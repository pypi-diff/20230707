# Comparing `tmp/distributed-2023.6.0.tar.gz` & `tmp/distributed-2023.6.1.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "distributed-2023.6.0.tar", last modified: Fri Jun  9 16:34:14 2023, max compression
+gzip compressed data, was "distributed-2023.6.1.tar", last modified: Mon Jun 26 20:35:19 2023, max compression
```

## Comparing `distributed-2023.6.0.tar` & `distributed-2023.6.1.tar`

### file list

```diff
@@ -1,296 +1,297 @@
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.909867 distributed-2023.6.0/
--rw-r--r--   0 james      (501) staff       (20)      104 2020-06-30 15:19:20.000000 distributed-2023.6.0/AUTHORS.md
--rw-r--r--   0 james      (501) staff       (20)     1533 2022-10-21 17:45:03.000000 distributed-2023.6.0/LICENSE.txt
--rw-r--r--   0 james      (501) staff       (20)      633 2023-06-02 19:58:01.000000 distributed-2023.6.0/MANIFEST.in
--rw-r--r--   0 james      (501) staff       (20)     2832 2023-06-09 16:34:14.909329 distributed-2023.6.0/PKG-INFO
--rw-r--r--   0 james      (501) staff       (20)     1801 2022-10-21 17:45:03.000000 distributed-2023.6.0/README.rst
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.910571 distributed-2023.6.0/distributed/
--rw-r--r--   0 james      (501) staff       (20)     4219 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     5528 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/_concurrent_futures_thread.py
--rw-r--r--   0 james      (501) staff       (20)     1297 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/_signals.py
--rw-r--r--   0 james      (501) staff       (20)     1399 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/_stories.py
--rw-r--r--   0 james      (501) staff       (20)      500 2023-06-09 16:34:14.910730 distributed-2023.6.0/distributed/_version.py
--rw-r--r--   0 james      (501) staff       (20)    29196 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/active_memory_manager.py
--rw-r--r--   0 james      (501) staff       (20)    10564 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/actor.py
--rw-r--r--   0 james      (501) staff       (20)     7347 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/batched.py
--rw-r--r--   0 james      (501) staff       (20)      121 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/bokeh.py
--rw-r--r--   0 james      (501) staff       (20)     5742 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/cfexecutor.py
--rw-r--r--   0 james      (501) staff       (20)     1947 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/chaos.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.736356 distributed-2023.6.0/distributed/cli/
--rw-r--r--   0 james      (501) staff       (20)        0 2020-06-30 15:19:20.000000 distributed-2023.6.0/distributed/cli/__init__.py
--rwxr-xr-x   0 james      (501) staff       (20)     7077 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/cli/dask_scheduler.py
--rw-r--r--   0 james      (501) staff       (20)     1269 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/cli/dask_spec.py
--rwxr-xr-x   0 james      (501) staff       (20)     5468 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/cli/dask_ssh.py
--rwxr-xr-x   0 james      (501) staff       (20)    15948 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/cli/dask_worker.py
--rw-r--r--   0 james      (501) staff       (20)     1092 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/cli/utils.py
--rw-r--r--   0 james      (501) staff       (20)   203544 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/client.py
--rw-r--r--   0 james      (501) staff       (20)    10960 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/cluster_dump.py
--rw-r--r--   0 james      (501) staff       (20)     6673 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/collections.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.742392 distributed-2023.6.0/distributed/comm/
--rw-r--r--   0 james      (501) staff       (20)     1285 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/comm/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     8597 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/comm/addressing.py
--rw-r--r--   0 james      (501) staff       (20)    37224 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/comm/asyncio_tcp.py
--rw-r--r--   0 james      (501) staff       (20)    13369 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/comm/core.py
--rw-r--r--   0 james      (501) staff       (20)    10321 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/comm/inproc.py
--rw-r--r--   0 james      (501) staff       (20)     2815 2022-11-15 16:22:42.000000 distributed-2023.6.0/distributed/comm/registry.py
--rw-r--r--   0 james      (501) staff       (20)    24054 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/comm/tcp.py
--rw-r--r--   0 james      (501) staff       (20)    22962 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/comm/ucx.py
--rw-r--r--   0 james      (501) staff       (20)     4220 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/comm/utils.py
--rw-r--r--   0 james      (501) staff       (20)    14868 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/comm/ws.py
--rw-r--r--   0 james      (501) staff       (20)     7416 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/compatibility.py
--rw-r--r--   0 james      (501) staff       (20)     7357 2023-06-07 19:11:17.000000 distributed-2023.6.0/distributed/config.py
--rw-r--r--   0 james      (501) staff       (20)    59300 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/core.py
--rw-r--r--   0 james      (501) staff       (20)     2146 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/counter.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.748884 distributed-2023.6.0/distributed/dashboard/
--rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:03.000000 distributed-2023.6.0/distributed/dashboard/__init__.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.752977 distributed-2023.6.0/distributed/dashboard/components/
--rw-r--r--   0 james      (501) staff       (20)     1550 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/dashboard/components/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     5818 2022-11-15 18:24:05.000000 distributed-2023.6.0/distributed/dashboard/components/nvml.py
--rw-r--r--   0 james      (501) staff       (20)     7055 2023-06-02 19:58:01.000000 distributed-2023.6.0/distributed/dashboard/components/rmm.py
--rw-r--r--   0 james      (501) staff       (20)   160410 2023-06-09 16:15:56.000000 distributed-2023.6.0/distributed/dashboard/components/scheduler.py
--rw-r--r--   0 james      (501) staff       (20)    19467 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/dashboard/components/shared.py
--rw-r--r--   0 james      (501) staff       (20)    15424 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/dashboard/components/worker.py
--rw-r--r--   0 james      (501) staff       (20)     1786 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/dashboard/core.py
--rw-r--r--   0 james      (501) staff       (20)     2313 2021-07-06 20:52:40.000000 distributed-2023.6.0/distributed/dashboard/export_tool.js
--rw-r--r--   0 james      (501) staff       (20)      763 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/dashboard/export_tool.py
--rw-r--r--   0 james      (501) staff       (20)     5834 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/dashboard/scheduler.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.754042 distributed-2023.6.0/distributed/dashboard/templates/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/dashboard/templates/__init__.py
--rw-r--r--   0 james      (501) staff       (20)      241 2022-06-06 20:36:46.000000 distributed-2023.6.0/distributed/dashboard/templates/performance_report.html
--rw-r--r--   0 james      (501) staff       (20)      199 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/dashboard/theme.yaml
--rw-r--r--   0 james      (501) staff       (20)     1668 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/dashboard/utils.py
--rw-r--r--   0 james      (501) staff       (20)      840 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/dashboard/worker.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.759480 distributed-2023.6.0/distributed/deploy/
--rw-r--r--   0 james      (501) staff       (20)      466 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/deploy/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     6702 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/deploy/adaptive.py
--rw-r--r--   0 james      (501) staff       (20)     7802 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/deploy/adaptive_core.py
--rw-r--r--   0 james      (501) staff       (20)    21248 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/deploy/cluster.py
--rw-r--r--   0 james      (501) staff       (20)    10434 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/deploy/local.py
--rw-r--r--   0 james      (501) staff       (20)    15514 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/deploy/old_ssh.py
--rw-r--r--   0 james      (501) staff       (20)    23732 2023-06-07 19:11:17.000000 distributed-2023.6.0/distributed/deploy/spec.py
--rw-r--r--   0 james      (501) staff       (20)    15265 2022-11-15 18:24:05.000000 distributed-2023.6.0/distributed/deploy/ssh.py
--rw-r--r--   0 james      (501) staff       (20)     7656 2023-06-02 19:58:01.000000 distributed-2023.6.0/distributed/deploy/subprocess.py
--rw-r--r--   0 james      (501) staff       (20)      888 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/deploy/utils.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.767274 distributed-2023.6.0/distributed/diagnostics/
--rw-r--r--   0 james      (501) staff       (20)      221 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/diagnostics/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     1302 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/diagnostics/cluster_dump.py
--rw-r--r--   0 james      (501) staff       (20)     2190 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/diagnostics/eventstream.py
--rw-r--r--   0 james      (501) staff       (20)     4994 2023-06-02 19:58:01.000000 distributed-2023.6.0/distributed/diagnostics/graph_layout.py
--rw-r--r--   0 james      (501) staff       (20)     6913 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/diagnostics/memory_sampler.py
--rw-r--r--   0 james      (501) staff       (20)    10781 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/diagnostics/nvml.py
--rw-r--r--   0 james      (501) staff       (20)    28291 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/diagnostics/plugin.py
--rw-r--r--   0 james      (501) staff       (20)    12565 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/diagnostics/progress.py
--rw-r--r--   0 james      (501) staff       (20)     6063 2022-11-07 19:30:53.000000 distributed-2023.6.0/distributed/diagnostics/progress_stream.py
--rw-r--r--   0 james      (501) staff       (20)    14665 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/diagnostics/progressbar.py
--rw-r--r--   0 james      (501) staff       (20)     1124 2023-06-02 19:58:01.000000 distributed-2023.6.0/distributed/diagnostics/rmm.py
--rw-r--r--   0 james      (501) staff       (20)     5677 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/diagnostics/task_stream.py
--rw-r--r--   0 james      (501) staff       (20)     2434 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/diagnostics/websocket.py
--rw-r--r--   0 james      (501) staff       (20)     9172 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/diskutils.py
--rw-r--r--   0 james      (501) staff       (20)    46226 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/distributed-schema.yaml
--rw-r--r--   0 james      (501) staff       (20)    14146 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/distributed.yaml
--rw-r--r--   0 james      (501) staff       (20)     8536 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/event.py
--rw-r--r--   0 james      (501) staff       (20)      586 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/exceptions.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.771150 distributed-2023.6.0/distributed/http/
--rw-r--r--   0 james      (501) staff       (20)       84 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/__init__.py
--rw-r--r--   0 james      (501) staff       (20)      258 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/http/health.py
--rw-r--r--   0 james      (501) staff       (20)     1480 2022-11-15 18:24:05.000000 distributed-2023.6.0/distributed/http/prometheus.py
--rw-r--r--   0 james      (501) staff       (20)     4377 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/proxy.py
--rw-r--r--   0 james      (501) staff       (20)     2548 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/routing.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.774801 distributed-2023.6.0/distributed/http/scheduler/
--rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/scheduler/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     2899 2023-06-07 19:06:41.000000 distributed-2023.6.0/distributed/http/scheduler/api.py
--rw-r--r--   0 james      (501) staff       (20)     6926 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/scheduler/info.py
--rw-r--r--   0 james      (501) staff       (20)     2159 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/scheduler/json.py
--rw-r--r--   0 james      (501) staff       (20)      625 2023-06-02 19:58:01.000000 distributed-2023.6.0/distributed/http/scheduler/missing_bokeh.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.777066 distributed-2023.6.0/distributed/http/scheduler/prometheus/
--rw-r--r--   0 james      (501) staff       (20)      291 2022-11-15 18:24:05.000000 distributed-2023.6.0/distributed/http/scheduler/prometheus/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     7049 2023-06-07 19:06:41.000000 distributed-2023.6.0/distributed/http/scheduler/prometheus/core.py
--rw-r--r--   0 james      (501) staff       (20)     3514 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/http/scheduler/prometheus/semaphore.py
--rw-r--r--   0 james      (501) staff       (20)     1617 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/http/scheduler/prometheus/stealing.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.778130 distributed-2023.6.0/distributed/http/static/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/http/static/__init__.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.784026 distributed-2023.6.0/distributed/http/static/css/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/http/static/css/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     2260 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/http/static/css/base.css
--rw-r--r--   0 james      (501) staff       (20)      250 2021-11-11 21:43:12.000000 distributed-2023.6.0/distributed/http/static/css/gpu.css
--rw-r--r--   0 james      (501) staff       (20)      840 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/static/css/individual-cluster-map.css
--rw-r--r--   0 james      (501) staff       (20)     1012 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/http/static/css/status.css
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.793149 distributed-2023.6.0/distributed/http/static/images/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/http/static/images/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     1607 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/static/images/dask-logo.svg
--rw-r--r--   0 james      (501) staff       (20)      552 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/static/images/fa-bars.svg
--rw-r--r--   0 james      (501) staff       (20)    15086 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/static/images/favicon.ico
--rw-r--r--   0 james      (501) staff       (20)    11002 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/http/static/images/jupyter.svg
--rw-r--r--   0 james      (501) staff       (20)    18663 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/http/static/images/numpy.png
--rw-r--r--   0 james      (501) staff       (20)     1213 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/http/static/images/pandas.png
--rw-r--r--   0 james      (501) staff       (20)   830916 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/http/static/images/python.png
--rw-r--r--   0 james      (501) staff       (20)      667 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/static/individual-cluster-map.html
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.802015 distributed-2023.6.0/distributed/http/static/js/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/http/static/js/__init__.py
--rw-r--r--   0 james      (501) staff       (20)    17271 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/static/js/anime.min.js
--rw-r--r--   0 james      (501) staff       (20)     9337 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/static/js/individual-cluster-map.js
--rw-r--r--   0 james      (501) staff       (20)     3276 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/static/js/reconnecting-websocket.min.js
--rw-r--r--   0 james      (501) staff       (20)      223 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/statics.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.816461 distributed-2023.6.0/distributed/http/templates/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/http/templates/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     2930 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/http/templates/base.html
--rw-r--r--   0 james      (501) staff       (20)      388 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/templates/call-stack.html
--rw-r--r--   0 james      (501) staff       (20)     1351 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/templates/exceptions.html
--rw-r--r--   0 james      (501) staff       (20)      404 2021-11-11 21:43:12.000000 distributed-2023.6.0/distributed/http/templates/gpu.html
--rw-r--r--   0 james      (501) staff       (20)      276 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/templates/json-index.html
--rw-r--r--   0 james      (501) staff       (20)      116 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/templates/logs.html
--rw-r--r--   0 james      (501) staff       (20)      369 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/templates/main.html
--rw-r--r--   0 james      (501) staff       (20)       95 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/templates/simple.html
--rw-r--r--   0 james      (501) staff       (20)      635 2022-11-15 16:22:42.000000 distributed-2023.6.0/distributed/http/templates/status.html
--rw-r--r--   0 james      (501) staff       (20)     5672 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/templates/task.html
--rw-r--r--   0 james      (501) staff       (20)     1405 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/templates/worker-table.html
--rw-r--r--   0 james      (501) staff       (20)     2024 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/templates/worker.html
--rw-r--r--   0 james      (501) staff       (20)      457 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/templates/workers.html
--rw-r--r--   0 james      (501) staff       (20)     1184 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/utils.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.817537 distributed-2023.6.0/distributed/http/worker/
--rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/worker/__init__.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.818494 distributed-2023.6.0/distributed/http/worker/prometheus/
--rw-r--r--   0 james      (501) staff       (20)      288 2022-11-15 18:24:05.000000 distributed-2023.6.0/distributed/http/worker/prometheus/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     9973 2023-06-02 19:58:01.000000 distributed-2023.6.0/distributed/http/worker/prometheus/core.py
--rw-r--r--   0 james      (501) staff       (20)     5599 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/lock.py
--rwxr-xr-x   0 james      (501) staff       (20)    12252 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/metrics.py
--rw-r--r--   0 james      (501) staff       (20)     8044 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/multi_lock.py
--rw-r--r--   0 james      (501) staff       (20)    33721 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/nanny.py
--rw-r--r--   0 james      (501) staff       (20)     6710 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/node.py
--rw-r--r--   0 james      (501) staff       (20)     1449 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/objects.py
--rw-r--r--   0 james      (501) staff       (20)     7513 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/preloading.py
--rw-r--r--   0 james      (501) staff       (20)    12887 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/process.py
--rw-r--r--   0 james      (501) staff       (20)      931 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/proctitle.py
--rw-r--r--   0 james      (501) staff       (20)    16141 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/profile.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.829905 distributed-2023.6.0/distributed/protocol/
--rw-r--r--   0 james      (501) staff       (20)     3363 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/protocol/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     1336 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/protocol/arrow.py
--rw-r--r--   0 james      (501) staff       (20)     6671 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/protocol/compression.py
--rw-r--r--   0 james      (501) staff       (20)     5964 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/protocol/core.py
--rw-r--r--   0 james      (501) staff       (20)     1181 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/protocol/cuda.py
--rw-r--r--   0 james      (501) staff       (20)     2931 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/protocol/cupy.py
--rw-r--r--   0 james      (501) staff       (20)      836 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/protocol/h5py.py
--rw-r--r--   0 james      (501) staff       (20)     1127 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/protocol/keras.py
--rw-r--r--   0 james      (501) staff       (20)     1466 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/protocol/netcdf4.py
--rw-r--r--   0 james      (501) staff       (20)     2139 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/protocol/numba.py
--rw-r--r--   0 james      (501) staff       (20)     6664 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/protocol/numpy.py
--rw-r--r--   0 james      (501) staff       (20)     3043 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/protocol/pickle.py
--rw-r--r--   0 james      (501) staff       (20)     1507 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/protocol/rmm.py
--rw-r--r--   0 james      (501) staff       (20)      800 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/protocol/scipy.py
--rw-r--r--   0 james      (501) staff       (20)    29121 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/protocol/serialize.py
--rw-r--r--   0 james      (501) staff       (20)      955 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/protocol/sparse.py
--rw-r--r--   0 james      (501) staff       (20)     1993 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/protocol/torch.py
--rw-r--r--   0 james      (501) staff       (20)     6102 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/protocol/utils.py
--rw-r--r--   0 james      (501) staff       (20)     3733 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/publish.py
--rw-r--r--   0 james      (501) staff       (20)    15652 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/pubsub.py
--rw-r--r--   0 james      (501) staff       (20)        0 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/py.typed
--rw-r--r--   0 james      (501) staff       (20)    10082 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/queues.py
--rw-r--r--   0 james      (501) staff       (20)     7620 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/recreate_tasks.py
--rw-r--r--   0 james      (501) staff       (20)   304785 2023-06-09 16:15:56.000000 distributed-2023.6.0/distributed/scheduler.py
--rw-r--r--   0 james      (501) staff       (20)    13825 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/security.py
--rw-r--r--   0 james      (501) staff       (20)    20568 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/semaphore.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.836836 distributed-2023.6.0/distributed/shuffle/
--rw-r--r--   0 james      (501) staff       (20)      692 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/shuffle/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     2575 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/shuffle/_arrow.py
--rw-r--r--   0 james      (501) staff       (20)     9206 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/shuffle/_buffer.py
--rw-r--r--   0 james      (501) staff       (20)     2526 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/shuffle/_comms.py
--rw-r--r--   0 james      (501) staff       (20)     3550 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/shuffle/_disk.py
--rw-r--r--   0 james      (501) staff       (20)     2361 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/shuffle/_limiter.py
--rw-r--r--   0 james      (501) staff       (20)    12505 2023-06-09 16:15:56.000000 distributed-2023.6.0/distributed/shuffle/_merge.py
--rw-r--r--   0 james      (501) staff       (20)     6012 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/shuffle/_rechunk.py
--rw-r--r--   0 james      (501) staff       (20)    12715 2023-06-09 16:15:56.000000 distributed-2023.6.0/distributed/shuffle/_scheduler_extension.py
--rw-r--r--   0 james      (501) staff       (20)     8462 2023-06-09 16:15:56.000000 distributed-2023.6.0/distributed/shuffle/_shuffle.py
--rw-r--r--   0 james      (501) staff       (20)    33727 2023-06-09 16:15:56.000000 distributed-2023.6.0/distributed/shuffle/_worker_extension.py
--rw-r--r--   0 james      (501) staff       (20)      607 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/sizeof.py
--rw-r--r--   0 james      (501) staff       (20)    15106 2023-06-09 16:15:56.000000 distributed-2023.6.0/distributed/spans.py
--rw-r--r--   0 james      (501) staff       (20)    13519 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/spill.py
--rw-r--r--   0 james      (501) staff       (20)    19859 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/stealing.py
--rw-r--r--   0 james      (501) staff       (20)     1883 2022-10-27 14:20:24.000000 distributed-2023.6.0/distributed/system.py
--rw-r--r--   0 james      (501) staff       (20)     8532 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/system_monitor.py
--rw-r--r--   0 james      (501) staff       (20)     7104 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/threadpoolexecutor.py
--rw-r--r--   0 james      (501) staff       (20)    55458 2023-06-07 19:11:17.000000 distributed-2023.6.0/distributed/utils.py
--rw-r--r--   0 james      (501) staff       (20)    13992 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/utils_comm.py
--rw-r--r--   0 james      (501) staff       (20)     8050 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/utils_perf.py
--rw-r--r--   0 james      (501) staff       (20)    81119 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/utils_test.py
--rw-r--r--   0 james      (501) staff       (20)     8463 2023-05-23 17:15:54.000000 distributed-2023.6.0/distributed/variable.py
--rw-r--r--   0 james      (501) staff       (20)     5165 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/versions.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.837731 distributed-2023.6.0/distributed/widgets/
--rw-r--r--   0 james      (501) staff       (20)      267 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/widgets/__init__.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.852653 distributed-2023.6.0/distributed/widgets/templates/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/widgets/templates/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     2265 2022-11-10 20:28:41.000000 distributed-2023.6.0/distributed/widgets/templates/client.html.j2
--rw-r--r--   0 james      (501) staff       (20)     1589 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/cluster.html.j2
--rw-r--r--   0 james      (501) staff       (20)     1270 2023-06-02 19:58:01.000000 distributed-2023.6.0/distributed/widgets/templates/computation.html.j2
--rw-r--r--   0 james      (501) staff       (20)      518 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/future.html.j2
--rw-r--r--   0 james      (501) staff       (20)      544 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/has_what.html.j2
--rw-r--r--   0 james      (501) staff       (20)      234 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/local_cluster.html.j2
--rw-r--r--   0 james      (501) staff       (20)      636 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/log.html.j2
--rw-r--r--   0 james      (501) staff       (20)      168 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/logs.html.j2
--rw-r--r--   0 james      (501) staff       (20)     1290 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/process_interface.html.j2
--rw-r--r--   0 james      (501) staff       (20)      317 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/scheduler.html.j2
--rw-r--r--   0 james      (501) staff       (20)     6705 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/widgets/templates/scheduler_info.html.j2
--rw-r--r--   0 james      (501) staff       (20)      407 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/security.html.j2
--rw-r--r--   0 james      (501) staff       (20)      448 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/task_state.html.j2
--rw-r--r--   0 james      (501) staff       (20)      295 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/who_has.html.j2
--rw-r--r--   0 james      (501) staff       (20)      407 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/worker_state.html.j2
--rw-r--r--   0 james      (501) staff       (20)   125799 2023-06-09 16:15:56.000000 distributed-2023.6.0/distributed/worker.py
--rw-r--r--   0 james      (501) staff       (20)     2568 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/worker_client.py
--rw-r--r--   0 james      (501) staff       (20)    21215 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/worker_memory.py
--rw-r--r--   0 james      (501) staff       (20)   142040 2023-06-09 16:15:56.000000 distributed-2023.6.0/distributed/worker_state_machine.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.733047 distributed-2023.6.0/distributed.egg-info/
--rw-r--r--   0 james      (501) staff       (20)     2832 2023-06-09 16:34:14.000000 distributed-2023.6.0/distributed.egg-info/PKG-INFO
--rw-r--r--   0 james      (501) staff       (20)     8594 2023-06-09 16:34:14.000000 distributed-2023.6.0/distributed.egg-info/SOURCES.txt
--rw-r--r--   0 james      (501) staff       (20)        1 2023-06-09 16:34:14.000000 distributed-2023.6.0/distributed.egg-info/dependency_links.txt
--rw-r--r--   0 james      (501) staff       (20)      335 2023-06-09 16:34:14.000000 distributed-2023.6.0/distributed.egg-info/entry_points.txt
--rw-r--r--   0 james      (501) staff       (20)        1 2023-06-09 16:34:13.000000 distributed-2023.6.0/distributed.egg-info/not-zip-safe
--rw-r--r--   0 james      (501) staff       (20)      227 2023-06-09 16:34:14.000000 distributed-2023.6.0/distributed.egg-info/requires.txt
--rw-r--r--   0 james      (501) staff       (20)       12 2023-06-09 16:34:14.000000 distributed-2023.6.0/distributed.egg-info/top_level.txt
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.683792 distributed-2023.6.0/docs/
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.906831 distributed-2023.6.0/docs/source/
--rw-r--r--   0 james      (501) staff       (20)    11754 2022-10-27 14:20:24.000000 distributed-2023.6.0/docs/source/active_memory_manager.rst
--rw-r--r--   0 james      (501) staff       (20)     8000 2022-11-15 18:24:05.000000 distributed-2023.6.0/docs/source/actors.rst
--rw-r--r--   0 james      (501) staff       (20)     4113 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/api.rst
--rw-r--r--   0 james      (501) staff       (20)     3519 2022-11-15 18:24:05.000000 distributed-2023.6.0/docs/source/asynchronous.rst
--rw-r--r--   0 james      (501) staff       (20)   257884 2023-06-09 16:24:48.000000 distributed-2023.6.0/docs/source/changelog.rst
--rw-r--r--   0 james      (501) staff       (20)     7084 2021-11-11 21:43:12.000000 distributed-2023.6.0/docs/source/client.rst
--rw-r--r--   0 james      (501) staff       (20)     3770 2021-11-11 17:33:04.000000 distributed-2023.6.0/docs/source/communications.rst
--rw-r--r--   0 james      (501) staff       (20)     7049 2023-06-07 19:29:49.000000 distributed-2023.6.0/docs/source/develop.rst
--rw-r--r--   0 james      (501) staff       (20)     6823 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/diagnosing-performance.rst
--rw-r--r--   0 james      (501) staff       (20)     3392 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/efficiency.rst
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.908466 distributed-2023.6.0/docs/source/examples/
--rw-r--r--   0 james      (501) staff       (20)     8953 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/examples/word-count.rst
--rw-r--r--   0 james      (501) staff       (20)       75 2020-06-30 15:19:20.000000 distributed-2023.6.0/docs/source/examples-overview.rst
--rw-r--r--   0 james      (501) staff       (20)     4228 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/faq.rst
--rw-r--r--   0 james      (501) staff       (20)     4613 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/foundations.rst
--rw-r--r--   0 james      (501) staff       (20)     4016 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/http_services.rst
--rw-r--r--   0 james      (501) staff       (20)     4423 2023-04-25 18:34:44.000000 distributed-2023.6.0/docs/source/index.rst
--rw-r--r--   0 james      (501) staff       (20)     1182 2022-08-08 21:17:38.000000 distributed-2023.6.0/docs/source/install.rst
--rw-r--r--   0 james      (501) staff       (20)     7293 2021-11-11 17:33:04.000000 distributed-2023.6.0/docs/source/journey.rst
--rw-r--r--   0 james      (501) staff       (20)     6470 2023-06-02 19:58:01.000000 distributed-2023.6.0/docs/source/killed.rst
--rw-r--r--   0 james      (501) staff       (20)     1828 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/limitations.rst
--rw-r--r--   0 james      (501) staff       (20)     6458 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/locality.rst
--rw-r--r--   0 james      (501) staff       (20)     2807 2021-11-11 17:33:04.000000 distributed-2023.6.0/docs/source/logging.rst
--rw-r--r--   0 james      (501) staff       (20)     6546 2021-07-06 20:52:40.000000 distributed-2023.6.0/docs/source/manage-computation.rst
--rw-r--r--   0 james      (501) staff       (20)     8550 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/memory.rst
--rw-r--r--   0 james      (501) staff       (20)     4100 2023-02-14 16:13:20.000000 distributed-2023.6.0/docs/source/plugins.rst
--rw-r--r--   0 james      (501) staff       (20)     3265 2021-11-11 21:43:12.000000 distributed-2023.6.0/docs/source/priority.rst
--rw-r--r--   0 james      (501) staff       (20)     7481 2023-06-07 19:06:41.000000 distributed-2023.6.0/docs/source/prometheus.rst
--rw-r--r--   0 james      (501) staff       (20)    11199 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/protocol.rst
--rw-r--r--   0 james      (501) staff       (20)     3107 2020-12-18 22:54:04.000000 distributed-2023.6.0/docs/source/publish.rst
--rw-r--r--   0 james      (501) staff       (20)      402 2023-06-02 19:58:01.000000 distributed-2023.6.0/docs/source/queues.rst
--rw-r--r--   0 james      (501) staff       (20)     2942 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/quickstart.rst
--rw-r--r--   0 james      (501) staff       (20)     8773 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/related-work.rst
--rw-r--r--   0 james      (501) staff       (20)     3418 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/resilience.rst
--rw-r--r--   0 james      (501) staff       (20)     6049 2022-11-15 18:24:05.000000 distributed-2023.6.0/docs/source/resources.rst
--rw-r--r--   0 james      (501) staff       (20)    16084 2023-04-25 18:34:44.000000 distributed-2023.6.0/docs/source/scheduling-policies.rst
--rw-r--r--   0 james      (501) staff       (20)    16901 2022-11-15 18:24:05.000000 distributed-2023.6.0/docs/source/scheduling-state.rst
--rw-r--r--   0 james      (501) staff       (20)     6518 2021-11-11 17:33:04.000000 distributed-2023.6.0/docs/source/serialization.rst
--rw-r--r--   0 james      (501) staff       (20)     8343 2022-08-08 21:17:38.000000 distributed-2023.6.0/docs/source/task-launch.rst
--rw-r--r--   0 james      (501) staff       (20)     4190 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/tls.rst
--rw-r--r--   0 james      (501) staff       (20)     5557 2021-11-11 17:33:04.000000 distributed-2023.6.0/docs/source/work-stealing.rst
--rw-r--r--   0 james      (501) staff       (20)    13489 2023-04-25 18:34:44.000000 distributed-2023.6.0/docs/source/worker-memory.rst
--rw-r--r--   0 james      (501) staff       (20)    22542 2023-06-02 19:58:01.000000 distributed-2023.6.0/docs/source/worker-state.rst
--rw-r--r--   0 james      (501) staff       (20)     3467 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/worker.rst
--rw-r--r--   0 james      (501) staff       (20)     8950 2023-06-09 16:25:53.000000 distributed-2023.6.0/pyproject.toml
--rw-r--r--   0 james      (501) staff       (20)       38 2023-06-09 16:34:14.910036 distributed-2023.6.0/setup.cfg
--rw-r--r--   0 james      (501) staff       (20)      171 2023-06-02 19:58:01.000000 distributed-2023.6.0/setup.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.855034 distributed-2023.6.1/
+-rw-r--r--   0 james      (501) staff       (20)      104 2020-06-30 15:19:20.000000 distributed-2023.6.1/AUTHORS.md
+-rw-r--r--   0 james      (501) staff       (20)     1533 2022-10-21 17:45:03.000000 distributed-2023.6.1/LICENSE.txt
+-rw-r--r--   0 james      (501) staff       (20)      633 2023-06-02 19:58:01.000000 distributed-2023.6.1/MANIFEST.in
+-rw-r--r--   0 james      (501) staff       (20)     2832 2023-06-26 20:35:19.854127 distributed-2023.6.1/PKG-INFO
+-rw-r--r--   0 james      (501) staff       (20)     1801 2022-10-21 17:45:03.000000 distributed-2023.6.1/README.rst
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.859002 distributed-2023.6.1/distributed/
+-rw-r--r--   0 james      (501) staff       (20)     4219 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     5528 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/_concurrent_futures_thread.py
+-rw-r--r--   0 james      (501) staff       (20)     1297 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/_signals.py
+-rw-r--r--   0 james      (501) staff       (20)     1399 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/_stories.py
+-rw-r--r--   0 james      (501) staff       (20)      500 2023-06-26 20:35:19.859189 distributed-2023.6.1/distributed/_version.py
+-rw-r--r--   0 james      (501) staff       (20)    29196 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/active_memory_manager.py
+-rw-r--r--   0 james      (501) staff       (20)     9576 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/actor.py
+-rw-r--r--   0 james      (501) staff       (20)     7347 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/batched.py
+-rw-r--r--   0 james      (501) staff       (20)      121 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/bokeh.py
+-rw-r--r--   0 james      (501) staff       (20)     5742 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/cfexecutor.py
+-rw-r--r--   0 james      (501) staff       (20)     1947 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/chaos.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.587921 distributed-2023.6.1/distributed/cli/
+-rw-r--r--   0 james      (501) staff       (20)        0 2020-06-30 15:19:20.000000 distributed-2023.6.1/distributed/cli/__init__.py
+-rwxr-xr-x   0 james      (501) staff       (20)     7077 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/cli/dask_scheduler.py
+-rw-r--r--   0 james      (501) staff       (20)     1269 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/cli/dask_spec.py
+-rwxr-xr-x   0 james      (501) staff       (20)     5468 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/cli/dask_ssh.py
+-rwxr-xr-x   0 james      (501) staff       (20)    15948 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/cli/dask_worker.py
+-rw-r--r--   0 james      (501) staff       (20)     1092 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/cli/utils.py
+-rw-r--r--   0 james      (501) staff       (20)   203532 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/client.py
+-rw-r--r--   0 james      (501) staff       (20)    10960 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/cluster_dump.py
+-rw-r--r--   0 james      (501) staff       (20)     7099 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/collections.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.596240 distributed-2023.6.1/distributed/comm/
+-rw-r--r--   0 james      (501) staff       (20)     1285 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/comm/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     8597 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/comm/addressing.py
+-rw-r--r--   0 james      (501) staff       (20)    37259 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/comm/asyncio_tcp.py
+-rw-r--r--   0 james      (501) staff       (20)    13918 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/comm/core.py
+-rw-r--r--   0 james      (501) staff       (20)    10356 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/comm/inproc.py
+-rw-r--r--   0 james      (501) staff       (20)     2815 2022-11-15 16:22:42.000000 distributed-2023.6.1/distributed/comm/registry.py
+-rw-r--r--   0 james      (501) staff       (20)    24089 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/comm/tcp.py
+-rw-r--r--   0 james      (501) staff       (20)    22997 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/comm/ucx.py
+-rw-r--r--   0 james      (501) staff       (20)     4220 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/comm/utils.py
+-rw-r--r--   0 james      (501) staff       (20)    14903 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/comm/ws.py
+-rw-r--r--   0 james      (501) staff       (20)     7416 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/compatibility.py
+-rw-r--r--   0 james      (501) staff       (20)     7357 2023-06-07 19:11:17.000000 distributed-2023.6.1/distributed/config.py
+-rw-r--r--   0 james      (501) staff       (20)    59865 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/core.py
+-rw-r--r--   0 james      (501) staff       (20)     2146 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/counter.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.604322 distributed-2023.6.1/distributed/dashboard/
+-rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:03.000000 distributed-2023.6.1/distributed/dashboard/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.609866 distributed-2023.6.1/distributed/dashboard/components/
+-rw-r--r--   0 james      (501) staff       (20)     1550 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/dashboard/components/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     5818 2022-11-15 18:24:05.000000 distributed-2023.6.1/distributed/dashboard/components/nvml.py
+-rw-r--r--   0 james      (501) staff       (20)     7055 2023-06-02 19:58:01.000000 distributed-2023.6.1/distributed/dashboard/components/rmm.py
+-rw-r--r--   0 james      (501) staff       (20)   162578 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/dashboard/components/scheduler.py
+-rw-r--r--   0 james      (501) staff       (20)    19467 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/dashboard/components/shared.py
+-rw-r--r--   0 james      (501) staff       (20)    15424 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/dashboard/components/worker.py
+-rw-r--r--   0 james      (501) staff       (20)     1786 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/dashboard/core.py
+-rw-r--r--   0 james      (501) staff       (20)     2313 2021-07-06 20:52:40.000000 distributed-2023.6.1/distributed/dashboard/export_tool.js
+-rw-r--r--   0 james      (501) staff       (20)      763 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/dashboard/export_tool.py
+-rw-r--r--   0 james      (501) staff       (20)     5834 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/dashboard/scheduler.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.611287 distributed-2023.6.1/distributed/dashboard/templates/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/dashboard/templates/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)      241 2022-06-06 20:36:46.000000 distributed-2023.6.1/distributed/dashboard/templates/performance_report.html
+-rw-r--r--   0 james      (501) staff       (20)      199 2022-08-08 21:17:38.000000 distributed-2023.6.1/distributed/dashboard/theme.yaml
+-rw-r--r--   0 james      (501) staff       (20)     1732 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/dashboard/utils.py
+-rw-r--r--   0 james      (501) staff       (20)      840 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/dashboard/worker.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.624858 distributed-2023.6.1/distributed/deploy/
+-rw-r--r--   0 james      (501) staff       (20)      466 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/deploy/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     6702 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/deploy/adaptive.py
+-rw-r--r--   0 james      (501) staff       (20)     7802 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/deploy/adaptive_core.py
+-rw-r--r--   0 james      (501) staff       (20)    21643 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/deploy/cluster.py
+-rw-r--r--   0 james      (501) staff       (20)    10434 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/deploy/local.py
+-rw-r--r--   0 james      (501) staff       (20)    15514 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/deploy/old_ssh.py
+-rw-r--r--   0 james      (501) staff       (20)    23602 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/deploy/spec.py
+-rw-r--r--   0 james      (501) staff       (20)    15265 2022-11-15 18:24:05.000000 distributed-2023.6.1/distributed/deploy/ssh.py
+-rw-r--r--   0 james      (501) staff       (20)     7656 2023-06-02 19:58:01.000000 distributed-2023.6.1/distributed/deploy/subprocess.py
+-rw-r--r--   0 james      (501) staff       (20)      888 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/deploy/utils.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.640278 distributed-2023.6.1/distributed/diagnostics/
+-rw-r--r--   0 james      (501) staff       (20)      221 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/diagnostics/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     1302 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/diagnostics/cluster_dump.py
+-rw-r--r--   0 james      (501) staff       (20)     2190 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/diagnostics/eventstream.py
+-rw-r--r--   0 james      (501) staff       (20)     4994 2023-06-02 19:58:01.000000 distributed-2023.6.1/distributed/diagnostics/graph_layout.py
+-rw-r--r--   0 james      (501) staff       (20)     6913 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/diagnostics/memory_sampler.py
+-rw-r--r--   0 james      (501) staff       (20)    10781 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/diagnostics/nvml.py
+-rw-r--r--   0 james      (501) staff       (20)    28291 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/diagnostics/plugin.py
+-rw-r--r--   0 james      (501) staff       (20)    12565 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/diagnostics/progress.py
+-rw-r--r--   0 james      (501) staff       (20)     6063 2022-11-07 19:30:53.000000 distributed-2023.6.1/distributed/diagnostics/progress_stream.py
+-rw-r--r--   0 james      (501) staff       (20)    14665 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/diagnostics/progressbar.py
+-rw-r--r--   0 james      (501) staff       (20)     1124 2023-06-02 19:58:01.000000 distributed-2023.6.1/distributed/diagnostics/rmm.py
+-rw-r--r--   0 james      (501) staff       (20)     5677 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/diagnostics/task_stream.py
+-rw-r--r--   0 james      (501) staff       (20)     2434 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/diagnostics/websocket.py
+-rw-r--r--   0 james      (501) staff       (20)     9172 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/diskutils.py
+-rw-r--r--   0 james      (501) staff       (20)    46226 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/distributed-schema.yaml
+-rw-r--r--   0 james      (501) staff       (20)    14146 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/distributed.yaml
+-rw-r--r--   0 james      (501) staff       (20)     8536 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/event.py
+-rw-r--r--   0 james      (501) staff       (20)      586 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/exceptions.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.646694 distributed-2023.6.1/distributed/http/
+-rw-r--r--   0 james      (501) staff       (20)       84 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/http/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)      258 2022-08-08 21:17:38.000000 distributed-2023.6.1/distributed/http/health.py
+-rw-r--r--   0 james      (501) staff       (20)     1480 2022-11-15 18:24:05.000000 distributed-2023.6.1/distributed/http/prometheus.py
+-rw-r--r--   0 james      (501) staff       (20)     4377 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/http/proxy.py
+-rw-r--r--   0 james      (501) staff       (20)     2548 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/http/routing.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.650113 distributed-2023.6.1/distributed/http/scheduler/
+-rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:04.000000 distributed-2023.6.1/distributed/http/scheduler/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2899 2023-06-07 19:06:41.000000 distributed-2023.6.1/distributed/http/scheduler/api.py
+-rw-r--r--   0 james      (501) staff       (20)     6926 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/http/scheduler/info.py
+-rw-r--r--   0 james      (501) staff       (20)     2159 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/http/scheduler/json.py
+-rw-r--r--   0 james      (501) staff       (20)      625 2023-06-02 19:58:01.000000 distributed-2023.6.1/distributed/http/scheduler/missing_bokeh.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.653943 distributed-2023.6.1/distributed/http/scheduler/prometheus/
+-rw-r--r--   0 james      (501) staff       (20)      291 2022-11-15 18:24:05.000000 distributed-2023.6.1/distributed/http/scheduler/prometheus/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     7049 2023-06-07 19:06:41.000000 distributed-2023.6.1/distributed/http/scheduler/prometheus/core.py
+-rw-r--r--   0 james      (501) staff       (20)     3514 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/http/scheduler/prometheus/semaphore.py
+-rw-r--r--   0 james      (501) staff       (20)     1617 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/http/scheduler/prometheus/stealing.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.656517 distributed-2023.6.1/distributed/http/static/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/http/static/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.668595 distributed-2023.6.1/distributed/http/static/css/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/http/static/css/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2260 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/http/static/css/base.css
+-rw-r--r--   0 james      (501) staff       (20)      250 2021-11-11 21:43:12.000000 distributed-2023.6.1/distributed/http/static/css/gpu.css
+-rw-r--r--   0 james      (501) staff       (20)      840 2021-11-11 17:33:04.000000 distributed-2023.6.1/distributed/http/static/css/individual-cluster-map.css
+-rw-r--r--   0 james      (501) staff       (20)     1012 2022-08-08 21:17:38.000000 distributed-2023.6.1/distributed/http/static/css/status.css
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.679428 distributed-2023.6.1/distributed/http/static/images/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/http/static/images/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     1607 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/http/static/images/dask-logo.svg
+-rw-r--r--   0 james      (501) staff       (20)      552 2021-11-11 17:33:04.000000 distributed-2023.6.1/distributed/http/static/images/fa-bars.svg
+-rw-r--r--   0 james      (501) staff       (20)    15086 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/http/static/images/favicon.ico
+-rw-r--r--   0 james      (501) staff       (20)    11002 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/http/static/images/jupyter.svg
+-rw-r--r--   0 james      (501) staff       (20)    18663 2022-08-08 21:17:38.000000 distributed-2023.6.1/distributed/http/static/images/numpy.png
+-rw-r--r--   0 james      (501) staff       (20)     1213 2022-08-08 21:17:38.000000 distributed-2023.6.1/distributed/http/static/images/pandas.png
+-rw-r--r--   0 james      (501) staff       (20)   830916 2022-08-08 21:17:38.000000 distributed-2023.6.1/distributed/http/static/images/python.png
+-rw-r--r--   0 james      (501) staff       (20)      667 2021-11-11 17:33:04.000000 distributed-2023.6.1/distributed/http/static/individual-cluster-map.html
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.693427 distributed-2023.6.1/distributed/http/static/js/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/http/static/js/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)    17271 2021-11-11 17:33:04.000000 distributed-2023.6.1/distributed/http/static/js/anime.min.js
+-rw-r--r--   0 james      (501) staff       (20)     9337 2021-11-11 17:33:04.000000 distributed-2023.6.1/distributed/http/static/js/individual-cluster-map.js
+-rw-r--r--   0 james      (501) staff       (20)     3276 2021-11-11 17:33:04.000000 distributed-2023.6.1/distributed/http/static/js/reconnecting-websocket.min.js
+-rw-r--r--   0 james      (501) staff       (20)      223 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/http/statics.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.711923 distributed-2023.6.1/distributed/http/templates/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/http/templates/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2930 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/http/templates/base.html
+-rw-r--r--   0 james      (501) staff       (20)      388 2021-11-11 17:33:04.000000 distributed-2023.6.1/distributed/http/templates/call-stack.html
+-rw-r--r--   0 james      (501) staff       (20)     1351 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/http/templates/exceptions.html
+-rw-r--r--   0 james      (501) staff       (20)      404 2021-11-11 21:43:12.000000 distributed-2023.6.1/distributed/http/templates/gpu.html
+-rw-r--r--   0 james      (501) staff       (20)      276 2021-11-11 17:33:04.000000 distributed-2023.6.1/distributed/http/templates/json-index.html
+-rw-r--r--   0 james      (501) staff       (20)      116 2021-11-11 17:33:04.000000 distributed-2023.6.1/distributed/http/templates/logs.html
+-rw-r--r--   0 james      (501) staff       (20)      369 2021-11-11 17:33:04.000000 distributed-2023.6.1/distributed/http/templates/main.html
+-rw-r--r--   0 james      (501) staff       (20)       95 2021-11-11 17:33:04.000000 distributed-2023.6.1/distributed/http/templates/simple.html
+-rw-r--r--   0 james      (501) staff       (20)      635 2022-11-15 16:22:42.000000 distributed-2023.6.1/distributed/http/templates/status.html
+-rw-r--r--   0 james      (501) staff       (20)     5672 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/http/templates/task.html
+-rw-r--r--   0 james      (501) staff       (20)     1405 2021-11-11 17:33:04.000000 distributed-2023.6.1/distributed/http/templates/worker-table.html
+-rw-r--r--   0 james      (501) staff       (20)     2024 2021-11-11 17:33:04.000000 distributed-2023.6.1/distributed/http/templates/worker.html
+-rw-r--r--   0 james      (501) staff       (20)      457 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/http/templates/workers.html
+-rw-r--r--   0 james      (501) staff       (20)     1184 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/http/utils.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.713032 distributed-2023.6.1/distributed/http/worker/
+-rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:04.000000 distributed-2023.6.1/distributed/http/worker/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.714239 distributed-2023.6.1/distributed/http/worker/prometheus/
+-rw-r--r--   0 james      (501) staff       (20)      288 2022-11-15 18:24:05.000000 distributed-2023.6.1/distributed/http/worker/prometheus/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     9973 2023-06-02 19:58:01.000000 distributed-2023.6.1/distributed/http/worker/prometheus/core.py
+-rw-r--r--   0 james      (501) staff       (20)     1170 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/itertools.py
+-rw-r--r--   0 james      (501) staff       (20)     5599 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/lock.py
+-rwxr-xr-x   0 james      (501) staff       (20)    12252 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/metrics.py
+-rw-r--r--   0 james      (501) staff       (20)     8044 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/multi_lock.py
+-rw-r--r--   0 james      (501) staff       (20)    33721 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/nanny.py
+-rw-r--r--   0 james      (501) staff       (20)     6710 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/node.py
+-rw-r--r--   0 james      (501) staff       (20)     1449 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/objects.py
+-rw-r--r--   0 james      (501) staff       (20)     7513 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/preloading.py
+-rw-r--r--   0 james      (501) staff       (20)    12887 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/process.py
+-rw-r--r--   0 james      (501) staff       (20)      931 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/proctitle.py
+-rw-r--r--   0 james      (501) staff       (20)    16141 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/profile.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.734398 distributed-2023.6.1/distributed/protocol/
+-rw-r--r--   0 james      (501) staff       (20)     3363 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/protocol/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     1336 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/protocol/arrow.py
+-rw-r--r--   0 james      (501) staff       (20)     6671 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/protocol/compression.py
+-rw-r--r--   0 james      (501) staff       (20)     5964 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/protocol/core.py
+-rw-r--r--   0 james      (501) staff       (20)     1181 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/protocol/cuda.py
+-rw-r--r--   0 james      (501) staff       (20)     2931 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/protocol/cupy.py
+-rw-r--r--   0 james      (501) staff       (20)      836 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/protocol/h5py.py
+-rw-r--r--   0 james      (501) staff       (20)     1127 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/protocol/keras.py
+-rw-r--r--   0 james      (501) staff       (20)     1466 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/protocol/netcdf4.py
+-rw-r--r--   0 james      (501) staff       (20)     2139 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/protocol/numba.py
+-rw-r--r--   0 james      (501) staff       (20)     6664 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/protocol/numpy.py
+-rw-r--r--   0 james      (501) staff       (20)     3043 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/protocol/pickle.py
+-rw-r--r--   0 james      (501) staff       (20)     1507 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/protocol/rmm.py
+-rw-r--r--   0 james      (501) staff       (20)      800 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/protocol/scipy.py
+-rw-r--r--   0 james      (501) staff       (20)    29121 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/protocol/serialize.py
+-rw-r--r--   0 james      (501) staff       (20)      955 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/protocol/sparse.py
+-rw-r--r--   0 james      (501) staff       (20)     1993 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/protocol/torch.py
+-rw-r--r--   0 james      (501) staff       (20)     6102 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/protocol/utils.py
+-rw-r--r--   0 james      (501) staff       (20)     3733 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/publish.py
+-rw-r--r--   0 james      (501) staff       (20)    15652 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/pubsub.py
+-rw-r--r--   0 james      (501) staff       (20)        0 2022-08-08 21:17:38.000000 distributed-2023.6.1/distributed/py.typed
+-rw-r--r--   0 james      (501) staff       (20)    10082 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/queues.py
+-rw-r--r--   0 james      (501) staff       (20)     7620 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/recreate_tasks.py
+-rw-r--r--   0 james      (501) staff       (20)   305271 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/scheduler.py
+-rw-r--r--   0 james      (501) staff       (20)    13825 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/security.py
+-rw-r--r--   0 james      (501) staff       (20)    20568 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/semaphore.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.743597 distributed-2023.6.1/distributed/shuffle/
+-rw-r--r--   0 james      (501) staff       (20)      692 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/shuffle/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     3114 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/shuffle/_arrow.py
+-rw-r--r--   0 james      (501) staff       (20)     9206 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/shuffle/_buffer.py
+-rw-r--r--   0 james      (501) staff       (20)     2526 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/shuffle/_comms.py
+-rw-r--r--   0 james      (501) staff       (20)     3550 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/shuffle/_disk.py
+-rw-r--r--   0 james      (501) staff       (20)     2361 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/shuffle/_limiter.py
+-rw-r--r--   0 james      (501) staff       (20)    12505 2023-06-12 20:29:06.000000 distributed-2023.6.1/distributed/shuffle/_merge.py
+-rw-r--r--   0 james      (501) staff       (20)     5594 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/shuffle/_rechunk.py
+-rw-r--r--   0 james      (501) staff       (20)    12899 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/shuffle/_scheduler_extension.py
+-rw-r--r--   0 james      (501) staff       (20)     8459 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/shuffle/_shuffle.py
+-rw-r--r--   0 james      (501) staff       (20)    33639 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/shuffle/_worker_extension.py
+-rw-r--r--   0 james      (501) staff       (20)      607 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/sizeof.py
+-rw-r--r--   0 james      (501) staff       (20)    22649 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/spans.py
+-rw-r--r--   0 james      (501) staff       (20)    13519 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/spill.py
+-rw-r--r--   0 james      (501) staff       (20)    19859 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/stealing.py
+-rw-r--r--   0 james      (501) staff       (20)     1883 2022-10-27 14:20:24.000000 distributed-2023.6.1/distributed/system.py
+-rw-r--r--   0 james      (501) staff       (20)     8532 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/system_monitor.py
+-rw-r--r--   0 james      (501) staff       (20)     7104 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/threadpoolexecutor.py
+-rw-r--r--   0 james      (501) staff       (20)    56496 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/utils.py
+-rw-r--r--   0 james      (501) staff       (20)    13992 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/utils_comm.py
+-rw-r--r--   0 james      (501) staff       (20)     8050 2023-04-25 18:34:44.000000 distributed-2023.6.1/distributed/utils_perf.py
+-rw-r--r--   0 james      (501) staff       (20)    80956 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/utils_test.py
+-rw-r--r--   0 james      (501) staff       (20)     8463 2023-05-23 17:15:54.000000 distributed-2023.6.1/distributed/variable.py
+-rw-r--r--   0 james      (501) staff       (20)     5165 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/versions.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.745112 distributed-2023.6.1/distributed/widgets/
+-rw-r--r--   0 james      (501) staff       (20)      267 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/widgets/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.779035 distributed-2023.6.1/distributed/widgets/templates/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/widgets/templates/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2265 2022-11-10 20:28:41.000000 distributed-2023.6.1/distributed/widgets/templates/client.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     1589 2022-08-08 21:17:38.000000 distributed-2023.6.1/distributed/widgets/templates/cluster.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     1270 2023-06-02 19:58:01.000000 distributed-2023.6.1/distributed/widgets/templates/computation.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      518 2022-08-08 21:17:38.000000 distributed-2023.6.1/distributed/widgets/templates/future.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      544 2022-08-08 21:17:38.000000 distributed-2023.6.1/distributed/widgets/templates/has_what.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      234 2022-08-08 21:17:38.000000 distributed-2023.6.1/distributed/widgets/templates/local_cluster.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      636 2022-08-08 21:17:38.000000 distributed-2023.6.1/distributed/widgets/templates/log.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      168 2022-08-08 21:17:38.000000 distributed-2023.6.1/distributed/widgets/templates/logs.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     1290 2022-08-08 21:17:38.000000 distributed-2023.6.1/distributed/widgets/templates/process_interface.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      317 2022-08-08 21:17:38.000000 distributed-2023.6.1/distributed/widgets/templates/scheduler.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     6705 2022-10-21 17:45:03.000000 distributed-2023.6.1/distributed/widgets/templates/scheduler_info.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      407 2022-08-08 21:17:38.000000 distributed-2023.6.1/distributed/widgets/templates/security.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      448 2022-08-08 21:17:38.000000 distributed-2023.6.1/distributed/widgets/templates/task_state.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      295 2022-08-08 21:17:38.000000 distributed-2023.6.1/distributed/widgets/templates/who_has.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      407 2022-08-08 21:17:38.000000 distributed-2023.6.1/distributed/widgets/templates/worker_state.html.j2
+-rw-r--r--   0 james      (501) staff       (20)   126523 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/worker.py
+-rw-r--r--   0 james      (501) staff       (20)     2568 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/worker_client.py
+-rw-r--r--   0 james      (501) staff       (20)    21215 2023-06-07 19:29:49.000000 distributed-2023.6.1/distributed/worker_memory.py
+-rw-r--r--   0 james      (501) staff       (20)   142155 2023-06-26 20:17:29.000000 distributed-2023.6.1/distributed/worker_state_machine.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.579981 distributed-2023.6.1/distributed.egg-info/
+-rw-r--r--   0 james      (501) staff       (20)     2832 2023-06-26 20:35:19.000000 distributed-2023.6.1/distributed.egg-info/PKG-INFO
+-rw-r--r--   0 james      (501) staff       (20)     8619 2023-06-26 20:35:19.000000 distributed-2023.6.1/distributed.egg-info/SOURCES.txt
+-rw-r--r--   0 james      (501) staff       (20)        1 2023-06-26 20:35:19.000000 distributed-2023.6.1/distributed.egg-info/dependency_links.txt
+-rw-r--r--   0 james      (501) staff       (20)      335 2023-06-26 20:35:19.000000 distributed-2023.6.1/distributed.egg-info/entry_points.txt
+-rw-r--r--   0 james      (501) staff       (20)        1 2023-06-26 20:35:17.000000 distributed-2023.6.1/distributed.egg-info/not-zip-safe
+-rw-r--r--   0 james      (501) staff       (20)      227 2023-06-26 20:35:19.000000 distributed-2023.6.1/distributed.egg-info/requires.txt
+-rw-r--r--   0 james      (501) staff       (20)       12 2023-06-26 20:35:19.000000 distributed-2023.6.1/distributed.egg-info/top_level.txt
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.491658 distributed-2023.6.1/docs/
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.851537 distributed-2023.6.1/docs/source/
+-rw-r--r--   0 james      (501) staff       (20)    11754 2022-10-27 14:20:24.000000 distributed-2023.6.1/docs/source/active_memory_manager.rst
+-rw-r--r--   0 james      (501) staff       (20)     8000 2022-11-15 18:24:05.000000 distributed-2023.6.1/docs/source/actors.rst
+-rw-r--r--   0 james      (501) staff       (20)     4113 2022-10-21 17:45:03.000000 distributed-2023.6.1/docs/source/api.rst
+-rw-r--r--   0 james      (501) staff       (20)     3519 2022-11-15 18:24:05.000000 distributed-2023.6.1/docs/source/asynchronous.rst
+-rw-r--r--   0 james      (501) staff       (20)   260447 2023-06-26 20:27:33.000000 distributed-2023.6.1/docs/source/changelog.rst
+-rw-r--r--   0 james      (501) staff       (20)     7084 2021-11-11 21:43:12.000000 distributed-2023.6.1/docs/source/client.rst
+-rw-r--r--   0 james      (501) staff       (20)     3770 2021-11-11 17:33:04.000000 distributed-2023.6.1/docs/source/communications.rst
+-rw-r--r--   0 james      (501) staff       (20)     7049 2023-06-07 19:29:49.000000 distributed-2023.6.1/docs/source/develop.rst
+-rw-r--r--   0 james      (501) staff       (20)     6823 2022-10-21 17:45:03.000000 distributed-2023.6.1/docs/source/diagnosing-performance.rst
+-rw-r--r--   0 james      (501) staff       (20)     3392 2022-10-21 17:45:03.000000 distributed-2023.6.1/docs/source/efficiency.rst
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-26 20:35:19.852906 distributed-2023.6.1/docs/source/examples/
+-rw-r--r--   0 james      (501) staff       (20)     8953 2022-10-21 17:45:03.000000 distributed-2023.6.1/docs/source/examples/word-count.rst
+-rw-r--r--   0 james      (501) staff       (20)       75 2020-06-30 15:19:20.000000 distributed-2023.6.1/docs/source/examples-overview.rst
+-rw-r--r--   0 james      (501) staff       (20)     4228 2022-10-21 17:45:03.000000 distributed-2023.6.1/docs/source/faq.rst
+-rw-r--r--   0 james      (501) staff       (20)     4613 2022-10-21 17:45:03.000000 distributed-2023.6.1/docs/source/foundations.rst
+-rw-r--r--   0 james      (501) staff       (20)     4016 2022-10-21 17:45:03.000000 distributed-2023.6.1/docs/source/http_services.rst
+-rw-r--r--   0 james      (501) staff       (20)     4423 2023-04-25 18:34:44.000000 distributed-2023.6.1/docs/source/index.rst
+-rw-r--r--   0 james      (501) staff       (20)     1182 2022-08-08 21:17:38.000000 distributed-2023.6.1/docs/source/install.rst
+-rw-r--r--   0 james      (501) staff       (20)     7293 2021-11-11 17:33:04.000000 distributed-2023.6.1/docs/source/journey.rst
+-rw-r--r--   0 james      (501) staff       (20)     6470 2023-06-02 19:58:01.000000 distributed-2023.6.1/docs/source/killed.rst
+-rw-r--r--   0 james      (501) staff       (20)     1828 2022-10-21 17:45:03.000000 distributed-2023.6.1/docs/source/limitations.rst
+-rw-r--r--   0 james      (501) staff       (20)     6458 2022-10-21 17:45:03.000000 distributed-2023.6.1/docs/source/locality.rst
+-rw-r--r--   0 james      (501) staff       (20)     2807 2021-11-11 17:33:04.000000 distributed-2023.6.1/docs/source/logging.rst
+-rw-r--r--   0 james      (501) staff       (20)     6546 2021-07-06 20:52:40.000000 distributed-2023.6.1/docs/source/manage-computation.rst
+-rw-r--r--   0 james      (501) staff       (20)     8550 2022-10-21 17:45:03.000000 distributed-2023.6.1/docs/source/memory.rst
+-rw-r--r--   0 james      (501) staff       (20)     4100 2023-02-14 16:13:20.000000 distributed-2023.6.1/docs/source/plugins.rst
+-rw-r--r--   0 james      (501) staff       (20)     3265 2021-11-11 21:43:12.000000 distributed-2023.6.1/docs/source/priority.rst
+-rw-r--r--   0 james      (501) staff       (20)     7481 2023-06-07 19:06:41.000000 distributed-2023.6.1/docs/source/prometheus.rst
+-rw-r--r--   0 james      (501) staff       (20)    11199 2022-10-21 17:45:03.000000 distributed-2023.6.1/docs/source/protocol.rst
+-rw-r--r--   0 james      (501) staff       (20)     3107 2020-12-18 22:54:04.000000 distributed-2023.6.1/docs/source/publish.rst
+-rw-r--r--   0 james      (501) staff       (20)      402 2023-06-02 19:58:01.000000 distributed-2023.6.1/docs/source/queues.rst
+-rw-r--r--   0 james      (501) staff       (20)     2942 2022-10-21 17:45:03.000000 distributed-2023.6.1/docs/source/quickstart.rst
+-rw-r--r--   0 james      (501) staff       (20)     8773 2022-10-21 17:45:03.000000 distributed-2023.6.1/docs/source/related-work.rst
+-rw-r--r--   0 james      (501) staff       (20)     3418 2022-10-21 17:45:03.000000 distributed-2023.6.1/docs/source/resilience.rst
+-rw-r--r--   0 james      (501) staff       (20)     6049 2022-11-15 18:24:05.000000 distributed-2023.6.1/docs/source/resources.rst
+-rw-r--r--   0 james      (501) staff       (20)    16084 2023-04-25 18:34:44.000000 distributed-2023.6.1/docs/source/scheduling-policies.rst
+-rw-r--r--   0 james      (501) staff       (20)    16901 2022-11-15 18:24:05.000000 distributed-2023.6.1/docs/source/scheduling-state.rst
+-rw-r--r--   0 james      (501) staff       (20)     6518 2021-11-11 17:33:04.000000 distributed-2023.6.1/docs/source/serialization.rst
+-rw-r--r--   0 james      (501) staff       (20)     8343 2022-08-08 21:17:38.000000 distributed-2023.6.1/docs/source/task-launch.rst
+-rw-r--r--   0 james      (501) staff       (20)     4190 2022-10-21 17:45:03.000000 distributed-2023.6.1/docs/source/tls.rst
+-rw-r--r--   0 james      (501) staff       (20)     5557 2021-11-11 17:33:04.000000 distributed-2023.6.1/docs/source/work-stealing.rst
+-rw-r--r--   0 james      (501) staff       (20)    13489 2023-04-25 18:34:44.000000 distributed-2023.6.1/docs/source/worker-memory.rst
+-rw-r--r--   0 james      (501) staff       (20)    22542 2023-06-02 19:58:01.000000 distributed-2023.6.1/docs/source/worker-state.rst
+-rw-r--r--   0 james      (501) staff       (20)     3467 2022-10-21 17:45:03.000000 distributed-2023.6.1/docs/source/worker.rst
+-rw-r--r--   0 james      (501) staff       (20)     8950 2023-06-26 20:30:43.000000 distributed-2023.6.1/pyproject.toml
+-rw-r--r--   0 james      (501) staff       (20)       38 2023-06-26 20:35:19.858047 distributed-2023.6.1/setup.cfg
+-rw-r--r--   0 james      (501) staff       (20)      171 2023-06-02 19:58:01.000000 distributed-2023.6.1/setup.py
```

### Comparing `distributed-2023.6.0/LICENSE.txt` & `distributed-2023.6.1/LICENSE.txt`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/MANIFEST.in` & `distributed-2023.6.1/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/PKG-INFO` & `distributed-2023.6.1/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: distributed
-Version: 2023.6.0
+Version: 2023.6.1
 Summary: Distributed scheduler for Dask
 Maintainer-email: Matthew Rocklin <mrocklin@gmail.com>
 License: BSD
 Project-URL: Homepage, https://distributed.dask.org
 Project-URL: Source, https://github.com/dask/distributed
 Classifier: Development Status :: 5 - Production/Stable
 Classifier: Intended Audience :: Developers
```

### Comparing `distributed-2023.6.0/README.rst` & `distributed-2023.6.1/README.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/__init__.py` & `distributed-2023.6.1/distributed/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/_concurrent_futures_thread.py` & `distributed-2023.6.1/distributed/_concurrent_futures_thread.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/_signals.py` & `distributed-2023.6.1/distributed/_signals.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/_stories.py` & `distributed-2023.6.1/distributed/_stories.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/active_memory_manager.py` & `distributed-2023.6.1/distributed/active_memory_manager.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/actor.py` & `distributed-2023.6.1/distributed/actor.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,58 +1,28 @@
 from __future__ import annotations
 
 import abc
-import asyncio
 import functools
-import sys
 import threading
 from collections.abc import Awaitable, Generator
 from dataclasses import dataclass
 from datetime import timedelta
 from typing import Generic, Literal, NoReturn, TypeVar
 
 from tornado.ioloop import IOLoop
 
 from distributed.client import Future
 from distributed.protocol import to_serialize
-from distributed.utils import iscoroutinefunction, sync, thread_state
+from distributed.utils import LateLoopEvent, iscoroutinefunction, sync, thread_state
 from distributed.utils_comm import WrappedKey
 from distributed.worker import get_client, get_worker
 
 _T = TypeVar("_T")
 
 
-if sys.version_info >= (3, 10):
-    from asyncio import Event as _LateLoopEvent
-else:
-    # In python 3.10 asyncio.Lock and other primitives no longer support
-    # passing a loop kwarg to bind to a loop running in another thread
-    # e.g. calling from Client(asynchronous=False). Instead the loop is bound
-    # as late as possible: when calling any methods that wait on or wake
-    # Future instances. See: https://bugs.python.org/issue42392
-    class _LateLoopEvent:
-        def __init__(self) -> None:
-            self._event: asyncio.Event | None = None
-
-        def set(self) -> None:
-            if self._event is None:
-                self._event = asyncio.Event()
-
-            self._event.set()
-
-        def is_set(self) -> bool:
-            return self._event is not None and self._event.is_set()
-
-        async def wait(self) -> bool:
-            if self._event is None:
-                self._event = asyncio.Event()
-
-            return await self._event.wait()
-
-
 class Actor(WrappedKey):
     """Controls an object on a remote worker
 
     An actor allows remote control of a stateful object living on a remote
     worker.  Method calls on this object trigger operations on the remote
     object and return BaseActorFutures on which we can block to get results.
 
@@ -318,15 +288,15 @@
     def unwrap(self) -> NoReturn:
         raise self._e
 
 
 class ActorFuture(BaseActorFuture[_T]):
     def __init__(self, io_loop: IOLoop):
         self._io_loop = io_loop
-        self._event = _LateLoopEvent()
+        self._event = LateLoopEvent()
         self._out: _Error | _OK[_T] | None = None
 
     def __await__(self) -> Generator[object, None, _T]:
         return self._result().__await__()
 
     def done(self) -> bool:
         return self._event.is_set()
```

### Comparing `distributed-2023.6.0/distributed/batched.py` & `distributed-2023.6.1/distributed/batched.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/cfexecutor.py` & `distributed-2023.6.1/distributed/cfexecutor.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/chaos.py` & `distributed-2023.6.1/distributed/chaos.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/cli/dask_scheduler.py` & `distributed-2023.6.1/distributed/cli/dask_scheduler.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/cli/dask_spec.py` & `distributed-2023.6.1/distributed/cli/dask_spec.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/cli/dask_ssh.py` & `distributed-2023.6.1/distributed/cli/dask_ssh.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/cli/dask_worker.py` & `distributed-2023.6.1/distributed/cli/dask_worker.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/cli/utils.py` & `distributed-2023.6.1/distributed/cli/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/client.py` & `distributed-2023.6.1/distributed/client.py`

 * *Files 0% similar despite different names*

```diff
@@ -3104,15 +3104,15 @@
                 raise TypeError("allow_other_workers= must be True, False, or None")
             if allow_other_workers:
                 annotations["allow_other_workers"] = allow_other_workers
             if resources:
                 annotations["resources"] = resources
 
             # Merge global and local annotations
-            annotations = merge(dask.config.get("annotations", {}), annotations)
+            annotations = merge(dask.get_annotations(), annotations)
 
             # Pack the high level graph before sending it to the scheduler
             keyset = set(keys)
 
             # Create futures before sending graph (helps avoid contention)
             futures = {key: Future(key, self, inform=False) for key in keyset}
             # Circular import
```

### Comparing `distributed-2023.6.0/distributed/cluster_dump.py` & `distributed-2023.6.1/distributed/cluster_dump.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/collections.py` & `distributed-2023.6.1/distributed/collections.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,14 +1,14 @@
 from __future__ import annotations
 
 import heapq
 import itertools
 import weakref
 from collections import OrderedDict, UserDict
-from collections.abc import Callable, Hashable, Iterator, MutableSet
+from collections.abc import Callable, Hashable, Iterable, Iterator, Mapping, MutableSet
 from typing import Any, TypeVar, cast
 
 T = TypeVar("T", bound=Hashable)
 K = TypeVar("K", bound=Hashable)
 V = TypeVar("V")
 
 
@@ -194,7 +194,21 @@
                 yield value
                 seen.add(value)
 
     def clear(self) -> None:
         self._data.clear()
         self._heap.clear()
         self._sorted = True
+
+
+def sum_mappings(ds: Iterable[Mapping[K, V] | Iterable[tuple[K, V]]], /) -> dict[K, V]:
+    """Sum the values of the given mappings, key by key"""
+    out: dict[K, V] = {}
+    for d in ds:
+        if isinstance(d, Mapping):
+            d = d.items()
+        for k, v in d:
+            try:
+                out[k] += v  # type: ignore
+            except KeyError:
+                out[k] = v
+    return out
```

### Comparing `distributed-2023.6.0/distributed/comm/__init__.py` & `distributed-2023.6.1/distributed/comm/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/comm/addressing.py` & `distributed-2023.6.1/distributed/comm/addressing.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/comm/asyncio_tcp.py` & `distributed-2023.6.1/distributed/comm/asyncio_tcp.py`

 * *Files 1% similar despite different names*

```diff
@@ -13,15 +13,15 @@
 from collections.abc import Callable
 from itertools import islice
 from typing import Any
 
 import dask
 
 from distributed.comm.addressing import parse_host_port, unparse_host_port
-from distributed.comm.core import Comm, CommClosedError, Connector, Listener
+from distributed.comm.core import BaseListener, Comm, CommClosedError, Connector
 from distributed.comm.registry import Backend
 from distributed.comm.utils import (
     ensure_concrete_host,
     from_frames,
     host_array,
     to_frames,
 )
@@ -590,28 +590,29 @@
     comm_class = TLS
 
     def _get_extra_kwargs(self, address: str, **kwargs: Any) -> dict[str, Any]:
         ctx = _expect_tls_context(kwargs)
         return {"ssl": ctx}
 
 
-class TCPListener(Listener):
+class TCPListener(BaseListener):
     prefix = "tcp://"
     comm_class = TCP
 
     def __init__(
         self,
         address,
         comm_handler,
         deserialize=True,
         allow_offload=True,
         default_host=None,
         default_port=0,
         **kwargs,
     ):
+        super().__init__()
         self.ip, self.port = parse_host_port(address, default_port)
         self.default_host = default_host
         self.comm_handler = comm_handler
         self.deserialize = deserialize
         self.allow_offload = allow_offload
         self._extra_kwargs = self._get_extra_kwargs(address, **kwargs)
         self.bound_address = None
```

### Comparing `distributed-2023.6.0/distributed/comm/core.py` & `distributed-2023.6.1/distributed/comm/core.py`

 * *Files 2% similar despite different names*

```diff
@@ -285,14 +285,33 @@
         comm.local_info["address"] = comm.local_address
 
         comm.handshake_options = comm.handshake_configuration(
             comm.local_info, comm.remote_info
         )
 
 
+class BaseListener(Listener):
+    def __init__(self) -> None:
+        self.__comms: set[Comm] = set()
+
+    async def on_connection(
+        self, comm: Comm, handshake_overrides: dict[str, Any] | None = None
+    ) -> None:
+        self.__comms.add(comm)
+        try:
+            return await super().on_connection(comm, handshake_overrides)
+        finally:
+            self.__comms.discard(comm)
+
+    def abort_handshaking_comms(self) -> None:
+        comms, self.__comms = self.__comms, set()
+        for comm in comms:
+            comm.abort()
+
+
 class Connector(ABC):
     @abstractmethod
     async def connect(self, address, deserialize=True):
         """
         Connect to the given address and return a Comm object.
         This function returns a coroutine. It may raise EnvironmentError
         if the other endpoint is unreachable or unavailable.  It
```

### Comparing `distributed-2023.6.0/distributed/comm/inproc.py` & `distributed-2023.6.1/distributed/comm/inproc.py`

 * *Files 2% similar despite different names*

```diff
@@ -7,15 +7,15 @@
 import threading
 import weakref
 from collections import deque, namedtuple
 
 from tornado.concurrent import Future
 from tornado.ioloop import IOLoop
 
-from distributed.comm.core import Comm, CommClosedError, Connector, Listener
+from distributed.comm.core import BaseListener, Comm, CommClosedError, Connector
 from distributed.comm.registry import Backend, backends
 from distributed.protocol import nested_deserialize
 from distributed.utils import get_ip
 
 logger = logging.getLogger(__name__)
 
 ConnectionRequest = namedtuple(
@@ -253,18 +253,19 @@
             self._closed = True
             self._finalizer.detach()
             return True
         else:
             return False
 
 
-class InProcListener(Listener):
+class InProcListener(BaseListener):
     prefix = "inproc"
 
     def __init__(self, address, comm_handler, deserialize=True):
+        super().__init__()
         self.manager = global_manager
         self.address = address or self.manager.new_address()
         self.comm_handler = comm_handler
         self.deserialize = deserialize
         self.listen_q = Queue()
 
     async def _handle_stream(self, comm):
```

### Comparing `distributed-2023.6.0/distributed/comm/registry.py` & `distributed-2023.6.1/distributed/comm/registry.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/comm/tcp.py` & `distributed-2023.6.1/distributed/comm/tcp.py`

 * *Files 0% similar despite different names*

```diff
@@ -20,19 +20,19 @@
 from tornado.tcpserver import TCPServer
 
 import dask
 from dask.utils import parse_timedelta
 
 from distributed.comm.addressing import parse_host_port, unparse_host_port
 from distributed.comm.core import (
+    BaseListener,
     Comm,
     CommClosedError,
     Connector,
     FatalCommClosedError,
-    Listener,
 )
 from distributed.comm.registry import Backend
 from distributed.comm.utils import (
     ensure_concrete_host,
     from_frames,
     get_tcp_server_address,
     host_array,
@@ -535,25 +535,26 @@
     def _get_connect_args(self, **connection_args):
         tls_args = {"ssl_options": _expect_tls_context(connection_args)}
         if connection_args.get("server_hostname"):
             tls_args["server_hostname"] = connection_args["server_hostname"]
         return tls_args
 
 
-class BaseTCPListener(Listener, RequireEncryptionMixin):
+class BaseTCPListener(BaseListener, RequireEncryptionMixin):
     def __init__(
         self,
         address,
         comm_handler,
         deserialize=True,
         allow_offload=True,
         default_host=None,
         default_port=0,
         **connection_args,
     ):
+        super().__init__()
         self._check_encryption(address, connection_args)
         self.ip, self.port = parse_host_port(address, default_port)
         self.default_host = default_host
         self.comm_handler = comm_handler
         self.deserialize = deserialize
         self.allow_offload = allow_offload
         self.server_args = self._get_server_args(**connection_args)
```

### Comparing `distributed-2023.6.0/distributed/comm/ucx.py` & `distributed-2023.6.1/distributed/comm/ucx.py`

 * *Files 1% similar despite different names*

```diff
@@ -16,15 +16,15 @@
 from typing import TYPE_CHECKING, Any
 from unittest.mock import patch
 
 import dask
 from dask.utils import parse_bytes
 
 from distributed.comm.addressing import parse_host_port, unparse_host_port
-from distributed.comm.core import Comm, CommClosedError, Connector, Listener
+from distributed.comm.core import BaseListener, Comm, CommClosedError, Connector
 from distributed.comm.registry import Backend, backends
 from distributed.comm.utils import (
     ensure_concrete_host,
     from_frames,
     host_array,
     to_frames,
 )
@@ -475,27 +475,28 @@
             ep,
             local_addr="",
             peer_addr=self.prefix + address,
             deserialize=deserialize,
         )
 
 
-class UCXListener(Listener):
+class UCXListener(BaseListener):
     prefix = UCXConnector.prefix
     comm_class = UCXConnector.comm_class
     encrypted = UCXConnector.encrypted
 
     def __init__(
         self,
         address: str,
         comm_handler: Callable[[UCX], Awaitable[None]] | None = None,
         deserialize: bool = False,
         allow_offload: bool = True,
         **connection_args: Any,
     ):
+        super().__init__()
         if not address.startswith("ucx"):
             address = "ucx://" + address
         self.ip, self._input_port = parse_host_port(address, default_port=0)
         self.comm_handler = comm_handler
         self.deserialize = deserialize
         self.allow_offload = allow_offload
         self._ep = None  # type: ucp.Endpoint
```

### Comparing `distributed-2023.6.0/distributed/comm/utils.py` & `distributed-2023.6.1/distributed/comm/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/comm/ws.py` & `distributed-2023.6.1/distributed/comm/ws.py`

 * *Files 0% similar despite different names*

```diff
@@ -21,19 +21,19 @@
     websocket_connect,
 )
 
 import dask
 
 from distributed.comm.addressing import parse_host_port, unparse_host_port
 from distributed.comm.core import (
+    BaseListener,
     Comm,
     CommClosedError,
     Connector,
     FatalCommClosedError,
-    Listener,
 )
 from distributed.comm.registry import backends
 from distributed.comm.tcp import (
     BaseTCPBackend,
     _expect_tls_context,
     convert_stream_closed_error,
 )
@@ -328,25 +328,26 @@
                 self._peer_addr,
                 proto,
                 cipher,
                 bits,
             )
 
 
-class WSListener(Listener):
+class WSListener(BaseListener):
     prefix = "ws://"
 
     def __init__(
         self,
         address: str,
         handler: Callable,
         deserialize: bool = True,
         allow_offload: bool = False,
         **connection_args: Any,
     ):
+        super().__init__()
         if not address.startswith(self.prefix):
             address = f"{self.prefix}{address}"
 
         self.ip, self.port = parse_host_port(address, default_port=0)
         self.handler = handler
         self.deserialize = deserialize
         self.allow_offload = allow_offload
```

### Comparing `distributed-2023.6.0/distributed/compatibility.py` & `distributed-2023.6.1/distributed/compatibility.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/config.py` & `distributed-2023.6.1/distributed/config.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/core.py` & `distributed-2023.6.1/distributed/core.py`

 * *Files 1% similar despite different names*

```diff
@@ -669,14 +669,20 @@
 
         self.__stopped = True
         _stops = set()
         for listener in self.listeners:
             future = listener.stop()
             if inspect.isawaitable(future):
                 _stops.add(future)
+            try:
+                abort_handshaking_comms = listener.abort_handshaking_comms
+            except AttributeError:
+                pass
+            else:
+                abort_handshaking_comms()
 
         if _stops:
 
             async def background_stops():
                 await asyncio.gather(*_stops)
 
             self._ongoing_background_tasks.call_soon(background_stops)
@@ -1033,14 +1039,20 @@
                     if inspect.isawaitable(future):
                         warnings.warn(
                             f"{type(listener)} is using an asynchronous `stop` method. "
                             "Support for asynchronous `Listener.stop` will be removed in a future version",
                             PendingDeprecationWarning,
                         )
                         _stops.add(future)
+                    try:
+                        abort_handshaking_comms = listener.abort_handshaking_comms
+                    except AttributeError:
+                        pass
+                    else:
+                        abort_handshaking_comms()
                 if _stops:
                     await asyncio.gather(*_stops)
 
             # TODO: Deal with exceptions
             await self._ongoing_background_tasks.stop()
 
             await self.rpc.close()
@@ -1551,14 +1563,16 @@
         finally:
             self._pending_count -= 1
 
     async def connect(self, addr: str, timeout: float | None = None) -> Comm:
         """
         Get a Comm to the given address.  For internal use.
         """
+        if self.status != Status.running:
+            raise RuntimeError("ConnectionPool is closed")
         available = self.available[addr]
         occupied = self.occupied[addr]
         while available:
             comm = available.pop()
             if comm.closed():
                 self.semaphore.release()
             else:
```

### Comparing `distributed-2023.6.0/distributed/counter.py` & `distributed-2023.6.1/distributed/counter.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/dashboard/components/__init__.py` & `distributed-2023.6.1/distributed/dashboard/components/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/dashboard/components/nvml.py` & `distributed-2023.6.1/distributed/dashboard/components/nvml.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/dashboard/components/rmm.py` & `distributed-2023.6.1/distributed/dashboard/components/rmm.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/dashboard/components/scheduler.py` & `distributed-2023.6.1/distributed/dashboard/components/scheduler.py`

 * *Files 2% similar despite different names*

```diff
@@ -6,10021 +6,10157 @@
 00000050: 6d70 6f72 7420 6f73 0a66 726f 6d20 636f  mport os.from co
 00000060: 6c6c 6563 7469 6f6e 7320 696d 706f 7274  llections import
 00000070: 204f 7264 6572 6564 4469 6374 2c20 6465   OrderedDict, de
 00000080: 6661 756c 7464 6963 740a 6672 6f6d 2063  faultdict.from c
 00000090: 6f6c 6c65 6374 696f 6e73 2e61 6263 2069  ollections.abc i
 000000a0: 6d70 6f72 7420 4974 6572 6162 6c65 0a66  mport Iterable.f
 000000b0: 726f 6d20 6461 7465 7469 6d65 2069 6d70  rom datetime imp
-000000c0: 6f72 7420 6461 7465 7469 6d65 2c20 7469  ort datetime, ti
-000000d0: 6d65 6465 6c74 610a 6672 6f6d 2069 7465  medelta.from ite
-000000e0: 7274 6f6f 6c73 2069 6d70 6f72 7420 6368  rtools import ch
-000000f0: 6169 6e0a 6672 6f6d 206e 756d 6265 7273  ain.from numbers
-00000100: 2069 6d70 6f72 7420 4e75 6d62 6572 0a66   import Number.f
-00000110: 726f 6d20 7479 7069 6e67 2069 6d70 6f72  rom typing impor
-00000120: 7420 416e 792c 2054 7970 6556 6172 0a0a  t Any, TypeVar..
-00000130: 696d 706f 7274 206e 756d 7079 2061 7320  import numpy as 
-00000140: 6e70 0a66 726f 6d20 626f 6b65 682e 636f  np.from bokeh.co
-00000150: 7265 2e70 726f 7065 7274 6965 7320 696d  re.properties im
-00000160: 706f 7274 2076 616c 7565 2c20 7769 7468  port value, with
-00000170: 6f75 745f 7072 6f70 6572 7479 5f76 616c  out_property_val
-00000180: 6964 6174 696f 6e0a 6672 6f6d 2062 6f6b  idation.from bok
-00000190: 6568 2e69 6f20 696d 706f 7274 2063 7572  eh.io import cur
-000001a0: 646f 630a 6672 6f6d 2062 6f6b 6568 2e6c  doc.from bokeh.l
-000001b0: 6179 6f75 7473 2069 6d70 6f72 7420 636f  ayouts import co
-000001c0: 6c75 6d6e 2c20 726f 770a 6672 6f6d 2062  lumn, row.from b
-000001d0: 6f6b 6568 2e6d 6f64 656c 7320 696d 706f  okeh.models impo
-000001e0: 7274 2028 0a20 2020 2041 6461 7074 6976  rt (.    Adaptiv
-000001f0: 6554 6963 6b65 722c 0a20 2020 2041 7272  eTicker,.    Arr
-00000200: 6f77 2c0a 2020 2020 4261 7369 6354 6963  ow,.    BasicTic
-00000210: 6b65 722c 0a20 2020 2042 6f78 5365 6c65  ker,.    BoxSele
-00000220: 6374 546f 6f6c 2c0a 2020 2020 426f 785a  ctTool,.    BoxZ
-00000230: 6f6f 6d54 6f6f 6c2c 0a20 2020 2043 4453  oomTool,.    CDS
-00000240: 5669 6577 2c0a 2020 2020 436f 6c6f 7242  View,.    ColorB
-00000250: 6172 2c0a 2020 2020 436f 6c75 6d6e 4461  ar,.    ColumnDa
-00000260: 7461 536f 7572 6365 2c0a 2020 2020 4375  taSource,.    Cu
-00000270: 7374 6f6d 4a53 486f 7665 722c 0a20 2020  stomJSHover,.   
-00000280: 2044 6174 6152 616e 6765 3164 2c0a 2020   DataRange1d,.  
-00000290: 2020 4661 6374 6f72 5261 6e67 652c 0a20    FactorRange,. 
-000002a0: 2020 2047 726f 7570 4669 6c74 6572 2c0a     GroupFilter,.
-000002b0: 2020 2020 4865 6c70 546f 6f6c 2c0a 2020      HelpTool,.  
-000002c0: 2020 486f 7665 7254 6f6f 6c2c 0a20 2020    HoverTool,.   
-000002d0: 2048 544d 4c54 656d 706c 6174 6546 6f72   HTMLTemplateFor
-000002e0: 6d61 7474 6572 2c0a 2020 2020 4d75 6c74  matter,.    Mult
-000002f0: 6943 686f 6963 652c 0a20 2020 204e 756d  iChoice,.    Num
-00000300: 6265 7246 6f72 6d61 7474 6572 2c0a 2020  berFormatter,.  
-00000310: 2020 4e75 6d65 7261 6c54 6963 6b46 6f72    NumeralTickFor
-00000320: 6d61 7474 6572 2c0a 2020 2020 4f70 656e  matter,.    Open
-00000330: 5552 4c2c 0a20 2020 2050 616e 546f 6f6c  URL,.    PanTool
-00000340: 2c0a 2020 2020 5261 6e67 6531 642c 0a20  ,.    Range1d,. 
-00000350: 2020 2052 6573 6574 546f 6f6c 2c0a 2020     ResetTool,.  
-00000360: 2020 5365 6c65 6374 2c0a 2020 2020 5461    Select,.    Ta
-00000370: 6273 2c0a 2020 2020 5461 7054 6f6f 6c2c  bs,.    TapTool,
-00000380: 0a20 2020 2054 6974 6c65 2c0a 2020 2020  .    Title,.    
-00000390: 5665 6548 6561 642c 0a20 2020 2057 6865  VeeHead,.    Whe
-000003a0: 656c 5a6f 6f6d 546f 6f6c 2c0a 290a 6672  elZoomTool,.).fr
-000003b0: 6f6d 2062 6f6b 6568 2e6d 6f64 656c 732e  om bokeh.models.
-000003c0: 7769 6467 6574 7320 696d 706f 7274 2044  widgets import D
-000003d0: 6174 6154 6162 6c65 2c20 5461 626c 6543  ataTable, TableC
-000003e0: 6f6c 756d 6e0a 6672 6f6d 2062 6f6b 6568  olumn.from bokeh
-000003f0: 2e6d 6f64 656c 732e 7769 6467 6574 732e  .models.widgets.
-00000400: 6d61 726b 7570 7320 696d 706f 7274 2044  markups import D
-00000410: 6976 0a66 726f 6d20 626f 6b65 682e 7061  iv.from bokeh.pa
-00000420: 6c65 7474 6573 2069 6d70 6f72 7420 5669  lettes import Vi
-00000430: 7269 6469 7331 312c 2059 6c47 6e42 7539  ridis11, YlGnBu9
-00000440: 2c20 696e 7465 7270 5f70 616c 6574 7465  , interp_palette
-00000450: 0a66 726f 6d20 626f 6b65 682e 706c 6f74  .from bokeh.plot
-00000460: 7469 6e67 2069 6d70 6f72 7420 6669 6775  ting import figu
-00000470: 7265 0a66 726f 6d20 626f 6b65 682e 7468  re.from bokeh.th
-00000480: 656d 6573 2069 6d70 6f72 7420 5468 656d  emes import Them
-00000490: 650a 6672 6f6d 2062 6f6b 6568 2e74 7261  e.from bokeh.tra
-000004a0: 6e73 666f 726d 2069 6d70 6f72 7420 6375  nsform import cu
-000004b0: 6d73 756d 2c20 6661 6374 6f72 5f63 6d61  msum, factor_cma
-000004c0: 702c 206c 696e 6561 725f 636d 6170 2c20  p, linear_cmap, 
-000004d0: 7374 6163 6b0a 6672 6f6d 206a 696e 6a61  stack.from jinja
-000004e0: 3220 696d 706f 7274 2045 6e76 6972 6f6e  2 import Environ
-000004f0: 6d65 6e74 2c20 4669 6c65 5379 7374 656d  ment, FileSystem
-00000500: 4c6f 6164 6572 0a66 726f 6d20 746c 7a20  Loader.from tlz 
-00000510: 696d 706f 7274 2063 7572 7279 2c20 7069  import curry, pi
-00000520: 7065 2c20 7661 6c6d 6170 0a66 726f 6d20  pe, valmap.from 
-00000530: 746c 7a2e 6375 7272 6965 6420 696d 706f  tlz.curried impo
-00000540: 7274 2063 6f6e 6361 742c 2067 726f 7570  rt concat, group
-00000550: 6279 2c20 6d61 700a 6672 6f6d 2074 6f72  by, map.from tor
-00000560: 6e61 646f 2069 6d70 6f72 7420 6573 6361  nado import esca
-00000570: 7065 0a0a 696d 706f 7274 2064 6173 6b0a  pe..import dask.
-00000580: 6672 6f6d 2064 6173 6b20 696d 706f 7274  from dask import
-00000590: 2063 6f6e 6669 670a 6672 6f6d 2064 6173   config.from das
-000005a0: 6b2e 7574 696c 7320 696d 706f 7274 2028  k.utils import (
-000005b0: 0a20 2020 2066 6f72 6d61 745f 6279 7465  .    format_byte
-000005c0: 732c 0a20 2020 2066 6f72 6d61 745f 7469  s,.    format_ti
-000005d0: 6d65 2c0a 2020 2020 6675 6e63 6e61 6d65  me,.    funcname
-000005e0: 2c0a 2020 2020 6b65 795f 7370 6c69 742c  ,.    key_split,
-000005f0: 0a20 2020 2070 6172 7365 5f62 7974 6573  .    parse_bytes
-00000600: 2c0a 2020 2020 7061 7273 655f 7469 6d65  ,.    parse_time
-00000610: 6465 6c74 612c 0a29 0a0a 6672 6f6d 2064  delta,.)..from d
-00000620: 6973 7472 6962 7574 6564 2e63 6f72 6520  istributed.core 
-00000630: 696d 706f 7274 2053 7461 7475 730a 6672  import Status.fr
-00000640: 6f6d 2064 6973 7472 6962 7574 6564 2e64  om distributed.d
-00000650: 6173 6862 6f61 7264 2e63 6f6d 706f 6e65  ashboard.compone
-00000660: 6e74 7320 696d 706f 7274 2061 6464 5f70  nts import add_p
-00000670: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
-00000680: 0a66 726f 6d20 6469 7374 7269 6275 7465  .from distribute
-00000690: 642e 6461 7368 626f 6172 642e 636f 6d70  d.dashboard.comp
-000006a0: 6f6e 656e 7473 2e73 6861 7265 6420 696d  onents.shared im
-000006b0: 706f 7274 2028 0a20 2020 2044 6173 6862  port (.    Dashb
-000006c0: 6f61 7264 436f 6d70 6f6e 656e 742c 0a20  oardComponent,. 
-000006d0: 2020 2050 726f 6669 6c65 5365 7276 6572     ProfileServer
-000006e0: 2c0a 2020 2020 5072 6f66 696c 6554 696d  ,.    ProfileTim
-000006f0: 6550 6c6f 742c 0a20 2020 2053 7973 7465  ePlot,.    Syste
-00000700: 6d4d 6f6e 6974 6f72 2c0a 290a 6672 6f6d  mMonitor,.).from
-00000710: 2064 6973 7472 6962 7574 6564 2e64 6173   distributed.das
-00000720: 6862 6f61 7264 2e63 6f72 6520 696d 706f  hboard.core impo
-00000730: 7274 2054 6162 5061 6e65 6c0a 6672 6f6d  rt TabPanel.from
-00000740: 2064 6973 7472 6962 7574 6564 2e64 6173   distributed.das
-00000750: 6862 6f61 7264 2e75 7469 6c73 2069 6d70  hboard.utils imp
-00000760: 6f72 7420 280a 2020 2020 5f44 4154 4154  ort (.    _DATAT
-00000770: 4142 4c45 5f53 5459 4c45 5348 4545 5453  ABLE_STYLESHEETS
-00000780: 5f4b 5741 5247 532c 0a20 2020 2042 4f4b  _KWARGS,.    BOK
-00000790: 4548 5f56 4552 5349 4f4e 2c0a 2020 2020  EH_VERSION,.    
-000007a0: 5052 4f46 494c 494e 472c 0a20 2020 2074  PROFILING,.    t
-000007b0: 7261 6e73 706f 7365 2c0a 2020 2020 7570  ranspose,.    up
-000007c0: 6461 7465 2c0a 290a 6672 6f6d 2064 6973  date,.).from dis
-000007d0: 7472 6962 7574 6564 2e64 6961 676e 6f73  tributed.diagnos
-000007e0: 7469 6373 2e67 7261 7068 5f6c 6179 6f75  tics.graph_layou
-000007f0: 7420 696d 706f 7274 2047 7261 7068 4c61  t import GraphLa
-00000800: 796f 7574 0a66 726f 6d20 6469 7374 7269  yout.from distri
-00000810: 6275 7465 642e 6469 6167 6e6f 7374 6963  buted.diagnostic
-00000820: 732e 7072 6f67 7265 7373 2069 6d70 6f72  s.progress impor
-00000830: 7420 4772 6f75 7054 696d 696e 670a 6672  t GroupTiming.fr
-00000840: 6f6d 2064 6973 7472 6962 7574 6564 2e64  om distributed.d
-00000850: 6961 676e 6f73 7469 6373 2e70 726f 6772  iagnostics.progr
-00000860: 6573 735f 7374 7265 616d 2069 6d70 6f72  ess_stream impor
-00000870: 7420 636f 6c6f 725f 6f66 2c20 7072 6f67  t color_of, prog
-00000880: 7265 7373 5f71 7561 6473 0a66 726f 6d20  ress_quads.from 
-00000890: 6469 7374 7269 6275 7465 642e 6469 6167  distributed.diag
-000008a0: 6e6f 7374 6963 732e 7461 736b 5f73 7472  nostics.task_str
-000008b0: 6561 6d20 696d 706f 7274 2054 6173 6b53  eam import TaskS
-000008c0: 7472 6561 6d50 6c75 6769 6e0a 6672 6f6d  treamPlugin.from
-000008d0: 2064 6973 7472 6962 7574 6564 2e64 6961   distributed.dia
-000008e0: 676e 6f73 7469 6373 2e74 6173 6b5f 7374  gnostics.task_st
-000008f0: 7265 616d 2069 6d70 6f72 7420 636f 6c6f  ream import colo
-00000900: 725f 6f66 2061 7320 7473 5f63 6f6c 6f72  r_of as ts_color
-00000910: 5f6f 660a 6672 6f6d 2064 6973 7472 6962  _of.from distrib
-00000920: 7574 6564 2e64 6961 676e 6f73 7469 6373  uted.diagnostics
-00000930: 2e74 6173 6b5f 7374 7265 616d 2069 6d70  .task_stream imp
-00000940: 6f72 7420 636f 6c6f 7273 2061 7320 7473  ort colors as ts
-00000950: 5f63 6f6c 6f72 5f6c 6f6f 6b75 700a 6672  _color_lookup.fr
-00000960: 6f6d 2064 6973 7472 6962 7574 6564 2e6d  om distributed.m
-00000970: 6574 7269 6373 2069 6d70 6f72 7420 7469  etrics import ti
-00000980: 6d65 0a66 726f 6d20 6469 7374 7269 6275  me.from distribu
-00000990: 7465 642e 7363 6865 6475 6c65 7220 696d  ted.scheduler im
-000009a0: 706f 7274 2053 6368 6564 756c 6572 0a66  port Scheduler.f
-000009b0: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
-000009c0: 7574 696c 7320 696d 706f 7274 204c 6f67  utils import Log
-000009d0: 2c20 6c6f 675f 6572 726f 7273 0a0a 6966  , log_errors..if
-000009e0: 2064 6173 6b2e 636f 6e66 6967 2e67 6574   dask.config.get
-000009f0: 2822 6469 7374 7269 6275 7465 642e 6461  ("distributed.da
-00000a00: 7368 626f 6172 642e 6578 706f 7274 2d74  shboard.export-t
-00000a10: 6f6f 6c22 293a 0a20 2020 2066 726f 6d20  ool"):.    from 
-00000a20: 6469 7374 7269 6275 7465 642e 6461 7368  distributed.dash
-00000a30: 626f 6172 642e 6578 706f 7274 5f74 6f6f  board.export_too
-00000a40: 6c20 696d 706f 7274 2045 7870 6f72 7454  l import ExportT
-00000a50: 6f6f 6c0a 656c 7365 3a0a 2020 2020 4578  ool.else:.    Ex
-00000a60: 706f 7274 546f 6f6c 203d 204e 6f6e 6520  portTool = None 
-00000a70: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
-00000a80: 0a54 203d 2054 7970 6556 6172 2822 5422  .T = TypeVar("T"
-00000a90: 290a 0a6c 6f67 6765 7220 3d20 6c6f 6767  )..logger = logg
-00000aa0: 696e 672e 6765 744c 6f67 6765 7228 5f5f  ing.getLogger(__
-00000ab0: 6e61 6d65 5f5f 290a 0a65 6e76 203d 2045  name__)..env = E
-00000ac0: 6e76 6972 6f6e 6d65 6e74 280a 2020 2020  nvironment(.    
-00000ad0: 6c6f 6164 6572 3d46 696c 6553 7973 7465  loader=FileSyste
-00000ae0: 6d4c 6f61 6465 7228 0a20 2020 2020 2020  mLoader(.       
-00000af0: 206f 732e 7061 7468 2e6a 6f69 6e28 6f73   os.path.join(os
-00000b00: 2e70 6174 682e 6469 726e 616d 6528 5f5f  .path.dirname(__
-00000b10: 6669 6c65 5f5f 292c 2022 2e2e 222c 2022  file__), "..", "
-00000b20: 2e2e 222c 2022 6874 7470 222c 2022 7465  ..", "http", "te
-00000b30: 6d70 6c61 7465 7322 290a 2020 2020 290a  mplates").    ).
-00000b40: 290a 0a42 4f4b 4548 5f54 4845 4d45 203d  )..BOKEH_THEME =
-00000b50: 2054 6865 6d65 280a 2020 2020 6669 6c65   Theme(.    file
-00000b60: 6e61 6d65 3d6f 732e 7061 7468 2e6a 6f69  name=os.path.joi
-00000b70: 6e28 6f73 2e70 6174 682e 6469 726e 616d  n(os.path.dirnam
-00000b80: 6528 5f5f 6669 6c65 5f5f 292c 2022 2e2e  e(__file__), "..
-00000b90: 222c 2022 7468 656d 652e 7961 6d6c 2229  ", "theme.yaml")
-00000ba0: 0a29 0a54 4943 4b53 5f31 3032 3420 3d20  .).TICKS_1024 = 
-00000bb0: 7b22 6261 7365 223a 2031 3032 342c 2022  {"base": 1024, "
-00000bc0: 6d61 6e74 6973 7361 7322 3a20 5b31 2c20  mantissas": [1, 
-00000bd0: 322c 2034 2c20 382c 2031 362c 2033 322c  2, 4, 8, 16, 32,
-00000be0: 2036 342c 2031 3238 2c20 3235 362c 2035   64, 128, 256, 5
-00000bf0: 3132 5d7d 0a58 4c41 4245 4c5f 4f52 4945  12]}.XLABEL_ORIE
-00000c00: 4e54 4154 494f 4e20 3d20 2d6d 6174 682e  NTATION = -math.
-00000c10: 7069 202f 2039 2020 2320 736c 616e 7465  pi / 9  # slante
-00000c20: 6420 646f 776e 7761 7264 7320 3230 2064  d downwards 20 d
-00000c30: 6567 7265 6573 0a0a 0a6c 6f67 6f73 5f64  egrees...logos_d
-00000c40: 6963 7420 3d20 7b0a 2020 2020 226e 756d  ict = {.    "num
-00000c50: 7079 223a 2022 7374 6174 6963 732f 696d  py": "statics/im
-00000c60: 6167 6573 2f6e 756d 7079 2e70 6e67 222c  ages/numpy.png",
-00000c70: 0a20 2020 2022 7061 6e64 6173 223a 2022  .    "pandas": "
-00000c80: 7374 6174 6963 732f 696d 6167 6573 2f70  statics/images/p
-00000c90: 616e 6461 732e 706e 6722 2c0a 2020 2020  andas.png",.    
-00000ca0: 2262 7569 6c74 696e 7322 3a20 2273 7461  "builtins": "sta
-00000cb0: 7469 6373 2f69 6d61 6765 732f 7079 7468  tics/images/pyth
-00000cc0: 6f6e 2e70 6e67 222c 0a7d 0a0a 0a63 6c61  on.png",.}...cla
-00000cd0: 7373 204f 6363 7570 616e 6379 2844 6173  ss Occupancy(Das
-00000ce0: 6862 6f61 7264 436f 6d70 6f6e 656e 7429  hboardComponent)
-00000cf0: 3a0a 2020 2020 2222 224f 6363 7570 616e  :.    """Occupan
-00000d00: 6379 2028 696e 2074 696d 6529 2070 6572  cy (in time) per
-00000d10: 2077 6f72 6b65 7222 2222 0a0a 2020 2020   worker"""..    
-00000d20: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
-00000d30: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
-00000d40: 662c 2073 6368 6564 756c 6572 2c20 2a2a  f, scheduler, **
-00000d50: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
-00000d60: 2073 656c 662e 7363 6865 6475 6c65 7220   self.scheduler 
-00000d70: 3d20 7363 6865 6475 6c65 720a 2020 2020  = scheduler.    
-00000d80: 2020 2020 7365 6c66 2e73 6f75 7263 6520      self.source 
-00000d90: 3d20 436f 6c75 6d6e 4461 7461 536f 7572  = ColumnDataSour
-00000da0: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
-00000db0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00000dc0: 2020 226f 6363 7570 616e 6379 223a 205b    "occupancy": [
-00000dd0: 302c 2030 5d2c 0a20 2020 2020 2020 2020  0, 0],.         
-00000de0: 2020 2020 2020 2022 776f 726b 6572 223a         "worker":
-00000df0: 205b 2261 222c 2022 6222 5d2c 0a20 2020   ["a", "b"],.   
-00000e00: 2020 2020 2020 2020 2020 2020 2022 7822               "x"
-00000e10: 3a20 5b30 2e30 2c20 302e 315d 2c0a 2020  : [0.0, 0.1],.  
-00000e20: 2020 2020 2020 2020 2020 2020 2020 2279                "y
-00000e30: 223a 205b 312c 2032 5d2c 0a20 2020 2020  ": [1, 2],.     
-00000e40: 2020 2020 2020 2020 2020 2022 6d73 223a             "ms":
-00000e50: 205b 312c 2032 5d2c 0a20 2020 2020 2020   [1, 2],.       
-00000e60: 2020 2020 2020 2020 2022 636f 6c6f 7222           "color"
-00000e70: 3a20 5b22 7265 6422 2c20 2262 6c75 6522  : ["red", "blue"
-00000e80: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00000e90: 2020 2022 6573 6361 7065 645f 776f 726b     "escaped_work
-00000ea0: 6572 223a 205b 2261 222c 2022 6222 5d2c  er": ["a", "b"],
-00000eb0: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-00000ec0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00000ed0: 2020 7365 6c66 2e72 6f6f 7420 3d20 6669    self.root = fi
-00000ee0: 6775 7265 280a 2020 2020 2020 2020 2020  gure(.          
-00000ef0: 2020 7469 746c 653d 224f 6363 7570 616e    title="Occupan
-00000f00: 6379 222c 0a20 2020 2020 2020 2020 2020  cy",.           
-00000f10: 2074 6f6f 6c73 3d22 222c 0a20 2020 2020   tools="",.     
-00000f20: 2020 2020 2020 2074 6f6f 6c62 6172 5f6c         toolbar_l
-00000f30: 6f63 6174 696f 6e3d 2261 626f 7665 222c  ocation="above",
-00000f40: 0a20 2020 2020 2020 2020 2020 2078 5f61  .            x_a
-00000f50: 7869 735f 7479 7065 3d22 6461 7465 7469  xis_type="dateti
-00000f60: 6d65 222c 0a20 2020 2020 2020 2020 2020  me",.           
-00000f70: 206d 696e 5f62 6f72 6465 725f 626f 7474   min_border_bott
-00000f80: 6f6d 3d35 302c 0a20 2020 2020 2020 2020  om=50,.         
-00000f90: 2020 202a 2a6b 7761 7267 732c 0a20 2020     **kwargs,.   
-00000fa0: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
-00000fb0: 6563 7420 3d20 7365 6c66 2e72 6f6f 742e  ect = self.root.
-00000fc0: 7265 6374 280a 2020 2020 2020 2020 2020  rect(.          
-00000fd0: 2020 736f 7572 6365 3d73 656c 662e 736f    source=self.so
-00000fe0: 7572 6365 2c20 783d 2278 222c 2077 6964  urce, x="x", wid
-00000ff0: 7468 3d22 6d73 222c 2079 3d22 7922 2c20  th="ms", y="y", 
-00001000: 6865 6967 6874 3d30 2e39 2c20 636f 6c6f  height=0.9, colo
-00001010: 723d 2263 6f6c 6f72 220a 2020 2020 2020  r="color".      
-00001020: 2020 290a 2020 2020 2020 2020 7265 6374    ).        rect
-00001030: 2e6e 6f6e 7365 6c65 6374 696f 6e5f 676c  .nonselection_gl
-00001040: 7970 6820 3d20 4e6f 6e65 0a0a 2020 2020  yph = None..    
-00001050: 2020 2020 7365 6c66 2e72 6f6f 742e 7861      self.root.xa
-00001060: 7869 732e 6d69 6e6f 725f 7469 636b 5f6c  xis.minor_tick_l
-00001070: 696e 655f 616c 7068 6120 3d20 300a 2020  ine_alpha = 0.  
-00001080: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-00001090: 7961 7869 732e 7669 7369 626c 6520 3d20  yaxis.visible = 
-000010a0: 4661 6c73 650a 2020 2020 2020 2020 7365  False.        se
-000010b0: 6c66 2e72 6f6f 742e 7967 7269 642e 7669  lf.root.ygrid.vi
-000010c0: 7369 626c 6520 3d20 4661 6c73 650a 2020  sible = False.  
-000010d0: 2020 2020 2020 2320 6669 672e 7861 7869        # fig.xaxi
-000010e0: 735b 305d 2e66 6f72 6d61 7474 6572 203d  s[0].formatter =
-000010f0: 204e 756d 6572 616c 5469 636b 466f 726d   NumeralTickForm
-00001100: 6174 7465 7228 666f 726d 6174 3d27 302e  atter(format='0.
-00001110: 3073 2729 0a20 2020 2020 2020 2073 656c  0s').        sel
-00001120: 662e 726f 6f74 2e78 5f72 616e 6765 2e73  f.root.x_range.s
-00001130: 7461 7274 203d 2030 0a0a 2020 2020 2020  tart = 0..      
-00001140: 2020 7461 7020 3d20 5461 7054 6f6f 6c28    tap = TapTool(
-00001150: 6361 6c6c 6261 636b 3d4f 7065 6e55 524c  callback=OpenURL
-00001160: 2875 726c 3d22 2e2f 696e 666f 2f77 6f72  (url="./info/wor
-00001170: 6b65 722f 4065 7363 6170 6564 5f77 6f72  ker/@escaped_wor
-00001180: 6b65 722e 6874 6d6c 2229 290a 0a20 2020  ker.html"))..   
-00001190: 2020 2020 2068 6f76 6572 203d 2048 6f76       hover = Hov
-000011a0: 6572 546f 6f6c 2829 0a20 2020 2020 2020  erTool().       
-000011b0: 2068 6f76 6572 2e74 6f6f 6c74 6970 7320   hover.tooltips 
-000011c0: 3d20 2240 776f 726b 6572 203a 2040 6f63  = "@worker : @oc
-000011d0: 6375 7061 6e63 7920 732e 220a 2020 2020  cupancy s.".    
-000011e0: 2020 2020 686f 7665 722e 706f 696e 745f      hover.point_
-000011f0: 706f 6c69 6379 203d 2022 666f 6c6c 6f77  policy = "follow
-00001200: 5f6d 6f75 7365 220a 2020 2020 2020 2020  _mouse".        
-00001210: 7365 6c66 2e72 6f6f 742e 6164 645f 746f  self.root.add_to
-00001220: 6f6c 7328 686f 7665 722c 2074 6170 290a  ols(hover, tap).
-00001230: 0a20 2020 2040 7769 7468 6f75 745f 7072  .    @without_pr
-00001240: 6f70 6572 7479 5f76 616c 6964 6174 696f  operty_validatio
-00001250: 6e0a 2020 2020 406c 6f67 5f65 7272 6f72  n.    @log_error
-00001260: 730a 2020 2020 6465 6620 7570 6461 7465  s.    def update
-00001270: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00001280: 776f 726b 6572 7320 3d20 7365 6c66 2e73  workers = self.s
-00001290: 6368 6564 756c 6572 2e77 6f72 6b65 7273  cheduler.workers
-000012a0: 2e76 616c 7565 7328 290a 0a20 2020 2020  .values()..     
-000012b0: 2020 2079 203d 206c 6973 7428 7261 6e67     y = list(rang
-000012c0: 6528 6c65 6e28 776f 726b 6572 7329 2929  e(len(workers)))
-000012d0: 0a20 2020 2020 2020 206f 6363 7570 616e  .        occupan
-000012e0: 6379 203d 205b 7773 2e6f 6363 7570 616e  cy = [ws.occupan
-000012f0: 6379 2066 6f72 2077 7320 696e 2077 6f72  cy for ws in wor
-00001300: 6b65 7273 5d0a 2020 2020 2020 2020 6d73  kers].        ms
-00001310: 203d 205b 6f63 6320 2a20 3130 3030 2066   = [occ * 1000 f
-00001320: 6f72 206f 6363 2069 6e20 6f63 6375 7061  or occ in occupa
-00001330: 6e63 795d 0a20 2020 2020 2020 2078 203d  ncy].        x =
-00001340: 205b 6f63 6320 2f20 3530 3020 666f 7220   [occ / 500 for 
-00001350: 6f63 6320 696e 206f 6363 7570 616e 6379  occ in occupancy
-00001360: 5d0a 2020 2020 2020 2020 746f 7461 6c20  ].        total 
-00001370: 3d20 7375 6d28 6f63 6375 7061 6e63 7929  = sum(occupancy)
-00001380: 0a20 2020 2020 2020 2063 6f6c 6f72 203d  .        color =
-00001390: 205b 5d0a 2020 2020 2020 2020 666f 7220   [].        for 
-000013a0: 7773 2069 6e20 776f 726b 6572 733a 0a20  ws in workers:. 
-000013b0: 2020 2020 2020 2020 2020 2069 6620 7773             if ws
-000013c0: 2069 6e20 7365 6c66 2e73 6368 6564 756c   in self.schedul
-000013d0: 6572 2e69 646c 653a 0a20 2020 2020 2020  er.idle:.       
-000013e0: 2020 2020 2020 2020 2063 6f6c 6f72 2e61           color.a
-000013f0: 7070 656e 6428 2272 6564 2229 0a20 2020  ppend("red").   
-00001400: 2020 2020 2020 2020 2065 6c69 6620 7773           elif ws
-00001410: 2069 6e20 7365 6c66 2e73 6368 6564 756c   in self.schedul
-00001420: 6572 2e73 6174 7572 6174 6564 3a0a 2020  er.saturated:.  
-00001430: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00001440: 6c6f 722e 6170 7065 6e64 2822 6772 6565  lor.append("gree
-00001450: 6e22 290a 2020 2020 2020 2020 2020 2020  n").            
-00001460: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00001470: 2020 2020 2020 636f 6c6f 722e 6170 7065        color.appe
-00001480: 6e64 2822 626c 7565 2229 0a0a 2020 2020  nd("blue")..    
-00001490: 2020 2020 6966 2074 6f74 616c 3a0a 2020      if total:.  
-000014a0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
-000014b0: 6f6f 742e 7469 746c 652e 7465 7874 203d  oot.title.text =
-000014c0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-000014d0: 2020 2066 224f 6363 7570 616e 6379 202d     f"Occupancy -
-000014e0: 2d20 746f 7461 6c20 7469 6d65 3a20 7b66  - total time: {f
-000014f0: 6f72 6d61 745f 7469 6d65 2874 6f74 616c  ormat_time(total
-00001500: 297d 2022 0a20 2020 2020 2020 2020 2020  )} ".           
-00001510: 2020 2020 2066 2277 616c 6c20 7469 6d65       f"wall time
-00001520: 3a20 7b66 6f72 6d61 745f 7469 6d65 2874  : {format_time(t
-00001530: 6f74 616c 202f 2073 656c 662e 7363 6865  otal / self.sche
-00001540: 6475 6c65 722e 746f 7461 6c5f 6e74 6872  duler.total_nthr
-00001550: 6561 6473 297d 220a 2020 2020 2020 2020  eads)}".        
-00001560: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
-00001570: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00001580: 7365 6c66 2e72 6f6f 742e 7469 746c 652e  self.root.title.
-00001590: 7465 7874 203d 2022 4f63 6375 7061 6e63  text = "Occupanc
-000015a0: 7922 0a0a 2020 2020 2020 2020 6966 206f  y"..        if o
-000015b0: 6363 7570 616e 6379 3a0a 2020 2020 2020  ccupancy:.      
-000015c0: 2020 2020 2020 7265 7375 6c74 203d 207b        result = {
-000015d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000015e0: 2022 6f63 6375 7061 6e63 7922 3a20 6f63   "occupancy": oc
-000015f0: 6375 7061 6e63 792c 0a20 2020 2020 2020  cupancy,.       
-00001600: 2020 2020 2020 2020 2022 776f 726b 6572           "worker
-00001610: 223a 205b 7773 2e61 6464 7265 7373 2066  ": [ws.address f
-00001620: 6f72 2077 7320 696e 2077 6f72 6b65 7273  or ws in workers
-00001630: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00001640: 2020 2022 6d73 223a 206d 732c 0a20 2020     "ms": ms,.   
-00001650: 2020 2020 2020 2020 2020 2020 2022 636f               "co
-00001660: 6c6f 7222 3a20 636f 6c6f 722c 0a20 2020  lor": color,.   
-00001670: 2020 2020 2020 2020 2020 2020 2022 6573               "es
-00001680: 6361 7065 645f 776f 726b 6572 223a 205b  caped_worker": [
-00001690: 6573 6361 7065 2e75 726c 5f65 7363 6170  escape.url_escap
-000016a0: 6528 7773 2e61 6464 7265 7373 2920 666f  e(ws.address) fo
-000016b0: 7220 7773 2069 6e20 776f 726b 6572 735d  r ws in workers]
-000016c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000016d0: 2020 2278 223a 2078 2c0a 2020 2020 2020    "x": x,.      
-000016e0: 2020 2020 2020 2020 2020 2279 223a 2079            "y": y
-000016f0: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
-00001700: 0a20 2020 2020 2020 2020 2020 2075 7064  .            upd
-00001710: 6174 6528 7365 6c66 2e73 6f75 7263 652c  ate(self.source,
-00001720: 2072 6573 756c 7429 0a0a 0a63 6c61 7373   result)...class
-00001730: 2050 726f 6365 7373 696e 6748 6973 746f   ProcessingHisto
-00001740: 6772 616d 2844 6173 6862 6f61 7264 436f  gram(DashboardCo
-00001750: 6d70 6f6e 656e 7429 3a0a 2020 2020 2222  mponent):.    ""
-00001760: 2248 6f77 206d 616e 7920 7461 736b 7320  "How many tasks 
-00001770: 6172 6520 6f6e 2065 6163 6820 776f 726b  are on each work
-00001780: 6572 2222 220a 0a20 2020 2040 6c6f 675f  er"""..    @log_
-00001790: 6572 726f 7273 0a20 2020 2064 6566 205f  errors.    def _
-000017a0: 5f69 6e69 745f 5f28 7365 6c66 2c20 7363  _init__(self, sc
-000017b0: 6865 6475 6c65 722c 202a 2a6b 7761 7267  heduler, **kwarg
-000017c0: 7329 3a0a 2020 2020 2020 2020 7365 6c66  s):.        self
-000017d0: 2e6c 6173 7420 3d20 300a 2020 2020 2020  .last = 0.      
-000017e0: 2020 7365 6c66 2e73 6368 6564 756c 6572    self.scheduler
-000017f0: 203d 2073 6368 6564 756c 6572 0a20 2020   = scheduler.   
-00001800: 2020 2020 2073 656c 662e 736f 7572 6365       self.source
-00001810: 203d 2043 6f6c 756d 6e44 6174 6153 6f75   = ColumnDataSou
-00001820: 7263 6528 0a20 2020 2020 2020 2020 2020  rce(.           
-00001830: 207b 226c 6566 7422 3a20 5b31 2c20 325d   {"left": [1, 2]
-00001840: 2c20 2272 6967 6874 223a 205b 3130 2c20  , "right": [10, 
-00001850: 3130 5d2c 2022 746f 7022 3a20 5b30 2c20  10], "top": [0, 
-00001860: 305d 7d0a 2020 2020 2020 2020 290a 0a20  0]}.        ).. 
-00001870: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-00001880: 203d 2066 6967 7572 6528 0a20 2020 2020   = figure(.     
-00001890: 2020 2020 2020 2074 6974 6c65 3d22 5461         title="Ta
-000018a0: 736b 7320 5072 6f63 6573 7369 6e67 2028  sks Processing (
-000018b0: 636f 756e 7429 222c 0a20 2020 2020 2020  count)",.       
-000018c0: 2020 2020 206e 616d 653d 2270 726f 6365       name="proce
-000018d0: 7373 696e 6722 2c0a 2020 2020 2020 2020  ssing",.        
-000018e0: 2020 2020 795f 6178 6973 5f6c 6162 656c      y_axis_label
-000018f0: 3d22 6672 6571 7565 6e63 7922 2c0a 2020  ="frequency",.  
-00001900: 2020 2020 2020 2020 2020 746f 6f6c 733d            tools=
-00001910: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
-00001920: 2a2a 6b77 6172 6773 2c0a 2020 2020 2020  **kwargs,.      
-00001930: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
-00001940: 662e 726f 6f74 2e78 6178 6973 2e6d 696e  f.root.xaxis.min
-00001950: 6f72 5f74 6963 6b5f 6c69 6e65 5f61 6c70  or_tick_line_alp
-00001960: 6861 203d 2030 0a20 2020 2020 2020 2073  ha = 0.        s
-00001970: 656c 662e 726f 6f74 2e79 6772 6964 2e76  elf.root.ygrid.v
-00001980: 6973 6962 6c65 203d 2046 616c 7365 0a0a  isible = False..
-00001990: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-000019a0: 742e 746f 6f6c 6261 725f 6c6f 6361 7469  t.toolbar_locati
-000019b0: 6f6e 203d 204e 6f6e 650a 0a20 2020 2020  on = None..     
-000019c0: 2020 2073 656c 662e 726f 6f74 2e71 7561     self.root.qua
-000019d0: 6428 0a20 2020 2020 2020 2020 2020 2073  d(.            s
-000019e0: 6f75 7263 653d 7365 6c66 2e73 6f75 7263  ource=self.sourc
-000019f0: 652c 0a20 2020 2020 2020 2020 2020 206c  e,.            l
-00001a00: 6566 743d 226c 6566 7422 2c0a 2020 2020  eft="left",.    
-00001a10: 2020 2020 2020 2020 7269 6768 743d 2272          right="r
-00001a20: 6967 6874 222c 0a20 2020 2020 2020 2020  ight",.         
-00001a30: 2020 2062 6f74 746f 6d3d 302c 0a20 2020     bottom=0,.   
-00001a40: 2020 2020 2020 2020 2074 6f70 3d22 746f           top="to
-00001a50: 7022 2c0a 2020 2020 2020 2020 2020 2020  p",.            
-00001a60: 636f 6c6f 723d 2264 6565 7073 6b79 626c  color="deepskybl
-00001a70: 7565 222c 0a20 2020 2020 2020 2020 2020  ue",.           
-00001a80: 2066 696c 6c5f 616c 7068 613d 302e 352c   fill_alpha=0.5,
-00001a90: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00001aa0: 4077 6974 686f 7574 5f70 726f 7065 7274  @without_propert
-00001ab0: 795f 7661 6c69 6461 7469 6f6e 0a20 2020  y_validation.   
-00001ac0: 2064 6566 2075 7064 6174 6528 7365 6c66   def update(self
-00001ad0: 293a 0a20 2020 2020 2020 204c 203d 205b  ):.        L = [
-00001ae0: 6c65 6e28 7773 2e70 726f 6365 7373 696e  len(ws.processin
-00001af0: 6729 2066 6f72 2077 7320 696e 2073 656c  g) for ws in sel
-00001b00: 662e 7363 6865 6475 6c65 722e 776f 726b  f.scheduler.work
-00001b10: 6572 732e 7661 6c75 6573 2829 5d0a 2020  ers.values()].  
-00001b20: 2020 2020 2020 636f 756e 7473 2c20 7820        counts, x 
-00001b30: 3d20 6e70 2e68 6973 746f 6772 616d 284c  = np.histogram(L
-00001b40: 2c20 6269 6e73 3d34 3029 0a20 2020 2020  , bins=40).     
-00001b50: 2020 2073 656c 662e 736f 7572 6365 2e64     self.source.d
-00001b60: 6174 612e 7570 6461 7465 287b 226c 6566  ata.update({"lef
-00001b70: 7422 3a20 785b 3a2d 315d 2c20 2272 6967  t": x[:-1], "rig
-00001b80: 6874 223a 2078 5b31 3a5d 2c20 2274 6f70  ht": x[1:], "top
-00001b90: 223a 2063 6f75 6e74 737d 290a 0a0a 636c  ": counts})...cl
-00001ba0: 6173 7320 4d65 6d6f 7279 436f 6c6f 723a  ass MemoryColor:
-00001bb0: 0a20 2020 2022 2222 4368 616e 6765 2074  .    """Change t
-00001bc0: 6865 2063 6f6c 6f72 206f 6620 7468 6520  he color of the 
-00001bd0: 6d65 6d6f 7279 2062 6172 7320 6672 6f6d  memory bars from
-00001be0: 2062 6c75 6520 746f 206f 7261 6e67 6520   blue to orange 
-00001bf0: 7768 656e 2070 726f 6365 7373 206d 656d  when process mem
-00001c00: 6f72 7920 676f 6573 0a20 2020 2061 626f  ory goes.    abo
-00001c10: 7665 2074 6865 2060 6074 6172 6765 7460  ve the ``target`
-00001c20: 6020 7468 7265 7368 6f6c 6420 616e 6420  ` threshold and 
-00001c30: 746f 2072 6564 2077 6865 6e20 7468 6520  to red when the 
-00001c40: 776f 726b 6572 2070 6175 7365 732e 0a20  worker pauses.. 
-00001c50: 2020 2057 6f72 6b65 7273 2069 6e20 6060     Workers in ``
-00001c60: 636c 6f73 696e 675f 6772 6163 6566 756c  closing_graceful
-00001c70: 6c79 6060 2073 7461 7465 2077 696c 6c20  ly`` state will 
-00001c80: 616c 736f 2062 6520 6f72 616e 6765 2e0a  also be orange..
-00001c90: 0a20 2020 2049 6620 6060 7461 7267 6574  .    If ``target
-00001ca0: 6060 2069 7320 6469 7361 626c 6564 2c20  `` is disabled, 
-00001cb0: 6368 616e 6765 2074 6f20 6f72 616e 6765  change to orange
-00001cc0: 206f 6e20 6060 7370 696c 6c60 6020 696e   on ``spill`` in
-00001cd0: 7374 6561 642e 0a20 2020 2049 6620 7370  stead..    If sp
-00001ce0: 696c 6c69 6e67 2069 7320 636f 6d70 6c65  illing is comple
-00001cf0: 7465 6c79 2064 6973 6162 6c65 642c 206e  tely disabled, n
-00001d00: 6576 6572 2074 7572 6e20 6f72 616e 6765  ever turn orange
-00001d10: 2e0a 0a20 2020 2049 6620 7061 7573 696e  ...    If pausin
-00001d20: 6720 6973 2064 6973 6162 6c65 642c 2063  g is disabled, c
-00001d30: 6861 6e67 6520 746f 2072 6564 2077 6865  hange to red whe
-00001d40: 6e20 7061 7373 696e 6720 7468 6520 6060  n passing the ``
-00001d50: 7465 726d 696e 6174 6560 6020 7468 7265  terminate`` thre
-00001d60: 7368 6f6c 640a 2020 2020 696e 7374 6561  shold.    instea
-00001d70: 642e 2049 6620 626f 7468 2070 6175 7365  d. If both pause
-00001d80: 2061 6e64 2074 6572 6d69 6e61 7465 2061   and terminate a
-00001d90: 7265 2064 6973 6162 6c65 642c 2074 7572  re disabled, tur
-00001da0: 6e20 7265 6420 7768 656e 2070 6173 7369  n red when passi
-00001db0: 6e67 0a20 2020 2060 606d 656d 6f72 795f  ng.    ``memory_
-00001dc0: 6c69 6d69 7460 602e 0a0a 2020 2020 4e6f  limit``...    No
-00001dd0: 7465 0a20 2020 202d 2d2d 2d0a 2020 2020  te.    ----.    
-00001de0: 4120 776f 726b 6572 2077 696c 6c20 7374  A worker will st
-00001df0: 6172 7420 7370 696c 6c69 6e67 2077 6865  art spilling whe
-00001e00: 6e20 6d61 6e61 6765 6420 6d65 6d6f 7279  n managed memory
-00001e10: 2061 6c6f 6e65 2070 6173 7365 7320 7468   alone passes th
-00001e20: 6520 7461 7267 6574 2074 6872 6573 686f  e target thresho
-00001e30: 6c64 2e0a 2020 2020 486f 7765 7665 722c  ld..    However,
-00001e40: 2068 6572 6520 7765 2772 6520 7377 6974   here we're swit
-00001e50: 6368 696e 6720 746f 206f 7261 6e67 6520  ching to orange 
-00001e60: 7768 656e 2074 6865 2070 726f 6365 7373  when the process
-00001e70: 206d 656d 6f72 7920 676f 6573 2062 6579   memory goes bey
-00001e80: 6f6e 6420 7461 7267 6574 2c0a 2020 2020  ond target,.    
-00001e90: 7768 6963 6820 6973 2075 7375 616c 6c79  which is usually
-00001ea0: 2065 6172 6c69 6572 2e0a 2020 2020 5468   earlier..    Th
-00001eb0: 6973 2069 7320 6465 6c69 6265 7261 7465  is is deliberate
-00001ec0: 2066 6f72 2074 6865 2073 616b 6520 6f66   for the sake of
-00001ed0: 2073 696d 706c 6963 6974 7920 616e 6420   simplicity and 
-00001ee0: 616c 736f 2062 6563 6175 7365 2c20 7768  also because, wh
-00001ef0: 656e 2074 6865 2070 726f 6365 7373 0a20  en the process. 
-00001f00: 2020 206d 656d 6f72 7920 7061 7373 6573     memory passes
-00001f10: 2074 6865 2073 7069 6c6c 2074 6872 6573   the spill thres
-00001f20: 686f 6c64 2c20 6974 2077 696c 6c20 6b65  hold, it will ke
-00001f30: 6570 2073 7069 6c6c 696e 6720 756e 7469  ep spilling unti
-00001f40: 6c20 6974 2066 616c 6c73 2062 656c 6f77  l it falls below
-00001f50: 2074 6865 0a20 2020 2074 6172 6765 7420   the.    target 
-00001f60: 7468 7265 7368 6f6c 6420 2d20 736f 2069  threshold - so i
-00001f70: 7427 7320 6e6f 7420 636f 6d70 6c65 7465  t's not complete
-00001f80: 6c79 2077 726f 6e67 2e20 4167 6169 6e2c  ly wrong. Again,
-00001f90: 2077 6520 646f 6e27 7420 7761 6e74 2074   we don't want t
-00001fa0: 6f20 7472 6163 6b0a 2020 2020 7468 6520  o track.    the 
-00001fb0: 6879 7374 6572 6573 6973 2063 7963 6c65  hysteresis cycle
-00001fc0: 206f 6620 7468 6520 7370 696c 6c20 7379   of the spill sy
-00001fd0: 7374 656d 2068 6572 6520 666f 7220 7468  stem here for th
-00001fe0: 6520 7361 6b65 206f 6620 7369 6d70 6c69  e sake of simpli
-00001ff0: 6369 7479 2e0a 0a20 2020 2049 6e20 7368  city...    In sh
-00002000: 6f72 742c 206f 7261 6e67 6520 7368 6f75  ort, orange shou
-00002010: 6c64 2062 6520 7472 6561 7465 6420 6173  ld be treated as
-00002020: 2022 7468 6520 776f 726b 6572 202a 6d61   "the worker *ma
-00002030: 792a 2062 6520 7370 696c 6c69 6e67 222e  y* be spilling".
-00002040: 0a20 2020 2022 2222 0a0a 2020 2020 6f72  .    """..    or
-00002050: 616e 6765 3a20 666c 6f61 740a 2020 2020  ange: float.    
-00002060: 7265 643a 2066 6c6f 6174 0a0a 2020 2020  red: float..    
-00002070: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
-00002080: 6629 3a0a 2020 2020 2020 2020 7461 7267  f):.        targ
-00002090: 6574 203d 2064 6173 6b2e 636f 6e66 6967  et = dask.config
-000020a0: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
-000020b0: 642e 776f 726b 6572 2e6d 656d 6f72 792e  d.worker.memory.
-000020c0: 7461 7267 6574 2229 0a20 2020 2020 2020  target").       
-000020d0: 2073 7069 6c6c 203d 2064 6173 6b2e 636f   spill = dask.co
-000020e0: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
-000020f0: 6275 7465 642e 776f 726b 6572 2e6d 656d  buted.worker.mem
-00002100: 6f72 792e 7370 696c 6c22 290a 2020 2020  ory.spill").    
-00002110: 2020 2020 7465 726d 696e 6174 6520 3d20      terminate = 
-00002120: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
-00002130: 2264 6973 7472 6962 7574 6564 2e77 6f72  "distributed.wor
-00002140: 6b65 722e 6d65 6d6f 7279 2e74 6572 6d69  ker.memory.termi
-00002150: 6e61 7465 2229 0a20 2020 2020 2020 2023  nate").        #
-00002160: 2054 6865 7365 2076 616c 7565 7320 6361   These values ca
-00002170: 6e20 6265 2046 616c 7365 2e20 4974 2773  n be False. It's
-00002180: 2061 6c73 6f20 636f 6d6d 6f6e 2074 6f20   also common to 
-00002190: 636f 6e66 6967 7572 6520 7468 656d 2074  configure them t
-000021a0: 6f20 696d 706f 7373 6962 6c79 0a20 2020  o impossibly.   
-000021b0: 2020 2020 2023 2068 6967 6820 7661 6c75       # high valu
-000021c0: 6573 2074 6f20 6163 6869 6576 6520 7468  es to achieve th
-000021d0: 6520 7361 6d65 2065 6666 6563 742e 0a20  e same effect.. 
-000021e0: 2020 2020 2020 2073 656c 662e 6f72 616e         self.oran
-000021f0: 6765 203d 206d 696e 2874 6172 6765 7420  ge = min(target 
-00002200: 6f72 206d 6174 682e 696e 662c 2073 7069  or math.inf, spi
-00002210: 6c6c 206f 7220 6d61 7468 2e69 6e66 290a  ll or math.inf).
-00002220: 2020 2020 2020 2020 7365 6c66 2e72 6564          self.red
-00002230: 203d 206d 696e 2874 6572 6d69 6e61 7465   = min(terminate
-00002240: 206f 7220 6d61 7468 2e69 6e66 2c20 312e   or math.inf, 1.
-00002250: 3029 0a0a 2020 2020 6465 6620 5f6d 656d  0)..    def _mem
-00002260: 6f72 795f 636f 6c6f 7228 7365 6c66 2c20  ory_color(self, 
-00002270: 6375 7272 656e 743a 2069 6e74 2c20 6c69  current: int, li
-00002280: 6d69 743a 2069 6e74 2c20 7374 6174 7573  mit: int, status
-00002290: 3a20 5374 6174 7573 2920 2d3e 2073 7472  : Status) -> str
-000022a0: 3a0a 2020 2020 2020 2020 6966 2073 7461  :.        if sta
-000022b0: 7475 7320 213d 2053 7461 7475 732e 7275  tus != Status.ru
-000022c0: 6e6e 696e 673a 0a20 2020 2020 2020 2020  nning:.         
-000022d0: 2020 2072 6574 7572 6e20 2272 6564 220a     return "red".
-000022e0: 2020 2020 2020 2020 6966 206e 6f74 206c          if not l
-000022f0: 696d 6974 3a0a 2020 2020 2020 2020 2020  imit:.          
-00002300: 2020 7265 7475 726e 2022 626c 7565 220a    return "blue".
-00002310: 2020 2020 2020 2020 6966 2063 7572 7265          if curre
-00002320: 6e74 203e 3d20 6c69 6d69 7420 2a20 7365  nt >= limit * se
-00002330: 6c66 2e72 6564 3a0a 2020 2020 2020 2020  lf.red:.        
-00002340: 2020 2020 7265 7475 726e 2022 7265 6422      return "red"
-00002350: 0a20 2020 2020 2020 2069 6620 6375 7272  .        if curr
-00002360: 656e 7420 3e3d 206c 696d 6974 202a 2073  ent >= limit * s
-00002370: 656c 662e 6f72 616e 6765 3a0a 2020 2020  elf.orange:.    
-00002380: 2020 2020 2020 2020 7265 7475 726e 2022          return "
-00002390: 6f72 616e 6765 220a 2020 2020 2020 2020  orange".        
-000023a0: 7265 7475 726e 2022 626c 7565 220a 0a0a  return "blue"...
-000023b0: 636c 6173 7320 436c 7573 7465 724d 656d  class ClusterMem
-000023c0: 6f72 7928 4461 7368 626f 6172 6443 6f6d  ory(DashboardCom
-000023d0: 706f 6e65 6e74 2c20 4d65 6d6f 7279 436f  ponent, MemoryCo
-000023e0: 6c6f 7229 3a0a 2020 2020 2222 2254 6f74  lor):.    """Tot
-000023f0: 616c 206d 656d 6f72 7920 7573 6167 6520  al memory usage 
-00002400: 6f6e 2074 6865 2063 6c75 7374 6572 2222  on the cluster""
-00002410: 220a 0a20 2020 2040 6c6f 675f 6572 726f  "..    @log_erro
-00002420: 7273 0a20 2020 2064 6566 205f 5f69 6e69  rs.    def __ini
-00002430: 745f 5f28 7365 6c66 2c20 7363 6865 6475  t__(self, schedu
-00002440: 6c65 722c 2077 6964 7468 3d36 3030 2c20  ler, width=600, 
-00002450: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
-00002460: 2020 2044 6173 6862 6f61 7264 436f 6d70     DashboardComp
-00002470: 6f6e 656e 742e 5f5f 696e 6974 5f5f 2873  onent.__init__(s
-00002480: 656c 6629 0a20 2020 2020 2020 204d 656d  elf).        Mem
-00002490: 6f72 7943 6f6c 6f72 2e5f 5f69 6e69 745f  oryColor.__init_
-000024a0: 5f28 7365 6c66 290a 0a20 2020 2020 2020  _(self)..       
-000024b0: 2073 656c 662e 7363 6865 6475 6c65 7220   self.scheduler 
-000024c0: 3d20 7363 6865 6475 6c65 720a 2020 2020  = scheduler.    
-000024d0: 2020 2020 7365 6c66 2e73 6f75 7263 6520      self.source 
-000024e0: 3d20 436f 6c75 6d6e 4461 7461 536f 7572  = ColumnDataSour
-000024f0: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
-00002500: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00002510: 2020 2277 6964 7468 223a 205b 305d 202a    "width": [0] *
-00002520: 2034 2c0a 2020 2020 2020 2020 2020 2020   4,.            
-00002530: 2020 2020 2278 223a 205b 305d 202a 2034      "x": [0] * 4
-00002540: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00002550: 2020 2279 223a 205b 305d 202a 2034 2c0a    "y": [0] * 4,.
-00002560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002570: 2263 6f6c 6f72 223a 205b 2262 6c75 6522  "color": ["blue"
-00002580: 2c20 2262 6c75 6522 2c20 2262 6c75 6522  , "blue", "blue"
-00002590: 2c20 2267 7265 7922 5d2c 0a20 2020 2020  , "grey"],.     
-000025a0: 2020 2020 2020 2020 2020 2022 616c 7068             "alph
-000025b0: 6122 3a20 5b31 2c20 302e 372c 2030 2e34  a": [1, 0.7, 0.4
-000025c0: 2c20 315d 2c0a 2020 2020 2020 2020 2020  , 1],.          
-000025d0: 2020 2020 2020 2270 726f 635f 6d65 6d6f        "proc_memo
-000025e0: 7279 223a 205b 305d 202a 2034 2c0a 2020  ry": [0] * 4,.  
-000025f0: 2020 2020 2020 2020 2020 2020 2020 226d                "m
-00002600: 616e 6167 6564 223a 205b 305d 202a 2034  anaged": [0] * 4
-00002610: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00002620: 2020 2275 6e6d 616e 6167 6564 5f6f 6c64    "unmanaged_old
-00002630: 223a 205b 305d 202a 2034 2c0a 2020 2020  ": [0] * 4,.    
-00002640: 2020 2020 2020 2020 2020 2020 2275 6e6d              "unm
-00002650: 616e 6167 6564 5f72 6563 656e 7422 3a20  anaged_recent": 
-00002660: 5b30 5d20 2a20 342c 0a20 2020 2020 2020  [0] * 4,.       
-00002670: 2020 2020 2020 2020 2022 7370 696c 6c65           "spille
-00002680: 6422 3a20 5b30 5d20 2a20 342c 0a20 2020  d": [0] * 4,.   
-00002690: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-000026a0: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
-000026b0: 6c66 2e72 6f6f 7420 3d20 6669 6775 7265  lf.root = figure
-000026c0: 280a 2020 2020 2020 2020 2020 2020 7469  (.            ti
-000026d0: 746c 653d 2242 7974 6573 2073 746f 7265  tle="Bytes store
-000026e0: 6420 6f6e 2063 6c75 7374 6572 222c 0a20  d on cluster",. 
-000026f0: 2020 2020 2020 2020 2020 2074 6f6f 6c73             tools
-00002700: 3d22 222c 0a20 2020 2020 2020 2020 2020  ="",.           
-00002710: 2077 6964 7468 3d69 6e74 2877 6964 7468   width=int(width
-00002720: 202f 2032 292c 0a20 2020 2020 2020 2020   / 2),.         
-00002730: 2020 206e 616d 653d 2263 6c75 7374 6572     name="cluster
-00002740: 5f6d 656d 6f72 7922 2c0a 2020 2020 2020  _memory",.      
-00002750: 2020 2020 2020 6d69 6e5f 626f 7264 6572        min_border
-00002760: 5f62 6f74 746f 6d3d 3530 2c0a 2020 2020  _bottom=50,.    
-00002770: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
-00002780: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00002790: 2020 2020 7265 6374 203d 2073 656c 662e      rect = self.
-000027a0: 726f 6f74 2e72 6563 7428 0a20 2020 2020  root.rect(.     
-000027b0: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
-000027c0: 6c66 2e73 6f75 7263 652c 0a20 2020 2020  lf.source,.     
-000027d0: 2020 2020 2020 2078 3d22 7822 2c0a 2020         x="x",.  
-000027e0: 2020 2020 2020 2020 2020 793d 2279 222c            y="y",
-000027f0: 0a20 2020 2020 2020 2020 2020 2077 6964  .            wid
-00002800: 7468 3d22 7769 6474 6822 2c0a 2020 2020  th="width",.    
-00002810: 2020 2020 2020 2020 6865 6967 6874 3d30          height=0
-00002820: 2e39 2c0a 2020 2020 2020 2020 2020 2020  .9,.            
-00002830: 636f 6c6f 723d 2263 6f6c 6f72 222c 0a20  color="color",. 
-00002840: 2020 2020 2020 2020 2020 2061 6c70 6861             alpha
-00002850: 3d22 616c 7068 6122 2c0a 2020 2020 2020  ="alpha",.      
-00002860: 2020 290a 2020 2020 2020 2020 7265 6374    ).        rect
-00002870: 2e6e 6f6e 7365 6c65 6374 696f 6e5f 676c  .nonselection_gl
-00002880: 7970 6820 3d20 4e6f 6e65 0a0a 2020 2020  yph = None..    
-00002890: 2020 2020 7365 6c66 2e72 6f6f 742e 6178      self.root.ax
-000028a0: 6973 5b30 5d2e 7469 636b 6572 203d 2042  is[0].ticker = B
-000028b0: 6173 6963 5469 636b 6572 282a 2a54 4943  asicTicker(**TIC
-000028c0: 4b53 5f31 3032 3429 0a20 2020 2020 2020  KS_1024).       
-000028d0: 2073 656c 662e 726f 6f74 2e78 6178 6973   self.root.xaxis
-000028e0: 5b30 5d2e 666f 726d 6174 7465 7220 3d20  [0].formatter = 
-000028f0: 4e75 6d65 7261 6c54 6963 6b46 6f72 6d61  NumeralTickForma
-00002900: 7474 6572 2866 6f72 6d61 743d 2230 2e30  tter(format="0.0
-00002910: 2062 2229 0a20 2020 2020 2020 2073 656c   b").        sel
-00002920: 662e 726f 6f74 2e78 6178 6973 2e6d 616a  f.root.xaxis.maj
-00002930: 6f72 5f6c 6162 656c 5f6f 7269 656e 7461  or_label_orienta
-00002940: 7469 6f6e 203d 2058 4c41 4245 4c5f 4f52  tion = XLABEL_OR
-00002950: 4945 4e54 4154 494f 4e0a 2020 2020 2020  IENTATION.      
-00002960: 2020 7365 6c66 2e72 6f6f 742e 7861 7869    self.root.xaxi
-00002970: 732e 6d69 6e6f 725f 7469 636b 5f6c 696e  s.minor_tick_lin
-00002980: 655f 616c 7068 6120 3d20 300a 2020 2020  e_alpha = 0.    
-00002990: 2020 2020 7365 6c66 2e72 6f6f 742e 785f      self.root.x_
-000029a0: 7261 6e67 6520 3d20 5261 6e67 6531 6428  range = Range1d(
-000029b0: 7374 6172 743d 3029 0a20 2020 2020 2020  start=0).       
-000029c0: 2073 656c 662e 726f 6f74 2e79 6178 6973   self.root.yaxis
-000029d0: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
-000029e0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-000029f0: 6f74 2e79 6772 6964 2e76 6973 6962 6c65  ot.ygrid.visible
-00002a00: 203d 2046 616c 7365 0a0a 2020 2020 2020   = False..      
-00002a10: 2020 7365 6c66 2e72 6f6f 742e 746f 6f6c    self.root.tool
-00002a20: 6261 725f 6c6f 6361 7469 6f6e 203d 2022  bar_location = "
-00002a30: 6162 6f76 6522 0a20 2020 2020 2020 2073  above".        s
-00002a40: 656c 662e 726f 6f74 2e79 6178 6973 2e76  elf.root.yaxis.v
-00002a50: 6973 6962 6c65 203d 2046 616c 7365 0a0a  isible = False..
-00002a60: 2020 2020 2020 2020 686f 7665 7220 3d20          hover = 
-00002a70: 486f 7665 7254 6f6f 6c28 0a20 2020 2020  HoverTool(.     
-00002a80: 2020 2020 2020 2070 6f69 6e74 5f70 6f6c         point_pol
-00002a90: 6963 793d 2266 6f6c 6c6f 775f 6d6f 7573  icy="follow_mous
-00002aa0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-00002ab0: 746f 6f6c 7469 7073 3d22 2222 0a20 2020  tooltips=""".   
-00002ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002ad0: 2020 2020 2020 2020 203c 6469 763e 0a20           <div>. 
+000000c0: 6f72 7420 6461 7465 7469 6d65 0a66 726f  ort datetime.fro
+000000d0: 6d20 6e75 6d62 6572 7320 696d 706f 7274  m numbers import
+000000e0: 204e 756d 6265 720a 6672 6f6d 2074 7970   Number.from typ
+000000f0: 696e 6720 696d 706f 7274 2041 6e79 2c20  ing import Any, 
+00000100: 5479 7065 5661 720a 0a69 6d70 6f72 7420  TypeVar..import 
+00000110: 6e75 6d70 7920 6173 206e 700a 6672 6f6d  numpy as np.from
+00000120: 2062 6f6b 6568 2e63 6f72 652e 7072 6f70   bokeh.core.prop
+00000130: 6572 7469 6573 2069 6d70 6f72 7420 7661  erties import va
+00000140: 6c75 652c 2077 6974 686f 7574 5f70 726f  lue, without_pro
+00000150: 7065 7274 795f 7661 6c69 6461 7469 6f6e  perty_validation
+00000160: 0a66 726f 6d20 626f 6b65 682e 696f 2069  .from bokeh.io i
+00000170: 6d70 6f72 7420 6375 7264 6f63 0a66 726f  mport curdoc.fro
+00000180: 6d20 626f 6b65 682e 6c61 796f 7574 7320  m bokeh.layouts 
+00000190: 696d 706f 7274 2063 6f6c 756d 6e2c 2072  import column, r
+000001a0: 6f77 0a66 726f 6d20 626f 6b65 682e 6d6f  ow.from bokeh.mo
+000001b0: 6465 6c73 2069 6d70 6f72 7420 280a 2020  dels import (.  
+000001c0: 2020 4164 6170 7469 7665 5469 636b 6572    AdaptiveTicker
+000001d0: 2c0a 2020 2020 4172 726f 772c 0a20 2020  ,.    Arrow,.   
+000001e0: 2042 6173 6963 5469 636b 6572 2c0a 2020   BasicTicker,.  
+000001f0: 2020 426f 7853 656c 6563 7454 6f6f 6c2c    BoxSelectTool,
+00000200: 0a20 2020 2042 6f78 5a6f 6f6d 546f 6f6c  .    BoxZoomTool
+00000210: 2c0a 2020 2020 4344 5356 6965 772c 0a20  ,.    CDSView,. 
+00000220: 2020 2043 6f6c 6f72 4261 722c 0a20 2020     ColorBar,.   
+00000230: 2043 6f6c 756d 6e44 6174 6153 6f75 7263   ColumnDataSourc
+00000240: 652c 0a20 2020 2043 7573 746f 6d4a 5348  e,.    CustomJSH
+00000250: 6f76 6572 2c0a 2020 2020 4461 7461 5261  over,.    DataRa
+00000260: 6e67 6531 642c 0a20 2020 2046 6163 746f  nge1d,.    Facto
+00000270: 7252 616e 6765 2c0a 2020 2020 4772 6f75  rRange,.    Grou
+00000280: 7046 696c 7465 722c 0a20 2020 2048 656c  pFilter,.    Hel
+00000290: 7054 6f6f 6c2c 0a20 2020 2048 6f76 6572  pTool,.    Hover
+000002a0: 546f 6f6c 2c0a 2020 2020 4854 4d4c 5465  Tool,.    HTMLTe
+000002b0: 6d70 6c61 7465 466f 726d 6174 7465 722c  mplateFormatter,
+000002c0: 0a20 2020 204d 756c 7469 4368 6f69 6365  .    MultiChoice
+000002d0: 2c0a 2020 2020 4e75 6d62 6572 466f 726d  ,.    NumberForm
+000002e0: 6174 7465 722c 0a20 2020 204e 756d 6572  atter,.    Numer
+000002f0: 616c 5469 636b 466f 726d 6174 7465 722c  alTickFormatter,
+00000300: 0a20 2020 204f 7065 6e55 524c 2c0a 2020  .    OpenURL,.  
+00000310: 2020 5061 6e54 6f6f 6c2c 0a20 2020 2052    PanTool,.    R
+00000320: 616e 6765 3164 2c0a 2020 2020 5265 7365  ange1d,.    Rese
+00000330: 7454 6f6f 6c2c 0a20 2020 2053 656c 6563  tTool,.    Selec
+00000340: 742c 0a20 2020 2054 6162 732c 0a20 2020  t,.    Tabs,.   
+00000350: 2054 6170 546f 6f6c 2c0a 2020 2020 5469   TapTool,.    Ti
+00000360: 746c 652c 0a20 2020 2056 6565 4865 6164  tle,.    VeeHead
+00000370: 2c0a 2020 2020 5768 6565 6c5a 6f6f 6d54  ,.    WheelZoomT
+00000380: 6f6f 6c2c 0a29 0a66 726f 6d20 626f 6b65  ool,.).from boke
+00000390: 682e 6d6f 6465 6c73 2e77 6964 6765 7473  h.models.widgets
+000003a0: 2069 6d70 6f72 7420 4461 7461 5461 626c   import DataTabl
+000003b0: 652c 2054 6162 6c65 436f 6c75 6d6e 0a66  e, TableColumn.f
+000003c0: 726f 6d20 626f 6b65 682e 6d6f 6465 6c73  rom bokeh.models
+000003d0: 2e77 6964 6765 7473 2e6d 6172 6b75 7073  .widgets.markups
+000003e0: 2069 6d70 6f72 7420 4469 760a 6672 6f6d   import Div.from
+000003f0: 2062 6f6b 6568 2e70 616c 6574 7465 7320   bokeh.palettes 
+00000400: 696d 706f 7274 2056 6972 6964 6973 3131  import Viridis11
+00000410: 0a66 726f 6d20 626f 6b65 682e 706c 6f74  .from bokeh.plot
+00000420: 7469 6e67 2069 6d70 6f72 7420 6669 6775  ting import figu
+00000430: 7265 0a66 726f 6d20 626f 6b65 682e 7468  re.from bokeh.th
+00000440: 656d 6573 2069 6d70 6f72 7420 5468 656d  emes import Them
+00000450: 650a 6672 6f6d 2062 6f6b 6568 2e74 7261  e.from bokeh.tra
+00000460: 6e73 666f 726d 2069 6d70 6f72 7420 6375  nsform import cu
+00000470: 6d73 756d 2c20 6661 6374 6f72 5f63 6d61  msum, factor_cma
+00000480: 702c 206c 696e 6561 725f 636d 6170 2c20  p, linear_cmap, 
+00000490: 7374 6163 6b0a 6672 6f6d 206a 696e 6a61  stack.from jinja
+000004a0: 3220 696d 706f 7274 2045 6e76 6972 6f6e  2 import Environ
+000004b0: 6d65 6e74 2c20 4669 6c65 5379 7374 656d  ment, FileSystem
+000004c0: 4c6f 6164 6572 0a66 726f 6d20 746c 7a20  Loader.from tlz 
+000004d0: 696d 706f 7274 2063 7572 7279 2c20 7069  import curry, pi
+000004e0: 7065 2c20 7661 6c6d 6170 0a66 726f 6d20  pe, valmap.from 
+000004f0: 746c 7a2e 6375 7272 6965 6420 696d 706f  tlz.curried impo
+00000500: 7274 2063 6f6e 6361 742c 2067 726f 7570  rt concat, group
+00000510: 6279 2c20 6d61 700a 6672 6f6d 2074 6f72  by, map.from tor
+00000520: 6e61 646f 2069 6d70 6f72 7420 6573 6361  nado import esca
+00000530: 7065 0a0a 696d 706f 7274 2064 6173 6b0a  pe..import dask.
+00000540: 6672 6f6d 2064 6173 6b20 696d 706f 7274  from dask import
+00000550: 2063 6f6e 6669 670a 6672 6f6d 2064 6173   config.from das
+00000560: 6b2e 7574 696c 7320 696d 706f 7274 2028  k.utils import (
+00000570: 0a20 2020 2066 6f72 6d61 745f 6279 7465  .    format_byte
+00000580: 732c 0a20 2020 2066 6f72 6d61 745f 7469  s,.    format_ti
+00000590: 6d65 2c0a 2020 2020 6675 6e63 6e61 6d65  me,.    funcname
+000005a0: 2c0a 2020 2020 6b65 795f 7370 6c69 742c  ,.    key_split,
+000005b0: 0a20 2020 2070 6172 7365 5f62 7974 6573  .    parse_bytes
+000005c0: 2c0a 2020 2020 7061 7273 655f 7469 6d65  ,.    parse_time
+000005d0: 6465 6c74 612c 0a29 0a0a 6672 6f6d 2064  delta,.)..from d
+000005e0: 6973 7472 6962 7574 6564 2e63 6f72 6520  istributed.core 
+000005f0: 696d 706f 7274 2053 7461 7475 730a 6672  import Status.fr
+00000600: 6f6d 2064 6973 7472 6962 7574 6564 2e64  om distributed.d
+00000610: 6173 6862 6f61 7264 2e63 6f6d 706f 6e65  ashboard.compone
+00000620: 6e74 7320 696d 706f 7274 2061 6464 5f70  nts import add_p
+00000630: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
+00000640: 0a66 726f 6d20 6469 7374 7269 6275 7465  .from distribute
+00000650: 642e 6461 7368 626f 6172 642e 636f 6d70  d.dashboard.comp
+00000660: 6f6e 656e 7473 2e73 6861 7265 6420 696d  onents.shared im
+00000670: 706f 7274 2028 0a20 2020 2044 6173 6862  port (.    Dashb
+00000680: 6f61 7264 436f 6d70 6f6e 656e 742c 0a20  oardComponent,. 
+00000690: 2020 2050 726f 6669 6c65 5365 7276 6572     ProfileServer
+000006a0: 2c0a 2020 2020 5072 6f66 696c 6554 696d  ,.    ProfileTim
+000006b0: 6550 6c6f 742c 0a20 2020 2053 7973 7465  ePlot,.    Syste
+000006c0: 6d4d 6f6e 6974 6f72 2c0a 290a 6672 6f6d  mMonitor,.).from
+000006d0: 2064 6973 7472 6962 7574 6564 2e64 6173   distributed.das
+000006e0: 6862 6f61 7264 2e63 6f72 6520 696d 706f  hboard.core impo
+000006f0: 7274 2054 6162 5061 6e65 6c0a 6672 6f6d  rt TabPanel.from
+00000700: 2064 6973 7472 6962 7574 6564 2e64 6173   distributed.das
+00000710: 6862 6f61 7264 2e75 7469 6c73 2069 6d70  hboard.utils imp
+00000720: 6f72 7420 280a 2020 2020 5f44 4154 4154  ort (.    _DATAT
+00000730: 4142 4c45 5f53 5459 4c45 5348 4545 5453  ABLE_STYLESHEETS
+00000740: 5f4b 5741 5247 532c 0a20 2020 2042 4f4b  _KWARGS,.    BOK
+00000750: 4548 5f56 4552 5349 4f4e 2c0a 2020 2020  EH_VERSION,.    
+00000760: 5052 4f46 494c 494e 472c 0a20 2020 2074  PROFILING,.    t
+00000770: 7261 6e73 706f 7365 2c0a 2020 2020 7570  ranspose,.    up
+00000780: 6461 7465 2c0a 290a 6672 6f6d 2064 6973  date,.).from dis
+00000790: 7472 6962 7574 6564 2e64 6961 676e 6f73  tributed.diagnos
+000007a0: 7469 6373 2e67 7261 7068 5f6c 6179 6f75  tics.graph_layou
+000007b0: 7420 696d 706f 7274 2047 7261 7068 4c61  t import GraphLa
+000007c0: 796f 7574 0a66 726f 6d20 6469 7374 7269  yout.from distri
+000007d0: 6275 7465 642e 6469 6167 6e6f 7374 6963  buted.diagnostic
+000007e0: 732e 7072 6f67 7265 7373 2069 6d70 6f72  s.progress impor
+000007f0: 7420 4772 6f75 7054 696d 696e 670a 6672  t GroupTiming.fr
+00000800: 6f6d 2064 6973 7472 6962 7574 6564 2e64  om distributed.d
+00000810: 6961 676e 6f73 7469 6373 2e70 726f 6772  iagnostics.progr
+00000820: 6573 735f 7374 7265 616d 2069 6d70 6f72  ess_stream impor
+00000830: 7420 636f 6c6f 725f 6f66 2c20 7072 6f67  t color_of, prog
+00000840: 7265 7373 5f71 7561 6473 0a66 726f 6d20  ress_quads.from 
+00000850: 6469 7374 7269 6275 7465 642e 6469 6167  distributed.diag
+00000860: 6e6f 7374 6963 732e 7461 736b 5f73 7472  nostics.task_str
+00000870: 6561 6d20 696d 706f 7274 2054 6173 6b53  eam import TaskS
+00000880: 7472 6561 6d50 6c75 6769 6e0a 6672 6f6d  treamPlugin.from
+00000890: 2064 6973 7472 6962 7574 6564 2e64 6961   distributed.dia
+000008a0: 676e 6f73 7469 6373 2e74 6173 6b5f 7374  gnostics.task_st
+000008b0: 7265 616d 2069 6d70 6f72 7420 636f 6c6f  ream import colo
+000008c0: 725f 6f66 2061 7320 7473 5f63 6f6c 6f72  r_of as ts_color
+000008d0: 5f6f 660a 6672 6f6d 2064 6973 7472 6962  _of.from distrib
+000008e0: 7574 6564 2e64 6961 676e 6f73 7469 6373  uted.diagnostics
+000008f0: 2e74 6173 6b5f 7374 7265 616d 2069 6d70  .task_stream imp
+00000900: 6f72 7420 636f 6c6f 7273 2061 7320 7473  ort colors as ts
+00000910: 5f63 6f6c 6f72 5f6c 6f6f 6b75 700a 6672  _color_lookup.fr
+00000920: 6f6d 2064 6973 7472 6962 7574 6564 2e6d  om distributed.m
+00000930: 6574 7269 6373 2069 6d70 6f72 7420 7469  etrics import ti
+00000940: 6d65 0a66 726f 6d20 6469 7374 7269 6275  me.from distribu
+00000950: 7465 642e 7363 6865 6475 6c65 7220 696d  ted.scheduler im
+00000960: 706f 7274 2053 6368 6564 756c 6572 0a66  port Scheduler.f
+00000970: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
+00000980: 7370 616e 7320 696d 706f 7274 2053 7061  spans import Spa
+00000990: 6e73 5363 6865 6475 6c65 7245 7874 656e  nsSchedulerExten
+000009a0: 7369 6f6e 0a66 726f 6d20 6469 7374 7269  sion.from distri
+000009b0: 6275 7465 642e 7574 696c 7320 696d 706f  buted.utils impo
+000009c0: 7274 204c 6f67 2c20 6c6f 675f 6572 726f  rt Log, log_erro
+000009d0: 7273 0a0a 6966 2064 6173 6b2e 636f 6e66  rs..if dask.conf
+000009e0: 6967 2e67 6574 2822 6469 7374 7269 6275  ig.get("distribu
+000009f0: 7465 642e 6461 7368 626f 6172 642e 6578  ted.dashboard.ex
+00000a00: 706f 7274 2d74 6f6f 6c22 293a 0a20 2020  port-tool"):.   
+00000a10: 2066 726f 6d20 6469 7374 7269 6275 7465   from distribute
+00000a20: 642e 6461 7368 626f 6172 642e 6578 706f  d.dashboard.expo
+00000a30: 7274 5f74 6f6f 6c20 696d 706f 7274 2045  rt_tool import E
+00000a40: 7870 6f72 7454 6f6f 6c0a 656c 7365 3a0a  xportTool.else:.
+00000a50: 2020 2020 4578 706f 7274 546f 6f6c 203d      ExportTool =
+00000a60: 204e 6f6e 6520 2023 2074 7970 653a 2069   None  # type: i
+00000a70: 676e 6f72 650a 0a54 203d 2054 7970 6556  gnore..T = TypeV
+00000a80: 6172 2822 5422 290a 0a6c 6f67 6765 7220  ar("T")..logger 
+00000a90: 3d20 6c6f 6767 696e 672e 6765 744c 6f67  = logging.getLog
+00000aa0: 6765 7228 5f5f 6e61 6d65 5f5f 290a 0a65  ger(__name__)..e
+00000ab0: 6e76 203d 2045 6e76 6972 6f6e 6d65 6e74  nv = Environment
+00000ac0: 280a 2020 2020 6c6f 6164 6572 3d46 696c  (.    loader=Fil
+00000ad0: 6553 7973 7465 6d4c 6f61 6465 7228 0a20  eSystemLoader(. 
+00000ae0: 2020 2020 2020 206f 732e 7061 7468 2e6a         os.path.j
+00000af0: 6f69 6e28 6f73 2e70 6174 682e 6469 726e  oin(os.path.dirn
+00000b00: 616d 6528 5f5f 6669 6c65 5f5f 292c 2022  ame(__file__), "
+00000b10: 2e2e 222c 2022 2e2e 222c 2022 6874 7470  ..", "..", "http
+00000b20: 222c 2022 7465 6d70 6c61 7465 7322 290a  ", "templates").
+00000b30: 2020 2020 290a 290a 0a42 4f4b 4548 5f54      ).)..BOKEH_T
+00000b40: 4845 4d45 203d 2054 6865 6d65 280a 2020  HEME = Theme(.  
+00000b50: 2020 6669 6c65 6e61 6d65 3d6f 732e 7061    filename=os.pa
+00000b60: 7468 2e6a 6f69 6e28 6f73 2e70 6174 682e  th.join(os.path.
+00000b70: 6469 726e 616d 6528 5f5f 6669 6c65 5f5f  dirname(__file__
+00000b80: 292c 2022 2e2e 222c 2022 7468 656d 652e  ), "..", "theme.
+00000b90: 7961 6d6c 2229 0a29 0a54 4943 4b53 5f31  yaml").).TICKS_1
+00000ba0: 3032 3420 3d20 7b22 6261 7365 223a 2031  024 = {"base": 1
+00000bb0: 3032 342c 2022 6d61 6e74 6973 7361 7322  024, "mantissas"
+00000bc0: 3a20 5b31 2c20 322c 2034 2c20 382c 2031  : [1, 2, 4, 8, 1
+00000bd0: 362c 2033 322c 2036 342c 2031 3238 2c20  6, 32, 64, 128, 
+00000be0: 3235 362c 2035 3132 5d7d 0a58 4c41 4245  256, 512]}.XLABE
+00000bf0: 4c5f 4f52 4945 4e54 4154 494f 4e20 3d20  L_ORIENTATION = 
+00000c00: 2d6d 6174 682e 7069 202f 2039 2020 2320  -math.pi / 9  # 
+00000c10: 736c 616e 7465 6420 646f 776e 7761 7264  slanted downward
+00000c20: 7320 3230 2064 6567 7265 6573 0a0a 0a6c  s 20 degrees...l
+00000c30: 6f67 6f73 5f64 6963 7420 3d20 7b0a 2020  ogos_dict = {.  
+00000c40: 2020 226e 756d 7079 223a 2022 7374 6174    "numpy": "stat
+00000c50: 6963 732f 696d 6167 6573 2f6e 756d 7079  ics/images/numpy
+00000c60: 2e70 6e67 222c 0a20 2020 2022 7061 6e64  .png",.    "pand
+00000c70: 6173 223a 2022 7374 6174 6963 732f 696d  as": "statics/im
+00000c80: 6167 6573 2f70 616e 6461 732e 706e 6722  ages/pandas.png"
+00000c90: 2c0a 2020 2020 2262 7569 6c74 696e 7322  ,.    "builtins"
+00000ca0: 3a20 2273 7461 7469 6373 2f69 6d61 6765  : "statics/image
+00000cb0: 732f 7079 7468 6f6e 2e70 6e67 222c 0a7d  s/python.png",.}
+00000cc0: 0a0a 0a63 6c61 7373 204f 6363 7570 616e  ...class Occupan
+00000cd0: 6379 2844 6173 6862 6f61 7264 436f 6d70  cy(DashboardComp
+00000ce0: 6f6e 656e 7429 3a0a 2020 2020 2222 224f  onent):.    """O
+00000cf0: 6363 7570 616e 6379 2028 696e 2074 696d  ccupancy (in tim
+00000d00: 6529 2070 6572 2077 6f72 6b65 7222 2222  e) per worker"""
+00000d10: 0a0a 2020 2020 406c 6f67 5f65 7272 6f72  ..    @log_error
+00000d20: 730a 2020 2020 6465 6620 5f5f 696e 6974  s.    def __init
+00000d30: 5f5f 2873 656c 662c 2073 6368 6564 756c  __(self, schedul
+00000d40: 6572 2c20 2a2a 6b77 6172 6773 293a 0a20  er, **kwargs):. 
+00000d50: 2020 2020 2020 2073 656c 662e 7363 6865         self.sche
+00000d60: 6475 6c65 7220 3d20 7363 6865 6475 6c65  duler = schedule
+00000d70: 720a 2020 2020 2020 2020 7365 6c66 2e73  r.        self.s
+00000d80: 6f75 7263 6520 3d20 436f 6c75 6d6e 4461  ource = ColumnDa
+00000d90: 7461 536f 7572 6365 280a 2020 2020 2020  taSource(.      
+00000da0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00000db0: 2020 2020 2020 2020 226f 6363 7570 616e          "occupan
+00000dc0: 6379 223a 205b 302c 2030 5d2c 0a20 2020  cy": [0, 0],.   
+00000dd0: 2020 2020 2020 2020 2020 2020 2022 776f               "wo
+00000de0: 726b 6572 223a 205b 2261 222c 2022 6222  rker": ["a", "b"
+00000df0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00000e00: 2020 2022 7822 3a20 5b30 2e30 2c20 302e     "x": [0.0, 0.
+00000e10: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
+00000e20: 2020 2020 2279 223a 205b 312c 2032 5d2c      "y": [1, 2],
+00000e30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00000e40: 2022 6d73 223a 205b 312c 2032 5d2c 0a20   "ms": [1, 2],. 
+00000e50: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00000e60: 636f 6c6f 7222 3a20 5b22 7265 6422 2c20  color": ["red", 
+00000e70: 2262 6c75 6522 5d2c 0a20 2020 2020 2020  "blue"],.       
+00000e80: 2020 2020 2020 2020 2022 6573 6361 7065           "escape
+00000e90: 645f 776f 726b 6572 223a 205b 2261 222c  d_worker": ["a",
+00000ea0: 2022 6222 5d2c 0a20 2020 2020 2020 2020   "b"],.         
+00000eb0: 2020 207d 0a20 2020 2020 2020 2029 0a0a     }.        )..
+00000ec0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+00000ed0: 7420 3d20 6669 6775 7265 280a 2020 2020  t = figure(.    
+00000ee0: 2020 2020 2020 2020 7469 746c 653d 224f          title="O
+00000ef0: 6363 7570 616e 6379 222c 0a20 2020 2020  ccupancy",.     
+00000f00: 2020 2020 2020 2074 6f6f 6c73 3d22 222c         tools="",
+00000f10: 0a20 2020 2020 2020 2020 2020 2074 6f6f  .            too
+00000f20: 6c62 6172 5f6c 6f63 6174 696f 6e3d 2261  lbar_location="a
+00000f30: 626f 7665 222c 0a20 2020 2020 2020 2020  bove",.         
+00000f40: 2020 2078 5f61 7869 735f 7479 7065 3d22     x_axis_type="
+00000f50: 6461 7465 7469 6d65 222c 0a20 2020 2020  datetime",.     
+00000f60: 2020 2020 2020 206d 696e 5f62 6f72 6465         min_borde
+00000f70: 725f 626f 7474 6f6d 3d35 302c 0a20 2020  r_bottom=50,.   
+00000f80: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
+00000f90: 732c 0a20 2020 2020 2020 2029 0a20 2020  s,.        ).   
+00000fa0: 2020 2020 2072 6563 7420 3d20 7365 6c66       rect = self
+00000fb0: 2e72 6f6f 742e 7265 6374 280a 2020 2020  .root.rect(.    
+00000fc0: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
+00000fd0: 656c 662e 736f 7572 6365 2c20 783d 2278  elf.source, x="x
+00000fe0: 222c 2077 6964 7468 3d22 6d73 222c 2079  ", width="ms", y
+00000ff0: 3d22 7922 2c20 6865 6967 6874 3d30 2e39  ="y", height=0.9
+00001000: 2c20 636f 6c6f 723d 2263 6f6c 6f72 220a  , color="color".
+00001010: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00001020: 2020 7265 6374 2e6e 6f6e 7365 6c65 6374    rect.nonselect
+00001030: 696f 6e5f 676c 7970 6820 3d20 4e6f 6e65  ion_glyph = None
+00001040: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
+00001050: 6f6f 742e 7861 7869 732e 6d69 6e6f 725f  oot.xaxis.minor_
+00001060: 7469 636b 5f6c 696e 655f 616c 7068 6120  tick_line_alpha 
+00001070: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
+00001080: 2e72 6f6f 742e 7961 7869 732e 7669 7369  .root.yaxis.visi
+00001090: 626c 6520 3d20 4661 6c73 650a 2020 2020  ble = False.    
+000010a0: 2020 2020 7365 6c66 2e72 6f6f 742e 7967      self.root.yg
+000010b0: 7269 642e 7669 7369 626c 6520 3d20 4661  rid.visible = Fa
+000010c0: 6c73 650a 2020 2020 2020 2020 2320 6669  lse.        # fi
+000010d0: 672e 7861 7869 735b 305d 2e66 6f72 6d61  g.xaxis[0].forma
+000010e0: 7474 6572 203d 204e 756d 6572 616c 5469  tter = NumeralTi
+000010f0: 636b 466f 726d 6174 7465 7228 666f 726d  ckFormatter(form
+00001100: 6174 3d27 302e 3073 2729 0a20 2020 2020  at='0.0s').     
+00001110: 2020 2073 656c 662e 726f 6f74 2e78 5f72     self.root.x_r
+00001120: 616e 6765 2e73 7461 7274 203d 2030 0a0a  ange.start = 0..
+00001130: 2020 2020 2020 2020 7461 7020 3d20 5461          tap = Ta
+00001140: 7054 6f6f 6c28 6361 6c6c 6261 636b 3d4f  pTool(callback=O
+00001150: 7065 6e55 524c 2875 726c 3d22 2e2f 696e  penURL(url="./in
+00001160: 666f 2f77 6f72 6b65 722f 4065 7363 6170  fo/worker/@escap
+00001170: 6564 5f77 6f72 6b65 722e 6874 6d6c 2229  ed_worker.html")
+00001180: 290a 0a20 2020 2020 2020 2068 6f76 6572  )..        hover
+00001190: 203d 2048 6f76 6572 546f 6f6c 2829 0a20   = HoverTool(). 
+000011a0: 2020 2020 2020 2068 6f76 6572 2e74 6f6f         hover.too
+000011b0: 6c74 6970 7320 3d20 2240 776f 726b 6572  ltips = "@worker
+000011c0: 203a 2040 6f63 6375 7061 6e63 7920 732e   : @occupancy s.
+000011d0: 220a 2020 2020 2020 2020 686f 7665 722e  ".        hover.
+000011e0: 706f 696e 745f 706f 6c69 6379 203d 2022  point_policy = "
+000011f0: 666f 6c6c 6f77 5f6d 6f75 7365 220a 2020  follow_mouse".  
+00001200: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+00001210: 6164 645f 746f 6f6c 7328 686f 7665 722c  add_tools(hover,
+00001220: 2074 6170 290a 0a20 2020 2040 7769 7468   tap)..    @with
+00001230: 6f75 745f 7072 6f70 6572 7479 5f76 616c  out_property_val
+00001240: 6964 6174 696f 6e0a 2020 2020 406c 6f67  idation.    @log
+00001250: 5f65 7272 6f72 730a 2020 2020 6465 6620  _errors.    def 
+00001260: 7570 6461 7465 2873 656c 6629 3a0a 2020  update(self):.  
+00001270: 2020 2020 2020 776f 726b 6572 7320 3d20        workers = 
+00001280: 7365 6c66 2e73 6368 6564 756c 6572 2e77  self.scheduler.w
+00001290: 6f72 6b65 7273 2e76 616c 7565 7328 290a  orkers.values().
+000012a0: 0a20 2020 2020 2020 2079 203d 206c 6973  .        y = lis
+000012b0: 7428 7261 6e67 6528 6c65 6e28 776f 726b  t(range(len(work
+000012c0: 6572 7329 2929 0a20 2020 2020 2020 206f  ers))).        o
+000012d0: 6363 7570 616e 6379 203d 205b 7773 2e6f  ccupancy = [ws.o
+000012e0: 6363 7570 616e 6379 2066 6f72 2077 7320  ccupancy for ws 
+000012f0: 696e 2077 6f72 6b65 7273 5d0a 2020 2020  in workers].    
+00001300: 2020 2020 6d73 203d 205b 6f63 6320 2a20      ms = [occ * 
+00001310: 3130 3030 2066 6f72 206f 6363 2069 6e20  1000 for occ in 
+00001320: 6f63 6375 7061 6e63 795d 0a20 2020 2020  occupancy].     
+00001330: 2020 2078 203d 205b 6f63 6320 2f20 3530     x = [occ / 50
+00001340: 3020 666f 7220 6f63 6320 696e 206f 6363  0 for occ in occ
+00001350: 7570 616e 6379 5d0a 2020 2020 2020 2020  upancy].        
+00001360: 746f 7461 6c20 3d20 7375 6d28 6f63 6375  total = sum(occu
+00001370: 7061 6e63 7929 0a20 2020 2020 2020 2063  pancy).        c
+00001380: 6f6c 6f72 203d 205b 5d0a 2020 2020 2020  olor = [].      
+00001390: 2020 666f 7220 7773 2069 6e20 776f 726b    for ws in work
+000013a0: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+000013b0: 2069 6620 7773 2069 6e20 7365 6c66 2e73   if ws in self.s
+000013c0: 6368 6564 756c 6572 2e69 646c 653a 0a20  cheduler.idle:. 
+000013d0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000013e0: 6f6c 6f72 2e61 7070 656e 6428 2272 6564  olor.append("red
+000013f0: 2229 0a20 2020 2020 2020 2020 2020 2065  ").            e
+00001400: 6c69 6620 7773 2069 6e20 7365 6c66 2e73  lif ws in self.s
+00001410: 6368 6564 756c 6572 2e73 6174 7572 6174  cheduler.saturat
+00001420: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
+00001430: 2020 2020 636f 6c6f 722e 6170 7065 6e64      color.append
+00001440: 2822 6772 6565 6e22 290a 2020 2020 2020  ("green").      
+00001450: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00001460: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
+00001470: 722e 6170 7065 6e64 2822 626c 7565 2229  r.append("blue")
+00001480: 0a0a 2020 2020 2020 2020 6966 2074 6f74  ..        if tot
+00001490: 616c 3a0a 2020 2020 2020 2020 2020 2020  al:.            
+000014a0: 7365 6c66 2e72 6f6f 742e 7469 746c 652e  self.root.title.
+000014b0: 7465 7874 203d 2028 0a20 2020 2020 2020  text = (.       
+000014c0: 2020 2020 2020 2020 2066 224f 6363 7570           f"Occup
+000014d0: 616e 6379 202d 2d20 746f 7461 6c20 7469  ancy -- total ti
+000014e0: 6d65 3a20 7b66 6f72 6d61 745f 7469 6d65  me: {format_time
+000014f0: 2874 6f74 616c 297d 2022 0a20 2020 2020  (total)} ".     
+00001500: 2020 2020 2020 2020 2020 2066 2277 616c             f"wal
+00001510: 6c20 7469 6d65 3a20 7b66 6f72 6d61 745f  l time: {format_
+00001520: 7469 6d65 2874 6f74 616c 202f 2073 656c  time(total / sel
+00001530: 662e 7363 6865 6475 6c65 722e 746f 7461  f.scheduler.tota
+00001540: 6c5f 6e74 6872 6561 6473 297d 220a 2020  l_nthreads)}".  
+00001550: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00001560: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00001570: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+00001580: 7469 746c 652e 7465 7874 203d 2022 4f63  title.text = "Oc
+00001590: 6375 7061 6e63 7922 0a0a 2020 2020 2020  cupancy"..      
+000015a0: 2020 6966 206f 6363 7570 616e 6379 3a0a    if occupancy:.
+000015b0: 2020 2020 2020 2020 2020 2020 7265 7375              resu
+000015c0: 6c74 203d 207b 0a20 2020 2020 2020 2020  lt = {.         
+000015d0: 2020 2020 2020 2022 6f63 6375 7061 6e63         "occupanc
+000015e0: 7922 3a20 6f63 6375 7061 6e63 792c 0a20  y": occupancy,. 
+000015f0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00001600: 776f 726b 6572 223a 205b 7773 2e61 6464  worker": [ws.add
+00001610: 7265 7373 2066 6f72 2077 7320 696e 2077  ress for ws in w
+00001620: 6f72 6b65 7273 5d2c 0a20 2020 2020 2020  orkers],.       
+00001630: 2020 2020 2020 2020 2022 6d73 223a 206d           "ms": m
+00001640: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00001650: 2020 2022 636f 6c6f 7222 3a20 636f 6c6f     "color": colo
+00001660: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+00001670: 2020 2022 6573 6361 7065 645f 776f 726b     "escaped_work
+00001680: 6572 223a 205b 6573 6361 7065 2e75 726c  er": [escape.url
+00001690: 5f65 7363 6170 6528 7773 2e61 6464 7265  _escape(ws.addre
+000016a0: 7373 2920 666f 7220 7773 2069 6e20 776f  ss) for ws in wo
+000016b0: 726b 6572 735d 2c0a 2020 2020 2020 2020  rkers],.        
+000016c0: 2020 2020 2020 2020 2278 223a 2078 2c0a          "x": x,.
+000016d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000016e0: 2279 223a 2079 2c0a 2020 2020 2020 2020  "y": y,.        
+000016f0: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+00001700: 2020 2075 7064 6174 6528 7365 6c66 2e73     update(self.s
+00001710: 6f75 7263 652c 2072 6573 756c 7429 0a0a  ource, result)..
+00001720: 0a63 6c61 7373 2050 726f 6365 7373 696e  .class Processin
+00001730: 6748 6973 746f 6772 616d 2844 6173 6862  gHistogram(Dashb
+00001740: 6f61 7264 436f 6d70 6f6e 656e 7429 3a0a  oardComponent):.
+00001750: 2020 2020 2222 2248 6f77 206d 616e 7920      """How many 
+00001760: 7461 736b 7320 6172 6520 6f6e 2065 6163  tasks are on eac
+00001770: 6820 776f 726b 6572 2222 220a 0a20 2020  h worker"""..   
+00001780: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
+00001790: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+000017a0: 6c66 2c20 7363 6865 6475 6c65 722c 202a  lf, scheduler, *
+000017b0: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
+000017c0: 2020 7365 6c66 2e6c 6173 7420 3d20 300a    self.last = 0.
+000017d0: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
+000017e0: 6564 756c 6572 203d 2073 6368 6564 756c  eduler = schedul
+000017f0: 6572 0a20 2020 2020 2020 2073 656c 662e  er.        self.
+00001800: 736f 7572 6365 203d 2043 6f6c 756d 6e44  source = ColumnD
+00001810: 6174 6153 6f75 7263 6528 0a20 2020 2020  ataSource(.     
+00001820: 2020 2020 2020 207b 226c 6566 7422 3a20         {"left": 
+00001830: 5b31 2c20 325d 2c20 2272 6967 6874 223a  [1, 2], "right":
+00001840: 205b 3130 2c20 3130 5d2c 2022 746f 7022   [10, 10], "top"
+00001850: 3a20 5b30 2c20 305d 7d0a 2020 2020 2020  : [0, 0]}.      
+00001860: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
+00001870: 662e 726f 6f74 203d 2066 6967 7572 6528  f.root = figure(
+00001880: 0a20 2020 2020 2020 2020 2020 2074 6974  .            tit
+00001890: 6c65 3d22 5461 736b 7320 5072 6f63 6573  le="Tasks Proces
+000018a0: 7369 6e67 2028 636f 756e 7429 222c 0a20  sing (count)",. 
+000018b0: 2020 2020 2020 2020 2020 206e 616d 653d             name=
+000018c0: 2270 726f 6365 7373 696e 6722 2c0a 2020  "processing",.  
+000018d0: 2020 2020 2020 2020 2020 795f 6178 6973            y_axis
+000018e0: 5f6c 6162 656c 3d22 6672 6571 7565 6e63  _label="frequenc
+000018f0: 7922 2c0a 2020 2020 2020 2020 2020 2020  y",.            
+00001900: 746f 6f6c 733d 2222 2c0a 2020 2020 2020  tools="",.      
+00001910: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
+00001920: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00001930: 2020 2073 656c 662e 726f 6f74 2e78 6178     self.root.xax
+00001940: 6973 2e6d 696e 6f72 5f74 6963 6b5f 6c69  is.minor_tick_li
+00001950: 6e65 5f61 6c70 6861 203d 2030 0a20 2020  ne_alpha = 0.   
+00001960: 2020 2020 2073 656c 662e 726f 6f74 2e79       self.root.y
+00001970: 6772 6964 2e76 6973 6962 6c65 203d 2046  grid.visible = F
+00001980: 616c 7365 0a0a 2020 2020 2020 2020 7365  alse..        se
+00001990: 6c66 2e72 6f6f 742e 746f 6f6c 6261 725f  lf.root.toolbar_
+000019a0: 6c6f 6361 7469 6f6e 203d 204e 6f6e 650a  location = None.
+000019b0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+000019c0: 6f74 2e71 7561 6428 0a20 2020 2020 2020  ot.quad(.       
+000019d0: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
+000019e0: 2e73 6f75 7263 652c 0a20 2020 2020 2020  .source,.       
+000019f0: 2020 2020 206c 6566 743d 226c 6566 7422       left="left"
+00001a00: 2c0a 2020 2020 2020 2020 2020 2020 7269  ,.            ri
+00001a10: 6768 743d 2272 6967 6874 222c 0a20 2020  ght="right",.   
+00001a20: 2020 2020 2020 2020 2062 6f74 746f 6d3d           bottom=
+00001a30: 302c 0a20 2020 2020 2020 2020 2020 2074  0,.            t
+00001a40: 6f70 3d22 746f 7022 2c0a 2020 2020 2020  op="top",.      
+00001a50: 2020 2020 2020 636f 6c6f 723d 2264 6565        color="dee
+00001a60: 7073 6b79 626c 7565 222c 0a20 2020 2020  pskyblue",.     
+00001a70: 2020 2020 2020 2066 696c 6c5f 616c 7068         fill_alph
+00001a80: 613d 302e 352c 0a20 2020 2020 2020 2029  a=0.5,.        )
+00001a90: 0a0a 2020 2020 4077 6974 686f 7574 5f70  ..    @without_p
+00001aa0: 726f 7065 7274 795f 7661 6c69 6461 7469  roperty_validati
+00001ab0: 6f6e 0a20 2020 2064 6566 2075 7064 6174  on.    def updat
+00001ac0: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
+00001ad0: 204c 203d 205b 6c65 6e28 7773 2e70 726f   L = [len(ws.pro
+00001ae0: 6365 7373 696e 6729 2066 6f72 2077 7320  cessing) for ws 
+00001af0: 696e 2073 656c 662e 7363 6865 6475 6c65  in self.schedule
+00001b00: 722e 776f 726b 6572 732e 7661 6c75 6573  r.workers.values
+00001b10: 2829 5d0a 2020 2020 2020 2020 636f 756e  ()].        coun
+00001b20: 7473 2c20 7820 3d20 6e70 2e68 6973 746f  ts, x = np.histo
+00001b30: 6772 616d 284c 2c20 6269 6e73 3d34 3029  gram(L, bins=40)
+00001b40: 0a20 2020 2020 2020 2073 656c 662e 736f  .        self.so
+00001b50: 7572 6365 2e64 6174 612e 7570 6461 7465  urce.data.update
+00001b60: 287b 226c 6566 7422 3a20 785b 3a2d 315d  ({"left": x[:-1]
+00001b70: 2c20 2272 6967 6874 223a 2078 5b31 3a5d  , "right": x[1:]
+00001b80: 2c20 2274 6f70 223a 2063 6f75 6e74 737d  , "top": counts}
+00001b90: 290a 0a0a 636c 6173 7320 4d65 6d6f 7279  )...class Memory
+00001ba0: 436f 6c6f 723a 0a20 2020 2022 2222 4368  Color:.    """Ch
+00001bb0: 616e 6765 2074 6865 2063 6f6c 6f72 206f  ange the color o
+00001bc0: 6620 7468 6520 6d65 6d6f 7279 2062 6172  f the memory bar
+00001bd0: 7320 6672 6f6d 2062 6c75 6520 746f 206f  s from blue to o
+00001be0: 7261 6e67 6520 7768 656e 2070 726f 6365  range when proce
+00001bf0: 7373 206d 656d 6f72 7920 676f 6573 0a20  ss memory goes. 
+00001c00: 2020 2061 626f 7665 2074 6865 2060 6074     above the ``t
+00001c10: 6172 6765 7460 6020 7468 7265 7368 6f6c  arget`` threshol
+00001c20: 6420 616e 6420 746f 2072 6564 2077 6865  d and to red whe
+00001c30: 6e20 7468 6520 776f 726b 6572 2070 6175  n the worker pau
+00001c40: 7365 732e 0a20 2020 2057 6f72 6b65 7273  ses..    Workers
+00001c50: 2069 6e20 6060 636c 6f73 696e 675f 6772   in ``closing_gr
+00001c60: 6163 6566 756c 6c79 6060 2073 7461 7465  acefully`` state
+00001c70: 2077 696c 6c20 616c 736f 2062 6520 6f72   will also be or
+00001c80: 616e 6765 2e0a 0a20 2020 2049 6620 6060  ange...    If ``
+00001c90: 7461 7267 6574 6060 2069 7320 6469 7361  target`` is disa
+00001ca0: 626c 6564 2c20 6368 616e 6765 2074 6f20  bled, change to 
+00001cb0: 6f72 616e 6765 206f 6e20 6060 7370 696c  orange on ``spil
+00001cc0: 6c60 6020 696e 7374 6561 642e 0a20 2020  l`` instead..   
+00001cd0: 2049 6620 7370 696c 6c69 6e67 2069 7320   If spilling is 
+00001ce0: 636f 6d70 6c65 7465 6c79 2064 6973 6162  completely disab
+00001cf0: 6c65 642c 206e 6576 6572 2074 7572 6e20  led, never turn 
+00001d00: 6f72 616e 6765 2e0a 0a20 2020 2049 6620  orange...    If 
+00001d10: 7061 7573 696e 6720 6973 2064 6973 6162  pausing is disab
+00001d20: 6c65 642c 2063 6861 6e67 6520 746f 2072  led, change to r
+00001d30: 6564 2077 6865 6e20 7061 7373 696e 6720  ed when passing 
+00001d40: 7468 6520 6060 7465 726d 696e 6174 6560  the ``terminate`
+00001d50: 6020 7468 7265 7368 6f6c 640a 2020 2020  ` threshold.    
+00001d60: 696e 7374 6561 642e 2049 6620 626f 7468  instead. If both
+00001d70: 2070 6175 7365 2061 6e64 2074 6572 6d69   pause and termi
+00001d80: 6e61 7465 2061 7265 2064 6973 6162 6c65  nate are disable
+00001d90: 642c 2074 7572 6e20 7265 6420 7768 656e  d, turn red when
+00001da0: 2070 6173 7369 6e67 0a20 2020 2060 606d   passing.    ``m
+00001db0: 656d 6f72 795f 6c69 6d69 7460 602e 0a0a  emory_limit``...
+00001dc0: 2020 2020 4e6f 7465 0a20 2020 202d 2d2d      Note.    ---
+00001dd0: 2d0a 2020 2020 4120 776f 726b 6572 2077  -.    A worker w
+00001de0: 696c 6c20 7374 6172 7420 7370 696c 6c69  ill start spilli
+00001df0: 6e67 2077 6865 6e20 6d61 6e61 6765 6420  ng when managed 
+00001e00: 6d65 6d6f 7279 2061 6c6f 6e65 2070 6173  memory alone pas
+00001e10: 7365 7320 7468 6520 7461 7267 6574 2074  ses the target t
+00001e20: 6872 6573 686f 6c64 2e0a 2020 2020 486f  hreshold..    Ho
+00001e30: 7765 7665 722c 2068 6572 6520 7765 2772  wever, here we'r
+00001e40: 6520 7377 6974 6368 696e 6720 746f 206f  e switching to o
+00001e50: 7261 6e67 6520 7768 656e 2074 6865 2070  range when the p
+00001e60: 726f 6365 7373 206d 656d 6f72 7920 676f  rocess memory go
+00001e70: 6573 2062 6579 6f6e 6420 7461 7267 6574  es beyond target
+00001e80: 2c0a 2020 2020 7768 6963 6820 6973 2075  ,.    which is u
+00001e90: 7375 616c 6c79 2065 6172 6c69 6572 2e0a  sually earlier..
+00001ea0: 2020 2020 5468 6973 2069 7320 6465 6c69      This is deli
+00001eb0: 6265 7261 7465 2066 6f72 2074 6865 2073  berate for the s
+00001ec0: 616b 6520 6f66 2073 696d 706c 6963 6974  ake of simplicit
+00001ed0: 7920 616e 6420 616c 736f 2062 6563 6175  y and also becau
+00001ee0: 7365 2c20 7768 656e 2074 6865 2070 726f  se, when the pro
+00001ef0: 6365 7373 0a20 2020 206d 656d 6f72 7920  cess.    memory 
+00001f00: 7061 7373 6573 2074 6865 2073 7069 6c6c  passes the spill
+00001f10: 2074 6872 6573 686f 6c64 2c20 6974 2077   threshold, it w
+00001f20: 696c 6c20 6b65 6570 2073 7069 6c6c 696e  ill keep spillin
+00001f30: 6720 756e 7469 6c20 6974 2066 616c 6c73  g until it falls
+00001f40: 2062 656c 6f77 2074 6865 0a20 2020 2074   below the.    t
+00001f50: 6172 6765 7420 7468 7265 7368 6f6c 6420  arget threshold 
+00001f60: 2d20 736f 2069 7427 7320 6e6f 7420 636f  - so it's not co
+00001f70: 6d70 6c65 7465 6c79 2077 726f 6e67 2e20  mpletely wrong. 
+00001f80: 4167 6169 6e2c 2077 6520 646f 6e27 7420  Again, we don't 
+00001f90: 7761 6e74 2074 6f20 7472 6163 6b0a 2020  want to track.  
+00001fa0: 2020 7468 6520 6879 7374 6572 6573 6973    the hysteresis
+00001fb0: 2063 7963 6c65 206f 6620 7468 6520 7370   cycle of the sp
+00001fc0: 696c 6c20 7379 7374 656d 2068 6572 6520  ill system here 
+00001fd0: 666f 7220 7468 6520 7361 6b65 206f 6620  for the sake of 
+00001fe0: 7369 6d70 6c69 6369 7479 2e0a 0a20 2020  simplicity...   
+00001ff0: 2049 6e20 7368 6f72 742c 206f 7261 6e67   In short, orang
+00002000: 6520 7368 6f75 6c64 2062 6520 7472 6561  e should be trea
+00002010: 7465 6420 6173 2022 7468 6520 776f 726b  ted as "the work
+00002020: 6572 202a 6d61 792a 2062 6520 7370 696c  er *may* be spil
+00002030: 6c69 6e67 222e 0a20 2020 2022 2222 0a0a  ling"..    """..
+00002040: 2020 2020 6f72 616e 6765 3a20 666c 6f61      orange: floa
+00002050: 740a 2020 2020 7265 643a 2066 6c6f 6174  t.    red: float
+00002060: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+00002070: 5f5f 2873 656c 6629 3a0a 2020 2020 2020  __(self):.      
+00002080: 2020 7461 7267 6574 203d 2064 6173 6b2e    target = dask.
+00002090: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
+000020a0: 7269 6275 7465 642e 776f 726b 6572 2e6d  ributed.worker.m
+000020b0: 656d 6f72 792e 7461 7267 6574 2229 0a20  emory.target"). 
+000020c0: 2020 2020 2020 2073 7069 6c6c 203d 2064         spill = d
+000020d0: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
+000020e0: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
+000020f0: 6572 2e6d 656d 6f72 792e 7370 696c 6c22  er.memory.spill"
+00002100: 290a 2020 2020 2020 2020 7465 726d 696e  ).        termin
+00002110: 6174 6520 3d20 6461 736b 2e63 6f6e 6669  ate = dask.confi
+00002120: 672e 6765 7428 2264 6973 7472 6962 7574  g.get("distribut
+00002130: 6564 2e77 6f72 6b65 722e 6d65 6d6f 7279  ed.worker.memory
+00002140: 2e74 6572 6d69 6e61 7465 2229 0a20 2020  .terminate").   
+00002150: 2020 2020 2023 2054 6865 7365 2076 616c       # These val
+00002160: 7565 7320 6361 6e20 6265 2046 616c 7365  ues can be False
+00002170: 2e20 4974 2773 2061 6c73 6f20 636f 6d6d  . It's also comm
+00002180: 6f6e 2074 6f20 636f 6e66 6967 7572 6520  on to configure 
+00002190: 7468 656d 2074 6f20 696d 706f 7373 6962  them to impossib
+000021a0: 6c79 0a20 2020 2020 2020 2023 2068 6967  ly.        # hig
+000021b0: 6820 7661 6c75 6573 2074 6f20 6163 6869  h values to achi
+000021c0: 6576 6520 7468 6520 7361 6d65 2065 6666  eve the same eff
+000021d0: 6563 742e 0a20 2020 2020 2020 2073 656c  ect..        sel
+000021e0: 662e 6f72 616e 6765 203d 206d 696e 2874  f.orange = min(t
+000021f0: 6172 6765 7420 6f72 206d 6174 682e 696e  arget or math.in
+00002200: 662c 2073 7069 6c6c 206f 7220 6d61 7468  f, spill or math
+00002210: 2e69 6e66 290a 2020 2020 2020 2020 7365  .inf).        se
+00002220: 6c66 2e72 6564 203d 206d 696e 2874 6572  lf.red = min(ter
+00002230: 6d69 6e61 7465 206f 7220 6d61 7468 2e69  minate or math.i
+00002240: 6e66 2c20 312e 3029 0a0a 2020 2020 6465  nf, 1.0)..    de
+00002250: 6620 5f6d 656d 6f72 795f 636f 6c6f 7228  f _memory_color(
+00002260: 7365 6c66 2c20 6375 7272 656e 743a 2069  self, current: i
+00002270: 6e74 2c20 6c69 6d69 743a 2069 6e74 2c20  nt, limit: int, 
+00002280: 7374 6174 7573 3a20 5374 6174 7573 2920  status: Status) 
+00002290: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
+000022a0: 6966 2073 7461 7475 7320 213d 2053 7461  if status != Sta
+000022b0: 7475 732e 7275 6e6e 696e 673a 0a20 2020  tus.running:.   
+000022c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000022d0: 2272 6564 220a 2020 2020 2020 2020 6966  "red".        if
+000022e0: 206e 6f74 206c 696d 6974 3a0a 2020 2020   not limit:.    
+000022f0: 2020 2020 2020 2020 7265 7475 726e 2022          return "
+00002300: 626c 7565 220a 2020 2020 2020 2020 6966  blue".        if
+00002310: 2063 7572 7265 6e74 203e 3d20 6c69 6d69   current >= limi
+00002320: 7420 2a20 7365 6c66 2e72 6564 3a0a 2020  t * self.red:.  
+00002330: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00002340: 2022 7265 6422 0a20 2020 2020 2020 2069   "red".        i
+00002350: 6620 6375 7272 656e 7420 3e3d 206c 696d  f current >= lim
+00002360: 6974 202a 2073 656c 662e 6f72 616e 6765  it * self.orange
+00002370: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00002380: 7475 726e 2022 6f72 616e 6765 220a 2020  turn "orange".  
+00002390: 2020 2020 2020 7265 7475 726e 2022 626c        return "bl
+000023a0: 7565 220a 0a0a 636c 6173 7320 436c 7573  ue"...class Clus
+000023b0: 7465 724d 656d 6f72 7928 4461 7368 626f  terMemory(Dashbo
+000023c0: 6172 6443 6f6d 706f 6e65 6e74 2c20 4d65  ardComponent, Me
+000023d0: 6d6f 7279 436f 6c6f 7229 3a0a 2020 2020  moryColor):.    
+000023e0: 2222 2254 6f74 616c 206d 656d 6f72 7920  """Total memory 
+000023f0: 7573 6167 6520 6f6e 2074 6865 2063 6c75  usage on the clu
+00002400: 7374 6572 2222 220a 0a20 2020 2040 6c6f  ster"""..    @lo
+00002410: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
+00002420: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+00002430: 7363 6865 6475 6c65 722c 2077 6964 7468  scheduler, width
+00002440: 3d36 3030 2c20 2a2a 6b77 6172 6773 293a  =600, **kwargs):
+00002450: 0a20 2020 2020 2020 2044 6173 6862 6f61  .        Dashboa
+00002460: 7264 436f 6d70 6f6e 656e 742e 5f5f 696e  rdComponent.__in
+00002470: 6974 5f5f 2873 656c 6629 0a20 2020 2020  it__(self).     
+00002480: 2020 204d 656d 6f72 7943 6f6c 6f72 2e5f     MemoryColor._
+00002490: 5f69 6e69 745f 5f28 7365 6c66 290a 0a20  _init__(self).. 
+000024a0: 2020 2020 2020 2073 656c 662e 7363 6865         self.sche
+000024b0: 6475 6c65 7220 3d20 7363 6865 6475 6c65  duler = schedule
+000024c0: 720a 2020 2020 2020 2020 7365 6c66 2e73  r.        self.s
+000024d0: 6f75 7263 6520 3d20 436f 6c75 6d6e 4461  ource = ColumnDa
+000024e0: 7461 536f 7572 6365 280a 2020 2020 2020  taSource(.      
+000024f0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00002500: 2020 2020 2020 2020 2277 6964 7468 223a          "width":
+00002510: 205b 305d 202a 2034 2c0a 2020 2020 2020   [0] * 4,.      
+00002520: 2020 2020 2020 2020 2020 2278 223a 205b            "x": [
+00002530: 305d 202a 2034 2c0a 2020 2020 2020 2020  0] * 4,.        
+00002540: 2020 2020 2020 2020 2279 223a 205b 305d          "y": [0]
+00002550: 202a 2034 2c0a 2020 2020 2020 2020 2020   * 4,.          
+00002560: 2020 2020 2020 2263 6f6c 6f72 223a 205b        "color": [
+00002570: 2262 6c75 6522 2c20 2262 6c75 6522 2c20  "blue", "blue", 
+00002580: 2262 6c75 6522 2c20 2267 7265 7922 5d2c  "blue", "grey"],
+00002590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000025a0: 2022 616c 7068 6122 3a20 5b31 2c20 302e   "alpha": [1, 0.
+000025b0: 372c 2030 2e34 2c20 315d 2c0a 2020 2020  7, 0.4, 1],.    
+000025c0: 2020 2020 2020 2020 2020 2020 2270 726f              "pro
+000025d0: 635f 6d65 6d6f 7279 223a 205b 305d 202a  c_memory": [0] *
+000025e0: 2034 2c0a 2020 2020 2020 2020 2020 2020   4,.            
+000025f0: 2020 2020 226d 616e 6167 6564 223a 205b      "managed": [
+00002600: 305d 202a 2034 2c0a 2020 2020 2020 2020  0] * 4,.        
+00002610: 2020 2020 2020 2020 2275 6e6d 616e 6167          "unmanag
+00002620: 6564 5f6f 6c64 223a 205b 305d 202a 2034  ed_old": [0] * 4
+00002630: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00002640: 2020 2275 6e6d 616e 6167 6564 5f72 6563    "unmanaged_rec
+00002650: 656e 7422 3a20 5b30 5d20 2a20 342c 0a20  ent": [0] * 4,. 
+00002660: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00002670: 7370 696c 6c65 6422 3a20 5b30 5d20 2a20  spilled": [0] * 
+00002680: 342c 0a20 2020 2020 2020 2020 2020 207d  4,.            }
+00002690: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+000026a0: 2020 2020 7365 6c66 2e72 6f6f 7420 3d20      self.root = 
+000026b0: 6669 6775 7265 280a 2020 2020 2020 2020  figure(.        
+000026c0: 2020 2020 7469 746c 653d 2242 7974 6573      title="Bytes
+000026d0: 2073 746f 7265 6420 6f6e 2063 6c75 7374   stored on clust
+000026e0: 6572 222c 0a20 2020 2020 2020 2020 2020  er",.           
+000026f0: 2074 6f6f 6c73 3d22 222c 0a20 2020 2020   tools="",.     
+00002700: 2020 2020 2020 2077 6964 7468 3d69 6e74         width=int
+00002710: 2877 6964 7468 202f 2032 292c 0a20 2020  (width / 2),.   
+00002720: 2020 2020 2020 2020 206e 616d 653d 2263           name="c
+00002730: 6c75 7374 6572 5f6d 656d 6f72 7922 2c0a  luster_memory",.
+00002740: 2020 2020 2020 2020 2020 2020 6d69 6e5f              min_
+00002750: 626f 7264 6572 5f62 6f74 746f 6d3d 3530  border_bottom=50
+00002760: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
+00002770: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
+00002780: 290a 2020 2020 2020 2020 7265 6374 203d  ).        rect =
+00002790: 2073 656c 662e 726f 6f74 2e72 6563 7428   self.root.rect(
+000027a0: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
+000027b0: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
+000027c0: 0a20 2020 2020 2020 2020 2020 2078 3d22  .            x="
+000027d0: 7822 2c0a 2020 2020 2020 2020 2020 2020  x",.            
+000027e0: 793d 2279 222c 0a20 2020 2020 2020 2020  y="y",.         
+000027f0: 2020 2077 6964 7468 3d22 7769 6474 6822     width="width"
+00002800: 2c0a 2020 2020 2020 2020 2020 2020 6865  ,.            he
+00002810: 6967 6874 3d30 2e39 2c0a 2020 2020 2020  ight=0.9,.      
+00002820: 2020 2020 2020 636f 6c6f 723d 2263 6f6c        color="col
+00002830: 6f72 222c 0a20 2020 2020 2020 2020 2020  or",.           
+00002840: 2061 6c70 6861 3d22 616c 7068 6122 2c0a   alpha="alpha",.
+00002850: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00002860: 2020 7265 6374 2e6e 6f6e 7365 6c65 6374    rect.nonselect
+00002870: 696f 6e5f 676c 7970 6820 3d20 4e6f 6e65  ion_glyph = None
+00002880: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
+00002890: 6f6f 742e 6178 6973 5b30 5d2e 7469 636b  oot.axis[0].tick
+000028a0: 6572 203d 2042 6173 6963 5469 636b 6572  er = BasicTicker
+000028b0: 282a 2a54 4943 4b53 5f31 3032 3429 0a20  (**TICKS_1024). 
+000028c0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+000028d0: 2e78 6178 6973 5b30 5d2e 666f 726d 6174  .xaxis[0].format
+000028e0: 7465 7220 3d20 4e75 6d65 7261 6c54 6963  ter = NumeralTic
+000028f0: 6b46 6f72 6d61 7474 6572 2866 6f72 6d61  kFormatter(forma
+00002900: 743d 2230 2e30 2062 2229 0a20 2020 2020  t="0.0 b").     
+00002910: 2020 2073 656c 662e 726f 6f74 2e78 6178     self.root.xax
+00002920: 6973 2e6d 616a 6f72 5f6c 6162 656c 5f6f  is.major_label_o
+00002930: 7269 656e 7461 7469 6f6e 203d 2058 4c41  rientation = XLA
+00002940: 4245 4c5f 4f52 4945 4e54 4154 494f 4e0a  BEL_ORIENTATION.
+00002950: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+00002960: 742e 7861 7869 732e 6d69 6e6f 725f 7469  t.xaxis.minor_ti
+00002970: 636b 5f6c 696e 655f 616c 7068 6120 3d20  ck_line_alpha = 
+00002980: 300a 2020 2020 2020 2020 7365 6c66 2e72  0.        self.r
+00002990: 6f6f 742e 785f 7261 6e67 6520 3d20 5261  oot.x_range = Ra
+000029a0: 6e67 6531 6428 7374 6172 743d 3029 0a20  nge1d(start=0). 
+000029b0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+000029c0: 2e79 6178 6973 2e76 6973 6962 6c65 203d  .yaxis.visible =
+000029d0: 2046 616c 7365 0a20 2020 2020 2020 2073   False.        s
+000029e0: 656c 662e 726f 6f74 2e79 6772 6964 2e76  elf.root.ygrid.v
+000029f0: 6973 6962 6c65 203d 2046 616c 7365 0a0a  isible = False..
+00002a00: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+00002a10: 742e 746f 6f6c 6261 725f 6c6f 6361 7469  t.toolbar_locati
+00002a20: 6f6e 203d 2022 6162 6f76 6522 0a20 2020  on = "above".   
+00002a30: 2020 2020 2073 656c 662e 726f 6f74 2e79       self.root.y
+00002a40: 6178 6973 2e76 6973 6962 6c65 203d 2046  axis.visible = F
+00002a50: 616c 7365 0a0a 2020 2020 2020 2020 686f  alse..        ho
+00002a60: 7665 7220 3d20 486f 7665 7254 6f6f 6c28  ver = HoverTool(
+00002a70: 0a20 2020 2020 2020 2020 2020 2070 6f69  .            poi
+00002a80: 6e74 5f70 6f6c 6963 793d 2266 6f6c 6c6f  nt_policy="follo
+00002a90: 775f 6d6f 7573 6522 2c0a 2020 2020 2020  w_mouse",.      
+00002aa0: 2020 2020 2020 746f 6f6c 7469 7073 3d22        tooltips="
+00002ab0: 2222 0a20 2020 2020 2020 2020 2020 2020  "".             
+00002ac0: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+00002ad0: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
 00002ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002af0: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-00002b00: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
-00002b10: 2d73 697a 653a 2031 3270 783b 2066 6f6e  -size: 12px; fon
-00002b20: 742d 7765 6967 6874 3a20 626f 6c64 3b22  t-weight: bold;"
-00002b30: 3e50 726f 6365 7373 206d 656d 6f72 7920  >Process memory 
-00002b40: 2852 5353 293a 3c2f 7370 616e 3e26 6e62  (RSS):</span>&nb
-00002b50: 7370 3b0a 2020 2020 2020 2020 2020 2020  sp;.            
-00002b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002b70: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
-00002b80: 2266 6f6e 742d 7369 7a65 3a20 3130 7078  "font-size: 10px
-00002b90: 3b20 666f 6e74 2d66 616d 696c 793a 204d  ; font-family: M
-00002ba0: 6f6e 6163 6f2c 206d 6f6e 6f73 7061 6365  onaco, monospace
-00002bb0: 3b22 3e40 7072 6f63 5f6d 656d 6f72 797b  ;">@proc_memory{
-00002bc0: 302e 3030 2062 7d3c 2f73 7061 6e3e 0a20  0.00 b}</span>. 
+00002af0: 2020 2020 203c 7370 616e 2073 7479 6c65       <span style
+00002b00: 3d22 666f 6e74 2d73 697a 653a 2031 3270  ="font-size: 12p
+00002b10: 783b 2066 6f6e 742d 7765 6967 6874 3a20  x; font-weight: 
+00002b20: 626f 6c64 3b22 3e50 726f 6365 7373 206d  bold;">Process m
+00002b30: 656d 6f72 7920 2852 5353 293a 3c2f 7370  emory (RSS):</sp
+00002b40: 616e 3e26 6e62 7370 3b0a 2020 2020 2020  an>&nbsp;.      
+00002b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002b60: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
+00002b70: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
+00002b80: 3a20 3130 7078 3b20 666f 6e74 2d66 616d  : 10px; font-fam
+00002b90: 696c 793a 204d 6f6e 6163 6f2c 206d 6f6e  ily: Monaco, mon
+00002ba0: 6f73 7061 6365 3b22 3e40 7072 6f63 5f6d  ospace;">@proc_m
+00002bb0: 656d 6f72 797b 302e 3030 2062 7d3c 2f73  emory{0.00 b}</s
+00002bc0: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
 00002bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002be0: 2020 2020 2020 2020 2020 203c 2f64 6976             </div
-00002bf0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-00002c00: 2020 2020 2020 2020 2020 2020 2020 3c64                <d
-00002c10: 6976 2073 7479 6c65 3d22 6d61 7267 696e  iv style="margin
-00002c20: 2d6c 6566 743a 2031 656d 3b22 3e0a 2020  -left: 1em;">.  
+00002be0: 203c 2f64 6976 3e0a 2020 2020 2020 2020   </div>.        
+00002bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002c00: 2020 2020 3c64 6976 2073 7479 6c65 3d22      <div style="
+00002c10: 6d61 7267 696e 2d6c 6566 743a 2031 656d  margin-left: 1em
+00002c20: 3b22 3e0a 2020 2020 2020 2020 2020 2020  ;">.            
 00002c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002c40: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
-00002c50: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
-00002c60: 7369 7a65 3a20 3132 7078 3b20 666f 6e74  size: 12px; font
-00002c70: 2d77 6569 6768 743a 2062 6f6c 643b 223e  -weight: bold;">
-00002c80: 4d61 6e61 6765 643a 3c2f 7370 616e 3e26  Managed:</span>&
-00002c90: 6e62 7370 3b0a 2020 2020 2020 2020 2020  nbsp;.          
-00002ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002cb0: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
-00002cc0: 653d 2266 6f6e 742d 7369 7a65 3a20 3130  e="font-size: 10
-00002cd0: 7078 3b20 666f 6e74 2d66 616d 696c 793a  px; font-family:
-00002ce0: 204d 6f6e 6163 6f2c 206d 6f6e 6f73 7061   Monaco, monospa
-00002cf0: 6365 3b22 3e40 6d61 6e61 6765 647b 302e  ce;">@managed{0.
-00002d00: 3030 2062 7d3c 2f73 7061 6e3e 0a20 2020  00 b}</span>.   
-00002d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002d20: 2020 2020 2020 2020 203c 2f64 6976 3e0a           </div>.
+00002c40: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
+00002c50: 2266 6f6e 742d 7369 7a65 3a20 3132 7078  "font-size: 12px
+00002c60: 3b20 666f 6e74 2d77 6569 6768 743a 2062  ; font-weight: b
+00002c70: 6f6c 643b 223e 4d61 6e61 6765 643a 3c2f  old;">Managed:</
+00002c80: 7370 616e 3e26 6e62 7370 3b0a 2020 2020  span>&nbsp;.    
+00002c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002ca0: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
+00002cb0: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
+00002cc0: 7a65 3a20 3130 7078 3b20 666f 6e74 2d66  ze: 10px; font-f
+00002cd0: 616d 696c 793a 204d 6f6e 6163 6f2c 206d  amily: Monaco, m
+00002ce0: 6f6e 6f73 7061 6365 3b22 3e40 6d61 6e61  onospace;">@mana
+00002cf0: 6765 647b 302e 3030 2062 7d3c 2f73 7061  ged{0.00 b}</spa
+00002d00: 6e3e 0a20 2020 2020 2020 2020 2020 2020  n>.             
+00002d10: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+00002d20: 2f64 6976 3e0a 2020 2020 2020 2020 2020  /div>.          
 00002d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002d40: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
-00002d50: 2073 7479 6c65 3d22 6d61 7267 696e 2d6c   style="margin-l
-00002d60: 6566 743a 2031 656d 3b22 3e0a 2020 2020  eft: 1em;">.    
+00002d40: 2020 3c64 6976 2073 7479 6c65 3d22 6d61    <div style="ma
+00002d50: 7267 696e 2d6c 6566 743a 2031 656d 3b22  rgin-left: 1em;"
+00002d60: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
 00002d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002d80: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
-00002d90: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
-00002da0: 7a65 3a20 3132 7078 3b20 666f 6e74 2d77  ze: 12px; font-w
-00002db0: 6569 6768 743a 2062 6f6c 643b 223e 556e  eight: bold;">Un
-00002dc0: 6d61 6e61 6765 6420 286f 6c64 293a 3c2f  managed (old):</
-00002dd0: 7370 616e 3e26 6e62 7370 3b0a 2020 2020  span>&nbsp;.    
+00002d80: 2020 3c73 7061 6e20 7374 796c 653d 2266    <span style="f
+00002d90: 6f6e 742d 7369 7a65 3a20 3132 7078 3b20  ont-size: 12px; 
+00002da0: 666f 6e74 2d77 6569 6768 743a 2062 6f6c  font-weight: bol
+00002db0: 643b 223e 556e 6d61 6e61 6765 6420 286f  d;">Unmanaged (o
+00002dc0: 6c64 293a 3c2f 7370 616e 3e26 6e62 7370  ld):</span>&nbsp
+00002dd0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
 00002de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002df0: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
-00002e00: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
-00002e10: 7a65 3a20 3130 7078 3b20 666f 6e74 2d66  ze: 10px; font-f
-00002e20: 616d 696c 793a 204d 6f6e 6163 6f2c 206d  amily: Monaco, m
-00002e30: 6f6e 6f73 7061 6365 3b22 3e40 756e 6d61  onospace;">@unma
-00002e40: 6e61 6765 645f 6f6c 647b 302e 3030 2062  naged_old{0.00 b
-00002e50: 7d3c 2f73 7061 6e3e 0a20 2020 2020 2020  }</span>.       
-00002e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002e70: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
-00002e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002e90: 2020 2020 2020 2020 3c64 6976 2073 7479          <div sty
-00002ea0: 6c65 3d22 6d61 7267 696e 2d6c 6566 743a  le="margin-left:
-00002eb0: 2031 656d 3b22 3e0a 2020 2020 2020 2020   1em;">.        
-00002ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002ed0: 2020 2020 2020 2020 3c73 7061 6e20 7374          <span st
-00002ee0: 796c 653d 2266 6f6e 742d 7369 7a65 3a20  yle="font-size: 
-00002ef0: 3132 7078 3b20 666f 6e74 2d77 6569 6768  12px; font-weigh
-00002f00: 743a 2062 6f6c 643b 223e 556e 6d61 6e61  t: bold;">Unmana
-00002f10: 6765 6420 2872 6563 656e 7429 3a3c 2f73  ged (recent):</s
-00002f20: 7061 6e3e 266e 6273 703b 0a20 2020 2020  pan>&nbsp;.     
+00002df0: 2020 3c73 7061 6e20 7374 796c 653d 2266    <span style="f
+00002e00: 6f6e 742d 7369 7a65 3a20 3130 7078 3b20  ont-size: 10px; 
+00002e10: 666f 6e74 2d66 616d 696c 793a 204d 6f6e  font-family: Mon
+00002e20: 6163 6f2c 206d 6f6e 6f73 7061 6365 3b22  aco, monospace;"
+00002e30: 3e40 756e 6d61 6e61 6765 645f 6f6c 647b  >@unmanaged_old{
+00002e40: 302e 3030 2062 7d3c 2f73 7061 6e3e 0a20  0.00 b}</span>. 
+00002e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002e60: 2020 2020 2020 2020 2020 203c 2f64 6976             </div
+00002e70: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+00002e80: 2020 2020 2020 2020 2020 2020 2020 3c64                <d
+00002e90: 6976 2073 7479 6c65 3d22 6d61 7267 696e  iv style="margin
+00002ea0: 2d6c 6566 743a 2031 656d 3b22 3e0a 2020  -left: 1em;">.  
+00002eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002ec0: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
+00002ed0: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
+00002ee0: 7369 7a65 3a20 3132 7078 3b20 666f 6e74  size: 12px; font
+00002ef0: 2d77 6569 6768 743a 2062 6f6c 643b 223e  -weight: bold;">
+00002f00: 556e 6d61 6e61 6765 6420 2872 6563 656e  Unmanaged (recen
+00002f10: 7429 3a3c 2f73 7061 6e3e 266e 6273 703b  t):</span>&nbsp;
+00002f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00002f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002f40: 2020 2020 2020 2020 2020 203c 7370 616e             <span
-00002f50: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
-00002f60: 653a 2031 3070 783b 2066 6f6e 742d 6661  e: 10px; font-fa
-00002f70: 6d69 6c79 3a20 4d6f 6e61 636f 2c20 6d6f  mily: Monaco, mo
-00002f80: 6e6f 7370 6163 653b 223e 4075 6e6d 616e  nospace;">@unman
-00002f90: 6167 6564 5f72 6563 656e 747b 302e 3030  aged_recent{0.00
-00002fa0: 2062 7d3c 2f73 7061 6e3e 0a20 2020 2020   b}</span>.     
-00002fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002fc0: 2020 2020 2020 203c 2f64 6976 3e0a 2020         </div>.  
+00002f40: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
+00002f50: 6e74 2d73 697a 653a 2031 3070 783b 2066  nt-size: 10px; f
+00002f60: 6f6e 742d 6661 6d69 6c79 3a20 4d6f 6e61  ont-family: Mona
+00002f70: 636f 2c20 6d6f 6e6f 7370 6163 653b 223e  co, monospace;">
+00002f80: 4075 6e6d 616e 6167 6564 5f72 6563 656e  @unmanaged_recen
+00002f90: 747b 302e 3030 2062 7d3c 2f73 7061 6e3e  t{0.00 b}</span>
+00002fa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002fb0: 2020 2020 2020 2020 2020 2020 203c 2f64               </d
+00002fc0: 6976 3e0a 2020 2020 2020 2020 2020 2020  iv>.            
 00002fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002fe0: 2020 2020 2020 2020 2020 3c64 6976 3e0a            <div>.
+00002fe0: 3c64 6976 3e0a 2020 2020 2020 2020 2020  <div>.          
 00002ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003010: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
-00003020: 742d 7369 7a65 3a20 3132 7078 3b20 666f  t-size: 12px; fo
-00003030: 6e74 2d77 6569 6768 743a 2062 6f6c 643b  nt-weight: bold;
-00003040: 223e 5370 696c 6c65 6420 746f 2064 6973  ">Spilled to dis
-00003050: 6b3a 3c2f 7370 616e 3e26 6e62 7370 3b0a  k:</span>&nbsp;.
+00003000: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
+00003010: 653d 2266 6f6e 742d 7369 7a65 3a20 3132  e="font-size: 12
+00003020: 7078 3b20 666f 6e74 2d77 6569 6768 743a  px; font-weight:
+00003030: 2062 6f6c 643b 223e 5370 696c 6c65 6420   bold;">Spilled 
+00003040: 746f 2064 6973 6b3a 3c2f 7370 616e 3e26  to disk:</span>&
+00003050: 6e62 7370 3b0a 2020 2020 2020 2020 2020  nbsp;.          
 00003060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003080: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
-00003090: 742d 7369 7a65 3a20 3130 7078 3b20 666f  t-size: 10px; fo
-000030a0: 6e74 2d66 616d 696c 793a 204d 6f6e 6163  nt-family: Monac
-000030b0: 6f2c 206d 6f6e 6f73 7061 6365 3b22 3e40  o, monospace;">@
-000030c0: 7370 696c 6c65 647b 302e 3030 2062 7d3c  spilled{0.00 b}<
-000030d0: 2f73 7061 6e3e 0a20 2020 2020 2020 2020  /span>.         
-000030e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000030f0: 2020 203c 2f64 6976 3e0a 2020 2020 2020     </div>.      
-00003100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003110: 2020 2020 2020 2222 222c 0a20 2020 2020        """,.     
-00003120: 2020 2029 0a20 2020 2020 2020 2068 656c     ).        hel
-00003130: 705f 203d 2048 656c 7054 6f6f 6c28 0a20  p_ = HelpTool(. 
-00003140: 2020 2020 2020 2020 2020 2072 6564 6972             redir
-00003150: 6563 743d 2268 7474 7073 3a2f 2f64 6f63  ect="https://doc
-00003160: 732e 6461 736b 2e6f 7267 2f65 6e2f 7374  s.dask.org/en/st
-00003170: 6162 6c65 2f64 6173 6862 6f61 7264 2e68  able/dashboard.h
-00003180: 746d 6c23 6279 7465 732d 7374 6f72 6564  tml#bytes-stored
-00003190: 2d61 6e64 2d62 7974 6573 2d70 6572 2d77  -and-bytes-per-w
-000031a0: 6f72 6b65 7222 2c0a 2020 2020 2020 2020  orker",.        
-000031b0: 2020 2020 6465 7363 7269 7074 696f 6e3d      description=
-000031c0: 2244 6573 6372 6970 7469 6f6e 206f 6620  "Description of 
-000031d0: 6279 7465 7320 7374 6f72 6564 2070 6c6f  bytes stored plo
-000031e0: 7473 222c 0a20 2020 2020 2020 2029 0a20  ts",.        ). 
-000031f0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-00003200: 2e61 6464 5f74 6f6f 6c73 2868 6f76 6572  .add_tools(hover
-00003210: 2c20 6865 6c70 5f29 0a0a 2020 2020 6465  , help_)..    de
-00003220: 6620 5f63 6c75 7374 6572 5f6d 656d 6f72  f _cluster_memor
-00003230: 795f 636f 6c6f 7228 7365 6c66 2920 2d3e  y_color(self) ->
-00003240: 2073 7472 3a0a 2020 2020 2020 2020 636f   str:.        co
-00003250: 6c6f 7273 203d 207b 0a20 2020 2020 2020  lors = {.       
-00003260: 2020 2020 2073 656c 662e 5f6d 656d 6f72       self._memor
-00003270: 795f 636f 6c6f 7228 0a20 2020 2020 2020  y_color(.       
-00003280: 2020 2020 2020 2020 2063 7572 7265 6e74           current
-00003290: 3d77 732e 6d65 6d6f 7279 2e70 726f 6365  =ws.memory.proce
-000032a0: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
-000032b0: 2020 2020 6c69 6d69 743d 6765 7461 7474      limit=getatt
-000032c0: 7228 7773 2c20 226d 656d 6f72 795f 6c69  r(ws, "memory_li
-000032d0: 6d69 7422 2c20 3029 2c0a 2020 2020 2020  mit", 0),.      
-000032e0: 2020 2020 2020 2020 2020 7374 6174 7573            status
-000032f0: 3d77 732e 7374 6174 7573 2c0a 2020 2020  =ws.status,.    
-00003300: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00003310: 2020 2020 2020 666f 7220 7773 2069 6e20        for ws in 
-00003320: 7365 6c66 2e73 6368 6564 756c 6572 2e77  self.scheduler.w
-00003330: 6f72 6b65 7273 2e76 616c 7565 7328 290a  orkers.values().
-00003340: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00003350: 2020 2061 7373 6572 7420 636f 6c6f 7273     assert colors
-00003360: 2e69 7373 7562 7365 7428 7b22 7265 6422  .issubset({"red"
-00003370: 2c20 226f 7261 6e67 6522 2c20 2262 6c75  , "orange", "blu
-00003380: 6522 7d29 0a20 2020 2020 2020 2069 6620  e"}).        if 
-00003390: 2272 6564 2220 696e 2063 6f6c 6f72 733a  "red" in colors:
-000033a0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000033b0: 7572 6e20 2272 6564 220a 2020 2020 2020  urn "red".      
-000033c0: 2020 656c 6966 2022 6f72 616e 6765 2220    elif "orange" 
-000033d0: 696e 2063 6f6c 6f72 733a 0a20 2020 2020  in colors:.     
-000033e0: 2020 2020 2020 2072 6574 7572 6e20 226f         return "o
-000033f0: 7261 6e67 6522 0a20 2020 2020 2020 2065  range".        e
-00003400: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00003410: 2072 6574 7572 6e20 2262 6c75 6522 0a0a   return "blue"..
-00003420: 2020 2020 4077 6974 686f 7574 5f70 726f      @without_pro
-00003430: 7065 7274 795f 7661 6c69 6461 7469 6f6e  perty_validation
-00003440: 0a20 2020 2040 6c6f 675f 6572 726f 7273  .    @log_errors
-00003450: 0a20 2020 2064 6566 2075 7064 6174 6528  .    def update(
-00003460: 7365 6c66 293a 0a20 2020 2020 2020 206c  self):.        l
-00003470: 696d 6974 203d 2073 756d 2877 732e 6d65  imit = sum(ws.me
-00003480: 6d6f 7279 5f6c 696d 6974 2066 6f72 2077  mory_limit for w
-00003490: 7320 696e 2073 656c 662e 7363 6865 6475  s in self.schedu
-000034a0: 6c65 722e 776f 726b 6572 732e 7661 6c75  ler.workers.valu
-000034b0: 6573 2829 290a 2020 2020 2020 2020 6d65  es()).        me
-000034c0: 6d69 6e66 6f20 3d20 7365 6c66 2e73 6368  minfo = self.sch
-000034d0: 6564 756c 6572 2e6d 656d 6f72 790a 2020  eduler.memory.  
-000034e0: 2020 2020 2020 636f 6c6f 7220 3d20 7365        color = se
-000034f0: 6c66 2e5f 636c 7573 7465 725f 6d65 6d6f  lf._cluster_memo
-00003500: 7279 5f63 6f6c 6f72 2829 0a0a 2020 2020  ry_color()..    
-00003510: 2020 2020 7769 6474 6820 3d20 5b0a 2020      width = [.  
-00003520: 2020 2020 2020 2020 2020 6d65 6d69 6e66            meminf
-00003530: 6f2e 6d61 6e61 6765 642c 0a20 2020 2020  o.managed,.     
-00003540: 2020 2020 2020 206d 656d 696e 666f 2e75         meminfo.u
-00003550: 6e6d 616e 6167 6564 5f6f 6c64 2c0a 2020  nmanaged_old,.  
-00003560: 2020 2020 2020 2020 2020 6d65 6d69 6e66            meminf
-00003570: 6f2e 756e 6d61 6e61 6765 645f 7265 6365  o.unmanaged_rece
-00003580: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
-00003590: 6d65 6d69 6e66 6f2e 7370 696c 6c65 642c  meminfo.spilled,
-000035a0: 0a20 2020 2020 2020 205d 0a0a 2020 2020  .        ]..    
-000035b0: 2020 2020 7265 7375 6c74 203d 207b 0a20      result = {. 
-000035c0: 2020 2020 2020 2020 2020 2022 7769 6474             "widt
-000035d0: 6822 3a20 7769 6474 682c 0a20 2020 2020  h": width,.     
-000035e0: 2020 2020 2020 2022 7822 3a20 5b73 756d         "x": [sum
-000035f0: 2877 6964 7468 5b3a 695d 2920 2b20 7720  (width[:i]) + w 
-00003600: 2f20 3220 666f 7220 692c 2077 2069 6e20  / 2 for i, w in 
-00003610: 656e 756d 6572 6174 6528 7769 6474 6829  enumerate(width)
-00003620: 5d2c 0a20 2020 2020 2020 2020 2020 2022  ],.            "
-00003630: 636f 6c6f 7222 3a20 5b63 6f6c 6f72 2c20  color": [color, 
-00003640: 636f 6c6f 722c 2063 6f6c 6f72 2c20 2267  color, color, "g
-00003650: 7265 7922 5d2c 0a20 2020 2020 2020 2020  rey"],.         
-00003660: 2020 2022 7072 6f63 5f6d 656d 6f72 7922     "proc_memory"
-00003670: 3a20 5b6d 656d 696e 666f 2e70 726f 6365  : [meminfo.proce
-00003680: 7373 5d20 2a20 342c 0a20 2020 2020 2020  ss] * 4,.       
-00003690: 2020 2020 2022 6d61 6e61 6765 6422 3a20       "managed": 
-000036a0: 5b6d 656d 696e 666f 2e6d 616e 6167 6564  [meminfo.managed
-000036b0: 5d20 2a20 342c 0a20 2020 2020 2020 2020  ] * 4,.         
-000036c0: 2020 2022 756e 6d61 6e61 6765 645f 6f6c     "unmanaged_ol
-000036d0: 6422 3a20 5b6d 656d 696e 666f 2e75 6e6d  d": [meminfo.unm
-000036e0: 616e 6167 6564 5f6f 6c64 5d20 2a20 342c  anaged_old] * 4,
-000036f0: 0a20 2020 2020 2020 2020 2020 2022 756e  .            "un
-00003700: 6d61 6e61 6765 645f 7265 6365 6e74 223a  managed_recent":
-00003710: 205b 6d65 6d69 6e66 6f2e 756e 6d61 6e61   [meminfo.unmana
-00003720: 6765 645f 7265 6365 6e74 5d20 2a20 342c  ged_recent] * 4,
-00003730: 0a20 2020 2020 2020 2020 2020 2022 7370  .            "sp
-00003740: 696c 6c65 6422 3a20 5b6d 656d 696e 666f  illed": [meminfo
-00003750: 2e73 7069 6c6c 6564 5d20 2a20 342c 0a20  .spilled] * 4,. 
-00003760: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00003770: 2020 785f 656e 6420 3d20 6d61 7828 6c69    x_end = max(li
-00003780: 6d69 742c 206d 656d 696e 666f 2e70 726f  mit, meminfo.pro
-00003790: 6365 7373 202b 206d 656d 696e 666f 2e73  cess + meminfo.s
-000037a0: 7069 6c6c 6564 290a 2020 2020 2020 2020  pilled).        
-000037b0: 7365 6c66 2e72 6f6f 742e 785f 7261 6e67  self.root.x_rang
-000037c0: 652e 656e 6420 3d20 785f 656e 640a 0a20  e.end = x_end.. 
-000037d0: 2020 2020 2020 2074 6974 6c65 203d 2066         title = f
-000037e0: 2242 7974 6573 2073 746f 7265 643a 207b  "Bytes stored: {
-000037f0: 666f 726d 6174 5f62 7974 6573 286d 656d  format_bytes(mem
-00003800: 696e 666f 2e70 726f 6365 7373 297d 220a  info.process)}".
-00003810: 2020 2020 2020 2020 6966 206d 656d 696e          if memin
-00003820: 666f 2e73 7069 6c6c 6564 3a0a 2020 2020  fo.spilled:.    
-00003830: 2020 2020 2020 2020 7469 746c 6520 2b3d          title +=
-00003840: 2066 2220 2b20 7b66 6f72 6d61 745f 6279   f" + {format_by
-00003850: 7465 7328 6d65 6d69 6e66 6f2e 7370 696c  tes(meminfo.spil
-00003860: 6c65 6429 7d20 7370 696c 6c65 6420 746f  led)} spilled to
-00003870: 2064 6973 6b22 0a20 2020 2020 2020 2073   disk".        s
-00003880: 656c 662e 726f 6f74 2e74 6974 6c65 2e74  elf.root.title.t
-00003890: 6578 7420 3d20 7469 746c 650a 0a20 2020  ext = title..   
-000038a0: 2020 2020 2075 7064 6174 6528 7365 6c66       update(self
-000038b0: 2e73 6f75 7263 652c 2072 6573 756c 7429  .source, result)
-000038c0: 0a0a 0a63 6c61 7373 2057 6f72 6b65 7273  ...class Workers
-000038d0: 4d65 6d6f 7279 2844 6173 6862 6f61 7264  Memory(Dashboard
-000038e0: 436f 6d70 6f6e 656e 742c 204d 656d 6f72  Component, Memor
-000038f0: 7943 6f6c 6f72 293a 0a20 2020 2022 2222  yColor):.    """
-00003900: 4d65 6d6f 7279 2075 7361 6765 2066 6f72  Memory usage for
-00003910: 2073 696e 676c 6520 776f 726b 6572 7322   single workers"
-00003920: 2222 0a0a 2020 2020 406c 6f67 5f65 7272  ""..    @log_err
-00003930: 6f72 730a 2020 2020 6465 6620 5f5f 696e  ors.    def __in
-00003940: 6974 5f5f 2873 656c 662c 2073 6368 6564  it__(self, sched
-00003950: 756c 6572 2c20 7769 6474 683d 3630 302c  uler, width=600,
-00003960: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
-00003970: 2020 2020 4461 7368 626f 6172 6443 6f6d      DashboardCom
-00003980: 706f 6e65 6e74 2e5f 5f69 6e69 745f 5f28  ponent.__init__(
-00003990: 7365 6c66 290a 2020 2020 2020 2020 4d65  self).        Me
-000039a0: 6d6f 7279 436f 6c6f 722e 5f5f 696e 6974  moryColor.__init
-000039b0: 5f5f 2873 656c 6629 0a0a 2020 2020 2020  __(self)..      
-000039c0: 2020 7365 6c66 2e73 6368 6564 756c 6572    self.scheduler
-000039d0: 203d 2073 6368 6564 756c 6572 0a20 2020   = scheduler.   
-000039e0: 2020 2020 2073 656c 662e 736f 7572 6365       self.source
-000039f0: 203d 2043 6f6c 756d 6e44 6174 6153 6f75   = ColumnDataSou
-00003a00: 7263 6528 0a20 2020 2020 2020 2020 2020  rce(.           
-00003a10: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00003a20: 2020 2022 7769 6474 6822 3a20 5b5d 2c0a     "width": [],.
-00003a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003a40: 2278 223a 205b 5d2c 0a20 2020 2020 2020  "x": [],.       
-00003a50: 2020 2020 2020 2020 2022 7922 3a20 5b5d           "y": []
-00003a60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00003a70: 2020 2263 6f6c 6f72 223a 205b 5d2c 0a20    "color": [],. 
-00003a80: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00003a90: 616c 7068 6122 3a20 5b5d 2c0a 2020 2020  alpha": [],.    
-00003aa0: 2020 2020 2020 2020 2020 2020 2277 6f72              "wor
-00003ab0: 6b65 7222 3a20 5b5d 2c0a 2020 2020 2020  ker": [],.      
-00003ac0: 2020 2020 2020 2020 2020 2265 7363 6170            "escap
-00003ad0: 6564 5f77 6f72 6b65 7222 3a20 5b5d 2c0a  ed_worker": [],.
-00003ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003af0: 2270 726f 635f 6d65 6d6f 7279 223a 205b  "proc_memory": [
-00003b00: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00003b10: 2020 2022 6d61 6e61 6765 6422 3a20 5b5d     "managed": []
-00003b20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00003b30: 2020 2275 6e6d 616e 6167 6564 5f6f 6c64    "unmanaged_old
-00003b40: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-00003b50: 2020 2020 2020 2022 756e 6d61 6e61 6765         "unmanage
-00003b60: 645f 7265 6365 6e74 223a 205b 5d2c 0a20  d_recent": [],. 
-00003b70: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00003b80: 7370 696c 6c65 6422 3a20 5b5d 2c0a 2020  spilled": [],.  
-00003b90: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00003ba0: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
-00003bb0: 656c 662e 726f 6f74 203d 2066 6967 7572  elf.root = figur
-00003bc0: 6528 0a20 2020 2020 2020 2020 2020 2074  e(.            t
-00003bd0: 6974 6c65 3d22 4279 7465 7320 7374 6f72  itle="Bytes stor
-00003be0: 6564 2070 6572 2077 6f72 6b65 7222 2c0a  ed per worker",.
-00003bf0: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
-00003c00: 733d 2222 2c0a 2020 2020 2020 2020 2020  s="",.          
-00003c10: 2020 7769 6474 683d 696e 7428 7769 6474    width=int(widt
-00003c20: 6820 2f20 3229 2c0a 2020 2020 2020 2020  h / 2),.        
-00003c30: 2020 2020 6e61 6d65 3d22 776f 726b 6572      name="worker
-00003c40: 735f 6d65 6d6f 7279 222c 0a20 2020 2020  s_memory",.     
-00003c50: 2020 2020 2020 206d 696e 5f62 6f72 6465         min_borde
-00003c60: 725f 626f 7474 6f6d 3d35 302c 0a20 2020  r_bottom=50,.   
-00003c70: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
-00003c80: 732c 0a20 2020 2020 2020 2029 0a20 2020  s,.        ).   
-00003c90: 2020 2020 2072 6563 7420 3d20 7365 6c66       rect = self
-00003ca0: 2e72 6f6f 742e 7265 6374 280a 2020 2020  .root.rect(.    
-00003cb0: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
-00003cc0: 656c 662e 736f 7572 6365 2c0a 2020 2020  elf.source,.    
-00003cd0: 2020 2020 2020 2020 783d 2278 222c 0a20          x="x",. 
-00003ce0: 2020 2020 2020 2020 2020 2079 3d22 7922             y="y"
-00003cf0: 2c0a 2020 2020 2020 2020 2020 2020 7769  ,.            wi
-00003d00: 6474 683d 2277 6964 7468 222c 0a20 2020  dth="width",.   
-00003d10: 2020 2020 2020 2020 2068 6569 6768 743d           height=
-00003d20: 302e 392c 0a20 2020 2020 2020 2020 2020  0.9,.           
-00003d30: 2063 6f6c 6f72 3d22 636f 6c6f 7222 2c0a   color="color",.
-00003d40: 2020 2020 2020 2020 2020 2020 6669 6c6c              fill
-00003d50: 5f61 6c70 6861 3d22 616c 7068 6122 2c0a  _alpha="alpha",.
-00003d60: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
-00003d70: 5f77 6964 7468 3d30 2c0a 2020 2020 2020  _width=0,.      
-00003d80: 2020 290a 2020 2020 2020 2020 7265 6374    ).        rect
-00003d90: 2e6e 6f6e 7365 6c65 6374 696f 6e5f 676c  .nonselection_gl
-00003da0: 7970 6820 3d20 4e6f 6e65 0a0a 2020 2020  yph = None..    
-00003db0: 2020 2020 7365 6c66 2e72 6f6f 742e 6178      self.root.ax
-00003dc0: 6973 5b30 5d2e 7469 636b 6572 203d 2042  is[0].ticker = B
-00003dd0: 6173 6963 5469 636b 6572 282a 2a54 4943  asicTicker(**TIC
-00003de0: 4b53 5f31 3032 3429 0a20 2020 2020 2020  KS_1024).       
-00003df0: 2073 656c 662e 726f 6f74 2e78 6178 6973   self.root.xaxis
-00003e00: 5b30 5d2e 666f 726d 6174 7465 7220 3d20  [0].formatter = 
-00003e10: 4e75 6d65 7261 6c54 6963 6b46 6f72 6d61  NumeralTickForma
-00003e20: 7474 6572 2866 6f72 6d61 743d 2230 2e30  tter(format="0.0
-00003e30: 2062 2229 0a20 2020 2020 2020 2073 656c   b").        sel
-00003e40: 662e 726f 6f74 2e78 6178 6973 2e6d 616a  f.root.xaxis.maj
-00003e50: 6f72 5f6c 6162 656c 5f6f 7269 656e 7461  or_label_orienta
-00003e60: 7469 6f6e 203d 2058 4c41 4245 4c5f 4f52  tion = XLABEL_OR
-00003e70: 4945 4e54 4154 494f 4e0a 2020 2020 2020  IENTATION.      
-00003e80: 2020 7365 6c66 2e72 6f6f 742e 7861 7869    self.root.xaxi
-00003e90: 732e 6d69 6e6f 725f 7469 636b 5f6c 696e  s.minor_tick_lin
-00003ea0: 655f 616c 7068 6120 3d20 300a 2020 2020  e_alpha = 0.    
-00003eb0: 2020 2020 7365 6c66 2e72 6f6f 742e 785f      self.root.x_
-00003ec0: 7261 6e67 6520 3d20 5261 6e67 6531 6428  range = Range1d(
-00003ed0: 7374 6172 743d 3029 0a20 2020 2020 2020  start=0).       
-00003ee0: 2073 656c 662e 726f 6f74 2e79 6178 6973   self.root.yaxis
-00003ef0: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
-00003f00: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-00003f10: 6f74 2e79 6772 6964 2e76 6973 6962 6c65  ot.ygrid.visible
-00003f20: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-00003f30: 2073 656c 662e 726f 6f74 2e74 6f6f 6c62   self.root.toolb
-00003f40: 6172 5f6c 6f63 6174 696f 6e20 3d20 4e6f  ar_location = No
-00003f50: 6e65 0a0a 2020 2020 2020 2020 7461 7020  ne..        tap 
-00003f60: 3d20 5461 7054 6f6f 6c28 6361 6c6c 6261  = TapTool(callba
-00003f70: 636b 3d4f 7065 6e55 524c 2875 726c 3d22  ck=OpenURL(url="
-00003f80: 2e2f 696e 666f 2f77 6f72 6b65 722f 4065  ./info/worker/@e
-00003f90: 7363 6170 6564 5f77 6f72 6b65 722e 6874  scaped_worker.ht
-00003fa0: 6d6c 2229 290a 2020 2020 2020 2020 7365  ml")).        se
-00003fb0: 6c66 2e72 6f6f 742e 6164 645f 746f 6f6c  lf.root.add_tool
-00003fc0: 7328 7461 7029 0a0a 2020 2020 2020 2020  s(tap)..        
-00003fd0: 686f 7665 7220 3d20 486f 7665 7254 6f6f  hover = HoverToo
-00003fe0: 6c28 0a20 2020 2020 2020 2020 2020 2070  l(.            p
-00003ff0: 6f69 6e74 5f70 6f6c 6963 793d 2266 6f6c  oint_policy="fol
-00004000: 6c6f 775f 6d6f 7573 6522 2c0a 2020 2020  low_mouse",.    
-00004010: 2020 2020 2020 2020 746f 6f6c 7469 7073          tooltips
-00004020: 3d22 2222 0a20 2020 2020 2020 2020 2020  =""".           
-00004030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004040: 203c 6469 763e 0a20 2020 2020 2020 2020   <div>.         
-00004050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004060: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
-00004070: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
-00004080: 3270 783b 2066 6f6e 742d 7765 6967 6874  2px; font-weight
-00004090: 3a20 626f 6c64 3b22 3e57 6f72 6b65 723a  : bold;">Worker:
-000040a0: 3c2f 7370 616e 3e26 6e62 7370 3b0a 2020  </span>&nbsp;.  
+00003070: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
+00003080: 653d 2266 6f6e 742d 7369 7a65 3a20 3130  e="font-size: 10
+00003090: 7078 3b20 666f 6e74 2d66 616d 696c 793a  px; font-family:
+000030a0: 204d 6f6e 6163 6f2c 206d 6f6e 6f73 7061   Monaco, monospa
+000030b0: 6365 3b22 3e40 7370 696c 6c65 647b 302e  ce;">@spilled{0.
+000030c0: 3030 2062 7d3c 2f73 7061 6e3e 0a20 2020  00 b}</span>.   
+000030d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000030e0: 2020 2020 2020 2020 203c 2f64 6976 3e0a           </div>.
+000030f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003100: 2020 2020 2020 2020 2020 2020 2222 222c              """,
+00003110: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00003120: 2020 2068 656c 705f 203d 2048 656c 7054     help_ = HelpT
+00003130: 6f6f 6c28 0a20 2020 2020 2020 2020 2020  ool(.           
+00003140: 2072 6564 6972 6563 743d 2268 7474 7073   redirect="https
+00003150: 3a2f 2f64 6f63 732e 6461 736b 2e6f 7267  ://docs.dask.org
+00003160: 2f65 6e2f 7374 6162 6c65 2f64 6173 6862  /en/stable/dashb
+00003170: 6f61 7264 2e68 746d 6c23 6279 7465 732d  oard.html#bytes-
+00003180: 7374 6f72 6564 2d61 6e64 2d62 7974 6573  stored-and-bytes
+00003190: 2d70 6572 2d77 6f72 6b65 7222 2c0a 2020  -per-worker",.  
+000031a0: 2020 2020 2020 2020 2020 6465 7363 7269            descri
+000031b0: 7074 696f 6e3d 2244 6573 6372 6970 7469  ption="Descripti
+000031c0: 6f6e 206f 6620 6279 7465 7320 7374 6f72  on of bytes stor
+000031d0: 6564 2070 6c6f 7473 222c 0a20 2020 2020  ed plots",.     
+000031e0: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
+000031f0: 662e 726f 6f74 2e61 6464 5f74 6f6f 6c73  f.root.add_tools
+00003200: 2868 6f76 6572 2c20 6865 6c70 5f29 0a0a  (hover, help_)..
+00003210: 2020 2020 6465 6620 5f63 6c75 7374 6572      def _cluster
+00003220: 5f6d 656d 6f72 795f 636f 6c6f 7228 7365  _memory_color(se
+00003230: 6c66 2920 2d3e 2073 7472 3a0a 2020 2020  lf) -> str:.    
+00003240: 2020 2020 636f 6c6f 7273 203d 207b 0a20      colors = {. 
+00003250: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00003260: 5f6d 656d 6f72 795f 636f 6c6f 7228 0a20  _memory_color(. 
+00003270: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00003280: 7572 7265 6e74 3d77 732e 6d65 6d6f 7279  urrent=ws.memory
+00003290: 2e70 726f 6365 7373 2c0a 2020 2020 2020  .process,.      
+000032a0: 2020 2020 2020 2020 2020 6c69 6d69 743d            limit=
+000032b0: 6765 7461 7474 7228 7773 2c20 226d 656d  getattr(ws, "mem
+000032c0: 6f72 795f 6c69 6d69 7422 2c20 3029 2c0a  ory_limit", 0),.
+000032d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000032e0: 7374 6174 7573 3d77 732e 7374 6174 7573  status=ws.status
+000032f0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00003300: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00003310: 7773 2069 6e20 7365 6c66 2e73 6368 6564  ws in self.sched
+00003320: 756c 6572 2e77 6f72 6b65 7273 2e76 616c  uler.workers.val
+00003330: 7565 7328 290a 2020 2020 2020 2020 7d0a  ues().        }.
+00003340: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00003350: 636f 6c6f 7273 2e69 7373 7562 7365 7428  colors.issubset(
+00003360: 7b22 7265 6422 2c20 226f 7261 6e67 6522  {"red", "orange"
+00003370: 2c20 2262 6c75 6522 7d29 0a20 2020 2020  , "blue"}).     
+00003380: 2020 2069 6620 2272 6564 2220 696e 2063     if "red" in c
+00003390: 6f6c 6f72 733a 0a20 2020 2020 2020 2020  olors:.         
+000033a0: 2020 2072 6574 7572 6e20 2272 6564 220a     return "red".
+000033b0: 2020 2020 2020 2020 656c 6966 2022 6f72          elif "or
+000033c0: 616e 6765 2220 696e 2063 6f6c 6f72 733a  ange" in colors:
+000033d0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000033e0: 7572 6e20 226f 7261 6e67 6522 0a20 2020  urn "orange".   
+000033f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00003400: 2020 2020 2020 2072 6574 7572 6e20 2262         return "b
+00003410: 6c75 6522 0a0a 2020 2020 4077 6974 686f  lue"..    @witho
+00003420: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
+00003430: 6461 7469 6f6e 0a20 2020 2040 6c6f 675f  dation.    @log_
+00003440: 6572 726f 7273 0a20 2020 2064 6566 2075  errors.    def u
+00003450: 7064 6174 6528 7365 6c66 293a 0a20 2020  pdate(self):.   
+00003460: 2020 2020 206c 696d 6974 203d 2073 756d       limit = sum
+00003470: 2877 732e 6d65 6d6f 7279 5f6c 696d 6974  (ws.memory_limit
+00003480: 2066 6f72 2077 7320 696e 2073 656c 662e   for ws in self.
+00003490: 7363 6865 6475 6c65 722e 776f 726b 6572  scheduler.worker
+000034a0: 732e 7661 6c75 6573 2829 290a 2020 2020  s.values()).    
+000034b0: 2020 2020 6d65 6d69 6e66 6f20 3d20 7365      meminfo = se
+000034c0: 6c66 2e73 6368 6564 756c 6572 2e6d 656d  lf.scheduler.mem
+000034d0: 6f72 790a 2020 2020 2020 2020 636f 6c6f  ory.        colo
+000034e0: 7220 3d20 7365 6c66 2e5f 636c 7573 7465  r = self._cluste
+000034f0: 725f 6d65 6d6f 7279 5f63 6f6c 6f72 2829  r_memory_color()
+00003500: 0a0a 2020 2020 2020 2020 7769 6474 6820  ..        width 
+00003510: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+00003520: 6d65 6d69 6e66 6f2e 6d61 6e61 6765 642c  meminfo.managed,
+00003530: 0a20 2020 2020 2020 2020 2020 206d 656d  .            mem
+00003540: 696e 666f 2e75 6e6d 616e 6167 6564 5f6f  info.unmanaged_o
+00003550: 6c64 2c0a 2020 2020 2020 2020 2020 2020  ld,.            
+00003560: 6d65 6d69 6e66 6f2e 756e 6d61 6e61 6765  meminfo.unmanage
+00003570: 645f 7265 6365 6e74 2c0a 2020 2020 2020  d_recent,.      
+00003580: 2020 2020 2020 6d65 6d69 6e66 6f2e 7370        meminfo.sp
+00003590: 696c 6c65 642c 0a20 2020 2020 2020 205d  illed,.        ]
+000035a0: 0a0a 2020 2020 2020 2020 7265 7375 6c74  ..        result
+000035b0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+000035c0: 2022 7769 6474 6822 3a20 7769 6474 682c   "width": width,
+000035d0: 0a20 2020 2020 2020 2020 2020 2022 7822  .            "x"
+000035e0: 3a20 5b73 756d 2877 6964 7468 5b3a 695d  : [sum(width[:i]
+000035f0: 2920 2b20 7720 2f20 3220 666f 7220 692c  ) + w / 2 for i,
+00003600: 2077 2069 6e20 656e 756d 6572 6174 6528   w in enumerate(
+00003610: 7769 6474 6829 5d2c 0a20 2020 2020 2020  width)],.       
+00003620: 2020 2020 2022 636f 6c6f 7222 3a20 5b63       "color": [c
+00003630: 6f6c 6f72 2c20 636f 6c6f 722c 2063 6f6c  olor, color, col
+00003640: 6f72 2c20 2267 7265 7922 5d2c 0a20 2020  or, "grey"],.   
+00003650: 2020 2020 2020 2020 2022 7072 6f63 5f6d           "proc_m
+00003660: 656d 6f72 7922 3a20 5b6d 656d 696e 666f  emory": [meminfo
+00003670: 2e70 726f 6365 7373 5d20 2a20 342c 0a20  .process] * 4,. 
+00003680: 2020 2020 2020 2020 2020 2022 6d61 6e61             "mana
+00003690: 6765 6422 3a20 5b6d 656d 696e 666f 2e6d  ged": [meminfo.m
+000036a0: 616e 6167 6564 5d20 2a20 342c 0a20 2020  anaged] * 4,.   
+000036b0: 2020 2020 2020 2020 2022 756e 6d61 6e61           "unmana
+000036c0: 6765 645f 6f6c 6422 3a20 5b6d 656d 696e  ged_old": [memin
+000036d0: 666f 2e75 6e6d 616e 6167 6564 5f6f 6c64  fo.unmanaged_old
+000036e0: 5d20 2a20 342c 0a20 2020 2020 2020 2020  ] * 4,.         
+000036f0: 2020 2022 756e 6d61 6e61 6765 645f 7265     "unmanaged_re
+00003700: 6365 6e74 223a 205b 6d65 6d69 6e66 6f2e  cent": [meminfo.
+00003710: 756e 6d61 6e61 6765 645f 7265 6365 6e74  unmanaged_recent
+00003720: 5d20 2a20 342c 0a20 2020 2020 2020 2020  ] * 4,.         
+00003730: 2020 2022 7370 696c 6c65 6422 3a20 5b6d     "spilled": [m
+00003740: 656d 696e 666f 2e73 7069 6c6c 6564 5d20  eminfo.spilled] 
+00003750: 2a20 342c 0a20 2020 2020 2020 207d 0a0a  * 4,.        }..
+00003760: 2020 2020 2020 2020 785f 656e 6420 3d20          x_end = 
+00003770: 6d61 7828 6c69 6d69 742c 206d 656d 696e  max(limit, memin
+00003780: 666f 2e70 726f 6365 7373 202b 206d 656d  fo.process + mem
+00003790: 696e 666f 2e73 7069 6c6c 6564 290a 2020  info.spilled).  
+000037a0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+000037b0: 785f 7261 6e67 652e 656e 6420 3d20 785f  x_range.end = x_
+000037c0: 656e 640a 0a20 2020 2020 2020 2074 6974  end..        tit
+000037d0: 6c65 203d 2066 2242 7974 6573 2073 746f  le = f"Bytes sto
+000037e0: 7265 643a 207b 666f 726d 6174 5f62 7974  red: {format_byt
+000037f0: 6573 286d 656d 696e 666f 2e70 726f 6365  es(meminfo.proce
+00003800: 7373 297d 220a 2020 2020 2020 2020 6966  ss)}".        if
+00003810: 206d 656d 696e 666f 2e73 7069 6c6c 6564   meminfo.spilled
+00003820: 3a0a 2020 2020 2020 2020 2020 2020 7469  :.            ti
+00003830: 746c 6520 2b3d 2066 2220 2b20 7b66 6f72  tle += f" + {for
+00003840: 6d61 745f 6279 7465 7328 6d65 6d69 6e66  mat_bytes(meminf
+00003850: 6f2e 7370 696c 6c65 6429 7d20 7370 696c  o.spilled)} spil
+00003860: 6c65 6420 746f 2064 6973 6b22 0a20 2020  led to disk".   
+00003870: 2020 2020 2073 656c 662e 726f 6f74 2e74       self.root.t
+00003880: 6974 6c65 2e74 6578 7420 3d20 7469 746c  itle.text = titl
+00003890: 650a 0a20 2020 2020 2020 2075 7064 6174  e..        updat
+000038a0: 6528 7365 6c66 2e73 6f75 7263 652c 2072  e(self.source, r
+000038b0: 6573 756c 7429 0a0a 0a63 6c61 7373 2057  esult)...class W
+000038c0: 6f72 6b65 7273 4d65 6d6f 7279 2844 6173  orkersMemory(Das
+000038d0: 6862 6f61 7264 436f 6d70 6f6e 656e 742c  hboardComponent,
+000038e0: 204d 656d 6f72 7943 6f6c 6f72 293a 0a20   MemoryColor):. 
+000038f0: 2020 2022 2222 4d65 6d6f 7279 2075 7361     """Memory usa
+00003900: 6765 2066 6f72 2073 696e 676c 6520 776f  ge for single wo
+00003910: 726b 6572 7322 2222 0a0a 2020 2020 406c  rkers"""..    @l
+00003920: 6f67 5f65 7272 6f72 730a 2020 2020 6465  og_errors.    de
+00003930: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+00003940: 2073 6368 6564 756c 6572 2c20 7769 6474   scheduler, widt
+00003950: 683d 3630 302c 202a 2a6b 7761 7267 7329  h=600, **kwargs)
+00003960: 3a0a 2020 2020 2020 2020 4461 7368 626f  :.        Dashbo
+00003970: 6172 6443 6f6d 706f 6e65 6e74 2e5f 5f69  ardComponent.__i
+00003980: 6e69 745f 5f28 7365 6c66 290a 2020 2020  nit__(self).    
+00003990: 2020 2020 4d65 6d6f 7279 436f 6c6f 722e      MemoryColor.
+000039a0: 5f5f 696e 6974 5f5f 2873 656c 6629 0a0a  __init__(self)..
+000039b0: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
+000039c0: 6564 756c 6572 203d 2073 6368 6564 756c  eduler = schedul
+000039d0: 6572 0a20 2020 2020 2020 2073 656c 662e  er.        self.
+000039e0: 736f 7572 6365 203d 2043 6f6c 756d 6e44  source = ColumnD
+000039f0: 6174 6153 6f75 7263 6528 0a20 2020 2020  ataSource(.     
+00003a00: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00003a10: 2020 2020 2020 2020 2022 7769 6474 6822           "width"
+00003a20: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+00003a30: 2020 2020 2020 2278 223a 205b 5d2c 0a20        "x": [],. 
+00003a40: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00003a50: 7922 3a20 5b5d 2c0a 2020 2020 2020 2020  y": [],.        
+00003a60: 2020 2020 2020 2020 2263 6f6c 6f72 223a          "color":
+00003a70: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+00003a80: 2020 2020 2022 616c 7068 6122 3a20 5b5d       "alpha": []
+00003a90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00003aa0: 2020 2277 6f72 6b65 7222 3a20 5b5d 2c0a    "worker": [],.
+00003ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003ac0: 2265 7363 6170 6564 5f77 6f72 6b65 7222  "escaped_worker"
+00003ad0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+00003ae0: 2020 2020 2020 2270 726f 635f 6d65 6d6f        "proc_memo
+00003af0: 7279 223a 205b 5d2c 0a20 2020 2020 2020  ry": [],.       
+00003b00: 2020 2020 2020 2020 2022 6d61 6e61 6765           "manage
+00003b10: 6422 3a20 5b5d 2c0a 2020 2020 2020 2020  d": [],.        
+00003b20: 2020 2020 2020 2020 2275 6e6d 616e 6167          "unmanag
+00003b30: 6564 5f6f 6c64 223a 205b 5d2c 0a20 2020  ed_old": [],.   
+00003b40: 2020 2020 2020 2020 2020 2020 2022 756e               "un
+00003b50: 6d61 6e61 6765 645f 7265 6365 6e74 223a  managed_recent":
+00003b60: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+00003b70: 2020 2020 2022 7370 696c 6c65 6422 3a20       "spilled": 
+00003b80: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+00003b90: 7d0a 2020 2020 2020 2020 290a 0a20 2020  }.        )..   
+00003ba0: 2020 2020 2073 656c 662e 726f 6f74 203d       self.root =
+00003bb0: 2066 6967 7572 6528 0a20 2020 2020 2020   figure(.       
+00003bc0: 2020 2020 2074 6974 6c65 3d22 4279 7465       title="Byte
+00003bd0: 7320 7374 6f72 6564 2070 6572 2077 6f72  s stored per wor
+00003be0: 6b65 7222 2c0a 2020 2020 2020 2020 2020  ker",.          
+00003bf0: 2020 746f 6f6c 733d 2222 2c0a 2020 2020    tools="",.    
+00003c00: 2020 2020 2020 2020 7769 6474 683d 696e          width=in
+00003c10: 7428 7769 6474 6820 2f20 3229 2c0a 2020  t(width / 2),.  
+00003c20: 2020 2020 2020 2020 2020 6e61 6d65 3d22            name="
+00003c30: 776f 726b 6572 735f 6d65 6d6f 7279 222c  workers_memory",
+00003c40: 0a20 2020 2020 2020 2020 2020 206d 696e  .            min
+00003c50: 5f62 6f72 6465 725f 626f 7474 6f6d 3d35  _border_bottom=5
+00003c60: 302c 0a20 2020 2020 2020 2020 2020 202a  0,.            *
+00003c70: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
+00003c80: 2029 0a20 2020 2020 2020 2072 6563 7420   ).        rect 
+00003c90: 3d20 7365 6c66 2e72 6f6f 742e 7265 6374  = self.root.rect
+00003ca0: 280a 2020 2020 2020 2020 2020 2020 736f  (.            so
+00003cb0: 7572 6365 3d73 656c 662e 736f 7572 6365  urce=self.source
+00003cc0: 2c0a 2020 2020 2020 2020 2020 2020 783d  ,.            x=
+00003cd0: 2278 222c 0a20 2020 2020 2020 2020 2020  "x",.           
+00003ce0: 2079 3d22 7922 2c0a 2020 2020 2020 2020   y="y",.        
+00003cf0: 2020 2020 7769 6474 683d 2277 6964 7468      width="width
+00003d00: 222c 0a20 2020 2020 2020 2020 2020 2068  ",.            h
+00003d10: 6569 6768 743d 302e 392c 0a20 2020 2020  eight=0.9,.     
+00003d20: 2020 2020 2020 2063 6f6c 6f72 3d22 636f         color="co
+00003d30: 6c6f 7222 2c0a 2020 2020 2020 2020 2020  lor",.          
+00003d40: 2020 6669 6c6c 5f61 6c70 6861 3d22 616c    fill_alpha="al
+00003d50: 7068 6122 2c0a 2020 2020 2020 2020 2020  pha",.          
+00003d60: 2020 6c69 6e65 5f77 6964 7468 3d30 2c0a    line_width=0,.
+00003d70: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00003d80: 2020 7265 6374 2e6e 6f6e 7365 6c65 6374    rect.nonselect
+00003d90: 696f 6e5f 676c 7970 6820 3d20 4e6f 6e65  ion_glyph = None
+00003da0: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
+00003db0: 6f6f 742e 6178 6973 5b30 5d2e 7469 636b  oot.axis[0].tick
+00003dc0: 6572 203d 2042 6173 6963 5469 636b 6572  er = BasicTicker
+00003dd0: 282a 2a54 4943 4b53 5f31 3032 3429 0a20  (**TICKS_1024). 
+00003de0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+00003df0: 2e78 6178 6973 5b30 5d2e 666f 726d 6174  .xaxis[0].format
+00003e00: 7465 7220 3d20 4e75 6d65 7261 6c54 6963  ter = NumeralTic
+00003e10: 6b46 6f72 6d61 7474 6572 2866 6f72 6d61  kFormatter(forma
+00003e20: 743d 2230 2e30 2062 2229 0a20 2020 2020  t="0.0 b").     
+00003e30: 2020 2073 656c 662e 726f 6f74 2e78 6178     self.root.xax
+00003e40: 6973 2e6d 616a 6f72 5f6c 6162 656c 5f6f  is.major_label_o
+00003e50: 7269 656e 7461 7469 6f6e 203d 2058 4c41  rientation = XLA
+00003e60: 4245 4c5f 4f52 4945 4e54 4154 494f 4e0a  BEL_ORIENTATION.
+00003e70: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+00003e80: 742e 7861 7869 732e 6d69 6e6f 725f 7469  t.xaxis.minor_ti
+00003e90: 636b 5f6c 696e 655f 616c 7068 6120 3d20  ck_line_alpha = 
+00003ea0: 300a 2020 2020 2020 2020 7365 6c66 2e72  0.        self.r
+00003eb0: 6f6f 742e 785f 7261 6e67 6520 3d20 5261  oot.x_range = Ra
+00003ec0: 6e67 6531 6428 7374 6172 743d 3029 0a20  nge1d(start=0). 
+00003ed0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+00003ee0: 2e79 6178 6973 2e76 6973 6962 6c65 203d  .yaxis.visible =
+00003ef0: 2046 616c 7365 0a20 2020 2020 2020 2073   False.        s
+00003f00: 656c 662e 726f 6f74 2e79 6772 6964 2e76  elf.root.ygrid.v
+00003f10: 6973 6962 6c65 203d 2046 616c 7365 0a20  isible = False. 
+00003f20: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+00003f30: 2e74 6f6f 6c62 6172 5f6c 6f63 6174 696f  .toolbar_locatio
+00003f40: 6e20 3d20 4e6f 6e65 0a0a 2020 2020 2020  n = None..      
+00003f50: 2020 7461 7020 3d20 5461 7054 6f6f 6c28    tap = TapTool(
+00003f60: 6361 6c6c 6261 636b 3d4f 7065 6e55 524c  callback=OpenURL
+00003f70: 2875 726c 3d22 2e2f 696e 666f 2f77 6f72  (url="./info/wor
+00003f80: 6b65 722f 4065 7363 6170 6564 5f77 6f72  ker/@escaped_wor
+00003f90: 6b65 722e 6874 6d6c 2229 290a 2020 2020  ker.html")).    
+00003fa0: 2020 2020 7365 6c66 2e72 6f6f 742e 6164      self.root.ad
+00003fb0: 645f 746f 6f6c 7328 7461 7029 0a0a 2020  d_tools(tap)..  
+00003fc0: 2020 2020 2020 686f 7665 7220 3d20 486f        hover = Ho
+00003fd0: 7665 7254 6f6f 6c28 0a20 2020 2020 2020  verTool(.       
+00003fe0: 2020 2020 2070 6f69 6e74 5f70 6f6c 6963       point_polic
+00003ff0: 793d 2266 6f6c 6c6f 775f 6d6f 7573 6522  y="follow_mouse"
+00004000: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
+00004010: 6f6c 7469 7073 3d22 2222 0a20 2020 2020  oltips=""".     
+00004020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004030: 2020 2020 2020 203c 6469 763e 0a20 2020         <div>.   
+00004040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004050: 2020 2020 2020 2020 2020 2020 203c 7370               <sp
+00004060: 616e 2073 7479 6c65 3d22 666f 6e74 2d73  an style="font-s
+00004070: 697a 653a 2031 3270 783b 2066 6f6e 742d  ize: 12px; font-
+00004080: 7765 6967 6874 3a20 626f 6c64 3b22 3e57  weight: bold;">W
+00004090: 6f72 6b65 723a 3c2f 7370 616e 3e26 6e62  orker:</span>&nb
+000040a0: 7370 3b0a 2020 2020 2020 2020 2020 2020  sp;.            
 000040b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000040c0: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
-000040d0: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
-000040e0: 7369 7a65 3a20 3130 7078 3b20 666f 6e74  size: 10px; font
-000040f0: 2d66 616d 696c 793a 204d 6f6e 6163 6f2c  -family: Monaco,
-00004100: 206d 6f6e 6f73 7061 6365 3b22 3e40 776f   monospace;">@wo
-00004110: 726b 6572 3c2f 7370 616e 3e0a 2020 2020  rker</span>.    
-00004120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004130: 2020 2020 2020 2020 3c2f 6469 763e 0a20          </div>. 
+000040c0: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
+000040d0: 2266 6f6e 742d 7369 7a65 3a20 3130 7078  "font-size: 10px
+000040e0: 3b20 666f 6e74 2d66 616d 696c 793a 204d  ; font-family: M
+000040f0: 6f6e 6163 6f2c 206d 6f6e 6f73 7061 6365  onaco, monospace
+00004100: 3b22 3e40 776f 726b 6572 3c2f 7370 616e  ;">@worker</span
+00004110: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+00004120: 2020 2020 2020 2020 2020 2020 2020 3c2f                </
+00004130: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
 00004140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004150: 2020 2020 2020 2020 2020 203c 6469 763e             <div>
-00004160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004180: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
-00004190: 6e74 2d73 697a 653a 2031 3270 783b 2066  nt-size: 12px; f
-000041a0: 6f6e 742d 7765 6967 6874 3a20 626f 6c64  ont-weight: bold
-000041b0: 3b22 3e50 726f 6365 7373 206d 656d 6f72  ;">Process memor
-000041c0: 7920 2852 5353 293a 3c2f 7370 616e 3e26  y (RSS):</span>&
-000041d0: 6e62 7370 3b0a 2020 2020 2020 2020 2020  nbsp;.          
-000041e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000041f0: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
-00004200: 653d 2266 6f6e 742d 7369 7a65 3a20 3130  e="font-size: 10
-00004210: 7078 3b20 666f 6e74 2d66 616d 696c 793a  px; font-family:
-00004220: 204d 6f6e 6163 6f2c 206d 6f6e 6f73 7061   Monaco, monospa
-00004230: 6365 3b22 3e40 7072 6f63 5f6d 656d 6f72  ce;">@proc_memor
-00004240: 797b 302e 3030 2062 7d3c 2f73 7061 6e3e  y{0.00 b}</span>
-00004250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004260: 2020 2020 2020 2020 2020 2020 203c 2f64               </d
-00004270: 6976 3e0a 2020 2020 2020 2020 2020 2020  iv>.            
-00004280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004290: 3c64 6976 2073 7479 6c65 3d22 6d61 7267  <div style="marg
-000042a0: 696e 2d6c 6566 743a 2031 656d 3b22 3e0a  in-left: 1em;">.
+00004150: 203c 6469 763e 0a20 2020 2020 2020 2020   <div>.         
+00004160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004170: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
+00004180: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
+00004190: 3270 783b 2066 6f6e 742d 7765 6967 6874  2px; font-weight
+000041a0: 3a20 626f 6c64 3b22 3e50 726f 6365 7373  : bold;">Process
+000041b0: 206d 656d 6f72 7920 2852 5353 293a 3c2f   memory (RSS):</
+000041c0: 7370 616e 3e26 6e62 7370 3b0a 2020 2020  span>&nbsp;.    
+000041d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000041e0: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
+000041f0: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
+00004200: 7a65 3a20 3130 7078 3b20 666f 6e74 2d66  ze: 10px; font-f
+00004210: 616d 696c 793a 204d 6f6e 6163 6f2c 206d  amily: Monaco, m
+00004220: 6f6e 6f73 7061 6365 3b22 3e40 7072 6f63  onospace;">@proc
+00004230: 5f6d 656d 6f72 797b 302e 3030 2062 7d3c  _memory{0.00 b}<
+00004240: 2f73 7061 6e3e 0a20 2020 2020 2020 2020  /span>.         
+00004250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004260: 2020 203c 2f64 6976 3e0a 2020 2020 2020     </div>.      
+00004270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004280: 2020 2020 2020 3c64 6976 2073 7479 6c65        <div style
+00004290: 3d22 6d61 7267 696e 2d6c 6566 743a 2031  ="margin-left: 1
+000042a0: 656d 3b22 3e0a 2020 2020 2020 2020 2020  em;">.          
 000042b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000042c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000042d0: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
-000042e0: 742d 7369 7a65 3a20 3132 7078 3b20 666f  t-size: 12px; fo
-000042f0: 6e74 2d77 6569 6768 743a 2062 6f6c 643b  nt-weight: bold;
-00004300: 223e 4d61 6e61 6765 643a 3c2f 7370 616e  ">Managed:</span
-00004310: 3e26 6e62 7370 3b0a 2020 2020 2020 2020  >&nbsp;.        
-00004320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004330: 2020 2020 2020 2020 3c73 7061 6e20 7374          <span st
-00004340: 796c 653d 2266 6f6e 742d 7369 7a65 3a20  yle="font-size: 
-00004350: 3130 7078 3b20 666f 6e74 2d66 616d 696c  10px; font-famil
-00004360: 793a 204d 6f6e 6163 6f2c 206d 6f6e 6f73  y: Monaco, monos
-00004370: 7061 6365 3b22 3e40 6d61 6e61 6765 647b  pace;">@managed{
-00004380: 302e 3030 2062 7d3c 2f73 7061 6e3e 0a20  0.00 b}</span>. 
+000042c0: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
+000042d0: 653d 2266 6f6e 742d 7369 7a65 3a20 3132  e="font-size: 12
+000042e0: 7078 3b20 666f 6e74 2d77 6569 6768 743a  px; font-weight:
+000042f0: 2062 6f6c 643b 223e 4d61 6e61 6765 643a   bold;">Managed:
+00004300: 3c2f 7370 616e 3e26 6e62 7370 3b0a 2020  </span>&nbsp;.  
+00004310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004320: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
+00004330: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
+00004340: 7369 7a65 3a20 3130 7078 3b20 666f 6e74  size: 10px; font
+00004350: 2d66 616d 696c 793a 204d 6f6e 6163 6f2c  -family: Monaco,
+00004360: 206d 6f6e 6f73 7061 6365 3b22 3e40 6d61   monospace;">@ma
+00004370: 6e61 6765 647b 302e 3030 2062 7d3c 2f73  naged{0.00 b}</s
+00004380: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
 00004390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000043a0: 2020 2020 2020 2020 2020 203c 2f64 6976             </div
-000043b0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-000043c0: 2020 2020 2020 2020 2020 2020 2020 3c64                <d
-000043d0: 6976 2073 7479 6c65 3d22 6d61 7267 696e  iv style="margin
-000043e0: 2d6c 6566 743a 2031 656d 3b22 3e0a 2020  -left: 1em;">.  
+000043a0: 203c 2f64 6976 3e0a 2020 2020 2020 2020   </div>.        
+000043b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000043c0: 2020 2020 3c64 6976 2073 7479 6c65 3d22      <div style="
+000043d0: 6d61 7267 696e 2d6c 6566 743a 2031 656d  margin-left: 1em
+000043e0: 3b22 3e0a 2020 2020 2020 2020 2020 2020  ;">.            
 000043f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004400: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
-00004410: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
-00004420: 7369 7a65 3a20 3132 7078 3b20 666f 6e74  size: 12px; font
-00004430: 2d77 6569 6768 743a 2062 6f6c 643b 223e  -weight: bold;">
-00004440: 556e 6d61 6e61 6765 6420 286f 6c64 293a  Unmanaged (old):
-00004450: 3c2f 7370 616e 3e26 6e62 7370 3b0a 2020  </span>&nbsp;.  
+00004400: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
+00004410: 2266 6f6e 742d 7369 7a65 3a20 3132 7078  "font-size: 12px
+00004420: 3b20 666f 6e74 2d77 6569 6768 743a 2062  ; font-weight: b
+00004430: 6f6c 643b 223e 556e 6d61 6e61 6765 6420  old;">Unmanaged 
+00004440: 286f 6c64 293a 3c2f 7370 616e 3e26 6e62  (old):</span>&nb
+00004450: 7370 3b0a 2020 2020 2020 2020 2020 2020  sp;.            
 00004460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004470: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
-00004480: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
-00004490: 7369 7a65 3a20 3130 7078 3b20 666f 6e74  size: 10px; font
-000044a0: 2d66 616d 696c 793a 204d 6f6e 6163 6f2c  -family: Monaco,
-000044b0: 206d 6f6e 6f73 7061 6365 3b22 3e40 756e   monospace;">@un
-000044c0: 6d61 6e61 6765 645f 6f6c 647b 302e 3030  managed_old{0.00
-000044d0: 2062 7d3c 2f73 7061 6e3e 0a20 2020 2020   b}</span>.     
-000044e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000044f0: 2020 2020 2020 203c 2f64 6976 3e0a 2020         </div>.  
+00004470: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
+00004480: 2266 6f6e 742d 7369 7a65 3a20 3130 7078  "font-size: 10px
+00004490: 3b20 666f 6e74 2d66 616d 696c 793a 204d  ; font-family: M
+000044a0: 6f6e 6163 6f2c 206d 6f6e 6f73 7061 6365  onaco, monospace
+000044b0: 3b22 3e40 756e 6d61 6e61 6765 645f 6f6c  ;">@unmanaged_ol
+000044c0: 647b 302e 3030 2062 7d3c 2f73 7061 6e3e  d{0.00 b}</span>
+000044d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000044e0: 2020 2020 2020 2020 2020 2020 203c 2f64               </d
+000044f0: 6976 3e0a 2020 2020 2020 2020 2020 2020  iv>.            
 00004500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004510: 2020 2020 2020 2020 2020 3c64 6976 2073            <div s
-00004520: 7479 6c65 3d22 6d61 7267 696e 2d6c 6566  tyle="margin-lef
-00004530: 743a 2031 656d 3b22 3e0a 2020 2020 2020  t: 1em;">.      
+00004510: 3c64 6976 2073 7479 6c65 3d22 6d61 7267  <div style="marg
+00004520: 696e 2d6c 6566 743a 2031 656d 3b22 3e0a  in-left: 1em;">.
+00004530: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004550: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
-00004560: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
-00004570: 3a20 3132 7078 3b20 666f 6e74 2d77 6569  : 12px; font-wei
-00004580: 6768 743a 2062 6f6c 643b 223e 556e 6d61  ght: bold;">Unma
-00004590: 6e61 6765 6420 2872 6563 656e 7429 3a3c  naged (recent):<
-000045a0: 2f73 7061 6e3e 266e 6273 703b 0a20 2020  /span>&nbsp;.   
+00004550: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
+00004560: 742d 7369 7a65 3a20 3132 7078 3b20 666f  t-size: 12px; fo
+00004570: 6e74 2d77 6569 6768 743a 2062 6f6c 643b  nt-weight: bold;
+00004580: 223e 556e 6d61 6e61 6765 6420 2872 6563  ">Unmanaged (rec
+00004590: 656e 7429 3a3c 2f73 7061 6e3e 266e 6273  ent):</span>&nbs
+000045a0: 703b 0a20 2020 2020 2020 2020 2020 2020  p;.             
 000045b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000045c0: 2020 2020 2020 2020 2020 2020 203c 7370               <sp
-000045d0: 616e 2073 7479 6c65 3d22 666f 6e74 2d73  an style="font-s
-000045e0: 697a 653a 2031 3070 783b 2066 6f6e 742d  ize: 10px; font-
-000045f0: 6661 6d69 6c79 3a20 4d6f 6e61 636f 2c20  family: Monaco, 
-00004600: 6d6f 6e6f 7370 6163 653b 223e 4075 6e6d  monospace;">@unm
-00004610: 616e 6167 6564 5f72 6563 656e 747b 302e  anaged_recent{0.
-00004620: 3030 2062 7d3c 2f73 7061 6e3e 0a20 2020  00 b}</span>.   
-00004630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004640: 2020 2020 2020 2020 203c 2f64 6976 3e0a           </div>.
+000045c0: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
+000045d0: 666f 6e74 2d73 697a 653a 2031 3070 783b  font-size: 10px;
+000045e0: 2066 6f6e 742d 6661 6d69 6c79 3a20 4d6f   font-family: Mo
+000045f0: 6e61 636f 2c20 6d6f 6e6f 7370 6163 653b  naco, monospace;
+00004600: 223e 4075 6e6d 616e 6167 6564 5f72 6563  ">@unmanaged_rec
+00004610: 656e 747b 302e 3030 2062 7d3c 2f73 7061  ent{0.00 b}</spa
+00004620: 6e3e 0a20 2020 2020 2020 2020 2020 2020  n>.             
+00004630: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+00004640: 2f64 6976 3e0a 2020 2020 2020 2020 2020  /div>.          
 00004650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004660: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
-00004670: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-00004680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004690: 2020 3c73 7061 6e20 7374 796c 653d 2266    <span style="f
-000046a0: 6f6e 742d 7369 7a65 3a20 3132 7078 3b20  ont-size: 12px; 
-000046b0: 666f 6e74 2d77 6569 6768 743a 2062 6f6c  font-weight: bol
-000046c0: 643b 223e 5370 696c 6c65 6420 746f 2064  d;">Spilled to d
-000046d0: 6973 6b3a 3c2f 7370 616e 3e26 6e62 7370  isk:</span>&nbsp
-000046e0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000046f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004700: 2020 3c73 7061 6e20 7374 796c 653d 2266    <span style="f
-00004710: 6f6e 742d 7369 7a65 3a20 3130 7078 3b20  ont-size: 10px; 
-00004720: 666f 6e74 2d66 616d 696c 793a 204d 6f6e  font-family: Mon
-00004730: 6163 6f2c 206d 6f6e 6f73 7061 6365 3b22  aco, monospace;"
-00004740: 3e40 7370 696c 6c65 647b 302e 3030 2062  >@spilled{0.00 b
-00004750: 7d3c 2f73 7061 6e3e 0a20 2020 2020 2020  }</span>.       
-00004760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004770: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
-00004780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004790: 2020 2020 2020 2020 2222 222c 0a20 2020          """,.   
-000047a0: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
-000047b0: 656c 662e 726f 6f74 2e61 6464 5f74 6f6f  elf.root.add_too
-000047c0: 6c73 2868 6f76 6572 290a 0a20 2020 2040  ls(hover)..    @
-000047d0: 7769 7468 6f75 745f 7072 6f70 6572 7479  without_property
-000047e0: 5f76 616c 6964 6174 696f 6e0a 2020 2020  _validation.    
-000047f0: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
-00004800: 6465 6620 7570 6461 7465 2873 656c 6629  def update(self)
-00004810: 3a0a 2020 2020 2020 2020 6465 6620 7175  :.        def qu
-00004820: 6164 6c69 7374 2869 3a20 4974 6572 6162  adlist(i: Iterab
-00004830: 6c65 5b54 5d29 202d 3e20 6c69 7374 5b54  le[T]) -> list[T
-00004840: 5d3a 0a20 2020 2020 2020 2020 2020 206f  ]:.            o
-00004850: 7574 203d 205b 5d0a 2020 2020 2020 2020  ut = [].        
-00004860: 2020 2020 666f 7220 6969 2069 6e20 693a      for ii in i:
-00004870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004880: 206f 7574 202b 3d20 5b69 692c 2069 692c   out += [ii, ii,
-00004890: 2069 692c 2069 695d 0a20 2020 2020 2020   ii, ii].       
-000048a0: 2020 2020 2072 6574 7572 6e20 6f75 740a       return out.
-000048b0: 0a20 2020 2020 2020 2077 6f72 6b65 7273  .        workers
-000048c0: 203d 2073 656c 662e 7363 6865 6475 6c65   = self.schedule
-000048d0: 722e 776f 726b 6572 732e 7661 6c75 6573  r.workers.values
-000048e0: 2829 0a0a 2020 2020 2020 2020 7769 6474  ()..        widt
-000048f0: 6820 3d20 5b5d 0a20 2020 2020 2020 2078  h = [].        x
-00004900: 203d 205b 5d0a 2020 2020 2020 2020 636f   = [].        co
-00004910: 6c6f 7220 3d20 5b5d 0a20 2020 2020 2020  lor = [].       
-00004920: 206d 6178 5f6c 696d 6974 203d 2030 0a20   max_limit = 0. 
-00004930: 2020 2020 2020 2070 726f 636d 656d 6f72         procmemor
-00004940: 7920 3d20 5b5d 0a20 2020 2020 2020 206d  y = [].        m
-00004950: 616e 6167 6564 203d 205b 5d0a 2020 2020  anaged = [].    
-00004960: 2020 2020 7370 696c 6c65 6420 3d20 5b5d      spilled = []
-00004970: 0a20 2020 2020 2020 2075 6e6d 616e 6167  .        unmanag
-00004980: 6564 5f6f 6c64 203d 205b 5d0a 2020 2020  ed_old = [].    
-00004990: 2020 2020 756e 6d61 6e61 6765 645f 7265      unmanaged_re
-000049a0: 6365 6e74 203d 205b 5d0a 0a20 2020 2020  cent = []..     
-000049b0: 2020 2066 6f72 2077 7320 696e 2077 6f72     for ws in wor
-000049c0: 6b65 7273 3a0a 2020 2020 2020 2020 2020  kers:.          
-000049d0: 2020 6d65 6d69 6e66 6f20 3d20 7773 2e6d    meminfo = ws.m
-000049e0: 656d 6f72 790a 2020 2020 2020 2020 2020  emory.          
-000049f0: 2020 6c69 6d69 7420 3d20 6765 7461 7474    limit = getatt
-00004a00: 7228 7773 2c20 226d 656d 6f72 795f 6c69  r(ws, "memory_li
-00004a10: 6d69 7422 2c20 3029 0a20 2020 2020 2020  mit", 0).       
-00004a20: 2020 2020 206d 6178 5f6c 696d 6974 203d       max_limit =
-00004a30: 206d 6178 286d 6178 5f6c 696d 6974 2c20   max(max_limit, 
-00004a40: 6c69 6d69 742c 206d 656d 696e 666f 2e70  limit, meminfo.p
-00004a50: 726f 6365 7373 202b 206d 656d 696e 666f  rocess + meminfo
-00004a60: 2e73 7069 6c6c 6564 290a 2020 2020 2020  .spilled).      
-00004a70: 2020 2020 2020 636f 6c6f 725f 6920 3d20        color_i = 
-00004a80: 7365 6c66 2e5f 6d65 6d6f 7279 5f63 6f6c  self._memory_col
-00004a90: 6f72 286d 656d 696e 666f 2e70 726f 6365  or(meminfo.proce
-00004aa0: 7373 2c20 6c69 6d69 742c 2077 732e 7374  ss, limit, ws.st
-00004ab0: 6174 7573 290a 0a20 2020 2020 2020 2020  atus)..         
-00004ac0: 2020 2077 6964 7468 202b 3d20 5b0a 2020     width += [.  
-00004ad0: 2020 2020 2020 2020 2020 2020 2020 6d65                me
-00004ae0: 6d69 6e66 6f2e 6d61 6e61 6765 642c 0a20  minfo.managed,. 
-00004af0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00004b00: 656d 696e 666f 2e75 6e6d 616e 6167 6564  eminfo.unmanaged
-00004b10: 5f6f 6c64 2c0a 2020 2020 2020 2020 2020  _old,.          
-00004b20: 2020 2020 2020 6d65 6d69 6e66 6f2e 756e        meminfo.un
-00004b30: 6d61 6e61 6765 645f 7265 6365 6e74 2c0a  managed_recent,.
-00004b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004b50: 6d65 6d69 6e66 6f2e 7370 696c 6c65 642c  meminfo.spilled,
-00004b60: 0a20 2020 2020 2020 2020 2020 205d 0a20  .            ]. 
-00004b70: 2020 2020 2020 2020 2020 2078 202b 3d20             x += 
-00004b80: 5b73 756d 2877 6964 7468 5b2d 343a 695d  [sum(width[-4:i]
-00004b90: 2920 2b20 7769 6474 685b 695d 202f 2032  ) + width[i] / 2
-00004ba0: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-00004bb0: 2d34 2c20 3029 5d0a 2020 2020 2020 2020  -4, 0)].        
-00004bc0: 2020 2020 636f 6c6f 7220 2b3d 205b 636f      color += [co
-00004bd0: 6c6f 725f 692c 2063 6f6c 6f72 5f69 2c20  lor_i, color_i, 
-00004be0: 636f 6c6f 725f 692c 2022 6772 6579 225d  color_i, "grey"]
-00004bf0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00004c00: 6d65 6d6f 7279 2069 6e66 6f0a 2020 2020  memory info.    
-00004c10: 2020 2020 2020 2020 7072 6f63 6d65 6d6f          procmemo
-00004c20: 7279 2e61 7070 656e 6428 6d65 6d69 6e66  ry.append(meminf
-00004c30: 6f2e 7072 6f63 6573 7329 0a20 2020 2020  o.process).     
-00004c40: 2020 2020 2020 206d 616e 6167 6564 2e61         managed.a
-00004c50: 7070 656e 6428 6d65 6d69 6e66 6f2e 6d61  ppend(meminfo.ma
-00004c60: 6e61 6765 6429 0a20 2020 2020 2020 2020  naged).         
-00004c70: 2020 2075 6e6d 616e 6167 6564 5f6f 6c64     unmanaged_old
-00004c80: 2e61 7070 656e 6428 6d65 6d69 6e66 6f2e  .append(meminfo.
-00004c90: 756e 6d61 6e61 6765 645f 6f6c 6429 0a20  unmanaged_old). 
-00004ca0: 2020 2020 2020 2020 2020 2075 6e6d 616e             unman
-00004cb0: 6167 6564 5f72 6563 656e 742e 6170 7065  aged_recent.appe
-00004cc0: 6e64 286d 656d 696e 666f 2e75 6e6d 616e  nd(meminfo.unman
-00004cd0: 6167 6564 5f72 6563 656e 7429 0a20 2020  aged_recent).   
-00004ce0: 2020 2020 2020 2020 2073 7069 6c6c 6564           spilled
-00004cf0: 2e61 7070 656e 6428 6d65 6d69 6e66 6f2e  .append(meminfo.
-00004d00: 7370 696c 6c65 6429 0a0a 2020 2020 2020  spilled)..      
-00004d10: 2020 7265 7375 6c74 203d 207b 0a20 2020    result = {.   
-00004d20: 2020 2020 2020 2020 2022 7769 6474 6822           "width"
-00004d30: 3a20 7769 6474 682c 0a20 2020 2020 2020  : width,.       
-00004d40: 2020 2020 2022 7822 3a20 782c 0a20 2020       "x": x,.   
-00004d50: 2020 2020 2020 2020 2022 636f 6c6f 7222           "color"
-00004d60: 3a20 636f 6c6f 722c 0a20 2020 2020 2020  : color,.       
-00004d70: 2020 2020 2022 616c 7068 6122 3a20 5b31       "alpha": [1
-00004d80: 2c20 302e 372c 2030 2e34 2c20 315d 202a  , 0.7, 0.4, 1] *
-00004d90: 206c 656e 2877 6f72 6b65 7273 292c 0a20   len(workers),. 
-00004da0: 2020 2020 2020 2020 2020 2022 776f 726b             "work
-00004db0: 6572 223a 2071 7561 646c 6973 7428 7773  er": quadlist(ws
-00004dc0: 2e61 6464 7265 7373 2066 6f72 2077 7320  .address for ws 
-00004dd0: 696e 2077 6f72 6b65 7273 292c 0a20 2020  in workers),.   
-00004de0: 2020 2020 2020 2020 2022 6573 6361 7065           "escape
-00004df0: 645f 776f 726b 6572 223a 2071 7561 646c  d_worker": quadl
-00004e00: 6973 7428 6573 6361 7065 2e75 726c 5f65  ist(escape.url_e
-00004e10: 7363 6170 6528 7773 2e61 6464 7265 7373  scape(ws.address
-00004e20: 2920 666f 7220 7773 2069 6e20 776f 726b  ) for ws in work
-00004e30: 6572 7329 2c0a 2020 2020 2020 2020 2020  ers),.          
-00004e40: 2020 2279 223a 2071 7561 646c 6973 7428    "y": quadlist(
-00004e50: 7261 6e67 6528 6c65 6e28 776f 726b 6572  range(len(worker
-00004e60: 7329 2929 2c0a 2020 2020 2020 2020 2020  s))),.          
-00004e70: 2020 2270 726f 635f 6d65 6d6f 7279 223a    "proc_memory":
-00004e80: 2071 7561 646c 6973 7428 7072 6f63 6d65   quadlist(procme
-00004e90: 6d6f 7279 292c 0a20 2020 2020 2020 2020  mory),.         
-00004ea0: 2020 2022 6d61 6e61 6765 6422 3a20 7175     "managed": qu
-00004eb0: 6164 6c69 7374 286d 616e 6167 6564 292c  adlist(managed),
-00004ec0: 0a20 2020 2020 2020 2020 2020 2022 756e  .            "un
-00004ed0: 6d61 6e61 6765 645f 6f6c 6422 3a20 7175  managed_old": qu
-00004ee0: 6164 6c69 7374 2875 6e6d 616e 6167 6564  adlist(unmanaged
-00004ef0: 5f6f 6c64 292c 0a20 2020 2020 2020 2020  _old),.         
-00004f00: 2020 2022 756e 6d61 6e61 6765 645f 7265     "unmanaged_re
-00004f10: 6365 6e74 223a 2071 7561 646c 6973 7428  cent": quadlist(
-00004f20: 756e 6d61 6e61 6765 645f 7265 6365 6e74  unmanaged_recent
-00004f30: 292c 0a20 2020 2020 2020 2020 2020 2022  ),.            "
-00004f40: 7370 696c 6c65 6422 3a20 7175 6164 6c69  spilled": quadli
-00004f50: 7374 2873 7069 6c6c 6564 292c 0a20 2020  st(spilled),.   
-00004f60: 2020 2020 207d 0a20 2020 2020 2020 2023       }.        #
-00004f70: 2052 656d 6f76 6520 7265 6374 616e 676c   Remove rectangl
-00004f80: 6573 2077 6974 6820 7769 6474 683d 300a  es with width=0.
-00004f90: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-00004fa0: 207b 6b3a 205b 7669 2066 6f72 2076 692c   {k: [vi for vi,
-00004fb0: 2077 2069 6e20 7a69 7028 762c 2077 6964   w in zip(v, wid
-00004fc0: 7468 2920 6966 2077 5d20 666f 7220 6b2c  th) if w] for k,
-00004fd0: 2076 2069 6e20 7265 7375 6c74 2e69 7465   v in result.ite
-00004fe0: 6d73 2829 7d0a 0a20 2020 2020 2020 2073  ms()}..        s
-00004ff0: 656c 662e 726f 6f74 2e78 5f72 616e 6765  elf.root.x_range
-00005000: 2e65 6e64 203d 206d 6178 5f6c 696d 6974  .end = max_limit
-00005010: 0a20 2020 2020 2020 2075 7064 6174 6528  .        update(
-00005020: 7365 6c66 2e73 6f75 7263 652c 2072 6573  self.source, res
-00005030: 756c 7429 0a0a 0a63 6c61 7373 2057 6f72  ult)...class Wor
-00005040: 6b65 7273 4d65 6d6f 7279 4869 7374 6f67  kersMemoryHistog
-00005050: 7261 6d28 4461 7368 626f 6172 6443 6f6d  ram(DashboardCom
-00005060: 706f 6e65 6e74 293a 0a20 2020 2022 2222  ponent):.    """
-00005070: 4869 7374 6f67 7261 6d20 6f66 206d 656d  Histogram of mem
-00005080: 6f72 7920 7573 6167 652c 2073 686f 7769  ory usage, showi
-00005090: 6e67 2068 6f77 206d 616e 7920 776f 726b  ng how many work
-000050a0: 6572 7320 7468 6572 6520 6172 6520 696e  ers there are in
-000050b0: 2065 6163 6820 6275 636b 6574 206f 660a   each bucket of.
-000050c0: 2020 2020 7573 6167 652e 2052 6570 6c61      usage. Repla
-000050d0: 6365 7320 7468 6520 7065 722d 776f 726b  ces the per-work
-000050e0: 6572 2067 7261 7068 2077 6865 6e20 7468  er graph when th
-000050f0: 6572 6520 6172 6520 3e3d 2035 3020 776f  ere are >= 50 wo
-00005100: 726b 6572 732e 0a20 2020 2022 2222 0a0a  rkers..    """..
-00005110: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
-00005120: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
-00005130: 2873 656c 662c 2073 6368 6564 756c 6572  (self, scheduler
-00005140: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-00005150: 2020 2020 2073 656c 662e 6c61 7374 203d       self.last =
-00005160: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
-00005170: 7363 6865 6475 6c65 7220 3d20 7363 6865  scheduler = sche
-00005180: 6475 6c65 720a 2020 2020 2020 2020 7365  duler.        se
-00005190: 6c66 2e73 6f75 7263 6520 3d20 436f 6c75  lf.source = Colu
-000051a0: 6d6e 4461 7461 536f 7572 6365 280a 2020  mnDataSource(.  
-000051b0: 2020 2020 2020 2020 2020 7b22 6c65 6674            {"left
-000051c0: 223a 205b 312c 2032 5d2c 2022 7269 6768  ": [1, 2], "righ
-000051d0: 7422 3a20 5b31 302c 2031 305d 2c20 2274  t": [10, 10], "t
-000051e0: 6f70 223a 205b 302c 2030 5d7d 0a20 2020  op": [0, 0]}.   
-000051f0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00005200: 7365 6c66 2e72 6f6f 7420 3d20 6669 6775  self.root = figu
-00005210: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
-00005220: 7469 746c 653d 2242 7974 6573 2073 746f  title="Bytes sto
-00005230: 7265 6420 7065 7220 776f 726b 6572 222c  red per worker",
-00005240: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-00005250: 653d 2277 6f72 6b65 7273 5f6d 656d 6f72  e="workers_memor
-00005260: 7922 2c0a 2020 2020 2020 2020 2020 2020  y",.            
-00005270: 795f 6178 6973 5f6c 6162 656c 3d22 6672  y_axis_label="fr
-00005280: 6571 7565 6e63 7922 2c0a 2020 2020 2020  equency",.      
-00005290: 2020 2020 2020 746f 6f6c 733d 2222 2c0a        tools="",.
-000052a0: 2020 2020 2020 2020 2020 2020 2a2a 6b77              **kw
-000052b0: 6172 6773 2c0a 2020 2020 2020 2020 290a  args,.        ).
-000052c0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-000052d0: 6f74 2e78 6178 6973 5b30 5d2e 666f 726d  ot.xaxis[0].form
-000052e0: 6174 7465 7220 3d20 4e75 6d65 7261 6c54  atter = NumeralT
-000052f0: 6963 6b46 6f72 6d61 7474 6572 2866 6f72  ickFormatter(for
-00005300: 6d61 743d 2230 2e30 2062 2229 0a20 2020  mat="0.0 b").   
-00005310: 2020 2020 2073 656c 662e 726f 6f74 2e78       self.root.x
-00005320: 6178 6973 2e74 6963 6b65 7220 3d20 4164  axis.ticker = Ad
-00005330: 6170 7469 7665 5469 636b 6572 282a 2a54  aptiveTicker(**T
-00005340: 4943 4b53 5f31 3032 3429 0a20 2020 2020  ICKS_1024).     
-00005350: 2020 2073 656c 662e 726f 6f74 2e78 6178     self.root.xax
-00005360: 6973 2e6d 616a 6f72 5f6c 6162 656c 5f6f  is.major_label_o
-00005370: 7269 656e 7461 7469 6f6e 203d 2058 4c41  rientation = XLA
-00005380: 4245 4c5f 4f52 4945 4e54 4154 494f 4e0a  BEL_ORIENTATION.
-00005390: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-000053a0: 6f74 2e78 6178 6973 2e6d 696e 6f72 5f74  ot.xaxis.minor_t
-000053b0: 6963 6b5f 6c69 6e65 5f61 6c70 6861 203d  ick_line_alpha =
-000053c0: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
-000053d0: 726f 6f74 2e79 6772 6964 2e76 6973 6962  root.ygrid.visib
-000053e0: 6c65 203d 2046 616c 7365 0a0a 2020 2020  le = False..    
-000053f0: 2020 2020 7365 6c66 2e72 6f6f 742e 746f      self.root.to
-00005400: 6f6c 6261 725f 6c6f 6361 7469 6f6e 203d  olbar_location =
-00005410: 204e 6f6e 650a 0a20 2020 2020 2020 2073   None..        s
-00005420: 656c 662e 726f 6f74 2e71 7561 6428 0a20  elf.root.quad(. 
-00005430: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
-00005440: 653d 7365 6c66 2e73 6f75 7263 652c 0a20  e=self.source,. 
-00005450: 2020 2020 2020 2020 2020 206c 6566 743d             left=
-00005460: 226c 6566 7422 2c0a 2020 2020 2020 2020  "left",.        
-00005470: 2020 2020 7269 6768 743d 2272 6967 6874      right="right
-00005480: 222c 0a20 2020 2020 2020 2020 2020 2062  ",.            b
-00005490: 6f74 746f 6d3d 302c 0a20 2020 2020 2020  ottom=0,.       
-000054a0: 2020 2020 2074 6f70 3d22 746f 7022 2c0a       top="top",.
-000054b0: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
-000054c0: 723d 2264 6565 7073 6b79 626c 7565 222c  r="deepskyblue",
-000054d0: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
-000054e0: 6c5f 616c 7068 613d 302e 352c 0a20 2020  l_alpha=0.5,.   
-000054f0: 2020 2020 2029 0a0a 2020 2020 4077 6974       )..    @wit
-00005500: 686f 7574 5f70 726f 7065 7274 795f 7661  hout_property_va
-00005510: 6c69 6461 7469 6f6e 0a20 2020 2064 6566  lidation.    def
-00005520: 2075 7064 6174 6528 7365 6c66 293a 0a20   update(self):. 
-00005530: 2020 2020 2020 206e 6279 7465 7320 3d20         nbytes = 
-00005540: 6e70 2e61 7361 7272 6179 280a 2020 2020  np.asarray(.    
-00005550: 2020 2020 2020 2020 5b77 732e 6d65 7472          [ws.metr
-00005560: 6963 735b 226d 656d 6f72 7922 5d20 666f  ics["memory"] fo
-00005570: 7220 7773 2069 6e20 7365 6c66 2e73 6368  r ws in self.sch
-00005580: 6564 756c 6572 2e77 6f72 6b65 7273 2e76  eduler.workers.v
-00005590: 616c 7565 7328 295d 0a20 2020 2020 2020  alues()].       
-000055a0: 2029 0a20 2020 2020 2020 2063 6f75 6e74   ).        count
-000055b0: 732c 2078 203d 206e 702e 6869 7374 6f67  s, x = np.histog
-000055c0: 7261 6d28 6e62 7974 6573 2c20 6269 6e73  ram(nbytes, bins
-000055d0: 3d34 3029 0a20 2020 2020 2020 2064 203d  =40).        d =
-000055e0: 207b 226c 6566 7422 3a20 785b 3a2d 315d   {"left": x[:-1]
-000055f0: 2c20 2272 6967 6874 223a 2078 5b31 3a5d  , "right": x[1:]
-00005600: 2c20 2274 6f70 223a 2063 6f75 6e74 737d  , "top": counts}
-00005610: 0a20 2020 2020 2020 2075 7064 6174 6528  .        update(
-00005620: 7365 6c66 2e73 6f75 7263 652c 2064 290a  self.source, d).
-00005630: 0a0a 636c 6173 7320 576f 726b 6572 7354  ..class WorkersT
-00005640: 7261 6e73 6665 7242 7974 6573 2844 6173  ransferBytes(Das
-00005650: 6862 6f61 7264 436f 6d70 6f6e 656e 7429  hboardComponent)
-00005660: 3a0a 2020 2020 2222 2253 697a 6520 6f66  :.    """Size of
-00005670: 206f 7065 6e20 6461 7461 2074 7261 6e73   open data trans
-00005680: 6665 7273 2066 726f 6d2f 746f 206f 7468  fers from/to oth
-00005690: 6572 2077 6f72 6b65 7273 2070 6572 2077  er workers per w
-000056a0: 6f72 6b65 7222 2222 0a0a 2020 2020 406c  orker"""..    @l
-000056b0: 6f67 5f65 7272 6f72 730a 2020 2020 6465  og_errors.    de
-000056c0: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
-000056d0: 2073 6368 6564 756c 6572 2c20 7769 6474   scheduler, widt
-000056e0: 683d 3630 302c 202a 2a6b 7761 7267 7329  h=600, **kwargs)
-000056f0: 3a0a 2020 2020 2020 2020 7365 6c66 2e73  :.        self.s
-00005700: 6368 6564 756c 6572 203d 2073 6368 6564  cheduler = sched
-00005710: 756c 6572 0a20 2020 2020 2020 2073 656c  uler.        sel
-00005720: 662e 736f 7572 6365 203d 2043 6f6c 756d  f.source = Colum
-00005730: 6e44 6174 6153 6f75 7263 6528 0a20 2020  nDataSource(.   
-00005740: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00005750: 2020 2020 2020 2020 2020 2022 6573 6361             "esca
-00005760: 7065 645f 776f 726b 6572 223a 205b 5d2c  ped_worker": [],
-00005770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005780: 2022 7472 616e 7366 6572 5f69 6e63 6f6d   "transfer_incom
-00005790: 696e 675f 6279 7465 7322 3a20 5b5d 2c0a  ing_bytes": [],.
-000057a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000057b0: 2274 7261 6e73 6665 725f 6f75 7467 6f69  "transfer_outgoi
-000057c0: 6e67 5f62 7974 6573 223a 205b 5d2c 0a20  ng_bytes": [],. 
-000057d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000057e0: 776f 726b 6572 223a 205b 5d2c 0a20 2020  worker": [],.   
-000057f0: 2020 2020 2020 2020 2020 2020 2022 795f               "y_
-00005800: 696e 636f 6d69 6e67 223a 205b 5d2c 0a20  incoming": [],. 
-00005810: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00005820: 795f 6f75 7467 6f69 6e67 223a 205b 5d2c  y_outgoing": [],
-00005830: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-00005840: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00005850: 2020 7365 6c66 2e72 6f6f 7420 3d20 6669    self.root = fi
-00005860: 6775 7265 280a 2020 2020 2020 2020 2020  gure(.          
-00005870: 2020 7469 746c 653d 6622 4279 7465 7320    title=f"Bytes 
-00005880: 7472 616e 7366 6572 7269 6e67 3a20 7b66  transferring: {f
-00005890: 6f72 6d61 745f 6279 7465 7328 3029 7d22  ormat_bytes(0)}"
-000058a0: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
-000058b0: 6f6c 733d 2222 2c0a 2020 2020 2020 2020  ols="",.        
-000058c0: 2020 2020 7769 6474 683d 696e 7428 7769      width=int(wi
-000058d0: 6474 6820 2f20 3229 2c0a 2020 2020 2020  dth / 2),.      
-000058e0: 2020 2020 2020 6e61 6d65 3d22 776f 726b        name="work
-000058f0: 6572 735f 7472 616e 7366 6572 5f62 7974  ers_transfer_byt
-00005900: 6573 222c 0a20 2020 2020 2020 2020 2020  es",.           
-00005910: 206d 696e 5f62 6f72 6465 725f 626f 7474   min_border_bott
-00005920: 6f6d 3d35 302c 0a20 2020 2020 2020 2020  om=50,.         
-00005930: 2020 202a 2a6b 7761 7267 732c 0a20 2020     **kwargs,.   
-00005940: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00005950: 2320 7472 616e 7366 6572 5f69 6e63 6f6d  # transfer_incom
-00005960: 696e 675f 6279 7465 730a 2020 2020 2020  ing_bytes.      
-00005970: 2020 7365 6c66 2e72 6f6f 742e 6862 6172    self.root.hbar
-00005980: 280a 2020 2020 2020 2020 2020 2020 6e61  (.            na
-00005990: 6d65 3d22 7472 616e 7366 6572 5f69 6e63  me="transfer_inc
-000059a0: 6f6d 696e 675f 6279 7465 7322 2c0a 2020  oming_bytes",.  
-000059b0: 2020 2020 2020 2020 2020 793d 2279 5f69            y="y_i
-000059c0: 6e63 6f6d 696e 6722 2c0a 2020 2020 2020  ncoming",.      
-000059d0: 2020 2020 2020 7269 6768 743d 2274 7261        right="tra
-000059e0: 6e73 6665 725f 696e 636f 6d69 6e67 5f62  nsfer_incoming_b
-000059f0: 7974 6573 222c 0a20 2020 2020 2020 2020  ytes",.         
-00005a00: 2020 206c 696e 655f 636f 6c6f 723d 4e6f     line_color=No
-00005a10: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-00005a20: 6c65 6674 3d30 2c0a 2020 2020 2020 2020  left=0,.        
-00005a30: 2020 2020 6865 6967 6874 3d30 2e35 2c0a      height=0.5,.
-00005a40: 2020 2020 2020 2020 2020 2020 6669 6c6c              fill
-00005a50: 5f63 6f6c 6f72 3d22 7265 6422 2c0a 2020  _color="red",.  
-00005a60: 2020 2020 2020 2020 2020 736f 7572 6365            source
-00005a70: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
-00005a80: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00005a90: 2023 2074 7261 6e73 6665 725f 6f75 7467   # transfer_outg
-00005aa0: 6f69 6e67 5f62 7974 6573 0a20 2020 2020  oing_bytes.     
-00005ab0: 2020 2073 656c 662e 726f 6f74 2e68 6261     self.root.hba
-00005ac0: 7228 0a20 2020 2020 2020 2020 2020 206e  r(.            n
-00005ad0: 616d 653d 2274 7261 6e73 6665 725f 6f75  ame="transfer_ou
-00005ae0: 7467 6f69 6e67 5f62 7974 6573 222c 0a20  tgoing_bytes",. 
-00005af0: 2020 2020 2020 2020 2020 2079 3d22 795f             y="y_
-00005b00: 6f75 7467 6f69 6e67 222c 0a20 2020 2020  outgoing",.     
-00005b10: 2020 2020 2020 2072 6967 6874 3d22 7472         right="tr
-00005b20: 616e 7366 6572 5f6f 7574 676f 696e 675f  ansfer_outgoing_
-00005b30: 6279 7465 7322 2c0a 2020 2020 2020 2020  bytes",.        
-00005b40: 2020 2020 6c69 6e65 5f63 6f6c 6f72 3d4e      line_color=N
-00005b50: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-00005b60: 206c 6566 743d 302c 0a20 2020 2020 2020   left=0,.       
-00005b70: 2020 2020 2068 6569 6768 743d 302e 352c       height=0.5,
-00005b80: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
-00005b90: 6c5f 636f 6c6f 723d 2262 6c75 6522 2c0a  l_color="blue",.
-00005ba0: 2020 2020 2020 2020 2020 2020 736f 7572              sour
-00005bb0: 6365 3d73 656c 662e 736f 7572 6365 2c0a  ce=self.source,.
-00005bc0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00005bd0: 2020 2073 656c 662e 726f 6f74 2e61 7869     self.root.axi
-00005be0: 735b 305d 2e74 6963 6b65 7220 3d20 4261  s[0].ticker = Ba
-00005bf0: 7369 6354 6963 6b65 7228 2a2a 5449 434b  sicTicker(**TICK
-00005c00: 535f 3130 3234 290a 2020 2020 2020 2020  S_1024).        
-00005c10: 7365 6c66 2e72 6f6f 742e 7861 7869 735b  self.root.xaxis[
-00005c20: 305d 2e66 6f72 6d61 7474 6572 203d 204e  0].formatter = N
-00005c30: 756d 6572 616c 5469 636b 466f 726d 6174  umeralTickFormat
-00005c40: 7465 7228 666f 726d 6174 3d22 302e 3020  ter(format="0.0 
-00005c50: 6222 290a 2020 2020 2020 2020 7365 6c66  b").        self
-00005c60: 2e72 6f6f 742e 7861 7869 732e 6d61 6a6f  .root.xaxis.majo
-00005c70: 725f 6c61 6265 6c5f 6f72 6965 6e74 6174  r_label_orientat
-00005c80: 696f 6e20 3d20 584c 4142 454c 5f4f 5249  ion = XLABEL_ORI
-00005c90: 454e 5441 5449 4f4e 0a20 2020 2020 2020  ENTATION.       
-00005ca0: 2073 656c 662e 726f 6f74 2e78 6178 6973   self.root.xaxis
-00005cb0: 2e6d 696e 6f72 5f74 6963 6b5f 6c69 6e65  .minor_tick_line
-00005cc0: 5f61 6c70 6861 203d 2030 0a20 2020 2020  _alpha = 0.     
-00005cd0: 2020 2073 656c 662e 726f 6f74 2e78 5f72     self.root.x_r
-00005ce0: 616e 6765 203d 2052 616e 6765 3164 2873  ange = Range1d(s
-00005cf0: 7461 7274 3d30 290a 2020 2020 2020 2020  tart=0).        
-00005d00: 7365 6c66 2e72 6f6f 742e 7961 7869 732e  self.root.yaxis.
-00005d10: 7669 7369 626c 6520 3d20 4661 6c73 650a  visible = False.
-00005d20: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-00005d30: 742e 7967 7269 642e 7669 7369 626c 6520  t.ygrid.visible 
-00005d40: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-00005d50: 7365 6c66 2e72 6f6f 742e 746f 6f6c 6261  self.root.toolba
-00005d60: 725f 6c6f 6361 7469 6f6e 203d 204e 6f6e  r_location = Non
-00005d70: 650a 0a20 2020 2020 2020 2074 6170 203d  e..        tap =
-00005d80: 2054 6170 546f 6f6c 2863 616c 6c62 6163   TapTool(callbac
-00005d90: 6b3d 4f70 656e 5552 4c28 7572 6c3d 222e  k=OpenURL(url=".
-00005da0: 2f69 6e66 6f2f 776f 726b 6572 2f40 6573  /info/worker/@es
-00005db0: 6361 7065 645f 776f 726b 6572 2e68 746d  caped_worker.htm
-00005dc0: 6c22 2929 0a20 2020 2020 2020 2068 6f76  l")).        hov
-00005dd0: 6572 203d 2048 6f76 6572 546f 6f6c 280a  er = HoverTool(.
-00005de0: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
-00005df0: 7469 7073 3d5b 0a20 2020 2020 2020 2020  tips=[.         
-00005e00: 2020 2020 2020 2028 2257 6f72 6b65 7222         ("Worker"
-00005e10: 2c20 2240 776f 726b 6572 2229 2c0a 2020  , "@worker"),.  
-00005e20: 2020 2020 2020 2020 2020 2020 2020 2822                ("
-00005e30: 496e 636f 6d69 6e67 222c 2022 4074 7261  Incoming", "@tra
-00005e40: 6e73 6665 725f 696e 636f 6d69 6e67 5f62  nsfer_incoming_b
-00005e50: 7974 6573 7b30 2e30 3020 627d 2229 2c0a  ytes{0.00 b}"),.
-00005e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005e70: 2822 4f75 7467 6f69 6e67 222c 2022 4074  ("Outgoing", "@t
-00005e80: 7261 6e73 6665 725f 6f75 7467 6f69 6e67  ransfer_outgoing
-00005e90: 5f62 7974 6573 7b30 2e30 3020 627d 2229  _bytes{0.00 b}")
-00005ea0: 2c0a 2020 2020 2020 2020 2020 2020 5d2c  ,.            ],
-00005eb0: 0a20 2020 2020 2020 2020 2020 2070 6f69  .            poi
-00005ec0: 6e74 5f70 6f6c 6963 793d 2266 6f6c 6c6f  nt_policy="follo
-00005ed0: 775f 6d6f 7573 6522 2c0a 2020 2020 2020  w_mouse",.      
-00005ee0: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
-00005ef0: 2e72 6f6f 742e 6164 645f 746f 6f6c 7328  .root.add_tools(
-00005f00: 686f 7665 722c 2074 6170 290a 0a20 2020  hover, tap)..   
-00005f10: 2040 7769 7468 6f75 745f 7072 6f70 6572   @without_proper
-00005f20: 7479 5f76 616c 6964 6174 696f 6e0a 2020  ty_validation.  
-00005f30: 2020 406c 6f67 5f65 7272 6f72 730a 2020    @log_errors.  
-00005f40: 2020 6465 6620 7570 6461 7465 2873 656c    def update(sel
-00005f50: 6629 3a0a 2020 2020 2020 2020 7773 7320  f):.        wss 
-00005f60: 3d20 7365 6c66 2e73 6368 6564 756c 6572  = self.scheduler
-00005f70: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
-00005f80: 290a 0a20 2020 2020 2020 2068 203d 2030  )..        h = 0
-00005f90: 2e31 0a20 2020 2020 2020 2079 5f69 6e63  .1.        y_inc
-00005fa0: 6f6d 696e 6720 3d20 5b69 202b 2030 2e37  oming = [i + 0.7
-00005fb0: 3520 2b20 6920 2a20 6820 666f 7220 6920  5 + i * h for i 
-00005fc0: 696e 2072 616e 6765 286c 656e 2877 7373  in range(len(wss
-00005fd0: 2929 5d0a 2020 2020 2020 2020 795f 6f75  ))].        y_ou
-00005fe0: 7467 6f69 6e67 203d 205b 6920 2b20 302e  tgoing = [i + 0.
-00005ff0: 3235 202b 2069 202a 2068 2066 6f72 2069  25 + i * h for i
-00006000: 2069 6e20 7261 6e67 6528 6c65 6e28 7773   in range(len(ws
-00006010: 7329 295d 0a0a 2020 2020 2020 2020 7472  s))]..        tr
-00006020: 616e 7366 6572 5f69 6e63 6f6d 696e 675f  ansfer_incoming_
-00006030: 6279 7465 7320 3d20 5b0a 2020 2020 2020  bytes = [.      
-00006040: 2020 2020 2020 7773 2e6d 6574 7269 6373        ws.metrics
-00006050: 5b22 7472 616e 7366 6572 225d 5b22 696e  ["transfer"]["in
-00006060: 636f 6d69 6e67 5f62 7974 6573 225d 2066  coming_bytes"] f
-00006070: 6f72 2077 7320 696e 2077 7373 0a20 2020  or ws in wss.   
-00006080: 2020 2020 205d 0a20 2020 2020 2020 2074       ].        t
-00006090: 7261 6e73 6665 725f 6f75 7467 6f69 6e67  ransfer_outgoing
-000060a0: 5f62 7974 6573 203d 205b 0a20 2020 2020  _bytes = [.     
-000060b0: 2020 2020 2020 2077 732e 6d65 7472 6963         ws.metric
-000060c0: 735b 2274 7261 6e73 6665 7222 5d5b 226f  s["transfer"]["o
-000060d0: 7574 676f 696e 675f 6279 7465 7322 5d20  utgoing_bytes"] 
-000060e0: 666f 7220 7773 2069 6e20 7773 730a 2020  for ws in wss.  
-000060f0: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
-00006100: 776f 726b 6572 7320 3d20 5b77 732e 6164  workers = [ws.ad
-00006110: 6472 6573 7320 666f 7220 7773 2069 6e20  dress for ws in 
-00006120: 7773 735d 0a20 2020 2020 2020 2065 7363  wss].        esc
-00006130: 6170 6564 5f77 6f72 6b65 7273 203d 205b  aped_workers = [
-00006140: 6573 6361 7065 2e75 726c 5f65 7363 6170  escape.url_escap
-00006150: 6528 776f 726b 6572 2920 666f 7220 776f  e(worker) for wo
-00006160: 726b 6572 2069 6e20 776f 726b 6572 735d  rker in workers]
-00006170: 0a0a 2020 2020 2020 2020 6966 2077 7373  ..        if wss
-00006180: 3a0a 2020 2020 2020 2020 2020 2020 785f  :.            x_
-00006190: 6c69 6d69 7420 3d20 6d61 7828 0a20 2020  limit = max(.   
-000061a0: 2020 2020 2020 2020 2020 2020 206d 6178               max
-000061b0: 2874 7261 6e73 6665 725f 696e 636f 6d69  (transfer_incomi
-000061c0: 6e67 5f62 7974 6573 292c 0a20 2020 2020  ng_bytes),.     
-000061d0: 2020 2020 2020 2020 2020 206d 6178 2874             max(t
-000061e0: 7261 6e73 6665 725f 6f75 7467 6f69 6e67  ransfer_outgoing
-000061f0: 5f62 7974 6573 292c 0a20 2020 2020 2020  _bytes),.       
-00006200: 2020 2020 2020 2020 206d 6178 2877 732e           max(ws.
-00006210: 6d65 6d6f 7279 5f6c 696d 6974 2066 6f72  memory_limit for
-00006220: 2077 7320 696e 2077 7373 292c 0a20 2020   ws in wss),.   
-00006230: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00006240: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00006250: 2020 2020 2078 5f6c 696d 6974 203d 2030       x_limit = 0
-00006260: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-00006270: 6f74 2e78 5f72 616e 6765 2e65 6e64 203d  ot.x_range.end =
-00006280: 2078 5f6c 696d 6974 0a0a 2020 2020 2020   x_limit..      
-00006290: 2020 7265 7375 6c74 203d 207b 0a20 2020    result = {.   
-000062a0: 2020 2020 2020 2020 2022 6573 6361 7065           "escape
-000062b0: 645f 776f 726b 6572 223a 2065 7363 6170  d_worker": escap
-000062c0: 6564 5f77 6f72 6b65 7273 2c0a 2020 2020  ed_workers,.    
-000062d0: 2020 2020 2020 2020 2274 7261 6e73 6665          "transfe
-000062e0: 725f 696e 636f 6d69 6e67 5f62 7974 6573  r_incoming_bytes
-000062f0: 223a 2074 7261 6e73 6665 725f 696e 636f  ": transfer_inco
-00006300: 6d69 6e67 5f62 7974 6573 2c0a 2020 2020  ming_bytes,.    
-00006310: 2020 2020 2020 2020 2274 7261 6e73 6665          "transfe
-00006320: 725f 6f75 7467 6f69 6e67 5f62 7974 6573  r_outgoing_bytes
-00006330: 223a 2074 7261 6e73 6665 725f 6f75 7467  ": transfer_outg
-00006340: 6f69 6e67 5f62 7974 6573 2c0a 2020 2020  oing_bytes,.    
-00006350: 2020 2020 2020 2020 2277 6f72 6b65 7222          "worker"
-00006360: 3a20 776f 726b 6572 732c 0a20 2020 2020  : workers,.     
-00006370: 2020 2020 2020 2022 795f 696e 636f 6d69         "y_incomi
-00006380: 6e67 223a 2079 5f69 6e63 6f6d 696e 672c  ng": y_incoming,
-00006390: 0a20 2020 2020 2020 2020 2020 2022 795f  .            "y_
-000063a0: 6f75 7467 6f69 6e67 223a 2079 5f6f 7574  outgoing": y_out
-000063b0: 676f 696e 672c 0a20 2020 2020 2020 207d  going,.        }
-000063c0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-000063d0: 6f74 2e74 6974 6c65 2e74 6578 7420 3d20  ot.title.text = 
-000063e0: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
-000063f0: 4279 7465 7320 7472 616e 7366 6572 7269  Bytes transferri
-00006400: 6e67 3a20 7b66 6f72 6d61 745f 6279 7465  ng: {format_byte
-00006410: 7328 7375 6d28 7472 616e 7366 6572 5f69  s(sum(transfer_i
-00006420: 6e63 6f6d 696e 675f 6279 7465 7329 297d  ncoming_bytes))}
-00006430: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
-00006440: 2020 2020 7570 6461 7465 2873 656c 662e      update(self.
-00006450: 736f 7572 6365 2c20 7265 7375 6c74 290a  source, result).
-00006460: 0a0a 636c 6173 7320 4861 7264 7761 7265  ..class Hardware
-00006470: 2844 6173 6862 6f61 7264 436f 6d70 6f6e  (DashboardCompon
-00006480: 656e 7429 3a0a 2020 2020 2222 224f 6363  ent):.    """Occ
-00006490: 7570 616e 6379 2028 696e 2074 696d 6529  upancy (in time)
-000064a0: 2070 6572 2077 6f72 6b65 7222 2222 0a0a   per worker"""..
-000064b0: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
-000064c0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
-000064d0: 2873 656c 662c 2073 6368 6564 756c 6572  (self, scheduler
-000064e0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-000064f0: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
-00006500: 6c65 7220 3d20 7363 6865 6475 6c65 720a  ler = scheduler.
-00006510: 2020 2020 2020 2020 2320 4469 736b 0a20          # Disk. 
-00006520: 2020 2020 2020 2073 656c 662e 6469 736b         self.disk
-00006530: 5f73 6f75 7263 6520 3d20 436f 6c75 6d6e  _source = Column
-00006540: 4461 7461 536f 7572 6365 280a 2020 2020  DataSource(.    
-00006550: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00006560: 2020 2020 2020 2020 2020 2273 697a 6522            "size"
-00006570: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-00006580: 2020 2020 2020 2262 616e 6477 6964 7468        "bandwidth
-00006590: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-000065a0: 2020 207d 0a20 2020 2020 2020 2029 0a0a     }.        )..
-000065b0: 2020 2020 2020 2020 7365 6c66 2e64 6973          self.dis
-000065c0: 6b5f 6669 6775 7265 203d 2066 6967 7572  k_figure = figur
-000065d0: 6528 0a20 2020 2020 2020 2020 2020 2074  e(.            t
-000065e0: 6974 6c65 3d22 4469 736b 2042 616e 6477  itle="Disk Bandw
-000065f0: 6964 7468 202d 2d20 436f 6d70 7574 696e  idth -- Computin
-00006600: 6720 2e2e 2e22 2c0a 2020 2020 2020 2020  g ...",.        
-00006610: 2020 2020 746f 6f6c 733d 2222 2c0a 2020      tools="",.  
-00006620: 2020 2020 2020 2020 2020 746f 6f6c 6261            toolba
-00006630: 725f 6c6f 6361 7469 6f6e 3d22 6162 6f76  r_location="abov
-00006640: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-00006650: 785f 7261 6e67 653d 4661 6374 6f72 5261  x_range=FactorRa
-00006660: 6e67 6528 6661 6374 6f72 733d 5b5d 292c  nge(factors=[]),
-00006670: 0a20 2020 2020 2020 2020 2020 202a 2a6b  .            **k
-00006680: 7761 7267 732c 0a20 2020 2020 2020 2029  wargs,.        )
-00006690: 0a20 2020 2020 2020 2073 656c 662e 6469  .        self.di
-000066a0: 736b 5f66 6967 7572 652e 7662 6172 280a  sk_figure.vbar(.
-000066b0: 2020 2020 2020 2020 2020 2020 783d 2273              x="s
-000066c0: 697a 6522 2c20 746f 703d 2262 616e 6477  ize", top="bandw
-000066d0: 6964 7468 222c 2077 6964 7468 3d30 2e39  idth", width=0.9
-000066e0: 2c20 736f 7572 6365 3d73 656c 662e 6469  , source=self.di
-000066f0: 736b 5f73 6f75 7263 650a 2020 2020 2020  sk_source.      
-00006700: 2020 290a 2020 2020 2020 2020 686f 7665    ).        hove
-00006710: 7220 3d20 486f 7665 7254 6f6f 6c28 0a20  r = HoverTool(. 
-00006720: 2020 2020 2020 2020 2020 206d 6f64 653d             mode=
-00006730: 2276 6c69 6e65 222c 2074 6f6f 6c74 6970  "vline", tooltip
-00006740: 733d 5b28 2242 616e 6477 6964 7468 222c  s=[("Bandwidth",
-00006750: 2022 4062 616e 6477 6964 7468 7b30 2e30   "@bandwidth{0.0
-00006760: 3020 627d 2f73 2229 5d0a 2020 2020 2020  0 b}/s")].      
-00006770: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
-00006780: 2e64 6973 6b5f 6669 6775 7265 2e61 6464  .disk_figure.add
-00006790: 5f74 6f6f 6c73 2868 6f76 6572 290a 2020  _tools(hover).  
-000067a0: 2020 2020 2020 7365 6c66 2e64 6973 6b5f        self.disk_
-000067b0: 6669 6775 7265 2e79 6178 6973 5b30 5d2e  figure.yaxis[0].
-000067c0: 666f 726d 6174 7465 7220 3d20 4e75 6d65  formatter = Nume
-000067d0: 7261 6c54 6963 6b46 6f72 6d61 7474 6572  ralTickFormatter
-000067e0: 2866 6f72 6d61 743d 2230 2e30 2062 2229  (format="0.0 b")
-000067f0: 0a20 2020 2020 2020 2073 656c 662e 6469  .        self.di
-00006800: 736b 5f66 6967 7572 652e 7867 7269 642e  sk_figure.xgrid.
-00006810: 7669 7369 626c 6520 3d20 4661 6c73 650a  visible = False.
-00006820: 0a20 2020 2020 2020 2023 204d 656d 6f72  .        # Memor
-00006830: 790a 2020 2020 2020 2020 7365 6c66 2e6d  y.        self.m
-00006840: 656d 6f72 795f 736f 7572 6365 203d 2043  emory_source = C
-00006850: 6f6c 756d 6e44 6174 6153 6f75 7263 6528  olumnDataSource(
-00006860: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00006870: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00006880: 7369 7a65 223a 205b 5d2c 0a20 2020 2020  size": [],.     
-00006890: 2020 2020 2020 2020 2020 2022 6261 6e64             "band
-000068a0: 7769 6474 6822 3a20 5b5d 2c0a 2020 2020  width": [],.    
-000068b0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-000068c0: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
-000068d0: 662e 6d65 6d6f 7279 5f66 6967 7572 6520  f.memory_figure 
-000068e0: 3d20 6669 6775 7265 280a 2020 2020 2020  = figure(.      
-000068f0: 2020 2020 2020 7469 746c 653d 224d 656d        title="Mem
-00006900: 6f72 7920 4261 6e64 7769 6474 6820 2d2d  ory Bandwidth --
-00006910: 2043 6f6d 7075 7469 6e67 202e 2e2e 222c   Computing ...",
-00006920: 0a20 2020 2020 2020 2020 2020 2074 6f6f  .            too
-00006930: 6c73 3d22 222c 0a20 2020 2020 2020 2020  ls="",.         
-00006940: 2020 2074 6f6f 6c62 6172 5f6c 6f63 6174     toolbar_locat
-00006950: 696f 6e3d 2261 626f 7665 222c 0a20 2020  ion="above",.   
-00006960: 2020 2020 2020 2020 2078 5f72 616e 6765           x_range
-00006970: 3d46 6163 746f 7252 616e 6765 2866 6163  =FactorRange(fac
-00006980: 746f 7273 3d5b 5d29 2c0a 2020 2020 2020  tors=[]),.      
-00006990: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
-000069a0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-000069b0: 2020 2073 656c 662e 6d65 6d6f 7279 5f66     self.memory_f
-000069c0: 6967 7572 652e 7662 6172 280a 2020 2020  igure.vbar(.    
-000069d0: 2020 2020 2020 2020 783d 2273 697a 6522          x="size"
-000069e0: 2c20 746f 703d 2262 616e 6477 6964 7468  , top="bandwidth
-000069f0: 222c 2077 6964 7468 3d30 2e39 2c20 736f  ", width=0.9, so
-00006a00: 7572 6365 3d73 656c 662e 6d65 6d6f 7279  urce=self.memory
-00006a10: 5f73 6f75 7263 650a 2020 2020 2020 2020  _source.        
-00006a20: 290a 2020 2020 2020 2020 686f 7665 7220  ).        hover 
-00006a30: 3d20 486f 7665 7254 6f6f 6c28 0a20 2020  = HoverTool(.   
-00006a40: 2020 2020 2020 2020 206d 6f64 653d 2276           mode="v
-00006a50: 6c69 6e65 222c 2074 6f6f 6c74 6970 733d  line", tooltips=
-00006a60: 5b28 2242 616e 6477 6964 7468 222c 2022  [("Bandwidth", "
-00006a70: 4062 616e 6477 6964 7468 7b30 2e30 3020  @bandwidth{0.00 
-00006a80: 627d 2f73 2229 5d0a 2020 2020 2020 2020  b}/s")].        
-00006a90: 290a 2020 2020 2020 2020 7365 6c66 2e6d  ).        self.m
-00006aa0: 656d 6f72 795f 6669 6775 7265 2e61 6464  emory_figure.add
-00006ab0: 5f74 6f6f 6c73 2868 6f76 6572 290a 2020  _tools(hover).  
-00006ac0: 2020 2020 2020 7365 6c66 2e6d 656d 6f72        self.memor
-00006ad0: 795f 6669 6775 7265 2e79 6178 6973 5b30  y_figure.yaxis[0
-00006ae0: 5d2e 666f 726d 6174 7465 7220 3d20 4e75  ].formatter = Nu
-00006af0: 6d65 7261 6c54 6963 6b46 6f72 6d61 7474  meralTickFormatt
-00006b00: 6572 2866 6f72 6d61 743d 2230 2e30 2062  er(format="0.0 b
-00006b10: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
-00006b20: 6d65 6d6f 7279 5f66 6967 7572 652e 7867  memory_figure.xg
-00006b30: 7269 642e 7669 7369 626c 6520 3d20 4661  rid.visible = Fa
-00006b40: 6c73 650a 0a20 2020 2020 2020 2023 204e  lse..        # N
-00006b50: 6574 776f 726b 0a20 2020 2020 2020 2073  etwork.        s
-00006b60: 656c 662e 6e65 7477 6f72 6b5f 736f 7572  elf.network_sour
-00006b70: 6365 203d 2043 6f6c 756d 6e44 6174 6153  ce = ColumnDataS
-00006b80: 6f75 7263 6528 0a20 2020 2020 2020 2020  ource(.         
-00006b90: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00006ba0: 2020 2020 2022 7369 7a65 223a 205b 5d2c       "size": [],
-00006bb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006bc0: 2022 6261 6e64 7769 6474 6822 3a20 5b5d   "bandwidth": []
-00006bd0: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
-00006be0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00006bf0: 2020 2073 656c 662e 6e65 7477 6f72 6b5f     self.network_
-00006c00: 6669 6775 7265 203d 2066 6967 7572 6528  figure = figure(
-00006c10: 0a20 2020 2020 2020 2020 2020 2074 6974  .            tit
-00006c20: 6c65 3d22 4e65 7477 6f72 6b20 4261 6e64  le="Network Band
-00006c30: 7769 6474 6820 2d2d 2043 6f6d 7075 7469  width -- Computi
-00006c40: 6e67 202e 2e2e 222c 0a20 2020 2020 2020  ng ...",.       
-00006c50: 2020 2020 2074 6f6f 6c73 3d22 222c 0a20       tools="",. 
-00006c60: 2020 2020 2020 2020 2020 2074 6f6f 6c62             toolb
-00006c70: 6172 5f6c 6f63 6174 696f 6e3d 2261 626f  ar_location="abo
-00006c80: 7665 222c 0a20 2020 2020 2020 2020 2020  ve",.           
-00006c90: 2078 5f72 616e 6765 3d46 6163 746f 7252   x_range=FactorR
-00006ca0: 616e 6765 2866 6163 746f 7273 3d5b 5d29  ange(factors=[])
-00006cb0: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
-00006cc0: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
-00006cd0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00006ce0: 6e65 7477 6f72 6b5f 6669 6775 7265 2e76  network_figure.v
-00006cf0: 6261 7228 0a20 2020 2020 2020 2020 2020  bar(.           
-00006d00: 2078 3d22 7369 7a65 222c 2074 6f70 3d22   x="size", top="
-00006d10: 6261 6e64 7769 6474 6822 2c20 7769 6474  bandwidth", widt
-00006d20: 683d 302e 392c 2073 6f75 7263 653d 7365  h=0.9, source=se
-00006d30: 6c66 2e6e 6574 776f 726b 5f73 6f75 7263  lf.network_sourc
-00006d40: 650a 2020 2020 2020 2020 290a 2020 2020  e.        ).    
-00006d50: 2020 2020 686f 7665 7220 3d20 486f 7665      hover = Hove
-00006d60: 7254 6f6f 6c28 0a20 2020 2020 2020 2020  rTool(.         
-00006d70: 2020 206d 6f64 653d 2276 6c69 6e65 222c     mode="vline",
-00006d80: 2074 6f6f 6c74 6970 733d 5b28 2242 616e   tooltips=[("Ban
-00006d90: 6477 6964 7468 222c 2022 4062 616e 6477  dwidth", "@bandw
-00006da0: 6964 7468 7b30 2e30 3020 627d 2f73 2229  idth{0.00 b}/s")
-00006db0: 5d0a 2020 2020 2020 2020 290a 2020 2020  ].        ).    
-00006dc0: 2020 2020 7365 6c66 2e6e 6574 776f 726b      self.network
-00006dd0: 5f66 6967 7572 652e 6164 645f 746f 6f6c  _figure.add_tool
-00006de0: 7328 686f 7665 7229 0a20 2020 2020 2020  s(hover).       
-00006df0: 2073 656c 662e 6e65 7477 6f72 6b5f 6669   self.network_fi
-00006e00: 6775 7265 2e79 6178 6973 5b30 5d2e 666f  gure.yaxis[0].fo
-00006e10: 726d 6174 7465 7220 3d20 4e75 6d65 7261  rmatter = Numera
-00006e20: 6c54 6963 6b46 6f72 6d61 7474 6572 2866  lTickFormatter(f
-00006e30: 6f72 6d61 743d 2230 2e30 2062 2229 0a20  ormat="0.0 b"). 
-00006e40: 2020 2020 2020 2073 656c 662e 6e65 7477         self.netw
-00006e50: 6f72 6b5f 6669 6775 7265 2e78 6772 6964  ork_figure.xgrid
-00006e60: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
-00006e70: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
-00006e80: 6f6f 7420 3d20 726f 7728 0a20 2020 2020  oot = row(.     
-00006e90: 2020 2020 2020 2073 656c 662e 6d65 6d6f         self.memo
-00006ea0: 7279 5f66 6967 7572 652c 0a20 2020 2020  ry_figure,.     
-00006eb0: 2020 2020 2020 2073 656c 662e 6469 736b         self.disk
-00006ec0: 5f66 6967 7572 652c 0a20 2020 2020 2020  _figure,.       
-00006ed0: 2020 2020 2073 656c 662e 6e65 7477 6f72       self.networ
-00006ee0: 6b5f 6669 6775 7265 2c0a 2020 2020 2020  k_figure,.      
-00006ef0: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
-00006f00: 662e 6d65 6d6f 7279 5f64 6174 6120 3d20  f.memory_data = 
-00006f10: 7b0a 2020 2020 2020 2020 2020 2020 2273  {.            "s
-00006f20: 697a 6522 3a20 5b5d 2c0a 2020 2020 2020  ize": [],.      
-00006f30: 2020 2020 2020 2262 616e 6477 6964 7468        "bandwidth
-00006f40: 223a 205b 5d2c 0a20 2020 2020 2020 207d  ": [],.        }
-00006f50: 0a20 2020 2020 2020 2073 656c 662e 6469  .        self.di
-00006f60: 736b 5f64 6174 6120 3d20 7b0a 2020 2020  sk_data = {.    
-00006f70: 2020 2020 2020 2020 2273 697a 6522 3a20          "size": 
-00006f80: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-00006f90: 2262 616e 6477 6964 7468 223a 205b 5d2c  "bandwidth": [],
-00006fa0: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
-00006fb0: 2020 2073 656c 662e 6e65 7477 6f72 6b5f     self.network_
-00006fc0: 6461 7461 203d 207b 0a20 2020 2020 2020  data = {.       
-00006fd0: 2020 2020 2022 7369 7a65 223a 205b 5d2c       "size": [],
-00006fe0: 0a20 2020 2020 2020 2020 2020 2022 6261  .            "ba
-00006ff0: 6e64 7769 6474 6822 3a20 5b5d 2c0a 2020  ndwidth": [],.  
-00007000: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00007010: 2061 7379 6e63 2064 6566 2066 2829 3a0a   async def f():.
-00007020: 2020 2020 2020 2020 2020 2020 7265 7375              resu
-00007030: 6c74 203d 2061 7761 6974 2073 656c 662e  lt = await self.
-00007040: 7363 6865 6475 6c65 722e 6265 6e63 686d  scheduler.benchm
-00007050: 6172 6b5f 6861 7264 7761 7265 2829 0a0a  ark_hardware()..
-00007060: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00007070: 7369 7a65 2069 6e20 736f 7274 6564 2872  size in sorted(r
-00007080: 6573 756c 745b 2264 6973 6b22 5d2c 206b  esult["disk"], k
-00007090: 6579 3d70 6172 7365 5f62 7974 6573 293a  ey=parse_bytes):
-000070a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000070b0: 2062 616e 6477 6964 7468 203d 2072 6573   bandwidth = res
-000070c0: 756c 745b 2264 6973 6b22 5d5b 7369 7a65  ult["disk"][size
-000070d0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000070e0: 2020 7365 6c66 2e64 6973 6b5f 6461 7461    self.disk_data
-000070f0: 5b22 7369 7a65 225d 2e61 7070 656e 6428  ["size"].append(
-00007100: 7369 7a65 290a 2020 2020 2020 2020 2020  size).          
-00007110: 2020 2020 2020 7365 6c66 2e64 6973 6b5f        self.disk_
-00007120: 6461 7461 5b22 6261 6e64 7769 6474 6822  data["bandwidth"
-00007130: 5d2e 6170 7065 6e64 2862 616e 6477 6964  ].append(bandwid
-00007140: 7468 290a 0a20 2020 2020 2020 2020 2020  th)..           
-00007150: 2066 6f72 2073 697a 6520 696e 2073 6f72   for size in sor
-00007160: 7465 6428 7265 7375 6c74 5b22 6d65 6d6f  ted(result["memo
-00007170: 7279 225d 2c20 6b65 793d 7061 7273 655f  ry"], key=parse_
-00007180: 6279 7465 7329 3a0a 2020 2020 2020 2020  bytes):.        
-00007190: 2020 2020 2020 2020 6261 6e64 7769 6474          bandwidt
-000071a0: 6820 3d20 7265 7375 6c74 5b22 6d65 6d6f  h = result["memo
-000071b0: 7279 225d 5b73 697a 655d 0a20 2020 2020  ry"][size].     
-000071c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000071d0: 6d65 6d6f 7279 5f64 6174 615b 2273 697a  memory_data["siz
-000071e0: 6522 5d2e 6170 7065 6e64 2873 697a 6529  e"].append(size)
-000071f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007200: 2073 656c 662e 6d65 6d6f 7279 5f64 6174   self.memory_dat
-00007210: 615b 2262 616e 6477 6964 7468 225d 2e61  a["bandwidth"].a
-00007220: 7070 656e 6428 6261 6e64 7769 6474 6829  ppend(bandwidth)
-00007230: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
-00007240: 7220 7369 7a65 2069 6e20 736f 7274 6564  r size in sorted
-00007250: 2872 6573 756c 745b 226e 6574 776f 726b  (result["network
-00007260: 225d 2c20 6b65 793d 7061 7273 655f 6279  "], key=parse_by
-00007270: 7465 7329 3a0a 2020 2020 2020 2020 2020  tes):.          
-00007280: 2020 2020 2020 6261 6e64 7769 6474 6820        bandwidth 
-00007290: 3d20 7265 7375 6c74 5b22 6e65 7477 6f72  = result["networ
-000072a0: 6b22 5d5b 7369 7a65 5d0a 2020 2020 2020  k"][size].      
-000072b0: 2020 2020 2020 2020 2020 7365 6c66 2e6e            self.n
-000072c0: 6574 776f 726b 5f64 6174 615b 2273 697a  etwork_data["siz
-000072d0: 6522 5d2e 6170 7065 6e64 2873 697a 6529  e"].append(size)
-000072e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000072f0: 2073 656c 662e 6e65 7477 6f72 6b5f 6461   self.network_da
-00007300: 7461 5b22 6261 6e64 7769 6474 6822 5d2e  ta["bandwidth"].
-00007310: 6170 7065 6e64 2862 616e 6477 6964 7468  append(bandwidth
-00007320: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00007330: 7363 6865 6475 6c65 722e 6c6f 6f70 2e61  scheduler.loop.a
-00007340: 6464 5f63 616c 6c62 6163 6b28 6629 0a0a  dd_callback(f)..
-00007350: 2020 2020 6465 6620 7570 6461 7465 2873      def update(s
-00007360: 656c 6629 3a0a 2020 2020 2020 2020 6966  elf):.        if
-00007370: 2028 0a20 2020 2020 2020 2020 2020 206e   (.            n
-00007380: 6f74 2073 656c 662e 6469 736b 5f64 6174  ot self.disk_dat
-00007390: 615b 2273 697a 6522 5d0a 2020 2020 2020  a["size"].      
-000073a0: 2020 2020 2020 6f72 2073 656c 662e 6469        or self.di
-000073b0: 736b 5f66 6967 7572 652e 7469 746c 652e  sk_figure.title.
-000073c0: 7465 7874 203d 3d20 2244 6973 6b20 4261  text == "Disk Ba
-000073d0: 6e64 7769 6474 6822 0a20 2020 2020 2020  ndwidth".       
-000073e0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-000073f0: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
-00007400: 7365 6c66 2e6e 6574 776f 726b 5f66 6967  self.network_fig
-00007410: 7572 652e 785f 7261 6e67 652e 6661 6374  ure.x_range.fact
-00007420: 6f72 7320 3d20 7365 6c66 2e6e 6574 776f  ors = self.netwo
-00007430: 726b 5f64 6174 615b 2273 697a 6522 5d0a  rk_data["size"].
-00007440: 2020 2020 2020 2020 7365 6c66 2e64 6973          self.dis
-00007450: 6b5f 6669 6775 7265 2e78 5f72 616e 6765  k_figure.x_range
-00007460: 2e66 6163 746f 7273 203d 2073 656c 662e  .factors = self.
-00007470: 6469 736b 5f64 6174 615b 2273 697a 6522  disk_data["size"
-00007480: 5d0a 2020 2020 2020 2020 7365 6c66 2e6d  ].        self.m
-00007490: 656d 6f72 795f 6669 6775 7265 2e78 5f72  emory_figure.x_r
-000074a0: 616e 6765 2e66 6163 746f 7273 203d 2073  ange.factors = s
-000074b0: 656c 662e 6d65 6d6f 7279 5f64 6174 615b  elf.memory_data[
-000074c0: 2273 697a 6522 5d0a 2020 2020 2020 2020  "size"].        
-000074d0: 7570 6461 7465 2873 656c 662e 6469 736b  update(self.disk
-000074e0: 5f73 6f75 7263 652c 2073 656c 662e 6469  _source, self.di
-000074f0: 736b 5f64 6174 6129 0a20 2020 2020 2020  sk_data).       
-00007500: 2075 7064 6174 6528 7365 6c66 2e6d 656d   update(self.mem
-00007510: 6f72 795f 736f 7572 6365 2c20 7365 6c66  ory_source, self
-00007520: 2e6d 656d 6f72 795f 6461 7461 290a 2020  .memory_data).  
-00007530: 2020 2020 2020 7570 6461 7465 2873 656c        update(sel
-00007540: 662e 6e65 7477 6f72 6b5f 736f 7572 6365  f.network_source
-00007550: 2c20 7365 6c66 2e6e 6574 776f 726b 5f64  , self.network_d
-00007560: 6174 6129 0a20 2020 2020 2020 2073 656c  ata).        sel
-00007570: 662e 6d65 6d6f 7279 5f66 6967 7572 652e  f.memory_figure.
-00007580: 7469 746c 652e 7465 7874 203d 2022 4d65  title.text = "Me
-00007590: 6d6f 7279 2042 616e 6477 6964 7468 220a  mory Bandwidth".
-000075a0: 2020 2020 2020 2020 7365 6c66 2e64 6973          self.dis
-000075b0: 6b5f 6669 6775 7265 2e74 6974 6c65 2e74  k_figure.title.t
-000075c0: 6578 7420 3d20 2244 6973 6b20 4261 6e64  ext = "Disk Band
-000075d0: 7769 6474 6822 0a20 2020 2020 2020 2073  width".        s
-000075e0: 656c 662e 6e65 7477 6f72 6b5f 6669 6775  elf.network_figu
-000075f0: 7265 2e74 6974 6c65 2e74 6578 7420 3d20  re.title.text = 
-00007600: 224e 6574 776f 726b 2042 616e 6477 6964  "Network Bandwid
-00007610: 7468 220a 0a0a 636c 6173 7320 4261 6e64  th"...class Band
-00007620: 7769 6474 6854 7970 6573 2844 6173 6862  widthTypes(Dashb
-00007630: 6f61 7264 436f 6d70 6f6e 656e 7429 3a0a  oardComponent):.
-00007640: 2020 2020 2222 2242 6172 2063 6861 7274      """Bar chart
-00007650: 2073 686f 7769 6e67 2062 616e 6477 6964   showing bandwid
-00007660: 7468 2070 6572 2074 7970 6522 2222 0a0a  th per type"""..
-00007670: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
-00007680: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
-00007690: 2873 656c 662c 2073 6368 6564 756c 6572  (self, scheduler
-000076a0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-000076b0: 2020 2020 2073 656c 662e 6c61 7374 203d       self.last =
-000076c0: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
-000076d0: 7363 6865 6475 6c65 7220 3d20 7363 6865  scheduler = sche
-000076e0: 6475 6c65 720a 2020 2020 2020 2020 7365  duler.        se
-000076f0: 6c66 2e73 6f75 7263 6520 3d20 436f 6c75  lf.source = Colu
-00007700: 6d6e 4461 7461 536f 7572 6365 280a 2020  mnDataSource(.  
-00007710: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00007720: 2020 2020 2020 2020 2020 2020 2262 616e              "ban
-00007730: 6477 6964 7468 223a 205b 312c 2032 5d2c  dwidth": [1, 2],
-00007740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007750: 2022 6261 6e64 7769 6474 682d 6861 6c66   "bandwidth-half
-00007760: 223a 205b 302e 352c 2031 5d2c 0a20 2020  ": [0.5, 1],.   
-00007770: 2020 2020 2020 2020 2020 2020 2022 7479               "ty
-00007780: 7065 223a 205b 2261 222c 2022 6222 5d2c  pe": ["a", "b"],
-00007790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000077a0: 2022 6261 6e64 7769 6474 685f 7465 7874   "bandwidth_text
-000077b0: 223a 205b 2231 222c 2022 3222 5d2c 0a20  ": ["1", "2"],. 
-000077c0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-000077d0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-000077e0: 7365 6c66 2e72 6f6f 7420 3d20 6669 6775  self.root = figu
-000077f0: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
-00007800: 7469 746c 653d 2242 616e 6477 6964 7468  title="Bandwidth
-00007810: 2062 7920 5479 7065 222c 0a20 2020 2020   by Type",.     
-00007820: 2020 2020 2020 2074 6f6f 6c73 3d22 222c         tools="",
-00007830: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-00007840: 653d 2262 616e 6477 6964 7468 5f74 7970  e="bandwidth_typ
-00007850: 655f 6869 7374 6f67 7261 6d22 2c0a 2020  e_histogram",.  
-00007860: 2020 2020 2020 2020 2020 795f 7261 6e67            y_rang
-00007870: 653d 5b22 6122 2c20 2262 225d 2c0a 2020  e=["a", "b"],.  
-00007880: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
-00007890: 6773 2c0a 2020 2020 2020 2020 290a 2020  gs,.        ).  
-000078a0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-000078b0: 7861 7869 732e 6d61 6a6f 725f 6c61 6265  xaxis.major_labe
-000078c0: 6c5f 6f72 6965 6e74 6174 696f 6e20 3d20  l_orientation = 
-000078d0: 2d30 2e35 0a20 2020 2020 2020 2072 6563  -0.5.        rec
-000078e0: 7420 3d20 7365 6c66 2e72 6f6f 742e 7265  t = self.root.re
-000078f0: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
-00007900: 736f 7572 6365 3d73 656c 662e 736f 7572  source=self.sour
-00007910: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
-00007920: 783d 2262 616e 6477 6964 7468 2d68 616c  x="bandwidth-hal
-00007930: 6622 2c0a 2020 2020 2020 2020 2020 2020  f",.            
-00007940: 793d 2274 7970 6522 2c0a 2020 2020 2020  y="type",.      
-00007950: 2020 2020 2020 7769 6474 683d 2262 616e        width="ban
-00007960: 6477 6964 7468 222c 0a20 2020 2020 2020  dwidth",.       
-00007970: 2020 2020 2068 6569 6768 743d 302e 392c       height=0.9,
-00007980: 0a20 2020 2020 2020 2020 2020 2063 6f6c  .            col
-00007990: 6f72 3d22 626c 7565 222c 0a20 2020 2020  or="blue",.     
-000079a0: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
-000079b0: 662e 726f 6f74 2e78 5f72 616e 6765 2e73  f.root.x_range.s
-000079c0: 7461 7274 203d 2030 0a20 2020 2020 2020  tart = 0.       
-000079d0: 2073 656c 662e 726f 6f74 2e78 6178 6973   self.root.xaxis
-000079e0: 5b30 5d2e 666f 726d 6174 7465 7220 3d20  [0].formatter = 
-000079f0: 4e75 6d65 7261 6c54 6963 6b46 6f72 6d61  NumeralTickForma
-00007a00: 7474 6572 2866 6f72 6d61 743d 2230 2e30  tter(format="0.0
-00007a10: 2062 2229 0a20 2020 2020 2020 2073 656c   b").        sel
-00007a20: 662e 726f 6f74 2e78 6178 6973 2e74 6963  f.root.xaxis.tic
-00007a30: 6b65 7220 3d20 4164 6170 7469 7665 5469  ker = AdaptiveTi
-00007a40: 636b 6572 282a 2a54 4943 4b53 5f31 3032  cker(**TICKS_102
-00007a50: 3429 0a20 2020 2020 2020 2072 6563 742e  4).        rect.
-00007a60: 6e6f 6e73 656c 6563 7469 6f6e 5f67 6c79  nonselection_gly
-00007a70: 7068 203d 204e 6f6e 650a 0a20 2020 2020  ph = None..     
-00007a80: 2020 2073 656c 662e 726f 6f74 2e78 6178     self.root.xax
-00007a90: 6973 2e6d 696e 6f72 5f74 6963 6b5f 6c69  is.minor_tick_li
-00007aa0: 6e65 5f61 6c70 6861 203d 2030 0a20 2020  ne_alpha = 0.   
-00007ab0: 2020 2020 2073 656c 662e 726f 6f74 2e79       self.root.y
-00007ac0: 6772 6964 2e76 6973 6962 6c65 203d 2046  grid.visible = F
-00007ad0: 616c 7365 0a0a 2020 2020 2020 2020 7365  alse..        se
-00007ae0: 6c66 2e72 6f6f 742e 746f 6f6c 6261 725f  lf.root.toolbar_
-00007af0: 6c6f 6361 7469 6f6e 203d 204e 6f6e 650a  location = None.
-00007b00: 0a20 2020 2020 2020 2068 6f76 6572 203d  .        hover =
-00007b10: 2048 6f76 6572 546f 6f6c 2829 0a20 2020   HoverTool().   
-00007b20: 2020 2020 2068 6f76 6572 2e74 6f6f 6c74       hover.toolt
-00007b30: 6970 7320 3d20 2240 7479 7065 3a20 4062  ips = "@type: @b
-00007b40: 616e 6477 6964 7468 5f74 6578 7420 2f20  andwidth_text / 
-00007b50: 7322 0a20 2020 2020 2020 2068 6f76 6572  s".        hover
-00007b60: 2e70 6f69 6e74 5f70 6f6c 6963 7920 3d20  .point_policy = 
-00007b70: 2266 6f6c 6c6f 775f 6d6f 7573 6522 0a20  "follow_mouse". 
-00007b80: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-00007b90: 2e61 6464 5f74 6f6f 6c73 2868 6f76 6572  .add_tools(hover
-00007ba0: 290a 0a20 2020 2040 7769 7468 6f75 745f  )..    @without_
-00007bb0: 7072 6f70 6572 7479 5f76 616c 6964 6174  property_validat
-00007bc0: 696f 6e0a 2020 2020 406c 6f67 5f65 7272  ion.    @log_err
-00007bd0: 6f72 730a 2020 2020 6465 6620 7570 6461  ors.    def upda
-00007be0: 7465 2873 656c 6629 3a0a 2020 2020 2020  te(self):.      
-00007bf0: 2020 6277 203d 2073 656c 662e 7363 6865    bw = self.sche
-00007c00: 6475 6c65 722e 6261 6e64 7769 6474 685f  duler.bandwidth_
-00007c10: 7479 7065 730a 2020 2020 2020 2020 7365  types.        se
-00007c20: 6c66 2e72 6f6f 742e 795f 7261 6e67 652e  lf.root.y_range.
-00007c30: 6661 6374 6f72 7320 3d20 6c69 7374 2873  factors = list(s
-00007c40: 6f72 7465 6428 6277 2929 0a20 2020 2020  orted(bw)).     
-00007c50: 2020 2072 6573 756c 7420 3d20 7b0a 2020     result = {.  
-00007c60: 2020 2020 2020 2020 2020 2262 616e 6477            "bandw
-00007c70: 6964 7468 223a 206c 6973 7428 6277 2e76  idth": list(bw.v
-00007c80: 616c 7565 7328 2929 2c0a 2020 2020 2020  alues()),.      
-00007c90: 2020 2020 2020 2262 616e 6477 6964 7468        "bandwidth
-00007ca0: 2d68 616c 6622 3a20 5b62 202f 2032 2066  -half": [b / 2 f
-00007cb0: 6f72 2062 2069 6e20 6277 2e76 616c 7565  or b in bw.value
-00007cc0: 7328 295d 2c0a 2020 2020 2020 2020 2020  s()],.          
-00007cd0: 2020 2274 7970 6522 3a20 6c69 7374 2862    "type": list(b
-00007ce0: 772e 6b65 7973 2829 292c 0a20 2020 2020  w.keys()),.     
-00007cf0: 2020 2020 2020 2022 6261 6e64 7769 6474         "bandwidt
-00007d00: 685f 7465 7874 223a 205b 666f 726d 6174  h_text": [format
-00007d10: 5f62 7974 6573 2878 2920 666f 7220 7820  _bytes(x) for x 
-00007d20: 696e 2062 772e 7661 6c75 6573 2829 5d2c  in bw.values()],
-00007d30: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
-00007d40: 2020 2073 656c 662e 726f 6f74 2e74 6974     self.root.tit
-00007d50: 6c65 2e74 6578 7420 3d20 2242 616e 6477  le.text = "Bandw
-00007d60: 6964 7468 3a20 2220 2b20 666f 726d 6174  idth: " + format
-00007d70: 5f62 7974 6573 2873 656c 662e 7363 6865  _bytes(self.sche
-00007d80: 6475 6c65 722e 6261 6e64 7769 6474 6829  duler.bandwidth)
-00007d90: 0a20 2020 2020 2020 2075 7064 6174 6528  .        update(
-00007da0: 7365 6c66 2e73 6f75 7263 652c 2072 6573  self.source, res
-00007db0: 756c 7429 0a0a 0a63 6c61 7373 2042 616e  ult)...class Ban
-00007dc0: 6477 6964 7468 576f 726b 6572 7328 4461  dwidthWorkers(Da
-00007dd0: 7368 626f 6172 6443 6f6d 706f 6e65 6e74  shboardComponent
-00007de0: 293a 0a20 2020 2022 2222 486f 7720 6d61  ):.    """How ma
-00007df0: 6e79 2074 6173 6b73 2061 7265 206f 6e20  ny tasks are on 
-00007e00: 6561 6368 2077 6f72 6b65 7222 2222 0a0a  each worker"""..
-00007e10: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
-00007e20: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
-00007e30: 2873 656c 662c 2073 6368 6564 756c 6572  (self, scheduler
-00007e40: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-00007e50: 2020 2020 2073 656c 662e 6c61 7374 203d       self.last =
-00007e60: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
-00007e70: 7363 6865 6475 6c65 7220 3d20 7363 6865  scheduler = sche
-00007e80: 6475 6c65 720a 2020 2020 2020 2020 7365  duler.        se
-00007e90: 6c66 2e73 6f75 7263 6520 3d20 436f 6c75  lf.source = Colu
-00007ea0: 6d6e 4461 7461 536f 7572 6365 280a 2020  mnDataSource(.  
-00007eb0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00007ec0: 2020 2020 2020 2020 2020 2020 2262 616e              "ban
-00007ed0: 6477 6964 7468 223a 205b 312c 2032 5d2c  dwidth": [1, 2],
-00007ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007ef0: 2022 736f 7572 6365 223a 205b 2261 222c   "source": ["a",
-00007f00: 2022 6222 5d2c 0a20 2020 2020 2020 2020   "b"],.         
-00007f10: 2020 2020 2020 2022 6465 7374 696e 6174         "destinat
-00007f20: 696f 6e22 3a20 5b22 6122 2c20 2262 225d  ion": ["a", "b"]
-00007f30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00007f40: 2020 2262 616e 6477 6964 7468 5f74 6578    "bandwidth_tex
-00007f50: 7422 3a20 5b22 3122 2c20 2232 225d 2c0a  t": ["1", "2"],.
-00007f60: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00007f70: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00007f80: 2076 616c 7565 7320 3d20 5b68 6578 2878   values = [hex(x
-00007f90: 295b 323a 5d20 666f 7220 7820 696e 2072  )[2:] for x in r
-00007fa0: 616e 6765 2836 342c 2032 3536 295d 5b3a  ange(64, 256)][:
-00007fb0: 3a2d 315d 0a20 2020 2020 2020 206d 6170  :-1].        map
-00007fc0: 7065 7220 3d20 6c69 6e65 6172 5f63 6d61  per = linear_cma
-00007fd0: 7028 0a20 2020 2020 2020 2020 2020 2066  p(.            f
-00007fe0: 6965 6c64 5f6e 616d 653d 2262 616e 6477  ield_name="bandw
-00007ff0: 6964 7468 222c 0a20 2020 2020 2020 2020  idth",.         
-00008000: 2020 2070 616c 6574 7465 3d5b 2223 2220     palette=["#" 
-00008010: 2b20 7820 2b20 7820 2b20 2246 4622 2066  + x + x + "FF" f
-00008020: 6f72 2078 2069 6e20 7661 6c75 6573 5d2c  or x in values],
-00008030: 0a20 2020 2020 2020 2020 2020 206c 6f77  .            low
-00008040: 3d30 2c0a 2020 2020 2020 2020 2020 2020  =0,.            
-00008050: 6869 6768 3d31 2c0a 2020 2020 2020 2020  high=1,.        
-00008060: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00008070: 726f 6f74 203d 2066 6967 7572 6528 0a20  root = figure(. 
-00008080: 2020 2020 2020 2020 2020 2074 6974 6c65             title
-00008090: 3d22 4261 6e64 7769 6474 6820 6279 2057  ="Bandwidth by W
-000080a0: 6f72 6b65 7222 2c0a 2020 2020 2020 2020  orker",.        
-000080b0: 2020 2020 746f 6f6c 733d 2222 2c0a 2020      tools="",.  
-000080c0: 2020 2020 2020 2020 2020 6e61 6d65 3d22            name="
-000080d0: 6261 6e64 7769 6474 685f 776f 726b 6572  bandwidth_worker
-000080e0: 5f68 6561 746d 6170 222c 0a20 2020 2020  _heatmap",.     
-000080f0: 2020 2020 2020 2078 5f72 616e 6765 3d5b         x_range=[
-00008100: 2261 222c 2022 6222 5d2c 0a20 2020 2020  "a", "b"],.     
-00008110: 2020 2020 2020 2079 5f72 616e 6765 3d5b         y_range=[
-00008120: 2261 222c 2022 6222 5d2c 0a20 2020 2020  "a", "b"],.     
-00008130: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
-00008140: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00008150: 2020 2073 656c 662e 726f 6f74 2e78 6178     self.root.xax
-00008160: 6973 2e6d 616a 6f72 5f6c 6162 656c 5f6f  is.major_label_o
-00008170: 7269 656e 7461 7469 6f6e 203d 2058 4c41  rientation = XLA
-00008180: 4245 4c5f 4f52 4945 4e54 4154 494f 4e0a  BEL_ORIENTATION.
-00008190: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-000081a0: 742e 7265 6374 280a 2020 2020 2020 2020  t.rect(.        
-000081b0: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
-000081c0: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
-000081d0: 2020 2020 783d 2273 6f75 7263 6522 2c0a      x="source",.
-000081e0: 2020 2020 2020 2020 2020 2020 793d 2264              y="d
-000081f0: 6573 7469 6e61 7469 6f6e 222c 0a20 2020  estination",.   
-00008200: 2020 2020 2020 2020 2063 6f6c 6f72 3d6d           color=m
-00008210: 6170 7065 722c 0a20 2020 2020 2020 2020  apper,.         
-00008220: 2020 2068 6569 6768 743d 312c 0a20 2020     height=1,.   
-00008230: 2020 2020 2020 2020 2077 6964 7468 3d31           width=1
-00008240: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-00008250: 2020 2020 2073 656c 662e 636f 6c6f 725f       self.color_
-00008260: 6d61 7020 3d20 6d61 7070 6572 5b22 7472  map = mapper["tr
-00008270: 616e 7366 6f72 6d22 5d0a 2020 2020 2020  ansform"].      
-00008280: 2020 636f 6c6f 725f 6261 7220 3d20 436f    color_bar = Co
-00008290: 6c6f 7242 6172 280a 2020 2020 2020 2020  lorBar(.        
-000082a0: 2020 2020 636f 6c6f 725f 6d61 7070 6572      color_mapper
-000082b0: 3d73 656c 662e 636f 6c6f 725f 6d61 702c  =self.color_map,
-000082c0: 0a20 2020 2020 2020 2020 2020 206c 6162  .            lab
-000082d0: 656c 5f73 7461 6e64 6f66 663d 3132 2c0a  el_standoff=12,.
-000082e0: 2020 2020 2020 2020 2020 2020 626f 7264              bord
-000082f0: 6572 5f6c 696e 655f 636f 6c6f 723d 4e6f  er_line_color=No
-00008300: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-00008310: 6c6f 6361 7469 6f6e 3d28 302c 2030 292c  location=(0, 0),
-00008320: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00008330: 2020 2063 6f6c 6f72 5f62 6172 2e66 6f72     color_bar.for
-00008340: 6d61 7474 6572 203d 204e 756d 6572 616c  matter = Numeral
-00008350: 5469 636b 466f 726d 6174 7465 7228 666f  TickFormatter(fo
-00008360: 726d 6174 3d22 302e 3020 6222 290a 2020  rmat="0.0 b").  
-00008370: 2020 2020 2020 636f 6c6f 725f 6261 722e        color_bar.
-00008380: 7469 636b 6572 203d 2041 6461 7074 6976  ticker = Adaptiv
-00008390: 6554 6963 6b65 7228 2a2a 5449 434b 535f  eTicker(**TICKS_
-000083a0: 3130 3234 290a 2020 2020 2020 2020 7365  1024).        se
-000083b0: 6c66 2e72 6f6f 742e 6164 645f 6c61 796f  lf.root.add_layo
-000083c0: 7574 2863 6f6c 6f72 5f62 6172 2c20 2272  ut(color_bar, "r
-000083d0: 6967 6874 2229 0a0a 2020 2020 2020 2020  ight")..        
-000083e0: 7365 6c66 2e72 6f6f 742e 746f 6f6c 6261  self.root.toolba
-000083f0: 725f 6c6f 6361 7469 6f6e 203d 204e 6f6e  r_location = Non
-00008400: 650a 0a20 2020 2020 2020 2068 6f76 6572  e..        hover
-00008410: 203d 2048 6f76 6572 546f 6f6c 2829 0a20   = HoverTool(). 
-00008420: 2020 2020 2020 2068 6f76 6572 2e74 6f6f         hover.too
-00008430: 6c74 6970 7320 3d20 2222 220a 2020 2020  ltips = """.    
-00008440: 2020 2020 2020 2020 3c64 6976 3e0a 2020          <div>.  
-00008450: 2020 2020 2020 2020 2020 2020 2020 3c70                <p
-00008460: 3e3c 623e 536f 7572 6365 3a3c 2f62 3e20  ><b>Source:</b> 
-00008470: 4073 6f75 7263 6520 3c2f 703e 0a20 2020  @source </p>.   
-00008480: 2020 2020 2020 2020 2020 2020 203c 703e               <p>
-00008490: 3c62 3e44 6573 7469 6e61 7469 6f6e 3a3c  <b>Destination:<
-000084a0: 2f62 3e20 4064 6573 7469 6e61 7469 6f6e  /b> @destination
-000084b0: 203c 2f70 3e0a 2020 2020 2020 2020 2020   </p>.          
-000084c0: 2020 2020 2020 3c70 3e3c 623e 4261 6e64        <p><b>Band
-000084d0: 7769 6474 683a 3c2f 623e 2040 6261 6e64  width:</b> @band
-000084e0: 7769 6474 685f 7465 7874 202f 2073 3c2f  width_text / s</
-000084f0: 703e 0a20 2020 2020 2020 2020 2020 203c  p>.            <
-00008500: 2f64 6976 3e0a 2020 2020 2020 2020 2020  /div>.          
-00008510: 2020 2222 220a 2020 2020 2020 2020 686f    """.        ho
-00008520: 7665 722e 706f 696e 745f 706f 6c69 6379  ver.point_policy
-00008530: 203d 2022 666f 6c6c 6f77 5f6d 6f75 7365   = "follow_mouse
-00008540: 220a 2020 2020 2020 2020 7365 6c66 2e72  ".        self.r
-00008550: 6f6f 742e 6164 645f 746f 6f6c 7328 686f  oot.add_tools(ho
-00008560: 7665 7229 0a0a 2020 2020 4077 6974 686f  ver)..    @witho
-00008570: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
-00008580: 6461 7469 6f6e 0a20 2020 2040 6c6f 675f  dation.    @log_
-00008590: 6572 726f 7273 0a20 2020 2064 6566 2075  errors.    def u
-000085a0: 7064 6174 6528 7365 6c66 293a 0a20 2020  pdate(self):.   
-000085b0: 2020 2020 2062 7720 3d20 7365 6c66 2e73       bw = self.s
-000085c0: 6368 6564 756c 6572 2e62 616e 6477 6964  cheduler.bandwid
-000085d0: 7468 5f77 6f72 6b65 7273 0a20 2020 2020  th_workers.     
-000085e0: 2020 2069 6620 6e6f 7420 6277 3a0a 2020     if not bw:.  
-000085f0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00008600: 0a0a 2020 2020 2020 2020 6465 6620 6e61  ..        def na
-00008610: 6d65 2861 6464 7265 7373 293a 0a20 2020  me(address):.   
-00008620: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00008630: 2020 2020 2020 2020 2020 2020 2020 7773                ws
-00008640: 203d 2073 656c 662e 7363 6865 6475 6c65   = self.schedule
-00008650: 722e 776f 726b 6572 735b 6164 6472 6573  r.workers[addres
-00008660: 735d 0a20 2020 2020 2020 2020 2020 2065  s].            e
-00008670: 7863 6570 7420 4b65 7945 7272 6f72 3a0a  xcept KeyError:.
-00008680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008690: 7265 7475 726e 2061 6464 7265 7373 0a20  return address. 
-000086a0: 2020 2020 2020 2020 2020 2069 6620 7773             if ws
-000086b0: 2e6e 616d 6520 6973 206e 6f74 204e 6f6e  .name is not Non
-000086c0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000086d0: 2020 2072 6574 7572 6e20 7374 7228 7773     return str(ws
-000086e0: 2e6e 616d 6529 0a20 2020 2020 2020 2020  .name).         
-000086f0: 2020 2072 6574 7572 6e20 6164 6472 6573     return addres
-00008700: 730a 0a20 2020 2020 2020 2078 2c20 792c  s..        x, y,
-00008710: 2076 616c 7565 203d 207a 6970 282a 2828   value = zip(*((
-00008720: 6e61 6d65 2861 292c 206e 616d 6528 6229  name(a), name(b)
-00008730: 2c20 6329 2066 6f72 2028 612c 2062 292c  , c) for (a, b),
-00008740: 2063 2069 6e20 6277 2e69 7465 6d73 2829   c in bw.items()
-00008750: 2929 0a0a 2020 2020 2020 2020 7365 6c66  ))..        self
-00008760: 2e63 6f6c 6f72 5f6d 6170 2e68 6967 6820  .color_map.high 
-00008770: 3d20 6d61 7828 7661 6c75 6529 0a0a 2020  = max(value)..  
-00008780: 2020 2020 2020 6661 6374 6f72 7320 3d20        factors = 
-00008790: 6c69 7374 2873 6f72 7465 6428 7365 7428  list(sorted(set(
-000087a0: 7820 2b20 7929 2929 0a20 2020 2020 2020  x + y))).       
-000087b0: 2073 656c 662e 726f 6f74 2e78 5f72 616e   self.root.x_ran
-000087c0: 6765 2e66 6163 746f 7273 203d 2066 6163  ge.factors = fac
-000087d0: 746f 7273 0a20 2020 2020 2020 2073 656c  tors.        sel
-000087e0: 662e 726f 6f74 2e79 5f72 616e 6765 2e66  f.root.y_range.f
-000087f0: 6163 746f 7273 203d 2066 6163 746f 7273  actors = factors
-00008800: 5b3a 3a2d 315d 0a0a 2020 2020 2020 2020  [::-1]..        
-00008810: 7265 7375 6c74 203d 207b 0a20 2020 2020  result = {.     
-00008820: 2020 2020 2020 2022 736f 7572 6365 223a         "source":
-00008830: 2078 2c0a 2020 2020 2020 2020 2020 2020   x,.            
-00008840: 2264 6573 7469 6e61 7469 6f6e 223a 2079  "destination": y
-00008850: 2c0a 2020 2020 2020 2020 2020 2020 2262  ,.            "b
-00008860: 616e 6477 6964 7468 223a 2076 616c 7565  andwidth": value
-00008870: 2c0a 2020 2020 2020 2020 2020 2020 2262  ,.            "b
-00008880: 616e 6477 6964 7468 5f74 6578 7422 3a20  andwidth_text": 
-00008890: 6c69 7374 286d 6170 2866 6f72 6d61 745f  list(map(format_
-000088a0: 6279 7465 732c 2076 616c 7565 2929 2c0a  bytes, value)),.
-000088b0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-000088c0: 2020 7365 6c66 2e72 6f6f 742e 7469 746c    self.root.titl
-000088d0: 652e 7465 7874 203d 2022 4261 6e64 7769  e.text = "Bandwi
-000088e0: 6474 683a 2022 202b 2066 6f72 6d61 745f  dth: " + format_
-000088f0: 6279 7465 7328 7365 6c66 2e73 6368 6564  bytes(self.sched
-00008900: 756c 6572 2e62 616e 6477 6964 7468 290a  uler.bandwidth).
-00008910: 2020 2020 2020 2020 7570 6461 7465 2873          update(s
-00008920: 656c 662e 736f 7572 6365 2c20 7265 7375  elf.source, resu
-00008930: 6c74 290a 0a0a 636c 6173 7320 576f 726b  lt)...class Work
-00008940: 6572 4e65 7477 6f72 6b42 616e 6477 6964  erNetworkBandwid
-00008950: 7468 2844 6173 6862 6f61 7264 436f 6d70  th(DashboardComp
-00008960: 6f6e 656e 7429 3a0a 2020 2020 2222 2257  onent):.    """W
-00008970: 6f72 6b65 7220 6e65 7477 6f72 6b20 6261  orker network ba
-00008980: 6e64 7769 6474 6820 6368 6172 740a 0a20  ndwidth chart.. 
-00008990: 2020 2050 6c6f 7473 2068 6f72 697a 6f6e     Plots horizon
-000089a0: 7461 6c20 6261 7273 2077 6974 6820 7468  tal bars with th
-000089b0: 6520 686f 7374 5f6e 6574 5f69 6f2e 7265  e host_net_io.re
-000089c0: 6164 5f62 7073 2061 6e64 2068 6f73 745f  ad_bps and host_
-000089d0: 6e65 745f 696f 2e77 7269 7465 5f62 7073  net_io.write_bps
-000089e0: 2077 6f72 6b65 720a 2020 2020 7374 6174   worker.    stat
-000089f0: 650a 2020 2020 2222 220a 0a20 2020 2040  e.    """..    @
-00008a00: 6c6f 675f 6572 726f 7273 0a20 2020 2064  log_errors.    d
-00008a10: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-00008a20: 2c20 7363 6865 6475 6c65 722c 202a 2a6b  , scheduler, **k
-00008a30: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
-00008a40: 7365 6c66 2e73 6368 6564 756c 6572 203d  self.scheduler =
-00008a50: 2073 6368 6564 756c 6572 0a20 2020 2020   scheduler.     
-00008a60: 2020 2073 656c 662e 736f 7572 6365 203d     self.source =
-00008a70: 2043 6f6c 756d 6e44 6174 6153 6f75 7263   ColumnDataSourc
-00008a80: 6528 0a20 2020 2020 2020 2020 2020 207b  e(.            {
-00008a90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008aa0: 2022 795f 7265 6164 223a 205b 5d2c 0a20   "y_read": [],. 
-00008ab0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00008ac0: 795f 7772 6974 6522 3a20 5b5d 2c0a 2020  y_write": [],.  
-00008ad0: 2020 2020 2020 2020 2020 2020 2020 2278                "x
-00008ae0: 5f72 6561 6422 3a20 5b5d 2c0a 2020 2020  _read": [],.    
-00008af0: 2020 2020 2020 2020 2020 2020 2278 5f77              "x_w
-00008b00: 7269 7465 223a 205b 5d2c 0a20 2020 2020  rite": [],.     
-00008b10: 2020 2020 2020 2020 2020 2022 785f 7265             "x_re
-00008b20: 6164 5f64 6973 6b22 3a20 5b5d 2c0a 2020  ad_disk": [],.  
-00008b30: 2020 2020 2020 2020 2020 2020 2020 2278                "x
-00008b40: 5f77 7269 7465 5f64 6973 6b22 3a20 5b5d  _write_disk": []
-00008b50: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
-00008b60: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00008b70: 2020 2073 656c 662e 6261 6e64 7769 6474     self.bandwidt
-00008b80: 6820 3d20 6669 6775 7265 280a 2020 2020  h = figure(.    
-00008b90: 2020 2020 2020 2020 7469 746c 653d 2257          title="W
-00008ba0: 6f72 6b65 7220 4e65 7477 6f72 6b20 4261  orker Network Ba
-00008bb0: 6e64 7769 6474 6822 2c0a 2020 2020 2020  ndwidth",.      
-00008bc0: 2020 2020 2020 746f 6f6c 733d 2222 2c0a        tools="",.
-00008bd0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-00008be0: 3d22 776f 726b 6572 5f6e 6574 776f 726b  ="worker_network
-00008bf0: 5f62 616e 6477 6964 7468 222c 0a20 2020  _bandwidth",.   
-00008c00: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
-00008c10: 732c 0a20 2020 2020 2020 2029 0a0a 2020  s,.        )..  
-00008c20: 2020 2020 2020 2320 686f 7374 5f6e 6574        # host_net
-00008c30: 5f69 6f2e 7265 6164 5f62 7073 0a20 2020  _io.read_bps.   
-00008c40: 2020 2020 2073 656c 662e 6261 6e64 7769       self.bandwi
-00008c50: 6474 682e 6862 6172 280a 2020 2020 2020  dth.hbar(.      
-00008c60: 2020 2020 2020 793d 2279 5f72 6561 6422        y="y_read"
-00008c70: 2c0a 2020 2020 2020 2020 2020 2020 7269  ,.            ri
-00008c80: 6768 743d 2278 5f72 6561 6422 2c0a 2020  ght="x_read",.  
-00008c90: 2020 2020 2020 2020 2020 6c69 6e65 5f63            line_c
-00008ca0: 6f6c 6f72 3d4e 6f6e 652c 0a20 2020 2020  olor=None,.     
-00008cb0: 2020 2020 2020 206c 6566 743d 302c 0a20         left=0,. 
-00008cc0: 2020 2020 2020 2020 2020 2068 6569 6768             heigh
-00008cd0: 743d 302e 352c 0a20 2020 2020 2020 2020  t=0.5,.         
-00008ce0: 2020 2066 696c 6c5f 636f 6c6f 723d 2272     fill_color="r
-00008cf0: 6564 222c 0a20 2020 2020 2020 2020 2020  ed",.           
-00008d00: 206c 6567 656e 645f 6c61 6265 6c3d 2272   legend_label="r
-00008d10: 6561 6422 2c0a 2020 2020 2020 2020 2020  ead",.          
-00008d20: 2020 736f 7572 6365 3d73 656c 662e 736f    source=self.so
-00008d30: 7572 6365 2c0a 2020 2020 2020 2020 290a  urce,.        ).
-00008d40: 0a20 2020 2020 2020 2023 2068 6f73 745f  .        # host_
-00008d50: 6e65 745f 696f 2e77 7269 7465 5f62 7073  net_io.write_bps
-00008d60: 0a20 2020 2020 2020 2073 656c 662e 6261  .        self.ba
-00008d70: 6e64 7769 6474 682e 6862 6172 280a 2020  ndwidth.hbar(.  
-00008d80: 2020 2020 2020 2020 2020 793d 2279 5f77            y="y_w
-00008d90: 7269 7465 222c 0a20 2020 2020 2020 2020  rite",.         
-00008da0: 2020 2072 6967 6874 3d22 785f 7772 6974     right="x_writ
-00008db0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-00008dc0: 6c69 6e65 5f63 6f6c 6f72 3d4e 6f6e 652c  line_color=None,
-00008dd0: 0a20 2020 2020 2020 2020 2020 206c 6566  .            lef
-00008de0: 743d 302c 0a20 2020 2020 2020 2020 2020  t=0,.           
-00008df0: 2068 6569 6768 743d 302e 352c 0a20 2020   height=0.5,.   
-00008e00: 2020 2020 2020 2020 2066 696c 6c5f 636f           fill_co
-00008e10: 6c6f 723d 2262 6c75 6522 2c0a 2020 2020  lor="blue",.    
-00008e20: 2020 2020 2020 2020 6c65 6765 6e64 5f6c          legend_l
-00008e30: 6162 656c 3d22 7772 6974 6522 2c0a 2020  abel="write",.  
-00008e40: 2020 2020 2020 2020 2020 736f 7572 6365            source
-00008e50: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
-00008e60: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00008e70: 2073 656c 662e 6261 6e64 7769 6474 682e   self.bandwidth.
-00008e80: 6178 6973 5b30 5d2e 7469 636b 6572 203d  axis[0].ticker =
-00008e90: 2042 6173 6963 5469 636b 6572 282a 2a54   BasicTicker(**T
-00008ea0: 4943 4b53 5f31 3032 3429 0a20 2020 2020  ICKS_1024).     
-00008eb0: 2020 2073 656c 662e 6261 6e64 7769 6474     self.bandwidt
-00008ec0: 682e 7861 7869 735b 305d 2e66 6f72 6d61  h.xaxis[0].forma
-00008ed0: 7474 6572 203d 204e 756d 6572 616c 5469  tter = NumeralTi
-00008ee0: 636b 466f 726d 6174 7465 7228 666f 726d  ckFormatter(form
-00008ef0: 6174 3d22 302e 3020 6222 290a 2020 2020  at="0.0 b").    
-00008f00: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
-00008f10: 7468 2e78 6178 6973 2e6d 616a 6f72 5f6c  th.xaxis.major_l
-00008f20: 6162 656c 5f6f 7269 656e 7461 7469 6f6e  abel_orientation
-00008f30: 203d 2058 4c41 4245 4c5f 4f52 4945 4e54   = XLABEL_ORIENT
-00008f40: 4154 494f 4e0a 2020 2020 2020 2020 7365  ATION.        se
-00008f50: 6c66 2e62 616e 6477 6964 7468 2e78 6178  lf.bandwidth.xax
-00008f60: 6973 2e6d 696e 6f72 5f74 6963 6b5f 6c69  is.minor_tick_li
-00008f70: 6e65 5f61 6c70 6861 203d 2030 0a20 2020  ne_alpha = 0.   
-00008f80: 2020 2020 2073 656c 662e 6261 6e64 7769       self.bandwi
-00008f90: 6474 682e 785f 7261 6e67 6520 3d20 5261  dth.x_range = Ra
-00008fa0: 6e67 6531 6428 7374 6172 743d 3029 0a20  nge1d(start=0). 
-00008fb0: 2020 2020 2020 2073 656c 662e 6261 6e64         self.band
-00008fc0: 7769 6474 682e 7961 7869 732e 7669 7369  width.yaxis.visi
-00008fd0: 626c 6520 3d20 4661 6c73 650a 2020 2020  ble = False.    
-00008fe0: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
-00008ff0: 7468 2e79 6772 6964 2e76 6973 6962 6c65  th.ygrid.visible
-00009000: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-00009010: 2073 656c 662e 6261 6e64 7769 6474 682e   self.bandwidth.
-00009020: 746f 6f6c 6261 725f 6c6f 6361 7469 6f6e  toolbar_location
-00009030: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
-00009040: 2073 656c 662e 6469 736b 203d 2066 6967   self.disk = fig
-00009050: 7572 6528 0a20 2020 2020 2020 2020 2020  ure(.           
-00009060: 2074 6974 6c65 3d22 576f 726b 6572 7320   title="Workers 
-00009070: 4469 736b 222c 0a20 2020 2020 2020 2020  Disk",.         
-00009080: 2020 2074 6f6f 6c73 3d22 222c 0a20 2020     tools="",.   
-00009090: 2020 2020 2020 2020 206e 616d 653d 2277           name="w
-000090a0: 6f72 6b65 725f 6469 736b 222c 0a20 2020  orker_disk",.   
-000090b0: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
-000090c0: 732c 0a20 2020 2020 2020 2029 0a0a 2020  s,.        )..  
-000090d0: 2020 2020 2020 2320 686f 7374 5f64 6973        # host_dis
-000090e0: 6b5f 696f 2e72 6561 645f 6270 730a 2020  k_io.read_bps.  
-000090f0: 2020 2020 2020 7365 6c66 2e64 6973 6b2e        self.disk.
-00009100: 6862 6172 280a 2020 2020 2020 2020 2020  hbar(.          
-00009110: 2020 793d 2279 5f72 6561 6422 2c0a 2020    y="y_read",.  
-00009120: 2020 2020 2020 2020 2020 7269 6768 743d            right=
-00009130: 2278 5f72 6561 645f 6469 736b 222c 0a20  "x_read_disk",. 
-00009140: 2020 2020 2020 2020 2020 206c 696e 655f             line_
-00009150: 636f 6c6f 723d 4e6f 6e65 2c0a 2020 2020  color=None,.    
-00009160: 2020 2020 2020 2020 6c65 6674 3d30 2c0a          left=0,.
-00009170: 2020 2020 2020 2020 2020 2020 6865 6967              heig
-00009180: 6874 3d30 2e35 2c0a 2020 2020 2020 2020  ht=0.5,.        
-00009190: 2020 2020 6669 6c6c 5f63 6f6c 6f72 3d22      fill_color="
-000091a0: 7265 6422 2c0a 2020 2020 2020 2020 2020  red",.          
-000091b0: 2020 6c65 6765 6e64 5f6c 6162 656c 3d22    legend_label="
-000091c0: 7265 6164 222c 0a20 2020 2020 2020 2020  read",.         
-000091d0: 2020 2073 6f75 7263 653d 7365 6c66 2e73     source=self.s
-000091e0: 6f75 7263 652c 0a20 2020 2020 2020 2029  ource,.        )
-000091f0: 0a0a 2020 2020 2020 2020 2320 686f 7374  ..        # host
-00009200: 5f64 6973 6b5f 696f 2e77 7269 7465 5f62  _disk_io.write_b
-00009210: 7073 0a20 2020 2020 2020 2073 656c 662e  ps.        self.
-00009220: 6469 736b 2e68 6261 7228 0a20 2020 2020  disk.hbar(.     
-00009230: 2020 2020 2020 2079 3d22 795f 7772 6974         y="y_writ
-00009240: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-00009250: 7269 6768 743d 2278 5f77 7269 7465 5f64  right="x_write_d
-00009260: 6973 6b22 2c0a 2020 2020 2020 2020 2020  isk",.          
-00009270: 2020 6c69 6e65 5f63 6f6c 6f72 3d4e 6f6e    line_color=Non
-00009280: 652c 0a20 2020 2020 2020 2020 2020 206c  e,.            l
-00009290: 6566 743d 302c 0a20 2020 2020 2020 2020  eft=0,.         
-000092a0: 2020 2068 6569 6768 743d 302e 352c 0a20     height=0.5,. 
-000092b0: 2020 2020 2020 2020 2020 2066 696c 6c5f             fill_
-000092c0: 636f 6c6f 723d 2262 6c75 6522 2c0a 2020  color="blue",.  
-000092d0: 2020 2020 2020 2020 2020 6c65 6765 6e64            legend
-000092e0: 5f6c 6162 656c 3d22 7772 6974 6522 2c0a  _label="write",.
-000092f0: 2020 2020 2020 2020 2020 2020 736f 7572              sour
-00009300: 6365 3d73 656c 662e 736f 7572 6365 2c0a  ce=self.source,.
-00009310: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00009320: 2020 2073 656c 662e 6469 736b 2e61 7869     self.disk.axi
-00009330: 735b 305d 2e74 6963 6b65 7220 3d20 4261  s[0].ticker = Ba
-00009340: 7369 6354 6963 6b65 7228 2a2a 5449 434b  sicTicker(**TICK
-00009350: 535f 3130 3234 290a 2020 2020 2020 2020  S_1024).        
-00009360: 7365 6c66 2e64 6973 6b2e 7861 7869 735b  self.disk.xaxis[
-00009370: 305d 2e66 6f72 6d61 7474 6572 203d 204e  0].formatter = N
-00009380: 756d 6572 616c 5469 636b 466f 726d 6174  umeralTickFormat
-00009390: 7465 7228 666f 726d 6174 3d22 302e 3020  ter(format="0.0 
-000093a0: 6222 290a 2020 2020 2020 2020 7365 6c66  b").        self
-000093b0: 2e64 6973 6b2e 7861 7869 732e 6d61 6a6f  .disk.xaxis.majo
-000093c0: 725f 6c61 6265 6c5f 6f72 6965 6e74 6174  r_label_orientat
-000093d0: 696f 6e20 3d20 584c 4142 454c 5f4f 5249  ion = XLABEL_ORI
-000093e0: 454e 5441 5449 4f4e 0a20 2020 2020 2020  ENTATION.       
-000093f0: 2073 656c 662e 6469 736b 2e78 6178 6973   self.disk.xaxis
-00009400: 2e6d 696e 6f72 5f74 6963 6b5f 6c69 6e65  .minor_tick_line
-00009410: 5f61 6c70 6861 203d 2030 0a20 2020 2020  _alpha = 0.     
-00009420: 2020 2073 656c 662e 6469 736b 2e78 5f72     self.disk.x_r
-00009430: 616e 6765 203d 2052 616e 6765 3164 2873  ange = Range1d(s
-00009440: 7461 7274 3d30 290a 2020 2020 2020 2020  tart=0).        
-00009450: 7365 6c66 2e64 6973 6b2e 7961 7869 732e  self.disk.yaxis.
-00009460: 7669 7369 626c 6520 3d20 4661 6c73 650a  visible = False.
-00009470: 2020 2020 2020 2020 7365 6c66 2e64 6973          self.dis
-00009480: 6b2e 7967 7269 642e 7669 7369 626c 6520  k.ygrid.visible 
-00009490: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-000094a0: 7365 6c66 2e64 6973 6b2e 746f 6f6c 6261  self.disk.toolba
-000094b0: 725f 6c6f 6361 7469 6f6e 203d 204e 6f6e  r_location = Non
-000094c0: 650a 0a20 2020 2040 7769 7468 6f75 745f  e..    @without_
-000094d0: 7072 6f70 6572 7479 5f76 616c 6964 6174  property_validat
-000094e0: 696f 6e0a 2020 2020 406c 6f67 5f65 7272  ion.    @log_err
-000094f0: 6f72 730a 2020 2020 6465 6620 7570 6461  ors.    def upda
-00009500: 7465 2873 656c 6629 3a0a 2020 2020 2020  te(self):.      
-00009510: 2020 776f 726b 6572 7320 3d20 7365 6c66    workers = self
-00009520: 2e73 6368 6564 756c 6572 2e77 6f72 6b65  .scheduler.worke
-00009530: 7273 2e76 616c 7565 7328 290a 0a20 2020  rs.values()..   
-00009540: 2020 2020 2068 203d 2030 2e31 0a20 2020       h = 0.1.   
-00009550: 2020 2020 2079 5f72 6561 6420 3d20 5b69       y_read = [i
-00009560: 202b 2030 2e37 3520 2b20 6920 2a20 6820   + 0.75 + i * h 
-00009570: 666f 7220 6920 696e 2072 616e 6765 286c  for i in range(l
-00009580: 656e 2877 6f72 6b65 7273 2929 5d0a 2020  en(workers))].  
-00009590: 2020 2020 2020 795f 7772 6974 6520 3d20        y_write = 
-000095a0: 5b69 202b 2030 2e32 3520 2b20 6920 2a20  [i + 0.25 + i * 
-000095b0: 6820 666f 7220 6920 696e 2072 616e 6765  h for i in range
-000095c0: 286c 656e 2877 6f72 6b65 7273 2929 5d0a  (len(workers))].
-000095d0: 0a20 2020 2020 2020 2078 5f72 6561 6420  .        x_read 
-000095e0: 3d20 5b5d 0a20 2020 2020 2020 2078 5f77  = [].        x_w
-000095f0: 7269 7465 203d 205b 5d0a 2020 2020 2020  rite = [].      
-00009600: 2020 785f 7265 6164 5f64 6973 6b20 3d20    x_read_disk = 
-00009610: 5b5d 0a20 2020 2020 2020 2078 5f77 7269  [].        x_wri
-00009620: 7465 5f64 6973 6b20 3d20 5b5d 0a0a 2020  te_disk = []..  
-00009630: 2020 2020 2020 666f 7220 7773 2069 6e20        for ws in 
-00009640: 776f 726b 6572 733a 0a20 2020 2020 2020  workers:.       
-00009650: 2020 2020 2078 5f72 6561 642e 6170 7065       x_read.appe
-00009660: 6e64 2877 732e 6d65 7472 6963 735b 2268  nd(ws.metrics["h
-00009670: 6f73 745f 6e65 745f 696f 225d 5b22 7265  ost_net_io"]["re
-00009680: 6164 5f62 7073 225d 290a 2020 2020 2020  ad_bps"]).      
-00009690: 2020 2020 2020 785f 7772 6974 652e 6170        x_write.ap
-000096a0: 7065 6e64 2877 732e 6d65 7472 6963 735b  pend(ws.metrics[
-000096b0: 2268 6f73 745f 6e65 745f 696f 225d 5b22  "host_net_io"]["
-000096c0: 7772 6974 655f 6270 7322 5d29 0a20 2020  write_bps"]).   
-000096d0: 2020 2020 2020 2020 2078 5f72 6561 645f           x_read_
-000096e0: 6469 736b 2e61 7070 656e 6428 7773 2e6d  disk.append(ws.m
-000096f0: 6574 7269 6373 2e67 6574 2822 686f 7374  etrics.get("host
-00009700: 5f64 6973 6b5f 696f 222c 207b 7d29 2e67  _disk_io", {}).g
-00009710: 6574 2822 7265 6164 5f62 7073 222c 2030  et("read_bps", 0
-00009720: 2929 0a20 2020 2020 2020 2020 2020 2078  )).            x
-00009730: 5f77 7269 7465 5f64 6973 6b2e 6170 7065  _write_disk.appe
-00009740: 6e64 2877 732e 6d65 7472 6963 732e 6765  nd(ws.metrics.ge
-00009750: 7428 2268 6f73 745f 6469 736b 5f69 6f22  t("host_disk_io"
-00009760: 2c20 7b7d 292e 6765 7428 2277 7269 7465  , {}).get("write
-00009770: 5f62 7073 222c 2030 2929 0a0a 2020 2020  _bps", 0))..    
-00009780: 2020 2020 6966 2073 656c 662e 7363 6865      if self.sche
-00009790: 6475 6c65 722e 776f 726b 6572 733a 0a20  duler.workers:. 
-000097a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000097b0: 6261 6e64 7769 6474 682e 785f 7261 6e67  bandwidth.x_rang
-000097c0: 652e 656e 6420 3d20 6d61 7828 0a20 2020  e.end = max(.   
-000097d0: 2020 2020 2020 2020 2020 2020 206d 6178               max
-000097e0: 2878 5f72 6561 6429 2c0a 2020 2020 2020  (x_read),.      
-000097f0: 2020 2020 2020 2020 2020 6d61 7828 785f            max(x_
-00009800: 7772 6974 6529 2c0a 2020 2020 2020 2020  write),.        
-00009810: 2020 2020 2020 2020 3130 305f 3030 305f          100_000_
-00009820: 3030 302c 0a20 2020 2020 2020 2020 2020  000,.           
-00009830: 2020 2020 2030 2e39 3520 2a20 7365 6c66       0.95 * self
-00009840: 2e62 616e 6477 6964 7468 2e78 5f72 616e  .bandwidth.x_ran
-00009850: 6765 2e65 6e64 2c0a 2020 2020 2020 2020  ge.end,.        
-00009860: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-00009870: 2020 2073 656c 662e 6469 736b 2e78 5f72     self.disk.x_r
-00009880: 616e 6765 2e65 6e64 203d 206d 6178 280a  ange.end = max(.
-00009890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000098a0: 6d61 7828 785f 7265 6164 5f64 6973 6b29  max(x_read_disk)
-000098b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000098c0: 2020 6d61 7828 785f 7772 6974 655f 6469    max(x_write_di
-000098d0: 736b 292c 0a20 2020 2020 2020 2020 2020  sk),.           
-000098e0: 2020 2020 2031 3030 5f30 3030 5f30 3030       100_000_000
-000098f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00009900: 2020 302e 3935 202a 2073 656c 662e 6469    0.95 * self.di
-00009910: 736b 2e78 5f72 616e 6765 2e65 6e64 2c0a  sk.x_range.end,.
-00009920: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00009930: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00009940: 2020 2020 2020 2020 7365 6c66 2e62 616e          self.ban
-00009950: 6477 6964 7468 2e78 5f72 616e 6765 2e65  dwidth.x_range.e
-00009960: 6e64 203d 2031 3030 5f30 3030 5f30 3030  nd = 100_000_000
-00009970: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00009980: 662e 6469 736b 2e78 5f72 616e 6765 2e65  f.disk.x_range.e
-00009990: 6e64 203d 2031 3030 5f30 3030 5f30 3030  nd = 100_000_000
-000099a0: 0a0a 2020 2020 2020 2020 7265 7375 6c74  ..        result
-000099b0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-000099c0: 2022 795f 7265 6164 223a 2079 5f72 6561   "y_read": y_rea
-000099d0: 642c 0a20 2020 2020 2020 2020 2020 2022  d,.            "
-000099e0: 795f 7772 6974 6522 3a20 795f 7772 6974  y_write": y_writ
-000099f0: 652c 0a20 2020 2020 2020 2020 2020 2022  e,.            "
-00009a00: 785f 7265 6164 223a 2078 5f72 6561 642c  x_read": x_read,
-00009a10: 0a20 2020 2020 2020 2020 2020 2022 785f  .            "x_
-00009a20: 7772 6974 6522 3a20 785f 7772 6974 652c  write": x_write,
-00009a30: 0a20 2020 2020 2020 2020 2020 2022 785f  .            "x_
-00009a40: 7265 6164 5f64 6973 6b22 3a20 785f 7265  read_disk": x_re
-00009a50: 6164 5f64 6973 6b2c 0a20 2020 2020 2020  ad_disk,.       
-00009a60: 2020 2020 2022 785f 7772 6974 655f 6469       "x_write_di
-00009a70: 736b 223a 2078 5f77 7269 7465 5f64 6973  sk": x_write_dis
-00009a80: 6b2c 0a20 2020 2020 2020 207d 0a0a 2020  k,.        }..  
-00009a90: 2020 2020 2020 7570 6461 7465 2873 656c        update(sel
-00009aa0: 662e 736f 7572 6365 2c20 7265 7375 6c74  f.source, result
-00009ab0: 290a 0a0a 636c 6173 7320 5379 7374 656d  )...class System
-00009ac0: 5469 6d65 7365 7269 6573 2844 6173 6862  Timeseries(Dashb
-00009ad0: 6f61 7264 436f 6d70 6f6e 656e 7429 3a0a  oardComponent):.
-00009ae0: 2020 2020 2222 2254 696d 6573 6572 6965      """Timeserie
-00009af0: 7320 666f 7220 776f 726b 6572 206e 6574  s for worker net
-00009b00: 776f 726b 2062 616e 6477 6964 7468 2c20  work bandwidth, 
-00009b10: 6370 752c 206d 656d 6f72 7920 616e 6420  cpu, memory and 
-00009b20: 6469 736b 2e0a 0a20 2020 2062 616e 6477  disk...    bandw
-00009b30: 6964 7468 0a20 2020 2020 2020 2050 6c6f  idth.        Plo
-00009b40: 7473 2074 6865 2061 7665 7261 6765 206f  ts the average o
-00009b50: 6620 686f 7374 5f6e 6574 5f69 6f2e 7265  f host_net_io.re
-00009b60: 6164 5f62 7073 2061 6e64 2068 6f73 745f  ad_bps and host_
-00009b70: 6e65 745f 696f 2e77 7269 7465 5f62 7073  net_io.write_bps
-00009b80: 2066 6f72 2074 6865 0a20 2020 2020 2020   for the.       
-00009b90: 2077 6f72 6b65 7273 2061 7320 6120 6675   workers as a fu
-00009ba0: 6e63 7469 6f6e 206f 6620 7469 6d65 0a20  nction of time. 
-00009bb0: 2020 2063 7075 0a20 2020 2020 2020 2050     cpu.        P
-00009bc0: 6c6f 7473 2074 6865 2061 7665 7261 6765  lots the average
-00009bd0: 206f 6620 6370 7520 666f 7220 7468 6520   of cpu for the 
-00009be0: 776f 726b 6572 7320 6173 2061 2066 756e  workers as a fun
-00009bf0: 6374 696f 6e20 6f66 2074 696d 650a 2020  ction of time.  
-00009c00: 2020 6d65 6d6f 7279 0a20 2020 2020 2020    memory.       
-00009c10: 2050 6c6f 7473 2074 6865 2061 7665 7261   Plots the avera
-00009c20: 6765 206f 6620 6d65 6d6f 7279 2066 6f72  ge of memory for
-00009c30: 2074 6865 2077 6f72 6b65 7273 2061 7320   the workers as 
-00009c40: 6120 6675 6e63 7469 6f6e 206f 6620 7469  a function of ti
-00009c50: 6d65 0a20 2020 2064 6973 6b0a 2020 2020  me.    disk.    
-00009c60: 2020 2020 506c 6f74 7320 7468 6520 6176      Plots the av
-00009c70: 6572 6167 6520 6f66 2068 6f73 745f 6469  erage of host_di
-00009c80: 736b 5f69 6f2e 7265 6164 5f62 7073 2061  sk_io.read_bps a
-00009c90: 6e64 2068 6f73 745f 6469 736b 5f69 6f2e  nd host_disk_io.
-00009ca0: 7772 6974 655f 6270 7320 666f 7220 7468  write_bps for th
-00009cb0: 650a 2020 2020 2020 2020 776f 726b 6572  e.        worker
-00009cc0: 7320 6173 2061 2066 756e 6374 696f 6e20  s as a function 
-00009cd0: 6f66 2074 696d 650a 0a20 2020 2054 6865  of time..    The
-00009ce0: 206d 6574 7269 6373 2070 6c6f 7474 6564   metrics plotted
-00009cf0: 2063 6f6d 6520 6672 6f6d 2074 6865 2061   come from the a
-00009d00: 6767 7265 6761 7469 6f6e 206f 6620 6672  ggregation of fr
-00009d10: 6f6d 2077 732e 6d65 7472 6963 735b 6b65  om ws.metrics[ke
-00009d20: 795d 2066 6f72 2077 7320 696e 0a20 2020  y] for ws in.   
-00009d30: 2073 6368 6564 756c 6572 2e77 6f72 6b65   scheduler.worke
-00009d40: 7273 2e76 616c 7565 7328 2920 6469 7669  rs.values() divi
-00009d50: 6465 6420 6279 206e 756d 6265 7220 6f66  ded by number of
-00009d60: 2077 6f72 6b65 7273 2e0a 2020 2020 2222   workers..    ""
-00009d70: 220a 0a20 2020 2040 6c6f 675f 6572 726f  "..    @log_erro
-00009d80: 7273 0a20 2020 2064 6566 205f 5f69 6e69  rs.    def __ini
-00009d90: 745f 5f28 7365 6c66 2c20 7363 6865 6475  t__(self, schedu
-00009da0: 6c65 722c 2066 6f6c 6c6f 775f 696e 7465  ler, follow_inte
-00009db0: 7276 616c 3d32 3030 3030 2c20 2a2a 6b77  rval=20000, **kw
-00009dc0: 6172 6773 293a 0a20 2020 2020 2020 2073  args):.        s
-00009dd0: 656c 662e 7363 6865 6475 6c65 7220 3d20  elf.scheduler = 
-00009de0: 7363 6865 6475 6c65 720a 2020 2020 2020  scheduler.      
-00009df0: 2020 7365 6c66 2e73 6f75 7263 6520 3d20    self.source = 
-00009e00: 436f 6c75 6d6e 4461 7461 536f 7572 6365  ColumnDataSource
-00009e10: 280a 2020 2020 2020 2020 2020 2020 7b0a  (.            {.
-00009e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e30: 2274 696d 6522 3a20 5b5d 2c0a 2020 2020  "time": [],.    
-00009e40: 2020 2020 2020 2020 2020 2020 2268 6f73              "hos
-00009e50: 745f 6e65 745f 696f 2e72 6561 645f 6270  t_net_io.read_bp
-00009e60: 7322 3a20 5b5d 2c0a 2020 2020 2020 2020  s": [],.        
-00009e70: 2020 2020 2020 2020 2268 6f73 745f 6e65          "host_ne
-00009e80: 745f 696f 2e77 7269 7465 5f62 7073 223a  t_io.write_bps":
-00009e90: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-00009ea0: 2020 2020 2022 6370 7522 3a20 5b5d 2c0a       "cpu": [],.
-00009eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009ec0: 226d 656d 6f72 7922 3a20 5b5d 2c0a 2020  "memory": [],.  
-00009ed0: 2020 2020 2020 2020 2020 2020 2020 2268                "h
-00009ee0: 6f73 745f 6469 736b 5f69 6f2e 7265 6164  ost_disk_io.read
-00009ef0: 5f62 7073 223a 205b 5d2c 0a20 2020 2020  _bps": [],.     
-00009f00: 2020 2020 2020 2020 2020 2022 686f 7374             "host
-00009f10: 5f64 6973 6b5f 696f 2e77 7269 7465 5f62  _disk_io.write_b
-00009f20: 7073 223a 205b 5d2c 0a20 2020 2020 2020  ps": [],.       
-00009f30: 2020 2020 207d 0a20 2020 2020 2020 2029       }.        )
-00009f40: 0a0a 2020 2020 2020 2020 7570 6461 7465  ..        update
-00009f50: 2873 656c 662e 736f 7572 6365 2c20 7365  (self.source, se
-00009f60: 6c66 2e67 6574 5f64 6174 6128 2929 0a0a  lf.get_data())..
-00009f70: 2020 2020 2020 2020 785f 7261 6e67 6520          x_range 
-00009f80: 3d20 4461 7461 5261 6e67 6531 6428 0a20  = DataRange1d(. 
-00009f90: 2020 2020 2020 2020 2020 2066 6f6c 6c6f             follo
-00009fa0: 773d 2265 6e64 222c 2066 6f6c 6c6f 775f  w="end", follow_
-00009fb0: 696e 7465 7276 616c 3d66 6f6c 6c6f 775f  interval=follow_
-00009fc0: 696e 7465 7276 616c 2c20 7261 6e67 655f  interval, range_
-00009fd0: 7061 6464 696e 673d 300a 2020 2020 2020  padding=0.      
-00009fe0: 2020 290a 2020 2020 2020 2020 746f 6f6c    ).        tool
-00009ff0: 7320 3d20 2272 6573 6574 2c20 7870 616e  s = "reset, xpan
-0000a000: 2c20 7877 6865 656c 5f7a 6f6f 6d22 0a0a  , xwheel_zoom"..
-0000a010: 2020 2020 2020 2020 7365 6c66 2e62 616e          self.ban
-0000a020: 6477 6964 7468 203d 2066 6967 7572 6528  dwidth = figure(
-0000a030: 0a20 2020 2020 2020 2020 2020 2074 6974  .            tit
-0000a040: 6c65 3d22 576f 726b 6572 204e 6574 776f  le="Worker Netwo
-0000a050: 726b 2042 616e 6477 6964 7468 2028 6176  rk Bandwidth (av
-0000a060: 6572 6167 6529 222c 0a20 2020 2020 2020  erage)",.       
-0000a070: 2020 2020 2078 5f61 7869 735f 7479 7065       x_axis_type
-0000a080: 3d22 6461 7465 7469 6d65 222c 0a20 2020  ="datetime",.   
-0000a090: 2020 2020 2020 2020 2074 6f6f 6c73 3d74           tools=t
-0000a0a0: 6f6f 6c73 2c0a 2020 2020 2020 2020 2020  ools,.          
-0000a0b0: 2020 785f 7261 6e67 653d 785f 7261 6e67    x_range=x_rang
-0000a0c0: 652c 0a20 2020 2020 2020 2020 2020 206e  e,.            n
-0000a0d0: 616d 653d 2277 6f72 6b65 725f 6e65 7477  ame="worker_netw
-0000a0e0: 6f72 6b5f 6261 6e64 7769 6474 682d 7469  ork_bandwidth-ti
-0000a0f0: 6d65 7365 7269 6573 222c 0a20 2020 2020  meseries",.     
-0000a100: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
-0000a110: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-0000a120: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
-0000a130: 7468 2e6c 696e 6528 0a20 2020 2020 2020  th.line(.       
-0000a140: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
-0000a150: 2e73 6f75 7263 652c 0a20 2020 2020 2020  .source,.       
-0000a160: 2020 2020 2078 3d22 7469 6d65 222c 0a20       x="time",. 
-0000a170: 2020 2020 2020 2020 2020 2079 3d22 686f             y="ho
-0000a180: 7374 5f6e 6574 5f69 6f2e 7265 6164 5f62  st_net_io.read_b
-0000a190: 7073 222c 0a20 2020 2020 2020 2020 2020  ps",.           
-0000a1a0: 2063 6f6c 6f72 3d22 7265 6422 2c0a 2020   color="red",.  
-0000a1b0: 2020 2020 2020 2020 2020 6c65 6765 6e64            legend
-0000a1c0: 5f6c 6162 656c 3d22 7265 6164 2028 6d65  _label="read (me
-0000a1d0: 616e 2922 2c0a 2020 2020 2020 2020 290a  an)",.        ).
-0000a1e0: 2020 2020 2020 2020 7365 6c66 2e62 616e          self.ban
-0000a1f0: 6477 6964 7468 2e6c 696e 6528 0a20 2020  dwidth.line(.   
-0000a200: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
-0000a210: 7365 6c66 2e73 6f75 7263 652c 0a20 2020  self.source,.   
-0000a220: 2020 2020 2020 2020 2078 3d22 7469 6d65           x="time
-0000a230: 222c 0a20 2020 2020 2020 2020 2020 2079  ",.            y
-0000a240: 3d22 686f 7374 5f6e 6574 5f69 6f2e 7772  ="host_net_io.wr
-0000a250: 6974 655f 6270 7322 2c0a 2020 2020 2020  ite_bps",.      
-0000a260: 2020 2020 2020 636f 6c6f 723d 2262 6c75        color="blu
-0000a270: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-0000a280: 6c65 6765 6e64 5f6c 6162 656c 3d22 7772  legend_label="wr
-0000a290: 6974 6520 286d 6561 6e29 222c 0a20 2020  ite (mean)",.   
-0000a2a0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0000a2b0: 7365 6c66 2e62 616e 6477 6964 7468 2e6c  self.bandwidth.l
-0000a2c0: 6567 656e 642e 6c6f 6361 7469 6f6e 203d  egend.location =
-0000a2d0: 2022 746f 705f 6c65 6674 220a 2020 2020   "top_left".    
-0000a2e0: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
-0000a2f0: 7468 2e79 6178 6973 2e61 7869 735f 6c61  th.yaxis.axis_la
-0000a300: 6265 6c20 3d20 2262 7974 6573 202f 2073  bel = "bytes / s
-0000a310: 6563 6f6e 6422 0a20 2020 2020 2020 2073  econd".        s
-0000a320: 656c 662e 6261 6e64 7769 6474 682e 7961  elf.bandwidth.ya
-0000a330: 7869 735b 305d 2e66 6f72 6d61 7474 6572  xis[0].formatter
-0000a340: 203d 204e 756d 6572 616c 5469 636b 466f   = NumeralTickFo
-0000a350: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
-0000a360: 302e 3062 2229 0a20 2020 2020 2020 2073  0.0b").        s
-0000a370: 656c 662e 6261 6e64 7769 6474 682e 795f  elf.bandwidth.y_
-0000a380: 7261 6e67 652e 7374 6172 7420 3d20 300a  range.start = 0.
-0000a390: 2020 2020 2020 2020 7365 6c66 2e62 616e          self.ban
-0000a3a0: 6477 6964 7468 2e79 6178 6973 2e6d 696e  dwidth.yaxis.min
-0000a3b0: 6f72 5f74 6963 6b5f 6c69 6e65 5f61 6c70  or_tick_line_alp
-0000a3c0: 6861 203d 2030 0a20 2020 2020 2020 2073  ha = 0.        s
-0000a3d0: 656c 662e 6261 6e64 7769 6474 682e 7867  elf.bandwidth.xg
-0000a3e0: 7269 642e 7669 7369 626c 6520 3d20 4661  rid.visible = Fa
-0000a3f0: 6c73 650a 0a20 2020 2020 2020 2073 656c  lse..        sel
-0000a400: 662e 6370 7520 3d20 6669 6775 7265 280a  f.cpu = figure(.
-0000a410: 2020 2020 2020 2020 2020 2020 7469 746c              titl
-0000a420: 653d 2257 6f72 6b65 7220 4350 5520 5574  e="Worker CPU Ut
-0000a430: 696c 697a 6174 696f 6e20 2861 7665 7261  ilization (avera
-0000a440: 6765 2922 2c0a 2020 2020 2020 2020 2020  ge)",.          
-0000a450: 2020 785f 6178 6973 5f74 7970 653d 2264    x_axis_type="d
-0000a460: 6174 6574 696d 6522 2c0a 2020 2020 2020  atetime",.      
-0000a470: 2020 2020 2020 746f 6f6c 733d 746f 6f6c        tools=tool
-0000a480: 732c 0a20 2020 2020 2020 2020 2020 2078  s,.            x
-0000a490: 5f72 616e 6765 3d78 5f72 616e 6765 2c0a  _range=x_range,.
-0000a4a0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-0000a4b0: 3d22 776f 726b 6572 5f63 7075 2d74 696d  ="worker_cpu-tim
-0000a4c0: 6573 6572 6965 7322 2c0a 2020 2020 2020  eseries",.      
-0000a4d0: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
-0000a4e0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0000a4f0: 2020 2073 656c 662e 6370 752e 6c69 6e65     self.cpu.line
-0000a500: 280a 2020 2020 2020 2020 2020 2020 736f  (.            so
-0000a510: 7572 6365 3d73 656c 662e 736f 7572 6365  urce=self.source
-0000a520: 2c0a 2020 2020 2020 2020 2020 2020 783d  ,.            x=
-0000a530: 2274 696d 6522 2c0a 2020 2020 2020 2020  "time",.        
-0000a540: 2020 2020 793d 2263 7075 222c 0a20 2020      y="cpu",.   
-0000a550: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
-0000a560: 656c 662e 6370 752e 7961 7869 732e 6178  elf.cpu.yaxis.ax
-0000a570: 6973 5f6c 6162 656c 203d 2022 5574 696c  is_label = "Util
-0000a580: 697a 6174 696f 6e22 0a20 2020 2020 2020  ization".       
-0000a590: 2073 656c 662e 6370 752e 795f 7261 6e67   self.cpu.y_rang
-0000a5a0: 652e 7374 6172 7420 3d20 300a 2020 2020  e.start = 0.    
-0000a5b0: 2020 2020 7365 6c66 2e63 7075 2e79 6178      self.cpu.yax
-0000a5c0: 6973 2e6d 696e 6f72 5f74 6963 6b5f 6c69  is.minor_tick_li
-0000a5d0: 6e65 5f61 6c70 6861 203d 2030 0a20 2020  ne_alpha = 0.   
-0000a5e0: 2020 2020 2073 656c 662e 6370 752e 7867       self.cpu.xg
-0000a5f0: 7269 642e 7669 7369 626c 6520 3d20 4661  rid.visible = Fa
-0000a600: 6c73 650a 0a20 2020 2020 2020 2073 656c  lse..        sel
-0000a610: 662e 6d65 6d6f 7279 203d 2066 6967 7572  f.memory = figur
-0000a620: 6528 0a20 2020 2020 2020 2020 2020 2074  e(.            t
-0000a630: 6974 6c65 3d22 576f 726b 6572 204d 656d  itle="Worker Mem
-0000a640: 6f72 7920 5573 6520 2861 7665 7261 6765  ory Use (average
-0000a650: 2922 2c0a 2020 2020 2020 2020 2020 2020  )",.            
-0000a660: 785f 6178 6973 5f74 7970 653d 2264 6174  x_axis_type="dat
-0000a670: 6574 696d 6522 2c0a 2020 2020 2020 2020  etime",.        
-0000a680: 2020 2020 746f 6f6c 733d 746f 6f6c 732c      tools=tools,
-0000a690: 0a20 2020 2020 2020 2020 2020 2078 5f72  .            x_r
-0000a6a0: 616e 6765 3d78 5f72 616e 6765 2c0a 2020  ange=x_range,.  
-0000a6b0: 2020 2020 2020 2020 2020 6e61 6d65 3d22            name="
-0000a6c0: 776f 726b 6572 5f6d 656d 6f72 792d 7469  worker_memory-ti
-0000a6d0: 6d65 7365 7269 6573 222c 0a20 2020 2020  meseries",.     
-0000a6e0: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
-0000a6f0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-0000a700: 2020 2020 7365 6c66 2e6d 656d 6f72 792e      self.memory.
-0000a710: 6c69 6e65 280a 2020 2020 2020 2020 2020  line(.          
-0000a720: 2020 736f 7572 6365 3d73 656c 662e 736f    source=self.so
-0000a730: 7572 6365 2c0a 2020 2020 2020 2020 2020  urce,.          
-0000a740: 2020 783d 2274 696d 6522 2c0a 2020 2020    x="time",.    
-0000a750: 2020 2020 2020 2020 793d 226d 656d 6f72          y="memor
-0000a760: 7922 2c0a 2020 2020 2020 2020 290a 2020  y",.        ).  
-0000a770: 2020 2020 2020 7365 6c66 2e6d 656d 6f72        self.memor
-0000a780: 792e 7961 7869 732e 6178 6973 5f6c 6162  y.yaxis.axis_lab
-0000a790: 656c 203d 2022 4279 7465 7322 0a20 2020  el = "Bytes".   
-0000a7a0: 2020 2020 2073 656c 662e 6d65 6d6f 7279       self.memory
-0000a7b0: 2e79 6178 6973 5b30 5d2e 666f 726d 6174  .yaxis[0].format
-0000a7c0: 7465 7220 3d20 4e75 6d65 7261 6c54 6963  ter = NumeralTic
-0000a7d0: 6b46 6f72 6d61 7474 6572 2866 6f72 6d61  kFormatter(forma
-0000a7e0: 743d 2230 2e30 6222 290a 2020 2020 2020  t="0.0b").      
-0000a7f0: 2020 7365 6c66 2e6d 656d 6f72 792e 795f    self.memory.y_
-0000a800: 7261 6e67 652e 7374 6172 7420 3d20 300a  range.start = 0.
-0000a810: 2020 2020 2020 2020 7365 6c66 2e6d 656d          self.mem
-0000a820: 6f72 792e 7961 7869 732e 6d69 6e6f 725f  ory.yaxis.minor_
-0000a830: 7469 636b 5f6c 696e 655f 616c 7068 6120  tick_line_alpha 
-0000a840: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
-0000a850: 2e6d 656d 6f72 792e 7867 7269 642e 7669  .memory.xgrid.vi
-0000a860: 7369 626c 6520 3d20 4661 6c73 650a 0a20  sible = False.. 
-0000a870: 2020 2020 2020 2073 656c 662e 6469 736b         self.disk
-0000a880: 203d 2066 6967 7572 6528 0a20 2020 2020   = figure(.     
-0000a890: 2020 2020 2020 2074 6974 6c65 3d22 576f         title="Wo
-0000a8a0: 726b 6572 2044 6973 6b20 4261 6e64 7769  rker Disk Bandwi
-0000a8b0: 6474 6820 2861 7665 7261 6765 2922 2c0a  dth (average)",.
-0000a8c0: 2020 2020 2020 2020 2020 2020 785f 6178              x_ax
-0000a8d0: 6973 5f74 7970 653d 2264 6174 6574 696d  is_type="datetim
-0000a8e0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-0000a8f0: 746f 6f6c 733d 746f 6f6c 732c 0a20 2020  tools=tools,.   
-0000a900: 2020 2020 2020 2020 2078 5f72 616e 6765           x_range
-0000a910: 3d78 5f72 616e 6765 2c0a 2020 2020 2020  =x_range,.      
-0000a920: 2020 2020 2020 6e61 6d65 3d22 776f 726b        name="work
-0000a930: 6572 5f64 6973 6b2d 7469 6d65 7365 7269  er_disk-timeseri
-0000a940: 6573 222c 0a20 2020 2020 2020 2020 2020  es",.           
-0000a950: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
-0000a960: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
-0000a970: 6c66 2e64 6973 6b2e 6c69 6e65 280a 2020  lf.disk.line(.  
-0000a980: 2020 2020 2020 2020 2020 736f 7572 6365            source
-0000a990: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
-0000a9a0: 2020 2020 2020 2020 2020 783d 2274 696d            x="tim
-0000a9b0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-0000a9c0: 793d 2268 6f73 745f 6469 736b 5f69 6f2e  y="host_disk_io.
-0000a9d0: 7265 6164 5f62 7073 222c 0a20 2020 2020  read_bps",.     
-0000a9e0: 2020 2020 2020 2063 6f6c 6f72 3d22 7265         color="re
-0000a9f0: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
-0000aa00: 6c65 6765 6e64 5f6c 6162 656c 3d22 7265  legend_label="re
-0000aa10: 6164 2028 6d65 616e 2922 2c0a 2020 2020  ad (mean)",.    
-0000aa20: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-0000aa30: 6c66 2e64 6973 6b2e 6c69 6e65 280a 2020  lf.disk.line(.  
-0000aa40: 2020 2020 2020 2020 2020 736f 7572 6365            source
-0000aa50: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
-0000aa60: 2020 2020 2020 2020 2020 783d 2274 696d            x="tim
-0000aa70: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-0000aa80: 793d 2268 6f73 745f 6469 736b 5f69 6f2e  y="host_disk_io.
-0000aa90: 7772 6974 655f 6270 7322 2c0a 2020 2020  write_bps",.    
-0000aaa0: 2020 2020 2020 2020 636f 6c6f 723d 2262          color="b
-0000aab0: 6c75 6522 2c0a 2020 2020 2020 2020 2020  lue",.          
-0000aac0: 2020 6c65 6765 6e64 5f6c 6162 656c 3d22    legend_label="
-0000aad0: 7772 6974 6520 286d 6561 6e29 222c 0a20  write (mean)",. 
-0000aae0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0000aaf0: 2020 7365 6c66 2e64 6973 6b2e 6c65 6765    self.disk.lege
-0000ab00: 6e64 2e6c 6f63 6174 696f 6e20 3d20 2274  nd.location = "t
-0000ab10: 6f70 5f6c 6566 7422 0a20 2020 2020 2020  op_left".       
-0000ab20: 2073 656c 662e 6469 736b 2e79 6178 6973   self.disk.yaxis
-0000ab30: 2e61 7869 735f 6c61 6265 6c20 3d20 2262  .axis_label = "b
-0000ab40: 7974 6573 202f 2073 6563 6f6e 6422 0a20  ytes / second". 
-0000ab50: 2020 2020 2020 2073 656c 662e 6469 736b         self.disk
-0000ab60: 2e79 6178 6973 5b30 5d2e 666f 726d 6174  .yaxis[0].format
-0000ab70: 7465 7220 3d20 4e75 6d65 7261 6c54 6963  ter = NumeralTic
-0000ab80: 6b46 6f72 6d61 7474 6572 2866 6f72 6d61  kFormatter(forma
-0000ab90: 743d 2230 2e30 6222 290a 2020 2020 2020  t="0.0b").      
-0000aba0: 2020 7365 6c66 2e64 6973 6b2e 795f 7261    self.disk.y_ra
-0000abb0: 6e67 652e 7374 6172 7420 3d20 300a 2020  nge.start = 0.  
-0000abc0: 2020 2020 2020 7365 6c66 2e64 6973 6b2e        self.disk.
-0000abd0: 7961 7869 732e 6d69 6e6f 725f 7469 636b  yaxis.minor_tick
-0000abe0: 5f6c 696e 655f 616c 7068 6120 3d20 300a  _line_alpha = 0.
-0000abf0: 2020 2020 2020 2020 7365 6c66 2e64 6973          self.dis
-0000ac00: 6b2e 7867 7269 642e 7669 7369 626c 6520  k.xgrid.visible 
-0000ac10: 3d20 4661 6c73 650a 0a20 2020 2064 6566  = False..    def
-0000ac20: 2067 6574 5f64 6174 6128 7365 6c66 293a   get_data(self):
-0000ac30: 0a20 2020 2020 2020 2077 6f72 6b65 7273  .        workers
-0000ac40: 203d 2073 656c 662e 7363 6865 6475 6c65   = self.schedule
-0000ac50: 722e 776f 726b 6572 732e 7661 6c75 6573  r.workers.values
-0000ac60: 2829 0a0a 2020 2020 2020 2020 6e65 745f  ()..        net_
-0000ac70: 7265 6164 5f62 7073 203d 2030 0a20 2020  read_bps = 0.   
-0000ac80: 2020 2020 206e 6574 5f77 7269 7465 5f62       net_write_b
-0000ac90: 7073 203d 2030 0a20 2020 2020 2020 2063  ps = 0.        c
-0000aca0: 7075 203d 2030 0a20 2020 2020 2020 206d  pu = 0.        m
-0000acb0: 656d 6f72 7920 3d20 300a 2020 2020 2020  emory = 0.      
-0000acc0: 2020 6469 736b 5f72 6561 645f 6270 7320    disk_read_bps 
-0000acd0: 3d20 300a 2020 2020 2020 2020 6469 736b  = 0.        disk
-0000ace0: 5f77 7269 7465 5f62 7073 203d 2030 0a20  _write_bps = 0. 
-0000acf0: 2020 2020 2020 2074 696d 6520 3d20 300a         time = 0.
-0000ad00: 2020 2020 2020 2020 666f 7220 7773 2069          for ws i
-0000ad10: 6e20 776f 726b 6572 733a 0a20 2020 2020  n workers:.     
-0000ad20: 2020 2020 2020 206e 6574 5f72 6561 645f         net_read_
-0000ad30: 6270 7320 2b3d 2077 732e 6d65 7472 6963  bps += ws.metric
-0000ad40: 735b 2268 6f73 745f 6e65 745f 696f 225d  s["host_net_io"]
-0000ad50: 5b22 7265 6164 5f62 7073 225d 0a20 2020  ["read_bps"].   
-0000ad60: 2020 2020 2020 2020 206e 6574 5f77 7269           net_wri
-0000ad70: 7465 5f62 7073 202b 3d20 7773 2e6d 6574  te_bps += ws.met
-0000ad80: 7269 6373 5b22 686f 7374 5f6e 6574 5f69  rics["host_net_i
-0000ad90: 6f22 5d5b 2277 7269 7465 5f62 7073 225d  o"]["write_bps"]
-0000ada0: 0a20 2020 2020 2020 2020 2020 2063 7075  .            cpu
-0000adb0: 202b 3d20 7773 2e6d 6574 7269 6373 5b22   += ws.metrics["
-0000adc0: 6370 7522 5d0a 2020 2020 2020 2020 2020  cpu"].          
-0000add0: 2020 6d65 6d6f 7279 202b 3d20 7773 2e6d    memory += ws.m
-0000ade0: 6574 7269 6373 5b22 6d65 6d6f 7279 225d  etrics["memory"]
-0000adf0: 0a20 2020 2020 2020 2020 2020 2064 6973  .            dis
-0000ae00: 6b5f 7265 6164 5f62 7073 202b 3d20 7773  k_read_bps += ws
-0000ae10: 2e6d 6574 7269 6373 2e67 6574 2822 686f  .metrics.get("ho
-0000ae20: 7374 5f64 6973 6b5f 696f 222c 207b 7d29  st_disk_io", {})
-0000ae30: 2e67 6574 2822 7265 6164 5f62 7073 222c  .get("read_bps",
-0000ae40: 2030 290a 2020 2020 2020 2020 2020 2020   0).            
-0000ae50: 6469 736b 5f77 7269 7465 5f62 7073 202b  disk_write_bps +
-0000ae60: 3d20 7773 2e6d 6574 7269 6373 2e67 6574  = ws.metrics.get
-0000ae70: 2822 686f 7374 5f64 6973 6b5f 696f 222c  ("host_disk_io",
-0000ae80: 207b 7d29 2e67 6574 2822 7772 6974 655f   {}).get("write_
-0000ae90: 6270 7322 2c20 3029 0a20 2020 2020 2020  bps", 0).       
-0000aea0: 2020 2020 2074 696d 6520 2b3d 2077 732e       time += ws.
-0000aeb0: 6d65 7472 6963 735b 2274 696d 6522 5d0a  metrics["time"].
-0000aec0: 0a20 2020 2020 2020 2072 6573 756c 7420  .        result 
-0000aed0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-0000aee0: 2320 7573 6520 606f 7260 2074 6f20 6176  # use `or` to av
-0000aef0: 6f69 6420 5a65 726f 4469 7669 7369 6f6e  oid ZeroDivision
-0000af00: 2077 6865 6e20 6e6f 2077 6f72 6b65 7273   when no workers
-0000af10: 0a20 2020 2020 2020 2020 2020 2022 7469  .            "ti
-0000af20: 6d65 223a 205b 7469 6d65 202f 2028 6c65  me": [time / (le
-0000af30: 6e28 776f 726b 6572 7329 206f 7220 3129  n(workers) or 1)
-0000af40: 202a 2031 3030 305d 2c0a 2020 2020 2020   * 1000],.      
-0000af50: 2020 2020 2020 2268 6f73 745f 6e65 745f        "host_net_
-0000af60: 696f 2e72 6561 645f 6270 7322 3a20 5b6e  io.read_bps": [n
-0000af70: 6574 5f72 6561 645f 6270 7320 2f20 286c  et_read_bps / (l
-0000af80: 656e 2877 6f72 6b65 7273 2920 6f72 2031  en(workers) or 1
-0000af90: 295d 2c0a 2020 2020 2020 2020 2020 2020  )],.            
-0000afa0: 2268 6f73 745f 6e65 745f 696f 2e77 7269  "host_net_io.wri
-0000afb0: 7465 5f62 7073 223a 205b 6e65 745f 7772  te_bps": [net_wr
-0000afc0: 6974 655f 6270 7320 2f20 286c 656e 2877  ite_bps / (len(w
-0000afd0: 6f72 6b65 7273 2920 6f72 2031 295d 2c0a  orkers) or 1)],.
-0000afe0: 2020 2020 2020 2020 2020 2020 2263 7075              "cpu
-0000aff0: 223a 205b 6370 7520 2f20 286c 656e 2877  ": [cpu / (len(w
-0000b000: 6f72 6b65 7273 2920 6f72 2031 295d 2c0a  orkers) or 1)],.
-0000b010: 2020 2020 2020 2020 2020 2020 226d 656d              "mem
-0000b020: 6f72 7922 3a20 5b6d 656d 6f72 7920 2f20  ory": [memory / 
-0000b030: 286c 656e 2877 6f72 6b65 7273 2920 6f72  (len(workers) or
-0000b040: 2031 295d 2c0a 2020 2020 2020 2020 2020   1)],.          
-0000b050: 2020 2268 6f73 745f 6469 736b 5f69 6f2e    "host_disk_io.
-0000b060: 7265 6164 5f62 7073 223a 205b 6469 736b  read_bps": [disk
-0000b070: 5f72 6561 645f 6270 7320 2f20 286c 656e  _read_bps / (len
-0000b080: 2877 6f72 6b65 7273 2920 6f72 2031 295d  (workers) or 1)]
-0000b090: 2c0a 2020 2020 2020 2020 2020 2020 2268  ,.            "h
-0000b0a0: 6f73 745f 6469 736b 5f69 6f2e 7772 6974  ost_disk_io.writ
-0000b0b0: 655f 6270 7322 3a20 5b64 6973 6b5f 7772  e_bps": [disk_wr
-0000b0c0: 6974 655f 6270 7320 2f20 286c 656e 2877  ite_bps / (len(w
-0000b0d0: 6f72 6b65 7273 2920 6f72 2031 295d 2c0a  orkers) or 1)],.
-0000b0e0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0000b0f0: 2020 7265 7475 726e 2072 6573 756c 740a    return result.
-0000b100: 0a20 2020 2040 7769 7468 6f75 745f 7072  .    @without_pr
-0000b110: 6f70 6572 7479 5f76 616c 6964 6174 696f  operty_validatio
-0000b120: 6e0a 2020 2020 406c 6f67 5f65 7272 6f72  n.    @log_error
-0000b130: 730a 2020 2020 6465 6620 7570 6461 7465  s.    def update
-0000b140: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000b150: 7365 6c66 2e73 6f75 7263 652e 7374 7265  self.source.stre
-0000b160: 616d 2873 656c 662e 6765 745f 6461 7461  am(self.get_data
-0000b170: 2829 2c20 3130 3030 290a 0a20 2020 2020  (), 1000)..     
-0000b180: 2020 2069 6620 7365 6c66 2e73 6368 6564     if self.sched
-0000b190: 756c 6572 2e77 6f72 6b65 7273 3a0a 2020  uler.workers:.  
-0000b1a0: 2020 2020 2020 2020 2020 795f 656e 645f            y_end_
-0000b1b0: 6370 7520 3d20 7375 6d28 0a20 2020 2020  cpu = sum(.     
-0000b1c0: 2020 2020 2020 2020 2020 2077 732e 6e74             ws.nt
-0000b1d0: 6872 6561 6473 206f 7220 3120 666f 7220  hreads or 1 for 
-0000b1e0: 7773 2069 6e20 7365 6c66 2e73 6368 6564  ws in self.sched
-0000b1f0: 756c 6572 2e77 6f72 6b65 7273 2e76 616c  uler.workers.val
-0000b200: 7565 7328 290a 2020 2020 2020 2020 2020  ues().          
-0000b210: 2020 2920 2f20 6c65 6e28 7365 6c66 2e73    ) / len(self.s
-0000b220: 6368 6564 756c 6572 2e77 6f72 6b65 7273  cheduler.workers
-0000b230: 2e76 616c 7565 7328 2929 0a20 2020 2020  .values()).     
-0000b240: 2020 2020 2020 2079 5f65 6e64 5f6d 656d         y_end_mem
-0000b250: 203d 2073 756d 280a 2020 2020 2020 2020   = sum(.        
-0000b260: 2020 2020 2020 2020 7773 2e6d 656d 6f72          ws.memor
-0000b270: 795f 6c69 6d69 7420 666f 7220 7773 2069  y_limit for ws i
-0000b280: 6e20 7365 6c66 2e73 6368 6564 756c 6572  n self.scheduler
-0000b290: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
-0000b2a0: 290a 2020 2020 2020 2020 2020 2020 2920  ).            ) 
-0000b2b0: 2f20 6c65 6e28 7365 6c66 2e73 6368 6564  / len(self.sched
-0000b2c0: 756c 6572 2e77 6f72 6b65 7273 2e76 616c  uler.workers.val
-0000b2d0: 7565 7328 2929 0a20 2020 2020 2020 2065  ues()).        e
-0000b2e0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000b2f0: 2079 5f65 6e64 5f63 7075 203d 2031 0a20   y_end_cpu = 1. 
-0000b300: 2020 2020 2020 2020 2020 2079 5f65 6e64             y_end
-0000b310: 5f6d 656d 203d 2031 3030 5f30 3030 5f30  _mem = 100_000_0
-0000b320: 3030 0a0a 2020 2020 2020 2020 7365 6c66  00..        self
-0000b330: 2e63 7075 2e79 5f72 616e 6765 2e65 6e64  .cpu.y_range.end
-0000b340: 203d 2079 5f65 6e64 5f63 7075 202a 2031   = y_end_cpu * 1
-0000b350: 3030 0a20 2020 2020 2020 2073 656c 662e  00.        self.
-0000b360: 6d65 6d6f 7279 2e79 5f72 616e 6765 2e65  memory.y_range.e
-0000b370: 6e64 203d 2079 5f65 6e64 5f6d 656d 0a0a  nd = y_end_mem..
-0000b380: 0a63 6c61 7373 2043 6f6d 7075 7465 5065  .class ComputePe
-0000b390: 724b 6579 2844 6173 6862 6f61 7264 436f  rKey(DashboardCo
-0000b3a0: 6d70 6f6e 656e 7429 3a0a 2020 2020 2222  mponent):.    ""
-0000b3b0: 2242 6172 2063 6861 7274 2073 686f 7769  "Bar chart showi
-0000b3c0: 6e67 2074 696d 6520 7370 656e 6420 696e  ng time spend in
-0000b3d0: 2061 6374 696f 6e20 6279 206b 6579 2070   action by key p
-0000b3e0: 7265 6669 7822 2222 0a0a 2020 2020 406c  refix"""..    @l
-0000b3f0: 6f67 5f65 7272 6f72 730a 2020 2020 6465  og_errors.    de
-0000b400: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
-0000b410: 2073 6368 6564 756c 6572 2c20 2a2a 6b77   scheduler, **kw
-0000b420: 6172 6773 293a 0a20 2020 2020 2020 2073  args):.        s
-0000b430: 656c 662e 6c61 7374 203d 2030 0a20 2020  elf.last = 0.   
-0000b440: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
-0000b450: 6c65 7220 3d20 7363 6865 6475 6c65 720a  ler = scheduler.
-0000b460: 0a20 2020 2020 2020 2069 6620 5461 736b  .        if Task
-0000b470: 5374 7265 616d 506c 7567 696e 2e6e 616d  StreamPlugin.nam
-0000b480: 6520 6e6f 7420 696e 2073 656c 662e 7363  e not in self.sc
-0000b490: 6865 6475 6c65 722e 706c 7567 696e 733a  heduler.plugins:
-0000b4a0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000b4b0: 662e 7363 6865 6475 6c65 722e 6164 645f  f.scheduler.add_
-0000b4c0: 706c 7567 696e 2854 6173 6b53 7472 6561  plugin(TaskStrea
-0000b4d0: 6d50 6c75 6769 6e28 7365 6c66 2e73 6368  mPlugin(self.sch
-0000b4e0: 6564 756c 6572 2929 0a0a 2020 2020 2020  eduler))..      
-0000b4f0: 2020 636f 6d70 7574 655f 6461 7461 203d    compute_data =
-0000b500: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
-0000b510: 7469 6d65 7322 3a20 5b30 2e32 2c20 302e  times": [0.2, 0.
-0000b520: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
-0000b530: 2266 6f72 6d61 7474 6564 5f74 696d 6522  "formatted_time"
-0000b540: 3a20 5b22 302e 3220 6d73 222c 2022 322e  : ["0.2 ms", "2.
-0000b550: 3820 7573 225d 2c0a 2020 2020 2020 2020  8 us"],.        
-0000b560: 2020 2020 2261 6e67 6c65 7322 3a20 5b33      "angles": [3
-0000b570: 2e31 342c 2030 2e37 3835 5d2c 0a20 2020  .14, 0.785],.   
-0000b580: 2020 2020 2020 2020 2022 636f 6c6f 7222           "color"
-0000b590: 3a20 5b74 735f 636f 6c6f 725f 6c6f 6f6b  : [ts_color_look
-0000b5a0: 7570 5b22 7472 616e 7366 6572 225d 2c20  up["transfer"], 
-0000b5b0: 7473 5f63 6f6c 6f72 5f6c 6f6f 6b75 705b  ts_color_lookup[
-0000b5c0: 2263 6f6d 7075 7465 225d 5d2c 0a20 2020  "compute"]],.   
-0000b5d0: 2020 2020 2020 2020 2022 6e61 6d65 7322           "names"
-0000b5e0: 3a20 5b22 7375 6d22 2c20 2273 756d 5f70  : ["sum", "sum_p
-0000b5f0: 6172 7469 616c 225d 2c0a 2020 2020 2020  artial"],.      
-0000b600: 2020 7d0a 0a20 2020 2020 2020 2073 656c    }..        sel
-0000b610: 662e 636f 6d70 7574 655f 736f 7572 6365  f.compute_source
-0000b620: 203d 2043 6f6c 756d 6e44 6174 6153 6f75   = ColumnDataSou
-0000b630: 7263 6528 6461 7461 3d63 6f6d 7075 7465  rce(data=compute
-0000b640: 5f64 6174 6129 0a0a 2020 2020 2020 2020  _data)..        
-0000b650: 6669 6720 3d20 6669 6775 7265 280a 2020  fig = figure(.  
-0000b660: 2020 2020 2020 2020 2020 7469 746c 653d            title=
-0000b670: 2243 6f6d 7075 7465 2054 696d 6520 5065  "Compute Time Pe
-0000b680: 7220 5461 736b 222c 0a20 2020 2020 2020  r Task",.       
-0000b690: 2020 2020 2074 6f6f 6c73 3d22 222c 0a20       tools="",. 
-0000b6a0: 2020 2020 2020 2020 2020 206e 616d 653d             name=
-0000b6b0: 2263 6f6d 7075 7465 5f74 696d 655f 7065  "compute_time_pe
-0000b6c0: 725f 6b65 7922 2c0a 2020 2020 2020 2020  r_key",.        
-0000b6d0: 2020 2020 785f 7261 6e67 653d 5b22 6122      x_range=["a"
-0000b6e0: 2c20 2262 225d 2c0a 2020 2020 2020 2020  , "b"],.        
-0000b6f0: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
-0000b700: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0000b710: 2072 6563 7420 3d20 6669 672e 7662 6172   rect = fig.vbar
-0000b720: 280a 2020 2020 2020 2020 2020 2020 736f  (.            so
-0000b730: 7572 6365 3d73 656c 662e 636f 6d70 7574  urce=self.comput
-0000b740: 655f 736f 7572 6365 2c0a 2020 2020 2020  e_source,.      
-0000b750: 2020 2020 2020 783d 226e 616d 6573 222c        x="names",
-0000b760: 0a20 2020 2020 2020 2020 2020 2074 6f70  .            top
-0000b770: 3d22 7469 6d65 7322 2c0a 2020 2020 2020  ="times",.      
-0000b780: 2020 2020 2020 7769 6474 683d 302e 372c        width=0.7,
-0000b790: 0a20 2020 2020 2020 2020 2020 2063 6f6c  .            col
-0000b7a0: 6f72 3d22 636f 6c6f 7222 2c0a 2020 2020  or="color",.    
-0000b7b0: 2020 2020 290a 0a20 2020 2020 2020 2066      )..        f
-0000b7c0: 6967 2e79 5f72 616e 6765 2e73 7461 7274  ig.y_range.start
-0000b7d0: 203d 2030 0a20 2020 2020 2020 2066 6967   = 0.        fig
-0000b7e0: 2e79 6178 6973 2e61 7869 735f 6c61 6265  .yaxis.axis_labe
-0000b7f0: 6c20 3d20 2254 696d 6520 2873 2922 0a20  l = "Time (s)". 
-0000b800: 2020 2020 2020 2066 6967 2e79 6178 6973         fig.yaxis
-0000b810: 5b30 5d2e 666f 726d 6174 7465 7220 3d20  [0].formatter = 
-0000b820: 4e75 6d65 7261 6c54 6963 6b46 6f72 6d61  NumeralTickForma
-0000b830: 7474 6572 2866 6f72 6d61 743d 2230 2229  tter(format="0")
-0000b840: 0a20 2020 2020 2020 2066 6967 2e79 6178  .        fig.yax
-0000b850: 6973 2e74 6963 6b65 7220 3d20 4164 6170  is.ticker = Adap
-0000b860: 7469 7665 5469 636b 6572 282a 2a54 4943  tiveTicker(**TIC
-0000b870: 4b53 5f31 3032 3429 0a20 2020 2020 2020  KS_1024).       
-0000b880: 2066 6967 2e78 6178 6973 2e6d 616a 6f72   fig.xaxis.major
-0000b890: 5f6c 6162 656c 5f6f 7269 656e 7461 7469  _label_orientati
-0000b8a0: 6f6e 203d 2058 4c41 4245 4c5f 4f52 4945  on = XLABEL_ORIE
-0000b8b0: 4e54 4154 494f 4e0a 2020 2020 2020 2020  NTATION.        
-0000b8c0: 7265 6374 2e6e 6f6e 7365 6c65 6374 696f  rect.nonselectio
-0000b8d0: 6e5f 676c 7970 6820 3d20 4e6f 6e65 0a0a  n_glyph = None..
-0000b8e0: 2020 2020 2020 2020 6669 672e 7861 7869          fig.xaxi
-0000b8f0: 732e 6d69 6e6f 725f 7469 636b 5f6c 696e  s.minor_tick_lin
-0000b900: 655f 616c 7068 6120 3d20 300a 2020 2020  e_alpha = 0.    
-0000b910: 2020 2020 6669 672e 7867 7269 642e 7669      fig.xgrid.vi
-0000b920: 7369 626c 6520 3d20 4661 6c73 650a 0a20  sible = False.. 
-0000b930: 2020 2020 2020 2066 6967 2e74 6f6f 6c62         fig.toolb
-0000b940: 6172 5f6c 6f63 6174 696f 6e20 3d20 4e6f  ar_location = No
-0000b950: 6e65 0a0a 2020 2020 2020 2020 686f 7665  ne..        hove
-0000b960: 7220 3d20 486f 7665 7254 6f6f 6c28 290a  r = HoverTool().
-0000b970: 2020 2020 2020 2020 686f 7665 722e 746f          hover.to
-0000b980: 6f6c 7469 7073 203d 2022 2222 0a20 2020  oltips = """.   
-0000b990: 2020 2020 2020 2020 203c 6469 763e 0a20           <div>. 
-0000b9a0: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-0000b9b0: 703e 3c62 3e4e 616d 653a 3c2f 623e 2040  p><b>Name:</b> @
-0000b9c0: 6e61 6d65 733c 2f70 3e0a 2020 2020 2020  names</p>.      
-0000b9d0: 2020 2020 2020 2020 2020 3c70 3e3c 623e            <p><b>
-0000b9e0: 5469 6d65 3a3c 2f62 3e20 4066 6f72 6d61  Time:</b> @forma
-0000b9f0: 7474 6564 5f74 696d 653c 2f70 3e0a 2020  tted_time</p>.  
-0000ba00: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
-0000ba10: 0a20 2020 2020 2020 2020 2020 2022 2222  .            """
-0000ba20: 0a20 2020 2020 2020 2068 6f76 6572 2e70  .        hover.p
-0000ba30: 6f69 6e74 5f70 6f6c 6963 7920 3d20 2266  oint_policy = "f
-0000ba40: 6f6c 6c6f 775f 6d6f 7573 6522 0a20 2020  ollow_mouse".   
-0000ba50: 2020 2020 2066 6967 2e61 6464 5f74 6f6f       fig.add_too
-0000ba60: 6c73 2868 6f76 6572 290a 0a20 2020 2020  ls(hover)..     
-0000ba70: 2020 2066 6967 2e61 6464 5f6c 6179 6f75     fig.add_layou
-0000ba80: 7428 0a20 2020 2020 2020 2020 2020 2054  t(.            T
-0000ba90: 6974 6c65 280a 2020 2020 2020 2020 2020  itle(.          
-0000baa0: 2020 2020 2020 7465 7874 3d22 4e6f 7465        text="Note
-0000bab0: 3a20 7461 736b 7320 6c65 7373 2074 6861  : tasks less tha
-0000bac0: 6e20 3225 206f 6620 6d61 7820 6172 6520  n 2% of max are 
-0000bad0: 6e6f 7420 6469 7370 6c61 7965 6422 2c0a  not displayed",.
-0000bae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000baf0: 7465 7874 5f66 6f6e 745f 7374 796c 653d  text_font_style=
-0000bb00: 2269 7461 6c69 6322 2c0a 2020 2020 2020  "italic",.      
-0000bb10: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
-0000bb20: 2020 2020 2022 6265 6c6f 7722 2c0a 2020       "below",.  
-0000bb30: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0000bb40: 2073 656c 662e 6669 6720 3d20 6669 670a   self.fig = fig.
-0000bb50: 2020 2020 2020 2020 7461 6231 203d 2054          tab1 = T
-0000bb60: 6162 5061 6e65 6c28 6368 696c 643d 6669  abPanel(child=fi
-0000bb70: 672c 2074 6974 6c65 3d22 4261 7220 4368  g, title="Bar Ch
-0000bb80: 6172 7422 290a 0a20 2020 2020 2020 2066  art")..        f
-0000bb90: 6967 3220 3d20 6669 6775 7265 280a 2020  ig2 = figure(.  
-0000bba0: 2020 2020 2020 2020 2020 7469 746c 653d            title=
-0000bbb0: 2243 6f6d 7075 7465 2054 696d 6520 5065  "Compute Time Pe
-0000bbc0: 7220 5461 736b 222c 0a20 2020 2020 2020  r Task",.       
-0000bbd0: 2020 2020 2074 6f6f 6c73 3d22 222c 0a20       tools="",. 
-0000bbe0: 2020 2020 2020 2020 2020 206e 616d 653d             name=
-0000bbf0: 2263 6f6d 7075 7465 5f74 696d 655f 7065  "compute_time_pe
-0000bc00: 725f 6b65 792d 7069 6522 2c0a 2020 2020  r_key-pie",.    
-0000bc10: 2020 2020 2020 2020 785f 7261 6e67 653d          x_range=
-0000bc20: 282d 302e 352c 2031 2e30 292c 0a20 2020  (-0.5, 1.0),.   
-0000bc30: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
-0000bc40: 732c 0a20 2020 2020 2020 2029 0a0a 2020  s,.        )..  
-0000bc50: 2020 2020 2020 6669 6732 2e77 6564 6765        fig2.wedge
-0000bc60: 280a 2020 2020 2020 2020 2020 2020 783d  (.            x=
-0000bc70: 302c 0a20 2020 2020 2020 2020 2020 2079  0,.            y
-0000bc80: 3d31 2c0a 2020 2020 2020 2020 2020 2020  =1,.            
-0000bc90: 7261 6469 7573 3d30 2e34 2c0a 2020 2020  radius=0.4,.    
-0000bca0: 2020 2020 2020 2020 7374 6172 745f 616e          start_an
-0000bcb0: 676c 653d 6375 6d73 756d 2822 616e 676c  gle=cumsum("angl
-0000bcc0: 6573 222c 2069 6e63 6c75 6465 5f7a 6572  es", include_zer
-0000bcd0: 6f3d 5472 7565 292c 0a20 2020 2020 2020  o=True),.       
-0000bce0: 2020 2020 2065 6e64 5f61 6e67 6c65 3d63       end_angle=c
-0000bcf0: 756d 7375 6d28 2261 6e67 6c65 7322 292c  umsum("angles"),
-0000bd00: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
-0000bd10: 655f 636f 6c6f 723d 2277 6869 7465 222c  e_color="white",
-0000bd20: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
-0000bd30: 6c5f 636f 6c6f 723d 2263 6f6c 6f72 222c  l_color="color",
-0000bd40: 0a20 2020 2020 2020 2020 2020 206c 6567  .            leg
-0000bd50: 656e 645f 6669 656c 643d 226e 616d 6573  end_field="names
-0000bd60: 222c 0a20 2020 2020 2020 2020 2020 2073  ",.            s
-0000bd70: 6f75 7263 653d 7365 6c66 2e63 6f6d 7075  ource=self.compu
-0000bd80: 7465 5f73 6f75 7263 652c 0a20 2020 2020  te_source,.     
-0000bd90: 2020 2029 0a0a 2020 2020 2020 2020 6669     )..        fi
-0000bda0: 6732 2e61 7869 732e 6178 6973 5f6c 6162  g2.axis.axis_lab
-0000bdb0: 656c 203d 204e 6f6e 650a 2020 2020 2020  el = None.      
-0000bdc0: 2020 6669 6732 2e61 7869 732e 7669 7369    fig2.axis.visi
-0000bdd0: 626c 6520 3d20 4661 6c73 650a 2020 2020  ble = False.    
-0000bde0: 2020 2020 6669 6732 2e67 7269 642e 6772      fig2.grid.gr
-0000bdf0: 6964 5f6c 696e 655f 636f 6c6f 7220 3d20  id_line_color = 
-0000be00: 4e6f 6e65 0a20 2020 2020 2020 2066 6967  None.        fig
-0000be10: 322e 6164 645f 6c61 796f 7574 280a 2020  2.add_layout(.  
-0000be20: 2020 2020 2020 2020 2020 5469 746c 6528            Title(
-0000be30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000be40: 2074 6578 743d 224e 6f74 653a 2074 6173   text="Note: tas
-0000be50: 6b73 206c 6573 7320 7468 616e 2032 2520  ks less than 2% 
-0000be60: 6f66 206d 6178 2061 7265 206e 6f74 2064  of max are not d
-0000be70: 6973 706c 6179 6564 222c 0a20 2020 2020  isplayed",.     
-0000be80: 2020 2020 2020 2020 2020 2074 6578 745f             text_
-0000be90: 666f 6e74 5f73 7479 6c65 3d22 6974 616c  font_style="ital
-0000bea0: 6963 222c 0a20 2020 2020 2020 2020 2020  ic",.           
-0000beb0: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
-0000bec0: 2262 656c 6f77 222c 0a20 2020 2020 2020  "below",.       
-0000bed0: 2029 0a0a 2020 2020 2020 2020 686f 7665   )..        hove
-0000bee0: 7220 3d20 486f 7665 7254 6f6f 6c28 290a  r = HoverTool().
-0000bef0: 2020 2020 2020 2020 686f 7665 722e 746f          hover.to
-0000bf00: 6f6c 7469 7073 203d 2022 2222 0a20 2020  oltips = """.   
-0000bf10: 2020 2020 2020 2020 203c 6469 763e 0a20           <div>. 
-0000bf20: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-0000bf30: 703e 3c62 3e4e 616d 653a 3c2f 623e 2040  p><b>Name:</b> @
-0000bf40: 6e61 6d65 733c 2f70 3e0a 2020 2020 2020  names</p>.      
-0000bf50: 2020 2020 2020 2020 2020 3c70 3e3c 623e            <p><b>
-0000bf60: 5469 6d65 3a3c 2f62 3e20 4066 6f72 6d61  Time:</b> @forma
-0000bf70: 7474 6564 5f74 696d 653c 2f70 3e0a 2020  tted_time</p>.  
-0000bf80: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
-0000bf90: 0a20 2020 2020 2020 2020 2020 2022 2222  .            """
-0000bfa0: 0a20 2020 2020 2020 2068 6f76 6572 2e70  .        hover.p
-0000bfb0: 6f69 6e74 5f70 6f6c 6963 7920 3d20 2266  oint_policy = "f
-0000bfc0: 6f6c 6c6f 775f 6d6f 7573 6522 0a20 2020  ollow_mouse".   
-0000bfd0: 2020 2020 2066 6967 322e 6164 645f 746f       fig2.add_to
-0000bfe0: 6f6c 7328 686f 7665 7229 0a20 2020 2020  ols(hover).     
-0000bff0: 2020 2073 656c 662e 7765 6467 655f 6669     self.wedge_fi
-0000c000: 6720 3d20 6669 6732 0a20 2020 2020 2020  g = fig2.       
-0000c010: 2074 6162 3220 3d20 5461 6250 616e 656c   tab2 = TabPanel
-0000c020: 2863 6869 6c64 3d66 6967 322c 2074 6974  (child=fig2, tit
-0000c030: 6c65 3d22 5069 6520 4368 6172 7422 290a  le="Pie Chart").
-0000c040: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-0000c050: 6f74 203d 2054 6162 7328 7461 6273 3d5b  ot = Tabs(tabs=[
-0000c060: 7461 6231 2c20 7461 6232 5d2c 2073 697a  tab1, tab2], siz
-0000c070: 696e 675f 6d6f 6465 3d22 7374 7265 7463  ing_mode="stretc
-0000c080: 685f 626f 7468 2229 0a0a 2020 2020 4077  h_both")..    @w
-0000c090: 6974 686f 7574 5f70 726f 7065 7274 795f  ithout_property_
-0000c0a0: 7661 6c69 6461 7469 6f6e 0a20 2020 2040  validation.    @
-0000c0b0: 6c6f 675f 6572 726f 7273 0a20 2020 2064  log_errors.    d
-0000c0c0: 6566 2075 7064 6174 6528 7365 6c66 293a  ef update(self):
-0000c0d0: 0a20 2020 2020 2020 2063 6f6d 7075 7465  .        compute
-0000c0e0: 5f74 696d 6573 203d 2064 6566 6175 6c74  _times = default
-0000c0f0: 6469 6374 2866 6c6f 6174 290a 0a20 2020  dict(float)..   
-0000c100: 2020 2020 2066 6f72 206b 6579 2c20 7473       for key, ts
-0000c110: 2069 6e20 7365 6c66 2e73 6368 6564 756c   in self.schedul
-0000c120: 6572 2e74 6173 6b5f 7072 6566 6978 6573  er.task_prefixes
-0000c130: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-0000c140: 2020 2020 2020 6e61 6d65 203d 206b 6579        name = key
-0000c150: 5f73 706c 6974 286b 6579 290a 2020 2020  _split(key).    
-0000c160: 2020 2020 2020 2020 666f 7220 6163 7469          for acti
-0000c170: 6f6e 2c20 7420 696e 2074 732e 616c 6c5f  on, t in ts.all_
-0000c180: 6475 7261 7469 6f6e 732e 6974 656d 7328  durations.items(
-0000c190: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000c1a0: 2020 2069 6620 6163 7469 6f6e 203d 3d20     if action == 
-0000c1b0: 2263 6f6d 7075 7465 223a 0a20 2020 2020  "compute":.     
-0000c1c0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0000c1d0: 6f6d 7075 7465 5f74 696d 6573 5b6e 616d  ompute_times[nam
-0000c1e0: 655d 202b 3d20 740a 0a20 2020 2020 2020  e] += t..       
-0000c1f0: 2023 206f 7264 6572 2062 7920 6c61 7267   # order by larg
-0000c200: 6573 7420 7469 6d65 2066 6972 7374 0a20  est time first. 
-0000c210: 2020 2020 2020 2063 6f6d 7075 7465 5f74         compute_t
-0000c220: 696d 6573 203d 2073 6f72 7465 6428 636f  imes = sorted(co
-0000c230: 6d70 7574 655f 7469 6d65 732e 6974 656d  mpute_times.item
-0000c240: 7328 292c 206b 6579 3d6c 616d 6264 6120  s(), key=lambda 
-0000c250: 783a 2078 5b31 5d2c 2072 6576 6572 7365  x: x[1], reverse
-0000c260: 3d54 7275 6529 0a0a 2020 2020 2020 2020  =True)..        
-0000c270: 2320 6b65 6570 206f 6e6c 7920 7469 6d65  # keep only time
-0000c280: 2077 6869 6368 2061 7265 2032 2520 6f66   which are 2% of
-0000c290: 206d 6178 206f 7220 6772 6561 7465 720a   max or greater.
-0000c2a0: 2020 2020 2020 2020 6966 2063 6f6d 7075          if compu
-0000c2b0: 7465 5f74 696d 6573 3a0a 2020 2020 2020  te_times:.      
-0000c2c0: 2020 2020 2020 6d61 785f 7469 6d65 203d        max_time =
-0000c2d0: 2063 6f6d 7075 7465 5f74 696d 6573 5b30   compute_times[0
-0000c2e0: 5d5b 315d 202a 2030 2e30 320a 2020 2020  ][1] * 0.02.    
-0000c2f0: 2020 2020 2020 2020 636f 6d70 7574 655f          compute_
-0000c300: 7469 6d65 7320 3d20 5b28 6e2c 2074 2920  times = [(n, t) 
-0000c310: 666f 7220 6e2c 2074 2069 6e20 636f 6d70  for n, t in comp
-0000c320: 7574 655f 7469 6d65 7320 6966 2074 203e  ute_times if t >
-0000c330: 206d 6178 5f74 696d 655d 0a20 2020 2020   max_time].     
-0000c340: 2020 2020 2020 2063 6f6d 7075 7465 5f63         compute_c
-0000c350: 6f6c 6f72 7320 3d20 6c69 7374 2829 0a20  olors = list(). 
-0000c360: 2020 2020 2020 2020 2020 2063 6f6d 7075             compu
-0000c370: 7465 5f6e 616d 6573 203d 206c 6973 7428  te_names = list(
-0000c380: 290a 2020 2020 2020 2020 2020 2020 636f  ).            co
-0000c390: 6d70 7574 655f 7469 6d65 203d 206c 6973  mpute_time = lis
-0000c3a0: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
-0000c3b0: 746f 7461 6c5f 7469 6d65 203d 2030 0a20  total_time = 0. 
-0000c3c0: 2020 2020 2020 2020 2020 2066 6f72 206e             for n
-0000c3d0: 616d 652c 2074 2069 6e20 636f 6d70 7574  ame, t in comput
-0000c3e0: 655f 7469 6d65 733a 0a20 2020 2020 2020  e_times:.       
-0000c3f0: 2020 2020 2020 2020 2063 6f6d 7075 7465           compute
-0000c400: 5f6e 616d 6573 2e61 7070 656e 6428 6e61  _names.append(na
-0000c410: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-0000c420: 2020 2020 636f 6d70 7574 655f 636f 6c6f      compute_colo
-0000c430: 7273 2e61 7070 656e 6428 7473 5f63 6f6c  rs.append(ts_col
-0000c440: 6f72 5f6f 6628 6e61 6d65 2929 0a20 2020  or_of(name)).   
-0000c450: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
-0000c460: 7075 7465 5f74 696d 652e 6170 7065 6e64  pute_time.append
-0000c470: 2874 290a 2020 2020 2020 2020 2020 2020  (t).            
-0000c480: 2020 2020 746f 7461 6c5f 7469 6d65 202b      total_time +
-0000c490: 3d20 740a 0a20 2020 2020 2020 2020 2020  = t..           
-0000c4a0: 2061 6e67 6c65 7320 3d20 5b74 202f 2074   angles = [t / t
-0000c4b0: 6f74 616c 5f74 696d 6520 2a20 3220 2a20  otal_time * 2 * 
-0000c4c0: 6d61 7468 2e70 6920 666f 7220 7420 696e  math.pi for t in
-0000c4d0: 2063 6f6d 7075 7465 5f74 696d 655d 0a0a   compute_time]..
-0000c4e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000c4f0: 2e66 6967 2e78 5f72 616e 6765 2e66 6163  .fig.x_range.fac
-0000c500: 746f 7273 203d 2063 6f6d 7075 7465 5f6e  tors = compute_n
-0000c510: 616d 6573 0a0a 2020 2020 2020 2020 2020  ames..          
-0000c520: 2020 636f 6d70 7574 655f 7265 7375 6c74    compute_result
-0000c530: 203d 2064 6963 7428 0a20 2020 2020 2020   = dict(.       
-0000c540: 2020 2020 2020 2020 2061 6e67 6c65 733d           angles=
-0000c550: 616e 676c 6573 2c0a 2020 2020 2020 2020  angles,.        
-0000c560: 2020 2020 2020 2020 7469 6d65 733d 636f          times=co
-0000c570: 6d70 7574 655f 7469 6d65 2c0a 2020 2020  mpute_time,.    
-0000c580: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
-0000c590: 723d 636f 6d70 7574 655f 636f 6c6f 7273  r=compute_colors
-0000c5a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000c5b0: 2020 6e61 6d65 733d 636f 6d70 7574 655f    names=compute_
-0000c5c0: 6e61 6d65 732c 0a20 2020 2020 2020 2020  names,.         
-0000c5d0: 2020 2020 2020 2066 6f72 6d61 7474 6564         formatted
-0000c5e0: 5f74 696d 653d 5b66 6f72 6d61 745f 7469  _time=[format_ti
-0000c5f0: 6d65 2874 2920 666f 7220 7420 696e 2063  me(t) for t in c
-0000c600: 6f6d 7075 7465 5f74 696d 655d 2c0a 2020  ompute_time],.  
-0000c610: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-0000c620: 2020 2020 2020 2020 2075 7064 6174 6528           update(
-0000c630: 7365 6c66 2e63 6f6d 7075 7465 5f73 6f75  self.compute_sou
-0000c640: 7263 652c 2063 6f6d 7075 7465 5f72 6573  rce, compute_res
-0000c650: 756c 7429 0a0a 0a63 6c61 7373 2041 6767  ult)...class Agg
-0000c660: 7265 6761 7465 4163 7469 6f6e 2844 6173  regateAction(Das
-0000c670: 6862 6f61 7264 436f 6d70 6f6e 656e 7429  hboardComponent)
-0000c680: 3a0a 2020 2020 2222 2242 6172 2063 6861  :.    """Bar cha
-0000c690: 7274 2073 686f 7769 6e67 2074 696d 6520  rt showing time 
-0000c6a0: 7370 656e 6420 696e 2061 6374 696f 6e20  spend in action 
-0000c6b0: 6279 206b 6579 2070 7265 6669 7822 2222  by key prefix"""
-0000c6c0: 0a0a 2020 2020 406c 6f67 5f65 7272 6f72  ..    @log_error
-0000c6d0: 730a 2020 2020 6465 6620 5f5f 696e 6974  s.    def __init
-0000c6e0: 5f5f 2873 656c 662c 2073 6368 6564 756c  __(self, schedul
-0000c6f0: 6572 2c20 2a2a 6b77 6172 6773 293a 0a20  er, **kwargs):. 
-0000c700: 2020 2020 2020 2073 656c 662e 6c61 7374         self.last
-0000c710: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
-0000c720: 662e 7363 6865 6475 6c65 7220 3d20 7363  f.scheduler = sc
-0000c730: 6865 6475 6c65 720a 0a20 2020 2020 2020  heduler..       
-0000c740: 2069 6620 5461 736b 5374 7265 616d 506c   if TaskStreamPl
-0000c750: 7567 696e 2e6e 616d 6520 6e6f 7420 696e  ugin.name not in
-0000c760: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
-0000c770: 706c 7567 696e 733a 0a20 2020 2020 2020  plugins:.       
-0000c780: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
-0000c790: 6c65 722e 6164 645f 706c 7567 696e 2854  ler.add_plugin(T
-0000c7a0: 6173 6b53 7472 6561 6d50 6c75 6769 6e28  askStreamPlugin(
-0000c7b0: 7365 6c66 2e73 6368 6564 756c 6572 2929  self.scheduler))
-0000c7c0: 0a0a 2020 2020 2020 2020 6163 7469 6f6e  ..        action
-0000c7d0: 5f64 6174 6120 3d20 7b0a 2020 2020 2020  _data = {.      
-0000c7e0: 2020 2020 2020 2274 696d 6573 223a 205b        "times": [
-0000c7f0: 302e 322c 2030 2e31 5d2c 0a20 2020 2020  0.2, 0.1],.     
-0000c800: 2020 2020 2020 2022 666f 726d 6174 7465         "formatte
-0000c810: 645f 7469 6d65 223a 205b 2230 2e32 206d  d_time": ["0.2 m
-0000c820: 7322 2c20 2232 2e38 2075 7322 5d2c 0a20  s", "2.8 us"],. 
-0000c830: 2020 2020 2020 2020 2020 2022 636f 6c6f             "colo
-0000c840: 7222 3a20 5b74 735f 636f 6c6f 725f 6c6f  r": [ts_color_lo
-0000c850: 6f6b 7570 5b22 7472 616e 7366 6572 225d  okup["transfer"]
-0000c860: 2c20 7473 5f63 6f6c 6f72 5f6c 6f6f 6b75  , ts_color_looku
-0000c870: 705b 2263 6f6d 7075 7465 225d 5d2c 0a20  p["compute"]],. 
-0000c880: 2020 2020 2020 2020 2020 2022 6e61 6d65             "name
-0000c890: 7322 3a20 5b22 7472 616e 7366 6572 222c  s": ["transfer",
-0000c8a0: 2022 636f 6d70 7574 6522 5d2c 0a20 2020   "compute"],.   
-0000c8b0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0000c8c0: 7365 6c66 2e61 6374 696f 6e5f 736f 7572  self.action_sour
-0000c8d0: 6365 203d 2043 6f6c 756d 6e44 6174 6153  ce = ColumnDataS
-0000c8e0: 6f75 7263 6528 6461 7461 3d61 6374 696f  ource(data=actio
-0000c8f0: 6e5f 6461 7461 290a 0a20 2020 2020 2020  n_data)..       
-0000c900: 2073 656c 662e 726f 6f74 203d 2066 6967   self.root = fig
-0000c910: 7572 6528 0a20 2020 2020 2020 2020 2020  ure(.           
-0000c920: 2074 6974 6c65 3d22 4167 6772 6567 6174   title="Aggregat
-0000c930: 6520 5065 7220 4163 7469 6f6e 222c 0a20  e Per Action",. 
-0000c940: 2020 2020 2020 2020 2020 2074 6f6f 6c73             tools
-0000c950: 3d22 222c 0a20 2020 2020 2020 2020 2020  ="",.           
-0000c960: 206e 616d 653d 2261 6767 7265 6761 7465   name="aggregate
-0000c970: 5f70 6572 5f61 6374 696f 6e22 2c0a 2020  _per_action",.  
-0000c980: 2020 2020 2020 2020 2020 785f 7261 6e67            x_rang
-0000c990: 653d 5b22 6122 2c20 2262 225d 2c0a 2020  e=["a", "b"],.  
-0000c9a0: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
-0000c9b0: 6773 2c0a 2020 2020 2020 2020 290a 0a20  gs,.        ).. 
-0000c9c0: 2020 2020 2020 2072 6563 7420 3d20 7365         rect = se
-0000c9d0: 6c66 2e72 6f6f 742e 7662 6172 280a 2020  lf.root.vbar(.  
-0000c9e0: 2020 2020 2020 2020 2020 736f 7572 6365            source
-0000c9f0: 3d73 656c 662e 6163 7469 6f6e 5f73 6f75  =self.action_sou
-0000ca00: 7263 652c 0a20 2020 2020 2020 2020 2020  rce,.           
-0000ca10: 2078 3d22 6e61 6d65 7322 2c0a 2020 2020   x="names",.    
-0000ca20: 2020 2020 2020 2020 746f 703d 2274 696d          top="tim
-0000ca30: 6573 222c 0a20 2020 2020 2020 2020 2020  es",.           
-0000ca40: 2077 6964 7468 3d30 2e37 2c0a 2020 2020   width=0.7,.    
-0000ca50: 2020 2020 2020 2020 636f 6c6f 723d 2263          color="c
-0000ca60: 6f6c 6f72 222c 0a20 2020 2020 2020 2029  olor",.        )
-0000ca70: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
-0000ca80: 6f6f 742e 795f 7261 6e67 652e 7374 6172  oot.y_range.star
-0000ca90: 7420 3d20 300a 2020 2020 2020 2020 7365  t = 0.        se
-0000caa0: 6c66 2e72 6f6f 742e 7961 7869 735b 305d  lf.root.yaxis[0]
-0000cab0: 2e66 6f72 6d61 7474 6572 203d 204e 756d  .formatter = Num
-0000cac0: 6572 616c 5469 636b 466f 726d 6174 7465  eralTickFormatte
-0000cad0: 7228 666f 726d 6174 3d22 3022 290a 2020  r(format="0").  
-0000cae0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-0000caf0: 7961 7869 732e 6178 6973 5f6c 6162 656c  yaxis.axis_label
-0000cb00: 203d 2022 5469 6d65 2028 7329 220a 2020   = "Time (s)".  
-0000cb10: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-0000cb20: 7961 7869 732e 7469 636b 6572 203d 2041  yaxis.ticker = A
-0000cb30: 6461 7074 6976 6554 6963 6b65 7228 2a2a  daptiveTicker(**
-0000cb40: 5449 434b 535f 3130 3234 290a 2020 2020  TICKS_1024).    
-0000cb50: 2020 2020 7365 6c66 2e72 6f6f 742e 7861      self.root.xa
-0000cb60: 7869 732e 6d61 6a6f 725f 6c61 6265 6c5f  xis.major_label_
-0000cb70: 6f72 6965 6e74 6174 696f 6e20 3d20 584c  orientation = XL
-0000cb80: 4142 454c 5f4f 5249 454e 5441 5449 4f4e  ABEL_ORIENTATION
-0000cb90: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-0000cba0: 6f74 2e78 6178 6973 2e6d 616a 6f72 5f6c  ot.xaxis.major_l
-0000cbb0: 6162 656c 5f74 6578 745f 666f 6e74 5f73  abel_text_font_s
-0000cbc0: 697a 6520 3d20 2231 3670 7822 0a20 2020  ize = "16px".   
-0000cbd0: 2020 2020 2072 6563 742e 6e6f 6e73 656c       rect.nonsel
-0000cbe0: 6563 7469 6f6e 5f67 6c79 7068 203d 204e  ection_glyph = N
-0000cbf0: 6f6e 650a 0a20 2020 2020 2020 2073 656c  one..        sel
-0000cc00: 662e 726f 6f74 2e78 6178 6973 2e6d 696e  f.root.xaxis.min
-0000cc10: 6f72 5f74 6963 6b5f 6c69 6e65 5f61 6c70  or_tick_line_alp
-0000cc20: 6861 203d 2030 0a20 2020 2020 2020 2073  ha = 0.        s
-0000cc30: 656c 662e 726f 6f74 2e78 6772 6964 2e76  elf.root.xgrid.v
-0000cc40: 6973 6962 6c65 203d 2046 616c 7365 0a0a  isible = False..
-0000cc50: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-0000cc60: 742e 746f 6f6c 6261 725f 6c6f 6361 7469  t.toolbar_locati
-0000cc70: 6f6e 203d 204e 6f6e 650a 0a20 2020 2020  on = None..     
-0000cc80: 2020 2068 6f76 6572 203d 2048 6f76 6572     hover = Hover
-0000cc90: 546f 6f6c 2829 0a20 2020 2020 2020 2068  Tool().        h
-0000cca0: 6f76 6572 2e74 6f6f 6c74 6970 7320 3d20  over.tooltips = 
-0000ccb0: 2222 220a 2020 2020 2020 2020 2020 2020  """.            
-0000ccc0: 3c64 6976 3e0a 2020 2020 2020 2020 2020  <div>.          
-0000ccd0: 2020 2020 2020 3c70 3e3c 623e 4e61 6d65        <p><b>Name
-0000cce0: 3a3c 2f62 3e20 406e 616d 6573 3c2f 703e  :</b> @names</p>
-0000ccf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000cd00: 203c 703e 3c62 3e54 696d 653a 3c2f 623e   <p><b>Time:</b>
-0000cd10: 2040 666f 726d 6174 7465 645f 7469 6d65   @formatted_time
-0000cd20: 3c2f 703e 0a20 2020 2020 2020 2020 2020  </p>.           
-0000cd30: 203c 2f64 6976 3e0a 2020 2020 2020 2020   </div>.        
-0000cd40: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0000cd50: 686f 7665 722e 706f 696e 745f 706f 6c69  hover.point_poli
-0000cd60: 6379 203d 2022 666f 6c6c 6f77 5f6d 6f75  cy = "follow_mou
-0000cd70: 7365 220a 2020 2020 2020 2020 7365 6c66  se".        self
-0000cd80: 2e72 6f6f 742e 6164 645f 746f 6f6c 7328  .root.add_tools(
-0000cd90: 686f 7665 7229 0a0a 2020 2020 4077 6974  hover)..    @wit
-0000cda0: 686f 7574 5f70 726f 7065 7274 795f 7661  hout_property_va
-0000cdb0: 6c69 6461 7469 6f6e 0a20 2020 2040 6c6f  lidation.    @lo
-0000cdc0: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
-0000cdd0: 2075 7064 6174 6528 7365 6c66 293a 0a20   update(self):. 
-0000cde0: 2020 2020 2020 2061 6767 5f74 696d 6573         agg_times
-0000cdf0: 203d 2064 6566 6175 6c74 6469 6374 2866   = defaultdict(f
-0000ce00: 6c6f 6174 290a 0a20 2020 2020 2020 2066  loat)..        f
-0000ce10: 6f72 2074 7320 696e 2073 656c 662e 7363  or ts in self.sc
-0000ce20: 6865 6475 6c65 722e 7461 736b 5f70 7265  heduler.task_pre
-0000ce30: 6669 7865 732e 7661 6c75 6573 2829 3a0a  fixes.values():.
-0000ce40: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000ce50: 6163 7469 6f6e 2c20 7420 696e 2074 732e  action, t in ts.
-0000ce60: 616c 6c5f 6475 7261 7469 6f6e 732e 6974  all_durations.it
-0000ce70: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
-0000ce80: 2020 2020 2020 2061 6767 5f74 696d 6573         agg_times
-0000ce90: 5b61 6374 696f 6e5d 202b 3d20 740a 0a20  [action] += t.. 
-0000cea0: 2020 2020 2020 2023 206f 7264 6572 2062         # order b
-0000ceb0: 7920 6c61 7267 6573 7420 7469 6d65 2066  y largest time f
-0000cec0: 6972 7374 0a20 2020 2020 2020 2061 6767  irst.        agg
-0000ced0: 5f74 696d 6573 203d 2073 6f72 7465 6428  _times = sorted(
-0000cee0: 6167 675f 7469 6d65 732e 6974 656d 7328  agg_times.items(
-0000cef0: 292c 206b 6579 3d6c 616d 6264 6120 783a  ), key=lambda x:
-0000cf00: 2078 5b31 5d2c 2072 6576 6572 7365 3d54   x[1], reverse=T
-0000cf10: 7275 6529 0a0a 2020 2020 2020 2020 6167  rue)..        ag
-0000cf20: 675f 636f 6c6f 7273 203d 206c 6973 7428  g_colors = list(
-0000cf30: 290a 2020 2020 2020 2020 6167 675f 6e61  ).        agg_na
-0000cf40: 6d65 7320 3d20 6c69 7374 2829 0a20 2020  mes = list().   
-0000cf50: 2020 2020 2061 6767 5f74 696d 6520 3d20       agg_time = 
-0000cf60: 6c69 7374 2829 0a20 2020 2020 2020 2066  list().        f
-0000cf70: 6f72 2061 6374 696f 6e2c 2074 2069 6e20  or action, t in 
-0000cf80: 6167 675f 7469 6d65 733a 0a20 2020 2020  agg_times:.     
-0000cf90: 2020 2020 2020 2061 6767 5f6e 616d 6573         agg_names
-0000cfa0: 2e61 7070 656e 6428 6163 7469 6f6e 290a  .append(action).
-0000cfb0: 2020 2020 2020 2020 2020 2020 6966 2061              if a
-0000cfc0: 6374 696f 6e20 3d3d 2022 636f 6d70 7574  ction == "comput
-0000cfd0: 6522 3a0a 2020 2020 2020 2020 2020 2020  e":.            
-0000cfe0: 2020 2020 6167 675f 636f 6c6f 7273 2e61      agg_colors.a
-0000cff0: 7070 656e 6428 2270 7572 706c 6522 290a  ppend("purple").
-0000d000: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0000d010: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000d020: 2020 6167 675f 636f 6c6f 7273 2e61 7070    agg_colors.app
-0000d030: 656e 6428 7473 5f63 6f6c 6f72 5f6c 6f6f  end(ts_color_loo
-0000d040: 6b75 705b 6163 7469 6f6e 5d29 0a20 2020  kup[action]).   
-0000d050: 2020 2020 2020 2020 2061 6767 5f74 696d           agg_tim
-0000d060: 652e 6170 7065 6e64 2874 290a 0a20 2020  e.append(t)..   
-0000d070: 2020 2020 2073 656c 662e 726f 6f74 2e78       self.root.x
-0000d080: 5f72 616e 6765 2e66 6163 746f 7273 203d  _range.factors =
-0000d090: 2061 6767 5f6e 616d 6573 0a20 2020 2020   agg_names.     
-0000d0a0: 2020 2073 656c 662e 726f 6f74 2e74 6974     self.root.tit
-0000d0b0: 6c65 2e74 6578 7420 3d20 2241 6767 7265  le.text = "Aggre
-0000d0c0: 6761 7465 2054 696d 6520 5065 7220 4163  gate Time Per Ac
-0000d0d0: 7469 6f6e 220a 0a20 2020 2020 2020 2061  tion"..        a
-0000d0e0: 6374 696f 6e5f 7265 7375 6c74 203d 2064  ction_result = d
-0000d0f0: 6963 7428 0a20 2020 2020 2020 2020 2020  ict(.           
-0000d100: 2074 696d 6573 3d61 6767 5f74 696d 652c   times=agg_time,
-0000d110: 0a20 2020 2020 2020 2020 2020 2063 6f6c  .            col
-0000d120: 6f72 3d61 6767 5f63 6f6c 6f72 732c 0a20  or=agg_colors,. 
-0000d130: 2020 2020 2020 2020 2020 206e 616d 6573             names
-0000d140: 3d61 6767 5f6e 616d 6573 2c0a 2020 2020  =agg_names,.    
-0000d150: 2020 2020 2020 2020 666f 726d 6174 7465          formatte
-0000d160: 645f 7469 6d65 3d5b 666f 726d 6174 5f74  d_time=[format_t
-0000d170: 696d 6528 7429 2066 6f72 2074 2069 6e20  ime(t) for t in 
-0000d180: 6167 675f 7469 6d65 5d2c 0a20 2020 2020  agg_time],.     
-0000d190: 2020 2029 0a0a 2020 2020 2020 2020 7570     )..        up
-0000d1a0: 6461 7465 2873 656c 662e 6163 7469 6f6e  date(self.action
-0000d1b0: 5f73 6f75 7263 652c 2061 6374 696f 6e5f  _source, action_
-0000d1c0: 7265 7375 6c74 290a 0a0a 636c 6173 7320  result)...class 
-0000d1d0: 4d65 6d6f 7279 4279 4b65 7928 4461 7368  MemoryByKey(Dash
-0000d1e0: 626f 6172 6443 6f6d 706f 6e65 6e74 293a  boardComponent):
-0000d1f0: 0a20 2020 2022 2222 4261 7220 6368 6172  .    """Bar char
-0000d200: 7420 7368 6f77 696e 6720 6d65 6d6f 7279  t showing memory
-0000d210: 2075 7365 2062 7920 6b65 7920 7072 6566   use by key pref
-0000d220: 6978 2222 220a 0a20 2020 2040 6c6f 675f  ix"""..    @log_
-0000d230: 6572 726f 7273 0a20 2020 2064 6566 205f  errors.    def _
-0000d240: 5f69 6e69 745f 5f28 7365 6c66 2c20 7363  _init__(self, sc
-0000d250: 6865 6475 6c65 722c 202a 2a6b 7761 7267  heduler, **kwarg
-0000d260: 7329 3a0a 2020 2020 2020 2020 7365 6c66  s):.        self
-0000d270: 2e6c 6173 7420 3d20 300a 2020 2020 2020  .last = 0.      
-0000d280: 2020 7365 6c66 2e73 6368 6564 756c 6572    self.scheduler
-0000d290: 203d 2073 6368 6564 756c 6572 0a20 2020   = scheduler.   
-0000d2a0: 2020 2020 2073 656c 662e 736f 7572 6365       self.source
-0000d2b0: 203d 2043 6f6c 756d 6e44 6174 6153 6f75   = ColumnDataSou
-0000d2c0: 7263 6528 0a20 2020 2020 2020 2020 2020  rce(.           
-0000d2d0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0000d2e0: 2020 2022 6e61 6d65 223a 205b 2261 222c     "name": ["a",
-0000d2f0: 2022 6222 5d2c 0a20 2020 2020 2020 2020   "b"],.         
-0000d300: 2020 2020 2020 2022 6e62 7974 6573 223a         "nbytes":
-0000d310: 205b 3130 302c 2031 3030 305d 2c0a 2020   [100, 1000],.  
-0000d320: 2020 2020 2020 2020 2020 2020 2020 2263                "c
-0000d330: 6f75 6e74 223a 205b 312c 2032 5d2c 0a20  ount": [1, 2],. 
-0000d340: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000d350: 636f 6c6f 7222 3a20 5b22 626c 7565 222c  color": ["blue",
-0000d360: 2022 626c 7565 225d 2c0a 2020 2020 2020   "blue"],.      
-0000d370: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0000d380: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0000d390: 726f 6f74 203d 2066 6967 7572 6528 0a20  root = figure(. 
-0000d3a0: 2020 2020 2020 2020 2020 2074 6974 6c65             title
-0000d3b0: 3d22 4d65 6d6f 7279 2055 7365 222c 0a20  ="Memory Use",. 
-0000d3c0: 2020 2020 2020 2020 2020 2074 6f6f 6c73             tools
-0000d3d0: 3d22 222c 0a20 2020 2020 2020 2020 2020  ="",.           
-0000d3e0: 206e 616d 653d 226d 656d 6f72 795f 6279   name="memory_by
-0000d3f0: 5f6b 6579 222c 0a20 2020 2020 2020 2020  _key",.         
-0000d400: 2020 2078 5f72 616e 6765 3d5b 2261 222c     x_range=["a",
-0000d410: 2022 6222 5d2c 0a20 2020 2020 2020 2020   "b"],.         
-0000d420: 2020 202a 2a6b 7761 7267 732c 0a20 2020     **kwargs,.   
-0000d430: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
-0000d440: 6563 7420 3d20 7365 6c66 2e72 6f6f 742e  ect = self.root.
-0000d450: 7662 6172 280a 2020 2020 2020 2020 2020  vbar(.          
-0000d460: 2020 736f 7572 6365 3d73 656c 662e 736f    source=self.so
-0000d470: 7572 6365 2c20 783d 226e 616d 6522 2c20  urce, x="name", 
-0000d480: 746f 703d 226e 6279 7465 7322 2c20 7769  top="nbytes", wi
-0000d490: 6474 683d 302e 392c 2063 6f6c 6f72 3d22  dth=0.9, color="
-0000d4a0: 636f 6c6f 7222 0a20 2020 2020 2020 2029  color".        )
-0000d4b0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-0000d4c0: 6f74 2e79 6178 6973 5b30 5d2e 666f 726d  ot.yaxis[0].form
-0000d4d0: 6174 7465 7220 3d20 4e75 6d65 7261 6c54  atter = NumeralT
-0000d4e0: 6963 6b46 6f72 6d61 7474 6572 2866 6f72  ickFormatter(for
-0000d4f0: 6d61 743d 2230 2e30 2062 2229 0a20 2020  mat="0.0 b").   
-0000d500: 2020 2020 2073 656c 662e 726f 6f74 2e79       self.root.y
-0000d510: 6178 6973 2e74 6963 6b65 7220 3d20 4164  axis.ticker = Ad
-0000d520: 6170 7469 7665 5469 636b 6572 282a 2a54  aptiveTicker(**T
-0000d530: 4943 4b53 5f31 3032 3429 0a20 2020 2020  ICKS_1024).     
-0000d540: 2020 2073 656c 662e 726f 6f74 2e78 6178     self.root.xax
-0000d550: 6973 2e6d 616a 6f72 5f6c 6162 656c 5f6f  is.major_label_o
-0000d560: 7269 656e 7461 7469 6f6e 203d 2058 4c41  rientation = XLA
-0000d570: 4245 4c5f 4f52 4945 4e54 4154 494f 4e0a  BEL_ORIENTATION.
-0000d580: 2020 2020 2020 2020 7265 6374 2e6e 6f6e          rect.non
-0000d590: 7365 6c65 6374 696f 6e5f 676c 7970 6820  selection_glyph 
-0000d5a0: 3d20 4e6f 6e65 0a0a 2020 2020 2020 2020  = None..        
-0000d5b0: 7365 6c66 2e72 6f6f 742e 7861 7869 732e  self.root.xaxis.
-0000d5c0: 6d69 6e6f 725f 7469 636b 5f6c 696e 655f  minor_tick_line_
-0000d5d0: 616c 7068 6120 3d20 300a 2020 2020 2020  alpha = 0.      
-0000d5e0: 2020 7365 6c66 2e72 6f6f 742e 7967 7269    self.root.ygri
-0000d5f0: 642e 7669 7369 626c 6520 3d20 4661 6c73  d.visible = Fals
-0000d600: 650a 0a20 2020 2020 2020 2073 656c 662e  e..        self.
-0000d610: 726f 6f74 2e74 6f6f 6c62 6172 5f6c 6f63  root.toolbar_loc
-0000d620: 6174 696f 6e20 3d20 4e6f 6e65 0a0a 2020  ation = None..  
-0000d630: 2020 2020 2020 686f 7665 7220 3d20 486f        hover = Ho
-0000d640: 7665 7254 6f6f 6c28 290a 2020 2020 2020  verTool().      
-0000d650: 2020 686f 7665 722e 746f 6f6c 7469 7073    hover.tooltips
-0000d660: 203d 2022 406e 616d 653a 2040 6e62 7974   = "@name: @nbyt
-0000d670: 6573 5f74 6578 7422 0a20 2020 2020 2020  es_text".       
-0000d680: 2068 6f76 6572 2e74 6f6f 6c74 6970 7320   hover.tooltips 
-0000d690: 3d20 2222 220a 2020 2020 2020 2020 2020  = """.          
-0000d6a0: 2020 3c64 6976 3e0a 2020 2020 2020 2020    <div>.        
-0000d6b0: 2020 2020 2020 2020 3c70 3e3c 623e 4e61          <p><b>Na
-0000d6c0: 6d65 3a3c 2f62 3e20 406e 616d 653c 2f70  me:</b> @name</p
-0000d6d0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-0000d6e0: 2020 3c70 3e3c 623e 4279 7465 733a 3c2f    <p><b>Bytes:</
-0000d6f0: 623e 2040 6e62 7974 6573 5f74 6578 7420  b> @nbytes_text 
-0000d700: 3c2f 703e 0a20 2020 2020 2020 2020 2020  </p>.           
-0000d710: 2020 2020 203c 703e 3c62 3e43 6f75 6e74       <p><b>Count
-0000d720: 3a3c 2f62 3e20 4063 6f75 6e74 206f 626a  :</b> @count obj
-0000d730: 6563 7473 203c 2f70 3e0a 2020 2020 2020  ects </p>.      
-0000d740: 2020 2020 2020 3c2f 6469 763e 0a20 2020        </div>.   
-0000d750: 2020 2020 2020 2020 2022 2222 0a20 2020           """.   
-0000d760: 2020 2020 2068 6f76 6572 2e70 6f69 6e74       hover.point
-0000d770: 5f70 6f6c 6963 7920 3d20 2266 6f6c 6c6f  _policy = "follo
-0000d780: 775f 6d6f 7573 6522 0a20 2020 2020 2020  w_mouse".       
-0000d790: 2073 656c 662e 726f 6f74 2e61 6464 5f74   self.root.add_t
-0000d7a0: 6f6f 6c73 2868 6f76 6572 290a 0a20 2020  ools(hover)..   
-0000d7b0: 2040 7769 7468 6f75 745f 7072 6f70 6572   @without_proper
-0000d7c0: 7479 5f76 616c 6964 6174 696f 6e0a 2020  ty_validation.  
-0000d7d0: 2020 406c 6f67 5f65 7272 6f72 730a 2020    @log_errors.  
-0000d7e0: 2020 6465 6620 7570 6461 7465 2873 656c    def update(sel
-0000d7f0: 6629 3a0a 2020 2020 2020 2020 636f 756e  f):.        coun
-0000d800: 7473 203d 2064 6566 6175 6c74 6469 6374  ts = defaultdict
-0000d810: 2869 6e74 290a 2020 2020 2020 2020 6e62  (int).        nb
-0000d820: 7974 6573 203d 2064 6566 6175 6c74 6469  ytes = defaultdi
-0000d830: 6374 2869 6e74 290a 2020 2020 2020 2020  ct(int).        
-0000d840: 666f 7220 7773 2069 6e20 7365 6c66 2e73  for ws in self.s
-0000d850: 6368 6564 756c 6572 2e77 6f72 6b65 7273  cheduler.workers
-0000d860: 2e76 616c 7565 7328 293a 0a20 2020 2020  .values():.     
-0000d870: 2020 2020 2020 2066 6f72 2074 7320 696e         for ts in
-0000d880: 2077 732e 6861 735f 7768 6174 3a0a 2020   ws.has_what:.  
-0000d890: 2020 2020 2020 2020 2020 2020 2020 6b73                ks
-0000d8a0: 203d 206b 6579 5f73 706c 6974 2874 732e   = key_split(ts.
-0000d8b0: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
-0000d8c0: 2020 2020 2063 6f75 6e74 735b 6b73 5d20       counts[ks] 
-0000d8d0: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
-0000d8e0: 2020 2020 206e 6279 7465 735b 6b73 5d20       nbytes[ks] 
-0000d8f0: 2b3d 2074 732e 6e62 7974 6573 0a0a 2020  += ts.nbytes..  
-0000d900: 2020 2020 2020 6e61 6d65 7320 3d20 6c69        names = li
-0000d910: 7374 2873 6f72 7465 6428 636f 756e 7473  st(sorted(counts
-0000d920: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-0000d930: 726f 6f74 2e78 5f72 616e 6765 2e66 6163  root.x_range.fac
-0000d940: 746f 7273 203d 206e 616d 6573 0a20 2020  tors = names.   
-0000d950: 2020 2020 2072 6573 756c 7420 3d20 7b0a       result = {.
-0000d960: 2020 2020 2020 2020 2020 2020 226e 616d              "nam
-0000d970: 6522 3a20 6e61 6d65 732c 0a20 2020 2020  e": names,.     
-0000d980: 2020 2020 2020 2022 636f 756e 7422 3a20         "count": 
-0000d990: 5b63 6f75 6e74 735b 6e61 6d65 5d20 666f  [counts[name] fo
-0000d9a0: 7220 6e61 6d65 2069 6e20 6e61 6d65 735d  r name in names]
-0000d9b0: 2c0a 2020 2020 2020 2020 2020 2020 226e  ,.            "n
-0000d9c0: 6279 7465 7322 3a20 5b6e 6279 7465 735b  bytes": [nbytes[
-0000d9d0: 6e61 6d65 5d20 666f 7220 6e61 6d65 2069  name] for name i
-0000d9e0: 6e20 6e61 6d65 735d 2c0a 2020 2020 2020  n names],.      
-0000d9f0: 2020 2020 2020 226e 6279 7465 735f 7465        "nbytes_te
-0000da00: 7874 223a 205b 666f 726d 6174 5f62 7974  xt": [format_byt
-0000da10: 6573 286e 6279 7465 735b 6e61 6d65 5d29  es(nbytes[name])
-0000da20: 2066 6f72 206e 616d 6520 696e 206e 616d   for name in nam
-0000da30: 6573 5d2c 0a20 2020 2020 2020 2020 2020  es],.           
-0000da40: 2022 636f 6c6f 7222 3a20 5b63 6f6c 6f72   "color": [color
-0000da50: 5f6f 6628 6e61 6d65 2920 666f 7220 6e61  _of(name) for na
-0000da60: 6d65 2069 6e20 6e61 6d65 735d 2c0a 2020  me in names],.  
-0000da70: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0000da80: 7365 6c66 2e72 6f6f 742e 7469 746c 652e  self.root.title.
-0000da90: 7465 7874 203d 2022 546f 7461 6c20 5573  text = "Total Us
-0000daa0: 653a 2022 202b 2066 6f72 6d61 745f 6279  e: " + format_by
-0000dab0: 7465 7328 7375 6d28 6e62 7974 6573 2e76  tes(sum(nbytes.v
-0000dac0: 616c 7565 7328 2929 290a 0a20 2020 2020  alues()))..     
-0000dad0: 2020 2075 7064 6174 6528 7365 6c66 2e73     update(self.s
-0000dae0: 6f75 7263 652c 2072 6573 756c 7429 0a0a  ource, result)..
-0000daf0: 0a63 6c61 7373 2043 7572 7265 6e74 4c6f  .class CurrentLo
-0000db00: 6164 2844 6173 6862 6f61 7264 436f 6d70  ad(DashboardComp
-0000db10: 6f6e 656e 7429 3a0a 2020 2020 2222 2254  onent):.    """T
-0000db20: 6173 6b73 2061 6e64 2043 5055 2075 7361  asks and CPU usa
-0000db30: 6765 206f 6e20 6561 6368 2077 6f72 6b65  ge on each worke
-0000db40: 7222 2222 0a0a 2020 2020 406c 6f67 5f65  r"""..    @log_e
-0000db50: 7272 6f72 730a 2020 2020 6465 6620 5f5f  rrors.    def __
-0000db60: 696e 6974 5f5f 2873 656c 662c 2073 6368  init__(self, sch
-0000db70: 6564 756c 6572 2c20 7769 6474 683d 3630  eduler, width=60
-0000db80: 302c 202a 2a6b 7761 7267 7329 3a0a 2020  0, **kwargs):.  
-0000db90: 2020 2020 2020 7365 6c66 2e6c 6173 7420        self.last 
-0000dba0: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
-0000dbb0: 2e73 6368 6564 756c 6572 203d 2073 6368  .scheduler = sch
-0000dbc0: 6564 756c 6572 0a20 2020 2020 2020 2073  eduler.        s
-0000dbd0: 656c 662e 736f 7572 6365 203d 2043 6f6c  elf.source = Col
-0000dbe0: 756d 6e44 6174 6153 6f75 7263 6528 0a20  umnDataSource(. 
-0000dbf0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-0000dc00: 2020 2020 2020 2020 2020 2020 2022 6e70               "np
-0000dc10: 726f 6365 7373 696e 6722 3a20 5b5d 2c0a  rocessing": [],.
-0000dc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dc30: 226e 7072 6f63 6573 7369 6e67 2d68 616c  "nprocessing-hal
-0000dc40: 6622 3a20 5b5d 2c0a 2020 2020 2020 2020  f": [],.        
-0000dc50: 2020 2020 2020 2020 226e 7072 6f63 6573          "nproces
-0000dc60: 7369 6e67 2d63 6f6c 6f72 223a 205b 5d2c  sing-color": [],
-0000dc70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000dc80: 2022 6370 7522 3a20 5b5d 2c0a 2020 2020   "cpu": [],.    
-0000dc90: 2020 2020 2020 2020 2020 2020 2263 7075              "cpu
-0000dca0: 2d68 616c 6622 3a20 5b5d 2c0a 2020 2020  -half": [],.    
-0000dcb0: 2020 2020 2020 2020 2020 2020 2279 223a              "y":
-0000dcc0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-0000dcd0: 2020 2020 2022 776f 726b 6572 223a 205b       "worker": [
-0000dce0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-0000dcf0: 2020 2022 6573 6361 7065 645f 776f 726b     "escaped_work
-0000dd00: 6572 223a 205b 5d2c 0a20 2020 2020 2020  er": [],.       
-0000dd10: 2020 2020 207d 0a20 2020 2020 2020 2029       }.        )
-0000dd20: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
-0000dd30: 696e 6720 3d20 6669 6775 7265 280a 2020  ing = figure(.  
-0000dd40: 2020 2020 2020 2020 2020 7469 746c 653d            title=
-0000dd50: 2254 6173 6b73 2050 726f 6365 7373 696e  "Tasks Processin
-0000dd60: 6722 2c0a 2020 2020 2020 2020 2020 2020  g",.            
-0000dd70: 746f 6f6c 733d 2222 2c0a 2020 2020 2020  tools="",.      
-0000dd80: 2020 2020 2020 6e61 6d65 3d22 7072 6f63        name="proc
-0000dd90: 6573 7369 6e67 222c 0a20 2020 2020 2020  essing",.       
-0000dda0: 2020 2020 2077 6964 7468 3d69 6e74 2877       width=int(w
-0000ddb0: 6964 7468 202f 2032 292c 0a20 2020 2020  idth / 2),.     
-0000ddc0: 2020 2020 2020 206d 696e 5f62 6f72 6465         min_borde
-0000ddd0: 725f 626f 7474 6f6d 3d35 302c 0a20 2020  r_bottom=50,.   
-0000dde0: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
-0000ddf0: 732c 0a20 2020 2020 2020 2029 0a20 2020  s,.        ).   
-0000de00: 2020 2020 2072 6563 7420 3d20 7072 6f63       rect = proc
-0000de10: 6573 7369 6e67 2e72 6563 7428 0a20 2020  essing.rect(.   
-0000de20: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
-0000de30: 7365 6c66 2e73 6f75 7263 652c 0a20 2020  self.source,.   
-0000de40: 2020 2020 2020 2020 2078 3d22 6e70 726f           x="npro
-0000de50: 6365 7373 696e 672d 6861 6c66 222c 0a20  cessing-half",. 
-0000de60: 2020 2020 2020 2020 2020 2079 3d22 7922             y="y"
-0000de70: 2c0a 2020 2020 2020 2020 2020 2020 7769  ,.            wi
-0000de80: 6474 683d 226e 7072 6f63 6573 7369 6e67  dth="nprocessing
-0000de90: 222c 0a20 2020 2020 2020 2020 2020 2068  ",.            h
-0000dea0: 6569 6768 743d 302e 392c 0a20 2020 2020  eight=0.9,.     
-0000deb0: 2020 2020 2020 2063 6f6c 6f72 3d22 6e70         color="np
-0000dec0: 726f 6365 7373 696e 672d 636f 6c6f 7222  rocessing-color"
-0000ded0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-0000dee0: 2020 2020 7072 6f63 6573 7369 6e67 2e78      processing.x
-0000def0: 5f72 616e 6765 2e73 7461 7274 203d 2030  _range.start = 0
-0000df00: 0a20 2020 2020 2020 2072 6563 742e 6e6f  .        rect.no
-0000df10: 6e73 656c 6563 7469 6f6e 5f67 6c79 7068  nselection_glyph
-0000df20: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
-0000df30: 2063 7075 203d 2066 6967 7572 6528 0a20   cpu = figure(. 
-0000df40: 2020 2020 2020 2020 2020 2074 6974 6c65             title
-0000df50: 3d22 4350 5520 5574 696c 697a 6174 696f  ="CPU Utilizatio
-0000df60: 6e22 2c0a 2020 2020 2020 2020 2020 2020  n",.            
-0000df70: 746f 6f6c 733d 2222 2c0a 2020 2020 2020  tools="",.      
-0000df80: 2020 2020 2020 7769 6474 683d 696e 7428        width=int(
-0000df90: 7769 6474 6820 2f20 3229 2c0a 2020 2020  width / 2),.    
-0000dfa0: 2020 2020 2020 2020 6e61 6d65 3d22 6370          name="cp
-0000dfb0: 755f 6869 7374 222c 0a20 2020 2020 2020  u_hist",.       
-0000dfc0: 2020 2020 2078 5f72 616e 6765 3d28 302c       x_range=(0,
-0000dfd0: 2031 3030 292c 0a20 2020 2020 2020 2020   100),.         
-0000dfe0: 2020 206d 696e 5f62 6f72 6465 725f 626f     min_border_bo
-0000dff0: 7474 6f6d 3d35 302c 0a20 2020 2020 2020  ttom=50,.       
-0000e000: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
-0000e010: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000e020: 2072 6563 7420 3d20 6370 752e 7265 6374   rect = cpu.rect
-0000e030: 280a 2020 2020 2020 2020 2020 2020 736f  (.            so
-0000e040: 7572 6365 3d73 656c 662e 736f 7572 6365  urce=self.source
-0000e050: 2c0a 2020 2020 2020 2020 2020 2020 783d  ,.            x=
-0000e060: 2263 7075 2d68 616c 6622 2c0a 2020 2020  "cpu-half",.    
-0000e070: 2020 2020 2020 2020 793d 2279 222c 0a20          y="y",. 
-0000e080: 2020 2020 2020 2020 2020 2077 6964 7468             width
-0000e090: 3d22 6370 7522 2c0a 2020 2020 2020 2020  ="cpu",.        
-0000e0a0: 2020 2020 6865 6967 6874 3d30 2e39 2c0a      height=0.9,.
-0000e0b0: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
-0000e0c0: 723d 2262 6c75 6522 2c0a 2020 2020 2020  r="blue",.      
-0000e0d0: 2020 290a 2020 2020 2020 2020 7265 6374    ).        rect
-0000e0e0: 2e6e 6f6e 7365 6c65 6374 696f 6e5f 676c  .nonselection_gl
-0000e0f0: 7970 6820 3d20 4e6f 6e65 0a0a 2020 2020  yph = None..    
-0000e100: 2020 2020 666f 7220 6669 6720 696e 2028      for fig in (
-0000e110: 7072 6f63 6573 7369 6e67 2c20 6370 7529  processing, cpu)
-0000e120: 3a0a 2020 2020 2020 2020 2020 2020 6669  :.            fi
-0000e130: 672e 7861 7869 732e 6d69 6e6f 725f 7469  g.xaxis.minor_ti
-0000e140: 636b 5f6c 696e 655f 616c 7068 6120 3d20  ck_line_alpha = 
-0000e150: 300a 2020 2020 2020 2020 2020 2020 6669  0.            fi
-0000e160: 672e 7961 7869 732e 7669 7369 626c 6520  g.yaxis.visible 
-0000e170: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-0000e180: 2020 2020 6669 672e 7967 7269 642e 7669      fig.ygrid.vi
-0000e190: 7369 626c 6520 3d20 4661 6c73 650a 0a20  sible = False.. 
-0000e1a0: 2020 2020 2020 2020 2020 2074 6170 203d             tap =
-0000e1b0: 2054 6170 546f 6f6c 2863 616c 6c62 6163   TapTool(callbac
-0000e1c0: 6b3d 4f70 656e 5552 4c28 7572 6c3d 222e  k=OpenURL(url=".
-0000e1d0: 2f69 6e66 6f2f 776f 726b 6572 2f40 6573  /info/worker/@es
-0000e1e0: 6361 7065 645f 776f 726b 6572 2e68 746d  caped_worker.htm
-0000e1f0: 6c22 2929 0a20 2020 2020 2020 2020 2020  l")).           
-0000e200: 2066 6967 2e61 6464 5f74 6f6f 6c73 2874   fig.add_tools(t
-0000e210: 6170 290a 0a20 2020 2020 2020 2020 2020  ap)..           
-0000e220: 2066 6967 2e74 6f6f 6c62 6172 5f6c 6f63   fig.toolbar_loc
-0000e230: 6174 696f 6e20 3d20 4e6f 6e65 0a20 2020  ation = None.   
-0000e240: 2020 2020 2020 2020 2066 6967 2e79 6178           fig.yax
-0000e250: 6973 2e76 6973 6962 6c65 203d 2046 616c  is.visible = Fal
-0000e260: 7365 0a0a 2020 2020 2020 2020 686f 7665  se..        hove
-0000e270: 7220 3d20 486f 7665 7254 6f6f 6c28 290a  r = HoverTool().
-0000e280: 2020 2020 2020 2020 686f 7665 722e 746f          hover.to
-0000e290: 6f6c 7469 7073 203d 2022 4077 6f72 6b65  oltips = "@worke
-0000e2a0: 7220 3a20 406e 7072 6f63 6573 7369 6e67  r : @nprocessing
-0000e2b0: 2074 6173 6b73 220a 2020 2020 2020 2020   tasks".        
-0000e2c0: 686f 7665 722e 706f 696e 745f 706f 6c69  hover.point_poli
-0000e2d0: 6379 203d 2022 666f 6c6c 6f77 5f6d 6f75  cy = "follow_mou
-0000e2e0: 7365 220a 2020 2020 2020 2020 7072 6f63  se".        proc
-0000e2f0: 6573 7369 6e67 2e61 6464 5f74 6f6f 6c73  essing.add_tools
-0000e300: 2868 6f76 6572 290a 0a20 2020 2020 2020  (hover)..       
-0000e310: 2068 6f76 6572 203d 2048 6f76 6572 546f   hover = HoverTo
-0000e320: 6f6c 2829 0a20 2020 2020 2020 2068 6f76  ol().        hov
-0000e330: 6572 2e74 6f6f 6c74 6970 7320 3d20 2240  er.tooltips = "@
-0000e340: 776f 726b 6572 203a 2040 6370 7520 2522  worker : @cpu %"
-0000e350: 0a20 2020 2020 2020 2068 6f76 6572 2e70  .        hover.p
-0000e360: 6f69 6e74 5f70 6f6c 6963 7920 3d20 2266  oint_policy = "f
-0000e370: 6f6c 6c6f 775f 6d6f 7573 6522 0a20 2020  ollow_mouse".   
-0000e380: 2020 2020 2063 7075 2e61 6464 5f74 6f6f       cpu.add_too
-0000e390: 6c73 2868 6f76 6572 290a 0a20 2020 2020  ls(hover)..     
-0000e3a0: 2020 2073 656c 662e 7072 6f63 6573 7369     self.processi
-0000e3b0: 6e67 5f66 6967 7572 6520 3d20 7072 6f63  ng_figure = proc
-0000e3c0: 6573 7369 6e67 0a20 2020 2020 2020 2073  essing.        s
-0000e3d0: 656c 662e 6370 755f 6669 6775 7265 203d  elf.cpu_figure =
-0000e3e0: 2063 7075 0a0a 2020 2020 4077 6974 686f   cpu..    @witho
-0000e3f0: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
-0000e400: 6461 7469 6f6e 0a20 2020 2040 6c6f 675f  dation.    @log_
-0000e410: 6572 726f 7273 0a20 2020 2064 6566 2075  errors.    def u
-0000e420: 7064 6174 6528 7365 6c66 293a 0a20 2020  pdate(self):.   
-0000e430: 2020 2020 2077 6f72 6b65 7273 203d 2073       workers = s
-0000e440: 656c 662e 7363 6865 6475 6c65 722e 776f  elf.scheduler.wo
-0000e450: 726b 6572 732e 7661 6c75 6573 2829 0a20  rkers.values(). 
-0000e460: 2020 2020 2020 206e 6f77 203d 2074 696d         now = tim
-0000e470: 6528 290a 2020 2020 2020 2020 6966 206e  e().        if n
-0000e480: 6f74 2061 6e79 2877 732e 7072 6f63 6573  ot any(ws.proces
-0000e490: 7369 6e67 2066 6f72 2077 7320 696e 2077  sing for ws in w
-0000e4a0: 6f72 6b65 7273 2920 616e 6420 6e6f 7720  orkers) and now 
-0000e4b0: 3c20 7365 6c66 2e6c 6173 7420 2b20 313a  < self.last + 1:
-0000e4c0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0000e4d0: 7572 6e0a 2020 2020 2020 2020 7365 6c66  urn.        self
-0000e4e0: 2e6c 6173 7420 3d20 6e6f 770a 0a20 2020  .last = now..   
-0000e4f0: 2020 2020 2063 7075 203d 205b 696e 7428       cpu = [int(
-0000e500: 7773 2e6d 6574 7269 6373 5b22 6370 7522  ws.metrics["cpu"
-0000e510: 5d29 2066 6f72 2077 7320 696e 2077 6f72  ]) for ws in wor
-0000e520: 6b65 7273 5d0a 2020 2020 2020 2020 6e70  kers].        np
-0000e530: 726f 6365 7373 696e 6720 3d20 5b6c 656e  rocessing = [len
-0000e540: 2877 732e 7072 6f63 6573 7369 6e67 2920  (ws.processing) 
-0000e550: 666f 7220 7773 2069 6e20 776f 726b 6572  for ws in worker
-0000e560: 735d 0a0a 2020 2020 2020 2020 6e70 726f  s]..        npro
-0000e570: 6365 7373 696e 675f 636f 6c6f 7220 3d20  cessing_color = 
-0000e580: 5b5d 0a20 2020 2020 2020 2066 6f72 2077  [].        for w
-0000e590: 7320 696e 2077 6f72 6b65 7273 3a0a 2020  s in workers:.  
-0000e5a0: 2020 2020 2020 2020 2020 6966 2077 7320            if ws 
-0000e5b0: 696e 2073 656c 662e 7363 6865 6475 6c65  in self.schedule
-0000e5c0: 722e 6964 6c65 3a0a 2020 2020 2020 2020  r.idle:.        
-0000e5d0: 2020 2020 2020 2020 6e70 726f 6365 7373          nprocess
-0000e5e0: 696e 675f 636f 6c6f 722e 6170 7065 6e64  ing_color.append
-0000e5f0: 2822 7265 6422 290a 2020 2020 2020 2020  ("red").        
-0000e600: 2020 2020 656c 6966 2077 7320 696e 2073      elif ws in s
-0000e610: 656c 662e 7363 6865 6475 6c65 722e 7361  elf.scheduler.sa
-0000e620: 7475 7261 7465 643a 0a20 2020 2020 2020  turated:.       
-0000e630: 2020 2020 2020 2020 206e 7072 6f63 6573           nproces
-0000e640: 7369 6e67 5f63 6f6c 6f72 2e61 7070 656e  sing_color.appen
-0000e650: 6428 2267 7265 656e 2229 0a20 2020 2020  d("green").     
-0000e660: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0000e670: 2020 2020 2020 2020 2020 2020 206e 7072               npr
-0000e680: 6f63 6573 7369 6e67 5f63 6f6c 6f72 2e61  ocessing_color.a
-0000e690: 7070 656e 6428 2262 6c75 6522 290a 0a20  ppend("blue").. 
-0000e6a0: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-0000e6b0: 7b0a 2020 2020 2020 2020 2020 2020 2263  {.            "c
-0000e6c0: 7075 223a 2063 7075 2c0a 2020 2020 2020  pu": cpu,.      
-0000e6d0: 2020 2020 2020 2263 7075 2d68 616c 6622        "cpu-half"
-0000e6e0: 3a20 5b63 202f 2032 2066 6f72 2063 2069  : [c / 2 for c i
-0000e6f0: 6e20 6370 755d 2c0a 2020 2020 2020 2020  n cpu],.        
-0000e700: 2020 2020 226e 7072 6f63 6573 7369 6e67      "nprocessing
-0000e710: 223a 206e 7072 6f63 6573 7369 6e67 2c0a  ": nprocessing,.
-0000e720: 2020 2020 2020 2020 2020 2020 226e 7072              "npr
-0000e730: 6f63 6573 7369 6e67 2d68 616c 6622 3a20  ocessing-half": 
-0000e740: 5b6e 7020 2f20 3220 666f 7220 6e70 2069  [np / 2 for np i
-0000e750: 6e20 6e70 726f 6365 7373 696e 675d 2c0a  n nprocessing],.
-0000e760: 2020 2020 2020 2020 2020 2020 226e 7072              "npr
-0000e770: 6f63 6573 7369 6e67 2d63 6f6c 6f72 223a  ocessing-color":
-0000e780: 206e 7072 6f63 6573 7369 6e67 5f63 6f6c   nprocessing_col
-0000e790: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
-0000e7a0: 2277 6f72 6b65 7222 3a20 5b77 732e 6164  "worker": [ws.ad
-0000e7b0: 6472 6573 7320 666f 7220 7773 2069 6e20  dress for ws in 
-0000e7c0: 776f 726b 6572 735d 2c0a 2020 2020 2020  workers],.      
-0000e7d0: 2020 2020 2020 2265 7363 6170 6564 5f77        "escaped_w
-0000e7e0: 6f72 6b65 7222 3a20 5b65 7363 6170 652e  orker": [escape.
-0000e7f0: 7572 6c5f 6573 6361 7065 2877 732e 6164  url_escape(ws.ad
-0000e800: 6472 6573 7329 2066 6f72 2077 7320 696e  dress) for ws in
-0000e810: 2077 6f72 6b65 7273 5d2c 0a20 2020 2020   workers],.     
-0000e820: 2020 2020 2020 2022 7922 3a20 6c69 7374         "y": list
-0000e830: 2872 616e 6765 286c 656e 2877 6f72 6b65  (range(len(worke
-0000e840: 7273 2929 292c 0a20 2020 2020 2020 207d  rs))),.        }
-0000e850: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-0000e860: 662e 7363 6865 6475 6c65 722e 776f 726b  f.scheduler.work
-0000e870: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
-0000e880: 2078 7261 6e67 6520 3d20 6d61 7828 7773   xrange = max(ws
-0000e890: 2e6e 7468 7265 6164 7320 6f72 2031 2066  .nthreads or 1 f
-0000e8a0: 6f72 2077 7320 696e 2077 6f72 6b65 7273  or ws in workers
-0000e8b0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-0000e8c0: 2020 2020 2020 2020 2020 2020 7872 616e              xran
-0000e8d0: 6765 203d 2031 0a20 2020 2020 2020 2073  ge = 1.        s
-0000e8e0: 656c 662e 6370 755f 6669 6775 7265 2e78  elf.cpu_figure.x
-0000e8f0: 5f72 616e 6765 2e65 6e64 203d 2078 7261  _range.end = xra
-0000e900: 6e67 6520 2a20 3130 300a 0a20 2020 2020  nge * 100..     
-0000e910: 2020 2075 7064 6174 6528 7365 6c66 2e73     update(self.s
-0000e920: 6f75 7263 652c 2072 6573 756c 7429 0a0a  ource, result)..
-0000e930: 0a63 6c61 7373 2053 7465 616c 696e 6754  .class StealingT
-0000e940: 696d 6553 6572 6965 7328 4461 7368 626f  imeSeries(Dashbo
-0000e950: 6172 6443 6f6d 706f 6e65 6e74 293a 0a20  ardComponent):. 
-0000e960: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-0000e970: 7365 6c66 2c20 7363 6865 6475 6c65 722c  self, scheduler,
-0000e980: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
-0000e990: 2020 2020 7365 6c66 2e73 6368 6564 756c      self.schedul
-0000e9a0: 6572 203d 2073 6368 6564 756c 6572 0a20  er = scheduler. 
-0000e9b0: 2020 2020 2020 2073 656c 662e 736f 7572         self.sour
-0000e9c0: 6365 203d 2043 6f6c 756d 6e44 6174 6153  ce = ColumnDataS
-0000e9d0: 6f75 7263 6528 0a20 2020 2020 2020 2020  ource(.         
-0000e9e0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0000e9f0: 2020 2020 2022 7469 6d65 223a 205b 7469       "time": [ti
-0000ea00: 6d65 2829 202a 2031 3030 302c 2074 696d  me() * 1000, tim
-0000ea10: 6528 2920 2a20 3130 3030 202b 2031 5d2c  e() * 1000 + 1],
-0000ea20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ea30: 2022 6964 6c65 223a 205b 302c 2030 5d2c   "idle": [0, 0],
-0000ea40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ea50: 2022 7361 7475 7261 7465 6422 3a20 5b30   "saturated": [0
-0000ea60: 2c20 305d 2c0a 2020 2020 2020 2020 2020  , 0],.          
-0000ea70: 2020 7d0a 2020 2020 2020 2020 290a 0a20    }.        ).. 
-0000ea80: 2020 2020 2020 2078 5f72 616e 6765 203d         x_range =
-0000ea90: 2044 6174 6152 616e 6765 3164 2866 6f6c   DataRange1d(fol
-0000eaa0: 6c6f 773d 2265 6e64 222c 2066 6f6c 6c6f  low="end", follo
-0000eab0: 775f 696e 7465 7276 616c 3d32 3030 3030  w_interval=20000
-0000eac0: 2c20 7261 6e67 655f 7061 6464 696e 673d  , range_padding=
-0000ead0: 3029 0a0a 2020 2020 2020 2020 7365 6c66  0)..        self
-0000eae0: 2e72 6f6f 7420 3d20 6669 6775 7265 280a  .root = figure(.
-0000eaf0: 2020 2020 2020 2020 2020 2020 7469 746c              titl
-0000eb00: 653d 2249 646c 6520 616e 6420 5361 7475  e="Idle and Satu
-0000eb10: 7261 7465 6420 576f 726b 6572 7320 4f76  rated Workers Ov
-0000eb20: 6572 2054 696d 6522 2c0a 2020 2020 2020  er Time",.      
-0000eb30: 2020 2020 2020 785f 6178 6973 5f74 7970        x_axis_typ
-0000eb40: 653d 2264 6174 6574 696d 6522 2c0a 2020  e="datetime",.  
-0000eb50: 2020 2020 2020 2020 2020 746f 6f6c 733d            tools=
-0000eb60: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
-0000eb70: 785f 7261 6e67 653d 785f 7261 6e67 652c  x_range=x_range,
-0000eb80: 0a20 2020 2020 2020 2020 2020 202a 2a6b  .            **k
-0000eb90: 7761 7267 732c 0a20 2020 2020 2020 2029  wargs,.        )
-0000eba0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-0000ebb0: 6f74 2e6c 696e 6528 736f 7572 6365 3d73  ot.line(source=s
-0000ebc0: 656c 662e 736f 7572 6365 2c20 783d 2274  elf.source, x="t
-0000ebd0: 696d 6522 2c20 793d 2269 646c 6522 2c20  ime", y="idle", 
-0000ebe0: 636f 6c6f 723d 2272 6564 2229 0a20 2020  color="red").   
-0000ebf0: 2020 2020 2073 656c 662e 726f 6f74 2e6c       self.root.l
-0000ec00: 696e 6528 736f 7572 6365 3d73 656c 662e  ine(source=self.
-0000ec10: 736f 7572 6365 2c20 783d 2274 696d 6522  source, x="time"
-0000ec20: 2c20 793d 2273 6174 7572 6174 6564 222c  , y="saturated",
-0000ec30: 2063 6f6c 6f72 3d22 6772 6565 6e22 290a   color="green").
-0000ec40: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-0000ec50: 742e 7961 7869 732e 6d69 6e6f 725f 7469  t.yaxis.minor_ti
-0000ec60: 636b 5f6c 696e 655f 636f 6c6f 7220 3d20  ck_line_color = 
-0000ec70: 4e6f 6e65 0a0a 2020 2020 2020 2020 7365  None..        se
-0000ec80: 6c66 2e72 6f6f 742e 6164 645f 746f 6f6c  lf.root.add_tool
-0000ec90: 7328 0a20 2020 2020 2020 2020 2020 2052  s(.            R
-0000eca0: 6573 6574 546f 6f6c 2829 2c20 5061 6e54  esetTool(), PanT
-0000ecb0: 6f6f 6c28 6469 6d65 6e73 696f 6e73 3d22  ool(dimensions="
-0000ecc0: 7769 6474 6822 292c 2057 6865 656c 5a6f  width"), WheelZo
-0000ecd0: 6f6d 546f 6f6c 2864 696d 656e 7369 6f6e  omTool(dimension
-0000ece0: 733d 2277 6964 7468 2229 0a20 2020 2020  s="width").     
-0000ecf0: 2020 2029 0a0a 2020 2020 4077 6974 686f     )..    @witho
-0000ed00: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
-0000ed10: 6461 7469 6f6e 0a20 2020 2040 6c6f 675f  dation.    @log_
-0000ed20: 6572 726f 7273 0a20 2020 2064 6566 2075  errors.    def u
-0000ed30: 7064 6174 6528 7365 6c66 293a 0a20 2020  pdate(self):.   
-0000ed40: 2020 2020 2072 6573 756c 7420 3d20 7b0a       result = {.
-0000ed50: 2020 2020 2020 2020 2020 2020 2274 696d              "tim
-0000ed60: 6522 3a20 5b74 696d 6528 2920 2a20 3130  e": [time() * 10
-0000ed70: 3030 5d2c 0a20 2020 2020 2020 2020 2020  00],.           
-0000ed80: 2022 6964 6c65 223a 205b 6c65 6e28 7365   "idle": [len(se
-0000ed90: 6c66 2e73 6368 6564 756c 6572 2e69 646c  lf.scheduler.idl
-0000eda0: 6529 5d2c 0a20 2020 2020 2020 2020 2020  e)],.           
-0000edb0: 2022 7361 7475 7261 7465 6422 3a20 5b6c   "saturated": [l
-0000edc0: 656e 2873 656c 662e 7363 6865 6475 6c65  en(self.schedule
-0000edd0: 722e 7361 7475 7261 7465 6429 5d2c 0a20  r.saturated)],. 
-0000ede0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0000edf0: 2069 6620 5052 4f46 494c 494e 473a 0a20   if PROFILING:. 
-0000ee00: 2020 2020 2020 2020 2020 2063 7572 646f             curdo
-0000ee10: 6328 292e 6164 645f 6e65 7874 5f74 6963  c().add_next_tic
-0000ee20: 6b5f 6361 6c6c 6261 636b 286c 616d 6264  k_callback(lambd
-0000ee30: 613a 2073 656c 662e 736f 7572 6365 2e73  a: self.source.s
-0000ee40: 7472 6561 6d28 7265 7375 6c74 2c20 3130  tream(result, 10
-0000ee50: 3030 3029 290a 2020 2020 2020 2020 656c  000)).        el
-0000ee60: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000ee70: 7365 6c66 2e73 6f75 7263 652e 7374 7265  self.source.stre
-0000ee80: 616d 2872 6573 756c 742c 2031 3030 3030  am(result, 10000
-0000ee90: 290a 0a0a 636c 6173 7320 5374 6561 6c69  )...class Steali
-0000eea0: 6e67 4576 656e 7473 2844 6173 6862 6f61  ngEvents(Dashboa
-0000eeb0: 7264 436f 6d70 6f6e 656e 7429 3a0a 2020  rdComponent):.  
-0000eec0: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-0000eed0: 656c 662c 2073 6368 6564 756c 6572 2c20  elf, scheduler, 
-0000eee0: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
-0000eef0: 2020 2073 656c 662e 7363 6865 6475 6c65     self.schedule
-0000ef00: 7220 3d20 7363 6865 6475 6c65 720a 2020  r = scheduler.  
-0000ef10: 2020 2020 2020 7365 6c66 2e73 7465 616c        self.steal
-0000ef20: 203d 2073 6368 6564 756c 6572 2e65 7874   = scheduler.ext
-0000ef30: 656e 7369 6f6e 735b 2273 7465 616c 696e  ensions["stealin
-0000ef40: 6722 5d0a 2020 2020 2020 2020 7365 6c66  g"].        self
-0000ef50: 2e6c 6173 7420 3d20 300a 2020 2020 2020  .last = 0.      
-0000ef60: 2020 7365 6c66 2e73 6f75 7263 6520 3d20    self.source = 
-0000ef70: 436f 6c75 6d6e 4461 7461 536f 7572 6365  ColumnDataSource
-0000ef80: 280a 2020 2020 2020 2020 2020 2020 7b0a  (.            {.
-0000ef90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000efa0: 2274 696d 6522 3a20 5b74 696d 6528 2920  "time": [time() 
-0000efb0: 2d20 3630 2c20 7469 6d65 2829 5d2c 0a20  - 60, time()],. 
-0000efc0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000efd0: 6c65 7665 6c22 3a20 5b30 2c20 3135 5d2c  level": [0, 15],
-0000efe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000eff0: 2022 636f 6c6f 7222 3a20 5b22 7768 6974   "color": ["whit
-0000f000: 6522 2c20 2277 6869 7465 225d 2c0a 2020  e", "white"],.  
-0000f010: 2020 2020 2020 2020 2020 2020 2020 2264                "d
-0000f020: 7572 6174 696f 6e22 3a20 5b30 2c20 305d  uration": [0, 0]
-0000f030: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000f040: 2020 2272 6164 6975 7322 3a20 5b31 2c20    "radius": [1, 
-0000f050: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
-0000f060: 2020 2020 2263 6f73 745f 6661 6374 6f72      "cost_factor
-0000f070: 223a 205b 302c 2031 305d 2c0a 2020 2020  ": [0, 10],.    
-0000f080: 2020 2020 2020 2020 2020 2020 2263 6f75              "cou
-0000f090: 6e74 223a 205b 312c 2031 5d2c 0a20 2020  nt": [1, 1],.   
-0000f0a0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0000f0b0: 2020 2029 0a0a 2020 2020 2020 2020 785f     )..        x_
-0000f0c0: 7261 6e67 6520 3d20 4461 7461 5261 6e67  range = DataRang
-0000f0d0: 6531 6428 666f 6c6c 6f77 3d22 656e 6422  e1d(follow="end"
-0000f0e0: 2c20 666f 6c6c 6f77 5f69 6e74 6572 7661  , follow_interva
-0000f0f0: 6c3d 3230 3030 302c 2072 616e 6765 5f70  l=20000, range_p
-0000f100: 6164 6469 6e67 3d30 290a 0a20 2020 2020  adding=0)..     
-0000f110: 2020 2073 656c 662e 726f 6f74 203d 2066     self.root = f
-0000f120: 6967 7572 6528 0a20 2020 2020 2020 2020  igure(.         
-0000f130: 2020 2074 6974 6c65 3d22 5374 6561 6c69     title="Steali
-0000f140: 6e67 2045 7665 6e74 7322 2c0a 2020 2020  ng Events",.    
-0000f150: 2020 2020 2020 2020 785f 6178 6973 5f74          x_axis_t
-0000f160: 7970 653d 2264 6174 6574 696d 6522 2c0a  ype="datetime",.
-0000f170: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
-0000f180: 733d 2222 2c0a 2020 2020 2020 2020 2020  s="",.          
-0000f190: 2020 785f 7261 6e67 653d 785f 7261 6e67    x_range=x_rang
-0000f1a0: 652c 0a20 2020 2020 2020 2020 2020 202a  e,.            *
-0000f1b0: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
-0000f1c0: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
-0000f1d0: 2e72 6f6f 742e 6369 7263 6c65 280a 2020  .root.circle(.  
-0000f1e0: 2020 2020 2020 2020 2020 736f 7572 6365            source
-0000f1f0: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
-0000f200: 2020 2020 2020 2020 2020 783d 2274 696d            x="tim
-0000f210: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-0000f220: 793d 226c 6576 656c 222c 0a20 2020 2020  y="level",.     
-0000f230: 2020 2020 2020 2063 6f6c 6f72 3d22 636f         color="co
-0000f240: 6c6f 7222 2c0a 2020 2020 2020 2020 2020  lor",.          
-0000f250: 2020 7369 7a65 3d22 7261 6469 7573 222c    size="radius",
-0000f260: 0a20 2020 2020 2020 2020 2020 2061 6c70  .            alp
-0000f270: 6861 3d30 2e35 2c0a 2020 2020 2020 2020  ha=0.5,.        
-0000f280: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
-0000f290: 6f6f 742e 7961 7869 732e 6178 6973 5f6c  oot.yaxis.axis_l
-0000f2a0: 6162 656c 203d 2022 4c65 7665 6c22 0a0a  abel = "Level"..
-0000f2b0: 2020 2020 2020 2020 686f 7665 7220 3d20          hover = 
-0000f2c0: 486f 7665 7254 6f6f 6c28 290a 2020 2020  HoverTool().    
-0000f2d0: 2020 2020 686f 7665 722e 746f 6f6c 7469      hover.toolti
-0000f2e0: 7073 203d 2022 4c65 7665 6c3a 2040 6c65  ps = "Level: @le
-0000f2f0: 7665 6c2c 2044 7572 6174 696f 6e3a 2040  vel, Duration: @
-0000f300: 6475 7261 7469 6f6e 2c20 436f 756e 743a  duration, Count:
-0000f310: 2040 636f 756e 742c 2043 6f73 7420 6661   @count, Cost fa
-0000f320: 6374 6f72 3a20 4063 6f73 745f 6661 6374  ctor: @cost_fact
-0000f330: 6f72 220a 2020 2020 2020 2020 686f 7665  or".        hove
-0000f340: 722e 706f 696e 745f 706f 6c69 6379 203d  r.point_policy =
-0000f350: 2022 666f 6c6c 6f77 5f6d 6f75 7365 220a   "follow_mouse".
-0000f360: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-0000f370: 6f74 2e61 6464 5f74 6f6f 6c73 280a 2020  ot.add_tools(.  
-0000f380: 2020 2020 2020 2020 2020 686f 7665 722c            hover,
-0000f390: 0a20 2020 2020 2020 2020 2020 2052 6573  .            Res
-0000f3a0: 6574 546f 6f6c 2829 2c0a 2020 2020 2020  etTool(),.      
-0000f3b0: 2020 2020 2020 5061 6e54 6f6f 6c28 6469        PanTool(di
-0000f3c0: 6d65 6e73 696f 6e73 3d22 7769 6474 6822  mensions="width"
-0000f3d0: 292c 0a20 2020 2020 2020 2020 2020 2057  ),.            W
-0000f3e0: 6865 656c 5a6f 6f6d 546f 6f6c 2864 696d  heelZoomTool(dim
-0000f3f0: 656e 7369 6f6e 733d 2277 6964 7468 2229  ensions="width")
-0000f400: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-0000f410: 2064 6566 2063 6f6e 7665 7274 2873 656c   def convert(sel
-0000f420: 662c 206d 7367 7329 3a0a 2020 2020 2020  f, msgs):.      
-0000f430: 2020 2222 2243 6f6e 7665 7274 2061 206c    """Convert a l
-0000f440: 6f67 206d 6573 7361 6765 2074 6f20 6120  og message to a 
-0000f450: 676c 7970 6822 2222 0a20 2020 2020 2020  glyph""".       
-0000f460: 2074 6f74 616c 5f64 7572 6174 696f 6e20   total_duration 
-0000f470: 3d20 300a 2020 2020 2020 2020 666f 7220  = 0.        for 
-0000f480: 6d73 6720 696e 206d 7367 733a 0a20 2020  msg in msgs:.   
-0000f490: 2020 2020 2020 2020 2074 696d 652c 206c           time, l
-0000f4a0: 6576 656c 2c20 6b65 792c 2064 7572 6174  evel, key, durat
-0000f4b0: 696f 6e2c 2073 6174 2c20 6f63 635f 7361  ion, sat, occ_sa
-0000f4c0: 742c 2069 646c 2c20 6f63 635f 6964 6c20  t, idl, occ_idl 
-0000f4d0: 3d20 6d73 675b 3a38 5d0a 2020 2020 2020  = msg[:8].      
-0000f4e0: 2020 2020 2020 746f 7461 6c5f 6475 7261        total_dura
-0000f4f0: 7469 6f6e 202b 3d20 6475 7261 7469 6f6e  tion += duration
-0000f500: 0a0a 2020 2020 2020 2020 7472 793a 0a20  ..        try:. 
-0000f510: 2020 2020 2020 2020 2020 2063 6f6c 6f72             color
-0000f520: 203d 2056 6972 6964 6973 3131 5b6c 6576   = Viridis11[lev
-0000f530: 656c 5d0a 2020 2020 2020 2020 6578 6365  el].        exce
-0000f540: 7074 2028 4b65 7945 7272 6f72 2c20 496e  pt (KeyError, In
-0000f550: 6465 7845 7272 6f72 293a 0a20 2020 2020  dexError):.     
-0000f560: 2020 2020 2020 2063 6f6c 6f72 203d 2022         color = "
-0000f570: 626c 6163 6b22 0a0a 2020 2020 2020 2020  black"..        
-0000f580: 7261 6469 7573 203d 206d 6174 682e 7371  radius = math.sq
-0000f590: 7274 286d 696e 2874 6f74 616c 5f64 7572  rt(min(total_dur
-0000f5a0: 6174 696f 6e2c 2031 3029 2920 2a20 3330  ation, 10)) * 30
-0000f5b0: 202b 2032 0a0a 2020 2020 2020 2020 6420   + 2..        d 
-0000f5c0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-0000f5d0: 2274 696d 6522 3a20 7469 6d65 202a 2031  "time": time * 1
-0000f5e0: 3030 302c 0a20 2020 2020 2020 2020 2020  000,.           
-0000f5f0: 2022 6c65 7665 6c22 3a20 6c65 7665 6c2c   "level": level,
-0000f600: 0a20 2020 2020 2020 2020 2020 2022 636f  .            "co
-0000f610: 756e 7422 3a20 6c65 6e28 6d73 6773 292c  unt": len(msgs),
-0000f620: 0a20 2020 2020 2020 2020 2020 2022 636f  .            "co
-0000f630: 6c6f 7222 3a20 636f 6c6f 722c 0a20 2020  lor": color,.   
-0000f640: 2020 2020 2020 2020 2022 6475 7261 7469           "durati
-0000f650: 6f6e 223a 2074 6f74 616c 5f64 7572 6174  on": total_durat
-0000f660: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
-0000f670: 2022 7261 6469 7573 223a 2072 6164 6975   "radius": radiu
-0000f680: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
-0000f690: 636f 7374 5f66 6163 746f 7222 3a20 7365  cost_factor": se
-0000f6a0: 6c66 2e73 7465 616c 2e63 6f73 745f 6d75  lf.steal.cost_mu
-0000f6b0: 6c74 6970 6c69 6572 735b 6c65 7665 6c5d  ltipliers[level]
-0000f6c0: 2c0a 2020 2020 2020 2020 7d0a 0a20 2020  ,.        }..   
-0000f6d0: 2020 2020 2072 6574 7572 6e20 640a 0a20       return d.. 
-0000f6e0: 2020 2040 7769 7468 6f75 745f 7072 6f70     @without_prop
-0000f6f0: 6572 7479 5f76 616c 6964 6174 696f 6e0a  erty_validation.
-0000f700: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
-0000f710: 2020 2020 6465 6620 7570 6461 7465 2873      def update(s
-0000f720: 656c 6629 3a0a 2020 2020 2020 2020 6c6f  elf):.        lo
-0000f730: 6720 3d20 7365 6c66 2e73 6368 6564 756c  g = self.schedul
-0000f740: 6572 2e67 6574 5f65 7665 6e74 7328 746f  er.get_events(to
-0000f750: 7069 633d 2273 7465 616c 696e 6722 290a  pic="stealing").
-0000f760: 2020 2020 2020 2020 6375 7272 656e 7420          current 
-0000f770: 3d20 6c65 6e28 7365 6c66 2e73 6368 6564  = len(self.sched
-0000f780: 756c 6572 2e65 7665 6e74 735b 2273 7465  uler.events["ste
-0000f790: 616c 696e 6722 5d29 0a20 2020 2020 2020  aling"]).       
-0000f7a0: 206e 203d 2063 7572 7265 6e74 202d 2073   n = current - s
-0000f7b0: 656c 662e 6c61 7374 0a0a 2020 2020 2020  elf.last..      
-0000f7c0: 2020 6c6f 6720 3d20 5b6c 6f67 5b2d 695d    log = [log[-i]
-0000f7d0: 5b31 5d5b 315d 2066 6f72 2069 2069 6e20  [1][1] for i in 
-0000f7e0: 7261 6e67 6528 312c 206e 202b 2031 2920  range(1, n + 1) 
-0000f7f0: 6966 206c 6f67 5b2d 695d 5b31 5d5b 305d  if log[-i][1][0]
-0000f800: 203d 3d20 2272 6571 7565 7374 225d 0a20   == "request"]. 
-0000f810: 2020 2020 2020 2073 656c 662e 6c61 7374         self.last
-0000f820: 203d 2063 7572 7265 6e74 0a0a 2020 2020   = current..    
-0000f830: 2020 2020 6966 206c 6f67 3a0a 2020 2020      if log:.    
-0000f840: 2020 2020 2020 2020 6e65 7720 3d20 7069          new = pi
-0000f850: 7065 280a 2020 2020 2020 2020 2020 2020  pe(.            
-0000f860: 2020 2020 6c6f 672c 0a20 2020 2020 2020      log,.       
-0000f870: 2020 2020 2020 2020 206d 6170 2867 726f           map(gro
-0000f880: 7570 6279 2831 2929 2c0a 2020 2020 2020  upby(1)),.      
-0000f890: 2020 2020 2020 2020 2020 6d61 7028 6469            map(di
-0000f8a0: 6374 2e76 616c 7565 7329 2c0a 2020 2020  ct.values),.    
-0000f8b0: 2020 2020 2020 2020 2020 2020 636f 6e63              conc
-0000f8c0: 6174 2c0a 2020 2020 2020 2020 2020 2020  at,.            
-0000f8d0: 2020 2020 6d61 7028 7365 6c66 2e63 6f6e      map(self.con
-0000f8e0: 7665 7274 292c 0a20 2020 2020 2020 2020  vert),.         
-0000f8f0: 2020 2020 2020 206c 6973 742c 0a20 2020         list,.   
-0000f900: 2020 2020 2020 2020 2020 2020 2074 7261               tra
-0000f910: 6e73 706f 7365 2c0a 2020 2020 2020 2020  nspose,.        
-0000f920: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0000f930: 2020 6966 2050 524f 4649 4c49 4e47 3a0a    if PROFILING:.
-0000f940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f950: 6375 7264 6f63 2829 2e61 6464 5f6e 6578  curdoc().add_nex
-0000f960: 745f 7469 636b 5f63 616c 6c62 6163 6b28  t_tick_callback(
-0000f970: 6c61 6d62 6461 3a20 7365 6c66 2e73 6f75  lambda: self.sou
-0000f980: 7263 652e 7374 7265 616d 286e 6577 2c20  rce.stream(new, 
-0000f990: 3130 3030 3029 290a 2020 2020 2020 2020  10000)).        
-0000f9a0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000f9b0: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-0000f9c0: 6f75 7263 652e 7374 7265 616d 286e 6577  ource.stream(new
-0000f9d0: 2c20 3130 3030 3029 0a0a 0a63 6c61 7373  , 10000)...class
-0000f9e0: 2045 7665 6e74 7328 4461 7368 626f 6172   Events(Dashboar
-0000f9f0: 6443 6f6d 706f 6e65 6e74 293a 0a20 2020  dComponent):.   
-0000fa00: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-0000fa10: 6c66 2c20 7363 6865 6475 6c65 722c 206e  lf, scheduler, n
-0000fa20: 616d 652c 2068 6569 6768 743d 3135 302c  ame, height=150,
-0000fa30: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
-0000fa40: 2020 2020 7365 6c66 2e73 6368 6564 756c      self.schedul
-0000fa50: 6572 203d 2073 6368 6564 756c 6572 0a20  er = scheduler. 
-0000fa60: 2020 2020 2020 2073 656c 662e 6163 7469         self.acti
-0000fa70: 6f6e 5f79 7320 3d20 6469 6374 2829 0a20  on_ys = dict(). 
-0000fa80: 2020 2020 2020 2073 656c 662e 6c61 7374         self.last
-0000fa90: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
-0000faa0: 662e 6e61 6d65 203d 206e 616d 650a 2020  f.name = name.  
-0000fab0: 2020 2020 2020 7365 6c66 2e73 6f75 7263        self.sourc
-0000fac0: 6520 3d20 436f 6c75 6d6e 4461 7461 536f  e = ColumnDataSo
-0000fad0: 7572 6365 280a 2020 2020 2020 2020 2020  urce(.          
-0000fae0: 2020 7b22 7469 6d65 223a 205b 5d2c 2022    {"time": [], "
-0000faf0: 6163 7469 6f6e 223a 205b 5d2c 2022 686f  action": [], "ho
-0000fb00: 7665 7222 3a20 5b5d 2c20 2279 223a 205b  ver": [], "y": [
-0000fb10: 5d2c 2022 636f 6c6f 7222 3a20 5b5d 7d0a  ], "color": []}.
-0000fb20: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0000fb30: 2020 2078 5f72 616e 6765 203d 2044 6174     x_range = Dat
-0000fb40: 6152 616e 6765 3164 2866 6f6c 6c6f 773d  aRange1d(follow=
-0000fb50: 2265 6e64 222c 2066 6f6c 6c6f 775f 696e  "end", follow_in
-0000fb60: 7465 7276 616c 3d32 3030 3030 3029 0a0a  terval=200000)..
-0000fb70: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-0000fb80: 7420 3d20 6669 6775 7265 280a 2020 2020  t = figure(.    
-0000fb90: 2020 2020 2020 2020 7469 746c 653d 6e61          title=na
-0000fba0: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
-0000fbb0: 785f 6178 6973 5f74 7970 653d 2264 6174  x_axis_type="dat
-0000fbc0: 6574 696d 6522 2c0a 2020 2020 2020 2020  etime",.        
-0000fbd0: 2020 2020 6865 6967 6874 3d68 6569 6768      height=heigh
-0000fbe0: 742c 0a20 2020 2020 2020 2020 2020 2074  t,.            t
-0000fbf0: 6f6f 6c73 3d22 222c 0a20 2020 2020 2020  ools="",.       
-0000fc00: 2020 2020 2078 5f72 616e 6765 3d78 5f72       x_range=x_r
-0000fc10: 616e 6765 2c0a 2020 2020 2020 2020 2020  ange,.          
-0000fc20: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
-0000fc30: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
-0000fc40: 656c 662e 726f 6f74 2e63 6972 636c 6528  elf.root.circle(
-0000fc50: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
-0000fc60: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
-0000fc70: 0a20 2020 2020 2020 2020 2020 2078 3d22  .            x="
-0000fc80: 7469 6d65 222c 0a20 2020 2020 2020 2020  time",.         
-0000fc90: 2020 2079 3d22 7922 2c0a 2020 2020 2020     y="y",.      
-0000fca0: 2020 2020 2020 636f 6c6f 723d 2263 6f6c        color="col
-0000fcb0: 6f72 222c 0a20 2020 2020 2020 2020 2020  or",.           
-0000fcc0: 2073 697a 653d 3530 2c0a 2020 2020 2020   size=50,.      
-0000fcd0: 2020 2020 2020 616c 7068 613d 302e 352c        alpha=0.5,
-0000fce0: 0a20 2020 2020 2020 2020 2020 206c 6567  .            leg
-0000fcf0: 656e 645f 6669 656c 643d 2261 6374 696f  end_field="actio
-0000fd00: 6e22 2c0a 2020 2020 2020 2020 290a 2020  n",.        ).  
-0000fd10: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-0000fd20: 7961 7869 732e 6178 6973 5f6c 6162 656c  yaxis.axis_label
-0000fd30: 203d 2022 4163 7469 6f6e 220a 2020 2020   = "Action".    
-0000fd40: 2020 2020 7365 6c66 2e72 6f6f 742e 6c65      self.root.le
-0000fd50: 6765 6e64 2e6c 6f63 6174 696f 6e20 3d20  gend.location = 
-0000fd60: 2274 6f70 5f6c 6566 7422 0a0a 2020 2020  "top_left"..    
-0000fd70: 2020 2020 686f 7665 7220 3d20 486f 7665      hover = Hove
-0000fd80: 7254 6f6f 6c28 290a 2020 2020 2020 2020  rTool().        
-0000fd90: 686f 7665 722e 746f 6f6c 7469 7073 203d  hover.tooltips =
-0000fda0: 2022 4061 6374 696f 6e3c 6272 3e40 686f   "@action<br>@ho
-0000fdb0: 7665 7222 0a20 2020 2020 2020 2068 6f76  ver".        hov
-0000fdc0: 6572 2e70 6f69 6e74 5f70 6f6c 6963 7920  er.point_policy 
-0000fdd0: 3d20 2266 6f6c 6c6f 775f 6d6f 7573 6522  = "follow_mouse"
-0000fde0: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
-0000fdf0: 6f6f 742e 6164 645f 746f 6f6c 7328 0a20  oot.add_tools(. 
-0000fe00: 2020 2020 2020 2020 2020 2068 6f76 6572             hover
-0000fe10: 2c0a 2020 2020 2020 2020 2020 2020 5265  ,.            Re
-0000fe20: 7365 7454 6f6f 6c28 292c 0a20 2020 2020  setTool(),.     
-0000fe30: 2020 2020 2020 2050 616e 546f 6f6c 2864         PanTool(d
-0000fe40: 696d 656e 7369 6f6e 733d 2277 6964 7468  imensions="width
-0000fe50: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-0000fe60: 5768 6565 6c5a 6f6f 6d54 6f6f 6c28 6469  WheelZoomTool(di
-0000fe70: 6d65 6e73 696f 6e73 3d22 7769 6474 6822  mensions="width"
-0000fe80: 292c 0a20 2020 2020 2020 2029 0a0a 2020  ),.        )..  
-0000fe90: 2020 4077 6974 686f 7574 5f70 726f 7065    @without_prope
-0000fea0: 7274 795f 7661 6c69 6461 7469 6f6e 0a20  rty_validation. 
-0000feb0: 2020 2040 6c6f 675f 6572 726f 7273 0a20     @log_errors. 
-0000fec0: 2020 2064 6566 2075 7064 6174 6528 7365     def update(se
-0000fed0: 6c66 293a 0a20 2020 2020 2020 206c 6f67  lf):.        log
-0000fee0: 203d 2073 656c 662e 7363 6865 6475 6c65   = self.schedule
-0000fef0: 722e 6576 656e 7473 5b73 656c 662e 6e61  r.events[self.na
-0000ff00: 6d65 5d0a 2020 2020 2020 2020 6e20 3d20  me].        n = 
-0000ff10: 7365 6c66 2e73 6368 6564 756c 6572 2e65  self.scheduler.e
-0000ff20: 7665 6e74 5f63 6f75 6e74 735b 7365 6c66  vent_counts[self
-0000ff30: 2e6e 616d 655d 202d 2073 656c 662e 6c61  .name] - self.la
-0000ff40: 7374 0a20 2020 2020 2020 2069 6620 6c6f  st.        if lo
-0000ff50: 673a 0a20 2020 2020 2020 2020 2020 206c  g:.            l
-0000ff60: 6f67 203d 205b 6c6f 675b 2d69 5d20 666f  og = [log[-i] fo
-0000ff70: 7220 6920 696e 2072 616e 6765 2831 2c20  r i in range(1, 
-0000ff80: 6e20 2b20 3129 5d0a 2020 2020 2020 2020  n + 1)].        
-0000ff90: 7365 6c66 2e6c 6173 7420 3d20 7365 6c66  self.last = self
-0000ffa0: 2e73 6368 6564 756c 6572 2e65 7665 6e74  .scheduler.event
-0000ffb0: 5f63 6f75 6e74 735b 7365 6c66 2e6e 616d  _counts[self.nam
-0000ffc0: 655d 0a0a 2020 2020 2020 2020 6966 206c  e]..        if l
-0000ffd0: 6f67 3a0a 2020 2020 2020 2020 2020 2020  og:.            
-0000ffe0: 6163 7469 6f6e 7320 3d20 5b5d 0a20 2020  actions = [].   
-0000fff0: 2020 2020 2020 2020 2074 696d 6573 203d           times =
-00010000: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-00010010: 686f 7665 7273 203d 205b 5d0a 2020 2020  hovers = [].    
-00010020: 2020 2020 2020 2020 7973 203d 205b 5d0a          ys = [].
-00010030: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
-00010040: 7273 203d 205b 5d0a 2020 2020 2020 2020  rs = [].        
-00010050: 2020 2020 666f 7220 6d73 675f 7469 6d65      for msg_time
-00010060: 2c20 6d73 6720 696e 206c 6f67 3a0a 2020  , msg in log:.  
-00010070: 2020 2020 2020 2020 2020 2020 2020 7469                ti
-00010080: 6d65 732e 6170 7065 6e64 286d 7367 5f74  mes.append(msg_t
-00010090: 696d 6520 2a20 3130 3030 290a 2020 2020  ime * 1000).    
-000100a0: 2020 2020 2020 2020 2020 2020 6163 7469              acti
-000100b0: 6f6e 203d 206d 7367 5b22 6163 7469 6f6e  on = msg["action
-000100c0: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
-000100d0: 2020 2061 6374 696f 6e73 2e61 7070 656e     actions.appen
-000100e0: 6428 6163 7469 6f6e 290a 2020 2020 2020  d(action).      
-000100f0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-00010100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010110: 2020 2079 732e 6170 7065 6e64 2873 656c     ys.append(sel
-00010120: 662e 6163 7469 6f6e 5f79 735b 6163 7469  f.action_ys[acti
-00010130: 6f6e 5d29 0a20 2020 2020 2020 2020 2020  on]).           
-00010140: 2020 2020 2065 7863 6570 7420 4b65 7945       except KeyE
-00010150: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
-00010160: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-00010170: 6374 696f 6e5f 7973 5b61 6374 696f 6e5d  ction_ys[action]
-00010180: 203d 206c 656e 2873 656c 662e 6163 7469   = len(self.acti
-00010190: 6f6e 5f79 7329 0a20 2020 2020 2020 2020  on_ys).         
-000101a0: 2020 2020 2020 2020 2020 2079 732e 6170             ys.ap
-000101b0: 7065 6e64 2873 656c 662e 6163 7469 6f6e  pend(self.action
-000101c0: 5f79 735b 6163 7469 6f6e 5d29 0a20 2020  _ys[action]).   
-000101d0: 2020 2020 2020 2020 2020 2020 2063 6f6c               col
-000101e0: 6f72 732e 6170 7065 6e64 2863 6f6c 6f72  ors.append(color
-000101f0: 5f6f 6628 6163 7469 6f6e 2929 0a20 2020  _of(action)).   
-00010200: 2020 2020 2020 2020 2020 2020 2068 6f76               hov
-00010210: 6572 732e 6170 7065 6e64 2822 544f 444f  ers.append("TODO
-00010220: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
-00010230: 6e65 7720 3d20 7b0a 2020 2020 2020 2020  new = {.        
-00010240: 2020 2020 2020 2020 2274 696d 6522 3a20          "time": 
-00010250: 7469 6d65 732c 0a20 2020 2020 2020 2020  times,.         
-00010260: 2020 2020 2020 2022 6163 7469 6f6e 223a         "action":
-00010270: 2061 6374 696f 6e73 2c0a 2020 2020 2020   actions,.      
-00010280: 2020 2020 2020 2020 2020 2268 6f76 6572            "hover
-00010290: 223a 2068 6f76 6572 732c 0a20 2020 2020  ": hovers,.     
-000102a0: 2020 2020 2020 2020 2020 2022 7922 3a20             "y": 
-000102b0: 7973 2c0a 2020 2020 2020 2020 2020 2020  ys,.            
-000102c0: 2020 2020 2263 6f6c 6f72 223a 2063 6f6c      "color": col
-000102d0: 6f72 732c 0a20 2020 2020 2020 2020 2020  ors,.           
-000102e0: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
-000102f0: 6966 2050 524f 4649 4c49 4e47 3a0a 2020  if PROFILING:.  
-00010300: 2020 2020 2020 2020 2020 2020 2020 6375                cu
-00010310: 7264 6f63 2829 2e61 6464 5f6e 6578 745f  rdoc().add_next_
-00010320: 7469 636b 5f63 616c 6c62 6163 6b28 6c61  tick_callback(la
-00010330: 6d62 6461 3a20 7365 6c66 2e73 6f75 7263  mbda: self.sourc
-00010340: 652e 7374 7265 616d 286e 6577 2c20 3130  e.stream(new, 10
-00010350: 3030 3029 290a 2020 2020 2020 2020 2020  000)).          
-00010360: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00010370: 2020 2020 2020 2020 7365 6c66 2e73 6f75          self.sou
-00010380: 7263 652e 7374 7265 616d 286e 6577 2c20  rce.stream(new, 
-00010390: 3130 3030 3029 0a0a 0a63 6c61 7373 2054  10000)...class T
-000103a0: 6173 6b53 7472 6561 6d28 4461 7368 626f  askStream(Dashbo
-000103b0: 6172 6443 6f6d 706f 6e65 6e74 293a 0a20  ardComponent):. 
-000103c0: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-000103d0: 7365 6c66 2c20 7363 6865 6475 6c65 722c  self, scheduler,
-000103e0: 206e 5f72 6563 7461 6e67 6c65 733d 3130   n_rectangles=10
-000103f0: 3030 2c20 636c 6561 725f 696e 7465 7276  00, clear_interv
-00010400: 616c 3d22 3230 7322 2c20 2a2a 6b77 6172  al="20s", **kwar
-00010410: 6773 293a 0a20 2020 2020 2020 2073 656c  gs):.        sel
-00010420: 662e 7363 6865 6475 6c65 7220 3d20 7363  f.scheduler = sc
-00010430: 6865 6475 6c65 720a 2020 2020 2020 2020  heduler.        
-00010440: 7365 6c66 2e6f 6666 7365 7420 3d20 300a  self.offset = 0.
-00010450: 0a20 2020 2020 2020 2069 6620 5461 736b  .        if Task
-00010460: 5374 7265 616d 506c 7567 696e 2e6e 616d  StreamPlugin.nam
-00010470: 6520 6e6f 7420 696e 2073 656c 662e 7363  e not in self.sc
-00010480: 6865 6475 6c65 722e 706c 7567 696e 733a  heduler.plugins:
-00010490: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000104a0: 662e 7363 6865 6475 6c65 722e 6164 645f  f.scheduler.add_
-000104b0: 706c 7567 696e 2854 6173 6b53 7472 6561  plugin(TaskStrea
-000104c0: 6d50 6c75 6769 6e28 7365 6c66 2e73 6368  mPlugin(self.sch
-000104d0: 6564 756c 6572 2929 0a20 2020 2020 2020  eduler)).       
-000104e0: 2073 656c 662e 706c 7567 696e 203d 2073   self.plugin = s
-000104f0: 656c 662e 7363 6865 6475 6c65 722e 706c  elf.scheduler.pl
-00010500: 7567 696e 735b 5461 736b 5374 7265 616d  ugins[TaskStream
-00010510: 506c 7567 696e 2e6e 616d 655d 0a0a 2020  Plugin.name]..  
-00010520: 2020 2020 2020 7365 6c66 2e69 6e64 6578        self.index
-00010530: 203d 206d 6178 2830 2c20 7365 6c66 2e70   = max(0, self.p
-00010540: 6c75 6769 6e2e 696e 6465 7820 2d20 6e5f  lugin.index - n_
-00010550: 7265 6374 616e 676c 6573 290a 2020 2020  rectangles).    
-00010560: 2020 2020 7365 6c66 2e77 6f72 6b65 7273      self.workers
-00010570: 203d 2064 6963 7428 290a 2020 2020 2020   = dict().      
-00010580: 2020 7365 6c66 2e6e 5f72 6563 7461 6e67    self.n_rectang
-00010590: 6c65 7320 3d20 6e5f 7265 6374 616e 676c  les = n_rectangl
-000105a0: 6573 0a20 2020 2020 2020 2063 6c65 6172  es.        clear
-000105b0: 5f69 6e74 6572 7661 6c20 3d20 7061 7273  _interval = pars
-000105c0: 655f 7469 6d65 6465 6c74 6128 636c 6561  e_timedelta(clea
-000105d0: 725f 696e 7465 7276 616c 2c20 6465 6661  r_interval, defa
-000105e0: 756c 743d 226d 7322 290a 2020 2020 2020  ult="ms").      
-000105f0: 2020 7365 6c66 2e63 6c65 6172 5f69 6e74    self.clear_int
-00010600: 6572 7661 6c20 3d20 636c 6561 725f 696e  erval = clear_in
-00010610: 7465 7276 616c 0a20 2020 2020 2020 2073  terval.        s
-00010620: 656c 662e 6c61 7374 203d 2030 0a20 2020  elf.last = 0.   
-00010630: 2020 2020 2073 656c 662e 6c61 7374 5f73       self.last_s
-00010640: 6565 6e20 3d20 300a 0a20 2020 2020 2020  een = 0..       
-00010650: 2073 656c 662e 736f 7572 6365 2c20 7365   self.source, se
-00010660: 6c66 2e72 6f6f 7420 3d20 7461 736b 5f73  lf.root = task_s
-00010670: 7472 6561 6d5f 6669 6775 7265 2863 6c65  tream_figure(cle
-00010680: 6172 5f69 6e74 6572 7661 6c2c 202a 2a6b  ar_interval, **k
-00010690: 7761 7267 7329 0a0a 2020 2020 2020 2020  wargs)..        
-000106a0: 2320 5265 7175 6972 6564 2066 6f72 2075  # Required for u
-000106b0: 7064 6174 6520 6361 6c6c 6261 636b 0a20  pdate callback. 
-000106c0: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
-000106d0: 5f73 7472 6561 6d5f 696e 6465 7820 3d20  _stream_index = 
-000106e0: 5b30 5d0a 0a20 2020 2040 7769 7468 6f75  [0]..    @withou
-000106f0: 745f 7072 6f70 6572 7479 5f76 616c 6964  t_property_valid
-00010700: 6174 696f 6e0a 2020 2020 406c 6f67 5f65  ation.    @log_e
-00010710: 7272 6f72 730a 2020 2020 6465 6620 7570  rrors.    def up
-00010720: 6461 7465 2873 656c 6629 3a0a 2020 2020  date(self):.    
-00010730: 2020 2020 6966 2073 656c 662e 696e 6465      if self.inde
-00010740: 7820 3d3d 2073 656c 662e 706c 7567 696e  x == self.plugin
-00010750: 2e69 6e64 6578 3a0a 2020 2020 2020 2020  .index:.        
-00010760: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-00010770: 2020 2020 6966 2073 656c 662e 696e 6465      if self.inde
-00010780: 7820 616e 6420 6c65 6e28 7365 6c66 2e73  x and len(self.s
-00010790: 6f75 7263 652e 6461 7461 5b22 7374 6172  ource.data["star
-000107a0: 7422 5d29 3a0a 2020 2020 2020 2020 2020  t"]):.          
-000107b0: 2020 7374 6172 7420 3d20 6d69 6e28 7365    start = min(se
-000107c0: 6c66 2e73 6f75 7263 652e 6461 7461 5b22  lf.source.data["
-000107d0: 7374 6172 7422 5d29 0a20 2020 2020 2020  start"]).       
-000107e0: 2020 2020 2064 7572 6174 696f 6e20 3d20       duration = 
-000107f0: 6d61 7828 7365 6c66 2e73 6f75 7263 652e  max(self.source.
-00010800: 6461 7461 5b22 6475 7261 7469 6f6e 225d  data["duration"]
-00010810: 290a 2020 2020 2020 2020 2020 2020 626f  ).            bo
-00010820: 756e 6461 7279 203d 2028 7365 6c66 2e6f  undary = (self.o
-00010830: 6666 7365 7420 2b20 7374 6172 7420 2d20  ffset + start - 
-00010840: 6475 7261 7469 6f6e 2920 2f20 3130 3030  duration) / 1000
-00010850: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00010860: 2020 2020 2020 2020 2020 2062 6f75 6e64             bound
-00010870: 6172 7920 3d20 7365 6c66 2e6f 6666 7365  ary = self.offse
-00010880: 740a 2020 2020 2020 2020 7265 6374 616e  t.        rectan
-00010890: 676c 6573 203d 2073 656c 662e 706c 7567  gles = self.plug
-000108a0: 696e 2e72 6563 7461 6e67 6c65 7328 0a20  in.rectangles(. 
-000108b0: 2020 2020 2020 2020 2020 2069 7374 6172             istar
-000108c0: 743d 7365 6c66 2e69 6e64 6578 2c20 776f  t=self.index, wo
-000108d0: 726b 6572 733d 7365 6c66 2e77 6f72 6b65  rkers=self.worke
-000108e0: 7273 2c20 7374 6172 745f 626f 756e 6461  rs, start_bounda
-000108f0: 7279 3d62 6f75 6e64 6172 790a 2020 2020  ry=boundary.    
-00010900: 2020 2020 290a 2020 2020 2020 2020 6e20      ).        n 
-00010910: 3d20 6c65 6e28 7265 6374 616e 676c 6573  = len(rectangles
-00010920: 5b22 6e61 6d65 225d 290a 2020 2020 2020  ["name"]).      
-00010930: 2020 7365 6c66 2e69 6e64 6578 203d 2073    self.index = s
-00010940: 656c 662e 706c 7567 696e 2e69 6e64 6578  elf.plugin.index
-00010950: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-00010960: 2072 6563 7461 6e67 6c65 735b 2273 7461   rectangles["sta
-00010970: 7274 225d 3a0a 2020 2020 2020 2020 2020  rt"]:.          
-00010980: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
-00010990: 2020 2320 4966 2069 7420 6861 7320 6265    # If it has be
-000109a0: 656e 2061 2077 6869 6c65 2073 696e 6365  en a while since
-000109b0: 2077 6527 7665 2075 7064 6174 6564 2074   we've updated t
-000109c0: 6865 2070 6c6f 740a 2020 2020 2020 2020  he plot.        
-000109d0: 6966 2074 696d 6528 2920 3e20 7365 6c66  if time() > self
-000109e0: 2e6c 6173 745f 7365 656e 202b 2073 656c  .last_seen + sel
-000109f0: 662e 636c 6561 725f 696e 7465 7276 616c  f.clear_interval
-00010a00: 3a0a 2020 2020 2020 2020 2020 2020 6e65  :.            ne
-00010a10: 775f 7374 6172 7420 3d20 6d69 6e28 7265  w_start = min(re
-00010a20: 6374 616e 676c 6573 5b22 7374 6172 7422  ctangles["start"
-00010a30: 5d29 202d 2073 656c 662e 6f66 6673 6574  ]) - self.offset
-00010a40: 0a20 2020 2020 2020 2020 2020 206f 6c64  .            old
-00010a50: 5f73 7461 7274 203d 206d 696e 2873 656c  _start = min(sel
-00010a60: 662e 736f 7572 6365 2e64 6174 615b 2273  f.source.data["s
-00010a70: 7461 7274 225d 290a 2020 2020 2020 2020  tart"]).        
-00010a80: 2020 2020 6f6c 645f 656e 6420 3d20 6d61      old_end = ma
-00010a90: 7828 0a20 2020 2020 2020 2020 2020 2020  x(.             
-00010aa0: 2020 206d 6170 280a 2020 2020 2020 2020     map(.        
-00010ab0: 2020 2020 2020 2020 2020 2020 6f70 6572              oper
-00010ac0: 6174 6f72 2e61 6464 2c0a 2020 2020 2020  ator.add,.      
-00010ad0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00010ae0: 6c66 2e73 6f75 7263 652e 6461 7461 5b22  lf.source.data["
-00010af0: 7374 6172 7422 5d2c 0a20 2020 2020 2020  start"],.       
-00010b00: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00010b10: 662e 736f 7572 6365 2e64 6174 615b 2264  f.source.data["d
-00010b20: 7572 6174 696f 6e22 5d2c 0a20 2020 2020  uration"],.     
-00010b30: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00010b40: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00010b50: 2020 2020 2020 2020 6465 6e73 6974 7920          density 
-00010b60: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-00010b70: 2020 2020 7375 6d28 7365 6c66 2e73 6f75      sum(self.sou
-00010b80: 7263 652e 6461 7461 5b22 6475 7261 7469  rce.data["durati
-00010b90: 6f6e 225d 290a 2020 2020 2020 2020 2020  on"]).          
-00010ba0: 2020 2020 2020 2f20 6c65 6e28 7365 6c66        / len(self
-00010bb0: 2e77 6f72 6b65 7273 290a 2020 2020 2020  .workers).      
-00010bc0: 2020 2020 2020 2020 2020 2f20 286f 6c64            / (old
-00010bd0: 5f65 6e64 202d 206f 6c64 5f73 7461 7274  _end - old_start
-00010be0: 290a 2020 2020 2020 2020 2020 2020 290a  ).            ).
-00010bf0: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
-00010c00: 6620 7768 6974 6573 7061 6365 2069 7320  f whitespace is 
-00010c10: 6d6f 7265 2074 6861 6e20 3378 2074 6865  more than 3x the
-00010c20: 206f 6c64 2077 6964 7468 0a20 2020 2020   old width.     
-00010c30: 2020 2020 2020 2069 6620 286e 6577 5f73         if (new_s
-00010c40: 7461 7274 202d 206f 6c64 5f65 6e64 2920  tart - old_end) 
-00010c50: 3e20 286f 6c64 5f65 6e64 202d 206f 6c64  > (old_end - old
-00010c60: 5f73 7461 7274 2920 2a20 3220 6f72 2064  _start) * 2 or d
-00010c70: 656e 7369 7479 203c 2030 2e30 353a 0a20  ensity < 0.05:. 
-00010c80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00010c90: 656c 662e 736f 7572 6365 2e64 6174 612e  elf.source.data.
-00010ca0: 7570 6461 7465 287b 6b3a 205b 5d20 666f  update({k: [] fo
-00010cb0: 7220 6b20 696e 2072 6563 7461 6e67 6c65  r k in rectangle
-00010cc0: 737d 2920 2023 2063 6c65 6172 0a20 2020  s})  # clear.   
-00010cd0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00010ce0: 662e 6f66 6673 6574 203d 206d 696e 2872  f.offset = min(r
-00010cf0: 6563 7461 6e67 6c65 735b 2273 7461 7274  ectangles["start
-00010d00: 225d 2920 2023 2072 6564 6566 696e 6520  "])  # redefine 
-00010d10: 6f66 6673 6574 0a0a 2020 2020 2020 2020  offset..        
-00010d20: 7265 6374 616e 676c 6573 5b22 7374 6172  rectangles["star
-00010d30: 7422 5d20 3d20 5b78 202d 2073 656c 662e  t"] = [x - self.
-00010d40: 6f66 6673 6574 2066 6f72 2078 2069 6e20  offset for x in 
-00010d50: 7265 6374 616e 676c 6573 5b22 7374 6172  rectangles["star
-00010d60: 7422 5d5d 0a20 2020 2020 2020 2073 656c  t"]].        sel
-00010d70: 662e 6c61 7374 5f73 6565 6e20 3d20 7469  f.last_seen = ti
-00010d80: 6d65 2829 0a0a 2020 2020 2020 2020 2320  me()..        # 
-00010d90: 436f 6e76 6572 7420 746f 206e 756d 7079  Convert to numpy
-00010da0: 2066 6f72 2073 6572 6961 6c69 7a61 7469   for serializati
-00010db0: 6f6e 2073 7065 6564 0a20 2020 2020 2020  on speed.       
-00010dc0: 2069 6620 6e20 3e3d 2031 3020 616e 6420   if n >= 10 and 
-00010dd0: 6e70 3a0a 2020 2020 2020 2020 2020 2020  np:.            
-00010de0: 666f 7220 6b2c 2076 2069 6e20 7265 6374  for k, v in rect
-00010df0: 616e 676c 6573 2e69 7465 6d73 2829 3a0a  angles.items():.
-00010e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010e10: 6966 2069 7369 6e73 7461 6e63 6528 765b  if isinstance(v[
-00010e20: 305d 2c20 4e75 6d62 6572 293a 0a20 2020  0], Number):.   
-00010e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010e40: 2072 6563 7461 6e67 6c65 735b 6b5d 203d   rectangles[k] =
-00010e50: 206e 702e 6172 7261 7928 7629 0a0a 2020   np.array(v)..  
-00010e60: 2020 2020 2020 6966 2050 524f 4649 4c49        if PROFILI
-00010e70: 4e47 3a0a 2020 2020 2020 2020 2020 2020  NG:.            
-00010e80: 6375 7264 6f63 2829 2e61 6464 5f6e 6578  curdoc().add_nex
-00010e90: 745f 7469 636b 5f63 616c 6c62 6163 6b28  t_tick_callback(
-00010ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010eb0: 206c 616d 6264 613a 2073 656c 662e 736f   lambda: self.so
-00010ec0: 7572 6365 2e73 7472 6561 6d28 7265 6374  urce.stream(rect
-00010ed0: 616e 676c 6573 2c20 7365 6c66 2e6e 5f72  angles, self.n_r
-00010ee0: 6563 7461 6e67 6c65 7329 0a20 2020 2020  ectangles).     
-00010ef0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00010f00: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00010f10: 2020 2073 656c 662e 736f 7572 6365 2e73     self.source.s
-00010f20: 7472 6561 6d28 7265 6374 616e 676c 6573  tream(rectangles
-00010f30: 2c20 7365 6c66 2e6e 5f72 6563 7461 6e67  , self.n_rectang
-00010f40: 6c65 7329 0a0a 0a64 6566 2074 6173 6b5f  les)...def task_
-00010f50: 7374 7265 616d 5f66 6967 7572 6528 636c  stream_figure(cl
-00010f60: 6561 725f 696e 7465 7276 616c 3d22 3230  ear_interval="20
-00010f70: 7322 2c20 2a2a 6b77 6172 6773 293a 0a20  s", **kwargs):. 
-00010f80: 2020 2022 2222 0a20 2020 206b 7761 7267     """.    kwarg
-00010f90: 7320 6172 6520 6170 706c 6965 6420 746f  s are applied to
-00010fa0: 2074 6865 2062 6f6b 6568 2e6d 6f64 656c   the bokeh.model
-00010fb0: 732e 706c 6f74 732e 506c 6f74 2063 6f6e  s.plots.Plot con
-00010fc0: 7374 7275 6374 6f72 0a20 2020 2022 2222  structor.    """
-00010fd0: 0a20 2020 2063 6c65 6172 5f69 6e74 6572  .    clear_inter
-00010fe0: 7661 6c20 3d20 7061 7273 655f 7469 6d65  val = parse_time
-00010ff0: 6465 6c74 6128 636c 6561 725f 696e 7465  delta(clear_inte
-00011000: 7276 616c 2c20 6465 6661 756c 743d 226d  rval, default="m
-00011010: 7322 290a 0a20 2020 2073 6f75 7263 6520  s")..    source 
-00011020: 3d20 436f 6c75 6d6e 4461 7461 536f 7572  = ColumnDataSour
-00011030: 6365 280a 2020 2020 2020 2020 6461 7461  ce(.        data
-00011040: 3d64 6963 7428 0a20 2020 2020 2020 2020  =dict(.         
-00011050: 2020 2073 7461 7274 3d5b 7469 6d65 2829     start=[time()
-00011060: 202d 2063 6c65 6172 5f69 6e74 6572 7661   - clear_interva
-00011070: 6c5d 2c0a 2020 2020 2020 2020 2020 2020  l],.            
-00011080: 6475 7261 7469 6f6e 3d5b 302e 315d 2c0a  duration=[0.1],.
-00011090: 2020 2020 2020 2020 2020 2020 6b65 793d              key=
-000110a0: 5b22 7374 6172 7422 5d2c 0a20 2020 2020  ["start"],.     
-000110b0: 2020 2020 2020 206e 616d 653d 5b22 7374         name=["st
-000110c0: 6172 7422 5d2c 0a20 2020 2020 2020 2020  art"],.         
-000110d0: 2020 2063 6f6c 6f72 3d5b 2277 6869 7465     color=["white
-000110e0: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
-000110f0: 6475 7261 7469 6f6e 5f74 6578 743d 5b22  duration_text=["
-00011100: 3130 3020 6d73 225d 2c0a 2020 2020 2020  100 ms"],.      
-00011110: 2020 2020 2020 776f 726b 6572 3d5b 2266        worker=["f
-00011120: 6f6f 225d 2c0a 2020 2020 2020 2020 2020  oo"],.          
-00011130: 2020 793d 5b30 5d2c 0a20 2020 2020 2020    y=[0],.       
-00011140: 2020 2020 2077 6f72 6b65 725f 7468 7265       worker_thre
-00011150: 6164 3d5b 315d 2c0a 2020 2020 2020 2020  ad=[1],.        
-00011160: 2020 2020 616c 7068 613d 5b30 2e30 5d2c      alpha=[0.0],
-00011170: 0a20 2020 2020 2020 2029 0a20 2020 2029  .        ).    )
-00011180: 0a0a 2020 2020 785f 7261 6e67 6520 3d20  ..    x_range = 
-00011190: 4461 7461 5261 6e67 6531 6428 7261 6e67  DataRange1d(rang
-000111a0: 655f 7061 6464 696e 673d 3029 0a20 2020  e_padding=0).   
-000111b0: 2079 5f72 616e 6765 203d 2044 6174 6152   y_range = DataR
-000111c0: 616e 6765 3164 2872 616e 6765 5f70 6164  ange1d(range_pad
-000111d0: 6469 6e67 3d30 290a 0a20 2020 2072 6f6f  ding=0)..    roo
-000111e0: 7420 3d20 6669 6775 7265 280a 2020 2020  t = figure(.    
-000111f0: 2020 2020 6e61 6d65 3d22 7461 736b 5f73      name="task_s
-00011200: 7472 6561 6d22 2c0a 2020 2020 2020 2020  tream",.        
-00011210: 7469 746c 653d 2254 6173 6b20 5374 7265  title="Task Stre
-00011220: 616d 222c 0a20 2020 2020 2020 2078 5f72  am",.        x_r
-00011230: 616e 6765 3d78 5f72 616e 6765 2c0a 2020  ange=x_range,.  
-00011240: 2020 2020 2020 795f 7261 6e67 653d 795f        y_range=y_
-00011250: 7261 6e67 652c 0a20 2020 2020 2020 2074  range,.        t
-00011260: 6f6f 6c62 6172 5f6c 6f63 6174 696f 6e3d  oolbar_location=
-00011270: 2261 626f 7665 222c 0a20 2020 2020 2020  "above",.       
-00011280: 2078 5f61 7869 735f 7479 7065 3d22 6461   x_axis_type="da
-00011290: 7465 7469 6d65 222c 0a20 2020 2020 2020  tetime",.       
-000112a0: 2079 5f61 7869 735f 6c6f 6361 7469 6f6e   y_axis_location
-000112b0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2074  =None,.        t
-000112c0: 6f6f 6c73 3d22 222c 0a20 2020 2020 2020  ools="",.       
-000112d0: 206d 696e 5f62 6f72 6465 725f 626f 7474   min_border_bott
-000112e0: 6f6d 3d35 302c 0a20 2020 2020 2020 202a  om=50,.        *
-000112f0: 2a6b 7761 7267 732c 0a20 2020 2029 0a0a  *kwargs,.    )..
-00011300: 2020 2020 7265 6374 203d 2072 6f6f 742e      rect = root.
-00011310: 7265 6374 280a 2020 2020 2020 2020 736f  rect(.        so
-00011320: 7572 6365 3d73 6f75 7263 652c 0a20 2020  urce=source,.   
-00011330: 2020 2020 2078 3d22 7374 6172 7422 2c0a       x="start",.
-00011340: 2020 2020 2020 2020 793d 2279 222c 0a20          y="y",. 
-00011350: 2020 2020 2020 2077 6964 7468 3d22 6475         width="du
-00011360: 7261 7469 6f6e 222c 0a20 2020 2020 2020  ration",.       
-00011370: 2068 6569 6768 743d 302e 342c 0a20 2020   height=0.4,.   
-00011380: 2020 2020 2066 696c 6c5f 636f 6c6f 723d       fill_color=
-00011390: 2263 6f6c 6f72 222c 0a20 2020 2020 2020  "color",.       
-000113a0: 206c 696e 655f 636f 6c6f 723d 2263 6f6c   line_color="col
-000113b0: 6f72 222c 0a20 2020 2020 2020 206c 696e  or",.        lin
-000113c0: 655f 616c 7068 613d 302e 362c 0a20 2020  e_alpha=0.6,.   
-000113d0: 2020 2020 2066 696c 6c5f 616c 7068 613d       fill_alpha=
-000113e0: 2261 6c70 6861 222c 0a20 2020 2020 2020  "alpha",.       
-000113f0: 206c 696e 655f 7769 6474 683d 332c 0a20   line_width=3,. 
-00011400: 2020 2029 0a20 2020 2072 6563 742e 6e6f     ).    rect.no
-00011410: 6e73 656c 6563 7469 6f6e 5f67 6c79 7068  nselection_glyph
-00011420: 203d 204e 6f6e 650a 0a20 2020 2072 6f6f   = None..    roo
-00011430: 742e 7961 7869 732e 6d61 6a6f 725f 6c61  t.yaxis.major_la
-00011440: 6265 6c5f 7465 7874 5f61 6c70 6861 203d  bel_text_alpha =
-00011450: 2030 0a20 2020 2072 6f6f 742e 7961 7869   0.    root.yaxi
-00011460: 732e 6d69 6e6f 725f 7469 636b 5f6c 696e  s.minor_tick_lin
-00011470: 655f 616c 7068 6120 3d20 300a 2020 2020  e_alpha = 0.    
-00011480: 726f 6f74 2e79 6178 6973 2e6d 616a 6f72  root.yaxis.major
-00011490: 5f74 6963 6b5f 6c69 6e65 5f61 6c70 6861  _tick_line_alpha
-000114a0: 203d 2030 0a20 2020 2072 6f6f 742e 7867   = 0.    root.xg
-000114b0: 7269 642e 7669 7369 626c 6520 3d20 4661  rid.visible = Fa
-000114c0: 6c73 650a 0a20 2020 2068 6f76 6572 203d  lse..    hover =
-000114d0: 2048 6f76 6572 546f 6f6c 280a 2020 2020   HoverTool(.    
-000114e0: 2020 2020 706f 696e 745f 706f 6c69 6379      point_policy
-000114f0: 3d22 666f 6c6c 6f77 5f6d 6f75 7365 222c  ="follow_mouse",
-00011500: 0a20 2020 2020 2020 2074 6f6f 6c74 6970  .        tooltip
-00011510: 733d 2222 220a 2020 2020 2020 2020 2020  s=""".          
-00011520: 2020 3c64 6976 3e0a 2020 2020 2020 2020    <div>.        
-00011530: 2020 2020 2020 2020 3c73 7061 6e20 7374          <span st
-00011540: 796c 653d 2266 6f6e 742d 7369 7a65 3a20  yle="font-size: 
-00011550: 3132 7078 3b20 666f 6e74 2d77 6569 6768  12px; font-weigh
-00011560: 743a 2062 6f6c 643b 223e 406e 616d 653a  t: bold;">@name:
-00011570: 3c2f 7370 616e 3e26 6e62 7370 3b0a 2020  </span>&nbsp;.  
-00011580: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
-00011590: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
-000115a0: 7369 7a65 3a20 3130 7078 3b20 666f 6e74  size: 10px; font
-000115b0: 2d66 616d 696c 793a 204d 6f6e 6163 6f2c  -family: Monaco,
-000115c0: 206d 6f6e 6f73 7061 6365 3b22 3e40 6475   monospace;">@du
-000115d0: 7261 7469 6f6e 5f74 6578 743c 2f73 7061  ration_text</spa
-000115e0: 6e3e 0a20 2020 2020 2020 2020 2020 203c  n>.            <
-000115f0: 2f64 6976 3e0a 2020 2020 2020 2020 2020  /div>.          
-00011600: 2020 2222 222c 0a20 2020 2029 0a0a 2020    """,.    )..  
-00011610: 2020 7461 7020 3d20 5461 7054 6f6f 6c28    tap = TapTool(
-00011620: 6361 6c6c 6261 636b 3d4f 7065 6e55 524c  callback=OpenURL
-00011630: 2875 726c 3d22 2e2f 7072 6f66 696c 653f  (url="./profile?
-00011640: 6b65 793d 406e 616d 6522 2929 0a20 2020  key=@name")).   
-00011650: 2068 656c 705f 203d 2048 656c 7054 6f6f   help_ = HelpToo
-00011660: 6c28 0a20 2020 2020 2020 2072 6564 6972  l(.        redir
-00011670: 6563 743d 2268 7474 7073 3a2f 2f64 6f63  ect="https://doc
-00011680: 732e 6461 736b 2e6f 7267 2f65 6e2f 7374  s.dask.org/en/st
-00011690: 6162 6c65 2f64 6173 6862 6f61 7264 2e68  able/dashboard.h
-000116a0: 746d 6c23 7461 736b 2d73 7472 6561 6d22  tml#task-stream"
-000116b0: 2c0a 2020 2020 2020 2020 6465 7363 7269  ,.        descri
-000116c0: 7074 696f 6e3d 2241 2064 6573 6372 6970  ption="A descrip
-000116d0: 7469 6f6e 206f 6620 7468 6520 5461 736b  tion of the Task
-000116e0: 5374 7265 616d 2061 6e64 2069 7473 2063  Stream and its c
-000116f0: 6f6c 6f72 2070 616c 6574 7465 2e22 2c0a  olor palette.",.
-00011700: 2020 2020 290a 2020 2020 726f 6f74 2e61      ).    root.a
-00011710: 6464 5f74 6f6f 6c73 280a 2020 2020 2020  dd_tools(.      
-00011720: 2020 686f 7665 722c 0a20 2020 2020 2020    hover,.       
-00011730: 2074 6170 2c0a 2020 2020 2020 2020 426f   tap,.        Bo
-00011740: 785a 6f6f 6d54 6f6f 6c28 292c 0a20 2020  xZoomTool(),.   
-00011750: 2020 2020 2052 6573 6574 546f 6f6c 2829       ResetTool()
-00011760: 2c0a 2020 2020 2020 2020 5061 6e54 6f6f  ,.        PanToo
-00011770: 6c28 6469 6d65 6e73 696f 6e73 3d22 7769  l(dimensions="wi
-00011780: 6474 6822 292c 0a20 2020 2020 2020 2057  dth"),.        W
-00011790: 6865 656c 5a6f 6f6d 546f 6f6c 2864 696d  heelZoomTool(dim
-000117a0: 656e 7369 6f6e 733d 2277 6964 7468 2229  ensions="width")
-000117b0: 2c0a 2020 2020 2020 2020 6865 6c70 5f2c  ,.        help_,
-000117c0: 0a20 2020 2029 0a20 2020 2069 6620 4578  .    ).    if Ex
-000117d0: 706f 7274 546f 6f6c 3a20 2023 2074 7970  portTool:  # typ
-000117e0: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
-000117f0: 2020 6578 706f 7274 203d 2045 7870 6f72    export = Expor
-00011800: 7454 6f6f 6c28 290a 2020 2020 2020 2020  tTool().        
-00011810: 6578 706f 7274 2e72 6567 6973 7465 725f  export.register_
-00011820: 706c 6f74 2872 6f6f 7429 0a20 2020 2020  plot(root).     
-00011830: 2020 2072 6f6f 742e 6164 645f 746f 6f6c     root.add_tool
-00011840: 7328 6578 706f 7274 290a 0a20 2020 2072  s(export)..    r
-00011850: 6574 7572 6e20 736f 7572 6365 2c20 726f  eturn source, ro
-00011860: 6f74 0a0a 0a63 6c61 7373 2054 6173 6b47  ot...class TaskG
-00011870: 7261 7068 2844 6173 6862 6f61 7264 436f  raph(DashboardCo
-00011880: 6d70 6f6e 656e 7429 3a0a 2020 2020 2222  mponent):.    ""
-00011890: 220a 2020 2020 4120 6479 6e61 6d69 6320  ".    A dynamic 
-000118a0: 6e6f 6465 2d6c 696e 6b20 6469 6167 7261  node-link diagra
-000118b0: 6d20 666f 7220 7468 6520 7461 736b 2067  m for the task g
-000118c0: 7261 7068 206f 6e20 7468 6520 7363 6865  raph on the sche
-000118d0: 6475 6c65 720a 0a20 2020 2053 6565 2061  duler..    See a
-000118e0: 6c73 6f20 7468 6520 4772 6170 684c 6179  lso the GraphLay
-000118f0: 6f75 7420 6469 6167 6e6f 7374 6963 2061  out diagnostic a
-00011900: 740a 2020 2020 6469 7374 7269 6275 7465  t.    distribute
-00011910: 642f 6469 6167 6e6f 7374 6963 732f 6772  d/diagnostics/gr
-00011920: 6170 685f 6c61 796f 7574 2e70 790a 2020  aph_layout.py.  
-00011930: 2020 2222 220a 0a20 2020 2064 6566 205f    """..    def _
-00011940: 5f69 6e69 745f 5f28 7365 6c66 2c20 7363  _init__(self, sc
-00011950: 6865 6475 6c65 722c 202a 2a6b 7761 7267  heduler, **kwarg
-00011960: 7329 3a0a 2020 2020 2020 2020 7365 6c66  s):.        self
-00011970: 2e73 6368 6564 756c 6572 203d 2073 6368  .scheduler = sch
-00011980: 6564 756c 6572 0a20 2020 2020 2020 2073  eduler.        s
-00011990: 656c 662e 6c61 796f 7574 203d 2047 7261  elf.layout = Gra
-000119a0: 7068 4c61 796f 7574 2873 6368 6564 756c  phLayout(schedul
-000119b0: 6572 290a 2020 2020 2020 2020 7363 6865  er).        sche
-000119c0: 6475 6c65 722e 6164 645f 706c 7567 696e  duler.add_plugin
-000119d0: 2873 656c 662e 6c61 796f 7574 290a 2020  (self.layout).  
-000119e0: 2020 2020 2020 7365 6c66 2e69 6e76 6973        self.invis
-000119f0: 6962 6c65 5f63 6f75 6e74 203d 2030 2020  ible_count = 0  
-00011a00: 2320 6e75 6d62 6572 206f 6620 696e 7669  # number of invi
-00011a10: 7369 626c 6520 6e6f 6465 730a 0a20 2020  sible nodes..   
-00011a20: 2020 2020 2073 656c 662e 6e6f 6465 5f73       self.node_s
-00011a30: 6f75 7263 6520 3d20 436f 6c75 6d6e 4461  ource = ColumnDa
-00011a40: 7461 536f 7572 6365 280a 2020 2020 2020  taSource(.      
-00011a50: 2020 2020 2020 7b22 7822 3a20 5b5d 2c20        {"x": [], 
-00011a60: 2279 223a 205b 5d2c 2022 6e61 6d65 223a  "y": [], "name":
-00011a70: 205b 5d2c 2022 7374 6174 6522 3a20 5b5d   [], "state": []
-00011a80: 2c20 2276 6973 6962 6c65 223a 205b 5d2c  , "visible": [],
-00011a90: 2022 6b65 7922 3a20 5b5d 7d0a 2020 2020   "key": []}.    
-00011aa0: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-00011ab0: 6c66 2e65 6467 655f 736f 7572 6365 203d  lf.edge_source =
-00011ac0: 2043 6f6c 756d 6e44 6174 6153 6f75 7263   ColumnDataSourc
-00011ad0: 6528 7b22 7822 3a20 5b5d 2c20 2279 223a  e({"x": [], "y":
-00011ae0: 205b 5d2c 2022 7669 7369 626c 6522 3a20   [], "visible": 
-00011af0: 5b5d 7d29 0a0a 2020 2020 2020 2020 6669  []})..        fi
-00011b00: 6c74 6572 203d 2047 726f 7570 4669 6c74  lter = GroupFilt
-00011b10: 6572 2863 6f6c 756d 6e5f 6e61 6d65 3d22  er(column_name="
-00011b20: 7669 7369 626c 6522 2c20 6772 6f75 703d  visible", group=
-00011b30: 2254 7275 6522 290a 2020 2020 2020 2020  "True").        
-00011b40: 6966 2042 4f4b 4548 5f56 4552 5349 4f4e  if BOKEH_VERSION
-00011b50: 2e6d 616a 6f72 203c 2033 3a0a 2020 2020  .major < 3:.    
-00011b60: 2020 2020 2020 2020 6669 6c74 6572 5f6b          filter_k
-00011b70: 7761 7267 7320 3d20 7b22 6669 6c74 6572  wargs = {"filter
-00011b80: 7322 3a20 5b66 696c 7465 725d 7d0a 2020  s": [filter]}.  
-00011b90: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00011ba0: 2020 2020 2020 2020 6669 6c74 6572 5f6b          filter_k
-00011bb0: 7761 7267 7320 3d20 7b22 6669 6c74 6572  wargs = {"filter
-00011bc0: 223a 2066 696c 7465 727d 0a20 2020 2020  ": filter}.     
-00011bd0: 2020 206e 6f64 655f 7669 6577 203d 2043     node_view = C
-00011be0: 4453 5669 6577 282a 2a66 696c 7465 725f  DSView(**filter_
-00011bf0: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
-00011c00: 6564 6765 5f76 6965 7720 3d20 4344 5356  edge_view = CDSV
-00011c10: 6965 7728 2a2a 6669 6c74 6572 5f6b 7761  iew(**filter_kwa
-00011c20: 7267 7329 0a0a 2020 2020 2020 2020 2320  rgs)..        # 
-00011c30: 426f 6b65 6820 3e3d 2033 2e30 2061 7574  Bokeh >= 3.0 aut
-00011c40: 6f6d 6174 6963 616c 6c79 2069 6e66 6572  omatically infer
-00011c50: 7320 7468 6520 736f 7572 6365 2074 6f20  s the source to 
-00011c60: 7573 650a 2020 2020 2020 2020 6966 2042  use.        if B
-00011c70: 4f4b 4548 5f56 4552 5349 4f4e 2e6d 616a  OKEH_VERSION.maj
-00011c80: 6f72 203c 2033 3a0a 2020 2020 2020 2020  or < 3:.        
-00011c90: 2020 2020 6e6f 6465 5f76 6965 772e 736f      node_view.so
-00011ca0: 7572 6365 203d 2073 656c 662e 6e6f 6465  urce = self.node
-00011cb0: 5f73 6f75 7263 650a 2020 2020 2020 2020  _source.        
-00011cc0: 2020 2020 6564 6765 5f76 6965 772e 736f      edge_view.so
-00011cd0: 7572 6365 203d 2073 656c 662e 6564 6765  urce = self.edge
-00011ce0: 5f73 6f75 7263 650a 0a20 2020 2020 2020  _source..       
-00011cf0: 206e 6f64 655f 636f 6c6f 7273 203d 2066   node_colors = f
-00011d00: 6163 746f 725f 636d 6170 280a 2020 2020  actor_cmap(.    
-00011d10: 2020 2020 2020 2020 2273 7461 7465 222c          "state",
-00011d20: 0a20 2020 2020 2020 2020 2020 2066 6163  .            fac
-00011d30: 746f 7273 3d5b 2277 6169 7469 6e67 222c  tors=["waiting",
-00011d40: 2022 7175 6575 6564 222c 2022 7072 6f63   "queued", "proc
-00011d50: 6573 7369 6e67 222c 2022 6d65 6d6f 7279  essing", "memory
-00011d60: 222c 2022 7265 6c65 6173 6564 222c 2022  ", "released", "
-00011d70: 6572 7265 6422 5d2c 0a20 2020 2020 2020  erred"],.       
-00011d80: 2020 2020 2070 616c 6574 7465 3d5b 2267       palette=["g
-00011d90: 7261 7922 2c20 2279 656c 6c6f 7722 2c20  ray", "yellow", 
-00011da0: 2267 7265 656e 222c 2022 7265 6422 2c20  "green", "red", 
-00011db0: 2262 6c75 6522 2c20 2262 6c61 636b 225d  "blue", "black"]
-00011dc0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-00011dd0: 2020 2020 2073 656c 662e 726f 6f74 203d       self.root =
-00011de0: 2066 6967 7572 6528 7469 746c 653d 2254   figure(title="T
-00011df0: 6173 6b20 4772 6170 6822 2c20 2a2a 6b77  ask Graph", **kw
-00011e00: 6172 6773 290a 2020 2020 2020 2020 7365  args).        se
-00011e10: 6c66 2e73 7562 7469 746c 6520 3d20 5469  lf.subtitle = Ti
-00011e20: 746c 6528 7465 7874 3d22 2022 2c20 7465  tle(text=" ", te
-00011e30: 7874 5f66 6f6e 745f 7374 796c 653d 2269  xt_font_style="i
-00011e40: 7461 6c69 6322 290a 2020 2020 2020 2020  talic").        
-00011e50: 7365 6c66 2e72 6f6f 742e 6164 645f 6c61  self.root.add_la
-00011e60: 796f 7574 2873 656c 662e 7375 6274 6974  yout(self.subtit
-00011e70: 6c65 2c20 2261 626f 7665 2229 0a0a 2020  le, "above")..  
-00011e80: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-00011e90: 6d75 6c74 695f 6c69 6e65 280a 2020 2020  multi_line(.    
-00011ea0: 2020 2020 2020 2020 7873 3d22 7822 2c0a          xs="x",.
-00011eb0: 2020 2020 2020 2020 2020 2020 7973 3d22              ys="
-00011ec0: 7922 2c0a 2020 2020 2020 2020 2020 2020  y",.            
-00011ed0: 736f 7572 6365 3d73 656c 662e 6564 6765  source=self.edge
-00011ee0: 5f73 6f75 7263 652c 0a20 2020 2020 2020  _source,.       
-00011ef0: 2020 2020 206c 696e 655f 7769 6474 683d       line_width=
-00011f00: 312c 0a20 2020 2020 2020 2020 2020 2076  1,.            v
-00011f10: 6965 773d 6564 6765 5f76 6965 772c 0a20  iew=edge_view,. 
-00011f20: 2020 2020 2020 2020 2020 2063 6f6c 6f72             color
-00011f30: 3d22 626c 6163 6b22 2c0a 2020 2020 2020  ="black",.      
-00011f40: 2020 2020 2020 616c 7068 613d 302e 332c        alpha=0.3,
-00011f50: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00011f60: 2020 2072 6563 7420 3d20 7365 6c66 2e72     rect = self.r
-00011f70: 6f6f 742e 7371 7561 7265 280a 2020 2020  oot.square(.    
-00011f80: 2020 2020 2020 2020 783d 2278 222c 0a20          x="x",. 
-00011f90: 2020 2020 2020 2020 2020 2079 3d22 7922             y="y"
-00011fa0: 2c0a 2020 2020 2020 2020 2020 2020 7369  ,.            si
-00011fb0: 7a65 3d31 302c 0a20 2020 2020 2020 2020  ze=10,.         
-00011fc0: 2020 2063 6f6c 6f72 3d6e 6f64 655f 636f     color=node_co
-00011fd0: 6c6f 7273 2c0a 2020 2020 2020 2020 2020  lors,.          
-00011fe0: 2020 736f 7572 6365 3d73 656c 662e 6e6f    source=self.no
-00011ff0: 6465 5f73 6f75 7263 652c 0a20 2020 2020  de_source,.     
-00012000: 2020 2020 2020 2076 6965 773d 6e6f 6465         view=node
-00012010: 5f76 6965 772c 0a20 2020 2020 2020 2020  _view,.         
-00012020: 2020 206c 6567 656e 645f 6669 656c 643d     legend_field=
-00012030: 2273 7461 7465 222c 0a20 2020 2020 2020  "state",.       
-00012040: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
-00012050: 726f 6f74 2e78 6772 6964 2e67 7269 645f  root.xgrid.grid_
-00012060: 6c69 6e65 5f63 6f6c 6f72 203d 204e 6f6e  line_color = Non
-00012070: 650a 2020 2020 2020 2020 7365 6c66 2e72  e.        self.r
-00012080: 6f6f 742e 7967 7269 642e 6772 6964 5f6c  oot.ygrid.grid_l
-00012090: 696e 655f 636f 6c6f 7220 3d20 4e6f 6e65  ine_color = None
-000120a0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-000120b0: 6f74 2e78 6178 6973 2e76 6973 6962 6c65  ot.xaxis.visible
-000120c0: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-000120d0: 2073 656c 662e 726f 6f74 2e79 6178 6973   self.root.yaxis
-000120e0: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
-000120f0: 0a0a 2020 2020 2020 2020 686f 7665 7220  ..        hover 
-00012100: 3d20 486f 7665 7254 6f6f 6c28 0a20 2020  = HoverTool(.   
-00012110: 2020 2020 2020 2020 2070 6f69 6e74 5f70           point_p
-00012120: 6f6c 6963 793d 2266 6f6c 6c6f 775f 6d6f  olicy="follow_mo
-00012130: 7573 6522 2c0a 2020 2020 2020 2020 2020  use",.          
-00012140: 2020 746f 6f6c 7469 7073 3d22 3c62 3e40    tooltips="<b>@
-00012150: 6e61 6d65 3c2f 623e 3a20 4073 7461 7465  name</b>: @state
-00012160: 222c 0a20 2020 2020 2020 2020 2020 2072  ",.            r
-00012170: 656e 6465 7265 7273 3d5b 7265 6374 5d2c  enderers=[rect],
-00012180: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00012190: 2020 2074 6170 203d 2054 6170 546f 6f6c     tap = TapTool
-000121a0: 2863 616c 6c62 6163 6b3d 4f70 656e 5552  (callback=OpenUR
-000121b0: 4c28 7572 6c3d 2269 6e66 6f2f 7461 736b  L(url="info/task
-000121c0: 2f40 6b65 792e 6874 6d6c 2229 2c20 7265  /@key.html"), re
-000121d0: 6e64 6572 6572 733d 5b72 6563 745d 290a  nderers=[rect]).
-000121e0: 2020 2020 2020 2020 7265 6374 2e6e 6f6e          rect.non
-000121f0: 7365 6c65 6374 696f 6e5f 676c 7970 6820  selection_glyph 
-00012200: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
-00012210: 656c 662e 726f 6f74 2e61 6464 5f74 6f6f  elf.root.add_too
-00012220: 6c73 2868 6f76 6572 2c20 7461 7029 0a20  ls(hover, tap). 
-00012230: 2020 2020 2020 2073 656c 662e 6d61 785f         self.max_
-00012240: 6974 656d 7320 3d20 636f 6e66 6967 2e67  items = config.g
-00012250: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
-00012260: 6461 7368 626f 6172 642e 6772 6170 682d  dashboard.graph-
-00012270: 6d61 782d 6974 656d 7322 2c20 3530 3030  max-items", 5000
-00012280: 290a 0a20 2020 2040 7769 7468 6f75 745f  )..    @without_
-00012290: 7072 6f70 6572 7479 5f76 616c 6964 6174  property_validat
-000122a0: 696f 6e0a 2020 2020 406c 6f67 5f65 7272  ion.    @log_err
-000122b0: 6f72 730a 2020 2020 6465 6620 7570 6461  ors.    def upda
-000122c0: 7465 2873 656c 6629 3a0a 2020 2020 2020  te(self):.      
-000122d0: 2020 2320 4966 2074 6865 7265 2061 7265    # If there are
-000122e0: 2074 6f6f 206d 616e 7920 7461 736b 7320   too many tasks 
-000122f0: 696e 2074 6865 2073 6368 6564 756c 6572  in the scheduler
-00012300: 2077 6527 6c6c 2064 6973 6162 6c65 2074   we'll disable t
-00012310: 6869 730a 2020 2020 2020 2020 2320 636f  his.        # co
-00012320: 6d70 6f6f 6e65 6e74 7320 746f 206e 6f74  mpoonents to not
-00012330: 206f 7665 726c 6f61 6420 7363 6865 6475   overload schedu
-00012340: 6c65 7220 6f72 2063 6c69 656e 742e 204f  ler or client. O
-00012350: 6e63 6520 7765 2064 726f 700a 2020 2020  nce we drop.    
-00012360: 2020 2020 2320 6265 6c6f 7720 7468 6520      # below the 
-00012370: 7468 7265 7368 6f6c 642c 2074 6865 2064  threshold, the d
-00012380: 6174 6120 6973 2066 696c 6c65 6420 7570  ata is filled up
-00012390: 2061 6761 696e 2061 7320 7573 7561 6c0a   again as usual.
-000123a0: 2020 2020 2020 2020 6966 206c 656e 2873          if len(s
-000123b0: 656c 662e 7363 6865 6475 6c65 722e 7461  elf.scheduler.ta
-000123c0: 736b 7329 203e 2073 656c 662e 6d61 785f  sks) > self.max_
-000123d0: 6974 656d 733a 0a20 2020 2020 2020 2020  items:.         
-000123e0: 2020 2073 656c 662e 7375 6274 6974 6c65     self.subtitle
-000123f0: 2e74 6578 7420 3d20 2253 6368 6564 756c  .text = "Schedul
-00012400: 6572 2068 6173 2074 6f6f 206d 616e 7920  er has too many 
-00012410: 7461 736b 7320 746f 2064 6973 706c 6179  tasks to display
-00012420: 2e22 0a20 2020 2020 2020 2020 2020 2066  .".            f
-00012430: 6f72 2063 6f6e 7461 696e 6572 2069 6e20  or container in 
-00012440: 5b73 656c 662e 6e6f 6465 5f73 6f75 7263  [self.node_sourc
-00012450: 652c 2073 656c 662e 6564 6765 5f73 6f75  e, self.edge_sou
-00012460: 7263 655d 3a0a 2020 2020 2020 2020 2020  rce]:.          
-00012470: 2020 2020 2020 636f 6e74 6169 6e65 722e        container.
-00012480: 6461 7461 203d 207b 636f 6c3a 205b 5d20  data = {col: [] 
-00012490: 666f 7220 636f 6c20 696e 2063 6f6e 7461  for col in conta
-000124a0: 696e 6572 2e63 6f6c 756d 6e5f 6e61 6d65  iner.column_name
-000124b0: 737d 0a20 2020 2020 2020 2065 6c73 653a  s}.        else:
-000124c0: 0a20 2020 2020 2020 2020 2020 2023 206f  .            # o
-000124d0: 6363 6173 696f 6e61 6c6c 7920 7265 7365  ccasionally rese
-000124e0: 7420 7468 6520 636f 6c75 6d6e 2064 6174  t the column dat
-000124f0: 6120 736f 7572 6365 2074 6f20 7265 6d6f  a source to remo
-00012500: 7665 206f 6c64 206e 6f64 6573 0a20 2020  ve old nodes.   
-00012510: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00012520: 2e69 6e76 6973 6962 6c65 5f63 6f75 6e74  .invisible_count
-00012530: 203e 206c 656e 2873 656c 662e 6e6f 6465   > len(self.node
-00012540: 5f73 6f75 7263 652e 6461 7461 5b22 7822  _source.data["x"
-00012550: 5d29 202f 2032 3a0a 2020 2020 2020 2020  ]) / 2:.        
-00012560: 2020 2020 2020 2020 7365 6c66 2e6c 6179          self.lay
-00012570: 6f75 742e 7265 7365 745f 696e 6465 7828  out.reset_index(
-00012580: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00012590: 2020 7365 6c66 2e69 6e76 6973 6962 6c65    self.invisible
-000125a0: 5f63 6f75 6e74 203d 2030 0a20 2020 2020  _count = 0.     
-000125b0: 2020 2020 2020 2020 2020 2075 7064 6174             updat
-000125c0: 6520 3d20 5472 7565 0a20 2020 2020 2020  e = True.       
-000125d0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000125e0: 2020 2020 2020 2020 2020 2075 7064 6174             updat
-000125f0: 6520 3d20 4661 6c73 650a 0a20 2020 2020  e = False..     
-00012600: 2020 2020 2020 206e 6577 2c20 7365 6c66         new, self
-00012610: 2e6c 6179 6f75 742e 6e65 7720 3d20 7365  .layout.new = se
-00012620: 6c66 2e6c 6179 6f75 742e 6e65 772c 205b  lf.layout.new, [
-00012630: 5d0a 2020 2020 2020 2020 2020 2020 6e65  ].            ne
-00012640: 775f 6564 6765 7320 3d20 7365 6c66 2e6c  w_edges = self.l
-00012650: 6179 6f75 742e 6e65 775f 6564 6765 730a  ayout.new_edges.
-00012660: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00012670: 2e6c 6179 6f75 742e 6e65 775f 6564 6765  .layout.new_edge
-00012680: 7320 3d20 5b5d 0a0a 2020 2020 2020 2020  s = []..        
-00012690: 2020 2020 7365 6c66 2e61 6464 5f6e 6577      self.add_new
-000126a0: 5f6e 6f64 6573 5f65 6467 6573 286e 6577  _nodes_edges(new
-000126b0: 2c20 6e65 775f 6564 6765 732c 2075 7064  , new_edges, upd
-000126c0: 6174 653d 7570 6461 7465 290a 0a20 2020  ate=update)..   
-000126d0: 2020 2020 2020 2020 2073 656c 662e 7061           self.pa
-000126e0: 7463 685f 7570 6461 7465 7328 290a 0a20  tch_updates().. 
-000126f0: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
-00012700: 6e28 7365 6c66 2e73 6368 6564 756c 6572  n(self.scheduler
-00012710: 2e74 6173 6b73 2920 3d3d 2030 3a0a 2020  .tasks) == 0:.  
-00012720: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00012730: 6c66 2e73 7562 7469 746c 652e 7465 7874  lf.subtitle.text
-00012740: 203d 2022 5363 6865 6475 6c65 7220 6973   = "Scheduler is
-00012750: 2065 6d70 7479 2e22 0a20 2020 2020 2020   empty.".       
-00012760: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00012770: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00012780: 7375 6274 6974 6c65 2e74 6578 7420 3d20  subtitle.text = 
-00012790: 2220 220a 0a20 2020 2040 7769 7468 6f75  " "..    @withou
-000127a0: 745f 7072 6f70 6572 7479 5f76 616c 6964  t_property_valid
-000127b0: 6174 696f 6e0a 2020 2020 6465 6620 6164  ation.    def ad
-000127c0: 645f 6e65 775f 6e6f 6465 735f 6564 6765  d_new_nodes_edge
-000127d0: 7328 7365 6c66 2c20 6e65 772c 206e 6577  s(self, new, new
-000127e0: 5f65 6467 6573 2c20 7570 6461 7465 3d46  _edges, update=F
-000127f0: 616c 7365 293a 0a20 2020 2020 2020 2069  alse):.        i
-00012800: 6620 6e65 7720 6f72 2075 7064 6174 653a  f new or update:
-00012810: 0a20 2020 2020 2020 2020 2020 206e 6f64  .            nod
-00012820: 655f 6b65 7920 3d20 5b5d 0a20 2020 2020  e_key = [].     
-00012830: 2020 2020 2020 206e 6f64 655f 7820 3d20         node_x = 
-00012840: 5b5d 0a20 2020 2020 2020 2020 2020 206e  [].            n
-00012850: 6f64 655f 7920 3d20 5b5d 0a20 2020 2020  ode_y = [].     
-00012860: 2020 2020 2020 206e 6f64 655f 7374 6174         node_stat
-00012870: 6520 3d20 5b5d 0a20 2020 2020 2020 2020  e = [].         
-00012880: 2020 206e 6f64 655f 6e61 6d65 203d 205b     node_name = [
-00012890: 5d0a 2020 2020 2020 2020 2020 2020 6564  ].            ed
-000128a0: 6765 5f78 203d 205b 5d0a 2020 2020 2020  ge_x = [].      
-000128b0: 2020 2020 2020 6564 6765 5f79 203d 205b        edge_y = [
-000128c0: 5d0a 0a20 2020 2020 2020 2020 2020 2078  ]..            x
-000128d0: 203d 2073 656c 662e 6c61 796f 7574 2e78   = self.layout.x
-000128e0: 0a20 2020 2020 2020 2020 2020 2079 203d  .            y =
-000128f0: 2073 656c 662e 6c61 796f 7574 2e79 0a0a   self.layout.y..
-00012900: 2020 2020 2020 2020 2020 2020 7461 736b              task
-00012910: 7320 3d20 7365 6c66 2e73 6368 6564 756c  s = self.schedul
-00012920: 6572 2e74 6173 6b73 0a20 2020 2020 2020  er.tasks.       
-00012930: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
-00012940: 6e65 773a 0a20 2020 2020 2020 2020 2020  new:.           
-00012950: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00012960: 2020 2020 2020 2020 2020 2020 2020 7461                ta
-00012970: 736b 203d 2074 6173 6b73 5b6b 6579 5d0a  sk = tasks[key].
-00012980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012990: 6578 6365 7074 204b 6579 4572 726f 723a  except KeyError:
-000129a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000129b0: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
-000129c0: 2020 2020 2020 2020 2020 2020 2020 7878                xx
-000129d0: 203d 2078 5b6b 6579 5d0a 2020 2020 2020   = x[key].      
-000129e0: 2020 2020 2020 2020 2020 7979 203d 2079            yy = y
-000129f0: 5b6b 6579 5d0a 2020 2020 2020 2020 2020  [key].          
-00012a00: 2020 2020 2020 6e6f 6465 5f6b 6579 2e61        node_key.a
-00012a10: 7070 656e 6428 6573 6361 7065 2e75 726c  ppend(escape.url
-00012a20: 5f65 7363 6170 6528 6b65 7929 290a 2020  _escape(key)).  
-00012a30: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-00012a40: 6465 5f78 2e61 7070 656e 6428 7878 290a  de_x.append(xx).
-00012a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012a60: 6e6f 6465 5f79 2e61 7070 656e 6428 7979  node_y.append(yy
-00012a70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00012a80: 2020 6e6f 6465 5f73 7461 7465 2e61 7070    node_state.app
-00012a90: 656e 6428 7461 736b 2e73 7461 7465 290a  end(task.state).
-00012aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ab0: 6e6f 6465 5f6e 616d 652e 6170 7065 6e64  node_name.append
-00012ac0: 2874 6173 6b2e 7072 6566 6978 2e6e 616d  (task.prefix.nam
-00012ad0: 6529 0a0a 2020 2020 2020 2020 2020 2020  e)..            
-00012ae0: 666f 7220 612c 2062 2069 6e20 6e65 775f  for a, b in new_
-00012af0: 6564 6765 733a 0a20 2020 2020 2020 2020  edges:.         
-00012b00: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00012b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012b20: 6564 6765 5f78 2e61 7070 656e 6428 5b78  edge_x.append([x
-00012b30: 5b61 5d2c 2078 5b62 5d5d 290a 2020 2020  [a], x[b]]).    
-00012b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012b50: 6564 6765 5f79 2e61 7070 656e 6428 5b79  edge_y.append([y
-00012b60: 5b61 5d2c 2079 5b62 5d5d 290a 2020 2020  [a], y[b]]).    
-00012b70: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-00012b80: 7074 204b 6579 4572 726f 723a 0a20 2020  pt KeyError:.   
-00012b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ba0: 2070 6173 730a 0a20 2020 2020 2020 2020   pass..         
-00012bb0: 2020 206e 6f64 6520 3d20 7b0a 2020 2020     node = {.    
-00012bc0: 2020 2020 2020 2020 2020 2020 2278 223a              "x":
-00012bd0: 206e 6f64 655f 782c 0a20 2020 2020 2020   node_x,.       
-00012be0: 2020 2020 2020 2020 2022 7922 3a20 6e6f           "y": no
-00012bf0: 6465 5f79 2c0a 2020 2020 2020 2020 2020  de_y,.          
-00012c00: 2020 2020 2020 2273 7461 7465 223a 206e        "state": n
-00012c10: 6f64 655f 7374 6174 652c 0a20 2020 2020  ode_state,.     
-00012c20: 2020 2020 2020 2020 2020 2022 6e61 6d65             "name
-00012c30: 223a 206e 6f64 655f 6e61 6d65 2c0a 2020  ": node_name,.  
-00012c40: 2020 2020 2020 2020 2020 2020 2020 226b                "k
-00012c50: 6579 223a 206e 6f64 655f 6b65 792c 0a20  ey": node_key,. 
-00012c60: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00012c70: 7669 7369 626c 6522 3a20 5b22 5472 7565  visible": ["True
-00012c80: 225d 202a 206c 656e 286e 6f64 655f 7829  "] * len(node_x)
-00012c90: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
-00012ca0: 2020 2020 2020 2020 2020 2020 6564 6765              edge
-00012cb0: 203d 207b 2278 223a 2065 6467 655f 782c   = {"x": edge_x,
-00012cc0: 2022 7922 3a20 6564 6765 5f79 2c20 2276   "y": edge_y, "v
-00012cd0: 6973 6962 6c65 223a 205b 2254 7275 6522  isible": ["True"
-00012ce0: 5d20 2a20 6c65 6e28 6564 6765 5f78 297d  ] * len(edge_x)}
-00012cf0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00012d00: 2075 7064 6174 6520 6f72 206e 6f74 206c   update or not l
-00012d10: 656e 2873 656c 662e 6e6f 6465 5f73 6f75  en(self.node_sou
-00012d20: 7263 652e 6461 7461 5b22 7822 5d29 3a0a  rce.data["x"]):.
-00012d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012d40: 2320 7365 6520 6874 7470 733a 2f2f 6769  # see https://gi
-00012d50: 7468 7562 2e63 6f6d 2f62 6f6b 6568 2f62  thub.com/bokeh/b
-00012d60: 6f6b 6568 2f69 7373 7565 732f 3735 3233  okeh/issues/7523
-00012d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012d80: 2073 656c 662e 6e6f 6465 5f73 6f75 7263   self.node_sourc
-00012d90: 652e 6461 7461 2e75 7064 6174 6528 6e6f  e.data.update(no
-00012da0: 6465 290a 2020 2020 2020 2020 2020 2020  de).            
-00012db0: 2020 2020 7365 6c66 2e65 6467 655f 736f      self.edge_so
-00012dc0: 7572 6365 2e64 6174 612e 7570 6461 7465  urce.data.update
-00012dd0: 2865 6467 6529 0a20 2020 2020 2020 2020  (edge).         
-00012de0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00012df0: 2020 2020 2020 2020 2073 656c 662e 6e6f           self.no
-00012e00: 6465 5f73 6f75 7263 652e 7374 7265 616d  de_source.stream
-00012e10: 286e 6f64 6529 0a20 2020 2020 2020 2020  (node).         
-00012e20: 2020 2020 2020 2073 656c 662e 6564 6765         self.edge
-00012e30: 5f73 6f75 7263 652e 7374 7265 616d 2865  _source.stream(e
-00012e40: 6467 6529 0a0a 2020 2020 4077 6974 686f  dge)..    @witho
-00012e50: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
-00012e60: 6461 7469 6f6e 0a20 2020 2064 6566 2070  dation.    def p
-00012e70: 6174 6368 5f75 7064 6174 6573 2873 656c  atch_updates(sel
-00012e80: 6629 3a0a 2020 2020 2020 2020 2222 220a  f):.        """.
-00012e90: 2020 2020 2020 2020 536d 616c 6c20 7570          Small up
-00012ea0: 6461 7465 7320 6c69 6b65 2063 6f6c 6f72  dates like color
-00012eb0: 2063 6861 6e67 6573 206f 7220 6c6f 7374   changes or lost
-00012ec0: 206e 6f64 6573 2066 726f 6d20 7461 736b   nodes from task
-00012ed0: 2074 7261 6e73 6974 696f 6e73 0a20 2020   transitions.   
-00012ee0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00012ef0: 206e 203d 206c 656e 2873 656c 662e 6e6f   n = len(self.no
-00012f00: 6465 5f73 6f75 7263 652e 6461 7461 5b22  de_source.data["
-00012f10: 7822 5d29 0a20 2020 2020 2020 206d 203d  x"]).        m =
-00012f20: 206c 656e 2873 656c 662e 6564 6765 5f73   len(self.edge_s
-00012f30: 6f75 7263 652e 6461 7461 5b22 7822 5d29  ource.data["x"])
-00012f40: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00012f50: 662e 6c61 796f 7574 2e73 7461 7465 5f75  f.layout.state_u
-00012f60: 7064 6174 6573 3a0a 2020 2020 2020 2020  pdates:.        
-00012f70: 2020 2020 7374 6174 655f 7570 6461 7465      state_update
-00012f80: 7320 3d20 7365 6c66 2e6c 6179 6f75 742e  s = self.layout.
-00012f90: 7374 6174 655f 7570 6461 7465 730a 2020  state_updates.  
-00012fa0: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
-00012fb0: 6179 6f75 742e 7374 6174 655f 7570 6461  ayout.state_upda
-00012fc0: 7465 7320 3d20 5b5d 0a20 2020 2020 2020  tes = [].       
-00012fd0: 2020 2020 2075 7064 6174 6573 203d 205b       updates = [
-00012fe0: 2869 2c20 6329 2066 6f72 2069 2c20 6320  (i, c) for i, c 
-00012ff0: 696e 2073 7461 7465 5f75 7064 6174 6573  in state_updates
-00013000: 2069 6620 6920 3c20 6e5d 0a20 2020 2020   if i < n].     
-00013010: 2020 2020 2020 2073 656c 662e 6e6f 6465         self.node
-00013020: 5f73 6f75 7263 652e 7061 7463 6828 7b22  _source.patch({"
-00013030: 7374 6174 6522 3a20 7570 6461 7465 737d  state": updates}
-00013040: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
-00013050: 6c66 2e6c 6179 6f75 742e 7669 7369 626c  lf.layout.visibl
-00013060: 655f 7570 6461 7465 733a 0a20 2020 2020  e_updates:.     
-00013070: 2020 2020 2020 2075 7064 6174 6573 203d         updates =
-00013080: 2073 656c 662e 6c61 796f 7574 2e76 6973   self.layout.vis
-00013090: 6962 6c65 5f75 7064 6174 6573 0a20 2020  ible_updates.   
-000130a0: 2020 2020 2020 2020 2075 7064 6174 6573           updates
-000130b0: 203d 205b 2869 2c20 6329 2066 6f72 2069   = [(i, c) for i
-000130c0: 2c20 6320 696e 2075 7064 6174 6573 2069  , c in updates i
-000130d0: 6620 6920 3c20 6e5d 0a20 2020 2020 2020  f i < n].       
-000130e0: 2020 2020 2073 656c 662e 6c61 796f 7574       self.layout
-000130f0: 2e76 6973 6962 6c65 5f75 7064 6174 6573  .visible_updates
-00013100: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
-00013110: 2020 7365 6c66 2e6e 6f64 655f 736f 7572    self.node_sour
-00013120: 6365 2e70 6174 6368 287b 2276 6973 6962  ce.patch({"visib
-00013130: 6c65 223a 2075 7064 6174 6573 7d29 0a20  le": updates}). 
-00013140: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00013150: 696e 7669 7369 626c 655f 636f 756e 7420  invisible_count 
-00013160: 2b3d 206c 656e 2875 7064 6174 6573 290a  += len(updates).
-00013170: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00013180: 2e6c 6179 6f75 742e 7669 7369 626c 655f  .layout.visible_
-00013190: 6564 6765 5f75 7064 6174 6573 3a0a 2020  edge_updates:.  
-000131a0: 2020 2020 2020 2020 2020 7570 6461 7465            update
-000131b0: 7320 3d20 7365 6c66 2e6c 6179 6f75 742e  s = self.layout.
-000131c0: 7669 7369 626c 655f 6564 6765 5f75 7064  visible_edge_upd
-000131d0: 6174 6573 0a20 2020 2020 2020 2020 2020  ates.           
-000131e0: 2075 7064 6174 6573 203d 205b 2869 2c20   updates = [(i, 
-000131f0: 6329 2066 6f72 2069 2c20 6320 696e 2075  c) for i, c in u
-00013200: 7064 6174 6573 2069 6620 6920 3c20 6d5d  pdates if i < m]
-00013210: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00013220: 662e 6c61 796f 7574 2e76 6973 6962 6c65  f.layout.visible
-00013230: 5f65 6467 655f 7570 6461 7465 7320 3d20  _edge_updates = 
-00013240: 5b5d 0a20 2020 2020 2020 2020 2020 2073  [].            s
-00013250: 656c 662e 6564 6765 5f73 6f75 7263 652e  elf.edge_source.
-00013260: 7061 7463 6828 7b22 7669 7369 626c 6522  patch({"visible"
-00013270: 3a20 7570 6461 7465 737d 290a 0a20 2020  : updates})..   
-00013280: 2064 6566 205f 5f64 656c 5f5f 2873 656c   def __del__(sel
-00013290: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-000132a0: 2e73 6368 6564 756c 6572 2e72 656d 6f76  .scheduler.remov
-000132b0: 655f 706c 7567 696e 286e 616d 653d 7365  e_plugin(name=se
-000132c0: 6c66 2e6c 6179 6f75 742e 6e61 6d65 290a  lf.layout.name).
-000132d0: 0a0a 636c 6173 7320 5461 736b 4772 6f75  ..class TaskGrou
-000132e0: 7047 7261 7068 2844 6173 6862 6f61 7264  pGraph(Dashboard
-000132f0: 436f 6d70 6f6e 656e 7429 3a0a 2020 2020  Component):.    
-00013300: 2222 220a 2020 2020 5461 736b 2047 726f  """.    Task Gro
-00013310: 7570 2047 7261 7068 0a0a 2020 2020 4372  up Graph..    Cr
-00013320: 6561 7465 7320 6120 6772 6170 6820 6c61  eates a graph la
-00013330: 796f 7574 2066 6f72 2054 6173 6b47 726f  yout for TaskGro
-00013340: 7570 7320 6f6e 2074 6865 2073 6368 6564  ups on the sched
-00013350: 756c 6572 2e20 2049 7420 6173 7369 676e  uler.  It assign
-00013360: 730a 2020 2020 2878 2c20 7929 206c 6f63  s.    (x, y) loc
-00013370: 6174 696f 6e73 2074 6f20 616c 6c20 7468  ations to all th
-00013380: 6520 5461 736b 4772 6f75 7073 2061 6e64  e TaskGroups and
-00013390: 206c 6179 7320 7468 656d 206f 7574 2062   lays them out b
-000133a0: 7920 6163 636f 7264 696e 670a 2020 2020  y according.    
-000133b0: 746f 2074 6865 6972 2064 6570 656e 6465  to their depende
-000133c0: 6e63 6965 732e 2054 6865 206c 6179 6f75  ncies. The layou
-000133d0: 7420 6765 7473 2075 7064 6174 6564 2065  t gets updated e
-000133e0: 7665 7279 2074 696d 6520 7468 6174 206e  very time that n
-000133f0: 6577 0a20 2020 2054 6173 6b47 726f 7570  ew.    TaskGroup
-00013400: 7320 6172 6520 6164 6465 642e 0a0a 2020  s are added...  
-00013410: 2020 4561 6368 2074 6173 6b20 6772 6f75    Each task grou
-00013420: 7020 6e6f 6465 2069 6e63 6f64 6573 2069  p node incodes i
-00013430: 6e66 6f72 6d61 7469 6f6e 2061 626f 7574  nformation about
-00013440: 2074 6173 6b20 7072 6f67 7265 7373 2c20   task progress, 
-00013450: 6d65 6d6f 7279 2c0a 2020 2020 616e 6420  memory,.    and 
-00013460: 6f75 7470 7574 2074 7970 6520 696e 746f  output type into
-00013470: 2067 6c79 7068 732c 2061 7320 7765 6c6c   glyphs, as well
-00013480: 2061 7320 6120 686f 7665 7220 746f 6f6c   as a hover tool
-00013490: 7469 7020 7769 7468 206d 6f72 6520 6465  tip with more de
-000134a0: 7461 696c 6564 0a20 2020 2069 6e66 6f72  tailed.    infor
-000134b0: 6d61 7469 6f6e 206f 6e20 6e61 6d65 2c20  mation on name, 
-000134c0: 636f 6d70 7574 6174 696f 6e20 7469 6d65  computation time
-000134d0: 2c20 6d65 6d6f 7279 2c20 616e 6420 7461  , memory, and ta
-000134e0: 736b 7320 7374 6174 7573 2e0a 2020 2020  sks status..    
-000134f0: 2222 220a 0a20 2020 2064 6566 205f 5f69  """..    def __i
-00013500: 6e69 745f 5f28 7365 6c66 2c20 7363 6865  nit__(self, sche
-00013510: 6475 6c65 722c 202a 2a6b 7761 7267 7329  duler, **kwargs)
-00013520: 3a0a 2020 2020 2020 2020 7365 6c66 2e73  :.        self.s
-00013530: 6368 6564 756c 6572 203d 2073 6368 6564  cheduler = sched
-00013540: 756c 6572 0a0a 2020 2020 2020 2020 7365  uler..        se
-00013550: 6c66 2e6e 6f64 6573 5f6c 6179 6f75 7420  lf.nodes_layout 
-00013560: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
-00013570: 662e 6172 726f 7773 5f6c 6179 6f75 7420  f.arrows_layout 
-00013580: 3d20 7b7d 0a0a 2020 2020 2020 2020 7365  = {}..        se
-00013590: 6c66 2e6f 6c64 5f63 6f75 6e74 6572 203d  lf.old_counter =
-000135a0: 202d 310a 0a20 2020 2020 2020 2073 656c   -1..        sel
-000135b0: 662e 6e6f 6465 735f 736f 7572 6365 203d  f.nodes_source =
-000135c0: 2043 6f6c 756d 6e44 6174 6153 6f75 7263   ColumnDataSourc
-000135d0: 6528 0a20 2020 2020 2020 2020 2020 207b  e(.            {
-000135e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000135f0: 2022 7822 3a20 5b5d 2c0a 2020 2020 2020   "x": [],.      
-00013600: 2020 2020 2020 2020 2020 2279 223a 205b            "y": [
-00013610: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00013620: 2020 2022 775f 626f 7822 3a20 5b5d 2c0a     "w_box": [],.
-00013630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013640: 2268 5f62 6f78 223a 205b 5d2c 0a20 2020  "h_box": [],.   
-00013650: 2020 2020 2020 2020 2020 2020 2022 6e61               "na
-00013660: 6d65 223a 205b 5d2c 0a20 2020 2020 2020  me": [],.       
-00013670: 2020 2020 2020 2020 2022 746f 745f 7461           "tot_ta
-00013680: 736b 7322 3a20 5b5d 2c0a 2020 2020 2020  sks": [],.      
-00013690: 2020 2020 2020 2020 2020 2263 6f6c 6f72            "color
-000136a0: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-000136b0: 2020 2020 2020 2022 785f 7374 6172 7422         "x_start"
-000136c0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-000136d0: 2020 2020 2020 2278 5f65 6e64 223a 205b        "x_end": [
-000136e0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-000136f0: 2020 2022 795f 7374 6172 7422 3a20 5b5d     "y_start": []
-00013700: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00013710: 2020 2279 5f65 6e64 223a 205b 5d2c 0a20    "y_end": [],. 
-00013720: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00013730: 785f 656e 645f 7072 6f67 7265 7373 223a  x_end_progress":
-00013740: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-00013750: 2020 2020 2022 6d65 6d5f 616c 7068 6122       "mem_alpha"
-00013760: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-00013770: 2020 2020 2020 226e 6f64 655f 6c69 6e65        "node_line
-00013780: 5f77 6964 7468 223a 205b 5d2c 0a20 2020  _width": [],.   
-00013790: 2020 2020 2020 2020 2020 2020 2022 636f               "co
-000137a0: 6d70 5f74 6173 6b73 223a 205b 5d2c 0a20  mp_tasks": [],. 
-000137b0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000137c0: 7572 6c5f 6c6f 676f 223a 205b 5d2c 0a20  url_logo": [],. 
-000137d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000137e0: 785f 6c6f 676f 223a 205b 5d2c 0a20 2020  x_logo": [],.   
-000137f0: 2020 2020 2020 2020 2020 2020 2022 795f               "y_
-00013800: 6c6f 676f 223a 205b 5d2c 0a20 2020 2020  logo": [],.     
-00013810: 2020 2020 2020 2020 2020 2022 775f 6c6f             "w_lo
-00013820: 676f 223a 205b 5d2c 0a20 2020 2020 2020  go": [],.       
-00013830: 2020 2020 2020 2020 2022 685f 6c6f 676f           "h_logo
-00013840: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-00013850: 2020 2020 2020 2022 696e 5f70 726f 6365         "in_proce
-00013860: 7373 696e 6722 3a20 5b5d 2c0a 2020 2020  ssing": [],.    
-00013870: 2020 2020 2020 2020 2020 2020 2269 6e5f              "in_
-00013880: 6d65 6d6f 7279 223a 205b 5d2c 0a20 2020  memory": [],.   
-00013890: 2020 2020 2020 2020 2020 2020 2022 696e               "in
-000138a0: 5f72 656c 6561 7365 6422 3a20 5b5d 2c0a  _released": [],.
-000138b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000138c0: 2269 6e5f 6572 7265 6422 3a20 5b5d 2c0a  "in_erred": [],.
-000138d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000138e0: 2263 6f6d 7075 7465 5f74 696d 6522 3a20  "compute_time": 
-000138f0: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-00013900: 2020 2020 226d 656d 6f72 7922 3a20 5b5d      "memory": []
-00013910: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
-00013920: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00013930: 2020 2073 656c 662e 6172 726f 7773 5f73     self.arrows_s
-00013940: 6f75 7263 6520 3d20 436f 6c75 6d6e 4461  ource = ColumnDa
-00013950: 7461 536f 7572 6365 287b 2278 7322 3a20  taSource({"xs": 
-00013960: 5b5d 2c20 2279 7322 3a20 5b5d 2c20 2278  [], "ys": [], "x
-00013970: 6522 3a20 5b5d 2c20 2279 6522 3a20 5b5d  e": [], "ye": []
-00013980: 7d29 0a0a 2020 2020 2020 2020 7365 6c66  })..        self
-00013990: 2e72 6f6f 7420 3d20 6669 6775 7265 2874  .root = figure(t
-000139a0: 6974 6c65 3d22 5461 736b 2047 726f 7570  itle="Task Group
-000139b0: 7320 4772 6170 6822 2c20 6d61 7463 685f  s Graph", match_
-000139c0: 6173 7065 6374 3d54 7275 652c 202a 2a6b  aspect=True, **k
-000139d0: 7761 7267 7329 0a20 2020 2020 2020 2073  wargs).        s
-000139e0: 656c 662e 726f 6f74 2e61 7869 732e 7669  elf.root.axis.vi
-000139f0: 7369 626c 6520 3d20 4661 6c73 650a 2020  sible = False.  
-00013a00: 2020 2020 2020 7365 6c66 2e73 7562 7469        self.subti
-00013a10: 746c 6520 3d20 5469 746c 6528 7465 7874  tle = Title(text
-00013a20: 3d22 2022 2c20 7465 7874 5f66 6f6e 745f  =" ", text_font_
-00013a30: 7374 796c 653d 2269 7461 6c69 6322 290a  style="italic").
-00013a40: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-00013a50: 742e 6164 645f 6c61 796f 7574 2873 656c  t.add_layout(sel
-00013a60: 662e 7375 6274 6974 6c65 2c20 2261 626f  f.subtitle, "abo
-00013a70: 7665 2229 0a0a 2020 2020 2020 2020 7265  ve")..        re
-00013a80: 6374 203d 2073 656c 662e 726f 6f74 2e72  ct = self.root.r
-00013a90: 6563 7428 0a20 2020 2020 2020 2020 2020  ect(.           
-00013aa0: 2078 3d22 7822 2c0a 2020 2020 2020 2020   x="x",.        
-00013ab0: 2020 2020 793d 2279 222c 0a20 2020 2020      y="y",.     
-00013ac0: 2020 2020 2020 2077 6964 7468 3d22 775f         width="w_
-00013ad0: 626f 7822 2c0a 2020 2020 2020 2020 2020  box",.          
-00013ae0: 2020 6865 6967 6874 3d22 685f 626f 7822    height="h_box"
-00013af0: 2c0a 2020 2020 2020 2020 2020 2020 636f  ,.            co
-00013b00: 6c6f 723d 2263 6f6c 6f72 222c 0a20 2020  lor="color",.   
-00013b10: 2020 2020 2020 2020 2066 696c 6c5f 616c           fill_al
-00013b20: 7068 613d 226d 656d 5f61 6c70 6861 222c  pha="mem_alpha",
-00013b30: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
-00013b40: 655f 636f 6c6f 723d 2262 6c61 636b 222c  e_color="black",
-00013b50: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
-00013b60: 655f 7769 6474 683d 226e 6f64 655f 6c69  e_width="node_li
-00013b70: 6e65 5f77 6964 7468 222c 0a20 2020 2020  ne_width",.     
-00013b80: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
-00013b90: 6c66 2e6e 6f64 6573 5f73 6f75 7263 652c  lf.nodes_source,
-00013ba0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00013bb0: 2020 2020 2320 706c 6f74 2074 6720 6c6f      # plot tg lo
-00013bc0: 670a 2020 2020 2020 2020 7365 6c66 2e72  g.        self.r
-00013bd0: 6f6f 742e 696d 6167 655f 7572 6c28 0a20  oot.image_url(. 
-00013be0: 2020 2020 2020 2020 2020 2075 726c 3d22             url="
-00013bf0: 7572 6c5f 6c6f 676f 222c 0a20 2020 2020  url_logo",.     
-00013c00: 2020 2020 2020 2078 3d22 785f 6c6f 676f         x="x_logo
-00013c10: 222c 0a20 2020 2020 2020 2020 2020 2079  ",.            y
-00013c20: 3d22 795f 6c6f 676f 222c 0a20 2020 2020  ="y_logo",.     
-00013c30: 2020 2020 2020 2077 3d22 775f 6c6f 676f         w="w_logo
-00013c40: 222c 0a20 2020 2020 2020 2020 2020 2068  ",.            h
-00013c50: 3d22 685f 6c6f 676f 222c 0a20 2020 2020  ="h_logo",.     
-00013c60: 2020 2020 2020 2061 6e63 686f 723d 2263         anchor="c
-00013c70: 656e 7465 7222 2c0a 2020 2020 2020 2020  enter",.        
-00013c80: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
-00013c90: 6e6f 6465 735f 736f 7572 6365 2c0a 2020  nodes_source,.  
-00013ca0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00013cb0: 2023 2070 726f 6772 6573 7320 6261 7220   # progress bar 
-00013cc0: 706c 6169 6e20 626f 780a 2020 2020 2020  plain box.      
-00013cd0: 2020 7365 6c66 2e72 6f6f 742e 7175 6164    self.root.quad
-00013ce0: 280a 2020 2020 2020 2020 2020 2020 6c65  (.            le
-00013cf0: 6674 3d22 785f 7374 6172 7422 2c0a 2020  ft="x_start",.  
-00013d00: 2020 2020 2020 2020 2020 7269 6768 743d            right=
-00013d10: 2278 5f65 6e64 222c 0a20 2020 2020 2020  "x_end",.       
-00013d20: 2020 2020 2062 6f74 746f 6d3d 2279 5f73       bottom="y_s
-00013d30: 7461 7274 222c 0a20 2020 2020 2020 2020  tart",.         
-00013d40: 2020 2074 6f70 3d22 795f 656e 6422 2c0a     top="y_end",.
-00013d50: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
-00013d60: 723d 4e6f 6e65 2c0a 2020 2020 2020 2020  r=None,.        
-00013d70: 2020 2020 6c69 6e65 5f63 6f6c 6f72 3d22      line_color="
-00013d80: 626c 6163 6b22 2c0a 2020 2020 2020 2020  black",.        
-00013d90: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
-00013da0: 6e6f 6465 735f 736f 7572 6365 2c0a 2020  nodes_source,.  
-00013db0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00013dc0: 2023 2070 726f 6772 6573 7320 6261 720a   # progress bar.
-00013dd0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-00013de0: 742e 7175 6164 280a 2020 2020 2020 2020  t.quad(.        
-00013df0: 2020 2020 6c65 6674 3d22 785f 7374 6172      left="x_star
-00013e00: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
-00013e10: 7269 6768 743d 2278 5f65 6e64 5f70 726f  right="x_end_pro
-00013e20: 6772 6573 7322 2c0a 2020 2020 2020 2020  gress",.        
-00013e30: 2020 2020 626f 7474 6f6d 3d22 795f 7374      bottom="y_st
-00013e40: 6172 7422 2c0a 2020 2020 2020 2020 2020  art",.          
-00013e50: 2020 746f 703d 2279 5f65 6e64 222c 0a20    top="y_end",. 
-00013e60: 2020 2020 2020 2020 2020 2063 6f6c 6f72             color
-00013e70: 3d22 636f 6c6f 7222 2c0a 2020 2020 2020  ="color",.      
-00013e80: 2020 2020 2020 6c69 6e65 5f63 6f6c 6f72        line_color
-00013e90: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
-00013ea0: 2020 2066 696c 6c5f 616c 7068 613d 302e     fill_alpha=0.
-00013eb0: 362c 0a20 2020 2020 2020 2020 2020 2073  6,.            s
-00013ec0: 6f75 7263 653d 7365 6c66 2e6e 6f64 6573  ource=self.nodes
-00013ed0: 5f73 6f75 7263 652c 0a20 2020 2020 2020  _source,.       
-00013ee0: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
-00013ef0: 2e61 7272 6f77 7320 3d20 4172 726f 7728  .arrows = Arrow(
-00013f00: 0a20 2020 2020 2020 2020 2020 2065 6e64  .            end
-00013f10: 3d56 6565 4865 6164 2873 697a 653d 3829  =VeeHead(size=8)
-00013f20: 2c0a 2020 2020 2020 2020 2020 2020 6c69  ,.            li
-00013f30: 6e65 5f63 6f6c 6f72 3d22 626c 6163 6b22  ne_color="black"
-00013f40: 2c0a 2020 2020 2020 2020 2020 2020 6c69  ,.            li
-00013f50: 6e65 5f61 6c70 6861 3d30 2e35 2c0a 2020  ne_alpha=0.5,.  
-00013f60: 2020 2020 2020 2020 2020 6c69 6e65 5f77            line_w
-00013f70: 6964 7468 3d31 2c0a 2020 2020 2020 2020  idth=1,.        
-00013f80: 2020 2020 785f 7374 6172 743d 2278 7322      x_start="xs"
-00013f90: 2c0a 2020 2020 2020 2020 2020 2020 795f  ,.            y_
-00013fa0: 7374 6172 743d 2279 7322 2c0a 2020 2020  start="ys",.    
-00013fb0: 2020 2020 2020 2020 785f 656e 643d 2278          x_end="x
-00013fc0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-00013fd0: 795f 656e 643d 2279 6522 2c0a 2020 2020  y_end="ye",.    
-00013fe0: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
-00013ff0: 656c 662e 6172 726f 7773 5f73 6f75 7263  elf.arrows_sourc
-00014000: 652c 0a20 2020 2020 2020 2029 0a20 2020  e,.        ).   
-00014010: 2020 2020 2073 656c 662e 726f 6f74 2e61       self.root.a
-00014020: 6464 5f6c 6179 6f75 7428 7365 6c66 2e61  dd_layout(self.a
-00014030: 7272 6f77 7329 0a0a 2020 2020 2020 2020  rrows)..        
-00014040: 7365 6c66 2e72 6f6f 742e 7867 7269 642e  self.root.xgrid.
-00014050: 6772 6964 5f6c 696e 655f 636f 6c6f 7220  grid_line_color 
-00014060: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
-00014070: 656c 662e 726f 6f74 2e79 6772 6964 2e67  elf.root.ygrid.g
-00014080: 7269 645f 6c69 6e65 5f63 6f6c 6f72 203d  rid_line_color =
-00014090: 204e 6f6e 650a 2020 2020 2020 2020 7365   None.        se
-000140a0: 6c66 2e72 6f6f 742e 785f 7261 6e67 652e  lf.root.x_range.
-000140b0: 7261 6e67 655f 7061 6464 696e 6720 3d20  range_padding = 
-000140c0: 302e 350a 2020 2020 2020 2020 7365 6c66  0.5.        self
-000140d0: 2e72 6f6f 742e 795f 7261 6e67 652e 7261  .root.y_range.ra
-000140e0: 6e67 655f 7061 6464 696e 6720 3d20 302e  nge_padding = 0.
-000140f0: 350a 0a20 2020 2020 2020 2068 6f76 6572  5..        hover
-00014100: 203d 2048 6f76 6572 546f 6f6c 280a 2020   = HoverTool(.  
-00014110: 2020 2020 2020 2020 2020 706f 696e 745f            point_
-00014120: 706f 6c69 6379 3d22 666f 6c6c 6f77 5f6d  policy="follow_m
-00014130: 6f75 7365 222c 0a20 2020 2020 2020 2020  ouse",.         
-00014140: 2020 2074 6f6f 6c74 6970 733d 2222 220a     tooltips=""".
-00014150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014160: 3c64 6976 3e0a 2020 2020 2020 2020 2020  <div>.          
-00014170: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
-00014180: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
-00014190: 3a20 3132 7078 3b20 666f 6e74 2d77 6569  : 12px; font-wei
-000141a0: 6768 743a 2062 6f6c 643b 223e 4e61 6d65  ght: bold;">Name
-000141b0: 3a3c 2f73 7061 6e3e 266e 6273 703b 0a20  :</span>&nbsp;. 
-000141c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000141d0: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
-000141e0: 666f 6e74 2d73 697a 653a 2031 3070 783b  font-size: 10px;
-000141f0: 2066 6f6e 742d 6661 6d69 6c79 3a20 4d6f   font-family: Mo
-00014200: 6e61 636f 2c20 6d6f 6e6f 7370 6163 653b  naco, monospace;
-00014210: 223e 406e 616d 653c 2f73 7061 6e3e 0a20  ">@name</span>. 
-00014220: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-00014230: 2f64 6976 3e0a 2020 2020 2020 2020 2020  /div>.          
-00014240: 2020 2020 2020 3c64 6976 3e0a 2020 2020        <div>.    
-00014250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014260: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
-00014270: 742d 7369 7a65 3a20 3132 7078 3b20 666f  t-size: 12px; fo
-00014280: 6e74 2d77 6569 6768 743a 2062 6f6c 643b  nt-weight: bold;
-00014290: 223e 436f 6d70 7574 6520 7469 6d65 3a3c  ">Compute time:<
-000142a0: 2f73 7061 6e3e 266e 6273 703b 0a20 2020  /span>&nbsp;.   
-000142b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000142c0: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
-000142d0: 6e74 2d73 697a 653a 2031 3070 783b 2066  nt-size: 10px; f
-000142e0: 6f6e 742d 6661 6d69 6c79 3a20 4d6f 6e61  ont-family: Mona
-000142f0: 636f 2c20 6d6f 6e6f 7370 6163 653b 223e  co, monospace;">
-00014300: 4063 6f6d 7075 7465 5f74 696d 653c 2f73  @compute_time</s
-00014310: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
-00014320: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
-00014330: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
-00014340: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-00014350: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
-00014360: 653d 2266 6f6e 742d 7369 7a65 3a20 3132  e="font-size: 12
-00014370: 7078 3b20 666f 6e74 2d77 6569 6768 743a  px; font-weight:
-00014380: 2062 6f6c 643b 223e 4d65 6d6f 7279 3a3c   bold;">Memory:<
-00014390: 2f73 7061 6e3e 266e 6273 703b 0a20 2020  /span>&nbsp;.   
-000143a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000143b0: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
-000143c0: 6e74 2d73 697a 653a 2031 3070 783b 2066  nt-size: 10px; f
-000143d0: 6f6e 742d 6661 6d69 6c79 3a20 4d6f 6e61  ont-family: Mona
-000143e0: 636f 2c20 6d6f 6e6f 7370 6163 653b 223e  co, monospace;">
-000143f0: 406d 656d 6f72 793c 2f73 7061 6e3e 0a20  @memory</span>. 
-00014400: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-00014410: 2f64 6976 3e0a 2020 2020 2020 2020 2020  /div>.          
-00014420: 2020 2020 2020 3c64 6976 3e0a 2020 2020        <div>.    
-00014430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014440: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
-00014450: 742d 7369 7a65 3a20 3132 7078 3b20 666f  t-size: 12px; fo
-00014460: 6e74 2d77 6569 6768 743a 2062 6f6c 643b  nt-weight: bold;
-00014470: 223e 5461 736b 733a 3c2f 7370 616e 3e26  ">Tasks:</span>&
-00014480: 6e62 7370 3b0a 2020 2020 2020 2020 2020  nbsp;.          
-00014490: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
-000144a0: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
-000144b0: 3a20 3130 7078 3b20 666f 6e74 2d66 616d  : 10px; font-fam
-000144c0: 696c 793a 204d 6f6e 6163 6f2c 206d 6f6e  ily: Monaco, mon
-000144d0: 6f73 7061 6365 3b22 3e40 746f 745f 7461  ospace;">@tot_ta
-000144e0: 736b 733c 2f73 7061 6e3e 0a20 2020 2020  sks</span>.     
-000144f0: 2020 2020 2020 2020 2020 203c 2f64 6976             </div
-00014500: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-00014510: 2020 3c64 6976 2073 7479 6c65 3d22 6d61    <div style="ma
-00014520: 7267 696e 2d6c 6566 743a 2032 656d 3b22  rgin-left: 2em;"
-00014530: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-00014540: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
-00014550: 653d 2266 6f6e 742d 7369 7a65 3a20 3132  e="font-size: 12
-00014560: 7078 3b20 666f 6e74 2d77 6569 6768 743a  px; font-weight:
-00014570: 2062 6f6c 643b 223e 436f 6d70 6c65 7465   bold;">Complete
-00014580: 643a 3c2f 7370 616e 3e26 6e62 7370 3b0a  d:</span>&nbsp;.
-00014590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000145a0: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
-000145b0: 2266 6f6e 742d 7369 7a65 3a20 3130 7078  "font-size: 10px
-000145c0: 3b20 666f 6e74 2d66 616d 696c 793a 204d  ; font-family: M
-000145d0: 6f6e 6163 6f2c 206d 6f6e 6f73 7061 6365  onaco, monospace
-000145e0: 3b22 3e40 636f 6d70 5f74 6173 6b73 3c2f  ;">@comp_tasks</
-000145f0: 7370 616e 3e0a 2020 2020 2020 2020 2020  span>.          
-00014600: 2020 2020 2020 3c2f 6469 763e 0a20 2020        </div>.   
-00014610: 2020 2020 2020 2020 2020 2020 203c 6469               <di
-00014620: 7620 7374 796c 653d 226d 6172 6769 6e2d  v style="margin-
-00014630: 6c65 6674 3a20 3265 6d3b 223e 0a20 2020  left: 2em;">.   
-00014640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014650: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
-00014660: 6e74 2d73 697a 653a 2031 3270 783b 2066  nt-size: 12px; f
-00014670: 6f6e 742d 7765 6967 6874 3a20 626f 6c64  ont-weight: bold
-00014680: 3b22 3e50 726f 6365 7373 696e 673a 3c2f  ;">Processing:</
-00014690: 7370 616e 3e26 6e62 7370 3b0a 2020 2020  span>&nbsp;.    
-000146a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000146b0: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
-000146c0: 742d 7369 7a65 3a20 3130 7078 3b20 666f  t-size: 10px; fo
-000146d0: 6e74 2d66 616d 696c 793a 204d 6f6e 6163  nt-family: Monac
-000146e0: 6f2c 206d 6f6e 6f73 7061 6365 3b22 3e40  o, monospace;">@
-000146f0: 696e 5f70 726f 6365 7373 696e 673c 2f73  in_processing</s
-00014700: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
-00014710: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
-00014720: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
-00014730: 2073 7479 6c65 3d22 6d61 7267 696e 2d6c   style="margin-l
-00014740: 6566 743a 2032 656d 3b22 3e0a 2020 2020  eft: 2em;">.    
-00014750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014760: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
-00014770: 742d 7369 7a65 3a20 3132 7078 3b20 666f  t-size: 12px; fo
-00014780: 6e74 2d77 6569 6768 743a 2062 6f6c 643b  nt-weight: bold;
-00014790: 223e 496e 206d 656d 6f72 793a 3c2f 7370  ">In memory:</sp
-000147a0: 616e 3e26 6e62 7370 3b0a 2020 2020 2020  an>&nbsp;.      
-000147b0: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
-000147c0: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
-000147d0: 7369 7a65 3a20 3130 7078 3b20 666f 6e74  size: 10px; font
-000147e0: 2d66 616d 696c 793a 204d 6f6e 6163 6f2c  -family: Monaco,
-000147f0: 206d 6f6e 6f73 7061 6365 3b22 3e40 696e   monospace;">@in
-00014800: 5f6d 656d 6f72 793c 2f73 7061 6e3e 0a20  _memory</span>. 
-00014810: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-00014820: 2f64 6976 3e0a 2020 2020 2020 2020 2020  /div>.          
-00014830: 2020 2020 2020 3c64 6976 2073 7479 6c65        <div style
-00014840: 3d22 6d61 7267 696e 2d6c 6566 743a 2032  ="margin-left: 2
-00014850: 656d 3b22 3e0a 2020 2020 2020 2020 2020  em;">.          
-00014860: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
-00014870: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
-00014880: 3a20 3132 7078 3b20 666f 6e74 2d77 6569  : 12px; font-wei
-00014890: 6768 743a 2062 6f6c 643b 223e 4572 7265  ght: bold;">Erre
-000148a0: 643a 3c2f 7370 616e 3e26 6e62 7370 3b0a  d:</span>&nbsp;.
-000148b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000148c0: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
-000148d0: 2266 6f6e 742d 7369 7a65 3a20 3130 7078  "font-size: 10px
-000148e0: 3b20 666f 6e74 2d66 616d 696c 793a 204d  ; font-family: M
-000148f0: 6f6e 6163 6f2c 206d 6f6e 6f73 7061 6365  onaco, monospace
-00014900: 3b22 3e40 696e 5f65 7272 6564 3c2f 7370  ;">@in_erred</sp
-00014910: 616e 3e0a 2020 2020 2020 2020 2020 2020  an>.            
-00014920: 2020 2020 3c2f 6469 763e 0a20 2020 2020      </div>.     
-00014930: 2020 2020 2020 2020 2020 203c 6469 7620             <div 
-00014940: 7374 796c 653d 226d 6172 6769 6e2d 6c65  style="margin-le
-00014950: 6674 3a20 3265 6d3b 223e 0a20 2020 2020  ft: 2em;">.     
-00014960: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-00014970: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
-00014980: 2d73 697a 653a 2031 3270 783b 2066 6f6e  -size: 12px; fon
-00014990: 742d 7765 6967 6874 3a20 626f 6c64 3b22  t-weight: bold;"
-000149a0: 3e52 656c 6561 7365 643a 3c2f 7370 616e  >Released:</span
-000149b0: 3e26 6e62 7370 3b0a 2020 2020 2020 2020  >&nbsp;.        
-000149c0: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
-000149d0: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
-000149e0: 7a65 3a20 3130 7078 3b20 666f 6e74 2d66  ze: 10px; font-f
-000149f0: 616d 696c 793a 204d 6f6e 6163 6f2c 206d  amily: Monaco, m
-00014a00: 6f6e 6f73 7061 6365 3b22 3e40 696e 5f72  onospace;">@in_r
-00014a10: 656c 6561 7365 643c 2f73 7061 6e3e 0a20  eleased</span>. 
-00014a20: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-00014a30: 2f64 6976 3e0a 2020 2020 2020 2020 2020  /div>.          
-00014a40: 2020 2020 2020 2222 222c 0a20 2020 2020        """,.     
-00014a50: 2020 2020 2020 2072 656e 6465 7265 7273         renderers
-00014a60: 3d5b 7265 6374 5d2c 0a20 2020 2020 2020  =[rect],.       
-00014a70: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
-00014a80: 2e72 6f6f 742e 6164 645f 746f 6f6c 7328  .root.add_tools(
-00014a90: 686f 7665 7229 0a0a 2020 2020 4077 6974  hover)..    @wit
-00014aa0: 686f 7574 5f70 726f 7065 7274 795f 7661  hout_property_va
-00014ab0: 6c69 6461 7469 6f6e 0a20 2020 2040 6c6f  lidation.    @lo
-00014ac0: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
-00014ad0: 2075 7064 6174 655f 6c61 796f 7574 2873   update_layout(s
-00014ae0: 656c 6629 3a0a 2020 2020 2020 2020 2320  elf):.        # 
-00014af0: 4765 7420 6465 7065 6e64 656e 6369 6573  Get dependencies
-00014b00: 2070 6572 2074 6173 6b20 6772 6f75 702e   per task group.
-00014b10: 0a20 2020 2020 2020 2023 2049 6e20 736f  .        # In so
-00014b20: 6d65 2063 6173 6573 2074 6865 7265 2061  me cases there a
-00014b30: 7265 2074 6720 7468 6174 2068 6176 6520  re tg that have 
-00014b40: 7468 656d 7365 6c76 6573 2061 7320 6465  themselves as de
-00014b50: 7065 6e64 656e 6369 6573 202d 2077 6520  pendencies - we 
-00014b60: 7265 6d6f 7665 2074 686f 7365 2e0a 2020  remove those..  
-00014b70: 2020 2020 2020 6465 7065 6e64 656e 6369        dependenci
-00014b80: 6573 203d 207b 0a20 2020 2020 2020 2020  es = {.         
-00014b90: 2020 206b 3a20 7b64 732e 6e61 6d65 2066     k: {ds.name f
-00014ba0: 6f72 2064 7320 696e 2074 732e 6465 7065  or ds in ts.depe
-00014bb0: 6e64 656e 6369 6573 2069 6620 6473 2e6e  ndencies if ds.n
-00014bc0: 616d 6520 213d 206b 7d0a 2020 2020 2020  ame != k}.      
-00014bd0: 2020 2020 2020 666f 7220 6b2c 2074 7320        for k, ts 
-00014be0: 696e 2073 656c 662e 7363 6865 6475 6c65  in self.schedule
-00014bf0: 722e 7461 736b 5f67 726f 7570 732e 6974  r.task_groups.it
-00014c00: 656d 7328 290a 2020 2020 2020 2020 7d0a  ems().        }.
-00014c10: 0a20 2020 2020 2020 2069 6d70 6f72 7420  .        import 
-00014c20: 6461 736b 0a0a 2020 2020 2020 2020 6f72  dask..        or
-00014c30: 6465 7220 3d20 6461 736b 2e6f 7264 6572  der = dask.order
-00014c40: 2e6f 7264 6572 280a 2020 2020 2020 2020  .order(.        
-00014c50: 2020 2020 6473 6b3d 7b67 726f 7570 2e6e      dsk={group.n
-00014c60: 616d 653a 2031 2066 6f72 206b 2c20 6772  ame: 1 for k, gr
-00014c70: 6f75 7020 696e 2073 656c 662e 7363 6865  oup in self.sche
-00014c80: 6475 6c65 722e 7461 736b 5f67 726f 7570  duler.task_group
-00014c90: 732e 6974 656d 7328 297d 2c0a 2020 2020  s.items()},.    
-00014ca0: 2020 2020 2020 2020 6465 7065 6e64 656e          dependen
-00014cb0: 6369 6573 3d64 6570 656e 6465 6e63 6965  cies=dependencie
-00014cc0: 732c 0a20 2020 2020 2020 2029 0a0a 2020  s,.        )..  
-00014cd0: 2020 2020 2020 6f72 6465 7265 6420 3d20        ordered = 
-00014ce0: 736f 7274 6564 2873 656c 662e 7363 6865  sorted(self.sche
-00014cf0: 6475 6c65 722e 7461 736b 5f67 726f 7570  duler.task_group
-00014d00: 732c 206b 6579 3d6f 7264 6572 2e67 6574  s, key=order.get
-00014d10: 290a 0a20 2020 2020 2020 2078 7320 3d20  )..        xs = 
-00014d20: 7b7d 0a20 2020 2020 2020 2079 7320 3d20  {}.        ys = 
-00014d30: 7b7d 0a20 2020 2020 2020 206c 6f63 6174  {}.        locat
-00014d40: 696f 6e73 203d 2073 6574 2829 0a20 2020  ions = set().   
-00014d50: 2020 2020 206e 6f64 6573 5f6c 6179 6f75       nodes_layou
-00014d60: 7420 3d20 7b7d 0a20 2020 2020 2020 2061  t = {}.        a
-00014d70: 7272 6f77 735f 6c61 796f 7574 203d 207b  rrows_layout = {
-00014d80: 7d0a 2020 2020 2020 2020 666f 7220 7467  }.        for tg
-00014d90: 2069 6e20 6f72 6465 7265 643a 0a20 2020   in ordered:.   
-00014da0: 2020 2020 2020 2020 2069 6620 6465 7065           if depe
-00014db0: 6e64 656e 6369 6573 5b74 675d 3a0a 2020  ndencies[tg]:.  
-00014dc0: 2020 2020 2020 2020 2020 2020 2020 7820                x 
-00014dd0: 3d20 6d61 7828 7873 5b64 6570 5d20 666f  = max(xs[dep] fo
-00014de0: 7220 6465 7020 696e 2064 6570 656e 6465  r dep in depende
-00014df0: 6e63 6965 735b 7467 5d29 202b 2031 0a20  ncies[tg]) + 1. 
-00014e00: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-00014e10: 203d 206d 6178 2879 735b 6465 705d 2066   = max(ys[dep] f
-00014e20: 6f72 2064 6570 2069 6e20 6465 7065 6e64  or dep in depend
-00014e30: 656e 6369 6573 5b74 675d 290a 2020 2020  encies[tg]).    
-00014e40: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00014e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014e60: 2020 2020 206c 656e 2864 6570 656e 6465       len(depende
-00014e70: 6e63 6965 735b 7467 5d29 203e 2031 0a20  ncies[tg]) > 1. 
-00014e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014e90: 2020 2061 6e64 206c 656e 287b 7973 5b64     and len({ys[d
-00014ea0: 6570 5d20 666f 7220 6465 7020 696e 2064  ep] for dep in d
-00014eb0: 6570 656e 6465 6e63 6965 735b 7467 5d7d  ependencies[tg]}
-00014ec0: 2920 3d3d 2031 0a20 2020 2020 2020 2020  ) == 1.         
-00014ed0: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
-00014ee0: 2020 2020 2020 2020 2020 2020 2020 7920                y 
-00014ef0: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
-00014f00: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00014f10: 2020 2020 2020 2078 203d 2030 0a20 2020         x = 0.   
-00014f20: 2020 2020 2020 2020 2020 2020 2079 203d               y =
-00014f30: 206d 6178 2879 732e 7661 6c75 6573 2829   max(ys.values()
-00014f40: 2920 2b20 3120 6966 2079 7320 656c 7365  ) + 1 if ys else
-00014f50: 2030 0a0a 2020 2020 2020 2020 2020 2020   0..            
-00014f60: 7768 696c 6520 2878 2c20 7929 2069 6e20  while (x, y) in 
-00014f70: 6c6f 6361 7469 6f6e 733a 2020 2320 6176  locations:  # av
-00014f80: 6f69 6420 636f 6c6c 6973 696f 6e73 2062  oid collisions b
-00014f90: 7920 6d6f 7669 6e67 2075 700a 2020 2020  y moving up.    
-00014fa0: 2020 2020 2020 2020 2020 2020 7920 2b3d              y +=
-00014fb0: 2031 0a0a 2020 2020 2020 2020 2020 2020   1..            
-00014fc0: 6c6f 6361 7469 6f6e 732e 6164 6428 2878  locations.add((x
-00014fd0: 2c20 7929 290a 0a20 2020 2020 2020 2020  , y))..         
-00014fe0: 2020 2078 735b 7467 5d2c 2079 735b 7467     xs[tg], ys[tg
-00014ff0: 5d20 3d20 782c 2079 0a0a 2020 2020 2020  ] = x, y..      
-00015000: 2020 2020 2020 2320 696e 666f 206e 6565        # info nee
-00015010: 6465 6420 666f 7220 6e6f 6465 206c 6179  ded for node lay
-00015020: 6f75 7420 746f 2063 6f6c 756d 6e20 6461  out to column da
-00015030: 7461 2073 6f75 7263 650a 2020 2020 2020  ta source.      
-00015040: 2020 2020 2020 6e6f 6465 735f 6c61 796f        nodes_layo
-00015050: 7574 5b74 675d 203d 207b 2278 223a 2078  ut[tg] = {"x": x
-00015060: 735b 7467 5d2c 2022 7922 3a20 7973 5b74  s[tg], "y": ys[t
-00015070: 675d 7d0a 0a20 2020 2020 2020 2020 2020  g]}..           
-00015080: 2023 2069 6e66 6f20 6e65 6564 6564 2066   # info needed f
-00015090: 6f72 2061 7272 6f77 206c 6179 6f75 740a  or arrow layout.
-000150a0: 2020 2020 2020 2020 2020 2020 6172 726f              arro
-000150b0: 7773 5f6c 6179 6f75 745b 7467 5d20 3d20  ws_layout[tg] = 
-000150c0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000150d0: 2020 226e 7374 6172 7422 3a20 6465 7065    "nstart": depe
-000150e0: 6e64 656e 6369 6573 5b74 675d 2c0a 2020  ndencies[tg],.  
-000150f0: 2020 2020 2020 2020 2020 2020 2020 226e                "n
-00015100: 656e 6422 3a20 5b74 675d 202a 206c 656e  end": [tg] * len
-00015110: 2864 6570 656e 6465 6e63 6965 735b 7467  (dependencies[tg
-00015120: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-00015130: 7d0a 0a20 2020 2020 2020 2072 6574 7572  }..        retur
-00015140: 6e20 6e6f 6465 735f 6c61 796f 7574 2c20  n nodes_layout, 
-00015150: 6172 726f 7773 5f6c 6179 6f75 740a 0a20  arrows_layout.. 
-00015160: 2020 2064 6566 2063 6f6d 7075 7465 5f73     def compute_s
-00015170: 697a 6528 7365 6c66 2c20 782c 206d 696e  ize(self, x, min
-00015180: 5f62 6f78 2c20 6d61 785f 626f 7829 3a0a  _box, max_box):.
-00015190: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
-000151a0: 302e 340a 2020 2020 2020 2020 656e 6420  0.4.        end 
-000151b0: 3d20 302e 380a 0a20 2020 2020 2020 2079  = 0.8..        y
-000151c0: 203d 2028 656e 6420 2d20 7374 6172 7429   = (end - start)
-000151d0: 202f 2028 6d61 785f 626f 7820 2d20 6d69   / (max_box - mi
-000151e0: 6e5f 626f 7829 202a 2028 7820 2d20 6d69  n_box) * (x - mi
-000151f0: 6e5f 626f 7829 202b 2073 7461 7274 0a0a  n_box) + start..
-00015200: 2020 2020 2020 2020 7265 7475 726e 2079          return y
-00015210: 0a0a 2020 2020 4077 6974 686f 7574 5f70  ..    @without_p
-00015220: 726f 7065 7274 795f 7661 6c69 6461 7469  roperty_validati
-00015230: 6f6e 0a20 2020 2064 6566 2075 7064 6174  on.    def updat
-00015240: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
-00015250: 2069 6620 7365 6c66 2e73 6368 6564 756c   if self.schedul
-00015260: 6572 2e74 7261 6e73 6974 696f 6e5f 636f  er.transition_co
-00015270: 756e 7465 7220 3d3d 2073 656c 662e 6f6c  unter == self.ol
-00015280: 645f 636f 756e 7465 723a 0a20 2020 2020  d_counter:.     
-00015290: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
-000152a0: 2020 2020 2020 7365 6c66 2e6f 6c64 5f63        self.old_c
-000152b0: 6f75 6e74 6572 203d 2073 656c 662e 7363  ounter = self.sc
-000152c0: 6865 6475 6c65 722e 7472 616e 7369 7469  heduler.transiti
-000152d0: 6f6e 5f63 6f75 6e74 6572 0a0a 2020 2020  on_counter..    
-000152e0: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
-000152f0: 7363 6865 6475 6c65 722e 7461 736b 5f67  scheduler.task_g
-00015300: 726f 7570 733a 0a20 2020 2020 2020 2020  roups:.         
-00015310: 2020 2073 656c 662e 7375 6274 6974 6c65     self.subtitle
-00015320: 2e74 6578 7420 3d20 2253 6368 6564 756c  .text = "Schedul
-00015330: 6572 2069 7320 656d 7074 792e 220a 2020  er is empty.".  
-00015340: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00015350: 2020 2020 2020 2020 7365 6c66 2e73 7562          self.sub
-00015360: 7469 746c 652e 7465 7874 203d 2022 2022  title.text = " "
-00015370: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00015380: 662e 6e6f 6465 735f 6c61 796f 7574 2e6b  f.nodes_layout.k
-00015390: 6579 7328 2920 213d 2073 656c 662e 7363  eys() != self.sc
-000153a0: 6865 6475 6c65 722e 7461 736b 5f67 726f  heduler.task_gro
-000153b0: 7570 732e 6b65 7973 2829 3a0a 2020 2020  ups.keys():.    
-000153c0: 2020 2020 2020 2020 7365 6c66 2e6e 6f64          self.nod
-000153d0: 6573 5f6c 6179 6f75 742c 2073 656c 662e  es_layout, self.
-000153e0: 6172 726f 7773 5f6c 6179 6f75 7420 3d20  arrows_layout = 
-000153f0: 7365 6c66 2e75 7064 6174 655f 6c61 796f  self.update_layo
-00015400: 7574 2829 0a0a 2020 2020 2020 2020 6e6f  ut()..        no
-00015410: 6465 735f 6461 7461 203d 207b 0a20 2020  des_data = {.   
-00015420: 2020 2020 2020 2020 2022 7822 3a20 5b5d           "x": []
-00015430: 2c0a 2020 2020 2020 2020 2020 2020 2279  ,.            "y
-00015440: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-00015450: 2020 2022 775f 626f 7822 3a20 5b5d 2c0a     "w_box": [],.
-00015460: 2020 2020 2020 2020 2020 2020 2268 5f62              "h_b
-00015470: 6f78 223a 205b 5d2c 0a20 2020 2020 2020  ox": [],.       
-00015480: 2020 2020 2022 6e61 6d65 223a 205b 5d2c       "name": [],
-00015490: 0a20 2020 2020 2020 2020 2020 2022 636f  .            "co
-000154a0: 6c6f 7222 3a20 5b5d 2c0a 2020 2020 2020  lor": [],.      
-000154b0: 2020 2020 2020 2274 6f74 5f74 6173 6b73        "tot_tasks
-000154c0: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-000154d0: 2020 2022 785f 7374 6172 7422 3a20 5b5d     "x_start": []
-000154e0: 2c0a 2020 2020 2020 2020 2020 2020 2278  ,.            "x
-000154f0: 5f65 6e64 223a 205b 5d2c 0a20 2020 2020  _end": [],.     
-00015500: 2020 2020 2020 2022 795f 7374 6172 7422         "y_start"
-00015510: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-00015520: 2020 2279 5f65 6e64 223a 205b 5d2c 0a20    "y_end": [],. 
-00015530: 2020 2020 2020 2020 2020 2022 785f 656e             "x_en
-00015540: 645f 7072 6f67 7265 7373 223a 205b 5d2c  d_progress": [],
-00015550: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
-00015560: 6d5f 616c 7068 6122 3a20 5b5d 2c0a 2020  m_alpha": [],.  
-00015570: 2020 2020 2020 2020 2020 226e 6f64 655f            "node_
-00015580: 6c69 6e65 5f77 6964 7468 223a 205b 5d2c  line_width": [],
-00015590: 0a20 2020 2020 2020 2020 2020 2022 636f  .            "co
-000155a0: 6d70 5f74 6173 6b73 223a 205b 5d2c 0a20  mp_tasks": [],. 
-000155b0: 2020 2020 2020 2020 2020 2022 7572 6c5f             "url_
-000155c0: 6c6f 676f 223a 205b 5d2c 0a20 2020 2020  logo": [],.     
-000155d0: 2020 2020 2020 2022 785f 6c6f 676f 223a         "x_logo":
-000155e0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-000155f0: 2022 795f 6c6f 676f 223a 205b 5d2c 0a20   "y_logo": [],. 
-00015600: 2020 2020 2020 2020 2020 2022 775f 6c6f             "w_lo
-00015610: 676f 223a 205b 5d2c 0a20 2020 2020 2020  go": [],.       
-00015620: 2020 2020 2022 685f 6c6f 676f 223a 205b       "h_logo": [
-00015630: 5d2c 0a20 2020 2020 2020 2020 2020 2022  ],.            "
-00015640: 696e 5f70 726f 6365 7373 696e 6722 3a20  in_processing": 
-00015650: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-00015660: 2269 6e5f 6d65 6d6f 7279 223a 205b 5d2c  "in_memory": [],
-00015670: 0a20 2020 2020 2020 2020 2020 2022 696e  .            "in
-00015680: 5f72 656c 6561 7365 6422 3a20 5b5d 2c0a  _released": [],.
-00015690: 2020 2020 2020 2020 2020 2020 2269 6e5f              "in_
-000156a0: 6572 7265 6422 3a20 5b5d 2c0a 2020 2020  erred": [],.    
-000156b0: 2020 2020 2020 2020 2263 6f6d 7075 7465          "compute
-000156c0: 5f74 696d 6522 3a20 5b5d 2c0a 2020 2020  _time": [],.    
-000156d0: 2020 2020 2020 2020 226d 656d 6f72 7922          "memory"
-000156e0: 3a20 5b5d 2c0a 2020 2020 2020 2020 7d0a  : [],.        }.
-000156f0: 0a20 2020 2020 2020 2061 7272 6f77 735f  .        arrows_
-00015700: 6461 7461 203d 207b 0a20 2020 2020 2020  data = {.       
-00015710: 2020 2020 2022 7873 223a 205b 5d2c 0a20       "xs": [],. 
-00015720: 2020 2020 2020 2020 2020 2022 7973 223a             "ys":
-00015730: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-00015740: 2022 7865 223a 205b 5d2c 0a20 2020 2020   "xe": [],.     
-00015750: 2020 2020 2020 2022 7965 223a 205b 5d2c         "ye": [],
-00015760: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-00015770: 2020 2020 6475 7261 7469 6f6e 7320 3d20      durations = 
-00015780: 7365 7428 290a 2020 2020 2020 2020 6e62  set().        nb
-00015790: 7974 6573 203d 2073 6574 2829 0a20 2020  ytes = set().   
-000157a0: 2020 2020 2066 6f72 2074 6720 696e 2073       for tg in s
-000157b0: 656c 662e 7363 6865 6475 6c65 722e 7461  elf.scheduler.ta
-000157c0: 736b 5f67 726f 7570 732e 7661 6c75 6573  sk_groups.values
-000157d0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-000157e0: 6966 2074 672e 6475 7261 7469 6f6e 2061  if tg.duration a
-000157f0: 6e64 2074 672e 6e62 7974 6573 5f74 6f74  nd tg.nbytes_tot
-00015800: 616c 3a0a 2020 2020 2020 2020 2020 2020  al:.            
-00015810: 2020 2020 6475 7261 7469 6f6e 732e 6164      durations.ad
-00015820: 6428 7467 2e64 7572 6174 696f 6e29 0a20  d(tg.duration). 
-00015830: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00015840: 6279 7465 732e 6164 6428 7467 2e6e 6279  bytes.add(tg.nby
-00015850: 7465 735f 746f 7461 6c29 0a0a 2020 2020  tes_total)..    
-00015860: 2020 2020 6475 7261 7469 6f6e 735f 6d69      durations_mi
-00015870: 6e20 3d20 6d69 6e28 6475 7261 7469 6f6e  n = min(duration
-00015880: 732c 2064 6566 6175 6c74 3d30 290a 2020  s, default=0).  
-00015890: 2020 2020 2020 6475 7261 7469 6f6e 735f        durations_
-000158a0: 6d61 7820 3d20 6d61 7828 6475 7261 7469  max = max(durati
-000158b0: 6f6e 732c 2064 6566 6175 6c74 3d30 290a  ons, default=0).
-000158c0: 2020 2020 2020 2020 6e62 7974 6573 5f6d          nbytes_m
-000158d0: 696e 203d 206d 696e 286e 6279 7465 732c  in = min(nbytes,
-000158e0: 2064 6566 6175 6c74 3d30 290a 2020 2020   default=0).    
-000158f0: 2020 2020 6e62 7974 6573 5f6d 6178 203d      nbytes_max =
-00015900: 206d 6178 286e 6279 7465 732c 2064 6566   max(nbytes, def
-00015910: 6175 6c74 3d30 290a 0a20 2020 2020 2020  ault=0)..       
-00015920: 2062 6f78 5f64 696d 203d 207b 7d0a 2020   box_dim = {}.  
-00015930: 2020 2020 2020 666f 7220 6b65 792c 2074        for key, t
-00015940: 6720 696e 2073 656c 662e 7363 6865 6475  g in self.schedu
-00015950: 6c65 722e 7461 736b 5f67 726f 7570 732e  ler.task_groups.
-00015960: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-00015970: 2020 2020 2063 6f6d 705f 7461 736b 7320       comp_tasks 
-00015980: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-00015990: 2020 2020 7467 2e73 7461 7465 735b 2272      tg.states["r
-000159a0: 656c 6561 7365 6422 5d20 2b20 7467 2e73  eleased"] + tg.s
-000159b0: 7461 7465 735b 226d 656d 6f72 7922 5d20  tates["memory"] 
-000159c0: 2b20 7467 2e73 7461 7465 735b 2265 7272  + tg.states["err
-000159d0: 6564 225d 0a20 2020 2020 2020 2020 2020  ed"].           
-000159e0: 2029 0a20 2020 2020 2020 2020 2020 2074   ).            t
-000159f0: 6f74 5f74 6173 6b73 203d 2073 756d 2874  ot_tasks = sum(t
-00015a00: 672e 7374 6174 6573 2e76 616c 7565 7328  g.states.values(
-00015a10: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
-00015a20: 2320 636f 6d70 7574 6520 7769 6474 6820  # compute width 
-00015a30: 616e 6420 6865 6967 6874 206f 6620 626f  and height of bo
-00015a40: 7865 730a 2020 2020 2020 2020 2020 2020  xes.            
-00015a50: 6966 2028 0a20 2020 2020 2020 2020 2020  if (.           
-00015a60: 2020 2020 2074 672e 6475 7261 7469 6f6e       tg.duration
-00015a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015a80: 2061 6e64 2074 672e 6e62 7974 6573 5f74   and tg.nbytes_t
-00015a90: 6f74 616c 0a20 2020 2020 2020 2020 2020  otal.           
-00015aa0: 2020 2020 2061 6e64 2063 6f6d 705f 7461       and comp_ta
-00015ab0: 736b 730a 2020 2020 2020 2020 2020 2020  sks.            
-00015ac0: 2020 2020 616e 6420 6c65 6e28 6475 7261      and len(dura
-00015ad0: 7469 6f6e 7329 203e 2031 0a20 2020 2020  tions) > 1.     
-00015ae0: 2020 2020 2020 2020 2020 2061 6e64 206c             and l
-00015af0: 656e 286e 6279 7465 7329 203e 2031 0a20  en(nbytes) > 1. 
-00015b00: 2020 2020 2020 2020 2020 2029 3a0a 2020             ):.  
-00015b10: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00015b20: 7363 616c 6520 6475 7261 7469 6f6e 2028  scale duration (
-00015b30: 7769 6474 6829 0a20 2020 2020 2020 2020  width).         
-00015b40: 2020 2020 2020 2077 6964 7468 5f62 6f78         width_box
-00015b50: 203d 2073 656c 662e 636f 6d70 7574 655f   = self.compute_
-00015b60: 7369 7a65 280a 2020 2020 2020 2020 2020  size(.          
-00015b70: 2020 2020 2020 2020 2020 7467 2e64 7572            tg.dur
-00015b80: 6174 696f 6e20 2f20 636f 6d70 5f74 6173  ation / comp_tas
-00015b90: 6b73 202a 2074 6f74 5f74 6173 6b73 2c0a  ks * tot_tasks,.
-00015ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015bb0: 2020 2020 6d69 6e5f 626f 783d 6475 7261      min_box=dura
-00015bc0: 7469 6f6e 735f 6d69 6e20 2f20 636f 6d70  tions_min / comp
-00015bd0: 5f74 6173 6b73 202a 2074 6f74 5f74 6173  _tasks * tot_tas
-00015be0: 6b73 2c0a 2020 2020 2020 2020 2020 2020  ks,.            
-00015bf0: 2020 2020 2020 2020 6d61 785f 626f 783d          max_box=
-00015c00: 6475 7261 7469 6f6e 735f 6d61 7820 2f20  durations_max / 
-00015c10: 636f 6d70 5f74 6173 6b73 202a 2074 6f74  comp_tasks * tot
-00015c20: 5f74 6173 6b73 2c0a 2020 2020 2020 2020  _tasks,.        
-00015c30: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00015c40: 2020 2020 2020 2020 2020 2023 206e 6565             # nee
-00015c50: 6420 746f 2073 6361 6c65 206d 656d 6f72  d to scale memor
-00015c60: 7920 2868 6569 6768 7429 0a20 2020 2020  y (height).     
-00015c70: 2020 2020 2020 2020 2020 2068 6569 6768             heigh
-00015c80: 745f 626f 7820 3d20 7365 6c66 2e63 6f6d  t_box = self.com
-00015c90: 7075 7465 5f73 697a 6528 0a20 2020 2020  pute_size(.     
-00015ca0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00015cb0: 672e 6e62 7974 6573 5f74 6f74 616c 202f  g.nbytes_total /
-00015cc0: 2063 6f6d 705f 7461 736b 7320 2a20 746f   comp_tasks * to
-00015cd0: 745f 7461 736b 732c 0a20 2020 2020 2020  t_tasks,.       
-00015ce0: 2020 2020 2020 2020 2020 2020 206d 696e               min
-00015cf0: 5f62 6f78 3d6e 6279 7465 735f 6d69 6e20  _box=nbytes_min 
-00015d00: 2f20 636f 6d70 5f74 6173 6b73 202a 2074  / comp_tasks * t
-00015d10: 6f74 5f74 6173 6b73 2c0a 2020 2020 2020  ot_tasks,.      
-00015d20: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-00015d30: 785f 626f 783d 6e62 7974 6573 5f6d 6178  x_box=nbytes_max
-00015d40: 202f 2063 6f6d 705f 7461 736b 7320 2a20   / comp_tasks * 
-00015d50: 746f 745f 7461 736b 732c 0a20 2020 2020  tot_tasks,.     
-00015d60: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00015d70: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00015d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d90: 7769 6474 685f 626f 7820 3d20 302e 360a  width_box = 0.6.
-00015da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015db0: 6865 6967 6874 5f62 6f78 203d 2077 6964  height_box = wid
-00015dc0: 7468 5f62 6f78 202f 2032 0a0a 2020 2020  th_box / 2..    
-00015dd0: 2020 2020 2020 2020 626f 785f 6469 6d5b          box_dim[
-00015de0: 6b65 795d 203d 207b 2277 6964 7468 223a  key] = {"width":
-00015df0: 2077 6964 7468 5f62 6f78 2c20 2268 6569   width_box, "hei
-00015e00: 6768 7422 3a20 6865 6967 6874 5f62 6f78  ght": height_box
-00015e10: 7d0a 0a20 2020 2020 2020 2066 6f72 206b  }..        for k
-00015e20: 6579 2c20 7467 2069 6e20 7365 6c66 2e73  ey, tg in self.s
-00015e30: 6368 6564 756c 6572 2e74 6173 6b5f 6772  cheduler.task_gr
-00015e40: 6f75 7073 2e69 7465 6d73 2829 3a0a 2020  oups.items():.  
-00015e50: 2020 2020 2020 2020 2020 7820 3d20 7365            x = se
-00015e60: 6c66 2e6e 6f64 6573 5f6c 6179 6f75 745b  lf.nodes_layout[
-00015e70: 6b65 795d 5b22 7822 5d0a 2020 2020 2020  key]["x"].      
-00015e80: 2020 2020 2020 7920 3d20 7365 6c66 2e6e        y = self.n
-00015e90: 6f64 6573 5f6c 6179 6f75 745b 6b65 795d  odes_layout[key]
-00015ea0: 5b22 7922 5d0a 2020 2020 2020 2020 2020  ["y"].          
-00015eb0: 2020 7769 6474 6820 3d20 626f 785f 6469    width = box_di
-00015ec0: 6d5b 6b65 795d 5b22 7769 6474 6822 5d0a  m[key]["width"].
-00015ed0: 2020 2020 2020 2020 2020 2020 6865 6967              heig
-00015ee0: 6874 203d 2062 6f78 5f64 696d 5b6b 6579  ht = box_dim[key
-00015ef0: 5d5b 2268 6569 6768 7422 5d0a 0a20 2020  ]["height"]..   
-00015f00: 2020 2020 2020 2020 2023 206d 6169 6e20           # main 
-00015f10: 626f 7865 7320 6c61 796f 7574 0a20 2020  boxes layout.   
-00015f20: 2020 2020 2020 2020 206e 6f64 6573 5f64           nodes_d
-00015f30: 6174 615b 2278 225d 2e61 7070 656e 6428  ata["x"].append(
-00015f40: 7829 0a20 2020 2020 2020 2020 2020 206e  x).            n
-00015f50: 6f64 6573 5f64 6174 615b 2279 225d 2e61  odes_data["y"].a
-00015f60: 7070 656e 6428 7929 0a20 2020 2020 2020  ppend(y).       
-00015f70: 2020 2020 206e 6f64 6573 5f64 6174 615b       nodes_data[
-00015f80: 2277 5f62 6f78 225d 2e61 7070 656e 6428  "w_box"].append(
-00015f90: 7769 6474 6829 0a20 2020 2020 2020 2020  width).         
-00015fa0: 2020 206e 6f64 6573 5f64 6174 615b 2268     nodes_data["h
-00015fb0: 5f62 6f78 225d 2e61 7070 656e 6428 6865  _box"].append(he
-00015fc0: 6967 6874 290a 0a20 2020 2020 2020 2020  ight)..         
-00015fd0: 2020 2063 6f6d 705f 7461 736b 7320 3d20     comp_tasks = 
-00015fe0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00015ff0: 2020 7467 2e73 7461 7465 735b 2272 656c    tg.states["rel
-00016000: 6561 7365 6422 5d20 2b20 7467 2e73 7461  eased"] + tg.sta
-00016010: 7465 735b 226d 656d 6f72 7922 5d20 2b20  tes["memory"] + 
-00016020: 7467 2e73 7461 7465 735b 2265 7272 6564  tg.states["erred
-00016030: 225d 0a20 2020 2020 2020 2020 2020 2029  "].            )
-00016040: 0a20 2020 2020 2020 2020 2020 2074 6f74  .            tot
-00016050: 5f74 6173 6b73 203d 2073 756d 2874 672e  _tasks = sum(tg.
-00016060: 7374 6174 6573 2e76 616c 7565 7328 2929  states.values())
-00016070: 0a0a 2020 2020 2020 2020 2020 2020 6e6f  ..            no
-00016080: 6465 735f 6461 7461 5b22 6e61 6d65 225d  des_data["name"]
-00016090: 2e61 7070 656e 6428 7467 2e70 7265 6669  .append(tg.prefi
-000160a0: 782e 6e61 6d65 290a 0a20 2020 2020 2020  x.name)..       
-000160b0: 2020 2020 206e 6f64 6573 5f64 6174 615b       nodes_data[
-000160c0: 2263 6f6c 6f72 225d 2e61 7070 656e 6428  "color"].append(
-000160d0: 636f 6c6f 725f 6f66 2874 672e 7072 6566  color_of(tg.pref
-000160e0: 6978 2e6e 616d 6529 290a 2020 2020 2020  ix.name)).      
-000160f0: 2020 2020 2020 6e6f 6465 735f 6461 7461        nodes_data
-00016100: 5b22 746f 745f 7461 736b 7322 5d2e 6170  ["tot_tasks"].ap
-00016110: 7065 6e64 2874 6f74 5f74 6173 6b73 290a  pend(tot_tasks).
-00016120: 0a20 2020 2020 2020 2020 2020 2023 206d  .            # m
-00016130: 656d 6f72 7920 616c 7068 6120 6661 6374  emory alpha fact
-00016140: 6f72 2062 7920 302e 3420 6966 206e 6f74  or by 0.4 if not
-00016150: 2067 6574 2773 2074 6f6f 2064 6172 6b0a   get's too dark.
-00016160: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-00016170: 735f 6461 7461 5b22 6d65 6d5f 616c 7068  s_data["mem_alph
-00016180: 6122 5d2e 6170 7065 6e64 280a 2020 2020  a"].append(.    
-00016190: 2020 2020 2020 2020 2020 2020 2874 672e              (tg.
-000161a0: 7374 6174 6573 5b22 6d65 6d6f 7279 225d  states["memory"]
-000161b0: 202f 2073 756d 2874 672e 7374 6174 6573   / sum(tg.states
-000161c0: 2e76 616c 7565 7328 2929 2920 2a20 302e  .values())) * 0.
-000161d0: 340a 2020 2020 2020 2020 2020 2020 290a  4.            ).
-000161e0: 0a20 2020 2020 2020 2020 2020 2023 206d  .            # m
-000161f0: 6169 6e20 626f 7820 6c69 6e65 2077 6964  ain box line wid
-00016200: 7468 0a20 2020 2020 2020 2020 2020 2069  th.            i
-00016210: 6620 7467 2e73 7461 7465 735b 2270 726f  f tg.states["pro
-00016220: 6365 7373 696e 6722 5d3a 0a20 2020 2020  cessing"]:.     
-00016230: 2020 2020 2020 2020 2020 206e 6f64 6573             nodes
-00016240: 5f64 6174 615b 226e 6f64 655f 6c69 6e65  _data["node_line
-00016250: 5f77 6964 7468 225d 2e61 7070 656e 6428  _width"].append(
-00016260: 3529 0a20 2020 2020 2020 2020 2020 2065  5).            e
-00016270: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00016280: 2020 2020 206e 6f64 6573 5f64 6174 615b       nodes_data[
-00016290: 226e 6f64 655f 6c69 6e65 5f77 6964 7468  "node_line_width
-000162a0: 225d 2e61 7070 656e 6428 3129 0a0a 2020  "].append(1)..  
-000162b0: 2020 2020 2020 2020 2020 2320 7072 6f67            # prog
-000162c0: 7265 7373 2062 6172 2064 6174 6120 7570  ress bar data up
-000162d0: 6461 7465 0a20 2020 2020 2020 2020 2020  date.           
-000162e0: 206e 6f64 6573 5f64 6174 615b 2278 5f73   nodes_data["x_s
-000162f0: 7461 7274 225d 2e61 7070 656e 6428 7820  tart"].append(x 
-00016300: 2d20 7769 6474 6820 2f20 3229 0a20 2020  - width / 2).   
-00016310: 2020 2020 2020 2020 206e 6f64 6573 5f64           nodes_d
-00016320: 6174 615b 2278 5f65 6e64 225d 2e61 7070  ata["x_end"].app
-00016330: 656e 6428 7820 2b20 7769 6474 6820 2f20  end(x + width / 
-00016340: 3229 0a0a 2020 2020 2020 2020 2020 2020  2)..            
-00016350: 6e6f 6465 735f 6461 7461 5b22 795f 7374  nodes_data["y_st
-00016360: 6172 7422 5d2e 6170 7065 6e64 2879 202d  art"].append(y -
-00016370: 2068 6569 6768 7420 2f20 3229 0a20 2020   height / 2).   
-00016380: 2020 2020 2020 2020 206e 6f64 6573 5f64           nodes_d
-00016390: 6174 615b 2279 5f65 6e64 225d 2e61 7070  ata["y_end"].app
-000163a0: 656e 6428 7920 2d20 6865 6967 6874 202f  end(y - height /
-000163b0: 2032 202b 2068 6569 6768 7420 2a20 302e   2 + height * 0.
-000163c0: 3429 0a0a 2020 2020 2020 2020 2020 2020  4)..            
-000163d0: 6e6f 6465 735f 6461 7461 5b22 785f 656e  nodes_data["x_en
-000163e0: 645f 7072 6f67 7265 7373 225d 2e61 7070  d_progress"].app
-000163f0: 656e 6428 0a20 2020 2020 2020 2020 2020  end(.           
-00016400: 2020 2020 2078 202d 2077 6964 7468 202f       x - width /
-00016410: 2032 202b 2077 6964 7468 202a 2063 6f6d   2 + width * com
-00016420: 705f 7461 736b 7320 2f20 746f 745f 7461  p_tasks / tot_ta
-00016430: 736b 730a 2020 2020 2020 2020 2020 2020  sks.            
-00016440: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
-00016450: 2061 7272 6f77 730a 2020 2020 2020 2020   arrows.        
-00016460: 2020 2020 6172 726f 7773 5f64 6174 615b      arrows_data[
-00016470: 2278 7322 5d20 2b3d 205b 0a20 2020 2020  "xs"] += [.     
-00016480: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00016490: 6e6f 6465 735f 6c61 796f 7574 5b6b 5d5b  nodes_layout[k][
-000164a0: 2278 225d 202b 2062 6f78 5f64 696d 5b6b  "x"] + box_dim[k
-000164b0: 5d5b 2277 6964 7468 225d 202f 2032 0a20  ]["width"] / 2. 
-000164c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000164d0: 6f72 206b 2069 6e20 7365 6c66 2e61 7272  or k in self.arr
-000164e0: 6f77 735f 6c61 796f 7574 5b6b 6579 5d5b  ows_layout[key][
-000164f0: 226e 7374 6172 7422 5d0a 2020 2020 2020  "nstart"].      
-00016500: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
-00016510: 2020 2020 6172 726f 7773 5f64 6174 615b      arrows_data[
-00016520: 2279 7322 5d20 2b3d 205b 0a20 2020 2020  "ys"] += [.     
-00016530: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00016540: 6e6f 6465 735f 6c61 796f 7574 5b6b 5d5b  nodes_layout[k][
-00016550: 2279 225d 2066 6f72 206b 2069 6e20 7365  "y"] for k in se
-00016560: 6c66 2e61 7272 6f77 735f 6c61 796f 7574  lf.arrows_layout
-00016570: 5b6b 6579 5d5b 226e 7374 6172 7422 5d0a  [key]["nstart"].
-00016580: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-00016590: 2020 2020 2020 2020 2020 6172 726f 7773            arrows
-000165a0: 5f64 6174 615b 2278 6522 5d20 2b3d 205b  _data["xe"] += [
-000165b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000165c0: 2073 656c 662e 6e6f 6465 735f 6c61 796f   self.nodes_layo
-000165d0: 7574 5b6b 5d5b 2278 225d 202d 2062 6f78  ut[k]["x"] - box
-000165e0: 5f64 696d 5b6b 5d5b 2277 6964 7468 225d  _dim[k]["width"]
-000165f0: 202f 2032 0a20 2020 2020 2020 2020 2020   / 2.           
-00016600: 2020 2020 2066 6f72 206b 2069 6e20 7365       for k in se
-00016610: 6c66 2e61 7272 6f77 735f 6c61 796f 7574  lf.arrows_layout
-00016620: 5b6b 6579 5d5b 226e 656e 6422 5d0a 2020  [key]["nend"].  
-00016630: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
-00016640: 2020 2020 2020 2020 6172 726f 7773 5f64          arrows_d
-00016650: 6174 615b 2279 6522 5d20 2b3d 205b 0a20  ata["ye"] += [. 
-00016660: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00016670: 656c 662e 6e6f 6465 735f 6c61 796f 7574  elf.nodes_layout
-00016680: 5b6b 5d5b 2279 225d 2066 6f72 206b 2069  [k]["y"] for k i
-00016690: 6e20 7365 6c66 2e61 7272 6f77 735f 6c61  n self.arrows_la
-000166a0: 796f 7574 5b6b 6579 5d5b 226e 656e 6422  yout[key]["nend"
-000166b0: 5d0a 2020 2020 2020 2020 2020 2020 5d0a  ].            ].
-000166c0: 0a20 2020 2020 2020 2020 2020 2023 204c  .            # L
-000166d0: 4f47 4f53 0a20 2020 2020 2020 2020 2020  OGOS.           
-000166e0: 2069 6620 6c65 6e28 7467 2e74 7970 6573   if len(tg.types
-000166f0: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
-00016700: 2020 2020 2020 2020 6c6f 676f 5f74 7970          logo_typ
-00016710: 6520 3d20 6e65 7874 2869 7465 7228 7467  e = next(iter(tg
-00016720: 2e74 7970 6573 2929 2e73 706c 6974 2822  .types)).split("
-00016730: 2e22 295b 305d 0a20 2020 2020 2020 2020  .")[0].         
-00016740: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00016750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016760: 7572 6c5f 6c6f 676f 203d 206c 6f67 6f73  url_logo = logos
-00016770: 5f64 6963 745b 6c6f 676f 5f74 7970 655d  _dict[logo_type]
-00016780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016790: 2065 7863 6570 7420 4b65 7945 7272 6f72   except KeyError
-000167a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000167b0: 2020 2020 2020 7572 6c5f 6c6f 676f 203d        url_logo =
-000167c0: 2022 220a 2020 2020 2020 2020 2020 2020   "".            
-000167d0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000167e0: 2020 2020 2020 7572 6c5f 6c6f 676f 203d        url_logo =
-000167f0: 2022 220a 0a20 2020 2020 2020 2020 2020   ""..           
-00016800: 206e 6f64 6573 5f64 6174 615b 2275 726c   nodes_data["url
-00016810: 5f6c 6f67 6f22 5d2e 6170 7065 6e64 2875  _logo"].append(u
-00016820: 726c 5f6c 6f67 6f29 0a0a 2020 2020 2020  rl_logo)..      
-00016830: 2020 2020 2020 6e6f 6465 735f 6461 7461        nodes_data
-00016840: 5b22 785f 6c6f 676f 225d 2e61 7070 656e  ["x_logo"].appen
-00016850: 6428 7820 2b20 7769 6474 6820 2f20 3329  d(x + width / 3)
-00016860: 0a20 2020 2020 2020 2020 2020 206e 6f64  .            nod
-00016870: 6573 5f64 6174 615b 2279 5f6c 6f67 6f22  es_data["y_logo"
-00016880: 5d2e 6170 7065 6e64 2879 202b 2068 6569  ].append(y + hei
-00016890: 6768 7420 2f20 3329 0a0a 2020 2020 2020  ght / 3)..      
-000168a0: 2020 2020 2020 7261 7469 6f20 3d20 7769        ratio = wi
-000168b0: 6474 6820 2f20 6865 6967 6874 0a0a 2020  dth / height..  
-000168c0: 2020 2020 2020 2020 2020 6966 2072 6174            if rat
-000168d0: 696f 203e 2031 3a0a 2020 2020 2020 2020  io > 1:.        
-000168e0: 2020 2020 2020 2020 6e6f 6465 735f 6461          nodes_da
-000168f0: 7461 5b22 685f 6c6f 676f 225d 2e61 7070  ta["h_logo"].app
-00016900: 656e 6428 6865 6967 6874 202a 2030 2e33  end(height * 0.3
-00016910: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00016920: 2020 6e6f 6465 735f 6461 7461 5b22 775f    nodes_data["w_
-00016930: 6c6f 676f 225d 2e61 7070 656e 6428 7769  logo"].append(wi
-00016940: 6474 6820 2a20 302e 3320 2f20 7261 7469  dth * 0.3 / rati
-00016950: 6f29 0a20 2020 2020 2020 2020 2020 2065  o).            e
-00016960: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00016970: 2020 2020 206e 6f64 6573 5f64 6174 615b       nodes_data[
-00016980: 2268 5f6c 6f67 6f22 5d2e 6170 7065 6e64  "h_logo"].append
-00016990: 2868 6569 6768 7420 2a20 302e 3320 2a20  (height * 0.3 * 
-000169a0: 7261 7469 6f29 0a20 2020 2020 2020 2020  ratio).         
-000169b0: 2020 2020 2020 206e 6f64 6573 5f64 6174         nodes_dat
-000169c0: 615b 2277 5f6c 6f67 6f22 5d2e 6170 7065  a["w_logo"].appe
-000169d0: 6e64 2877 6964 7468 202a 2030 2e33 290a  nd(width * 0.3).
-000169e0: 0a20 2020 2020 2020 2020 2020 2023 2063  .            # c
-000169f0: 6f6d 7075 7465 5f74 696d 6520 616e 6420  ompute_time and 
-00016a00: 6d65 6d6f 7279 0a20 2020 2020 2020 2020  memory.         
-00016a10: 2020 206e 6f64 6573 5f64 6174 615b 2263     nodes_data["c
-00016a20: 6f6d 7075 7465 5f74 696d 6522 5d2e 6170  ompute_time"].ap
-00016a30: 7065 6e64 2866 6f72 6d61 745f 7469 6d65  pend(format_time
-00016a40: 2874 672e 6475 7261 7469 6f6e 2929 0a20  (tg.duration)). 
-00016a50: 2020 2020 2020 2020 2020 206e 6f64 6573             nodes
-00016a60: 5f64 6174 615b 226d 656d 6f72 7922 5d2e  _data["memory"].
-00016a70: 6170 7065 6e64 2866 6f72 6d61 745f 6279  append(format_by
-00016a80: 7465 7328 7467 2e6e 6279 7465 735f 746f  tes(tg.nbytes_to
-00016a90: 7461 6c29 290a 0a20 2020 2020 2020 2020  tal))..         
-00016aa0: 2020 2023 2041 6464 2073 6f6d 6520 7374     # Add some st
-00016ab0: 6174 7573 2074 6f20 686f 7665 720a 2020  atus to hover.  
-00016ac0: 2020 2020 2020 2020 2020 7461 736b 735f            tasks_
-00016ad0: 7072 6f63 6573 7369 6e67 203d 2074 672e  processing = tg.
-00016ae0: 7374 6174 6573 5b22 7072 6f63 6573 7369  states["processi
-00016af0: 6e67 225d 0a20 2020 2020 2020 2020 2020  ng"].           
-00016b00: 2074 6173 6b73 5f6d 656d 6f72 7920 3d20   tasks_memory = 
-00016b10: 7467 2e73 7461 7465 735b 226d 656d 6f72  tg.states["memor
-00016b20: 7922 5d0a 2020 2020 2020 2020 2020 2020  y"].            
-00016b30: 7461 736b 735f 7265 6c61 7365 6420 3d20  tasks_relased = 
-00016b40: 7467 2e73 7461 7465 735b 2272 656c 6561  tg.states["relea
-00016b50: 7365 6422 5d0a 2020 2020 2020 2020 2020  sed"].          
-00016b60: 2020 7461 736b 735f 6572 7265 6420 3d20    tasks_erred = 
-00016b70: 7467 2e73 7461 7465 735b 2265 7272 6564  tg.states["erred
-00016b80: 225d 0a0a 2020 2020 2020 2020 2020 2020  "]..            
-00016b90: 6e6f 6465 735f 6461 7461 5b22 636f 6d70  nodes_data["comp
-00016ba0: 5f74 6173 6b73 225d 2e61 7070 656e 6428  _tasks"].append(
-00016bb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016bc0: 2066 227b 636f 6d70 5f74 6173 6b73 7d20   f"{comp_tasks} 
-00016bd0: 287b 636f 6d70 5f74 6173 6b73 202f 2074  ({comp_tasks / t
-00016be0: 6f74 5f74 6173 6b73 202a 2031 3030 3a2e  ot_tasks * 100:.
-00016bf0: 3066 7d20 2529 220a 2020 2020 2020 2020  0f} %)".        
-00016c00: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00016c10: 2020 6e6f 6465 735f 6461 7461 5b22 696e    nodes_data["in
-00016c20: 5f70 726f 6365 7373 696e 6722 5d2e 6170  _processing"].ap
-00016c30: 7065 6e64 280a 2020 2020 2020 2020 2020  pend(.          
-00016c40: 2020 2020 2020 6622 7b74 6173 6b73 5f70        f"{tasks_p
-00016c50: 726f 6365 7373 696e 677d 2028 7b74 6173  rocessing} ({tas
-00016c60: 6b73 5f70 726f 6365 7373 696e 672f 2074  ks_processing/ t
-00016c70: 6f74 5f74 6173 6b73 202a 2031 3030 3a2e  ot_tasks * 100:.
-00016c80: 3066 7d20 2529 220a 2020 2020 2020 2020  0f} %)".        
-00016c90: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00016ca0: 2020 6e6f 6465 735f 6461 7461 5b22 696e    nodes_data["in
-00016cb0: 5f6d 656d 6f72 7922 5d2e 6170 7065 6e64  _memory"].append
-00016cc0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00016cd0: 2020 6622 7b74 6173 6b73 5f6d 656d 6f72    f"{tasks_memor
-00016ce0: 797d 2028 7b74 6173 6b73 5f6d 656d 6f72  y} ({tasks_memor
-00016cf0: 792f 2074 6f74 5f74 6173 6b73 202a 2031  y/ tot_tasks * 1
-00016d00: 3030 3a2e 3066 7d20 2529 220a 2020 2020  00:.0f} %)".    
-00016d10: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00016d20: 2020 2020 2020 6e6f 6465 735f 6461 7461        nodes_data
-00016d30: 5b22 696e 5f72 656c 6561 7365 6422 5d2e  ["in_released"].
-00016d40: 6170 7065 6e64 280a 2020 2020 2020 2020  append(.        
-00016d50: 2020 2020 2020 2020 6622 7b74 6173 6b73          f"{tasks
-00016d60: 5f72 656c 6173 6564 7d20 287b 7461 736b  _relased} ({task
-00016d70: 735f 7265 6c61 7365 642f 2074 6f74 5f74  s_relased/ tot_t
-00016d80: 6173 6b73 202a 2031 3030 3a2e 3066 7d20  asks * 100:.0f} 
-00016d90: 2529 220a 2020 2020 2020 2020 2020 2020  %)".            
-00016da0: 290a 2020 2020 2020 2020 2020 2020 6e6f  ).            no
-00016db0: 6465 735f 6461 7461 5b22 696e 5f65 7272  des_data["in_err
-00016dc0: 6564 225d 2e61 7070 656e 6428 0a20 2020  ed"].append(.   
-00016dd0: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
-00016de0: 2074 6173 6b73 5f65 7272 6564 7d20 287b   tasks_erred} ({
-00016df0: 7461 736b 735f 6572 7265 642f 2074 6f74  tasks_erred/ tot
-00016e00: 5f74 6173 6b73 202a 2031 3030 3a2e 3066  _tasks * 100:.0f
-00016e10: 7d20 2529 220a 2020 2020 2020 2020 2020  } %)".          
-00016e20: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
-00016e30: 662e 6e6f 6465 735f 736f 7572 6365 2e64  f.nodes_source.d
-00016e40: 6174 612e 7570 6461 7465 286e 6f64 6573  ata.update(nodes
-00016e50: 5f64 6174 6129 0a20 2020 2020 2020 2073  _data).        s
-00016e60: 656c 662e 6172 726f 7773 5f73 6f75 7263  elf.arrows_sourc
-00016e70: 652e 6461 7461 2e75 7064 6174 6528 6172  e.data.update(ar
-00016e80: 726f 7773 5f64 6174 6129 0a0a 0a63 6c61  rows_data)...cla
-00016e90: 7373 2054 6173 6b47 726f 7570 5072 6f67  ss TaskGroupProg
-00016ea0: 7265 7373 2844 6173 6862 6f61 7264 436f  ress(DashboardCo
-00016eb0: 6d70 6f6e 656e 7429 3a0a 2020 2020 2222  mponent):.    ""
-00016ec0: 2253 7461 636b 6564 2061 7265 6120 6368  "Stacked area ch
-00016ed0: 6172 7420 7368 6f77 696e 6720 7461 736b  art showing task
-00016ee0: 2067 726f 7570 7320 7468 726f 7567 6820   groups through 
-00016ef0: 7469 6d65 2222 220a 0a20 2020 2064 6566  time"""..    def
-00016f00: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-00016f10: 7363 6865 6475 6c65 722c 202a 2a6b 7761  scheduler, **kwa
-00016f20: 7267 7329 3a0a 2020 2020 2020 2020 7365  rgs):.        se
-00016f30: 6c66 2e73 6368 6564 756c 6572 203d 2073  lf.scheduler = s
-00016f40: 6368 6564 756c 6572 0a20 2020 2020 2020  cheduler.       
-00016f50: 2073 656c 662e 736f 7572 6365 203d 2043   self.source = C
-00016f60: 6f6c 756d 6e44 6174 6153 6f75 7263 6528  olumnDataSource(
-00016f70: 290a 2020 2020 2020 2020 2320 5468 6520  ).        # The 
-00016f80: 6c65 6e67 7468 206f 6620 7469 6d65 7365  length of timese
-00016f90: 7269 6573 2074 6f20 6368 6172 7420 2869  ries to chart (i
-00016fa0: 6e20 756e 6974 7320 6f66 2070 6c75 6769  n units of plugi
-00016fb0: 6e2e 6474 290a 2020 2020 2020 2020 7365  n.dt).        se
-00016fc0: 6c66 2e6e 7074 7320 3d20 3138 300a 0a20  lf.npts = 180.. 
-00016fd0: 2020 2020 2020 2069 6620 4772 6f75 7054         if GroupT
-00016fe0: 696d 696e 672e 6e61 6d65 206e 6f74 2069  iming.name not i
-00016ff0: 6e20 7363 6865 6475 6c65 722e 706c 7567  n scheduler.plug
-00017000: 696e 733a 0a20 2020 2020 2020 2020 2020  ins:.           
-00017010: 2073 6368 6564 756c 6572 2e61 6464 5f70   scheduler.add_p
-00017020: 6c75 6769 6e28 706c 7567 696e 3d47 726f  lugin(plugin=Gro
-00017030: 7570 5469 6d69 6e67 2873 6368 6564 756c  upTiming(schedul
-00017040: 6572 2929 0a0a 2020 2020 2020 2020 7365  er))..        se
-00017050: 6c66 2e70 6c75 6769 6e20 3d20 7363 6865  lf.plugin = sche
-00017060: 6475 6c65 722e 706c 7567 696e 735b 4772  duler.plugins[Gr
-00017070: 6f75 7054 696d 696e 672e 6e61 6d65 5d0a  oupTiming.name].
-00017080: 0a20 2020 2020 2020 2073 656c 662e 736f  .        self.so
-00017090: 7572 6365 2e61 6464 286e 702e 6172 7261  urce.add(np.arra
-000170a0: 7928 7365 6c66 2e70 6c75 6769 6e2e 7469  y(self.plugin.ti
-000170b0: 6d65 2920 2a20 3130 3030 2e30 2c20 2274  me) * 1000.0, "t
-000170c0: 696d 6522 290a 0a20 2020 2020 2020 2078  ime")..        x
-000170d0: 5f72 616e 6765 203d 2044 6174 6152 616e  _range = DataRan
-000170e0: 6765 3164 2872 616e 6765 5f70 6164 6469  ge1d(range_paddi
-000170f0: 6e67 3d30 290a 2020 2020 2020 2020 795f  ng=0).        y_
-00017100: 7261 6e67 6520 3d20 5261 6e67 6531 6428  range = Range1d(
-00017110: 302c 206d 6178 2873 656c 662e 706c 7567  0, max(self.plug
-00017120: 696e 2e6e 7468 7265 6164 7329 290a 0a20  in.nthreads)).. 
-00017130: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-00017140: 203d 2066 6967 7572 6528 0a20 2020 2020   = figure(.     
-00017150: 2020 2020 2020 2074 6974 6c65 3d22 5461         title="Ta
-00017160: 736b 2047 726f 7570 2050 726f 6772 6573  sk Group Progres
-00017170: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-00017180: 6e61 6d65 3d22 7461 736b 5f67 726f 7570  name="task_group
-00017190: 5f70 726f 6772 6573 7322 2c0a 2020 2020  _progress",.    
-000171a0: 2020 2020 2020 2020 746f 6f6c 6261 725f          toolbar_
-000171b0: 6c6f 6361 7469 6f6e 3d22 6162 6f76 6522  location="above"
-000171c0: 2c0a 2020 2020 2020 2020 2020 2020 6d69  ,.            mi
-000171d0: 6e5f 626f 7264 6572 5f62 6f74 746f 6d3d  n_border_bottom=
-000171e0: 3530 2c0a 2020 2020 2020 2020 2020 2020  50,.            
-000171f0: 785f 7261 6e67 653d 785f 7261 6e67 652c  x_range=x_range,
-00017200: 0a20 2020 2020 2020 2020 2020 2079 5f72  .            y_r
-00017210: 616e 6765 3d79 5f72 616e 6765 2c0a 2020  ange=y_range,.  
-00017220: 2020 2020 2020 2020 2020 746f 6f6c 733d            tools=
-00017230: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
-00017240: 785f 6178 6973 5f74 7970 653d 2264 6174  x_axis_type="dat
-00017250: 6574 696d 6522 2c0a 2020 2020 2020 2020  etime",.        
-00017260: 2020 2020 795f 6178 6973 5f6c 6f63 6174      y_axis_locat
-00017270: 696f 6e3d 4e6f 6e65 2c0a 2020 2020 2020  ion=None,.      
-00017280: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
-00017290: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000172a0: 2020 7365 6c66 2e72 6f6f 742e 7961 7869    self.root.yaxi
-000172b0: 732e 6d61 6a6f 725f 6c61 6265 6c5f 7465  s.major_label_te
-000172c0: 7874 5f61 6c70 6861 203d 2030 0a20 2020  xt_alpha = 0.   
-000172d0: 2020 2020 2073 656c 662e 726f 6f74 2e79       self.root.y
-000172e0: 6178 6973 2e6d 696e 6f72 5f74 6963 6b5f  axis.minor_tick_
-000172f0: 6c69 6e65 5f61 6c70 6861 203d 2030 0a20  line_alpha = 0. 
-00017300: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-00017310: 2e79 6178 6973 2e6d 616a 6f72 5f74 6963  .yaxis.major_tic
-00017320: 6b5f 6c69 6e65 5f61 6c70 6861 203d 2030  k_line_alpha = 0
-00017330: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-00017340: 6f74 2e78 6772 6964 2e76 6973 6962 6c65  ot.xgrid.visible
-00017350: 203d 2046 616c 7365 0a0a 2020 2020 2020   = False..      
-00017360: 2020 7365 6c66 2e72 6f6f 742e 6164 645f    self.root.add_
-00017370: 746f 6f6c 7328 0a20 2020 2020 2020 2020  tools(.         
-00017380: 2020 2042 6f78 5a6f 6f6d 546f 6f6c 2829     BoxZoomTool()
-00017390: 2c0a 2020 2020 2020 2020 2020 2020 5265  ,.            Re
-000173a0: 7365 7454 6f6f 6c28 292c 0a20 2020 2020  setTool(),.     
-000173b0: 2020 2020 2020 2050 616e 546f 6f6c 2864         PanTool(d
-000173c0: 696d 656e 7369 6f6e 733d 2277 6964 7468  imensions="width
-000173d0: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-000173e0: 5768 6565 6c5a 6f6f 6d54 6f6f 6c28 6469  WheelZoomTool(di
-000173f0: 6d65 6e73 696f 6e73 3d22 7769 6474 6822  mensions="width"
-00017400: 292c 0a20 2020 2020 2020 2029 0a20 2020  ),.        ).   
-00017410: 2020 2020 2073 656c 662e 5f68 6f76 6572       self._hover
-00017420: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00017430: 7365 6c66 2e5f 6c61 7374 5f64 7261 776e  self._last_drawn
-00017440: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00017450: 7365 6c66 2e5f 6f66 6673 6574 203d 2074  self._offset = t
-00017460: 696d 6528 290a 2020 2020 2020 2020 7365  ime().        se
-00017470: 6c66 2e5f 6c61 7374 5f74 7261 6e73 6974  lf._last_transit
-00017480: 696f 6e5f 636f 756e 7420 3d20 7363 6865  ion_count = sche
-00017490: 6475 6c65 722e 7472 616e 7369 7469 6f6e  duler.transition
-000174a0: 5f63 6f75 6e74 6572 0a20 2020 2020 2020  _counter.       
-000174b0: 2023 204f 7264 6572 6564 4469 6374 2073   # OrderedDict s
-000174c0: 6f20 7765 2063 616e 206d 616b 6520 6120  o we can make a 
-000174d0: 7265 7665 7273 6520 6974 6572 6174 6f72  reverse iterator
-000174e0: 206c 6174 6572 2061 6e64 2067 6574 2074   later and get t
-000174f0: 6865 0a20 2020 2020 2020 2023 206d 6f73  he.        # mos
-00017500: 742d 7265 6365 6e74 6c79 2d61 6464 6564  t-recently-added
-00017510: 2067 6c79 7068 732e 0a20 2020 2020 2020   glyphs..       
-00017520: 2073 656c 662e 5f72 656e 6465 7265 7273   self._renderers
-00017530: 203d 204f 7264 6572 6564 4469 6374 2829   = OrderedDict()
-00017540: 0a20 2020 2020 2020 2073 656c 662e 5f6c  .        self._l
-00017550: 696e 655f 7265 6e64 6572 6572 7320 3d20  ine_renderers = 
-00017560: 4f72 6465 7265 6444 6963 7428 290a 0a20  OrderedDict().. 
-00017570: 2020 2064 6566 205f 7368 6f75 6c64 5f61     def _should_a
-00017580: 6464 5f6e 6577 5f72 656e 6465 7265 7273  dd_new_renderers
-00017590: 2873 656c 6629 202d 3e20 626f 6f6c 3a0a  (self) -> bool:.
-000175a0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000175b0: 2020 2020 5768 6574 6865 7220 746f 2061      Whether to a
-000175c0: 6464 206e 6577 2072 656e 6465 7265 7273  dd new renderers
-000175d0: 2074 6f20 7468 6520 6368 6172 742e 0a0a   to the chart...
-000175e0: 2020 2020 2020 2020 5768 656e 2061 206e          When a n
-000175f0: 6577 2073 6574 206f 6620 7461 736b 2067  ew set of task g
-00017600: 726f 7570 7320 656e 7465 7273 2074 6865  roups enters the
-00017610: 2073 6368 6564 756c 6572 2077 6527 6420   scheduler we'd 
-00017620: 6c69 6b65 2074 6f20 7374 6172 7420 7265  like to start re
-00017630: 6e64 6572 696e 670a 2020 2020 2020 2020  ndering.        
-00017640: 7468 656d 2e20 4275 7420 6974 2063 616e  them. But it can
-00017650: 2062 6520 6578 7065 6e73 6976 6520 746f   be expensive to
-00017660: 2061 6464 206e 6577 2067 6c79 7073 2c20   add new glyps, 
-00017670: 736f 2077 6520 646f 2069 7420 6465 6c69  so we do it deli
-00017680: 6265 7261 7465 6c79 2c0a 2020 2020 2020  berately,.      
-00017690: 2020 6368 6563 6b69 6e67 2077 6865 7468    checking wheth
-000176a0: 6572 2077 6520 6861 7665 2074 6f20 646f  er we have to do
-000176b0: 2069 7420 616e 6420 7768 6574 6865 7220   it and whether 
-000176c0: 7468 6520 7363 6865 6475 6c65 7220 7365  the scheduler se
-000176d0: 656d 7320 6275 7379 2e0a 2020 2020 2020  ems busy..      
-000176e0: 2020 2222 220a 2020 2020 2020 2020 2320    """.        # 
-000176f0: 416c 7761 7973 2064 7261 7720 6966 2077  Always draw if w
-00017700: 6520 6861 7665 206e 6f74 2062 6566 6f72  e have not befor
-00017710: 650a 2020 2020 2020 2020 6966 206e 6f74  e.        if not
-00017720: 2073 656c 662e 5f6c 6173 745f 6472 6177   self._last_draw
-00017730: 6e3a 0a20 2020 2020 2020 2020 2020 2072  n:.            r
-00017740: 6574 7572 6e20 5472 7565 0a20 2020 2020  eturn True.     
-00017750: 2020 2023 2044 6f6e 2774 2064 7261 7720     # Don't draw 
-00017760: 6966 2074 6865 7265 2068 6176 6520 6265  if there have be
-00017770: 656e 206e 6f20 6e65 7720 7461 736b 7320  en no new tasks 
-00017780: 636f 6d70 6c65 7465 6420 7369 6e63 6520  completed since 
-00017790: 7468 6520 6c61 7374 2075 7064 6174 652c  the last update,
-000177a0: 0a20 2020 2020 2020 2023 206f 7220 6966  .        # or if
-000177b0: 2074 6865 2073 6368 6564 756c 6572 2043   the scheduler C
-000177c0: 5055 2069 7320 6f63 6375 7069 6564 2e0a  PU is occupied..
-000177d0: 2020 2020 2020 2020 6966 2028 0a20 2020          if (.   
-000177e0: 2020 2020 2020 2020 2073 656c 662e 5f6c           self._l
-000177f0: 6173 745f 7472 616e 7369 7469 6f6e 5f63  ast_transition_c
-00017800: 6f75 6e74 203d 3d20 7365 6c66 2e73 6368  ount == self.sch
-00017810: 6564 756c 6572 2e74 7261 6e73 6974 696f  eduler.transitio
-00017820: 6e5f 636f 756e 7465 720a 2020 2020 2020  n_counter.      
-00017830: 2020 2020 2020 6f72 2073 656c 662e 7363        or self.sc
-00017840: 6865 6475 6c65 722e 7072 6f63 2e63 7075  heduler.proc.cpu
-00017850: 5f70 6572 6365 6e74 2829 203e 2035 300a  _percent() > 50.
-00017860: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
-00017870: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
-00017880: 6c73 650a 0a20 2020 2020 2020 2023 204f  lse..        # O
-00017890: 6e6c 7920 7265 7475 726e 2074 7275 6520  nly return true 
-000178a0: 6966 2074 6865 7265 2061 7265 206e 6577  if there are new
-000178b0: 2074 6173 6b20 6772 6f75 7073 2074 6861   task groups tha
-000178c0: 7420 7765 2068 6176 6520 6e6f 7420 7965  t we have not ye
-000178d0: 7420 6164 6465 640a 2020 2020 2020 2020  t added.        
-000178e0: 2320 746f 2074 6865 2043 6f6c 756d 6e44  # to the ColumnD
-000178f0: 6174 6153 6f75 7263 652e 0a20 2020 2020  ataSource..     
-00017900: 2020 2072 6574 7572 6e20 6e6f 7420 7365     return not se
-00017910: 7428 7365 6c66 2e70 6c75 6769 6e2e 636f  t(self.plugin.co
-00017920: 6d70 7574 652e 6b65 7973 2829 2920 3c3d  mpute.keys()) <=
-00017930: 2073 6574 2873 656c 662e 736f 7572 6365   set(self.source
-00017940: 2e64 6174 612e 6b65 7973 2829 290a 0a20  .data.keys()).. 
-00017950: 2020 2064 6566 205f 7368 6f75 6c64 5f75     def _should_u
-00017960: 7064 6174 6528 7365 6c66 2920 2d3e 2062  pdate(self) -> b
-00017970: 6f6f 6c3a 0a20 2020 2020 2020 2022 2222  ool:.        """
-00017980: 0a20 2020 2020 2020 2057 6865 7468 6572  .        Whether
-00017990: 2074 6f20 7570 6461 7465 2074 6865 2043   to update the C
-000179a0: 6f6c 756d 6e44 6174 6153 6f75 7263 652e  olumnDataSource.
-000179b0: 2054 6869 7320 6973 2063 6865 6170 6572   This is cheaper
-000179c0: 2074 6861 6e20 7265 6472 6177 696e 672c   than redrawing,
-000179d0: 0a20 2020 2020 2020 2062 7574 2073 7469  .        but sti
-000179e0: 6c6c 206e 6f74 2066 7265 652c 2073 6f20  ll not free, so 
-000179f0: 7765 2063 6865 636b 2077 6865 7468 6572  we check whether
-00017a00: 2077 6520 6e65 6564 2069 7420 616e 6420   we need it and 
-00017a10: 7768 6574 6865 7220 7468 6520 7363 6865  whether the sche
-00017a20: 7564 6c65 720a 2020 2020 2020 2020 6973  udler.        is
-00017a30: 2062 7573 792e 0a20 2020 2020 2020 2022   busy..        "
-00017a40: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
-00017a50: 6e20 280a 2020 2020 2020 2020 2020 2020  n (.            
-00017a60: 7365 6c66 2e5f 6c61 7374 5f74 7261 6e73  self._last_trans
-00017a70: 6974 696f 6e5f 636f 756e 7420 213d 2073  ition_count != s
-00017a80: 656c 662e 7363 6865 6475 6c65 722e 7472  elf.scheduler.tr
-00017a90: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
-00017aa0: 0a20 2020 2020 2020 2020 2020 2061 6e64  .            and
-00017ab0: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
-00017ac0: 7072 6f63 2e63 7075 5f70 6572 6365 6e74  proc.cpu_percent
-00017ad0: 2829 203c 2035 300a 2020 2020 2020 2020  () < 50.        
-00017ae0: 290a 0a20 2020 2064 6566 205f 6765 745f  )..    def _get_
-00017af0: 7469 6d65 7365 7269 6573 2873 656c 662c  timeseries(self,
-00017b00: 2072 6573 7472 6963 745f 746f 5f65 7869   restrict_to_exi
-00017b10: 7374 696e 673d 4661 6c73 6529 3a0a 2020  sting=False):.  
-00017b20: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00017b30: 2020 5570 6461 7465 2074 6865 2043 6f6c    Update the Col
-00017b40: 756d 6e44 6174 6153 6f75 7263 6520 7769  umnDataSource wi
-00017b50: 7468 206f 7572 2074 696d 6520 7365 7269  th our time seri
-00017b60: 6573 2064 6174 612e 0a0a 2020 2020 2020  es data...      
-00017b70: 2020 7265 7374 7269 6374 5f74 6f5f 6578    restrict_to_ex
-00017b80: 6973 7469 6e67 2064 6574 6572 6d69 6e65  isting determine
-00017b90: 7320 7768 6574 6865 7220 746f 2061 6464  s whether to add
-00017ba0: 206e 6577 2074 6173 6b20 6772 6f75 7073   new task groups
-00017bb0: 0a20 2020 2020 2020 2077 6869 6368 206d  .        which m
-00017bc0: 6967 6874 2068 6176 6520 6265 656e 2061  ight have been a
-00017bd0: 6464 6564 2073 696e 6365 2074 6865 206c  dded since the l
-00017be0: 6173 7420 7469 6d65 2077 6520 7265 6e64  ast time we rend
-00017bf0: 6572 6564 2e0a 2020 2020 2020 2020 5468  ered..        Th
-00017c00: 6973 2069 7320 696d 706f 7274 616e 7420  is is important 
-00017c10: 6173 2077 6520 7761 6e74 2074 6f20 6164  as we want to ad
-00017c20: 6420 6e65 7720 7374 6163 6b65 7273 2076  d new stackers v
-00017c30: 6572 7920 6465 6c69 6265 7261 7465 6c79  ery deliberately
-00017c40: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-00017c50: 2020 2020 2020 2320 4765 7420 7468 6520        # Get the 
-00017c60: 6672 6f6e 742f 6261 636b 2069 6e64 6963  front/back indic
-00017c70: 6573 2066 6f72 206d 6f73 7420 7265 6365  es for most rece
-00017c80: 6e74 206e 7074 7320 6269 6e73 206f 7574  nt npts bins out
-00017c90: 206f 6620 7468 6520 7469 6d65 7365 7269   of the timeseri
-00017ca0: 6573 0a20 2020 2020 2020 2066 726f 6e74  es.        front
-00017cb0: 203d 206d 6178 286c 656e 2873 656c 662e   = max(len(self.
-00017cc0: 706c 7567 696e 2e74 696d 6529 202d 2073  plugin.time) - s
-00017cd0: 656c 662e 6e70 7473 2c20 3029 0a20 2020  elf.npts, 0).   
-00017ce0: 2020 2020 2062 6163 6b20 3d20 4e6f 6e65       back = None
-00017cf0: 0a20 2020 2020 2020 2023 2052 656d 6f76  .        # Remov
-00017d00: 6520 616e 7920 7065 7269 6f64 7320 6f66  e any periods of
-00017d10: 207a 6572 6f20 636f 6d70 7574 6520 6174   zero compute at
-00017d20: 2074 6865 2066 726f 6e74 206f 7220 6261   the front or ba
-00017d30: 636b 206f 6620 7468 6520 7469 6d65 7365  ck of the timese
-00017d40: 7269 6573 0a20 2020 2020 2020 2069 6620  ries.        if 
-00017d50: 6c65 6e28 7365 6c66 2e70 6c75 6769 6e2e  len(self.plugin.
-00017d60: 636f 6d70 7574 6529 3a0a 2020 2020 2020  compute):.      
-00017d70: 2020 2020 2020 6167 6720 3d20 7375 6d28        agg = sum(
-00017d80: 6e70 2e61 7272 6179 2876 5b66 726f 6e74  np.array(v[front
-00017d90: 3a5d 2920 666f 7220 7620 696e 2073 656c  :]) for v in sel
-00017da0: 662e 706c 7567 696e 2e63 6f6d 7075 7465  f.plugin.compute
-00017db0: 2e76 616c 7565 7328 2929 0a20 2020 2020  .values()).     
-00017dc0: 2020 2020 2020 2066 726f 6e74 3220 3d20         front2 = 
-00017dd0: 6c65 6e28 6167 6729 202d 206c 656e 286e  len(agg) - len(n
-00017de0: 702e 7472 696d 5f7a 6572 6f73 2861 6767  p.trim_zeros(agg
-00017df0: 2c20 7472 696d 3d22 6622 2929 0a20 2020  , trim="f")).   
-00017e00: 2020 2020 2020 2020 2066 726f 6e74 202b           front +
-00017e10: 3d20 6672 6f6e 7432 0a20 2020 2020 2020  = front2.       
-00017e20: 2020 2020 2062 6163 6b20 3d20 6c65 6e28       back = len(
-00017e30: 6e70 2e74 7269 6d5f 7a65 726f 7328 6167  np.trim_zeros(ag
-00017e40: 672c 2074 7269 6d3d 2262 2229 2920 2d20  g, trim="b")) - 
-00017e50: 6c65 6e28 6167 6729 206f 7220 4e6f 6e65  len(agg) or None
-00017e60: 0a0a 2020 2020 2020 2020 7072 6570 656e  ..        prepen
-00017e70: 6420 3d20 280a 2020 2020 2020 2020 2020  d = (.          
-00017e80: 2020 7365 6c66 2e70 6c75 6769 6e2e 7469    self.plugin.ti
-00017e90: 6d65 5b66 726f 6e74 202d 2031 5d0a 2020  me[front - 1].  
-00017ea0: 2020 2020 2020 2020 2020 6966 2066 726f            if fro
-00017eb0: 6e74 203e 3d20 310a 2020 2020 2020 2020  nt >= 1.        
-00017ec0: 2020 2020 656c 7365 2073 656c 662e 706c      else self.pl
-00017ed0: 7567 696e 2e74 696d 655b 6672 6f6e 745d  ugin.time[front]
-00017ee0: 202d 2073 656c 662e 706c 7567 696e 2e64   - self.plugin.d
-00017ef0: 740a 2020 2020 2020 2020 290a 2020 2020  t.        ).    
-00017f00: 2020 2020 7469 6d65 7374 616d 7073 203d      timestamps =
-00017f10: 206e 702e 6172 7261 7928 7365 6c66 2e70   np.array(self.p
-00017f20: 6c75 6769 6e2e 7469 6d65 5b66 726f 6e74  lugin.time[front
-00017f30: 3a62 6163 6b5d 290a 2020 2020 2020 2020  :back]).        
-00017f40: 6474 203d 206e 702e 6469 6666 2874 696d  dt = np.diff(tim
-00017f50: 6573 7461 6d70 732c 2070 7265 7065 6e64  estamps, prepend
-00017f60: 3d70 7265 7065 6e64 290a 0a20 2020 2020  =prepend)..     
-00017f70: 2020 2069 6620 7265 7374 7269 6374 5f74     if restrict_t
-00017f80: 6f5f 6578 6973 7469 6e67 3a0a 2020 2020  o_existing:.    
-00017f90: 2020 2020 2020 2020 6e65 775f 6461 7461          new_data
-00017fa0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00017fb0: 2020 2020 206b 3a20 6e70 2e61 7272 6179       k: np.array
-00017fc0: 2876 5b66 726f 6e74 3a62 6163 6b5d 2920  (v[front:back]) 
-00017fd0: 2f20 6474 0a20 2020 2020 2020 2020 2020  / dt.           
-00017fe0: 2020 2020 2066 6f72 206b 2c20 7620 696e       for k, v in
-00017ff0: 2073 656c 662e 706c 7567 696e 2e63 6f6d   self.plugin.com
-00018000: 7075 7465 2e69 7465 6d73 2829 0a20 2020  pute.items().   
-00018010: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00018020: 6b20 696e 2073 656c 662e 736f 7572 6365  k in self.source
-00018030: 2e64 6174 610a 2020 2020 2020 2020 2020  .data.          
-00018040: 2020 7d0a 2020 2020 2020 2020 656c 7365    }.        else
-00018050: 3a0a 2020 2020 2020 2020 2020 2020 6e65  :.            ne
-00018060: 775f 6461 7461 203d 2076 616c 6d61 7028  w_data = valmap(
-00018070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018080: 206c 616d 6264 6120 783a 206e 702e 6172   lambda x: np.ar
-00018090: 7261 7928 785b 6672 6f6e 743a 6261 636b  ray(x[front:back
-000180a0: 5d29 202f 2064 742c 0a20 2020 2020 2020  ]) / dt,.       
-000180b0: 2020 2020 2020 2020 2073 656c 662e 706c           self.pl
-000180c0: 7567 696e 2e63 6f6d 7075 7465 2c0a 2020  ugin.compute,.  
-000180d0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-000180e0: 2020 2020 206e 6577 5f64 6174 615b 2274       new_data["t
-000180f0: 696d 6522 5d20 3d20 280a 2020 2020 2020  ime"] = (.      
-00018100: 2020 2020 2020 7469 6d65 7374 616d 7073        timestamps
-00018110: 202d 2073 656c 662e 5f6f 6666 7365 740a   - self._offset.
-00018120: 2020 2020 2020 2020 2920 2a20 3130 3030          ) * 1000
-00018130: 2e30 2020 2320 626f 6b65 6820 6c69 6b65  .0  # bokeh like
-00018140: 7320 6d69 6c6c 6973 6563 6f6e 6473 0a20  s milliseconds. 
-00018150: 2020 2020 2020 206e 6577 5f64 6174 615b         new_data[
-00018160: 226e 7468 7265 6164 7322 5d20 3d20 6e70  "nthreads"] = np
-00018170: 2e61 7272 6179 2873 656c 662e 706c 7567  .array(self.plug
-00018180: 696e 2e6e 7468 7265 6164 735b 6672 6f6e  in.nthreads[fron
-00018190: 743a 6261 636b 5d29 0a0a 2020 2020 2020  t:back])..      
-000181a0: 2020 7265 7475 726e 206e 6577 5f64 6174    return new_dat
-000181b0: 610a 0a20 2020 2040 7769 7468 6f75 745f  a..    @without_
-000181c0: 7072 6f70 6572 7479 5f76 616c 6964 6174  property_validat
-000181d0: 696f 6e0a 2020 2020 406c 6f67 5f65 7272  ion.    @log_err
-000181e0: 6f72 730a 2020 2020 6465 6620 7570 6461  ors.    def upda
-000181f0: 7465 2873 656c 6629 3a0a 2020 2020 2020  te(self):.      
-00018200: 2020 2222 220a 2020 2020 2020 2020 4d61    """.        Ma
-00018210: 7962 6520 7570 6461 7465 2074 6865 2063  ybe update the c
-00018220: 6861 7274 2e20 5468 6973 2069 7320 736f  hart. This is so
-00018230: 6d65 7768 6174 2065 7870 656e 7369 7665  mewhat expensive
-00018240: 2074 6f20 6472 6177 2c20 736f 2077 6520   to draw, so we 
-00018250: 7570 6461 7465 0a20 2020 2020 2020 2069  update.        i
-00018260: 7420 7072 6574 7479 2064 6566 656e 7369  t pretty defensi
-00018270: 7665 6c79 2e0a 2020 2020 2020 2020 2222  vely..        ""
-00018280: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
-00018290: 662e 5f73 686f 756c 645f 6164 645f 6e65  f._should_add_ne
-000182a0: 775f 7265 6e64 6572 6572 7328 293a 0a20  w_renderers():. 
-000182b0: 2020 2020 2020 2020 2020 2023 2055 7064             # Upd
-000182c0: 6174 6520 7468 6520 6368 6172 742c 2061  ate the chart, a
-000182d0: 6c6c 6f77 696e 6720 666f 7220 6e65 7720  llowing for new 
-000182e0: 7461 736b 2067 726f 7570 7320 746f 2062  task groups to b
-000182f0: 6520 6164 6465 642e 0a20 2020 2020 2020  e added..       
-00018300: 2020 2020 206e 6577 5f64 6174 6120 3d20       new_data = 
-00018310: 7365 6c66 2e5f 6765 745f 7469 6d65 7365  self._get_timese
-00018320: 7269 6573 2872 6573 7472 6963 745f 746f  ries(restrict_to
-00018330: 5f65 7869 7374 696e 673d 4661 6c73 6529  _existing=False)
-00018340: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00018350: 662e 736f 7572 6365 2e64 6174 6120 3d20  f.source.data = 
-00018360: 6e65 775f 6461 7461 0a0a 2020 2020 2020  new_data..      
-00018370: 2020 2020 2020 2320 506f 7373 6962 6c79        # Possibly
-00018380: 2075 7064 6174 6520 7468 6520 7920 7261   update the y ra
-00018390: 6e67 6520 6966 2074 6865 206e 756d 6265  nge if the numbe
-000183a0: 7220 6f66 2074 6872 6561 6473 2068 6173  r of threads has
-000183b0: 2069 6e63 7265 6173 6564 2e0a 2020 2020   increased..    
-000183c0: 2020 2020 2020 2020 6d61 785f 6e74 6872          max_nthr
-000183d0: 6561 6473 203d 206d 6178 2873 656c 662e  eads = max(self.
-000183e0: 706c 7567 696e 2e6e 7468 7265 6164 7329  plugin.nthreads)
-000183f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00018400: 7365 6c66 2e72 6f6f 742e 795f 7261 6e67  self.root.y_rang
-00018410: 652e 656e 6420 213d 206d 6178 5f6e 7468  e.end != max_nth
-00018420: 7265 6164 733a 0a20 2020 2020 2020 2020  reads:.         
-00018430: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-00018440: 2e79 5f72 616e 6765 2e65 6e64 203d 206d  .y_range.end = m
-00018450: 6178 5f6e 7468 7265 6164 730a 0a20 2020  ax_nthreads..   
-00018460: 2020 2020 2020 2020 2073 7461 636b 6572           stacker
-00018470: 7320 3d20 6c69 7374 2873 656c 662e 706c  s = list(self.pl
-00018480: 7567 696e 2e63 6f6d 7075 7465 2e6b 6579  ugin.compute.key
-00018490: 7328 2929 0a20 2020 2020 2020 2020 2020  s()).           
-000184a0: 2063 6f6c 6f72 7320 3d20 5b63 6f6c 6f72   colors = [color
-000184b0: 5f6f 6628 6b65 795f 7370 6c69 7428 6b29  _of(key_split(k)
-000184c0: 2920 666f 7220 6b20 696e 2073 7461 636b  ) for k in stack
-000184d0: 6572 735d 0a0a 2020 2020 2020 2020 2020  ers]..          
-000184e0: 2020 666f 7220 692c 2028 6772 6f75 702c    for i, (group,
-000184f0: 2063 6f6c 6f72 2920 696e 2065 6e75 6d65   color) in enume
-00018500: 7261 7465 287a 6970 2873 7461 636b 6572  rate(zip(stacker
-00018510: 732c 2063 6f6c 6f72 7329 293a 0a20 2020  s, colors)):.   
-00018520: 2020 2020 2020 2020 2020 2020 2023 2049               # I
-00018530: 6620 7765 2068 6176 6520 616c 7265 6164  f we have alread
-00018540: 7920 6472 6177 6e20 7468 6520 6772 6f75  y drawn the grou
-00018550: 702c 2062 7574 2069 7420 6973 2061 6c6c  p, but it is all
-00018560: 207a 6572 6f2c 0a20 2020 2020 2020 2020   zero,.         
-00018570: 2020 2020 2020 2023 2073 6574 2069 7420         # set it 
-00018580: 746f 2062 6520 696e 7669 7369 626c 652e  to be invisible.
-00018590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000185a0: 2069 6620 6772 6f75 7020 696e 2073 656c   if group in sel
-000185b0: 662e 5f72 656e 6465 7265 7273 3a0a 2020  f._renderers:.  
-000185c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000185d0: 2020 6966 206e 6f74 206e 702e 636f 756e    if not np.coun
-000185e0: 745f 6e6f 6e7a 6572 6f28 6e65 775f 6461  t_nonzero(new_da
-000185f0: 7461 5b67 726f 7570 5d29 203e 2030 3a0a  ta[group]) > 0:.
-00018600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018610: 2020 2020 2020 2020 7365 6c66 2e5f 7265          self._re
-00018620: 6e64 6572 6572 735b 6772 6f75 705d 2e76  nderers[group].v
-00018630: 6973 6962 6c65 203d 2046 616c 7365 0a20  isible = False. 
-00018640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018650: 2020 2020 2020 2073 656c 662e 5f6c 696e         self._lin
-00018660: 655f 7265 6e64 6572 6572 735b 6772 6f75  e_renderers[grou
-00018670: 705d 2e76 6973 6962 6c65 203d 2046 616c  p].visible = Fal
-00018680: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-00018690: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000186a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000186b0: 2020 2020 2073 656c 662e 5f72 656e 6465       self._rende
-000186c0: 7265 7273 5b67 726f 7570 5d2e 7669 7369  rers[group].visi
-000186d0: 626c 6520 3d20 5472 7565 0a20 2020 2020  ble = True.     
-000186e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000186f0: 2020 2073 656c 662e 5f6c 696e 655f 7265     self._line_re
-00018700: 6e64 6572 6572 735b 6772 6f75 705d 2e76  nderers[group].v
-00018710: 6973 6962 6c65 203d 2054 7275 650a 0a20  isible = True.. 
-00018720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018730: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
-00018740: 2020 2020 2020 2020 2020 2020 2023 2044               # D
-00018750: 7261 7720 7468 6520 6e65 7720 6172 6561  raw the new area
-00018760: 2061 6e64 206c 696e 6520 676c 7970 6873   and line glyphs
-00018770: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00018780: 2020 7265 6e64 6572 6572 203d 2073 656c    renderer = sel
-00018790: 662e 726f 6f74 2e76 6172 6561 280a 2020  f.root.varea(.  
-000187a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000187b0: 2020 783d 2274 696d 6522 2c0a 2020 2020    x="time",.    
-000187c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000187d0: 7931 3d73 7461 636b 282a 7374 6163 6b65  y1=stack(*stacke
-000187e0: 7273 5b3a 695d 292c 0a20 2020 2020 2020  rs[:i]),.       
-000187f0: 2020 2020 2020 2020 2020 2020 2079 323d               y2=
-00018800: 7374 6163 6b28 2a73 7461 636b 6572 735b  stack(*stackers[
-00018810: 3a20 6920 2b20 315d 292c 0a20 2020 2020  : i + 1]),.     
-00018820: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00018830: 6f6c 6f72 3d63 6f6c 6f72 2c0a 2020 2020  olor=color,.    
-00018840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018850: 616c 7068 613d 302e 352c 0a20 2020 2020  alpha=0.5,.     
-00018860: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00018870: 6f75 7263 653d 7365 6c66 2e73 6f75 7263  ource=self.sourc
-00018880: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00018890: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-000188a0: 2020 2020 2073 656c 662e 5f72 656e 6465       self._rende
-000188b0: 7265 7273 5b67 726f 7570 5d20 3d20 7265  rers[group] = re
-000188c0: 6e64 6572 6572 0a0a 2020 2020 2020 2020  nderer..        
-000188d0: 2020 2020 2020 2020 6c69 6e65 5f72 656e          line_ren
-000188e0: 6465 7265 7220 3d20 7365 6c66 2e72 6f6f  derer = self.roo
-000188f0: 742e 6c69 6e65 280a 2020 2020 2020 2020  t.line(.        
-00018900: 2020 2020 2020 2020 2020 2020 783d 2274              x="t
-00018910: 696d 6522 2c0a 2020 2020 2020 2020 2020  ime",.          
-00018920: 2020 2020 2020 2020 2020 793d 7374 6163            y=stac
-00018930: 6b28 2a73 7461 636b 6572 735b 3a20 6920  k(*stackers[: i 
-00018940: 2b20 315d 292c 0a20 2020 2020 2020 2020  + 1]),.         
-00018950: 2020 2020 2020 2020 2020 2063 6f6c 6f72             color
-00018960: 3d63 6f6c 6f72 2c0a 2020 2020 2020 2020  =color,.        
-00018970: 2020 2020 2020 2020 2020 2020 616c 7068              alph
-00018980: 613d 312e 302c 0a20 2020 2020 2020 2020  a=1.0,.         
-00018990: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
-000189a0: 653d 7365 6c66 2e73 6f75 7263 652c 0a20  e=self.source,. 
-000189b0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-000189c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000189d0: 2073 656c 662e 5f6c 696e 655f 7265 6e64   self._line_rend
-000189e0: 6572 6572 735b 6772 6f75 705d 203d 206c  erers[group] = l
-000189f0: 696e 655f 7265 6e64 6572 6572 0a0a 2020  ine_renderer..  
-00018a00: 2020 2020 2020 2020 2020 2320 446f 6e27            # Don'
-00018a10: 7420 6164 6420 686f 7665 7220 756e 7469  t add hover unti
-00018a20: 6c20 7468 6572 6520 6973 2073 6f6d 6574  l there is somet
-00018a30: 6869 6e67 2074 6f20 7368 6f77 2c20 6173  hing to show, as
-00018a40: 2062 6f6b 6568 6a73 2073 6565 6d73 2074   bokehjs seems t
-00018a50: 6f0a 2020 2020 2020 2020 2020 2020 2320  o.            # 
-00018a60: 6861 7665 2074 726f 7562 6c65 2077 6974  have trouble wit
-00018a70: 6820 6375 7374 6f6d 2068 6f76 6572 7320  h custom hovers 
-00018a80: 7768 656e 2074 6865 7265 2061 7265 206e  when there are n
-00018a90: 6f20 7265 6e64 6572 6572 732e 0a20 2020  o renderers..   
-00018aa0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00018ab0: 2e70 6c75 6769 6e2e 636f 6d70 7574 6520  .plugin.compute 
-00018ac0: 616e 6420 7365 6c66 2e5f 686f 7665 7220  and self._hover 
-00018ad0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00018ae0: 2020 2020 2020 2020 2023 2041 6464 2061           # Add a
-00018af0: 2068 6f76 6572 2074 6861 7420 7769 6c6c   hover that will
-00018b00: 2073 686f 7720 6f63 6375 7061 6e63 7920   show occupancy 
-00018b10: 666f 7220 616c 6c20 6375 7272 656e 746c  for all currentl
-00018b20: 7920 6163 7469 7665 0a20 2020 2020 2020  y active.       
-00018b30: 2020 2020 2020 2020 2023 2074 6173 6b20           # task 
-00018b40: 6772 6f75 7073 2e20 5468 6973 2069 7320  groups. This is 
-00018b50: 6120 6c69 7474 6c65 2074 7269 636b 792c  a little tricky,
-00018b60: 2062 6f6b 6568 2064 6f65 736e 2774 2028   bokeh doesn't (
-00018b70: 7965 7429 2073 7570 706f 7274 0a20 2020  yet) support.   
-00018b80: 2020 2020 2020 2020 2020 2020 2023 2068               # h
-00018b90: 6974 2074 6573 7473 2066 6f72 2073 7461  it tests for sta
-00018ba0: 636b 6564 2061 7265 6120 6368 6172 7473  cked area charts
-00018bb0: 3a20 6874 7470 733a 2f2f 6769 7468 7562  : https://github
-00018bc0: 2e63 6f6d 2f62 6f6b 6568 2f62 6f6b 6568  .com/bokeh/bokeh
-00018bd0: 2f69 7373 7565 732f 3931 3832 0a20 2020  /issues/9182.   
-00018be0: 2020 2020 2020 2020 2020 2020 2023 2049               # I
-00018bf0: 6e73 7465 6164 2c20 7368 6f77 2061 2073  nstead, show a s
-00018c00: 696e 676c 6520 766c 696e 6520 686f 7665  ingle vline hove
-00018c10: 7220 7768 6963 6820 6c69 7374 7320 7468  r which lists th
-00018c20: 6520 6375 7272 656e 746c 7920 6163 7469  e currently acti
-00018c30: 7665 2074 6173 6b0a 2020 2020 2020 2020  ve task.        
-00018c40: 2020 2020 2020 2020 2320 6772 6f75 7073          # groups
-00018c50: 2e20 4120 6375 7374 6f6d 2066 6f72 6d61  . A custom forma
-00018c60: 7474 6572 2069 6e20 4a53 2d6c 616e 6420  tter in JS-land 
-00018c70: 7075 6c6c 7320 7468 6520 7265 6c65 7661  pulls the releva
-00018c80: 6e74 2064 6174 6120 696e 6465 7820 616e  nt data index an
-00018c90: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-00018ca0: 2020 2320 6173 7365 6d62 6c65 7320 7468    # assembles th
-00018cb0: 6520 746f 6f6c 7469 702e 0a20 2020 2020  e tooltip..     
-00018cc0: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
-00018cd0: 7474 6572 203d 2043 7573 746f 6d4a 5348  tter = CustomJSH
-00018ce0: 6f76 6572 2863 6f64 653d 2272 6574 7572  over(code="retur
-00018cf0: 6e20 2727 3b22 290a 2020 2020 2020 2020  n '';").        
-00018d00: 2020 2020 2020 2020 7365 6c66 2e5f 686f          self._ho
-00018d10: 7665 7220 3d20 486f 7665 7254 6f6f 6c28  ver = HoverTool(
-00018d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018d30: 2020 2020 2074 6f6f 6c74 6970 733d 2222       tooltips=""
-00018d40: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00018d50: 2020 2020 2020 2020 2020 3c64 6976 3e0a            <div>.
+00004660: 2020 3c64 6976 3e0a 2020 2020 2020 2020    <div>.        
+00004670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004680: 2020 2020 2020 2020 3c73 7061 6e20 7374          <span st
+00004690: 796c 653d 2266 6f6e 742d 7369 7a65 3a20  yle="font-size: 
+000046a0: 3132 7078 3b20 666f 6e74 2d77 6569 6768  12px; font-weigh
+000046b0: 743a 2062 6f6c 643b 223e 5370 696c 6c65  t: bold;">Spille
+000046c0: 6420 746f 2064 6973 6b3a 3c2f 7370 616e  d to disk:</span
+000046d0: 3e26 6e62 7370 3b0a 2020 2020 2020 2020  >&nbsp;.        
+000046e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000046f0: 2020 2020 2020 2020 3c73 7061 6e20 7374          <span st
+00004700: 796c 653d 2266 6f6e 742d 7369 7a65 3a20  yle="font-size: 
+00004710: 3130 7078 3b20 666f 6e74 2d66 616d 696c  10px; font-famil
+00004720: 793a 204d 6f6e 6163 6f2c 206d 6f6e 6f73  y: Monaco, monos
+00004730: 7061 6365 3b22 3e40 7370 696c 6c65 647b  pace;">@spilled{
+00004740: 302e 3030 2062 7d3c 2f73 7061 6e3e 0a20  0.00 b}</span>. 
+00004750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004760: 2020 2020 2020 2020 2020 203c 2f64 6976             </div
+00004770: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+00004780: 2020 2020 2020 2020 2020 2020 2020 2222                ""
+00004790: 222c 0a20 2020 2020 2020 2029 0a20 2020  ",.        ).   
+000047a0: 2020 2020 2073 656c 662e 726f 6f74 2e61       self.root.a
+000047b0: 6464 5f74 6f6f 6c73 2868 6f76 6572 290a  dd_tools(hover).
+000047c0: 0a20 2020 2040 7769 7468 6f75 745f 7072  .    @without_pr
+000047d0: 6f70 6572 7479 5f76 616c 6964 6174 696f  operty_validatio
+000047e0: 6e0a 2020 2020 406c 6f67 5f65 7272 6f72  n.    @log_error
+000047f0: 730a 2020 2020 6465 6620 7570 6461 7465  s.    def update
+00004800: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00004810: 6465 6620 7175 6164 6c69 7374 2869 3a20  def quadlist(i: 
+00004820: 4974 6572 6162 6c65 5b54 5d29 202d 3e20  Iterable[T]) -> 
+00004830: 6c69 7374 5b54 5d3a 0a20 2020 2020 2020  list[T]:.       
+00004840: 2020 2020 206f 7574 203d 205b 5d0a 2020       out = [].  
+00004850: 2020 2020 2020 2020 2020 666f 7220 6969            for ii
+00004860: 2069 6e20 693a 0a20 2020 2020 2020 2020   in i:.         
+00004870: 2020 2020 2020 206f 7574 202b 3d20 5b69         out += [i
+00004880: 692c 2069 692c 2069 692c 2069 695d 0a20  i, ii, ii, ii]. 
+00004890: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000048a0: 6e20 6f75 740a 0a20 2020 2020 2020 2077  n out..        w
+000048b0: 6f72 6b65 7273 203d 2073 656c 662e 7363  orkers = self.sc
+000048c0: 6865 6475 6c65 722e 776f 726b 6572 732e  heduler.workers.
+000048d0: 7661 6c75 6573 2829 0a0a 2020 2020 2020  values()..      
+000048e0: 2020 7769 6474 6820 3d20 5b5d 0a20 2020    width = [].   
+000048f0: 2020 2020 2078 203d 205b 5d0a 2020 2020       x = [].    
+00004900: 2020 2020 636f 6c6f 7220 3d20 5b5d 0a20      color = []. 
+00004910: 2020 2020 2020 206d 6178 5f6c 696d 6974         max_limit
+00004920: 203d 2030 0a20 2020 2020 2020 2070 726f   = 0.        pro
+00004930: 636d 656d 6f72 7920 3d20 5b5d 0a20 2020  cmemory = [].   
+00004940: 2020 2020 206d 616e 6167 6564 203d 205b       managed = [
+00004950: 5d0a 2020 2020 2020 2020 7370 696c 6c65  ].        spille
+00004960: 6420 3d20 5b5d 0a20 2020 2020 2020 2075  d = [].        u
+00004970: 6e6d 616e 6167 6564 5f6f 6c64 203d 205b  nmanaged_old = [
+00004980: 5d0a 2020 2020 2020 2020 756e 6d61 6e61  ].        unmana
+00004990: 6765 645f 7265 6365 6e74 203d 205b 5d0a  ged_recent = [].
+000049a0: 0a20 2020 2020 2020 2066 6f72 2077 7320  .        for ws 
+000049b0: 696e 2077 6f72 6b65 7273 3a0a 2020 2020  in workers:.    
+000049c0: 2020 2020 2020 2020 6d65 6d69 6e66 6f20          meminfo 
+000049d0: 3d20 7773 2e6d 656d 6f72 790a 2020 2020  = ws.memory.    
+000049e0: 2020 2020 2020 2020 6c69 6d69 7420 3d20          limit = 
+000049f0: 6765 7461 7474 7228 7773 2c20 226d 656d  getattr(ws, "mem
+00004a00: 6f72 795f 6c69 6d69 7422 2c20 3029 0a20  ory_limit", 0). 
+00004a10: 2020 2020 2020 2020 2020 206d 6178 5f6c             max_l
+00004a20: 696d 6974 203d 206d 6178 286d 6178 5f6c  imit = max(max_l
+00004a30: 696d 6974 2c20 6c69 6d69 742c 206d 656d  imit, limit, mem
+00004a40: 696e 666f 2e70 726f 6365 7373 202b 206d  info.process + m
+00004a50: 656d 696e 666f 2e73 7069 6c6c 6564 290a  eminfo.spilled).
+00004a60: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
+00004a70: 725f 6920 3d20 7365 6c66 2e5f 6d65 6d6f  r_i = self._memo
+00004a80: 7279 5f63 6f6c 6f72 286d 656d 696e 666f  ry_color(meminfo
+00004a90: 2e70 726f 6365 7373 2c20 6c69 6d69 742c  .process, limit,
+00004aa0: 2077 732e 7374 6174 7573 290a 0a20 2020   ws.status)..   
+00004ab0: 2020 2020 2020 2020 2077 6964 7468 202b           width +
+00004ac0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+00004ad0: 2020 2020 6d65 6d69 6e66 6f2e 6d61 6e61      meminfo.mana
+00004ae0: 6765 642c 0a20 2020 2020 2020 2020 2020  ged,.           
+00004af0: 2020 2020 206d 656d 696e 666f 2e75 6e6d       meminfo.unm
+00004b00: 616e 6167 6564 5f6f 6c64 2c0a 2020 2020  anaged_old,.    
+00004b10: 2020 2020 2020 2020 2020 2020 6d65 6d69              memi
+00004b20: 6e66 6f2e 756e 6d61 6e61 6765 645f 7265  nfo.unmanaged_re
+00004b30: 6365 6e74 2c0a 2020 2020 2020 2020 2020  cent,.          
+00004b40: 2020 2020 2020 6d65 6d69 6e66 6f2e 7370        meminfo.sp
+00004b50: 696c 6c65 642c 0a20 2020 2020 2020 2020  illed,.         
+00004b60: 2020 205d 0a20 2020 2020 2020 2020 2020     ].           
+00004b70: 2078 202b 3d20 5b73 756d 2877 6964 7468   x += [sum(width
+00004b80: 5b2d 343a 695d 2920 2b20 7769 6474 685b  [-4:i]) + width[
+00004b90: 695d 202f 2032 2066 6f72 2069 2069 6e20  i] / 2 for i in 
+00004ba0: 7261 6e67 6528 2d34 2c20 3029 5d0a 2020  range(-4, 0)].  
+00004bb0: 2020 2020 2020 2020 2020 636f 6c6f 7220            color 
+00004bc0: 2b3d 205b 636f 6c6f 725f 692c 2063 6f6c  += [color_i, col
+00004bd0: 6f72 5f69 2c20 636f 6c6f 725f 692c 2022  or_i, color_i, "
+00004be0: 6772 6579 225d 0a0a 2020 2020 2020 2020  grey"]..        
+00004bf0: 2020 2020 2320 6d65 6d6f 7279 2069 6e66      # memory inf
+00004c00: 6f0a 2020 2020 2020 2020 2020 2020 7072  o.            pr
+00004c10: 6f63 6d65 6d6f 7279 2e61 7070 656e 6428  ocmemory.append(
+00004c20: 6d65 6d69 6e66 6f2e 7072 6f63 6573 7329  meminfo.process)
+00004c30: 0a20 2020 2020 2020 2020 2020 206d 616e  .            man
+00004c40: 6167 6564 2e61 7070 656e 6428 6d65 6d69  aged.append(memi
+00004c50: 6e66 6f2e 6d61 6e61 6765 6429 0a20 2020  nfo.managed).   
+00004c60: 2020 2020 2020 2020 2075 6e6d 616e 6167           unmanag
+00004c70: 6564 5f6f 6c64 2e61 7070 656e 6428 6d65  ed_old.append(me
+00004c80: 6d69 6e66 6f2e 756e 6d61 6e61 6765 645f  minfo.unmanaged_
+00004c90: 6f6c 6429 0a20 2020 2020 2020 2020 2020  old).           
+00004ca0: 2075 6e6d 616e 6167 6564 5f72 6563 656e   unmanaged_recen
+00004cb0: 742e 6170 7065 6e64 286d 656d 696e 666f  t.append(meminfo
+00004cc0: 2e75 6e6d 616e 6167 6564 5f72 6563 656e  .unmanaged_recen
+00004cd0: 7429 0a20 2020 2020 2020 2020 2020 2073  t).            s
+00004ce0: 7069 6c6c 6564 2e61 7070 656e 6428 6d65  pilled.append(me
+00004cf0: 6d69 6e66 6f2e 7370 696c 6c65 6429 0a0a  minfo.spilled)..
+00004d00: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+00004d10: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
+00004d20: 7769 6474 6822 3a20 7769 6474 682c 0a20  width": width,. 
+00004d30: 2020 2020 2020 2020 2020 2022 7822 3a20             "x": 
+00004d40: 782c 0a20 2020 2020 2020 2020 2020 2022  x,.            "
+00004d50: 636f 6c6f 7222 3a20 636f 6c6f 722c 0a20  color": color,. 
+00004d60: 2020 2020 2020 2020 2020 2022 616c 7068             "alph
+00004d70: 6122 3a20 5b31 2c20 302e 372c 2030 2e34  a": [1, 0.7, 0.4
+00004d80: 2c20 315d 202a 206c 656e 2877 6f72 6b65  , 1] * len(worke
+00004d90: 7273 292c 0a20 2020 2020 2020 2020 2020  rs),.           
+00004da0: 2022 776f 726b 6572 223a 2071 7561 646c   "worker": quadl
+00004db0: 6973 7428 7773 2e61 6464 7265 7373 2066  ist(ws.address f
+00004dc0: 6f72 2077 7320 696e 2077 6f72 6b65 7273  or ws in workers
+00004dd0: 292c 0a20 2020 2020 2020 2020 2020 2022  ),.            "
+00004de0: 6573 6361 7065 645f 776f 726b 6572 223a  escaped_worker":
+00004df0: 2071 7561 646c 6973 7428 6573 6361 7065   quadlist(escape
+00004e00: 2e75 726c 5f65 7363 6170 6528 7773 2e61  .url_escape(ws.a
+00004e10: 6464 7265 7373 2920 666f 7220 7773 2069  ddress) for ws i
+00004e20: 6e20 776f 726b 6572 7329 2c0a 2020 2020  n workers),.    
+00004e30: 2020 2020 2020 2020 2279 223a 2071 7561          "y": qua
+00004e40: 646c 6973 7428 7261 6e67 6528 6c65 6e28  dlist(range(len(
+00004e50: 776f 726b 6572 7329 2929 2c0a 2020 2020  workers))),.    
+00004e60: 2020 2020 2020 2020 2270 726f 635f 6d65          "proc_me
+00004e70: 6d6f 7279 223a 2071 7561 646c 6973 7428  mory": quadlist(
+00004e80: 7072 6f63 6d65 6d6f 7279 292c 0a20 2020  procmemory),.   
+00004e90: 2020 2020 2020 2020 2022 6d61 6e61 6765           "manage
+00004ea0: 6422 3a20 7175 6164 6c69 7374 286d 616e  d": quadlist(man
+00004eb0: 6167 6564 292c 0a20 2020 2020 2020 2020  aged),.         
+00004ec0: 2020 2022 756e 6d61 6e61 6765 645f 6f6c     "unmanaged_ol
+00004ed0: 6422 3a20 7175 6164 6c69 7374 2875 6e6d  d": quadlist(unm
+00004ee0: 616e 6167 6564 5f6f 6c64 292c 0a20 2020  anaged_old),.   
+00004ef0: 2020 2020 2020 2020 2022 756e 6d61 6e61           "unmana
+00004f00: 6765 645f 7265 6365 6e74 223a 2071 7561  ged_recent": qua
+00004f10: 646c 6973 7428 756e 6d61 6e61 6765 645f  dlist(unmanaged_
+00004f20: 7265 6365 6e74 292c 0a20 2020 2020 2020  recent),.       
+00004f30: 2020 2020 2022 7370 696c 6c65 6422 3a20       "spilled": 
+00004f40: 7175 6164 6c69 7374 2873 7069 6c6c 6564  quadlist(spilled
+00004f50: 292c 0a20 2020 2020 2020 207d 0a20 2020  ),.        }.   
+00004f60: 2020 2020 2023 2052 656d 6f76 6520 7265       # Remove re
+00004f70: 6374 616e 676c 6573 2077 6974 6820 7769  ctangles with wi
+00004f80: 6474 683d 300a 2020 2020 2020 2020 7265  dth=0.        re
+00004f90: 7375 6c74 203d 207b 6b3a 205b 7669 2066  sult = {k: [vi f
+00004fa0: 6f72 2076 692c 2077 2069 6e20 7a69 7028  or vi, w in zip(
+00004fb0: 762c 2077 6964 7468 2920 6966 2077 5d20  v, width) if w] 
+00004fc0: 666f 7220 6b2c 2076 2069 6e20 7265 7375  for k, v in resu
+00004fd0: 6c74 2e69 7465 6d73 2829 7d0a 0a20 2020  lt.items()}..   
+00004fe0: 2020 2020 2073 656c 662e 726f 6f74 2e78       self.root.x
+00004ff0: 5f72 616e 6765 2e65 6e64 203d 206d 6178  _range.end = max
+00005000: 5f6c 696d 6974 0a20 2020 2020 2020 2075  _limit.        u
+00005010: 7064 6174 6528 7365 6c66 2e73 6f75 7263  pdate(self.sourc
+00005020: 652c 2072 6573 756c 7429 0a0a 0a63 6c61  e, result)...cla
+00005030: 7373 2057 6f72 6b65 7273 4d65 6d6f 7279  ss WorkersMemory
+00005040: 4869 7374 6f67 7261 6d28 4461 7368 626f  Histogram(Dashbo
+00005050: 6172 6443 6f6d 706f 6e65 6e74 293a 0a20  ardComponent):. 
+00005060: 2020 2022 2222 4869 7374 6f67 7261 6d20     """Histogram 
+00005070: 6f66 206d 656d 6f72 7920 7573 6167 652c  of memory usage,
+00005080: 2073 686f 7769 6e67 2068 6f77 206d 616e   showing how man
+00005090: 7920 776f 726b 6572 7320 7468 6572 6520  y workers there 
+000050a0: 6172 6520 696e 2065 6163 6820 6275 636b  are in each buck
+000050b0: 6574 206f 660a 2020 2020 7573 6167 652e  et of.    usage.
+000050c0: 2052 6570 6c61 6365 7320 7468 6520 7065   Replaces the pe
+000050d0: 722d 776f 726b 6572 2067 7261 7068 2077  r-worker graph w
+000050e0: 6865 6e20 7468 6572 6520 6172 6520 3e3d  hen there are >=
+000050f0: 2035 3020 776f 726b 6572 732e 0a20 2020   50 workers..   
+00005100: 2022 2222 0a0a 2020 2020 406c 6f67 5f65   """..    @log_e
+00005110: 7272 6f72 730a 2020 2020 6465 6620 5f5f  rrors.    def __
+00005120: 696e 6974 5f5f 2873 656c 662c 2073 6368  init__(self, sch
+00005130: 6564 756c 6572 2c20 2a2a 6b77 6172 6773  eduler, **kwargs
+00005140: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00005150: 6c61 7374 203d 2030 0a20 2020 2020 2020  last = 0.       
+00005160: 2073 656c 662e 7363 6865 6475 6c65 7220   self.scheduler 
+00005170: 3d20 7363 6865 6475 6c65 720a 2020 2020  = scheduler.    
+00005180: 2020 2020 7365 6c66 2e73 6f75 7263 6520      self.source 
+00005190: 3d20 436f 6c75 6d6e 4461 7461 536f 7572  = ColumnDataSour
+000051a0: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
+000051b0: 7b22 6c65 6674 223a 205b 312c 2032 5d2c  {"left": [1, 2],
+000051c0: 2022 7269 6768 7422 3a20 5b31 302c 2031   "right": [10, 1
+000051d0: 305d 2c20 2274 6f70 223a 205b 302c 2030  0], "top": [0, 0
+000051e0: 5d7d 0a20 2020 2020 2020 2029 0a0a 2020  ]}.        )..  
+000051f0: 2020 2020 2020 7365 6c66 2e72 6f6f 7420        self.root 
+00005200: 3d20 6669 6775 7265 280a 2020 2020 2020  = figure(.      
+00005210: 2020 2020 2020 7469 746c 653d 2242 7974        title="Byt
+00005220: 6573 2073 746f 7265 6420 7065 7220 776f  es stored per wo
+00005230: 726b 6572 222c 0a20 2020 2020 2020 2020  rker",.         
+00005240: 2020 206e 616d 653d 2277 6f72 6b65 7273     name="workers
+00005250: 5f6d 656d 6f72 7922 2c0a 2020 2020 2020  _memory",.      
+00005260: 2020 2020 2020 795f 6178 6973 5f6c 6162        y_axis_lab
+00005270: 656c 3d22 6672 6571 7565 6e63 7922 2c0a  el="frequency",.
+00005280: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
+00005290: 733d 2222 2c0a 2020 2020 2020 2020 2020  s="",.          
+000052a0: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
+000052b0: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
+000052c0: 656c 662e 726f 6f74 2e78 6178 6973 5b30  elf.root.xaxis[0
+000052d0: 5d2e 666f 726d 6174 7465 7220 3d20 4e75  ].formatter = Nu
+000052e0: 6d65 7261 6c54 6963 6b46 6f72 6d61 7474  meralTickFormatt
+000052f0: 6572 2866 6f72 6d61 743d 2230 2e30 2062  er(format="0.0 b
+00005300: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
+00005310: 726f 6f74 2e78 6178 6973 2e74 6963 6b65  root.xaxis.ticke
+00005320: 7220 3d20 4164 6170 7469 7665 5469 636b  r = AdaptiveTick
+00005330: 6572 282a 2a54 4943 4b53 5f31 3032 3429  er(**TICKS_1024)
+00005340: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+00005350: 6f74 2e78 6178 6973 2e6d 616a 6f72 5f6c  ot.xaxis.major_l
+00005360: 6162 656c 5f6f 7269 656e 7461 7469 6f6e  abel_orientation
+00005370: 203d 2058 4c41 4245 4c5f 4f52 4945 4e54   = XLABEL_ORIENT
+00005380: 4154 494f 4e0a 0a20 2020 2020 2020 2073  ATION..        s
+00005390: 656c 662e 726f 6f74 2e78 6178 6973 2e6d  elf.root.xaxis.m
+000053a0: 696e 6f72 5f74 6963 6b5f 6c69 6e65 5f61  inor_tick_line_a
+000053b0: 6c70 6861 203d 2030 0a20 2020 2020 2020  lpha = 0.       
+000053c0: 2073 656c 662e 726f 6f74 2e79 6772 6964   self.root.ygrid
+000053d0: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
+000053e0: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
+000053f0: 6f6f 742e 746f 6f6c 6261 725f 6c6f 6361  oot.toolbar_loca
+00005400: 7469 6f6e 203d 204e 6f6e 650a 0a20 2020  tion = None..   
+00005410: 2020 2020 2073 656c 662e 726f 6f74 2e71       self.root.q
+00005420: 7561 6428 0a20 2020 2020 2020 2020 2020  uad(.           
+00005430: 2073 6f75 7263 653d 7365 6c66 2e73 6f75   source=self.sou
+00005440: 7263 652c 0a20 2020 2020 2020 2020 2020  rce,.           
+00005450: 206c 6566 743d 226c 6566 7422 2c0a 2020   left="left",.  
+00005460: 2020 2020 2020 2020 2020 7269 6768 743d            right=
+00005470: 2272 6967 6874 222c 0a20 2020 2020 2020  "right",.       
+00005480: 2020 2020 2062 6f74 746f 6d3d 302c 0a20       bottom=0,. 
+00005490: 2020 2020 2020 2020 2020 2074 6f70 3d22             top="
+000054a0: 746f 7022 2c0a 2020 2020 2020 2020 2020  top",.          
+000054b0: 2020 636f 6c6f 723d 2264 6565 7073 6b79    color="deepsky
+000054c0: 626c 7565 222c 0a20 2020 2020 2020 2020  blue",.         
+000054d0: 2020 2066 696c 6c5f 616c 7068 613d 302e     fill_alpha=0.
+000054e0: 352c 0a20 2020 2020 2020 2029 0a0a 2020  5,.        )..  
+000054f0: 2020 4077 6974 686f 7574 5f70 726f 7065    @without_prope
+00005500: 7274 795f 7661 6c69 6461 7469 6f6e 0a20  rty_validation. 
+00005510: 2020 2064 6566 2075 7064 6174 6528 7365     def update(se
+00005520: 6c66 293a 0a20 2020 2020 2020 206e 6279  lf):.        nby
+00005530: 7465 7320 3d20 6e70 2e61 7361 7272 6179  tes = np.asarray
+00005540: 280a 2020 2020 2020 2020 2020 2020 5b77  (.            [w
+00005550: 732e 6d65 7472 6963 735b 226d 656d 6f72  s.metrics["memor
+00005560: 7922 5d20 666f 7220 7773 2069 6e20 7365  y"] for ws in se
+00005570: 6c66 2e73 6368 6564 756c 6572 2e77 6f72  lf.scheduler.wor
+00005580: 6b65 7273 2e76 616c 7565 7328 295d 0a20  kers.values()]. 
+00005590: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000055a0: 2063 6f75 6e74 732c 2078 203d 206e 702e   counts, x = np.
+000055b0: 6869 7374 6f67 7261 6d28 6e62 7974 6573  histogram(nbytes
+000055c0: 2c20 6269 6e73 3d34 3029 0a20 2020 2020  , bins=40).     
+000055d0: 2020 2064 203d 207b 226c 6566 7422 3a20     d = {"left": 
+000055e0: 785b 3a2d 315d 2c20 2272 6967 6874 223a  x[:-1], "right":
+000055f0: 2078 5b31 3a5d 2c20 2274 6f70 223a 2063   x[1:], "top": c
+00005600: 6f75 6e74 737d 0a20 2020 2020 2020 2075  ounts}.        u
+00005610: 7064 6174 6528 7365 6c66 2e73 6f75 7263  pdate(self.sourc
+00005620: 652c 2064 290a 0a0a 636c 6173 7320 576f  e, d)...class Wo
+00005630: 726b 6572 7354 7261 6e73 6665 7242 7974  rkersTransferByt
+00005640: 6573 2844 6173 6862 6f61 7264 436f 6d70  es(DashboardComp
+00005650: 6f6e 656e 7429 3a0a 2020 2020 2222 2253  onent):.    """S
+00005660: 697a 6520 6f66 206f 7065 6e20 6461 7461  ize of open data
+00005670: 2074 7261 6e73 6665 7273 2066 726f 6d2f   transfers from/
+00005680: 746f 206f 7468 6572 2077 6f72 6b65 7273  to other workers
+00005690: 2070 6572 2077 6f72 6b65 7222 2222 0a0a   per worker"""..
+000056a0: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
+000056b0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+000056c0: 2873 656c 662c 2073 6368 6564 756c 6572  (self, scheduler
+000056d0: 2c20 7769 6474 683d 3630 302c 202a 2a6b  , width=600, **k
+000056e0: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+000056f0: 7365 6c66 2e73 6368 6564 756c 6572 203d  self.scheduler =
+00005700: 2073 6368 6564 756c 6572 0a20 2020 2020   scheduler.     
+00005710: 2020 2073 656c 662e 736f 7572 6365 203d     self.source =
+00005720: 2043 6f6c 756d 6e44 6174 6153 6f75 7263   ColumnDataSourc
+00005730: 6528 0a20 2020 2020 2020 2020 2020 207b  e(.            {
+00005740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005750: 2022 6573 6361 7065 645f 776f 726b 6572   "escaped_worker
+00005760: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00005770: 2020 2020 2020 2022 7472 616e 7366 6572         "transfer
+00005780: 5f69 6e63 6f6d 696e 675f 6279 7465 7322  _incoming_bytes"
+00005790: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+000057a0: 2020 2020 2020 2274 7261 6e73 6665 725f        "transfer_
+000057b0: 6f75 7467 6f69 6e67 5f62 7974 6573 223a  outgoing_bytes":
+000057c0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+000057d0: 2020 2020 2022 776f 726b 6572 223a 205b       "worker": [
+000057e0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+000057f0: 2020 2022 795f 696e 636f 6d69 6e67 223a     "y_incoming":
+00005800: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+00005810: 2020 2020 2022 795f 6f75 7467 6f69 6e67       "y_outgoing
+00005820: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00005830: 2020 207d 0a20 2020 2020 2020 2029 0a0a     }.        )..
+00005840: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+00005850: 7420 3d20 6669 6775 7265 280a 2020 2020  t = figure(.    
+00005860: 2020 2020 2020 2020 7469 746c 653d 6622          title=f"
+00005870: 4279 7465 7320 7472 616e 7366 6572 7269  Bytes transferri
+00005880: 6e67 3a20 7b66 6f72 6d61 745f 6279 7465  ng: {format_byte
+00005890: 7328 3029 7d22 2c0a 2020 2020 2020 2020  s(0)}",.        
+000058a0: 2020 2020 746f 6f6c 733d 2222 2c0a 2020      tools="",.  
+000058b0: 2020 2020 2020 2020 2020 7769 6474 683d            width=
+000058c0: 696e 7428 7769 6474 6820 2f20 3229 2c0a  int(width / 2),.
+000058d0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+000058e0: 3d22 776f 726b 6572 735f 7472 616e 7366  ="workers_transf
+000058f0: 6572 5f62 7974 6573 222c 0a20 2020 2020  er_bytes",.     
+00005900: 2020 2020 2020 206d 696e 5f62 6f72 6465         min_borde
+00005910: 725f 626f 7474 6f6d 3d35 302c 0a20 2020  r_bottom=50,.   
+00005920: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
+00005930: 732c 0a20 2020 2020 2020 2029 0a0a 2020  s,.        )..  
+00005940: 2020 2020 2020 2320 7472 616e 7366 6572        # transfer
+00005950: 5f69 6e63 6f6d 696e 675f 6279 7465 730a  _incoming_bytes.
+00005960: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+00005970: 742e 6862 6172 280a 2020 2020 2020 2020  t.hbar(.        
+00005980: 2020 2020 6e61 6d65 3d22 7472 616e 7366      name="transf
+00005990: 6572 5f69 6e63 6f6d 696e 675f 6279 7465  er_incoming_byte
+000059a0: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
+000059b0: 793d 2279 5f69 6e63 6f6d 696e 6722 2c0a  y="y_incoming",.
+000059c0: 2020 2020 2020 2020 2020 2020 7269 6768              righ
+000059d0: 743d 2274 7261 6e73 6665 725f 696e 636f  t="transfer_inco
+000059e0: 6d69 6e67 5f62 7974 6573 222c 0a20 2020  ming_bytes",.   
+000059f0: 2020 2020 2020 2020 206c 696e 655f 636f           line_co
+00005a00: 6c6f 723d 4e6f 6e65 2c0a 2020 2020 2020  lor=None,.      
+00005a10: 2020 2020 2020 6c65 6674 3d30 2c0a 2020        left=0,.  
+00005a20: 2020 2020 2020 2020 2020 6865 6967 6874            height
+00005a30: 3d30 2e35 2c0a 2020 2020 2020 2020 2020  =0.5,.          
+00005a40: 2020 6669 6c6c 5f63 6f6c 6f72 3d22 7265    fill_color="re
+00005a50: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
+00005a60: 736f 7572 6365 3d73 656c 662e 736f 7572  source=self.sour
+00005a70: 6365 2c0a 2020 2020 2020 2020 290a 0a20  ce,.        ).. 
+00005a80: 2020 2020 2020 2023 2074 7261 6e73 6665         # transfe
+00005a90: 725f 6f75 7467 6f69 6e67 5f62 7974 6573  r_outgoing_bytes
+00005aa0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+00005ab0: 6f74 2e68 6261 7228 0a20 2020 2020 2020  ot.hbar(.       
+00005ac0: 2020 2020 206e 616d 653d 2274 7261 6e73       name="trans
+00005ad0: 6665 725f 6f75 7467 6f69 6e67 5f62 7974  fer_outgoing_byt
+00005ae0: 6573 222c 0a20 2020 2020 2020 2020 2020  es",.           
+00005af0: 2079 3d22 795f 6f75 7467 6f69 6e67 222c   y="y_outgoing",
+00005b00: 0a20 2020 2020 2020 2020 2020 2072 6967  .            rig
+00005b10: 6874 3d22 7472 616e 7366 6572 5f6f 7574  ht="transfer_out
+00005b20: 676f 696e 675f 6279 7465 7322 2c0a 2020  going_bytes",.  
+00005b30: 2020 2020 2020 2020 2020 6c69 6e65 5f63            line_c
+00005b40: 6f6c 6f72 3d4e 6f6e 652c 0a20 2020 2020  olor=None,.     
+00005b50: 2020 2020 2020 206c 6566 743d 302c 0a20         left=0,. 
+00005b60: 2020 2020 2020 2020 2020 2068 6569 6768             heigh
+00005b70: 743d 302e 352c 0a20 2020 2020 2020 2020  t=0.5,.         
+00005b80: 2020 2066 696c 6c5f 636f 6c6f 723d 2262     fill_color="b
+00005b90: 6c75 6522 2c0a 2020 2020 2020 2020 2020  lue",.          
+00005ba0: 2020 736f 7572 6365 3d73 656c 662e 736f    source=self.so
+00005bb0: 7572 6365 2c0a 2020 2020 2020 2020 290a  urce,.        ).
+00005bc0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+00005bd0: 6f74 2e61 7869 735b 305d 2e74 6963 6b65  ot.axis[0].ticke
+00005be0: 7220 3d20 4261 7369 6354 6963 6b65 7228  r = BasicTicker(
+00005bf0: 2a2a 5449 434b 535f 3130 3234 290a 2020  **TICKS_1024).  
+00005c00: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+00005c10: 7861 7869 735b 305d 2e66 6f72 6d61 7474  xaxis[0].formatt
+00005c20: 6572 203d 204e 756d 6572 616c 5469 636b  er = NumeralTick
+00005c30: 466f 726d 6174 7465 7228 666f 726d 6174  Formatter(format
+00005c40: 3d22 302e 3020 6222 290a 2020 2020 2020  ="0.0 b").      
+00005c50: 2020 7365 6c66 2e72 6f6f 742e 7861 7869    self.root.xaxi
+00005c60: 732e 6d61 6a6f 725f 6c61 6265 6c5f 6f72  s.major_label_or
+00005c70: 6965 6e74 6174 696f 6e20 3d20 584c 4142  ientation = XLAB
+00005c80: 454c 5f4f 5249 454e 5441 5449 4f4e 0a20  EL_ORIENTATION. 
+00005c90: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+00005ca0: 2e78 6178 6973 2e6d 696e 6f72 5f74 6963  .xaxis.minor_tic
+00005cb0: 6b5f 6c69 6e65 5f61 6c70 6861 203d 2030  k_line_alpha = 0
+00005cc0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+00005cd0: 6f74 2e78 5f72 616e 6765 203d 2052 616e  ot.x_range = Ran
+00005ce0: 6765 3164 2873 7461 7274 3d30 290a 2020  ge1d(start=0).  
+00005cf0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+00005d00: 7961 7869 732e 7669 7369 626c 6520 3d20  yaxis.visible = 
+00005d10: 4661 6c73 650a 2020 2020 2020 2020 7365  False.        se
+00005d20: 6c66 2e72 6f6f 742e 7967 7269 642e 7669  lf.root.ygrid.vi
+00005d30: 7369 626c 6520 3d20 4661 6c73 650a 2020  sible = False.  
+00005d40: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+00005d50: 746f 6f6c 6261 725f 6c6f 6361 7469 6f6e  toolbar_location
+00005d60: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
+00005d70: 2074 6170 203d 2054 6170 546f 6f6c 2863   tap = TapTool(c
+00005d80: 616c 6c62 6163 6b3d 4f70 656e 5552 4c28  allback=OpenURL(
+00005d90: 7572 6c3d 222e 2f69 6e66 6f2f 776f 726b  url="./info/work
+00005da0: 6572 2f40 6573 6361 7065 645f 776f 726b  er/@escaped_work
+00005db0: 6572 2e68 746d 6c22 2929 0a20 2020 2020  er.html")).     
+00005dc0: 2020 2068 6f76 6572 203d 2048 6f76 6572     hover = Hover
+00005dd0: 546f 6f6c 280a 2020 2020 2020 2020 2020  Tool(.          
+00005de0: 2020 746f 6f6c 7469 7073 3d5b 0a20 2020    tooltips=[.   
+00005df0: 2020 2020 2020 2020 2020 2020 2028 2257               ("W
+00005e00: 6f72 6b65 7222 2c20 2240 776f 726b 6572  orker", "@worker
+00005e10: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+00005e20: 2020 2020 2822 496e 636f 6d69 6e67 222c      ("Incoming",
+00005e30: 2022 4074 7261 6e73 6665 725f 696e 636f   "@transfer_inco
+00005e40: 6d69 6e67 5f62 7974 6573 7b30 2e30 3020  ming_bytes{0.00 
+00005e50: 627d 2229 2c0a 2020 2020 2020 2020 2020  b}"),.          
+00005e60: 2020 2020 2020 2822 4f75 7467 6f69 6e67        ("Outgoing
+00005e70: 222c 2022 4074 7261 6e73 6665 725f 6f75  ", "@transfer_ou
+00005e80: 7467 6f69 6e67 5f62 7974 6573 7b30 2e30  tgoing_bytes{0.0
+00005e90: 3020 627d 2229 2c0a 2020 2020 2020 2020  0 b}"),.        
+00005ea0: 2020 2020 5d2c 0a20 2020 2020 2020 2020      ],.         
+00005eb0: 2020 2070 6f69 6e74 5f70 6f6c 6963 793d     point_policy=
+00005ec0: 2266 6f6c 6c6f 775f 6d6f 7573 6522 2c0a  "follow_mouse",.
+00005ed0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00005ee0: 2020 7365 6c66 2e72 6f6f 742e 6164 645f    self.root.add_
+00005ef0: 746f 6f6c 7328 686f 7665 722c 2074 6170  tools(hover, tap
+00005f00: 290a 0a20 2020 2040 7769 7468 6f75 745f  )..    @without_
+00005f10: 7072 6f70 6572 7479 5f76 616c 6964 6174  property_validat
+00005f20: 696f 6e0a 2020 2020 406c 6f67 5f65 7272  ion.    @log_err
+00005f30: 6f72 730a 2020 2020 6465 6620 7570 6461  ors.    def upda
+00005f40: 7465 2873 656c 6629 3a0a 2020 2020 2020  te(self):.      
+00005f50: 2020 7773 7320 3d20 7365 6c66 2e73 6368    wss = self.sch
+00005f60: 6564 756c 6572 2e77 6f72 6b65 7273 2e76  eduler.workers.v
+00005f70: 616c 7565 7328 290a 0a20 2020 2020 2020  alues()..       
+00005f80: 2068 203d 2030 2e31 0a20 2020 2020 2020   h = 0.1.       
+00005f90: 2079 5f69 6e63 6f6d 696e 6720 3d20 5b69   y_incoming = [i
+00005fa0: 202b 2030 2e37 3520 2b20 6920 2a20 6820   + 0.75 + i * h 
+00005fb0: 666f 7220 6920 696e 2072 616e 6765 286c  for i in range(l
+00005fc0: 656e 2877 7373 2929 5d0a 2020 2020 2020  en(wss))].      
+00005fd0: 2020 795f 6f75 7467 6f69 6e67 203d 205b    y_outgoing = [
+00005fe0: 6920 2b20 302e 3235 202b 2069 202a 2068  i + 0.25 + i * h
+00005ff0: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+00006000: 6c65 6e28 7773 7329 295d 0a0a 2020 2020  len(wss))]..    
+00006010: 2020 2020 7472 616e 7366 6572 5f69 6e63      transfer_inc
+00006020: 6f6d 696e 675f 6279 7465 7320 3d20 5b0a  oming_bytes = [.
+00006030: 2020 2020 2020 2020 2020 2020 7773 2e6d              ws.m
+00006040: 6574 7269 6373 5b22 7472 616e 7366 6572  etrics["transfer
+00006050: 225d 5b22 696e 636f 6d69 6e67 5f62 7974  "]["incoming_byt
+00006060: 6573 225d 2066 6f72 2077 7320 696e 2077  es"] for ws in w
+00006070: 7373 0a20 2020 2020 2020 205d 0a20 2020  ss.        ].   
+00006080: 2020 2020 2074 7261 6e73 6665 725f 6f75       transfer_ou
+00006090: 7467 6f69 6e67 5f62 7974 6573 203d 205b  tgoing_bytes = [
+000060a0: 0a20 2020 2020 2020 2020 2020 2077 732e  .            ws.
+000060b0: 6d65 7472 6963 735b 2274 7261 6e73 6665  metrics["transfe
+000060c0: 7222 5d5b 226f 7574 676f 696e 675f 6279  r"]["outgoing_by
+000060d0: 7465 7322 5d20 666f 7220 7773 2069 6e20  tes"] for ws in 
+000060e0: 7773 730a 2020 2020 2020 2020 5d0a 2020  wss.        ].  
+000060f0: 2020 2020 2020 776f 726b 6572 7320 3d20        workers = 
+00006100: 5b77 732e 6164 6472 6573 7320 666f 7220  [ws.address for 
+00006110: 7773 2069 6e20 7773 735d 0a20 2020 2020  ws in wss].     
+00006120: 2020 2065 7363 6170 6564 5f77 6f72 6b65     escaped_worke
+00006130: 7273 203d 205b 6573 6361 7065 2e75 726c  rs = [escape.url
+00006140: 5f65 7363 6170 6528 776f 726b 6572 2920  _escape(worker) 
+00006150: 666f 7220 776f 726b 6572 2069 6e20 776f  for worker in wo
+00006160: 726b 6572 735d 0a0a 2020 2020 2020 2020  rkers]..        
+00006170: 6966 2077 7373 3a0a 2020 2020 2020 2020  if wss:.        
+00006180: 2020 2020 785f 6c69 6d69 7420 3d20 6d61      x_limit = ma
+00006190: 7828 0a20 2020 2020 2020 2020 2020 2020  x(.             
+000061a0: 2020 206d 6178 2874 7261 6e73 6665 725f     max(transfer_
+000061b0: 696e 636f 6d69 6e67 5f62 7974 6573 292c  incoming_bytes),
+000061c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000061d0: 206d 6178 2874 7261 6e73 6665 725f 6f75   max(transfer_ou
+000061e0: 7467 6f69 6e67 5f62 7974 6573 292c 0a20  tgoing_bytes),. 
+000061f0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00006200: 6178 2877 732e 6d65 6d6f 7279 5f6c 696d  ax(ws.memory_lim
+00006210: 6974 2066 6f72 2077 7320 696e 2077 7373  it for ws in wss
+00006220: 292c 0a20 2020 2020 2020 2020 2020 2029  ),.            )
+00006230: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00006240: 2020 2020 2020 2020 2020 2078 5f6c 696d             x_lim
+00006250: 6974 203d 2030 0a20 2020 2020 2020 2073  it = 0.        s
+00006260: 656c 662e 726f 6f74 2e78 5f72 616e 6765  elf.root.x_range
+00006270: 2e65 6e64 203d 2078 5f6c 696d 6974 0a0a  .end = x_limit..
+00006280: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+00006290: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
+000062a0: 6573 6361 7065 645f 776f 726b 6572 223a  escaped_worker":
+000062b0: 2065 7363 6170 6564 5f77 6f72 6b65 7273   escaped_workers
+000062c0: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
+000062d0: 7261 6e73 6665 725f 696e 636f 6d69 6e67  ransfer_incoming
+000062e0: 5f62 7974 6573 223a 2074 7261 6e73 6665  _bytes": transfe
+000062f0: 725f 696e 636f 6d69 6e67 5f62 7974 6573  r_incoming_bytes
+00006300: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
+00006310: 7261 6e73 6665 725f 6f75 7467 6f69 6e67  ransfer_outgoing
+00006320: 5f62 7974 6573 223a 2074 7261 6e73 6665  _bytes": transfe
+00006330: 725f 6f75 7467 6f69 6e67 5f62 7974 6573  r_outgoing_bytes
+00006340: 2c0a 2020 2020 2020 2020 2020 2020 2277  ,.            "w
+00006350: 6f72 6b65 7222 3a20 776f 726b 6572 732c  orker": workers,
+00006360: 0a20 2020 2020 2020 2020 2020 2022 795f  .            "y_
+00006370: 696e 636f 6d69 6e67 223a 2079 5f69 6e63  incoming": y_inc
+00006380: 6f6d 696e 672c 0a20 2020 2020 2020 2020  oming,.         
+00006390: 2020 2022 795f 6f75 7467 6f69 6e67 223a     "y_outgoing":
+000063a0: 2079 5f6f 7574 676f 696e 672c 0a20 2020   y_outgoing,.   
+000063b0: 2020 2020 207d 0a20 2020 2020 2020 2073       }.        s
+000063c0: 656c 662e 726f 6f74 2e74 6974 6c65 2e74  elf.root.title.t
+000063d0: 6578 7420 3d20 280a 2020 2020 2020 2020  ext = (.        
+000063e0: 2020 2020 6622 4279 7465 7320 7472 616e      f"Bytes tran
+000063f0: 7366 6572 7269 6e67 3a20 7b66 6f72 6d61  sferring: {forma
+00006400: 745f 6279 7465 7328 7375 6d28 7472 616e  t_bytes(sum(tran
+00006410: 7366 6572 5f69 6e63 6f6d 696e 675f 6279  sfer_incoming_by
+00006420: 7465 7329 297d 220a 2020 2020 2020 2020  tes))}".        
+00006430: 290a 2020 2020 2020 2020 7570 6461 7465  ).        update
+00006440: 2873 656c 662e 736f 7572 6365 2c20 7265  (self.source, re
+00006450: 7375 6c74 290a 0a0a 636c 6173 7320 4861  sult)...class Ha
+00006460: 7264 7761 7265 2844 6173 6862 6f61 7264  rdware(Dashboard
+00006470: 436f 6d70 6f6e 656e 7429 3a0a 2020 2020  Component):.    
+00006480: 2222 224f 6363 7570 616e 6379 2028 696e  """Occupancy (in
+00006490: 2074 696d 6529 2070 6572 2077 6f72 6b65   time) per worke
+000064a0: 7222 2222 0a0a 2020 2020 406c 6f67 5f65  r"""..    @log_e
+000064b0: 7272 6f72 730a 2020 2020 6465 6620 5f5f  rrors.    def __
+000064c0: 696e 6974 5f5f 2873 656c 662c 2073 6368  init__(self, sch
+000064d0: 6564 756c 6572 2c20 2a2a 6b77 6172 6773  eduler, **kwargs
+000064e0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+000064f0: 7363 6865 6475 6c65 7220 3d20 7363 6865  scheduler = sche
+00006500: 6475 6c65 720a 2020 2020 2020 2020 2320  duler.        # 
+00006510: 4469 736b 0a20 2020 2020 2020 2073 656c  Disk.        sel
+00006520: 662e 6469 736b 5f73 6f75 7263 6520 3d20  f.disk_source = 
+00006530: 436f 6c75 6d6e 4461 7461 536f 7572 6365  ColumnDataSource
+00006540: 280a 2020 2020 2020 2020 2020 2020 7b0a  (.            {.
+00006550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006560: 2273 697a 6522 3a20 5b5d 2c0a 2020 2020  "size": [],.    
+00006570: 2020 2020 2020 2020 2020 2020 2262 616e              "ban
+00006580: 6477 6964 7468 223a 205b 5d2c 0a20 2020  dwidth": [],.   
+00006590: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+000065a0: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
+000065b0: 6c66 2e64 6973 6b5f 6669 6775 7265 203d  lf.disk_figure =
+000065c0: 2066 6967 7572 6528 0a20 2020 2020 2020   figure(.       
+000065d0: 2020 2020 2074 6974 6c65 3d22 4469 736b       title="Disk
+000065e0: 2042 616e 6477 6964 7468 202d 2d20 436f   Bandwidth -- Co
+000065f0: 6d70 7574 696e 6720 2e2e 2e22 2c0a 2020  mputing ...",.  
+00006600: 2020 2020 2020 2020 2020 746f 6f6c 733d            tools=
+00006610: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
+00006620: 746f 6f6c 6261 725f 6c6f 6361 7469 6f6e  toolbar_location
+00006630: 3d22 6162 6f76 6522 2c0a 2020 2020 2020  ="above",.      
+00006640: 2020 2020 2020 785f 7261 6e67 653d 4661        x_range=Fa
+00006650: 6374 6f72 5261 6e67 6528 6661 6374 6f72  ctorRange(factor
+00006660: 733d 5b5d 292c 0a20 2020 2020 2020 2020  s=[]),.         
+00006670: 2020 202a 2a6b 7761 7267 732c 0a20 2020     **kwargs,.   
+00006680: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+00006690: 656c 662e 6469 736b 5f66 6967 7572 652e  elf.disk_figure.
+000066a0: 7662 6172 280a 2020 2020 2020 2020 2020  vbar(.          
+000066b0: 2020 783d 2273 697a 6522 2c20 746f 703d    x="size", top=
+000066c0: 2262 616e 6477 6964 7468 222c 2077 6964  "bandwidth", wid
+000066d0: 7468 3d30 2e39 2c20 736f 7572 6365 3d73  th=0.9, source=s
+000066e0: 656c 662e 6469 736b 5f73 6f75 7263 650a  elf.disk_source.
+000066f0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00006700: 2020 686f 7665 7220 3d20 486f 7665 7254    hover = HoverT
+00006710: 6f6f 6c28 0a20 2020 2020 2020 2020 2020  ool(.           
+00006720: 206d 6f64 653d 2276 6c69 6e65 222c 2074   mode="vline", t
+00006730: 6f6f 6c74 6970 733d 5b28 2242 616e 6477  ooltips=[("Bandw
+00006740: 6964 7468 222c 2022 4062 616e 6477 6964  idth", "@bandwid
+00006750: 7468 7b30 2e30 3020 627d 2f73 2229 5d0a  th{0.00 b}/s")].
+00006760: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00006770: 2020 7365 6c66 2e64 6973 6b5f 6669 6775    self.disk_figu
+00006780: 7265 2e61 6464 5f74 6f6f 6c73 2868 6f76  re.add_tools(hov
+00006790: 6572 290a 2020 2020 2020 2020 7365 6c66  er).        self
+000067a0: 2e64 6973 6b5f 6669 6775 7265 2e79 6178  .disk_figure.yax
+000067b0: 6973 5b30 5d2e 666f 726d 6174 7465 7220  is[0].formatter 
+000067c0: 3d20 4e75 6d65 7261 6c54 6963 6b46 6f72  = NumeralTickFor
+000067d0: 6d61 7474 6572 2866 6f72 6d61 743d 2230  matter(format="0
+000067e0: 2e30 2062 2229 0a20 2020 2020 2020 2073  .0 b").        s
+000067f0: 656c 662e 6469 736b 5f66 6967 7572 652e  elf.disk_figure.
+00006800: 7867 7269 642e 7669 7369 626c 6520 3d20  xgrid.visible = 
+00006810: 4661 6c73 650a 0a20 2020 2020 2020 2023  False..        #
+00006820: 204d 656d 6f72 790a 2020 2020 2020 2020   Memory.        
+00006830: 7365 6c66 2e6d 656d 6f72 795f 736f 7572  self.memory_sour
+00006840: 6365 203d 2043 6f6c 756d 6e44 6174 6153  ce = ColumnDataS
+00006850: 6f75 7263 6528 0a20 2020 2020 2020 2020  ource(.         
+00006860: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00006870: 2020 2020 2022 7369 7a65 223a 205b 5d2c       "size": [],
+00006880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006890: 2022 6261 6e64 7769 6474 6822 3a20 5b5d   "bandwidth": []
+000068a0: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
+000068b0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+000068c0: 2020 2073 656c 662e 6d65 6d6f 7279 5f66     self.memory_f
+000068d0: 6967 7572 6520 3d20 6669 6775 7265 280a  igure = figure(.
+000068e0: 2020 2020 2020 2020 2020 2020 7469 746c              titl
+000068f0: 653d 224d 656d 6f72 7920 4261 6e64 7769  e="Memory Bandwi
+00006900: 6474 6820 2d2d 2043 6f6d 7075 7469 6e67  dth -- Computing
+00006910: 202e 2e2e 222c 0a20 2020 2020 2020 2020   ...",.         
+00006920: 2020 2074 6f6f 6c73 3d22 222c 0a20 2020     tools="",.   
+00006930: 2020 2020 2020 2020 2074 6f6f 6c62 6172           toolbar
+00006940: 5f6c 6f63 6174 696f 6e3d 2261 626f 7665  _location="above
+00006950: 222c 0a20 2020 2020 2020 2020 2020 2078  ",.            x
+00006960: 5f72 616e 6765 3d46 6163 746f 7252 616e  _range=FactorRan
+00006970: 6765 2866 6163 746f 7273 3d5b 5d29 2c0a  ge(factors=[]),.
+00006980: 2020 2020 2020 2020 2020 2020 2a2a 6b77              **kw
+00006990: 6172 6773 2c0a 2020 2020 2020 2020 290a  args,.        ).
+000069a0: 0a20 2020 2020 2020 2073 656c 662e 6d65  .        self.me
+000069b0: 6d6f 7279 5f66 6967 7572 652e 7662 6172  mory_figure.vbar
+000069c0: 280a 2020 2020 2020 2020 2020 2020 783d  (.            x=
+000069d0: 2273 697a 6522 2c20 746f 703d 2262 616e  "size", top="ban
+000069e0: 6477 6964 7468 222c 2077 6964 7468 3d30  dwidth", width=0
+000069f0: 2e39 2c20 736f 7572 6365 3d73 656c 662e  .9, source=self.
+00006a00: 6d65 6d6f 7279 5f73 6f75 7263 650a 2020  memory_source.  
+00006a10: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00006a20: 686f 7665 7220 3d20 486f 7665 7254 6f6f  hover = HoverToo
+00006a30: 6c28 0a20 2020 2020 2020 2020 2020 206d  l(.            m
+00006a40: 6f64 653d 2276 6c69 6e65 222c 2074 6f6f  ode="vline", too
+00006a50: 6c74 6970 733d 5b28 2242 616e 6477 6964  ltips=[("Bandwid
+00006a60: 7468 222c 2022 4062 616e 6477 6964 7468  th", "@bandwidth
+00006a70: 7b30 2e30 3020 627d 2f73 2229 5d0a 2020  {0.00 b}/s")].  
+00006a80: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00006a90: 7365 6c66 2e6d 656d 6f72 795f 6669 6775  self.memory_figu
+00006aa0: 7265 2e61 6464 5f74 6f6f 6c73 2868 6f76  re.add_tools(hov
+00006ab0: 6572 290a 2020 2020 2020 2020 7365 6c66  er).        self
+00006ac0: 2e6d 656d 6f72 795f 6669 6775 7265 2e79  .memory_figure.y
+00006ad0: 6178 6973 5b30 5d2e 666f 726d 6174 7465  axis[0].formatte
+00006ae0: 7220 3d20 4e75 6d65 7261 6c54 6963 6b46  r = NumeralTickF
+00006af0: 6f72 6d61 7474 6572 2866 6f72 6d61 743d  ormatter(format=
+00006b00: 2230 2e30 2062 2229 0a20 2020 2020 2020  "0.0 b").       
+00006b10: 2073 656c 662e 6d65 6d6f 7279 5f66 6967   self.memory_fig
+00006b20: 7572 652e 7867 7269 642e 7669 7369 626c  ure.xgrid.visibl
+00006b30: 6520 3d20 4661 6c73 650a 0a20 2020 2020  e = False..     
+00006b40: 2020 2023 204e 6574 776f 726b 0a20 2020     # Network.   
+00006b50: 2020 2020 2073 656c 662e 6e65 7477 6f72       self.networ
+00006b60: 6b5f 736f 7572 6365 203d 2043 6f6c 756d  k_source = Colum
+00006b70: 6e44 6174 6153 6f75 7263 6528 0a20 2020  nDataSource(.   
+00006b80: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00006b90: 2020 2020 2020 2020 2020 2022 7369 7a65             "size
+00006ba0: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00006bb0: 2020 2020 2020 2022 6261 6e64 7769 6474         "bandwidt
+00006bc0: 6822 3a20 5b5d 2c0a 2020 2020 2020 2020  h": [],.        
+00006bd0: 2020 2020 7d0a 2020 2020 2020 2020 290a      }.        ).
+00006be0: 0a20 2020 2020 2020 2073 656c 662e 6e65  .        self.ne
+00006bf0: 7477 6f72 6b5f 6669 6775 7265 203d 2066  twork_figure = f
+00006c00: 6967 7572 6528 0a20 2020 2020 2020 2020  igure(.         
+00006c10: 2020 2074 6974 6c65 3d22 4e65 7477 6f72     title="Networ
+00006c20: 6b20 4261 6e64 7769 6474 6820 2d2d 2043  k Bandwidth -- C
+00006c30: 6f6d 7075 7469 6e67 202e 2e2e 222c 0a20  omputing ...",. 
+00006c40: 2020 2020 2020 2020 2020 2074 6f6f 6c73             tools
+00006c50: 3d22 222c 0a20 2020 2020 2020 2020 2020  ="",.           
+00006c60: 2074 6f6f 6c62 6172 5f6c 6f63 6174 696f   toolbar_locatio
+00006c70: 6e3d 2261 626f 7665 222c 0a20 2020 2020  n="above",.     
+00006c80: 2020 2020 2020 2078 5f72 616e 6765 3d46         x_range=F
+00006c90: 6163 746f 7252 616e 6765 2866 6163 746f  actorRange(facto
+00006ca0: 7273 3d5b 5d29 2c0a 2020 2020 2020 2020  rs=[]),.        
+00006cb0: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
+00006cc0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00006cd0: 2073 656c 662e 6e65 7477 6f72 6b5f 6669   self.network_fi
+00006ce0: 6775 7265 2e76 6261 7228 0a20 2020 2020  gure.vbar(.     
+00006cf0: 2020 2020 2020 2078 3d22 7369 7a65 222c         x="size",
+00006d00: 2074 6f70 3d22 6261 6e64 7769 6474 6822   top="bandwidth"
+00006d10: 2c20 7769 6474 683d 302e 392c 2073 6f75  , width=0.9, sou
+00006d20: 7263 653d 7365 6c66 2e6e 6574 776f 726b  rce=self.network
+00006d30: 5f73 6f75 7263 650a 2020 2020 2020 2020  _source.        
+00006d40: 290a 2020 2020 2020 2020 686f 7665 7220  ).        hover 
+00006d50: 3d20 486f 7665 7254 6f6f 6c28 0a20 2020  = HoverTool(.   
+00006d60: 2020 2020 2020 2020 206d 6f64 653d 2276           mode="v
+00006d70: 6c69 6e65 222c 2074 6f6f 6c74 6970 733d  line", tooltips=
+00006d80: 5b28 2242 616e 6477 6964 7468 222c 2022  [("Bandwidth", "
+00006d90: 4062 616e 6477 6964 7468 7b30 2e30 3020  @bandwidth{0.00 
+00006da0: 627d 2f73 2229 5d0a 2020 2020 2020 2020  b}/s")].        
+00006db0: 290a 2020 2020 2020 2020 7365 6c66 2e6e  ).        self.n
+00006dc0: 6574 776f 726b 5f66 6967 7572 652e 6164  etwork_figure.ad
+00006dd0: 645f 746f 6f6c 7328 686f 7665 7229 0a20  d_tools(hover). 
+00006de0: 2020 2020 2020 2073 656c 662e 6e65 7477         self.netw
+00006df0: 6f72 6b5f 6669 6775 7265 2e79 6178 6973  ork_figure.yaxis
+00006e00: 5b30 5d2e 666f 726d 6174 7465 7220 3d20  [0].formatter = 
+00006e10: 4e75 6d65 7261 6c54 6963 6b46 6f72 6d61  NumeralTickForma
+00006e20: 7474 6572 2866 6f72 6d61 743d 2230 2e30  tter(format="0.0
+00006e30: 2062 2229 0a20 2020 2020 2020 2073 656c   b").        sel
+00006e40: 662e 6e65 7477 6f72 6b5f 6669 6775 7265  f.network_figure
+00006e50: 2e78 6772 6964 2e76 6973 6962 6c65 203d  .xgrid.visible =
+00006e60: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
+00006e70: 7365 6c66 2e72 6f6f 7420 3d20 726f 7728  self.root = row(
+00006e80: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00006e90: 662e 6d65 6d6f 7279 5f66 6967 7572 652c  f.memory_figure,
+00006ea0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00006eb0: 662e 6469 736b 5f66 6967 7572 652c 0a20  f.disk_figure,. 
+00006ec0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00006ed0: 6e65 7477 6f72 6b5f 6669 6775 7265 2c0a  network_figure,.
+00006ee0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00006ef0: 2020 2073 656c 662e 6d65 6d6f 7279 5f64     self.memory_d
+00006f00: 6174 6120 3d20 7b0a 2020 2020 2020 2020  ata = {.        
+00006f10: 2020 2020 2273 697a 6522 3a20 5b5d 2c0a      "size": [],.
+00006f20: 2020 2020 2020 2020 2020 2020 2262 616e              "ban
+00006f30: 6477 6964 7468 223a 205b 5d2c 0a20 2020  dwidth": [],.   
+00006f40: 2020 2020 207d 0a20 2020 2020 2020 2073       }.        s
+00006f50: 656c 662e 6469 736b 5f64 6174 6120 3d20  elf.disk_data = 
+00006f60: 7b0a 2020 2020 2020 2020 2020 2020 2273  {.            "s
+00006f70: 697a 6522 3a20 5b5d 2c0a 2020 2020 2020  ize": [],.      
+00006f80: 2020 2020 2020 2262 616e 6477 6964 7468        "bandwidth
+00006f90: 223a 205b 5d2c 0a20 2020 2020 2020 207d  ": [],.        }
+00006fa0: 0a20 2020 2020 2020 2073 656c 662e 6e65  .        self.ne
+00006fb0: 7477 6f72 6b5f 6461 7461 203d 207b 0a20  twork_data = {. 
+00006fc0: 2020 2020 2020 2020 2020 2022 7369 7a65             "size
+00006fd0: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00006fe0: 2020 2022 6261 6e64 7769 6474 6822 3a20     "bandwidth": 
+00006ff0: 5b5d 2c0a 2020 2020 2020 2020 7d0a 0a20  [],.        }.. 
+00007000: 2020 2020 2020 2061 7379 6e63 2064 6566         async def
+00007010: 2066 2829 3a0a 2020 2020 2020 2020 2020   f():.          
+00007020: 2020 7265 7375 6c74 203d 2061 7761 6974    result = await
+00007030: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
+00007040: 6265 6e63 686d 6172 6b5f 6861 7264 7761  benchmark_hardwa
+00007050: 7265 2829 0a0a 2020 2020 2020 2020 2020  re()..          
+00007060: 2020 666f 7220 7369 7a65 2069 6e20 736f    for size in so
+00007070: 7274 6564 2872 6573 756c 745b 2264 6973  rted(result["dis
+00007080: 6b22 5d2c 206b 6579 3d70 6172 7365 5f62  k"], key=parse_b
+00007090: 7974 6573 293a 0a20 2020 2020 2020 2020  ytes):.         
+000070a0: 2020 2020 2020 2062 616e 6477 6964 7468         bandwidth
+000070b0: 203d 2072 6573 756c 745b 2264 6973 6b22   = result["disk"
+000070c0: 5d5b 7369 7a65 5d0a 2020 2020 2020 2020  ][size].        
+000070d0: 2020 2020 2020 2020 7365 6c66 2e64 6973          self.dis
+000070e0: 6b5f 6461 7461 5b22 7369 7a65 225d 2e61  k_data["size"].a
+000070f0: 7070 656e 6428 7369 7a65 290a 2020 2020  ppend(size).    
+00007100: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00007110: 2e64 6973 6b5f 6461 7461 5b22 6261 6e64  .disk_data["band
+00007120: 7769 6474 6822 5d2e 6170 7065 6e64 2862  width"].append(b
+00007130: 616e 6477 6964 7468 290a 0a20 2020 2020  andwidth)..     
+00007140: 2020 2020 2020 2066 6f72 2073 697a 6520         for size 
+00007150: 696e 2073 6f72 7465 6428 7265 7375 6c74  in sorted(result
+00007160: 5b22 6d65 6d6f 7279 225d 2c20 6b65 793d  ["memory"], key=
+00007170: 7061 7273 655f 6279 7465 7329 3a0a 2020  parse_bytes):.  
+00007180: 2020 2020 2020 2020 2020 2020 2020 6261                ba
+00007190: 6e64 7769 6474 6820 3d20 7265 7375 6c74  ndwidth = result
+000071a0: 5b22 6d65 6d6f 7279 225d 5b73 697a 655d  ["memory"][size]
+000071b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000071c0: 2073 656c 662e 6d65 6d6f 7279 5f64 6174   self.memory_dat
+000071d0: 615b 2273 697a 6522 5d2e 6170 7065 6e64  a["size"].append
+000071e0: 2873 697a 6529 0a20 2020 2020 2020 2020  (size).         
+000071f0: 2020 2020 2020 2073 656c 662e 6d65 6d6f         self.memo
+00007200: 7279 5f64 6174 615b 2262 616e 6477 6964  ry_data["bandwid
+00007210: 7468 225d 2e61 7070 656e 6428 6261 6e64  th"].append(band
+00007220: 7769 6474 6829 0a0a 2020 2020 2020 2020  width)..        
+00007230: 2020 2020 666f 7220 7369 7a65 2069 6e20      for size in 
+00007240: 736f 7274 6564 2872 6573 756c 745b 226e  sorted(result["n
+00007250: 6574 776f 726b 225d 2c20 6b65 793d 7061  etwork"], key=pa
+00007260: 7273 655f 6279 7465 7329 3a0a 2020 2020  rse_bytes):.    
+00007270: 2020 2020 2020 2020 2020 2020 6261 6e64              band
+00007280: 7769 6474 6820 3d20 7265 7375 6c74 5b22  width = result["
+00007290: 6e65 7477 6f72 6b22 5d5b 7369 7a65 5d0a  network"][size].
+000072a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000072b0: 7365 6c66 2e6e 6574 776f 726b 5f64 6174  self.network_dat
+000072c0: 615b 2273 697a 6522 5d2e 6170 7065 6e64  a["size"].append
+000072d0: 2873 697a 6529 0a20 2020 2020 2020 2020  (size).         
+000072e0: 2020 2020 2020 2073 656c 662e 6e65 7477         self.netw
+000072f0: 6f72 6b5f 6461 7461 5b22 6261 6e64 7769  ork_data["bandwi
+00007300: 6474 6822 5d2e 6170 7065 6e64 2862 616e  dth"].append(ban
+00007310: 6477 6964 7468 290a 0a20 2020 2020 2020  dwidth)..       
+00007320: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
+00007330: 6c6f 6f70 2e61 6464 5f63 616c 6c62 6163  loop.add_callbac
+00007340: 6b28 6629 0a0a 2020 2020 6465 6620 7570  k(f)..    def up
+00007350: 6461 7465 2873 656c 6629 3a0a 2020 2020  date(self):.    
+00007360: 2020 2020 6966 2028 0a20 2020 2020 2020      if (.       
+00007370: 2020 2020 206e 6f74 2073 656c 662e 6469       not self.di
+00007380: 736b 5f64 6174 615b 2273 697a 6522 5d0a  sk_data["size"].
+00007390: 2020 2020 2020 2020 2020 2020 6f72 2073              or s
+000073a0: 656c 662e 6469 736b 5f66 6967 7572 652e  elf.disk_figure.
+000073b0: 7469 746c 652e 7465 7874 203d 3d20 2244  title.text == "D
+000073c0: 6973 6b20 4261 6e64 7769 6474 6822 0a20  isk Bandwidth". 
+000073d0: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
+000073e0: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+000073f0: 2020 2020 2020 7365 6c66 2e6e 6574 776f        self.netwo
+00007400: 726b 5f66 6967 7572 652e 785f 7261 6e67  rk_figure.x_rang
+00007410: 652e 6661 6374 6f72 7320 3d20 7365 6c66  e.factors = self
+00007420: 2e6e 6574 776f 726b 5f64 6174 615b 2273  .network_data["s
+00007430: 697a 6522 5d0a 2020 2020 2020 2020 7365  ize"].        se
+00007440: 6c66 2e64 6973 6b5f 6669 6775 7265 2e78  lf.disk_figure.x
+00007450: 5f72 616e 6765 2e66 6163 746f 7273 203d  _range.factors =
+00007460: 2073 656c 662e 6469 736b 5f64 6174 615b   self.disk_data[
+00007470: 2273 697a 6522 5d0a 2020 2020 2020 2020  "size"].        
+00007480: 7365 6c66 2e6d 656d 6f72 795f 6669 6775  self.memory_figu
+00007490: 7265 2e78 5f72 616e 6765 2e66 6163 746f  re.x_range.facto
+000074a0: 7273 203d 2073 656c 662e 6d65 6d6f 7279  rs = self.memory
+000074b0: 5f64 6174 615b 2273 697a 6522 5d0a 2020  _data["size"].  
+000074c0: 2020 2020 2020 7570 6461 7465 2873 656c        update(sel
+000074d0: 662e 6469 736b 5f73 6f75 7263 652c 2073  f.disk_source, s
+000074e0: 656c 662e 6469 736b 5f64 6174 6129 0a20  elf.disk_data). 
+000074f0: 2020 2020 2020 2075 7064 6174 6528 7365         update(se
+00007500: 6c66 2e6d 656d 6f72 795f 736f 7572 6365  lf.memory_source
+00007510: 2c20 7365 6c66 2e6d 656d 6f72 795f 6461  , self.memory_da
+00007520: 7461 290a 2020 2020 2020 2020 7570 6461  ta).        upda
+00007530: 7465 2873 656c 662e 6e65 7477 6f72 6b5f  te(self.network_
+00007540: 736f 7572 6365 2c20 7365 6c66 2e6e 6574  source, self.net
+00007550: 776f 726b 5f64 6174 6129 0a20 2020 2020  work_data).     
+00007560: 2020 2073 656c 662e 6d65 6d6f 7279 5f66     self.memory_f
+00007570: 6967 7572 652e 7469 746c 652e 7465 7874  igure.title.text
+00007580: 203d 2022 4d65 6d6f 7279 2042 616e 6477   = "Memory Bandw
+00007590: 6964 7468 220a 2020 2020 2020 2020 7365  idth".        se
+000075a0: 6c66 2e64 6973 6b5f 6669 6775 7265 2e74  lf.disk_figure.t
+000075b0: 6974 6c65 2e74 6578 7420 3d20 2244 6973  itle.text = "Dis
+000075c0: 6b20 4261 6e64 7769 6474 6822 0a20 2020  k Bandwidth".   
+000075d0: 2020 2020 2073 656c 662e 6e65 7477 6f72       self.networ
+000075e0: 6b5f 6669 6775 7265 2e74 6974 6c65 2e74  k_figure.title.t
+000075f0: 6578 7420 3d20 224e 6574 776f 726b 2042  ext = "Network B
+00007600: 616e 6477 6964 7468 220a 0a0a 636c 6173  andwidth"...clas
+00007610: 7320 4261 6e64 7769 6474 6854 7970 6573  s BandwidthTypes
+00007620: 2844 6173 6862 6f61 7264 436f 6d70 6f6e  (DashboardCompon
+00007630: 656e 7429 3a0a 2020 2020 2222 2242 6172  ent):.    """Bar
+00007640: 2063 6861 7274 2073 686f 7769 6e67 2062   chart showing b
+00007650: 616e 6477 6964 7468 2070 6572 2074 7970  andwidth per typ
+00007660: 6522 2222 0a0a 2020 2020 406c 6f67 5f65  e"""..    @log_e
+00007670: 7272 6f72 730a 2020 2020 6465 6620 5f5f  rrors.    def __
+00007680: 696e 6974 5f5f 2873 656c 662c 2073 6368  init__(self, sch
+00007690: 6564 756c 6572 2c20 2a2a 6b77 6172 6773  eduler, **kwargs
+000076a0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+000076b0: 6c61 7374 203d 2030 0a20 2020 2020 2020  last = 0.       
+000076c0: 2073 656c 662e 7363 6865 6475 6c65 7220   self.scheduler 
+000076d0: 3d20 7363 6865 6475 6c65 720a 2020 2020  = scheduler.    
+000076e0: 2020 2020 7365 6c66 2e73 6f75 7263 6520      self.source 
+000076f0: 3d20 436f 6c75 6d6e 4461 7461 536f 7572  = ColumnDataSour
+00007700: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
+00007710: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00007720: 2020 2262 616e 6477 6964 7468 223a 205b    "bandwidth": [
+00007730: 312c 2032 5d2c 0a20 2020 2020 2020 2020  1, 2],.         
+00007740: 2020 2020 2020 2022 6261 6e64 7769 6474         "bandwidt
+00007750: 682d 6861 6c66 223a 205b 302e 352c 2031  h-half": [0.5, 1
+00007760: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00007770: 2020 2022 7479 7065 223a 205b 2261 222c     "type": ["a",
+00007780: 2022 6222 5d2c 0a20 2020 2020 2020 2020   "b"],.         
+00007790: 2020 2020 2020 2022 6261 6e64 7769 6474         "bandwidt
+000077a0: 685f 7465 7874 223a 205b 2231 222c 2022  h_text": ["1", "
+000077b0: 3222 5d2c 0a20 2020 2020 2020 2020 2020  2"],.           
+000077c0: 207d 0a20 2020 2020 2020 2029 0a0a 2020   }.        )..  
+000077d0: 2020 2020 2020 7365 6c66 2e72 6f6f 7420        self.root 
+000077e0: 3d20 6669 6775 7265 280a 2020 2020 2020  = figure(.      
+000077f0: 2020 2020 2020 7469 746c 653d 2242 616e        title="Ban
+00007800: 6477 6964 7468 2062 7920 5479 7065 222c  dwidth by Type",
+00007810: 0a20 2020 2020 2020 2020 2020 2074 6f6f  .            too
+00007820: 6c73 3d22 222c 0a20 2020 2020 2020 2020  ls="",.         
+00007830: 2020 206e 616d 653d 2262 616e 6477 6964     name="bandwid
+00007840: 7468 5f74 7970 655f 6869 7374 6f67 7261  th_type_histogra
+00007850: 6d22 2c0a 2020 2020 2020 2020 2020 2020  m",.            
+00007860: 795f 7261 6e67 653d 5b22 6122 2c20 2262  y_range=["a", "b
+00007870: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
+00007880: 2a2a 6b77 6172 6773 2c0a 2020 2020 2020  **kwargs,.      
+00007890: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+000078a0: 2e72 6f6f 742e 7861 7869 732e 6d61 6a6f  .root.xaxis.majo
+000078b0: 725f 6c61 6265 6c5f 6f72 6965 6e74 6174  r_label_orientat
+000078c0: 696f 6e20 3d20 2d30 2e35 0a20 2020 2020  ion = -0.5.     
+000078d0: 2020 2072 6563 7420 3d20 7365 6c66 2e72     rect = self.r
+000078e0: 6f6f 742e 7265 6374 280a 2020 2020 2020  oot.rect(.      
+000078f0: 2020 2020 2020 736f 7572 6365 3d73 656c        source=sel
+00007900: 662e 736f 7572 6365 2c0a 2020 2020 2020  f.source,.      
+00007910: 2020 2020 2020 783d 2262 616e 6477 6964        x="bandwid
+00007920: 7468 2d68 616c 6622 2c0a 2020 2020 2020  th-half",.      
+00007930: 2020 2020 2020 793d 2274 7970 6522 2c0a        y="type",.
+00007940: 2020 2020 2020 2020 2020 2020 7769 6474              widt
+00007950: 683d 2262 616e 6477 6964 7468 222c 0a20  h="bandwidth",. 
+00007960: 2020 2020 2020 2020 2020 2068 6569 6768             heigh
+00007970: 743d 302e 392c 0a20 2020 2020 2020 2020  t=0.9,.         
+00007980: 2020 2063 6f6c 6f72 3d22 626c 7565 222c     color="blue",
+00007990: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+000079a0: 2020 2073 656c 662e 726f 6f74 2e78 5f72     self.root.x_r
+000079b0: 616e 6765 2e73 7461 7274 203d 2030 0a20  ange.start = 0. 
+000079c0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+000079d0: 2e78 6178 6973 5b30 5d2e 666f 726d 6174  .xaxis[0].format
+000079e0: 7465 7220 3d20 4e75 6d65 7261 6c54 6963  ter = NumeralTic
+000079f0: 6b46 6f72 6d61 7474 6572 2866 6f72 6d61  kFormatter(forma
+00007a00: 743d 2230 2e30 2062 2229 0a20 2020 2020  t="0.0 b").     
+00007a10: 2020 2073 656c 662e 726f 6f74 2e78 6178     self.root.xax
+00007a20: 6973 2e74 6963 6b65 7220 3d20 4164 6170  is.ticker = Adap
+00007a30: 7469 7665 5469 636b 6572 282a 2a54 4943  tiveTicker(**TIC
+00007a40: 4b53 5f31 3032 3429 0a20 2020 2020 2020  KS_1024).       
+00007a50: 2072 6563 742e 6e6f 6e73 656c 6563 7469   rect.nonselecti
+00007a60: 6f6e 5f67 6c79 7068 203d 204e 6f6e 650a  on_glyph = None.
+00007a70: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+00007a80: 6f74 2e78 6178 6973 2e6d 696e 6f72 5f74  ot.xaxis.minor_t
+00007a90: 6963 6b5f 6c69 6e65 5f61 6c70 6861 203d  ick_line_alpha =
+00007aa0: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
+00007ab0: 726f 6f74 2e79 6772 6964 2e76 6973 6962  root.ygrid.visib
+00007ac0: 6c65 203d 2046 616c 7365 0a0a 2020 2020  le = False..    
+00007ad0: 2020 2020 7365 6c66 2e72 6f6f 742e 746f      self.root.to
+00007ae0: 6f6c 6261 725f 6c6f 6361 7469 6f6e 203d  olbar_location =
+00007af0: 204e 6f6e 650a 0a20 2020 2020 2020 2068   None..        h
+00007b00: 6f76 6572 203d 2048 6f76 6572 546f 6f6c  over = HoverTool
+00007b10: 2829 0a20 2020 2020 2020 2068 6f76 6572  ().        hover
+00007b20: 2e74 6f6f 6c74 6970 7320 3d20 2240 7479  .tooltips = "@ty
+00007b30: 7065 3a20 4062 616e 6477 6964 7468 5f74  pe: @bandwidth_t
+00007b40: 6578 7420 2f20 7322 0a20 2020 2020 2020  ext / s".       
+00007b50: 2068 6f76 6572 2e70 6f69 6e74 5f70 6f6c   hover.point_pol
+00007b60: 6963 7920 3d20 2266 6f6c 6c6f 775f 6d6f  icy = "follow_mo
+00007b70: 7573 6522 0a20 2020 2020 2020 2073 656c  use".        sel
+00007b80: 662e 726f 6f74 2e61 6464 5f74 6f6f 6c73  f.root.add_tools
+00007b90: 2868 6f76 6572 290a 0a20 2020 2040 7769  (hover)..    @wi
+00007ba0: 7468 6f75 745f 7072 6f70 6572 7479 5f76  thout_property_v
+00007bb0: 616c 6964 6174 696f 6e0a 2020 2020 406c  alidation.    @l
+00007bc0: 6f67 5f65 7272 6f72 730a 2020 2020 6465  og_errors.    de
+00007bd0: 6620 7570 6461 7465 2873 656c 6629 3a0a  f update(self):.
+00007be0: 2020 2020 2020 2020 6277 203d 2073 656c          bw = sel
+00007bf0: 662e 7363 6865 6475 6c65 722e 6261 6e64  f.scheduler.band
+00007c00: 7769 6474 685f 7479 7065 730a 2020 2020  width_types.    
+00007c10: 2020 2020 7365 6c66 2e72 6f6f 742e 795f      self.root.y_
+00007c20: 7261 6e67 652e 6661 6374 6f72 7320 3d20  range.factors = 
+00007c30: 6c69 7374 2873 6f72 7465 6428 6277 2929  list(sorted(bw))
+00007c40: 0a20 2020 2020 2020 2072 6573 756c 7420  .        result 
+00007c50: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+00007c60: 2262 616e 6477 6964 7468 223a 206c 6973  "bandwidth": lis
+00007c70: 7428 6277 2e76 616c 7565 7328 2929 2c0a  t(bw.values()),.
+00007c80: 2020 2020 2020 2020 2020 2020 2262 616e              "ban
+00007c90: 6477 6964 7468 2d68 616c 6622 3a20 5b62  dwidth-half": [b
+00007ca0: 202f 2032 2066 6f72 2062 2069 6e20 6277   / 2 for b in bw
+00007cb0: 2e76 616c 7565 7328 295d 2c0a 2020 2020  .values()],.    
+00007cc0: 2020 2020 2020 2020 2274 7970 6522 3a20          "type": 
+00007cd0: 6c69 7374 2862 772e 6b65 7973 2829 292c  list(bw.keys()),
+00007ce0: 0a20 2020 2020 2020 2020 2020 2022 6261  .            "ba
+00007cf0: 6e64 7769 6474 685f 7465 7874 223a 205b  ndwidth_text": [
+00007d00: 666f 726d 6174 5f62 7974 6573 2878 2920  format_bytes(x) 
+00007d10: 666f 7220 7820 696e 2062 772e 7661 6c75  for x in bw.valu
+00007d20: 6573 2829 5d2c 0a20 2020 2020 2020 207d  es()],.        }
+00007d30: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+00007d40: 6f74 2e74 6974 6c65 2e74 6578 7420 3d20  ot.title.text = 
+00007d50: 2242 616e 6477 6964 7468 3a20 2220 2b20  "Bandwidth: " + 
+00007d60: 666f 726d 6174 5f62 7974 6573 2873 656c  format_bytes(sel
+00007d70: 662e 7363 6865 6475 6c65 722e 6261 6e64  f.scheduler.band
+00007d80: 7769 6474 6829 0a20 2020 2020 2020 2075  width).        u
+00007d90: 7064 6174 6528 7365 6c66 2e73 6f75 7263  pdate(self.sourc
+00007da0: 652c 2072 6573 756c 7429 0a0a 0a63 6c61  e, result)...cla
+00007db0: 7373 2042 616e 6477 6964 7468 576f 726b  ss BandwidthWork
+00007dc0: 6572 7328 4461 7368 626f 6172 6443 6f6d  ers(DashboardCom
+00007dd0: 706f 6e65 6e74 293a 0a20 2020 2022 2222  ponent):.    """
+00007de0: 486f 7720 6d61 6e79 2074 6173 6b73 2061  How many tasks a
+00007df0: 7265 206f 6e20 6561 6368 2077 6f72 6b65  re on each worke
+00007e00: 7222 2222 0a0a 2020 2020 406c 6f67 5f65  r"""..    @log_e
+00007e10: 7272 6f72 730a 2020 2020 6465 6620 5f5f  rrors.    def __
+00007e20: 696e 6974 5f5f 2873 656c 662c 2073 6368  init__(self, sch
+00007e30: 6564 756c 6572 2c20 2a2a 6b77 6172 6773  eduler, **kwargs
+00007e40: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00007e50: 6c61 7374 203d 2030 0a20 2020 2020 2020  last = 0.       
+00007e60: 2073 656c 662e 7363 6865 6475 6c65 7220   self.scheduler 
+00007e70: 3d20 7363 6865 6475 6c65 720a 2020 2020  = scheduler.    
+00007e80: 2020 2020 7365 6c66 2e73 6f75 7263 6520      self.source 
+00007e90: 3d20 436f 6c75 6d6e 4461 7461 536f 7572  = ColumnDataSour
+00007ea0: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
+00007eb0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00007ec0: 2020 2262 616e 6477 6964 7468 223a 205b    "bandwidth": [
+00007ed0: 312c 2032 5d2c 0a20 2020 2020 2020 2020  1, 2],.         
+00007ee0: 2020 2020 2020 2022 736f 7572 6365 223a         "source":
+00007ef0: 205b 2261 222c 2022 6222 5d2c 0a20 2020   ["a", "b"],.   
+00007f00: 2020 2020 2020 2020 2020 2020 2022 6465               "de
+00007f10: 7374 696e 6174 696f 6e22 3a20 5b22 6122  stination": ["a"
+00007f20: 2c20 2262 225d 2c0a 2020 2020 2020 2020  , "b"],.        
+00007f30: 2020 2020 2020 2020 2262 616e 6477 6964          "bandwid
+00007f40: 7468 5f74 6578 7422 3a20 5b22 3122 2c20  th_text": ["1", 
+00007f50: 2232 225d 2c0a 2020 2020 2020 2020 2020  "2"],.          
+00007f60: 2020 7d0a 2020 2020 2020 2020 290a 0a20    }.        ).. 
+00007f70: 2020 2020 2020 2076 616c 7565 7320 3d20         values = 
+00007f80: 5b68 6578 2878 295b 323a 5d20 666f 7220  [hex(x)[2:] for 
+00007f90: 7820 696e 2072 616e 6765 2836 342c 2032  x in range(64, 2
+00007fa0: 3536 295d 5b3a 3a2d 315d 0a20 2020 2020  56)][::-1].     
+00007fb0: 2020 206d 6170 7065 7220 3d20 6c69 6e65     mapper = line
+00007fc0: 6172 5f63 6d61 7028 0a20 2020 2020 2020  ar_cmap(.       
+00007fd0: 2020 2020 2066 6965 6c64 5f6e 616d 653d       field_name=
+00007fe0: 2262 616e 6477 6964 7468 222c 0a20 2020  "bandwidth",.   
+00007ff0: 2020 2020 2020 2020 2070 616c 6574 7465           palette
+00008000: 3d5b 2223 2220 2b20 7820 2b20 7820 2b20  =["#" + x + x + 
+00008010: 2246 4622 2066 6f72 2078 2069 6e20 7661  "FF" for x in va
+00008020: 6c75 6573 5d2c 0a20 2020 2020 2020 2020  lues],.         
+00008030: 2020 206c 6f77 3d30 2c0a 2020 2020 2020     low=0,.      
+00008040: 2020 2020 2020 6869 6768 3d31 2c0a 2020        high=1,.  
+00008050: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00008060: 2073 656c 662e 726f 6f74 203d 2066 6967   self.root = fig
+00008070: 7572 6528 0a20 2020 2020 2020 2020 2020  ure(.           
+00008080: 2074 6974 6c65 3d22 4261 6e64 7769 6474   title="Bandwidt
+00008090: 6820 6279 2057 6f72 6b65 7222 2c0a 2020  h by Worker",.  
+000080a0: 2020 2020 2020 2020 2020 746f 6f6c 733d            tools=
+000080b0: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
+000080c0: 6e61 6d65 3d22 6261 6e64 7769 6474 685f  name="bandwidth_
+000080d0: 776f 726b 6572 5f68 6561 746d 6170 222c  worker_heatmap",
+000080e0: 0a20 2020 2020 2020 2020 2020 2078 5f72  .            x_r
+000080f0: 616e 6765 3d5b 2261 222c 2022 6222 5d2c  ange=["a", "b"],
+00008100: 0a20 2020 2020 2020 2020 2020 2079 5f72  .            y_r
+00008110: 616e 6765 3d5b 2261 222c 2022 6222 5d2c  ange=["a", "b"],
+00008120: 0a20 2020 2020 2020 2020 2020 202a 2a6b  .            **k
+00008130: 7761 7267 732c 0a20 2020 2020 2020 2029  wargs,.        )
+00008140: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+00008150: 6f74 2e78 6178 6973 2e6d 616a 6f72 5f6c  ot.xaxis.major_l
+00008160: 6162 656c 5f6f 7269 656e 7461 7469 6f6e  abel_orientation
+00008170: 203d 2058 4c41 4245 4c5f 4f52 4945 4e54   = XLABEL_ORIENT
+00008180: 4154 494f 4e0a 2020 2020 2020 2020 7365  ATION.        se
+00008190: 6c66 2e72 6f6f 742e 7265 6374 280a 2020  lf.root.rect(.  
+000081a0: 2020 2020 2020 2020 2020 736f 7572 6365            source
+000081b0: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
+000081c0: 2020 2020 2020 2020 2020 783d 2273 6f75            x="sou
+000081d0: 7263 6522 2c0a 2020 2020 2020 2020 2020  rce",.          
+000081e0: 2020 793d 2264 6573 7469 6e61 7469 6f6e    y="destination
+000081f0: 222c 0a20 2020 2020 2020 2020 2020 2063  ",.            c
+00008200: 6f6c 6f72 3d6d 6170 7065 722c 0a20 2020  olor=mapper,.   
+00008210: 2020 2020 2020 2020 2068 6569 6768 743d           height=
+00008220: 312c 0a20 2020 2020 2020 2020 2020 2077  1,.            w
+00008230: 6964 7468 3d31 2c0a 2020 2020 2020 2020  idth=1,.        
+00008240: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00008250: 636f 6c6f 725f 6d61 7020 3d20 6d61 7070  color_map = mapp
+00008260: 6572 5b22 7472 616e 7366 6f72 6d22 5d0a  er["transform"].
+00008270: 2020 2020 2020 2020 636f 6c6f 725f 6261          color_ba
+00008280: 7220 3d20 436f 6c6f 7242 6172 280a 2020  r = ColorBar(.  
+00008290: 2020 2020 2020 2020 2020 636f 6c6f 725f            color_
+000082a0: 6d61 7070 6572 3d73 656c 662e 636f 6c6f  mapper=self.colo
+000082b0: 725f 6d61 702c 0a20 2020 2020 2020 2020  r_map,.         
+000082c0: 2020 206c 6162 656c 5f73 7461 6e64 6f66     label_standof
+000082d0: 663d 3132 2c0a 2020 2020 2020 2020 2020  f=12,.          
+000082e0: 2020 626f 7264 6572 5f6c 696e 655f 636f    border_line_co
+000082f0: 6c6f 723d 4e6f 6e65 2c0a 2020 2020 2020  lor=None,.      
+00008300: 2020 2020 2020 6c6f 6361 7469 6f6e 3d28        location=(
+00008310: 302c 2030 292c 0a20 2020 2020 2020 2029  0, 0),.        )
+00008320: 0a20 2020 2020 2020 2063 6f6c 6f72 5f62  .        color_b
+00008330: 6172 2e66 6f72 6d61 7474 6572 203d 204e  ar.formatter = N
+00008340: 756d 6572 616c 5469 636b 466f 726d 6174  umeralTickFormat
+00008350: 7465 7228 666f 726d 6174 3d22 302e 3020  ter(format="0.0 
+00008360: 6222 290a 2020 2020 2020 2020 636f 6c6f  b").        colo
+00008370: 725f 6261 722e 7469 636b 6572 203d 2041  r_bar.ticker = A
+00008380: 6461 7074 6976 6554 6963 6b65 7228 2a2a  daptiveTicker(**
+00008390: 5449 434b 535f 3130 3234 290a 2020 2020  TICKS_1024).    
+000083a0: 2020 2020 7365 6c66 2e72 6f6f 742e 6164      self.root.ad
+000083b0: 645f 6c61 796f 7574 2863 6f6c 6f72 5f62  d_layout(color_b
+000083c0: 6172 2c20 2272 6967 6874 2229 0a0a 2020  ar, "right")..  
+000083d0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+000083e0: 746f 6f6c 6261 725f 6c6f 6361 7469 6f6e  toolbar_location
+000083f0: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
+00008400: 2068 6f76 6572 203d 2048 6f76 6572 546f   hover = HoverTo
+00008410: 6f6c 2829 0a20 2020 2020 2020 2068 6f76  ol().        hov
+00008420: 6572 2e74 6f6f 6c74 6970 7320 3d20 2222  er.tooltips = ""
+00008430: 220a 2020 2020 2020 2020 2020 2020 3c64  ".            <d
+00008440: 6976 3e0a 2020 2020 2020 2020 2020 2020  iv>.            
+00008450: 2020 2020 3c70 3e3c 623e 536f 7572 6365      <p><b>Source
+00008460: 3a3c 2f62 3e20 4073 6f75 7263 6520 3c2f  :</b> @source </
+00008470: 703e 0a20 2020 2020 2020 2020 2020 2020  p>.             
+00008480: 2020 203c 703e 3c62 3e44 6573 7469 6e61     <p><b>Destina
+00008490: 7469 6f6e 3a3c 2f62 3e20 4064 6573 7469  tion:</b> @desti
+000084a0: 6e61 7469 6f6e 203c 2f70 3e0a 2020 2020  nation </p>.    
+000084b0: 2020 2020 2020 2020 2020 2020 3c70 3e3c              <p><
+000084c0: 623e 4261 6e64 7769 6474 683a 3c2f 623e  b>Bandwidth:</b>
+000084d0: 2040 6261 6e64 7769 6474 685f 7465 7874   @bandwidth_text
+000084e0: 202f 2073 3c2f 703e 0a20 2020 2020 2020   / s</p>.       
+000084f0: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
+00008500: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00008510: 2020 2020 686f 7665 722e 706f 696e 745f      hover.point_
+00008520: 706f 6c69 6379 203d 2022 666f 6c6c 6f77  policy = "follow
+00008530: 5f6d 6f75 7365 220a 2020 2020 2020 2020  _mouse".        
+00008540: 7365 6c66 2e72 6f6f 742e 6164 645f 746f  self.root.add_to
+00008550: 6f6c 7328 686f 7665 7229 0a0a 2020 2020  ols(hover)..    
+00008560: 4077 6974 686f 7574 5f70 726f 7065 7274  @without_propert
+00008570: 795f 7661 6c69 6461 7469 6f6e 0a20 2020  y_validation.   
+00008580: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
+00008590: 2064 6566 2075 7064 6174 6528 7365 6c66   def update(self
+000085a0: 293a 0a20 2020 2020 2020 2062 7720 3d20  ):.        bw = 
+000085b0: 7365 6c66 2e73 6368 6564 756c 6572 2e62  self.scheduler.b
+000085c0: 616e 6477 6964 7468 5f77 6f72 6b65 7273  andwidth_workers
+000085d0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+000085e0: 6277 3a0a 2020 2020 2020 2020 2020 2020  bw:.            
+000085f0: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
+00008600: 6465 6620 6e61 6d65 2861 6464 7265 7373  def name(address
+00008610: 293a 0a20 2020 2020 2020 2020 2020 2074  ):.            t
+00008620: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00008630: 2020 2020 7773 203d 2073 656c 662e 7363      ws = self.sc
+00008640: 6865 6475 6c65 722e 776f 726b 6572 735b  heduler.workers[
+00008650: 6164 6472 6573 735d 0a20 2020 2020 2020  address].       
+00008660: 2020 2020 2065 7863 6570 7420 4b65 7945       except KeyE
+00008670: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+00008680: 2020 2020 2020 7265 7475 726e 2061 6464        return add
+00008690: 7265 7373 0a20 2020 2020 2020 2020 2020  ress.           
+000086a0: 2069 6620 7773 2e6e 616d 6520 6973 206e   if ws.name is n
+000086b0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+000086c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000086d0: 7374 7228 7773 2e6e 616d 6529 0a20 2020  str(ws.name).   
+000086e0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000086f0: 6164 6472 6573 730a 0a20 2020 2020 2020  address..       
+00008700: 2078 2c20 792c 2076 616c 7565 203d 207a   x, y, value = z
+00008710: 6970 282a 2828 6e61 6d65 2861 292c 206e  ip(*((name(a), n
+00008720: 616d 6528 6229 2c20 6329 2066 6f72 2028  ame(b), c) for (
+00008730: 612c 2062 292c 2063 2069 6e20 6277 2e69  a, b), c in bw.i
+00008740: 7465 6d73 2829 2929 0a0a 2020 2020 2020  tems()))..      
+00008750: 2020 7365 6c66 2e63 6f6c 6f72 5f6d 6170    self.color_map
+00008760: 2e68 6967 6820 3d20 6d61 7828 7661 6c75  .high = max(valu
+00008770: 6529 0a0a 2020 2020 2020 2020 6661 6374  e)..        fact
+00008780: 6f72 7320 3d20 6c69 7374 2873 6f72 7465  ors = list(sorte
+00008790: 6428 7365 7428 7820 2b20 7929 2929 0a20  d(set(x + y))). 
+000087a0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+000087b0: 2e78 5f72 616e 6765 2e66 6163 746f 7273  .x_range.factors
+000087c0: 203d 2066 6163 746f 7273 0a20 2020 2020   = factors.     
+000087d0: 2020 2073 656c 662e 726f 6f74 2e79 5f72     self.root.y_r
+000087e0: 616e 6765 2e66 6163 746f 7273 203d 2066  ange.factors = f
+000087f0: 6163 746f 7273 5b3a 3a2d 315d 0a0a 2020  actors[::-1]..  
+00008800: 2020 2020 2020 7265 7375 6c74 203d 207b        result = {
+00008810: 0a20 2020 2020 2020 2020 2020 2022 736f  .            "so
+00008820: 7572 6365 223a 2078 2c0a 2020 2020 2020  urce": x,.      
+00008830: 2020 2020 2020 2264 6573 7469 6e61 7469        "destinati
+00008840: 6f6e 223a 2079 2c0a 2020 2020 2020 2020  on": y,.        
+00008850: 2020 2020 2262 616e 6477 6964 7468 223a      "bandwidth":
+00008860: 2076 616c 7565 2c0a 2020 2020 2020 2020   value,.        
+00008870: 2020 2020 2262 616e 6477 6964 7468 5f74      "bandwidth_t
+00008880: 6578 7422 3a20 6c69 7374 286d 6170 2866  ext": list(map(f
+00008890: 6f72 6d61 745f 6279 7465 732c 2076 616c  ormat_bytes, val
+000088a0: 7565 2929 2c0a 2020 2020 2020 2020 7d0a  ue)),.        }.
+000088b0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+000088c0: 742e 7469 746c 652e 7465 7874 203d 2022  t.title.text = "
+000088d0: 4261 6e64 7769 6474 683a 2022 202b 2066  Bandwidth: " + f
+000088e0: 6f72 6d61 745f 6279 7465 7328 7365 6c66  ormat_bytes(self
+000088f0: 2e73 6368 6564 756c 6572 2e62 616e 6477  .scheduler.bandw
+00008900: 6964 7468 290a 2020 2020 2020 2020 7570  idth).        up
+00008910: 6461 7465 2873 656c 662e 736f 7572 6365  date(self.source
+00008920: 2c20 7265 7375 6c74 290a 0a0a 636c 6173  , result)...clas
+00008930: 7320 576f 726b 6572 4e65 7477 6f72 6b42  s WorkerNetworkB
+00008940: 616e 6477 6964 7468 2844 6173 6862 6f61  andwidth(Dashboa
+00008950: 7264 436f 6d70 6f6e 656e 7429 3a0a 2020  rdComponent):.  
+00008960: 2020 2222 2257 6f72 6b65 7220 6e65 7477    """Worker netw
+00008970: 6f72 6b20 6261 6e64 7769 6474 6820 6368  ork bandwidth ch
+00008980: 6172 740a 0a20 2020 2050 6c6f 7473 2068  art..    Plots h
+00008990: 6f72 697a 6f6e 7461 6c20 6261 7273 2077  orizontal bars w
+000089a0: 6974 6820 7468 6520 686f 7374 5f6e 6574  ith the host_net
+000089b0: 5f69 6f2e 7265 6164 5f62 7073 2061 6e64  _io.read_bps and
+000089c0: 2068 6f73 745f 6e65 745f 696f 2e77 7269   host_net_io.wri
+000089d0: 7465 5f62 7073 2077 6f72 6b65 720a 2020  te_bps worker.  
+000089e0: 2020 7374 6174 650a 2020 2020 2222 220a    state.    """.
+000089f0: 0a20 2020 2040 6c6f 675f 6572 726f 7273  .    @log_errors
+00008a00: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00008a10: 5f28 7365 6c66 2c20 7363 6865 6475 6c65  _(self, schedule
+00008a20: 722c 202a 2a6b 7761 7267 7329 3a0a 2020  r, **kwargs):.  
+00008a30: 2020 2020 2020 7365 6c66 2e73 6368 6564        self.sched
+00008a40: 756c 6572 203d 2073 6368 6564 756c 6572  uler = scheduler
+00008a50: 0a20 2020 2020 2020 2073 656c 662e 736f  .        self.so
+00008a60: 7572 6365 203d 2043 6f6c 756d 6e44 6174  urce = ColumnDat
+00008a70: 6153 6f75 7263 6528 0a20 2020 2020 2020  aSource(.       
+00008a80: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00008a90: 2020 2020 2020 2022 795f 7265 6164 223a         "y_read":
+00008aa0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+00008ab0: 2020 2020 2022 795f 7772 6974 6522 3a20       "y_write": 
+00008ac0: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+00008ad0: 2020 2020 2278 5f72 6561 6422 3a20 5b5d      "x_read": []
+00008ae0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00008af0: 2020 2278 5f77 7269 7465 223a 205b 5d2c    "x_write": [],
+00008b00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008b10: 2022 785f 7265 6164 5f64 6973 6b22 3a20   "x_read_disk": 
+00008b20: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+00008b30: 2020 2020 2278 5f77 7269 7465 5f64 6973      "x_write_dis
+00008b40: 6b22 3a20 5b5d 2c0a 2020 2020 2020 2020  k": [],.        
+00008b50: 2020 2020 7d0a 2020 2020 2020 2020 290a      }.        ).
+00008b60: 0a20 2020 2020 2020 2073 656c 662e 6261  .        self.ba
+00008b70: 6e64 7769 6474 6820 3d20 6669 6775 7265  ndwidth = figure
+00008b80: 280a 2020 2020 2020 2020 2020 2020 7469  (.            ti
+00008b90: 746c 653d 2257 6f72 6b65 7220 4e65 7477  tle="Worker Netw
+00008ba0: 6f72 6b20 4261 6e64 7769 6474 6822 2c0a  ork Bandwidth",.
+00008bb0: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
+00008bc0: 733d 2222 2c0a 2020 2020 2020 2020 2020  s="",.          
+00008bd0: 2020 6e61 6d65 3d22 776f 726b 6572 5f6e    name="worker_n
+00008be0: 6574 776f 726b 5f62 616e 6477 6964 7468  etwork_bandwidth
+00008bf0: 222c 0a20 2020 2020 2020 2020 2020 202a  ",.            *
+00008c00: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
+00008c10: 2029 0a0a 2020 2020 2020 2020 2320 686f   )..        # ho
+00008c20: 7374 5f6e 6574 5f69 6f2e 7265 6164 5f62  st_net_io.read_b
+00008c30: 7073 0a20 2020 2020 2020 2073 656c 662e  ps.        self.
+00008c40: 6261 6e64 7769 6474 682e 6862 6172 280a  bandwidth.hbar(.
+00008c50: 2020 2020 2020 2020 2020 2020 793d 2279              y="y
+00008c60: 5f72 6561 6422 2c0a 2020 2020 2020 2020  _read",.        
+00008c70: 2020 2020 7269 6768 743d 2278 5f72 6561      right="x_rea
+00008c80: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
+00008c90: 6c69 6e65 5f63 6f6c 6f72 3d4e 6f6e 652c  line_color=None,
+00008ca0: 0a20 2020 2020 2020 2020 2020 206c 6566  .            lef
+00008cb0: 743d 302c 0a20 2020 2020 2020 2020 2020  t=0,.           
+00008cc0: 2068 6569 6768 743d 302e 352c 0a20 2020   height=0.5,.   
+00008cd0: 2020 2020 2020 2020 2066 696c 6c5f 636f           fill_co
+00008ce0: 6c6f 723d 2272 6564 222c 0a20 2020 2020  lor="red",.     
+00008cf0: 2020 2020 2020 206c 6567 656e 645f 6c61         legend_la
+00008d00: 6265 6c3d 2272 6561 6422 2c0a 2020 2020  bel="read",.    
+00008d10: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
+00008d20: 656c 662e 736f 7572 6365 2c0a 2020 2020  elf.source,.    
+00008d30: 2020 2020 290a 0a20 2020 2020 2020 2023      )..        #
+00008d40: 2068 6f73 745f 6e65 745f 696f 2e77 7269   host_net_io.wri
+00008d50: 7465 5f62 7073 0a20 2020 2020 2020 2073  te_bps.        s
+00008d60: 656c 662e 6261 6e64 7769 6474 682e 6862  elf.bandwidth.hb
+00008d70: 6172 280a 2020 2020 2020 2020 2020 2020  ar(.            
+00008d80: 793d 2279 5f77 7269 7465 222c 0a20 2020  y="y_write",.   
+00008d90: 2020 2020 2020 2020 2072 6967 6874 3d22           right="
+00008da0: 785f 7772 6974 6522 2c0a 2020 2020 2020  x_write",.      
+00008db0: 2020 2020 2020 6c69 6e65 5f63 6f6c 6f72        line_color
+00008dc0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
+00008dd0: 2020 206c 6566 743d 302c 0a20 2020 2020     left=0,.     
+00008de0: 2020 2020 2020 2068 6569 6768 743d 302e         height=0.
+00008df0: 352c 0a20 2020 2020 2020 2020 2020 2066  5,.            f
+00008e00: 696c 6c5f 636f 6c6f 723d 2262 6c75 6522  ill_color="blue"
+00008e10: 2c0a 2020 2020 2020 2020 2020 2020 6c65  ,.            le
+00008e20: 6765 6e64 5f6c 6162 656c 3d22 7772 6974  gend_label="writ
+00008e30: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+00008e40: 736f 7572 6365 3d73 656c 662e 736f 7572  source=self.sour
+00008e50: 6365 2c0a 2020 2020 2020 2020 290a 0a20  ce,.        ).. 
+00008e60: 2020 2020 2020 2073 656c 662e 6261 6e64         self.band
+00008e70: 7769 6474 682e 6178 6973 5b30 5d2e 7469  width.axis[0].ti
+00008e80: 636b 6572 203d 2042 6173 6963 5469 636b  cker = BasicTick
+00008e90: 6572 282a 2a54 4943 4b53 5f31 3032 3429  er(**TICKS_1024)
+00008ea0: 0a20 2020 2020 2020 2073 656c 662e 6261  .        self.ba
+00008eb0: 6e64 7769 6474 682e 7861 7869 735b 305d  ndwidth.xaxis[0]
+00008ec0: 2e66 6f72 6d61 7474 6572 203d 204e 756d  .formatter = Num
+00008ed0: 6572 616c 5469 636b 466f 726d 6174 7465  eralTickFormatte
+00008ee0: 7228 666f 726d 6174 3d22 302e 3020 6222  r(format="0.0 b"
+00008ef0: 290a 2020 2020 2020 2020 7365 6c66 2e62  ).        self.b
+00008f00: 616e 6477 6964 7468 2e78 6178 6973 2e6d  andwidth.xaxis.m
+00008f10: 616a 6f72 5f6c 6162 656c 5f6f 7269 656e  ajor_label_orien
+00008f20: 7461 7469 6f6e 203d 2058 4c41 4245 4c5f  tation = XLABEL_
+00008f30: 4f52 4945 4e54 4154 494f 4e0a 2020 2020  ORIENTATION.    
+00008f40: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
+00008f50: 7468 2e78 6178 6973 2e6d 696e 6f72 5f74  th.xaxis.minor_t
+00008f60: 6963 6b5f 6c69 6e65 5f61 6c70 6861 203d  ick_line_alpha =
+00008f70: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
+00008f80: 6261 6e64 7769 6474 682e 785f 7261 6e67  bandwidth.x_rang
+00008f90: 6520 3d20 5261 6e67 6531 6428 7374 6172  e = Range1d(star
+00008fa0: 743d 3029 0a20 2020 2020 2020 2073 656c  t=0).        sel
+00008fb0: 662e 6261 6e64 7769 6474 682e 7961 7869  f.bandwidth.yaxi
+00008fc0: 732e 7669 7369 626c 6520 3d20 4661 6c73  s.visible = Fals
+00008fd0: 650a 2020 2020 2020 2020 7365 6c66 2e62  e.        self.b
+00008fe0: 616e 6477 6964 7468 2e79 6772 6964 2e76  andwidth.ygrid.v
+00008ff0: 6973 6962 6c65 203d 2046 616c 7365 0a20  isible = False. 
+00009000: 2020 2020 2020 2073 656c 662e 6261 6e64         self.band
+00009010: 7769 6474 682e 746f 6f6c 6261 725f 6c6f  width.toolbar_lo
+00009020: 6361 7469 6f6e 203d 204e 6f6e 650a 0a20  cation = None.. 
+00009030: 2020 2020 2020 2073 656c 662e 6469 736b         self.disk
+00009040: 203d 2066 6967 7572 6528 0a20 2020 2020   = figure(.     
+00009050: 2020 2020 2020 2074 6974 6c65 3d22 576f         title="Wo
+00009060: 726b 6572 7320 4469 736b 222c 0a20 2020  rkers Disk",.   
+00009070: 2020 2020 2020 2020 2074 6f6f 6c73 3d22           tools="
+00009080: 222c 0a20 2020 2020 2020 2020 2020 206e  ",.            n
+00009090: 616d 653d 2277 6f72 6b65 725f 6469 736b  ame="worker_disk
+000090a0: 222c 0a20 2020 2020 2020 2020 2020 202a  ",.            *
+000090b0: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
+000090c0: 2029 0a0a 2020 2020 2020 2020 2320 686f   )..        # ho
+000090d0: 7374 5f64 6973 6b5f 696f 2e72 6561 645f  st_disk_io.read_
+000090e0: 6270 730a 2020 2020 2020 2020 7365 6c66  bps.        self
+000090f0: 2e64 6973 6b2e 6862 6172 280a 2020 2020  .disk.hbar(.    
+00009100: 2020 2020 2020 2020 793d 2279 5f72 6561          y="y_rea
+00009110: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
+00009120: 7269 6768 743d 2278 5f72 6561 645f 6469  right="x_read_di
+00009130: 736b 222c 0a20 2020 2020 2020 2020 2020  sk",.           
+00009140: 206c 696e 655f 636f 6c6f 723d 4e6f 6e65   line_color=None
+00009150: 2c0a 2020 2020 2020 2020 2020 2020 6c65  ,.            le
+00009160: 6674 3d30 2c0a 2020 2020 2020 2020 2020  ft=0,.          
+00009170: 2020 6865 6967 6874 3d30 2e35 2c0a 2020    height=0.5,.  
+00009180: 2020 2020 2020 2020 2020 6669 6c6c 5f63            fill_c
+00009190: 6f6c 6f72 3d22 7265 6422 2c0a 2020 2020  olor="red",.    
+000091a0: 2020 2020 2020 2020 6c65 6765 6e64 5f6c          legend_l
+000091b0: 6162 656c 3d22 7265 6164 222c 0a20 2020  abel="read",.   
+000091c0: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
+000091d0: 7365 6c66 2e73 6f75 7263 652c 0a20 2020  self.source,.   
+000091e0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+000091f0: 2320 686f 7374 5f64 6973 6b5f 696f 2e77  # host_disk_io.w
+00009200: 7269 7465 5f62 7073 0a20 2020 2020 2020  rite_bps.       
+00009210: 2073 656c 662e 6469 736b 2e68 6261 7228   self.disk.hbar(
+00009220: 0a20 2020 2020 2020 2020 2020 2079 3d22  .            y="
+00009230: 795f 7772 6974 6522 2c0a 2020 2020 2020  y_write",.      
+00009240: 2020 2020 2020 7269 6768 743d 2278 5f77        right="x_w
+00009250: 7269 7465 5f64 6973 6b22 2c0a 2020 2020  rite_disk",.    
+00009260: 2020 2020 2020 2020 6c69 6e65 5f63 6f6c          line_col
+00009270: 6f72 3d4e 6f6e 652c 0a20 2020 2020 2020  or=None,.       
+00009280: 2020 2020 206c 6566 743d 302c 0a20 2020       left=0,.   
+00009290: 2020 2020 2020 2020 2068 6569 6768 743d           height=
+000092a0: 302e 352c 0a20 2020 2020 2020 2020 2020  0.5,.           
+000092b0: 2066 696c 6c5f 636f 6c6f 723d 2262 6c75   fill_color="blu
+000092c0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+000092d0: 6c65 6765 6e64 5f6c 6162 656c 3d22 7772  legend_label="wr
+000092e0: 6974 6522 2c0a 2020 2020 2020 2020 2020  ite",.          
+000092f0: 2020 736f 7572 6365 3d73 656c 662e 736f    source=self.so
+00009300: 7572 6365 2c0a 2020 2020 2020 2020 290a  urce,.        ).
+00009310: 0a20 2020 2020 2020 2073 656c 662e 6469  .        self.di
+00009320: 736b 2e61 7869 735b 305d 2e74 6963 6b65  sk.axis[0].ticke
+00009330: 7220 3d20 4261 7369 6354 6963 6b65 7228  r = BasicTicker(
+00009340: 2a2a 5449 434b 535f 3130 3234 290a 2020  **TICKS_1024).  
+00009350: 2020 2020 2020 7365 6c66 2e64 6973 6b2e        self.disk.
+00009360: 7861 7869 735b 305d 2e66 6f72 6d61 7474  xaxis[0].formatt
+00009370: 6572 203d 204e 756d 6572 616c 5469 636b  er = NumeralTick
+00009380: 466f 726d 6174 7465 7228 666f 726d 6174  Formatter(format
+00009390: 3d22 302e 3020 6222 290a 2020 2020 2020  ="0.0 b").      
+000093a0: 2020 7365 6c66 2e64 6973 6b2e 7861 7869    self.disk.xaxi
+000093b0: 732e 6d61 6a6f 725f 6c61 6265 6c5f 6f72  s.major_label_or
+000093c0: 6965 6e74 6174 696f 6e20 3d20 584c 4142  ientation = XLAB
+000093d0: 454c 5f4f 5249 454e 5441 5449 4f4e 0a20  EL_ORIENTATION. 
+000093e0: 2020 2020 2020 2073 656c 662e 6469 736b         self.disk
+000093f0: 2e78 6178 6973 2e6d 696e 6f72 5f74 6963  .xaxis.minor_tic
+00009400: 6b5f 6c69 6e65 5f61 6c70 6861 203d 2030  k_line_alpha = 0
+00009410: 0a20 2020 2020 2020 2073 656c 662e 6469  .        self.di
+00009420: 736b 2e78 5f72 616e 6765 203d 2052 616e  sk.x_range = Ran
+00009430: 6765 3164 2873 7461 7274 3d30 290a 2020  ge1d(start=0).  
+00009440: 2020 2020 2020 7365 6c66 2e64 6973 6b2e        self.disk.
+00009450: 7961 7869 732e 7669 7369 626c 6520 3d20  yaxis.visible = 
+00009460: 4661 6c73 650a 2020 2020 2020 2020 7365  False.        se
+00009470: 6c66 2e64 6973 6b2e 7967 7269 642e 7669  lf.disk.ygrid.vi
+00009480: 7369 626c 6520 3d20 4661 6c73 650a 2020  sible = False.  
+00009490: 2020 2020 2020 7365 6c66 2e64 6973 6b2e        self.disk.
+000094a0: 746f 6f6c 6261 725f 6c6f 6361 7469 6f6e  toolbar_location
+000094b0: 203d 204e 6f6e 650a 0a20 2020 2040 7769   = None..    @wi
+000094c0: 7468 6f75 745f 7072 6f70 6572 7479 5f76  thout_property_v
+000094d0: 616c 6964 6174 696f 6e0a 2020 2020 406c  alidation.    @l
+000094e0: 6f67 5f65 7272 6f72 730a 2020 2020 6465  og_errors.    de
+000094f0: 6620 7570 6461 7465 2873 656c 6629 3a0a  f update(self):.
+00009500: 2020 2020 2020 2020 776f 726b 6572 7320          workers 
+00009510: 3d20 7365 6c66 2e73 6368 6564 756c 6572  = self.scheduler
+00009520: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
+00009530: 290a 0a20 2020 2020 2020 2068 203d 2030  )..        h = 0
+00009540: 2e31 0a20 2020 2020 2020 2079 5f72 6561  .1.        y_rea
+00009550: 6420 3d20 5b69 202b 2030 2e37 3520 2b20  d = [i + 0.75 + 
+00009560: 6920 2a20 6820 666f 7220 6920 696e 2072  i * h for i in r
+00009570: 616e 6765 286c 656e 2877 6f72 6b65 7273  ange(len(workers
+00009580: 2929 5d0a 2020 2020 2020 2020 795f 7772  ))].        y_wr
+00009590: 6974 6520 3d20 5b69 202b 2030 2e32 3520  ite = [i + 0.25 
+000095a0: 2b20 6920 2a20 6820 666f 7220 6920 696e  + i * h for i in
+000095b0: 2072 616e 6765 286c 656e 2877 6f72 6b65   range(len(worke
+000095c0: 7273 2929 5d0a 0a20 2020 2020 2020 2078  rs))]..        x
+000095d0: 5f72 6561 6420 3d20 5b5d 0a20 2020 2020  _read = [].     
+000095e0: 2020 2078 5f77 7269 7465 203d 205b 5d0a     x_write = [].
+000095f0: 2020 2020 2020 2020 785f 7265 6164 5f64          x_read_d
+00009600: 6973 6b20 3d20 5b5d 0a20 2020 2020 2020  isk = [].       
+00009610: 2078 5f77 7269 7465 5f64 6973 6b20 3d20   x_write_disk = 
+00009620: 5b5d 0a0a 2020 2020 2020 2020 666f 7220  []..        for 
+00009630: 7773 2069 6e20 776f 726b 6572 733a 0a20  ws in workers:. 
+00009640: 2020 2020 2020 2020 2020 2078 5f72 6561             x_rea
+00009650: 642e 6170 7065 6e64 2877 732e 6d65 7472  d.append(ws.metr
+00009660: 6963 735b 2268 6f73 745f 6e65 745f 696f  ics["host_net_io
+00009670: 225d 5b22 7265 6164 5f62 7073 225d 290a  "]["read_bps"]).
+00009680: 2020 2020 2020 2020 2020 2020 785f 7772              x_wr
+00009690: 6974 652e 6170 7065 6e64 2877 732e 6d65  ite.append(ws.me
+000096a0: 7472 6963 735b 2268 6f73 745f 6e65 745f  trics["host_net_
+000096b0: 696f 225d 5b22 7772 6974 655f 6270 7322  io"]["write_bps"
+000096c0: 5d29 0a20 2020 2020 2020 2020 2020 2078  ]).            x
+000096d0: 5f72 6561 645f 6469 736b 2e61 7070 656e  _read_disk.appen
+000096e0: 6428 7773 2e6d 6574 7269 6373 2e67 6574  d(ws.metrics.get
+000096f0: 2822 686f 7374 5f64 6973 6b5f 696f 222c  ("host_disk_io",
+00009700: 207b 7d29 2e67 6574 2822 7265 6164 5f62   {}).get("read_b
+00009710: 7073 222c 2030 2929 0a20 2020 2020 2020  ps", 0)).       
+00009720: 2020 2020 2078 5f77 7269 7465 5f64 6973       x_write_dis
+00009730: 6b2e 6170 7065 6e64 2877 732e 6d65 7472  k.append(ws.metr
+00009740: 6963 732e 6765 7428 2268 6f73 745f 6469  ics.get("host_di
+00009750: 736b 5f69 6f22 2c20 7b7d 292e 6765 7428  sk_io", {}).get(
+00009760: 2277 7269 7465 5f62 7073 222c 2030 2929  "write_bps", 0))
+00009770: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00009780: 662e 7363 6865 6475 6c65 722e 776f 726b  f.scheduler.work
+00009790: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+000097a0: 2073 656c 662e 6261 6e64 7769 6474 682e   self.bandwidth.
+000097b0: 785f 7261 6e67 652e 656e 6420 3d20 6d61  x_range.end = ma
+000097c0: 7828 0a20 2020 2020 2020 2020 2020 2020  x(.             
+000097d0: 2020 206d 6178 2878 5f72 6561 6429 2c0a     max(x_read),.
+000097e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000097f0: 6d61 7828 785f 7772 6974 6529 2c0a 2020  max(x_write),.  
+00009800: 2020 2020 2020 2020 2020 2020 2020 3130                10
+00009810: 305f 3030 305f 3030 302c 0a20 2020 2020  0_000_000,.     
+00009820: 2020 2020 2020 2020 2020 2030 2e39 3520             0.95 
+00009830: 2a20 7365 6c66 2e62 616e 6477 6964 7468  * self.bandwidth
+00009840: 2e78 5f72 616e 6765 2e65 6e64 2c0a 2020  .x_range.end,.  
+00009850: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00009860: 2020 2020 2020 2020 2073 656c 662e 6469           self.di
+00009870: 736b 2e78 5f72 616e 6765 2e65 6e64 203d  sk.x_range.end =
+00009880: 206d 6178 280a 2020 2020 2020 2020 2020   max(.          
+00009890: 2020 2020 2020 6d61 7828 785f 7265 6164        max(x_read
+000098a0: 5f64 6973 6b29 2c0a 2020 2020 2020 2020  _disk),.        
+000098b0: 2020 2020 2020 2020 6d61 7828 785f 7772          max(x_wr
+000098c0: 6974 655f 6469 736b 292c 0a20 2020 2020  ite_disk),.     
+000098d0: 2020 2020 2020 2020 2020 2031 3030 5f30             100_0
+000098e0: 3030 5f30 3030 2c0a 2020 2020 2020 2020  00_000,.        
+000098f0: 2020 2020 2020 2020 302e 3935 202a 2073          0.95 * s
+00009900: 656c 662e 6469 736b 2e78 5f72 616e 6765  elf.disk.x_range
+00009910: 2e65 6e64 2c0a 2020 2020 2020 2020 2020  .end,.          
+00009920: 2020 290a 2020 2020 2020 2020 656c 7365    ).        else
+00009930: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00009940: 6c66 2e62 616e 6477 6964 7468 2e78 5f72  lf.bandwidth.x_r
+00009950: 616e 6765 2e65 6e64 203d 2031 3030 5f30  ange.end = 100_0
+00009960: 3030 5f30 3030 0a20 2020 2020 2020 2020  00_000.         
+00009970: 2020 2073 656c 662e 6469 736b 2e78 5f72     self.disk.x_r
+00009980: 616e 6765 2e65 6e64 203d 2031 3030 5f30  ange.end = 100_0
+00009990: 3030 5f30 3030 0a0a 2020 2020 2020 2020  00_000..        
+000099a0: 7265 7375 6c74 203d 207b 0a20 2020 2020  result = {.     
+000099b0: 2020 2020 2020 2022 795f 7265 6164 223a         "y_read":
+000099c0: 2079 5f72 6561 642c 0a20 2020 2020 2020   y_read,.       
+000099d0: 2020 2020 2022 795f 7772 6974 6522 3a20       "y_write": 
+000099e0: 795f 7772 6974 652c 0a20 2020 2020 2020  y_write,.       
+000099f0: 2020 2020 2022 785f 7265 6164 223a 2078       "x_read": x
+00009a00: 5f72 6561 642c 0a20 2020 2020 2020 2020  _read,.         
+00009a10: 2020 2022 785f 7772 6974 6522 3a20 785f     "x_write": x_
+00009a20: 7772 6974 652c 0a20 2020 2020 2020 2020  write,.         
+00009a30: 2020 2022 785f 7265 6164 5f64 6973 6b22     "x_read_disk"
+00009a40: 3a20 785f 7265 6164 5f64 6973 6b2c 0a20  : x_read_disk,. 
+00009a50: 2020 2020 2020 2020 2020 2022 785f 7772             "x_wr
+00009a60: 6974 655f 6469 736b 223a 2078 5f77 7269  ite_disk": x_wri
+00009a70: 7465 5f64 6973 6b2c 0a20 2020 2020 2020  te_disk,.       
+00009a80: 207d 0a0a 2020 2020 2020 2020 7570 6461   }..        upda
+00009a90: 7465 2873 656c 662e 736f 7572 6365 2c20  te(self.source, 
+00009aa0: 7265 7375 6c74 290a 0a0a 636c 6173 7320  result)...class 
+00009ab0: 5379 7374 656d 5469 6d65 7365 7269 6573  SystemTimeseries
+00009ac0: 2844 6173 6862 6f61 7264 436f 6d70 6f6e  (DashboardCompon
+00009ad0: 656e 7429 3a0a 2020 2020 2222 2254 696d  ent):.    """Tim
+00009ae0: 6573 6572 6965 7320 666f 7220 776f 726b  eseries for work
+00009af0: 6572 206e 6574 776f 726b 2062 616e 6477  er network bandw
+00009b00: 6964 7468 2c20 6370 752c 206d 656d 6f72  idth, cpu, memor
+00009b10: 7920 616e 6420 6469 736b 2e0a 0a20 2020  y and disk...   
+00009b20: 2062 616e 6477 6964 7468 0a20 2020 2020   bandwidth.     
+00009b30: 2020 2050 6c6f 7473 2074 6865 2061 7665     Plots the ave
+00009b40: 7261 6765 206f 6620 686f 7374 5f6e 6574  rage of host_net
+00009b50: 5f69 6f2e 7265 6164 5f62 7073 2061 6e64  _io.read_bps and
+00009b60: 2068 6f73 745f 6e65 745f 696f 2e77 7269   host_net_io.wri
+00009b70: 7465 5f62 7073 2066 6f72 2074 6865 0a20  te_bps for the. 
+00009b80: 2020 2020 2020 2077 6f72 6b65 7273 2061         workers a
+00009b90: 7320 6120 6675 6e63 7469 6f6e 206f 6620  s a function of 
+00009ba0: 7469 6d65 0a20 2020 2063 7075 0a20 2020  time.    cpu.   
+00009bb0: 2020 2020 2050 6c6f 7473 2074 6865 2061       Plots the a
+00009bc0: 7665 7261 6765 206f 6620 6370 7520 666f  verage of cpu fo
+00009bd0: 7220 7468 6520 776f 726b 6572 7320 6173  r the workers as
+00009be0: 2061 2066 756e 6374 696f 6e20 6f66 2074   a function of t
+00009bf0: 696d 650a 2020 2020 6d65 6d6f 7279 0a20  ime.    memory. 
+00009c00: 2020 2020 2020 2050 6c6f 7473 2074 6865         Plots the
+00009c10: 2061 7665 7261 6765 206f 6620 6d65 6d6f   average of memo
+00009c20: 7279 2066 6f72 2074 6865 2077 6f72 6b65  ry for the worke
+00009c30: 7273 2061 7320 6120 6675 6e63 7469 6f6e  rs as a function
+00009c40: 206f 6620 7469 6d65 0a20 2020 2064 6973   of time.    dis
+00009c50: 6b0a 2020 2020 2020 2020 506c 6f74 7320  k.        Plots 
+00009c60: 7468 6520 6176 6572 6167 6520 6f66 2068  the average of h
+00009c70: 6f73 745f 6469 736b 5f69 6f2e 7265 6164  ost_disk_io.read
+00009c80: 5f62 7073 2061 6e64 2068 6f73 745f 6469  _bps and host_di
+00009c90: 736b 5f69 6f2e 7772 6974 655f 6270 7320  sk_io.write_bps 
+00009ca0: 666f 7220 7468 650a 2020 2020 2020 2020  for the.        
+00009cb0: 776f 726b 6572 7320 6173 2061 2066 756e  workers as a fun
+00009cc0: 6374 696f 6e20 6f66 2074 696d 650a 0a20  ction of time.. 
+00009cd0: 2020 2054 6865 206d 6574 7269 6373 2070     The metrics p
+00009ce0: 6c6f 7474 6564 2063 6f6d 6520 6672 6f6d  lotted come from
+00009cf0: 2074 6865 2061 6767 7265 6761 7469 6f6e   the aggregation
+00009d00: 206f 6620 6672 6f6d 2077 732e 6d65 7472   of from ws.metr
+00009d10: 6963 735b 6b65 795d 2066 6f72 2077 7320  ics[key] for ws 
+00009d20: 696e 0a20 2020 2073 6368 6564 756c 6572  in.    scheduler
+00009d30: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
+00009d40: 2920 6469 7669 6465 6420 6279 206e 756d  ) divided by num
+00009d50: 6265 7220 6f66 2077 6f72 6b65 7273 2e0a  ber of workers..
+00009d60: 2020 2020 2222 220a 0a20 2020 2040 6c6f      """..    @lo
+00009d70: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
+00009d80: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+00009d90: 7363 6865 6475 6c65 722c 2066 6f6c 6c6f  scheduler, follo
+00009da0: 775f 696e 7465 7276 616c 3d32 3030 3030  w_interval=20000
+00009db0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+00009dc0: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
+00009dd0: 6c65 7220 3d20 7363 6865 6475 6c65 720a  ler = scheduler.
+00009de0: 2020 2020 2020 2020 7365 6c66 2e73 6f75          self.sou
+00009df0: 7263 6520 3d20 436f 6c75 6d6e 4461 7461  rce = ColumnData
+00009e00: 536f 7572 6365 280a 2020 2020 2020 2020  Source(.        
+00009e10: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00009e20: 2020 2020 2020 2274 696d 6522 3a20 5b5d        "time": []
+00009e30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009e40: 2020 2268 6f73 745f 6e65 745f 696f 2e72    "host_net_io.r
+00009e50: 6561 645f 6270 7322 3a20 5b5d 2c0a 2020  ead_bps": [],.  
+00009e60: 2020 2020 2020 2020 2020 2020 2020 2268                "h
+00009e70: 6f73 745f 6e65 745f 696f 2e77 7269 7465  ost_net_io.write
+00009e80: 5f62 7073 223a 205b 5d2c 0a20 2020 2020  _bps": [],.     
+00009e90: 2020 2020 2020 2020 2020 2022 6370 7522             "cpu"
+00009ea0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+00009eb0: 2020 2020 2020 226d 656d 6f72 7922 3a20        "memory": 
+00009ec0: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+00009ed0: 2020 2020 2268 6f73 745f 6469 736b 5f69      "host_disk_i
+00009ee0: 6f2e 7265 6164 5f62 7073 223a 205b 5d2c  o.read_bps": [],
+00009ef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009f00: 2022 686f 7374 5f64 6973 6b5f 696f 2e77   "host_disk_io.w
+00009f10: 7269 7465 5f62 7073 223a 205b 5d2c 0a20  rite_bps": [],. 
+00009f20: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00009f30: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00009f40: 7570 6461 7465 2873 656c 662e 736f 7572  update(self.sour
+00009f50: 6365 2c20 7365 6c66 2e67 6574 5f64 6174  ce, self.get_dat
+00009f60: 6128 2929 0a0a 2020 2020 2020 2020 785f  a())..        x_
+00009f70: 7261 6e67 6520 3d20 4461 7461 5261 6e67  range = DataRang
+00009f80: 6531 6428 0a20 2020 2020 2020 2020 2020  e1d(.           
+00009f90: 2066 6f6c 6c6f 773d 2265 6e64 222c 2066   follow="end", f
+00009fa0: 6f6c 6c6f 775f 696e 7465 7276 616c 3d66  ollow_interval=f
+00009fb0: 6f6c 6c6f 775f 696e 7465 7276 616c 2c20  ollow_interval, 
+00009fc0: 7261 6e67 655f 7061 6464 696e 673d 300a  range_padding=0.
+00009fd0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00009fe0: 2020 746f 6f6c 7320 3d20 2272 6573 6574    tools = "reset
+00009ff0: 2c20 7870 616e 2c20 7877 6865 656c 5f7a  , xpan, xwheel_z
+0000a000: 6f6f 6d22 0a0a 2020 2020 2020 2020 7365  oom"..        se
+0000a010: 6c66 2e62 616e 6477 6964 7468 203d 2066  lf.bandwidth = f
+0000a020: 6967 7572 6528 0a20 2020 2020 2020 2020  igure(.         
+0000a030: 2020 2074 6974 6c65 3d22 576f 726b 6572     title="Worker
+0000a040: 204e 6574 776f 726b 2042 616e 6477 6964   Network Bandwid
+0000a050: 7468 2028 6176 6572 6167 6529 222c 0a20  th (average)",. 
+0000a060: 2020 2020 2020 2020 2020 2078 5f61 7869             x_axi
+0000a070: 735f 7479 7065 3d22 6461 7465 7469 6d65  s_type="datetime
+0000a080: 222c 0a20 2020 2020 2020 2020 2020 2074  ",.            t
+0000a090: 6f6f 6c73 3d74 6f6f 6c73 2c0a 2020 2020  ools=tools,.    
+0000a0a0: 2020 2020 2020 2020 785f 7261 6e67 653d          x_range=
+0000a0b0: 785f 7261 6e67 652c 0a20 2020 2020 2020  x_range,.       
+0000a0c0: 2020 2020 206e 616d 653d 2277 6f72 6b65       name="worke
+0000a0d0: 725f 6e65 7477 6f72 6b5f 6261 6e64 7769  r_network_bandwi
+0000a0e0: 6474 682d 7469 6d65 7365 7269 6573 222c  dth-timeseries",
+0000a0f0: 0a20 2020 2020 2020 2020 2020 202a 2a6b  .            **k
+0000a100: 7761 7267 732c 0a20 2020 2020 2020 2029  wargs,.        )
+0000a110: 0a0a 2020 2020 2020 2020 7365 6c66 2e62  ..        self.b
+0000a120: 616e 6477 6964 7468 2e6c 696e 6528 0a20  andwidth.line(. 
+0000a130: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
+0000a140: 653d 7365 6c66 2e73 6f75 7263 652c 0a20  e=self.source,. 
+0000a150: 2020 2020 2020 2020 2020 2078 3d22 7469             x="ti
+0000a160: 6d65 222c 0a20 2020 2020 2020 2020 2020  me",.           
+0000a170: 2079 3d22 686f 7374 5f6e 6574 5f69 6f2e   y="host_net_io.
+0000a180: 7265 6164 5f62 7073 222c 0a20 2020 2020  read_bps",.     
+0000a190: 2020 2020 2020 2063 6f6c 6f72 3d22 7265         color="re
+0000a1a0: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
+0000a1b0: 6c65 6765 6e64 5f6c 6162 656c 3d22 7265  legend_label="re
+0000a1c0: 6164 2028 6d65 616e 2922 2c0a 2020 2020  ad (mean)",.    
+0000a1d0: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+0000a1e0: 6c66 2e62 616e 6477 6964 7468 2e6c 696e  lf.bandwidth.lin
+0000a1f0: 6528 0a20 2020 2020 2020 2020 2020 2073  e(.            s
+0000a200: 6f75 7263 653d 7365 6c66 2e73 6f75 7263  ource=self.sourc
+0000a210: 652c 0a20 2020 2020 2020 2020 2020 2078  e,.            x
+0000a220: 3d22 7469 6d65 222c 0a20 2020 2020 2020  ="time",.       
+0000a230: 2020 2020 2079 3d22 686f 7374 5f6e 6574       y="host_net
+0000a240: 5f69 6f2e 7772 6974 655f 6270 7322 2c0a  _io.write_bps",.
+0000a250: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
+0000a260: 723d 2262 6c75 6522 2c0a 2020 2020 2020  r="blue",.      
+0000a270: 2020 2020 2020 6c65 6765 6e64 5f6c 6162        legend_lab
+0000a280: 656c 3d22 7772 6974 6520 286d 6561 6e29  el="write (mean)
+0000a290: 222c 0a20 2020 2020 2020 2029 0a0a 2020  ",.        )..  
+0000a2a0: 2020 2020 2020 7365 6c66 2e62 616e 6477        self.bandw
+0000a2b0: 6964 7468 2e6c 6567 656e 642e 6c6f 6361  idth.legend.loca
+0000a2c0: 7469 6f6e 203d 2022 746f 705f 6c65 6674  tion = "top_left
+0000a2d0: 220a 2020 2020 2020 2020 7365 6c66 2e62  ".        self.b
+0000a2e0: 616e 6477 6964 7468 2e79 6178 6973 2e61  andwidth.yaxis.a
+0000a2f0: 7869 735f 6c61 6265 6c20 3d20 2262 7974  xis_label = "byt
+0000a300: 6573 202f 2073 6563 6f6e 6422 0a20 2020  es / second".   
+0000a310: 2020 2020 2073 656c 662e 6261 6e64 7769       self.bandwi
+0000a320: 6474 682e 7961 7869 735b 305d 2e66 6f72  dth.yaxis[0].for
+0000a330: 6d61 7474 6572 203d 204e 756d 6572 616c  matter = Numeral
+0000a340: 5469 636b 466f 726d 6174 7465 7228 666f  TickFormatter(fo
+0000a350: 726d 6174 3d22 302e 3062 2229 0a20 2020  rmat="0.0b").   
+0000a360: 2020 2020 2073 656c 662e 6261 6e64 7769       self.bandwi
+0000a370: 6474 682e 795f 7261 6e67 652e 7374 6172  dth.y_range.star
+0000a380: 7420 3d20 300a 2020 2020 2020 2020 7365  t = 0.        se
+0000a390: 6c66 2e62 616e 6477 6964 7468 2e79 6178  lf.bandwidth.yax
+0000a3a0: 6973 2e6d 696e 6f72 5f74 6963 6b5f 6c69  is.minor_tick_li
+0000a3b0: 6e65 5f61 6c70 6861 203d 2030 0a20 2020  ne_alpha = 0.   
+0000a3c0: 2020 2020 2073 656c 662e 6261 6e64 7769       self.bandwi
+0000a3d0: 6474 682e 7867 7269 642e 7669 7369 626c  dth.xgrid.visibl
+0000a3e0: 6520 3d20 4661 6c73 650a 0a20 2020 2020  e = False..     
+0000a3f0: 2020 2073 656c 662e 6370 7520 3d20 6669     self.cpu = fi
+0000a400: 6775 7265 280a 2020 2020 2020 2020 2020  gure(.          
+0000a410: 2020 7469 746c 653d 2257 6f72 6b65 7220    title="Worker 
+0000a420: 4350 5520 5574 696c 697a 6174 696f 6e20  CPU Utilization 
+0000a430: 2861 7665 7261 6765 2922 2c0a 2020 2020  (average)",.    
+0000a440: 2020 2020 2020 2020 785f 6178 6973 5f74          x_axis_t
+0000a450: 7970 653d 2264 6174 6574 696d 6522 2c0a  ype="datetime",.
+0000a460: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
+0000a470: 733d 746f 6f6c 732c 0a20 2020 2020 2020  s=tools,.       
+0000a480: 2020 2020 2078 5f72 616e 6765 3d78 5f72       x_range=x_r
+0000a490: 616e 6765 2c0a 2020 2020 2020 2020 2020  ange,.          
+0000a4a0: 2020 6e61 6d65 3d22 776f 726b 6572 5f63    name="worker_c
+0000a4b0: 7075 2d74 696d 6573 6572 6965 7322 2c0a  pu-timeseries",.
+0000a4c0: 2020 2020 2020 2020 2020 2020 2a2a 6b77              **kw
+0000a4d0: 6172 6773 2c0a 2020 2020 2020 2020 290a  args,.        ).
+0000a4e0: 0a20 2020 2020 2020 2073 656c 662e 6370  .        self.cp
+0000a4f0: 752e 6c69 6e65 280a 2020 2020 2020 2020  u.line(.        
+0000a500: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
+0000a510: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
+0000a520: 2020 2020 783d 2274 696d 6522 2c0a 2020      x="time",.  
+0000a530: 2020 2020 2020 2020 2020 793d 2263 7075            y="cpu
+0000a540: 222c 0a20 2020 2020 2020 2029 0a20 2020  ",.        ).   
+0000a550: 2020 2020 2073 656c 662e 6370 752e 7961       self.cpu.ya
+0000a560: 7869 732e 6178 6973 5f6c 6162 656c 203d  xis.axis_label =
+0000a570: 2022 5574 696c 697a 6174 696f 6e22 0a20   "Utilization". 
+0000a580: 2020 2020 2020 2073 656c 662e 6370 752e         self.cpu.
+0000a590: 795f 7261 6e67 652e 7374 6172 7420 3d20  y_range.start = 
+0000a5a0: 300a 2020 2020 2020 2020 7365 6c66 2e63  0.        self.c
+0000a5b0: 7075 2e79 6178 6973 2e6d 696e 6f72 5f74  pu.yaxis.minor_t
+0000a5c0: 6963 6b5f 6c69 6e65 5f61 6c70 6861 203d  ick_line_alpha =
+0000a5d0: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
+0000a5e0: 6370 752e 7867 7269 642e 7669 7369 626c  cpu.xgrid.visibl
+0000a5f0: 6520 3d20 4661 6c73 650a 0a20 2020 2020  e = False..     
+0000a600: 2020 2073 656c 662e 6d65 6d6f 7279 203d     self.memory =
+0000a610: 2066 6967 7572 6528 0a20 2020 2020 2020   figure(.       
+0000a620: 2020 2020 2074 6974 6c65 3d22 576f 726b       title="Work
+0000a630: 6572 204d 656d 6f72 7920 5573 6520 2861  er Memory Use (a
+0000a640: 7665 7261 6765 2922 2c0a 2020 2020 2020  verage)",.      
+0000a650: 2020 2020 2020 785f 6178 6973 5f74 7970        x_axis_typ
+0000a660: 653d 2264 6174 6574 696d 6522 2c0a 2020  e="datetime",.  
+0000a670: 2020 2020 2020 2020 2020 746f 6f6c 733d            tools=
+0000a680: 746f 6f6c 732c 0a20 2020 2020 2020 2020  tools,.         
+0000a690: 2020 2078 5f72 616e 6765 3d78 5f72 616e     x_range=x_ran
+0000a6a0: 6765 2c0a 2020 2020 2020 2020 2020 2020  ge,.            
+0000a6b0: 6e61 6d65 3d22 776f 726b 6572 5f6d 656d  name="worker_mem
+0000a6c0: 6f72 792d 7469 6d65 7365 7269 6573 222c  ory-timeseries",
+0000a6d0: 0a20 2020 2020 2020 2020 2020 202a 2a6b  .            **k
+0000a6e0: 7761 7267 732c 0a20 2020 2020 2020 2029  wargs,.        )
+0000a6f0: 0a0a 2020 2020 2020 2020 7365 6c66 2e6d  ..        self.m
+0000a700: 656d 6f72 792e 6c69 6e65 280a 2020 2020  emory.line(.    
+0000a710: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
+0000a720: 656c 662e 736f 7572 6365 2c0a 2020 2020  elf.source,.    
+0000a730: 2020 2020 2020 2020 783d 2274 696d 6522          x="time"
+0000a740: 2c0a 2020 2020 2020 2020 2020 2020 793d  ,.            y=
+0000a750: 226d 656d 6f72 7922 2c0a 2020 2020 2020  "memory",.      
+0000a760: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+0000a770: 2e6d 656d 6f72 792e 7961 7869 732e 6178  .memory.yaxis.ax
+0000a780: 6973 5f6c 6162 656c 203d 2022 4279 7465  is_label = "Byte
+0000a790: 7322 0a20 2020 2020 2020 2073 656c 662e  s".        self.
+0000a7a0: 6d65 6d6f 7279 2e79 6178 6973 5b30 5d2e  memory.yaxis[0].
+0000a7b0: 666f 726d 6174 7465 7220 3d20 4e75 6d65  formatter = Nume
+0000a7c0: 7261 6c54 6963 6b46 6f72 6d61 7474 6572  ralTickFormatter
+0000a7d0: 2866 6f72 6d61 743d 2230 2e30 6222 290a  (format="0.0b").
+0000a7e0: 2020 2020 2020 2020 7365 6c66 2e6d 656d          self.mem
+0000a7f0: 6f72 792e 795f 7261 6e67 652e 7374 6172  ory.y_range.star
+0000a800: 7420 3d20 300a 2020 2020 2020 2020 7365  t = 0.        se
+0000a810: 6c66 2e6d 656d 6f72 792e 7961 7869 732e  lf.memory.yaxis.
+0000a820: 6d69 6e6f 725f 7469 636b 5f6c 696e 655f  minor_tick_line_
+0000a830: 616c 7068 6120 3d20 300a 2020 2020 2020  alpha = 0.      
+0000a840: 2020 7365 6c66 2e6d 656d 6f72 792e 7867    self.memory.xg
+0000a850: 7269 642e 7669 7369 626c 6520 3d20 4661  rid.visible = Fa
+0000a860: 6c73 650a 0a20 2020 2020 2020 2073 656c  lse..        sel
+0000a870: 662e 6469 736b 203d 2066 6967 7572 6528  f.disk = figure(
+0000a880: 0a20 2020 2020 2020 2020 2020 2074 6974  .            tit
+0000a890: 6c65 3d22 576f 726b 6572 2044 6973 6b20  le="Worker Disk 
+0000a8a0: 4261 6e64 7769 6474 6820 2861 7665 7261  Bandwidth (avera
+0000a8b0: 6765 2922 2c0a 2020 2020 2020 2020 2020  ge)",.          
+0000a8c0: 2020 785f 6178 6973 5f74 7970 653d 2264    x_axis_type="d
+0000a8d0: 6174 6574 696d 6522 2c0a 2020 2020 2020  atetime",.      
+0000a8e0: 2020 2020 2020 746f 6f6c 733d 746f 6f6c        tools=tool
+0000a8f0: 732c 0a20 2020 2020 2020 2020 2020 2078  s,.            x
+0000a900: 5f72 616e 6765 3d78 5f72 616e 6765 2c0a  _range=x_range,.
+0000a910: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+0000a920: 3d22 776f 726b 6572 5f64 6973 6b2d 7469  ="worker_disk-ti
+0000a930: 6d65 7365 7269 6573 222c 0a20 2020 2020  meseries",.     
+0000a940: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
+0000a950: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0000a960: 2020 2020 7365 6c66 2e64 6973 6b2e 6c69      self.disk.li
+0000a970: 6e65 280a 2020 2020 2020 2020 2020 2020  ne(.            
+0000a980: 736f 7572 6365 3d73 656c 662e 736f 7572  source=self.sour
+0000a990: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
+0000a9a0: 783d 2274 696d 6522 2c0a 2020 2020 2020  x="time",.      
+0000a9b0: 2020 2020 2020 793d 2268 6f73 745f 6469        y="host_di
+0000a9c0: 736b 5f69 6f2e 7265 6164 5f62 7073 222c  sk_io.read_bps",
+0000a9d0: 0a20 2020 2020 2020 2020 2020 2063 6f6c  .            col
+0000a9e0: 6f72 3d22 7265 6422 2c0a 2020 2020 2020  or="red",.      
+0000a9f0: 2020 2020 2020 6c65 6765 6e64 5f6c 6162        legend_lab
+0000aa00: 656c 3d22 7265 6164 2028 6d65 616e 2922  el="read (mean)"
+0000aa10: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+0000aa20: 2020 2020 7365 6c66 2e64 6973 6b2e 6c69      self.disk.li
+0000aa30: 6e65 280a 2020 2020 2020 2020 2020 2020  ne(.            
+0000aa40: 736f 7572 6365 3d73 656c 662e 736f 7572  source=self.sour
+0000aa50: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
+0000aa60: 783d 2274 696d 6522 2c0a 2020 2020 2020  x="time",.      
+0000aa70: 2020 2020 2020 793d 2268 6f73 745f 6469        y="host_di
+0000aa80: 736b 5f69 6f2e 7772 6974 655f 6270 7322  sk_io.write_bps"
+0000aa90: 2c0a 2020 2020 2020 2020 2020 2020 636f  ,.            co
+0000aaa0: 6c6f 723d 2262 6c75 6522 2c0a 2020 2020  lor="blue",.    
+0000aab0: 2020 2020 2020 2020 6c65 6765 6e64 5f6c          legend_l
+0000aac0: 6162 656c 3d22 7772 6974 6520 286d 6561  abel="write (mea
+0000aad0: 6e29 222c 0a20 2020 2020 2020 2029 0a0a  n)",.        )..
+0000aae0: 2020 2020 2020 2020 7365 6c66 2e64 6973          self.dis
+0000aaf0: 6b2e 6c65 6765 6e64 2e6c 6f63 6174 696f  k.legend.locatio
+0000ab00: 6e20 3d20 2274 6f70 5f6c 6566 7422 0a20  n = "top_left". 
+0000ab10: 2020 2020 2020 2073 656c 662e 6469 736b         self.disk
+0000ab20: 2e79 6178 6973 2e61 7869 735f 6c61 6265  .yaxis.axis_labe
+0000ab30: 6c20 3d20 2262 7974 6573 202f 2073 6563  l = "bytes / sec
+0000ab40: 6f6e 6422 0a20 2020 2020 2020 2073 656c  ond".        sel
+0000ab50: 662e 6469 736b 2e79 6178 6973 5b30 5d2e  f.disk.yaxis[0].
+0000ab60: 666f 726d 6174 7465 7220 3d20 4e75 6d65  formatter = Nume
+0000ab70: 7261 6c54 6963 6b46 6f72 6d61 7474 6572  ralTickFormatter
+0000ab80: 2866 6f72 6d61 743d 2230 2e30 6222 290a  (format="0.0b").
+0000ab90: 2020 2020 2020 2020 7365 6c66 2e64 6973          self.dis
+0000aba0: 6b2e 795f 7261 6e67 652e 7374 6172 7420  k.y_range.start 
+0000abb0: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
+0000abc0: 2e64 6973 6b2e 7961 7869 732e 6d69 6e6f  .disk.yaxis.mino
+0000abd0: 725f 7469 636b 5f6c 696e 655f 616c 7068  r_tick_line_alph
+0000abe0: 6120 3d20 300a 2020 2020 2020 2020 7365  a = 0.        se
+0000abf0: 6c66 2e64 6973 6b2e 7867 7269 642e 7669  lf.disk.xgrid.vi
+0000ac00: 7369 626c 6520 3d20 4661 6c73 650a 0a20  sible = False.. 
+0000ac10: 2020 2064 6566 2067 6574 5f64 6174 6128     def get_data(
+0000ac20: 7365 6c66 293a 0a20 2020 2020 2020 2077  self):.        w
+0000ac30: 6f72 6b65 7273 203d 2073 656c 662e 7363  orkers = self.sc
+0000ac40: 6865 6475 6c65 722e 776f 726b 6572 732e  heduler.workers.
+0000ac50: 7661 6c75 6573 2829 0a0a 2020 2020 2020  values()..      
+0000ac60: 2020 6e65 745f 7265 6164 5f62 7073 203d    net_read_bps =
+0000ac70: 2030 0a20 2020 2020 2020 206e 6574 5f77   0.        net_w
+0000ac80: 7269 7465 5f62 7073 203d 2030 0a20 2020  rite_bps = 0.   
+0000ac90: 2020 2020 2063 7075 203d 2030 0a20 2020       cpu = 0.   
+0000aca0: 2020 2020 206d 656d 6f72 7920 3d20 300a       memory = 0.
+0000acb0: 2020 2020 2020 2020 6469 736b 5f72 6561          disk_rea
+0000acc0: 645f 6270 7320 3d20 300a 2020 2020 2020  d_bps = 0.      
+0000acd0: 2020 6469 736b 5f77 7269 7465 5f62 7073    disk_write_bps
+0000ace0: 203d 2030 0a20 2020 2020 2020 2074 696d   = 0.        tim
+0000acf0: 6520 3d20 300a 2020 2020 2020 2020 666f  e = 0.        fo
+0000ad00: 7220 7773 2069 6e20 776f 726b 6572 733a  r ws in workers:
+0000ad10: 0a20 2020 2020 2020 2020 2020 206e 6574  .            net
+0000ad20: 5f72 6561 645f 6270 7320 2b3d 2077 732e  _read_bps += ws.
+0000ad30: 6d65 7472 6963 735b 2268 6f73 745f 6e65  metrics["host_ne
+0000ad40: 745f 696f 225d 5b22 7265 6164 5f62 7073  t_io"]["read_bps
+0000ad50: 225d 0a20 2020 2020 2020 2020 2020 206e  "].            n
+0000ad60: 6574 5f77 7269 7465 5f62 7073 202b 3d20  et_write_bps += 
+0000ad70: 7773 2e6d 6574 7269 6373 5b22 686f 7374  ws.metrics["host
+0000ad80: 5f6e 6574 5f69 6f22 5d5b 2277 7269 7465  _net_io"]["write
+0000ad90: 5f62 7073 225d 0a20 2020 2020 2020 2020  _bps"].         
+0000ada0: 2020 2063 7075 202b 3d20 7773 2e6d 6574     cpu += ws.met
+0000adb0: 7269 6373 5b22 6370 7522 5d0a 2020 2020  rics["cpu"].    
+0000adc0: 2020 2020 2020 2020 6d65 6d6f 7279 202b          memory +
+0000add0: 3d20 7773 2e6d 6574 7269 6373 5b22 6d65  = ws.metrics["me
+0000ade0: 6d6f 7279 225d 0a20 2020 2020 2020 2020  mory"].         
+0000adf0: 2020 2064 6973 6b5f 7265 6164 5f62 7073     disk_read_bps
+0000ae00: 202b 3d20 7773 2e6d 6574 7269 6373 2e67   += ws.metrics.g
+0000ae10: 6574 2822 686f 7374 5f64 6973 6b5f 696f  et("host_disk_io
+0000ae20: 222c 207b 7d29 2e67 6574 2822 7265 6164  ", {}).get("read
+0000ae30: 5f62 7073 222c 2030 290a 2020 2020 2020  _bps", 0).      
+0000ae40: 2020 2020 2020 6469 736b 5f77 7269 7465        disk_write
+0000ae50: 5f62 7073 202b 3d20 7773 2e6d 6574 7269  _bps += ws.metri
+0000ae60: 6373 2e67 6574 2822 686f 7374 5f64 6973  cs.get("host_dis
+0000ae70: 6b5f 696f 222c 207b 7d29 2e67 6574 2822  k_io", {}).get("
+0000ae80: 7772 6974 655f 6270 7322 2c20 3029 0a20  write_bps", 0). 
+0000ae90: 2020 2020 2020 2020 2020 2074 696d 6520             time 
+0000aea0: 2b3d 2077 732e 6d65 7472 6963 735b 2274  += ws.metrics["t
+0000aeb0: 696d 6522 5d0a 0a20 2020 2020 2020 2072  ime"]..        r
+0000aec0: 6573 756c 7420 3d20 7b0a 2020 2020 2020  esult = {.      
+0000aed0: 2020 2020 2020 2320 7573 6520 606f 7260        # use `or`
+0000aee0: 2074 6f20 6176 6f69 6420 5a65 726f 4469   to avoid ZeroDi
+0000aef0: 7669 7369 6f6e 2077 6865 6e20 6e6f 2077  vision when no w
+0000af00: 6f72 6b65 7273 0a20 2020 2020 2020 2020  orkers.         
+0000af10: 2020 2022 7469 6d65 223a 205b 7469 6d65     "time": [time
+0000af20: 202f 2028 6c65 6e28 776f 726b 6572 7329   / (len(workers)
+0000af30: 206f 7220 3129 202a 2031 3030 305d 2c0a   or 1) * 1000],.
+0000af40: 2020 2020 2020 2020 2020 2020 2268 6f73              "hos
+0000af50: 745f 6e65 745f 696f 2e72 6561 645f 6270  t_net_io.read_bp
+0000af60: 7322 3a20 5b6e 6574 5f72 6561 645f 6270  s": [net_read_bp
+0000af70: 7320 2f20 286c 656e 2877 6f72 6b65 7273  s / (len(workers
+0000af80: 2920 6f72 2031 295d 2c0a 2020 2020 2020  ) or 1)],.      
+0000af90: 2020 2020 2020 2268 6f73 745f 6e65 745f        "host_net_
+0000afa0: 696f 2e77 7269 7465 5f62 7073 223a 205b  io.write_bps": [
+0000afb0: 6e65 745f 7772 6974 655f 6270 7320 2f20  net_write_bps / 
+0000afc0: 286c 656e 2877 6f72 6b65 7273 2920 6f72  (len(workers) or
+0000afd0: 2031 295d 2c0a 2020 2020 2020 2020 2020   1)],.          
+0000afe0: 2020 2263 7075 223a 205b 6370 7520 2f20    "cpu": [cpu / 
+0000aff0: 286c 656e 2877 6f72 6b65 7273 2920 6f72  (len(workers) or
+0000b000: 2031 295d 2c0a 2020 2020 2020 2020 2020   1)],.          
+0000b010: 2020 226d 656d 6f72 7922 3a20 5b6d 656d    "memory": [mem
+0000b020: 6f72 7920 2f20 286c 656e 2877 6f72 6b65  ory / (len(worke
+0000b030: 7273 2920 6f72 2031 295d 2c0a 2020 2020  rs) or 1)],.    
+0000b040: 2020 2020 2020 2020 2268 6f73 745f 6469          "host_di
+0000b050: 736b 5f69 6f2e 7265 6164 5f62 7073 223a  sk_io.read_bps":
+0000b060: 205b 6469 736b 5f72 6561 645f 6270 7320   [disk_read_bps 
+0000b070: 2f20 286c 656e 2877 6f72 6b65 7273 2920  / (len(workers) 
+0000b080: 6f72 2031 295d 2c0a 2020 2020 2020 2020  or 1)],.        
+0000b090: 2020 2020 2268 6f73 745f 6469 736b 5f69      "host_disk_i
+0000b0a0: 6f2e 7772 6974 655f 6270 7322 3a20 5b64  o.write_bps": [d
+0000b0b0: 6973 6b5f 7772 6974 655f 6270 7320 2f20  isk_write_bps / 
+0000b0c0: 286c 656e 2877 6f72 6b65 7273 2920 6f72  (len(workers) or
+0000b0d0: 2031 295d 2c0a 2020 2020 2020 2020 7d0a   1)],.        }.
+0000b0e0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+0000b0f0: 6573 756c 740a 0a20 2020 2040 7769 7468  esult..    @with
+0000b100: 6f75 745f 7072 6f70 6572 7479 5f76 616c  out_property_val
+0000b110: 6964 6174 696f 6e0a 2020 2020 406c 6f67  idation.    @log
+0000b120: 5f65 7272 6f72 730a 2020 2020 6465 6620  _errors.    def 
+0000b130: 7570 6461 7465 2873 656c 6629 3a0a 2020  update(self):.  
+0000b140: 2020 2020 2020 7365 6c66 2e73 6f75 7263        self.sourc
+0000b150: 652e 7374 7265 616d 2873 656c 662e 6765  e.stream(self.ge
+0000b160: 745f 6461 7461 2829 2c20 3130 3030 290a  t_data(), 1000).
+0000b170: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0000b180: 2e73 6368 6564 756c 6572 2e77 6f72 6b65  .scheduler.worke
+0000b190: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
+0000b1a0: 795f 656e 645f 6370 7520 3d20 7375 6d28  y_end_cpu = sum(
+0000b1b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b1c0: 2077 732e 6e74 6872 6561 6473 206f 7220   ws.nthreads or 
+0000b1d0: 3120 666f 7220 7773 2069 6e20 7365 6c66  1 for ws in self
+0000b1e0: 2e73 6368 6564 756c 6572 2e77 6f72 6b65  .scheduler.worke
+0000b1f0: 7273 2e76 616c 7565 7328 290a 2020 2020  rs.values().    
+0000b200: 2020 2020 2020 2020 2920 2f20 6c65 6e28          ) / len(
+0000b210: 7365 6c66 2e73 6368 6564 756c 6572 2e77  self.scheduler.w
+0000b220: 6f72 6b65 7273 2e76 616c 7565 7328 2929  orkers.values())
+0000b230: 0a20 2020 2020 2020 2020 2020 2079 5f65  .            y_e
+0000b240: 6e64 5f6d 656d 203d 2073 756d 280a 2020  nd_mem = sum(.  
+0000b250: 2020 2020 2020 2020 2020 2020 2020 7773                ws
+0000b260: 2e6d 656d 6f72 795f 6c69 6d69 7420 666f  .memory_limit fo
+0000b270: 7220 7773 2069 6e20 7365 6c66 2e73 6368  r ws in self.sch
+0000b280: 6564 756c 6572 2e77 6f72 6b65 7273 2e76  eduler.workers.v
+0000b290: 616c 7565 7328 290a 2020 2020 2020 2020  alues().        
+0000b2a0: 2020 2020 2920 2f20 6c65 6e28 7365 6c66      ) / len(self
+0000b2b0: 2e73 6368 6564 756c 6572 2e77 6f72 6b65  .scheduler.worke
+0000b2c0: 7273 2e76 616c 7565 7328 2929 0a20 2020  rs.values()).   
+0000b2d0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000b2e0: 2020 2020 2020 2079 5f65 6e64 5f63 7075         y_end_cpu
+0000b2f0: 203d 2031 0a20 2020 2020 2020 2020 2020   = 1.           
+0000b300: 2079 5f65 6e64 5f6d 656d 203d 2031 3030   y_end_mem = 100
+0000b310: 5f30 3030 5f30 3030 0a0a 2020 2020 2020  _000_000..      
+0000b320: 2020 7365 6c66 2e63 7075 2e79 5f72 616e    self.cpu.y_ran
+0000b330: 6765 2e65 6e64 203d 2079 5f65 6e64 5f63  ge.end = y_end_c
+0000b340: 7075 202a 2031 3030 0a20 2020 2020 2020  pu * 100.       
+0000b350: 2073 656c 662e 6d65 6d6f 7279 2e79 5f72   self.memory.y_r
+0000b360: 616e 6765 2e65 6e64 203d 2079 5f65 6e64  ange.end = y_end
+0000b370: 5f6d 656d 0a0a 0a63 6c61 7373 2043 6f6d  _mem...class Com
+0000b380: 7075 7465 5065 724b 6579 2844 6173 6862  putePerKey(Dashb
+0000b390: 6f61 7264 436f 6d70 6f6e 656e 7429 3a0a  oardComponent):.
+0000b3a0: 2020 2020 2222 2242 6172 2063 6861 7274      """Bar chart
+0000b3b0: 2073 686f 7769 6e67 2074 696d 6520 7370   showing time sp
+0000b3c0: 656e 6420 696e 2061 6374 696f 6e20 6279  end in action by
+0000b3d0: 206b 6579 2070 7265 6669 7822 2222 0a0a   key prefix"""..
+0000b3e0: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
+0000b3f0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+0000b400: 2873 656c 662c 2073 6368 6564 756c 6572  (self, scheduler
+0000b410: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+0000b420: 2020 2020 2073 656c 662e 6c61 7374 203d       self.last =
+0000b430: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
+0000b440: 7363 6865 6475 6c65 7220 3d20 7363 6865  scheduler = sche
+0000b450: 6475 6c65 720a 0a20 2020 2020 2020 2069  duler..        i
+0000b460: 6620 5461 736b 5374 7265 616d 506c 7567  f TaskStreamPlug
+0000b470: 696e 2e6e 616d 6520 6e6f 7420 696e 2073  in.name not in s
+0000b480: 656c 662e 7363 6865 6475 6c65 722e 706c  elf.scheduler.pl
+0000b490: 7567 696e 733a 0a20 2020 2020 2020 2020  ugins:.         
+0000b4a0: 2020 2073 656c 662e 7363 6865 6475 6c65     self.schedule
+0000b4b0: 722e 6164 645f 706c 7567 696e 2854 6173  r.add_plugin(Tas
+0000b4c0: 6b53 7472 6561 6d50 6c75 6769 6e28 7365  kStreamPlugin(se
+0000b4d0: 6c66 2e73 6368 6564 756c 6572 2929 0a0a  lf.scheduler))..
+0000b4e0: 2020 2020 2020 2020 636f 6d70 7574 655f          compute_
+0000b4f0: 6461 7461 203d 207b 0a20 2020 2020 2020  data = {.       
+0000b500: 2020 2020 2022 7469 6d65 7322 3a20 5b30       "times": [0
+0000b510: 2e32 2c20 302e 315d 2c0a 2020 2020 2020  .2, 0.1],.      
+0000b520: 2020 2020 2020 2266 6f72 6d61 7474 6564        "formatted
+0000b530: 5f74 696d 6522 3a20 5b22 302e 3220 6d73  _time": ["0.2 ms
+0000b540: 222c 2022 322e 3820 7573 225d 2c0a 2020  ", "2.8 us"],.  
+0000b550: 2020 2020 2020 2020 2020 2261 6e67 6c65            "angle
+0000b560: 7322 3a20 5b33 2e31 342c 2030 2e37 3835  s": [3.14, 0.785
+0000b570: 5d2c 0a20 2020 2020 2020 2020 2020 2022  ],.            "
+0000b580: 636f 6c6f 7222 3a20 5b74 735f 636f 6c6f  color": [ts_colo
+0000b590: 725f 6c6f 6f6b 7570 5b22 7472 616e 7366  r_lookup["transf
+0000b5a0: 6572 225d 2c20 7473 5f63 6f6c 6f72 5f6c  er"], ts_color_l
+0000b5b0: 6f6f 6b75 705b 2263 6f6d 7075 7465 225d  ookup["compute"]
+0000b5c0: 5d2c 0a20 2020 2020 2020 2020 2020 2022  ],.            "
+0000b5d0: 6e61 6d65 7322 3a20 5b22 7375 6d22 2c20  names": ["sum", 
+0000b5e0: 2273 756d 5f70 6172 7469 616c 225d 2c0a  "sum_partial"],.
+0000b5f0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+0000b600: 2020 2073 656c 662e 636f 6d70 7574 655f     self.compute_
+0000b610: 736f 7572 6365 203d 2043 6f6c 756d 6e44  source = ColumnD
+0000b620: 6174 6153 6f75 7263 6528 6461 7461 3d63  ataSource(data=c
+0000b630: 6f6d 7075 7465 5f64 6174 6129 0a0a 2020  ompute_data)..  
+0000b640: 2020 2020 2020 6669 6720 3d20 6669 6775        fig = figu
+0000b650: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
+0000b660: 7469 746c 653d 2243 6f6d 7075 7465 2054  title="Compute T
+0000b670: 696d 6520 5065 7220 5461 736b 222c 0a20  ime Per Task",. 
+0000b680: 2020 2020 2020 2020 2020 2074 6f6f 6c73             tools
+0000b690: 3d22 222c 0a20 2020 2020 2020 2020 2020  ="",.           
+0000b6a0: 206e 616d 653d 2263 6f6d 7075 7465 5f74   name="compute_t
+0000b6b0: 696d 655f 7065 725f 6b65 7922 2c0a 2020  ime_per_key",.  
+0000b6c0: 2020 2020 2020 2020 2020 785f 7261 6e67            x_rang
+0000b6d0: 653d 5b22 6122 2c20 2262 225d 2c0a 2020  e=["a", "b"],.  
+0000b6e0: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
+0000b6f0: 6773 2c0a 2020 2020 2020 2020 290a 0a20  gs,.        ).. 
+0000b700: 2020 2020 2020 2072 6563 7420 3d20 6669         rect = fi
+0000b710: 672e 7662 6172 280a 2020 2020 2020 2020  g.vbar(.        
+0000b720: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
+0000b730: 636f 6d70 7574 655f 736f 7572 6365 2c0a  compute_source,.
+0000b740: 2020 2020 2020 2020 2020 2020 783d 226e              x="n
+0000b750: 616d 6573 222c 0a20 2020 2020 2020 2020  ames",.         
+0000b760: 2020 2074 6f70 3d22 7469 6d65 7322 2c0a     top="times",.
+0000b770: 2020 2020 2020 2020 2020 2020 7769 6474              widt
+0000b780: 683d 302e 372c 0a20 2020 2020 2020 2020  h=0.7,.         
+0000b790: 2020 2063 6f6c 6f72 3d22 636f 6c6f 7222     color="color"
+0000b7a0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+0000b7b0: 2020 2020 2066 6967 2e79 5f72 616e 6765       fig.y_range
+0000b7c0: 2e73 7461 7274 203d 2030 0a20 2020 2020  .start = 0.     
+0000b7d0: 2020 2066 6967 2e79 6178 6973 2e61 7869     fig.yaxis.axi
+0000b7e0: 735f 6c61 6265 6c20 3d20 2254 696d 6520  s_label = "Time 
+0000b7f0: 2873 2922 0a20 2020 2020 2020 2066 6967  (s)".        fig
+0000b800: 2e79 6178 6973 5b30 5d2e 666f 726d 6174  .yaxis[0].format
+0000b810: 7465 7220 3d20 4e75 6d65 7261 6c54 6963  ter = NumeralTic
+0000b820: 6b46 6f72 6d61 7474 6572 2866 6f72 6d61  kFormatter(forma
+0000b830: 743d 2230 2229 0a20 2020 2020 2020 2066  t="0").        f
+0000b840: 6967 2e79 6178 6973 2e74 6963 6b65 7220  ig.yaxis.ticker 
+0000b850: 3d20 4164 6170 7469 7665 5469 636b 6572  = AdaptiveTicker
+0000b860: 282a 2a54 4943 4b53 5f31 3032 3429 0a20  (**TICKS_1024). 
+0000b870: 2020 2020 2020 2066 6967 2e78 6178 6973         fig.xaxis
+0000b880: 2e6d 616a 6f72 5f6c 6162 656c 5f6f 7269  .major_label_ori
+0000b890: 656e 7461 7469 6f6e 203d 2058 4c41 4245  entation = XLABE
+0000b8a0: 4c5f 4f52 4945 4e54 4154 494f 4e0a 2020  L_ORIENTATION.  
+0000b8b0: 2020 2020 2020 7265 6374 2e6e 6f6e 7365        rect.nonse
+0000b8c0: 6c65 6374 696f 6e5f 676c 7970 6820 3d20  lection_glyph = 
+0000b8d0: 4e6f 6e65 0a0a 2020 2020 2020 2020 6669  None..        fi
+0000b8e0: 672e 7861 7869 732e 6d69 6e6f 725f 7469  g.xaxis.minor_ti
+0000b8f0: 636b 5f6c 696e 655f 616c 7068 6120 3d20  ck_line_alpha = 
+0000b900: 300a 2020 2020 2020 2020 6669 672e 7867  0.        fig.xg
+0000b910: 7269 642e 7669 7369 626c 6520 3d20 4661  rid.visible = Fa
+0000b920: 6c73 650a 0a20 2020 2020 2020 2066 6967  lse..        fig
+0000b930: 2e74 6f6f 6c62 6172 5f6c 6f63 6174 696f  .toolbar_locatio
+0000b940: 6e20 3d20 4e6f 6e65 0a0a 2020 2020 2020  n = None..      
+0000b950: 2020 686f 7665 7220 3d20 486f 7665 7254    hover = HoverT
+0000b960: 6f6f 6c28 290a 2020 2020 2020 2020 686f  ool().        ho
+0000b970: 7665 722e 746f 6f6c 7469 7073 203d 2022  ver.tooltips = "
+0000b980: 2222 0a20 2020 2020 2020 2020 2020 203c  "".            <
+0000b990: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
+0000b9a0: 2020 2020 203c 703e 3c62 3e4e 616d 653a       <p><b>Name:
+0000b9b0: 3c2f 623e 2040 6e61 6d65 733c 2f70 3e0a  </b> @names</p>.
+0000b9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b9d0: 3c70 3e3c 623e 5469 6d65 3a3c 2f62 3e20  <p><b>Time:</b> 
+0000b9e0: 4066 6f72 6d61 7474 6564 5f74 696d 653c  @formatted_time<
+0000b9f0: 2f70 3e0a 2020 2020 2020 2020 2020 2020  /p>.            
+0000ba00: 3c2f 6469 763e 0a20 2020 2020 2020 2020  </div>.         
+0000ba10: 2020 2022 2222 0a20 2020 2020 2020 2068     """.        h
+0000ba20: 6f76 6572 2e70 6f69 6e74 5f70 6f6c 6963  over.point_polic
+0000ba30: 7920 3d20 2266 6f6c 6c6f 775f 6d6f 7573  y = "follow_mous
+0000ba40: 6522 0a20 2020 2020 2020 2066 6967 2e61  e".        fig.a
+0000ba50: 6464 5f74 6f6f 6c73 2868 6f76 6572 290a  dd_tools(hover).
+0000ba60: 0a20 2020 2020 2020 2066 6967 2e61 6464  .        fig.add
+0000ba70: 5f6c 6179 6f75 7428 0a20 2020 2020 2020  _layout(.       
+0000ba80: 2020 2020 2054 6974 6c65 280a 2020 2020       Title(.    
+0000ba90: 2020 2020 2020 2020 2020 2020 7465 7874              text
+0000baa0: 3d22 4e6f 7465 3a20 7461 736b 7320 6c65  ="Note: tasks le
+0000bab0: 7373 2074 6861 6e20 3225 206f 6620 6d61  ss than 2% of ma
+0000bac0: 7820 6172 6520 6e6f 7420 6469 7370 6c61  x are not displa
+0000bad0: 7965 6422 2c0a 2020 2020 2020 2020 2020  yed",.          
+0000bae0: 2020 2020 2020 7465 7874 5f66 6f6e 745f        text_font_
+0000baf0: 7374 796c 653d 2269 7461 6c69 6322 2c0a  style="italic",.
+0000bb00: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
+0000bb10: 2020 2020 2020 2020 2020 2022 6265 6c6f             "belo
+0000bb20: 7722 2c0a 2020 2020 2020 2020 290a 0a20  w",.        ).. 
+0000bb30: 2020 2020 2020 2073 656c 662e 6669 6720         self.fig 
+0000bb40: 3d20 6669 670a 2020 2020 2020 2020 7461  = fig.        ta
+0000bb50: 6231 203d 2054 6162 5061 6e65 6c28 6368  b1 = TabPanel(ch
+0000bb60: 696c 643d 6669 672c 2074 6974 6c65 3d22  ild=fig, title="
+0000bb70: 4261 7220 4368 6172 7422 290a 0a20 2020  Bar Chart")..   
+0000bb80: 2020 2020 2066 6967 3220 3d20 6669 6775       fig2 = figu
+0000bb90: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
+0000bba0: 7469 746c 653d 2243 6f6d 7075 7465 2054  title="Compute T
+0000bbb0: 696d 6520 5065 7220 5461 736b 222c 0a20  ime Per Task",. 
+0000bbc0: 2020 2020 2020 2020 2020 2074 6f6f 6c73             tools
+0000bbd0: 3d22 222c 0a20 2020 2020 2020 2020 2020  ="",.           
+0000bbe0: 206e 616d 653d 2263 6f6d 7075 7465 5f74   name="compute_t
+0000bbf0: 696d 655f 7065 725f 6b65 792d 7069 6522  ime_per_key-pie"
+0000bc00: 2c0a 2020 2020 2020 2020 2020 2020 785f  ,.            x_
+0000bc10: 7261 6e67 653d 282d 302e 352c 2031 2e30  range=(-0.5, 1.0
+0000bc20: 292c 0a20 2020 2020 2020 2020 2020 202a  ),.            *
+0000bc30: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
+0000bc40: 2029 0a0a 2020 2020 2020 2020 6669 6732   )..        fig2
+0000bc50: 2e77 6564 6765 280a 2020 2020 2020 2020  .wedge(.        
+0000bc60: 2020 2020 783d 302c 0a20 2020 2020 2020      x=0,.       
+0000bc70: 2020 2020 2079 3d31 2c0a 2020 2020 2020       y=1,.      
+0000bc80: 2020 2020 2020 7261 6469 7573 3d30 2e34        radius=0.4
+0000bc90: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
+0000bca0: 6172 745f 616e 676c 653d 6375 6d73 756d  art_angle=cumsum
+0000bcb0: 2822 616e 676c 6573 222c 2069 6e63 6c75  ("angles", inclu
+0000bcc0: 6465 5f7a 6572 6f3d 5472 7565 292c 0a20  de_zero=True),. 
+0000bcd0: 2020 2020 2020 2020 2020 2065 6e64 5f61             end_a
+0000bce0: 6e67 6c65 3d63 756d 7375 6d28 2261 6e67  ngle=cumsum("ang
+0000bcf0: 6c65 7322 292c 0a20 2020 2020 2020 2020  les"),.         
+0000bd00: 2020 206c 696e 655f 636f 6c6f 723d 2277     line_color="w
+0000bd10: 6869 7465 222c 0a20 2020 2020 2020 2020  hite",.         
+0000bd20: 2020 2066 696c 6c5f 636f 6c6f 723d 2263     fill_color="c
+0000bd30: 6f6c 6f72 222c 0a20 2020 2020 2020 2020  olor",.         
+0000bd40: 2020 206c 6567 656e 645f 6669 656c 643d     legend_field=
+0000bd50: 226e 616d 6573 222c 0a20 2020 2020 2020  "names",.       
+0000bd60: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
+0000bd70: 2e63 6f6d 7075 7465 5f73 6f75 7263 652c  .compute_source,
+0000bd80: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0000bd90: 2020 2020 6669 6732 2e61 7869 732e 6178      fig2.axis.ax
+0000bda0: 6973 5f6c 6162 656c 203d 204e 6f6e 650a  is_label = None.
+0000bdb0: 2020 2020 2020 2020 6669 6732 2e61 7869          fig2.axi
+0000bdc0: 732e 7669 7369 626c 6520 3d20 4661 6c73  s.visible = Fals
+0000bdd0: 650a 2020 2020 2020 2020 6669 6732 2e67  e.        fig2.g
+0000bde0: 7269 642e 6772 6964 5f6c 696e 655f 636f  rid.grid_line_co
+0000bdf0: 6c6f 7220 3d20 4e6f 6e65 0a20 2020 2020  lor = None.     
+0000be00: 2020 2066 6967 322e 6164 645f 6c61 796f     fig2.add_layo
+0000be10: 7574 280a 2020 2020 2020 2020 2020 2020  ut(.            
+0000be20: 5469 746c 6528 0a20 2020 2020 2020 2020  Title(.         
+0000be30: 2020 2020 2020 2074 6578 743d 224e 6f74         text="Not
+0000be40: 653a 2074 6173 6b73 206c 6573 7320 7468  e: tasks less th
+0000be50: 616e 2032 2520 6f66 206d 6178 2061 7265  an 2% of max are
+0000be60: 206e 6f74 2064 6973 706c 6179 6564 222c   not displayed",
+0000be70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000be80: 2074 6578 745f 666f 6e74 5f73 7479 6c65   text_font_style
+0000be90: 3d22 6974 616c 6963 222c 0a20 2020 2020  ="italic",.     
+0000bea0: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
+0000beb0: 2020 2020 2020 2262 656c 6f77 222c 0a20        "below",. 
+0000bec0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0000bed0: 2020 686f 7665 7220 3d20 486f 7665 7254    hover = HoverT
+0000bee0: 6f6f 6c28 290a 2020 2020 2020 2020 686f  ool().        ho
+0000bef0: 7665 722e 746f 6f6c 7469 7073 203d 2022  ver.tooltips = "
+0000bf00: 2222 0a20 2020 2020 2020 2020 2020 203c  "".            <
+0000bf10: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
+0000bf20: 2020 2020 203c 703e 3c62 3e4e 616d 653a       <p><b>Name:
+0000bf30: 3c2f 623e 2040 6e61 6d65 733c 2f70 3e0a  </b> @names</p>.
+0000bf40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bf50: 3c70 3e3c 623e 5469 6d65 3a3c 2f62 3e20  <p><b>Time:</b> 
+0000bf60: 4066 6f72 6d61 7474 6564 5f74 696d 653c  @formatted_time<
+0000bf70: 2f70 3e0a 2020 2020 2020 2020 2020 2020  /p>.            
+0000bf80: 3c2f 6469 763e 0a20 2020 2020 2020 2020  </div>.         
+0000bf90: 2020 2022 2222 0a20 2020 2020 2020 2068     """.        h
+0000bfa0: 6f76 6572 2e70 6f69 6e74 5f70 6f6c 6963  over.point_polic
+0000bfb0: 7920 3d20 2266 6f6c 6c6f 775f 6d6f 7573  y = "follow_mous
+0000bfc0: 6522 0a20 2020 2020 2020 2066 6967 322e  e".        fig2.
+0000bfd0: 6164 645f 746f 6f6c 7328 686f 7665 7229  add_tools(hover)
+0000bfe0: 0a20 2020 2020 2020 2073 656c 662e 7765  .        self.we
+0000bff0: 6467 655f 6669 6720 3d20 6669 6732 0a20  dge_fig = fig2. 
+0000c000: 2020 2020 2020 2074 6162 3220 3d20 5461         tab2 = Ta
+0000c010: 6250 616e 656c 2863 6869 6c64 3d66 6967  bPanel(child=fig
+0000c020: 322c 2074 6974 6c65 3d22 5069 6520 4368  2, title="Pie Ch
+0000c030: 6172 7422 290a 0a20 2020 2020 2020 2073  art")..        s
+0000c040: 656c 662e 726f 6f74 203d 2054 6162 7328  elf.root = Tabs(
+0000c050: 7461 6273 3d5b 7461 6231 2c20 7461 6232  tabs=[tab1, tab2
+0000c060: 5d2c 2073 697a 696e 675f 6d6f 6465 3d22  ], sizing_mode="
+0000c070: 7374 7265 7463 685f 626f 7468 2229 0a0a  stretch_both")..
+0000c080: 2020 2020 4077 6974 686f 7574 5f70 726f      @without_pro
+0000c090: 7065 7274 795f 7661 6c69 6461 7469 6f6e  perty_validation
+0000c0a0: 0a20 2020 2040 6c6f 675f 6572 726f 7273  .    @log_errors
+0000c0b0: 0a20 2020 2064 6566 2075 7064 6174 6528  .    def update(
+0000c0c0: 7365 6c66 293a 0a20 2020 2020 2020 2063  self):.        c
+0000c0d0: 6f6d 7075 7465 5f74 696d 6573 203d 2064  ompute_times = d
+0000c0e0: 6566 6175 6c74 6469 6374 2866 6c6f 6174  efaultdict(float
+0000c0f0: 290a 0a20 2020 2020 2020 2066 6f72 206b  )..        for k
+0000c100: 6579 2c20 7473 2069 6e20 7365 6c66 2e73  ey, ts in self.s
+0000c110: 6368 6564 756c 6572 2e74 6173 6b5f 7072  cheduler.task_pr
+0000c120: 6566 6978 6573 2e69 7465 6d73 2829 3a0a  efixes.items():.
+0000c130: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+0000c140: 203d 206b 6579 5f73 706c 6974 286b 6579   = key_split(key
+0000c150: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+0000c160: 7220 6163 7469 6f6e 2c20 7420 696e 2074  r action, t in t
+0000c170: 732e 616c 6c5f 6475 7261 7469 6f6e 732e  s.all_durations.
+0000c180: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+0000c190: 2020 2020 2020 2020 2069 6620 6163 7469           if acti
+0000c1a0: 6f6e 203d 3d20 2263 6f6d 7075 7465 223a  on == "compute":
+0000c1b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c1c0: 2020 2020 2063 6f6d 7075 7465 5f74 696d       compute_tim
+0000c1d0: 6573 5b6e 616d 655d 202b 3d20 740a 0a20  es[name] += t.. 
+0000c1e0: 2020 2020 2020 2023 206f 7264 6572 2062         # order b
+0000c1f0: 7920 6c61 7267 6573 7420 7469 6d65 2066  y largest time f
+0000c200: 6972 7374 0a20 2020 2020 2020 2063 6f6d  irst.        com
+0000c210: 7075 7465 5f74 696d 6573 203d 2073 6f72  pute_times = sor
+0000c220: 7465 6428 636f 6d70 7574 655f 7469 6d65  ted(compute_time
+0000c230: 732e 6974 656d 7328 292c 206b 6579 3d6c  s.items(), key=l
+0000c240: 616d 6264 6120 783a 2078 5b31 5d2c 2072  ambda x: x[1], r
+0000c250: 6576 6572 7365 3d54 7275 6529 0a0a 2020  everse=True)..  
+0000c260: 2020 2020 2020 2320 6b65 6570 206f 6e6c        # keep onl
+0000c270: 7920 7469 6d65 2077 6869 6368 2061 7265  y time which are
+0000c280: 2032 2520 6f66 206d 6178 206f 7220 6772   2% of max or gr
+0000c290: 6561 7465 720a 2020 2020 2020 2020 6966  eater.        if
+0000c2a0: 2063 6f6d 7075 7465 5f74 696d 6573 3a0a   compute_times:.
+0000c2b0: 2020 2020 2020 2020 2020 2020 6d61 785f              max_
+0000c2c0: 7469 6d65 203d 2063 6f6d 7075 7465 5f74  time = compute_t
+0000c2d0: 696d 6573 5b30 5d5b 315d 202a 2030 2e30  imes[0][1] * 0.0
+0000c2e0: 320a 2020 2020 2020 2020 2020 2020 636f  2.            co
+0000c2f0: 6d70 7574 655f 7469 6d65 7320 3d20 5b28  mpute_times = [(
+0000c300: 6e2c 2074 2920 666f 7220 6e2c 2074 2069  n, t) for n, t i
+0000c310: 6e20 636f 6d70 7574 655f 7469 6d65 7320  n compute_times 
+0000c320: 6966 2074 203e 206d 6178 5f74 696d 655d  if t > max_time]
+0000c330: 0a20 2020 2020 2020 2020 2020 2063 6f6d  .            com
+0000c340: 7075 7465 5f63 6f6c 6f72 7320 3d20 6c69  pute_colors = li
+0000c350: 7374 2829 0a20 2020 2020 2020 2020 2020  st().           
+0000c360: 2063 6f6d 7075 7465 5f6e 616d 6573 203d   compute_names =
+0000c370: 206c 6973 7428 290a 2020 2020 2020 2020   list().        
+0000c380: 2020 2020 636f 6d70 7574 655f 7469 6d65      compute_time
+0000c390: 203d 206c 6973 7428 290a 2020 2020 2020   = list().      
+0000c3a0: 2020 2020 2020 746f 7461 6c5f 7469 6d65        total_time
+0000c3b0: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
+0000c3c0: 2066 6f72 206e 616d 652c 2074 2069 6e20   for name, t in 
+0000c3d0: 636f 6d70 7574 655f 7469 6d65 733a 0a20  compute_times:. 
+0000c3e0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000c3f0: 6f6d 7075 7465 5f6e 616d 6573 2e61 7070  ompute_names.app
+0000c400: 656e 6428 6e61 6d65 290a 2020 2020 2020  end(name).      
+0000c410: 2020 2020 2020 2020 2020 636f 6d70 7574            comput
+0000c420: 655f 636f 6c6f 7273 2e61 7070 656e 6428  e_colors.append(
+0000c430: 7473 5f63 6f6c 6f72 5f6f 6628 6e61 6d65  ts_color_of(name
+0000c440: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+0000c450: 2020 2063 6f6d 7075 7465 5f74 696d 652e     compute_time.
+0000c460: 6170 7065 6e64 2874 290a 2020 2020 2020  append(t).      
+0000c470: 2020 2020 2020 2020 2020 746f 7461 6c5f            total_
+0000c480: 7469 6d65 202b 3d20 740a 0a20 2020 2020  time += t..     
+0000c490: 2020 2020 2020 2061 6e67 6c65 7320 3d20         angles = 
+0000c4a0: 5b74 202f 2074 6f74 616c 5f74 696d 6520  [t / total_time 
+0000c4b0: 2a20 3220 2a20 6d61 7468 2e70 6920 666f  * 2 * math.pi fo
+0000c4c0: 7220 7420 696e 2063 6f6d 7075 7465 5f74  r t in compute_t
+0000c4d0: 696d 655d 0a0a 2020 2020 2020 2020 2020  ime]..          
+0000c4e0: 2020 7365 6c66 2e66 6967 2e78 5f72 616e    self.fig.x_ran
+0000c4f0: 6765 2e66 6163 746f 7273 203d 2063 6f6d  ge.factors = com
+0000c500: 7075 7465 5f6e 616d 6573 0a0a 2020 2020  pute_names..    
+0000c510: 2020 2020 2020 2020 636f 6d70 7574 655f          compute_
+0000c520: 7265 7375 6c74 203d 2064 6963 7428 0a20  result = dict(. 
+0000c530: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000c540: 6e67 6c65 733d 616e 676c 6573 2c0a 2020  ngles=angles,.  
+0000c550: 2020 2020 2020 2020 2020 2020 2020 7469                ti
+0000c560: 6d65 733d 636f 6d70 7574 655f 7469 6d65  mes=compute_time
+0000c570: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000c580: 2020 636f 6c6f 723d 636f 6d70 7574 655f    color=compute_
+0000c590: 636f 6c6f 7273 2c0a 2020 2020 2020 2020  colors,.        
+0000c5a0: 2020 2020 2020 2020 6e61 6d65 733d 636f          names=co
+0000c5b0: 6d70 7574 655f 6e61 6d65 732c 0a20 2020  mpute_names,.   
+0000c5c0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0000c5d0: 6d61 7474 6564 5f74 696d 653d 5b66 6f72  matted_time=[for
+0000c5e0: 6d61 745f 7469 6d65 2874 2920 666f 7220  mat_time(t) for 
+0000c5f0: 7420 696e 2063 6f6d 7075 7465 5f74 696d  t in compute_tim
+0000c600: 655d 2c0a 2020 2020 2020 2020 2020 2020  e],.            
+0000c610: 290a 0a20 2020 2020 2020 2020 2020 2075  )..            u
+0000c620: 7064 6174 6528 7365 6c66 2e63 6f6d 7075  pdate(self.compu
+0000c630: 7465 5f73 6f75 7263 652c 2063 6f6d 7075  te_source, compu
+0000c640: 7465 5f72 6573 756c 7429 0a0a 0a63 6c61  te_result)...cla
+0000c650: 7373 2041 6767 7265 6761 7465 4163 7469  ss AggregateActi
+0000c660: 6f6e 2844 6173 6862 6f61 7264 436f 6d70  on(DashboardComp
+0000c670: 6f6e 656e 7429 3a0a 2020 2020 2222 2242  onent):.    """B
+0000c680: 6172 2063 6861 7274 2073 686f 7769 6e67  ar chart showing
+0000c690: 2074 696d 6520 7370 656e 6420 696e 2061   time spend in a
+0000c6a0: 6374 696f 6e20 6279 206b 6579 2070 7265  ction by key pre
+0000c6b0: 6669 7822 2222 0a0a 2020 2020 406c 6f67  fix"""..    @log
+0000c6c0: 5f65 7272 6f72 730a 2020 2020 6465 6620  _errors.    def 
+0000c6d0: 5f5f 696e 6974 5f5f 2873 656c 662c 2073  __init__(self, s
+0000c6e0: 6368 6564 756c 6572 2c20 2a2a 6b77 6172  cheduler, **kwar
+0000c6f0: 6773 293a 0a20 2020 2020 2020 2073 656c  gs):.        sel
+0000c700: 662e 6c61 7374 203d 2030 0a20 2020 2020  f.last = 0.     
+0000c710: 2020 2073 656c 662e 7363 6865 6475 6c65     self.schedule
+0000c720: 7220 3d20 7363 6865 6475 6c65 720a 0a20  r = scheduler.. 
+0000c730: 2020 2020 2020 2069 6620 5461 736b 5374         if TaskSt
+0000c740: 7265 616d 506c 7567 696e 2e6e 616d 6520  reamPlugin.name 
+0000c750: 6e6f 7420 696e 2073 656c 662e 7363 6865  not in self.sche
+0000c760: 6475 6c65 722e 706c 7567 696e 733a 0a20  duler.plugins:. 
+0000c770: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000c780: 7363 6865 6475 6c65 722e 6164 645f 706c  scheduler.add_pl
+0000c790: 7567 696e 2854 6173 6b53 7472 6561 6d50  ugin(TaskStreamP
+0000c7a0: 6c75 6769 6e28 7365 6c66 2e73 6368 6564  lugin(self.sched
+0000c7b0: 756c 6572 2929 0a0a 2020 2020 2020 2020  uler))..        
+0000c7c0: 6163 7469 6f6e 5f64 6174 6120 3d20 7b0a  action_data = {.
+0000c7d0: 2020 2020 2020 2020 2020 2020 2274 696d              "tim
+0000c7e0: 6573 223a 205b 302e 322c 2030 2e31 5d2c  es": [0.2, 0.1],
+0000c7f0: 0a20 2020 2020 2020 2020 2020 2022 666f  .            "fo
+0000c800: 726d 6174 7465 645f 7469 6d65 223a 205b  rmatted_time": [
+0000c810: 2230 2e32 206d 7322 2c20 2232 2e38 2075  "0.2 ms", "2.8 u
+0000c820: 7322 5d2c 0a20 2020 2020 2020 2020 2020  s"],.           
+0000c830: 2022 636f 6c6f 7222 3a20 5b74 735f 636f   "color": [ts_co
+0000c840: 6c6f 725f 6c6f 6f6b 7570 5b22 7472 616e  lor_lookup["tran
+0000c850: 7366 6572 225d 2c20 7473 5f63 6f6c 6f72  sfer"], ts_color
+0000c860: 5f6c 6f6f 6b75 705b 2263 6f6d 7075 7465  _lookup["compute
+0000c870: 225d 5d2c 0a20 2020 2020 2020 2020 2020  "]],.           
+0000c880: 2022 6e61 6d65 7322 3a20 5b22 7472 616e   "names": ["tran
+0000c890: 7366 6572 222c 2022 636f 6d70 7574 6522  sfer", "compute"
+0000c8a0: 5d2c 0a20 2020 2020 2020 207d 0a0a 2020  ],.        }..  
+0000c8b0: 2020 2020 2020 7365 6c66 2e61 6374 696f        self.actio
+0000c8c0: 6e5f 736f 7572 6365 203d 2043 6f6c 756d  n_source = Colum
+0000c8d0: 6e44 6174 6153 6f75 7263 6528 6461 7461  nDataSource(data
+0000c8e0: 3d61 6374 696f 6e5f 6461 7461 290a 0a20  =action_data).. 
+0000c8f0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+0000c900: 203d 2066 6967 7572 6528 0a20 2020 2020   = figure(.     
+0000c910: 2020 2020 2020 2074 6974 6c65 3d22 4167         title="Ag
+0000c920: 6772 6567 6174 6520 5065 7220 4163 7469  gregate Per Acti
+0000c930: 6f6e 222c 0a20 2020 2020 2020 2020 2020  on",.           
+0000c940: 2074 6f6f 6c73 3d22 222c 0a20 2020 2020   tools="",.     
+0000c950: 2020 2020 2020 206e 616d 653d 2261 6767         name="agg
+0000c960: 7265 6761 7465 5f70 6572 5f61 6374 696f  regate_per_actio
+0000c970: 6e22 2c0a 2020 2020 2020 2020 2020 2020  n",.            
+0000c980: 785f 7261 6e67 653d 5b22 6122 2c20 2262  x_range=["a", "b
+0000c990: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
+0000c9a0: 2a2a 6b77 6172 6773 2c0a 2020 2020 2020  **kwargs,.      
+0000c9b0: 2020 290a 0a20 2020 2020 2020 2072 6563    )..        rec
+0000c9c0: 7420 3d20 7365 6c66 2e72 6f6f 742e 7662  t = self.root.vb
+0000c9d0: 6172 280a 2020 2020 2020 2020 2020 2020  ar(.            
+0000c9e0: 736f 7572 6365 3d73 656c 662e 6163 7469  source=self.acti
+0000c9f0: 6f6e 5f73 6f75 7263 652c 0a20 2020 2020  on_source,.     
+0000ca00: 2020 2020 2020 2078 3d22 6e61 6d65 7322         x="names"
+0000ca10: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
+0000ca20: 703d 2274 696d 6573 222c 0a20 2020 2020  p="times",.     
+0000ca30: 2020 2020 2020 2077 6964 7468 3d30 2e37         width=0.7
+0000ca40: 2c0a 2020 2020 2020 2020 2020 2020 636f  ,.            co
+0000ca50: 6c6f 723d 2263 6f6c 6f72 222c 0a20 2020  lor="color",.   
+0000ca60: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0000ca70: 7365 6c66 2e72 6f6f 742e 795f 7261 6e67  self.root.y_rang
+0000ca80: 652e 7374 6172 7420 3d20 300a 2020 2020  e.start = 0.    
+0000ca90: 2020 2020 7365 6c66 2e72 6f6f 742e 7961      self.root.ya
+0000caa0: 7869 735b 305d 2e66 6f72 6d61 7474 6572  xis[0].formatter
+0000cab0: 203d 204e 756d 6572 616c 5469 636b 466f   = NumeralTickFo
+0000cac0: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
+0000cad0: 3022 290a 2020 2020 2020 2020 7365 6c66  0").        self
+0000cae0: 2e72 6f6f 742e 7961 7869 732e 6178 6973  .root.yaxis.axis
+0000caf0: 5f6c 6162 656c 203d 2022 5469 6d65 2028  _label = "Time (
+0000cb00: 7329 220a 2020 2020 2020 2020 7365 6c66  s)".        self
+0000cb10: 2e72 6f6f 742e 7961 7869 732e 7469 636b  .root.yaxis.tick
+0000cb20: 6572 203d 2041 6461 7074 6976 6554 6963  er = AdaptiveTic
+0000cb30: 6b65 7228 2a2a 5449 434b 535f 3130 3234  ker(**TICKS_1024
+0000cb40: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
+0000cb50: 6f6f 742e 7861 7869 732e 6d61 6a6f 725f  oot.xaxis.major_
+0000cb60: 6c61 6265 6c5f 6f72 6965 6e74 6174 696f  label_orientatio
+0000cb70: 6e20 3d20 584c 4142 454c 5f4f 5249 454e  n = XLABEL_ORIEN
+0000cb80: 5441 5449 4f4e 0a20 2020 2020 2020 2073  TATION.        s
+0000cb90: 656c 662e 726f 6f74 2e78 6178 6973 2e6d  elf.root.xaxis.m
+0000cba0: 616a 6f72 5f6c 6162 656c 5f74 6578 745f  ajor_label_text_
+0000cbb0: 666f 6e74 5f73 697a 6520 3d20 2231 3670  font_size = "16p
+0000cbc0: 7822 0a20 2020 2020 2020 2072 6563 742e  x".        rect.
+0000cbd0: 6e6f 6e73 656c 6563 7469 6f6e 5f67 6c79  nonselection_gly
+0000cbe0: 7068 203d 204e 6f6e 650a 0a20 2020 2020  ph = None..     
+0000cbf0: 2020 2073 656c 662e 726f 6f74 2e78 6178     self.root.xax
+0000cc00: 6973 2e6d 696e 6f72 5f74 6963 6b5f 6c69  is.minor_tick_li
+0000cc10: 6e65 5f61 6c70 6861 203d 2030 0a20 2020  ne_alpha = 0.   
+0000cc20: 2020 2020 2073 656c 662e 726f 6f74 2e78       self.root.x
+0000cc30: 6772 6964 2e76 6973 6962 6c65 203d 2046  grid.visible = F
+0000cc40: 616c 7365 0a0a 2020 2020 2020 2020 7365  alse..        se
+0000cc50: 6c66 2e72 6f6f 742e 746f 6f6c 6261 725f  lf.root.toolbar_
+0000cc60: 6c6f 6361 7469 6f6e 203d 204e 6f6e 650a  location = None.
+0000cc70: 0a20 2020 2020 2020 2068 6f76 6572 203d  .        hover =
+0000cc80: 2048 6f76 6572 546f 6f6c 2829 0a20 2020   HoverTool().   
+0000cc90: 2020 2020 2068 6f76 6572 2e74 6f6f 6c74       hover.toolt
+0000cca0: 6970 7320 3d20 2222 220a 2020 2020 2020  ips = """.      
+0000ccb0: 2020 2020 2020 3c64 6976 3e0a 2020 2020        <div>.    
+0000ccc0: 2020 2020 2020 2020 2020 2020 3c70 3e3c              <p><
+0000ccd0: 623e 4e61 6d65 3a3c 2f62 3e20 406e 616d  b>Name:</b> @nam
+0000cce0: 6573 3c2f 703e 0a20 2020 2020 2020 2020  es</p>.         
+0000ccf0: 2020 2020 2020 203c 703e 3c62 3e54 696d         <p><b>Tim
+0000cd00: 653a 3c2f 623e 2040 666f 726d 6174 7465  e:</b> @formatte
+0000cd10: 645f 7469 6d65 3c2f 703e 0a20 2020 2020  d_time</p>.     
+0000cd20: 2020 2020 2020 203c 2f64 6976 3e0a 2020         </div>.  
+0000cd30: 2020 2020 2020 2020 2020 2222 220a 2020            """.  
+0000cd40: 2020 2020 2020 686f 7665 722e 706f 696e        hover.poin
+0000cd50: 745f 706f 6c69 6379 203d 2022 666f 6c6c  t_policy = "foll
+0000cd60: 6f77 5f6d 6f75 7365 220a 2020 2020 2020  ow_mouse".      
+0000cd70: 2020 7365 6c66 2e72 6f6f 742e 6164 645f    self.root.add_
+0000cd80: 746f 6f6c 7328 686f 7665 7229 0a0a 2020  tools(hover)..  
+0000cd90: 2020 4077 6974 686f 7574 5f70 726f 7065    @without_prope
+0000cda0: 7274 795f 7661 6c69 6461 7469 6f6e 0a20  rty_validation. 
+0000cdb0: 2020 2040 6c6f 675f 6572 726f 7273 0a20     @log_errors. 
+0000cdc0: 2020 2064 6566 2075 7064 6174 6528 7365     def update(se
+0000cdd0: 6c66 293a 0a20 2020 2020 2020 2061 6767  lf):.        agg
+0000cde0: 5f74 696d 6573 203d 2064 6566 6175 6c74  _times = default
+0000cdf0: 6469 6374 2866 6c6f 6174 290a 0a20 2020  dict(float)..   
+0000ce00: 2020 2020 2066 6f72 2074 7320 696e 2073       for ts in s
+0000ce10: 656c 662e 7363 6865 6475 6c65 722e 7461  elf.scheduler.ta
+0000ce20: 736b 5f70 7265 6669 7865 732e 7661 6c75  sk_prefixes.valu
+0000ce30: 6573 2829 3a0a 2020 2020 2020 2020 2020  es():.          
+0000ce40: 2020 666f 7220 6163 7469 6f6e 2c20 7420    for action, t 
+0000ce50: 696e 2074 732e 616c 6c5f 6475 7261 7469  in ts.all_durati
+0000ce60: 6f6e 732e 6974 656d 7328 293a 0a20 2020  ons.items():.   
+0000ce70: 2020 2020 2020 2020 2020 2020 2061 6767               agg
+0000ce80: 5f74 696d 6573 5b61 6374 696f 6e5d 202b  _times[action] +
+0000ce90: 3d20 740a 0a20 2020 2020 2020 2023 206f  = t..        # o
+0000cea0: 7264 6572 2062 7920 6c61 7267 6573 7420  rder by largest 
+0000ceb0: 7469 6d65 2066 6972 7374 0a20 2020 2020  time first.     
+0000cec0: 2020 2061 6767 5f74 696d 6573 203d 2073     agg_times = s
+0000ced0: 6f72 7465 6428 6167 675f 7469 6d65 732e  orted(agg_times.
+0000cee0: 6974 656d 7328 292c 206b 6579 3d6c 616d  items(), key=lam
+0000cef0: 6264 6120 783a 2078 5b31 5d2c 2072 6576  bda x: x[1], rev
+0000cf00: 6572 7365 3d54 7275 6529 0a0a 2020 2020  erse=True)..    
+0000cf10: 2020 2020 6167 675f 636f 6c6f 7273 203d      agg_colors =
+0000cf20: 206c 6973 7428 290a 2020 2020 2020 2020   list().        
+0000cf30: 6167 675f 6e61 6d65 7320 3d20 6c69 7374  agg_names = list
+0000cf40: 2829 0a20 2020 2020 2020 2061 6767 5f74  ().        agg_t
+0000cf50: 696d 6520 3d20 6c69 7374 2829 0a20 2020  ime = list().   
+0000cf60: 2020 2020 2066 6f72 2061 6374 696f 6e2c       for action,
+0000cf70: 2074 2069 6e20 6167 675f 7469 6d65 733a   t in agg_times:
+0000cf80: 0a20 2020 2020 2020 2020 2020 2061 6767  .            agg
+0000cf90: 5f6e 616d 6573 2e61 7070 656e 6428 6163  _names.append(ac
+0000cfa0: 7469 6f6e 290a 2020 2020 2020 2020 2020  tion).          
+0000cfb0: 2020 6966 2061 6374 696f 6e20 3d3d 2022    if action == "
+0000cfc0: 636f 6d70 7574 6522 3a0a 2020 2020 2020  compute":.      
+0000cfd0: 2020 2020 2020 2020 2020 6167 675f 636f            agg_co
+0000cfe0: 6c6f 7273 2e61 7070 656e 6428 2270 7572  lors.append("pur
+0000cff0: 706c 6522 290a 2020 2020 2020 2020 2020  ple").          
+0000d000: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000d010: 2020 2020 2020 2020 6167 675f 636f 6c6f          agg_colo
+0000d020: 7273 2e61 7070 656e 6428 7473 5f63 6f6c  rs.append(ts_col
+0000d030: 6f72 5f6c 6f6f 6b75 705b 6163 7469 6f6e  or_lookup[action
+0000d040: 5d29 0a20 2020 2020 2020 2020 2020 2061  ]).            a
+0000d050: 6767 5f74 696d 652e 6170 7065 6e64 2874  gg_time.append(t
+0000d060: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+0000d070: 726f 6f74 2e78 5f72 616e 6765 2e66 6163  root.x_range.fac
+0000d080: 746f 7273 203d 2061 6767 5f6e 616d 6573  tors = agg_names
+0000d090: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+0000d0a0: 6f74 2e74 6974 6c65 2e74 6578 7420 3d20  ot.title.text = 
+0000d0b0: 2241 6767 7265 6761 7465 2054 696d 6520  "Aggregate Time 
+0000d0c0: 5065 7220 4163 7469 6f6e 220a 0a20 2020  Per Action"..   
+0000d0d0: 2020 2020 2061 6374 696f 6e5f 7265 7375       action_resu
+0000d0e0: 6c74 203d 2064 6963 7428 0a20 2020 2020  lt = dict(.     
+0000d0f0: 2020 2020 2020 2074 696d 6573 3d61 6767         times=agg
+0000d100: 5f74 696d 652c 0a20 2020 2020 2020 2020  _time,.         
+0000d110: 2020 2063 6f6c 6f72 3d61 6767 5f63 6f6c     color=agg_col
+0000d120: 6f72 732c 0a20 2020 2020 2020 2020 2020  ors,.           
+0000d130: 206e 616d 6573 3d61 6767 5f6e 616d 6573   names=agg_names
+0000d140: 2c0a 2020 2020 2020 2020 2020 2020 666f  ,.            fo
+0000d150: 726d 6174 7465 645f 7469 6d65 3d5b 666f  rmatted_time=[fo
+0000d160: 726d 6174 5f74 696d 6528 7429 2066 6f72  rmat_time(t) for
+0000d170: 2074 2069 6e20 6167 675f 7469 6d65 5d2c   t in agg_time],
+0000d180: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0000d190: 2020 2020 7570 6461 7465 2873 656c 662e      update(self.
+0000d1a0: 6163 7469 6f6e 5f73 6f75 7263 652c 2061  action_source, a
+0000d1b0: 6374 696f 6e5f 7265 7375 6c74 290a 0a0a  ction_result)...
+0000d1c0: 636c 6173 7320 4d65 6d6f 7279 4279 4b65  class MemoryByKe
+0000d1d0: 7928 4461 7368 626f 6172 6443 6f6d 706f  y(DashboardCompo
+0000d1e0: 6e65 6e74 293a 0a20 2020 2022 2222 4261  nent):.    """Ba
+0000d1f0: 7220 6368 6172 7420 7368 6f77 696e 6720  r chart showing 
+0000d200: 6d65 6d6f 7279 2075 7365 2062 7920 6b65  memory use by ke
+0000d210: 7920 7072 6566 6978 2222 220a 0a20 2020  y prefix"""..   
+0000d220: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
+0000d230: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+0000d240: 6c66 2c20 7363 6865 6475 6c65 722c 202a  lf, scheduler, *
+0000d250: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
+0000d260: 2020 7365 6c66 2e6c 6173 7420 3d20 300a    self.last = 0.
+0000d270: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
+0000d280: 6564 756c 6572 203d 2073 6368 6564 756c  eduler = schedul
+0000d290: 6572 0a20 2020 2020 2020 2073 656c 662e  er.        self.
+0000d2a0: 736f 7572 6365 203d 2043 6f6c 756d 6e44  source = ColumnD
+0000d2b0: 6174 6153 6f75 7263 6528 0a20 2020 2020  ataSource(.     
+0000d2c0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0000d2d0: 2020 2020 2020 2020 2022 6e61 6d65 223a           "name":
+0000d2e0: 205b 2261 222c 2022 6222 5d2c 0a20 2020   ["a", "b"],.   
+0000d2f0: 2020 2020 2020 2020 2020 2020 2022 6e62               "nb
+0000d300: 7974 6573 223a 205b 3130 302c 2031 3030  ytes": [100, 100
+0000d310: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+0000d320: 2020 2020 2263 6f75 6e74 223a 205b 312c      "count": [1,
+0000d330: 2032 5d2c 0a20 2020 2020 2020 2020 2020   2],.           
+0000d340: 2020 2020 2022 636f 6c6f 7222 3a20 5b22       "color": ["
+0000d350: 626c 7565 222c 2022 626c 7565 225d 2c0a  blue", "blue"],.
+0000d360: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0000d370: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0000d380: 2073 656c 662e 726f 6f74 203d 2066 6967   self.root = fig
+0000d390: 7572 6528 0a20 2020 2020 2020 2020 2020  ure(.           
+0000d3a0: 2074 6974 6c65 3d22 4d65 6d6f 7279 2055   title="Memory U
+0000d3b0: 7365 222c 0a20 2020 2020 2020 2020 2020  se",.           
+0000d3c0: 2074 6f6f 6c73 3d22 222c 0a20 2020 2020   tools="",.     
+0000d3d0: 2020 2020 2020 206e 616d 653d 226d 656d         name="mem
+0000d3e0: 6f72 795f 6279 5f6b 6579 222c 0a20 2020  ory_by_key",.   
+0000d3f0: 2020 2020 2020 2020 2078 5f72 616e 6765           x_range
+0000d400: 3d5b 2261 222c 2022 6222 5d2c 0a20 2020  =["a", "b"],.   
+0000d410: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
+0000d420: 732c 0a20 2020 2020 2020 2029 0a20 2020  s,.        ).   
+0000d430: 2020 2020 2072 6563 7420 3d20 7365 6c66       rect = self
+0000d440: 2e72 6f6f 742e 7662 6172 280a 2020 2020  .root.vbar(.    
+0000d450: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
+0000d460: 656c 662e 736f 7572 6365 2c20 783d 226e  elf.source, x="n
+0000d470: 616d 6522 2c20 746f 703d 226e 6279 7465  ame", top="nbyte
+0000d480: 7322 2c20 7769 6474 683d 302e 392c 2063  s", width=0.9, c
+0000d490: 6f6c 6f72 3d22 636f 6c6f 7222 0a20 2020  olor="color".   
+0000d4a0: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+0000d4b0: 656c 662e 726f 6f74 2e79 6178 6973 5b30  elf.root.yaxis[0
+0000d4c0: 5d2e 666f 726d 6174 7465 7220 3d20 4e75  ].formatter = Nu
+0000d4d0: 6d65 7261 6c54 6963 6b46 6f72 6d61 7474  meralTickFormatt
+0000d4e0: 6572 2866 6f72 6d61 743d 2230 2e30 2062  er(format="0.0 b
+0000d4f0: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
+0000d500: 726f 6f74 2e79 6178 6973 2e74 6963 6b65  root.yaxis.ticke
+0000d510: 7220 3d20 4164 6170 7469 7665 5469 636b  r = AdaptiveTick
+0000d520: 6572 282a 2a54 4943 4b53 5f31 3032 3429  er(**TICKS_1024)
+0000d530: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+0000d540: 6f74 2e78 6178 6973 2e6d 616a 6f72 5f6c  ot.xaxis.major_l
+0000d550: 6162 656c 5f6f 7269 656e 7461 7469 6f6e  abel_orientation
+0000d560: 203d 2058 4c41 4245 4c5f 4f52 4945 4e54   = XLABEL_ORIENT
+0000d570: 4154 494f 4e0a 2020 2020 2020 2020 7265  ATION.        re
+0000d580: 6374 2e6e 6f6e 7365 6c65 6374 696f 6e5f  ct.nonselection_
+0000d590: 676c 7970 6820 3d20 4e6f 6e65 0a0a 2020  glyph = None..  
+0000d5a0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+0000d5b0: 7861 7869 732e 6d69 6e6f 725f 7469 636b  xaxis.minor_tick
+0000d5c0: 5f6c 696e 655f 616c 7068 6120 3d20 300a  _line_alpha = 0.
+0000d5d0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+0000d5e0: 742e 7967 7269 642e 7669 7369 626c 6520  t.ygrid.visible 
+0000d5f0: 3d20 4661 6c73 650a 0a20 2020 2020 2020  = False..       
+0000d600: 2073 656c 662e 726f 6f74 2e74 6f6f 6c62   self.root.toolb
+0000d610: 6172 5f6c 6f63 6174 696f 6e20 3d20 4e6f  ar_location = No
+0000d620: 6e65 0a0a 2020 2020 2020 2020 686f 7665  ne..        hove
+0000d630: 7220 3d20 486f 7665 7254 6f6f 6c28 290a  r = HoverTool().
+0000d640: 2020 2020 2020 2020 686f 7665 722e 746f          hover.to
+0000d650: 6f6c 7469 7073 203d 2022 406e 616d 653a  oltips = "@name:
+0000d660: 2040 6e62 7974 6573 5f74 6578 7422 0a20   @nbytes_text". 
+0000d670: 2020 2020 2020 2068 6f76 6572 2e74 6f6f         hover.too
+0000d680: 6c74 6970 7320 3d20 2222 220a 2020 2020  ltips = """.    
+0000d690: 2020 2020 2020 2020 3c64 6976 3e0a 2020          <div>.  
+0000d6a0: 2020 2020 2020 2020 2020 2020 2020 3c70                <p
+0000d6b0: 3e3c 623e 4e61 6d65 3a3c 2f62 3e20 406e  ><b>Name:</b> @n
+0000d6c0: 616d 653c 2f70 3e0a 2020 2020 2020 2020  ame</p>.        
+0000d6d0: 2020 2020 2020 2020 3c70 3e3c 623e 4279          <p><b>By
+0000d6e0: 7465 733a 3c2f 623e 2040 6e62 7974 6573  tes:</b> @nbytes
+0000d6f0: 5f74 6578 7420 3c2f 703e 0a20 2020 2020  _text </p>.     
+0000d700: 2020 2020 2020 2020 2020 203c 703e 3c62             <p><b
+0000d710: 3e43 6f75 6e74 3a3c 2f62 3e20 4063 6f75  >Count:</b> @cou
+0000d720: 6e74 206f 626a 6563 7473 203c 2f70 3e0a  nt objects </p>.
+0000d730: 2020 2020 2020 2020 2020 2020 3c2f 6469              </di
+0000d740: 763e 0a20 2020 2020 2020 2020 2020 2022  v>.            "
+0000d750: 2222 0a20 2020 2020 2020 2068 6f76 6572  "".        hover
+0000d760: 2e70 6f69 6e74 5f70 6f6c 6963 7920 3d20  .point_policy = 
+0000d770: 2266 6f6c 6c6f 775f 6d6f 7573 6522 0a20  "follow_mouse". 
+0000d780: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+0000d790: 2e61 6464 5f74 6f6f 6c73 2868 6f76 6572  .add_tools(hover
+0000d7a0: 290a 0a20 2020 2040 7769 7468 6f75 745f  )..    @without_
+0000d7b0: 7072 6f70 6572 7479 5f76 616c 6964 6174  property_validat
+0000d7c0: 696f 6e0a 2020 2020 406c 6f67 5f65 7272  ion.    @log_err
+0000d7d0: 6f72 730a 2020 2020 6465 6620 7570 6461  ors.    def upda
+0000d7e0: 7465 2873 656c 6629 3a0a 2020 2020 2020  te(self):.      
+0000d7f0: 2020 636f 756e 7473 203d 2064 6566 6175    counts = defau
+0000d800: 6c74 6469 6374 2869 6e74 290a 2020 2020  ltdict(int).    
+0000d810: 2020 2020 6e62 7974 6573 203d 2064 6566      nbytes = def
+0000d820: 6175 6c74 6469 6374 2869 6e74 290a 2020  aultdict(int).  
+0000d830: 2020 2020 2020 666f 7220 7773 2069 6e20        for ws in 
+0000d840: 7365 6c66 2e73 6368 6564 756c 6572 2e77  self.scheduler.w
+0000d850: 6f72 6b65 7273 2e76 616c 7565 7328 293a  orkers.values():
+0000d860: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0000d870: 2074 7320 696e 2077 732e 6861 735f 7768   ts in ws.has_wh
+0000d880: 6174 3a0a 2020 2020 2020 2020 2020 2020  at:.            
+0000d890: 2020 2020 6b73 203d 206b 6579 5f73 706c      ks = key_spl
+0000d8a0: 6974 2874 732e 6b65 7929 0a20 2020 2020  it(ts.key).     
+0000d8b0: 2020 2020 2020 2020 2020 2063 6f75 6e74             count
+0000d8c0: 735b 6b73 5d20 2b3d 2031 0a20 2020 2020  s[ks] += 1.     
+0000d8d0: 2020 2020 2020 2020 2020 206e 6279 7465             nbyte
+0000d8e0: 735b 6b73 5d20 2b3d 2074 732e 6e62 7974  s[ks] += ts.nbyt
+0000d8f0: 6573 0a0a 2020 2020 2020 2020 6e61 6d65  es..        name
+0000d900: 7320 3d20 6c69 7374 2873 6f72 7465 6428  s = list(sorted(
+0000d910: 636f 756e 7473 2929 0a20 2020 2020 2020  counts)).       
+0000d920: 2073 656c 662e 726f 6f74 2e78 5f72 616e   self.root.x_ran
+0000d930: 6765 2e66 6163 746f 7273 203d 206e 616d  ge.factors = nam
+0000d940: 6573 0a20 2020 2020 2020 2072 6573 756c  es.        resul
+0000d950: 7420 3d20 7b0a 2020 2020 2020 2020 2020  t = {.          
+0000d960: 2020 226e 616d 6522 3a20 6e61 6d65 732c    "name": names,
+0000d970: 0a20 2020 2020 2020 2020 2020 2022 636f  .            "co
+0000d980: 756e 7422 3a20 5b63 6f75 6e74 735b 6e61  unt": [counts[na
+0000d990: 6d65 5d20 666f 7220 6e61 6d65 2069 6e20  me] for name in 
+0000d9a0: 6e61 6d65 735d 2c0a 2020 2020 2020 2020  names],.        
+0000d9b0: 2020 2020 226e 6279 7465 7322 3a20 5b6e      "nbytes": [n
+0000d9c0: 6279 7465 735b 6e61 6d65 5d20 666f 7220  bytes[name] for 
+0000d9d0: 6e61 6d65 2069 6e20 6e61 6d65 735d 2c0a  name in names],.
+0000d9e0: 2020 2020 2020 2020 2020 2020 226e 6279              "nby
+0000d9f0: 7465 735f 7465 7874 223a 205b 666f 726d  tes_text": [form
+0000da00: 6174 5f62 7974 6573 286e 6279 7465 735b  at_bytes(nbytes[
+0000da10: 6e61 6d65 5d29 2066 6f72 206e 616d 6520  name]) for name 
+0000da20: 696e 206e 616d 6573 5d2c 0a20 2020 2020  in names],.     
+0000da30: 2020 2020 2020 2022 636f 6c6f 7222 3a20         "color": 
+0000da40: 5b63 6f6c 6f72 5f6f 6628 6e61 6d65 2920  [color_of(name) 
+0000da50: 666f 7220 6e61 6d65 2069 6e20 6e61 6d65  for name in name
+0000da60: 735d 2c0a 2020 2020 2020 2020 7d0a 2020  s],.        }.  
+0000da70: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+0000da80: 7469 746c 652e 7465 7874 203d 2022 546f  title.text = "To
+0000da90: 7461 6c20 5573 653a 2022 202b 2066 6f72  tal Use: " + for
+0000daa0: 6d61 745f 6279 7465 7328 7375 6d28 6e62  mat_bytes(sum(nb
+0000dab0: 7974 6573 2e76 616c 7565 7328 2929 290a  ytes.values())).
+0000dac0: 0a20 2020 2020 2020 2075 7064 6174 6528  .        update(
+0000dad0: 7365 6c66 2e73 6f75 7263 652c 2072 6573  self.source, res
+0000dae0: 756c 7429 0a0a 0a63 6c61 7373 2043 7572  ult)...class Cur
+0000daf0: 7265 6e74 4c6f 6164 2844 6173 6862 6f61  rentLoad(Dashboa
+0000db00: 7264 436f 6d70 6f6e 656e 7429 3a0a 2020  rdComponent):.  
+0000db10: 2020 2222 2254 6173 6b73 2061 6e64 2043    """Tasks and C
+0000db20: 5055 2075 7361 6765 206f 6e20 6561 6368  PU usage on each
+0000db30: 2077 6f72 6b65 7222 2222 0a0a 2020 2020   worker"""..    
+0000db40: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
+0000db50: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+0000db60: 662c 2073 6368 6564 756c 6572 2c20 7769  f, scheduler, wi
+0000db70: 6474 683d 3630 302c 202a 2a6b 7761 7267  dth=600, **kwarg
+0000db80: 7329 3a0a 2020 2020 2020 2020 7365 6c66  s):.        self
+0000db90: 2e6c 6173 7420 3d20 300a 2020 2020 2020  .last = 0.      
+0000dba0: 2020 7365 6c66 2e73 6368 6564 756c 6572    self.scheduler
+0000dbb0: 203d 2073 6368 6564 756c 6572 0a20 2020   = scheduler.   
+0000dbc0: 2020 2020 2073 656c 662e 736f 7572 6365       self.source
+0000dbd0: 203d 2043 6f6c 756d 6e44 6174 6153 6f75   = ColumnDataSou
+0000dbe0: 7263 6528 0a20 2020 2020 2020 2020 2020  rce(.           
+0000dbf0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0000dc00: 2020 2022 6e70 726f 6365 7373 696e 6722     "nprocessing"
+0000dc10: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+0000dc20: 2020 2020 2020 226e 7072 6f63 6573 7369        "nprocessi
+0000dc30: 6e67 2d68 616c 6622 3a20 5b5d 2c0a 2020  ng-half": [],.  
+0000dc40: 2020 2020 2020 2020 2020 2020 2020 226e                "n
+0000dc50: 7072 6f63 6573 7369 6e67 2d63 6f6c 6f72  processing-color
+0000dc60: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+0000dc70: 2020 2020 2020 2022 6370 7522 3a20 5b5d         "cpu": []
+0000dc80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000dc90: 2020 2263 7075 2d68 616c 6622 3a20 5b5d    "cpu-half": []
+0000dca0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000dcb0: 2020 2279 223a 205b 5d2c 0a20 2020 2020    "y": [],.     
+0000dcc0: 2020 2020 2020 2020 2020 2022 776f 726b             "work
+0000dcd0: 6572 223a 205b 5d2c 0a20 2020 2020 2020  er": [],.       
+0000dce0: 2020 2020 2020 2020 2022 6573 6361 7065           "escape
+0000dcf0: 645f 776f 726b 6572 223a 205b 5d2c 0a20  d_worker": [],. 
+0000dd00: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0000dd10: 2020 2020 2029 0a20 2020 2020 2020 2070       ).        p
+0000dd20: 726f 6365 7373 696e 6720 3d20 6669 6775  rocessing = figu
+0000dd30: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
+0000dd40: 7469 746c 653d 2254 6173 6b73 2050 726f  title="Tasks Pro
+0000dd50: 6365 7373 696e 6722 2c0a 2020 2020 2020  cessing",.      
+0000dd60: 2020 2020 2020 746f 6f6c 733d 2222 2c0a        tools="",.
+0000dd70: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+0000dd80: 3d22 7072 6f63 6573 7369 6e67 222c 0a20  ="processing",. 
+0000dd90: 2020 2020 2020 2020 2020 2077 6964 7468             width
+0000dda0: 3d69 6e74 2877 6964 7468 202f 2032 292c  =int(width / 2),
+0000ddb0: 0a20 2020 2020 2020 2020 2020 206d 696e  .            min
+0000ddc0: 5f62 6f72 6465 725f 626f 7474 6f6d 3d35  _border_bottom=5
+0000ddd0: 302c 0a20 2020 2020 2020 2020 2020 202a  0,.            *
+0000dde0: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
+0000ddf0: 2029 0a20 2020 2020 2020 2072 6563 7420   ).        rect 
+0000de00: 3d20 7072 6f63 6573 7369 6e67 2e72 6563  = processing.rec
+0000de10: 7428 0a20 2020 2020 2020 2020 2020 2073  t(.            s
+0000de20: 6f75 7263 653d 7365 6c66 2e73 6f75 7263  ource=self.sourc
+0000de30: 652c 0a20 2020 2020 2020 2020 2020 2078  e,.            x
+0000de40: 3d22 6e70 726f 6365 7373 696e 672d 6861  ="nprocessing-ha
+0000de50: 6c66 222c 0a20 2020 2020 2020 2020 2020  lf",.           
+0000de60: 2079 3d22 7922 2c0a 2020 2020 2020 2020   y="y",.        
+0000de70: 2020 2020 7769 6474 683d 226e 7072 6f63      width="nproc
+0000de80: 6573 7369 6e67 222c 0a20 2020 2020 2020  essing",.       
+0000de90: 2020 2020 2068 6569 6768 743d 302e 392c       height=0.9,
+0000dea0: 0a20 2020 2020 2020 2020 2020 2063 6f6c  .            col
+0000deb0: 6f72 3d22 6e70 726f 6365 7373 696e 672d  or="nprocessing-
+0000dec0: 636f 6c6f 7222 2c0a 2020 2020 2020 2020  color",.        
+0000ded0: 290a 2020 2020 2020 2020 7072 6f63 6573  ).        proces
+0000dee0: 7369 6e67 2e78 5f72 616e 6765 2e73 7461  sing.x_range.sta
+0000def0: 7274 203d 2030 0a20 2020 2020 2020 2072  rt = 0.        r
+0000df00: 6563 742e 6e6f 6e73 656c 6563 7469 6f6e  ect.nonselection
+0000df10: 5f67 6c79 7068 203d 204e 6f6e 650a 0a20  _glyph = None.. 
+0000df20: 2020 2020 2020 2063 7075 203d 2066 6967         cpu = fig
+0000df30: 7572 6528 0a20 2020 2020 2020 2020 2020  ure(.           
+0000df40: 2074 6974 6c65 3d22 4350 5520 5574 696c   title="CPU Util
+0000df50: 697a 6174 696f 6e22 2c0a 2020 2020 2020  ization",.      
+0000df60: 2020 2020 2020 746f 6f6c 733d 2222 2c0a        tools="",.
+0000df70: 2020 2020 2020 2020 2020 2020 7769 6474              widt
+0000df80: 683d 696e 7428 7769 6474 6820 2f20 3229  h=int(width / 2)
+0000df90: 2c0a 2020 2020 2020 2020 2020 2020 6e61  ,.            na
+0000dfa0: 6d65 3d22 6370 755f 6869 7374 222c 0a20  me="cpu_hist",. 
+0000dfb0: 2020 2020 2020 2020 2020 2078 5f72 616e             x_ran
+0000dfc0: 6765 3d28 302c 2031 3030 292c 0a20 2020  ge=(0, 100),.   
+0000dfd0: 2020 2020 2020 2020 206d 696e 5f62 6f72           min_bor
+0000dfe0: 6465 725f 626f 7474 6f6d 3d35 302c 0a20  der_bottom=50,. 
+0000dff0: 2020 2020 2020 2020 2020 202a 2a6b 7761             **kwa
+0000e000: 7267 732c 0a20 2020 2020 2020 2029 0a20  rgs,.        ). 
+0000e010: 2020 2020 2020 2072 6563 7420 3d20 6370         rect = cp
+0000e020: 752e 7265 6374 280a 2020 2020 2020 2020  u.rect(.        
+0000e030: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
+0000e040: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
+0000e050: 2020 2020 783d 2263 7075 2d68 616c 6622      x="cpu-half"
+0000e060: 2c0a 2020 2020 2020 2020 2020 2020 793d  ,.            y=
+0000e070: 2279 222c 0a20 2020 2020 2020 2020 2020  "y",.           
+0000e080: 2077 6964 7468 3d22 6370 7522 2c0a 2020   width="cpu",.  
+0000e090: 2020 2020 2020 2020 2020 6865 6967 6874            height
+0000e0a0: 3d30 2e39 2c0a 2020 2020 2020 2020 2020  =0.9,.          
+0000e0b0: 2020 636f 6c6f 723d 2262 6c75 6522 2c0a    color="blue",.
+0000e0c0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000e0d0: 2020 7265 6374 2e6e 6f6e 7365 6c65 6374    rect.nonselect
+0000e0e0: 696f 6e5f 676c 7970 6820 3d20 4e6f 6e65  ion_glyph = None
+0000e0f0: 0a0a 2020 2020 2020 2020 666f 7220 6669  ..        for fi
+0000e100: 6720 696e 2028 7072 6f63 6573 7369 6e67  g in (processing
+0000e110: 2c20 6370 7529 3a0a 2020 2020 2020 2020  , cpu):.        
+0000e120: 2020 2020 6669 672e 7861 7869 732e 6d69      fig.xaxis.mi
+0000e130: 6e6f 725f 7469 636b 5f6c 696e 655f 616c  nor_tick_line_al
+0000e140: 7068 6120 3d20 300a 2020 2020 2020 2020  pha = 0.        
+0000e150: 2020 2020 6669 672e 7961 7869 732e 7669      fig.yaxis.vi
+0000e160: 7369 626c 6520 3d20 4661 6c73 650a 2020  sible = False.  
+0000e170: 2020 2020 2020 2020 2020 6669 672e 7967            fig.yg
+0000e180: 7269 642e 7669 7369 626c 6520 3d20 4661  rid.visible = Fa
+0000e190: 6c73 650a 0a20 2020 2020 2020 2020 2020  lse..           
+0000e1a0: 2074 6170 203d 2054 6170 546f 6f6c 2863   tap = TapTool(c
+0000e1b0: 616c 6c62 6163 6b3d 4f70 656e 5552 4c28  allback=OpenURL(
+0000e1c0: 7572 6c3d 222e 2f69 6e66 6f2f 776f 726b  url="./info/work
+0000e1d0: 6572 2f40 6573 6361 7065 645f 776f 726b  er/@escaped_work
+0000e1e0: 6572 2e68 746d 6c22 2929 0a20 2020 2020  er.html")).     
+0000e1f0: 2020 2020 2020 2066 6967 2e61 6464 5f74         fig.add_t
+0000e200: 6f6f 6c73 2874 6170 290a 0a20 2020 2020  ools(tap)..     
+0000e210: 2020 2020 2020 2066 6967 2e74 6f6f 6c62         fig.toolb
+0000e220: 6172 5f6c 6f63 6174 696f 6e20 3d20 4e6f  ar_location = No
+0000e230: 6e65 0a20 2020 2020 2020 2020 2020 2066  ne.            f
+0000e240: 6967 2e79 6178 6973 2e76 6973 6962 6c65  ig.yaxis.visible
+0000e250: 203d 2046 616c 7365 0a0a 2020 2020 2020   = False..      
+0000e260: 2020 686f 7665 7220 3d20 486f 7665 7254    hover = HoverT
+0000e270: 6f6f 6c28 290a 2020 2020 2020 2020 686f  ool().        ho
+0000e280: 7665 722e 746f 6f6c 7469 7073 203d 2022  ver.tooltips = "
+0000e290: 4077 6f72 6b65 7220 3a20 406e 7072 6f63  @worker : @nproc
+0000e2a0: 6573 7369 6e67 2074 6173 6b73 220a 2020  essing tasks".  
+0000e2b0: 2020 2020 2020 686f 7665 722e 706f 696e        hover.poin
+0000e2c0: 745f 706f 6c69 6379 203d 2022 666f 6c6c  t_policy = "foll
+0000e2d0: 6f77 5f6d 6f75 7365 220a 2020 2020 2020  ow_mouse".      
+0000e2e0: 2020 7072 6f63 6573 7369 6e67 2e61 6464    processing.add
+0000e2f0: 5f74 6f6f 6c73 2868 6f76 6572 290a 0a20  _tools(hover).. 
+0000e300: 2020 2020 2020 2068 6f76 6572 203d 2048         hover = H
+0000e310: 6f76 6572 546f 6f6c 2829 0a20 2020 2020  overTool().     
+0000e320: 2020 2068 6f76 6572 2e74 6f6f 6c74 6970     hover.tooltip
+0000e330: 7320 3d20 2240 776f 726b 6572 203a 2040  s = "@worker : @
+0000e340: 6370 7520 2522 0a20 2020 2020 2020 2068  cpu %".        h
+0000e350: 6f76 6572 2e70 6f69 6e74 5f70 6f6c 6963  over.point_polic
+0000e360: 7920 3d20 2266 6f6c 6c6f 775f 6d6f 7573  y = "follow_mous
+0000e370: 6522 0a20 2020 2020 2020 2063 7075 2e61  e".        cpu.a
+0000e380: 6464 5f74 6f6f 6c73 2868 6f76 6572 290a  dd_tools(hover).
+0000e390: 0a20 2020 2020 2020 2073 656c 662e 7072  .        self.pr
+0000e3a0: 6f63 6573 7369 6e67 5f66 6967 7572 6520  ocessing_figure 
+0000e3b0: 3d20 7072 6f63 6573 7369 6e67 0a20 2020  = processing.   
+0000e3c0: 2020 2020 2073 656c 662e 6370 755f 6669       self.cpu_fi
+0000e3d0: 6775 7265 203d 2063 7075 0a0a 2020 2020  gure = cpu..    
+0000e3e0: 4077 6974 686f 7574 5f70 726f 7065 7274  @without_propert
+0000e3f0: 795f 7661 6c69 6461 7469 6f6e 0a20 2020  y_validation.   
+0000e400: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
+0000e410: 2064 6566 2075 7064 6174 6528 7365 6c66   def update(self
+0000e420: 293a 0a20 2020 2020 2020 2077 6f72 6b65  ):.        worke
+0000e430: 7273 203d 2073 656c 662e 7363 6865 6475  rs = self.schedu
+0000e440: 6c65 722e 776f 726b 6572 732e 7661 6c75  ler.workers.valu
+0000e450: 6573 2829 0a20 2020 2020 2020 206e 6f77  es().        now
+0000e460: 203d 2074 696d 6528 290a 2020 2020 2020   = time().      
+0000e470: 2020 6966 206e 6f74 2061 6e79 2877 732e    if not any(ws.
+0000e480: 7072 6f63 6573 7369 6e67 2066 6f72 2077  processing for w
+0000e490: 7320 696e 2077 6f72 6b65 7273 2920 616e  s in workers) an
+0000e4a0: 6420 6e6f 7720 3c20 7365 6c66 2e6c 6173  d now < self.las
+0000e4b0: 7420 2b20 313a 0a20 2020 2020 2020 2020  t + 1:.         
+0000e4c0: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
+0000e4d0: 2020 7365 6c66 2e6c 6173 7420 3d20 6e6f    self.last = no
+0000e4e0: 770a 0a20 2020 2020 2020 2063 7075 203d  w..        cpu =
+0000e4f0: 205b 696e 7428 7773 2e6d 6574 7269 6373   [int(ws.metrics
+0000e500: 5b22 6370 7522 5d29 2066 6f72 2077 7320  ["cpu"]) for ws 
+0000e510: 696e 2077 6f72 6b65 7273 5d0a 2020 2020  in workers].    
+0000e520: 2020 2020 6e70 726f 6365 7373 696e 6720      nprocessing 
+0000e530: 3d20 5b6c 656e 2877 732e 7072 6f63 6573  = [len(ws.proces
+0000e540: 7369 6e67 2920 666f 7220 7773 2069 6e20  sing) for ws in 
+0000e550: 776f 726b 6572 735d 0a0a 2020 2020 2020  workers]..      
+0000e560: 2020 6e70 726f 6365 7373 696e 675f 636f    nprocessing_co
+0000e570: 6c6f 7220 3d20 5b5d 0a20 2020 2020 2020  lor = [].       
+0000e580: 2066 6f72 2077 7320 696e 2077 6f72 6b65   for ws in worke
+0000e590: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
+0000e5a0: 6966 2077 7320 696e 2073 656c 662e 7363  if ws in self.sc
+0000e5b0: 6865 6475 6c65 722e 6964 6c65 3a0a 2020  heduler.idle:.  
+0000e5c0: 2020 2020 2020 2020 2020 2020 2020 6e70                np
+0000e5d0: 726f 6365 7373 696e 675f 636f 6c6f 722e  rocessing_color.
+0000e5e0: 6170 7065 6e64 2822 7265 6422 290a 2020  append("red").  
+0000e5f0: 2020 2020 2020 2020 2020 656c 6966 2077            elif w
+0000e600: 7320 696e 2073 656c 662e 7363 6865 6475  s in self.schedu
+0000e610: 6c65 722e 7361 7475 7261 7465 643a 0a20  ler.saturated:. 
+0000e620: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0000e630: 7072 6f63 6573 7369 6e67 5f63 6f6c 6f72  processing_color
+0000e640: 2e61 7070 656e 6428 2267 7265 656e 2229  .append("green")
+0000e650: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0000e660: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000e670: 2020 206e 7072 6f63 6573 7369 6e67 5f63     nprocessing_c
+0000e680: 6f6c 6f72 2e61 7070 656e 6428 2262 6c75  olor.append("blu
+0000e690: 6522 290a 0a20 2020 2020 2020 2072 6573  e")..        res
+0000e6a0: 756c 7420 3d20 7b0a 2020 2020 2020 2020  ult = {.        
+0000e6b0: 2020 2020 2263 7075 223a 2063 7075 2c0a      "cpu": cpu,.
+0000e6c0: 2020 2020 2020 2020 2020 2020 2263 7075              "cpu
+0000e6d0: 2d68 616c 6622 3a20 5b63 202f 2032 2066  -half": [c / 2 f
+0000e6e0: 6f72 2063 2069 6e20 6370 755d 2c0a 2020  or c in cpu],.  
+0000e6f0: 2020 2020 2020 2020 2020 226e 7072 6f63            "nproc
+0000e700: 6573 7369 6e67 223a 206e 7072 6f63 6573  essing": nproces
+0000e710: 7369 6e67 2c0a 2020 2020 2020 2020 2020  sing,.          
+0000e720: 2020 226e 7072 6f63 6573 7369 6e67 2d68    "nprocessing-h
+0000e730: 616c 6622 3a20 5b6e 7020 2f20 3220 666f  alf": [np / 2 fo
+0000e740: 7220 6e70 2069 6e20 6e70 726f 6365 7373  r np in nprocess
+0000e750: 696e 675d 2c0a 2020 2020 2020 2020 2020  ing],.          
+0000e760: 2020 226e 7072 6f63 6573 7369 6e67 2d63    "nprocessing-c
+0000e770: 6f6c 6f72 223a 206e 7072 6f63 6573 7369  olor": nprocessi
+0000e780: 6e67 5f63 6f6c 6f72 2c0a 2020 2020 2020  ng_color,.      
+0000e790: 2020 2020 2020 2277 6f72 6b65 7222 3a20        "worker": 
+0000e7a0: 5b77 732e 6164 6472 6573 7320 666f 7220  [ws.address for 
+0000e7b0: 7773 2069 6e20 776f 726b 6572 735d 2c0a  ws in workers],.
+0000e7c0: 2020 2020 2020 2020 2020 2020 2265 7363              "esc
+0000e7d0: 6170 6564 5f77 6f72 6b65 7222 3a20 5b65  aped_worker": [e
+0000e7e0: 7363 6170 652e 7572 6c5f 6573 6361 7065  scape.url_escape
+0000e7f0: 2877 732e 6164 6472 6573 7329 2066 6f72  (ws.address) for
+0000e800: 2077 7320 696e 2077 6f72 6b65 7273 5d2c   ws in workers],
+0000e810: 0a20 2020 2020 2020 2020 2020 2022 7922  .            "y"
+0000e820: 3a20 6c69 7374 2872 616e 6765 286c 656e  : list(range(len
+0000e830: 2877 6f72 6b65 7273 2929 292c 0a20 2020  (workers))),.   
+0000e840: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+0000e850: 6966 2073 656c 662e 7363 6865 6475 6c65  if self.schedule
+0000e860: 722e 776f 726b 6572 733a 0a20 2020 2020  r.workers:.     
+0000e870: 2020 2020 2020 2078 7261 6e67 6520 3d20         xrange = 
+0000e880: 6d61 7828 7773 2e6e 7468 7265 6164 7320  max(ws.nthreads 
+0000e890: 6f72 2031 2066 6f72 2077 7320 696e 2077  or 1 for ws in w
+0000e8a0: 6f72 6b65 7273 290a 2020 2020 2020 2020  orkers).        
+0000e8b0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000e8c0: 2020 7872 616e 6765 203d 2031 0a20 2020    xrange = 1.   
+0000e8d0: 2020 2020 2073 656c 662e 6370 755f 6669       self.cpu_fi
+0000e8e0: 6775 7265 2e78 5f72 616e 6765 2e65 6e64  gure.x_range.end
+0000e8f0: 203d 2078 7261 6e67 6520 2a20 3130 300a   = xrange * 100.
+0000e900: 0a20 2020 2020 2020 2075 7064 6174 6528  .        update(
+0000e910: 7365 6c66 2e73 6f75 7263 652c 2072 6573  self.source, res
+0000e920: 756c 7429 0a0a 0a63 6c61 7373 2053 7465  ult)...class Ste
+0000e930: 616c 696e 6754 696d 6553 6572 6965 7328  alingTimeSeries(
+0000e940: 4461 7368 626f 6172 6443 6f6d 706f 6e65  DashboardCompone
+0000e950: 6e74 293a 0a20 2020 2064 6566 205f 5f69  nt):.    def __i
+0000e960: 6e69 745f 5f28 7365 6c66 2c20 7363 6865  nit__(self, sche
+0000e970: 6475 6c65 722c 202a 2a6b 7761 7267 7329  duler, **kwargs)
+0000e980: 3a0a 2020 2020 2020 2020 7365 6c66 2e73  :.        self.s
+0000e990: 6368 6564 756c 6572 203d 2073 6368 6564  cheduler = sched
+0000e9a0: 756c 6572 0a20 2020 2020 2020 2073 656c  uler.        sel
+0000e9b0: 662e 736f 7572 6365 203d 2043 6f6c 756d  f.source = Colum
+0000e9c0: 6e44 6174 6153 6f75 7263 6528 0a20 2020  nDataSource(.   
+0000e9d0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0000e9e0: 2020 2020 2020 2020 2020 2022 7469 6d65             "time
+0000e9f0: 223a 205b 7469 6d65 2829 202a 2031 3030  ": [time() * 100
+0000ea00: 302c 2074 696d 6528 2920 2a20 3130 3030  0, time() * 1000
+0000ea10: 202b 2031 5d2c 0a20 2020 2020 2020 2020   + 1],.         
+0000ea20: 2020 2020 2020 2022 6964 6c65 223a 205b         "idle": [
+0000ea30: 302c 2030 5d2c 0a20 2020 2020 2020 2020  0, 0],.         
+0000ea40: 2020 2020 2020 2022 7361 7475 7261 7465         "saturate
+0000ea50: 6422 3a20 5b30 2c20 305d 2c0a 2020 2020  d": [0, 0],.    
+0000ea60: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0000ea70: 2020 290a 0a20 2020 2020 2020 2078 5f72    )..        x_r
+0000ea80: 616e 6765 203d 2044 6174 6152 616e 6765  ange = DataRange
+0000ea90: 3164 2866 6f6c 6c6f 773d 2265 6e64 222c  1d(follow="end",
+0000eaa0: 2066 6f6c 6c6f 775f 696e 7465 7276 616c   follow_interval
+0000eab0: 3d32 3030 3030 2c20 7261 6e67 655f 7061  =20000, range_pa
+0000eac0: 6464 696e 673d 3029 0a0a 2020 2020 2020  dding=0)..      
+0000ead0: 2020 7365 6c66 2e72 6f6f 7420 3d20 6669    self.root = fi
+0000eae0: 6775 7265 280a 2020 2020 2020 2020 2020  gure(.          
+0000eaf0: 2020 7469 746c 653d 2249 646c 6520 616e    title="Idle an
+0000eb00: 6420 5361 7475 7261 7465 6420 576f 726b  d Saturated Work
+0000eb10: 6572 7320 4f76 6572 2054 696d 6522 2c0a  ers Over Time",.
+0000eb20: 2020 2020 2020 2020 2020 2020 785f 6178              x_ax
+0000eb30: 6973 5f74 7970 653d 2264 6174 6574 696d  is_type="datetim
+0000eb40: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+0000eb50: 746f 6f6c 733d 2222 2c0a 2020 2020 2020  tools="",.      
+0000eb60: 2020 2020 2020 785f 7261 6e67 653d 785f        x_range=x_
+0000eb70: 7261 6e67 652c 0a20 2020 2020 2020 2020  range,.         
+0000eb80: 2020 202a 2a6b 7761 7267 732c 0a20 2020     **kwargs,.   
+0000eb90: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+0000eba0: 656c 662e 726f 6f74 2e6c 696e 6528 736f  elf.root.line(so
+0000ebb0: 7572 6365 3d73 656c 662e 736f 7572 6365  urce=self.source
+0000ebc0: 2c20 783d 2274 696d 6522 2c20 793d 2269  , x="time", y="i
+0000ebd0: 646c 6522 2c20 636f 6c6f 723d 2272 6564  dle", color="red
+0000ebe0: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
+0000ebf0: 726f 6f74 2e6c 696e 6528 736f 7572 6365  root.line(source
+0000ec00: 3d73 656c 662e 736f 7572 6365 2c20 783d  =self.source, x=
+0000ec10: 2274 696d 6522 2c20 793d 2273 6174 7572  "time", y="satur
+0000ec20: 6174 6564 222c 2063 6f6c 6f72 3d22 6772  ated", color="gr
+0000ec30: 6565 6e22 290a 2020 2020 2020 2020 7365  een").        se
+0000ec40: 6c66 2e72 6f6f 742e 7961 7869 732e 6d69  lf.root.yaxis.mi
+0000ec50: 6e6f 725f 7469 636b 5f6c 696e 655f 636f  nor_tick_line_co
+0000ec60: 6c6f 7220 3d20 4e6f 6e65 0a0a 2020 2020  lor = None..    
+0000ec70: 2020 2020 7365 6c66 2e72 6f6f 742e 6164      self.root.ad
+0000ec80: 645f 746f 6f6c 7328 0a20 2020 2020 2020  d_tools(.       
+0000ec90: 2020 2020 2052 6573 6574 546f 6f6c 2829       ResetTool()
+0000eca0: 2c20 5061 6e54 6f6f 6c28 6469 6d65 6e73  , PanTool(dimens
+0000ecb0: 696f 6e73 3d22 7769 6474 6822 292c 2057  ions="width"), W
+0000ecc0: 6865 656c 5a6f 6f6d 546f 6f6c 2864 696d  heelZoomTool(dim
+0000ecd0: 656e 7369 6f6e 733d 2277 6964 7468 2229  ensions="width")
+0000ece0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0000ecf0: 4077 6974 686f 7574 5f70 726f 7065 7274  @without_propert
+0000ed00: 795f 7661 6c69 6461 7469 6f6e 0a20 2020  y_validation.   
+0000ed10: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
+0000ed20: 2064 6566 2075 7064 6174 6528 7365 6c66   def update(self
+0000ed30: 293a 0a20 2020 2020 2020 2072 6573 756c  ):.        resul
+0000ed40: 7420 3d20 7b0a 2020 2020 2020 2020 2020  t = {.          
+0000ed50: 2020 2274 696d 6522 3a20 5b74 696d 6528    "time": [time(
+0000ed60: 2920 2a20 3130 3030 5d2c 0a20 2020 2020  ) * 1000],.     
+0000ed70: 2020 2020 2020 2022 6964 6c65 223a 205b         "idle": [
+0000ed80: 6c65 6e28 7365 6c66 2e73 6368 6564 756c  len(self.schedul
+0000ed90: 6572 2e69 646c 6529 5d2c 0a20 2020 2020  er.idle)],.     
+0000eda0: 2020 2020 2020 2022 7361 7475 7261 7465         "saturate
+0000edb0: 6422 3a20 5b6c 656e 2873 656c 662e 7363  d": [len(self.sc
+0000edc0: 6865 6475 6c65 722e 7361 7475 7261 7465  heduler.saturate
+0000edd0: 6429 5d2c 0a20 2020 2020 2020 207d 0a20  d)],.        }. 
+0000ede0: 2020 2020 2020 2069 6620 5052 4f46 494c         if PROFIL
+0000edf0: 494e 473a 0a20 2020 2020 2020 2020 2020  ING:.           
+0000ee00: 2063 7572 646f 6328 292e 6164 645f 6e65   curdoc().add_ne
+0000ee10: 7874 5f74 6963 6b5f 6361 6c6c 6261 636b  xt_tick_callback
+0000ee20: 286c 616d 6264 613a 2073 656c 662e 736f  (lambda: self.so
+0000ee30: 7572 6365 2e73 7472 6561 6d28 7265 7375  urce.stream(resu
+0000ee40: 6c74 2c20 3130 3030 3029 290a 2020 2020  lt, 10000)).    
+0000ee50: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000ee60: 2020 2020 2020 7365 6c66 2e73 6f75 7263        self.sourc
+0000ee70: 652e 7374 7265 616d 2872 6573 756c 742c  e.stream(result,
+0000ee80: 2031 3030 3030 290a 0a0a 636c 6173 7320   10000)...class 
+0000ee90: 5374 6561 6c69 6e67 4576 656e 7473 2844  StealingEvents(D
+0000eea0: 6173 6862 6f61 7264 436f 6d70 6f6e 656e  ashboardComponen
+0000eeb0: 7429 3a0a 2020 2020 6465 6620 5f5f 696e  t):.    def __in
+0000eec0: 6974 5f5f 2873 656c 662c 2073 6368 6564  it__(self, sched
+0000eed0: 756c 6572 2c20 2a2a 6b77 6172 6773 293a  uler, **kwargs):
+0000eee0: 0a20 2020 2020 2020 2073 656c 662e 7363  .        self.sc
+0000eef0: 6865 6475 6c65 7220 3d20 7363 6865 6475  heduler = schedu
+0000ef00: 6c65 720a 2020 2020 2020 2020 7365 6c66  ler.        self
+0000ef10: 2e73 7465 616c 203d 2073 6368 6564 756c  .steal = schedul
+0000ef20: 6572 2e65 7874 656e 7369 6f6e 735b 2273  er.extensions["s
+0000ef30: 7465 616c 696e 6722 5d0a 2020 2020 2020  tealing"].      
+0000ef40: 2020 7365 6c66 2e6c 6173 7420 3d20 300a    self.last = 0.
+0000ef50: 2020 2020 2020 2020 7365 6c66 2e73 6f75          self.sou
+0000ef60: 7263 6520 3d20 436f 6c75 6d6e 4461 7461  rce = ColumnData
+0000ef70: 536f 7572 6365 280a 2020 2020 2020 2020  Source(.        
+0000ef80: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0000ef90: 2020 2020 2020 2274 696d 6522 3a20 5b74        "time": [t
+0000efa0: 696d 6528 2920 2d20 3630 2c20 7469 6d65  ime() - 60, time
+0000efb0: 2829 5d2c 0a20 2020 2020 2020 2020 2020  ()],.           
+0000efc0: 2020 2020 2022 6c65 7665 6c22 3a20 5b30       "level": [0
+0000efd0: 2c20 3135 5d2c 0a20 2020 2020 2020 2020  , 15],.         
+0000efe0: 2020 2020 2020 2022 636f 6c6f 7222 3a20         "color": 
+0000eff0: 5b22 7768 6974 6522 2c20 2277 6869 7465  ["white", "white
+0000f000: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
+0000f010: 2020 2020 2264 7572 6174 696f 6e22 3a20      "duration": 
+0000f020: 5b30 2c20 305d 2c0a 2020 2020 2020 2020  [0, 0],.        
+0000f030: 2020 2020 2020 2020 2272 6164 6975 7322          "radius"
+0000f040: 3a20 5b31 2c20 315d 2c0a 2020 2020 2020  : [1, 1],.      
+0000f050: 2020 2020 2020 2020 2020 2263 6f73 745f            "cost_
+0000f060: 6661 6374 6f72 223a 205b 302c 2031 305d  factor": [0, 10]
+0000f070: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000f080: 2020 2263 6f75 6e74 223a 205b 312c 2031    "count": [1, 1
+0000f090: 5d2c 0a20 2020 2020 2020 2020 2020 207d  ],.            }
+0000f0a0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0000f0b0: 2020 2020 785f 7261 6e67 6520 3d20 4461      x_range = Da
+0000f0c0: 7461 5261 6e67 6531 6428 666f 6c6c 6f77  taRange1d(follow
+0000f0d0: 3d22 656e 6422 2c20 666f 6c6c 6f77 5f69  ="end", follow_i
+0000f0e0: 6e74 6572 7661 6c3d 3230 3030 302c 2072  nterval=20000, r
+0000f0f0: 616e 6765 5f70 6164 6469 6e67 3d30 290a  ange_padding=0).
+0000f100: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+0000f110: 6f74 203d 2066 6967 7572 6528 0a20 2020  ot = figure(.   
+0000f120: 2020 2020 2020 2020 2074 6974 6c65 3d22           title="
+0000f130: 5374 6561 6c69 6e67 2045 7665 6e74 7322  Stealing Events"
+0000f140: 2c0a 2020 2020 2020 2020 2020 2020 785f  ,.            x_
+0000f150: 6178 6973 5f74 7970 653d 2264 6174 6574  axis_type="datet
+0000f160: 696d 6522 2c0a 2020 2020 2020 2020 2020  ime",.          
+0000f170: 2020 746f 6f6c 733d 2222 2c0a 2020 2020    tools="",.    
+0000f180: 2020 2020 2020 2020 785f 7261 6e67 653d          x_range=
+0000f190: 785f 7261 6e67 652c 0a20 2020 2020 2020  x_range,.       
+0000f1a0: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
+0000f1b0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0000f1c0: 2020 7365 6c66 2e72 6f6f 742e 6369 7263    self.root.circ
+0000f1d0: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
+0000f1e0: 736f 7572 6365 3d73 656c 662e 736f 7572  source=self.sour
+0000f1f0: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
+0000f200: 783d 2274 696d 6522 2c0a 2020 2020 2020  x="time",.      
+0000f210: 2020 2020 2020 793d 226c 6576 656c 222c        y="level",
+0000f220: 0a20 2020 2020 2020 2020 2020 2063 6f6c  .            col
+0000f230: 6f72 3d22 636f 6c6f 7222 2c0a 2020 2020  or="color",.    
+0000f240: 2020 2020 2020 2020 7369 7a65 3d22 7261          size="ra
+0000f250: 6469 7573 222c 0a20 2020 2020 2020 2020  dius",.         
+0000f260: 2020 2061 6c70 6861 3d30 2e35 2c0a 2020     alpha=0.5,.  
+0000f270: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000f280: 7365 6c66 2e72 6f6f 742e 7961 7869 732e  self.root.yaxis.
+0000f290: 6178 6973 5f6c 6162 656c 203d 2022 4c65  axis_label = "Le
+0000f2a0: 7665 6c22 0a0a 2020 2020 2020 2020 686f  vel"..        ho
+0000f2b0: 7665 7220 3d20 486f 7665 7254 6f6f 6c28  ver = HoverTool(
+0000f2c0: 290a 2020 2020 2020 2020 686f 7665 722e  ).        hover.
+0000f2d0: 746f 6f6c 7469 7073 203d 2022 4c65 7665  tooltips = "Leve
+0000f2e0: 6c3a 2040 6c65 7665 6c2c 2044 7572 6174  l: @level, Durat
+0000f2f0: 696f 6e3a 2040 6475 7261 7469 6f6e 2c20  ion: @duration, 
+0000f300: 436f 756e 743a 2040 636f 756e 742c 2043  Count: @count, C
+0000f310: 6f73 7420 6661 6374 6f72 3a20 4063 6f73  ost factor: @cos
+0000f320: 745f 6661 6374 6f72 220a 2020 2020 2020  t_factor".      
+0000f330: 2020 686f 7665 722e 706f 696e 745f 706f    hover.point_po
+0000f340: 6c69 6379 203d 2022 666f 6c6c 6f77 5f6d  licy = "follow_m
+0000f350: 6f75 7365 220a 0a20 2020 2020 2020 2073  ouse"..        s
+0000f360: 656c 662e 726f 6f74 2e61 6464 5f74 6f6f  elf.root.add_too
+0000f370: 6c73 280a 2020 2020 2020 2020 2020 2020  ls(.            
+0000f380: 686f 7665 722c 0a20 2020 2020 2020 2020  hover,.         
+0000f390: 2020 2052 6573 6574 546f 6f6c 2829 2c0a     ResetTool(),.
+0000f3a0: 2020 2020 2020 2020 2020 2020 5061 6e54              PanT
+0000f3b0: 6f6f 6c28 6469 6d65 6e73 696f 6e73 3d22  ool(dimensions="
+0000f3c0: 7769 6474 6822 292c 0a20 2020 2020 2020  width"),.       
+0000f3d0: 2020 2020 2057 6865 656c 5a6f 6f6d 546f       WheelZoomTo
+0000f3e0: 6f6c 2864 696d 656e 7369 6f6e 733d 2277  ol(dimensions="w
+0000f3f0: 6964 7468 2229 2c0a 2020 2020 2020 2020  idth"),.        
+0000f400: 290a 0a20 2020 2064 6566 2063 6f6e 7665  )..    def conve
+0000f410: 7274 2873 656c 662c 206d 7367 7329 3a0a  rt(self, msgs):.
+0000f420: 2020 2020 2020 2020 2222 2243 6f6e 7665          """Conve
+0000f430: 7274 2061 206c 6f67 206d 6573 7361 6765  rt a log message
+0000f440: 2074 6f20 6120 676c 7970 6822 2222 0a20   to a glyph""". 
+0000f450: 2020 2020 2020 2074 6f74 616c 5f64 7572         total_dur
+0000f460: 6174 696f 6e20 3d20 300a 2020 2020 2020  ation = 0.      
+0000f470: 2020 666f 7220 6d73 6720 696e 206d 7367    for msg in msg
+0000f480: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
+0000f490: 696d 652c 206c 6576 656c 2c20 6b65 792c  ime, level, key,
+0000f4a0: 2064 7572 6174 696f 6e2c 2073 6174 2c20   duration, sat, 
+0000f4b0: 6f63 635f 7361 742c 2069 646c 2c20 6f63  occ_sat, idl, oc
+0000f4c0: 635f 6964 6c20 3d20 6d73 675b 3a38 5d0a  c_idl = msg[:8].
+0000f4d0: 2020 2020 2020 2020 2020 2020 746f 7461              tota
+0000f4e0: 6c5f 6475 7261 7469 6f6e 202b 3d20 6475  l_duration += du
+0000f4f0: 7261 7469 6f6e 0a0a 2020 2020 2020 2020  ration..        
+0000f500: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0000f510: 2063 6f6c 6f72 203d 2056 6972 6964 6973   color = Viridis
+0000f520: 3131 5b6c 6576 656c 5d0a 2020 2020 2020  11[level].      
+0000f530: 2020 6578 6365 7074 2028 4b65 7945 7272    except (KeyErr
+0000f540: 6f72 2c20 496e 6465 7845 7272 6f72 293a  or, IndexError):
+0000f550: 0a20 2020 2020 2020 2020 2020 2063 6f6c  .            col
+0000f560: 6f72 203d 2022 626c 6163 6b22 0a0a 2020  or = "black"..  
+0000f570: 2020 2020 2020 7261 6469 7573 203d 206d        radius = m
+0000f580: 6174 682e 7371 7274 286d 696e 2874 6f74  ath.sqrt(min(tot
+0000f590: 616c 5f64 7572 6174 696f 6e2c 2031 3029  al_duration, 10)
+0000f5a0: 2920 2a20 3330 202b 2032 0a0a 2020 2020  ) * 30 + 2..    
+0000f5b0: 2020 2020 6420 3d20 7b0a 2020 2020 2020      d = {.      
+0000f5c0: 2020 2020 2020 2274 696d 6522 3a20 7469        "time": ti
+0000f5d0: 6d65 202a 2031 3030 302c 0a20 2020 2020  me * 1000,.     
+0000f5e0: 2020 2020 2020 2022 6c65 7665 6c22 3a20         "level": 
+0000f5f0: 6c65 7665 6c2c 0a20 2020 2020 2020 2020  level,.         
+0000f600: 2020 2022 636f 756e 7422 3a20 6c65 6e28     "count": len(
+0000f610: 6d73 6773 292c 0a20 2020 2020 2020 2020  msgs),.         
+0000f620: 2020 2022 636f 6c6f 7222 3a20 636f 6c6f     "color": colo
+0000f630: 722c 0a20 2020 2020 2020 2020 2020 2022  r,.            "
+0000f640: 6475 7261 7469 6f6e 223a 2074 6f74 616c  duration": total
+0000f650: 5f64 7572 6174 696f 6e2c 0a20 2020 2020  _duration,.     
+0000f660: 2020 2020 2020 2022 7261 6469 7573 223a         "radius":
+0000f670: 2072 6164 6975 732c 0a20 2020 2020 2020   radius,.       
+0000f680: 2020 2020 2022 636f 7374 5f66 6163 746f       "cost_facto
+0000f690: 7222 3a20 7365 6c66 2e73 7465 616c 2e63  r": self.steal.c
+0000f6a0: 6f73 745f 6d75 6c74 6970 6c69 6572 735b  ost_multipliers[
+0000f6b0: 6c65 7665 6c5d 2c0a 2020 2020 2020 2020  level],.        
+0000f6c0: 7d0a 0a20 2020 2020 2020 2072 6574 7572  }..        retur
+0000f6d0: 6e20 640a 0a20 2020 2040 7769 7468 6f75  n d..    @withou
+0000f6e0: 745f 7072 6f70 6572 7479 5f76 616c 6964  t_property_valid
+0000f6f0: 6174 696f 6e0a 2020 2020 406c 6f67 5f65  ation.    @log_e
+0000f700: 7272 6f72 730a 2020 2020 6465 6620 7570  rrors.    def up
+0000f710: 6461 7465 2873 656c 6629 3a0a 2020 2020  date(self):.    
+0000f720: 2020 2020 6c6f 6720 3d20 7365 6c66 2e73      log = self.s
+0000f730: 6368 6564 756c 6572 2e67 6574 5f65 7665  cheduler.get_eve
+0000f740: 6e74 7328 746f 7069 633d 2273 7465 616c  nts(topic="steal
+0000f750: 696e 6722 290a 2020 2020 2020 2020 6375  ing").        cu
+0000f760: 7272 656e 7420 3d20 6c65 6e28 7365 6c66  rrent = len(self
+0000f770: 2e73 6368 6564 756c 6572 2e65 7665 6e74  .scheduler.event
+0000f780: 735b 2273 7465 616c 696e 6722 5d29 0a20  s["stealing"]). 
+0000f790: 2020 2020 2020 206e 203d 2063 7572 7265         n = curre
+0000f7a0: 6e74 202d 2073 656c 662e 6c61 7374 0a0a  nt - self.last..
+0000f7b0: 2020 2020 2020 2020 6c6f 6720 3d20 5b6c          log = [l
+0000f7c0: 6f67 5b2d 695d 5b31 5d5b 315d 2066 6f72  og[-i][1][1] for
+0000f7d0: 2069 2069 6e20 7261 6e67 6528 312c 206e   i in range(1, n
+0000f7e0: 202b 2031 2920 6966 206c 6f67 5b2d 695d   + 1) if log[-i]
+0000f7f0: 5b31 5d5b 305d 203d 3d20 2272 6571 7565  [1][0] == "reque
+0000f800: 7374 225d 0a20 2020 2020 2020 2073 656c  st"].        sel
+0000f810: 662e 6c61 7374 203d 2063 7572 7265 6e74  f.last = current
+0000f820: 0a0a 2020 2020 2020 2020 6966 206c 6f67  ..        if log
+0000f830: 3a0a 2020 2020 2020 2020 2020 2020 6e65  :.            ne
+0000f840: 7720 3d20 7069 7065 280a 2020 2020 2020  w = pipe(.      
+0000f850: 2020 2020 2020 2020 2020 6c6f 672c 0a20            log,. 
+0000f860: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0000f870: 6170 2867 726f 7570 6279 2831 2929 2c0a  ap(groupby(1)),.
+0000f880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f890: 6d61 7028 6469 6374 2e76 616c 7565 7329  map(dict.values)
+0000f8a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000f8b0: 2020 636f 6e63 6174 2c0a 2020 2020 2020    concat,.      
+0000f8c0: 2020 2020 2020 2020 2020 6d61 7028 7365            map(se
+0000f8d0: 6c66 2e63 6f6e 7665 7274 292c 0a20 2020  lf.convert),.   
+0000f8e0: 2020 2020 2020 2020 2020 2020 206c 6973               lis
+0000f8f0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+0000f900: 2020 2074 7261 6e73 706f 7365 2c0a 2020     transpose,.  
+0000f910: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0000f920: 2020 2020 2020 2020 6966 2050 524f 4649          if PROFI
+0000f930: 4c49 4e47 3a0a 2020 2020 2020 2020 2020  LING:.          
+0000f940: 2020 2020 2020 6375 7264 6f63 2829 2e61        curdoc().a
+0000f950: 6464 5f6e 6578 745f 7469 636b 5f63 616c  dd_next_tick_cal
+0000f960: 6c62 6163 6b28 6c61 6d62 6461 3a20 7365  lback(lambda: se
+0000f970: 6c66 2e73 6f75 7263 652e 7374 7265 616d  lf.source.stream
+0000f980: 286e 6577 2c20 3130 3030 3029 290a 2020  (new, 10000)).  
+0000f990: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0000f9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f9b0: 7365 6c66 2e73 6f75 7263 652e 7374 7265  self.source.stre
+0000f9c0: 616d 286e 6577 2c20 3130 3030 3029 0a0a  am(new, 10000)..
+0000f9d0: 0a63 6c61 7373 2045 7665 6e74 7328 4461  .class Events(Da
+0000f9e0: 7368 626f 6172 6443 6f6d 706f 6e65 6e74  shboardComponent
+0000f9f0: 293a 0a20 2020 2064 6566 205f 5f69 6e69  ):.    def __ini
+0000fa00: 745f 5f28 7365 6c66 2c20 7363 6865 6475  t__(self, schedu
+0000fa10: 6c65 722c 206e 616d 652c 2068 6569 6768  ler, name, heigh
+0000fa20: 743d 3135 302c 202a 2a6b 7761 7267 7329  t=150, **kwargs)
+0000fa30: 3a0a 2020 2020 2020 2020 7365 6c66 2e73  :.        self.s
+0000fa40: 6368 6564 756c 6572 203d 2073 6368 6564  cheduler = sched
+0000fa50: 756c 6572 0a20 2020 2020 2020 2073 656c  uler.        sel
+0000fa60: 662e 6163 7469 6f6e 5f79 7320 3d20 6469  f.action_ys = di
+0000fa70: 6374 2829 0a20 2020 2020 2020 2073 656c  ct().        sel
+0000fa80: 662e 6c61 7374 203d 2030 0a20 2020 2020  f.last = 0.     
+0000fa90: 2020 2073 656c 662e 6e61 6d65 203d 206e     self.name = n
+0000faa0: 616d 650a 2020 2020 2020 2020 7365 6c66  ame.        self
+0000fab0: 2e73 6f75 7263 6520 3d20 436f 6c75 6d6e  .source = Column
+0000fac0: 4461 7461 536f 7572 6365 280a 2020 2020  DataSource(.    
+0000fad0: 2020 2020 2020 2020 7b22 7469 6d65 223a          {"time":
+0000fae0: 205b 5d2c 2022 6163 7469 6f6e 223a 205b   [], "action": [
+0000faf0: 5d2c 2022 686f 7665 7222 3a20 5b5d 2c20  ], "hover": [], 
+0000fb00: 2279 223a 205b 5d2c 2022 636f 6c6f 7222  "y": [], "color"
+0000fb10: 3a20 5b5d 7d0a 2020 2020 2020 2020 290a  : []}.        ).
+0000fb20: 0a20 2020 2020 2020 2078 5f72 616e 6765  .        x_range
+0000fb30: 203d 2044 6174 6152 616e 6765 3164 2866   = DataRange1d(f
+0000fb40: 6f6c 6c6f 773d 2265 6e64 222c 2066 6f6c  ollow="end", fol
+0000fb50: 6c6f 775f 696e 7465 7276 616c 3d32 3030  low_interval=200
+0000fb60: 3030 3029 0a0a 2020 2020 2020 2020 7365  000)..        se
+0000fb70: 6c66 2e72 6f6f 7420 3d20 6669 6775 7265  lf.root = figure
+0000fb80: 280a 2020 2020 2020 2020 2020 2020 7469  (.            ti
+0000fb90: 746c 653d 6e61 6d65 2c0a 2020 2020 2020  tle=name,.      
+0000fba0: 2020 2020 2020 785f 6178 6973 5f74 7970        x_axis_typ
+0000fbb0: 653d 2264 6174 6574 696d 6522 2c0a 2020  e="datetime",.  
+0000fbc0: 2020 2020 2020 2020 2020 6865 6967 6874            height
+0000fbd0: 3d68 6569 6768 742c 0a20 2020 2020 2020  =height,.       
+0000fbe0: 2020 2020 2074 6f6f 6c73 3d22 222c 0a20       tools="",. 
+0000fbf0: 2020 2020 2020 2020 2020 2078 5f72 616e             x_ran
+0000fc00: 6765 3d78 5f72 616e 6765 2c0a 2020 2020  ge=x_range,.    
+0000fc10: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+0000fc20: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+0000fc30: 2020 2020 2073 656c 662e 726f 6f74 2e63       self.root.c
+0000fc40: 6972 636c 6528 0a20 2020 2020 2020 2020  ircle(.         
+0000fc50: 2020 2073 6f75 7263 653d 7365 6c66 2e73     source=self.s
+0000fc60: 6f75 7263 652c 0a20 2020 2020 2020 2020  ource,.         
+0000fc70: 2020 2078 3d22 7469 6d65 222c 0a20 2020     x="time",.   
+0000fc80: 2020 2020 2020 2020 2079 3d22 7922 2c0a           y="y",.
+0000fc90: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
+0000fca0: 723d 2263 6f6c 6f72 222c 0a20 2020 2020  r="color",.     
+0000fcb0: 2020 2020 2020 2073 697a 653d 3530 2c0a         size=50,.
+0000fcc0: 2020 2020 2020 2020 2020 2020 616c 7068              alph
+0000fcd0: 613d 302e 352c 0a20 2020 2020 2020 2020  a=0.5,.         
+0000fce0: 2020 206c 6567 656e 645f 6669 656c 643d     legend_field=
+0000fcf0: 2261 6374 696f 6e22 2c0a 2020 2020 2020  "action",.      
+0000fd00: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+0000fd10: 2e72 6f6f 742e 7961 7869 732e 6178 6973  .root.yaxis.axis
+0000fd20: 5f6c 6162 656c 203d 2022 4163 7469 6f6e  _label = "Action
+0000fd30: 220a 2020 2020 2020 2020 7365 6c66 2e72  ".        self.r
+0000fd40: 6f6f 742e 6c65 6765 6e64 2e6c 6f63 6174  oot.legend.locat
+0000fd50: 696f 6e20 3d20 2274 6f70 5f6c 6566 7422  ion = "top_left"
+0000fd60: 0a0a 2020 2020 2020 2020 686f 7665 7220  ..        hover 
+0000fd70: 3d20 486f 7665 7254 6f6f 6c28 290a 2020  = HoverTool().  
+0000fd80: 2020 2020 2020 686f 7665 722e 746f 6f6c        hover.tool
+0000fd90: 7469 7073 203d 2022 4061 6374 696f 6e3c  tips = "@action<
+0000fda0: 6272 3e40 686f 7665 7222 0a20 2020 2020  br>@hover".     
+0000fdb0: 2020 2068 6f76 6572 2e70 6f69 6e74 5f70     hover.point_p
+0000fdc0: 6f6c 6963 7920 3d20 2266 6f6c 6c6f 775f  olicy = "follow_
+0000fdd0: 6d6f 7573 6522 0a0a 2020 2020 2020 2020  mouse"..        
+0000fde0: 7365 6c66 2e72 6f6f 742e 6164 645f 746f  self.root.add_to
+0000fdf0: 6f6c 7328 0a20 2020 2020 2020 2020 2020  ols(.           
+0000fe00: 2068 6f76 6572 2c0a 2020 2020 2020 2020   hover,.        
+0000fe10: 2020 2020 5265 7365 7454 6f6f 6c28 292c      ResetTool(),
+0000fe20: 0a20 2020 2020 2020 2020 2020 2050 616e  .            Pan
+0000fe30: 546f 6f6c 2864 696d 656e 7369 6f6e 733d  Tool(dimensions=
+0000fe40: 2277 6964 7468 2229 2c0a 2020 2020 2020  "width"),.      
+0000fe50: 2020 2020 2020 5768 6565 6c5a 6f6f 6d54        WheelZoomT
+0000fe60: 6f6f 6c28 6469 6d65 6e73 696f 6e73 3d22  ool(dimensions="
+0000fe70: 7769 6474 6822 292c 0a20 2020 2020 2020  width"),.       
+0000fe80: 2029 0a0a 2020 2020 4077 6974 686f 7574   )..    @without
+0000fe90: 5f70 726f 7065 7274 795f 7661 6c69 6461  _property_valida
+0000fea0: 7469 6f6e 0a20 2020 2040 6c6f 675f 6572  tion.    @log_er
+0000feb0: 726f 7273 0a20 2020 2064 6566 2075 7064  rors.    def upd
+0000fec0: 6174 6528 7365 6c66 293a 0a20 2020 2020  ate(self):.     
+0000fed0: 2020 206c 6f67 203d 2073 656c 662e 7363     log = self.sc
+0000fee0: 6865 6475 6c65 722e 6576 656e 7473 5b73  heduler.events[s
+0000fef0: 656c 662e 6e61 6d65 5d0a 2020 2020 2020  elf.name].      
+0000ff00: 2020 6e20 3d20 7365 6c66 2e73 6368 6564    n = self.sched
+0000ff10: 756c 6572 2e65 7665 6e74 5f63 6f75 6e74  uler.event_count
+0000ff20: 735b 7365 6c66 2e6e 616d 655d 202d 2073  s[self.name] - s
+0000ff30: 656c 662e 6c61 7374 0a20 2020 2020 2020  elf.last.       
+0000ff40: 2069 6620 6c6f 673a 0a20 2020 2020 2020   if log:.       
+0000ff50: 2020 2020 206c 6f67 203d 205b 6c6f 675b       log = [log[
+0000ff60: 2d69 5d20 666f 7220 6920 696e 2072 616e  -i] for i in ran
+0000ff70: 6765 2831 2c20 6e20 2b20 3129 5d0a 2020  ge(1, n + 1)].  
+0000ff80: 2020 2020 2020 7365 6c66 2e6c 6173 7420        self.last 
+0000ff90: 3d20 7365 6c66 2e73 6368 6564 756c 6572  = self.scheduler
+0000ffa0: 2e65 7665 6e74 5f63 6f75 6e74 735b 7365  .event_counts[se
+0000ffb0: 6c66 2e6e 616d 655d 0a0a 2020 2020 2020  lf.name]..      
+0000ffc0: 2020 6966 206c 6f67 3a0a 2020 2020 2020    if log:.      
+0000ffd0: 2020 2020 2020 6163 7469 6f6e 7320 3d20        actions = 
+0000ffe0: 5b5d 0a20 2020 2020 2020 2020 2020 2074  [].            t
+0000fff0: 696d 6573 203d 205b 5d0a 2020 2020 2020  imes = [].      
+00010000: 2020 2020 2020 686f 7665 7273 203d 205b        hovers = [
+00010010: 5d0a 2020 2020 2020 2020 2020 2020 7973  ].            ys
+00010020: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
+00010030: 2020 636f 6c6f 7273 203d 205b 5d0a 2020    colors = [].  
+00010040: 2020 2020 2020 2020 2020 666f 7220 6d73            for ms
+00010050: 675f 7469 6d65 2c20 6d73 6720 696e 206c  g_time, msg in l
+00010060: 6f67 3a0a 2020 2020 2020 2020 2020 2020  og:.            
+00010070: 2020 2020 7469 6d65 732e 6170 7065 6e64      times.append
+00010080: 286d 7367 5f74 696d 6520 2a20 3130 3030  (msg_time * 1000
+00010090: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000100a0: 2020 6163 7469 6f6e 203d 206d 7367 5b22    action = msg["
+000100b0: 6163 7469 6f6e 225d 0a20 2020 2020 2020  action"].       
+000100c0: 2020 2020 2020 2020 2061 6374 696f 6e73           actions
+000100d0: 2e61 7070 656e 6428 6163 7469 6f6e 290a  .append(action).
+000100e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000100f0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00010100: 2020 2020 2020 2020 2079 732e 6170 7065           ys.appe
+00010110: 6e64 2873 656c 662e 6163 7469 6f6e 5f79  nd(self.action_y
+00010120: 735b 6163 7469 6f6e 5d29 0a20 2020 2020  s[action]).     
+00010130: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00010140: 7420 4b65 7945 7272 6f72 3a0a 2020 2020  t KeyError:.    
+00010150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010160: 7365 6c66 2e61 6374 696f 6e5f 7973 5b61  self.action_ys[a
+00010170: 6374 696f 6e5d 203d 206c 656e 2873 656c  ction] = len(sel
+00010180: 662e 6163 7469 6f6e 5f79 7329 0a20 2020  f.action_ys).   
+00010190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000101a0: 2079 732e 6170 7065 6e64 2873 656c 662e   ys.append(self.
+000101b0: 6163 7469 6f6e 5f79 735b 6163 7469 6f6e  action_ys[action
+000101c0: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+000101d0: 2020 2063 6f6c 6f72 732e 6170 7065 6e64     colors.append
+000101e0: 2863 6f6c 6f72 5f6f 6628 6163 7469 6f6e  (color_of(action
+000101f0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00010200: 2020 2068 6f76 6572 732e 6170 7065 6e64     hovers.append
+00010210: 2822 544f 444f 2229 0a0a 2020 2020 2020  ("TODO")..      
+00010220: 2020 2020 2020 6e65 7720 3d20 7b0a 2020        new = {.  
+00010230: 2020 2020 2020 2020 2020 2020 2020 2274                "t
+00010240: 696d 6522 3a20 7469 6d65 732c 0a20 2020  ime": times,.   
+00010250: 2020 2020 2020 2020 2020 2020 2022 6163               "ac
+00010260: 7469 6f6e 223a 2061 6374 696f 6e73 2c0a  tion": actions,.
+00010270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010280: 2268 6f76 6572 223a 2068 6f76 6572 732c  "hover": hovers,
+00010290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000102a0: 2022 7922 3a20 7973 2c0a 2020 2020 2020   "y": ys,.      
+000102b0: 2020 2020 2020 2020 2020 2263 6f6c 6f72            "color
+000102c0: 223a 2063 6f6c 6f72 732c 0a20 2020 2020  ": colors,.     
+000102d0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+000102e0: 2020 2020 2020 6966 2050 524f 4649 4c49        if PROFILI
+000102f0: 4e47 3a0a 2020 2020 2020 2020 2020 2020  NG:.            
+00010300: 2020 2020 6375 7264 6f63 2829 2e61 6464      curdoc().add
+00010310: 5f6e 6578 745f 7469 636b 5f63 616c 6c62  _next_tick_callb
+00010320: 6163 6b28 6c61 6d62 6461 3a20 7365 6c66  ack(lambda: self
+00010330: 2e73 6f75 7263 652e 7374 7265 616d 286e  .source.stream(n
+00010340: 6577 2c20 3130 3030 3029 290a 2020 2020  ew, 10000)).    
+00010350: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00010360: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00010370: 6c66 2e73 6f75 7263 652e 7374 7265 616d  lf.source.stream
+00010380: 286e 6577 2c20 3130 3030 3029 0a0a 0a63  (new, 10000)...c
+00010390: 6c61 7373 2054 6173 6b53 7472 6561 6d28  lass TaskStream(
+000103a0: 4461 7368 626f 6172 6443 6f6d 706f 6e65  DashboardCompone
+000103b0: 6e74 293a 0a20 2020 2064 6566 205f 5f69  nt):.    def __i
+000103c0: 6e69 745f 5f28 7365 6c66 2c20 7363 6865  nit__(self, sche
+000103d0: 6475 6c65 722c 206e 5f72 6563 7461 6e67  duler, n_rectang
+000103e0: 6c65 733d 3130 3030 2c20 636c 6561 725f  les=1000, clear_
+000103f0: 696e 7465 7276 616c 3d22 3230 7322 2c20  interval="20s", 
+00010400: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
+00010410: 2020 2073 656c 662e 7363 6865 6475 6c65     self.schedule
+00010420: 7220 3d20 7363 6865 6475 6c65 720a 2020  r = scheduler.  
+00010430: 2020 2020 2020 7365 6c66 2e6f 6666 7365        self.offse
+00010440: 7420 3d20 300a 0a20 2020 2020 2020 2069  t = 0..        i
+00010450: 6620 5461 736b 5374 7265 616d 506c 7567  f TaskStreamPlug
+00010460: 696e 2e6e 616d 6520 6e6f 7420 696e 2073  in.name not in s
+00010470: 656c 662e 7363 6865 6475 6c65 722e 706c  elf.scheduler.pl
+00010480: 7567 696e 733a 0a20 2020 2020 2020 2020  ugins:.         
+00010490: 2020 2073 656c 662e 7363 6865 6475 6c65     self.schedule
+000104a0: 722e 6164 645f 706c 7567 696e 2854 6173  r.add_plugin(Tas
+000104b0: 6b53 7472 6561 6d50 6c75 6769 6e28 7365  kStreamPlugin(se
+000104c0: 6c66 2e73 6368 6564 756c 6572 2929 0a20  lf.scheduler)). 
+000104d0: 2020 2020 2020 2073 656c 662e 706c 7567         self.plug
+000104e0: 696e 203d 2073 656c 662e 7363 6865 6475  in = self.schedu
+000104f0: 6c65 722e 706c 7567 696e 735b 5461 736b  ler.plugins[Task
+00010500: 5374 7265 616d 506c 7567 696e 2e6e 616d  StreamPlugin.nam
+00010510: 655d 0a0a 2020 2020 2020 2020 7365 6c66  e]..        self
+00010520: 2e69 6e64 6578 203d 206d 6178 2830 2c20  .index = max(0, 
+00010530: 7365 6c66 2e70 6c75 6769 6e2e 696e 6465  self.plugin.inde
+00010540: 7820 2d20 6e5f 7265 6374 616e 676c 6573  x - n_rectangles
+00010550: 290a 2020 2020 2020 2020 7365 6c66 2e77  ).        self.w
+00010560: 6f72 6b65 7273 203d 2064 6963 7428 290a  orkers = dict().
+00010570: 2020 2020 2020 2020 7365 6c66 2e6e 5f72          self.n_r
+00010580: 6563 7461 6e67 6c65 7320 3d20 6e5f 7265  ectangles = n_re
+00010590: 6374 616e 676c 6573 0a20 2020 2020 2020  ctangles.       
+000105a0: 2063 6c65 6172 5f69 6e74 6572 7661 6c20   clear_interval 
+000105b0: 3d20 7061 7273 655f 7469 6d65 6465 6c74  = parse_timedelt
+000105c0: 6128 636c 6561 725f 696e 7465 7276 616c  a(clear_interval
+000105d0: 2c20 6465 6661 756c 743d 226d 7322 290a  , default="ms").
+000105e0: 2020 2020 2020 2020 7365 6c66 2e63 6c65          self.cle
+000105f0: 6172 5f69 6e74 6572 7661 6c20 3d20 636c  ar_interval = cl
+00010600: 6561 725f 696e 7465 7276 616c 0a20 2020  ear_interval.   
+00010610: 2020 2020 2073 656c 662e 6c61 7374 203d       self.last =
+00010620: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
+00010630: 6c61 7374 5f73 6565 6e20 3d20 300a 0a20  last_seen = 0.. 
+00010640: 2020 2020 2020 2073 656c 662e 736f 7572         self.sour
+00010650: 6365 2c20 7365 6c66 2e72 6f6f 7420 3d20  ce, self.root = 
+00010660: 7461 736b 5f73 7472 6561 6d5f 6669 6775  task_stream_figu
+00010670: 7265 2863 6c65 6172 5f69 6e74 6572 7661  re(clear_interva
+00010680: 6c2c 202a 2a6b 7761 7267 7329 0a0a 2020  l, **kwargs)..  
+00010690: 2020 2020 2020 2320 5265 7175 6972 6564        # Required
+000106a0: 2066 6f72 2075 7064 6174 6520 6361 6c6c   for update call
+000106b0: 6261 636b 0a20 2020 2020 2020 2073 656c  back.        sel
+000106c0: 662e 7461 736b 5f73 7472 6561 6d5f 696e  f.task_stream_in
+000106d0: 6465 7820 3d20 5b30 5d0a 0a20 2020 2040  dex = [0]..    @
+000106e0: 7769 7468 6f75 745f 7072 6f70 6572 7479  without_property
+000106f0: 5f76 616c 6964 6174 696f 6e0a 2020 2020  _validation.    
+00010700: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
+00010710: 6465 6620 7570 6461 7465 2873 656c 6629  def update(self)
+00010720: 3a0a 2020 2020 2020 2020 6966 2073 656c  :.        if sel
+00010730: 662e 696e 6465 7820 3d3d 2073 656c 662e  f.index == self.
+00010740: 706c 7567 696e 2e69 6e64 6578 3a0a 2020  plugin.index:.  
+00010750: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00010760: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00010770: 662e 696e 6465 7820 616e 6420 6c65 6e28  f.index and len(
+00010780: 7365 6c66 2e73 6f75 7263 652e 6461 7461  self.source.data
+00010790: 5b22 7374 6172 7422 5d29 3a0a 2020 2020  ["start"]):.    
+000107a0: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
+000107b0: 6d69 6e28 7365 6c66 2e73 6f75 7263 652e  min(self.source.
+000107c0: 6461 7461 5b22 7374 6172 7422 5d29 0a20  data["start"]). 
+000107d0: 2020 2020 2020 2020 2020 2064 7572 6174             durat
+000107e0: 696f 6e20 3d20 6d61 7828 7365 6c66 2e73  ion = max(self.s
+000107f0: 6f75 7263 652e 6461 7461 5b22 6475 7261  ource.data["dura
+00010800: 7469 6f6e 225d 290a 2020 2020 2020 2020  tion"]).        
+00010810: 2020 2020 626f 756e 6461 7279 203d 2028      boundary = (
+00010820: 7365 6c66 2e6f 6666 7365 7420 2b20 7374  self.offset + st
+00010830: 6172 7420 2d20 6475 7261 7469 6f6e 2920  art - duration) 
+00010840: 2f20 3130 3030 0a20 2020 2020 2020 2065  / 1000.        e
+00010850: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00010860: 2062 6f75 6e64 6172 7920 3d20 7365 6c66   boundary = self
+00010870: 2e6f 6666 7365 740a 2020 2020 2020 2020  .offset.        
+00010880: 7265 6374 616e 676c 6573 203d 2073 656c  rectangles = sel
+00010890: 662e 706c 7567 696e 2e72 6563 7461 6e67  f.plugin.rectang
+000108a0: 6c65 7328 0a20 2020 2020 2020 2020 2020  les(.           
+000108b0: 2069 7374 6172 743d 7365 6c66 2e69 6e64   istart=self.ind
+000108c0: 6578 2c20 776f 726b 6572 733d 7365 6c66  ex, workers=self
+000108d0: 2e77 6f72 6b65 7273 2c20 7374 6172 745f  .workers, start_
+000108e0: 626f 756e 6461 7279 3d62 6f75 6e64 6172  boundary=boundar
+000108f0: 790a 2020 2020 2020 2020 290a 2020 2020  y.        ).    
+00010900: 2020 2020 6e20 3d20 6c65 6e28 7265 6374      n = len(rect
+00010910: 616e 676c 6573 5b22 6e61 6d65 225d 290a  angles["name"]).
+00010920: 2020 2020 2020 2020 7365 6c66 2e69 6e64          self.ind
+00010930: 6578 203d 2073 656c 662e 706c 7567 696e  ex = self.plugin
+00010940: 2e69 6e64 6578 0a0a 2020 2020 2020 2020  .index..        
+00010950: 6966 206e 6f74 2072 6563 7461 6e67 6c65  if not rectangle
+00010960: 735b 2273 7461 7274 225d 3a0a 2020 2020  s["start"]:.    
+00010970: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
+00010980: 2020 2020 2020 2020 2320 4966 2069 7420          # If it 
+00010990: 6861 7320 6265 656e 2061 2077 6869 6c65  has been a while
+000109a0: 2073 696e 6365 2077 6527 7665 2075 7064   since we've upd
+000109b0: 6174 6564 2074 6865 2070 6c6f 740a 2020  ated the plot.  
+000109c0: 2020 2020 2020 6966 2074 696d 6528 2920        if time() 
+000109d0: 3e20 7365 6c66 2e6c 6173 745f 7365 656e  > self.last_seen
+000109e0: 202b 2073 656c 662e 636c 6561 725f 696e   + self.clear_in
+000109f0: 7465 7276 616c 3a0a 2020 2020 2020 2020  terval:.        
+00010a00: 2020 2020 6e65 775f 7374 6172 7420 3d20      new_start = 
+00010a10: 6d69 6e28 7265 6374 616e 676c 6573 5b22  min(rectangles["
+00010a20: 7374 6172 7422 5d29 202d 2073 656c 662e  start"]) - self.
+00010a30: 6f66 6673 6574 0a20 2020 2020 2020 2020  offset.         
+00010a40: 2020 206f 6c64 5f73 7461 7274 203d 206d     old_start = m
+00010a50: 696e 2873 656c 662e 736f 7572 6365 2e64  in(self.source.d
+00010a60: 6174 615b 2273 7461 7274 225d 290a 2020  ata["start"]).  
+00010a70: 2020 2020 2020 2020 2020 6f6c 645f 656e            old_en
+00010a80: 6420 3d20 6d61 7828 0a20 2020 2020 2020  d = max(.       
+00010a90: 2020 2020 2020 2020 206d 6170 280a 2020           map(.  
+00010aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010ab0: 2020 6f70 6572 6174 6f72 2e61 6464 2c0a    operator.add,.
+00010ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010ad0: 2020 2020 7365 6c66 2e73 6f75 7263 652e      self.source.
+00010ae0: 6461 7461 5b22 7374 6172 7422 5d2c 0a20  data["start"],. 
+00010af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010b00: 2020 2073 656c 662e 736f 7572 6365 2e64     self.source.d
+00010b10: 6174 615b 2264 7572 6174 696f 6e22 5d2c  ata["duration"],
+00010b20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010b30: 2029 0a20 2020 2020 2020 2020 2020 2029   ).            )
+00010b40: 0a0a 2020 2020 2020 2020 2020 2020 6465  ..            de
+00010b50: 6e73 6974 7920 3d20 280a 2020 2020 2020  nsity = (.      
+00010b60: 2020 2020 2020 2020 2020 7375 6d28 7365            sum(se
+00010b70: 6c66 2e73 6f75 7263 652e 6461 7461 5b22  lf.source.data["
+00010b80: 6475 7261 7469 6f6e 225d 290a 2020 2020  duration"]).    
+00010b90: 2020 2020 2020 2020 2020 2020 2f20 6c65              / le
+00010ba0: 6e28 7365 6c66 2e77 6f72 6b65 7273 290a  n(self.workers).
+00010bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010bc0: 2f20 286f 6c64 5f65 6e64 202d 206f 6c64  / (old_end - old
+00010bd0: 5f73 7461 7274 290a 2020 2020 2020 2020  _start).        
+00010be0: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+00010bf0: 2020 2023 2049 6620 7768 6974 6573 7061     # If whitespa
+00010c00: 6365 2069 7320 6d6f 7265 2074 6861 6e20  ce is more than 
+00010c10: 3378 2074 6865 206f 6c64 2077 6964 7468  3x the old width
+00010c20: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00010c30: 286e 6577 5f73 7461 7274 202d 206f 6c64  (new_start - old
+00010c40: 5f65 6e64 2920 3e20 286f 6c64 5f65 6e64  _end) > (old_end
+00010c50: 202d 206f 6c64 5f73 7461 7274 2920 2a20   - old_start) * 
+00010c60: 3220 6f72 2064 656e 7369 7479 203c 2030  2 or density < 0
+00010c70: 2e30 353a 0a20 2020 2020 2020 2020 2020  .05:.           
+00010c80: 2020 2020 2073 656c 662e 736f 7572 6365       self.source
+00010c90: 2e64 6174 612e 7570 6461 7465 287b 6b3a  .data.update({k:
+00010ca0: 205b 5d20 666f 7220 6b20 696e 2072 6563   [] for k in rec
+00010cb0: 7461 6e67 6c65 737d 2920 2023 2063 6c65  tangles})  # cle
+00010cc0: 6172 0a20 2020 2020 2020 2020 2020 2020  ar.             
+00010cd0: 2020 2073 656c 662e 6f66 6673 6574 203d     self.offset =
+00010ce0: 206d 696e 2872 6563 7461 6e67 6c65 735b   min(rectangles[
+00010cf0: 2273 7461 7274 225d 2920 2023 2072 6564  "start"])  # red
+00010d00: 6566 696e 6520 6f66 6673 6574 0a0a 2020  efine offset..  
+00010d10: 2020 2020 2020 7265 6374 616e 676c 6573        rectangles
+00010d20: 5b22 7374 6172 7422 5d20 3d20 5b78 202d  ["start"] = [x -
+00010d30: 2073 656c 662e 6f66 6673 6574 2066 6f72   self.offset for
+00010d40: 2078 2069 6e20 7265 6374 616e 676c 6573   x in rectangles
+00010d50: 5b22 7374 6172 7422 5d5d 0a20 2020 2020  ["start"]].     
+00010d60: 2020 2073 656c 662e 6c61 7374 5f73 6565     self.last_see
+00010d70: 6e20 3d20 7469 6d65 2829 0a0a 2020 2020  n = time()..    
+00010d80: 2020 2020 2320 436f 6e76 6572 7420 746f      # Convert to
+00010d90: 206e 756d 7079 2066 6f72 2073 6572 6961   numpy for seria
+00010da0: 6c69 7a61 7469 6f6e 2073 7065 6564 0a20  lization speed. 
+00010db0: 2020 2020 2020 2069 6620 6e20 3e3d 2031         if n >= 1
+00010dc0: 3020 616e 6420 6e70 3a0a 2020 2020 2020  0 and np:.      
+00010dd0: 2020 2020 2020 666f 7220 6b2c 2076 2069        for k, v i
+00010de0: 6e20 7265 6374 616e 676c 6573 2e69 7465  n rectangles.ite
+00010df0: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+00010e00: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00010e10: 6e63 6528 765b 305d 2c20 4e75 6d62 6572  nce(v[0], Number
+00010e20: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00010e30: 2020 2020 2020 2072 6563 7461 6e67 6c65         rectangle
+00010e40: 735b 6b5d 203d 206e 702e 6172 7261 7928  s[k] = np.array(
+00010e50: 7629 0a0a 2020 2020 2020 2020 6966 2050  v)..        if P
+00010e60: 524f 4649 4c49 4e47 3a0a 2020 2020 2020  ROFILING:.      
+00010e70: 2020 2020 2020 6375 7264 6f63 2829 2e61        curdoc().a
+00010e80: 6464 5f6e 6578 745f 7469 636b 5f63 616c  dd_next_tick_cal
+00010e90: 6c62 6163 6b28 0a20 2020 2020 2020 2020  lback(.         
+00010ea0: 2020 2020 2020 206c 616d 6264 613a 2073         lambda: s
+00010eb0: 656c 662e 736f 7572 6365 2e73 7472 6561  elf.source.strea
+00010ec0: 6d28 7265 6374 616e 676c 6573 2c20 7365  m(rectangles, se
+00010ed0: 6c66 2e6e 5f72 6563 7461 6e67 6c65 7329  lf.n_rectangles)
+00010ee0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00010ef0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00010f00: 2020 2020 2020 2020 2073 656c 662e 736f           self.so
+00010f10: 7572 6365 2e73 7472 6561 6d28 7265 6374  urce.stream(rect
+00010f20: 616e 676c 6573 2c20 7365 6c66 2e6e 5f72  angles, self.n_r
+00010f30: 6563 7461 6e67 6c65 7329 0a0a 0a64 6566  ectangles)...def
+00010f40: 2074 6173 6b5f 7374 7265 616d 5f66 6967   task_stream_fig
+00010f50: 7572 6528 636c 6561 725f 696e 7465 7276  ure(clear_interv
+00010f60: 616c 3d22 3230 7322 2c20 2a2a 6b77 6172  al="20s", **kwar
+00010f70: 6773 293a 0a20 2020 2022 2222 0a20 2020  gs):.    """.   
+00010f80: 206b 7761 7267 7320 6172 6520 6170 706c   kwargs are appl
+00010f90: 6965 6420 746f 2074 6865 2062 6f6b 6568  ied to the bokeh
+00010fa0: 2e6d 6f64 656c 732e 706c 6f74 732e 506c  .models.plots.Pl
+00010fb0: 6f74 2063 6f6e 7374 7275 6374 6f72 0a20  ot constructor. 
+00010fc0: 2020 2022 2222 0a20 2020 2063 6c65 6172     """.    clear
+00010fd0: 5f69 6e74 6572 7661 6c20 3d20 7061 7273  _interval = pars
+00010fe0: 655f 7469 6d65 6465 6c74 6128 636c 6561  e_timedelta(clea
+00010ff0: 725f 696e 7465 7276 616c 2c20 6465 6661  r_interval, defa
+00011000: 756c 743d 226d 7322 290a 0a20 2020 2073  ult="ms")..    s
+00011010: 6f75 7263 6520 3d20 436f 6c75 6d6e 4461  ource = ColumnDa
+00011020: 7461 536f 7572 6365 280a 2020 2020 2020  taSource(.      
+00011030: 2020 6461 7461 3d64 6963 7428 0a20 2020    data=dict(.   
+00011040: 2020 2020 2020 2020 2073 7461 7274 3d5b           start=[
+00011050: 7469 6d65 2829 202d 2063 6c65 6172 5f69  time() - clear_i
+00011060: 6e74 6572 7661 6c5d 2c0a 2020 2020 2020  nterval],.      
+00011070: 2020 2020 2020 6475 7261 7469 6f6e 3d5b        duration=[
+00011080: 302e 315d 2c0a 2020 2020 2020 2020 2020  0.1],.          
+00011090: 2020 6b65 793d 5b22 7374 6172 7422 5d2c    key=["start"],
+000110a0: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+000110b0: 653d 5b22 7374 6172 7422 5d2c 0a20 2020  e=["start"],.   
+000110c0: 2020 2020 2020 2020 2063 6f6c 6f72 3d5b           color=[
+000110d0: 2277 6869 7465 225d 2c0a 2020 2020 2020  "white"],.      
+000110e0: 2020 2020 2020 6475 7261 7469 6f6e 5f74        duration_t
+000110f0: 6578 743d 5b22 3130 3020 6d73 225d 2c0a  ext=["100 ms"],.
+00011100: 2020 2020 2020 2020 2020 2020 776f 726b              work
+00011110: 6572 3d5b 2266 6f6f 225d 2c0a 2020 2020  er=["foo"],.    
+00011120: 2020 2020 2020 2020 793d 5b30 5d2c 0a20          y=[0],. 
+00011130: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
+00011140: 725f 7468 7265 6164 3d5b 315d 2c0a 2020  r_thread=[1],.  
+00011150: 2020 2020 2020 2020 2020 616c 7068 613d            alpha=
+00011160: 5b30 2e30 5d2c 0a20 2020 2020 2020 2029  [0.0],.        )
+00011170: 0a20 2020 2029 0a0a 2020 2020 785f 7261  .    )..    x_ra
+00011180: 6e67 6520 3d20 4461 7461 5261 6e67 6531  nge = DataRange1
+00011190: 6428 7261 6e67 655f 7061 6464 696e 673d  d(range_padding=
+000111a0: 3029 0a20 2020 2079 5f72 616e 6765 203d  0).    y_range =
+000111b0: 2044 6174 6152 616e 6765 3164 2872 616e   DataRange1d(ran
+000111c0: 6765 5f70 6164 6469 6e67 3d30 290a 0a20  ge_padding=0).. 
+000111d0: 2020 2072 6f6f 7420 3d20 6669 6775 7265     root = figure
+000111e0: 280a 2020 2020 2020 2020 6e61 6d65 3d22  (.        name="
+000111f0: 7461 736b 5f73 7472 6561 6d22 2c0a 2020  task_stream",.  
+00011200: 2020 2020 2020 7469 746c 653d 2254 6173        title="Tas
+00011210: 6b20 5374 7265 616d 222c 0a20 2020 2020  k Stream",.     
+00011220: 2020 2078 5f72 616e 6765 3d78 5f72 616e     x_range=x_ran
+00011230: 6765 2c0a 2020 2020 2020 2020 795f 7261  ge,.        y_ra
+00011240: 6e67 653d 795f 7261 6e67 652c 0a20 2020  nge=y_range,.   
+00011250: 2020 2020 2074 6f6f 6c62 6172 5f6c 6f63       toolbar_loc
+00011260: 6174 696f 6e3d 2261 626f 7665 222c 0a20  ation="above",. 
+00011270: 2020 2020 2020 2078 5f61 7869 735f 7479         x_axis_ty
+00011280: 7065 3d22 6461 7465 7469 6d65 222c 0a20  pe="datetime",. 
+00011290: 2020 2020 2020 2079 5f61 7869 735f 6c6f         y_axis_lo
+000112a0: 6361 7469 6f6e 3d4e 6f6e 652c 0a20 2020  cation=None,.   
+000112b0: 2020 2020 2074 6f6f 6c73 3d22 222c 0a20       tools="",. 
+000112c0: 2020 2020 2020 206d 696e 5f62 6f72 6465         min_borde
+000112d0: 725f 626f 7474 6f6d 3d35 302c 0a20 2020  r_bottom=50,.   
+000112e0: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
+000112f0: 2020 2029 0a0a 2020 2020 7265 6374 203d     )..    rect =
+00011300: 2072 6f6f 742e 7265 6374 280a 2020 2020   root.rect(.    
+00011310: 2020 2020 736f 7572 6365 3d73 6f75 7263      source=sourc
+00011320: 652c 0a20 2020 2020 2020 2078 3d22 7374  e,.        x="st
+00011330: 6172 7422 2c0a 2020 2020 2020 2020 793d  art",.        y=
+00011340: 2279 222c 0a20 2020 2020 2020 2077 6964  "y",.        wid
+00011350: 7468 3d22 6475 7261 7469 6f6e 222c 0a20  th="duration",. 
+00011360: 2020 2020 2020 2068 6569 6768 743d 302e         height=0.
+00011370: 342c 0a20 2020 2020 2020 2066 696c 6c5f  4,.        fill_
+00011380: 636f 6c6f 723d 2263 6f6c 6f72 222c 0a20  color="color",. 
+00011390: 2020 2020 2020 206c 696e 655f 636f 6c6f         line_colo
+000113a0: 723d 2263 6f6c 6f72 222c 0a20 2020 2020  r="color",.     
+000113b0: 2020 206c 696e 655f 616c 7068 613d 302e     line_alpha=0.
+000113c0: 362c 0a20 2020 2020 2020 2066 696c 6c5f  6,.        fill_
+000113d0: 616c 7068 613d 2261 6c70 6861 222c 0a20  alpha="alpha",. 
+000113e0: 2020 2020 2020 206c 696e 655f 7769 6474         line_widt
+000113f0: 683d 332c 0a20 2020 2029 0a20 2020 2072  h=3,.    ).    r
+00011400: 6563 742e 6e6f 6e73 656c 6563 7469 6f6e  ect.nonselection
+00011410: 5f67 6c79 7068 203d 204e 6f6e 650a 0a20  _glyph = None.. 
+00011420: 2020 2072 6f6f 742e 7961 7869 732e 6d61     root.yaxis.ma
+00011430: 6a6f 725f 6c61 6265 6c5f 7465 7874 5f61  jor_label_text_a
+00011440: 6c70 6861 203d 2030 0a20 2020 2072 6f6f  lpha = 0.    roo
+00011450: 742e 7961 7869 732e 6d69 6e6f 725f 7469  t.yaxis.minor_ti
+00011460: 636b 5f6c 696e 655f 616c 7068 6120 3d20  ck_line_alpha = 
+00011470: 300a 2020 2020 726f 6f74 2e79 6178 6973  0.    root.yaxis
+00011480: 2e6d 616a 6f72 5f74 6963 6b5f 6c69 6e65  .major_tick_line
+00011490: 5f61 6c70 6861 203d 2030 0a20 2020 2072  _alpha = 0.    r
+000114a0: 6f6f 742e 7867 7269 642e 7669 7369 626c  oot.xgrid.visibl
+000114b0: 6520 3d20 4661 6c73 650a 0a20 2020 2068  e = False..    h
+000114c0: 6f76 6572 203d 2048 6f76 6572 546f 6f6c  over = HoverTool
+000114d0: 280a 2020 2020 2020 2020 706f 696e 745f  (.        point_
+000114e0: 706f 6c69 6379 3d22 666f 6c6c 6f77 5f6d  policy="follow_m
+000114f0: 6f75 7365 222c 0a20 2020 2020 2020 2074  ouse",.        t
+00011500: 6f6f 6c74 6970 733d 2222 220a 2020 2020  ooltips=""".    
+00011510: 2020 2020 2020 2020 3c64 6976 3e0a 2020          <div>.  
+00011520: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
+00011530: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
+00011540: 7369 7a65 3a20 3132 7078 3b20 666f 6e74  size: 12px; font
+00011550: 2d77 6569 6768 743a 2062 6f6c 643b 223e  -weight: bold;">
+00011560: 406e 616d 653a 3c2f 7370 616e 3e26 6e62  @name:</span>&nb
+00011570: 7370 3b0a 2020 2020 2020 2020 2020 2020  sp;.            
+00011580: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
+00011590: 2266 6f6e 742d 7369 7a65 3a20 3130 7078  "font-size: 10px
+000115a0: 3b20 666f 6e74 2d66 616d 696c 793a 204d  ; font-family: M
+000115b0: 6f6e 6163 6f2c 206d 6f6e 6f73 7061 6365  onaco, monospace
+000115c0: 3b22 3e40 6475 7261 7469 6f6e 5f74 6578  ;">@duration_tex
+000115d0: 743c 2f73 7061 6e3e 0a20 2020 2020 2020  t</span>.       
+000115e0: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
+000115f0: 2020 2020 2020 2020 2222 222c 0a20 2020          """,.   
+00011600: 2029 0a0a 2020 2020 7461 7020 3d20 5461   )..    tap = Ta
+00011610: 7054 6f6f 6c28 6361 6c6c 6261 636b 3d4f  pTool(callback=O
+00011620: 7065 6e55 524c 2875 726c 3d22 2e2f 7072  penURL(url="./pr
+00011630: 6f66 696c 653f 6b65 793d 406e 616d 6522  ofile?key=@name"
+00011640: 2929 0a20 2020 2068 656c 705f 203d 2048  )).    help_ = H
+00011650: 656c 7054 6f6f 6c28 0a20 2020 2020 2020  elpTool(.       
+00011660: 2072 6564 6972 6563 743d 2268 7474 7073   redirect="https
+00011670: 3a2f 2f64 6f63 732e 6461 736b 2e6f 7267  ://docs.dask.org
+00011680: 2f65 6e2f 7374 6162 6c65 2f64 6173 6862  /en/stable/dashb
+00011690: 6f61 7264 2e68 746d 6c23 7461 736b 2d73  oard.html#task-s
+000116a0: 7472 6561 6d22 2c0a 2020 2020 2020 2020  tream",.        
+000116b0: 6465 7363 7269 7074 696f 6e3d 2241 2064  description="A d
+000116c0: 6573 6372 6970 7469 6f6e 206f 6620 7468  escription of th
+000116d0: 6520 5461 736b 5374 7265 616d 2061 6e64  e TaskStream and
+000116e0: 2069 7473 2063 6f6c 6f72 2070 616c 6574   its color palet
+000116f0: 7465 2e22 2c0a 2020 2020 290a 2020 2020  te.",.    ).    
+00011700: 726f 6f74 2e61 6464 5f74 6f6f 6c73 280a  root.add_tools(.
+00011710: 2020 2020 2020 2020 686f 7665 722c 0a20          hover,. 
+00011720: 2020 2020 2020 2074 6170 2c0a 2020 2020         tap,.    
+00011730: 2020 2020 426f 785a 6f6f 6d54 6f6f 6c28      BoxZoomTool(
+00011740: 292c 0a20 2020 2020 2020 2052 6573 6574  ),.        Reset
+00011750: 546f 6f6c 2829 2c0a 2020 2020 2020 2020  Tool(),.        
+00011760: 5061 6e54 6f6f 6c28 6469 6d65 6e73 696f  PanTool(dimensio
+00011770: 6e73 3d22 7769 6474 6822 292c 0a20 2020  ns="width"),.   
+00011780: 2020 2020 2057 6865 656c 5a6f 6f6d 546f       WheelZoomTo
+00011790: 6f6c 2864 696d 656e 7369 6f6e 733d 2277  ol(dimensions="w
+000117a0: 6964 7468 2229 2c0a 2020 2020 2020 2020  idth"),.        
+000117b0: 6865 6c70 5f2c 0a20 2020 2029 0a20 2020  help_,.    ).   
+000117c0: 2069 6620 4578 706f 7274 546f 6f6c 3a20   if ExportTool: 
+000117d0: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
+000117e0: 2020 2020 2020 2020 6578 706f 7274 203d          export =
+000117f0: 2045 7870 6f72 7454 6f6f 6c28 290a 2020   ExportTool().  
+00011800: 2020 2020 2020 6578 706f 7274 2e72 6567        export.reg
+00011810: 6973 7465 725f 706c 6f74 2872 6f6f 7429  ister_plot(root)
+00011820: 0a20 2020 2020 2020 2072 6f6f 742e 6164  .        root.ad
+00011830: 645f 746f 6f6c 7328 6578 706f 7274 290a  d_tools(export).
+00011840: 0a20 2020 2072 6574 7572 6e20 736f 7572  .    return sour
+00011850: 6365 2c20 726f 6f74 0a0a 0a63 6c61 7373  ce, root...class
+00011860: 2054 6173 6b47 7261 7068 2844 6173 6862   TaskGraph(Dashb
+00011870: 6f61 7264 436f 6d70 6f6e 656e 7429 3a0a  oardComponent):.
+00011880: 2020 2020 2222 220a 2020 2020 4120 6479      """.    A dy
+00011890: 6e61 6d69 6320 6e6f 6465 2d6c 696e 6b20  namic node-link 
+000118a0: 6469 6167 7261 6d20 666f 7220 7468 6520  diagram for the 
+000118b0: 7461 736b 2067 7261 7068 206f 6e20 7468  task graph on th
+000118c0: 6520 7363 6865 6475 6c65 720a 0a20 2020  e scheduler..   
+000118d0: 2053 6565 2061 6c73 6f20 7468 6520 4772   See also the Gr
+000118e0: 6170 684c 6179 6f75 7420 6469 6167 6e6f  aphLayout diagno
+000118f0: 7374 6963 2061 740a 2020 2020 6469 7374  stic at.    dist
+00011900: 7269 6275 7465 642f 6469 6167 6e6f 7374  ributed/diagnost
+00011910: 6963 732f 6772 6170 685f 6c61 796f 7574  ics/graph_layout
+00011920: 2e70 790a 2020 2020 2222 220a 0a20 2020  .py.    """..   
+00011930: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+00011940: 6c66 2c20 7363 6865 6475 6c65 722c 202a  lf, scheduler, *
+00011950: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
+00011960: 2020 7365 6c66 2e73 6368 6564 756c 6572    self.scheduler
+00011970: 203d 2073 6368 6564 756c 6572 0a20 2020   = scheduler.   
+00011980: 2020 2020 2073 656c 662e 6c61 796f 7574       self.layout
+00011990: 203d 2047 7261 7068 4c61 796f 7574 2873   = GraphLayout(s
+000119a0: 6368 6564 756c 6572 290a 2020 2020 2020  cheduler).      
+000119b0: 2020 7363 6865 6475 6c65 722e 6164 645f    scheduler.add_
+000119c0: 706c 7567 696e 2873 656c 662e 6c61 796f  plugin(self.layo
+000119d0: 7574 290a 2020 2020 2020 2020 7365 6c66  ut).        self
+000119e0: 2e69 6e76 6973 6962 6c65 5f63 6f75 6e74  .invisible_count
+000119f0: 203d 2030 2020 2320 6e75 6d62 6572 206f   = 0  # number o
+00011a00: 6620 696e 7669 7369 626c 6520 6e6f 6465  f invisible node
+00011a10: 730a 0a20 2020 2020 2020 2073 656c 662e  s..        self.
+00011a20: 6e6f 6465 5f73 6f75 7263 6520 3d20 436f  node_source = Co
+00011a30: 6c75 6d6e 4461 7461 536f 7572 6365 280a  lumnDataSource(.
+00011a40: 2020 2020 2020 2020 2020 2020 7b22 7822              {"x"
+00011a50: 3a20 5b5d 2c20 2279 223a 205b 5d2c 2022  : [], "y": [], "
+00011a60: 6e61 6d65 223a 205b 5d2c 2022 7374 6174  name": [], "stat
+00011a70: 6522 3a20 5b5d 2c20 2276 6973 6962 6c65  e": [], "visible
+00011a80: 223a 205b 5d2c 2022 6b65 7922 3a20 5b5d  ": [], "key": []
+00011a90: 7d0a 2020 2020 2020 2020 290a 2020 2020  }.        ).    
+00011aa0: 2020 2020 7365 6c66 2e65 6467 655f 736f      self.edge_so
+00011ab0: 7572 6365 203d 2043 6f6c 756d 6e44 6174  urce = ColumnDat
+00011ac0: 6153 6f75 7263 6528 7b22 7822 3a20 5b5d  aSource({"x": []
+00011ad0: 2c20 2279 223a 205b 5d2c 2022 7669 7369  , "y": [], "visi
+00011ae0: 626c 6522 3a20 5b5d 7d29 0a0a 2020 2020  ble": []})..    
+00011af0: 2020 2020 6669 6c74 6572 203d 2047 726f      filter = Gro
+00011b00: 7570 4669 6c74 6572 2863 6f6c 756d 6e5f  upFilter(column_
+00011b10: 6e61 6d65 3d22 7669 7369 626c 6522 2c20  name="visible", 
+00011b20: 6772 6f75 703d 2254 7275 6522 290a 2020  group="True").  
+00011b30: 2020 2020 2020 6966 2042 4f4b 4548 5f56        if BOKEH_V
+00011b40: 4552 5349 4f4e 2e6d 616a 6f72 203c 2033  ERSION.major < 3
+00011b50: 3a0a 2020 2020 2020 2020 2020 2020 6669  :.            fi
+00011b60: 6c74 6572 5f6b 7761 7267 7320 3d20 7b22  lter_kwargs = {"
+00011b70: 6669 6c74 6572 7322 3a20 5b66 696c 7465  filters": [filte
+00011b80: 725d 7d0a 2020 2020 2020 2020 656c 7365  r]}.        else
+00011b90: 3a0a 2020 2020 2020 2020 2020 2020 6669  :.            fi
+00011ba0: 6c74 6572 5f6b 7761 7267 7320 3d20 7b22  lter_kwargs = {"
+00011bb0: 6669 6c74 6572 223a 2066 696c 7465 727d  filter": filter}
+00011bc0: 0a20 2020 2020 2020 206e 6f64 655f 7669  .        node_vi
+00011bd0: 6577 203d 2043 4453 5669 6577 282a 2a66  ew = CDSView(**f
+00011be0: 696c 7465 725f 6b77 6172 6773 290a 2020  ilter_kwargs).  
+00011bf0: 2020 2020 2020 6564 6765 5f76 6965 7720        edge_view 
+00011c00: 3d20 4344 5356 6965 7728 2a2a 6669 6c74  = CDSView(**filt
+00011c10: 6572 5f6b 7761 7267 7329 0a0a 2020 2020  er_kwargs)..    
+00011c20: 2020 2020 2320 426f 6b65 6820 3e3d 2033      # Bokeh >= 3
+00011c30: 2e30 2061 7574 6f6d 6174 6963 616c 6c79  .0 automatically
+00011c40: 2069 6e66 6572 7320 7468 6520 736f 7572   infers the sour
+00011c50: 6365 2074 6f20 7573 650a 2020 2020 2020  ce to use.      
+00011c60: 2020 6966 2042 4f4b 4548 5f56 4552 5349    if BOKEH_VERSI
+00011c70: 4f4e 2e6d 616a 6f72 203c 2033 3a0a 2020  ON.major < 3:.  
+00011c80: 2020 2020 2020 2020 2020 6e6f 6465 5f76            node_v
+00011c90: 6965 772e 736f 7572 6365 203d 2073 656c  iew.source = sel
+00011ca0: 662e 6e6f 6465 5f73 6f75 7263 650a 2020  f.node_source.  
+00011cb0: 2020 2020 2020 2020 2020 6564 6765 5f76            edge_v
+00011cc0: 6965 772e 736f 7572 6365 203d 2073 656c  iew.source = sel
+00011cd0: 662e 6564 6765 5f73 6f75 7263 650a 0a20  f.edge_source.. 
+00011ce0: 2020 2020 2020 206e 6f64 655f 636f 6c6f         node_colo
+00011cf0: 7273 203d 2066 6163 746f 725f 636d 6170  rs = factor_cmap
+00011d00: 280a 2020 2020 2020 2020 2020 2020 2273  (.            "s
+00011d10: 7461 7465 222c 0a20 2020 2020 2020 2020  tate",.         
+00011d20: 2020 2066 6163 746f 7273 3d5b 2277 6169     factors=["wai
+00011d30: 7469 6e67 222c 2022 7175 6575 6564 222c  ting", "queued",
+00011d40: 2022 7072 6f63 6573 7369 6e67 222c 2022   "processing", "
+00011d50: 6d65 6d6f 7279 222c 2022 7265 6c65 6173  memory", "releas
+00011d60: 6564 222c 2022 6572 7265 6422 5d2c 0a20  ed", "erred"],. 
+00011d70: 2020 2020 2020 2020 2020 2070 616c 6574             palet
+00011d80: 7465 3d5b 2267 7261 7922 2c20 2279 656c  te=["gray", "yel
+00011d90: 6c6f 7722 2c20 2267 7265 656e 222c 2022  low", "green", "
+00011da0: 7265 6422 2c20 2262 6c75 6522 2c20 2262  red", "blue", "b
+00011db0: 6c61 636b 225d 2c0a 2020 2020 2020 2020  lack"],.        
+00011dc0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00011dd0: 726f 6f74 203d 2066 6967 7572 6528 7469  root = figure(ti
+00011de0: 746c 653d 2254 6173 6b20 4772 6170 6822  tle="Task Graph"
+00011df0: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
+00011e00: 2020 2020 7365 6c66 2e73 7562 7469 746c      self.subtitl
+00011e10: 6520 3d20 5469 746c 6528 7465 7874 3d22  e = Title(text="
+00011e20: 2022 2c20 7465 7874 5f66 6f6e 745f 7374   ", text_font_st
+00011e30: 796c 653d 2269 7461 6c69 6322 290a 2020  yle="italic").  
+00011e40: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+00011e50: 6164 645f 6c61 796f 7574 2873 656c 662e  add_layout(self.
+00011e60: 7375 6274 6974 6c65 2c20 2261 626f 7665  subtitle, "above
+00011e70: 2229 0a0a 2020 2020 2020 2020 7365 6c66  ")..        self
+00011e80: 2e72 6f6f 742e 6d75 6c74 695f 6c69 6e65  .root.multi_line
+00011e90: 280a 2020 2020 2020 2020 2020 2020 7873  (.            xs
+00011ea0: 3d22 7822 2c0a 2020 2020 2020 2020 2020  ="x",.          
+00011eb0: 2020 7973 3d22 7922 2c0a 2020 2020 2020    ys="y",.      
+00011ec0: 2020 2020 2020 736f 7572 6365 3d73 656c        source=sel
+00011ed0: 662e 6564 6765 5f73 6f75 7263 652c 0a20  f.edge_source,. 
+00011ee0: 2020 2020 2020 2020 2020 206c 696e 655f             line_
+00011ef0: 7769 6474 683d 312c 0a20 2020 2020 2020  width=1,.       
+00011f00: 2020 2020 2076 6965 773d 6564 6765 5f76       view=edge_v
+00011f10: 6965 772c 0a20 2020 2020 2020 2020 2020  iew,.           
+00011f20: 2063 6f6c 6f72 3d22 626c 6163 6b22 2c0a   color="black",.
+00011f30: 2020 2020 2020 2020 2020 2020 616c 7068              alph
+00011f40: 613d 302e 332c 0a20 2020 2020 2020 2029  a=0.3,.        )
+00011f50: 0a20 2020 2020 2020 2072 6563 7420 3d20  .        rect = 
+00011f60: 7365 6c66 2e72 6f6f 742e 7371 7561 7265  self.root.square
+00011f70: 280a 2020 2020 2020 2020 2020 2020 783d  (.            x=
+00011f80: 2278 222c 0a20 2020 2020 2020 2020 2020  "x",.           
+00011f90: 2079 3d22 7922 2c0a 2020 2020 2020 2020   y="y",.        
+00011fa0: 2020 2020 7369 7a65 3d31 302c 0a20 2020      size=10,.   
+00011fb0: 2020 2020 2020 2020 2063 6f6c 6f72 3d6e           color=n
+00011fc0: 6f64 655f 636f 6c6f 7273 2c0a 2020 2020  ode_colors,.    
+00011fd0: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
+00011fe0: 656c 662e 6e6f 6465 5f73 6f75 7263 652c  elf.node_source,
+00011ff0: 0a20 2020 2020 2020 2020 2020 2076 6965  .            vie
+00012000: 773d 6e6f 6465 5f76 6965 772c 0a20 2020  w=node_view,.   
+00012010: 2020 2020 2020 2020 206c 6567 656e 645f           legend_
+00012020: 6669 656c 643d 2273 7461 7465 222c 0a20  field="state",. 
+00012030: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00012040: 2073 656c 662e 726f 6f74 2e78 6772 6964   self.root.xgrid
+00012050: 2e67 7269 645f 6c69 6e65 5f63 6f6c 6f72  .grid_line_color
+00012060: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+00012070: 7365 6c66 2e72 6f6f 742e 7967 7269 642e  self.root.ygrid.
+00012080: 6772 6964 5f6c 696e 655f 636f 6c6f 7220  grid_line_color 
+00012090: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
+000120a0: 656c 662e 726f 6f74 2e78 6178 6973 2e76  elf.root.xaxis.v
+000120b0: 6973 6962 6c65 203d 2046 616c 7365 0a20  isible = False. 
+000120c0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+000120d0: 2e79 6178 6973 2e76 6973 6962 6c65 203d  .yaxis.visible =
+000120e0: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
+000120f0: 686f 7665 7220 3d20 486f 7665 7254 6f6f  hover = HoverToo
+00012100: 6c28 0a20 2020 2020 2020 2020 2020 2070  l(.            p
+00012110: 6f69 6e74 5f70 6f6c 6963 793d 2266 6f6c  oint_policy="fol
+00012120: 6c6f 775f 6d6f 7573 6522 2c0a 2020 2020  low_mouse",.    
+00012130: 2020 2020 2020 2020 746f 6f6c 7469 7073          tooltips
+00012140: 3d22 3c62 3e40 6e61 6d65 3c2f 623e 3a20  ="<b>@name</b>: 
+00012150: 4073 7461 7465 222c 0a20 2020 2020 2020  @state",.       
+00012160: 2020 2020 2072 656e 6465 7265 7273 3d5b       renderers=[
+00012170: 7265 6374 5d2c 0a20 2020 2020 2020 2029  rect],.        )
+00012180: 0a20 2020 2020 2020 2074 6170 203d 2054  .        tap = T
+00012190: 6170 546f 6f6c 2863 616c 6c62 6163 6b3d  apTool(callback=
+000121a0: 4f70 656e 5552 4c28 7572 6c3d 2269 6e66  OpenURL(url="inf
+000121b0: 6f2f 7461 736b 2f40 6b65 792e 6874 6d6c  o/task/@key.html
+000121c0: 2229 2c20 7265 6e64 6572 6572 733d 5b72  "), renderers=[r
+000121d0: 6563 745d 290a 2020 2020 2020 2020 7265  ect]).        re
+000121e0: 6374 2e6e 6f6e 7365 6c65 6374 696f 6e5f  ct.nonselection_
+000121f0: 676c 7970 6820 3d20 4e6f 6e65 0a20 2020  glyph = None.   
+00012200: 2020 2020 2073 656c 662e 726f 6f74 2e61       self.root.a
+00012210: 6464 5f74 6f6f 6c73 2868 6f76 6572 2c20  dd_tools(hover, 
+00012220: 7461 7029 0a20 2020 2020 2020 2073 656c  tap).        sel
+00012230: 662e 6d61 785f 6974 656d 7320 3d20 636f  f.max_items = co
+00012240: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
+00012250: 6275 7465 642e 6461 7368 626f 6172 642e  buted.dashboard.
+00012260: 6772 6170 682d 6d61 782d 6974 656d 7322  graph-max-items"
+00012270: 2c20 3530 3030 290a 0a20 2020 2040 7769  , 5000)..    @wi
+00012280: 7468 6f75 745f 7072 6f70 6572 7479 5f76  thout_property_v
+00012290: 616c 6964 6174 696f 6e0a 2020 2020 406c  alidation.    @l
+000122a0: 6f67 5f65 7272 6f72 730a 2020 2020 6465  og_errors.    de
+000122b0: 6620 7570 6461 7465 2873 656c 6629 3a0a  f update(self):.
+000122c0: 2020 2020 2020 2020 2320 4966 2074 6865          # If the
+000122d0: 7265 2061 7265 2074 6f6f 206d 616e 7920  re are too many 
+000122e0: 7461 736b 7320 696e 2074 6865 2073 6368  tasks in the sch
+000122f0: 6564 756c 6572 2077 6527 6c6c 2064 6973  eduler we'll dis
+00012300: 6162 6c65 2074 6869 730a 2020 2020 2020  able this.      
+00012310: 2020 2320 636f 6d70 6f6f 6e65 6e74 7320    # compoonents 
+00012320: 746f 206e 6f74 206f 7665 726c 6f61 6420  to not overload 
+00012330: 7363 6865 6475 6c65 7220 6f72 2063 6c69  scheduler or cli
+00012340: 656e 742e 204f 6e63 6520 7765 2064 726f  ent. Once we dro
+00012350: 700a 2020 2020 2020 2020 2320 6265 6c6f  p.        # belo
+00012360: 7720 7468 6520 7468 7265 7368 6f6c 642c  w the threshold,
+00012370: 2074 6865 2064 6174 6120 6973 2066 696c   the data is fil
+00012380: 6c65 6420 7570 2061 6761 696e 2061 7320  led up again as 
+00012390: 7573 7561 6c0a 2020 2020 2020 2020 6966  usual.        if
+000123a0: 206c 656e 2873 656c 662e 7363 6865 6475   len(self.schedu
+000123b0: 6c65 722e 7461 736b 7329 203e 2073 656c  ler.tasks) > sel
+000123c0: 662e 6d61 785f 6974 656d 733a 0a20 2020  f.max_items:.   
+000123d0: 2020 2020 2020 2020 2073 656c 662e 7375           self.su
+000123e0: 6274 6974 6c65 2e74 6578 7420 3d20 2253  btitle.text = "S
+000123f0: 6368 6564 756c 6572 2068 6173 2074 6f6f  cheduler has too
+00012400: 206d 616e 7920 7461 736b 7320 746f 2064   many tasks to d
+00012410: 6973 706c 6179 2e22 0a20 2020 2020 2020  isplay.".       
+00012420: 2020 2020 2066 6f72 2063 6f6e 7461 696e       for contain
+00012430: 6572 2069 6e20 5b73 656c 662e 6e6f 6465  er in [self.node
+00012440: 5f73 6f75 7263 652c 2073 656c 662e 6564  _source, self.ed
+00012450: 6765 5f73 6f75 7263 655d 3a0a 2020 2020  ge_source]:.    
+00012460: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00012470: 6169 6e65 722e 6461 7461 203d 207b 636f  ainer.data = {co
+00012480: 6c3a 205b 5d20 666f 7220 636f 6c20 696e  l: [] for col in
+00012490: 2063 6f6e 7461 696e 6572 2e63 6f6c 756d   container.colum
+000124a0: 6e5f 6e61 6d65 737d 0a20 2020 2020 2020  n_names}.       
+000124b0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000124c0: 2020 2023 206f 6363 6173 696f 6e61 6c6c     # occasionall
+000124d0: 7920 7265 7365 7420 7468 6520 636f 6c75  y reset the colu
+000124e0: 6d6e 2064 6174 6120 736f 7572 6365 2074  mn data source t
+000124f0: 6f20 7265 6d6f 7665 206f 6c64 206e 6f64  o remove old nod
+00012500: 6573 0a20 2020 2020 2020 2020 2020 2069  es.            i
+00012510: 6620 7365 6c66 2e69 6e76 6973 6962 6c65  f self.invisible
+00012520: 5f63 6f75 6e74 203e 206c 656e 2873 656c  _count > len(sel
+00012530: 662e 6e6f 6465 5f73 6f75 7263 652e 6461  f.node_source.da
+00012540: 7461 5b22 7822 5d29 202f 2032 3a0a 2020  ta["x"]) / 2:.  
+00012550: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00012560: 6c66 2e6c 6179 6f75 742e 7265 7365 745f  lf.layout.reset_
+00012570: 696e 6465 7828 290a 2020 2020 2020 2020  index().        
+00012580: 2020 2020 2020 2020 7365 6c66 2e69 6e76          self.inv
+00012590: 6973 6962 6c65 5f63 6f75 6e74 203d 2030  isible_count = 0
+000125a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000125b0: 2075 7064 6174 6520 3d20 5472 7565 0a20   update = True. 
+000125c0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000125d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000125e0: 2075 7064 6174 6520 3d20 4661 6c73 650a   update = False.
+000125f0: 0a20 2020 2020 2020 2020 2020 206e 6577  .            new
+00012600: 2c20 7365 6c66 2e6c 6179 6f75 742e 6e65  , self.layout.ne
+00012610: 7720 3d20 7365 6c66 2e6c 6179 6f75 742e  w = self.layout.
+00012620: 6e65 772c 205b 5d0a 2020 2020 2020 2020  new, [].        
+00012630: 2020 2020 6e65 775f 6564 6765 7320 3d20      new_edges = 
+00012640: 7365 6c66 2e6c 6179 6f75 742e 6e65 775f  self.layout.new_
+00012650: 6564 6765 730a 2020 2020 2020 2020 2020  edges.          
+00012660: 2020 7365 6c66 2e6c 6179 6f75 742e 6e65    self.layout.ne
+00012670: 775f 6564 6765 7320 3d20 5b5d 0a0a 2020  w_edges = []..  
+00012680: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+00012690: 6464 5f6e 6577 5f6e 6f64 6573 5f65 6467  dd_new_nodes_edg
+000126a0: 6573 286e 6577 2c20 6e65 775f 6564 6765  es(new, new_edge
+000126b0: 732c 2075 7064 6174 653d 7570 6461 7465  s, update=update
+000126c0: 290a 0a20 2020 2020 2020 2020 2020 2073  )..            s
+000126d0: 656c 662e 7061 7463 685f 7570 6461 7465  elf.patch_update
+000126e0: 7328 290a 0a20 2020 2020 2020 2020 2020  s()..           
+000126f0: 2069 6620 6c65 6e28 7365 6c66 2e73 6368   if len(self.sch
+00012700: 6564 756c 6572 2e74 6173 6b73 2920 3d3d  eduler.tasks) ==
+00012710: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00012720: 2020 2020 7365 6c66 2e73 7562 7469 746c      self.subtitl
+00012730: 652e 7465 7874 203d 2022 5363 6865 6475  e.text = "Schedu
+00012740: 6c65 7220 6973 2065 6d70 7479 2e22 0a20  ler is empty.". 
+00012750: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00012760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012770: 2073 656c 662e 7375 6274 6974 6c65 2e74   self.subtitle.t
+00012780: 6578 7420 3d20 2220 220a 0a20 2020 2040  ext = " "..    @
+00012790: 7769 7468 6f75 745f 7072 6f70 6572 7479  without_property
+000127a0: 5f76 616c 6964 6174 696f 6e0a 2020 2020  _validation.    
+000127b0: 6465 6620 6164 645f 6e65 775f 6e6f 6465  def add_new_node
+000127c0: 735f 6564 6765 7328 7365 6c66 2c20 6e65  s_edges(self, ne
+000127d0: 772c 206e 6577 5f65 6467 6573 2c20 7570  w, new_edges, up
+000127e0: 6461 7465 3d46 616c 7365 293a 0a20 2020  date=False):.   
+000127f0: 2020 2020 2069 6620 6e65 7720 6f72 2075       if new or u
+00012800: 7064 6174 653a 0a20 2020 2020 2020 2020  pdate:.         
+00012810: 2020 206e 6f64 655f 6b65 7920 3d20 5b5d     node_key = []
+00012820: 0a20 2020 2020 2020 2020 2020 206e 6f64  .            nod
+00012830: 655f 7820 3d20 5b5d 0a20 2020 2020 2020  e_x = [].       
+00012840: 2020 2020 206e 6f64 655f 7920 3d20 5b5d       node_y = []
+00012850: 0a20 2020 2020 2020 2020 2020 206e 6f64  .            nod
+00012860: 655f 7374 6174 6520 3d20 5b5d 0a20 2020  e_state = [].   
+00012870: 2020 2020 2020 2020 206e 6f64 655f 6e61           node_na
+00012880: 6d65 203d 205b 5d0a 2020 2020 2020 2020  me = [].        
+00012890: 2020 2020 6564 6765 5f78 203d 205b 5d0a      edge_x = [].
+000128a0: 2020 2020 2020 2020 2020 2020 6564 6765              edge
+000128b0: 5f79 203d 205b 5d0a 0a20 2020 2020 2020  _y = []..       
+000128c0: 2020 2020 2078 203d 2073 656c 662e 6c61       x = self.la
+000128d0: 796f 7574 2e78 0a20 2020 2020 2020 2020  yout.x.         
+000128e0: 2020 2079 203d 2073 656c 662e 6c61 796f     y = self.layo
+000128f0: 7574 2e79 0a0a 2020 2020 2020 2020 2020  ut.y..          
+00012900: 2020 7461 736b 7320 3d20 7365 6c66 2e73    tasks = self.s
+00012910: 6368 6564 756c 6572 2e74 6173 6b73 0a20  cheduler.tasks. 
+00012920: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
+00012930: 6579 2069 6e20 6e65 773a 0a20 2020 2020  ey in new:.     
+00012940: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00012950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012960: 2020 2020 7461 736b 203d 2074 6173 6b73      task = tasks
+00012970: 5b6b 6579 5d0a 2020 2020 2020 2020 2020  [key].          
+00012980: 2020 2020 2020 6578 6365 7074 204b 6579        except Key
+00012990: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+000129a0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+000129b0: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
+000129c0: 2020 2020 7878 203d 2078 5b6b 6579 5d0a      xx = x[key].
+000129d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000129e0: 7979 203d 2079 5b6b 6579 5d0a 2020 2020  yy = y[key].    
+000129f0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+00012a00: 5f6b 6579 2e61 7070 656e 6428 6573 6361  _key.append(esca
+00012a10: 7065 2e75 726c 5f65 7363 6170 6528 6b65  pe.url_escape(ke
+00012a20: 7929 290a 2020 2020 2020 2020 2020 2020  y)).            
+00012a30: 2020 2020 6e6f 6465 5f78 2e61 7070 656e      node_x.appen
+00012a40: 6428 7878 290a 2020 2020 2020 2020 2020  d(xx).          
+00012a50: 2020 2020 2020 6e6f 6465 5f79 2e61 7070        node_y.app
+00012a60: 656e 6428 7979 290a 2020 2020 2020 2020  end(yy).        
+00012a70: 2020 2020 2020 2020 6e6f 6465 5f73 7461          node_sta
+00012a80: 7465 2e61 7070 656e 6428 7461 736b 2e73  te.append(task.s
+00012a90: 7461 7465 290a 2020 2020 2020 2020 2020  tate).          
+00012aa0: 2020 2020 2020 6e6f 6465 5f6e 616d 652e        node_name.
+00012ab0: 6170 7065 6e64 2874 6173 6b2e 7072 6566  append(task.pref
+00012ac0: 6978 2e6e 616d 6529 0a0a 2020 2020 2020  ix.name)..      
+00012ad0: 2020 2020 2020 666f 7220 612c 2062 2069        for a, b i
+00012ae0: 6e20 6e65 775f 6564 6765 733a 0a20 2020  n new_edges:.   
+00012af0: 2020 2020 2020 2020 2020 2020 2074 7279               try
+00012b00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00012b10: 2020 2020 2020 6564 6765 5f78 2e61 7070        edge_x.app
+00012b20: 656e 6428 5b78 5b61 5d2c 2078 5b62 5d5d  end([x[a], x[b]]
+00012b30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00012b40: 2020 2020 2020 6564 6765 5f79 2e61 7070        edge_y.app
+00012b50: 656e 6428 5b79 5b61 5d2c 2079 5b62 5d5d  end([y[a], y[b]]
+00012b60: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00012b70: 2020 6578 6365 7074 204b 6579 4572 726f    except KeyErro
+00012b80: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+00012b90: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
+00012ba0: 2020 2020 2020 2020 206e 6f64 6520 3d20           node = 
+00012bb0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00012bc0: 2020 2278 223a 206e 6f64 655f 782c 0a20    "x": node_x,. 
+00012bd0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00012be0: 7922 3a20 6e6f 6465 5f79 2c0a 2020 2020  y": node_y,.    
+00012bf0: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+00012c00: 7465 223a 206e 6f64 655f 7374 6174 652c  te": node_state,
+00012c10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012c20: 2022 6e61 6d65 223a 206e 6f64 655f 6e61   "name": node_na
+00012c30: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+00012c40: 2020 2020 226b 6579 223a 206e 6f64 655f      "key": node_
+00012c50: 6b65 792c 0a20 2020 2020 2020 2020 2020  key,.           
+00012c60: 2020 2020 2022 7669 7369 626c 6522 3a20       "visible": 
+00012c70: 5b22 5472 7565 225d 202a 206c 656e 286e  ["True"] * len(n
+00012c80: 6f64 655f 7829 2c0a 2020 2020 2020 2020  ode_x),.        
+00012c90: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00012ca0: 2020 6564 6765 203d 207b 2278 223a 2065    edge = {"x": e
+00012cb0: 6467 655f 782c 2022 7922 3a20 6564 6765  dge_x, "y": edge
+00012cc0: 5f79 2c20 2276 6973 6962 6c65 223a 205b  _y, "visible": [
+00012cd0: 2254 7275 6522 5d20 2a20 6c65 6e28 6564  "True"] * len(ed
+00012ce0: 6765 5f78 297d 0a0a 2020 2020 2020 2020  ge_x)}..        
+00012cf0: 2020 2020 6966 2075 7064 6174 6520 6f72      if update or
+00012d00: 206e 6f74 206c 656e 2873 656c 662e 6e6f   not len(self.no
+00012d10: 6465 5f73 6f75 7263 652e 6461 7461 5b22  de_source.data["
+00012d20: 7822 5d29 3a0a 2020 2020 2020 2020 2020  x"]):.          
+00012d30: 2020 2020 2020 2320 7365 6520 6874 7470        # see http
+00012d40: 733a 2f2f 6769 7468 7562 2e63 6f6d 2f62  s://github.com/b
+00012d50: 6f6b 6568 2f62 6f6b 6568 2f69 7373 7565  okeh/bokeh/issue
+00012d60: 732f 3735 3233 0a20 2020 2020 2020 2020  s/7523.         
+00012d70: 2020 2020 2020 2073 656c 662e 6e6f 6465         self.node
+00012d80: 5f73 6f75 7263 652e 6461 7461 2e75 7064  _source.data.upd
+00012d90: 6174 6528 6e6f 6465 290a 2020 2020 2020  ate(node).      
+00012da0: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
+00012db0: 6467 655f 736f 7572 6365 2e64 6174 612e  dge_source.data.
+00012dc0: 7570 6461 7465 2865 6467 6529 0a20 2020  update(edge).   
+00012dd0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00012de0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00012df0: 656c 662e 6e6f 6465 5f73 6f75 7263 652e  elf.node_source.
+00012e00: 7374 7265 616d 286e 6f64 6529 0a20 2020  stream(node).   
+00012e10: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00012e20: 662e 6564 6765 5f73 6f75 7263 652e 7374  f.edge_source.st
+00012e30: 7265 616d 2865 6467 6529 0a0a 2020 2020  ream(edge)..    
+00012e40: 4077 6974 686f 7574 5f70 726f 7065 7274  @without_propert
+00012e50: 795f 7661 6c69 6461 7469 6f6e 0a20 2020  y_validation.   
+00012e60: 2064 6566 2070 6174 6368 5f75 7064 6174   def patch_updat
+00012e70: 6573 2873 656c 6629 3a0a 2020 2020 2020  es(self):.      
+00012e80: 2020 2222 220a 2020 2020 2020 2020 536d    """.        Sm
+00012e90: 616c 6c20 7570 6461 7465 7320 6c69 6b65  all updates like
+00012ea0: 2063 6f6c 6f72 2063 6861 6e67 6573 206f   color changes o
+00012eb0: 7220 6c6f 7374 206e 6f64 6573 2066 726f  r lost nodes fro
+00012ec0: 6d20 7461 736b 2074 7261 6e73 6974 696f  m task transitio
+00012ed0: 6e73 0a20 2020 2020 2020 2022 2222 0a20  ns.        """. 
+00012ee0: 2020 2020 2020 206e 203d 206c 656e 2873         n = len(s
+00012ef0: 656c 662e 6e6f 6465 5f73 6f75 7263 652e  elf.node_source.
+00012f00: 6461 7461 5b22 7822 5d29 0a20 2020 2020  data["x"]).     
+00012f10: 2020 206d 203d 206c 656e 2873 656c 662e     m = len(self.
+00012f20: 6564 6765 5f73 6f75 7263 652e 6461 7461  edge_source.data
+00012f30: 5b22 7822 5d29 0a0a 2020 2020 2020 2020  ["x"])..        
+00012f40: 6966 2073 656c 662e 6c61 796f 7574 2e73  if self.layout.s
+00012f50: 7461 7465 5f75 7064 6174 6573 3a0a 2020  tate_updates:.  
+00012f60: 2020 2020 2020 2020 2020 7374 6174 655f            state_
+00012f70: 7570 6461 7465 7320 3d20 7365 6c66 2e6c  updates = self.l
+00012f80: 6179 6f75 742e 7374 6174 655f 7570 6461  ayout.state_upda
+00012f90: 7465 730a 2020 2020 2020 2020 2020 2020  tes.            
+00012fa0: 7365 6c66 2e6c 6179 6f75 742e 7374 6174  self.layout.stat
+00012fb0: 655f 7570 6461 7465 7320 3d20 5b5d 0a20  e_updates = []. 
+00012fc0: 2020 2020 2020 2020 2020 2075 7064 6174             updat
+00012fd0: 6573 203d 205b 2869 2c20 6329 2066 6f72  es = [(i, c) for
+00012fe0: 2069 2c20 6320 696e 2073 7461 7465 5f75   i, c in state_u
+00012ff0: 7064 6174 6573 2069 6620 6920 3c20 6e5d  pdates if i < n]
+00013000: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00013010: 662e 6e6f 6465 5f73 6f75 7263 652e 7061  f.node_source.pa
+00013020: 7463 6828 7b22 7374 6174 6522 3a20 7570  tch({"state": up
+00013030: 6461 7465 737d 290a 0a20 2020 2020 2020  dates})..       
+00013040: 2069 6620 7365 6c66 2e6c 6179 6f75 742e   if self.layout.
+00013050: 7669 7369 626c 655f 7570 6461 7465 733a  visible_updates:
+00013060: 0a20 2020 2020 2020 2020 2020 2075 7064  .            upd
+00013070: 6174 6573 203d 2073 656c 662e 6c61 796f  ates = self.layo
+00013080: 7574 2e76 6973 6962 6c65 5f75 7064 6174  ut.visible_updat
+00013090: 6573 0a20 2020 2020 2020 2020 2020 2075  es.            u
+000130a0: 7064 6174 6573 203d 205b 2869 2c20 6329  pdates = [(i, c)
+000130b0: 2066 6f72 2069 2c20 6320 696e 2075 7064   for i, c in upd
+000130c0: 6174 6573 2069 6620 6920 3c20 6e5d 0a20  ates if i < n]. 
+000130d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000130e0: 6c61 796f 7574 2e76 6973 6962 6c65 5f75  layout.visible_u
+000130f0: 7064 6174 6573 203d 205b 5d0a 2020 2020  pdates = [].    
+00013100: 2020 2020 2020 2020 7365 6c66 2e6e 6f64          self.nod
+00013110: 655f 736f 7572 6365 2e70 6174 6368 287b  e_source.patch({
+00013120: 2276 6973 6962 6c65 223a 2075 7064 6174  "visible": updat
+00013130: 6573 7d29 0a20 2020 2020 2020 2020 2020  es}).           
+00013140: 2073 656c 662e 696e 7669 7369 626c 655f   self.invisible_
+00013150: 636f 756e 7420 2b3d 206c 656e 2875 7064  count += len(upd
+00013160: 6174 6573 290a 0a20 2020 2020 2020 2069  ates)..        i
+00013170: 6620 7365 6c66 2e6c 6179 6f75 742e 7669  f self.layout.vi
+00013180: 7369 626c 655f 6564 6765 5f75 7064 6174  sible_edge_updat
+00013190: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+000131a0: 7570 6461 7465 7320 3d20 7365 6c66 2e6c  updates = self.l
+000131b0: 6179 6f75 742e 7669 7369 626c 655f 6564  ayout.visible_ed
+000131c0: 6765 5f75 7064 6174 6573 0a20 2020 2020  ge_updates.     
+000131d0: 2020 2020 2020 2075 7064 6174 6573 203d         updates =
+000131e0: 205b 2869 2c20 6329 2066 6f72 2069 2c20   [(i, c) for i, 
+000131f0: 6320 696e 2075 7064 6174 6573 2069 6620  c in updates if 
+00013200: 6920 3c20 6d5d 0a20 2020 2020 2020 2020  i < m].         
+00013210: 2020 2073 656c 662e 6c61 796f 7574 2e76     self.layout.v
+00013220: 6973 6962 6c65 5f65 6467 655f 7570 6461  isible_edge_upda
+00013230: 7465 7320 3d20 5b5d 0a20 2020 2020 2020  tes = [].       
+00013240: 2020 2020 2073 656c 662e 6564 6765 5f73       self.edge_s
+00013250: 6f75 7263 652e 7061 7463 6828 7b22 7669  ource.patch({"vi
+00013260: 7369 626c 6522 3a20 7570 6461 7465 737d  sible": updates}
+00013270: 290a 0a20 2020 2064 6566 205f 5f64 656c  )..    def __del
+00013280: 5f5f 2873 656c 6629 3a0a 2020 2020 2020  __(self):.      
+00013290: 2020 7365 6c66 2e73 6368 6564 756c 6572    self.scheduler
+000132a0: 2e72 656d 6f76 655f 706c 7567 696e 286e  .remove_plugin(n
+000132b0: 616d 653d 7365 6c66 2e6c 6179 6f75 742e  ame=self.layout.
+000132c0: 6e61 6d65 290a 0a0a 636c 6173 7320 5461  name)...class Ta
+000132d0: 736b 4772 6f75 7047 7261 7068 2844 6173  skGroupGraph(Das
+000132e0: 6862 6f61 7264 436f 6d70 6f6e 656e 7429  hboardComponent)
+000132f0: 3a0a 2020 2020 2222 220a 2020 2020 5461  :.    """.    Ta
+00013300: 736b 2047 726f 7570 2047 7261 7068 0a0a  sk Group Graph..
+00013310: 2020 2020 4372 6561 7465 7320 6120 6772      Creates a gr
+00013320: 6170 6820 6c61 796f 7574 2066 6f72 2054  aph layout for T
+00013330: 6173 6b47 726f 7570 7320 6f6e 2074 6865  askGroups on the
+00013340: 2073 6368 6564 756c 6572 2e20 2049 7420   scheduler.  It 
+00013350: 6173 7369 676e 730a 2020 2020 2878 2c20  assigns.    (x, 
+00013360: 7929 206c 6f63 6174 696f 6e73 2074 6f20  y) locations to 
+00013370: 616c 6c20 7468 6520 5461 736b 4772 6f75  all the TaskGrou
+00013380: 7073 2061 6e64 206c 6179 7320 7468 656d  ps and lays them
+00013390: 206f 7574 2062 7920 6163 636f 7264 696e   out by accordin
+000133a0: 670a 2020 2020 746f 2074 6865 6972 2064  g.    to their d
+000133b0: 6570 656e 6465 6e63 6965 732e 2054 6865  ependencies. The
+000133c0: 206c 6179 6f75 7420 6765 7473 2075 7064   layout gets upd
+000133d0: 6174 6564 2065 7665 7279 2074 696d 6520  ated every time 
+000133e0: 7468 6174 206e 6577 0a20 2020 2054 6173  that new.    Tas
+000133f0: 6b47 726f 7570 7320 6172 6520 6164 6465  kGroups are adde
+00013400: 642e 0a0a 2020 2020 4561 6368 2074 6173  d...    Each tas
+00013410: 6b20 6772 6f75 7020 6e6f 6465 2069 6e63  k group node inc
+00013420: 6f64 6573 2069 6e66 6f72 6d61 7469 6f6e  odes information
+00013430: 2061 626f 7574 2074 6173 6b20 7072 6f67   about task prog
+00013440: 7265 7373 2c20 6d65 6d6f 7279 2c0a 2020  ress, memory,.  
+00013450: 2020 616e 6420 6f75 7470 7574 2074 7970    and output typ
+00013460: 6520 696e 746f 2067 6c79 7068 732c 2061  e into glyphs, a
+00013470: 7320 7765 6c6c 2061 7320 6120 686f 7665  s well as a hove
+00013480: 7220 746f 6f6c 7469 7020 7769 7468 206d  r tooltip with m
+00013490: 6f72 6520 6465 7461 696c 6564 0a20 2020  ore detailed.   
+000134a0: 2069 6e66 6f72 6d61 7469 6f6e 206f 6e20   information on 
+000134b0: 6e61 6d65 2c20 636f 6d70 7574 6174 696f  name, computatio
+000134c0: 6e20 7469 6d65 2c20 6d65 6d6f 7279 2c20  n time, memory, 
+000134d0: 616e 6420 7461 736b 7320 7374 6174 7573  and tasks status
+000134e0: 2e0a 2020 2020 2222 220a 0a20 2020 2064  ..    """..    d
+000134f0: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+00013500: 2c20 7363 6865 6475 6c65 722c 202a 2a6b  , scheduler, **k
+00013510: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+00013520: 7365 6c66 2e73 6368 6564 756c 6572 203d  self.scheduler =
+00013530: 2073 6368 6564 756c 6572 0a0a 2020 2020   scheduler..    
+00013540: 2020 2020 7365 6c66 2e6e 6f64 6573 5f6c      self.nodes_l
+00013550: 6179 6f75 7420 3d20 7b7d 0a20 2020 2020  ayout = {}.     
+00013560: 2020 2073 656c 662e 6172 726f 7773 5f6c     self.arrows_l
+00013570: 6179 6f75 7420 3d20 7b7d 0a0a 2020 2020  ayout = {}..    
+00013580: 2020 2020 7365 6c66 2e6f 6c64 5f63 6f75      self.old_cou
+00013590: 6e74 6572 203d 202d 310a 0a20 2020 2020  nter = -1..     
+000135a0: 2020 2073 656c 662e 6e6f 6465 735f 736f     self.nodes_so
+000135b0: 7572 6365 203d 2043 6f6c 756d 6e44 6174  urce = ColumnDat
+000135c0: 6153 6f75 7263 6528 0a20 2020 2020 2020  aSource(.       
+000135d0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+000135e0: 2020 2020 2020 2022 7822 3a20 5b5d 2c0a         "x": [],.
+000135f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013600: 2279 223a 205b 5d2c 0a20 2020 2020 2020  "y": [],.       
+00013610: 2020 2020 2020 2020 2022 775f 626f 7822           "w_box"
+00013620: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+00013630: 2020 2020 2020 2268 5f62 6f78 223a 205b        "h_box": [
+00013640: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00013650: 2020 2022 6e61 6d65 223a 205b 5d2c 0a20     "name": [],. 
+00013660: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00013670: 746f 745f 7461 736b 7322 3a20 5b5d 2c0a  tot_tasks": [],.
+00013680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013690: 2263 6f6c 6f72 223a 205b 5d2c 0a20 2020  "color": [],.   
+000136a0: 2020 2020 2020 2020 2020 2020 2022 785f               "x_
+000136b0: 7374 6172 7422 3a20 5b5d 2c0a 2020 2020  start": [],.    
+000136c0: 2020 2020 2020 2020 2020 2020 2278 5f65              "x_e
+000136d0: 6e64 223a 205b 5d2c 0a20 2020 2020 2020  nd": [],.       
+000136e0: 2020 2020 2020 2020 2022 795f 7374 6172           "y_star
+000136f0: 7422 3a20 5b5d 2c0a 2020 2020 2020 2020  t": [],.        
+00013700: 2020 2020 2020 2020 2279 5f65 6e64 223a          "y_end":
+00013710: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+00013720: 2020 2020 2022 785f 656e 645f 7072 6f67       "x_end_prog
+00013730: 7265 7373 223a 205b 5d2c 0a20 2020 2020  ress": [],.     
+00013740: 2020 2020 2020 2020 2020 2022 6d65 6d5f             "mem_
+00013750: 616c 7068 6122 3a20 5b5d 2c0a 2020 2020  alpha": [],.    
+00013760: 2020 2020 2020 2020 2020 2020 226e 6f64              "nod
+00013770: 655f 6c69 6e65 5f77 6964 7468 223a 205b  e_line_width": [
+00013780: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00013790: 2020 2022 636f 6d70 5f74 6173 6b73 223a     "comp_tasks":
+000137a0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+000137b0: 2020 2020 2022 7572 6c5f 6c6f 676f 223a       "url_logo":
+000137c0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+000137d0: 2020 2020 2022 785f 6c6f 676f 223a 205b       "x_logo": [
+000137e0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+000137f0: 2020 2022 795f 6c6f 676f 223a 205b 5d2c     "y_logo": [],
+00013800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013810: 2022 775f 6c6f 676f 223a 205b 5d2c 0a20   "w_logo": [],. 
+00013820: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00013830: 685f 6c6f 676f 223a 205b 5d2c 0a20 2020  h_logo": [],.   
+00013840: 2020 2020 2020 2020 2020 2020 2022 696e               "in
+00013850: 5f70 726f 6365 7373 696e 6722 3a20 5b5d  _processing": []
+00013860: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00013870: 2020 2269 6e5f 6d65 6d6f 7279 223a 205b    "in_memory": [
+00013880: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00013890: 2020 2022 696e 5f72 656c 6561 7365 6422     "in_released"
+000138a0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+000138b0: 2020 2020 2020 2269 6e5f 6572 7265 6422        "in_erred"
+000138c0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+000138d0: 2020 2020 2020 2263 6f6d 7075 7465 5f74        "compute_t
+000138e0: 696d 6522 3a20 5b5d 2c0a 2020 2020 2020  ime": [],.      
+000138f0: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
+00013900: 7922 3a20 5b5d 2c0a 2020 2020 2020 2020  y": [],.        
+00013910: 2020 2020 7d0a 2020 2020 2020 2020 290a      }.        ).
+00013920: 0a20 2020 2020 2020 2073 656c 662e 6172  .        self.ar
+00013930: 726f 7773 5f73 6f75 7263 6520 3d20 436f  rows_source = Co
+00013940: 6c75 6d6e 4461 7461 536f 7572 6365 287b  lumnDataSource({
+00013950: 2278 7322 3a20 5b5d 2c20 2279 7322 3a20  "xs": [], "ys": 
+00013960: 5b5d 2c20 2278 6522 3a20 5b5d 2c20 2279  [], "xe": [], "y
+00013970: 6522 3a20 5b5d 7d29 0a0a 2020 2020 2020  e": []})..      
+00013980: 2020 7365 6c66 2e72 6f6f 7420 3d20 6669    self.root = fi
+00013990: 6775 7265 2874 6974 6c65 3d22 5461 736b  gure(title="Task
+000139a0: 2047 726f 7570 7320 4772 6170 6822 2c20   Groups Graph", 
+000139b0: 6d61 7463 685f 6173 7065 6374 3d54 7275  match_aspect=Tru
+000139c0: 652c 202a 2a6b 7761 7267 7329 0a20 2020  e, **kwargs).   
+000139d0: 2020 2020 2073 656c 662e 726f 6f74 2e61       self.root.a
+000139e0: 7869 732e 7669 7369 626c 6520 3d20 4661  xis.visible = Fa
+000139f0: 6c73 650a 2020 2020 2020 2020 7365 6c66  lse.        self
+00013a00: 2e73 7562 7469 746c 6520 3d20 5469 746c  .subtitle = Titl
+00013a10: 6528 7465 7874 3d22 2022 2c20 7465 7874  e(text=" ", text
+00013a20: 5f66 6f6e 745f 7374 796c 653d 2269 7461  _font_style="ita
+00013a30: 6c69 6322 290a 2020 2020 2020 2020 7365  lic").        se
+00013a40: 6c66 2e72 6f6f 742e 6164 645f 6c61 796f  lf.root.add_layo
+00013a50: 7574 2873 656c 662e 7375 6274 6974 6c65  ut(self.subtitle
+00013a60: 2c20 2261 626f 7665 2229 0a0a 2020 2020  , "above")..    
+00013a70: 2020 2020 7265 6374 203d 2073 656c 662e      rect = self.
+00013a80: 726f 6f74 2e72 6563 7428 0a20 2020 2020  root.rect(.     
+00013a90: 2020 2020 2020 2078 3d22 7822 2c0a 2020         x="x",.  
+00013aa0: 2020 2020 2020 2020 2020 793d 2279 222c            y="y",
+00013ab0: 0a20 2020 2020 2020 2020 2020 2077 6964  .            wid
+00013ac0: 7468 3d22 775f 626f 7822 2c0a 2020 2020  th="w_box",.    
+00013ad0: 2020 2020 2020 2020 6865 6967 6874 3d22          height="
+00013ae0: 685f 626f 7822 2c0a 2020 2020 2020 2020  h_box",.        
+00013af0: 2020 2020 636f 6c6f 723d 2263 6f6c 6f72      color="color
+00013b00: 222c 0a20 2020 2020 2020 2020 2020 2066  ",.            f
+00013b10: 696c 6c5f 616c 7068 613d 226d 656d 5f61  ill_alpha="mem_a
+00013b20: 6c70 6861 222c 0a20 2020 2020 2020 2020  lpha",.         
+00013b30: 2020 206c 696e 655f 636f 6c6f 723d 2262     line_color="b
+00013b40: 6c61 636b 222c 0a20 2020 2020 2020 2020  lack",.         
+00013b50: 2020 206c 696e 655f 7769 6474 683d 226e     line_width="n
+00013b60: 6f64 655f 6c69 6e65 5f77 6964 7468 222c  ode_line_width",
+00013b70: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
+00013b80: 7263 653d 7365 6c66 2e6e 6f64 6573 5f73  rce=self.nodes_s
+00013b90: 6f75 7263 652c 0a20 2020 2020 2020 2029  ource,.        )
+00013ba0: 0a0a 2020 2020 2020 2020 2320 706c 6f74  ..        # plot
+00013bb0: 2074 6720 6c6f 670a 2020 2020 2020 2020   tg log.        
+00013bc0: 7365 6c66 2e72 6f6f 742e 696d 6167 655f  self.root.image_
+00013bd0: 7572 6c28 0a20 2020 2020 2020 2020 2020  url(.           
+00013be0: 2075 726c 3d22 7572 6c5f 6c6f 676f 222c   url="url_logo",
+00013bf0: 0a20 2020 2020 2020 2020 2020 2078 3d22  .            x="
+00013c00: 785f 6c6f 676f 222c 0a20 2020 2020 2020  x_logo",.       
+00013c10: 2020 2020 2079 3d22 795f 6c6f 676f 222c       y="y_logo",
+00013c20: 0a20 2020 2020 2020 2020 2020 2077 3d22  .            w="
+00013c30: 775f 6c6f 676f 222c 0a20 2020 2020 2020  w_logo",.       
+00013c40: 2020 2020 2068 3d22 685f 6c6f 676f 222c       h="h_logo",
+00013c50: 0a20 2020 2020 2020 2020 2020 2061 6e63  .            anc
+00013c60: 686f 723d 2263 656e 7465 7222 2c0a 2020  hor="center",.  
+00013c70: 2020 2020 2020 2020 2020 736f 7572 6365            source
+00013c80: 3d73 656c 662e 6e6f 6465 735f 736f 7572  =self.nodes_sour
+00013c90: 6365 2c0a 2020 2020 2020 2020 290a 0a20  ce,.        ).. 
+00013ca0: 2020 2020 2020 2023 2070 726f 6772 6573         # progres
+00013cb0: 7320 6261 7220 706c 6169 6e20 626f 780a  s bar plain box.
+00013cc0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+00013cd0: 742e 7175 6164 280a 2020 2020 2020 2020  t.quad(.        
+00013ce0: 2020 2020 6c65 6674 3d22 785f 7374 6172      left="x_star
+00013cf0: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
+00013d00: 7269 6768 743d 2278 5f65 6e64 222c 0a20  right="x_end",. 
+00013d10: 2020 2020 2020 2020 2020 2062 6f74 746f             botto
+00013d20: 6d3d 2279 5f73 7461 7274 222c 0a20 2020  m="y_start",.   
+00013d30: 2020 2020 2020 2020 2074 6f70 3d22 795f           top="y_
+00013d40: 656e 6422 2c0a 2020 2020 2020 2020 2020  end",.          
+00013d50: 2020 636f 6c6f 723d 4e6f 6e65 2c0a 2020    color=None,.  
+00013d60: 2020 2020 2020 2020 2020 6c69 6e65 5f63            line_c
+00013d70: 6f6c 6f72 3d22 626c 6163 6b22 2c0a 2020  olor="black",.  
+00013d80: 2020 2020 2020 2020 2020 736f 7572 6365            source
+00013d90: 3d73 656c 662e 6e6f 6465 735f 736f 7572  =self.nodes_sour
+00013da0: 6365 2c0a 2020 2020 2020 2020 290a 0a20  ce,.        ).. 
+00013db0: 2020 2020 2020 2023 2070 726f 6772 6573         # progres
+00013dc0: 7320 6261 720a 2020 2020 2020 2020 7365  s bar.        se
+00013dd0: 6c66 2e72 6f6f 742e 7175 6164 280a 2020  lf.root.quad(.  
+00013de0: 2020 2020 2020 2020 2020 6c65 6674 3d22            left="
+00013df0: 785f 7374 6172 7422 2c0a 2020 2020 2020  x_start",.      
+00013e00: 2020 2020 2020 7269 6768 743d 2278 5f65        right="x_e
+00013e10: 6e64 5f70 726f 6772 6573 7322 2c0a 2020  nd_progress",.  
+00013e20: 2020 2020 2020 2020 2020 626f 7474 6f6d            bottom
+00013e30: 3d22 795f 7374 6172 7422 2c0a 2020 2020  ="y_start",.    
+00013e40: 2020 2020 2020 2020 746f 703d 2279 5f65          top="y_e
+00013e50: 6e64 222c 0a20 2020 2020 2020 2020 2020  nd",.           
+00013e60: 2063 6f6c 6f72 3d22 636f 6c6f 7222 2c0a   color="color",.
+00013e70: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
+00013e80: 5f63 6f6c 6f72 3d4e 6f6e 652c 0a20 2020  _color=None,.   
+00013e90: 2020 2020 2020 2020 2066 696c 6c5f 616c           fill_al
+00013ea0: 7068 613d 302e 362c 0a20 2020 2020 2020  pha=0.6,.       
+00013eb0: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
+00013ec0: 2e6e 6f64 6573 5f73 6f75 7263 652c 0a20  .nodes_source,. 
+00013ed0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00013ee0: 2020 7365 6c66 2e61 7272 6f77 7320 3d20    self.arrows = 
+00013ef0: 4172 726f 7728 0a20 2020 2020 2020 2020  Arrow(.         
+00013f00: 2020 2065 6e64 3d56 6565 4865 6164 2873     end=VeeHead(s
+00013f10: 697a 653d 3829 2c0a 2020 2020 2020 2020  ize=8),.        
+00013f20: 2020 2020 6c69 6e65 5f63 6f6c 6f72 3d22      line_color="
+00013f30: 626c 6163 6b22 2c0a 2020 2020 2020 2020  black",.        
+00013f40: 2020 2020 6c69 6e65 5f61 6c70 6861 3d30      line_alpha=0
+00013f50: 2e35 2c0a 2020 2020 2020 2020 2020 2020  .5,.            
+00013f60: 6c69 6e65 5f77 6964 7468 3d31 2c0a 2020  line_width=1,.  
+00013f70: 2020 2020 2020 2020 2020 785f 7374 6172            x_star
+00013f80: 743d 2278 7322 2c0a 2020 2020 2020 2020  t="xs",.        
+00013f90: 2020 2020 795f 7374 6172 743d 2279 7322      y_start="ys"
+00013fa0: 2c0a 2020 2020 2020 2020 2020 2020 785f  ,.            x_
+00013fb0: 656e 643d 2278 6522 2c0a 2020 2020 2020  end="xe",.      
+00013fc0: 2020 2020 2020 795f 656e 643d 2279 6522        y_end="ye"
+00013fd0: 2c0a 2020 2020 2020 2020 2020 2020 736f  ,.            so
+00013fe0: 7572 6365 3d73 656c 662e 6172 726f 7773  urce=self.arrows
+00013ff0: 5f73 6f75 7263 652c 0a20 2020 2020 2020  _source,.       
+00014000: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+00014010: 726f 6f74 2e61 6464 5f6c 6179 6f75 7428  root.add_layout(
+00014020: 7365 6c66 2e61 7272 6f77 7329 0a0a 2020  self.arrows)..  
+00014030: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+00014040: 7867 7269 642e 6772 6964 5f6c 696e 655f  xgrid.grid_line_
+00014050: 636f 6c6f 7220 3d20 4e6f 6e65 0a20 2020  color = None.   
+00014060: 2020 2020 2073 656c 662e 726f 6f74 2e79       self.root.y
+00014070: 6772 6964 2e67 7269 645f 6c69 6e65 5f63  grid.grid_line_c
+00014080: 6f6c 6f72 203d 204e 6f6e 650a 2020 2020  olor = None.    
+00014090: 2020 2020 7365 6c66 2e72 6f6f 742e 785f      self.root.x_
+000140a0: 7261 6e67 652e 7261 6e67 655f 7061 6464  range.range_padd
+000140b0: 696e 6720 3d20 302e 350a 2020 2020 2020  ing = 0.5.      
+000140c0: 2020 7365 6c66 2e72 6f6f 742e 795f 7261    self.root.y_ra
+000140d0: 6e67 652e 7261 6e67 655f 7061 6464 696e  nge.range_paddin
+000140e0: 6720 3d20 302e 350a 0a20 2020 2020 2020  g = 0.5..       
+000140f0: 2068 6f76 6572 203d 2048 6f76 6572 546f   hover = HoverTo
+00014100: 6f6c 280a 2020 2020 2020 2020 2020 2020  ol(.            
+00014110: 706f 696e 745f 706f 6c69 6379 3d22 666f  point_policy="fo
+00014120: 6c6c 6f77 5f6d 6f75 7365 222c 0a20 2020  llow_mouse",.   
+00014130: 2020 2020 2020 2020 2074 6f6f 6c74 6970           tooltip
+00014140: 733d 2222 220a 2020 2020 2020 2020 2020  s=""".          
+00014150: 2020 2020 2020 3c64 6976 3e0a 2020 2020        <div>.    
+00014160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014170: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
+00014180: 742d 7369 7a65 3a20 3132 7078 3b20 666f  t-size: 12px; fo
+00014190: 6e74 2d77 6569 6768 743a 2062 6f6c 643b  nt-weight: bold;
+000141a0: 223e 4e61 6d65 3a3c 2f73 7061 6e3e 266e  ">Name:</span>&n
+000141b0: 6273 703b 0a20 2020 2020 2020 2020 2020  bsp;.           
+000141c0: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
+000141d0: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
+000141e0: 2031 3070 783b 2066 6f6e 742d 6661 6d69   10px; font-fami
+000141f0: 6c79 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f  ly: Monaco, mono
+00014200: 7370 6163 653b 223e 406e 616d 653c 2f73  space;">@name</s
+00014210: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
+00014220: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
+00014230: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
+00014240: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+00014250: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
+00014260: 653d 2266 6f6e 742d 7369 7a65 3a20 3132  e="font-size: 12
+00014270: 7078 3b20 666f 6e74 2d77 6569 6768 743a  px; font-weight:
+00014280: 2062 6f6c 643b 223e 436f 6d70 7574 6520   bold;">Compute 
+00014290: 7469 6d65 3a3c 2f73 7061 6e3e 266e 6273  time:</span>&nbs
+000142a0: 703b 0a20 2020 2020 2020 2020 2020 2020  p;.             
+000142b0: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
+000142c0: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
+000142d0: 3070 783b 2066 6f6e 742d 6661 6d69 6c79  0px; font-family
+000142e0: 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f 7370  : Monaco, monosp
+000142f0: 6163 653b 223e 4063 6f6d 7075 7465 5f74  ace;">@compute_t
+00014300: 696d 653c 2f73 7061 6e3e 0a20 2020 2020  ime</span>.     
+00014310: 2020 2020 2020 2020 2020 203c 2f64 6976             </div
+00014320: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+00014330: 2020 3c64 6976 3e0a 2020 2020 2020 2020    <div>.        
+00014340: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
+00014350: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
+00014360: 7a65 3a20 3132 7078 3b20 666f 6e74 2d77  ze: 12px; font-w
+00014370: 6569 6768 743a 2062 6f6c 643b 223e 4d65  eight: bold;">Me
+00014380: 6d6f 7279 3a3c 2f73 7061 6e3e 266e 6273  mory:</span>&nbs
+00014390: 703b 0a20 2020 2020 2020 2020 2020 2020  p;.             
+000143a0: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
+000143b0: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
+000143c0: 3070 783b 2066 6f6e 742d 6661 6d69 6c79  0px; font-family
+000143d0: 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f 7370  : Monaco, monosp
+000143e0: 6163 653b 223e 406d 656d 6f72 793c 2f73  ace;">@memory</s
+000143f0: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
+00014400: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
+00014410: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
+00014420: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+00014430: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
+00014440: 653d 2266 6f6e 742d 7369 7a65 3a20 3132  e="font-size: 12
+00014450: 7078 3b20 666f 6e74 2d77 6569 6768 743a  px; font-weight:
+00014460: 2062 6f6c 643b 223e 5461 736b 733a 3c2f   bold;">Tasks:</
+00014470: 7370 616e 3e26 6e62 7370 3b0a 2020 2020  span>&nbsp;.    
+00014480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014490: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
+000144a0: 742d 7369 7a65 3a20 3130 7078 3b20 666f  t-size: 10px; fo
+000144b0: 6e74 2d66 616d 696c 793a 204d 6f6e 6163  nt-family: Monac
+000144c0: 6f2c 206d 6f6e 6f73 7061 6365 3b22 3e40  o, monospace;">@
+000144d0: 746f 745f 7461 736b 733c 2f73 7061 6e3e  tot_tasks</span>
+000144e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000144f0: 203c 2f64 6976 3e0a 2020 2020 2020 2020   </div>.        
+00014500: 2020 2020 2020 2020 3c64 6976 2073 7479          <div sty
+00014510: 6c65 3d22 6d61 7267 696e 2d6c 6566 743a  le="margin-left:
+00014520: 2032 656d 3b22 3e0a 2020 2020 2020 2020   2em;">.        
+00014530: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
+00014540: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
+00014550: 7a65 3a20 3132 7078 3b20 666f 6e74 2d77  ze: 12px; font-w
+00014560: 6569 6768 743a 2062 6f6c 643b 223e 436f  eight: bold;">Co
+00014570: 6d70 6c65 7465 643a 3c2f 7370 616e 3e26  mpleted:</span>&
+00014580: 6e62 7370 3b0a 2020 2020 2020 2020 2020  nbsp;.          
+00014590: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
+000145a0: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
+000145b0: 3a20 3130 7078 3b20 666f 6e74 2d66 616d  : 10px; font-fam
+000145c0: 696c 793a 204d 6f6e 6163 6f2c 206d 6f6e  ily: Monaco, mon
+000145d0: 6f73 7061 6365 3b22 3e40 636f 6d70 5f74  ospace;">@comp_t
+000145e0: 6173 6b73 3c2f 7370 616e 3e0a 2020 2020  asks</span>.    
+000145f0: 2020 2020 2020 2020 2020 2020 3c2f 6469              </di
+00014600: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
+00014610: 2020 203c 6469 7620 7374 796c 653d 226d     <div style="m
+00014620: 6172 6769 6e2d 6c65 6674 3a20 3265 6d3b  argin-left: 2em;
+00014630: 223e 0a20 2020 2020 2020 2020 2020 2020  ">.             
+00014640: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
+00014650: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
+00014660: 3270 783b 2066 6f6e 742d 7765 6967 6874  2px; font-weight
+00014670: 3a20 626f 6c64 3b22 3e50 726f 6365 7373  : bold;">Process
+00014680: 696e 673a 3c2f 7370 616e 3e26 6e62 7370  ing:</span>&nbsp
+00014690: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000146a0: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
+000146b0: 653d 2266 6f6e 742d 7369 7a65 3a20 3130  e="font-size: 10
+000146c0: 7078 3b20 666f 6e74 2d66 616d 696c 793a  px; font-family:
+000146d0: 204d 6f6e 6163 6f2c 206d 6f6e 6f73 7061   Monaco, monospa
+000146e0: 6365 3b22 3e40 696e 5f70 726f 6365 7373  ce;">@in_process
+000146f0: 696e 673c 2f73 7061 6e3e 0a20 2020 2020  ing</span>.     
+00014700: 2020 2020 2020 2020 2020 203c 2f64 6976             </div
+00014710: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+00014720: 2020 3c64 6976 2073 7479 6c65 3d22 6d61    <div style="ma
+00014730: 7267 696e 2d6c 6566 743a 2032 656d 3b22  rgin-left: 2em;"
+00014740: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+00014750: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
+00014760: 653d 2266 6f6e 742d 7369 7a65 3a20 3132  e="font-size: 12
+00014770: 7078 3b20 666f 6e74 2d77 6569 6768 743a  px; font-weight:
+00014780: 2062 6f6c 643b 223e 496e 206d 656d 6f72   bold;">In memor
+00014790: 793a 3c2f 7370 616e 3e26 6e62 7370 3b0a  y:</span>&nbsp;.
+000147a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000147b0: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
+000147c0: 2266 6f6e 742d 7369 7a65 3a20 3130 7078  "font-size: 10px
+000147d0: 3b20 666f 6e74 2d66 616d 696c 793a 204d  ; font-family: M
+000147e0: 6f6e 6163 6f2c 206d 6f6e 6f73 7061 6365  onaco, monospace
+000147f0: 3b22 3e40 696e 5f6d 656d 6f72 793c 2f73  ;">@in_memory</s
+00014800: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
+00014810: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
+00014820: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
+00014830: 2073 7479 6c65 3d22 6d61 7267 696e 2d6c   style="margin-l
+00014840: 6566 743a 2032 656d 3b22 3e0a 2020 2020  eft: 2em;">.    
+00014850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014860: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
+00014870: 742d 7369 7a65 3a20 3132 7078 3b20 666f  t-size: 12px; fo
+00014880: 6e74 2d77 6569 6768 743a 2062 6f6c 643b  nt-weight: bold;
+00014890: 223e 4572 7265 643a 3c2f 7370 616e 3e26  ">Erred:</span>&
+000148a0: 6e62 7370 3b0a 2020 2020 2020 2020 2020  nbsp;.          
+000148b0: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
+000148c0: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
+000148d0: 3a20 3130 7078 3b20 666f 6e74 2d66 616d  : 10px; font-fam
+000148e0: 696c 793a 204d 6f6e 6163 6f2c 206d 6f6e  ily: Monaco, mon
+000148f0: 6f73 7061 6365 3b22 3e40 696e 5f65 7272  ospace;">@in_err
+00014900: 6564 3c2f 7370 616e 3e0a 2020 2020 2020  ed</span>.      
+00014910: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
+00014920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014930: 203c 6469 7620 7374 796c 653d 226d 6172   <div style="mar
+00014940: 6769 6e2d 6c65 6674 3a20 3265 6d3b 223e  gin-left: 2em;">
+00014950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014960: 2020 2020 203c 7370 616e 2073 7479 6c65       <span style
+00014970: 3d22 666f 6e74 2d73 697a 653a 2031 3270  ="font-size: 12p
+00014980: 783b 2066 6f6e 742d 7765 6967 6874 3a20  x; font-weight: 
+00014990: 626f 6c64 3b22 3e52 656c 6561 7365 643a  bold;">Released:
+000149a0: 3c2f 7370 616e 3e26 6e62 7370 3b0a 2020  </span>&nbsp;.  
+000149b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000149c0: 2020 3c73 7061 6e20 7374 796c 653d 2266    <span style="f
+000149d0: 6f6e 742d 7369 7a65 3a20 3130 7078 3b20  ont-size: 10px; 
+000149e0: 666f 6e74 2d66 616d 696c 793a 204d 6f6e  font-family: Mon
+000149f0: 6163 6f2c 206d 6f6e 6f73 7061 6365 3b22  aco, monospace;"
+00014a00: 3e40 696e 5f72 656c 6561 7365 643c 2f73  >@in_released</s
+00014a10: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
+00014a20: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
+00014a30: 2020 2020 2020 2020 2020 2020 2222 222c              """,
+00014a40: 0a20 2020 2020 2020 2020 2020 2072 656e  .            ren
+00014a50: 6465 7265 7273 3d5b 7265 6374 5d2c 0a20  derers=[rect],. 
+00014a60: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00014a70: 2020 7365 6c66 2e72 6f6f 742e 6164 645f    self.root.add_
+00014a80: 746f 6f6c 7328 686f 7665 7229 0a0a 2020  tools(hover)..  
+00014a90: 2020 4077 6974 686f 7574 5f70 726f 7065    @without_prope
+00014aa0: 7274 795f 7661 6c69 6461 7469 6f6e 0a20  rty_validation. 
+00014ab0: 2020 2040 6c6f 675f 6572 726f 7273 0a20     @log_errors. 
+00014ac0: 2020 2064 6566 2075 7064 6174 655f 6c61     def update_la
+00014ad0: 796f 7574 2873 656c 6629 3a0a 2020 2020  yout(self):.    
+00014ae0: 2020 2020 2320 4765 7420 6465 7065 6e64      # Get depend
+00014af0: 656e 6369 6573 2070 6572 2074 6173 6b20  encies per task 
+00014b00: 6772 6f75 702e 0a20 2020 2020 2020 2023  group..        #
+00014b10: 2049 6e20 736f 6d65 2063 6173 6573 2074   In some cases t
+00014b20: 6865 7265 2061 7265 2074 6720 7468 6174  here are tg that
+00014b30: 2068 6176 6520 7468 656d 7365 6c76 6573   have themselves
+00014b40: 2061 7320 6465 7065 6e64 656e 6369 6573   as dependencies
+00014b50: 202d 2077 6520 7265 6d6f 7665 2074 686f   - we remove tho
+00014b60: 7365 2e0a 2020 2020 2020 2020 6465 7065  se..        depe
+00014b70: 6e64 656e 6369 6573 203d 207b 0a20 2020  ndencies = {.   
+00014b80: 2020 2020 2020 2020 206b 3a20 7b64 732e           k: {ds.
+00014b90: 6e61 6d65 2066 6f72 2064 7320 696e 2074  name for ds in t
+00014ba0: 732e 6465 7065 6e64 656e 6369 6573 2069  s.dependencies i
+00014bb0: 6620 6473 2e6e 616d 6520 213d 206b 7d0a  f ds.name != k}.
+00014bc0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00014bd0: 6b2c 2074 7320 696e 2073 656c 662e 7363  k, ts in self.sc
+00014be0: 6865 6475 6c65 722e 7461 736b 5f67 726f  heduler.task_gro
+00014bf0: 7570 732e 6974 656d 7328 290a 2020 2020  ups.items().    
+00014c00: 2020 2020 7d0a 0a20 2020 2020 2020 2069      }..        i
+00014c10: 6d70 6f72 7420 6461 736b 0a0a 2020 2020  mport dask..    
+00014c20: 2020 2020 6f72 6465 7220 3d20 6461 736b      order = dask
+00014c30: 2e6f 7264 6572 2e6f 7264 6572 280a 2020  .order.order(.  
+00014c40: 2020 2020 2020 2020 2020 6473 6b3d 7b67            dsk={g
+00014c50: 726f 7570 2e6e 616d 653a 2031 2066 6f72  roup.name: 1 for
+00014c60: 206b 2c20 6772 6f75 7020 696e 2073 656c   k, group in sel
+00014c70: 662e 7363 6865 6475 6c65 722e 7461 736b  f.scheduler.task
+00014c80: 5f67 726f 7570 732e 6974 656d 7328 297d  _groups.items()}
+00014c90: 2c0a 2020 2020 2020 2020 2020 2020 6465  ,.            de
+00014ca0: 7065 6e64 656e 6369 6573 3d64 6570 656e  pendencies=depen
+00014cb0: 6465 6e63 6965 732c 0a20 2020 2020 2020  dencies,.       
+00014cc0: 2029 0a0a 2020 2020 2020 2020 6f72 6465   )..        orde
+00014cd0: 7265 6420 3d20 736f 7274 6564 2873 656c  red = sorted(sel
+00014ce0: 662e 7363 6865 6475 6c65 722e 7461 736b  f.scheduler.task
+00014cf0: 5f67 726f 7570 732c 206b 6579 3d6f 7264  _groups, key=ord
+00014d00: 6572 2e67 6574 290a 0a20 2020 2020 2020  er.get)..       
+00014d10: 2078 7320 3d20 7b7d 0a20 2020 2020 2020   xs = {}.       
+00014d20: 2079 7320 3d20 7b7d 0a20 2020 2020 2020   ys = {}.       
+00014d30: 206c 6f63 6174 696f 6e73 203d 2073 6574   locations = set
+00014d40: 2829 0a20 2020 2020 2020 206e 6f64 6573  ().        nodes
+00014d50: 5f6c 6179 6f75 7420 3d20 7b7d 0a20 2020  _layout = {}.   
+00014d60: 2020 2020 2061 7272 6f77 735f 6c61 796f       arrows_layo
+00014d70: 7574 203d 207b 7d0a 2020 2020 2020 2020  ut = {}.        
+00014d80: 666f 7220 7467 2069 6e20 6f72 6465 7265  for tg in ordere
+00014d90: 643a 0a20 2020 2020 2020 2020 2020 2069  d:.            i
+00014da0: 6620 6465 7065 6e64 656e 6369 6573 5b74  f dependencies[t
+00014db0: 675d 3a0a 2020 2020 2020 2020 2020 2020  g]:.            
+00014dc0: 2020 2020 7820 3d20 6d61 7828 7873 5b64      x = max(xs[d
+00014dd0: 6570 5d20 666f 7220 6465 7020 696e 2064  ep] for dep in d
+00014de0: 6570 656e 6465 6e63 6965 735b 7467 5d29  ependencies[tg])
+00014df0: 202b 2031 0a20 2020 2020 2020 2020 2020   + 1.           
+00014e00: 2020 2020 2079 203d 206d 6178 2879 735b       y = max(ys[
+00014e10: 6465 705d 2066 6f72 2064 6570 2069 6e20  dep] for dep in 
+00014e20: 6465 7065 6e64 656e 6369 6573 5b74 675d  dependencies[tg]
+00014e30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00014e40: 2020 6966 2028 0a20 2020 2020 2020 2020    if (.         
+00014e50: 2020 2020 2020 2020 2020 206c 656e 2864             len(d
+00014e60: 6570 656e 6465 6e63 6965 735b 7467 5d29  ependencies[tg])
+00014e70: 203e 2031 0a20 2020 2020 2020 2020 2020   > 1.           
+00014e80: 2020 2020 2020 2020 2061 6e64 206c 656e           and len
+00014e90: 287b 7973 5b64 6570 5d20 666f 7220 6465  ({ys[dep] for de
+00014ea0: 7020 696e 2064 6570 656e 6465 6e63 6965  p in dependencie
+00014eb0: 735b 7467 5d7d 2920 3d3d 2031 0a20 2020  s[tg]}) == 1.   
+00014ec0: 2020 2020 2020 2020 2020 2020 2029 3a0a               ):.
+00014ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014ee0: 2020 2020 7920 2b3d 2031 0a20 2020 2020      y += 1.     
+00014ef0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00014f00: 2020 2020 2020 2020 2020 2020 2078 203d               x =
+00014f10: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
+00014f20: 2020 2079 203d 206d 6178 2879 732e 7661     y = max(ys.va
+00014f30: 6c75 6573 2829 2920 2b20 3120 6966 2079  lues()) + 1 if y
+00014f40: 7320 656c 7365 2030 0a0a 2020 2020 2020  s else 0..      
+00014f50: 2020 2020 2020 7768 696c 6520 2878 2c20        while (x, 
+00014f60: 7929 2069 6e20 6c6f 6361 7469 6f6e 733a  y) in locations:
+00014f70: 2020 2320 6176 6f69 6420 636f 6c6c 6973    # avoid collis
+00014f80: 696f 6e73 2062 7920 6d6f 7669 6e67 2075  ions by moving u
+00014f90: 700a 2020 2020 2020 2020 2020 2020 2020  p.              
+00014fa0: 2020 7920 2b3d 2031 0a0a 2020 2020 2020    y += 1..      
+00014fb0: 2020 2020 2020 6c6f 6361 7469 6f6e 732e        locations.
+00014fc0: 6164 6428 2878 2c20 7929 290a 0a20 2020  add((x, y))..   
+00014fd0: 2020 2020 2020 2020 2078 735b 7467 5d2c           xs[tg],
+00014fe0: 2079 735b 7467 5d20 3d20 782c 2079 0a0a   ys[tg] = x, y..
+00014ff0: 2020 2020 2020 2020 2020 2020 2320 696e              # in
+00015000: 666f 206e 6565 6465 6420 666f 7220 6e6f  fo needed for no
+00015010: 6465 206c 6179 6f75 7420 746f 2063 6f6c  de layout to col
+00015020: 756d 6e20 6461 7461 2073 6f75 7263 650a  umn data source.
+00015030: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+00015040: 735f 6c61 796f 7574 5b74 675d 203d 207b  s_layout[tg] = {
+00015050: 2278 223a 2078 735b 7467 5d2c 2022 7922  "x": xs[tg], "y"
+00015060: 3a20 7973 5b74 675d 7d0a 0a20 2020 2020  : ys[tg]}..     
+00015070: 2020 2020 2020 2023 2069 6e66 6f20 6e65         # info ne
+00015080: 6564 6564 2066 6f72 2061 7272 6f77 206c  eded for arrow l
+00015090: 6179 6f75 740a 2020 2020 2020 2020 2020  ayout.          
+000150a0: 2020 6172 726f 7773 5f6c 6179 6f75 745b    arrows_layout[
+000150b0: 7467 5d20 3d20 7b0a 2020 2020 2020 2020  tg] = {.        
+000150c0: 2020 2020 2020 2020 226e 7374 6172 7422          "nstart"
+000150d0: 3a20 6465 7065 6e64 656e 6369 6573 5b74  : dependencies[t
+000150e0: 675d 2c0a 2020 2020 2020 2020 2020 2020  g],.            
+000150f0: 2020 2020 226e 656e 6422 3a20 5b74 675d      "nend": [tg]
+00015100: 202a 206c 656e 2864 6570 656e 6465 6e63   * len(dependenc
+00015110: 6965 735b 7467 5d29 2c0a 2020 2020 2020  ies[tg]),.      
+00015120: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00015130: 2072 6574 7572 6e20 6e6f 6465 735f 6c61   return nodes_la
+00015140: 796f 7574 2c20 6172 726f 7773 5f6c 6179  yout, arrows_lay
+00015150: 6f75 740a 0a20 2020 2064 6566 2063 6f6d  out..    def com
+00015160: 7075 7465 5f73 697a 6528 7365 6c66 2c20  pute_size(self, 
+00015170: 782c 206d 696e 5f62 6f78 2c20 6d61 785f  x, min_box, max_
+00015180: 626f 7829 3a0a 2020 2020 2020 2020 7374  box):.        st
+00015190: 6172 7420 3d20 302e 340a 2020 2020 2020  art = 0.4.      
+000151a0: 2020 656e 6420 3d20 302e 380a 0a20 2020    end = 0.8..   
+000151b0: 2020 2020 2079 203d 2028 656e 6420 2d20       y = (end - 
+000151c0: 7374 6172 7429 202f 2028 6d61 785f 626f  start) / (max_bo
+000151d0: 7820 2d20 6d69 6e5f 626f 7829 202a 2028  x - min_box) * (
+000151e0: 7820 2d20 6d69 6e5f 626f 7829 202b 2073  x - min_box) + s
+000151f0: 7461 7274 0a0a 2020 2020 2020 2020 7265  tart..        re
+00015200: 7475 726e 2079 0a0a 2020 2020 4077 6974  turn y..    @wit
+00015210: 686f 7574 5f70 726f 7065 7274 795f 7661  hout_property_va
+00015220: 6c69 6461 7469 6f6e 0a20 2020 2064 6566  lidation.    def
+00015230: 2075 7064 6174 6528 7365 6c66 293a 0a20   update(self):. 
+00015240: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
+00015250: 6368 6564 756c 6572 2e74 7261 6e73 6974  cheduler.transit
+00015260: 696f 6e5f 636f 756e 7465 7220 3d3d 2073  ion_counter == s
+00015270: 656c 662e 6f6c 645f 636f 756e 7465 723a  elf.old_counter:
+00015280: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00015290: 7572 6e0a 2020 2020 2020 2020 7365 6c66  urn.        self
+000152a0: 2e6f 6c64 5f63 6f75 6e74 6572 203d 2073  .old_counter = s
+000152b0: 656c 662e 7363 6865 6475 6c65 722e 7472  elf.scheduler.tr
+000152c0: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
+000152d0: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+000152e0: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
+000152f0: 7461 736b 5f67 726f 7570 733a 0a20 2020  task_groups:.   
+00015300: 2020 2020 2020 2020 2073 656c 662e 7375           self.su
+00015310: 6274 6974 6c65 2e74 6578 7420 3d20 2253  btitle.text = "S
+00015320: 6368 6564 756c 6572 2069 7320 656d 7074  cheduler is empt
+00015330: 792e 220a 2020 2020 2020 2020 656c 7365  y.".        else
+00015340: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00015350: 6c66 2e73 7562 7469 746c 652e 7465 7874  lf.subtitle.text
+00015360: 203d 2022 2022 0a0a 2020 2020 2020 2020   = " "..        
+00015370: 6966 2073 656c 662e 6e6f 6465 735f 6c61  if self.nodes_la
+00015380: 796f 7574 2e6b 6579 7328 2920 213d 2073  yout.keys() != s
+00015390: 656c 662e 7363 6865 6475 6c65 722e 7461  elf.scheduler.ta
+000153a0: 736b 5f67 726f 7570 732e 6b65 7973 2829  sk_groups.keys()
+000153b0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+000153c0: 6c66 2e6e 6f64 6573 5f6c 6179 6f75 742c  lf.nodes_layout,
+000153d0: 2073 656c 662e 6172 726f 7773 5f6c 6179   self.arrows_lay
+000153e0: 6f75 7420 3d20 7365 6c66 2e75 7064 6174  out = self.updat
+000153f0: 655f 6c61 796f 7574 2829 0a0a 2020 2020  e_layout()..    
+00015400: 2020 2020 6e6f 6465 735f 6461 7461 203d      nodes_data =
+00015410: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
+00015420: 7822 3a20 5b5d 2c0a 2020 2020 2020 2020  x": [],.        
+00015430: 2020 2020 2279 223a 205b 5d2c 0a20 2020      "y": [],.   
+00015440: 2020 2020 2020 2020 2022 775f 626f 7822           "w_box"
+00015450: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+00015460: 2020 2268 5f62 6f78 223a 205b 5d2c 0a20    "h_box": [],. 
+00015470: 2020 2020 2020 2020 2020 2022 6e61 6d65             "name
+00015480: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00015490: 2020 2022 636f 6c6f 7222 3a20 5b5d 2c0a     "color": [],.
+000154a0: 2020 2020 2020 2020 2020 2020 2274 6f74              "tot
+000154b0: 5f74 6173 6b73 223a 205b 5d2c 0a20 2020  _tasks": [],.   
+000154c0: 2020 2020 2020 2020 2022 785f 7374 6172           "x_star
+000154d0: 7422 3a20 5b5d 2c0a 2020 2020 2020 2020  t": [],.        
+000154e0: 2020 2020 2278 5f65 6e64 223a 205b 5d2c      "x_end": [],
+000154f0: 0a20 2020 2020 2020 2020 2020 2022 795f  .            "y_
+00015500: 7374 6172 7422 3a20 5b5d 2c0a 2020 2020  start": [],.    
+00015510: 2020 2020 2020 2020 2279 5f65 6e64 223a          "y_end":
+00015520: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+00015530: 2022 785f 656e 645f 7072 6f67 7265 7373   "x_end_progress
+00015540: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00015550: 2020 2022 6d65 6d5f 616c 7068 6122 3a20     "mem_alpha": 
+00015560: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+00015570: 226e 6f64 655f 6c69 6e65 5f77 6964 7468  "node_line_width
+00015580: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00015590: 2020 2022 636f 6d70 5f74 6173 6b73 223a     "comp_tasks":
+000155a0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+000155b0: 2022 7572 6c5f 6c6f 676f 223a 205b 5d2c   "url_logo": [],
+000155c0: 0a20 2020 2020 2020 2020 2020 2022 785f  .            "x_
+000155d0: 6c6f 676f 223a 205b 5d2c 0a20 2020 2020  logo": [],.     
+000155e0: 2020 2020 2020 2022 795f 6c6f 676f 223a         "y_logo":
+000155f0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+00015600: 2022 775f 6c6f 676f 223a 205b 5d2c 0a20   "w_logo": [],. 
+00015610: 2020 2020 2020 2020 2020 2022 685f 6c6f             "h_lo
+00015620: 676f 223a 205b 5d2c 0a20 2020 2020 2020  go": [],.       
+00015630: 2020 2020 2022 696e 5f70 726f 6365 7373       "in_process
+00015640: 696e 6722 3a20 5b5d 2c0a 2020 2020 2020  ing": [],.      
+00015650: 2020 2020 2020 2269 6e5f 6d65 6d6f 7279        "in_memory
+00015660: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00015670: 2020 2022 696e 5f72 656c 6561 7365 6422     "in_released"
+00015680: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+00015690: 2020 2269 6e5f 6572 7265 6422 3a20 5b5d    "in_erred": []
+000156a0: 2c0a 2020 2020 2020 2020 2020 2020 2263  ,.            "c
+000156b0: 6f6d 7075 7465 5f74 696d 6522 3a20 5b5d  ompute_time": []
+000156c0: 2c0a 2020 2020 2020 2020 2020 2020 226d  ,.            "m
+000156d0: 656d 6f72 7922 3a20 5b5d 2c0a 2020 2020  emory": [],.    
+000156e0: 2020 2020 7d0a 0a20 2020 2020 2020 2061      }..        a
+000156f0: 7272 6f77 735f 6461 7461 203d 207b 0a20  rrows_data = {. 
+00015700: 2020 2020 2020 2020 2020 2022 7873 223a             "xs":
+00015710: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+00015720: 2022 7973 223a 205b 5d2c 0a20 2020 2020   "ys": [],.     
+00015730: 2020 2020 2020 2022 7865 223a 205b 5d2c         "xe": [],
+00015740: 0a20 2020 2020 2020 2020 2020 2022 7965  .            "ye
+00015750: 223a 205b 5d2c 0a20 2020 2020 2020 207d  ": [],.        }
+00015760: 0a0a 2020 2020 2020 2020 6475 7261 7469  ..        durati
+00015770: 6f6e 7320 3d20 7365 7428 290a 2020 2020  ons = set().    
+00015780: 2020 2020 6e62 7974 6573 203d 2073 6574      nbytes = set
+00015790: 2829 0a20 2020 2020 2020 2066 6f72 2074  ().        for t
+000157a0: 6720 696e 2073 656c 662e 7363 6865 6475  g in self.schedu
+000157b0: 6c65 722e 7461 736b 5f67 726f 7570 732e  ler.task_groups.
+000157c0: 7661 6c75 6573 2829 3a0a 2020 2020 2020  values():.      
+000157d0: 2020 2020 2020 6966 2074 672e 6475 7261        if tg.dura
+000157e0: 7469 6f6e 2061 6e64 2074 672e 6e62 7974  tion and tg.nbyt
+000157f0: 6573 5f74 6f74 616c 3a0a 2020 2020 2020  es_total:.      
+00015800: 2020 2020 2020 2020 2020 6475 7261 7469            durati
+00015810: 6f6e 732e 6164 6428 7467 2e64 7572 6174  ons.add(tg.durat
+00015820: 696f 6e29 0a20 2020 2020 2020 2020 2020  ion).           
+00015830: 2020 2020 206e 6279 7465 732e 6164 6428       nbytes.add(
+00015840: 7467 2e6e 6279 7465 735f 746f 7461 6c29  tg.nbytes_total)
+00015850: 0a0a 2020 2020 2020 2020 6475 7261 7469  ..        durati
+00015860: 6f6e 735f 6d69 6e20 3d20 6d69 6e28 6475  ons_min = min(du
+00015870: 7261 7469 6f6e 732c 2064 6566 6175 6c74  rations, default
+00015880: 3d30 290a 2020 2020 2020 2020 6475 7261  =0).        dura
+00015890: 7469 6f6e 735f 6d61 7820 3d20 6d61 7828  tions_max = max(
+000158a0: 6475 7261 7469 6f6e 732c 2064 6566 6175  durations, defau
+000158b0: 6c74 3d30 290a 2020 2020 2020 2020 6e62  lt=0).        nb
+000158c0: 7974 6573 5f6d 696e 203d 206d 696e 286e  ytes_min = min(n
+000158d0: 6279 7465 732c 2064 6566 6175 6c74 3d30  bytes, default=0
+000158e0: 290a 2020 2020 2020 2020 6e62 7974 6573  ).        nbytes
+000158f0: 5f6d 6178 203d 206d 6178 286e 6279 7465  _max = max(nbyte
+00015900: 732c 2064 6566 6175 6c74 3d30 290a 0a20  s, default=0).. 
+00015910: 2020 2020 2020 2062 6f78 5f64 696d 203d         box_dim =
+00015920: 207b 7d0a 2020 2020 2020 2020 666f 7220   {}.        for 
+00015930: 6b65 792c 2074 6720 696e 2073 656c 662e  key, tg in self.
+00015940: 7363 6865 6475 6c65 722e 7461 736b 5f67  scheduler.task_g
+00015950: 726f 7570 732e 6974 656d 7328 293a 0a20  roups.items():. 
+00015960: 2020 2020 2020 2020 2020 2063 6f6d 705f             comp_
+00015970: 7461 736b 7320 3d20 280a 2020 2020 2020  tasks = (.      
+00015980: 2020 2020 2020 2020 2020 7467 2e73 7461            tg.sta
+00015990: 7465 735b 2272 656c 6561 7365 6422 5d20  tes["released"] 
+000159a0: 2b20 7467 2e73 7461 7465 735b 226d 656d  + tg.states["mem
+000159b0: 6f72 7922 5d20 2b20 7467 2e73 7461 7465  ory"] + tg.state
+000159c0: 735b 2265 7272 6564 225d 0a20 2020 2020  s["erred"].     
+000159d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000159e0: 2020 2020 2074 6f74 5f74 6173 6b73 203d       tot_tasks =
+000159f0: 2073 756d 2874 672e 7374 6174 6573 2e76   sum(tg.states.v
+00015a00: 616c 7565 7328 2929 0a0a 2020 2020 2020  alues())..      
+00015a10: 2020 2020 2020 2320 636f 6d70 7574 6520        # compute 
+00015a20: 7769 6474 6820 616e 6420 6865 6967 6874  width and height
+00015a30: 206f 6620 626f 7865 730a 2020 2020 2020   of boxes.      
+00015a40: 2020 2020 2020 6966 2028 0a20 2020 2020        if (.     
+00015a50: 2020 2020 2020 2020 2020 2074 672e 6475             tg.du
+00015a60: 7261 7469 6f6e 0a20 2020 2020 2020 2020  ration.         
+00015a70: 2020 2020 2020 2061 6e64 2074 672e 6e62         and tg.nb
+00015a80: 7974 6573 5f74 6f74 616c 0a20 2020 2020  ytes_total.     
+00015a90: 2020 2020 2020 2020 2020 2061 6e64 2063             and c
+00015aa0: 6f6d 705f 7461 736b 730a 2020 2020 2020  omp_tasks.      
+00015ab0: 2020 2020 2020 2020 2020 616e 6420 6c65            and le
+00015ac0: 6e28 6475 7261 7469 6f6e 7329 203e 2031  n(durations) > 1
+00015ad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015ae0: 2061 6e64 206c 656e 286e 6279 7465 7329   and len(nbytes)
+00015af0: 203e 2031 0a20 2020 2020 2020 2020 2020   > 1.           
+00015b00: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+00015b10: 2020 2020 2320 7363 616c 6520 6475 7261      # scale dura
+00015b20: 7469 6f6e 2028 7769 6474 6829 0a20 2020  tion (width).   
+00015b30: 2020 2020 2020 2020 2020 2020 2077 6964               wid
+00015b40: 7468 5f62 6f78 203d 2073 656c 662e 636f  th_box = self.co
+00015b50: 6d70 7574 655f 7369 7a65 280a 2020 2020  mpute_size(.    
+00015b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015b70: 7467 2e64 7572 6174 696f 6e20 2f20 636f  tg.duration / co
+00015b80: 6d70 5f74 6173 6b73 202a 2074 6f74 5f74  mp_tasks * tot_t
+00015b90: 6173 6b73 2c0a 2020 2020 2020 2020 2020  asks,.          
+00015ba0: 2020 2020 2020 2020 2020 6d69 6e5f 626f            min_bo
+00015bb0: 783d 6475 7261 7469 6f6e 735f 6d69 6e20  x=durations_min 
+00015bc0: 2f20 636f 6d70 5f74 6173 6b73 202a 2074  / comp_tasks * t
+00015bd0: 6f74 5f74 6173 6b73 2c0a 2020 2020 2020  ot_tasks,.      
+00015be0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+00015bf0: 785f 626f 783d 6475 7261 7469 6f6e 735f  x_box=durations_
+00015c00: 6d61 7820 2f20 636f 6d70 5f74 6173 6b73  max / comp_tasks
+00015c10: 202a 2074 6f74 5f74 6173 6b73 2c0a 2020   * tot_tasks,.  
+00015c20: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00015c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015c40: 2023 206e 6565 6420 746f 2073 6361 6c65   # need to scale
+00015c50: 206d 656d 6f72 7920 2868 6569 6768 7429   memory (height)
+00015c60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015c70: 2068 6569 6768 745f 626f 7820 3d20 7365   height_box = se
+00015c80: 6c66 2e63 6f6d 7075 7465 5f73 697a 6528  lf.compute_size(
+00015c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015ca0: 2020 2020 2074 672e 6e62 7974 6573 5f74       tg.nbytes_t
+00015cb0: 6f74 616c 202f 2063 6f6d 705f 7461 736b  otal / comp_task
+00015cc0: 7320 2a20 746f 745f 7461 736b 732c 0a20  s * tot_tasks,. 
+00015cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015ce0: 2020 206d 696e 5f62 6f78 3d6e 6279 7465     min_box=nbyte
+00015cf0: 735f 6d69 6e20 2f20 636f 6d70 5f74 6173  s_min / comp_tas
+00015d00: 6b73 202a 2074 6f74 5f74 6173 6b73 2c0a  ks * tot_tasks,.
+00015d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d20: 2020 2020 6d61 785f 626f 783d 6e62 7974      max_box=nbyt
+00015d30: 6573 5f6d 6178 202f 2063 6f6d 705f 7461  es_max / comp_ta
+00015d40: 736b 7320 2a20 746f 745f 7461 736b 732c  sks * tot_tasks,
+00015d50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015d60: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+00015d70: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00015d80: 2020 2020 2020 7769 6474 685f 626f 7820        width_box 
+00015d90: 3d20 302e 360a 2020 2020 2020 2020 2020  = 0.6.          
+00015da0: 2020 2020 2020 6865 6967 6874 5f62 6f78        height_box
+00015db0: 203d 2077 6964 7468 5f62 6f78 202f 2032   = width_box / 2
+00015dc0: 0a0a 2020 2020 2020 2020 2020 2020 626f  ..            bo
+00015dd0: 785f 6469 6d5b 6b65 795d 203d 207b 2277  x_dim[key] = {"w
+00015de0: 6964 7468 223a 2077 6964 7468 5f62 6f78  idth": width_box
+00015df0: 2c20 2268 6569 6768 7422 3a20 6865 6967  , "height": heig
+00015e00: 6874 5f62 6f78 7d0a 0a20 2020 2020 2020  ht_box}..       
+00015e10: 2066 6f72 206b 6579 2c20 7467 2069 6e20   for key, tg in 
+00015e20: 7365 6c66 2e73 6368 6564 756c 6572 2e74  self.scheduler.t
+00015e30: 6173 6b5f 6772 6f75 7073 2e69 7465 6d73  ask_groups.items
+00015e40: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00015e50: 7820 3d20 7365 6c66 2e6e 6f64 6573 5f6c  x = self.nodes_l
+00015e60: 6179 6f75 745b 6b65 795d 5b22 7822 5d0a  ayout[key]["x"].
+00015e70: 2020 2020 2020 2020 2020 2020 7920 3d20              y = 
+00015e80: 7365 6c66 2e6e 6f64 6573 5f6c 6179 6f75  self.nodes_layou
+00015e90: 745b 6b65 795d 5b22 7922 5d0a 2020 2020  t[key]["y"].    
+00015ea0: 2020 2020 2020 2020 7769 6474 6820 3d20          width = 
+00015eb0: 626f 785f 6469 6d5b 6b65 795d 5b22 7769  box_dim[key]["wi
+00015ec0: 6474 6822 5d0a 2020 2020 2020 2020 2020  dth"].          
+00015ed0: 2020 6865 6967 6874 203d 2062 6f78 5f64    height = box_d
+00015ee0: 696d 5b6b 6579 5d5b 2268 6569 6768 7422  im[key]["height"
+00015ef0: 5d0a 0a20 2020 2020 2020 2020 2020 2023  ]..            #
+00015f00: 206d 6169 6e20 626f 7865 7320 6c61 796f   main boxes layo
+00015f10: 7574 0a20 2020 2020 2020 2020 2020 206e  ut.            n
+00015f20: 6f64 6573 5f64 6174 615b 2278 225d 2e61  odes_data["x"].a
+00015f30: 7070 656e 6428 7829 0a20 2020 2020 2020  ppend(x).       
+00015f40: 2020 2020 206e 6f64 6573 5f64 6174 615b       nodes_data[
+00015f50: 2279 225d 2e61 7070 656e 6428 7929 0a20  "y"].append(y). 
+00015f60: 2020 2020 2020 2020 2020 206e 6f64 6573             nodes
+00015f70: 5f64 6174 615b 2277 5f62 6f78 225d 2e61  _data["w_box"].a
+00015f80: 7070 656e 6428 7769 6474 6829 0a20 2020  ppend(width).   
+00015f90: 2020 2020 2020 2020 206e 6f64 6573 5f64           nodes_d
+00015fa0: 6174 615b 2268 5f62 6f78 225d 2e61 7070  ata["h_box"].app
+00015fb0: 656e 6428 6865 6967 6874 290a 0a20 2020  end(height)..   
+00015fc0: 2020 2020 2020 2020 2063 6f6d 705f 7461           comp_ta
+00015fd0: 736b 7320 3d20 280a 2020 2020 2020 2020  sks = (.        
+00015fe0: 2020 2020 2020 2020 7467 2e73 7461 7465          tg.state
+00015ff0: 735b 2272 656c 6561 7365 6422 5d20 2b20  s["released"] + 
+00016000: 7467 2e73 7461 7465 735b 226d 656d 6f72  tg.states["memor
+00016010: 7922 5d20 2b20 7467 2e73 7461 7465 735b  y"] + tg.states[
+00016020: 2265 7272 6564 225d 0a20 2020 2020 2020  "erred"].       
+00016030: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00016040: 2020 2074 6f74 5f74 6173 6b73 203d 2073     tot_tasks = s
+00016050: 756d 2874 672e 7374 6174 6573 2e76 616c  um(tg.states.val
+00016060: 7565 7328 2929 0a0a 2020 2020 2020 2020  ues())..        
+00016070: 2020 2020 6e6f 6465 735f 6461 7461 5b22      nodes_data["
+00016080: 6e61 6d65 225d 2e61 7070 656e 6428 7467  name"].append(tg
+00016090: 2e70 7265 6669 782e 6e61 6d65 290a 0a20  .prefix.name).. 
+000160a0: 2020 2020 2020 2020 2020 206e 6f64 6573             nodes
+000160b0: 5f64 6174 615b 2263 6f6c 6f72 225d 2e61  _data["color"].a
+000160c0: 7070 656e 6428 636f 6c6f 725f 6f66 2874  ppend(color_of(t
+000160d0: 672e 7072 6566 6978 2e6e 616d 6529 290a  g.prefix.name)).
+000160e0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+000160f0: 735f 6461 7461 5b22 746f 745f 7461 736b  s_data["tot_task
+00016100: 7322 5d2e 6170 7065 6e64 2874 6f74 5f74  s"].append(tot_t
+00016110: 6173 6b73 290a 0a20 2020 2020 2020 2020  asks)..         
+00016120: 2020 2023 206d 656d 6f72 7920 616c 7068     # memory alph
+00016130: 6120 6661 6374 6f72 2062 7920 302e 3420  a factor by 0.4 
+00016140: 6966 206e 6f74 2067 6574 2773 2074 6f6f  if not get's too
+00016150: 2064 6172 6b0a 2020 2020 2020 2020 2020   dark.          
+00016160: 2020 6e6f 6465 735f 6461 7461 5b22 6d65    nodes_data["me
+00016170: 6d5f 616c 7068 6122 5d2e 6170 7065 6e64  m_alpha"].append
+00016180: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00016190: 2020 2874 672e 7374 6174 6573 5b22 6d65    (tg.states["me
+000161a0: 6d6f 7279 225d 202f 2073 756d 2874 672e  mory"] / sum(tg.
+000161b0: 7374 6174 6573 2e76 616c 7565 7328 2929  states.values())
+000161c0: 2920 2a20 302e 340a 2020 2020 2020 2020  ) * 0.4.        
+000161d0: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+000161e0: 2020 2023 206d 6169 6e20 626f 7820 6c69     # main box li
+000161f0: 6e65 2077 6964 7468 0a20 2020 2020 2020  ne width.       
+00016200: 2020 2020 2069 6620 7467 2e73 7461 7465       if tg.state
+00016210: 735b 2270 726f 6365 7373 696e 6722 5d3a  s["processing"]:
+00016220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016230: 206e 6f64 6573 5f64 6174 615b 226e 6f64   nodes_data["nod
+00016240: 655f 6c69 6e65 5f77 6964 7468 225d 2e61  e_line_width"].a
+00016250: 7070 656e 6428 3529 0a20 2020 2020 2020  ppend(5).       
+00016260: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00016270: 2020 2020 2020 2020 2020 206e 6f64 6573             nodes
+00016280: 5f64 6174 615b 226e 6f64 655f 6c69 6e65  _data["node_line
+00016290: 5f77 6964 7468 225d 2e61 7070 656e 6428  _width"].append(
+000162a0: 3129 0a0a 2020 2020 2020 2020 2020 2020  1)..            
+000162b0: 2320 7072 6f67 7265 7373 2062 6172 2064  # progress bar d
+000162c0: 6174 6120 7570 6461 7465 0a20 2020 2020  ata update.     
+000162d0: 2020 2020 2020 206e 6f64 6573 5f64 6174         nodes_dat
+000162e0: 615b 2278 5f73 7461 7274 225d 2e61 7070  a["x_start"].app
+000162f0: 656e 6428 7820 2d20 7769 6474 6820 2f20  end(x - width / 
+00016300: 3229 0a20 2020 2020 2020 2020 2020 206e  2).            n
+00016310: 6f64 6573 5f64 6174 615b 2278 5f65 6e64  odes_data["x_end
+00016320: 225d 2e61 7070 656e 6428 7820 2b20 7769  "].append(x + wi
+00016330: 6474 6820 2f20 3229 0a0a 2020 2020 2020  dth / 2)..      
+00016340: 2020 2020 2020 6e6f 6465 735f 6461 7461        nodes_data
+00016350: 5b22 795f 7374 6172 7422 5d2e 6170 7065  ["y_start"].appe
+00016360: 6e64 2879 202d 2068 6569 6768 7420 2f20  nd(y - height / 
+00016370: 3229 0a20 2020 2020 2020 2020 2020 206e  2).            n
+00016380: 6f64 6573 5f64 6174 615b 2279 5f65 6e64  odes_data["y_end
+00016390: 225d 2e61 7070 656e 6428 7920 2d20 6865  "].append(y - he
+000163a0: 6967 6874 202f 2032 202b 2068 6569 6768  ight / 2 + heigh
+000163b0: 7420 2a20 302e 3429 0a0a 2020 2020 2020  t * 0.4)..      
+000163c0: 2020 2020 2020 6e6f 6465 735f 6461 7461        nodes_data
+000163d0: 5b22 785f 656e 645f 7072 6f67 7265 7373  ["x_end_progress
+000163e0: 225d 2e61 7070 656e 6428 0a20 2020 2020  "].append(.     
+000163f0: 2020 2020 2020 2020 2020 2078 202d 2077             x - w
+00016400: 6964 7468 202f 2032 202b 2077 6964 7468  idth / 2 + width
+00016410: 202a 2063 6f6d 705f 7461 736b 7320 2f20   * comp_tasks / 
+00016420: 746f 745f 7461 736b 730a 2020 2020 2020  tot_tasks.      
+00016430: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00016440: 2020 2020 2023 2061 7272 6f77 730a 2020       # arrows.  
+00016450: 2020 2020 2020 2020 2020 6172 726f 7773            arrows
+00016460: 5f64 6174 615b 2278 7322 5d20 2b3d 205b  _data["xs"] += [
+00016470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016480: 2073 656c 662e 6e6f 6465 735f 6c61 796f   self.nodes_layo
+00016490: 7574 5b6b 5d5b 2278 225d 202b 2062 6f78  ut[k]["x"] + box
+000164a0: 5f64 696d 5b6b 5d5b 2277 6964 7468 225d  _dim[k]["width"]
+000164b0: 202f 2032 0a20 2020 2020 2020 2020 2020   / 2.           
+000164c0: 2020 2020 2066 6f72 206b 2069 6e20 7365       for k in se
+000164d0: 6c66 2e61 7272 6f77 735f 6c61 796f 7574  lf.arrows_layout
+000164e0: 5b6b 6579 5d5b 226e 7374 6172 7422 5d0a  [key]["nstart"].
+000164f0: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
+00016500: 2020 2020 2020 2020 2020 6172 726f 7773            arrows
+00016510: 5f64 6174 615b 2279 7322 5d20 2b3d 205b  _data["ys"] += [
+00016520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016530: 2073 656c 662e 6e6f 6465 735f 6c61 796f   self.nodes_layo
+00016540: 7574 5b6b 5d5b 2279 225d 2066 6f72 206b  ut[k]["y"] for k
+00016550: 2069 6e20 7365 6c66 2e61 7272 6f77 735f   in self.arrows_
+00016560: 6c61 796f 7574 5b6b 6579 5d5b 226e 7374  layout[key]["nst
+00016570: 6172 7422 5d0a 2020 2020 2020 2020 2020  art"].          
+00016580: 2020 5d0a 2020 2020 2020 2020 2020 2020    ].            
+00016590: 6172 726f 7773 5f64 6174 615b 2278 6522  arrows_data["xe"
+000165a0: 5d20 2b3d 205b 0a20 2020 2020 2020 2020  ] += [.         
+000165b0: 2020 2020 2020 2073 656c 662e 6e6f 6465         self.node
+000165c0: 735f 6c61 796f 7574 5b6b 5d5b 2278 225d  s_layout[k]["x"]
+000165d0: 202d 2062 6f78 5f64 696d 5b6b 5d5b 2277   - box_dim[k]["w
+000165e0: 6964 7468 225d 202f 2032 0a20 2020 2020  idth"] / 2.     
+000165f0: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
+00016600: 2069 6e20 7365 6c66 2e61 7272 6f77 735f   in self.arrows_
+00016610: 6c61 796f 7574 5b6b 6579 5d5b 226e 656e  layout[key]["nen
+00016620: 6422 5d0a 2020 2020 2020 2020 2020 2020  d"].            
+00016630: 5d0a 2020 2020 2020 2020 2020 2020 6172  ].            ar
+00016640: 726f 7773 5f64 6174 615b 2279 6522 5d20  rows_data["ye"] 
+00016650: 2b3d 205b 0a20 2020 2020 2020 2020 2020  += [.           
+00016660: 2020 2020 2073 656c 662e 6e6f 6465 735f       self.nodes_
+00016670: 6c61 796f 7574 5b6b 5d5b 2279 225d 2066  layout[k]["y"] f
+00016680: 6f72 206b 2069 6e20 7365 6c66 2e61 7272  or k in self.arr
+00016690: 6f77 735f 6c61 796f 7574 5b6b 6579 5d5b  ows_layout[key][
+000166a0: 226e 656e 6422 5d0a 2020 2020 2020 2020  "nend"].        
+000166b0: 2020 2020 5d0a 0a20 2020 2020 2020 2020      ]..         
+000166c0: 2020 2023 204c 4f47 4f53 0a20 2020 2020     # LOGOS.     
+000166d0: 2020 2020 2020 2069 6620 6c65 6e28 7467         if len(tg
+000166e0: 2e74 7970 6573 2920 3d3d 2031 3a0a 2020  .types) == 1:.  
+000166f0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00016700: 676f 5f74 7970 6520 3d20 6e65 7874 2869  go_type = next(i
+00016710: 7465 7228 7467 2e74 7970 6573 2929 2e73  ter(tg.types)).s
+00016720: 706c 6974 2822 2e22 295b 305d 0a20 2020  plit(".")[0].   
+00016730: 2020 2020 2020 2020 2020 2020 2074 7279               try
+00016740: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00016750: 2020 2020 2020 7572 6c5f 6c6f 676f 203d        url_logo =
+00016760: 206c 6f67 6f73 5f64 6963 745b 6c6f 676f   logos_dict[logo
+00016770: 5f74 7970 655d 0a20 2020 2020 2020 2020  _type].         
+00016780: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
+00016790: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
+000167a0: 2020 2020 2020 2020 2020 2020 7572 6c5f              url_
+000167b0: 6c6f 676f 203d 2022 220a 2020 2020 2020  logo = "".      
+000167c0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000167d0: 2020 2020 2020 2020 2020 2020 7572 6c5f              url_
+000167e0: 6c6f 676f 203d 2022 220a 0a20 2020 2020  logo = ""..     
+000167f0: 2020 2020 2020 206e 6f64 6573 5f64 6174         nodes_dat
+00016800: 615b 2275 726c 5f6c 6f67 6f22 5d2e 6170  a["url_logo"].ap
+00016810: 7065 6e64 2875 726c 5f6c 6f67 6f29 0a0a  pend(url_logo)..
+00016820: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+00016830: 735f 6461 7461 5b22 785f 6c6f 676f 225d  s_data["x_logo"]
+00016840: 2e61 7070 656e 6428 7820 2b20 7769 6474  .append(x + widt
+00016850: 6820 2f20 3329 0a20 2020 2020 2020 2020  h / 3).         
+00016860: 2020 206e 6f64 6573 5f64 6174 615b 2279     nodes_data["y
+00016870: 5f6c 6f67 6f22 5d2e 6170 7065 6e64 2879  _logo"].append(y
+00016880: 202b 2068 6569 6768 7420 2f20 3329 0a0a   + height / 3)..
+00016890: 2020 2020 2020 2020 2020 2020 7261 7469              rati
+000168a0: 6f20 3d20 7769 6474 6820 2f20 6865 6967  o = width / heig
+000168b0: 6874 0a0a 2020 2020 2020 2020 2020 2020  ht..            
+000168c0: 6966 2072 6174 696f 203e 2031 3a0a 2020  if ratio > 1:.  
+000168d0: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
+000168e0: 6465 735f 6461 7461 5b22 685f 6c6f 676f  des_data["h_logo
+000168f0: 225d 2e61 7070 656e 6428 6865 6967 6874  "].append(height
+00016900: 202a 2030 2e33 290a 2020 2020 2020 2020   * 0.3).        
+00016910: 2020 2020 2020 2020 6e6f 6465 735f 6461          nodes_da
+00016920: 7461 5b22 775f 6c6f 676f 225d 2e61 7070  ta["w_logo"].app
+00016930: 656e 6428 7769 6474 6820 2a20 302e 3320  end(width * 0.3 
+00016940: 2f20 7261 7469 6f29 0a20 2020 2020 2020  / ratio).       
+00016950: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00016960: 2020 2020 2020 2020 2020 206e 6f64 6573             nodes
+00016970: 5f64 6174 615b 2268 5f6c 6f67 6f22 5d2e  _data["h_logo"].
+00016980: 6170 7065 6e64 2868 6569 6768 7420 2a20  append(height * 
+00016990: 302e 3320 2a20 7261 7469 6f29 0a20 2020  0.3 * ratio).   
+000169a0: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
+000169b0: 6573 5f64 6174 615b 2277 5f6c 6f67 6f22  es_data["w_logo"
+000169c0: 5d2e 6170 7065 6e64 2877 6964 7468 202a  ].append(width *
+000169d0: 2030 2e33 290a 0a20 2020 2020 2020 2020   0.3)..         
+000169e0: 2020 2023 2063 6f6d 7075 7465 5f74 696d     # compute_tim
+000169f0: 6520 616e 6420 6d65 6d6f 7279 0a20 2020  e and memory.   
+00016a00: 2020 2020 2020 2020 206e 6f64 6573 5f64           nodes_d
+00016a10: 6174 615b 2263 6f6d 7075 7465 5f74 696d  ata["compute_tim
+00016a20: 6522 5d2e 6170 7065 6e64 2866 6f72 6d61  e"].append(forma
+00016a30: 745f 7469 6d65 2874 672e 6475 7261 7469  t_time(tg.durati
+00016a40: 6f6e 2929 0a20 2020 2020 2020 2020 2020  on)).           
+00016a50: 206e 6f64 6573 5f64 6174 615b 226d 656d   nodes_data["mem
+00016a60: 6f72 7922 5d2e 6170 7065 6e64 2866 6f72  ory"].append(for
+00016a70: 6d61 745f 6279 7465 7328 7467 2e6e 6279  mat_bytes(tg.nby
+00016a80: 7465 735f 746f 7461 6c29 290a 0a20 2020  tes_total))..   
+00016a90: 2020 2020 2020 2020 2023 2041 6464 2073           # Add s
+00016aa0: 6f6d 6520 7374 6174 7573 2074 6f20 686f  ome status to ho
+00016ab0: 7665 720a 2020 2020 2020 2020 2020 2020  ver.            
+00016ac0: 7461 736b 735f 7072 6f63 6573 7369 6e67  tasks_processing
+00016ad0: 203d 2074 672e 7374 6174 6573 5b22 7072   = tg.states["pr
+00016ae0: 6f63 6573 7369 6e67 225d 0a20 2020 2020  ocessing"].     
+00016af0: 2020 2020 2020 2074 6173 6b73 5f6d 656d         tasks_mem
+00016b00: 6f72 7920 3d20 7467 2e73 7461 7465 735b  ory = tg.states[
+00016b10: 226d 656d 6f72 7922 5d0a 2020 2020 2020  "memory"].      
+00016b20: 2020 2020 2020 7461 736b 735f 7265 6c61        tasks_rela
+00016b30: 7365 6420 3d20 7467 2e73 7461 7465 735b  sed = tg.states[
+00016b40: 2272 656c 6561 7365 6422 5d0a 2020 2020  "released"].    
+00016b50: 2020 2020 2020 2020 7461 736b 735f 6572          tasks_er
+00016b60: 7265 6420 3d20 7467 2e73 7461 7465 735b  red = tg.states[
+00016b70: 2265 7272 6564 225d 0a0a 2020 2020 2020  "erred"]..      
+00016b80: 2020 2020 2020 6e6f 6465 735f 6461 7461        nodes_data
+00016b90: 5b22 636f 6d70 5f74 6173 6b73 225d 2e61  ["comp_tasks"].a
+00016ba0: 7070 656e 6428 0a20 2020 2020 2020 2020  ppend(.         
+00016bb0: 2020 2020 2020 2066 227b 636f 6d70 5f74         f"{comp_t
+00016bc0: 6173 6b73 7d20 287b 636f 6d70 5f74 6173  asks} ({comp_tas
+00016bd0: 6b73 202f 2074 6f74 5f74 6173 6b73 202a  ks / tot_tasks *
+00016be0: 2031 3030 3a2e 3066 7d20 2529 220a 2020   100:.0f} %)".  
+00016bf0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00016c00: 2020 2020 2020 2020 6e6f 6465 735f 6461          nodes_da
+00016c10: 7461 5b22 696e 5f70 726f 6365 7373 696e  ta["in_processin
+00016c20: 6722 5d2e 6170 7065 6e64 280a 2020 2020  g"].append(.    
+00016c30: 2020 2020 2020 2020 2020 2020 6622 7b74              f"{t
+00016c40: 6173 6b73 5f70 726f 6365 7373 696e 677d  asks_processing}
+00016c50: 2028 7b74 6173 6b73 5f70 726f 6365 7373   ({tasks_process
+00016c60: 696e 672f 2074 6f74 5f74 6173 6b73 202a  ing/ tot_tasks *
+00016c70: 2031 3030 3a2e 3066 7d20 2529 220a 2020   100:.0f} %)".  
+00016c80: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00016c90: 2020 2020 2020 2020 6e6f 6465 735f 6461          nodes_da
+00016ca0: 7461 5b22 696e 5f6d 656d 6f72 7922 5d2e  ta["in_memory"].
+00016cb0: 6170 7065 6e64 280a 2020 2020 2020 2020  append(.        
+00016cc0: 2020 2020 2020 2020 6622 7b74 6173 6b73          f"{tasks
+00016cd0: 5f6d 656d 6f72 797d 2028 7b74 6173 6b73  _memory} ({tasks
+00016ce0: 5f6d 656d 6f72 792f 2074 6f74 5f74 6173  _memory/ tot_tas
+00016cf0: 6b73 202a 2031 3030 3a2e 3066 7d20 2529  ks * 100:.0f} %)
+00016d00: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+00016d10: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+00016d20: 735f 6461 7461 5b22 696e 5f72 656c 6561  s_data["in_relea
+00016d30: 7365 6422 5d2e 6170 7065 6e64 280a 2020  sed"].append(.  
+00016d40: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00016d50: 7b74 6173 6b73 5f72 656c 6173 6564 7d20  {tasks_relased} 
+00016d60: 287b 7461 736b 735f 7265 6c61 7365 642f  ({tasks_relased/
+00016d70: 2074 6f74 5f74 6173 6b73 202a 2031 3030   tot_tasks * 100
+00016d80: 3a2e 3066 7d20 2529 220a 2020 2020 2020  :.0f} %)".      
+00016d90: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00016da0: 2020 2020 6e6f 6465 735f 6461 7461 5b22      nodes_data["
+00016db0: 696e 5f65 7272 6564 225d 2e61 7070 656e  in_erred"].appen
+00016dc0: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
+00016dd0: 2020 2066 227b 2074 6173 6b73 5f65 7272     f"{ tasks_err
+00016de0: 6564 7d20 287b 7461 736b 735f 6572 7265  ed} ({tasks_erre
+00016df0: 642f 2074 6f74 5f74 6173 6b73 202a 2031  d/ tot_tasks * 1
+00016e00: 3030 3a2e 3066 7d20 2529 220a 2020 2020  00:.0f} %)".    
+00016e10: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00016e20: 2020 2073 656c 662e 6e6f 6465 735f 736f     self.nodes_so
+00016e30: 7572 6365 2e64 6174 612e 7570 6461 7465  urce.data.update
+00016e40: 286e 6f64 6573 5f64 6174 6129 0a20 2020  (nodes_data).   
+00016e50: 2020 2020 2073 656c 662e 6172 726f 7773       self.arrows
+00016e60: 5f73 6f75 7263 652e 6461 7461 2e75 7064  _source.data.upd
+00016e70: 6174 6528 6172 726f 7773 5f64 6174 6129  ate(arrows_data)
+00016e80: 0a0a 0a63 6c61 7373 2054 6173 6b47 726f  ...class TaskGro
+00016e90: 7570 5072 6f67 7265 7373 2844 6173 6862  upProgress(Dashb
+00016ea0: 6f61 7264 436f 6d70 6f6e 656e 7429 3a0a  oardComponent):.
+00016eb0: 2020 2020 2222 2253 7461 636b 6564 2061      """Stacked a
+00016ec0: 7265 6120 6368 6172 7420 7368 6f77 696e  rea chart showin
+00016ed0: 6720 7461 736b 2067 726f 7570 7320 7468  g task groups th
+00016ee0: 726f 7567 6820 7469 6d65 2222 220a 0a20  rough time""".. 
+00016ef0: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+00016f00: 7365 6c66 2c20 7363 6865 6475 6c65 722c  self, scheduler,
+00016f10: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
+00016f20: 2020 2020 7365 6c66 2e73 6368 6564 756c      self.schedul
+00016f30: 6572 203d 2073 6368 6564 756c 6572 0a20  er = scheduler. 
+00016f40: 2020 2020 2020 2073 656c 662e 736f 7572         self.sour
+00016f50: 6365 203d 2043 6f6c 756d 6e44 6174 6153  ce = ColumnDataS
+00016f60: 6f75 7263 6528 290a 2020 2020 2020 2020  ource().        
+00016f70: 2320 5468 6520 6c65 6e67 7468 206f 6620  # The length of 
+00016f80: 7469 6d65 7365 7269 6573 2074 6f20 6368  timeseries to ch
+00016f90: 6172 7420 2869 6e20 756e 6974 7320 6f66  art (in units of
+00016fa0: 2070 6c75 6769 6e2e 6474 290a 2020 2020   plugin.dt).    
+00016fb0: 2020 2020 7365 6c66 2e6e 7074 7320 3d20      self.npts = 
+00016fc0: 3138 300a 0a20 2020 2020 2020 2069 6620  180..        if 
+00016fd0: 4772 6f75 7054 696d 696e 672e 6e61 6d65  GroupTiming.name
+00016fe0: 206e 6f74 2069 6e20 7363 6865 6475 6c65   not in schedule
+00016ff0: 722e 706c 7567 696e 733a 0a20 2020 2020  r.plugins:.     
+00017000: 2020 2020 2020 2073 6368 6564 756c 6572         scheduler
+00017010: 2e61 6464 5f70 6c75 6769 6e28 706c 7567  .add_plugin(plug
+00017020: 696e 3d47 726f 7570 5469 6d69 6e67 2873  in=GroupTiming(s
+00017030: 6368 6564 756c 6572 2929 0a0a 2020 2020  cheduler))..    
+00017040: 2020 2020 7365 6c66 2e70 6c75 6769 6e20      self.plugin 
+00017050: 3d20 7363 6865 6475 6c65 722e 706c 7567  = scheduler.plug
+00017060: 696e 735b 4772 6f75 7054 696d 696e 672e  ins[GroupTiming.
+00017070: 6e61 6d65 5d0a 0a20 2020 2020 2020 2073  name]..        s
+00017080: 656c 662e 736f 7572 6365 2e61 6464 286e  elf.source.add(n
+00017090: 702e 6172 7261 7928 7365 6c66 2e70 6c75  p.array(self.plu
+000170a0: 6769 6e2e 7469 6d65 2920 2a20 3130 3030  gin.time) * 1000
+000170b0: 2e30 2c20 2274 696d 6522 290a 0a20 2020  .0, "time")..   
+000170c0: 2020 2020 2078 5f72 616e 6765 203d 2044       x_range = D
+000170d0: 6174 6152 616e 6765 3164 2872 616e 6765  ataRange1d(range
+000170e0: 5f70 6164 6469 6e67 3d30 290a 2020 2020  _padding=0).    
+000170f0: 2020 2020 795f 7261 6e67 6520 3d20 5261      y_range = Ra
+00017100: 6e67 6531 6428 302c 206d 6178 2873 656c  nge1d(0, max(sel
+00017110: 662e 706c 7567 696e 2e6e 7468 7265 6164  f.plugin.nthread
+00017120: 7329 290a 0a20 2020 2020 2020 2073 656c  s))..        sel
+00017130: 662e 726f 6f74 203d 2066 6967 7572 6528  f.root = figure(
+00017140: 0a20 2020 2020 2020 2020 2020 2074 6974  .            tit
+00017150: 6c65 3d22 5461 736b 2047 726f 7570 2050  le="Task Group P
+00017160: 726f 6772 6573 7322 2c0a 2020 2020 2020  rogress",.      
+00017170: 2020 2020 2020 6e61 6d65 3d22 7461 736b        name="task
+00017180: 5f67 726f 7570 5f70 726f 6772 6573 7322  _group_progress"
+00017190: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
+000171a0: 6f6c 6261 725f 6c6f 6361 7469 6f6e 3d22  olbar_location="
+000171b0: 6162 6f76 6522 2c0a 2020 2020 2020 2020  above",.        
+000171c0: 2020 2020 6d69 6e5f 626f 7264 6572 5f62      min_border_b
+000171d0: 6f74 746f 6d3d 3530 2c0a 2020 2020 2020  ottom=50,.      
+000171e0: 2020 2020 2020 785f 7261 6e67 653d 785f        x_range=x_
+000171f0: 7261 6e67 652c 0a20 2020 2020 2020 2020  range,.         
+00017200: 2020 2079 5f72 616e 6765 3d79 5f72 616e     y_range=y_ran
+00017210: 6765 2c0a 2020 2020 2020 2020 2020 2020  ge,.            
+00017220: 746f 6f6c 733d 2222 2c0a 2020 2020 2020  tools="",.      
+00017230: 2020 2020 2020 785f 6178 6973 5f74 7970        x_axis_typ
+00017240: 653d 2264 6174 6574 696d 6522 2c0a 2020  e="datetime",.  
+00017250: 2020 2020 2020 2020 2020 795f 6178 6973            y_axis
+00017260: 5f6c 6f63 6174 696f 6e3d 4e6f 6e65 2c0a  _location=None,.
+00017270: 2020 2020 2020 2020 2020 2020 2a2a 6b77              **kw
+00017280: 6172 6773 2c0a 2020 2020 2020 2020 290a  args,.        ).
+00017290: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+000172a0: 742e 7961 7869 732e 6d61 6a6f 725f 6c61  t.yaxis.major_la
+000172b0: 6265 6c5f 7465 7874 5f61 6c70 6861 203d  bel_text_alpha =
+000172c0: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
+000172d0: 726f 6f74 2e79 6178 6973 2e6d 696e 6f72  root.yaxis.minor
+000172e0: 5f74 6963 6b5f 6c69 6e65 5f61 6c70 6861  _tick_line_alpha
+000172f0: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
+00017300: 662e 726f 6f74 2e79 6178 6973 2e6d 616a  f.root.yaxis.maj
+00017310: 6f72 5f74 6963 6b5f 6c69 6e65 5f61 6c70  or_tick_line_alp
+00017320: 6861 203d 2030 0a20 2020 2020 2020 2073  ha = 0.        s
+00017330: 656c 662e 726f 6f74 2e78 6772 6964 2e76  elf.root.xgrid.v
+00017340: 6973 6962 6c65 203d 2046 616c 7365 0a0a  isible = False..
+00017350: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+00017360: 742e 6164 645f 746f 6f6c 7328 0a20 2020  t.add_tools(.   
+00017370: 2020 2020 2020 2020 2042 6f78 5a6f 6f6d           BoxZoom
+00017380: 546f 6f6c 2829 2c0a 2020 2020 2020 2020  Tool(),.        
+00017390: 2020 2020 5265 7365 7454 6f6f 6c28 292c      ResetTool(),
+000173a0: 0a20 2020 2020 2020 2020 2020 2050 616e  .            Pan
+000173b0: 546f 6f6c 2864 696d 656e 7369 6f6e 733d  Tool(dimensions=
+000173c0: 2277 6964 7468 2229 2c0a 2020 2020 2020  "width"),.      
+000173d0: 2020 2020 2020 5768 6565 6c5a 6f6f 6d54        WheelZoomT
+000173e0: 6f6f 6c28 6469 6d65 6e73 696f 6e73 3d22  ool(dimensions="
+000173f0: 7769 6474 6822 292c 0a20 2020 2020 2020  width"),.       
+00017400: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+00017410: 5f68 6f76 6572 203d 204e 6f6e 650a 2020  _hover = None.  
+00017420: 2020 2020 2020 7365 6c66 2e5f 6c61 7374        self._last
+00017430: 5f64 7261 776e 203d 204e 6f6e 650a 2020  _drawn = None.  
+00017440: 2020 2020 2020 7365 6c66 2e5f 6f66 6673        self._offs
+00017450: 6574 203d 2074 696d 6528 290a 2020 2020  et = time().    
+00017460: 2020 2020 7365 6c66 2e5f 6c61 7374 5f74      self._last_t
+00017470: 7261 6e73 6974 696f 6e5f 636f 756e 7420  ransition_count 
+00017480: 3d20 7363 6865 6475 6c65 722e 7472 616e  = scheduler.tran
+00017490: 7369 7469 6f6e 5f63 6f75 6e74 6572 0a20  sition_counter. 
+000174a0: 2020 2020 2020 2023 204f 7264 6572 6564         # Ordered
+000174b0: 4469 6374 2073 6f20 7765 2063 616e 206d  Dict so we can m
+000174c0: 616b 6520 6120 7265 7665 7273 6520 6974  ake a reverse it
+000174d0: 6572 6174 6f72 206c 6174 6572 2061 6e64  erator later and
+000174e0: 2067 6574 2074 6865 0a20 2020 2020 2020   get the.       
+000174f0: 2023 206d 6f73 742d 7265 6365 6e74 6c79   # most-recently
+00017500: 2d61 6464 6564 2067 6c79 7068 732e 0a20  -added glyphs.. 
+00017510: 2020 2020 2020 2073 656c 662e 5f72 656e         self._ren
+00017520: 6465 7265 7273 203d 204f 7264 6572 6564  derers = Ordered
+00017530: 4469 6374 2829 0a20 2020 2020 2020 2073  Dict().        s
+00017540: 656c 662e 5f6c 696e 655f 7265 6e64 6572  elf._line_render
+00017550: 6572 7320 3d20 4f72 6465 7265 6444 6963  ers = OrderedDic
+00017560: 7428 290a 0a20 2020 2064 6566 205f 7368  t()..    def _sh
+00017570: 6f75 6c64 5f61 6464 5f6e 6577 5f72 656e  ould_add_new_ren
+00017580: 6465 7265 7273 2873 656c 6629 202d 3e20  derers(self) -> 
+00017590: 626f 6f6c 3a0a 2020 2020 2020 2020 2222  bool:.        ""
+000175a0: 220a 2020 2020 2020 2020 5768 6574 6865  ".        Whethe
+000175b0: 7220 746f 2061 6464 206e 6577 2072 656e  r to add new ren
+000175c0: 6465 7265 7273 2074 6f20 7468 6520 6368  derers to the ch
+000175d0: 6172 742e 0a0a 2020 2020 2020 2020 5768  art...        Wh
+000175e0: 656e 2061 206e 6577 2073 6574 206f 6620  en a new set of 
+000175f0: 7461 736b 2067 726f 7570 7320 656e 7465  task groups ente
+00017600: 7273 2074 6865 2073 6368 6564 756c 6572  rs the scheduler
+00017610: 2077 6527 6420 6c69 6b65 2074 6f20 7374   we'd like to st
+00017620: 6172 7420 7265 6e64 6572 696e 670a 2020  art rendering.  
+00017630: 2020 2020 2020 7468 656d 2e20 4275 7420        them. But 
+00017640: 6974 2063 616e 2062 6520 6578 7065 6e73  it can be expens
+00017650: 6976 6520 746f 2061 6464 206e 6577 2067  ive to add new g
+00017660: 6c79 7073 2c20 736f 2077 6520 646f 2069  lyps, so we do i
+00017670: 7420 6465 6c69 6265 7261 7465 6c79 2c0a  t deliberately,.
+00017680: 2020 2020 2020 2020 6368 6563 6b69 6e67          checking
+00017690: 2077 6865 7468 6572 2077 6520 6861 7665   whether we have
+000176a0: 2074 6f20 646f 2069 7420 616e 6420 7768   to do it and wh
+000176b0: 6574 6865 7220 7468 6520 7363 6865 6475  ether the schedu
+000176c0: 6c65 7220 7365 656d 7320 6275 7379 2e0a  ler seems busy..
+000176d0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+000176e0: 2020 2020 2320 416c 7761 7973 2064 7261      # Always dra
+000176f0: 7720 6966 2077 6520 6861 7665 206e 6f74  w if we have not
+00017700: 2062 6566 6f72 650a 2020 2020 2020 2020   before.        
+00017710: 6966 206e 6f74 2073 656c 662e 5f6c 6173  if not self._las
+00017720: 745f 6472 6177 6e3a 0a20 2020 2020 2020  t_drawn:.       
+00017730: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
+00017740: 0a20 2020 2020 2020 2023 2044 6f6e 2774  .        # Don't
+00017750: 2064 7261 7720 6966 2074 6865 7265 2068   draw if there h
+00017760: 6176 6520 6265 656e 206e 6f20 6e65 7720  ave been no new 
+00017770: 7461 736b 7320 636f 6d70 6c65 7465 6420  tasks completed 
+00017780: 7369 6e63 6520 7468 6520 6c61 7374 2075  since the last u
+00017790: 7064 6174 652c 0a20 2020 2020 2020 2023  pdate,.        #
+000177a0: 206f 7220 6966 2074 6865 2073 6368 6564   or if the sched
+000177b0: 756c 6572 2043 5055 2069 7320 6f63 6375  uler CPU is occu
+000177c0: 7069 6564 2e0a 2020 2020 2020 2020 6966  pied..        if
+000177d0: 2028 0a20 2020 2020 2020 2020 2020 2073   (.            s
+000177e0: 656c 662e 5f6c 6173 745f 7472 616e 7369  elf._last_transi
+000177f0: 7469 6f6e 5f63 6f75 6e74 203d 3d20 7365  tion_count == se
+00017800: 6c66 2e73 6368 6564 756c 6572 2e74 7261  lf.scheduler.tra
+00017810: 6e73 6974 696f 6e5f 636f 756e 7465 720a  nsition_counter.
+00017820: 2020 2020 2020 2020 2020 2020 6f72 2073              or s
+00017830: 656c 662e 7363 6865 6475 6c65 722e 7072  elf.scheduler.pr
+00017840: 6f63 2e63 7075 5f70 6572 6365 6e74 2829  oc.cpu_percent()
+00017850: 203e 2035 300a 2020 2020 2020 2020 293a   > 50.        ):
+00017860: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00017870: 7572 6e20 4661 6c73 650a 0a20 2020 2020  urn False..     
+00017880: 2020 2023 204f 6e6c 7920 7265 7475 726e     # Only return
+00017890: 2074 7275 6520 6966 2074 6865 7265 2061   true if there a
+000178a0: 7265 206e 6577 2074 6173 6b20 6772 6f75  re new task grou
+000178b0: 7073 2074 6861 7420 7765 2068 6176 6520  ps that we have 
+000178c0: 6e6f 7420 7965 7420 6164 6465 640a 2020  not yet added.  
+000178d0: 2020 2020 2020 2320 746f 2074 6865 2043        # to the C
+000178e0: 6f6c 756d 6e44 6174 6153 6f75 7263 652e  olumnDataSource.
+000178f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00017900: 6e6f 7420 7365 7428 7365 6c66 2e70 6c75  not set(self.plu
+00017910: 6769 6e2e 636f 6d70 7574 652e 6b65 7973  gin.compute.keys
+00017920: 2829 2920 3c3d 2073 6574 2873 656c 662e  ()) <= set(self.
+00017930: 736f 7572 6365 2e64 6174 612e 6b65 7973  source.data.keys
+00017940: 2829 290a 0a20 2020 2064 6566 205f 7368  ())..    def _sh
+00017950: 6f75 6c64 5f75 7064 6174 6528 7365 6c66  ould_update(self
+00017960: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
+00017970: 2020 2022 2222 0a20 2020 2020 2020 2057     """.        W
+00017980: 6865 7468 6572 2074 6f20 7570 6461 7465  hether to update
+00017990: 2074 6865 2043 6f6c 756d 6e44 6174 6153   the ColumnDataS
+000179a0: 6f75 7263 652e 2054 6869 7320 6973 2063  ource. This is c
+000179b0: 6865 6170 6572 2074 6861 6e20 7265 6472  heaper than redr
+000179c0: 6177 696e 672c 0a20 2020 2020 2020 2062  awing,.        b
+000179d0: 7574 2073 7469 6c6c 206e 6f74 2066 7265  ut still not fre
+000179e0: 652c 2073 6f20 7765 2063 6865 636b 2077  e, so we check w
+000179f0: 6865 7468 6572 2077 6520 6e65 6564 2069  hether we need i
+00017a00: 7420 616e 6420 7768 6574 6865 7220 7468  t and whether th
+00017a10: 6520 7363 6865 7564 6c65 720a 2020 2020  e scheudler.    
+00017a20: 2020 2020 6973 2062 7573 792e 0a20 2020      is busy..   
+00017a30: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00017a40: 2072 6574 7572 6e20 280a 2020 2020 2020   return (.      
+00017a50: 2020 2020 2020 7365 6c66 2e5f 6c61 7374        self._last
+00017a60: 5f74 7261 6e73 6974 696f 6e5f 636f 756e  _transition_coun
+00017a70: 7420 213d 2073 656c 662e 7363 6865 6475  t != self.schedu
+00017a80: 6c65 722e 7472 616e 7369 7469 6f6e 5f63  ler.transition_c
+00017a90: 6f75 6e74 6572 0a20 2020 2020 2020 2020  ounter.         
+00017aa0: 2020 2061 6e64 2073 656c 662e 7363 6865     and self.sche
+00017ab0: 6475 6c65 722e 7072 6f63 2e63 7075 5f70  duler.proc.cpu_p
+00017ac0: 6572 6365 6e74 2829 203c 2035 300a 2020  ercent() < 50.  
+00017ad0: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
+00017ae0: 205f 6765 745f 7469 6d65 7365 7269 6573   _get_timeseries
+00017af0: 2873 656c 662c 2072 6573 7472 6963 745f  (self, restrict_
+00017b00: 746f 5f65 7869 7374 696e 673d 4661 6c73  to_existing=Fals
+00017b10: 6529 3a0a 2020 2020 2020 2020 2222 220a  e):.        """.
+00017b20: 2020 2020 2020 2020 5570 6461 7465 2074          Update t
+00017b30: 6865 2043 6f6c 756d 6e44 6174 6153 6f75  he ColumnDataSou
+00017b40: 7263 6520 7769 7468 206f 7572 2074 696d  rce with our tim
+00017b50: 6520 7365 7269 6573 2064 6174 612e 0a0a  e series data...
+00017b60: 2020 2020 2020 2020 7265 7374 7269 6374          restrict
+00017b70: 5f74 6f5f 6578 6973 7469 6e67 2064 6574  _to_existing det
+00017b80: 6572 6d69 6e65 7320 7768 6574 6865 7220  ermines whether 
+00017b90: 746f 2061 6464 206e 6577 2074 6173 6b20  to add new task 
+00017ba0: 6772 6f75 7073 0a20 2020 2020 2020 2077  groups.        w
+00017bb0: 6869 6368 206d 6967 6874 2068 6176 6520  hich might have 
+00017bc0: 6265 656e 2061 6464 6564 2073 696e 6365  been added since
+00017bd0: 2074 6865 206c 6173 7420 7469 6d65 2077   the last time w
+00017be0: 6520 7265 6e64 6572 6564 2e0a 2020 2020  e rendered..    
+00017bf0: 2020 2020 5468 6973 2069 7320 696d 706f      This is impo
+00017c00: 7274 616e 7420 6173 2077 6520 7761 6e74  rtant as we want
+00017c10: 2074 6f20 6164 6420 6e65 7720 7374 6163   to add new stac
+00017c20: 6b65 7273 2076 6572 7920 6465 6c69 6265  kers very delibe
+00017c30: 7261 7465 6c79 2e0a 2020 2020 2020 2020  rately..        
+00017c40: 2222 220a 2020 2020 2020 2020 2320 4765  """.        # Ge
+00017c50: 7420 7468 6520 6672 6f6e 742f 6261 636b  t the front/back
+00017c60: 2069 6e64 6963 6573 2066 6f72 206d 6f73   indices for mos
+00017c70: 7420 7265 6365 6e74 206e 7074 7320 6269  t recent npts bi
+00017c80: 6e73 206f 7574 206f 6620 7468 6520 7469  ns out of the ti
+00017c90: 6d65 7365 7269 6573 0a20 2020 2020 2020  meseries.       
+00017ca0: 2066 726f 6e74 203d 206d 6178 286c 656e   front = max(len
+00017cb0: 2873 656c 662e 706c 7567 696e 2e74 696d  (self.plugin.tim
+00017cc0: 6529 202d 2073 656c 662e 6e70 7473 2c20  e) - self.npts, 
+00017cd0: 3029 0a20 2020 2020 2020 2062 6163 6b20  0).        back 
+00017ce0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2023  = None.        #
+00017cf0: 2052 656d 6f76 6520 616e 7920 7065 7269   Remove any peri
+00017d00: 6f64 7320 6f66 207a 6572 6f20 636f 6d70  ods of zero comp
+00017d10: 7574 6520 6174 2074 6865 2066 726f 6e74  ute at the front
+00017d20: 206f 7220 6261 636b 206f 6620 7468 6520   or back of the 
+00017d30: 7469 6d65 7365 7269 6573 0a20 2020 2020  timeseries.     
+00017d40: 2020 2069 6620 6c65 6e28 7365 6c66 2e70     if len(self.p
+00017d50: 6c75 6769 6e2e 636f 6d70 7574 6529 3a0a  lugin.compute):.
+00017d60: 2020 2020 2020 2020 2020 2020 6167 6720              agg 
+00017d70: 3d20 7375 6d28 6e70 2e61 7272 6179 2876  = sum(np.array(v
+00017d80: 5b66 726f 6e74 3a5d 2920 666f 7220 7620  [front:]) for v 
+00017d90: 696e 2073 656c 662e 706c 7567 696e 2e63  in self.plugin.c
+00017da0: 6f6d 7075 7465 2e76 616c 7565 7328 2929  ompute.values())
+00017db0: 0a20 2020 2020 2020 2020 2020 2066 726f  .            fro
+00017dc0: 6e74 3220 3d20 6c65 6e28 6167 6729 202d  nt2 = len(agg) -
+00017dd0: 206c 656e 286e 702e 7472 696d 5f7a 6572   len(np.trim_zer
+00017de0: 6f73 2861 6767 2c20 7472 696d 3d22 6622  os(agg, trim="f"
+00017df0: 2929 0a20 2020 2020 2020 2020 2020 2066  )).            f
+00017e00: 726f 6e74 202b 3d20 6672 6f6e 7432 0a20  ront += front2. 
+00017e10: 2020 2020 2020 2020 2020 2062 6163 6b20             back 
+00017e20: 3d20 6c65 6e28 6e70 2e74 7269 6d5f 7a65  = len(np.trim_ze
+00017e30: 726f 7328 6167 672c 2074 7269 6d3d 2262  ros(agg, trim="b
+00017e40: 2229 2920 2d20 6c65 6e28 6167 6729 206f  ")) - len(agg) o
+00017e50: 7220 4e6f 6e65 0a0a 2020 2020 2020 2020  r None..        
+00017e60: 7072 6570 656e 6420 3d20 280a 2020 2020  prepend = (.    
+00017e70: 2020 2020 2020 2020 7365 6c66 2e70 6c75          self.plu
+00017e80: 6769 6e2e 7469 6d65 5b66 726f 6e74 202d  gin.time[front -
+00017e90: 2031 5d0a 2020 2020 2020 2020 2020 2020   1].            
+00017ea0: 6966 2066 726f 6e74 203e 3d20 310a 2020  if front >= 1.  
+00017eb0: 2020 2020 2020 2020 2020 656c 7365 2073            else s
+00017ec0: 656c 662e 706c 7567 696e 2e74 696d 655b  elf.plugin.time[
+00017ed0: 6672 6f6e 745d 202d 2073 656c 662e 706c  front] - self.pl
+00017ee0: 7567 696e 2e64 740a 2020 2020 2020 2020  ugin.dt.        
+00017ef0: 290a 2020 2020 2020 2020 7469 6d65 7374  ).        timest
+00017f00: 616d 7073 203d 206e 702e 6172 7261 7928  amps = np.array(
+00017f10: 7365 6c66 2e70 6c75 6769 6e2e 7469 6d65  self.plugin.time
+00017f20: 5b66 726f 6e74 3a62 6163 6b5d 290a 2020  [front:back]).  
+00017f30: 2020 2020 2020 6474 203d 206e 702e 6469        dt = np.di
+00017f40: 6666 2874 696d 6573 7461 6d70 732c 2070  ff(timestamps, p
+00017f50: 7265 7065 6e64 3d70 7265 7065 6e64 290a  repend=prepend).
+00017f60: 0a20 2020 2020 2020 2069 6620 7265 7374  .        if rest
+00017f70: 7269 6374 5f74 6f5f 6578 6973 7469 6e67  rict_to_existing
+00017f80: 3a0a 2020 2020 2020 2020 2020 2020 6e65  :.            ne
+00017f90: 775f 6461 7461 203d 207b 0a20 2020 2020  w_data = {.     
+00017fa0: 2020 2020 2020 2020 2020 206b 3a20 6e70             k: np
+00017fb0: 2e61 7272 6179 2876 5b66 726f 6e74 3a62  .array(v[front:b
+00017fc0: 6163 6b5d 2920 2f20 6474 0a20 2020 2020  ack]) / dt.     
+00017fd0: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
+00017fe0: 2c20 7620 696e 2073 656c 662e 706c 7567  , v in self.plug
+00017ff0: 696e 2e63 6f6d 7075 7465 2e69 7465 6d73  in.compute.items
+00018000: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+00018010: 2020 2069 6620 6b20 696e 2073 656c 662e     if k in self.
+00018020: 736f 7572 6365 2e64 6174 610a 2020 2020  source.data.    
+00018030: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00018040: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00018050: 2020 2020 6e65 775f 6461 7461 203d 2076      new_data = v
+00018060: 616c 6d61 7028 0a20 2020 2020 2020 2020  almap(.         
+00018070: 2020 2020 2020 206c 616d 6264 6120 783a         lambda x:
+00018080: 206e 702e 6172 7261 7928 785b 6672 6f6e   np.array(x[fron
+00018090: 743a 6261 636b 5d29 202f 2064 742c 0a20  t:back]) / dt,. 
+000180a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000180b0: 656c 662e 706c 7567 696e 2e63 6f6d 7075  elf.plugin.compu
+000180c0: 7465 2c0a 2020 2020 2020 2020 2020 2020  te,.            
+000180d0: 290a 0a20 2020 2020 2020 206e 6577 5f64  )..        new_d
+000180e0: 6174 615b 2274 696d 6522 5d20 3d20 280a  ata["time"] = (.
+000180f0: 2020 2020 2020 2020 2020 2020 7469 6d65              time
+00018100: 7374 616d 7073 202d 2073 656c 662e 5f6f  stamps - self._o
+00018110: 6666 7365 740a 2020 2020 2020 2020 2920  ffset.        ) 
+00018120: 2a20 3130 3030 2e30 2020 2320 626f 6b65  * 1000.0  # boke
+00018130: 6820 6c69 6b65 7320 6d69 6c6c 6973 6563  h likes millisec
+00018140: 6f6e 6473 0a20 2020 2020 2020 206e 6577  onds.        new
+00018150: 5f64 6174 615b 226e 7468 7265 6164 7322  _data["nthreads"
+00018160: 5d20 3d20 6e70 2e61 7272 6179 2873 656c  ] = np.array(sel
+00018170: 662e 706c 7567 696e 2e6e 7468 7265 6164  f.plugin.nthread
+00018180: 735b 6672 6f6e 743a 6261 636b 5d29 0a0a  s[front:back])..
+00018190: 2020 2020 2020 2020 7265 7475 726e 206e          return n
+000181a0: 6577 5f64 6174 610a 0a20 2020 2040 7769  ew_data..    @wi
+000181b0: 7468 6f75 745f 7072 6f70 6572 7479 5f76  thout_property_v
+000181c0: 616c 6964 6174 696f 6e0a 2020 2020 406c  alidation.    @l
+000181d0: 6f67 5f65 7272 6f72 730a 2020 2020 6465  og_errors.    de
+000181e0: 6620 7570 6461 7465 2873 656c 6629 3a0a  f update(self):.
+000181f0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00018200: 2020 2020 4d61 7962 6520 7570 6461 7465      Maybe update
+00018210: 2074 6865 2063 6861 7274 2e20 5468 6973   the chart. This
+00018220: 2069 7320 736f 6d65 7768 6174 2065 7870   is somewhat exp
+00018230: 656e 7369 7665 2074 6f20 6472 6177 2c20  ensive to draw, 
+00018240: 736f 2077 6520 7570 6461 7465 0a20 2020  so we update.   
+00018250: 2020 2020 2069 7420 7072 6574 7479 2064       it pretty d
+00018260: 6566 656e 7369 7665 6c79 2e0a 2020 2020  efensively..    
+00018270: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00018280: 6966 2073 656c 662e 5f73 686f 756c 645f  if self._should_
+00018290: 6164 645f 6e65 775f 7265 6e64 6572 6572  add_new_renderer
+000182a0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+000182b0: 2023 2055 7064 6174 6520 7468 6520 6368   # Update the ch
+000182c0: 6172 742c 2061 6c6c 6f77 696e 6720 666f  art, allowing fo
+000182d0: 7220 6e65 7720 7461 736b 2067 726f 7570  r new task group
+000182e0: 7320 746f 2062 6520 6164 6465 642e 0a20  s to be added.. 
+000182f0: 2020 2020 2020 2020 2020 206e 6577 5f64             new_d
+00018300: 6174 6120 3d20 7365 6c66 2e5f 6765 745f  ata = self._get_
+00018310: 7469 6d65 7365 7269 6573 2872 6573 7472  timeseries(restr
+00018320: 6963 745f 746f 5f65 7869 7374 696e 673d  ict_to_existing=
+00018330: 4661 6c73 6529 0a20 2020 2020 2020 2020  False).         
+00018340: 2020 2073 656c 662e 736f 7572 6365 2e64     self.source.d
+00018350: 6174 6120 3d20 6e65 775f 6461 7461 0a0a  ata = new_data..
+00018360: 2020 2020 2020 2020 2020 2020 2320 506f              # Po
+00018370: 7373 6962 6c79 2075 7064 6174 6520 7468  ssibly update th
+00018380: 6520 7920 7261 6e67 6520 6966 2074 6865  e y range if the
+00018390: 206e 756d 6265 7220 6f66 2074 6872 6561   number of threa
+000183a0: 6473 2068 6173 2069 6e63 7265 6173 6564  ds has increased
+000183b0: 2e0a 2020 2020 2020 2020 2020 2020 6d61  ..            ma
+000183c0: 785f 6e74 6872 6561 6473 203d 206d 6178  x_nthreads = max
+000183d0: 2873 656c 662e 706c 7567 696e 2e6e 7468  (self.plugin.nth
+000183e0: 7265 6164 7329 0a20 2020 2020 2020 2020  reads).         
+000183f0: 2020 2069 6620 7365 6c66 2e72 6f6f 742e     if self.root.
+00018400: 795f 7261 6e67 652e 656e 6420 213d 206d  y_range.end != m
+00018410: 6178 5f6e 7468 7265 6164 733a 0a20 2020  ax_nthreads:.   
+00018420: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00018430: 662e 726f 6f74 2e79 5f72 616e 6765 2e65  f.root.y_range.e
+00018440: 6e64 203d 206d 6178 5f6e 7468 7265 6164  nd = max_nthread
+00018450: 730a 0a20 2020 2020 2020 2020 2020 2073  s..            s
+00018460: 7461 636b 6572 7320 3d20 6c69 7374 2873  tackers = list(s
+00018470: 656c 662e 706c 7567 696e 2e63 6f6d 7075  elf.plugin.compu
+00018480: 7465 2e6b 6579 7328 2929 0a20 2020 2020  te.keys()).     
+00018490: 2020 2020 2020 2063 6f6c 6f72 7320 3d20         colors = 
+000184a0: 5b63 6f6c 6f72 5f6f 6628 6b65 795f 7370  [color_of(key_sp
+000184b0: 6c69 7428 6b29 2920 666f 7220 6b20 696e  lit(k)) for k in
+000184c0: 2073 7461 636b 6572 735d 0a0a 2020 2020   stackers]..    
+000184d0: 2020 2020 2020 2020 666f 7220 692c 2028          for i, (
+000184e0: 6772 6f75 702c 2063 6f6c 6f72 2920 696e  group, color) in
+000184f0: 2065 6e75 6d65 7261 7465 287a 6970 2873   enumerate(zip(s
+00018500: 7461 636b 6572 732c 2063 6f6c 6f72 7329  tackers, colors)
+00018510: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00018520: 2020 2023 2049 6620 7765 2068 6176 6520     # If we have 
+00018530: 616c 7265 6164 7920 6472 6177 6e20 7468  already drawn th
+00018540: 6520 6772 6f75 702c 2062 7574 2069 7420  e group, but it 
+00018550: 6973 2061 6c6c 207a 6572 6f2c 0a20 2020  is all zero,.   
+00018560: 2020 2020 2020 2020 2020 2020 2023 2073               # s
+00018570: 6574 2069 7420 746f 2062 6520 696e 7669  et it to be invi
+00018580: 7369 626c 652e 0a20 2020 2020 2020 2020  sible..         
+00018590: 2020 2020 2020 2069 6620 6772 6f75 7020         if group 
+000185a0: 696e 2073 656c 662e 5f72 656e 6465 7265  in self._rendere
+000185b0: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
+000185c0: 2020 2020 2020 2020 6966 206e 6f74 206e          if not n
+000185d0: 702e 636f 756e 745f 6e6f 6e7a 6572 6f28  p.count_nonzero(
+000185e0: 6e65 775f 6461 7461 5b67 726f 7570 5d29  new_data[group])
+000185f0: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
+00018600: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00018610: 6c66 2e5f 7265 6e64 6572 6572 735b 6772  lf._renderers[gr
+00018620: 6f75 705d 2e76 6973 6962 6c65 203d 2046  oup].visible = F
+00018630: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
+00018640: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00018650: 662e 5f6c 696e 655f 7265 6e64 6572 6572  f._line_renderer
+00018660: 735b 6772 6f75 705d 2e76 6973 6962 6c65  s[group].visible
+00018670: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+00018680: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00018690: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000186a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000186b0: 5f72 656e 6465 7265 7273 5b67 726f 7570  _renderers[group
+000186c0: 5d2e 7669 7369 626c 6520 3d20 5472 7565  ].visible = True
+000186d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000186e0: 2020 2020 2020 2020 2073 656c 662e 5f6c           self._l
+000186f0: 696e 655f 7265 6e64 6572 6572 735b 6772  ine_renderers[gr
+00018700: 6f75 705d 2e76 6973 6962 6c65 203d 2054  oup].visible = T
+00018710: 7275 650a 0a20 2020 2020 2020 2020 2020  rue..           
+00018720: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
+00018730: 650a 0a20 2020 2020 2020 2020 2020 2020  e..             
+00018740: 2020 2023 2044 7261 7720 7468 6520 6e65     # Draw the ne
+00018750: 7720 6172 6561 2061 6e64 206c 696e 6520  w area and line 
+00018760: 676c 7970 6873 2e0a 2020 2020 2020 2020  glyphs..        
+00018770: 2020 2020 2020 2020 7265 6e64 6572 6572          renderer
+00018780: 203d 2073 656c 662e 726f 6f74 2e76 6172   = self.root.var
+00018790: 6561 280a 2020 2020 2020 2020 2020 2020  ea(.            
+000187a0: 2020 2020 2020 2020 783d 2274 696d 6522          x="time"
+000187b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000187c0: 2020 2020 2020 7931 3d73 7461 636b 282a        y1=stack(*
+000187d0: 7374 6163 6b65 7273 5b3a 695d 292c 0a20  stackers[:i]),. 
+000187e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000187f0: 2020 2079 323d 7374 6163 6b28 2a73 7461     y2=stack(*sta
+00018800: 636b 6572 735b 3a20 6920 2b20 315d 292c  ckers[: i + 1]),
+00018810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018820: 2020 2020 2063 6f6c 6f72 3d63 6f6c 6f72       color=color
+00018830: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00018840: 2020 2020 2020 616c 7068 613d 302e 352c        alpha=0.5,
+00018850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018860: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
+00018870: 2e73 6f75 7263 652c 0a20 2020 2020 2020  .source,.       
+00018880: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00018890: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000188a0: 5f72 656e 6465 7265 7273 5b67 726f 7570  _renderers[group
+000188b0: 5d20 3d20 7265 6e64 6572 6572 0a0a 2020  ] = renderer..  
+000188c0: 2020 2020 2020 2020 2020 2020 2020 6c69                li
+000188d0: 6e65 5f72 656e 6465 7265 7220 3d20 7365  ne_renderer = se
+000188e0: 6c66 2e72 6f6f 742e 6c69 6e65 280a 2020  lf.root.line(.  
+000188f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018900: 2020 783d 2274 696d 6522 2c0a 2020 2020    x="time",.    
+00018910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018920: 793d 7374 6163 6b28 2a73 7461 636b 6572  y=stack(*stacker
+00018930: 735b 3a20 6920 2b20 315d 292c 0a20 2020  s[: i + 1]),.   
+00018940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018950: 2063 6f6c 6f72 3d63 6f6c 6f72 2c0a 2020   color=color,.  
+00018960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018970: 2020 616c 7068 613d 312e 302c 0a20 2020    alpha=1.0,.   
+00018980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018990: 2073 6f75 7263 653d 7365 6c66 2e73 6f75   source=self.sou
+000189a0: 7263 652c 0a20 2020 2020 2020 2020 2020  rce,.           
+000189b0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+000189c0: 2020 2020 2020 2073 656c 662e 5f6c 696e         self._lin
+000189d0: 655f 7265 6e64 6572 6572 735b 6772 6f75  e_renderers[grou
+000189e0: 705d 203d 206c 696e 655f 7265 6e64 6572  p] = line_render
+000189f0: 6572 0a0a 2020 2020 2020 2020 2020 2020  er..            
+00018a00: 2320 446f 6e27 7420 6164 6420 686f 7665  # Don't add hove
+00018a10: 7220 756e 7469 6c20 7468 6572 6520 6973  r until there is
+00018a20: 2073 6f6d 6574 6869 6e67 2074 6f20 7368   something to sh
+00018a30: 6f77 2c20 6173 2062 6f6b 6568 6a73 2073  ow, as bokehjs s
+00018a40: 6565 6d73 2074 6f0a 2020 2020 2020 2020  eems to.        
+00018a50: 2020 2020 2320 6861 7665 2074 726f 7562      # have troub
+00018a60: 6c65 2077 6974 6820 6375 7374 6f6d 2068  le with custom h
+00018a70: 6f76 6572 7320 7768 656e 2074 6865 7265  overs when there
+00018a80: 2061 7265 206e 6f20 7265 6e64 6572 6572   are no renderer
+00018a90: 732e 0a20 2020 2020 2020 2020 2020 2069  s..            i
+00018aa0: 6620 7365 6c66 2e70 6c75 6769 6e2e 636f  f self.plugin.co
+00018ab0: 6d70 7574 6520 616e 6420 7365 6c66 2e5f  mpute and self._
+00018ac0: 686f 7665 7220 6973 204e 6f6e 653a 0a20  hover is None:. 
+00018ad0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00018ae0: 2041 6464 2061 2068 6f76 6572 2074 6861   Add a hover tha
+00018af0: 7420 7769 6c6c 2073 686f 7720 6f63 6375  t will show occu
+00018b00: 7061 6e63 7920 666f 7220 616c 6c20 6375  pancy for all cu
+00018b10: 7272 656e 746c 7920 6163 7469 7665 0a20  rrently active. 
+00018b20: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00018b30: 2074 6173 6b20 6772 6f75 7073 2e20 5468   task groups. Th
+00018b40: 6973 2069 7320 6120 6c69 7474 6c65 2074  is is a little t
+00018b50: 7269 636b 792c 2062 6f6b 6568 2064 6f65  ricky, bokeh doe
+00018b60: 736e 2774 2028 7965 7429 2073 7570 706f  sn't (yet) suppo
+00018b70: 7274 0a20 2020 2020 2020 2020 2020 2020  rt.             
+00018b80: 2020 2023 2068 6974 2074 6573 7473 2066     # hit tests f
+00018b90: 6f72 2073 7461 636b 6564 2061 7265 6120  or stacked area 
+00018ba0: 6368 6172 7473 3a20 6874 7470 733a 2f2f  charts: https://
+00018bb0: 6769 7468 7562 2e63 6f6d 2f62 6f6b 6568  github.com/bokeh
+00018bc0: 2f62 6f6b 6568 2f69 7373 7565 732f 3931  /bokeh/issues/91
+00018bd0: 3832 0a20 2020 2020 2020 2020 2020 2020  82.             
+00018be0: 2020 2023 2049 6e73 7465 6164 2c20 7368     # Instead, sh
+00018bf0: 6f77 2061 2073 696e 676c 6520 766c 696e  ow a single vlin
+00018c00: 6520 686f 7665 7220 7768 6963 6820 6c69  e hover which li
+00018c10: 7374 7320 7468 6520 6375 7272 656e 746c  sts the currentl
+00018c20: 7920 6163 7469 7665 2074 6173 6b0a 2020  y active task.  
+00018c30: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00018c40: 6772 6f75 7073 2e20 4120 6375 7374 6f6d  groups. A custom
+00018c50: 2066 6f72 6d61 7474 6572 2069 6e20 4a53   formatter in JS
+00018c60: 2d6c 616e 6420 7075 6c6c 7320 7468 6520  -land pulls the 
+00018c70: 7265 6c65 7661 6e74 2064 6174 6120 696e  relevant data in
+00018c80: 6465 7820 616e 640a 2020 2020 2020 2020  dex and.        
+00018c90: 2020 2020 2020 2020 2320 6173 7365 6d62          # assemb
+00018ca0: 6c65 7320 7468 6520 746f 6f6c 7469 702e  les the tooltip.
+00018cb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018cc0: 2066 6f72 6d61 7474 6572 203d 2043 7573   formatter = Cus
+00018cd0: 746f 6d4a 5348 6f76 6572 2863 6f64 653d  tomJSHover(code=
+00018ce0: 2272 6574 7572 6e20 2727 3b22 290a 2020  "return '';").  
+00018cf0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00018d00: 6c66 2e5f 686f 7665 7220 3d20 486f 7665  lf._hover = Hove
+00018d10: 7254 6f6f 6c28 0a20 2020 2020 2020 2020  rTool(.         
+00018d20: 2020 2020 2020 2020 2020 2074 6f6f 6c74             toolt
+00018d30: 6970 733d 2222 220a 2020 2020 2020 2020  ips=""".        
+00018d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018d50: 3c64 6976 3e0a 2020 2020 2020 2020 2020  <div>.          
 00018d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018d70: 2020 2020 2020 2020 2020 3c64 6976 2073            <div s
-00018d80: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
-00018d90: 2031 2e32 656d 3b20 666f 6e74 2d77 6569   1.2em; font-wei
-00018da0: 6768 743a 2062 6f6c 6422 3e0a 2020 2020  ght: bold">.    
-00018db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018dc0: 2020 2020 2020 2020 3c62 3e57 6f72 6b65          <b>Worke
-00018dd0: 7220 7468 7265 6164 206f 6363 7570 616e  r thread occupan
-00018de0: 6379 3c2f 623e 0a20 2020 2020 2020 2020  cy</b>.         
-00018df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018e00: 203c 2f64 6976 3e0a 2020 2020 2020 2020   </div>.        
-00018e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018e20: 2020 3c64 6976 3e0a 2020 2020 2020 2020    <div>.        
-00018e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018e40: 2020 2020 2469 6e64 6578 7b63 7573 746f      $index{custo
-00018e50: 6d7d 0a20 2020 2020 2020 2020 2020 2020  m}.             
-00018e60: 2020 2020 2020 2020 2020 2020 203c 2f64               </d
-00018e70: 6976 3e0a 2020 2020 2020 2020 2020 2020  iv>.            
-00018e80: 2020 2020 2020 2020 2020 2020 3c2f 6469              </di
-00018e90: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
-00018ea0: 2020 2020 2020 2020 2020 2022 2222 2c0a             """,.
-00018eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018ec0: 2020 2020 6d6f 6465 3d22 766c 696e 6522      mode="vline"
-00018ed0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018ee0: 2020 2020 2020 6c69 6e65 5f70 6f6c 6963        line_polic
-00018ef0: 793d 226e 6561 7265 7374 222c 0a20 2020  y="nearest",.   
-00018f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018f10: 2061 7474 6163 686d 656e 743d 2268 6f72   attachment="hor
-00018f20: 697a 6f6e 7461 6c22 2c0a 2020 2020 2020  izontal",.      
-00018f30: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00018f40: 726d 6174 7465 7273 3d7b 2224 696e 6465  rmatters={"$inde
-00018f50: 7822 3a20 666f 726d 6174 7465 727d 2c0a  x": formatter},.
-00018f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018f70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00018f80: 2020 7365 6c66 2e72 6f6f 742e 6164 645f    self.root.add_
-00018f90: 746f 6f6c 7328 7365 6c66 2e5f 686f 7665  tools(self._hove
-00018fa0: 7229 0a0a 2020 2020 2020 2020 2020 2020  r)..            
-00018fb0: 6966 2073 656c 662e 5f68 6f76 6572 3a0a  if self._hover:.
-00018fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018fd0: 2320 4372 6561 7465 2061 2063 7573 746f  # Create a custo
-00018fe0: 6d20 746f 6f6c 7469 7020 7468 6174 3a0a  m tooltip that:.
-00018ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019000: 2320 2020 312e 2049 6e63 6c75 6465 7320  #   1. Includes 
-00019010: 6e74 6872 6561 6473 0a20 2020 2020 2020  nthreads.       
-00019020: 2020 2020 2020 2020 2023 2020 2032 2e20           #   2. 
-00019030: 4669 6c74 6572 7320 6f75 7420 696e 6163  Filters out inac
-00019040: 7469 7665 2074 6173 6b20 6772 6f75 7073  tive task groups
-00019050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019060: 2023 2020 2020 2020 286f 6e65 7320 7769   #      (ones wi
-00019070: 7468 6f75 7420 616e 7920 636f 6d70 7574  thout any comput
-00019080: 6520 6475 7269 6e67 2074 6865 2072 656c  e during the rel
-00019090: 6576 616e 7420 6474 290a 2020 2020 2020  evant dt).      
-000190a0: 2020 2020 2020 2020 2020 2320 2020 332e            #   3.
-000190b0: 2043 6f6c 6f72 7320 7468 6520 6c61 6265   Colors the labe
-000190c0: 6c73 2061 7070 726f 7072 6961 7465 6c79  ls appropriately
-000190d0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000190e0: 2020 666f 726d 6174 7465 7220 3d20 4375    formatter = Cu
-000190f0: 7374 6f6d 4a53 486f 7665 7228 0a20 2020  stomJSHover(.   
-00019100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019110: 2063 6f64 653d 2222 220a 2020 2020 2020   code=""".      
-00019120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019130: 2020 636f 6e73 7420 636f 6c6f 726d 6170    const colormap
-00019140: 203d 2025 733b 0a20 2020 2020 2020 2020   = %s;.         
-00019150: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00019160: 6f6e 7374 2064 6976 7320 3d20 5b5d 3b0a  onst divs = [];.
-00019170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019180: 2020 2020 2020 2020 666f 7220 286c 6574          for (let
-00019190: 206b 206f 6620 4f62 6a65 6374 2e6b 6579   k of Object.key
-000191a0: 7328 736f 7572 6365 2e64 6174 6129 2920  s(source.data)) 
-000191b0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000191c0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-000191d0: 7420 7661 6c20 3d20 736f 7572 6365 2e64  t val = source.d
-000191e0: 6174 615b 6b5d 5b76 616c 7565 5d3b 0a20  ata[k][value];. 
-000191f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019200: 2020 2020 2020 2020 2063 6f6e 7374 2063           const c
-00019210: 6f6c 6f72 203d 2063 6f6c 6f72 6d61 705b  olor = colormap[
-00019220: 6b5d 3b0a 2020 2020 2020 2020 2020 2020  k];.            
-00019230: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00019240: 2028 6b20 3d3d 3d20 2274 696d 6522 207c   (k === "time" |
-00019250: 7c20 6b20 3d3d 3d20 226e 7468 7265 6164  | k === "nthread
-00019260: 7322 207c 7c20 7661 6c20 3c20 312e 652d  s" || val < 1.e-
-00019270: 3329 207b 0a20 2020 2020 2020 2020 2020  3) {.           
-00019280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019290: 2063 6f6e 7469 6e75 653b 0a20 2020 2020   continue;.     
-000192a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000192b0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-000192c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000192d0: 2063 6f6e 7374 206c 6162 656c 203d 206b   const label = k
-000192e0: 2e6c 656e 6774 6820 3e3d 2032 3020 3f20  .length >= 20 ? 
-000192f0: 6b2e 736c 6963 6528 302c 2032 3029 202b  k.slice(0, 20) +
-00019300: 2027 e280 a627 203a 206b 3b0a 0a20 2020   '...' : k;..   
-00019310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019320: 2020 2020 2020 202f 2f20 556e 7368 6966         // Unshif
-00019330: 7420 736f 2074 6861 7420 7468 6520 6f72  t so that the or
-00019340: 6465 7269 6e67 206f 6620 7468 6520 6c61  dering of the la
-00019350: 6265 6c73 2069 7320 7468 6520 7361 6d65  bels is the same
-00019360: 2061 730a 2020 2020 2020 2020 2020 2020   as.            
-00019370: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-00019380: 2074 6865 206f 7264 6572 696e 6720 6f66   the ordering of
-00019390: 2074 6865 2073 7461 636b 6572 732e 0a20   the stackers.. 
-000193a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000193b0: 2020 2020 2020 2020 2064 6976 732e 756e           divs.un
-000193c0: 7368 6966 7428 0a20 2020 2020 2020 2020  shift(.         
-000193d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000193e0: 2020 2027 3c64 6976 3e27 0a20 2020 2020     '<div>'.     
-000193f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019400: 2020 2020 2020 2020 202b 2027 3c73 7061           + '<spa
-00019410: 6e20 7374 796c 653d 2266 6f6e 742d 7765  n style="font-we
-00019420: 6967 6874 3a20 626f 6c64 3b20 636f 6c6f  ight: bold; colo
-00019430: 723a 2720 2b20 636f 6c6f 7220 2b20 273b  r:' + color + ';
-00019440: 223e 270a 2020 2020 2020 2020 2020 2020  ">'.            
-00019450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019460: 2020 2020 2b20 6c61 6265 6c0a 2020 2020      + label.    
+00018d70: 3c64 6976 2073 7479 6c65 3d22 666f 6e74  <div style="font
+00018d80: 2d73 697a 653a 2031 2e32 656d 3b20 666f  -size: 1.2em; fo
+00018d90: 6e74 2d77 6569 6768 743a 2062 6f6c 6422  nt-weight: bold"
+00018da0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+00018db0: 2020 2020 2020 2020 2020 2020 2020 3c62                <b
+00018dc0: 3e57 6f72 6b65 7220 7468 7265 6164 206f  >Worker thread o
+00018dd0: 6363 7570 616e 6379 3c2f 623e 0a20 2020  ccupancy</b>.   
+00018de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018df0: 2020 2020 2020 203c 2f64 6976 3e0a 2020         </div>.  
+00018e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e10: 2020 2020 2020 2020 3c64 6976 3e0a 2020          <div>.  
+00018e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e30: 2020 2020 2020 2020 2020 2469 6e64 6578            $index
+00018e40: 7b63 7573 746f 6d7d 0a20 2020 2020 2020  {custom}.       
+00018e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e60: 2020 203c 2f64 6976 3e0a 2020 2020 2020     </div>.      
+00018e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e80: 2020 3c2f 6469 763e 0a20 2020 2020 2020    </div>.       
+00018e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018ea0: 2022 2222 2c0a 2020 2020 2020 2020 2020   """,.          
+00018eb0: 2020 2020 2020 2020 2020 6d6f 6465 3d22            mode="
+00018ec0: 766c 696e 6522 2c0a 2020 2020 2020 2020  vline",.        
+00018ed0: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
+00018ee0: 5f70 6f6c 6963 793d 226e 6561 7265 7374  _policy="nearest
+00018ef0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00018f00: 2020 2020 2020 2061 7474 6163 686d 656e         attachmen
+00018f10: 743d 2268 6f72 697a 6f6e 7461 6c22 2c0a  t="horizontal",.
+00018f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018f30: 2020 2020 666f 726d 6174 7465 7273 3d7b      formatters={
+00018f40: 2224 696e 6465 7822 3a20 666f 726d 6174  "$index": format
+00018f50: 7465 727d 2c0a 2020 2020 2020 2020 2020  ter},.          
+00018f60: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00018f70: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+00018f80: 742e 6164 645f 746f 6f6c 7328 7365 6c66  t.add_tools(self
+00018f90: 2e5f 686f 7665 7229 0a0a 2020 2020 2020  ._hover)..      
+00018fa0: 2020 2020 2020 6966 2073 656c 662e 5f68        if self._h
+00018fb0: 6f76 6572 3a0a 2020 2020 2020 2020 2020  over:.          
+00018fc0: 2020 2020 2020 2320 4372 6561 7465 2061        # Create a
+00018fd0: 2063 7573 746f 6d20 746f 6f6c 7469 7020   custom tooltip 
+00018fe0: 7468 6174 3a0a 2020 2020 2020 2020 2020  that:.          
+00018ff0: 2020 2020 2020 2320 2020 312e 2049 6e63        #   1. Inc
+00019000: 6c75 6465 7320 6e74 6872 6561 6473 0a20  ludes nthreads. 
+00019010: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00019020: 2020 2032 2e20 4669 6c74 6572 7320 6f75     2. Filters ou
+00019030: 7420 696e 6163 7469 7665 2074 6173 6b20  t inactive task 
+00019040: 6772 6f75 7073 0a20 2020 2020 2020 2020  groups.         
+00019050: 2020 2020 2020 2023 2020 2020 2020 286f         #      (o
+00019060: 6e65 7320 7769 7468 6f75 7420 616e 7920  nes without any 
+00019070: 636f 6d70 7574 6520 6475 7269 6e67 2074  compute during t
+00019080: 6865 2072 656c 6576 616e 7420 6474 290a  he relevant dt).
+00019090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000190a0: 2320 2020 332e 2043 6f6c 6f72 7320 7468  #   3. Colors th
+000190b0: 6520 6c61 6265 6c73 2061 7070 726f 7072  e labels appropr
+000190c0: 6961 7465 6c79 2e0a 2020 2020 2020 2020  iately..        
+000190d0: 2020 2020 2020 2020 666f 726d 6174 7465          formatte
+000190e0: 7220 3d20 4375 7374 6f6d 4a53 486f 7665  r = CustomJSHove
+000190f0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00019100: 2020 2020 2020 2063 6f64 653d 2222 220a         code=""".
+00019110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019120: 2020 2020 2020 2020 636f 6e73 7420 636f          const co
+00019130: 6c6f 726d 6170 203d 2025 733b 0a20 2020  lormap = %s;.   
+00019140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019150: 2020 2020 2063 6f6e 7374 2064 6976 7320       const divs 
+00019160: 3d20 5b5d 3b0a 2020 2020 2020 2020 2020  = [];.          
+00019170: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00019180: 7220 286c 6574 206b 206f 6620 4f62 6a65  r (let k of Obje
+00019190: 6374 2e6b 6579 7328 736f 7572 6365 2e64  ct.keys(source.d
+000191a0: 6174 6129 2920 7b0a 2020 2020 2020 2020  ata)) {.        
+000191b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000191c0: 2020 636f 6e73 7420 7661 6c20 3d20 736f    const val = so
+000191d0: 7572 6365 2e64 6174 615b 6b5d 5b76 616c  urce.data[k][val
+000191e0: 7565 5d3b 0a20 2020 2020 2020 2020 2020  ue];.           
+000191f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00019200: 6f6e 7374 2063 6f6c 6f72 203d 2063 6f6c  onst color = col
+00019210: 6f72 6d61 705b 6b5d 3b0a 2020 2020 2020  ormap[k];.      
+00019220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019230: 2020 2020 6966 2028 6b20 3d3d 3d20 2274      if (k === "t
+00019240: 696d 6522 207c 7c20 6b20 3d3d 3d20 226e  ime" || k === "n
+00019250: 7468 7265 6164 7322 207c 7c20 7661 6c20  threads" || val 
+00019260: 3c20 312e 652d 3329 207b 0a20 2020 2020  < 1.e-3) {.     
+00019270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019280: 2020 2020 2020 2063 6f6e 7469 6e75 653b         continue;
+00019290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000192a0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+000192b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000192c0: 2020 2020 2020 2063 6f6e 7374 206c 6162         const lab
+000192d0: 656c 203d 206b 2e6c 656e 6774 6820 3e3d  el = k.length >=
+000192e0: 2032 3020 3f20 6b2e 736c 6963 6528 302c   20 ? k.slice(0,
+000192f0: 2032 3029 202b 2027 e280 a627 203a 206b   20) + '...' : k
+00019300: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00019310: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+00019320: 556e 7368 6966 7420 736f 2074 6861 7420  Unshift so that 
+00019330: 7468 6520 6f72 6465 7269 6e67 206f 6620  the ordering of 
+00019340: 7468 6520 6c61 6265 6c73 2069 7320 7468  the labels is th
+00019350: 6520 7361 6d65 2061 730a 2020 2020 2020  e same as.      
+00019360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019370: 2020 2020 2f2f 2074 6865 206f 7264 6572      // the order
+00019380: 696e 6720 6f66 2074 6865 2073 7461 636b  ing of the stack
+00019390: 6572 732e 0a20 2020 2020 2020 2020 2020  ers..           
+000193a0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000193b0: 6976 732e 756e 7368 6966 7428 0a20 2020  ivs.unshift(.   
+000193c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000193d0: 2020 2020 2020 2020 2027 3c64 6976 3e27           '<div>'
+000193e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000193f0: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+00019400: 2027 3c73 7061 6e20 7374 796c 653d 2266   '<span style="f
+00019410: 6f6e 742d 7765 6967 6874 3a20 626f 6c64  ont-weight: bold
+00019420: 3b20 636f 6c6f 723a 2720 2b20 636f 6c6f  ; color:' + colo
+00019430: 7220 2b20 273b 223e 270a 2020 2020 2020  r + ';">'.      
+00019440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019450: 2020 2020 2020 2020 2020 2b20 6c61 6265            + labe
+00019460: 6c0a 2020 2020 2020 2020 2020 2020 2020  l.              
 00019470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019480: 2020 2020 2020 2020 2020 2b20 273c 2f73            + '</s
-00019490: 7061 6e3e 270a 2020 2020 2020 2020 2020  pan>'.          
-000194a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000194b0: 2020 2020 2b20 273a 2027 0a20 2020 2020      + ': '.     
-000194c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000194d0: 2020 2020 2020 2020 202b 2020 7661 6c2e           +  val.
-000194e0: 746f 4669 7865 6428 3129 0a20 2020 2020  toFixed(1).     
-000194f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019500: 2020 2020 2020 2020 202b 2027 3c2f 6469           + '</di
-00019510: 763e 270a 2020 2020 2020 2020 2020 2020  v>'.            
-00019520: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00019530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019540: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00019550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019560: 2020 2064 6976 732e 756e 7368 6966 7428     divs.unshift(
-00019570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019580: 2020 2020 2020 2020 2020 2027 3c64 6976             '<div
-00019590: 3e27 0a20 2020 2020 2020 2020 2020 2020  >'.             
-000195a0: 2020 2020 2020 2020 2020 2020 2020 202b                 +
-000195b0: 2027 3c73 7061 6e20 7374 796c 653d 2266   '<span style="f
-000195c0: 6f6e 742d 7765 6967 6874 3a20 626f 6c64  ont-weight: bold
-000195d0: 3b20 636f 6c6f 723a 2064 6172 6b67 7265  ; color: darkgre
-000195e0: 793b 223e 6e74 6872 6561 6473 3a20 3c2f  y;">nthreads: </
-000195f0: 7370 616e 3e27 0a20 2020 2020 2020 2020  span>'.         
-00019600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019610: 2020 202b 2073 6f75 7263 652e 6461 7461     + source.data
-00019620: 2e6e 7468 7265 6164 735b 7661 6c75 655d  .nthreads[value]
-00019630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019640: 2020 2020 2020 2020 2020 2020 202b 2027               + '
-00019650: 3c2f 6469 763e 270a 2020 2020 2020 2020  </div>'.        
-00019660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019670: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00019680: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00019690: 6e20 6469 7673 2e6a 6f69 6e28 275c 5c6e  n divs.join('\\n
-000196a0: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-000196b0: 2020 2020 2020 2020 2020 2022 2222 0a20             """. 
-000196c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000196d0: 2020 2025 2064 6963 7428 0a20 2020 2020     % dict(.     
-000196e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000196f0: 2020 207a 6970 2873 7461 636b 6572 732c     zip(stackers,
-00019700: 2063 6f6c 6f72 7329 0a20 2020 2020 2020   colors).       
-00019710: 2020 2020 2020 2020 2020 2020 2029 2c20               ), 
-00019720: 2023 2073 6e65 616b 2074 6865 2063 6f6c   # sneak the col
-00019730: 6f72 206d 6170 7069 6e67 2069 6e74 6f20  or mapping into 
-00019740: 7468 6520 6361 6c6c 6261 636b 0a20 2020  the callback.   
-00019750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019760: 2061 7267 733d 7b22 736f 7572 6365 223a   args={"source":
-00019770: 2073 656c 662e 736f 7572 6365 7d2c 0a20   self.source},. 
-00019780: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00019790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000197a0: 2023 2041 6464 2074 6865 2048 6f76 6572   # Add the Hover
-000197b0: 546f 6f6c 2074 6f20 7468 6520 746f 7020  Tool to the top 
-000197c0: 6c69 6e65 2072 656e 6465 7265 722e 0a20  line renderer.. 
-000197d0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000197e0: 6f70 5f6c 696e 6520 3d20 4e6f 6e65 0a20  op_line = None. 
-000197f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00019800: 6f72 206c 696e 6520 696e 2072 6576 6572  or line in rever
-00019810: 7365 6428 7365 6c66 2e5f 6c69 6e65 5f72  sed(self._line_r
-00019820: 656e 6465 7265 7273 2e76 616c 7565 7328  enderers.values(
-00019830: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-00019840: 2020 2020 2020 2020 6966 206c 696e 652e          if line.
-00019850: 7669 7369 626c 653a 0a20 2020 2020 2020  visible:.       
-00019860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019870: 2074 6f70 5f6c 696e 6520 3d20 6c69 6e65   top_line = line
-00019880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019890: 2020 2020 2020 2020 2062 7265 616b 0a20           break. 
-000198a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000198b0: 656c 662e 5f68 6f76 6572 2e72 656e 6465  elf._hover.rende
-000198c0: 7265 7273 203d 205b 746f 705f 6c69 6e65  rers = [top_line
-000198d0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000198e0: 2020 7365 6c66 2e5f 686f 7665 722e 666f    self._hover.fo
-000198f0: 726d 6174 7465 7273 203d 207b 2224 696e  rmatters = {"$in
-00019900: 6465 7822 3a20 666f 726d 6174 7465 727d  dex": formatter}
-00019910: 0a0a 2020 2020 2020 2020 2020 2020 7365  ..            se
-00019920: 6c66 2e5f 6c61 7374 5f64 7261 776e 203d  lf._last_drawn =
-00019930: 2074 696d 6528 290a 2020 2020 2020 2020   time().        
-00019940: 2020 2020 7365 6c66 2e5f 6c61 7374 5f74      self._last_t
-00019950: 7261 6e73 6974 696f 6e5f 636f 756e 7420  ransition_count 
-00019960: 3d20 7365 6c66 2e73 6368 6564 756c 6572  = self.scheduler
-00019970: 2e74 7261 6e73 6974 696f 6e5f 636f 756e  .transition_coun
-00019980: 7465 720a 2020 2020 2020 2020 656c 6966  ter.        elif
-00019990: 2073 656c 662e 5f73 686f 756c 645f 7570   self._should_up
-000199a0: 6461 7465 2829 3a0a 2020 2020 2020 2020  date():.        
-000199b0: 2020 2020 2320 506f 7373 6962 6c79 2075      # Possibly u
-000199c0: 7064 6174 6520 7468 6520 7920 7261 6e67  pdate the y rang
-000199d0: 6520 6966 206e 6577 2074 6872 6561 6473  e if new threads
-000199e0: 2068 6176 6520 6265 656e 2061 6464 6564   have been added
-000199f0: 0a20 2020 2020 2020 2020 2020 206d 6178  .            max
-00019a00: 5f6e 7468 7265 6164 7320 3d20 6d61 7828  _nthreads = max(
-00019a10: 7365 6c66 2e70 6c75 6769 6e2e 6e74 6872  self.plugin.nthr
-00019a20: 6561 6473 290a 2020 2020 2020 2020 2020  eads).          
-00019a30: 2020 6966 2073 656c 662e 726f 6f74 2e79    if self.root.y
-00019a40: 5f72 616e 6765 2e65 6e64 2021 3d20 6d61  _range.end != ma
-00019a50: 785f 6e74 6872 6561 6473 3a0a 2020 2020  x_nthreads:.    
-00019a60: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00019a70: 2e72 6f6f 742e 795f 7261 6e67 652e 656e  .root.y_range.en
-00019a80: 6420 3d20 6d61 785f 6e74 6872 6561 6473  d = max_nthreads
-00019a90: 0a20 2020 2020 2020 2020 2020 2023 2055  .            # U
-00019aa0: 7064 6174 6520 7468 6520 6461 7461 2c20  pdate the data, 
-00019ab0: 6f6e 6c79 2069 6e63 6c75 6469 6e67 2065  only including e
-00019ac0: 7869 7374 696e 6720 636f 6c75 6d6e 732c  xisting columns,
-00019ad0: 2072 6174 6865 7220 7468 616e 2072 6564   rather than red
-00019ae0: 7261 7769 6e67 0a20 2020 2020 2020 2020  rawing.         
-00019af0: 2020 2023 2074 6865 2077 686f 6c65 2063     # the whole c
-00019b00: 6861 7274 2e0a 2020 2020 2020 2020 2020  hart..          
-00019b10: 2020 7365 6c66 2e73 6f75 7263 652e 6461    self.source.da
-00019b20: 7461 203d 2073 656c 662e 5f67 6574 5f74  ta = self._get_t
-00019b30: 696d 6573 6572 6965 7328 7265 7374 7269  imeseries(restri
-00019b40: 6374 5f74 6f5f 6578 6973 7469 6e67 3d54  ct_to_existing=T
-00019b50: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
-00019b60: 2073 656c 662e 5f6c 6173 745f 7472 616e   self._last_tran
-00019b70: 7369 7469 6f6e 5f63 6f75 6e74 203d 2073  sition_count = s
-00019b80: 656c 662e 7363 6865 6475 6c65 722e 7472  elf.scheduler.tr
-00019b90: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
-00019ba0: 0a0a 0a63 6c61 7373 2054 6173 6b50 726f  ...class TaskPro
-00019bb0: 6772 6573 7328 4461 7368 626f 6172 6443  gress(DashboardC
-00019bc0: 6f6d 706f 6e65 6e74 293a 0a20 2020 2022  omponent):.    "
-00019bd0: 2222 5072 6f67 7265 7373 2062 6172 7320  ""Progress bars 
-00019be0: 7065 7220 7461 736b 2074 7970 6522 2222  per task type"""
-00019bf0: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
-00019c00: 5f5f 2873 656c 662c 2073 6368 6564 756c  __(self, schedul
-00019c10: 6572 2c20 2a2a 6b77 6172 6773 293a 0a20  er, **kwargs):. 
-00019c20: 2020 2020 2020 2073 656c 662e 7363 6865         self.sche
-00019c30: 6475 6c65 7220 3d20 7363 6865 6475 6c65  duler = schedule
-00019c40: 720a 0a20 2020 2020 2020 2064 6174 6120  r..        data 
-00019c50: 3d20 7072 6f67 7265 7373 5f71 7561 6473  = progress_quads
-00019c60: 280a 2020 2020 2020 2020 2020 2020 6469  (.            di
-00019c70: 6374 2861 6c6c 3d7b 7d2c 206d 656d 6f72  ct(all={}, memor
-00019c80: 793d 7b7d 2c20 6572 7265 643d 7b7d 2c20  y={}, erred={}, 
-00019c90: 7265 6c65 6173 6564 3d7b 7d2c 2070 726f  released={}, pro
-00019ca0: 6365 7373 696e 673d 7b7d 2c20 7175 6575  cessing={}, queu
-00019cb0: 6564 3d7b 7d29 0a20 2020 2020 2020 2029  ed={}).        )
-00019cc0: 0a20 2020 2020 2020 2073 656c 662e 736f  .        self.so
-00019cd0: 7572 6365 203d 2043 6f6c 756d 6e44 6174  urce = ColumnDat
-00019ce0: 6153 6f75 7263 6528 6461 7461 3d64 6174  aSource(data=dat
-00019cf0: 6129 0a0a 2020 2020 2020 2020 785f 7261  a)..        x_ra
-00019d00: 6e67 6520 3d20 4461 7461 5261 6e67 6531  nge = DataRange1
-00019d10: 6428 7261 6e67 655f 7061 6464 696e 673d  d(range_padding=
-00019d20: 3029 0a20 2020 2020 2020 2079 5f72 616e  0).        y_ran
-00019d30: 6765 203d 2052 616e 6765 3164 282d 382c  ge = Range1d(-8,
-00019d40: 2030 290a 0a20 2020 2020 2020 2073 656c   0)..        sel
-00019d50: 662e 726f 6f74 203d 2066 6967 7572 6528  f.root = figure(
-00019d60: 0a20 2020 2020 2020 2020 2020 2074 6974  .            tit
-00019d70: 6c65 3d22 5072 6f67 7265 7373 222c 0a20  le="Progress",. 
-00019d80: 2020 2020 2020 2020 2020 206e 616d 653d             name=
-00019d90: 2274 6173 6b5f 7072 6f67 7265 7373 222c  "task_progress",
-00019da0: 0a20 2020 2020 2020 2020 2020 2078 5f72  .            x_r
-00019db0: 616e 6765 3d78 5f72 616e 6765 2c0a 2020  ange=x_range,.  
-00019dc0: 2020 2020 2020 2020 2020 795f 7261 6e67            y_rang
-00019dd0: 653d 795f 7261 6e67 652c 0a20 2020 2020  e=y_range,.     
-00019de0: 2020 2020 2020 2074 6f6f 6c62 6172 5f6c         toolbar_l
-00019df0: 6f63 6174 696f 6e3d 2261 626f 7665 222c  ocation="above",
-00019e00: 0a20 2020 2020 2020 2020 2020 2074 6f6f  .            too
-00019e10: 6c73 3d22 222c 0a20 2020 2020 2020 2020  ls="",.         
-00019e20: 2020 206d 696e 5f62 6f72 6465 725f 626f     min_border_bo
-00019e30: 7474 6f6d 3d35 302c 0a20 2020 2020 2020  ttom=50,.       
-00019e40: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
-00019e50: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00019e60: 2073 656c 662e 726f 6f74 2e6c 696e 6528   self.root.line(
-00019e70: 2020 2320 6a75 7374 2074 6f20 6465 6669    # just to defi
-00019e80: 6e65 2065 6172 6c79 2072 616e 6765 730a  ne early ranges.
-00019e90: 2020 2020 2020 2020 2020 2020 783d 5b30              x=[0
-00019ea0: 2c20 302e 395d 2c20 793d 5b2d 312c 2030  , 0.9], y=[-1, 0
-00019eb0: 5d2c 206c 696e 655f 636f 6c6f 723d 2223  ], line_color="#
-00019ec0: 4646 4646 4646 222c 2061 6c70 6861 3d30  FFFFFF", alpha=0
-00019ed0: 2e30 0a20 2020 2020 2020 2029 0a20 2020  .0.        ).   
-00019ee0: 2020 2020 2073 656c 662e 726f 6f74 2e71       self.root.q
-00019ef0: 7561 6428 0a20 2020 2020 2020 2020 2020  uad(.           
-00019f00: 2073 6f75 7263 653d 7365 6c66 2e73 6f75   source=self.sou
-00019f10: 7263 652c 0a20 2020 2020 2020 2020 2020  rce,.           
-00019f20: 2074 6f70 3d22 746f 7022 2c0a 2020 2020   top="top",.    
-00019f30: 2020 2020 2020 2020 626f 7474 6f6d 3d22          bottom="
-00019f40: 626f 7474 6f6d 222c 0a20 2020 2020 2020  bottom",.       
-00019f50: 2020 2020 206c 6566 743d 226c 6566 7422       left="left"
-00019f60: 2c0a 2020 2020 2020 2020 2020 2020 7269  ,.            ri
-00019f70: 6768 743d 2272 6967 6874 222c 0a20 2020  ght="right",.   
-00019f80: 2020 2020 2020 2020 2066 696c 6c5f 636f           fill_co
-00019f90: 6c6f 723d 2223 6161 6161 6161 222c 0a20  lor="#aaaaaa",. 
-00019fa0: 2020 2020 2020 2020 2020 206c 696e 655f             line_
-00019fb0: 636f 6c6f 723d 2223 6161 6161 6161 222c  color="#aaaaaa",
-00019fc0: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
-00019fd0: 6c5f 616c 7068 613d 302e 312c 0a20 2020  l_alpha=0.1,.   
-00019fe0: 2020 2020 2020 2020 206c 696e 655f 616c           line_al
-00019ff0: 7068 613d 302e 332c 0a20 2020 2020 2020  pha=0.3,.       
-0001a000: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
-0001a010: 726f 6f74 2e71 7561 6428 0a20 2020 2020  root.quad(.     
-0001a020: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
-0001a030: 6c66 2e73 6f75 7263 652c 0a20 2020 2020  lf.source,.     
-0001a040: 2020 2020 2020 2074 6f70 3d22 746f 7022         top="top"
-0001a050: 2c0a 2020 2020 2020 2020 2020 2020 626f  ,.            bo
-0001a060: 7474 6f6d 3d22 626f 7474 6f6d 222c 0a20  ttom="bottom",. 
-0001a070: 2020 2020 2020 2020 2020 206c 6566 743d             left=
-0001a080: 226c 6566 7422 2c0a 2020 2020 2020 2020  "left",.        
-0001a090: 2020 2020 7269 6768 743d 2272 656c 6561      right="relea
-0001a0a0: 7365 642d 6c6f 6322 2c0a 2020 2020 2020  sed-loc",.      
-0001a0b0: 2020 2020 2020 6669 6c6c 5f63 6f6c 6f72        fill_color
-0001a0c0: 3d22 636f 6c6f 7222 2c0a 2020 2020 2020  ="color",.      
-0001a0d0: 2020 2020 2020 6c69 6e65 5f63 6f6c 6f72        line_color
-0001a0e0: 3d22 636f 6c6f 7222 2c0a 2020 2020 2020  ="color",.      
-0001a0f0: 2020 2020 2020 6669 6c6c 5f61 6c70 6861        fill_alpha
-0001a100: 3d30 2e36 2c0a 2020 2020 2020 2020 290a  =0.6,.        ).
-0001a110: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-0001a120: 742e 7175 6164 280a 2020 2020 2020 2020  t.quad(.        
-0001a130: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
-0001a140: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
-0001a150: 2020 2020 746f 703d 2274 6f70 222c 0a20      top="top",. 
-0001a160: 2020 2020 2020 2020 2020 2062 6f74 746f             botto
-0001a170: 6d3d 2262 6f74 746f 6d22 2c0a 2020 2020  m="bottom",.    
-0001a180: 2020 2020 2020 2020 6c65 6674 3d22 7265          left="re
-0001a190: 6c65 6173 6564 2d6c 6f63 222c 0a20 2020  leased-loc",.   
-0001a1a0: 2020 2020 2020 2020 2072 6967 6874 3d22           right="
-0001a1b0: 6d65 6d6f 7279 2d6c 6f63 222c 0a20 2020  memory-loc",.   
-0001a1c0: 2020 2020 2020 2020 2066 696c 6c5f 636f           fill_co
-0001a1d0: 6c6f 723d 2263 6f6c 6f72 222c 0a20 2020  lor="color",.   
-0001a1e0: 2020 2020 2020 2020 206c 696e 655f 636f           line_co
-0001a1f0: 6c6f 723d 2263 6f6c 6f72 222c 0a20 2020  lor="color",.   
-0001a200: 2020 2020 2020 2020 2066 696c 6c5f 616c           fill_al
-0001a210: 7068 613d 312e 302c 0a20 2020 2020 2020  pha=1.0,.       
-0001a220: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
-0001a230: 726f 6f74 2e71 7561 6428 0a20 2020 2020  root.quad(.     
-0001a240: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
-0001a250: 6c66 2e73 6f75 7263 652c 0a20 2020 2020  lf.source,.     
-0001a260: 2020 2020 2020 2074 6f70 3d22 746f 7022         top="top"
-0001a270: 2c0a 2020 2020 2020 2020 2020 2020 626f  ,.            bo
-0001a280: 7474 6f6d 3d22 626f 7474 6f6d 222c 0a20  ttom="bottom",. 
-0001a290: 2020 2020 2020 2020 2020 206c 6566 743d             left=
-0001a2a0: 226d 656d 6f72 792d 6c6f 6322 2c0a 2020  "memory-loc",.  
-0001a2b0: 2020 2020 2020 2020 2020 7269 6768 743d            right=
-0001a2c0: 2265 7272 6564 2d6c 6f63 222c 0a20 2020  "erred-loc",.   
-0001a2d0: 2020 2020 2020 2020 2066 696c 6c5f 636f           fill_co
-0001a2e0: 6c6f 723d 2262 6c61 636b 222c 0a20 2020  lor="black",.   
-0001a2f0: 2020 2020 2020 2020 2066 696c 6c5f 616c           fill_al
-0001a300: 7068 613d 302e 352c 0a20 2020 2020 2020  pha=0.5,.       
-0001a310: 2020 2020 206c 696e 655f 616c 7068 613d       line_alpha=
-0001a320: 302c 0a20 2020 2020 2020 2029 0a20 2020  0,.        ).   
-0001a330: 2020 2020 2073 656c 662e 726f 6f74 2e71       self.root.q
-0001a340: 7561 6428 0a20 2020 2020 2020 2020 2020  uad(.           
-0001a350: 2073 6f75 7263 653d 7365 6c66 2e73 6f75   source=self.sou
-0001a360: 7263 652c 0a20 2020 2020 2020 2020 2020  rce,.           
-0001a370: 2074 6f70 3d22 746f 7022 2c0a 2020 2020   top="top",.    
-0001a380: 2020 2020 2020 2020 626f 7474 6f6d 3d22          bottom="
-0001a390: 626f 7474 6f6d 222c 0a20 2020 2020 2020  bottom",.       
-0001a3a0: 2020 2020 206c 6566 743d 2265 7272 6564       left="erred
-0001a3b0: 2d6c 6f63 222c 0a20 2020 2020 2020 2020  -loc",.         
-0001a3c0: 2020 2072 6967 6874 3d22 7072 6f63 6573     right="proces
-0001a3d0: 7369 6e67 2d6c 6f63 222c 0a20 2020 2020  sing-loc",.     
-0001a3e0: 2020 2020 2020 2066 696c 6c5f 636f 6c6f         fill_colo
-0001a3f0: 723d 2267 7261 7922 2c0a 2020 2020 2020  r="gray",.      
-0001a400: 2020 2020 2020 6669 6c6c 5f61 6c70 6861        fill_alpha
-0001a410: 3d30 2e33 352c 0a20 2020 2020 2020 2020  =0.35,.         
-0001a420: 2020 206c 696e 655f 616c 7068 613d 302c     line_alpha=0,
-0001a430: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0001a440: 2020 2073 656c 662e 726f 6f74 2e71 7561     self.root.qua
-0001a450: 6428 0a20 2020 2020 2020 2020 2020 2073  d(.            s
-0001a460: 6f75 7263 653d 7365 6c66 2e73 6f75 7263  ource=self.sourc
-0001a470: 652c 0a20 2020 2020 2020 2020 2020 2074  e,.            t
-0001a480: 6f70 3d22 746f 7022 2c0a 2020 2020 2020  op="top",.      
-0001a490: 2020 2020 2020 626f 7474 6f6d 3d22 626f        bottom="bo
-0001a4a0: 7474 6f6d 222c 0a20 2020 2020 2020 2020  ttom",.         
-0001a4b0: 2020 206c 6566 743d 2270 726f 6365 7373     left="process
-0001a4c0: 696e 672d 6c6f 6322 2c0a 2020 2020 2020  ing-loc",.      
-0001a4d0: 2020 2020 2020 7269 6768 743d 2271 7565        right="que
-0001a4e0: 7565 642d 6c6f 6322 2c0a 2020 2020 2020  ued-loc",.      
-0001a4f0: 2020 2020 2020 6669 6c6c 5f63 6f6c 6f72        fill_color
-0001a500: 3d22 6772 6179 222c 0a20 2020 2020 2020  ="gray",.       
-0001a510: 2020 2020 2068 6174 6368 5f70 6174 7465       hatch_patte
-0001a520: 726e 3d22 2f22 2c0a 2020 2020 2020 2020  rn="/",.        
-0001a530: 2020 2020 6861 7463 685f 636f 6c6f 723d      hatch_color=
-0001a540: 2277 6869 7465 222c 0a20 2020 2020 2020  "white",.       
-0001a550: 2020 2020 2066 696c 6c5f 616c 7068 613d       fill_alpha=
-0001a560: 302e 3335 2c0a 2020 2020 2020 2020 2020  0.35,.          
-0001a570: 2020 6c69 6e65 5f61 6c70 6861 3d30 2c0a    line_alpha=0,.
-0001a580: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001a590: 2020 7365 6c66 2e72 6f6f 742e 7175 6164    self.root.quad
-0001a5a0: 280a 2020 2020 2020 2020 2020 2020 736f  (.            so
-0001a5b0: 7572 6365 3d73 656c 662e 736f 7572 6365  urce=self.source
-0001a5c0: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
-0001a5d0: 703d 2274 6f70 222c 0a20 2020 2020 2020  p="top",.       
-0001a5e0: 2020 2020 2062 6f74 746f 6d3d 2262 6f74       bottom="bot
-0001a5f0: 746f 6d22 2c0a 2020 2020 2020 2020 2020  tom",.          
-0001a600: 2020 6c65 6674 3d22 7175 6575 6564 2d6c    left="queued-l
-0001a610: 6f63 222c 0a20 2020 2020 2020 2020 2020  oc",.           
-0001a620: 2072 6967 6874 3d22 6e6f 2d77 6f72 6b65   right="no-worke
-0001a630: 722d 6c6f 6322 2c0a 2020 2020 2020 2020  r-loc",.        
-0001a640: 2020 2020 6669 6c6c 5f63 6f6c 6f72 3d22      fill_color="
-0001a650: 7265 6422 2c0a 2020 2020 2020 2020 2020  red",.          
-0001a660: 2020 6861 7463 685f 7061 7474 6572 6e3d    hatch_pattern=
-0001a670: 222f 222c 0a20 2020 2020 2020 2020 2020  "/",.           
-0001a680: 2068 6174 6368 5f63 6f6c 6f72 3d22 626c   hatch_color="bl
-0001a690: 6163 6b22 2c0a 2020 2020 2020 2020 2020  ack",.          
-0001a6a0: 2020 6669 6c6c 5f61 6c70 6861 3d30 2e33    fill_alpha=0.3
-0001a6b0: 352c 0a20 2020 2020 2020 2020 2020 206c  5,.            l
-0001a6c0: 696e 655f 616c 7068 613d 302c 0a20 2020  ine_alpha=0,.   
-0001a6d0: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
-0001a6e0: 656c 662e 726f 6f74 2e74 6578 7428 0a20  elf.root.text(. 
-0001a6f0: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
-0001a700: 653d 7365 6c66 2e73 6f75 7263 652c 0a20  e=self.source,. 
-0001a710: 2020 2020 2020 2020 2020 2074 6578 743d             text=
-0001a720: 2273 686f 772d 6e61 6d65 222c 0a20 2020  "show-name",.   
-0001a730: 2020 2020 2020 2020 2079 3d22 626f 7474           y="bott
-0001a740: 6f6d 222c 0a20 2020 2020 2020 2020 2020  om",.           
-0001a750: 2078 3d22 6c65 6674 222c 0a20 2020 2020   x="left",.     
-0001a760: 2020 2020 2020 2078 5f6f 6666 7365 743d         x_offset=
-0001a770: 352c 0a20 2020 2020 2020 2020 2020 2074  5,.            t
-0001a780: 6578 745f 666f 6e74 5f73 697a 653d 7661  ext_font_size=va
-0001a790: 6c75 6528 2231 3070 7422 292c 0a20 2020  lue("10pt"),.   
-0001a7a0: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
-0001a7b0: 656c 662e 726f 6f74 2e74 6578 7428 0a20  elf.root.text(. 
-0001a7c0: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
-0001a7d0: 653d 7365 6c66 2e73 6f75 7263 652c 0a20  e=self.source,. 
-0001a7e0: 2020 2020 2020 2020 2020 2074 6578 743d             text=
-0001a7f0: 2264 6f6e 6522 2c0a 2020 2020 2020 2020  "done",.        
-0001a800: 2020 2020 793d 2262 6f74 746f 6d22 2c0a      y="bottom",.
-0001a810: 2020 2020 2020 2020 2020 2020 783d 2272              x="r
-0001a820: 6967 6874 222c 0a20 2020 2020 2020 2020  ight",.         
-0001a830: 2020 2078 5f6f 6666 7365 743d 2d35 2c0a     x_offset=-5,.
-0001a840: 2020 2020 2020 2020 2020 2020 7465 7874              text
-0001a850: 5f61 6c69 676e 3d22 7269 6768 7422 2c0a  _align="right",.
-0001a860: 2020 2020 2020 2020 2020 2020 7465 7874              text
-0001a870: 5f66 6f6e 745f 7369 7a65 3d76 616c 7565  _font_size=value
-0001a880: 2822 3130 7074 2229 2c0a 2020 2020 2020  ("10pt"),.      
-0001a890: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
-0001a8a0: 2e72 6f6f 742e 7967 7269 642e 7669 7369  .root.ygrid.visi
-0001a8b0: 626c 6520 3d20 4661 6c73 650a 2020 2020  ble = False.    
-0001a8c0: 2020 2020 7365 6c66 2e72 6f6f 742e 7961      self.root.ya
-0001a8d0: 7869 732e 6d69 6e6f 725f 7469 636b 5f6c  xis.minor_tick_l
-0001a8e0: 696e 655f 616c 7068 6120 3d20 300a 2020  ine_alpha = 0.  
-0001a8f0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-0001a900: 7961 7869 732e 7669 7369 626c 6520 3d20  yaxis.visible = 
-0001a910: 4661 6c73 650a 2020 2020 2020 2020 7365  False.        se
-0001a920: 6c66 2e72 6f6f 742e 7867 7269 642e 7669  lf.root.xgrid.vi
-0001a930: 7369 626c 6520 3d20 4661 6c73 650a 2020  sible = False.  
-0001a940: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-0001a950: 7861 7869 732e 6d69 6e6f 725f 7469 636b  xaxis.minor_tick
-0001a960: 5f6c 696e 655f 616c 7068 6120 3d20 300a  _line_alpha = 0.
-0001a970: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-0001a980: 742e 7861 7869 732e 7669 7369 626c 6520  t.xaxis.visible 
-0001a990: 3d20 4661 6c73 650a 0a20 2020 2020 2020  = False..       
-0001a9a0: 2068 6f76 6572 203d 2048 6f76 6572 546f   hover = HoverTo
-0001a9b0: 6f6c 280a 2020 2020 2020 2020 2020 2020  ol(.            
-0001a9c0: 706f 696e 745f 706f 6c69 6379 3d22 666f  point_policy="fo
-0001a9d0: 6c6c 6f77 5f6d 6f75 7365 222c 0a20 2020  llow_mouse",.   
-0001a9e0: 2020 2020 2020 2020 2074 6f6f 6c74 6970           tooltip
-0001a9f0: 733d 2222 220a 2020 2020 2020 2020 2020  s=""".          
-0001aa00: 2020 2020 2020 3c64 6976 3e0a 2020 2020        <div>.    
-0001aa10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aa20: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
-0001aa30: 742d 7369 7a65 3a20 3134 7078 3b20 666f  t-size: 14px; fo
-0001aa40: 6e74 2d77 6569 6768 743a 2062 6f6c 643b  nt-weight: bold;
-0001aa50: 223e 4e61 6d65 3a3c 2f73 7061 6e3e 266e  ">Name:</span>&n
-0001aa60: 6273 703b 0a20 2020 2020 2020 2020 2020  bsp;.           
-0001aa70: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
-0001aa80: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
-0001aa90: 2031 3070 783b 2066 6f6e 742d 6661 6d69   10px; font-fami
-0001aaa0: 6c79 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f  ly: Monaco, mono
-0001aab0: 7370 6163 653b 223e 406e 616d 653c 2f73  space;">@name</s
-0001aac0: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
-0001aad0: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
-0001aae0: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
-0001aaf0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-0001ab00: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
-0001ab10: 653d 2266 6f6e 742d 7369 7a65 3a20 3134  e="font-size: 14
-0001ab20: 7078 3b20 666f 6e74 2d77 6569 6768 743a  px; font-weight:
-0001ab30: 2062 6f6c 643b 223e 416c 6c3a 3c2f 7370   bold;">All:</sp
-0001ab40: 616e 3e26 6e62 7370 3b0a 2020 2020 2020  an>&nbsp;.      
-0001ab50: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
-0001ab60: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
-0001ab70: 7369 7a65 3a20 3130 7078 3b20 666f 6e74  size: 10px; font
-0001ab80: 2d66 616d 696c 793a 204d 6f6e 6163 6f2c  -family: Monaco,
-0001ab90: 206d 6f6e 6f73 7061 6365 3b22 3e40 616c   monospace;">@al
-0001aba0: 6c3c 2f73 7061 6e3e 0a20 2020 2020 2020  l</span>.       
-0001abb0: 2020 2020 2020 2020 203c 2f64 6976 3e0a           </div>.
-0001abc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001abd0: 3c64 6976 3e0a 2020 2020 2020 2020 2020  <div>.          
-0001abe0: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
-0001abf0: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
-0001ac00: 3a20 3134 7078 3b20 666f 6e74 2d77 6569  : 14px; font-wei
-0001ac10: 6768 743a 2062 6f6c 643b 223e 5175 6575  ght: bold;">Queu
-0001ac20: 6564 3a3c 2f73 7061 6e3e 266e 6273 703b  ed:</span>&nbsp;
-0001ac30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ac40: 2020 2020 203c 7370 616e 2073 7479 6c65       <span style
-0001ac50: 3d22 666f 6e74 2d73 697a 653a 2031 3070  ="font-size: 10p
-0001ac60: 783b 2066 6f6e 742d 6661 6d69 6c79 3a20  x; font-family: 
-0001ac70: 4d6f 6e61 636f 2c20 6d6f 6e6f 7370 6163  Monaco, monospac
-0001ac80: 653b 223e 4071 7565 7565 643c 2f73 7061  e;">@queued</spa
-0001ac90: 6e3e 0a20 2020 2020 2020 2020 2020 2020  n>.             
-0001aca0: 2020 203c 2f64 6976 3e0a 2020 2020 2020     </div>.      
-0001acb0: 2020 2020 2020 2020 2020 3c64 6976 3e0a            <div>.
-0001acc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001acd0: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
-0001ace0: 2266 6f6e 742d 7369 7a65 3a20 3134 7078  "font-size: 14px
-0001acf0: 3b20 666f 6e74 2d77 6569 6768 743a 2062  ; font-weight: b
-0001ad00: 6f6c 643b 223e 4e6f 2d77 6f72 6b65 723a  old;">No-worker:
-0001ad10: 3c2f 7370 616e 3e26 6e62 7370 3b0a 2020  </span>&nbsp;.  
-0001ad20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ad30: 2020 3c73 7061 6e20 7374 796c 653d 2266    <span style="f
-0001ad40: 6f6e 742d 7369 7a65 3a20 3130 7078 3b20  ont-size: 10px; 
-0001ad50: 666f 6e74 2d66 616d 696c 793a 204d 6f6e  font-family: Mon
-0001ad60: 6163 6f2c 206d 6f6e 6f73 7061 6365 3b22  aco, monospace;"
-0001ad70: 3e40 6e6f 5f77 6f72 6b65 723c 2f73 7061  >@no_worker</spa
-0001ad80: 6e3e 0a20 2020 2020 2020 2020 2020 2020  n>.             
-0001ad90: 2020 203c 2f64 6976 3e0a 2020 2020 2020     </div>.      
-0001ada0: 2020 2020 2020 2020 2020 3c64 6976 3e0a            <div>.
-0001adb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001adc0: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
-0001add0: 2266 6f6e 742d 7369 7a65 3a20 3134 7078  "font-size: 14px
-0001ade0: 3b20 666f 6e74 2d77 6569 6768 743a 2062  ; font-weight: b
-0001adf0: 6f6c 643b 223e 5072 6f63 6573 7369 6e67  old;">Processing
-0001ae00: 3a3c 2f73 7061 6e3e 266e 6273 703b 0a20  :</span>&nbsp;. 
-0001ae10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ae20: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
-0001ae30: 666f 6e74 2d73 697a 653a 2031 3070 783b  font-size: 10px;
-0001ae40: 2066 6f6e 742d 6661 6d69 6c79 3a20 4d6f   font-family: Mo
-0001ae50: 6e61 636f 2c20 6d6f 6e6f 7370 6163 653b  naco, monospace;
-0001ae60: 223e 4070 726f 6365 7373 696e 673c 2f73  ">@processing</s
-0001ae70: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
-0001ae80: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
-0001ae90: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
-0001aea0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-0001aeb0: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
-0001aec0: 653d 2266 6f6e 742d 7369 7a65 3a20 3134  e="font-size: 14
-0001aed0: 7078 3b20 666f 6e74 2d77 6569 6768 743a  px; font-weight:
-0001aee0: 2062 6f6c 643b 223e 4d65 6d6f 7279 3a3c   bold;">Memory:<
-0001aef0: 2f73 7061 6e3e 266e 6273 703b 0a20 2020  /span>&nbsp;.   
-0001af00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001af10: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
-0001af20: 6e74 2d73 697a 653a 2031 3070 783b 2066  nt-size: 10px; f
-0001af30: 6f6e 742d 6661 6d69 6c79 3a20 4d6f 6e61  ont-family: Mona
-0001af40: 636f 2c20 6d6f 6e6f 7370 6163 653b 223e  co, monospace;">
-0001af50: 406d 656d 6f72 793c 2f73 7061 6e3e 0a20  @memory</span>. 
-0001af60: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-0001af70: 2f64 6976 3e0a 2020 2020 2020 2020 2020  /div>.          
-0001af80: 2020 2020 2020 3c64 6976 3e0a 2020 2020        <div>.    
-0001af90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001afa0: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
-0001afb0: 742d 7369 7a65 3a20 3134 7078 3b20 666f  t-size: 14px; fo
-0001afc0: 6e74 2d77 6569 6768 743a 2062 6f6c 643b  nt-weight: bold;
-0001afd0: 223e 4572 7265 643a 3c2f 7370 616e 3e26  ">Erred:</span>&
-0001afe0: 6e62 7370 3b0a 2020 2020 2020 2020 2020  nbsp;.          
-0001aff0: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
-0001b000: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
-0001b010: 3a20 3130 7078 3b20 666f 6e74 2d66 616d  : 10px; font-fam
-0001b020: 696c 793a 204d 6f6e 6163 6f2c 206d 6f6e  ily: Monaco, mon
-0001b030: 6f73 7061 6365 3b22 3e40 6572 7265 643c  ospace;">@erred<
-0001b040: 2f73 7061 6e3e 0a20 2020 2020 2020 2020  /span>.         
-0001b050: 2020 2020 2020 203c 2f64 6976 3e0a 2020         </div>.  
-0001b060: 2020 2020 2020 2020 2020 2020 2020 2222                ""
-0001b070: 222c 0a20 2020 2020 2020 2029 0a20 2020  ",.        ).   
-0001b080: 2020 2020 2068 656c 705f 203d 2048 656c       help_ = Hel
-0001b090: 7054 6f6f 6c28 0a20 2020 2020 2020 2020  pTool(.         
-0001b0a0: 2020 2072 6564 6972 6563 743d 2268 7474     redirect="htt
-0001b0b0: 7073 3a2f 2f64 6f63 732e 6461 736b 2e6f  ps://docs.dask.o
-0001b0c0: 7267 2f65 6e2f 7374 6162 6c65 2f64 6173  rg/en/stable/das
-0001b0d0: 6862 6f61 7264 2e68 746d 6c23 7072 6f67  hboard.html#prog
-0001b0e0: 7265 7373 222c 0a20 2020 2020 2020 2020  ress",.         
-0001b0f0: 2020 2064 6573 6372 6970 7469 6f6e 3d22     description="
-0001b100: 4120 6465 7363 7269 7074 696f 6e20 6f66  A description of
-0001b110: 2074 6865 2070 726f 6772 6573 7320 6261   the progress ba
-0001b120: 7273 2070 6c6f 742e 222c 0a20 2020 2020  rs plot.",.     
-0001b130: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
-0001b140: 662e 726f 6f74 2e61 6464 5f74 6f6f 6c73  f.root.add_tools
-0001b150: 2868 6f76 6572 2c20 6865 6c70 5f29 0a0a  (hover, help_)..
-0001b160: 2020 2020 4077 6974 686f 7574 5f70 726f      @without_pro
-0001b170: 7065 7274 795f 7661 6c69 6461 7469 6f6e  perty_validation
-0001b180: 0a20 2020 2040 6c6f 675f 6572 726f 7273  .    @log_errors
-0001b190: 0a20 2020 2064 6566 2075 7064 6174 6528  .    def update(
-0001b1a0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
-0001b1b0: 7461 7465 203d 207b 0a20 2020 2020 2020  tate = {.       
-0001b1c0: 2020 2020 2022 6d65 6d6f 7279 223a 207b       "memory": {
-0001b1d0: 7d2c 0a20 2020 2020 2020 2020 2020 2022  },.            "
-0001b1e0: 6572 7265 6422 3a20 7b7d 2c0a 2020 2020  erred": {},.    
-0001b1f0: 2020 2020 2020 2020 2272 656c 6561 7365          "release
-0001b200: 6422 3a20 7b7d 2c0a 2020 2020 2020 2020  d": {},.        
-0001b210: 2020 2020 2270 726f 6365 7373 696e 6722      "processing"
-0001b220: 3a20 7b7d 2c0a 2020 2020 2020 2020 2020  : {},.          
-0001b230: 2020 2277 6169 7469 6e67 223a 207b 7d2c    "waiting": {},
-0001b240: 0a20 2020 2020 2020 2020 2020 2022 7175  .            "qu
-0001b250: 6575 6564 223a 207b 7d2c 0a20 2020 2020  eued": {},.     
-0001b260: 2020 2020 2020 2022 6e6f 5f77 6f72 6b65         "no_worke
-0001b270: 7222 3a20 7b7d 2c0a 2020 2020 2020 2020  r": {},.        
-0001b280: 7d0a 0a20 2020 2020 2020 2066 6f72 2074  }..        for t
-0001b290: 7020 696e 2073 656c 662e 7363 6865 6475  p in self.schedu
-0001b2a0: 6c65 722e 7461 736b 5f70 7265 6669 7865  ler.task_prefixe
-0001b2b0: 732e 7661 6c75 6573 2829 3a0a 2020 2020  s.values():.    
-0001b2c0: 2020 2020 2020 2020 6163 7469 7665 5f73          active_s
-0001b2d0: 7461 7465 7320 3d20 7470 2e61 6374 6976  tates = tp.activ
-0001b2e0: 655f 7374 6174 6573 0a20 2020 2020 2020  e_states.       
-0001b2f0: 2020 2020 2069 6620 616e 7928 6163 7469       if any(acti
-0001b300: 7665 5f73 7461 7465 732e 6765 7428 7329  ve_states.get(s)
-0001b310: 2066 6f72 2073 2069 6e20 7374 6174 652e   for s in state.
-0001b320: 6b65 7973 2829 293a 0a20 2020 2020 2020  keys()):.       
-0001b330: 2020 2020 2020 2020 2073 7461 7465 5b22           state["
-0001b340: 6d65 6d6f 7279 225d 5b74 702e 6e61 6d65  memory"][tp.name
-0001b350: 5d20 3d20 6163 7469 7665 5f73 7461 7465  ] = active_state
-0001b360: 735b 226d 656d 6f72 7922 5d0a 2020 2020  s["memory"].    
-0001b370: 2020 2020 2020 2020 2020 2020 7374 6174              stat
-0001b380: 655b 2265 7272 6564 225d 5b74 702e 6e61  e["erred"][tp.na
-0001b390: 6d65 5d20 3d20 6163 7469 7665 5f73 7461  me] = active_sta
-0001b3a0: 7465 735b 2265 7272 6564 225d 0a20 2020  tes["erred"].   
-0001b3b0: 2020 2020 2020 2020 2020 2020 2073 7461               sta
-0001b3c0: 7465 5b22 7265 6c65 6173 6564 225d 5b74  te["released"][t
-0001b3d0: 702e 6e61 6d65 5d20 3d20 6163 7469 7665  p.name] = active
-0001b3e0: 5f73 7461 7465 735b 2272 656c 6561 7365  _states["release
-0001b3f0: 6422 5d0a 2020 2020 2020 2020 2020 2020  d"].            
-0001b400: 2020 2020 7374 6174 655b 2270 726f 6365      state["proce
-0001b410: 7373 696e 6722 5d5b 7470 2e6e 616d 655d  ssing"][tp.name]
-0001b420: 203d 2061 6374 6976 655f 7374 6174 6573   = active_states
-0001b430: 5b22 7072 6f63 6573 7369 6e67 225d 0a20  ["processing"]. 
-0001b440: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001b450: 7461 7465 5b22 7761 6974 696e 6722 5d5b  tate["waiting"][
-0001b460: 7470 2e6e 616d 655d 203d 2061 6374 6976  tp.name] = activ
-0001b470: 655f 7374 6174 6573 5b22 7761 6974 696e  e_states["waitin
-0001b480: 6722 5d0a 2020 2020 2020 2020 2020 2020  g"].            
-0001b490: 2020 2020 7374 6174 655b 2271 7565 7565      state["queue
-0001b4a0: 6422 5d5b 7470 2e6e 616d 655d 203d 2061  d"][tp.name] = a
-0001b4b0: 6374 6976 655f 7374 6174 6573 5b22 7175  ctive_states["qu
-0001b4c0: 6575 6564 225d 0a20 2020 2020 2020 2020  eued"].         
-0001b4d0: 2020 2020 2020 2073 7461 7465 5b22 6e6f         state["no
-0001b4e0: 5f77 6f72 6b65 7222 5d5b 7470 2e6e 616d  _worker"][tp.nam
-0001b4f0: 655d 203d 2061 6374 6976 655f 7374 6174  e] = active_stat
-0001b500: 6573 5b22 6e6f 2d77 6f72 6b65 7222 5d0a  es["no-worker"].
-0001b510: 0a20 2020 2020 2020 2073 7461 7465 5b22  .        state["
-0001b520: 616c 6c22 5d20 3d20 7b6b 3a20 7375 6d28  all"] = {k: sum(
-0001b530: 765b 6b5d 2066 6f72 2076 2069 6e20 7374  v[k] for v in st
-0001b540: 6174 652e 7661 6c75 6573 2829 2920 666f  ate.values()) fo
-0001b550: 7220 6b20 696e 2073 7461 7465 5b22 6d65  r k in state["me
-0001b560: 6d6f 7279 225d 7d0a 0a20 2020 2020 2020  mory"]}..       
-0001b570: 2069 6620 6e6f 7420 7374 6174 655b 2261   if not state["a
-0001b580: 6c6c 225d 2061 6e64 206e 6f74 206c 656e  ll"] and not len
-0001b590: 2873 656c 662e 736f 7572 6365 2e64 6174  (self.source.dat
-0001b5a0: 615b 2261 6c6c 225d 293a 0a20 2020 2020  a["all"]):.     
-0001b5b0: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
-0001b5c0: 2020 2020 2020 2064 203d 2070 726f 6772         d = progr
-0001b5d0: 6573 735f 7175 6164 7328 7374 6174 6529  ess_quads(state)
-0001b5e0: 0a0a 2020 2020 2020 2020 7570 6461 7465  ..        update
-0001b5f0: 2873 656c 662e 736f 7572 6365 2c20 6429  (self.source, d)
-0001b600: 0a0a 2020 2020 2020 2020 746f 7461 6c73  ..        totals
-0001b610: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-0001b620: 206b 3a20 7375 6d28 7374 6174 655b 6b5d   k: sum(state[k]
-0001b630: 2e76 616c 7565 7328 2929 0a20 2020 2020  .values()).     
-0001b640: 2020 2020 2020 2066 6f72 206b 2069 6e20         for k in 
-0001b650: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-0001b660: 2020 2261 6c6c 222c 0a20 2020 2020 2020    "all",.       
-0001b670: 2020 2020 2020 2020 2022 6d65 6d6f 7279           "memory
-0001b680: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0001b690: 2020 2022 6572 7265 6422 2c0a 2020 2020     "erred",.    
-0001b6a0: 2020 2020 2020 2020 2020 2020 2272 656c              "rel
-0001b6b0: 6561 7365 6422 2c0a 2020 2020 2020 2020  eased",.        
-0001b6c0: 2020 2020 2020 2020 2277 6169 7469 6e67          "waiting
-0001b6d0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0001b6e0: 2020 2022 7175 6575 6564 222c 0a20 2020     "queued",.   
-0001b6f0: 2020 2020 2020 2020 2020 2020 2022 6e6f               "no
-0001b700: 5f77 6f72 6b65 7222 2c0a 2020 2020 2020  _worker",.      
-0001b710: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
-0001b720: 7d0a 2020 2020 2020 2020 746f 7461 6c73  }.        totals
-0001b730: 5b22 7072 6f63 6573 7369 6e67 225d 203d  ["processing"] =
-0001b740: 2074 6f74 616c 735b 2261 6c6c 225d 202d   totals["all"] -
-0001b750: 2073 756d 280a 2020 2020 2020 2020 2020   sum(.          
-0001b760: 2020 7620 666f 7220 6b2c 2076 2069 6e20    v for k, v in 
-0001b770: 746f 7461 6c73 2e69 7465 6d73 2829 2069  totals.items() i
-0001b780: 6620 6b20 213d 2022 616c 6c22 0a20 2020  f k != "all".   
-0001b790: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0001b7a0: 7365 6c66 2e72 6f6f 742e 7469 746c 652e  self.root.title.
-0001b7b0: 7465 7874 203d 2028 0a20 2020 2020 2020  text = (.       
-0001b7c0: 2020 2020 2022 5072 6f67 7265 7373 202d       "Progress -
-0001b7d0: 2d20 746f 7461 6c3a 2025 2861 6c6c 2973  - total: %(all)s
-0001b7e0: 2c20 220a 2020 2020 2020 2020 2020 2020  , ".            
-0001b7f0: 2277 6169 7469 6e67 3a20 2528 7761 6974  "waiting: %(wait
-0001b800: 696e 6729 732c 2022 0a20 2020 2020 2020  ing)s, ".       
-0001b810: 2020 2020 2022 7175 6575 6564 3a20 2528       "queued: %(
-0001b820: 7175 6575 6564 2973 2c20 220a 2020 2020  queued)s, ".    
-0001b830: 2020 2020 2020 2020 2270 726f 6365 7373          "process
-0001b840: 696e 673a 2025 2870 726f 6365 7373 696e  ing: %(processin
-0001b850: 6729 732c 2022 0a20 2020 2020 2020 2020  g)s, ".         
-0001b860: 2020 2022 696e 2d6d 656d 6f72 793a 2025     "in-memory: %
-0001b870: 286d 656d 6f72 7929 732c 2022 0a20 2020  (memory)s, ".   
-0001b880: 2020 2020 2020 2020 2022 6e6f 2d77 6f72           "no-wor
-0001b890: 6b65 723a 2025 286e 6f5f 776f 726b 6572  ker: %(no_worker
-0001b8a0: 2973 2c20 220a 2020 2020 2020 2020 2020  )s, ".          
-0001b8b0: 2020 2265 7272 6564 3a20 2528 6572 7265    "erred: %(erre
-0001b8c0: 6429 7322 2025 2074 6f74 616c 730a 2020  d)s" % totals.  
-0001b8d0: 2020 2020 2020 290a 0a0a 636c 6173 7320        )...class 
-0001b8e0: 4669 6e65 5065 7266 6f72 6d61 6e63 654d  FinePerformanceM
-0001b8f0: 6574 7269 6373 2844 6173 6862 6f61 7264  etrics(Dashboard
-0001b900: 436f 6d70 6f6e 656e 7429 3a0a 2020 2020  Component):.    
-0001b910: 2222 220a 2020 2020 5468 6520 6d61 696e  """.    The main
-0001b920: 206f 7665 7276 6965 7720 6f66 2074 6865   overview of the
-0001b930: 2046 696e 6520 5065 7266 6f72 6d61 6e63   Fine Performanc
-0001b940: 6520 4d65 7472 6963 7320 7061 6765 2e0a  e Metrics page..
-0001b950: 2020 2020 2222 220a 0a20 2020 2040 6c6f      """..    @lo
-0001b960: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
-0001b970: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-0001b980: 7363 6865 6475 6c65 722c 202a 2a6b 7761  scheduler, **kwa
-0001b990: 7267 7329 3a0a 2020 2020 2020 2020 7365  rgs):.        se
-0001b9a0: 6c66 2e73 6368 6564 756c 6572 203d 2073  lf.scheduler = s
-0001b9b0: 6368 6564 756c 6572 0a20 2020 2020 2020  cheduler.       
-0001b9c0: 2073 656c 662e 7365 6e64 6461 7461 203d   self.senddata =
-0001b9d0: 2064 6566 6175 6c74 6469 6374 286c 6973   defaultdict(lis
-0001b9e0: 7429 0a20 2020 2020 2020 2073 656c 662e  t).        self.
-0001b9f0: 7365 6e64 7372 6320 3d20 436f 6c75 6d6e  sendsrc = Column
-0001ba00: 4461 7461 536f 7572 6365 2864 6174 613d  DataSource(data=
-0001ba10: 6469 6374 2829 290a 2020 2020 2020 2020  dict()).        
-0001ba20: 7365 6c66 2e74 6173 6b5f 6578 6563 5f64  self.task_exec_d
-0001ba30: 6174 6120 3d20 6465 6661 756c 7464 6963  ata = defaultdic
-0001ba40: 7428 6c69 7374 290a 2020 2020 2020 2020  t(list).        
-0001ba50: 7365 6c66 2e74 6173 6b5f 6578 6563 5f64  self.task_exec_d
-0001ba60: 6174 615f 6c69 6d69 7465 6420 3d20 6465  ata_limited = de
-0001ba70: 6661 756c 7464 6963 7428 6c69 7374 290a  faultdict(list).
-0001ba80: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
-0001ba90: 6b5f 6578 6563 5f62 795f 7072 6566 6978  k_exec_by_prefix
-0001baa0: 5f73 7263 203d 2043 6f6c 756d 6e44 6174  _src = ColumnDat
-0001bab0: 6153 6f75 7263 6528 6461 7461 3d64 6963  aSource(data=dic
-0001bac0: 7428 2929 0a20 2020 2020 2020 2073 656c  t()).        sel
-0001bad0: 662e 7461 736b 5f65 7865 635f 6279 5f61  f.task_exec_by_a
-0001bae0: 6374 6976 6974 795f 7372 6320 3d20 436f  ctivity_src = Co
-0001baf0: 6c75 6d6e 4461 7461 536f 7572 6365 2864  lumnDataSource(d
-0001bb00: 6174 613d 6469 6374 2829 290a 2020 2020  ata=dict()).    
-0001bb10: 2020 2020 7365 6c66 2e73 7562 7374 616e      self.substan
-0001bb20: 7469 616c 5f63 6861 6e67 6520 3d20 4661  tial_change = Fa
-0001bb30: 6c73 650a 2020 2020 2020 2020 7365 6c66  lse.        self
-0001bb40: 2e74 6173 6b5f 6163 7469 7669 7469 6573  .task_activities
-0001bb50: 203d 205b 5d0a 2020 2020 2020 2020 7365   = [].        se
-0001bb60: 6c66 2e69 6e69 745f 726f 6f74 2829 0a0a  lf.init_root()..
-0001bb70: 2020 2020 6465 6620 696e 6974 5f72 6f6f      def init_roo
-0001bb80: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
-0001bb90: 2064 6566 2068 616e 646c 655f 7365 6c65   def handle_sele
-0001bba0: 6374 6f72 5f63 686e 6728 6174 7472 2c20  ctor_chng(attr, 
-0001bbb0: 6f6c 642c 206e 6577 293a 0a20 2020 2020  old, new):.     
-0001bbc0: 2020 2020 2020 2073 656c 662e 756e 6974         self.unit
-0001bbd0: 5f73 656c 6563 7465 6420 3d20 6e65 770a  _selected = new.
-0001bbe0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001bbf0: 2e73 7562 7374 616e 7469 616c 5f63 6861  .substantial_cha
-0001bc00: 6e67 6520 3d20 5472 7565 0a0a 2020 2020  nge = True..    
-0001bc10: 2020 2020 7365 6c66 2e66 756e 6374 696f      self.functio
-0001bc20: 6e5f 7365 6c65 6374 6f72 203d 204d 756c  n_selector = Mul
-0001bc30: 7469 4368 6f69 6365 2876 616c 7565 3d5b  tiChoice(value=[
-0001bc40: 5d2c 206f 7074 696f 6e73 3d5b 5d29 0a20  ], options=[]). 
-0001bc50: 2020 2020 2020 2073 656c 662e 6675 6e63         self.func
-0001bc60: 7469 6f6e 5f73 656c 6563 746f 722e 706c  tion_selector.pl
-0001bc70: 6163 6568 6f6c 6465 7220 3d20 2253 656c  aceholder = "Sel
-0001bc80: 6563 7420 7370 6563 6966 6963 2066 756e  ect specific fun
-0001bc90: 6374 696f 6e73 220a 2020 2020 2020 2020  ctions".        
-0001bca0: 7365 6c66 2e75 6e69 745f 7365 6c65 6374  self.unit_select
-0001bcb0: 6f72 203d 2053 656c 6563 7428 7469 746c  or = Select(titl
-0001bcc0: 653d 2255 6e69 7420 7365 6c65 6374 696f  e="Unit selectio
-0001bcd0: 6e22 2c20 6f70 7469 6f6e 733d 5b22 7365  n", options=["se
-0001bce0: 636f 6e64 7322 5d29 0a20 2020 2020 2020  conds"]).       
-0001bcf0: 2073 656c 662e 756e 6974 5f73 656c 6563   self.unit_selec
-0001bd00: 746f 722e 6f6e 5f63 6861 6e67 6528 2276  tor.on_change("v
-0001bd10: 616c 7565 222c 2068 616e 646c 655f 7365  alue", handle_se
-0001bd20: 6c65 6374 6f72 5f63 686e 6729 0a20 2020  lector_chng).   
-0001bd30: 2020 2020 2073 656c 662e 756e 6974 5f73       self.unit_s
-0001bd40: 656c 6563 7465 6420 3d20 2273 6563 6f6e  elected = "secon
-0001bd50: 6473 220a 2020 2020 2020 2020 7365 6c66  ds".        self
-0001bd60: 2e74 6173 6b5f 6578 6563 5f62 795f 6163  .task_exec_by_ac
-0001bd70: 7469 7669 7479 5f63 6861 7274 203d 204e  tivity_chart = N
-0001bd80: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
-0001bd90: 2e74 6173 6b5f 6578 6563 5f62 795f 7072  .task_exec_by_pr
-0001bda0: 6566 6978 5f63 6861 7274 203d 204e 6f6e  efix_chart = Non
-0001bdb0: 650a 2020 2020 2020 2020 7365 6c66 2e73  e.        self.s
-0001bdc0: 656e 6464 6174 615f 6279 5f61 6374 6976  enddata_by_activ
-0001bdd0: 6974 795f 6368 6172 7420 3d20 4e6f 6e65  ity_chart = None
-0001bde0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-0001bdf0: 6f74 203d 2063 6f6c 756d 6e28 0a20 2020  ot = column(.   
-0001be00: 2020 2020 2020 2020 2073 656c 662e 6675           self.fu
-0001be10: 6e63 7469 6f6e 5f73 656c 6563 746f 722c  nction_selector,
-0001be20: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0001be30: 662e 756e 6974 5f73 656c 6563 746f 722c  f.unit_selector,
-0001be40: 0a20 2020 2020 2020 2020 2020 2073 697a  .            siz
-0001be50: 696e 675f 6d6f 6465 3d22 7363 616c 655f  ing_mode="scale_
-0001be60: 7769 6474 6822 2c0a 2020 2020 2020 2020  width",.        
-0001be70: 290a 0a20 2020 2064 6566 2066 6f72 6d61  )..    def forma
-0001be80: 7428 7365 6c66 2c20 756e 6974 3a20 7374  t(self, unit: st
-0001be90: 722c 2076 616c 3a20 416e 7929 202d 3e20  r, val: Any) -> 
-0001bea0: 7374 723a 0a20 2020 2020 2020 2066 6f72  str:.        for
-0001beb0: 6d61 7474 6572 7320 3d20 7b22 6279 7465  matters = {"byte
-0001bec0: 7322 3a20 666f 726d 6174 5f62 7974 6573  s": format_bytes
-0001bed0: 2c20 2273 6563 6f6e 6473 223a 2066 6f72  , "seconds": for
-0001bee0: 6d61 745f 7469 6d65 7d0a 2020 2020 2020  mat_time}.      
-0001bef0: 2020 7265 7475 726e 2066 6f72 6d61 7474    return formatt
-0001bf00: 6572 732e 6765 7428 756e 6974 2c20 7374  ers.get(unit, st
-0001bf10: 7229 2876 616c 290a 0a20 2020 2064 6566  r)(val)..    def
-0001bf20: 2067 6574 5f6d 6574 7269 6373 280a 2020   get_metrics(.  
-0001bf30: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-0001bf40: 2920 2d3e 2074 7570 6c65 5b6c 6973 745b  ) -> tuple[list[
-0001bf50: 7475 706c 655b 7374 722c 2073 7472 2c20  tuple[str, str, 
-0001bf60: 7374 722c 2066 6c6f 6174 5d5d 2c20 6c69  str, float]], li
-0001bf70: 7374 5b74 7570 6c65 5b73 7472 2c20 7374  st[tuple[str, st
-0001bf80: 722c 2066 6c6f 6174 5d5d 5d3a 0a20 2020  r, float]]]:.   
-0001bf90: 2020 2020 2022 2222 5072 652d 7072 6f63       """Pre-proc
-0001bfa0: 6573 7320 6669 6e65 2070 6572 666f 726d  ess fine perform
-0001bfb0: 616e 6365 206d 6574 7269 6373 0a0a 2020  ance metrics..  
-0001bfc0: 2020 2020 2020 5265 7475 726e 730a 2020        Returns.  
-0001bfd0: 2020 2020 2020 2d2d 2d2d 2d2d 2d0a 2020        -------.  
-0001bfe0: 2020 2020 2020 2d20 2765 7865 6375 7465        - 'execute
-0001bff0: 2720 6d65 7472 6963 733a 205b 2866 756e  ' metrics: [(fun
-0001c000: 6374 696f 6e2c 2061 6374 6976 6974 792c  ction, activity,
-0001c010: 2075 6e69 742c 2076 616c 7565 292c 202e   unit, value), .
-0001c020: 2e2e 5d0a 2020 2020 2020 2020 2d20 2767  ..].        - 'g
-0001c030: 6574 5f64 6174 6127 206d 6574 7269 6373  et_data' metrics
-0001c040: 3a20 5b28 6163 7469 7669 7479 2c20 756e  : [(activity, un
-0001c050: 6974 2c20 7661 6c75 6529 2c20 2e2e 2e5d  it, value), ...]
-0001c060: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0001c070: 2020 2020 2065 7865 6375 7465 3a20 6465       execute: de
-0001c080: 6661 756c 7464 6963 745b 7475 706c 655b  faultdict[tuple[
-0001c090: 7374 722c 2073 7472 2c20 7374 725d 2c20  str, str, str], 
-0001c0a0: 666c 6f61 745d 203d 2064 6566 6175 6c74  float] = default
-0001c0b0: 6469 6374 2866 6c6f 6174 290a 2020 2020  dict(float).    
-0001c0c0: 2020 2020 6765 745f 6461 7461 203d 205b      get_data = [
-0001c0d0: 5d0a 0a20 2020 2020 2020 2066 6f72 206b  ]..        for k
-0001c0e0: 2c20 7620 696e 2073 656c 662e 7363 6865  , v in self.sche
-0001c0f0: 6475 6c65 722e 6375 6d75 6c61 7469 7665  duler.cumulative
-0001c100: 5f77 6f72 6b65 725f 6d65 7472 6963 732e  _worker_metrics.
-0001c110: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-0001c120: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
-0001c130: 7374 616e 6365 286b 2c20 7475 706c 6529  stance(k, tuple)
-0001c140: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001c150: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
-0001c160: 2020 2020 2020 2063 6f6e 7465 7874 2c20         context, 
-0001c170: 2a6f 7468 6572 2c20 6163 7469 7669 7479  *other, activity
-0001c180: 2c20 756e 6974 203d 206b 0a20 2020 2020  , unit = k.     
-0001c190: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
-0001c1a0: 696e 7374 616e 6365 2875 6e69 742c 2073  instance(unit, s
-0001c1b0: 7472 290a 0a20 2020 2020 2020 2020 2020  tr)..           
-0001c1c0: 2069 6620 636f 6e74 6578 7420 3d3d 2022   if context == "
-0001c1d0: 6578 6563 7574 6522 3a0a 2020 2020 2020  execute":.      
-0001c1e0: 2020 2020 2020 2020 2020 7370 616e 5f69            span_i
-0001c1f0: 642c 2066 756e 6374 696f 6e20 3d20 6f74  d, function = ot
-0001c200: 6865 720a 2020 2020 2020 2020 2020 2020  her.            
-0001c210: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-0001c220: 7461 6e63 6528 6675 6e63 7469 6f6e 2c20  tance(function, 
-0001c230: 7374 7229 0a20 2020 2020 2020 2020 2020  str).           
-0001c240: 2020 2020 2023 2043 7573 746f 6d20 6d65       # Custom me
-0001c250: 7472 6963 7320 6361 6e20 7072 6f76 6964  trics can provid
-0001c260: 6520 616e 7920 6861 7368 6162 6c65 2061  e any hashable a
-0001c270: 7320 7468 6520 6c61 6265 6c0a 2020 2020  s the label.    
-0001c280: 2020 2020 2020 2020 2020 2020 2320 5371              # Sq
-0001c290: 7561 7368 2061 6c6c 2073 7061 6e5f 6964  uash all span_id
-0001c2a0: 7320 746f 6765 7468 6572 0a20 2020 2020  s together.     
-0001c2b0: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
-0001c2c0: 4f20 6f66 6665 7220 6120 6669 6c74 6572  O offer a filter
-0001c2d0: 2062 7920 7370 616e 5f69 642c 206c 696b   by span_id, lik
-0001c2e0: 6520 7765 2061 6c72 6561 6479 2064 6f20  e we already do 
-0001c2f0: 6279 2066 756e 6374 696f 6e0a 2020 2020  by function.    
-0001c300: 2020 2020 2020 2020 2020 2020 6578 6563              exec
-0001c310: 7574 655b 6675 6e63 7469 6f6e 2c20 7374  ute[function, st
-0001c320: 7228 6163 7469 7669 7479 292c 2075 6e69  r(activity), uni
-0001c330: 745d 202b 3d20 760a 2020 2020 2020 2020  t] += v.        
-0001c340: 2020 2020 656c 6966 2063 6f6e 7465 7874      elif context
-0001c350: 203d 3d20 2267 6574 2d64 6174 6122 3a0a   == "get-data":.
-0001c360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c370: 6173 7365 7274 206e 6f74 206f 7468 6572  assert not other
-0001c380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c390: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-0001c3a0: 6365 2861 6374 6976 6974 792c 2073 7472  ce(activity, str
-0001c3b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001c3c0: 2020 6765 745f 6461 7461 2e61 7070 656e    get_data.appen
-0001c3d0: 6428 2861 6374 6976 6974 792c 2075 6e69  d((activity, uni
-0001c3e0: 742c 2076 2929 0a0a 2020 2020 2020 2020  t, v))..        
-0001c3f0: 2020 2020 2320 4967 6e6f 7265 206d 656d      # Ignore mem
-0001c400: 6f72 792d 6d6f 6e69 746f 7220 616e 6420  ory-monitor and 
-0001c410: 6761 7468 6572 2d64 6570 206d 6574 7269  gather-dep metri
-0001c420: 6373 0a0a 2020 2020 2020 2020 7265 7475  cs..        retu
-0001c430: 726e 2028 0a20 2020 2020 2020 2020 2020  rn (.           
-0001c440: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-0001c450: 2020 2028 6675 6e63 7469 6f6e 2c20 6163     (function, ac
-0001c460: 7469 7669 7479 2c20 756e 6974 2c20 7629  tivity, unit, v)
-0001c470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c480: 2066 6f72 2028 6675 6e63 7469 6f6e 2c20   for (function, 
-0001c490: 6163 7469 7669 7479 2c20 756e 6974 292c  activity, unit),
-0001c4a0: 2076 2069 6e20 736f 7274 6564 2865 7865   v in sorted(exe
-0001c4b0: 6375 7465 2e69 7465 6d73 2829 290a 2020  cute.items()).  
-0001c4c0: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
-0001c4d0: 2020 2020 2020 2020 2073 6f72 7465 6428           sorted(
-0001c4e0: 6765 745f 6461 7461 292c 0a20 2020 2020  get_data),.     
-0001c4f0: 2020 2029 0a0a 2020 2020 4077 6974 686f     )..    @witho
-0001c500: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
-0001c510: 6461 7469 6f6e 0a20 2020 2040 6c6f 675f  dation.    @log_
-0001c520: 6572 726f 7273 0a20 2020 2064 6566 2075  errors.    def u
-0001c530: 7064 6174 6528 7365 6c66 293a 0a20 2020  pdate(self):.   
-0001c540: 2020 2020 2065 7865 6375 7465 5f6d 6574       execute_met
-0001c550: 7269 6373 2c20 6765 745f 6461 7461 5f6d  rics, get_data_m
-0001c560: 6574 7269 6373 203d 2073 656c 662e 6765  etrics = self.ge
-0001c570: 745f 6d65 7472 6963 7328 290a 0a20 2020  t_metrics()..   
-0001c580: 2020 2020 2061 6374 6976 6974 6965 7320       activities 
-0001c590: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-0001c5a0: 6163 7469 7669 7479 2066 6f72 202a 5f2c  activity for *_,
-0001c5b0: 2061 6374 6976 6974 792c 205f 2c20 5f20   activity, _, _ 
-0001c5c0: 696e 2063 6861 696e 2865 7865 6375 7465  in chain(execute
-0001c5d0: 5f6d 6574 7269 6373 2c20 6765 745f 6461  _metrics, get_da
-0001c5e0: 7461 5f6d 6574 7269 6373 290a 2020 2020  ta_metrics).    
-0001c5f0: 2020 2020 7d0a 2020 2020 2020 2020 6163      }.        ac
-0001c600: 7469 7669 7469 6573 2e64 6966 6665 7265  tivities.differe
-0001c610: 6e63 655f 7570 6461 7465 2873 656c 662e  nce_update(self.
-0001c620: 7461 736b 5f61 6374 6976 6974 6965 7329  task_activities)
-0001c630: 0a20 2020 2020 2020 2069 6620 6163 7469  .        if acti
-0001c640: 7669 7469 6573 3a0a 2020 2020 2020 2020  vities:.        
-0001c650: 2020 2020 7365 6c66 2e73 7562 7374 616e      self.substan
-0001c660: 7469 616c 5f63 6861 6e67 6520 3d20 5472  tial_change = Tr
-0001c670: 7565 0a20 2020 2020 2020 2020 2020 2073  ue.            s
-0001c680: 656c 662e 7461 736b 5f61 6374 6976 6974  elf.task_activit
-0001c690: 6965 732e 6578 7465 6e64 2861 6374 6976  ies.extend(activ
-0001c6a0: 6974 6965 7329 0a0a 2020 2020 2020 2020  ities)..        
-0001c6b0: 756e 6974 7320 3d20 7b75 6e69 7420 666f  units = {unit fo
-0001c6c0: 7220 2a5f 2c20 756e 6974 2c20 5f20 696e  r *_, unit, _ in
-0001c6d0: 2063 6861 696e 2865 7865 6375 7465 5f6d   chain(execute_m
-0001c6e0: 6574 7269 6373 2c20 6765 745f 6461 7461  etrics, get_data
-0001c6f0: 5f6d 6574 7269 6373 297d 0a20 2020 2020  _metrics)}.     
-0001c700: 2020 2075 6e69 7473 2e64 6966 6665 7265     units.differe
-0001c710: 6e63 655f 7570 6461 7465 2873 656c 662e  nce_update(self.
-0001c720: 756e 6974 5f73 656c 6563 746f 722e 6f70  unit_selector.op
-0001c730: 7469 6f6e 7329 0a20 2020 2020 2020 2073  tions).        s
-0001c740: 656c 662e 756e 6974 5f73 656c 6563 746f  elf.unit_selecto
-0001c750: 722e 6f70 7469 6f6e 732e 6578 7465 6e64  r.options.extend
-0001c760: 2875 6e69 7473 290a 0a20 2020 2020 2020  (units)..       
-0001c770: 2066 756e 6374 696f 6e73 203d 207b 6675   functions = {fu
-0001c780: 6e63 7469 6f6e 2066 6f72 2066 756e 6374  nction for funct
-0001c790: 696f 6e2c 202a 5f20 696e 2065 7865 6375  ion, *_ in execu
-0001c7a0: 7465 5f6d 6574 7269 6373 7d0a 2020 2020  te_metrics}.    
-0001c7b0: 2020 2020 6675 6e63 7469 6f6e 732e 6469      functions.di
-0001c7c0: 6666 6572 656e 6365 5f75 7064 6174 6528  fference_update(
-0001c7d0: 7365 6c66 2e74 6173 6b5f 6578 6563 5f64  self.task_exec_d
-0001c7e0: 6174 615b 2266 756e 6374 696f 6e73 225d  ata["functions"]
-0001c7f0: 290a 2020 2020 2020 2020 6966 2066 756e  ).        if fun
-0001c800: 6374 696f 6e73 3a0a 2020 2020 2020 2020  ctions:.        
+00019480: 2b20 273c 2f73 7061 6e3e 270a 2020 2020  + '</span>'.    
+00019490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000194a0: 2020 2020 2020 2020 2020 2b20 273a 2027            + ': '
+000194b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000194c0: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+000194d0: 2020 7661 6c2e 746f 4669 7865 6428 3129    val.toFixed(1)
+000194e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000194f0: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+00019500: 2027 3c2f 6469 763e 270a 2020 2020 2020   '</div>'.      
+00019510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019520: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+00019530: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00019540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019550: 2020 2020 2020 2020 2064 6976 732e 756e           divs.un
+00019560: 7368 6966 7428 0a20 2020 2020 2020 2020  shift(.         
+00019570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019580: 2027 3c64 6976 3e27 0a20 2020 2020 2020   '<div>'.       
+00019590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000195a0: 2020 2020 202b 2027 3c73 7061 6e20 7374       + '<span st
+000195b0: 796c 653d 2266 6f6e 742d 7765 6967 6874  yle="font-weight
+000195c0: 3a20 626f 6c64 3b20 636f 6c6f 723a 2064  : bold; color: d
+000195d0: 6172 6b67 7265 793b 223e 6e74 6872 6561  arkgrey;">nthrea
+000195e0: 6473 3a20 3c2f 7370 616e 3e27 0a20 2020  ds: </span>'.   
+000195f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019600: 2020 2020 2020 2020 202b 2073 6f75 7263           + sourc
+00019610: 652e 6461 7461 2e6e 7468 7265 6164 735b  e.data.nthreads[
+00019620: 7661 6c75 655d 0a20 2020 2020 2020 2020  value].         
+00019630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019640: 2020 202b 2027 3c2f 6469 763e 270a 2020     + '</div>'.  
+00019650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019660: 2020 2020 2020 293b 0a20 2020 2020 2020        );.       
+00019670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019680: 2072 6574 7572 6e20 6469 7673 2e6a 6f69   return divs.joi
+00019690: 6e28 275c 5c6e 2729 0a20 2020 2020 2020  n('\\n').       
+000196a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000196b0: 2022 2222 0a20 2020 2020 2020 2020 2020   """.           
+000196c0: 2020 2020 2020 2020 2025 2064 6963 7428           % dict(
+000196d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000196e0: 2020 2020 2020 2020 207a 6970 2873 7461           zip(sta
+000196f0: 636b 6572 732c 2063 6f6c 6f72 7329 0a20  ckers, colors). 
+00019700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019710: 2020 2029 2c20 2023 2073 6e65 616b 2074     ),  # sneak t
+00019720: 6865 2063 6f6c 6f72 206d 6170 7069 6e67  he color mapping
+00019730: 2069 6e74 6f20 7468 6520 6361 6c6c 6261   into the callba
+00019740: 636b 0a20 2020 2020 2020 2020 2020 2020  ck.             
+00019750: 2020 2020 2020 2061 7267 733d 7b22 736f         args={"so
+00019760: 7572 6365 223a 2073 656c 662e 736f 7572  urce": self.sour
+00019770: 6365 7d2c 0a20 2020 2020 2020 2020 2020  ce},.           
+00019780: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00019790: 2020 2020 2020 2023 2041 6464 2074 6865         # Add the
+000197a0: 2048 6f76 6572 546f 6f6c 2074 6f20 7468   HoverTool to th
+000197b0: 6520 746f 7020 6c69 6e65 2072 656e 6465  e top line rende
+000197c0: 7265 722e 0a20 2020 2020 2020 2020 2020  rer..           
+000197d0: 2020 2020 2074 6f70 5f6c 696e 6520 3d20       top_line = 
+000197e0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+000197f0: 2020 2020 2066 6f72 206c 696e 6520 696e       for line in
+00019800: 2072 6576 6572 7365 6428 7365 6c66 2e5f   reversed(self._
+00019810: 6c69 6e65 5f72 656e 6465 7265 7273 2e76  line_renderers.v
+00019820: 616c 7565 7328 2929 3a0a 2020 2020 2020  alues()):.      
+00019830: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00019840: 206c 696e 652e 7669 7369 626c 653a 0a20   line.visible:. 
+00019850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019860: 2020 2020 2020 2074 6f70 5f6c 696e 6520         top_line 
+00019870: 3d20 6c69 6e65 0a20 2020 2020 2020 2020  = line.         
+00019880: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00019890: 7265 616b 0a20 2020 2020 2020 2020 2020  reak.           
+000198a0: 2020 2020 2073 656c 662e 5f68 6f76 6572       self._hover
+000198b0: 2e72 656e 6465 7265 7273 203d 205b 746f  .renderers = [to
+000198c0: 705f 6c69 6e65 5d0a 2020 2020 2020 2020  p_line].        
+000198d0: 2020 2020 2020 2020 7365 6c66 2e5f 686f          self._ho
+000198e0: 7665 722e 666f 726d 6174 7465 7273 203d  ver.formatters =
+000198f0: 207b 2224 696e 6465 7822 3a20 666f 726d   {"$index": form
+00019900: 6174 7465 727d 0a0a 2020 2020 2020 2020  atter}..        
+00019910: 2020 2020 7365 6c66 2e5f 6c61 7374 5f64      self._last_d
+00019920: 7261 776e 203d 2074 696d 6528 290a 2020  rawn = time().  
+00019930: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00019940: 6c61 7374 5f74 7261 6e73 6974 696f 6e5f  last_transition_
+00019950: 636f 756e 7420 3d20 7365 6c66 2e73 6368  count = self.sch
+00019960: 6564 756c 6572 2e74 7261 6e73 6974 696f  eduler.transitio
+00019970: 6e5f 636f 756e 7465 720a 2020 2020 2020  n_counter.      
+00019980: 2020 656c 6966 2073 656c 662e 5f73 686f    elif self._sho
+00019990: 756c 645f 7570 6461 7465 2829 3a0a 2020  uld_update():.  
+000199a0: 2020 2020 2020 2020 2020 2320 506f 7373            # Poss
+000199b0: 6962 6c79 2075 7064 6174 6520 7468 6520  ibly update the 
+000199c0: 7920 7261 6e67 6520 6966 206e 6577 2074  y range if new t
+000199d0: 6872 6561 6473 2068 6176 6520 6265 656e  hreads have been
+000199e0: 2061 6464 6564 0a20 2020 2020 2020 2020   added.         
+000199f0: 2020 206d 6178 5f6e 7468 7265 6164 7320     max_nthreads 
+00019a00: 3d20 6d61 7828 7365 6c66 2e70 6c75 6769  = max(self.plugi
+00019a10: 6e2e 6e74 6872 6561 6473 290a 2020 2020  n.nthreads).    
+00019a20: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00019a30: 726f 6f74 2e79 5f72 616e 6765 2e65 6e64  root.y_range.end
+00019a40: 2021 3d20 6d61 785f 6e74 6872 6561 6473   != max_nthreads
+00019a50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00019a60: 2020 7365 6c66 2e72 6f6f 742e 795f 7261    self.root.y_ra
+00019a70: 6e67 652e 656e 6420 3d20 6d61 785f 6e74  nge.end = max_nt
+00019a80: 6872 6561 6473 0a20 2020 2020 2020 2020  hreads.         
+00019a90: 2020 2023 2055 7064 6174 6520 7468 6520     # Update the 
+00019aa0: 6461 7461 2c20 6f6e 6c79 2069 6e63 6c75  data, only inclu
+00019ab0: 6469 6e67 2065 7869 7374 696e 6720 636f  ding existing co
+00019ac0: 6c75 6d6e 732c 2072 6174 6865 7220 7468  lumns, rather th
+00019ad0: 616e 2072 6564 7261 7769 6e67 0a20 2020  an redrawing.   
+00019ae0: 2020 2020 2020 2020 2023 2074 6865 2077           # the w
+00019af0: 686f 6c65 2063 6861 7274 2e0a 2020 2020  hole chart..    
+00019b00: 2020 2020 2020 2020 7365 6c66 2e73 6f75          self.sou
+00019b10: 7263 652e 6461 7461 203d 2073 656c 662e  rce.data = self.
+00019b20: 5f67 6574 5f74 696d 6573 6572 6965 7328  _get_timeseries(
+00019b30: 7265 7374 7269 6374 5f74 6f5f 6578 6973  restrict_to_exis
+00019b40: 7469 6e67 3d54 7275 6529 0a20 2020 2020  ting=True).     
+00019b50: 2020 2020 2020 2073 656c 662e 5f6c 6173         self._las
+00019b60: 745f 7472 616e 7369 7469 6f6e 5f63 6f75  t_transition_cou
+00019b70: 6e74 203d 2073 656c 662e 7363 6865 6475  nt = self.schedu
+00019b80: 6c65 722e 7472 616e 7369 7469 6f6e 5f63  ler.transition_c
+00019b90: 6f75 6e74 6572 0a0a 0a63 6c61 7373 2054  ounter...class T
+00019ba0: 6173 6b50 726f 6772 6573 7328 4461 7368  askProgress(Dash
+00019bb0: 626f 6172 6443 6f6d 706f 6e65 6e74 293a  boardComponent):
+00019bc0: 0a20 2020 2022 2222 5072 6f67 7265 7373  .    """Progress
+00019bd0: 2062 6172 7320 7065 7220 7461 736b 2074   bars per task t
+00019be0: 7970 6522 2222 0a0a 2020 2020 6465 6620  ype"""..    def 
+00019bf0: 5f5f 696e 6974 5f5f 2873 656c 662c 2073  __init__(self, s
+00019c00: 6368 6564 756c 6572 2c20 2a2a 6b77 6172  cheduler, **kwar
+00019c10: 6773 293a 0a20 2020 2020 2020 2073 656c  gs):.        sel
+00019c20: 662e 7363 6865 6475 6c65 7220 3d20 7363  f.scheduler = sc
+00019c30: 6865 6475 6c65 720a 0a20 2020 2020 2020  heduler..       
+00019c40: 2064 6174 6120 3d20 7072 6f67 7265 7373   data = progress
+00019c50: 5f71 7561 6473 280a 2020 2020 2020 2020  _quads(.        
+00019c60: 2020 2020 6469 6374 2861 6c6c 3d7b 7d2c      dict(all={},
+00019c70: 206d 656d 6f72 793d 7b7d 2c20 6572 7265   memory={}, erre
+00019c80: 643d 7b7d 2c20 7265 6c65 6173 6564 3d7b  d={}, released={
+00019c90: 7d2c 2070 726f 6365 7373 696e 673d 7b7d  }, processing={}
+00019ca0: 2c20 7175 6575 6564 3d7b 7d29 0a20 2020  , queued={}).   
+00019cb0: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+00019cc0: 656c 662e 736f 7572 6365 203d 2043 6f6c  elf.source = Col
+00019cd0: 756d 6e44 6174 6153 6f75 7263 6528 6461  umnDataSource(da
+00019ce0: 7461 3d64 6174 6129 0a0a 2020 2020 2020  ta=data)..      
+00019cf0: 2020 785f 7261 6e67 6520 3d20 4461 7461    x_range = Data
+00019d00: 5261 6e67 6531 6428 7261 6e67 655f 7061  Range1d(range_pa
+00019d10: 6464 696e 673d 3029 0a20 2020 2020 2020  dding=0).       
+00019d20: 2079 5f72 616e 6765 203d 2052 616e 6765   y_range = Range
+00019d30: 3164 282d 382c 2030 290a 0a20 2020 2020  1d(-8, 0)..     
+00019d40: 2020 2073 656c 662e 726f 6f74 203d 2066     self.root = f
+00019d50: 6967 7572 6528 0a20 2020 2020 2020 2020  igure(.         
+00019d60: 2020 2074 6974 6c65 3d22 5072 6f67 7265     title="Progre
+00019d70: 7373 222c 0a20 2020 2020 2020 2020 2020  ss",.           
+00019d80: 206e 616d 653d 2274 6173 6b5f 7072 6f67   name="task_prog
+00019d90: 7265 7373 222c 0a20 2020 2020 2020 2020  ress",.         
+00019da0: 2020 2078 5f72 616e 6765 3d78 5f72 616e     x_range=x_ran
+00019db0: 6765 2c0a 2020 2020 2020 2020 2020 2020  ge,.            
+00019dc0: 795f 7261 6e67 653d 795f 7261 6e67 652c  y_range=y_range,
+00019dd0: 0a20 2020 2020 2020 2020 2020 2074 6f6f  .            too
+00019de0: 6c62 6172 5f6c 6f63 6174 696f 6e3d 2261  lbar_location="a
+00019df0: 626f 7665 222c 0a20 2020 2020 2020 2020  bove",.         
+00019e00: 2020 2074 6f6f 6c73 3d22 222c 0a20 2020     tools="",.   
+00019e10: 2020 2020 2020 2020 206d 696e 5f62 6f72           min_bor
+00019e20: 6465 725f 626f 7474 6f6d 3d35 302c 0a20  der_bottom=50,. 
+00019e30: 2020 2020 2020 2020 2020 202a 2a6b 7761             **kwa
+00019e40: 7267 732c 0a20 2020 2020 2020 2029 0a20  rgs,.        ). 
+00019e50: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+00019e60: 2e6c 696e 6528 2020 2320 6a75 7374 2074  .line(  # just t
+00019e70: 6f20 6465 6669 6e65 2065 6172 6c79 2072  o define early r
+00019e80: 616e 6765 730a 2020 2020 2020 2020 2020  anges.          
+00019e90: 2020 783d 5b30 2c20 302e 395d 2c20 793d    x=[0, 0.9], y=
+00019ea0: 5b2d 312c 2030 5d2c 206c 696e 655f 636f  [-1, 0], line_co
+00019eb0: 6c6f 723d 2223 4646 4646 4646 222c 2061  lor="#FFFFFF", a
+00019ec0: 6c70 6861 3d30 2e30 0a20 2020 2020 2020  lpha=0.0.       
+00019ed0: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+00019ee0: 726f 6f74 2e71 7561 6428 0a20 2020 2020  root.quad(.     
+00019ef0: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
+00019f00: 6c66 2e73 6f75 7263 652c 0a20 2020 2020  lf.source,.     
+00019f10: 2020 2020 2020 2074 6f70 3d22 746f 7022         top="top"
+00019f20: 2c0a 2020 2020 2020 2020 2020 2020 626f  ,.            bo
+00019f30: 7474 6f6d 3d22 626f 7474 6f6d 222c 0a20  ttom="bottom",. 
+00019f40: 2020 2020 2020 2020 2020 206c 6566 743d             left=
+00019f50: 226c 6566 7422 2c0a 2020 2020 2020 2020  "left",.        
+00019f60: 2020 2020 7269 6768 743d 2272 6967 6874      right="right
+00019f70: 222c 0a20 2020 2020 2020 2020 2020 2066  ",.            f
+00019f80: 696c 6c5f 636f 6c6f 723d 2223 6161 6161  ill_color="#aaaa
+00019f90: 6161 222c 0a20 2020 2020 2020 2020 2020  aa",.           
+00019fa0: 206c 696e 655f 636f 6c6f 723d 2223 6161   line_color="#aa
+00019fb0: 6161 6161 222c 0a20 2020 2020 2020 2020  aaaa",.         
+00019fc0: 2020 2066 696c 6c5f 616c 7068 613d 302e     fill_alpha=0.
+00019fd0: 312c 0a20 2020 2020 2020 2020 2020 206c  1,.            l
+00019fe0: 696e 655f 616c 7068 613d 302e 332c 0a20  ine_alpha=0.3,. 
+00019ff0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001a000: 2073 656c 662e 726f 6f74 2e71 7561 6428   self.root.quad(
+0001a010: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
+0001a020: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
+0001a030: 0a20 2020 2020 2020 2020 2020 2074 6f70  .            top
+0001a040: 3d22 746f 7022 2c0a 2020 2020 2020 2020  ="top",.        
+0001a050: 2020 2020 626f 7474 6f6d 3d22 626f 7474      bottom="bott
+0001a060: 6f6d 222c 0a20 2020 2020 2020 2020 2020  om",.           
+0001a070: 206c 6566 743d 226c 6566 7422 2c0a 2020   left="left",.  
+0001a080: 2020 2020 2020 2020 2020 7269 6768 743d            right=
+0001a090: 2272 656c 6561 7365 642d 6c6f 6322 2c0a  "released-loc",.
+0001a0a0: 2020 2020 2020 2020 2020 2020 6669 6c6c              fill
+0001a0b0: 5f63 6f6c 6f72 3d22 636f 6c6f 7222 2c0a  _color="color",.
+0001a0c0: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
+0001a0d0: 5f63 6f6c 6f72 3d22 636f 6c6f 7222 2c0a  _color="color",.
+0001a0e0: 2020 2020 2020 2020 2020 2020 6669 6c6c              fill
+0001a0f0: 5f61 6c70 6861 3d30 2e36 2c0a 2020 2020  _alpha=0.6,.    
+0001a100: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+0001a110: 6c66 2e72 6f6f 742e 7175 6164 280a 2020  lf.root.quad(.  
+0001a120: 2020 2020 2020 2020 2020 736f 7572 6365            source
+0001a130: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
+0001a140: 2020 2020 2020 2020 2020 746f 703d 2274            top="t
+0001a150: 6f70 222c 0a20 2020 2020 2020 2020 2020  op",.           
+0001a160: 2062 6f74 746f 6d3d 2262 6f74 746f 6d22   bottom="bottom"
+0001a170: 2c0a 2020 2020 2020 2020 2020 2020 6c65  ,.            le
+0001a180: 6674 3d22 7265 6c65 6173 6564 2d6c 6f63  ft="released-loc
+0001a190: 222c 0a20 2020 2020 2020 2020 2020 2072  ",.            r
+0001a1a0: 6967 6874 3d22 6d65 6d6f 7279 2d6c 6f63  ight="memory-loc
+0001a1b0: 222c 0a20 2020 2020 2020 2020 2020 2066  ",.            f
+0001a1c0: 696c 6c5f 636f 6c6f 723d 2263 6f6c 6f72  ill_color="color
+0001a1d0: 222c 0a20 2020 2020 2020 2020 2020 206c  ",.            l
+0001a1e0: 696e 655f 636f 6c6f 723d 2263 6f6c 6f72  ine_color="color
+0001a1f0: 222c 0a20 2020 2020 2020 2020 2020 2066  ",.            f
+0001a200: 696c 6c5f 616c 7068 613d 312e 302c 0a20  ill_alpha=1.0,. 
+0001a210: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001a220: 2073 656c 662e 726f 6f74 2e71 7561 6428   self.root.quad(
+0001a230: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
+0001a240: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
+0001a250: 0a20 2020 2020 2020 2020 2020 2074 6f70  .            top
+0001a260: 3d22 746f 7022 2c0a 2020 2020 2020 2020  ="top",.        
+0001a270: 2020 2020 626f 7474 6f6d 3d22 626f 7474      bottom="bott
+0001a280: 6f6d 222c 0a20 2020 2020 2020 2020 2020  om",.           
+0001a290: 206c 6566 743d 226d 656d 6f72 792d 6c6f   left="memory-lo
+0001a2a0: 6322 2c0a 2020 2020 2020 2020 2020 2020  c",.            
+0001a2b0: 7269 6768 743d 2265 7272 6564 2d6c 6f63  right="erred-loc
+0001a2c0: 222c 0a20 2020 2020 2020 2020 2020 2066  ",.            f
+0001a2d0: 696c 6c5f 636f 6c6f 723d 2262 6c61 636b  ill_color="black
+0001a2e0: 222c 0a20 2020 2020 2020 2020 2020 2066  ",.            f
+0001a2f0: 696c 6c5f 616c 7068 613d 302e 352c 0a20  ill_alpha=0.5,. 
+0001a300: 2020 2020 2020 2020 2020 206c 696e 655f             line_
+0001a310: 616c 7068 613d 302c 0a20 2020 2020 2020  alpha=0,.       
+0001a320: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+0001a330: 726f 6f74 2e71 7561 6428 0a20 2020 2020  root.quad(.     
+0001a340: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
+0001a350: 6c66 2e73 6f75 7263 652c 0a20 2020 2020  lf.source,.     
+0001a360: 2020 2020 2020 2074 6f70 3d22 746f 7022         top="top"
+0001a370: 2c0a 2020 2020 2020 2020 2020 2020 626f  ,.            bo
+0001a380: 7474 6f6d 3d22 626f 7474 6f6d 222c 0a20  ttom="bottom",. 
+0001a390: 2020 2020 2020 2020 2020 206c 6566 743d             left=
+0001a3a0: 2265 7272 6564 2d6c 6f63 222c 0a20 2020  "erred-loc",.   
+0001a3b0: 2020 2020 2020 2020 2072 6967 6874 3d22           right="
+0001a3c0: 7072 6f63 6573 7369 6e67 2d6c 6f63 222c  processing-loc",
+0001a3d0: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
+0001a3e0: 6c5f 636f 6c6f 723d 2267 7261 7922 2c0a  l_color="gray",.
+0001a3f0: 2020 2020 2020 2020 2020 2020 6669 6c6c              fill
+0001a400: 5f61 6c70 6861 3d30 2e33 352c 0a20 2020  _alpha=0.35,.   
+0001a410: 2020 2020 2020 2020 206c 696e 655f 616c           line_al
+0001a420: 7068 613d 302c 0a20 2020 2020 2020 2029  pha=0,.        )
+0001a430: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+0001a440: 6f74 2e71 7561 6428 0a20 2020 2020 2020  ot.quad(.       
+0001a450: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
+0001a460: 2e73 6f75 7263 652c 0a20 2020 2020 2020  .source,.       
+0001a470: 2020 2020 2074 6f70 3d22 746f 7022 2c0a       top="top",.
+0001a480: 2020 2020 2020 2020 2020 2020 626f 7474              bott
+0001a490: 6f6d 3d22 626f 7474 6f6d 222c 0a20 2020  om="bottom",.   
+0001a4a0: 2020 2020 2020 2020 206c 6566 743d 2270           left="p
+0001a4b0: 726f 6365 7373 696e 672d 6c6f 6322 2c0a  rocessing-loc",.
+0001a4c0: 2020 2020 2020 2020 2020 2020 7269 6768              righ
+0001a4d0: 743d 2271 7565 7565 642d 6c6f 6322 2c0a  t="queued-loc",.
+0001a4e0: 2020 2020 2020 2020 2020 2020 6669 6c6c              fill
+0001a4f0: 5f63 6f6c 6f72 3d22 6772 6179 222c 0a20  _color="gray",. 
+0001a500: 2020 2020 2020 2020 2020 2068 6174 6368             hatch
+0001a510: 5f70 6174 7465 726e 3d22 2f22 2c0a 2020  _pattern="/",.  
+0001a520: 2020 2020 2020 2020 2020 6861 7463 685f            hatch_
+0001a530: 636f 6c6f 723d 2277 6869 7465 222c 0a20  color="white",. 
+0001a540: 2020 2020 2020 2020 2020 2066 696c 6c5f             fill_
+0001a550: 616c 7068 613d 302e 3335 2c0a 2020 2020  alpha=0.35,.    
+0001a560: 2020 2020 2020 2020 6c69 6e65 5f61 6c70          line_alp
+0001a570: 6861 3d30 2c0a 2020 2020 2020 2020 290a  ha=0,.        ).
+0001a580: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+0001a590: 742e 7175 6164 280a 2020 2020 2020 2020  t.quad(.        
+0001a5a0: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
+0001a5b0: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
+0001a5c0: 2020 2020 746f 703d 2274 6f70 222c 0a20      top="top",. 
+0001a5d0: 2020 2020 2020 2020 2020 2062 6f74 746f             botto
+0001a5e0: 6d3d 2262 6f74 746f 6d22 2c0a 2020 2020  m="bottom",.    
+0001a5f0: 2020 2020 2020 2020 6c65 6674 3d22 7175          left="qu
+0001a600: 6575 6564 2d6c 6f63 222c 0a20 2020 2020  eued-loc",.     
+0001a610: 2020 2020 2020 2072 6967 6874 3d22 6e6f         right="no
+0001a620: 2d77 6f72 6b65 722d 6c6f 6322 2c0a 2020  -worker-loc",.  
+0001a630: 2020 2020 2020 2020 2020 6669 6c6c 5f63            fill_c
+0001a640: 6f6c 6f72 3d22 7265 6422 2c0a 2020 2020  olor="red",.    
+0001a650: 2020 2020 2020 2020 6861 7463 685f 7061          hatch_pa
+0001a660: 7474 6572 6e3d 222f 222c 0a20 2020 2020  ttern="/",.     
+0001a670: 2020 2020 2020 2068 6174 6368 5f63 6f6c         hatch_col
+0001a680: 6f72 3d22 626c 6163 6b22 2c0a 2020 2020  or="black",.    
+0001a690: 2020 2020 2020 2020 6669 6c6c 5f61 6c70          fill_alp
+0001a6a0: 6861 3d30 2e33 352c 0a20 2020 2020 2020  ha=0.35,.       
+0001a6b0: 2020 2020 206c 696e 655f 616c 7068 613d       line_alpha=
+0001a6c0: 302c 0a20 2020 2020 2020 2029 0a20 2020  0,.        ).   
+0001a6d0: 2020 2020 2073 656c 662e 726f 6f74 2e74       self.root.t
+0001a6e0: 6578 7428 0a20 2020 2020 2020 2020 2020  ext(.           
+0001a6f0: 2073 6f75 7263 653d 7365 6c66 2e73 6f75   source=self.sou
+0001a700: 7263 652c 0a20 2020 2020 2020 2020 2020  rce,.           
+0001a710: 2074 6578 743d 2273 686f 772d 6e61 6d65   text="show-name
+0001a720: 222c 0a20 2020 2020 2020 2020 2020 2079  ",.            y
+0001a730: 3d22 626f 7474 6f6d 222c 0a20 2020 2020  ="bottom",.     
+0001a740: 2020 2020 2020 2078 3d22 6c65 6674 222c         x="left",
+0001a750: 0a20 2020 2020 2020 2020 2020 2078 5f6f  .            x_o
+0001a760: 6666 7365 743d 352c 0a20 2020 2020 2020  ffset=5,.       
+0001a770: 2020 2020 2074 6578 745f 666f 6e74 5f73       text_font_s
+0001a780: 697a 653d 7661 6c75 6528 2231 3070 7422  ize=value("10pt"
+0001a790: 292c 0a20 2020 2020 2020 2029 0a20 2020  ),.        ).   
+0001a7a0: 2020 2020 2073 656c 662e 726f 6f74 2e74       self.root.t
+0001a7b0: 6578 7428 0a20 2020 2020 2020 2020 2020  ext(.           
+0001a7c0: 2073 6f75 7263 653d 7365 6c66 2e73 6f75   source=self.sou
+0001a7d0: 7263 652c 0a20 2020 2020 2020 2020 2020  rce,.           
+0001a7e0: 2074 6578 743d 2264 6f6e 6522 2c0a 2020   text="done",.  
+0001a7f0: 2020 2020 2020 2020 2020 793d 2262 6f74            y="bot
+0001a800: 746f 6d22 2c0a 2020 2020 2020 2020 2020  tom",.          
+0001a810: 2020 783d 2272 6967 6874 222c 0a20 2020    x="right",.   
+0001a820: 2020 2020 2020 2020 2078 5f6f 6666 7365           x_offse
+0001a830: 743d 2d35 2c0a 2020 2020 2020 2020 2020  t=-5,.          
+0001a840: 2020 7465 7874 5f61 6c69 676e 3d22 7269    text_align="ri
+0001a850: 6768 7422 2c0a 2020 2020 2020 2020 2020  ght",.          
+0001a860: 2020 7465 7874 5f66 6f6e 745f 7369 7a65    text_font_size
+0001a870: 3d76 616c 7565 2822 3130 7074 2229 2c0a  =value("10pt"),.
+0001a880: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0001a890: 2020 7365 6c66 2e72 6f6f 742e 7967 7269    self.root.ygri
+0001a8a0: 642e 7669 7369 626c 6520 3d20 4661 6c73  d.visible = Fals
+0001a8b0: 650a 2020 2020 2020 2020 7365 6c66 2e72  e.        self.r
+0001a8c0: 6f6f 742e 7961 7869 732e 6d69 6e6f 725f  oot.yaxis.minor_
+0001a8d0: 7469 636b 5f6c 696e 655f 616c 7068 6120  tick_line_alpha 
+0001a8e0: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
+0001a8f0: 2e72 6f6f 742e 7961 7869 732e 7669 7369  .root.yaxis.visi
+0001a900: 626c 6520 3d20 4661 6c73 650a 2020 2020  ble = False.    
+0001a910: 2020 2020 7365 6c66 2e72 6f6f 742e 7867      self.root.xg
+0001a920: 7269 642e 7669 7369 626c 6520 3d20 4661  rid.visible = Fa
+0001a930: 6c73 650a 2020 2020 2020 2020 7365 6c66  lse.        self
+0001a940: 2e72 6f6f 742e 7861 7869 732e 6d69 6e6f  .root.xaxis.mino
+0001a950: 725f 7469 636b 5f6c 696e 655f 616c 7068  r_tick_line_alph
+0001a960: 6120 3d20 300a 2020 2020 2020 2020 7365  a = 0.        se
+0001a970: 6c66 2e72 6f6f 742e 7861 7869 732e 7669  lf.root.xaxis.vi
+0001a980: 7369 626c 6520 3d20 4661 6c73 650a 0a20  sible = False.. 
+0001a990: 2020 2020 2020 2068 6f76 6572 203d 2048         hover = H
+0001a9a0: 6f76 6572 546f 6f6c 280a 2020 2020 2020  overTool(.      
+0001a9b0: 2020 2020 2020 706f 696e 745f 706f 6c69        point_poli
+0001a9c0: 6379 3d22 666f 6c6c 6f77 5f6d 6f75 7365  cy="follow_mouse
+0001a9d0: 222c 0a20 2020 2020 2020 2020 2020 2074  ",.            t
+0001a9e0: 6f6f 6c74 6970 733d 2222 220a 2020 2020  ooltips=""".    
+0001a9f0: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
+0001aa00: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+0001aa10: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
+0001aa20: 653d 2266 6f6e 742d 7369 7a65 3a20 3134  e="font-size: 14
+0001aa30: 7078 3b20 666f 6e74 2d77 6569 6768 743a  px; font-weight:
+0001aa40: 2062 6f6c 643b 223e 4e61 6d65 3a3c 2f73   bold;">Name:</s
+0001aa50: 7061 6e3e 266e 6273 703b 0a20 2020 2020  pan>&nbsp;.     
+0001aa60: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+0001aa70: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
+0001aa80: 2d73 697a 653a 2031 3070 783b 2066 6f6e  -size: 10px; fon
+0001aa90: 742d 6661 6d69 6c79 3a20 4d6f 6e61 636f  t-family: Monaco
+0001aaa0: 2c20 6d6f 6e6f 7370 6163 653b 223e 406e  , monospace;">@n
+0001aab0: 616d 653c 2f73 7061 6e3e 0a20 2020 2020  ame</span>.     
+0001aac0: 2020 2020 2020 2020 2020 203c 2f64 6976             </div
+0001aad0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+0001aae0: 2020 3c64 6976 3e0a 2020 2020 2020 2020    <div>.        
+0001aaf0: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
+0001ab00: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
+0001ab10: 7a65 3a20 3134 7078 3b20 666f 6e74 2d77  ze: 14px; font-w
+0001ab20: 6569 6768 743a 2062 6f6c 643b 223e 416c  eight: bold;">Al
+0001ab30: 6c3a 3c2f 7370 616e 3e26 6e62 7370 3b0a  l:</span>&nbsp;.
+0001ab40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ab50: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
+0001ab60: 2266 6f6e 742d 7369 7a65 3a20 3130 7078  "font-size: 10px
+0001ab70: 3b20 666f 6e74 2d66 616d 696c 793a 204d  ; font-family: M
+0001ab80: 6f6e 6163 6f2c 206d 6f6e 6f73 7061 6365  onaco, monospace
+0001ab90: 3b22 3e40 616c 6c3c 2f73 7061 6e3e 0a20  ;">@all</span>. 
+0001aba0: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+0001abb0: 2f64 6976 3e0a 2020 2020 2020 2020 2020  /div>.          
+0001abc0: 2020 2020 2020 3c64 6976 3e0a 2020 2020        <div>.    
+0001abd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001abe0: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
+0001abf0: 742d 7369 7a65 3a20 3134 7078 3b20 666f  t-size: 14px; fo
+0001ac00: 6e74 2d77 6569 6768 743a 2062 6f6c 643b  nt-weight: bold;
+0001ac10: 223e 5175 6575 6564 3a3c 2f73 7061 6e3e  ">Queued:</span>
+0001ac20: 266e 6273 703b 0a20 2020 2020 2020 2020  &nbsp;.         
+0001ac30: 2020 2020 2020 2020 2020 203c 7370 616e             <span
+0001ac40: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
+0001ac50: 653a 2031 3070 783b 2066 6f6e 742d 6661  e: 10px; font-fa
+0001ac60: 6d69 6c79 3a20 4d6f 6e61 636f 2c20 6d6f  mily: Monaco, mo
+0001ac70: 6e6f 7370 6163 653b 223e 4071 7565 7565  nospace;">@queue
+0001ac80: 643c 2f73 7061 6e3e 0a20 2020 2020 2020  d</span>.       
+0001ac90: 2020 2020 2020 2020 203c 2f64 6976 3e0a           </div>.
+0001aca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001acb0: 3c64 6976 3e0a 2020 2020 2020 2020 2020  <div>.          
+0001acc0: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
+0001acd0: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
+0001ace0: 3a20 3134 7078 3b20 666f 6e74 2d77 6569  : 14px; font-wei
+0001acf0: 6768 743a 2062 6f6c 643b 223e 4e6f 2d77  ght: bold;">No-w
+0001ad00: 6f72 6b65 723a 3c2f 7370 616e 3e26 6e62  orker:</span>&nb
+0001ad10: 7370 3b0a 2020 2020 2020 2020 2020 2020  sp;.            
+0001ad20: 2020 2020 2020 2020 3c73 7061 6e20 7374          <span st
+0001ad30: 796c 653d 2266 6f6e 742d 7369 7a65 3a20  yle="font-size: 
+0001ad40: 3130 7078 3b20 666f 6e74 2d66 616d 696c  10px; font-famil
+0001ad50: 793a 204d 6f6e 6163 6f2c 206d 6f6e 6f73  y: Monaco, monos
+0001ad60: 7061 6365 3b22 3e40 6e6f 5f77 6f72 6b65  pace;">@no_worke
+0001ad70: 723c 2f73 7061 6e3e 0a20 2020 2020 2020  r</span>.       
+0001ad80: 2020 2020 2020 2020 203c 2f64 6976 3e0a           </div>.
+0001ad90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ada0: 3c64 6976 3e0a 2020 2020 2020 2020 2020  <div>.          
+0001adb0: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
+0001adc0: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
+0001add0: 3a20 3134 7078 3b20 666f 6e74 2d77 6569  : 14px; font-wei
+0001ade0: 6768 743a 2062 6f6c 643b 223e 5072 6f63  ght: bold;">Proc
+0001adf0: 6573 7369 6e67 3a3c 2f73 7061 6e3e 266e  essing:</span>&n
+0001ae00: 6273 703b 0a20 2020 2020 2020 2020 2020  bsp;.           
+0001ae10: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
+0001ae20: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
+0001ae30: 2031 3070 783b 2066 6f6e 742d 6661 6d69   10px; font-fami
+0001ae40: 6c79 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f  ly: Monaco, mono
+0001ae50: 7370 6163 653b 223e 4070 726f 6365 7373  space;">@process
+0001ae60: 696e 673c 2f73 7061 6e3e 0a20 2020 2020  ing</span>.     
+0001ae70: 2020 2020 2020 2020 2020 203c 2f64 6976             </div
+0001ae80: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+0001ae90: 2020 3c64 6976 3e0a 2020 2020 2020 2020    <div>.        
+0001aea0: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
+0001aeb0: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
+0001aec0: 7a65 3a20 3134 7078 3b20 666f 6e74 2d77  ze: 14px; font-w
+0001aed0: 6569 6768 743a 2062 6f6c 643b 223e 4d65  eight: bold;">Me
+0001aee0: 6d6f 7279 3a3c 2f73 7061 6e3e 266e 6273  mory:</span>&nbs
+0001aef0: 703b 0a20 2020 2020 2020 2020 2020 2020  p;.             
+0001af00: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
+0001af10: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
+0001af20: 3070 783b 2066 6f6e 742d 6661 6d69 6c79  0px; font-family
+0001af30: 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f 7370  : Monaco, monosp
+0001af40: 6163 653b 223e 406d 656d 6f72 793c 2f73  ace;">@memory</s
+0001af50: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
+0001af60: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
+0001af70: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
+0001af80: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+0001af90: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
+0001afa0: 653d 2266 6f6e 742d 7369 7a65 3a20 3134  e="font-size: 14
+0001afb0: 7078 3b20 666f 6e74 2d77 6569 6768 743a  px; font-weight:
+0001afc0: 2062 6f6c 643b 223e 4572 7265 643a 3c2f   bold;">Erred:</
+0001afd0: 7370 616e 3e26 6e62 7370 3b0a 2020 2020  span>&nbsp;.    
+0001afe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aff0: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
+0001b000: 742d 7369 7a65 3a20 3130 7078 3b20 666f  t-size: 10px; fo
+0001b010: 6e74 2d66 616d 696c 793a 204d 6f6e 6163  nt-family: Monac
+0001b020: 6f2c 206d 6f6e 6f73 7061 6365 3b22 3e40  o, monospace;">@
+0001b030: 6572 7265 643c 2f73 7061 6e3e 0a20 2020  erred</span>.   
+0001b040: 2020 2020 2020 2020 2020 2020 203c 2f64               </d
+0001b050: 6976 3e0a 2020 2020 2020 2020 2020 2020  iv>.            
+0001b060: 2020 2020 2222 222c 0a20 2020 2020 2020      """,.       
+0001b070: 2029 0a20 2020 2020 2020 2068 656c 705f   ).        help_
+0001b080: 203d 2048 656c 7054 6f6f 6c28 0a20 2020   = HelpTool(.   
+0001b090: 2020 2020 2020 2020 2072 6564 6972 6563           redirec
+0001b0a0: 743d 2268 7474 7073 3a2f 2f64 6f63 732e  t="https://docs.
+0001b0b0: 6461 736b 2e6f 7267 2f65 6e2f 7374 6162  dask.org/en/stab
+0001b0c0: 6c65 2f64 6173 6862 6f61 7264 2e68 746d  le/dashboard.htm
+0001b0d0: 6c23 7072 6f67 7265 7373 222c 0a20 2020  l#progress",.   
+0001b0e0: 2020 2020 2020 2020 2064 6573 6372 6970           descrip
+0001b0f0: 7469 6f6e 3d22 4120 6465 7363 7269 7074  tion="A descript
+0001b100: 696f 6e20 6f66 2074 6865 2070 726f 6772  ion of the progr
+0001b110: 6573 7320 6261 7273 2070 6c6f 742e 222c  ess bars plot.",
+0001b120: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0001b130: 2020 2073 656c 662e 726f 6f74 2e61 6464     self.root.add
+0001b140: 5f74 6f6f 6c73 2868 6f76 6572 2c20 6865  _tools(hover, he
+0001b150: 6c70 5f29 0a0a 2020 2020 4077 6974 686f  lp_)..    @witho
+0001b160: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
+0001b170: 6461 7469 6f6e 0a20 2020 2040 6c6f 675f  dation.    @log_
+0001b180: 6572 726f 7273 0a20 2020 2064 6566 2075  errors.    def u
+0001b190: 7064 6174 6528 7365 6c66 293a 0a20 2020  pdate(self):.   
+0001b1a0: 2020 2020 2073 7461 7465 203d 207b 0a20       state = {. 
+0001b1b0: 2020 2020 2020 2020 2020 2022 6d65 6d6f             "memo
+0001b1c0: 7279 223a 207b 7d2c 0a20 2020 2020 2020  ry": {},.       
+0001b1d0: 2020 2020 2022 6572 7265 6422 3a20 7b7d       "erred": {}
+0001b1e0: 2c0a 2020 2020 2020 2020 2020 2020 2272  ,.            "r
+0001b1f0: 656c 6561 7365 6422 3a20 7b7d 2c0a 2020  eleased": {},.  
+0001b200: 2020 2020 2020 2020 2020 2270 726f 6365            "proce
+0001b210: 7373 696e 6722 3a20 7b7d 2c0a 2020 2020  ssing": {},.    
+0001b220: 2020 2020 2020 2020 2277 6169 7469 6e67          "waiting
+0001b230: 223a 207b 7d2c 0a20 2020 2020 2020 2020  ": {},.         
+0001b240: 2020 2022 7175 6575 6564 223a 207b 7d2c     "queued": {},
+0001b250: 0a20 2020 2020 2020 2020 2020 2022 6e6f  .            "no
+0001b260: 5f77 6f72 6b65 7222 3a20 7b7d 2c0a 2020  _worker": {},.  
+0001b270: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+0001b280: 2066 6f72 2074 7020 696e 2073 656c 662e   for tp in self.
+0001b290: 7363 6865 6475 6c65 722e 7461 736b 5f70  scheduler.task_p
+0001b2a0: 7265 6669 7865 732e 7661 6c75 6573 2829  refixes.values()
+0001b2b0: 3a0a 2020 2020 2020 2020 2020 2020 6163  :.            ac
+0001b2c0: 7469 7665 5f73 7461 7465 7320 3d20 7470  tive_states = tp
+0001b2d0: 2e61 6374 6976 655f 7374 6174 6573 0a20  .active_states. 
+0001b2e0: 2020 2020 2020 2020 2020 2069 6620 616e             if an
+0001b2f0: 7928 6163 7469 7665 5f73 7461 7465 732e  y(active_states.
+0001b300: 6765 7428 7329 2066 6f72 2073 2069 6e20  get(s) for s in 
+0001b310: 7374 6174 652e 6b65 7973 2829 293a 0a20  state.keys()):. 
+0001b320: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001b330: 7461 7465 5b22 6d65 6d6f 7279 225d 5b74  tate["memory"][t
+0001b340: 702e 6e61 6d65 5d20 3d20 6163 7469 7665  p.name] = active
+0001b350: 5f73 7461 7465 735b 226d 656d 6f72 7922  _states["memory"
+0001b360: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0001b370: 2020 7374 6174 655b 2265 7272 6564 225d    state["erred"]
+0001b380: 5b74 702e 6e61 6d65 5d20 3d20 6163 7469  [tp.name] = acti
+0001b390: 7665 5f73 7461 7465 735b 2265 7272 6564  ve_states["erred
+0001b3a0: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
+0001b3b0: 2020 2073 7461 7465 5b22 7265 6c65 6173     state["releas
+0001b3c0: 6564 225d 5b74 702e 6e61 6d65 5d20 3d20  ed"][tp.name] = 
+0001b3d0: 6163 7469 7665 5f73 7461 7465 735b 2272  active_states["r
+0001b3e0: 656c 6561 7365 6422 5d0a 2020 2020 2020  eleased"].      
+0001b3f0: 2020 2020 2020 2020 2020 7374 6174 655b            state[
+0001b400: 2270 726f 6365 7373 696e 6722 5d5b 7470  "processing"][tp
+0001b410: 2e6e 616d 655d 203d 2061 6374 6976 655f  .name] = active_
+0001b420: 7374 6174 6573 5b22 7072 6f63 6573 7369  states["processi
+0001b430: 6e67 225d 0a20 2020 2020 2020 2020 2020  ng"].           
+0001b440: 2020 2020 2073 7461 7465 5b22 7761 6974       state["wait
+0001b450: 696e 6722 5d5b 7470 2e6e 616d 655d 203d  ing"][tp.name] =
+0001b460: 2061 6374 6976 655f 7374 6174 6573 5b22   active_states["
+0001b470: 7761 6974 696e 6722 5d0a 2020 2020 2020  waiting"].      
+0001b480: 2020 2020 2020 2020 2020 7374 6174 655b            state[
+0001b490: 2271 7565 7565 6422 5d5b 7470 2e6e 616d  "queued"][tp.nam
+0001b4a0: 655d 203d 2061 6374 6976 655f 7374 6174  e] = active_stat
+0001b4b0: 6573 5b22 7175 6575 6564 225d 0a20 2020  es["queued"].   
+0001b4c0: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+0001b4d0: 7465 5b22 6e6f 5f77 6f72 6b65 7222 5d5b  te["no_worker"][
+0001b4e0: 7470 2e6e 616d 655d 203d 2061 6374 6976  tp.name] = activ
+0001b4f0: 655f 7374 6174 6573 5b22 6e6f 2d77 6f72  e_states["no-wor
+0001b500: 6b65 7222 5d0a 0a20 2020 2020 2020 2073  ker"]..        s
+0001b510: 7461 7465 5b22 616c 6c22 5d20 3d20 7b6b  tate["all"] = {k
+0001b520: 3a20 7375 6d28 765b 6b5d 2066 6f72 2076  : sum(v[k] for v
+0001b530: 2069 6e20 7374 6174 652e 7661 6c75 6573   in state.values
+0001b540: 2829 2920 666f 7220 6b20 696e 2073 7461  ()) for k in sta
+0001b550: 7465 5b22 6d65 6d6f 7279 225d 7d0a 0a20  te["memory"]}.. 
+0001b560: 2020 2020 2020 2069 6620 6e6f 7420 7374         if not st
+0001b570: 6174 655b 2261 6c6c 225d 2061 6e64 206e  ate["all"] and n
+0001b580: 6f74 206c 656e 2873 656c 662e 736f 7572  ot len(self.sour
+0001b590: 6365 2e64 6174 615b 2261 6c6c 225d 293a  ce.data["all"]):
+0001b5a0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0001b5b0: 7572 6e0a 0a20 2020 2020 2020 2064 203d  urn..        d =
+0001b5c0: 2070 726f 6772 6573 735f 7175 6164 7328   progress_quads(
+0001b5d0: 7374 6174 6529 0a0a 2020 2020 2020 2020  state)..        
+0001b5e0: 7570 6461 7465 2873 656c 662e 736f 7572  update(self.sour
+0001b5f0: 6365 2c20 6429 0a0a 2020 2020 2020 2020  ce, d)..        
+0001b600: 746f 7461 6c73 203d 207b 0a20 2020 2020  totals = {.     
+0001b610: 2020 2020 2020 206b 3a20 7375 6d28 7374         k: sum(st
+0001b620: 6174 655b 6b5d 2e76 616c 7565 7328 2929  ate[k].values())
+0001b630: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0001b640: 206b 2069 6e20 5b0a 2020 2020 2020 2020   k in [.        
+0001b650: 2020 2020 2020 2020 2261 6c6c 222c 0a20          "all",. 
+0001b660: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0001b670: 6d65 6d6f 7279 222c 0a20 2020 2020 2020  memory",.       
+0001b680: 2020 2020 2020 2020 2022 6572 7265 6422           "erred"
+0001b690: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001b6a0: 2020 2272 656c 6561 7365 6422 2c0a 2020    "released",.  
+0001b6b0: 2020 2020 2020 2020 2020 2020 2020 2277                "w
+0001b6c0: 6169 7469 6e67 222c 0a20 2020 2020 2020  aiting",.       
+0001b6d0: 2020 2020 2020 2020 2022 7175 6575 6564           "queued
+0001b6e0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0001b6f0: 2020 2022 6e6f 5f77 6f72 6b65 7222 2c0a     "no_worker",.
+0001b700: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
+0001b710: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0001b720: 746f 7461 6c73 5b22 7072 6f63 6573 7369  totals["processi
+0001b730: 6e67 225d 203d 2074 6f74 616c 735b 2261  ng"] = totals["a
+0001b740: 6c6c 225d 202d 2073 756d 280a 2020 2020  ll"] - sum(.    
+0001b750: 2020 2020 2020 2020 7620 666f 7220 6b2c          v for k,
+0001b760: 2076 2069 6e20 746f 7461 6c73 2e69 7465   v in totals.ite
+0001b770: 6d73 2829 2069 6620 6b20 213d 2022 616c  ms() if k != "al
+0001b780: 6c22 0a20 2020 2020 2020 2029 0a0a 2020  l".        )..  
+0001b790: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+0001b7a0: 7469 746c 652e 7465 7874 203d 2028 0a20  title.text = (. 
+0001b7b0: 2020 2020 2020 2020 2020 2022 5072 6f67             "Prog
+0001b7c0: 7265 7373 202d 2d20 746f 7461 6c3a 2025  ress -- total: %
+0001b7d0: 2861 6c6c 2973 2c20 220a 2020 2020 2020  (all)s, ".      
+0001b7e0: 2020 2020 2020 2277 6169 7469 6e67 3a20        "waiting: 
+0001b7f0: 2528 7761 6974 696e 6729 732c 2022 0a20  %(waiting)s, ". 
+0001b800: 2020 2020 2020 2020 2020 2022 7175 6575             "queu
+0001b810: 6564 3a20 2528 7175 6575 6564 2973 2c20  ed: %(queued)s, 
+0001b820: 220a 2020 2020 2020 2020 2020 2020 2270  ".            "p
+0001b830: 726f 6365 7373 696e 673a 2025 2870 726f  rocessing: %(pro
+0001b840: 6365 7373 696e 6729 732c 2022 0a20 2020  cessing)s, ".   
+0001b850: 2020 2020 2020 2020 2022 696e 2d6d 656d           "in-mem
+0001b860: 6f72 793a 2025 286d 656d 6f72 7929 732c  ory: %(memory)s,
+0001b870: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
+0001b880: 6e6f 2d77 6f72 6b65 723a 2025 286e 6f5f  no-worker: %(no_
+0001b890: 776f 726b 6572 2973 2c20 220a 2020 2020  worker)s, ".    
+0001b8a0: 2020 2020 2020 2020 2265 7272 6564 3a20          "erred: 
+0001b8b0: 2528 6572 7265 6429 7322 2025 2074 6f74  %(erred)s" % tot
+0001b8c0: 616c 730a 2020 2020 2020 2020 290a 0a0a  als.        )...
+0001b8d0: 636c 6173 7320 4669 6e65 5065 7266 6f72  class FinePerfor
+0001b8e0: 6d61 6e63 654d 6574 7269 6373 2844 6173  manceMetrics(Das
+0001b8f0: 6862 6f61 7264 436f 6d70 6f6e 656e 7429  hboardComponent)
+0001b900: 3a0a 2020 2020 2222 220a 2020 2020 5468  :.    """.    Th
+0001b910: 6520 6d61 696e 206f 7665 7276 6965 7720  e main overview 
+0001b920: 6f66 2074 6865 2046 696e 6520 5065 7266  of the Fine Perf
+0001b930: 6f72 6d61 6e63 6520 4d65 7472 6963 7320  ormance Metrics 
+0001b940: 7061 6765 2e0a 2020 2020 2222 220a 0a20  page..    """.. 
+0001b950: 2020 2042 4153 455f 544f 4f4c 5320 3d20     BASE_TOOLS = 
+0001b960: 5b22 7061 6e22 2c20 2277 6865 656c 5f7a  ["pan", "wheel_z
+0001b970: 6f6f 6d22 2c20 2262 6f78 5f7a 6f6f 6d22  oom", "box_zoom"
+0001b980: 2c20 2272 6573 6574 225d 0a20 2020 2073  , "reset"].    s
+0001b990: 6368 6564 756c 6572 3a20 5363 6865 6475  cheduler: Schedu
+0001b9a0: 6c65 720a 2020 2020 7461 736b 5f65 7865  ler.    task_exe
+0001b9b0: 635f 6279 5f70 7265 6669 785f 7372 633a  c_by_prefix_src:
+0001b9c0: 2043 6f6c 756d 6e44 6174 6153 6f75 7263   ColumnDataSourc
+0001b9d0: 650a 2020 2020 7461 736b 5f65 7865 635f  e.    task_exec_
+0001b9e0: 6279 5f70 7265 6669 785f 796d 6178 3a20  by_prefix_ymax: 
+0001b9f0: 666c 6f61 740a 2020 2020 7461 736b 5f65  float.    task_e
+0001ba00: 7865 635f 6279 5f61 6374 6976 6974 795f  xec_by_activity_
+0001ba10: 7372 633a 2043 6f6c 756d 6e44 6174 6153  src: ColumnDataS
+0001ba20: 6f75 7263 650a 2020 2020 6765 745f 6461  ource.    get_da
+0001ba30: 7461 5f62 795f 6163 7469 7669 7479 5f73  ta_by_activity_s
+0001ba40: 7263 3a20 436f 6c75 6d6e 4461 7461 536f  rc: ColumnDataSo
+0001ba50: 7572 6365 0a20 2020 2073 7562 7374 616e  urce.    substan
+0001ba60: 7469 616c 5f63 6861 6e67 653a 2062 6f6f  tial_change: boo
+0001ba70: 6c0a 2020 2020 7669 7369 626c 655f 6675  l.    visible_fu
+0001ba80: 6e63 7469 6f6e 733a 206c 6973 745b 7374  nctions: list[st
+0001ba90: 725d 0a20 2020 2076 6973 6962 6c65 5f61  r].    visible_a
+0001baa0: 6374 6976 6974 6965 733a 206c 6973 745b  ctivities: list[
+0001bab0: 7374 725d 0a20 2020 2066 756e 6374 696f  str].    functio
+0001bac0: 6e5f 7365 6c65 6374 6f72 3a20 4d75 6c74  n_selector: Mult
+0001bad0: 6943 686f 6963 650a 2020 2020 7370 616e  iChoice.    span
+0001bae0: 5f74 6167 5f73 656c 6563 746f 723a 204d  _tag_selector: M
+0001baf0: 756c 7469 4368 6f69 6365 0a20 2020 2075  ultiChoice.    u
+0001bb00: 6e69 745f 7365 6c65 6374 6f72 3a20 5365  nit_selector: Se
+0001bb10: 6c65 6374 0a20 2020 2074 6173 6b5f 6578  lect.    task_ex
+0001bb20: 6563 5f62 795f 6163 7469 7669 7479 5f63  ec_by_activity_c
+0001bb30: 6861 7274 3a20 6669 6775 7265 207c 204e  hart: figure | N
+0001bb40: 6f6e 650a 2020 2020 7461 736b 5f65 7865  one.    task_exe
+0001bb50: 635f 6279 5f70 7265 6669 785f 6368 6172  c_by_prefix_char
+0001bb60: 743a 2066 6967 7572 6520 7c20 4e6f 6e65  t: figure | None
+0001bb70: 0a20 2020 2067 6574 5f64 6174 615f 6279  .    get_data_by
+0001bb80: 5f61 6374 6976 6974 795f 6368 6172 743a  _activity_chart:
+0001bb90: 2066 6967 7572 6520 7c20 4e6f 6e65 0a0a   figure | None..
+0001bba0: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
+0001bbb0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+0001bbc0: 2873 656c 662c 2073 6368 6564 756c 6572  (self, scheduler
+0001bbd0: 3a20 5363 6865 6475 6c65 722c 202a 2a6b  : Scheduler, **k
+0001bbe0: 7761 7267 733a 2041 6e79 293a 0a20 2020  wargs: Any):.   
+0001bbf0: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
+0001bc00: 6c65 7220 3d20 7363 6865 6475 6c65 720a  ler = scheduler.
+0001bc10: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
+0001bc20: 6b5f 6578 6563 5f62 795f 7072 6566 6978  k_exec_by_prefix
+0001bc30: 5f73 7263 203d 2043 6f6c 756d 6e44 6174  _src = ColumnDat
+0001bc40: 6153 6f75 7263 6528 6461 7461 3d7b 7d29  aSource(data={})
+0001bc50: 0a20 2020 2020 2020 2073 656c 662e 7461  .        self.ta
+0001bc60: 736b 5f65 7865 635f 6279 5f70 7265 6669  sk_exec_by_prefi
+0001bc70: 785f 796d 6178 203d 2030 2e30 0a20 2020  x_ymax = 0.0.   
+0001bc80: 2020 2020 2073 656c 662e 7461 736b 5f65       self.task_e
+0001bc90: 7865 635f 6279 5f61 6374 6976 6974 795f  xec_by_activity_
+0001bca0: 7372 6320 3d20 436f 6c75 6d6e 4461 7461  src = ColumnData
+0001bcb0: 536f 7572 6365 2864 6174 613d 7b7d 290a  Source(data={}).
+0001bcc0: 2020 2020 2020 2020 7365 6c66 2e67 6574          self.get
+0001bcd0: 5f64 6174 615f 6279 5f61 6374 6976 6974  _data_by_activit
+0001bce0: 795f 7372 6320 3d20 436f 6c75 6d6e 4461  y_src = ColumnDa
+0001bcf0: 7461 536f 7572 6365 2864 6174 613d 7b7d  taSource(data={}
+0001bd00: 290a 2020 2020 2020 2020 7365 6c66 2e73  ).        self.s
+0001bd10: 7562 7374 616e 7469 616c 5f63 6861 6e67  ubstantial_chang
+0001bd20: 6520 3d20 4661 6c73 650a 2020 2020 2020  e = False.      
+0001bd30: 2020 7365 6c66 2e76 6973 6962 6c65 5f66    self.visible_f
+0001bd40: 756e 6374 696f 6e73 203d 205b 5d0a 2020  unctions = [].  
+0001bd50: 2020 2020 2020 7365 6c66 2e76 6973 6962        self.visib
+0001bd60: 6c65 5f61 6374 6976 6974 6965 7320 3d20  le_activities = 
+0001bd70: 5b5d 0a20 2020 2020 2020 2073 656c 662e  [].        self.
+0001bd80: 7461 736b 5f65 7865 635f 6279 5f61 6374  task_exec_by_act
+0001bd90: 6976 6974 795f 6368 6172 7420 3d20 4e6f  ivity_chart = No
+0001bda0: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
+0001bdb0: 7461 736b 5f65 7865 635f 6279 5f70 7265  task_exec_by_pre
+0001bdc0: 6669 785f 6368 6172 7420 3d20 4e6f 6e65  fix_chart = None
+0001bdd0: 0a20 2020 2020 2020 2073 656c 662e 6765  .        self.ge
+0001bde0: 745f 6461 7461 5f62 795f 6163 7469 7669  t_data_by_activi
+0001bdf0: 7479 5f63 6861 7274 203d 204e 6f6e 650a  ty_chart = None.
+0001be00: 0a20 2020 2020 2020 2023 2053 656c 6563  .        # Selec
+0001be10: 746f 7273 0a20 2020 2020 2020 2073 656c  tors.        sel
+0001be20: 662e 6675 6e63 7469 6f6e 5f73 656c 6563  f.function_selec
+0001be30: 746f 7220 3d20 4d75 6c74 6943 686f 6963  tor = MultiChoic
+0001be40: 6528 0a20 2020 2020 2020 2020 2020 2074  e(.            t
+0001be50: 6974 6c65 3d22 4669 6c74 6572 2062 7920  itle="Filter by 
+0001be60: 6675 6e63 7469 6f6e 222c 0a20 2020 2020  function",.     
+0001be70: 2020 2020 2020 2070 6c61 6365 686f 6c64         placehold
+0001be80: 6572 3d22 5365 6c65 6374 2073 7065 6369  er="Select speci
+0001be90: 6669 6320 6675 6e63 7469 6f6e 7322 2c0a  fic functions",.
+0001bea0: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
+0001beb0: 653d 5b5d 2c0a 2020 2020 2020 2020 2020  e=[],.          
+0001bec0: 2020 6f70 7469 6f6e 733d 5b5d 2c0a 2020    options=[],.  
+0001bed0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0001bee0: 7365 6c66 2e73 7061 6e5f 7461 675f 7365  self.span_tag_se
+0001bef0: 6c65 6374 6f72 203d 204d 756c 7469 4368  lector = MultiCh
+0001bf00: 6f69 6365 280a 2020 2020 2020 2020 2020  oice(.          
+0001bf10: 2020 7469 746c 653d 2246 696c 7465 7220    title="Filter 
+0001bf20: 6279 2073 7061 6e20 7461 6722 2c0a 2020  by span tag",.  
+0001bf30: 2020 2020 2020 2020 2020 706c 6163 6568            placeh
+0001bf40: 6f6c 6465 723d 2253 656c 6563 7420 7370  older="Select sp
+0001bf50: 6563 6966 6963 2073 7061 6e20 7461 6773  ecific span tags
+0001bf60: 222c 0a20 2020 2020 2020 2020 2020 2076  ",.            v
+0001bf70: 616c 7565 3d5b 5d2c 0a20 2020 2020 2020  alue=[],.       
+0001bf80: 2020 2020 206f 7074 696f 6e73 3d5b 5d2c       options=[],
+0001bf90: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0001bfa0: 2020 2073 656c 662e 756e 6974 5f73 656c     self.unit_sel
+0001bfb0: 6563 746f 7220 3d20 5365 6c65 6374 2874  ector = Select(t
+0001bfc0: 6974 6c65 3d22 556e 6974 2073 656c 6563  itle="Unit selec
+0001bfd0: 7469 6f6e 222c 206f 7074 696f 6e73 3d5b  tion", options=[
+0001bfe0: 2273 6563 6f6e 6473 225d 290a 2020 2020  "seconds"]).    
+0001bff0: 2020 2020 7365 6c66 2e75 6e69 745f 7365      self.unit_se
+0001c000: 6c65 6374 6f72 2e76 616c 7565 203d 2022  lector.value = "
+0001c010: 7365 636f 6e64 7322 0a20 2020 2020 2020  seconds".       
+0001c020: 2073 656c 662e 756e 6974 5f73 656c 6563   self.unit_selec
+0001c030: 746f 722e 6f6e 5f63 6861 6e67 6528 2276  tor.on_change("v
+0001c040: 616c 7565 222c 2073 656c 662e 5f68 616e  alue", self._han
+0001c050: 646c 655f 6368 616e 6765 5f75 6e69 7429  dle_change_unit)
+0001c060: 0a0a 2020 2020 2020 2020 7365 6c65 6374  ..        select
+0001c070: 6f72 735f 726f 7720 3d20 726f 7728 0a20  ors_row = row(. 
+0001c080: 2020 2020 2020 2020 2020 2063 6869 6c64             child
+0001c090: 7265 6e3d 5b0a 2020 2020 2020 2020 2020  ren=[.          
+0001c0a0: 2020 2020 2020 7365 6c66 2e73 7061 6e5f        self.span_
+0001c0b0: 7461 675f 7365 6c65 6374 6f72 2c0a 2020  tag_selector,.  
+0001c0c0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0001c0d0: 6c66 2e66 756e 6374 696f 6e5f 7365 6c65  lf.function_sele
+0001c0e0: 6374 6f72 2c0a 2020 2020 2020 2020 2020  ctor,.          
+0001c0f0: 2020 2020 2020 7365 6c66 2e75 6e69 745f        self.unit_
+0001c100: 7365 6c65 6374 6f72 2c0a 2020 2020 2020  selector,.      
+0001c110: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+0001c120: 2020 2020 2073 697a 696e 675f 6d6f 6465       sizing_mode
+0001c130: 3d22 7374 7265 7463 685f 7769 6474 6822  ="stretch_width"
+0001c140: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+0001c150: 2020 2020 7365 6c66 2e72 6f6f 7420 3d20      self.root = 
+0001c160: 636f 6c75 6d6e 280a 2020 2020 2020 2020  column(.        
+0001c170: 2020 2020 7365 6c65 6374 6f72 735f 726f      selectors_ro
+0001c180: 772c 0a20 2020 2020 2020 2020 2020 2073  w,.            s
+0001c190: 697a 696e 675f 6d6f 6465 3d22 7363 616c  izing_mode="scal
+0001c1a0: 655f 7769 6474 6822 2c0a 2020 2020 2020  e_width",.      
+0001c1b0: 2020 290a 0a20 2020 2064 6566 205f 6861    )..    def _ha
+0001c1c0: 6e64 6c65 5f63 6861 6e67 655f 756e 6974  ndle_change_unit
+0001c1d0: 2873 656c 662c 2061 7474 723a 2073 7472  (self, attr: str
+0001c1e0: 2c20 6f6c 643a 2073 7472 2c20 6e65 773a  , old: str, new:
+0001c1f0: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
+0001c200: 2020 2020 2020 2073 656c 662e 7375 6273         self.subs
+0001c210: 7461 6e74 6961 6c5f 6368 616e 6765 203d  tantial_change =
+0001c220: 2054 7275 650a 0a20 2020 2020 2020 2069   True..        i
+0001c230: 6620 6e65 7720 3d3d 2022 7365 636f 6e64  f new == "second
+0001c240: 7322 3a0a 2020 2020 2020 2020 2020 2020  s":.            
+0001c250: 7966 6d74 203d 2022 3030 3a30 303a 3030  yfmt = "00:00:00
+0001c260: 220a 2020 2020 2020 2020 656c 6966 206e  ".        elif n
+0001c270: 6577 203d 3d20 2262 7974 6573 223a 0a20  ew == "bytes":. 
+0001c280: 2020 2020 2020 2020 2020 2079 666d 7420             yfmt 
+0001c290: 3d20 2230 2e30 3062 220a 2020 2020 2020  = "0.00b".      
+0001c2a0: 2020 656c 6966 206e 6577 203d 3d20 2263    elif new == "c
+0001c2b0: 6f75 6e74 223a 0a20 2020 2020 2020 2020  ount":.         
+0001c2c0: 2020 2079 666d 7420 3d20 2230 220a 2020     yfmt = "0".  
+0001c2d0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001c2e0: 2020 2020 2020 2020 7966 6d74 203d 2022          yfmt = "
+0001c2f0: 302e 3030 3022 0a20 2020 2020 2020 2061  0.000".        a
+0001c300: 7373 6572 7420 7365 6c66 2e74 6173 6b5f  ssert self.task_
+0001c310: 6578 6563 5f62 795f 7072 6566 6978 5f63  exec_by_prefix_c
+0001c320: 6861 7274 0a20 2020 2020 2020 2073 656c  hart.        sel
+0001c330: 662e 7461 736b 5f65 7865 635f 6279 5f70  f.task_exec_by_p
+0001c340: 7265 6669 785f 6368 6172 742e 7961 7869  refix_chart.yaxi
+0001c350: 735b 305d 2e66 6f72 6d61 7474 6572 2e66  s[0].formatter.f
+0001c360: 6f72 6d61 7420 3d20 7966 6d74 0a0a 2020  ormat = yfmt..  
+0001c370: 2020 4077 6974 686f 7574 5f70 726f 7065    @without_prope
+0001c380: 7274 795f 7661 6c69 6461 7469 6f6e 0a20  rty_validation. 
+0001c390: 2020 2040 6c6f 675f 6572 726f 7273 0a20     @log_errors. 
+0001c3a0: 2020 2064 6566 2075 7064 6174 6528 7365     def update(se
+0001c3b0: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+0001c3c0: 662e 5f75 7064 6174 655f 7365 6c65 6374  f._update_select
+0001c3d0: 6f72 7328 290a 2020 2020 2020 2020 7365  ors().        se
+0001c3e0: 6c66 2e5f 6275 696c 645f 6461 7461 5f73  lf._build_data_s
+0001c3f0: 6f75 7263 6573 2829 0a0a 2020 2020 2020  ources()..      
+0001c400: 2020 6e65 6564 735f 6669 6775 7265 735f    needs_figures_
+0001c410: 726f 7720 3d20 7365 6c66 2e74 6173 6b5f  row = self.task_
+0001c420: 6578 6563 5f62 795f 6163 7469 7669 7479  exec_by_activity
+0001c430: 5f63 6861 7274 2069 7320 4e6f 6e65 0a20  _chart is None. 
+0001c440: 2020 2020 2020 2069 6620 6e65 6564 735f         if needs_
+0001c450: 6669 6775 7265 735f 726f 773a 0a20 2020  figures_row:.   
+0001c460: 2020 2020 2020 2020 2073 656c 662e 7375           self.su
+0001c470: 6273 7461 6e74 6961 6c5f 6368 616e 6765  bstantial_change
+0001c480: 203d 2054 7275 650a 0a20 2020 2020 2020   = True..       
+0001c490: 2069 6620 6e65 6564 735f 6669 6775 7265   if needs_figure
+0001c4a0: 735f 726f 773a 0a20 2020 2020 2020 2020  s_row:.         
+0001c4b0: 2020 2023 2046 6972 7374 2063 616c 6c20     # First call 
+0001c4c0: 746f 2075 7064 6174 6528 290a 2020 2020  to update().    
+0001c4d0: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
+0001c4e0: 6b5f 6578 6563 5f62 795f 7072 6566 6978  k_exec_by_prefix
+0001c4f0: 5f63 6861 7274 203d 2028 0a20 2020 2020  _chart = (.     
+0001c500: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001c510: 5f62 7569 6c64 5f74 6173 6b5f 6578 6563  _build_task_exec
+0001c520: 7574 696f 6e5f 6279 5f70 7265 6669 785f  ution_by_prefix_
+0001c530: 6368 6172 7428 290a 2020 2020 2020 2020  chart().        
+0001c540: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0001c550: 2020 7365 6c66 2e74 6173 6b5f 6578 6563    self.task_exec
+0001c560: 5f62 795f 6163 7469 7669 7479 5f63 6861  _by_activity_cha
+0001c570: 7274 203d 2073 656c 662e 5f62 7569 6c64  rt = self._build
+0001c580: 5f70 6965 5f63 6861 7274 280a 2020 2020  _pie_chart(.    
+0001c590: 2020 2020 2020 2020 2020 2020 736f 7572              sour
+0001c5a0: 6365 3d73 656c 662e 7461 736b 5f65 7865  ce=self.task_exe
+0001c5b0: 635f 6279 5f61 6374 6976 6974 795f 7372  c_by_activity_sr
+0001c5c0: 632c 0a20 2020 2020 2020 2020 2020 2020  c,.             
+0001c5d0: 2020 2074 6974 6c65 3d22 5461 736b 2065     title="Task e
+0001c5e0: 7865 6375 7469 6f6e 2c20 6279 2061 6374  xecution, by act
+0001c5f0: 6976 6974 7922 2c0a 2020 2020 2020 2020  ivity",.        
+0001c600: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0001c610: 2020 7365 6c66 2e67 6574 5f64 6174 615f    self.get_data_
+0001c620: 6279 5f61 6374 6976 6974 795f 6368 6172  by_activity_char
+0001c630: 7420 3d20 7365 6c66 2e5f 6275 696c 645f  t = self._build_
+0001c640: 7069 655f 6368 6172 7428 0a20 2020 2020  pie_chart(.     
+0001c650: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
+0001c660: 653d 7365 6c66 2e67 6574 5f64 6174 615f  e=self.get_data_
+0001c670: 6279 5f61 6374 6976 6974 795f 7372 632c  by_activity_src,
+0001c680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c690: 2023 2067 6574 5f64 6174 6120 6973 2063   # get_data is c
+0001c6a0: 616c 6c65 6420 7669 6120 5250 4320 666f  alled via RPC fo
+0001c6b0: 7220 6461 7461 2070 756c 6c3b 2074 6865  r data pull; the
+0001c6c0: 206d 6574 7269 6373 2066 6f72 2069 7420   metrics for it 
+0001c6d0: 6172 650a 2020 2020 2020 2020 2020 2020  are.            
+0001c6e0: 2020 2020 2320 7265 636f 7264 6564 206f      # recorded o
+0001c6f0: 6e20 7468 6520 776f 726b 6572 202a 646f  n the worker *do
+0001c700: 6e61 7469 6e67 2a20 7468 6520 6461 7461  nating* the data
+0001c710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c720: 2074 6974 6c65 3d22 5365 6e64 2064 6174   title="Send dat
+0001c730: 612c 2062 7920 6163 7469 7669 7479 222c  a, by activity",
+0001c740: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+0001c750: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
+0001c760: 6b5f 6578 6563 5f62 795f 7072 6566 6978  k_exec_by_prefix
+0001c770: 5f63 6861 7274 2e79 5f72 616e 6765 2e65  _chart.y_range.e
+0001c780: 6e64 203d 2073 656c 662e 7461 736b 5f65  nd = self.task_e
+0001c790: 7865 635f 6279 5f70 7265 6669 785f 796d  xec_by_prefix_ym
+0001c7a0: 6178 202a 2031 2e31 0a0a 2020 2020 2020  ax * 1.1..      
+0001c7b0: 2020 6966 2073 656c 662e 7375 6273 7461    if self.substa
+0001c7c0: 6e74 6961 6c5f 6368 616e 6765 3a0a 2020  ntial_change:.  
+0001c7d0: 2020 2020 2020 2020 2020 2320 5669 7369            # Visi
+0001c7e0: 626c 6520 6163 7469 7669 7469 6573 2061  ble activities a
+0001c7f0: 6e64 2f6f 7220 6675 6e63 7469 6f6e 7320  nd/or functions 
+0001c800: 6368 616e 6765 640a 2020 2020 2020 2020  changed.        
 0001c810: 2020 2020 7365 6c66 2e73 7562 7374 616e      self.substan
-0001c820: 7469 616c 5f63 6861 6e67 6520 3d20 5472  tial_change = Tr
-0001c830: 7565 0a20 2020 2020 2020 2020 2020 2073  ue.            s
-0001c840: 656c 662e 7461 736b 5f65 7865 635f 6461  elf.task_exec_da
-0001c850: 7461 5b22 7469 6d65 7374 616d 7022 5d2e  ta["timestamp"].
-0001c860: 6578 7465 6e64 2864 6174 6574 696d 652e  extend(datetime.
-0001c870: 6e6f 7728 2920 666f 7220 5f20 696e 2066  now() for _ in f
-0001c880: 756e 6374 696f 6e73 290a 2020 2020 2020  unctions).      
-0001c890: 2020 2020 2020 7365 6c66 2e66 756e 6374        self.funct
-0001c8a0: 696f 6e5f 7365 6c65 6374 6f72 2e6f 7074  ion_selector.opt
-0001c8b0: 696f 6e73 2e65 7874 656e 6428 6675 6e63  ions.extend(func
-0001c8c0: 7469 6f6e 7329 0a20 2020 2020 2020 2020  tions).         
-0001c8d0: 2020 2073 656c 662e 7461 736b 5f65 7865     self.task_exe
-0001c8e0: 635f 6461 7461 5b22 6675 6e63 7469 6f6e  c_data["function
-0001c8f0: 7322 5d2e 6578 7465 6e64 2866 756e 6374  s"].extend(funct
-0001c900: 696f 6e73 290a 0a20 2020 2020 2020 2066  ions)..        f
-0001c910: 6f72 2061 6374 6976 6974 792c 2075 6e69  or activity, uni
-0001c920: 742c 2076 616c 2069 6e20 6765 745f 6461  t, val in get_da
-0001c930: 7461 5f6d 6574 7269 6373 3a0a 2020 2020  ta_metrics:.    
-0001c940: 2020 2020 2020 2020 6966 2061 6374 6976          if activ
-0001c950: 6974 7920 6e6f 7420 696e 2073 656c 662e  ity not in self.
-0001c960: 7365 6e64 6461 7461 5b22 6163 7469 7669  senddata["activi
-0001c970: 7479 225d 3a0a 2020 2020 2020 2020 2020  ty"]:.          
-0001c980: 2020 2020 2020 7365 6c66 2e73 7562 7374        self.subst
-0001c990: 616e 7469 616c 5f63 6861 6e67 6520 3d20  antial_change = 
-0001c9a0: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-0001c9b0: 2020 2020 2073 656c 662e 7365 6e64 6461       self.sendda
-0001c9c0: 7461 5b22 6163 7469 7669 7479 225d 2e61  ta["activity"].a
-0001c9d0: 7070 656e 6428 6163 7469 7669 7479 290a  ppend(activity).
-0001c9e0: 0a20 2020 2020 2020 2020 2020 2069 6478  .            idx
-0001c9f0: 203d 2073 656c 662e 7365 6e64 6461 7461   = self.senddata
-0001ca00: 5b22 6163 7469 7669 7479 225d 2e69 6e64  ["activity"].ind
-0001ca10: 6578 2861 6374 6976 6974 7929 0a20 2020  ex(activity).   
-0001ca20: 2020 2020 2020 2020 2077 6869 6c65 2069           while i
-0001ca30: 6478 203e 3d20 6c65 6e28 7365 6c66 2e73  dx >= len(self.s
-0001ca40: 656e 6464 6174 615b 6622 7b61 6374 6976  enddata[f"{activ
-0001ca50: 6974 797d 5f7b 756e 6974 7d22 5d29 3a0a  ity}_{unit}"]):.
-0001ca60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca70: 7365 6c66 2e73 656e 6464 6174 615b 6622  self.senddata[f"
-0001ca80: 7b61 6374 6976 6974 797d 5f7b 756e 6974  {activity}_{unit
-0001ca90: 7d22 5d2e 6170 7065 6e64 2830 290a 2020  }"].append(0).  
-0001caa0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0001cab0: 6c66 2e73 656e 6464 6174 615b 6622 7b61  lf.senddata[f"{a
-0001cac0: 6374 6976 6974 797d 5f7b 756e 6974 7d5f  ctivity}_{unit}_
-0001cad0: 7465 7874 225d 2e61 7070 656e 6428 2222  text"].append(""
-0001cae0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-0001caf0: 6c66 2e73 656e 6464 6174 615b 6622 7b61  lf.senddata[f"{a
-0001cb00: 6374 6976 6974 797d 5f7b 756e 6974 7d5f  ctivity}_{unit}_
-0001cb10: 7465 7874 225d 5b69 6478 5d20 3d20 7365  text"][idx] = se
-0001cb20: 6c66 2e66 6f72 6d61 7428 756e 6974 2c20  lf.format(unit, 
-0001cb30: 7661 6c29 0a20 2020 2020 2020 2020 2020  val).           
-0001cb40: 2073 656c 662e 7365 6e64 6461 7461 5b66   self.senddata[f
-0001cb50: 227b 6163 7469 7669 7479 7d5f 7b75 6e69  "{activity}_{uni
-0001cb60: 747d 225d 5b69 6478 5d20 3d20 7661 6c0a  t}"][idx] = val.
-0001cb70: 0a20 2020 2020 2020 2066 6f72 2070 7265  .        for pre
-0001cb80: 6669 782c 2061 6374 6976 6974 792c 2075  fix, activity, u
-0001cb90: 6e69 742c 2076 616c 2069 6e20 6578 6563  nit, val in exec
-0001cba0: 7574 655f 6d65 7472 6963 733a 0a20 2020  ute_metrics:.   
-0001cbb0: 2020 2020 2020 2020 2069 6478 203d 2073           idx = s
-0001cbc0: 656c 662e 7461 736b 5f65 7865 635f 6461  elf.task_exec_da
-0001cbd0: 7461 5b22 6675 6e63 7469 6f6e 7322 5d2e  ta["functions"].
-0001cbe0: 696e 6465 7828 7072 6566 6978 290a 0a20  index(prefix).. 
-0001cbf0: 2020 2020 2020 2020 2020 2023 2053 6f6d             # Som
-0001cc00: 6520 6675 6e63 7469 6f6e 2f61 6374 6976  e function/activ
-0001cc10: 6974 7920 636f 6d62 6f73 206d 6973 7369  ity combos missi
-0001cc20: 6e67 2c20 736f 206e 6565 6420 746f 206b  ng, so need to k
-0001cc30: 6565 7020 636f 6c75 6d6e 7320 616c 6967  eep columns alig
-0001cc40: 6e65 640a 2020 2020 2020 2020 2020 2020  ned.            
-0001cc50: 666f 7220 6f70 2069 6e20 7365 6c66 2e74  for op in self.t
-0001cc60: 6173 6b5f 6163 7469 7669 7469 6573 3a0a  ask_activities:.
-0001cc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc80: 7768 696c 6520 6c65 6e28 7365 6c66 2e74  while len(self.t
-0001cc90: 6173 6b5f 6578 6563 5f64 6174 615b 6622  ask_exec_data[f"
-0001cca0: 7b6f 707d 5f7b 756e 6974 7d22 5d29 2021  {op}_{unit}"]) !
-0001ccb0: 3d20 6c65 6e28 0a20 2020 2020 2020 2020  = len(.         
-0001ccc0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001ccd0: 7461 736b 5f65 7865 635f 6461 7461 5b22  task_exec_data["
-0001cce0: 6675 6e63 7469 6f6e 7322 5d0a 2020 2020  functions"].    
-0001ccf0: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
-0001cd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cd10: 2020 2073 656c 662e 7461 736b 5f65 7865     self.task_exe
-0001cd20: 635f 6461 7461 5b66 227b 6f70 7d5f 7b75  c_data[f"{op}_{u
-0001cd30: 6e69 747d 225d 2e61 7070 656e 6428 3029  nit}"].append(0)
-0001cd40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001cd50: 2020 2020 2073 656c 662e 7461 736b 5f65       self.task_e
-0001cd60: 7865 635f 6461 7461 5b66 227b 6f70 7d5f  xec_data[f"{op}_
-0001cd70: 7b75 6e69 747d 5f74 6578 7422 5d2e 6170  {unit}_text"].ap
-0001cd80: 7065 6e64 2822 2229 0a0a 2020 2020 2020  pend("")..      
-0001cd90: 2020 2020 2020 7365 6c66 2e74 6173 6b5f        self.task_
-0001cda0: 6578 6563 5f64 6174 615b 6622 7b61 6374  exec_data[f"{act
-0001cdb0: 6976 6974 797d 5f7b 756e 6974 7d22 5d5b  ivity}_{unit}"][
-0001cdc0: 6964 785d 203d 2076 616c 0a20 2020 2020  idx] = val.     
-0001cdd0: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
-0001cde0: 5f65 7865 635f 6461 7461 5b66 227b 6163  _exec_data[f"{ac
-0001cdf0: 7469 7669 7479 7d5f 7b75 6e69 747d 5f74  tivity}_{unit}_t
-0001ce00: 6578 7422 5d5b 6964 785d 203d 2073 656c  ext"][idx] = sel
-0001ce10: 662e 666f 726d 6174 2875 6e69 742c 2076  f.format(unit, v
-0001ce20: 616c 290a 0a20 2020 2020 2020 2064 6174  al)..        dat
-0001ce30: 6120 3d20 7365 6c66 2e74 6173 6b5f 6578  a = self.task_ex
-0001ce40: 6563 5f64 6174 612e 636f 7079 2829 0a20  ec_data.copy(). 
-0001ce50: 2020 2020 2020 2023 2049 6620 7573 6572         # If user
-0001ce60: 2068 6173 206d 616e 7561 6c6c 7920 7365   has manually se
-0001ce70: 6c65 6374 6564 2066 756e 6374 696f 6e28  lected function(
-0001ce80: 7329 2074 6865 6e20 7765 2061 7265 206f  s) then we are o
-0001ce90: 6e6c 7920 7368 6f77 696e 6720 7468 656d  nly showing them
-0001cea0: 2e0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-0001ceb0: 662e 6675 6e63 7469 6f6e 5f73 656c 6563  f.function_selec
-0001cec0: 746f 722e 7661 6c75 653a 0a20 2020 2020  tor.value:.     
-0001ced0: 2020 2020 2020 2069 6e64 6578 6573 203d         indexes =
-0001cee0: 205b 6461 7461 5b22 6675 6e63 7469 6f6e   [data["function
-0001cef0: 7322 5d2e 696e 6465 7828 6629 2066 6f72  s"].index(f) for
-0001cf00: 2066 2069 6e20 7365 6c66 2e66 756e 6374   f in self.funct
-0001cf10: 696f 6e5f 7365 6c65 6374 6f72 2e76 616c  ion_selector.val
-0001cf20: 7565 5d0a 2020 2020 2020 2020 2020 2020  ue].            
-0001cf30: 666f 7220 6b65 792c 2076 616c 7565 7320  for key, values 
-0001cf40: 696e 2064 6174 612e 6974 656d 7328 293a  in data.items():
-0001cf50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001cf60: 2064 6174 615b 6b65 795d 203d 205b 7661   data[key] = [va
-0001cf70: 6c75 6573 5b69 6478 5d20 666f 7220 6964  lues[idx] for id
-0001cf80: 7820 696e 2069 6e64 6578 6573 5d0a 0a20  x in indexes].. 
-0001cf90: 2020 2020 2020 2023 204f 7468 6572 7769         # Otherwi
-0001cfa0: 7365 206c 696d 6974 2074 686f 7365 2062  se limit those b
-0001cfb0: 6569 6e67 2073 686f 776e 2077 6869 6368  eing shown which
-0001cfc0: 2068 6176 6520 2765 7870 6972 6564 2720   have 'expired' 
-0001cfd0: 746f 2062 6520 6469 7370 6c61 7965 640a  to be displayed.
-0001cfe0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001cff0: 2020 2020 2020 2020 2020 6375 746f 6666            cutoff
-0001d000: 203d 2064 6174 6574 696d 652e 7574 636e   = datetime.utcn
-0001d010: 6f77 2829 202d 2074 696d 6564 656c 7461  ow() - timedelta
-0001d020: 2873 6563 6f6e 6473 3d31 3029 0a20 2020  (seconds=10).   
-0001d030: 2020 2020 2020 2020 206e 5f73 686f 7720           n_show 
-0001d040: 3d20 6c65 6e28 5b64 2066 6f72 2064 2069  = len([d for d i
-0001d050: 6e20 6461 7461 5b22 7469 6d65 7374 616d  n data["timestam
-0001d060: 7022 5d20 6966 2064 203e 2063 7574 6f66  p"] if d > cutof
-0001d070: 665d 2920 6f72 2035 0a20 2020 2020 2020  f]) or 5.       
-0001d080: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
-0001d090: 6461 7461 3a0a 2020 2020 2020 2020 2020  data:.          
-0001d0a0: 2020 2020 2020 6461 7461 5b6b 6579 5d20        data[key] 
-0001d0b0: 3d20 6461 7461 5b6b 6579 5d5b 2d6e 5f73  = data[key][-n_s
-0001d0c0: 686f 773a 5d0a 2020 2020 2020 2020 7365  how:].        se
-0001d0d0: 6c66 2e74 6173 6b5f 6578 6563 5f64 6174  lf.task_exec_dat
-0001d0e0: 615f 6c69 6d69 7465 6420 3d20 6461 7461  a_limited = data
-0001d0f0: 2e63 6f70 7928 290a 0a20 2020 2020 2020  .copy()..       
-0001d100: 2023 2053 686f 7720 746f 7461 6c20 6e75   # Show total nu
-0001d110: 6d62 6572 206f 6620 6675 6e63 7469 6f6e  mber of function
-0001d120: 7320 746f 2063 686f 6f73 6520 6672 6f6d  s to choose from
-0001d130: 0a20 2020 2020 2020 2073 656c 662e 6675  .        self.fu
-0001d140: 6e63 7469 6f6e 5f73 656c 6563 746f 722e  nction_selector.
-0001d150: 7469 746c 6520 3d20 280a 2020 2020 2020  title = (.      
-0001d160: 2020 2020 2020 6622 4669 6c74 6572 2062        f"Filter b
-0001d170: 7920 6675 6e63 7469 6f6e 2028 7b6c 656e  y function ({len
-0001d180: 2873 656c 662e 6675 6e63 7469 6f6e 5f73  (self.function_s
-0001d190: 656c 6563 746f 722e 6f70 7469 6f6e 7329  elector.options)
-0001d1a0: 7d29 3a22 0a20 2020 2020 2020 2029 0a0a  }):".        )..
-0001d1b0: 2020 2020 2020 2020 6e65 6564 735f 6669          needs_fi
-0001d1c0: 6775 7265 735f 726f 7720 3d20 7365 6c66  gures_row = self
-0001d1d0: 2e74 6173 6b5f 6578 6563 5f62 795f 6163  .task_exec_by_ac
-0001d1e0: 7469 7669 7479 5f63 6861 7274 2069 7320  tivity_chart is 
-0001d1f0: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
-0001d200: 662e 5f62 7569 6c64 5f74 6173 6b5f 6578  f._build_task_ex
-0001d210: 6563 7574 696f 6e5f 6279 5f61 6374 6976  ecution_by_activ
-0001d220: 6974 795f 6368 6172 7428 7365 6c66 2e74  ity_chart(self.t
-0001d230: 6173 6b5f 6578 6563 5f64 6174 615f 6c69  ask_exec_data_li
-0001d240: 6d69 7465 642e 636f 7079 2829 290a 2020  mited.copy()).  
-0001d250: 2020 2020 2020 7365 6c66 2e5f 6275 696c        self._buil
-0001d260: 645f 7461 736b 5f65 7865 6375 7469 6f6e  d_task_execution
-0001d270: 5f62 795f 7072 6566 6978 5f63 6861 7274  _by_prefix_chart
-0001d280: 2873 656c 662e 7461 736b 5f65 7865 635f  (self.task_exec_
-0001d290: 6461 7461 5f6c 696d 6974 6564 2e63 6f70  data_limited.cop
-0001d2a0: 7928 2929 0a20 2020 2020 2020 2073 656c  y()).        sel
-0001d2b0: 662e 5f62 7569 6c64 5f73 656e 6464 6174  f._build_senddat
-0001d2c0: 615f 6368 6172 7428 7365 6c66 2e73 656e  a_chart(self.sen
-0001d2d0: 6464 6174 612e 636f 7079 2829 290a 0a20  ddata.copy()).. 
-0001d2e0: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
-0001d2f0: 7562 7374 616e 7469 616c 5f63 6861 6e67  ubstantial_chang
-0001d300: 6520 6f72 206e 6565 6473 5f66 6967 7572  e or needs_figur
-0001d310: 6573 5f72 6f77 3a0a 2020 2020 2020 2020  es_row:.        
-0001d320: 2020 2020 7365 6c66 2e73 7562 7374 616e      self.substan
-0001d330: 7469 616c 5f63 6861 6e67 6520 3d20 4661  tial_change = Fa
-0001d340: 6c73 650a 0a20 2020 2020 2020 2020 2020  lse..           
-0001d350: 2066 6967 7572 6573 5f72 6f77 203d 2072   figures_row = r
-0001d360: 6f77 280a 2020 2020 2020 2020 2020 2020  ow(.            
-0001d370: 2020 2020 6368 696c 6472 656e 3d5b 0a20      children=[. 
-0001d380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d390: 2020 2073 656c 662e 7461 736b 5f65 7865     self.task_exe
-0001d3a0: 635f 6279 5f70 7265 6669 785f 6368 6172  c_by_prefix_char
-0001d3b0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-0001d3c0: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
-0001d3d0: 5f65 7865 635f 6279 5f61 6374 6976 6974  _exec_by_activit
-0001d3e0: 795f 6368 6172 742c 0a20 2020 2020 2020  y_chart,.       
-0001d3f0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0001d400: 662e 7365 6e64 6461 7461 5f62 795f 6163  f.senddata_by_ac
-0001d410: 7469 7669 7479 5f63 6861 7274 2c0a 2020  tivity_chart,.  
-0001d420: 2020 2020 2020 2020 2020 2020 2020 5d2c                ],
-0001d430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d440: 2073 697a 696e 675f 6d6f 6465 3d22 7374   sizing_mode="st
-0001d450: 7265 7463 685f 7769 6474 6822 2c0a 2020  retch_width",.  
-0001d460: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-0001d470: 2020 2020 2020 2020 2069 6620 6e65 6564           if need
-0001d480: 735f 6669 6775 7265 735f 726f 773a 0a20  s_figures_row:. 
-0001d490: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0001d4a0: 2046 6972 7374 2069 7465 7261 7469 6f6e   First iteration
-0001d4b0: 2c20 696e 6974 6961 6c20 6173 7369 676e  , initial assign
-0001d4c0: 6d65 6e74 206f 6620 6669 6775 7265 7320  ment of figures 
-0001d4d0: 726f 770a 2020 2020 2020 2020 2020 2020  row.            
-0001d4e0: 2020 2020 7365 6c66 2e72 6f6f 742e 6368      self.root.ch
-0001d4f0: 696c 6472 656e 2e61 7070 656e 6428 6669  ildren.append(fi
-0001d500: 6775 7265 735f 726f 7729 0a20 2020 2020  gures_row).     
-0001d510: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001d520: 2020 2020 2020 2020 2020 2020 2023 204f               # O
-0001d530: 7468 6572 7769 7365 206e 6565 6473 2066  therwise needs f
-0001d540: 6f72 6365 6420 7265 6672 6573 6820 6279  orced refresh by
-0001d550: 2072 6570 6c61 6369 6e67 2074 6865 2066   replacing the f
-0001d560: 6967 7572 6573 2072 6f77 0a20 2020 2020  igures row.     
-0001d570: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001d580: 726f 6f74 2e63 6869 6c64 7265 6e5b 2d31  root.children[-1
-0001d590: 5d20 3d20 6669 6775 7265 735f 726f 770a  ] = figures_row.
-0001d5a0: 0a20 2020 2064 6566 205f 6275 696c 645f  .    def _build_
-0001d5b0: 7461 736b 5f65 7865 6375 7469 6f6e 5f62  task_execution_b
-0001d5c0: 795f 6163 7469 7669 7479 5f63 6861 7274  y_activity_chart
-0001d5d0: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
-0001d5e0: 7461 736b 5f65 7865 635f 6461 7461 3a20  task_exec_data: 
-0001d5f0: 6465 6661 756c 7464 6963 745b 7374 722c  defaultdict[str,
-0001d600: 206c 6973 745d 0a20 2020 2029 202d 3e20   list].    ) -> 
-0001d610: 4e6f 6e65 3a0a 2020 2020 2020 2020 7069  None:.        pi
-0001d620: 6563 6861 7274 5f64 6174 6120 3d20 7b7d  echart_data = {}
-0001d630: 0a20 2020 2020 2020 2070 6965 6368 6172  .        piechar
-0001d640: 745f 6461 7461 5b22 7661 6c75 6522 5d20  t_data["value"] 
-0001d650: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-0001d660: 7375 6d28 7461 736b 5f65 7865 635f 6461  sum(task_exec_da
-0001d670: 7461 5b66 227b 6f70 7d5f 7b73 656c 662e  ta[f"{op}_{self.
-0001d680: 756e 6974 5f73 656c 6563 7465 647d 225d  unit_selected}"]
-0001d690: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
-0001d6a0: 7220 6f70 2069 6e20 7365 6c66 2e74 6173  r op in self.tas
-0001d6b0: 6b5f 6163 7469 7669 7469 6573 0a20 2020  k_activities.   
-0001d6c0: 2020 2020 205d 0a20 2020 2020 2020 2070       ].        p
-0001d6d0: 6965 6368 6172 745f 6461 7461 5b22 7465  iechart_data["te
-0001d6e0: 7874 225d 203d 205b 0a20 2020 2020 2020  xt"] = [.       
-0001d6f0: 2020 2020 2073 656c 662e 666f 726d 6174       self.format
-0001d700: 2873 656c 662e 756e 6974 5f73 656c 6563  (self.unit_selec
-0001d710: 7465 642c 2076 2920 666f 7220 7620 696e  ted, v) for v in
-0001d720: 2070 6965 6368 6172 745f 6461 7461 5b22   piechart_data["
-0001d730: 7661 6c75 6522 5d0a 2020 2020 2020 2020  value"].        
-0001d740: 5d0a 2020 2020 2020 2020 7069 6563 6861  ].        piecha
-0001d750: 7274 5f64 6174 615b 2261 6e67 6c65 225d  rt_data["angle"]
-0001d760: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-0001d770: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-0001d780: 2020 2073 756d 2874 6173 6b5f 6578 6563     sum(task_exec
-0001d790: 5f64 6174 615b 6622 7b61 6374 6976 6974  _data[f"{activit
-0001d7a0: 797d 5f7b 7365 6c66 2e75 6e69 745f 7365  y}_{self.unit_se
-0001d7b0: 6c65 6374 6564 7d22 5d29 0a20 2020 2020  lected}"]).     
-0001d7c0: 2020 2020 2020 2020 2020 202f 2073 756d             / sum
-0001d7d0: 2870 6965 6368 6172 745f 6461 7461 5b22  (piechart_data["
-0001d7e0: 7661 6c75 6522 5d29 0a20 2020 2020 2020  value"]).       
-0001d7f0: 2020 2020 2020 2020 2069 6620 7375 6d28           if sum(
-0001d800: 7069 6563 6861 7274 5f64 6174 615b 2276  piechart_data["v
-0001d810: 616c 7565 225d 290a 2020 2020 2020 2020  alue"]).        
-0001d820: 2020 2020 2020 2020 656c 7365 2030 2020          else 0  
-0001d830: 2320 6d61 7920 6e6f 7420 6861 7665 2061  # may not have a
-0001d840: 6e79 2062 7974 6573 206d 6f76 656d 656e  ny bytes movemen
-0001d850: 7420 7265 706f 7274 6564 2c20 6176 6f69  t reported, avoi
-0001d860: 6420 6469 7669 6465 2062 7920 7a65 726f  d divide by zero
-0001d870: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0001d880: 2020 2020 2020 2020 2020 202a 2032 0a20             * 2. 
-0001d890: 2020 2020 2020 2020 2020 202a 206d 6174             * mat
-0001d8a0: 682e 7069 0a20 2020 2020 2020 2020 2020  h.pi.           
-0001d8b0: 2066 6f72 2061 6374 6976 6974 7920 696e   for activity in
-0001d8c0: 2073 656c 662e 7461 736b 5f61 6374 6976   self.task_activ
-0001d8d0: 6974 6965 730a 2020 2020 2020 2020 5d0a  ities.        ].
-0001d8e0: 2020 2020 2020 2020 7069 6563 6861 7274          piechart
-0001d8f0: 5f64 6174 615b 2263 6f6c 6f72 225d 203d  _data["color"] =
-0001d900: 2073 656c 662e 5f67 6574 5f70 616c 6574   self._get_palet
-0001d910: 7465 286c 656e 2873 656c 662e 7461 736b  te(len(self.task
-0001d920: 5f61 6374 6976 6974 6965 7329 290a 2020  _activities)).  
-0001d930: 2020 2020 2020 7069 6563 6861 7274 5f64        piechart_d
-0001d940: 6174 615b 2261 6374 6976 6974 7922 5d20  ata["activity"] 
-0001d950: 3d20 7365 6c66 2e74 6173 6b5f 6163 7469  = self.task_acti
-0001d960: 7669 7469 6573 0a20 2020 2020 2020 2073  vities.        s
-0001d970: 656c 662e 7461 736b 5f65 7865 635f 6279  elf.task_exec_by
-0001d980: 5f61 6374 6976 6974 795f 7372 632e 6461  _activity_src.da
-0001d990: 7461 203d 2070 6965 6368 6172 745f 6461  ta = piechart_da
-0001d9a0: 7461 0a0a 2020 2020 2020 2020 6966 2073  ta..        if s
-0001d9b0: 656c 662e 7461 736b 5f65 7865 635f 6279  elf.task_exec_by
-0001d9c0: 5f61 6374 6976 6974 795f 6368 6172 7420  _activity_chart 
-0001d9d0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0001d9e0: 2020 2020 2070 6965 6368 6172 7420 3d20       piechart = 
-0001d9f0: 6669 6775 7265 280a 2020 2020 2020 2020  figure(.        
-0001da00: 2020 2020 2020 2020 6865 6967 6874 3d35          height=5
-0001da10: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
-0001da20: 2020 2020 7369 7a69 6e67 5f6d 6f64 653d      sizing_mode=
-0001da30: 2273 6361 6c65 5f62 6f74 6822 2c0a 2020  "scale_both",.  
-0001da40: 2020 2020 2020 2020 2020 2020 2020 7469                ti
-0001da50: 746c 653d 2254 6173 6b20 6578 6563 7574  tle="Task execut
-0001da60: 696f 6e2c 2062 7920 6163 7469 7669 7479  ion, by activity
-0001da70: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0001da80: 2020 2074 6f6f 6c73 3d22 686f 7665 7222     tools="hover"
-0001da90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001daa0: 2020 746f 6f6c 7469 7073 3d22 407b 6163    tooltips="@{ac
-0001dab0: 7469 7669 7479 7d3a 2040 7465 7874 222c  tivity}: @text",
-0001dac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001dad0: 2078 5f72 616e 6765 3d28 2d30 2e35 2c20   x_range=(-0.5, 
-0001dae0: 312e 3029 2c0a 2020 2020 2020 2020 2020  1.0),.          
-0001daf0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0001db00: 7069 6563 6861 7274 2e61 7869 732e 6178  piechart.axis.ax
-0001db10: 6973 5f6c 6162 656c 203d 204e 6f6e 650a  is_label = None.
-0001db20: 2020 2020 2020 2020 2020 2020 7069 6563              piec
-0001db30: 6861 7274 2e61 7869 732e 7669 7369 626c  hart.axis.visibl
-0001db40: 6520 3d20 4661 6c73 650a 2020 2020 2020  e = False.      
-0001db50: 2020 2020 2020 7069 6563 6861 7274 2e67        piechart.g
-0001db60: 7269 642e 6772 6964 5f6c 696e 655f 636f  rid.grid_line_co
-0001db70: 6c6f 7220 3d20 4e6f 6e65 0a0a 2020 2020  lor = None..    
-0001db80: 2020 2020 2020 2020 7069 6563 6861 7274          piechart
-0001db90: 2e77 6564 6765 280a 2020 2020 2020 2020  .wedge(.        
-0001dba0: 2020 2020 2020 2020 783d 302c 0a20 2020          x=0,.   
-0001dbb0: 2020 2020 2020 2020 2020 2020 2079 3d31               y=1
-0001dbc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001dbd0: 2020 7261 6469 7573 3d30 2e34 2c0a 2020    radius=0.4,.  
-0001dbe0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0001dbf0: 6172 745f 616e 676c 653d 6375 6d73 756d  art_angle=cumsum
-0001dc00: 2822 616e 676c 6522 2c20 696e 636c 7564  ("angle", includ
-0001dc10: 655f 7a65 726f 3d54 7275 6529 2c0a 2020  e_zero=True),.  
-0001dc20: 2020 2020 2020 2020 2020 2020 2020 656e                en
-0001dc30: 645f 616e 676c 653d 6375 6d73 756d 2822  d_angle=cumsum("
-0001dc40: 616e 676c 6522 292c 0a20 2020 2020 2020  angle"),.       
-0001dc50: 2020 2020 2020 2020 206c 696e 655f 636f           line_co
-0001dc60: 6c6f 723d 2277 6869 7465 222c 0a20 2020  lor="white",.   
-0001dc70: 2020 2020 2020 2020 2020 2020 2066 696c               fil
-0001dc80: 6c5f 636f 6c6f 723d 2263 6f6c 6f72 222c  l_color="color",
-0001dc90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001dca0: 206c 6567 656e 645f 6669 656c 643d 2261   legend_field="a
-0001dcb0: 6374 6976 6974 7922 2c0a 2020 2020 2020  ctivity",.      
-0001dcc0: 2020 2020 2020 2020 2020 736f 7572 6365            source
-0001dcd0: 3d73 656c 662e 7461 736b 5f65 7865 635f  =self.task_exec_
-0001dce0: 6279 5f61 6374 6976 6974 795f 7372 632c  by_activity_src,
-0001dcf0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0001dd00: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001dd10: 7461 736b 5f65 7865 635f 6279 5f61 6374  task_exec_by_act
-0001dd20: 6976 6974 795f 6368 6172 7420 3d20 7069  ivity_chart = pi
-0001dd30: 6563 6861 7274 0a0a 2020 2020 6465 6620  echart..    def 
-0001dd40: 5f62 7569 6c64 5f74 6173 6b5f 6578 6563  _build_task_exec
-0001dd50: 7574 696f 6e5f 6279 5f70 7265 6669 785f  ution_by_prefix_
-0001dd60: 6368 6172 7428 0a20 2020 2020 2020 2073  chart(.        s
-0001dd70: 656c 662c 2074 6173 6b5f 6578 6563 5f64  elf, task_exec_d
-0001dd80: 6174 613a 2064 6566 6175 6c74 6469 6374  ata: defaultdict
-0001dd90: 5b73 7472 2c20 6c69 7374 5d0a 2020 2020  [str, list].    
-0001dda0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0001ddb0: 2020 2066 756e 6374 696f 6e73 203d 2074     functions = t
-0001ddc0: 6173 6b5f 6578 6563 5f64 6174 615b 2266  ask_exec_data["f
-0001ddd0: 756e 6374 696f 6e73 225d 0a20 2020 2020  unctions"].     
-0001dde0: 2020 2062 6173 655f 746f 6f6c 7320 3d20     base_tools = 
-0001ddf0: 2270 616e 2c77 6865 656c 5f7a 6f6f 6d2c  "pan,wheel_zoom,
-0001de00: 626f 785f 7a6f 6f6d 2c72 6573 6574 220a  box_zoom,reset".
-0001de10: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0001de20: 2e74 6173 6b5f 6578 6563 5f62 795f 7072  .task_exec_by_pr
-0001de30: 6566 6978 5f63 6861 7274 2069 7320 4e6f  efix_chart is No
-0001de40: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0001de50: 6261 7263 6861 7274 203d 2066 6967 7572  barchart = figur
-0001de60: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-0001de70: 2020 2078 5f72 616e 6765 3d66 756e 6374     x_range=funct
-0001de80: 696f 6e73 2c0a 2020 2020 2020 2020 2020  ions,.          
-0001de90: 2020 2020 2020 6865 6967 6874 3d35 3030        height=500
-0001dea0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001deb0: 2020 7369 7a69 6e67 5f6d 6f64 653d 2273    sizing_mode="s
-0001dec0: 6361 6c65 5f62 6f74 6822 2c0a 2020 2020  cale_both",.    
-0001ded0: 2020 2020 2020 2020 2020 2020 7469 746c              titl
-0001dee0: 653d 2254 6173 6b20 6578 6563 7574 696f  e="Task executio
-0001def0: 6e2c 2062 7920 6675 6e63 7469 6f6e 222c  n, by function",
-0001df00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001df10: 2074 6f6f 6c73 3d62 6173 655f 746f 6f6c   tools=base_tool
-0001df20: 732c 0a20 2020 2020 2020 2020 2020 2029  s,.            )
-0001df30: 0a20 2020 2020 2020 2020 2020 2062 6172  .            bar
-0001df40: 6368 6172 742e 7961 7869 732e 7669 7369  chart.yaxis.visi
-0001df50: 626c 6520 3d20 4661 6c73 650a 2020 2020  ble = False.    
-0001df60: 2020 2020 2020 2020 6261 7263 6861 7274          barchart
-0001df70: 2e78 6178 6973 2e6d 616a 6f72 5f6c 6162  .xaxis.major_lab
-0001df80: 656c 5f6f 7269 656e 7461 7469 6f6e 203d  el_orientation =
-0001df90: 2030 2e32 0a20 2020 2020 2020 2020 2020   0.2.           
-0001dfa0: 2062 6172 6368 6172 742e 6772 6964 2e67   barchart.grid.g
-0001dfb0: 7269 645f 6c69 6e65 5f63 6f6c 6f72 203d  rid_line_color =
-0001dfc0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-0001dfd0: 2020 7365 6c66 2e74 6173 6b5f 6578 6563    self.task_exec
-0001dfe0: 5f62 795f 7072 6566 6978 5f63 6861 7274  _by_prefix_chart
-0001dff0: 203d 2062 6172 6368 6172 740a 0a20 2020   = barchart..   
-0001e000: 2020 2020 2069 6620 7365 6c66 2e74 6173       if self.tas
-0001e010: 6b5f 6578 6563 5f62 795f 7072 6566 6978  k_exec_by_prefix
-0001e020: 5f63 6861 7274 2e78 5f72 616e 6765 2e66  _chart.x_range.f
-0001e030: 6163 746f 7273 2021 3d20 6675 6e63 7469  actors != functi
-0001e040: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
-0001e050: 2073 656c 662e 7375 6273 7461 6e74 6961   self.substantia
-0001e060: 6c5f 6368 616e 6765 203d 2054 7275 650a  l_change = True.
-0001e070: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001e080: 2e74 6173 6b5f 6578 6563 5f62 795f 7072  .task_exec_by_pr
-0001e090: 6566 6978 5f63 6861 7274 2e78 5f72 616e  efix_chart.x_ran
-0001e0a0: 6765 203d 2046 6163 746f 7252 616e 6765  ge = FactorRange
-0001e0b0: 282a 6675 6e63 7469 6f6e 7329 0a0a 2020  (*functions)..  
-0001e0c0: 2020 2020 2020 7374 6163 6b65 7273 203d        stackers =
-0001e0d0: 205b 0a20 2020 2020 2020 2020 2020 206e   [.            n
-0001e0e0: 616d 6520 666f 7220 6e61 6d65 2069 6e20  ame for name in 
-0001e0f0: 7461 736b 5f65 7865 635f 6461 7461 2069  task_exec_data i
-0001e100: 6620 6e61 6d65 2e65 6e64 7377 6974 6828  f name.endswith(
-0001e110: 7365 6c66 2e75 6e69 745f 7365 6c65 6374  self.unit_select
-0001e120: 6564 290a 2020 2020 2020 2020 5d0a 0a20  ed).        ].. 
-0001e130: 2020 2020 2020 2069 6620 7374 6163 6b65         if stacke
-0001e140: 7273 2061 6e64 2073 7461 636b 6572 7320  rs and stackers 
-0001e150: 213d 2067 6574 6174 7472 2873 656c 662c  != getattr(self,
-0001e160: 2022 5f70 7265 765f 7374 6163 6b65 7273   "_prev_stackers
-0001e170: 222c 205b 5d29 3a0a 2020 2020 2020 2020  ", []):.        
-0001e180: 2020 2020 7365 6c66 2e5f 7072 6576 5f73      self._prev_s
-0001e190: 7461 636b 6572 7320 3d20 7374 6163 6b65  tackers = stacke
-0001e1a0: 7273 0a20 2020 2020 2020 2020 2020 2072  rs.            r
-0001e1b0: 656e 6465 7265 7273 203d 2073 656c 662e  enderers = self.
-0001e1c0: 7461 736b 5f65 7865 635f 6279 5f70 7265  task_exec_by_pre
-0001e1d0: 6669 785f 6368 6172 742e 7662 6172 5f73  fix_chart.vbar_s
-0001e1e0: 7461 636b 280a 2020 2020 2020 2020 2020  tack(.          
-0001e1f0: 2020 2020 2020 7374 6163 6b65 7273 2c0a        stackers,.
-0001e200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e210: 783d 2266 756e 6374 696f 6e73 222c 0a20  x="functions",. 
-0001e220: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0001e230: 6964 7468 3d30 2e39 2c0a 2020 2020 2020  idth=0.9,.      
-0001e240: 2020 2020 2020 2020 2020 736f 7572 6365            source
-0001e250: 3d73 656c 662e 7461 736b 5f65 7865 635f  =self.task_exec_
-0001e260: 6279 5f70 7265 6669 785f 7372 632c 0a20  by_prefix_src,. 
-0001e270: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001e280: 6f6c 6f72 3d73 656c 662e 5f67 6574 5f70  olor=self._get_p
-0001e290: 616c 6574 7465 286c 656e 2873 656c 662e  alette(len(self.
-0001e2a0: 7461 736b 5f61 6374 6976 6974 6965 7329  task_activities)
-0001e2b0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0001e2c0: 2020 206c 6567 656e 645f 6c61 6265 6c3d     legend_label=
-0001e2d0: 7365 6c66 2e74 6173 6b5f 6163 7469 7669  self.task_activi
-0001e2e0: 7469 6573 2c0a 2020 2020 2020 2020 2020  ties,.          
-0001e2f0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
-0001e300: 2023 2043 7265 6174 6520 686f 7665 7274   # Create hovert
-0001e310: 6f6f 6c73 206f 6e74 6f70 206f 6620 6261  ools ontop of ba
-0001e320: 7365 2074 6f6f 6c73 0a20 2020 2020 2020  se tools.       
-0001e330: 2020 2020 2074 6f6f 6c73 203d 2073 656c       tools = sel
-0001e340: 662e 7461 736b 5f65 7865 635f 6279 5f70  f.task_exec_by_p
-0001e350: 7265 6669 785f 6368 6172 742e 746f 6f6c  refix_chart.tool
-0001e360: 730a 2020 2020 2020 2020 2020 2020 7365  s.            se
-0001e370: 6c66 2e74 6173 6b5f 6578 6563 5f62 795f  lf.task_exec_by_
-0001e380: 7072 6566 6978 5f63 6861 7274 2e74 6f6f  prefix_chart.too
-0001e390: 6c73 203d 2074 6f6f 6c73 5b3a 206c 656e  ls = tools[: len
-0001e3a0: 2862 6173 655f 746f 6f6c 732e 7370 6c69  (base_tools.spli
-0001e3b0: 7428 222c 2229 295d 0a0a 2020 2020 2020  t(","))]..      
-0001e3c0: 2020 2020 2020 666f 7220 7662 6172 2069        for vbar i
-0001e3d0: 6e20 7265 6e64 6572 6572 733a 0a20 2020  n renderers:.   
-0001e3e0: 2020 2020 2020 2020 2020 2020 2074 6f6f               too
-0001e3f0: 6c74 6970 7320 3d20 5b0a 2020 2020 2020  ltips = [.      
-0001e400: 2020 2020 2020 2020 2020 2020 2020 280a                (.
-0001e410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e420: 2020 2020 2020 2020 7662 6172 2e6e 616d          vbar.nam
-0001e430: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0001e440: 2020 2020 2020 2020 2020 2066 2240 7b7b             f"@{{
-0001e450: 7b76 6261 722e 6e61 6d65 7d5f 7465 7874  {vbar.name}_text
-0001e460: 7d7d 222c 0a20 2020 2020 2020 2020 2020  }}",.           
-0001e470: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
-0001e480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e490: 2822 6675 6e63 7469 6f6e 222c 2022 4066  ("function", "@f
-0001e4a0: 756e 6374 696f 6e73 2229 2c0a 2020 2020  unctions"),.    
-0001e4b0: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-0001e4c0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0001e4d0: 6c66 2e74 6173 6b5f 6578 6563 5f62 795f  lf.task_exec_by_
-0001e4e0: 7072 6566 6978 5f63 6861 7274 2e61 6464  prefix_chart.add
-0001e4f0: 5f74 6f6f 6c73 280a 2020 2020 2020 2020  _tools(.        
-0001e500: 2020 2020 2020 2020 2020 2020 486f 7665              Hove
-0001e510: 7254 6f6f 6c28 746f 6f6c 7469 7073 3d74  rTool(tooltips=t
-0001e520: 6f6f 6c74 6970 732c 2072 656e 6465 7265  ooltips, rendere
-0001e530: 7273 3d5b 7662 6172 5d29 0a20 2020 2020  rs=[vbar]).     
-0001e540: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-0001e550: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-0001e560: 7562 7374 616e 7469 616c 5f63 6861 6e67  ubstantial_chang
-0001e570: 6520 3d20 5472 7565 0a20 2020 2020 2020  e = True.       
-0001e580: 2020 2020 2073 656c 662e 7461 736b 5f65       self.task_e
-0001e590: 7865 635f 6279 5f70 7265 6669 785f 6368  xec_by_prefix_ch
-0001e5a0: 6172 742e 7265 6e64 6572 6572 7320 3d20  art.renderers = 
-0001e5b0: 7265 6e64 6572 6572 730a 2020 2020 2020  renderers.      
-0001e5c0: 2020 7365 6c66 2e74 6173 6b5f 6578 6563    self.task_exec
-0001e5d0: 5f62 795f 7072 6566 6978 5f73 7263 2e64  _by_prefix_src.d
-0001e5e0: 6174 6120 3d20 6469 6374 2874 6173 6b5f  ata = dict(task_
-0001e5f0: 6578 6563 5f64 6174 6129 0a0a 2020 2020  exec_data)..    
-0001e600: 6465 6620 5f62 7569 6c64 5f73 656e 6464  def _build_sendd
-0001e610: 6174 615f 6368 6172 7428 7365 6c66 2c20  ata_chart(self, 
-0001e620: 7365 6e64 6461 7461 3a20 6465 6661 756c  senddata: defaul
-0001e630: 7464 6963 745b 7374 722c 206c 6973 745d  tdict[str, list]
-0001e640: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0001e650: 2020 2070 6965 6461 7461 203d 207b 7d0a     piedata = {}.
-0001e660: 2020 2020 2020 2020 7069 6564 6174 615b          piedata[
-0001e670: 2261 6374 6976 6974 7922 5d20 3d20 7365  "activity"] = se
-0001e680: 6e64 6461 7461 5b22 6163 7469 7669 7479  nddata["activity
-0001e690: 225d 0a20 2020 2020 2020 2070 6965 6461  "].        pieda
-0001e6a0: 7461 5b22 7661 6c75 6522 5d20 3d20 5b0a  ta["value"] = [.
-0001e6b0: 2020 2020 2020 2020 2020 2020 2873 756d              (sum
-0001e6c0: 2873 656e 6464 6174 615b 6622 7b6f 707d  (senddata[f"{op}
-0001e6d0: 5f7b 7365 6c66 2e75 6e69 745f 7365 6c65  _{self.unit_sele
-0001e6e0: 6374 6564 7d22 5d29 2920 666f 7220 6f70  cted}"])) for op
-0001e6f0: 2069 6e20 7365 6e64 6461 7461 5b22 6163   in senddata["ac
-0001e700: 7469 7669 7479 225d 0a20 2020 2020 2020  tivity"].       
-0001e710: 205d 0a20 2020 2020 2020 2070 6965 6461   ].        pieda
-0001e720: 7461 5b22 7465 7874 225d 203d 205b 7365  ta["text"] = [se
-0001e730: 6c66 2e66 6f72 6d61 7428 7365 6c66 2e75  lf.format(self.u
-0001e740: 6e69 745f 7365 6c65 6374 6564 2c20 7629  nit_selected, v)
-0001e750: 2066 6f72 2076 2069 6e20 7069 6564 6174   for v in piedat
-0001e760: 615b 2276 616c 7565 225d 5d0a 2020 2020  a["value"]].    
-0001e770: 2020 2020 7069 6564 6174 615b 2261 6e67      piedata["ang
-0001e780: 6c65 225d 203d 205b 0a20 2020 2020 2020  le"] = [.       
-0001e790: 2020 2020 2028 0a20 2020 2020 2020 2020       (.         
-0001e7a0: 2020 2020 2020 2028 7375 6d28 7365 6e64         (sum(send
-0001e7b0: 6461 7461 5b66 227b 6f70 7d5f 7b73 656c  data[f"{op}_{sel
-0001e7c0: 662e 756e 6974 5f73 656c 6563 7465 647d  f.unit_selected}
-0001e7d0: 225d 2920 2f20 7375 6d28 7069 6564 6174  "]) / sum(piedat
-0001e7e0: 615b 2276 616c 7565 225d 2929 0a20 2020  a["value"])).   
-0001e7f0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0001e800: 7375 6d28 7069 6564 6174 615b 2276 616c  sum(piedata["val
-0001e810: 7565 225d 290a 2020 2020 2020 2020 2020  ue"]).          
-0001e820: 2020 2020 2020 656c 7365 2030 2e30 0a20        else 0.0. 
-0001e830: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0001e840: 2020 2020 2020 2020 202a 2032 0a20 2020           * 2.   
-0001e850: 2020 2020 2020 2020 202a 206d 6174 682e           * math.
-0001e860: 7069 0a20 2020 2020 2020 2020 2020 2066  pi.            f
-0001e870: 6f72 206f 7020 696e 2070 6965 6461 7461  or op in piedata
-0001e880: 5b22 6163 7469 7669 7479 225d 0a20 2020  ["activity"].   
-0001e890: 2020 2020 205d 0a20 2020 2020 2020 2070       ].        p
-0001e8a0: 6965 6461 7461 5b22 636f 6c6f 7222 5d20  iedata["color"] 
-0001e8b0: 3d20 7365 6c66 2e5f 6765 745f 7061 6c65  = self._get_pale
-0001e8c0: 7474 6528 6c65 6e28 7069 6564 6174 615b  tte(len(piedata[
-0001e8d0: 2261 6374 6976 6974 7922 5d29 290a 0a20  "activity"])).. 
-0001e8e0: 2020 2020 2020 2073 656c 662e 7365 6e64         self.send
-0001e8f0: 7372 632e 6461 7461 203d 2070 6965 6461  src.data = pieda
-0001e900: 7461 0a0a 2020 2020 2020 2020 6966 2073  ta..        if s
-0001e910: 656c 662e 7365 6e64 6461 7461 5f62 795f  elf.senddata_by_
-0001e920: 6163 7469 7669 7479 5f63 6861 7274 2069  activity_chart i
-0001e930: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0001e940: 2020 2020 7365 6e64 6461 7461 5f70 6965      senddata_pie
-0001e950: 6368 6172 7420 3d20 6669 6775 7265 280a  chart = figure(.
-0001e960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e970: 6865 6967 6874 3d35 3030 2c0a 2020 2020  height=500,.    
-0001e980: 2020 2020 2020 2020 2020 2020 7369 7a69              sizi
-0001e990: 6e67 5f6d 6f64 653d 2273 6361 6c65 5f62  ng_mode="scale_b
-0001e9a0: 6f74 6822 2c0a 2020 2020 2020 2020 2020  oth",.          
-0001e9b0: 2020 2020 2020 7469 746c 653d 2253 656e        title="Sen
-0001e9c0: 6420 6461 7461 2c20 6279 2061 6374 6976  d data, by activ
-0001e9d0: 6974 7922 2c0a 2020 2020 2020 2020 2020  ity",.          
-0001e9e0: 2020 2020 2020 746f 6f6c 733d 2268 6f76        tools="hov
-0001e9f0: 6572 222c 0a20 2020 2020 2020 2020 2020  er",.           
-0001ea00: 2020 2020 2074 6f6f 6c74 6970 733d 2240       tooltips="@
-0001ea10: 7b61 6374 6976 6974 797d 3a20 4074 6578  {activity}: @tex
-0001ea20: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
-0001ea30: 2020 2020 785f 7261 6e67 653d 282d 302e      x_range=(-0.
-0001ea40: 352c 2031 2e30 292c 0a20 2020 2020 2020  5, 1.0),.       
-0001ea50: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0001ea60: 2020 2073 656e 6464 6174 615f 7069 6563     senddata_piec
-0001ea70: 6861 7274 2e77 6564 6765 280a 2020 2020  hart.wedge(.    
-0001ea80: 2020 2020 2020 2020 2020 2020 783d 302c              x=0,
-0001ea90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001eaa0: 2079 3d31 2c0a 2020 2020 2020 2020 2020   y=1,.          
-0001eab0: 2020 2020 2020 7261 6469 7573 3d30 2e34        radius=0.4
-0001eac0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001ead0: 2020 7374 6172 745f 616e 676c 653d 6375    start_angle=cu
-0001eae0: 6d73 756d 2822 616e 676c 6522 2c20 696e  msum("angle", in
-0001eaf0: 636c 7564 655f 7a65 726f 3d54 7275 6529  clude_zero=True)
-0001eb00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001eb10: 2020 656e 645f 616e 676c 653d 6375 6d73    end_angle=cums
-0001eb20: 756d 2822 616e 676c 6522 292c 0a20 2020  um("angle"),.   
-0001eb30: 2020 2020 2020 2020 2020 2020 206c 696e               lin
-0001eb40: 655f 636f 6c6f 723d 2277 6869 7465 222c  e_color="white",
-0001eb50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001eb60: 2066 696c 6c5f 636f 6c6f 723d 2263 6f6c   fill_color="col
-0001eb70: 6f72 222c 0a20 2020 2020 2020 2020 2020  or",.           
-0001eb80: 2020 2020 206c 6567 656e 645f 6669 656c       legend_fiel
-0001eb90: 643d 2261 6374 6976 6974 7922 2c0a 2020  d="activity",.  
-0001eba0: 2020 2020 2020 2020 2020 2020 2020 736f                so
-0001ebb0: 7572 6365 3d73 656c 662e 7365 6e64 7372  urce=self.sendsr
-0001ebc0: 632c 0a20 2020 2020 2020 2020 2020 2029  c,.            )
-0001ebd0: 0a20 2020 2020 2020 2020 2020 2073 656e  .            sen
-0001ebe0: 6464 6174 615f 7069 6563 6861 7274 2e61  ddata_piechart.a
-0001ebf0: 7869 732e 6178 6973 5f6c 6162 656c 203d  xis.axis_label =
-0001ec00: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-0001ec10: 2020 7365 6e64 6461 7461 5f70 6965 6368    senddata_piech
-0001ec20: 6172 742e 6178 6973 2e76 6973 6962 6c65  art.axis.visible
-0001ec30: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-0001ec40: 2020 2020 2073 656e 6464 6174 615f 7069       senddata_pi
-0001ec50: 6563 6861 7274 2e67 7269 642e 6772 6964  echart.grid.grid
-0001ec60: 5f6c 696e 655f 636f 6c6f 7220 3d20 4e6f  _line_color = No
-0001ec70: 6e65 0a20 2020 2020 2020 2020 2020 2073  ne.            s
-0001ec80: 656c 662e 7365 6e64 6461 7461 5f62 795f  elf.senddata_by_
-0001ec90: 6163 7469 7669 7479 5f63 6861 7274 203d  activity_chart =
-0001eca0: 2073 656e 6464 6174 615f 7069 6563 6861   senddata_piecha
-0001ecb0: 7274 0a0a 2020 2020 6465 6620 5f67 6574  rt..    def _get
-0001ecc0: 5f70 616c 6574 7465 2873 656c 662c 206e  _palette(self, n
-0001ecd0: 3a20 696e 7429 202d 3e20 6c69 7374 5b73  : int) -> list[s
-0001ece0: 7472 5d3a 0a20 2020 2020 2020 2072 6574  tr]:.        ret
-0001ecf0: 7572 6e20 696e 7465 7270 5f70 616c 6574  urn interp_palet
-0001ed00: 7465 2859 6c47 6e42 7539 2c20 6e29 0a0a  te(YlGnBu9, n)..
-0001ed10: 0a63 6c61 7373 2043 6f6e 7465 6e74 696f  .class Contentio
-0001ed20: 6e28 4461 7368 626f 6172 6443 6f6d 706f  n(DashboardCompo
-0001ed30: 6e65 6e74 293a 0a20 2020 2022 2222 0a20  nent):.    """. 
-0001ed40: 2020 2045 7665 6e74 204c 6f6f 7020 4865     Event Loop He
-0001ed50: 616c 7468 2028 616e 6420 4749 4c20 436f  alth (and GIL Co
-0001ed60: 6e74 656e 7469 6f6e 2c20 6966 2063 6f6e  ntention, if con
-0001ed70: 6669 6775 7265 6429 0a20 2020 2022 2222  figured).    """
-0001ed80: 0a0a 2020 2020 406c 6f67 5f65 7272 6f72  ..    @log_error
-0001ed90: 730a 2020 2020 6465 6620 5f5f 696e 6974  s.    def __init
-0001eda0: 5f5f 2873 656c 662c 2073 6368 6564 756c  __(self, schedul
-0001edb0: 6572 2c20 2a2a 6b77 6172 6773 293a 0a20  er, **kwargs):. 
-0001edc0: 2020 2020 2020 2073 656c 662e 7363 6865         self.sche
-0001edd0: 6475 6c65 7220 3d20 7363 6865 6475 6c65  duler = schedule
-0001ede0: 720a 2020 2020 2020 2020 7365 6c66 2e64  r.        self.d
-0001edf0: 6174 6120 3d20 6469 6374 280a 2020 2020  ata = dict(.    
-0001ee00: 2020 2020 2020 2020 6e61 6d65 733d 5b0a          names=[.
-0001ee10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ee20: 2822 5363 6865 6475 6c65 7222 2c20 2245  ("Scheduler", "E
-0001ee30: 7665 6e74 204c 6f6f 7022 292c 0a20 2020  vent Loop"),.   
-0001ee40: 2020 2020 2020 2020 2020 2020 2028 2253               ("S
-0001ee50: 6368 6564 756c 6572 222c 2022 4749 4c20  cheduler", "GIL 
-0001ee60: 436f 6e74 656e 7469 6f6e 2229 2c0a 2020  Contention"),.  
-0001ee70: 2020 2020 2020 2020 2020 2020 2020 2822                ("
-0001ee80: 576f 726b 6572 7322 2c20 2245 7665 6e74  Workers", "Event
-0001ee90: 204c 6f6f 7022 292c 0a20 2020 2020 2020   Loop"),.       
-0001eea0: 2020 2020 2020 2020 2028 2257 6f72 6b65           ("Worke
-0001eeb0: 7273 222c 2022 4749 4c20 436f 6e74 656e  rs", "GIL Conten
-0001eec0: 7469 6f6e 2229 2c0a 2020 2020 2020 2020  tion"),.        
-0001eed0: 2020 2020 5d2c 0a20 2020 2020 2020 2020      ],.         
-0001eee0: 2020 2076 616c 7565 733d 5b30 2c20 302c     values=[0, 0,
-0001eef0: 2030 2c20 305d 2c0a 2020 2020 2020 2020   0, 0],.        
-0001ef00: 2020 2020 7465 7874 3d5b 2230 7322 2c20      text=["0s", 
-0001ef10: 2230 2522 2c20 2230 7322 2c20 2230 2522  "0%", "0s", "0%"
-0001ef20: 5d2c 0a20 2020 2020 2020 2029 0a20 2020  ],.        ).   
-0001ef30: 2020 2020 2074 6974 6c65 203d 2022 4576       title = "Ev
-0001ef40: 656e 7420 4c6f 6f70 2026 2047 494c 2043  ent Loop & GIL C
-0001ef50: 6f6e 7465 6e74 696f 6e22 0a0a 2020 2020  ontention"..    
-0001ef60: 2020 2020 2320 5265 6d6f 7665 2047 494c      # Remove GIL
-0001ef70: 2072 656c 6174 6564 206e 616d 6573 2f76   related names/v
-0001ef80: 616c 7565 7320 6966 206e 6f74 206d 6f6e  alues if not mon
-0001ef90: 6974 6f72 696e 6720 4749 4c0a 2020 2020  itoring GIL.    
-0001efa0: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
-0001efb0: 7363 6865 6475 6c65 722e 6d6f 6e69 746f  scheduler.monito
-0001efc0: 722e 6d6f 6e69 746f 725f 6769 6c5f 636f  r.monitor_gil_co
-0001efd0: 6e74 656e 7469 6f6e 3a0a 2020 2020 2020  ntention:.      
-0001efe0: 2020 2020 2020 7469 746c 6520 3d20 2245        title = "E
-0001eff0: 7665 6e74 204c 6f6f 7022 0a20 2020 2020  vent Loop".     
-0001f000: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
-0001f010: 6e20 7365 6c66 2e64 6174 613a 0a20 2020  n self.data:.   
-0001f020: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0001f030: 662e 6461 7461 5b6b 6579 5d20 3d20 7365  f.data[key] = se
-0001f040: 6c66 2e64 6174 615b 6b65 795d 5b3a 3a32  lf.data[key][::2
-0001f050: 5d0a 0a20 2020 2020 2020 2073 656c 662e  ]..        self.
-0001f060: 736f 7572 6365 203d 2043 6f6c 756d 6e44  source = ColumnD
-0001f070: 6174 6153 6f75 7263 6528 6461 7461 3d73  ataSource(data=s
-0001f080: 656c 662e 6461 7461 290a 2020 2020 2020  elf.data).      
-0001f090: 2020 7365 6c66 2e72 6f6f 7420 3d20 6669    self.root = fi
-0001f0a0: 6775 7265 280a 2020 2020 2020 2020 2020  gure(.          
-0001f0b0: 2020 7469 746c 653d 7469 746c 652c 0a20    title=title,. 
-0001f0c0: 2020 2020 2020 2020 2020 2078 5f72 616e             x_ran
-0001f0d0: 6765 3d46 6163 746f 7252 616e 6765 282a  ge=FactorRange(*
-0001f0e0: 7365 6c66 2e64 6174 615b 226e 616d 6573  self.data["names
-0001f0f0: 225d 292c 0a20 2020 2020 2020 2020 2020  "]),.           
-0001f100: 2079 5f72 616e 6765 3d28 302c 2031 292c   y_range=(0, 1),
-0001f110: 0a20 2020 2020 2020 2020 2020 2074 6f6f  .            too
-0001f120: 6c73 3d22 222c 0a20 2020 2020 2020 2020  ls="",.         
-0001f130: 2020 2074 6f6f 6c62 6172 5f6c 6f63 6174     toolbar_locat
-0001f140: 696f 6e3d 2261 626f 7665 222c 0a20 2020  ion="above",.   
-0001f150: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
-0001f160: 732c 0a20 2020 2020 2020 2029 0a20 2020  s,.        ).   
-0001f170: 2020 2020 2073 656c 662e 726f 6f74 2e76       self.root.v
-0001f180: 6261 7228 0a20 2020 2020 2020 2020 2020  bar(.           
-0001f190: 2078 3d22 6e61 6d65 7322 2c0a 2020 2020   x="names",.    
-0001f1a0: 2020 2020 2020 2020 746f 703d 2276 616c          top="val
-0001f1b0: 7565 7322 2c0a 2020 2020 2020 2020 2020  ues",.          
-0001f1c0: 2020 7769 6474 683d 302e 392c 0a20 2020    width=0.9,.   
-0001f1d0: 2020 2020 2020 2020 206c 696e 655f 636f           line_co
-0001f1e0: 6c6f 723d 2277 6869 7465 222c 0a20 2020  lor="white",.   
-0001f1f0: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
-0001f200: 7365 6c66 2e73 6f75 7263 652c 0a20 2020  self.source,.   
-0001f210: 2020 2020 2020 2020 2066 696c 6c5f 636f           fill_co
-0001f220: 6c6f 723d 6661 6374 6f72 5f63 6d61 7028  lor=factor_cmap(
-0001f230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f240: 2066 6965 6c64 5f6e 616d 653d 226e 616d   field_name="nam
-0001f250: 6573 222c 0a20 2020 2020 2020 2020 2020  es",.           
-0001f260: 2020 2020 2070 616c 6574 7465 3d5b 2223       palette=["#
-0001f270: 6238 6530 6365 222c 2022 2338 3161 6165  b8e0ce", "#81aae
-0001f280: 3422 5d2c 0a20 2020 2020 2020 2020 2020  4"],.           
-0001f290: 2020 2020 2066 6163 746f 7273 3d5b 2245       factors=["E
-0001f2a0: 7665 6e74 204c 6f6f 7022 2c20 2247 494c  vent Loop", "GIL
-0001f2b0: 2043 6f6e 7465 6e74 696f 6e22 5d2c 0a20   Contention"],. 
-0001f2c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001f2d0: 7461 7274 3d31 2c0a 2020 2020 2020 2020  tart=1,.        
-0001f2e0: 2020 2020 2020 2020 656e 643d 322c 0a20          end=2,. 
-0001f2f0: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
-0001f300: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0001f310: 2073 656c 662e 726f 6f74 2e78 5f72 616e   self.root.x_ran
-0001f320: 6765 2e67 726f 7570 5f70 6164 6469 6e67  ge.group_padding
-0001f330: 203d 2030 2e32 350a 2020 2020 2020 2020   = 0.25.        
-0001f340: 7365 6c66 2e72 6f6f 742e 7861 7869 732e  self.root.xaxis.
-0001f350: 6d69 6e6f 725f 7469 636b 5f6c 696e 655f  minor_tick_line_
-0001f360: 616c 7068 6120 3d20 300a 2020 2020 2020  alpha = 0.      
-0001f370: 2020 7365 6c66 2e72 6f6f 742e 7967 7269    self.root.ygri
-0001f380: 642e 7669 7369 626c 6520 3d20 5472 7565  d.visible = True
-0001f390: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-0001f3a0: 6f74 2e78 6772 6964 2e76 6973 6962 6c65  ot.xgrid.visible
-0001f3b0: 203d 2046 616c 7365 0a0a 2020 2020 2020   = False..      
-0001f3c0: 2020 686f 7665 7220 3d20 486f 7665 7254    hover = HoverT
-0001f3d0: 6f6f 6c28 0a20 2020 2020 2020 2020 2020  ool(.           
-0001f3e0: 2074 6f6f 6c74 6970 733d 5b28 224e 616d   tooltips=[("Nam
-0001f3f0: 6522 2c20 2240 6e61 6d65 7322 292c 2028  e", "@names"), (
-0001f400: 2256 616c 7565 222c 2022 4074 6578 7422  "Value", "@text"
-0001f410: 295d 2c20 6d6f 6465 3d22 766c 696e 6522  )], mode="vline"
-0001f420: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0001f430: 2020 2073 656c 662e 726f 6f74 2e61 6464     self.root.add
-0001f440: 5f74 6f6f 6c73 2868 6f76 6572 290a 0a20  _tools(hover).. 
-0001f450: 2020 2040 7769 7468 6f75 745f 7072 6f70     @without_prop
-0001f460: 6572 7479 5f76 616c 6964 6174 696f 6e0a  erty_validation.
-0001f470: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
-0001f480: 2020 2020 6465 6620 7570 6461 7465 2873      def update(s
-0001f490: 656c 6629 3a0a 2020 2020 2020 2020 7320  elf):.        s 
-0001f4a0: 3d20 7365 6c66 2e73 6368 6564 756c 6572  = self.scheduler
-0001f4b0: 0a20 2020 2020 2020 206d 6f6e 6974 6f72  .        monitor
-0001f4c0: 5f67 696c 203d 2073 2e6d 6f6e 6974 6f72  _gil = s.monitor
-0001f4d0: 2e6d 6f6e 6974 6f72 5f67 696c 5f63 6f6e  .monitor_gil_con
-0001f4e0: 7465 6e74 696f 6e0a 0a20 2020 2020 2020  tention..       
-0001f4f0: 2073 656c 662e 6461 7461 5b22 7661 6c75   self.data["valu
-0001f500: 6573 225d 203d 205b 0a20 2020 2020 2020  es"] = [.       
-0001f510: 2020 2020 2073 2e5f 7469 636b 5f69 6e74       s._tick_int
-0001f520: 6572 7661 6c5f 6f62 7365 7276 6564 2c0a  erval_observed,.
-0001f530: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001f540: 2e67 696c 5f63 6f6e 7465 6e74 696f 6e5f  .gil_contention_
-0001f550: 7363 6865 6475 6c65 722c 0a20 2020 2020  scheduler,.     
-0001f560: 2020 2020 2020 2073 756d 2877 2e6d 6574         sum(w.met
-0001f570: 7269 6373 5b22 6576 656e 745f 6c6f 6f70  rics["event_loop
-0001f580: 5f69 6e74 6572 7661 6c22 5d20 666f 7220  _interval"] for 
-0001f590: 7720 696e 2073 2e77 6f72 6b65 7273 2e76  w in s.workers.v
-0001f5a0: 616c 7565 7328 2929 0a20 2020 2020 2020  alues()).       
-0001f5b0: 2020 2020 202f 2028 6c65 6e28 732e 776f       / (len(s.wo
-0001f5c0: 726b 6572 7329 206f 7220 3129 2c0a 2020  rkers) or 1),.  
-0001f5d0: 2020 2020 2020 2020 2020 7365 6c66 2e67            self.g
-0001f5e0: 696c 5f63 6f6e 7465 6e74 696f 6e5f 776f  il_contention_wo
-0001f5f0: 726b 6572 732c 0a20 2020 2020 2020 205d  rkers,.        ]
-0001f600: 5b3a 3a20 3120 6966 206d 6f6e 6974 6f72  [:: 1 if monitor
-0001f610: 5f67 696c 2065 6c73 6520 325d 0a0a 2020  _gil else 2]..  
-0001f620: 2020 2020 2020 2320 466f 726d 6174 2065        # Format e
-0001f630: 7665 6e74 206c 6f6f 7020 6173 2074 696d  vent loop as tim
-0001f640: 6520 616e 6420 4749 4c20 2869 6620 636f  e and GIL (if co
-0001f650: 6e66 6967 7572 6564 2920 6173 2025 0a20  nfigured) as %. 
-0001f660: 2020 2020 2020 2073 656c 662e 6461 7461         self.data
-0001f670: 5b22 7465 7874 225d 203d 205b 0a20 2020  ["text"] = [.   
-0001f680: 2020 2020 2020 2020 2066 227b 7820 2a20           f"{x * 
-0001f690: 3130 303a 2e31 667d 2522 2069 6620 6920  100:.1f}%" if i 
-0001f6a0: 2520 3220 616e 6420 6d6f 6e69 746f 725f  % 2 and monitor_
-0001f6b0: 6769 6c20 656c 7365 2066 6f72 6d61 745f  gil else format_
-0001f6c0: 7469 6d65 2878 290a 2020 2020 2020 2020  time(x).        
-0001f6d0: 2020 2020 666f 7220 692c 2078 2069 6e20      for i, x in 
-0001f6e0: 656e 756d 6572 6174 6528 7365 6c66 2e64  enumerate(self.d
-0001f6f0: 6174 615b 2276 616c 7565 7322 5d29 0a20  ata["values"]). 
-0001f700: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
-0001f710: 2075 7064 6174 6528 7365 6c66 2e73 6f75   update(self.sou
-0001f720: 7263 652c 2073 656c 662e 6461 7461 290a  rce, self.data).
-0001f730: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-0001f740: 2020 2064 6566 2067 696c 5f63 6f6e 7465     def gil_conte
-0001f750: 6e74 696f 6e5f 776f 726b 6572 7328 7365  ntion_workers(se
-0001f760: 6c66 2920 2d3e 2066 6c6f 6174 3a0a 2020  lf) -> float:.  
-0001f770: 2020 2020 2020 776f 726b 6572 7320 3d20        workers = 
-0001f780: 7365 6c66 2e73 6368 6564 756c 6572 2e77  self.scheduler.w
-0001f790: 6f72 6b65 7273 0a20 2020 2020 2020 2069  orkers.        i
-0001f7a0: 6620 776f 726b 6572 733a 0a20 2020 2020  f workers:.     
-0001f7b0: 2020 2020 2020 2072 6574 7572 6e20 7375         return su
-0001f7c0: 6d28 0a20 2020 2020 2020 2020 2020 2020  m(.             
-0001f7d0: 2020 2077 2e6d 6574 7269 6373 2e67 6574     w.metrics.get
-0001f7e0: 2822 6769 6c5f 636f 6e74 656e 7469 6f6e  ("gil_contention
-0001f7f0: 222c 2030 2920 666f 7220 7720 696e 2077  ", 0) for w in w
-0001f800: 6f72 6b65 7273 2e76 616c 7565 7328 290a  orkers.values().
-0001f810: 2020 2020 2020 2020 2020 2020 2920 2f20              ) / 
-0001f820: 6c65 6e28 776f 726b 6572 7329 0a20 2020  len(workers).   
-0001f830: 2020 2020 2072 6574 7572 6e20 666c 6f61       return floa
-0001f840: 7428 224e 614e 2229 0a0a 2020 2020 4070  t("NaN")..    @p
-0001f850: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-0001f860: 6769 6c5f 636f 6e74 656e 7469 6f6e 5f73  gil_contention_s
-0001f870: 6368 6564 756c 6572 2873 656c 6629 202d  cheduler(self) -
-0001f880: 3e20 666c 6f61 743a 0a20 2020 2020 2020  > float:.       
-0001f890: 2072 6574 7572 6e20 7365 6c66 2e73 6368   return self.sch
-0001f8a0: 6564 756c 6572 2e6d 6f6e 6974 6f72 2e72  eduler.monitor.r
-0001f8b0: 6563 656e 7428 292e 6765 7428 2267 696c  ecent().get("gil
-0001f8c0: 5f63 6f6e 7465 6e74 696f 6e22 2c20 666c  _contention", fl
-0001f8d0: 6f61 7428 224e 614e 2229 290a 0a0a 636c  oat("NaN"))...cl
-0001f8e0: 6173 7320 4578 6365 7074 696f 6e73 5461  ass ExceptionsTa
-0001f8f0: 626c 6528 4461 7368 626f 6172 6443 6f6d  ble(DashboardCom
-0001f900: 706f 6e65 6e74 293a 0a20 2020 2022 2222  ponent):.    """
-0001f910: 0a20 2020 2045 7863 6570 7469 6f6e 7320  .    Exceptions 
-0001f920: 6c6f 6767 6564 2069 6e20 7461 736b 732e  logged in tasks.
-0001f930: 0a0a 2020 2020 5369 6e63 6520 7468 6572  ..    Since ther
-0001f940: 6520 6d69 6768 7420 6265 206d 616e 7920  e might be many 
-0001f950: 7265 6c61 7465 6420 6578 6365 7074 696f  related exceptio
-0001f960: 6e73 2028 652e 672e 2c20 616c 6c20 7461  ns (e.g., all ta
-0001f970: 736b 7320 696e 2061 2067 6976 656e 0a20  sks in a given. 
-0001f980: 2020 2074 6173 6b20 6772 6f75 7020 6661     task group fa
-0001f990: 696c 2066 6f72 2074 6865 2073 616d 6520  il for the same 
-0001f9a0: 7265 6173 6f6e 292c 2077 6520 6d61 6b65  reason), we make
-0001f9b0: 2061 2062 6573 742d 6566 666f 7274 2061   a best-effort a
-0001f9c0: 7474 656d 7074 2074 6f0a 2020 2020 2831  ttempt to.    (1
-0001f9d0: 2920 6167 6772 6567 6174 6520 746f 2074  ) aggregate to t
-0001f9e0: 6865 2074 6173 6b20 6772 6f75 702c 2061  he task group, a
-0001f9f0: 6e64 2028 3229 2064 6564 7570 6c69 6361  nd (2) deduplica
-0001fa00: 7465 2073 696d 696c 6172 206c 6f6f 6b69  te similar looki
-0001fa10: 6e67 2074 6173 6b73 2e0a 2020 2020 2222  ng tasks..    ""
-0001fa20: 220a 0a20 2020 2073 6368 6564 756c 6572  "..    scheduler
-0001fa30: 3a20 5363 6865 6475 6c65 720a 0a20 2020  : Scheduler..   
-0001fa40: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-0001fa50: 6c66 2c20 7363 6865 6475 6c65 723a 2053  lf, scheduler: S
-0001fa60: 6368 6564 756c 6572 2c20 7769 6474 683a  cheduler, width:
-0001fa70: 2069 6e74 203d 2031 3030 302c 202a 2a6b   int = 1000, **k
-0001fa80: 7761 7267 733a 2041 6e79 293a 0a20 2020  wargs: Any):.   
-0001fa90: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
-0001faa0: 6c65 7220 3d20 7363 6865 6475 6c65 720a  ler = scheduler.
-0001fab0: 0a20 2020 2020 2020 2073 656c 662e 6e61  .        self.na
-0001fac0: 6d65 7320 3d20 5b0a 2020 2020 2020 2020  mes = [.        
-0001fad0: 2020 2020 2254 6173 6b22 2c0a 2020 2020      "Task",.    
-0001fae0: 2020 2020 2020 2020 2245 7863 6570 7469          "Excepti
-0001faf0: 6f6e 222c 0a20 2020 2020 2020 2020 2020  on",.           
-0001fb00: 2022 5472 6163 6562 6163 6b22 2c0a 2020   "Traceback",.  
-0001fb10: 2020 2020 2020 2020 2020 2257 6f72 6b65            "Worke
-0001fb20: 7228 7329 222c 0a20 2020 2020 2020 2020  r(s)",.         
-0001fb30: 2020 2022 436f 756e 7422 2c0a 2020 2020     "Count",.    
-0001fb40: 2020 2020 5d0a 0a20 2020 2020 2020 2073      ]..        s
-0001fb50: 656c 662e 736f 7572 6365 203d 2043 6f6c  elf.source = Col
-0001fb60: 756d 6e44 6174 6153 6f75 7263 6528 7b6b  umnDataSource({k
-0001fb70: 3a20 5b5d 2066 6f72 206b 2069 6e20 7365  : [] for k in se
-0001fb80: 6c66 2e6e 616d 6573 7d29 0a0a 2020 2020  lf.names})..    
-0001fb90: 2020 2020 636f 6465 5f66 6f72 6d61 7474      code_formatt
-0001fba0: 6572 203d 2048 544d 4c54 656d 706c 6174  er = HTMLTemplat
-0001fbb0: 6546 6f72 6d61 7474 6572 280a 2020 2020  eFormatter(.    
-0001fbc0: 2020 2020 2020 2020 7465 6d70 6c61 7465          template
-0001fbd0: 3d27 3c63 6f64 6520 7469 746c 653d 223c  ='<code title="<
-0001fbe0: 252d 2076 616c 7565 2025 3e22 3e3c 253d  %- value %>"><%=
-0001fbf0: 2076 616c 7565 2025 3e3c 2f63 6f64 653e   value %></code>
-0001fc00: 270a 2020 2020 2020 2020 290a 2020 2020  '.        ).    
-0001fc10: 2020 2020 636f 6c75 6d6e 7320 3d20 5b0a      columns = [.
-0001fc20: 2020 2020 2020 2020 2020 2020 5461 626c              Tabl
-0001fc30: 6543 6f6c 756d 6e28 0a20 2020 2020 2020  eColumn(.       
-0001fc40: 2020 2020 2020 2020 2066 6965 6c64 3d22           field="
-0001fc50: 5461 736b 222c 0a20 2020 2020 2020 2020  Task",.         
-0001fc60: 2020 2020 2020 2074 6974 6c65 3d22 5461         title="Ta
-0001fc70: 736b 222c 0a20 2020 2020 2020 2020 2020  sk",.           
-0001fc80: 2020 2020 2066 6f72 6d61 7474 6572 3d63       formatter=c
-0001fc90: 6f64 655f 666f 726d 6174 7465 722c 0a20  ode_formatter,. 
-0001fca0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0001fcb0: 6964 7468 3d31 3530 2c0a 2020 2020 2020  idth=150,.      
-0001fcc0: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
-0001fcd0: 2020 2020 2054 6162 6c65 436f 6c75 6d6e       TableColumn
-0001fce0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001fcf0: 2020 6669 656c 643d 2245 7863 6570 7469    field="Excepti
-0001fd00: 6f6e 222c 0a20 2020 2020 2020 2020 2020  on",.           
-0001fd10: 2020 2020 2074 6974 6c65 3d22 4578 6365       title="Exce
-0001fd20: 7074 696f 6e22 2c0a 2020 2020 2020 2020  ption",.        
-0001fd30: 2020 2020 2020 2020 666f 726d 6174 7465          formatte
-0001fd40: 723d 636f 6465 5f66 6f72 6d61 7474 6572  r=code_formatter
-0001fd50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001fd60: 2020 7769 6474 683d 3330 302c 0a20 2020    width=300,.   
-0001fd70: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
-0001fd80: 2020 2020 2020 2020 5461 626c 6543 6f6c          TableCol
-0001fd90: 756d 6e28 0a20 2020 2020 2020 2020 2020  umn(.           
-0001fda0: 2020 2020 2066 6965 6c64 3d22 5472 6163       field="Trac
-0001fdb0: 6562 6163 6b22 2c0a 2020 2020 2020 2020  eback",.        
-0001fdc0: 2020 2020 2020 2020 7469 746c 653d 2254          title="T
-0001fdd0: 7261 6365 6261 636b 222c 0a20 2020 2020  raceback",.     
-0001fde0: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
-0001fdf0: 7474 6572 3d63 6f64 655f 666f 726d 6174  tter=code_format
-0001fe00: 7465 722c 0a20 2020 2020 2020 2020 2020  ter,.           
-0001fe10: 2020 2020 2077 6964 7468 3d33 3030 2c0a       width=300,.
-0001fe20: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
-0001fe30: 2020 2020 2020 2020 2020 2054 6162 6c65             Table
-0001fe40: 436f 6c75 6d6e 280a 2020 2020 2020 2020  Column(.        
-0001fe50: 2020 2020 2020 2020 6669 656c 643d 2257          field="W
-0001fe60: 6f72 6b65 7228 7329 222c 0a20 2020 2020  orker(s)",.     
-0001fe70: 2020 2020 2020 2020 2020 2074 6974 6c65             title
-0001fe80: 3d22 576f 726b 6572 2873 2922 2c0a 2020  ="Worker(s)",.  
-0001fe90: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0001fea0: 726d 6174 7465 723d 636f 6465 5f66 6f72  rmatter=code_for
-0001feb0: 6d61 7474 6572 2c0a 2020 2020 2020 2020  matter,.        
-0001fec0: 2020 2020 2020 2020 7769 6474 683d 3230          width=20
-0001fed0: 302c 0a20 2020 2020 2020 2020 2020 2029  0,.            )
-0001fee0: 2c0a 2020 2020 2020 2020 2020 2020 5461  ,.            Ta
-0001fef0: 626c 6543 6f6c 756d 6e28 0a20 2020 2020  bleColumn(.     
-0001ff00: 2020 2020 2020 2020 2020 2066 6965 6c64             field
-0001ff10: 3d22 436f 756e 7422 2c0a 2020 2020 2020  ="Count",.      
-0001ff20: 2020 2020 2020 2020 2020 7469 746c 653d            title=
-0001ff30: 2243 6f75 6e74 222c 0a20 2020 2020 2020  "Count",.       
-0001ff40: 2020 2020 2020 2020 2066 6f72 6d61 7474           formatt
-0001ff50: 6572 3d4e 756d 6265 7246 6f72 6d61 7474  er=NumberFormatt
-0001ff60: 6572 2866 6f72 6d61 743d 2230 2c30 2229  er(format="0,0")
-0001ff70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001ff80: 2020 7769 6474 683d 3530 2c0a 2020 2020    width=50,.    
-0001ff90: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
-0001ffa0: 2020 205d 0a0a 2020 2020 2020 2020 6966     ]..        if
-0001ffb0: 2022 7369 7a69 6e67 5f6d 6f64 6522 2069   "sizing_mode" i
-0001ffc0: 6e20 6b77 6172 6773 3a0a 2020 2020 2020  n kwargs:.      
-0001ffd0: 2020 2020 2020 7369 7a69 6e67 5f6d 6f64        sizing_mod
-0001ffe0: 6520 3d20 7b22 7369 7a69 6e67 5f6d 6f64  e = {"sizing_mod
-0001fff0: 6522 3a20 6b77 6172 6773 5b22 7369 7a69  e": kwargs["sizi
-00020000: 6e67 5f6d 6f64 6522 5d7d 0a20 2020 2020  ng_mode"]}.     
-00020010: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00020020: 2020 2020 2073 697a 696e 675f 6d6f 6465       sizing_mode
-00020030: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
-00020040: 6c66 2e72 6f6f 7420 3d20 4461 7461 5461  lf.root = DataTa
-00020050: 626c 6528 0a20 2020 2020 2020 2020 2020  ble(.           
-00020060: 2073 6f75 7263 653d 7365 6c66 2e73 6f75   source=self.sou
-00020070: 7263 652c 0a20 2020 2020 2020 2020 2020  rce,.           
-00020080: 2063 6f6c 756d 6e73 3d63 6f6c 756d 6e73   columns=columns
-00020090: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
-000200a0: 6f72 6465 7261 626c 653d 5472 7565 2c0a  orderable=True,.
-000200b0: 2020 2020 2020 2020 2020 2020 736f 7274              sort
-000200c0: 6162 6c65 3d54 7275 652c 0a20 2020 2020  able=True,.     
-000200d0: 2020 2020 2020 2077 6964 7468 3d77 6964         width=wid
-000200e0: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
-000200f0: 696e 6465 785f 706f 7369 7469 6f6e 3d4e  index_position=N
-00020100: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-00020110: 202a 2a5f 4441 5441 5441 424c 455f 5354   **_DATATABLE_ST
-00020120: 594c 4553 4845 4554 535f 4b57 4152 4753  YLESHEETS_KWARGS
-00020130: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
-00020140: 7369 7a69 6e67 5f6d 6f64 652c 0a20 2020  sizing_mode,.   
-00020150: 2020 2020 2029 0a0a 2020 2020 4077 6974       )..    @wit
-00020160: 686f 7574 5f70 726f 7065 7274 795f 7661  hout_property_va
-00020170: 6c69 6461 7469 6f6e 0a20 2020 2064 6566  lidation.    def
-00020180: 2075 7064 6174 6528 7365 6c66 293a 0a20   update(self):. 
-00020190: 2020 2020 2020 206e 6577 5f64 6174 6120         new_data 
-000201a0: 3d20 7b6e 616d 653a 205b 5d20 666f 7220  = {name: [] for 
-000201b0: 6e61 6d65 2069 6e20 7365 6c66 2e6e 616d  name in self.nam
-000201c0: 6573 7d0a 2020 2020 2020 2020 6572 7265  es}.        erre
-000201d0: 645f 7461 736b 7320 3d20 7365 6c66 2e73  d_tasks = self.s
-000201e0: 6368 6564 756c 6572 2e65 7272 6564 5f74  cheduler.erred_t
-000201f0: 6173 6b73 0a0a 2020 2020 2020 2020 666f  asks..        fo
-00020200: 7220 7473 2069 6e20 6572 7265 645f 7461  r ts in erred_ta
-00020210: 736b 733a 0a20 2020 2020 2020 2020 2020  sks:.           
-00020220: 206e 6577 5f64 6174 615b 2254 6173 6b22   new_data["Task"
-00020230: 5d2e 6170 7065 6e64 2874 732e 6b65 7929  ].append(ts.key)
-00020240: 0a20 2020 2020 2020 2020 2020 206e 6577  .            new
-00020250: 5f64 6174 615b 2245 7863 6570 7469 6f6e  _data["Exception
-00020260: 225d 2e61 7070 656e 6428 7473 2e65 7863  "].append(ts.exc
-00020270: 6570 7469 6f6e 5f74 6578 7429 0a20 2020  eption_text).   
-00020280: 2020 2020 2020 2020 206e 6577 5f64 6174           new_dat
-00020290: 615b 2254 7261 6365 6261 636b 225d 2e61  a["Traceback"].a
-000202a0: 7070 656e 6428 7473 2e74 7261 6365 6261  ppend(ts.traceba
-000202b0: 636b 5f74 6578 7429 0a20 2020 2020 2020  ck_text).       
-000202c0: 2020 2020 206e 6577 5f64 6174 615b 2257       new_data["W
-000202d0: 6f72 6b65 7228 7329 225d 2e61 7070 656e  orker(s)"].appen
-000202e0: 6428 222c 5c6e 222e 6a6f 696e 2874 732e  d(",\n".join(ts.
-000202f0: 6572 7265 645f 6f6e 2929 0a20 2020 2020  erred_on)).     
-00020300: 2020 2020 2020 206e 6577 5f64 6174 615b         new_data[
-00020310: 2243 6f75 6e74 225d 2e61 7070 656e 6428  "Count"].append(
-00020320: 6c65 6e28 7473 2e65 7272 6564 5f6f 6e29  len(ts.erred_on)
-00020330: 290a 0a20 2020 2020 2020 2075 7064 6174  )..        updat
-00020340: 6528 7365 6c66 2e73 6f75 7263 652c 206e  e(self.source, n
-00020350: 6577 5f64 6174 6129 0a0a 0a63 6c61 7373  ew_data)...class
-00020360: 2057 6f72 6b65 7254 6162 6c65 2844 6173   WorkerTable(Das
-00020370: 6862 6f61 7264 436f 6d70 6f6e 656e 7429  hboardComponent)
-00020380: 3a0a 2020 2020 2222 2253 7461 7475 7320  :.    """Status 
-00020390: 6f66 2074 6865 2063 7572 7265 6e74 2077  of the current w
-000203a0: 6f72 6b65 7273 0a0a 2020 2020 5468 6973  orkers..    This
-000203b0: 2069 7320 7477 6f20 706c 6f74 732c 2061   is two plots, a
-000203c0: 2074 6578 742d 6261 7365 6420 7461 626c   text-based tabl
-000203d0: 6520 666f 7220 6561 6368 2068 6f73 7420  e for each host 
-000203e0: 616e 6420 6120 7468 696e 2068 6f72 697a  and a thin horiz
-000203f0: 6f6e 7461 6c0a 2020 2020 706c 6f74 206c  ontal.    plot l
-00020400: 6179 696e 6720 6f75 7420 686f 7374 7320  aying out hosts 
-00020410: 6279 2074 6865 6972 2063 7572 7265 6e74  by their current
-00020420: 206d 656d 6f72 7920 7573 652e 0a20 2020   memory use..   
-00020430: 2022 2222 0a0a 2020 2020 6578 636c 7564   """..    exclud
-00020440: 6564 5f6e 616d 6573 203d 207b 0a20 2020  ed_names = {.   
-00020450: 2020 2020 2022 6578 6563 7574 696e 6722       "executing"
-00020460: 2c0a 2020 2020 2020 2020 2269 6e5f 666c  ,.        "in_fl
-00020470: 6967 6874 222c 0a20 2020 2020 2020 2022  ight",.        "
-00020480: 696e 5f6d 656d 6f72 7922 2c0a 2020 2020  in_memory",.    
-00020490: 2020 2020 2272 6561 6479 222c 0a20 2020      "ready",.   
-000204a0: 2020 2020 2022 7469 6d65 222c 0a20 2020       "time",.   
-000204b0: 2020 2020 2023 2055 7365 2073 6368 6564       # Use sched
-000204c0: 756c 6572 2e57 6f72 6b65 7253 7461 7465  uler.WorkerState
-000204d0: 2e6d 656d 6f72 792e 6d61 6e61 6765 6420  .memory.managed 
-000204e0: 696e 7374 6561 6420 6f66 0a20 2020 2020  instead of.     
-000204f0: 2020 2023 2073 6368 6564 756c 6572 2e57     # scheduler.W
-00020500: 6f72 6b65 7253 7461 7465 2e6d 6574 7269  orkerState.metri
-00020510: 6373 5b22 6d61 6e61 6765 645f 6279 7465  cs["managed_byte
-00020520: 7322 5d3b 2074 6865 2074 776f 206d 6561  s"]; the two mea
-00020530: 7375 7265 7320 6172 6520 736c 6967 6874  sures are slight
-00020540: 6c79 0a20 2020 2020 2020 2023 2064 6966  ly.        # dif
-00020550: 6665 7265 6e74 2e20 5365 6520 6578 706c  ferent. See expl
-00020560: 616e 6174 696f 6e20 696e 2073 6368 6564  anation in sched
-00020570: 756c 6572 2e57 6f72 6b65 7253 7461 7465  uler.WorkerState
-00020580: 2e6d 656d 6f72 7928 292e 0a20 2020 2020  .memory()..     
-00020590: 2020 2022 6d61 6e61 6765 645f 6279 7465     "managed_byte
-000205a0: 7322 2c0a 2020 2020 2020 2020 2273 7069  s",.        "spi
-000205b0: 6c6c 6564 5f62 7974 6573 222c 0a20 2020  lled_bytes",.   
-000205c0: 207d 0a0a 2020 2020 6465 6620 5f5f 696e   }..    def __in
-000205d0: 6974 5f5f 2873 656c 662c 2073 6368 6564  it__(self, sched
-000205e0: 756c 6572 2c20 7769 6474 683d 3830 302c  uler, width=800,
-000205f0: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
-00020600: 2020 2020 7365 6c66 2e73 6368 6564 756c      self.schedul
-00020610: 6572 203d 2073 6368 6564 756c 6572 0a20  er = scheduler. 
-00020620: 2020 2020 2020 2073 656c 662e 6e61 6d65         self.name
-00020630: 7320 3d20 5b0a 2020 2020 2020 2020 2020  s = [.          
-00020640: 2020 226e 616d 6522 2c0a 2020 2020 2020    "name",.      
-00020650: 2020 2020 2020 2261 6464 7265 7373 222c        "address",
-00020660: 0a20 2020 2020 2020 2020 2020 2022 6e74  .            "nt
-00020670: 6872 6561 6473 222c 0a20 2020 2020 2020  hreads",.       
-00020680: 2020 2020 2022 6370 7522 2c0a 2020 2020       "cpu",.    
-00020690: 2020 2020 2020 2020 226d 656d 6f72 7922          "memory"
-000206a0: 2c0a 2020 2020 2020 2020 2020 2020 226d  ,.            "m
-000206b0: 656d 6f72 795f 6c69 6d69 7422 2c0a 2020  emory_limit",.  
-000206c0: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
-000206d0: 795f 7065 7263 656e 7422 2c0a 2020 2020  y_percent",.    
-000206e0: 2020 2020 2020 2020 226d 656d 6f72 795f          "memory_
-000206f0: 6d61 6e61 6765 6422 2c0a 2020 2020 2020  managed",.      
-00020700: 2020 2020 2020 226d 656d 6f72 795f 756e        "memory_un
-00020710: 6d61 6e61 6765 645f 6f6c 6422 2c0a 2020  managed_old",.  
-00020720: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
-00020730: 795f 756e 6d61 6e61 6765 645f 7265 6365  y_unmanaged_rece
-00020740: 6e74 222c 0a20 2020 2020 2020 2020 2020  nt",.           
-00020750: 2022 6d65 6d6f 7279 5f73 7069 6c6c 6564   "memory_spilled
-00020760: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
-00020770: 6e75 6d5f 6664 7322 2c0a 2020 2020 2020  num_fds",.      
-00020780: 2020 2020 2020 2268 6f73 745f 6e65 745f        "host_net_
-00020790: 696f 2e72 6561 645f 6270 7322 2c0a 2020  io.read_bps",.  
-000207a0: 2020 2020 2020 2020 2020 2268 6f73 745f            "host_
-000207b0: 6e65 745f 696f 2e77 7269 7465 5f62 7073  net_io.write_bps
-000207c0: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
-000207d0: 686f 7374 5f64 6973 6b5f 696f 2e72 6561  host_disk_io.rea
-000207e0: 645f 6270 7322 2c0a 2020 2020 2020 2020  d_bps",.        
-000207f0: 2020 2020 2268 6f73 745f 6469 736b 5f69      "host_disk_i
-00020800: 6f2e 7772 6974 655f 6270 7322 2c0a 2020  o.write_bps",.  
-00020810: 2020 2020 2020 2020 2020 2263 7075 5f66            "cpu_f
-00020820: 7261 6374 696f 6e22 2c0a 2020 2020 2020  raction",.      
-00020830: 2020 5d0a 2020 2020 2020 2020 776f 726b    ].        work
-00020840: 6572 7320 3d20 7365 6c66 2e73 6368 6564  ers = self.sched
-00020850: 756c 6572 2e77 6f72 6b65 7273 2e76 616c  uler.workers.val
-00020860: 7565 7328 290a 2020 2020 2020 2020 7365  ues().        se
-00020870: 6c66 2e65 7874 7261 5f6e 616d 6573 203d  lf.extra_names =
-00020880: 2073 6f72 7465 6428 0a20 2020 2020 2020   sorted(.       
-00020890: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-000208a0: 2020 2020 2020 206d 0a20 2020 2020 2020         m.       
-000208b0: 2020 2020 2020 2020 2066 6f72 2077 7320           for ws 
-000208c0: 696e 2077 6f72 6b65 7273 0a20 2020 2020  in workers.     
-000208d0: 2020 2020 2020 2020 2020 2066 6f72 206d             for m
-000208e0: 2c20 7620 696e 2077 732e 6d65 7472 6963  , v in ws.metric
-000208f0: 732e 6974 656d 7328 290a 2020 2020 2020  s.items().      
-00020900: 2020 2020 2020 2020 2020 6966 206d 206e            if m n
-00020910: 6f74 2069 6e20 7365 6c66 2e6e 616d 6573  ot in self.names
-00020920: 2061 6e64 2069 7369 6e73 7461 6e63 6528   and isinstance(
-00020930: 762c 2028 7374 722c 2069 6e74 2c20 666c  v, (str, int, fl
-00020940: 6f61 7429 290a 2020 2020 2020 2020 2020  oat)).          
-00020950: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00020960: 2d20 7365 6c66 2e65 7863 6c75 6465 645f  - self.excluded_
-00020970: 6e61 6d65 730a 2020 2020 2020 2020 290a  names.        ).
-00020980: 0a20 2020 2020 2020 2074 6162 6c65 5f6e  .        table_n
-00020990: 616d 6573 203d 205b 0a20 2020 2020 2020  ames = [.       
-000209a0: 2020 2020 2022 6e61 6d65 222c 0a20 2020       "name",.   
-000209b0: 2020 2020 2020 2020 2022 6164 6472 6573           "addres
-000209c0: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-000209d0: 226e 7468 7265 6164 7322 2c0a 2020 2020  "nthreads",.    
-000209e0: 2020 2020 2020 2020 2263 7075 222c 0a20          "cpu",. 
-000209f0: 2020 2020 2020 2020 2020 2022 6d65 6d6f             "memo
-00020a00: 7279 222c 0a20 2020 2020 2020 2020 2020  ry",.           
-00020a10: 2022 6d65 6d6f 7279 5f6c 696d 6974 222c   "memory_limit",
-00020a20: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
-00020a30: 6d6f 7279 5f70 6572 6365 6e74 222c 0a20  mory_percent",. 
-00020a40: 2020 2020 2020 2020 2020 2022 6d65 6d6f             "memo
-00020a50: 7279 5f6d 616e 6167 6564 222c 0a20 2020  ry_managed",.   
-00020a60: 2020 2020 2020 2020 2022 6d65 6d6f 7279           "memory
-00020a70: 5f75 6e6d 616e 6167 6564 5f6f 6c64 222c  _unmanaged_old",
-00020a80: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
-00020a90: 6d6f 7279 5f75 6e6d 616e 6167 6564 5f72  mory_unmanaged_r
-00020aa0: 6563 656e 7422 2c0a 2020 2020 2020 2020  ecent",.        
-00020ab0: 2020 2020 226d 656d 6f72 795f 7370 696c      "memory_spil
-00020ac0: 6c65 6422 2c0a 2020 2020 2020 2020 2020  led",.          
-00020ad0: 2020 226e 756d 5f66 6473 222c 0a20 2020    "num_fds",.   
-00020ae0: 2020 2020 2020 2020 2022 686f 7374 5f6e           "host_n
-00020af0: 6574 5f69 6f2e 7265 6164 5f62 7073 222c  et_io.read_bps",
-00020b00: 0a20 2020 2020 2020 2020 2020 2022 686f  .            "ho
-00020b10: 7374 5f6e 6574 5f69 6f2e 7772 6974 655f  st_net_io.write_
-00020b20: 6270 7322 2c0a 2020 2020 2020 2020 2020  bps",.          
-00020b30: 2020 2268 6f73 745f 6469 736b 5f69 6f2e    "host_disk_io.
-00020b40: 7265 6164 5f62 7073 222c 0a20 2020 2020  read_bps",.     
-00020b50: 2020 2020 2020 2022 686f 7374 5f64 6973         "host_dis
-00020b60: 6b5f 696f 2e77 7269 7465 5f62 7073 222c  k_io.write_bps",
-00020b70: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
-00020b80: 2020 2063 6f6c 756d 6e5f 7469 746c 655f     column_title_
-00020b90: 7265 6e61 6d65 7320 3d20 7b0a 2020 2020  renames = {.    
-00020ba0: 2020 2020 2020 2020 226d 656d 6f72 795f          "memory_
-00020bb0: 6c69 6d69 7422 3a20 226c 696d 6974 222c  limit": "limit",
-00020bc0: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
-00020bd0: 6d6f 7279 5f70 6572 6365 6e74 223a 2022  mory_percent": "
-00020be0: 6d65 6d6f 7279 2025 222c 0a20 2020 2020  memory %",.     
-00020bf0: 2020 2020 2020 2022 6d65 6d6f 7279 5f6d         "memory_m
-00020c00: 616e 6167 6564 223a 2022 6d61 6e61 6765  anaged": "manage
-00020c10: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
-00020c20: 226d 656d 6f72 795f 756e 6d61 6e61 6765  "memory_unmanage
-00020c30: 645f 6f6c 6422 3a20 2275 6e6d 616e 6167  d_old": "unmanag
-00020c40: 6564 206f 6c64 222c 0a20 2020 2020 2020  ed old",.       
-00020c50: 2020 2020 2022 6d65 6d6f 7279 5f75 6e6d       "memory_unm
-00020c60: 616e 6167 6564 5f72 6563 656e 7422 3a20  anaged_recent": 
-00020c70: 2275 6e6d 616e 6167 6564 2072 6563 656e  "unmanaged recen
-00020c80: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
-00020c90: 226d 656d 6f72 795f 7370 696c 6c65 6422  "memory_spilled"
-00020ca0: 3a20 2273 7069 6c6c 6564 222c 0a20 2020  : "spilled",.   
-00020cb0: 2020 2020 2020 2020 2022 6e75 6d5f 6664           "num_fd
-00020cc0: 7322 3a20 2223 2066 6473 222c 0a20 2020  s": "# fds",.   
-00020cd0: 2020 2020 2020 2020 2022 686f 7374 5f6e           "host_n
-00020ce0: 6574 5f69 6f2e 7265 6164 5f62 7073 223a  et_io.read_bps":
-00020cf0: 2022 6e65 7420 7265 6164 222c 0a20 2020   "net read",.   
-00020d00: 2020 2020 2020 2020 2022 686f 7374 5f6e           "host_n
-00020d10: 6574 5f69 6f2e 7772 6974 655f 6270 7322  et_io.write_bps"
-00020d20: 3a20 226e 6574 2077 7269 7465 222c 0a20  : "net write",. 
-00020d30: 2020 2020 2020 2020 2020 2022 686f 7374             "host
-00020d40: 5f64 6973 6b5f 696f 2e72 6561 645f 6270  _disk_io.read_bp
-00020d50: 7322 3a20 2264 6973 6b20 7265 6164 222c  s": "disk read",
-00020d60: 0a20 2020 2020 2020 2020 2020 2022 686f  .            "ho
-00020d70: 7374 5f64 6973 6b5f 696f 2e77 7269 7465  st_disk_io.write
-00020d80: 5f62 7073 223a 2022 6469 736b 2077 7269  _bps": "disk wri
-00020d90: 7465 222c 0a20 2020 2020 2020 207d 0a0a  te",.        }..
-00020da0: 2020 2020 2020 2020 7365 6c66 2e73 6f75          self.sou
-00020db0: 7263 6520 3d20 436f 6c75 6d6e 4461 7461  rce = ColumnData
-00020dc0: 536f 7572 6365 287b 6b3a 205b 5d20 666f  Source({k: [] fo
-00020dd0: 7220 6b20 696e 2073 656c 662e 6e61 6d65  r k in self.name
-00020de0: 737d 290a 0a20 2020 2020 2020 2063 6f6c  s})..        col
-00020df0: 756d 6e73 203d 207b 0a20 2020 2020 2020  umns = {.       
-00020e00: 2020 2020 206e 616d 653a 2054 6162 6c65       name: Table
-00020e10: 436f 6c75 6d6e 2866 6965 6c64 3d6e 616d  Column(field=nam
-00020e20: 652c 2074 6974 6c65 3d63 6f6c 756d 6e5f  e, title=column_
-00020e30: 7469 746c 655f 7265 6e61 6d65 732e 6765  title_renames.ge
-00020e40: 7428 6e61 6d65 2c20 6e61 6d65 2929 0a20  t(name, name)). 
-00020e50: 2020 2020 2020 2020 2020 2066 6f72 206e             for n
-00020e60: 616d 6520 696e 2074 6162 6c65 5f6e 616d  ame in table_nam
-00020e70: 6573 0a20 2020 2020 2020 207d 0a0a 2020  es.        }..  
-00020e80: 2020 2020 2020 666f 726d 6174 7465 7273        formatters
-00020e90: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00020ea0: 2022 6370 7522 3a20 4e75 6d62 6572 466f   "cpu": NumberFo
-00020eb0: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
-00020ec0: 3020 2522 292c 0a20 2020 2020 2020 2020  0 %"),.         
-00020ed0: 2020 2022 6d65 6d6f 7279 5f70 6572 6365     "memory_perce
-00020ee0: 6e74 223a 204e 756d 6265 7246 6f72 6d61  nt": NumberForma
-00020ef0: 7474 6572 2866 6f72 6d61 743d 2230 2e30  tter(format="0.0
-00020f00: 2025 2229 2c0a 2020 2020 2020 2020 2020   %"),.          
-00020f10: 2020 226d 656d 6f72 7922 3a20 4e75 6d62    "memory": Numb
-00020f20: 6572 466f 726d 6174 7465 7228 666f 726d  erFormatter(form
-00020f30: 6174 3d22 302e 3020 6222 292c 0a20 2020  at="0.0 b"),.   
-00020f40: 2020 2020 2020 2020 2022 6d65 6d6f 7279           "memory
-00020f50: 5f6c 696d 6974 223a 204e 756d 6265 7246  _limit": NumberF
-00020f60: 6f72 6d61 7474 6572 2866 6f72 6d61 743d  ormatter(format=
-00020f70: 2230 2e30 2062 2229 2c0a 2020 2020 2020  "0.0 b"),.      
-00020f80: 2020 2020 2020 226d 656d 6f72 795f 6d61        "memory_ma
-00020f90: 6e61 6765 6422 3a20 4e75 6d62 6572 466f  naged": NumberFo
-00020fa0: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
-00020fb0: 302e 3020 6222 292c 0a20 2020 2020 2020  0.0 b"),.       
-00020fc0: 2020 2020 2022 6d65 6d6f 7279 5f75 6e6d       "memory_unm
-00020fd0: 616e 6167 6564 5f6f 6c64 223a 204e 756d  anaged_old": Num
-00020fe0: 6265 7246 6f72 6d61 7474 6572 2866 6f72  berFormatter(for
-00020ff0: 6d61 743d 2230 2e30 2062 2229 2c0a 2020  mat="0.0 b"),.  
-00021000: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
-00021010: 795f 756e 6d61 6e61 6765 645f 7265 6365  y_unmanaged_rece
-00021020: 6e74 223a 204e 756d 6265 7246 6f72 6d61  nt": NumberForma
-00021030: 7474 6572 2866 6f72 6d61 743d 2230 2e30  tter(format="0.0
-00021040: 2062 2229 2c0a 2020 2020 2020 2020 2020   b"),.          
-00021050: 2020 226d 656d 6f72 795f 7370 696c 6c65    "memory_spille
-00021060: 6422 3a20 4e75 6d62 6572 466f 726d 6174  d": NumberFormat
-00021070: 7465 7228 666f 726d 6174 3d22 302e 3020  ter(format="0.0 
-00021080: 6222 292c 0a20 2020 2020 2020 2020 2020  b"),.           
-00021090: 2022 686f 7374 5f6e 6574 5f69 6f2e 7265   "host_net_io.re
-000210a0: 6164 5f62 7073 223a 204e 756d 6265 7246  ad_bps": NumberF
-000210b0: 6f72 6d61 7474 6572 2866 6f72 6d61 743d  ormatter(format=
-000210c0: 2230 2062 2229 2c0a 2020 2020 2020 2020  "0 b"),.        
-000210d0: 2020 2020 2268 6f73 745f 6e65 745f 696f      "host_net_io
-000210e0: 2e77 7269 7465 5f62 7073 223a 204e 756d  .write_bps": Num
-000210f0: 6265 7246 6f72 6d61 7474 6572 2866 6f72  berFormatter(for
-00021100: 6d61 743d 2230 2062 2229 2c0a 2020 2020  mat="0 b"),.    
-00021110: 2020 2020 2020 2020 226e 756d 5f66 6473          "num_fds
-00021120: 223a 204e 756d 6265 7246 6f72 6d61 7474  ": NumberFormatt
-00021130: 6572 2866 6f72 6d61 743d 2230 2229 2c0a  er(format="0"),.
-00021140: 2020 2020 2020 2020 2020 2020 226e 7468              "nth
-00021150: 7265 6164 7322 3a20 4e75 6d62 6572 466f  reads": NumberFo
-00021160: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
-00021170: 3022 292c 0a20 2020 2020 2020 2020 2020  0"),.           
-00021180: 2022 686f 7374 5f64 6973 6b5f 696f 2e72   "host_disk_io.r
-00021190: 6561 645f 6270 7322 3a20 4e75 6d62 6572  ead_bps": Number
-000211a0: 466f 726d 6174 7465 7228 666f 726d 6174  Formatter(format
-000211b0: 3d22 3020 6222 292c 0a20 2020 2020 2020  ="0 b"),.       
-000211c0: 2020 2020 2022 686f 7374 5f64 6973 6b5f       "host_disk_
-000211d0: 696f 2e77 7269 7465 5f62 7073 223a 204e  io.write_bps": N
-000211e0: 756d 6265 7246 6f72 6d61 7474 6572 2866  umberFormatter(f
-000211f0: 6f72 6d61 743d 2230 2062 2229 2c0a 2020  ormat="0 b"),.  
-00021200: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00021210: 2074 6162 6c65 203d 2044 6174 6154 6162   table = DataTab
-00021220: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
-00021230: 736f 7572 6365 3d73 656c 662e 736f 7572  source=self.sour
-00021240: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
-00021250: 636f 6c75 6d6e 733d 5b63 6f6c 756d 6e73  columns=[columns
-00021260: 5b6e 5d20 666f 7220 6e20 696e 2074 6162  [n] for n in tab
-00021270: 6c65 5f6e 616d 6573 5d2c 0a20 2020 2020  le_names],.     
-00021280: 2020 2020 2020 2072 656f 7264 6572 6162         reorderab
-00021290: 6c65 3d54 7275 652c 0a20 2020 2020 2020  le=True,.       
-000212a0: 2020 2020 2073 6f72 7461 626c 653d 5472       sortable=Tr
-000212b0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-000212c0: 7769 6474 683d 7769 6474 682c 0a20 2020  width=width,.   
-000212d0: 2020 2020 2020 2020 2069 6e64 6578 5f70           index_p
-000212e0: 6f73 6974 696f 6e3d 4e6f 6e65 2c0a 2020  osition=None,.  
-000212f0: 2020 2020 2020 2020 2020 2a2a 5f44 4154            **_DAT
-00021300: 4154 4142 4c45 5f53 5459 4c45 5348 4545  ATABLE_STYLESHEE
-00021310: 5453 5f4b 5741 5247 532c 0a20 2020 2020  TS_KWARGS,.     
-00021320: 2020 2029 0a0a 2020 2020 2020 2020 666f     )..        fo
-00021330: 7220 6e61 6d65 2069 6e20 7461 626c 655f  r name in table_
-00021340: 6e61 6d65 733a 0a20 2020 2020 2020 2020  names:.         
-00021350: 2020 2069 6620 6e61 6d65 2069 6e20 666f     if name in fo
-00021360: 726d 6174 7465 7273 3a0a 2020 2020 2020  rmatters:.      
-00021370: 2020 2020 2020 2020 2020 7461 626c 652e            table.
-00021380: 636f 6c75 6d6e 735b 7461 626c 655f 6e61  columns[table_na
-00021390: 6d65 732e 696e 6465 7828 6e61 6d65 295d  mes.index(name)]
-000213a0: 2e66 6f72 6d61 7474 6572 203d 2066 6f72  .formatter = for
-000213b0: 6d61 7474 6572 735b 6e61 6d65 5d0a 0a20  matters[name].. 
-000213c0: 2020 2020 2020 2065 7874 7261 5f6e 616d         extra_nam
-000213d0: 6573 203d 205b 226e 616d 6522 2c20 2261  es = ["name", "a
-000213e0: 6464 7265 7373 225d 202b 2073 656c 662e  ddress"] + self.
-000213f0: 6578 7472 615f 6e61 6d65 730a 2020 2020  extra_names.    
-00021400: 2020 2020 6578 7472 615f 636f 6c75 6d6e      extra_column
-00021410: 7320 3d20 7b0a 2020 2020 2020 2020 2020  s = {.          
-00021420: 2020 6e61 6d65 3a20 5461 626c 6543 6f6c    name: TableCol
-00021430: 756d 6e28 6669 656c 643d 6e61 6d65 2c20  umn(field=name, 
-00021440: 7469 746c 653d 636f 6c75 6d6e 5f74 6974  title=column_tit
-00021450: 6c65 5f72 656e 616d 6573 2e67 6574 286e  le_renames.get(n
-00021460: 616d 652c 206e 616d 6529 290a 2020 2020  ame, name)).    
-00021470: 2020 2020 2020 2020 666f 7220 6e61 6d65          for name
-00021480: 2069 6e20 6578 7472 615f 6e61 6d65 730a   in extra_names.
-00021490: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-000214a0: 2020 2065 7874 7261 5f74 6162 6c65 203d     extra_table =
-000214b0: 2044 6174 6154 6162 6c65 280a 2020 2020   DataTable(.    
-000214c0: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
-000214d0: 656c 662e 736f 7572 6365 2c0a 2020 2020  elf.source,.    
-000214e0: 2020 2020 2020 2020 636f 6c75 6d6e 733d          columns=
-000214f0: 5b65 7874 7261 5f63 6f6c 756d 6e73 5b6e  [extra_columns[n
-00021500: 5d20 666f 7220 6e20 696e 2065 7874 7261  ] for n in extra
-00021510: 5f6e 616d 6573 5d2c 0a20 2020 2020 2020  _names],.       
-00021520: 2020 2020 2072 656f 7264 6572 6162 6c65       reorderable
-00021530: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
-00021540: 2020 2073 6f72 7461 626c 653d 5472 7565     sortable=True
-00021550: 2c0a 2020 2020 2020 2020 2020 2020 7769  ,.            wi
-00021560: 6474 683d 7769 6474 682c 0a20 2020 2020  dth=width,.     
-00021570: 2020 2020 2020 2069 6e64 6578 5f70 6f73         index_pos
-00021580: 6974 696f 6e3d 4e6f 6e65 2c0a 2020 2020  ition=None,.    
-00021590: 2020 2020 2020 2020 2a2a 5f44 4154 4154          **_DATAT
-000215a0: 4142 4c45 5f53 5459 4c45 5348 4545 5453  ABLE_STYLESHEETS
-000215b0: 5f4b 5741 5247 532c 0a20 2020 2020 2020  _KWARGS,.       
-000215c0: 2029 0a0a 2020 2020 2020 2020 666f 7220   )..        for 
-000215d0: 6e61 6d65 2069 6e20 6578 7472 615f 6e61  name in extra_na
-000215e0: 6d65 733a 0a20 2020 2020 2020 2020 2020  mes:.           
-000215f0: 2069 6620 6e61 6d65 2069 6e20 666f 726d   if name in form
-00021600: 6174 7465 7273 3a0a 2020 2020 2020 2020  atters:.        
-00021610: 2020 2020 2020 2020 6578 7472 615f 7461          extra_ta
-00021620: 626c 652e 636f 6c75 6d6e 735b 6578 7472  ble.columns[extr
-00021630: 615f 6e61 6d65 732e 696e 6465 7828 6e61  a_names.index(na
-00021640: 6d65 295d 2e66 6f72 6d61 7474 6572 203d  me)].formatter =
-00021650: 2066 6f72 6d61 7474 6572 735b 0a20 2020   formatters[.   
-00021660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021670: 206e 616d 650a 2020 2020 2020 2020 2020   name.          
-00021680: 2020 2020 2020 5d0a 0a20 2020 2020 2020        ]..       
-00021690: 2068 6f76 6572 203d 2048 6f76 6572 546f   hover = HoverTo
-000216a0: 6f6c 280a 2020 2020 2020 2020 2020 2020  ol(.            
-000216b0: 706f 696e 745f 706f 6c69 6379 3d22 666f  point_policy="fo
-000216c0: 6c6c 6f77 5f6d 6f75 7365 222c 0a20 2020  llow_mouse",.   
-000216d0: 2020 2020 2020 2020 2074 6f6f 6c74 6970           tooltip
-000216e0: 733d 2222 220a 2020 2020 2020 2020 2020  s=""".          
-000216f0: 2020 2020 2020 3c64 6976 3e0a 2020 2020        <div>.    
-00021700: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
-00021710: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
-00021720: 7369 7a65 3a20 3130 7078 3b20 666f 6e74  size: 10px; font
-00021730: 2d66 616d 696c 793a 204d 6f6e 6163 6f2c  -family: Monaco,
-00021740: 206d 6f6e 6f73 7061 6365 3b22 3e57 6f72   monospace;">Wor
-00021750: 6b65 7220 2840 6e61 6d65 293a 203c 2f73  ker (@name): </s
-00021760: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
-00021770: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
-00021780: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
-00021790: 3070 783b 2066 6f6e 742d 6661 6d69 6c79  0px; font-family
-000217a0: 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f 7370  : Monaco, monosp
-000217b0: 6163 653b 223e 406d 656d 6f72 795f 7065  ace;">@memory_pe
-000217c0: 7263 656e 747b 302e 3020 257d 3c2f 7370  rcent{0.0 %}</sp
-000217d0: 616e 3e0a 2020 2020 2020 2020 2020 2020  an>.            
-000217e0: 2020 2020 3c2f 6469 763e 0a20 2020 2020      </div>.     
-000217f0: 2020 2020 2020 2020 2020 2022 2222 2c0a             """,.
-00021800: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00021810: 2020 206d 656d 5f70 6c6f 7420 3d20 6669     mem_plot = fi
-00021820: 6775 7265 280a 2020 2020 2020 2020 2020  gure(.          
-00021830: 2020 7469 746c 653d 224d 656d 6f72 7920    title="Memory 
-00021840: 5573 6520 2825 2922 2c0a 2020 2020 2020  Use (%)",.      
-00021850: 2020 2020 2020 746f 6f6c 6261 725f 6c6f        toolbar_lo
-00021860: 6361 7469 6f6e 3d4e 6f6e 652c 0a20 2020  cation=None,.   
-00021870: 2020 2020 2020 2020 2078 5f72 616e 6765           x_range
-00021880: 3d28 302c 2031 292c 0a20 2020 2020 2020  =(0, 1),.       
-00021890: 2020 2020 2079 5f72 616e 6765 3d28 2d30       y_range=(-0
-000218a0: 2e31 2c20 302e 3129 2c0a 2020 2020 2020  .1, 0.1),.      
-000218b0: 2020 2020 2020 6865 6967 6874 3d36 302c        height=60,
-000218c0: 0a20 2020 2020 2020 2020 2020 2077 6964  .            wid
-000218d0: 7468 3d77 6964 7468 2c0a 2020 2020 2020  th=width,.      
-000218e0: 2020 2020 2020 746f 6f6c 733d 2222 2c0a        tools="",.
-000218f0: 2020 2020 2020 2020 2020 2020 6d69 6e5f              min_
-00021900: 626f 7264 6572 5f72 6967 6874 3d30 2c0a  border_right=0,.
-00021910: 2020 2020 2020 2020 2020 2020 2a2a 6b77              **kw
-00021920: 6172 6773 2c0a 2020 2020 2020 2020 290a  args,.        ).
-00021930: 2020 2020 2020 2020 6d65 6d5f 706c 6f74          mem_plot
-00021940: 2e63 6972 636c 6528 0a20 2020 2020 2020  .circle(.       
-00021950: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
-00021960: 2e73 6f75 7263 652c 2078 3d22 6d65 6d6f  .source, x="memo
-00021970: 7279 5f70 6572 6365 6e74 222c 2079 3d30  ry_percent", y=0
-00021980: 2c20 7369 7a65 3d31 302c 2066 696c 6c5f  , size=10, fill_
-00021990: 616c 7068 613d 302e 350a 2020 2020 2020  alpha=0.5.      
-000219a0: 2020 290a 2020 2020 2020 2020 6d65 6d5f    ).        mem_
-000219b0: 706c 6f74 2e79 6772 6964 2e76 6973 6962  plot.ygrid.visib
-000219c0: 6c65 203d 2046 616c 7365 0a20 2020 2020  le = False.     
-000219d0: 2020 206d 656d 5f70 6c6f 742e 7961 7869     mem_plot.yaxi
-000219e0: 732e 6d69 6e6f 725f 7469 636b 5f6c 696e  s.minor_tick_lin
-000219f0: 655f 616c 7068 6120 3d20 300a 2020 2020  e_alpha = 0.    
-00021a00: 2020 2020 6d65 6d5f 706c 6f74 2e78 6178      mem_plot.xax
-00021a10: 6973 2e76 6973 6962 6c65 203d 2046 616c  is.visible = Fal
-00021a20: 7365 0a20 2020 2020 2020 206d 656d 5f70  se.        mem_p
-00021a30: 6c6f 742e 7961 7869 732e 7669 7369 626c  lot.yaxis.visibl
-00021a40: 6520 3d20 4661 6c73 650a 2020 2020 2020  e = False.      
-00021a50: 2020 6d65 6d5f 706c 6f74 2e61 6464 5f74    mem_plot.add_t
-00021a60: 6f6f 6c73 2868 6f76 6572 2c20 426f 7853  ools(hover, BoxS
-00021a70: 656c 6563 7454 6f6f 6c28 2929 0a0a 2020  electTool())..  
-00021a80: 2020 2020 2020 686f 7665 7220 3d20 486f        hover = Ho
-00021a90: 7665 7254 6f6f 6c28 0a20 2020 2020 2020  verTool(.       
-00021aa0: 2020 2020 2070 6f69 6e74 5f70 6f6c 6963       point_polic
-00021ab0: 793d 2266 6f6c 6c6f 775f 6d6f 7573 6522  y="follow_mouse"
-00021ac0: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
-00021ad0: 6f6c 7469 7073 3d22 2222 0a20 2020 2020  oltips=""".     
-00021ae0: 2020 2020 2020 2020 2020 203c 6469 763e             <div>
-00021af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021b00: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
-00021b10: 666f 6e74 2d73 697a 653a 2031 3070 783b  font-size: 10px;
-00021b20: 2066 6f6e 742d 6661 6d69 6c79 3a20 4d6f   font-family: Mo
-00021b30: 6e61 636f 2c20 6d6f 6e6f 7370 6163 653b  naco, monospace;
-00021b40: 223e 576f 726b 6572 2028 406e 616d 6529  ">Worker (@name)
-00021b50: 3a20 3c2f 7370 616e 3e0a 2020 2020 2020  : </span>.      
-00021b60: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
-00021b70: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
-00021b80: 7a65 3a20 3130 7078 3b20 666f 6e74 2d66  ze: 10px; font-f
-00021b90: 616d 696c 793a 204d 6f6e 6163 6f2c 206d  amily: Monaco, m
-00021ba0: 6f6e 6f73 7061 6365 3b22 3e40 6370 755f  onospace;">@cpu_
-00021bb0: 6672 6163 7469 6f6e 7b30 2025 7d3c 2f73  fraction{0 %}</s
-00021bc0: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
-00021bd0: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
-00021be0: 2020 2020 2020 2020 2020 2020 2222 222c              """,
-00021bf0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00021c00: 2020 2020 6370 755f 706c 6f74 203d 2066      cpu_plot = f
-00021c10: 6967 7572 6528 0a20 2020 2020 2020 2020  igure(.         
-00021c20: 2020 2074 6974 6c65 3d22 4350 5520 5573     title="CPU Us
-00021c30: 6520 2825 2922 2c0a 2020 2020 2020 2020  e (%)",.        
-00021c40: 2020 2020 746f 6f6c 6261 725f 6c6f 6361      toolbar_loca
-00021c50: 7469 6f6e 3d4e 6f6e 652c 0a20 2020 2020  tion=None,.     
-00021c60: 2020 2020 2020 2078 5f72 616e 6765 3d28         x_range=(
-00021c70: 302c 2031 292c 0a20 2020 2020 2020 2020  0, 1),.         
-00021c80: 2020 2079 5f72 616e 6765 3d28 2d30 2e31     y_range=(-0.1
-00021c90: 2c20 302e 3129 2c0a 2020 2020 2020 2020  , 0.1),.        
-00021ca0: 2020 2020 6865 6967 6874 3d36 302c 0a20      height=60,. 
-00021cb0: 2020 2020 2020 2020 2020 2077 6964 7468             width
-00021cc0: 3d77 6964 7468 2c0a 2020 2020 2020 2020  =width,.        
-00021cd0: 2020 2020 746f 6f6c 733d 2222 2c0a 2020      tools="",.  
-00021ce0: 2020 2020 2020 2020 2020 6d69 6e5f 626f            min_bo
-00021cf0: 7264 6572 5f72 6967 6874 3d30 2c0a 2020  rder_right=0,.  
-00021d00: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
-00021d10: 6773 2c0a 2020 2020 2020 2020 290a 2020  gs,.        ).  
-00021d20: 2020 2020 2020 6370 755f 706c 6f74 2e63        cpu_plot.c
-00021d30: 6972 636c 6528 0a20 2020 2020 2020 2020  ircle(.         
-00021d40: 2020 2073 6f75 7263 653d 7365 6c66 2e73     source=self.s
-00021d50: 6f75 7263 652c 2078 3d22 6370 755f 6672  ource, x="cpu_fr
-00021d60: 6163 7469 6f6e 222c 2079 3d30 2c20 7369  action", y=0, si
-00021d70: 7a65 3d31 302c 2066 696c 6c5f 616c 7068  ze=10, fill_alph
-00021d80: 613d 302e 350a 2020 2020 2020 2020 290a  a=0.5.        ).
-00021d90: 2020 2020 2020 2020 6370 755f 706c 6f74          cpu_plot
-00021da0: 2e79 6772 6964 2e76 6973 6962 6c65 203d  .ygrid.visible =
-00021db0: 2046 616c 7365 0a20 2020 2020 2020 2063   False.        c
-00021dc0: 7075 5f70 6c6f 742e 7961 7869 732e 6d69  pu_plot.yaxis.mi
-00021dd0: 6e6f 725f 7469 636b 5f6c 696e 655f 616c  nor_tick_line_al
-00021de0: 7068 6120 3d20 300a 2020 2020 2020 2020  pha = 0.        
-00021df0: 6370 755f 706c 6f74 2e78 6178 6973 2e76  cpu_plot.xaxis.v
-00021e00: 6973 6962 6c65 203d 2046 616c 7365 0a20  isible = False. 
-00021e10: 2020 2020 2020 2063 7075 5f70 6c6f 742e         cpu_plot.
-00021e20: 7961 7869 732e 7669 7369 626c 6520 3d20  yaxis.visible = 
-00021e30: 4661 6c73 650a 2020 2020 2020 2020 6370  False.        cp
-00021e40: 755f 706c 6f74 2e61 6464 5f74 6f6f 6c73  u_plot.add_tools
-00021e50: 2868 6f76 6572 2c20 426f 7853 656c 6563  (hover, BoxSelec
-00021e60: 7454 6f6f 6c28 2929 0a20 2020 2020 2020  tTool()).       
-00021e70: 2073 656c 662e 6370 755f 706c 6f74 203d   self.cpu_plot =
-00021e80: 2063 7075 5f70 6c6f 740a 0a20 2020 2020   cpu_plot..     
-00021e90: 2020 2069 6620 2273 697a 696e 675f 6d6f     if "sizing_mo
-00021ea0: 6465 2220 696e 206b 7761 7267 733a 0a20  de" in kwargs:. 
-00021eb0: 2020 2020 2020 2020 2020 2073 697a 696e             sizin
-00021ec0: 675f 6d6f 6465 203d 207b 2273 697a 696e  g_mode = {"sizin
-00021ed0: 675f 6d6f 6465 223a 206b 7761 7267 735b  g_mode": kwargs[
-00021ee0: 2273 697a 696e 675f 6d6f 6465 225d 7d0a  "sizing_mode"]}.
-00021ef0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00021f00: 2020 2020 2020 2020 2020 7369 7a69 6e67            sizing
-00021f10: 5f6d 6f64 6520 3d20 7b7d 0a0a 2020 2020  _mode = {}..    
-00021f20: 2020 2020 636f 6d70 6f6e 656e 7473 203d      components =
-00021f30: 205b 6370 755f 706c 6f74 2c20 6d65 6d5f   [cpu_plot, mem_
-00021f40: 706c 6f74 2c20 7461 626c 655d 0a20 2020  plot, table].   
-00021f50: 2020 2020 2069 6620 7365 6c66 2e65 7874       if self.ext
-00021f60: 7261 5f6e 616d 6573 3a0a 2020 2020 2020  ra_names:.      
-00021f70: 2020 2020 2020 636f 6d70 6f6e 656e 7473        components
-00021f80: 2e61 7070 656e 6428 6578 7472 615f 7461  .append(extra_ta
-00021f90: 626c 6529 0a0a 2020 2020 2020 2020 7365  ble)..        se
-00021fa0: 6c66 2e72 6f6f 7420 3d20 636f 6c75 6d6e  lf.root = column
-00021fb0: 282a 636f 6d70 6f6e 656e 7473 2c20 2a2a  (*components, **
-00021fc0: 7369 7a69 6e67 5f6d 6f64 6529 0a0a 2020  sizing_mode)..  
-00021fd0: 2020 4077 6974 686f 7574 5f70 726f 7065    @without_prope
-00021fe0: 7274 795f 7661 6c69 6461 7469 6f6e 0a20  rty_validation. 
-00021ff0: 2020 2064 6566 2075 7064 6174 6528 7365     def update(se
-00022000: 6c66 293a 0a20 2020 2020 2020 2064 6174  lf):.        dat
-00022010: 6120 3d20 7b6e 616d 653a 205b 5d20 666f  a = {name: [] fo
-00022020: 7220 6e61 6d65 2069 6e20 7365 6c66 2e6e  r name in self.n
-00022030: 616d 6573 202b 2073 656c 662e 6578 7472  ames + self.extr
-00022040: 615f 6e61 6d65 737d 0a20 2020 2020 2020  a_names}.       
-00022050: 2066 6f72 2069 2c20 7773 2069 6e20 656e   for i, ws in en
-00022060: 756d 6572 6174 6528 0a20 2020 2020 2020  umerate(.       
-00022070: 2020 2020 2073 6f72 7465 6428 7365 6c66       sorted(self
-00022080: 2e73 6368 6564 756c 6572 2e77 6f72 6b65  .scheduler.worke
-00022090: 7273 2e76 616c 7565 7328 292c 206b 6579  rs.values(), key
-000220a0: 3d6c 616d 6264 6120 7773 3a20 7374 7228  =lambda ws: str(
-000220b0: 7773 2e6e 616d 6529 290a 2020 2020 2020  ws.name)).      
-000220c0: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-000220d0: 206d 696e 666f 203d 2077 732e 6d65 6d6f   minfo = ws.memo
-000220e0: 7279 0a0a 2020 2020 2020 2020 2020 2020  ry..            
-000220f0: 666f 7220 6e61 6d65 2069 6e20 7365 6c66  for name in self
-00022100: 2e6e 616d 6573 202b 2073 656c 662e 6578  .names + self.ex
-00022110: 7472 615f 6e61 6d65 733a 0a20 2020 2020  tra_names:.     
-00022120: 2020 2020 2020 2020 2020 2069 6620 222e             if ".
-00022130: 2220 696e 206e 616d 653a 0a20 2020 2020  " in name:.     
-00022140: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00022150: 302c 205f 2c20 6e31 203d 206e 616d 652e  0, _, n1 = name.
-00022160: 7061 7274 6974 696f 6e28 222e 2229 0a20  partition("."). 
-00022170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022180: 2020 2076 203d 2077 732e 6d65 7472 6963     v = ws.metric
-00022190: 732e 6765 7428 6e30 2c20 7b7d 292e 6765  s.get(n0, {}).ge
-000221a0: 7428 6e31 2c20 4e6f 6e65 290a 2020 2020  t(n1, None).    
-000221b0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000221c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000221d0: 2020 2020 2020 7620 3d20 7773 2e6d 6574        v = ws.met
-000221e0: 7269 6373 2e67 6574 286e 616d 652c 204e  rics.get(name, N
-000221f0: 6f6e 6529 0a20 2020 2020 2020 2020 2020  one).           
-00022200: 2020 2020 2064 6174 615b 6e61 6d65 5d2e       data[name].
-00022210: 6170 7065 6e64 2876 290a 0a20 2020 2020  append(v)..     
-00022220: 2020 2020 2020 2064 6174 615b 226e 616d         data["nam
-00022230: 6522 5d5b 2d31 5d20 3d20 7773 2e6e 616d  e"][-1] = ws.nam
-00022240: 6520 6966 2077 732e 6e61 6d65 2069 7320  e if ws.name is 
-00022250: 6e6f 7420 4e6f 6e65 2065 6c73 6520 690a  not None else i.
-00022260: 2020 2020 2020 2020 2020 2020 6461 7461              data
-00022270: 5b22 6164 6472 6573 7322 5d5b 2d31 5d20  ["address"][-1] 
-00022280: 3d20 7773 2e61 6464 7265 7373 0a20 2020  = ws.address.   
-00022290: 2020 2020 2020 2020 2069 6620 7773 2e6d           if ws.m
-000222a0: 656d 6f72 795f 6c69 6d69 743a 0a20 2020  emory_limit:.   
-000222b0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
-000222c0: 615b 226d 656d 6f72 795f 7065 7263 656e  a["memory_percen
-000222d0: 7422 5d5b 2d31 5d20 3d20 7773 2e6d 6574  t"][-1] = ws.met
-000222e0: 7269 6373 5b22 6d65 6d6f 7279 225d 202f  rics["memory"] /
-000222f0: 2077 732e 6d65 6d6f 7279 5f6c 696d 6974   ws.memory_limit
-00022300: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00022310: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00022320: 2020 2064 6174 615b 226d 656d 6f72 795f     data["memory_
-00022330: 7065 7263 656e 7422 5d5b 2d31 5d20 3d20  percent"][-1] = 
-00022340: 2222 0a20 2020 2020 2020 2020 2020 2064  "".            d
-00022350: 6174 615b 226d 656d 6f72 795f 6c69 6d69  ata["memory_limi
-00022360: 7422 5d5b 2d31 5d20 3d20 7773 2e6d 656d  t"][-1] = ws.mem
-00022370: 6f72 795f 6c69 6d69 740a 2020 2020 2020  ory_limit.      
-00022380: 2020 2020 2020 6461 7461 5b22 6d65 6d6f        data["memo
-00022390: 7279 5f6d 616e 6167 6564 225d 5b2d 315d  ry_managed"][-1]
-000223a0: 203d 206d 696e 666f 2e6d 616e 6167 6564   = minfo.managed
-000223b0: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
-000223c0: 615b 226d 656d 6f72 795f 756e 6d61 6e61  a["memory_unmana
-000223d0: 6765 645f 6f6c 6422 5d5b 2d31 5d20 3d20  ged_old"][-1] = 
-000223e0: 6d69 6e66 6f2e 756e 6d61 6e61 6765 645f  minfo.unmanaged_
-000223f0: 6f6c 640a 2020 2020 2020 2020 2020 2020  old.            
-00022400: 6461 7461 5b22 6d65 6d6f 7279 5f75 6e6d  data["memory_unm
-00022410: 616e 6167 6564 5f72 6563 656e 7422 5d5b  anaged_recent"][
-00022420: 2d31 5d20 3d20 6d69 6e66 6f2e 756e 6d61  -1] = minfo.unma
-00022430: 6e61 6765 645f 7265 6365 6e74 0a20 2020  naged_recent.   
-00022440: 2020 2020 2020 2020 2064 6174 615b 226d           data["m
-00022450: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
-00022460: 7265 6365 6e74 225d 5b2d 315d 203d 206d  recent"][-1] = m
-00022470: 696e 666f 2e75 6e6d 616e 6167 6564 5f72  info.unmanaged_r
-00022480: 6563 656e 740a 2020 2020 2020 2020 2020  ecent.          
-00022490: 2020 6461 7461 5b22 6d65 6d6f 7279 5f73    data["memory_s
-000224a0: 7069 6c6c 6564 225d 5b2d 315d 203d 206d  pilled"][-1] = m
-000224b0: 696e 666f 2e73 7069 6c6c 6564 0a20 2020  info.spilled.   
-000224c0: 2020 2020 2020 2020 2064 6174 615b 2263           data["c
-000224d0: 7075 225d 5b2d 315d 203d 2077 732e 6d65  pu"][-1] = ws.me
-000224e0: 7472 6963 735b 2263 7075 225d 202f 2031  trics["cpu"] / 1
-000224f0: 3030 2e30 0a20 2020 2020 2020 2020 2020  00.0.           
-00022500: 2064 6174 615b 2263 7075 5f66 7261 6374   data["cpu_fract
-00022510: 696f 6e22 5d5b 2d31 5d20 3d20 7773 2e6d  ion"][-1] = ws.m
-00022520: 6574 7269 6373 5b22 6370 7522 5d20 2f20  etrics["cpu"] / 
-00022530: 3130 302e 3020 2f20 7773 2e6e 7468 7265  100.0 / ws.nthre
-00022540: 6164 730a 2020 2020 2020 2020 2020 2020  ads.            
-00022550: 6461 7461 5b22 6e74 6872 6561 6473 225d  data["nthreads"]
-00022560: 5b2d 315d 203d 2077 732e 6e74 6872 6561  [-1] = ws.nthrea
-00022570: 6473 0a0a 2020 2020 2020 2020 666f 7220  ds..        for 
-00022580: 6e61 6d65 2069 6e20 7365 6c66 2e6e 616d  name in self.nam
-00022590: 6573 202b 2073 656c 662e 6578 7472 615f  es + self.extra_
-000225a0: 6e61 6d65 733a 0a20 2020 2020 2020 2020  names:.         
-000225b0: 2020 2069 6620 6e61 6d65 203d 3d20 226e     if name == "n
-000225c0: 616d 6522 3a0a 2020 2020 2020 2020 2020  ame":.          
-000225d0: 2020 2020 2020 6461 7461 5b6e 616d 655d        data[name]
-000225e0: 2e69 6e73 6572 7428 302c 2066 2254 6f74  .insert(0, f"Tot
-000225f0: 616c 2028 7b6c 656e 2864 6174 615b 6e61  al ({len(data[na
-00022600: 6d65 5d29 7d29 2229 0a20 2020 2020 2020  me])})").       
-00022610: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
-00022620: 650a 2020 2020 2020 2020 2020 2020 7472  e.            tr
-00022630: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00022640: 2020 2069 6620 6c65 6e28 7365 6c66 2e73     if len(self.s
-00022650: 6368 6564 756c 6572 2e77 6f72 6b65 7273  cheduler.workers
-00022660: 2920 3d3d 2030 3a0a 2020 2020 2020 2020  ) == 0:.        
-00022670: 2020 2020 2020 2020 2020 2020 746f 7461              tota
-00022680: 6c5f 6461 7461 203d 204e 6f6e 650a 2020  l_data = None.  
-00022690: 2020 2020 2020 2020 2020 2020 2020 656c                el
-000226a0: 6966 206e 616d 6520 3d3d 2022 6d65 6d6f  if name == "memo
-000226b0: 7279 5f70 6572 6365 6e74 223a 0a20 2020  ry_percent":.   
-000226c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000226d0: 2074 6f74 616c 5f6d 656d 203d 2073 756d   total_mem = sum
-000226e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000226f0: 2020 2020 2020 2020 2020 7773 2e6d 656d            ws.mem
-00022700: 6f72 795f 6c69 6d69 7420 666f 7220 7773  ory_limit for ws
-00022710: 2069 6e20 7365 6c66 2e73 6368 6564 756c   in self.schedul
-00022720: 6572 2e77 6f72 6b65 7273 2e76 616c 7565  er.workers.value
-00022730: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
-00022740: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00022750: 2020 2020 2020 2020 2020 2020 2020 746f                to
-00022760: 7461 6c5f 6461 7461 203d 2028 0a20 2020  tal_data = (.   
-00022770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022780: 2020 2020 2028 0a20 2020 2020 2020 2020       (.         
-00022790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000227a0: 2020 2073 756d 280a 2020 2020 2020 2020     sum(.        
-000227b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000227c0: 2020 2020 2020 2020 7773 2e6d 6574 7269          ws.metri
-000227d0: 6373 5b22 6d65 6d6f 7279 225d 0a20 2020  cs["memory"].   
-000227e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000227f0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00022800: 2077 7320 696e 2073 656c 662e 7363 6865   ws in self.sche
-00022810: 6475 6c65 722e 776f 726b 6572 732e 7661  duler.workers.va
-00022820: 6c75 6573 2829 0a20 2020 2020 2020 2020  lues().         
-00022830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022840: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00022850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022860: 202f 2074 6f74 616c 5f6d 656d 0a20 2020   / total_mem.   
-00022870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022880: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00022890: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000228a0: 6620 746f 7461 6c5f 6d65 6d0a 2020 2020  f total_mem.    
-000228b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000228c0: 2020 2020 656c 7365 2022 220a 2020 2020      else "".    
-000228d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000228e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000228f0: 2020 656c 6966 206e 616d 6520 3d3d 2022    elif name == "
-00022900: 6370 7522 3a0a 2020 2020 2020 2020 2020  cpu":.          
-00022910: 2020 2020 2020 2020 2020 746f 7461 6c5f            total_
-00022920: 6461 7461 203d 2028 0a20 2020 2020 2020  data = (.       
-00022930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022940: 2073 756d 2877 732e 6d65 7472 6963 735b   sum(ws.metrics[
-00022950: 2263 7075 225d 2066 6f72 2077 7320 696e  "cpu"] for ws in
-00022960: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
-00022970: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
-00022980: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00022990: 2020 2020 2020 2020 2020 2f20 3130 300a            / 100.
-000229a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000229b0: 2020 2020 2020 2020 2f20 6c65 6e28 7365          / len(se
-000229c0: 6c66 2e73 6368 6564 756c 6572 2e77 6f72  lf.scheduler.wor
-000229d0: 6b65 7273 2e76 616c 7565 7328 2929 0a20  kers.values()). 
-000229e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000229f0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00022a00: 2020 2020 2065 6c69 6620 6e61 6d65 203d       elif name =
-00022a10: 3d20 2263 7075 5f66 7261 6374 696f 6e22  = "cpu_fraction"
-00022a20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00022a30: 2020 2020 2020 746f 7461 6c5f 6461 7461        total_data
-00022a40: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-00022a50: 2020 2020 2020 2020 2020 2020 2073 756d               sum
-00022a60: 2877 732e 6d65 7472 6963 735b 2263 7075  (ws.metrics["cpu
-00022a70: 225d 2066 6f72 2077 7320 696e 2073 656c  "] for ws in sel
-00022a80: 662e 7363 6865 6475 6c65 722e 776f 726b  f.scheduler.work
-00022a90: 6572 732e 7661 6c75 6573 2829 290a 2020  ers.values()).  
-00022aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022ab0: 2020 2020 2020 2f20 3130 300a 2020 2020        / 100.    
-00022ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022ad0: 2020 2020 2f20 7375 6d28 7773 2e6e 7468      / sum(ws.nth
-00022ae0: 7265 6164 7320 666f 7220 7773 2069 6e20  reads for ws in 
-00022af0: 7365 6c66 2e73 6368 6564 756c 6572 2e77  self.scheduler.w
-00022b00: 6f72 6b65 7273 2e76 616c 7565 7328 2929  orkers.values())
-00022b10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022b20: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00022b30: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00022b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022b50: 2074 6f74 616c 5f64 6174 6120 3d20 7375   total_data = su
-00022b60: 6d28 6461 7461 5b6e 616d 655d 290a 0a20  m(data[name]).. 
-00022b70: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00022b80: 6174 615b 6e61 6d65 5d2e 696e 7365 7274  ata[name].insert
-00022b90: 2830 2c20 746f 7461 6c5f 6461 7461 290a  (0, total_data).
-00022ba0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-00022bb0: 7074 2054 7970 6545 7272 6f72 3a0a 2020  pt TypeError:.  
-00022bc0: 2020 2020 2020 2020 2020 2020 2020 6461                da
-00022bd0: 7461 5b6e 616d 655d 2e69 6e73 6572 7428  ta[name].insert(
-00022be0: 302c 204e 6f6e 6529 0a0a 2020 2020 2020  0, None)..      
-00022bf0: 2020 7365 6c66 2e73 6f75 7263 652e 6461    self.source.da
-00022c00: 7461 2e75 7064 6174 6528 6461 7461 290a  ta.update(data).
-00022c10: 0a0a 636c 6173 7320 5368 7566 666c 696e  ..class Shufflin
-00022c20: 6728 4461 7368 626f 6172 6443 6f6d 706f  g(DashboardCompo
-00022c30: 6e65 6e74 293a 0a20 2020 2022 2222 4f63  nent):.    """Oc
-00022c40: 6375 7061 6e63 7920 2869 6e20 7469 6d65  cupancy (in time
-00022c50: 2920 7065 7220 776f 726b 6572 2222 220a  ) per worker""".
-00022c60: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-00022c70: 5f28 7365 6c66 2c20 7363 6865 6475 6c65  _(self, schedule
-00022c80: 722c 202a 2a6b 7761 7267 7329 3a0a 2020  r, **kwargs):.  
-00022c90: 2020 2020 2020 7769 7468 206c 6f67 5f65        with log_e
-00022ca0: 7272 6f72 7328 293a 0a20 2020 2020 2020  rrors():.       
-00022cb0: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
-00022cc0: 6c65 7220 3d20 7363 6865 6475 6c65 720a  ler = scheduler.
-00022cd0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00022ce0: 2e73 6f75 7263 6520 3d20 436f 6c75 6d6e  .source = Column
-00022cf0: 4461 7461 536f 7572 6365 280a 2020 2020  DataSource(.    
-00022d00: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00022d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022d20: 2020 2277 6f72 6b65 7222 3a20 5b5d 2c0a    "worker": [],.
-00022d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022d40: 2020 2020 2279 223a 205b 5d2c 0a20 2020      "y": [],.   
-00022d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022d60: 2022 636f 6d6d 5f6d 656d 6f72 7922 3a20   "comm_memory": 
-00022d70: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-00022d80: 2020 2020 2020 2020 2263 6f6d 6d5f 6d65          "comm_me
-00022d90: 6d6f 7279 5f6c 696d 6974 223a 205b 5d2c  mory_limit": [],
-00022da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022db0: 2020 2020 2022 636f 6d6d 5f62 7563 6b65       "comm_bucke
-00022dc0: 7473 223a 205b 5d2c 0a20 2020 2020 2020  ts": [],.       
-00022dd0: 2020 2020 2020 2020 2020 2020 2022 636f               "co
-00022de0: 6d6d 5f61 7667 5f64 7572 6174 696f 6e22  mm_avg_duration"
-00022df0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-00022e00: 2020 2020 2020 2020 2020 2263 6f6d 6d5f            "comm_
-00022e10: 6176 675f 7369 7a65 223a 205b 5d2c 0a20  avg_size": [],. 
-00022e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022e30: 2020 2022 636f 6d6d 5f72 6561 6422 3a20     "comm_read": 
-00022e40: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-00022e50: 2020 2020 2020 2020 2263 6f6d 6d5f 7772          "comm_wr
-00022e60: 6974 7465 6e22 3a20 5b5d 2c0a 2020 2020  itten": [],.    
-00022e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022e80: 2263 6f6d 6d5f 636f 6c6f 7222 3a20 5b5d  "comm_color": []
-00022e90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00022ea0: 2020 2020 2020 2264 6973 6b5f 6d65 6d6f        "disk_memo
-00022eb0: 7279 223a 205b 5d2c 0a20 2020 2020 2020  ry": [],.       
-00022ec0: 2020 2020 2020 2020 2020 2020 2022 6469               "di
-00022ed0: 736b 5f6d 656d 6f72 795f 6c69 6d69 7422  sk_memory_limit"
-00022ee0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-00022ef0: 2020 2020 2020 2020 2020 2264 6973 6b5f            "disk_
-00022f00: 6275 636b 6574 7322 3a20 5b5d 2c0a 2020  buckets": [],.  
-00022f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022f20: 2020 2264 6973 6b5f 6176 675f 6475 7261    "disk_avg_dura
-00022f30: 7469 6f6e 223a 205b 5d2c 0a20 2020 2020  tion": [],.     
-00022f40: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00022f50: 6469 736b 5f61 7667 5f73 697a 6522 3a20  disk_avg_size": 
-00022f60: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-00022f70: 2020 2020 2020 2020 2264 6973 6b5f 7265          "disk_re
-00022f80: 6164 223a 205b 5d2c 0a20 2020 2020 2020  ad": [],.       
-00022f90: 2020 2020 2020 2020 2020 2020 2022 6469               "di
-00022fa0: 736b 5f77 7269 7474 656e 223a 205b 5d2c  sk_written": [],
-00022fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022fc0: 2020 2020 2022 6469 736b 5f63 6f6c 6f72       "disk_color
-00022fd0: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-00022fe0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00022ff0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00023000: 2020 2073 656c 662e 746f 7461 6c73 5f73     self.totals_s
-00023010: 6f75 7263 6520 3d20 436f 6c75 6d6e 4461  ource = ColumnDa
-00023020: 7461 536f 7572 6365 280a 2020 2020 2020  taSource(.      
-00023030: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00023040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023050: 2278 223a 205b 224e 6574 776f 726b 2053  "x": ["Network S
-00023060: 656e 6422 2c20 224e 6574 776f 726b 2052  end", "Network R
-00023070: 6563 6569 7665 222c 2022 4469 736b 2057  eceive", "Disk W
-00023080: 7269 7465 222c 2022 4469 736b 2052 6561  rite", "Disk Rea
-00023090: 6422 5d2c 0a20 2020 2020 2020 2020 2020  d"],.           
-000230a0: 2020 2020 2020 2020 2022 7661 6c75 6573           "values
-000230b0: 223a 205b 302c 2030 2c20 302c 2030 5d2c  ": [0, 0, 0, 0],
-000230c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000230d0: 207d 0a20 2020 2020 2020 2020 2020 2029   }.            )
-000230e0: 0a0a 2020 2020 2020 2020 2020 2020 7365  ..            se
-000230f0: 6c66 2e63 6f6d 6d5f 6d65 6d6f 7279 203d  lf.comm_memory =
-00023100: 2066 6967 7572 6528 0a20 2020 2020 2020   figure(.       
-00023110: 2020 2020 2020 2020 2074 6974 6c65 3d22           title="
-00023120: 436f 6d6d 7320 4275 6666 6572 222c 0a20  Comms Buffer",. 
-00023130: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00023140: 6f6f 6c73 3d22 222c 0a20 2020 2020 2020  ools="",.       
-00023150: 2020 2020 2020 2020 2074 6f6f 6c62 6172           toolbar
-00023160: 5f6c 6f63 6174 696f 6e3d 2261 626f 7665  _location="above
-00023170: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00023180: 2020 2078 5f72 616e 6765 3d52 616e 6765     x_range=Range
-00023190: 3164 2830 2c20 3130 305f 3030 305f 3030  1d(0, 100_000_00
-000231a0: 3029 2c0a 2020 2020 2020 2020 2020 2020  0),.            
-000231b0: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
-000231c0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000231d0: 2020 2020 2020 2020 7365 6c66 2e63 6f6d          self.com
-000231e0: 6d5f 6d65 6d6f 7279 2e68 6261 7228 0a20  m_memory.hbar(. 
-000231f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00023200: 6f75 7263 653d 7365 6c66 2e73 6f75 7263  ource=self.sourc
-00023210: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00023220: 2020 2072 6967 6874 3d22 636f 6d6d 5f6d     right="comm_m
-00023230: 656d 6f72 7922 2c0a 2020 2020 2020 2020  emory",.        
-00023240: 2020 2020 2020 2020 793d 2279 222c 0a20          y="y",. 
-00023250: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-00023260: 6569 6768 743d 302e 392c 0a20 2020 2020  eight=0.9,.     
-00023270: 2020 2020 2020 2020 2020 2063 6f6c 6f72             color
-00023280: 3d22 636f 6d6d 5f63 6f6c 6f72 222c 0a20  ="comm_color",. 
-00023290: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000232a0: 2020 2020 2020 2020 2068 6f76 6572 203d           hover =
-000232b0: 2048 6f76 6572 546f 6f6c 280a 2020 2020   HoverTool(.    
-000232c0: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
-000232d0: 7469 7073 3d5b 0a20 2020 2020 2020 2020  tips=[.         
-000232e0: 2020 2020 2020 2020 2020 2028 224d 656d             ("Mem
-000232f0: 6f72 7920 5573 6564 222c 2022 4063 6f6d  ory Used", "@com
-00023300: 6d5f 6d65 6d6f 7279 7b30 2e30 3020 627d  m_memory{0.00 b}
-00023310: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-00023320: 2020 2020 2020 2020 2822 4176 6572 6167          ("Averag
-00023330: 6520 5772 6974 6522 2c20 2240 636f 6d6d  e Write", "@comm
-00023340: 5f61 7667 5f73 697a 657b 302e 3030 2062  _avg_size{0.00 b
-00023350: 7d22 292c 0a20 2020 2020 2020 2020 2020  }"),.           
-00023360: 2020 2020 2020 2020 2028 2223 2042 7563           ("# Buc
-00023370: 6b65 7473 222c 2022 4063 6f6d 6d5f 6275  kets", "@comm_bu
-00023380: 636b 6574 7322 292c 0a20 2020 2020 2020  ckets"),.       
-00023390: 2020 2020 2020 2020 2020 2020 2028 2241               ("A
-000233a0: 7665 7261 6765 2044 7572 6174 696f 6e22  verage Duration"
-000233b0: 2c20 2240 636f 6d6d 5f61 7667 5f64 7572  , "@comm_avg_dur
-000233c0: 6174 696f 6e22 292c 0a20 2020 2020 2020  ation"),.       
-000233d0: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
-000233e0: 2020 2020 2020 2020 2020 2020 666f 726d              form
-000233f0: 6174 7465 7273 3d7b 2240 636f 6d6d 5f61  atters={"@comm_a
-00023400: 7667 5f64 7572 6174 696f 6e22 3a20 2264  vg_duration": "d
-00023410: 6174 6574 696d 6522 7d2c 0a20 2020 2020  atetime"},.     
-00023420: 2020 2020 2020 2020 2020 206d 6f64 653d             mode=
-00023430: 2268 6c69 6e65 222c 0a20 2020 2020 2020  "hline",.       
-00023440: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00023450: 2020 2073 656c 662e 636f 6d6d 5f6d 656d     self.comm_mem
-00023460: 6f72 792e 6164 645f 746f 6f6c 7328 686f  ory.add_tools(ho
-00023470: 7665 7229 0a20 2020 2020 2020 2020 2020  ver).           
-00023480: 2073 656c 662e 636f 6d6d 5f6d 656d 6f72   self.comm_memor
-00023490: 792e 785f 7261 6e67 652e 7374 6172 7420  y.x_range.start 
-000234a0: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
-000234b0: 7365 6c66 2e63 6f6d 6d5f 6d65 6d6f 7279  self.comm_memory
-000234c0: 2e78 5f72 616e 6765 2e65 6e64 203d 2031  .x_range.end = 1
-000234d0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000234e0: 662e 636f 6d6d 5f6d 656d 6f72 792e 7861  f.comm_memory.xa
-000234f0: 7869 735b 305d 2e66 6f72 6d61 7474 6572  xis[0].formatter
-00023500: 203d 204e 756d 6572 616c 5469 636b 466f   = NumeralTickFo
-00023510: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
-00023520: 302e 3020 6222 290a 0a20 2020 2020 2020  0.0 b")..       
-00023530: 2020 2020 2073 656c 662e 6469 736b 5f6d       self.disk_m
-00023540: 656d 6f72 7920 3d20 6669 6775 7265 280a  emory = figure(.
-00023550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023560: 7469 746c 653d 2244 6973 6b20 4275 6666  title="Disk Buff
-00023570: 6572 222c 0a20 2020 2020 2020 2020 2020  er",.           
-00023580: 2020 2020 2074 6f6f 6c73 3d22 222c 0a20       tools="",. 
-00023590: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000235a0: 6f6f 6c62 6172 5f6c 6f63 6174 696f 6e3d  oolbar_location=
-000235b0: 2261 626f 7665 222c 0a20 2020 2020 2020  "above",.       
-000235c0: 2020 2020 2020 2020 2078 5f72 616e 6765           x_range
-000235d0: 3d52 616e 6765 3164 2830 2c20 3130 305f  =Range1d(0, 100_
-000235e0: 3030 305f 3030 3029 2c0a 2020 2020 2020  000_000),.      
-000235f0: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
-00023600: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
-00023610: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-00023620: 6c66 2e64 6973 6b5f 6d65 6d6f 7279 2e79  lf.disk_memory.y
-00023630: 6178 6973 2e76 6973 6962 6c65 203d 2046  axis.visible = F
-00023640: 616c 7365 0a0a 2020 2020 2020 2020 2020  alse..          
-00023650: 2020 7365 6c66 2e64 6973 6b5f 6d65 6d6f    self.disk_memo
-00023660: 7279 2e68 6261 7228 0a20 2020 2020 2020  ry.hbar(.       
-00023670: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
-00023680: 7365 6c66 2e73 6f75 7263 652c 0a20 2020  self.source,.   
-00023690: 2020 2020 2020 2020 2020 2020 2072 6967               rig
-000236a0: 6874 3d22 6469 736b 5f6d 656d 6f72 7922  ht="disk_memory"
-000236b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000236c0: 2020 793d 2279 222c 0a20 2020 2020 2020    y="y",.       
-000236d0: 2020 2020 2020 2020 2068 6569 6768 743d           height=
-000236e0: 302e 392c 0a20 2020 2020 2020 2020 2020  0.9,.           
-000236f0: 2020 2020 2063 6f6c 6f72 3d22 6469 736b       color="disk
-00023700: 5f63 6f6c 6f72 222c 0a20 2020 2020 2020  _color",.       
-00023710: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00023720: 2020 2020 686f 7665 7220 3d20 486f 7665      hover = Hove
-00023730: 7254 6f6f 6c28 0a20 2020 2020 2020 2020  rTool(.         
-00023740: 2020 2020 2020 2074 6f6f 6c74 6970 733d         tooltips=
-00023750: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-00023760: 2020 2020 2020 2822 4d65 6d6f 7279 2055        ("Memory U
-00023770: 7365 6422 2c20 2240 6469 736b 5f6d 656d  sed", "@disk_mem
-00023780: 6f72 797b 302e 3030 2062 7d22 292c 0a20  ory{0.00 b}"),. 
-00023790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000237a0: 2020 2028 2241 7665 7261 6765 2057 7269     ("Average Wri
-000237b0: 7465 222c 2022 4064 6973 6b5f 6176 675f  te", "@disk_avg_
-000237c0: 7369 7a65 7b30 2e30 3020 627d 2229 2c0a  size{0.00 b}"),.
-000237d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000237e0: 2020 2020 2822 2320 4275 636b 6574 7322      ("# Buckets"
-000237f0: 2c20 2240 6469 736b 5f62 7563 6b65 7473  , "@disk_buckets
-00023800: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-00023810: 2020 2020 2020 2020 2822 4176 6572 6167          ("Averag
-00023820: 6520 4475 7261 7469 6f6e 222c 2022 4064  e Duration", "@d
-00023830: 6973 6b5f 6176 675f 6475 7261 7469 6f6e  isk_avg_duration
-00023840: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-00023850: 2020 2020 5d2c 0a20 2020 2020 2020 2020      ],.         
-00023860: 2020 2020 2020 2066 6f72 6d61 7474 6572         formatter
-00023870: 733d 7b22 4064 6973 6b5f 6176 675f 6475  s={"@disk_avg_du
-00023880: 7261 7469 6f6e 223a 2022 6461 7465 7469  ration": "dateti
-00023890: 6d65 227d 2c0a 2020 2020 2020 2020 2020  me"},.          
-000238a0: 2020 2020 2020 6d6f 6465 3d22 686c 696e        mode="hlin
-000238b0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-000238c0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-000238d0: 6c66 2e64 6973 6b5f 6d65 6d6f 7279 2e61  lf.disk_memory.a
-000238e0: 6464 5f74 6f6f 6c73 2868 6f76 6572 290a  dd_tools(hover).
-000238f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00023900: 2e64 6973 6b5f 6d65 6d6f 7279 2e78 6178  .disk_memory.xax
-00023910: 6973 5b30 5d2e 666f 726d 6174 7465 7220  is[0].formatter 
-00023920: 3d20 4e75 6d65 7261 6c54 6963 6b46 6f72  = NumeralTickFor
-00023930: 6d61 7474 6572 2866 6f72 6d61 743d 2230  matter(format="0
-00023940: 2e30 2062 2229 0a0a 2020 2020 2020 2020  .0 b")..        
-00023950: 2020 2020 7365 6c66 2e74 6f74 616c 7320      self.totals 
-00023960: 3d20 6669 6775 7265 280a 2020 2020 2020  = figure(.      
-00023970: 2020 2020 2020 2020 2020 7469 746c 653d            title=
-00023980: 2254 6f74 616c 206d 6f76 656d 656e 7422  "Total movement"
-00023990: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000239a0: 2020 746f 6f6c 733d 2222 2c0a 2020 2020    tools="",.    
-000239b0: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
-000239c0: 6261 725f 6c6f 6361 7469 6f6e 3d22 6162  bar_location="ab
-000239d0: 6f76 6522 2c0a 2020 2020 2020 2020 2020  ove",.          
-000239e0: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
-000239f0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00023a00: 2020 2020 2020 2020 2020 7469 746c 6573            titles
-00023a10: 203d 205b 224e 6574 776f 726b 2053 656e   = ["Network Sen
-00023a20: 6422 2c20 224e 6574 776f 726b 2052 6563  d", "Network Rec
-00023a30: 6569 7665 222c 2022 4469 736b 2057 7269  eive", "Disk Wri
-00023a40: 7465 222c 2022 4469 736b 2052 6561 6422  te", "Disk Read"
-00023a50: 5d0a 2020 2020 2020 2020 2020 2020 7365  ].            se
-00023a60: 6c66 2e74 6f74 616c 7320 3d20 6669 6775  lf.totals = figu
-00023a70: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
-00023a80: 2020 2020 785f 7261 6e67 653d 7469 746c      x_range=titl
-00023a90: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-00023aa0: 2020 2020 7469 746c 653d 2254 6f74 616c      title="Total
-00023ab0: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-00023ac0: 2020 2020 746f 6f6c 6261 725f 6c6f 6361      toolbar_loca
-00023ad0: 7469 6f6e 3d4e 6f6e 652c 0a20 2020 2020  tion=None,.     
-00023ae0: 2020 2020 2020 2020 2020 2074 6f6f 6c73             tools
-00023af0: 3d22 222c 0a20 2020 2020 2020 2020 2020  ="",.           
-00023b00: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
-00023b10: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00023b20: 2020 2020 2020 2020 2020 7365 6c66 2e74            self.t
-00023b30: 6f74 616c 732e 7662 6172 280a 2020 2020  otals.vbar(.    
-00023b40: 2020 2020 2020 2020 2020 2020 783d 2278              x="x
-00023b50: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00023b60: 2020 2074 6f70 3d22 7661 6c75 6573 222c     top="values",
-00023b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023b80: 2077 6964 7468 3d30 2e39 2c0a 2020 2020   width=0.9,.    
-00023b90: 2020 2020 2020 2020 2020 2020 736f 7572              sour
-00023ba0: 6365 3d73 656c 662e 746f 7461 6c73 5f73  ce=self.totals_s
-00023bb0: 6f75 7263 652c 0a20 2020 2020 2020 2020  ource,.         
-00023bc0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-00023bd0: 2020 7365 6c66 2e74 6f74 616c 732e 7867    self.totals.xg
-00023be0: 7269 642e 6772 6964 5f6c 696e 655f 636f  rid.grid_line_co
-00023bf0: 6c6f 7220 3d20 4e6f 6e65 0a20 2020 2020  lor = None.     
-00023c00: 2020 2020 2020 2073 656c 662e 746f 7461         self.tota
-00023c10: 6c73 2e79 5f72 616e 6765 2e73 7461 7274  ls.y_range.start
-00023c20: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
-00023c30: 2073 656c 662e 746f 7461 6c73 2e79 6178   self.totals.yax
-00023c40: 6973 5b30 5d2e 666f 726d 6174 7465 7220  is[0].formatter 
-00023c50: 3d20 4e75 6d65 7261 6c54 6963 6b46 6f72  = NumeralTickFor
-00023c60: 6d61 7474 6572 2866 6f72 6d61 743d 2230  matter(format="0
-00023c70: 2e30 2062 2229 0a0a 2020 2020 2020 2020  .0 b")..        
-00023c80: 2020 2020 686f 7665 7220 3d20 486f 7665      hover = Hove
-00023c90: 7254 6f6f 6c28 0a20 2020 2020 2020 2020  rTool(.         
-00023ca0: 2020 2020 2020 2074 6f6f 6c74 6970 733d         tooltips=
-00023cb0: 5b28 2254 6f74 616c 222c 2022 4076 616c  [("Total", "@val
-00023cc0: 7565 737b 302e 3030 627d 2229 5d2c 0a20  ues{0.00b}")],. 
-00023cd0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00023ce0: 6f64 653d 2276 6c69 6e65 222c 0a20 2020  ode="vline",.   
-00023cf0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00023d00: 2020 2020 2020 2073 656c 662e 746f 7461         self.tota
-00023d10: 6c73 2e61 6464 5f74 6f6f 6c73 2868 6f76  ls.add_tools(hov
-00023d20: 6572 290a 0a20 2020 2020 2020 2020 2020  er)..           
-00023d30: 2073 656c 662e 726f 6f74 203d 2072 6f77   self.root = row
-00023d40: 2873 656c 662e 636f 6d6d 5f6d 656d 6f72  (self.comm_memor
-00023d50: 792c 2073 656c 662e 6469 736b 5f6d 656d  y, self.disk_mem
-00023d60: 6f72 7929 0a0a 2020 2020 4077 6974 686f  ory)..    @witho
-00023d70: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
-00023d80: 6461 7469 6f6e 0a20 2020 2064 6566 2075  dation.    def u
-00023d90: 7064 6174 6528 7365 6c66 293a 0a20 2020  pdate(self):.   
-00023da0: 2020 2020 2077 6974 6820 6c6f 675f 6572       with log_er
-00023db0: 726f 7273 2829 3a0a 2020 2020 2020 2020  rors():.        
-00023dc0: 2020 2020 696e 7075 7420 3d20 7365 6c66      input = self
-00023dd0: 2e73 6368 6564 756c 6572 2e65 7874 656e  .scheduler.exten
-00023de0: 7369 6f6e 735b 2273 6875 6666 6c65 225d  sions["shuffle"]
-00023df0: 2e68 6561 7274 6265 6174 730a 2020 2020  .heartbeats.    
-00023e00: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
-00023e10: 6e70 7574 3a0a 2020 2020 2020 2020 2020  nput:.          
-00023e20: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
-00023e30: 2020 2020 2020 2020 2020 696e 7075 7420            input 
-00023e40: 3d20 6c69 7374 2869 6e70 7574 2e76 616c  = list(input.val
-00023e50: 7565 7328 2929 5b2d 315d 2020 2320 544f  ues())[-1]  # TO
-00023e60: 444f 3a20 6d75 6c74 6970 6c65 2063 6f6e  DO: multiple con
-00023e70: 6375 7272 656e 7420 7368 7566 666c 6573  current shuffles
-00023e80: 0a0a 2020 2020 2020 2020 2020 2020 6461  ..            da
-00023e90: 7461 203d 2064 6566 6175 6c74 6469 6374  ta = defaultdict
-00023ea0: 286c 6973 7429 0a20 2020 2020 2020 2020  (list).         
-00023eb0: 2020 206e 6f77 203d 2074 696d 6528 290a     now = time().
-00023ec0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00023ed0: 2069 2c20 2877 6f72 6b65 722c 2064 2920   i, (worker, d) 
-00023ee0: 696e 2065 6e75 6d65 7261 7465 2869 6e70  in enumerate(inp
-00023ef0: 7574 2e69 7465 6d73 2829 293a 0a20 2020  ut.items()):.   
-00023f00: 2020 2020 2020 2020 2020 2020 2064 6174               dat
-00023f10: 615b 2279 225d 2e61 7070 656e 6428 6929  a["y"].append(i)
-00023f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023f30: 2064 6174 615b 2277 6f72 6b65 7222 5d2e   data["worker"].
-00023f40: 6170 7065 6e64 2877 6f72 6b65 7229 0a20  append(worker). 
-00023f50: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00023f60: 6f72 2070 7265 6669 7820 696e 205b 2263  or prefix in ["c
-00023f70: 6f6d 6d22 2c20 2264 6973 6b22 5d3a 0a20  omm", "disk"]:. 
-00023f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023f90: 2020 2064 6174 615b 6622 7b70 7265 6669     data[f"{prefi
-00023fa0: 787d 5f74 6f74 616c 225d 2e61 7070 656e  x}_total"].appen
-00023fb0: 6428 645b 7072 6566 6978 5d5b 2274 6f74  d(d[prefix]["tot
-00023fc0: 616c 225d 290a 2020 2020 2020 2020 2020  al"]).          
-00023fd0: 2020 2020 2020 2020 2020 6461 7461 5b66            data[f
-00023fe0: 227b 7072 6566 6978 7d5f 6d65 6d6f 7279  "{prefix}_memory
-00023ff0: 225d 2e61 7070 656e 6428 645b 7072 6566  "].append(d[pref
-00024000: 6978 5d5b 226d 656d 6f72 7922 5d29 0a20  ix]["memory"]). 
-00024010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024020: 2020 2064 6174 615b 6622 7b70 7265 6669     data[f"{prefi
-00024030: 787d 5f6d 656d 6f72 795f 6c69 6d69 7422  x}_memory_limit"
-00024040: 5d2e 6170 7065 6e64 2864 5b70 7265 6669  ].append(d[prefi
-00024050: 785d 5b22 6d65 6d6f 7279 5f6c 696d 6974  x]["memory_limit
-00024060: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
-00024070: 2020 2020 2020 2020 6461 7461 5b66 227b          data[f"{
-00024080: 7072 6566 6978 7d5f 6275 636b 6574 7322  prefix}_buckets"
-00024090: 5d2e 6170 7065 6e64 2864 5b70 7265 6669  ].append(d[prefi
-000240a0: 785d 5b22 6275 636b 6574 7322 5d29 0a20  x]["buckets"]). 
-000240b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000240c0: 2020 2064 6174 615b 6622 7b70 7265 6669     data[f"{prefi
-000240d0: 787d 5f61 7667 5f64 7572 6174 696f 6e22  x}_avg_duration"
-000240e0: 5d2e 6170 7065 6e64 280a 2020 2020 2020  ].append(.      
-000240f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024100: 2020 645b 7072 6566 6978 5d5b 2264 6961    d[prefix]["dia
-00024110: 676e 6f73 7469 6373 225d 2e67 6574 2822  gnostics"].get("
-00024120: 6176 675f 6475 7261 7469 6f6e 222c 2030  avg_duration", 0
-00024130: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00024140: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00024150: 2020 2020 2020 2020 2020 2020 6461 7461              data
-00024160: 5b66 227b 7072 6566 6978 7d5f 6176 675f  [f"{prefix}_avg_
-00024170: 7369 7a65 225d 2e61 7070 656e 6428 0a20  size"].append(. 
-00024180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024190: 2020 2020 2020 2064 5b70 7265 6669 785d         d[prefix]
-000241a0: 5b22 6469 6167 6e6f 7374 6963 7322 5d2e  ["diagnostics"].
-000241b0: 6765 7428 2261 7667 5f73 697a 6522 2c20  get("avg_size", 
-000241c0: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
-000241d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000241e0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
-000241f0: 615b 6622 7b70 7265 6669 787d 5f72 6561  a[f"{prefix}_rea
-00024200: 6422 5d2e 6170 7065 6e64 2864 5b70 7265  d"].append(d[pre
-00024210: 6669 785d 5b22 7265 6164 225d 290a 2020  fix]["read"]).  
-00024220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024230: 2020 6461 7461 5b66 227b 7072 6566 6978    data[f"{prefix
-00024240: 7d5f 7772 6974 7465 6e22 5d2e 6170 7065  }_written"].appe
-00024250: 6e64 2864 5b70 7265 6669 785d 5b22 7772  nd(d[prefix]["wr
-00024260: 6974 7465 6e22 5d29 0a20 2020 2020 2020  itten"]).       
-00024270: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00024280: 7365 6c66 2e73 6368 6564 756c 6572 2e77  self.scheduler.w
-00024290: 6f72 6b65 7273 5b77 6f72 6b65 725d 2e6c  orkers[worker].l
-000242a0: 6173 745f 7365 656e 203c 206e 6f77 202d  ast_seen < now -
-000242b0: 2035 3a0a 2020 2020 2020 2020 2020 2020   5:.            
-000242c0: 2020 2020 2020 2020 2020 2020 6461 7461              data
-000242d0: 5b66 227b 7072 6566 6978 7d5f 636f 6c6f  [f"{prefix}_colo
-000242e0: 7222 5d2e 6170 7065 6e64 2822 6772 6179  r"].append("gray
-000242f0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-00024300: 2020 2020 2020 2065 6c69 6620 645b 7072         elif d[pr
-00024310: 6566 6978 5d5b 226d 656d 6f72 7922 5d20  efix]["memory"] 
-00024320: 3e20 645b 7072 6566 6978 5d5b 226d 656d  > d[prefix]["mem
-00024330: 6f72 795f 6c69 6d69 7422 5d3a 0a20 2020  ory_limit"]:.   
-00024340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024350: 2020 2020 2064 6174 615b 6622 7b70 7265       data[f"{pre
-00024360: 6669 787d 5f63 6f6c 6f72 225d 2e61 7070  fix}_color"].app
-00024370: 656e 6428 2272 6564 2229 0a20 2020 2020  end("red").     
-00024380: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00024390: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000243a0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
-000243b0: 615b 6622 7b70 7265 6669 787d 5f63 6f6c  a[f"{prefix}_col
-000243c0: 6f72 225d 2e61 7070 656e 6428 2262 6c75  or"].append("blu
-000243d0: 6522 290a 0a20 2020 2020 2020 2020 2020  e")..           
-000243e0: 2022 2222 0a20 2020 2020 2020 2020 2020   """.           
-000243f0: 2073 696e 676c 6574 6f6e 7320 3d20 7b0a   singletons = {.
-00024400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024410: 6622 7b70 7265 6669 787d 5f61 7667 5f64  f"{prefix}_avg_d
-00024420: 7572 6174 696f 6e22 3a20 5b0a 2020 2020  uration": [.    
-00024430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024440: 7375 6d28 6461 7461 5b66 227b 7072 6566  sum(data[f"{pref
-00024450: 6978 7d5f 6176 675f 6475 7261 7469 6f6e  ix}_avg_duration
-00024460: 225d 2920 2f20 6c65 6e28 6461 7461 5b66  "]) / len(data[f
-00024470: 227b 7072 6566 6978 7d5f 6176 675f 6475  "{prefix}_avg_du
-00024480: 7261 7469 6f6e 225d 290a 2020 2020 2020  ration"]).      
-00024490: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
-000244a0: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
-000244b0: 7072 6566 6978 7d5f 6176 675f 7369 7a65  prefix}_avg_size
-000244c0: 223a 205b 0a20 2020 2020 2020 2020 2020  ": [.           
-000244d0: 2020 2020 2020 2020 2073 756d 2864 6174           sum(dat
-000244e0: 615b 6622 7b70 7265 6669 787d 5f61 7667  a[f"{prefix}_avg
-000244f0: 5f73 697a 6522 5d29 202f 206c 656e 2864  _size"]) / len(d
-00024500: 6174 615b 6622 7b70 7265 6669 787d 5f61  ata[f"{prefix}_a
-00024510: 7667 5f73 697a 6522 5d29 0a20 2020 2020  vg_size"]).     
-00024520: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
-00024530: 2020 2020 2020 2020 2020 2020 2020 2264                "d
-00024540: 6973 6b5f 6176 675f 6475 7261 7469 6f6e  isk_avg_duration
-00024550: 223a 205b 0a20 2020 2020 2020 2020 2020  ": [.           
-00024560: 2020 2020 2020 2020 2073 756d 2864 6174           sum(dat
-00024570: 615b 2264 6973 6b5f 6176 675f 6475 7261  a["disk_avg_dura
-00024580: 7469 6f6e 225d 2920 2f20 6c65 6e28 6461  tion"]) / len(da
-00024590: 7461 5b22 6469 736b 5f61 7667 5f64 7572  ta["disk_avg_dur
-000245a0: 6174 696f 6e22 5d29 0a20 2020 2020 2020  ation"]).       
-000245b0: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
-000245c0: 2020 2020 2020 2020 2020 2020 2264 6973              "dis
-000245d0: 6b5f 6176 675f 7369 7a65 223a 205b 0a20  k_avg_size": [. 
-000245e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000245f0: 2020 2073 756d 2864 6174 615b 2264 6973     sum(data["dis
-00024600: 6b5f 6176 675f 7369 7a65 225d 2920 2f20  k_avg_size"]) / 
-00024610: 6c65 6e28 6461 7461 5b22 6469 736b 5f61  len(data["disk_a
-00024620: 7667 5f73 697a 6522 5d29 0a20 2020 2020  vg_size"]).     
-00024630: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
-00024640: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00024650: 2020 2020 2020 2020 7369 6e67 6c65 746f          singleto
-00024660: 6e73 5b66 227b 7072 6566 6978 7d5f 6176  ns[f"{prefix}_av
-00024670: 675f 6261 6e64 7769 6474 6822 5d20 3d20  g_bandwidth"] = 
-00024680: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-00024690: 2020 7369 6e67 6c65 746f 6e73 5b66 227b    singletons[f"{
-000246a0: 7072 6566 6978 7d5f 6176 675f 7369 7a65  prefix}_avg_size
-000246b0: 225d 5b30 5d20 2f20 7369 6e67 6c65 746f  "][0] / singleto
-000246c0: 6e73 5b66 227b 7072 6566 6978 7d5f 6176  ns[f"{prefix}_av
-000246d0: 675f 6475 7261 7469 6f6e 225d 5b30 5d0a  g_duration"][0].
-000246e0: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-000246f0: 2020 2020 2020 2020 2020 7369 6e67 6c65            single
-00024700: 746f 6e73 5b22 6469 736b 5f61 7667 5f62  tons["disk_avg_b
-00024710: 616e 6477 6964 7468 225d 203d 205b 0a20  andwidth"] = [. 
-00024720: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00024730: 696e 676c 6574 6f6e 735b 2264 6973 6b5f  ingletons["disk_
-00024740: 6176 675f 7369 7a65 225d 5b30 5d20 2f20  avg_size"][0] / 
-00024750: 7369 6e67 6c65 746f 6e73 5b22 6469 736b  singletons["disk
-00024760: 5f61 7667 5f64 7572 6174 696f 6e22 5d5b  _avg_duration"][
-00024770: 305d 0a20 2020 2020 2020 2020 2020 205d  0].            ]
-00024780: 0a20 2020 2020 2020 2020 2020 2073 696e  .            sin
-00024790: 676c 6574 6f6e 735b 2279 225d 203d 205b  gletons["y"] = [
-000247a0: 6461 7461 5b22 7922 5d5b 2d31 5d20 2f20  data["y"][-1] / 
-000247b0: 325d 0a20 2020 2020 2020 2020 2020 2022  2].            "
-000247c0: 2222 0a0a 2020 2020 2020 2020 2020 2020  ""..            
-000247d0: 746f 7461 6c73 203d 207b 0a20 2020 2020  totals = {.     
-000247e0: 2020 2020 2020 2020 2020 2022 7822 3a20             "x": 
-000247f0: 5b22 4e65 7477 6f72 6b20 5365 6e64 222c  ["Network Send",
-00024800: 2022 4e65 7477 6f72 6b20 5265 6365 6976   "Network Receiv
-00024810: 6522 2c20 2244 6973 6b20 5772 6974 6522  e", "Disk Write"
-00024820: 2c20 2244 6973 6b20 5265 6164 225d 2c0a  , "Disk Read"],.
-00024830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024840: 2276 616c 7565 7322 3a20 5b0a 2020 2020  "values": [.    
-00024850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024860: 7375 6d28 6461 7461 5b22 636f 6d6d 5f77  sum(data["comm_w
-00024870: 7269 7474 656e 225d 292c 0a20 2020 2020  ritten"]),.     
-00024880: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00024890: 756d 2864 6174 615b 2263 6f6d 6d5f 7265  um(data["comm_re
-000248a0: 6164 225d 292c 0a20 2020 2020 2020 2020  ad"]),.         
-000248b0: 2020 2020 2020 2020 2020 2073 756d 2864             sum(d
-000248c0: 6174 615b 2264 6973 6b5f 7772 6974 7465  ata["disk_writte
-000248d0: 6e22 5d29 2c0a 2020 2020 2020 2020 2020  n"]),.          
-000248e0: 2020 2020 2020 2020 2020 7375 6d28 6461            sum(da
-000248f0: 7461 5b22 6469 736b 5f72 6561 6422 5d29  ta["disk_read"])
-00024900: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00024910: 2020 5d2c 0a20 2020 2020 2020 2020 2020    ],.           
-00024920: 207d 0a20 2020 2020 2020 2020 2020 2075   }.            u
-00024930: 7064 6174 6528 7365 6c66 2e74 6f74 616c  pdate(self.total
-00024940: 735f 736f 7572 6365 2c20 746f 7461 6c73  s_source, totals
-00024950: 290a 0a20 2020 2020 2020 2020 2020 2075  )..            u
-00024960: 7064 6174 6528 7365 6c66 2e73 6f75 7263  pdate(self.sourc
-00024970: 652c 2064 6963 7428 6461 7461 2929 0a20  e, dict(data)). 
-00024980: 2020 2020 2020 2020 2020 206c 696d 6974             limit
-00024990: 203d 206d 6178 2864 6174 615b 2263 6f6d   = max(data["com
-000249a0: 6d5f 6d65 6d6f 7279 5f6c 696d 6974 225d  m_memory_limit"]
-000249b0: 202b 2064 6174 615b 2264 6973 6b5f 6d65   + data["disk_me
-000249c0: 6d6f 7279 5f6c 696d 6974 225d 2920 2a20  mory_limit"]) * 
-000249d0: 312e 320a 2020 2020 2020 2020 2020 2020  1.2.            
-000249e0: 7365 6c66 2e63 6f6d 6d5f 6d65 6d6f 7279  self.comm_memory
-000249f0: 2e78 5f72 616e 6765 2e65 6e64 203d 206c  .x_range.end = l
-00024a00: 696d 6974 0a20 2020 2020 2020 2020 2020  imit.           
-00024a10: 2073 656c 662e 6469 736b 5f6d 656d 6f72   self.disk_memor
-00024a20: 792e 785f 7261 6e67 652e 656e 6420 3d20  y.x_range.end = 
-00024a30: 6c69 6d69 740a 0a0a 5f53 5459 4c45 5320  limit..._STYLES 
-00024a40: 3d20 7b0a 2020 2020 2277 6964 7468 223a  = {.    "width":
-00024a50: 2022 3130 3025 222c 0a20 2020 2022 6865   "100%",.    "he
-00024a60: 6967 6874 223a 2022 3130 3025 222c 0a20  ight": "100%",. 
-00024a70: 2020 2022 6d61 782d 7769 6474 6822 3a20     "max-width": 
-00024a80: 2231 3932 3070 7822 2c0a 2020 2020 226d  "1920px",.    "m
-00024a90: 6178 2d68 6569 6768 7422 3a20 2231 3038  ax-height": "108
-00024aa0: 3070 7822 2c0a 2020 2020 2270 6164 6469  0px",.    "paddi
-00024ab0: 6e67 223a 2022 3132 7078 222c 0a20 2020  ng": "12px",.   
-00024ac0: 2022 626f 7264 6572 223a 2022 3170 7820   "border": "1px 
-00024ad0: 736f 6c69 6420 6c69 6768 7467 7261 7922  solid lightgray"
-00024ae0: 2c0a 2020 2020 2262 6f78 2d73 6861 646f  ,.    "box-shado
-00024af0: 7722 3a20 2269 6e73 6574 2031 7078 2030  w": "inset 1px 0
-00024b00: 2038 7078 2030 206c 6967 6874 6772 6179   8px 0 lightgray
-00024b10: 222c 0a20 2020 2022 6f76 6572 666c 6f77  ",.    "overflow
-00024b20: 223a 2022 6175 746f 222c 0a7d 0a69 6620  ": "auto",.}.if 
-00024b30: 424f 4b45 485f 5645 5253 494f 4e2e 6d61  BOKEH_VERSION.ma
-00024b40: 6a6f 7220 3c20 333a 0a20 2020 205f 424f  jor < 3:.    _BO
-00024b50: 4b45 485f 5354 594c 4553 5f4b 5741 5247  KEH_STYLES_KWARG
-00024b60: 5320 3d20 7b22 7374 796c 6522 3a20 5f53  S = {"style": _S
-00024b70: 5459 4c45 537d 0a65 6c73 653a 0a20 2020  TYLES}.else:.   
-00024b80: 205f 424f 4b45 485f 5354 594c 4553 5f4b   _BOKEH_STYLES_K
-00024b90: 5741 5247 5320 3d20 7b22 7374 796c 6573  WARGS = {"styles
-00024ba0: 223a 205f 5354 594c 4553 7d0a 0a0a 636c  ": _STYLES}...cl
-00024bb0: 6173 7320 5363 6865 6475 6c65 724c 6f67  ass SchedulerLog
-00024bc0: 733a 0a20 2020 2064 6566 205f 5f69 6e69  s:.    def __ini
-00024bd0: 745f 5f28 7365 6c66 2c20 7363 6865 6475  t__(self, schedu
-00024be0: 6c65 722c 2073 7461 7274 3d4e 6f6e 6529  ler, start=None)
-00024bf0: 3a0a 2020 2020 2020 2020 6c6f 6773 203d  :.        logs =
-00024c00: 2073 6368 6564 756c 6572 2e67 6574 5f6c   scheduler.get_l
-00024c10: 6f67 7328 7374 6172 743d 7374 6172 742c  ogs(start=start,
-00024c20: 2074 696d 6573 7461 6d70 733d 5472 7565   timestamps=True
-00024c30: 290a 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
-00024c40: 7420 6c6f 6773 3a0a 2020 2020 2020 2020  t logs:.        
-00024c50: 2020 2020 6c6f 6773 5f68 746d 6c20 3d20      logs_html = 
-00024c60: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00024c70: 2020 273c 7020 7374 796c 653d 2266 6f6e    '<p style="fon
-00024c80: 742d 6661 6d69 6c79 3a20 6d6f 6e6f 7370  t-family: monosp
-00024c90: 6163 653b 206d 6172 6769 6e3a 2030 3b22  ace; margin: 0;"
-00024ca0: 3e4e 6f20 6c6f 6773 2074 6f20 7265 706f  >No logs to repo
-00024cb0: 7274 3c2f 703e 270a 2020 2020 2020 2020  rt</p>'.        
-00024cc0: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
-00024cd0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00024ce0: 6c6f 6773 5f68 746d 6c20 3d20 4c6f 6728  logs_html = Log(
-00024cf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024d00: 2022 5c6e 222e 6a6f 696e 280a 2020 2020   "\n".join(.    
-00024d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024d20: 2225 7320 2d20 2573 220a 2020 2020 2020  "%s - %s".      
-00024d30: 2020 2020 2020 2020 2020 2020 2020 2520                % 
-00024d40: 2864 6174 6574 696d 652e 6672 6f6d 7469  (datetime.fromti
-00024d50: 6d65 7374 616d 7028 7469 6d65 292e 7374  mestamp(time).st
-00024d60: 7266 7469 6d65 2822 2548 3a25 4d3a 2553  rftime("%H:%M:%S
-00024d70: 2e25 6622 292c 206c 696e 6529 0a20 2020  .%f"), line).   
-00024d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024d90: 2066 6f72 2074 696d 652c 206c 6576 656c   for time, level
-00024da0: 2c20 6c69 6e65 2069 6e20 6c6f 6773 0a20  , line in logs. 
-00024db0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00024dc0: 0a20 2020 2020 2020 2020 2020 2029 2e5f  .            )._
-00024dd0: 7265 7072 5f68 746d 6c5f 2829 0a0a 2020  repr_html_()..  
-00024de0: 2020 2020 2020 7365 6c66 2e72 6f6f 7420        self.root 
-00024df0: 3d20 4469 7628 7465 7874 3d6c 6f67 735f  = Div(text=logs_
-00024e00: 6874 6d6c 2c20 2a2a 5f42 4f4b 4548 5f53  html, **_BOKEH_S
-00024e10: 5459 4c45 535f 4b57 4152 4753 290a 0a0a  TYLES_KWARGS)...
-00024e20: 406c 6f67 5f65 7272 6f72 730a 6465 6620  @log_errors.def 
-00024e30: 7379 7374 656d 6d6f 6e69 746f 725f 646f  systemmonitor_do
-00024e40: 6328 7363 6865 6475 6c65 722c 2065 7874  c(scheduler, ext
-00024e50: 7261 2c20 646f 6329 3a0a 2020 2020 7379  ra, doc):.    sy
-00024e60: 736d 6f6e 203d 2053 7973 7465 6d4d 6f6e  smon = SystemMon
-00024e70: 6974 6f72 2873 6368 6564 756c 6572 2c20  itor(scheduler, 
-00024e80: 7369 7a69 6e67 5f6d 6f64 653d 2273 7472  sizing_mode="str
-00024e90: 6574 6368 5f62 6f74 6822 290a 2020 2020  etch_both").    
-00024ea0: 646f 632e 7469 746c 6520 3d20 2244 6173  doc.title = "Das
-00024eb0: 6b3a 2053 6368 6564 756c 6572 2053 7973  k: Scheduler Sys
-00024ec0: 7465 6d20 4d6f 6e69 746f 7222 0a20 2020  tem Monitor".   
-00024ed0: 2061 6464 5f70 6572 696f 6469 635f 6361   add_periodic_ca
-00024ee0: 6c6c 6261 636b 2864 6f63 2c20 7379 736d  llback(doc, sysm
-00024ef0: 6f6e 2c20 3530 3029 0a0a 2020 2020 646f  on, 500)..    do
-00024f00: 632e 6164 645f 726f 6f74 2873 7973 6d6f  c.add_root(sysmo
-00024f10: 6e2e 726f 6f74 290a 2020 2020 646f 632e  n.root).    doc.
-00024f20: 7465 6d70 6c61 7465 203d 2065 6e76 2e67  template = env.g
-00024f30: 6574 5f74 656d 706c 6174 6528 2273 696d  et_template("sim
-00024f40: 706c 652e 6874 6d6c 2229 0a20 2020 2064  ple.html").    d
-00024f50: 6f63 2e74 656d 706c 6174 655f 7661 7269  oc.template_vari
-00024f60: 6162 6c65 732e 7570 6461 7465 2865 7874  ables.update(ext
-00024f70: 7261 290a 2020 2020 646f 632e 7468 656d  ra).    doc.them
-00024f80: 6520 3d20 424f 4b45 485f 5448 454d 450a  e = BOKEH_THEME.
-00024f90: 0a0a 406c 6f67 5f65 7272 6f72 730a 6465  ..@log_errors.de
-00024fa0: 6620 7368 7566 666c 696e 675f 646f 6328  f shuffling_doc(
-00024fb0: 7363 6865 6475 6c65 722c 2065 7874 7261  scheduler, extra
-00024fc0: 2c20 646f 6329 3a0a 2020 2020 646f 632e  , doc):.    doc.
-00024fd0: 7469 746c 6520 3d20 2244 6173 6b3a 2053  title = "Dask: S
-00024fe0: 6875 6666 6c69 6e67 220a 0a20 2020 2073  huffling"..    s
-00024ff0: 6875 6666 6c69 6e67 203d 2053 6875 6666  huffling = Shuff
-00025000: 6c69 6e67 2873 6368 6564 756c 6572 2c20  ling(scheduler, 
-00025010: 7769 6474 683d 3430 302c 2068 6569 6768  width=400, heigh
-00025020: 743d 3430 3029 0a20 2020 2077 6f72 6b65  t=400).    worke
-00025030: 7273 5f6d 656d 6f72 7920 3d20 576f 726b  rs_memory = Work
-00025040: 6572 734d 656d 6f72 7928 7363 6865 6475  ersMemory(schedu
-00025050: 6c65 722c 2077 6964 7468 3d34 3030 2c20  ler, width=400, 
-00025060: 6865 6967 6874 3d34 3030 290a 2020 2020  height=400).    
-00025070: 7469 6d65 7365 7269 6573 203d 2053 7973  timeseries = Sys
-00025080: 7465 6d54 696d 6573 6572 6965 7328 0a20  temTimeseries(. 
-00025090: 2020 2020 2020 2073 6368 6564 756c 6572         scheduler
-000250a0: 2c20 7769 6474 683d 3136 3030 2c20 6865  , width=1600, he
-000250b0: 6967 6874 3d32 3030 2c20 666f 6c6c 6f77  ight=200, follow
-000250c0: 5f69 6e74 6572 7661 6c3d 3330 3030 0a20  _interval=3000. 
-000250d0: 2020 2029 0a20 2020 2065 7665 6e74 5f6c     ).    event_l
-000250e0: 6f6f 7020 3d20 436f 6e74 656e 7469 6f6e  oop = Contention
-000250f0: 2873 6368 6564 756c 6572 2c20 7769 6474  (scheduler, widt
-00025100: 683d 3230 302c 2068 6569 6768 743d 3430  h=200, height=40
-00025110: 3029 0a0a 2020 2020 6164 645f 7065 7269  0)..    add_peri
-00025120: 6f64 6963 5f63 616c 6c62 6163 6b28 646f  odic_callback(do
-00025130: 632c 2073 6875 6666 6c69 6e67 2c20 3230  c, shuffling, 20
-00025140: 3029 0a20 2020 2061 6464 5f70 6572 696f  0).    add_perio
-00025150: 6469 635f 6361 6c6c 6261 636b 2864 6f63  dic_callback(doc
-00025160: 2c20 776f 726b 6572 735f 6d65 6d6f 7279  , workers_memory
-00025170: 2c20 3230 3029 0a20 2020 2061 6464 5f70  , 200).    add_p
-00025180: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
-00025190: 2864 6f63 2c20 7469 6d65 7365 7269 6573  (doc, timeseries
-000251a0: 2c20 3530 3029 0a20 2020 2061 6464 5f70  , 500).    add_p
-000251b0: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
-000251c0: 2864 6f63 2c20 6576 656e 745f 6c6f 6f70  (doc, event_loop
-000251d0: 2c20 3530 3029 0a0a 2020 2020 7469 6d65  , 500)..    time
-000251e0: 7365 7269 6573 2e62 616e 6477 6964 7468  series.bandwidth
-000251f0: 2e79 5f72 616e 6765 203d 2074 696d 6573  .y_range = times
-00025200: 6572 6965 732e 6469 736b 2e79 5f72 616e  eries.disk.y_ran
-00025210: 6765 0a0a 2020 2020 646f 632e 6164 645f  ge..    doc.add_
-00025220: 726f 6f74 280a 2020 2020 2020 2020 636f  root(.        co
-00025230: 6c75 6d6e 280a 2020 2020 2020 2020 2020  lumn(.          
-00025240: 2020 726f 7728 0a20 2020 2020 2020 2020    row(.         
-00025250: 2020 2020 2020 2077 6f72 6b65 7273 5f6d         workers_m
-00025260: 656d 6f72 792e 726f 6f74 2c0a 2020 2020  emory.root,.    
-00025270: 2020 2020 2020 2020 2020 2020 7368 7566              shuf
-00025280: 666c 696e 672e 636f 6d6d 5f6d 656d 6f72  fling.comm_memor
-00025290: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
-000252a0: 2020 2073 6875 6666 6c69 6e67 2e64 6973     shuffling.dis
-000252b0: 6b5f 6d65 6d6f 7279 2c0a 2020 2020 2020  k_memory,.      
-000252c0: 2020 2020 2020 2020 2020 7368 7566 666c            shuffl
-000252d0: 696e 672e 746f 7461 6c73 2c0a 2020 2020  ing.totals,.    
-000252e0: 2020 2020 2020 2020 2020 2020 6576 656e              even
-000252f0: 745f 6c6f 6f70 2e72 6f6f 742c 0a20 2020  t_loop.root,.   
-00025300: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
-00025310: 2020 2020 2020 2020 726f 7728 636f 6c75          row(colu
-00025320: 6d6e 2874 696d 6573 6572 6965 732e 6261  mn(timeseries.ba
-00025330: 6e64 7769 6474 682c 2074 696d 6573 6572  ndwidth, timeser
-00025340: 6965 732e 6469 736b 2929 2c0a 2020 2020  ies.disk)),.    
-00025350: 2020 2020 290a 2020 2020 290a 2020 2020      ).    ).    
-00025360: 646f 632e 7465 6d70 6c61 7465 203d 2065  doc.template = e
-00025370: 6e76 2e67 6574 5f74 656d 706c 6174 6528  nv.get_template(
-00025380: 2273 696d 706c 652e 6874 6d6c 2229 0a20  "simple.html"). 
-00025390: 2020 2064 6f63 2e74 656d 706c 6174 655f     doc.template_
-000253a0: 7661 7269 6162 6c65 732e 7570 6461 7465  variables.update
-000253b0: 2865 7874 7261 290a 2020 2020 646f 632e  (extra).    doc.
-000253c0: 7468 656d 6520 3d20 424f 4b45 485f 5448  theme = BOKEH_TH
-000253d0: 454d 450a 0a0a 406c 6f67 5f65 7272 6f72  EME...@log_error
-000253e0: 730a 6465 6620 7374 6561 6c69 6e67 5f64  s.def stealing_d
-000253f0: 6f63 2873 6368 6564 756c 6572 2c20 6578  oc(scheduler, ex
-00025400: 7472 612c 2064 6f63 293a 0a20 2020 206f  tra, doc):.    o
-00025410: 6363 7570 616e 6379 203d 204f 6363 7570  ccupancy = Occup
-00025420: 616e 6379 2873 6368 6564 756c 6572 290a  ancy(scheduler).
-00025430: 2020 2020 7374 6561 6c69 6e67 5f74 7320      stealing_ts 
-00025440: 3d20 5374 6561 6c69 6e67 5469 6d65 5365  = StealingTimeSe
-00025450: 7269 6573 2873 6368 6564 756c 6572 290a  ries(scheduler).
-00025460: 2020 2020 7374 6561 6c69 6e67 5f65 7665      stealing_eve
-00025470: 6e74 7320 3d20 5374 6561 6c69 6e67 4576  nts = StealingEv
-00025480: 656e 7473 2873 6368 6564 756c 6572 290a  ents(scheduler).
-00025490: 2020 2020 7374 6561 6c69 6e67 5f65 7665      stealing_eve
-000254a0: 6e74 732e 726f 6f74 2e78 5f72 616e 6765  nts.root.x_range
-000254b0: 203d 2073 7465 616c 696e 675f 7473 2e72   = stealing_ts.r
-000254c0: 6f6f 742e 785f 7261 6e67 650a 2020 2020  oot.x_range.    
-000254d0: 646f 632e 7469 746c 6520 3d20 2244 6173  doc.title = "Das
-000254e0: 6b3a 2057 6f72 6b20 5374 6561 6c69 6e67  k: Work Stealing
-000254f0: 220a 2020 2020 6164 645f 7065 7269 6f64  ".    add_period
-00025500: 6963 5f63 616c 6c62 6163 6b28 646f 632c  ic_callback(doc,
-00025510: 206f 6363 7570 616e 6379 2c20 3530 3029   occupancy, 500)
-00025520: 0a20 2020 2061 6464 5f70 6572 696f 6469  .    add_periodi
-00025530: 635f 6361 6c6c 6261 636b 2864 6f63 2c20  c_callback(doc, 
-00025540: 7374 6561 6c69 6e67 5f74 732c 2035 3030  stealing_ts, 500
-00025550: 290a 2020 2020 6164 645f 7065 7269 6f64  ).    add_period
-00025560: 6963 5f63 616c 6c62 6163 6b28 646f 632c  ic_callback(doc,
-00025570: 2073 7465 616c 696e 675f 6576 656e 7473   stealing_events
-00025580: 2c20 3530 3029 0a0a 2020 2020 646f 632e  , 500)..    doc.
-00025590: 6164 645f 726f 6f74 280a 2020 2020 2020  add_root(.      
-000255a0: 2020 726f 7728 0a20 2020 2020 2020 2020    row(.         
-000255b0: 2020 206f 6363 7570 616e 6379 2e72 6f6f     occupancy.roo
-000255c0: 742c 0a20 2020 2020 2020 2020 2020 2063  t,.            c
-000255d0: 6f6c 756d 6e28 0a20 2020 2020 2020 2020  olumn(.         
-000255e0: 2020 2020 2020 2073 7465 616c 696e 675f         stealing_
-000255f0: 7473 2e72 6f6f 742c 0a20 2020 2020 2020  ts.root,.       
-00025600: 2020 2020 2020 2020 2073 7465 616c 696e           stealin
-00025610: 675f 6576 656e 7473 2e72 6f6f 742c 0a20  g_events.root,. 
-00025620: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00025630: 697a 696e 675f 6d6f 6465 3d22 7374 7265  izing_mode="stre
-00025640: 7463 685f 626f 7468 222c 0a20 2020 2020  tch_both",.     
-00025650: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-00025660: 2020 290a 2020 2020 290a 0a20 2020 2064    ).    )..    d
-00025670: 6f63 2e74 656d 706c 6174 6520 3d20 656e  oc.template = en
-00025680: 762e 6765 745f 7465 6d70 6c61 7465 2822  v.get_template("
-00025690: 7369 6d70 6c65 2e68 746d 6c22 290a 2020  simple.html").  
-000256a0: 2020 646f 632e 7465 6d70 6c61 7465 5f76    doc.template_v
-000256b0: 6172 6961 626c 6573 2e75 7064 6174 6528  ariables.update(
-000256c0: 6578 7472 6129 0a20 2020 2064 6f63 2e74  extra).    doc.t
-000256d0: 6865 6d65 203d 2042 4f4b 4548 5f54 4845  heme = BOKEH_THE
-000256e0: 4d45 0a0a 0a40 6c6f 675f 6572 726f 7273  ME...@log_errors
-000256f0: 0a64 6566 2065 7665 6e74 735f 646f 6328  .def events_doc(
-00025700: 7363 6865 6475 6c65 722c 2065 7874 7261  scheduler, extra
-00025710: 2c20 646f 6329 3a0a 2020 2020 6576 656e  , doc):.    even
-00025720: 7473 203d 2045 7665 6e74 7328 7363 6865  ts = Events(sche
-00025730: 6475 6c65 722c 2022 616c 6c22 2c20 6865  duler, "all", he
-00025740: 6967 6874 3d32 3530 290a 2020 2020 6576  ight=250).    ev
-00025750: 656e 7473 2e75 7064 6174 6528 290a 2020  ents.update().  
-00025760: 2020 6164 645f 7065 7269 6f64 6963 5f63    add_periodic_c
-00025770: 616c 6c62 6163 6b28 646f 632c 2065 7665  allback(doc, eve
-00025780: 6e74 732c 2035 3030 290a 2020 2020 646f  nts, 500).    do
-00025790: 632e 7469 746c 6520 3d20 2244 6173 6b3a  c.title = "Dask:
-000257a0: 2053 6368 6564 756c 6572 2045 7665 6e74   Scheduler Event
-000257b0: 7322 0a20 2020 2064 6f63 2e61 6464 5f72  s".    doc.add_r
-000257c0: 6f6f 7428 636f 6c75 6d6e 2865 7665 6e74  oot(column(event
-000257d0: 732e 726f 6f74 2c20 7369 7a69 6e67 5f6d  s.root, sizing_m
-000257e0: 6f64 653d 2273 6361 6c65 5f77 6964 7468  ode="scale_width
-000257f0: 2229 290a 2020 2020 646f 632e 7465 6d70  ")).    doc.temp
-00025800: 6c61 7465 203d 2065 6e76 2e67 6574 5f74  late = env.get_t
-00025810: 656d 706c 6174 6528 2273 696d 706c 652e  emplate("simple.
-00025820: 6874 6d6c 2229 0a20 2020 2064 6f63 2e74  html").    doc.t
-00025830: 656d 706c 6174 655f 7661 7269 6162 6c65  emplate_variable
-00025840: 732e 7570 6461 7465 2865 7874 7261 290a  s.update(extra).
-00025850: 2020 2020 646f 632e 7468 656d 6520 3d20      doc.theme = 
-00025860: 424f 4b45 485f 5448 454d 450a 0a0a 406c  BOKEH_THEME...@l
-00025870: 6f67 5f65 7272 6f72 730a 6465 6620 6578  og_errors.def ex
-00025880: 6365 7074 696f 6e73 5f64 6f63 2873 6368  ceptions_doc(sch
-00025890: 6564 756c 6572 2c20 6578 7472 612c 2064  eduler, extra, d
-000258a0: 6f63 293a 0a20 2020 2074 6162 6c65 203d  oc):.    table =
-000258b0: 2045 7863 6570 7469 6f6e 7354 6162 6c65   ExceptionsTable
-000258c0: 2873 6368 6564 756c 6572 290a 2020 2020  (scheduler).    
-000258d0: 7461 626c 652e 7570 6461 7465 2829 0a20  table.update(). 
-000258e0: 2020 2061 6464 5f70 6572 696f 6469 635f     add_periodic_
-000258f0: 6361 6c6c 6261 636b 2864 6f63 2c20 7461  callback(doc, ta
-00025900: 626c 652c 2031 3030 3029 0a20 2020 2064  ble, 1000).    d
-00025910: 6f63 2e74 6974 6c65 203d 2022 4461 736b  oc.title = "Dask
-00025920: 3a20 4578 6365 7074 696f 6e73 220a 2020  : Exceptions".  
-00025930: 2020 646f 632e 6164 645f 726f 6f74 2874    doc.add_root(t
-00025940: 6162 6c65 2e72 6f6f 7429 0a20 2020 2064  able.root).    d
-00025950: 6f63 2e74 656d 706c 6174 6520 3d20 656e  oc.template = en
-00025960: 762e 6765 745f 7465 6d70 6c61 7465 2822  v.get_template("
-00025970: 7369 6d70 6c65 2e68 746d 6c22 290a 2020  simple.html").  
-00025980: 2020 646f 632e 7465 6d70 6c61 7465 5f76    doc.template_v
-00025990: 6172 6961 626c 6573 2e75 7064 6174 6528  ariables.update(
-000259a0: 6578 7472 6129 0a20 2020 2064 6f63 2e74  extra).    doc.t
-000259b0: 6865 6d65 203d 2042 4f4b 4548 5f54 4845  heme = BOKEH_THE
-000259c0: 4d45 0a0a 0a40 6c6f 675f 6572 726f 7273  ME...@log_errors
-000259d0: 0a64 6566 2077 6f72 6b65 7273 5f64 6f63  .def workers_doc
-000259e0: 2873 6368 6564 756c 6572 2c20 6578 7472  (scheduler, extr
-000259f0: 612c 2064 6f63 293a 0a20 2020 2074 6162  a, doc):.    tab
-00025a00: 6c65 203d 2057 6f72 6b65 7254 6162 6c65  le = WorkerTable
-00025a10: 2873 6368 6564 756c 6572 290a 2020 2020  (scheduler).    
-00025a20: 7461 626c 652e 7570 6461 7465 2829 0a20  table.update(). 
-00025a30: 2020 2061 6464 5f70 6572 696f 6469 635f     add_periodic_
-00025a40: 6361 6c6c 6261 636b 2864 6f63 2c20 7461  callback(doc, ta
-00025a50: 626c 652c 2035 3030 290a 2020 2020 646f  ble, 500).    do
-00025a60: 632e 7469 746c 6520 3d20 2244 6173 6b3a  c.title = "Dask:
-00025a70: 2057 6f72 6b65 7273 220a 2020 2020 646f   Workers".    do
-00025a80: 632e 6164 645f 726f 6f74 2874 6162 6c65  c.add_root(table
-00025a90: 2e72 6f6f 7429 0a20 2020 2064 6f63 2e74  .root).    doc.t
-00025aa0: 656d 706c 6174 6520 3d20 656e 762e 6765  emplate = env.ge
-00025ab0: 745f 7465 6d70 6c61 7465 2822 7369 6d70  t_template("simp
-00025ac0: 6c65 2e68 746d 6c22 290a 2020 2020 646f  le.html").    do
-00025ad0: 632e 7465 6d70 6c61 7465 5f76 6172 6961  c.template_varia
-00025ae0: 626c 6573 2e75 7064 6174 6528 6578 7472  bles.update(extr
-00025af0: 6129 0a20 2020 2064 6f63 2e74 6865 6d65  a).    doc.theme
-00025b00: 203d 2042 4f4b 4548 5f54 4845 4d45 0a0a   = BOKEH_THEME..
-00025b10: 0a40 6c6f 675f 6572 726f 7273 0a64 6566  .@log_errors.def
-00025b20: 2068 6172 6477 6172 655f 646f 6328 7363   hardware_doc(sc
-00025b30: 6865 6475 6c65 722c 2065 7874 7261 2c20  heduler, extra, 
-00025b40: 646f 6329 3a0a 2020 2020 6877 203d 2048  doc):.    hw = H
-00025b50: 6172 6477 6172 6528 7363 6865 6475 6c65  ardware(schedule
-00025b60: 7229 0a20 2020 2068 772e 7570 6461 7465  r).    hw.update
-00025b70: 2829 0a20 2020 2064 6f63 2e74 6974 6c65  ().    doc.title
-00025b80: 203d 2022 4461 736b 3a20 436c 7573 7465   = "Dask: Cluste
-00025b90: 7220 4861 7264 7761 7265 2042 616e 6477  r Hardware Bandw
-00025ba0: 6964 7468 220a 2020 2020 646f 632e 6164  idth".    doc.ad
-00025bb0: 645f 726f 6f74 2868 772e 726f 6f74 290a  d_root(hw.root).
-00025bc0: 2020 2020 646f 632e 7465 6d70 6c61 7465      doc.template
-00025bd0: 203d 2065 6e76 2e67 6574 5f74 656d 706c   = env.get_templ
-00025be0: 6174 6528 2273 696d 706c 652e 6874 6d6c  ate("simple.html
-00025bf0: 2229 0a20 2020 2064 6f63 2e74 656d 706c  ").    doc.templ
-00025c00: 6174 655f 7661 7269 6162 6c65 732e 7570  ate_variables.up
-00025c10: 6461 7465 2865 7874 7261 290a 2020 2020  date(extra).    
-00025c20: 646f 632e 7468 656d 6520 3d20 424f 4b45  doc.theme = BOKE
-00025c30: 485f 5448 454d 450a 0a20 2020 2061 6464  H_THEME..    add
-00025c40: 5f70 6572 696f 6469 635f 6361 6c6c 6261  _periodic_callba
-00025c50: 636b 2864 6f63 2c20 6877 2c20 3530 3029  ck(doc, hw, 500)
-00025c60: 0a0a 0a40 6c6f 675f 6572 726f 7273 0a64  ...@log_errors.d
-00025c70: 6566 2074 6173 6b73 5f64 6f63 2873 6368  ef tasks_doc(sch
-00025c80: 6564 756c 6572 2c20 6578 7472 612c 2064  eduler, extra, d
-00025c90: 6f63 293a 0a20 2020 2074 7320 3d20 5461  oc):.    ts = Ta
-00025ca0: 736b 5374 7265 616d 280a 2020 2020 2020  skStream(.      
-00025cb0: 2020 7363 6865 6475 6c65 722c 0a20 2020    scheduler,.   
-00025cc0: 2020 2020 206e 5f72 6563 7461 6e67 6c65       n_rectangle
-00025cd0: 733d 6461 736b 2e63 6f6e 6669 672e 6765  s=dask.config.ge
-00025ce0: 7428 0a20 2020 2020 2020 2020 2020 2022  t(.            "
-00025cf0: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
-00025d00: 6475 6c65 722e 6461 7368 626f 6172 642e  duler.dashboard.
-00025d10: 7461 736b 732e 7461 736b 2d73 7472 6561  tasks.task-strea
-00025d20: 6d2d 6c65 6e67 7468 220a 2020 2020 2020  m-length".      
-00025d30: 2020 292c 0a20 2020 2020 2020 2063 6c65    ),.        cle
-00025d40: 6172 5f69 6e74 6572 7661 6c3d 2236 3073  ar_interval="60s
-00025d50: 222c 0a20 2020 2020 2020 2073 697a 696e  ",.        sizin
-00025d60: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
-00025d70: 626f 7468 222c 0a20 2020 2029 0a20 2020  both",.    ).   
-00025d80: 2074 732e 7570 6461 7465 2829 0a20 2020   ts.update().   
-00025d90: 2061 6464 5f70 6572 696f 6469 635f 6361   add_periodic_ca
-00025da0: 6c6c 6261 636b 2864 6f63 2c20 7473 2c20  llback(doc, ts, 
-00025db0: 3530 3030 290a 2020 2020 646f 632e 7469  5000).    doc.ti
-00025dc0: 746c 6520 3d20 2244 6173 6b3a 2054 6173  tle = "Dask: Tas
-00025dd0: 6b20 5374 7265 616d 220a 2020 2020 646f  k Stream".    do
-00025de0: 632e 6164 645f 726f 6f74 2874 732e 726f  c.add_root(ts.ro
-00025df0: 6f74 290a 2020 2020 646f 632e 7465 6d70  ot).    doc.temp
-00025e00: 6c61 7465 203d 2065 6e76 2e67 6574 5f74  late = env.get_t
-00025e10: 656d 706c 6174 6528 2273 696d 706c 652e  emplate("simple.
-00025e20: 6874 6d6c 2229 0a20 2020 2064 6f63 2e74  html").    doc.t
-00025e30: 656d 706c 6174 655f 7661 7269 6162 6c65  emplate_variable
-00025e40: 732e 7570 6461 7465 2865 7874 7261 290a  s.update(extra).
-00025e50: 2020 2020 646f 632e 7468 656d 6520 3d20      doc.theme = 
-00025e60: 424f 4b45 485f 5448 454d 450a 0a0a 406c  BOKEH_THEME...@l
-00025e70: 6f67 5f65 7272 6f72 730a 6465 6620 6772  og_errors.def gr
-00025e80: 6170 685f 646f 6328 7363 6865 6475 6c65  aph_doc(schedule
-00025e90: 722c 2065 7874 7261 2c20 646f 6329 3a0a  r, extra, doc):.
-00025ea0: 2020 2020 6772 6170 6820 3d20 5461 736b      graph = Task
-00025eb0: 4772 6170 6828 7363 6865 6475 6c65 722c  Graph(scheduler,
-00025ec0: 2073 697a 696e 675f 6d6f 6465 3d22 7374   sizing_mode="st
-00025ed0: 7265 7463 685f 626f 7468 2229 0a20 2020  retch_both").   
-00025ee0: 2064 6f63 2e74 6974 6c65 203d 2022 4461   doc.title = "Da
-00025ef0: 736b 3a20 5461 736b 2047 7261 7068 220a  sk: Task Graph".
-00025f00: 2020 2020 6772 6170 682e 7570 6461 7465      graph.update
-00025f10: 2829 0a20 2020 2061 6464 5f70 6572 696f  ().    add_perio
-00025f20: 6469 635f 6361 6c6c 6261 636b 2864 6f63  dic_callback(doc
-00025f30: 2c20 6772 6170 682c 2032 3030 290a 2020  , graph, 200).  
-00025f40: 2020 646f 632e 6164 645f 726f 6f74 2867    doc.add_root(g
-00025f50: 7261 7068 2e72 6f6f 7429 0a0a 2020 2020  raph.root)..    
-00025f60: 646f 632e 7465 6d70 6c61 7465 203d 2065  doc.template = e
-00025f70: 6e76 2e67 6574 5f74 656d 706c 6174 6528  nv.get_template(
-00025f80: 2273 696d 706c 652e 6874 6d6c 2229 0a20  "simple.html"). 
-00025f90: 2020 2064 6f63 2e74 656d 706c 6174 655f     doc.template_
-00025fa0: 7661 7269 6162 6c65 732e 7570 6461 7465  variables.update
-00025fb0: 2865 7874 7261 290a 2020 2020 646f 632e  (extra).    doc.
-00025fc0: 7468 656d 6520 3d20 424f 4b45 485f 5448  theme = BOKEH_TH
-00025fd0: 454d 450a 0a0a 406c 6f67 5f65 7272 6f72  EME...@log_error
-00025fe0: 730a 6465 6620 7467 5f67 7261 7068 5f64  s.def tg_graph_d
-00025ff0: 6f63 2873 6368 6564 756c 6572 2c20 6578  oc(scheduler, ex
-00026000: 7472 612c 2064 6f63 293a 0a20 2020 2074  tra, doc):.    t
-00026010: 675f 6772 6170 6820 3d20 5461 736b 4772  g_graph = TaskGr
-00026020: 6f75 7047 7261 7068 2873 6368 6564 756c  oupGraph(schedul
-00026030: 6572 2c20 7369 7a69 6e67 5f6d 6f64 653d  er, sizing_mode=
-00026040: 2273 7472 6574 6368 5f62 6f74 6822 290a  "stretch_both").
-00026050: 2020 2020 646f 632e 7469 746c 6520 3d20      doc.title = 
-00026060: 2244 6173 6b3a 2054 6173 6b20 4772 6f75  "Dask: Task Grou
-00026070: 7073 2047 7261 7068 220a 2020 2020 7467  ps Graph".    tg
-00026080: 5f67 7261 7068 2e75 7064 6174 6528 290a  _graph.update().
-00026090: 2020 2020 6164 645f 7065 7269 6f64 6963      add_periodic
-000260a0: 5f63 616c 6c62 6163 6b28 646f 632c 2074  _callback(doc, t
-000260b0: 675f 6772 6170 682c 2032 3030 290a 2020  g_graph, 200).  
-000260c0: 2020 646f 632e 6164 645f 726f 6f74 2874    doc.add_root(t
-000260d0: 675f 6772 6170 682e 726f 6f74 290a 2020  g_graph.root).  
-000260e0: 2020 646f 632e 7465 6d70 6c61 7465 203d    doc.template =
-000260f0: 2065 6e76 2e67 6574 5f74 656d 706c 6174   env.get_templat
-00026100: 6528 2273 696d 706c 652e 6874 6d6c 2229  e("simple.html")
-00026110: 0a20 2020 2064 6f63 2e74 656d 706c 6174  .    doc.templat
-00026120: 655f 7661 7269 6162 6c65 732e 7570 6461  e_variables.upda
-00026130: 7465 2865 7874 7261 290a 2020 2020 646f  te(extra).    do
-00026140: 632e 7468 656d 6520 3d20 424f 4b45 485f  c.theme = BOKEH_
-00026150: 5448 454d 450a 0a0a 406c 6f67 5f65 7272  THEME...@log_err
-00026160: 6f72 730a 6465 6620 7374 6174 7573 5f64  ors.def status_d
-00026170: 6f63 2873 6368 6564 756c 6572 2c20 6578  oc(scheduler, ex
-00026180: 7472 612c 2064 6f63 293a 0a20 2020 2063  tra, doc):.    c
-00026190: 6c75 7374 6572 5f6d 656d 6f72 7920 3d20  luster_memory = 
-000261a0: 436c 7573 7465 724d 656d 6f72 7928 7363  ClusterMemory(sc
-000261b0: 6865 6475 6c65 722c 2073 697a 696e 675f  heduler, sizing_
-000261c0: 6d6f 6465 3d22 7374 7265 7463 685f 626f  mode="stretch_bo
-000261d0: 7468 2229 0a20 2020 2063 6c75 7374 6572  th").    cluster
-000261e0: 5f6d 656d 6f72 792e 7570 6461 7465 2829  _memory.update()
-000261f0: 0a20 2020 2061 6464 5f70 6572 696f 6469  .    add_periodi
-00026200: 635f 6361 6c6c 6261 636b 2864 6f63 2c20  c_callback(doc, 
-00026210: 636c 7573 7465 725f 6d65 6d6f 7279 2c20  cluster_memory, 
-00026220: 3130 3029 0a20 2020 2064 6f63 2e61 6464  100).    doc.add
-00026230: 5f72 6f6f 7428 636c 7573 7465 725f 6d65  _root(cluster_me
-00026240: 6d6f 7279 2e72 6f6f 7429 0a0a 2020 2020  mory.root)..    
-00026250: 6966 206c 656e 2873 6368 6564 756c 6572  if len(scheduler
-00026260: 2e77 6f72 6b65 7273 2920 3c3d 2031 3030  .workers) <= 100
-00026270: 3a0a 2020 2020 2020 2020 776f 726b 6572  :.        worker
-00026280: 735f 6d65 6d6f 7279 203d 2057 6f72 6b65  s_memory = Worke
-00026290: 7273 4d65 6d6f 7279 2873 6368 6564 756c  rsMemory(schedul
-000262a0: 6572 2c20 7369 7a69 6e67 5f6d 6f64 653d  er, sizing_mode=
-000262b0: 2273 7472 6574 6368 5f62 6f74 6822 290a  "stretch_both").
-000262c0: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
-000262d0: 696e 6720 3d20 4375 7272 656e 744c 6f61  ing = CurrentLoa
-000262e0: 6428 7363 6865 6475 6c65 722c 2073 697a  d(scheduler, siz
-000262f0: 696e 675f 6d6f 6465 3d22 7374 7265 7463  ing_mode="stretc
-00026300: 685f 626f 7468 2229 0a0a 2020 2020 2020  h_both")..      
-00026310: 2020 7072 6f63 6573 7369 6e67 5f72 6f6f    processing_roo
-00026320: 7420 3d20 7072 6f63 6573 7369 6e67 2e70  t = processing.p
-00026330: 726f 6365 7373 696e 675f 6669 6775 7265  rocessing_figure
-00026340: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00026350: 2020 2077 6f72 6b65 7273 5f6d 656d 6f72     workers_memor
-00026360: 7920 3d20 576f 726b 6572 734d 656d 6f72  y = WorkersMemor
-00026370: 7948 6973 746f 6772 616d 2873 6368 6564  yHistogram(sched
-00026380: 756c 6572 2c20 7369 7a69 6e67 5f6d 6f64  uler, sizing_mod
-00026390: 653d 2273 7472 6574 6368 5f62 6f74 6822  e="stretch_both"
-000263a0: 290a 2020 2020 2020 2020 7072 6f63 6573  ).        proces
-000263b0: 7369 6e67 203d 2050 726f 6365 7373 696e  sing = Processin
-000263c0: 6748 6973 746f 6772 616d 2873 6368 6564  gHistogram(sched
-000263d0: 756c 6572 2c20 7369 7a69 6e67 5f6d 6f64  uler, sizing_mod
-000263e0: 653d 2273 7472 6574 6368 5f62 6f74 6822  e="stretch_both"
-000263f0: 290a 0a20 2020 2020 2020 2070 726f 6365  )..        proce
-00026400: 7373 696e 675f 726f 6f74 203d 2070 726f  ssing_root = pro
-00026410: 6365 7373 696e 672e 726f 6f74 0a0a 2020  cessing.root..  
-00026420: 2020 6375 7272 656e 745f 6c6f 6164 203d    current_load =
-00026430: 2043 7572 7265 6e74 4c6f 6164 2873 6368   CurrentLoad(sch
-00026440: 6564 756c 6572 2c20 7369 7a69 6e67 5f6d  eduler, sizing_m
-00026450: 6f64 653d 2273 7472 6574 6368 5f62 6f74  ode="stretch_bot
-00026460: 6822 290a 2020 2020 6f63 6375 7061 6e63  h").    occupanc
-00026470: 7920 3d20 4f63 6375 7061 6e63 7928 7363  y = Occupancy(sc
-00026480: 6865 6475 6c65 722c 2073 697a 696e 675f  heduler, sizing_
-00026490: 6d6f 6465 3d22 7374 7265 7463 685f 626f  mode="stretch_bo
-000264a0: 7468 2229 0a20 2020 2077 6f72 6b65 7273  th").    workers
-000264b0: 5f74 7261 6e73 6665 725f 6279 7465 7320  _transfer_bytes 
-000264c0: 3d20 576f 726b 6572 7354 7261 6e73 6665  = WorkersTransfe
-000264d0: 7242 7974 6573 2873 6368 6564 756c 6572  rBytes(scheduler
-000264e0: 2c20 7369 7a69 6e67 5f6d 6f64 653d 2273  , sizing_mode="s
-000264f0: 7472 6574 6368 5f62 6f74 6822 290a 0a20  tretch_both").. 
-00026500: 2020 2063 7075 5f72 6f6f 7420 3d20 6375     cpu_root = cu
-00026510: 7272 656e 745f 6c6f 6164 2e63 7075 5f66  rrent_load.cpu_f
-00026520: 6967 7572 650a 2020 2020 6f63 6375 7061  igure.    occupa
-00026530: 6e63 795f 726f 6f74 203d 206f 6363 7570  ncy_root = occup
-00026540: 616e 6379 2e72 6f6f 740a 0a20 2020 2077  ancy.root..    w
-00026550: 6f72 6b65 7273 5f6d 656d 6f72 792e 7570  orkers_memory.up
-00026560: 6461 7465 2829 0a20 2020 2077 6f72 6b65  date().    worke
-00026570: 7273 5f74 7261 6e73 6665 725f 6279 7465  rs_transfer_byte
-00026580: 732e 7570 6461 7465 2829 0a20 2020 2070  s.update().    p
-00026590: 726f 6365 7373 696e 672e 7570 6461 7465  rocessing.update
-000265a0: 2829 0a20 2020 2063 7572 7265 6e74 5f6c  ().    current_l
-000265b0: 6f61 642e 7570 6461 7465 2829 0a20 2020  oad.update().   
-000265c0: 206f 6363 7570 616e 6379 2e75 7064 6174   occupancy.updat
-000265d0: 6528 290a 0a20 2020 2061 6464 5f70 6572  e()..    add_per
-000265e0: 696f 6469 635f 6361 6c6c 6261 636b 2864  iodic_callback(d
-000265f0: 6f63 2c20 776f 726b 6572 735f 6d65 6d6f  oc, workers_memo
-00026600: 7279 2c20 3130 3029 0a20 2020 2061 6464  ry, 100).    add
-00026610: 5f70 6572 696f 6469 635f 6361 6c6c 6261  _periodic_callba
-00026620: 636b 2864 6f63 2c20 776f 726b 6572 735f  ck(doc, workers_
-00026630: 7472 616e 7366 6572 5f62 7974 6573 2c20  transfer_bytes, 
-00026640: 3130 3029 0a20 2020 2061 6464 5f70 6572  100).    add_per
-00026650: 696f 6469 635f 6361 6c6c 6261 636b 2864  iodic_callback(d
-00026660: 6f63 2c20 7072 6f63 6573 7369 6e67 2c20  oc, processing, 
-00026670: 3130 3029 0a20 2020 2061 6464 5f70 6572  100).    add_per
-00026680: 696f 6469 635f 6361 6c6c 6261 636b 2864  iodic_callback(d
-00026690: 6f63 2c20 6375 7272 656e 745f 6c6f 6164  oc, current_load
-000266a0: 2c20 3130 3029 0a20 2020 2061 6464 5f70  , 100).    add_p
-000266b0: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
-000266c0: 2864 6f63 2c20 6f63 6375 7061 6e63 792c  (doc, occupancy,
-000266d0: 2031 3030 290a 0a20 2020 2064 6f63 2e61   100)..    doc.a
-000266e0: 6464 5f72 6f6f 7428 776f 726b 6572 735f  dd_root(workers_
-000266f0: 6d65 6d6f 7279 2e72 6f6f 7429 0a0a 2020  memory.root)..  
-00026700: 2020 7461 6273 203d 205b 0a20 2020 2020    tabs = [.     
-00026710: 2020 2054 6162 5061 6e65 6c28 6368 696c     TabPanel(chil
-00026720: 643d 7072 6f63 6573 7369 6e67 5f72 6f6f  d=processing_roo
-00026730: 742c 2074 6974 6c65 3d22 5072 6f63 6573  t, title="Proces
-00026740: 7369 6e67 2229 2c0a 2020 2020 2020 2020  sing"),.        
-00026750: 5461 6250 616e 656c 2863 6869 6c64 3d63  TabPanel(child=c
-00026760: 7075 5f72 6f6f 742c 2074 6974 6c65 3d22  pu_root, title="
-00026770: 4350 5522 292c 0a20 2020 2020 2020 2054  CPU"),.        T
-00026780: 6162 5061 6e65 6c28 6368 696c 643d 6f63  abPanel(child=oc
-00026790: 6375 7061 6e63 795f 726f 6f74 2c20 7469  cupancy_root, ti
-000267a0: 746c 653d 224f 6363 7570 616e 6379 2229  tle="Occupancy")
-000267b0: 2c0a 2020 2020 2020 2020 5461 6250 616e  ,.        TabPan
-000267c0: 656c 2863 6869 6c64 3d77 6f72 6b65 7273  el(child=workers
-000267d0: 5f74 7261 6e73 6665 725f 6279 7465 732e  _transfer_bytes.
-000267e0: 726f 6f74 2c20 7469 746c 653d 2244 6174  root, title="Dat
-000267f0: 6120 5472 616e 7366 6572 2229 2c0a 2020  a Transfer"),.  
-00026800: 2020 5d0a 0a20 2020 2068 656c 705f 203d    ]..    help_ =
-00026810: 2048 656c 7054 6f6f 6c28 0a20 2020 2020   HelpTool(.     
-00026820: 2020 2072 6564 6972 6563 743d 2268 7474     redirect="htt
-00026830: 7073 3a2f 2f64 6f63 732e 6461 736b 2e6f  ps://docs.dask.o
-00026840: 7267 2f65 6e2f 7374 6162 6c65 2f64 6173  rg/en/stable/das
-00026850: 6862 6f61 7264 2e68 746d 6c23 7461 736b  hboard.html#task
-00026860: 2d70 726f 6365 7373 696e 672d 6370 752d  -processing-cpu-
-00026870: 7574 696c 697a 6174 696f 6e2d 6f63 6375  utilization-occu
-00026880: 7061 6e63 792d 6461 7461 2d74 7261 6e73  pancy-data-trans
-00026890: 6665 7222 2c0a 2020 2020 2020 2020 6465  fer",.        de
-000268a0: 7363 7269 7074 696f 6e3d 2241 2064 6573  scription="A des
-000268b0: 6372 6970 7469 6f6e 206f 6620 5461 736b  cription of Task
-000268c0: 2050 726f 6365 7373 696e 672f 4350 5520   Processing/CPU 
-000268d0: 5574 696c 697a 6174 696f 6e2f 4f63 6375  Utilization/Occu
-000268e0: 7061 6e63 7922 2c0a 2020 2020 290a 2020  pancy",.    ).  
-000268f0: 2020 666f 7220 7461 6220 696e 2074 6162    for tab in tab
-00026900: 733a 0a20 2020 2020 2020 2074 6162 2e63  s:.        tab.c
-00026910: 6869 6c64 2e74 6f6f 6c62 6172 5f6c 6f63  hild.toolbar_loc
-00026920: 6174 696f 6e20 3d20 2261 626f 7665 220a  ation = "above".
-00026930: 2020 2020 2020 2020 7461 622e 6368 696c          tab.chil
-00026940: 642e 6164 645f 746f 6f6c 7328 6865 6c70  d.add_tools(help
-00026950: 5f29 0a0a 2020 2020 7072 6f63 5f74 6162  _)..    proc_tab
-00026960: 7320 3d20 5461 6273 2874 6162 733d 7461  s = Tabs(tabs=ta
-00026970: 6273 2c20 6e61 6d65 3d22 7072 6f63 6573  bs, name="proces
-00026980: 7369 6e67 5f74 6162 7322 2c20 7369 7a69  sing_tabs", sizi
-00026990: 6e67 5f6d 6f64 653d 2273 7472 6574 6368  ng_mode="stretch
-000269a0: 5f62 6f74 6822 290a 2020 2020 646f 632e  _both").    doc.
-000269b0: 6164 645f 726f 6f74 2870 726f 635f 7461  add_root(proc_ta
-000269c0: 6273 290a 0a20 2020 2074 6173 6b5f 7374  bs)..    task_st
-000269d0: 7265 616d 203d 2054 6173 6b53 7472 6561  ream = TaskStrea
-000269e0: 6d28 0a20 2020 2020 2020 2073 6368 6564  m(.        sched
-000269f0: 756c 6572 2c0a 2020 2020 2020 2020 6e5f  uler,.        n_
-00026a00: 7265 6374 616e 676c 6573 3d64 6173 6b2e  rectangles=dask.
-00026a10: 636f 6e66 6967 2e67 6574 280a 2020 2020  config.get(.    
-00026a20: 2020 2020 2020 2020 2264 6973 7472 6962          "distrib
-00026a30: 7574 6564 2e73 6368 6564 756c 6572 2e64  uted.scheduler.d
-00026a40: 6173 6862 6f61 7264 2e73 7461 7475 732e  ashboard.status.
-00026a50: 7461 736b 2d73 7472 6561 6d2d 6c65 6e67  task-stream-leng
-00026a60: 7468 220a 2020 2020 2020 2020 292c 0a20  th".        ),. 
-00026a70: 2020 2020 2020 2063 6c65 6172 5f69 6e74         clear_int
-00026a80: 6572 7661 6c3d 2235 7322 2c0a 2020 2020  erval="5s",.    
-00026a90: 2020 2020 7369 7a69 6e67 5f6d 6f64 653d      sizing_mode=
-00026aa0: 2273 7472 6574 6368 5f62 6f74 6822 2c0a  "stretch_both",.
-00026ab0: 2020 2020 290a 2020 2020 7461 736b 5f73      ).    task_s
-00026ac0: 7472 6561 6d2e 7570 6461 7465 2829 0a20  tream.update(). 
-00026ad0: 2020 2061 6464 5f70 6572 696f 6469 635f     add_periodic_
-00026ae0: 6361 6c6c 6261 636b 2864 6f63 2c20 7461  callback(doc, ta
-00026af0: 736b 5f73 7472 6561 6d2c 2031 3030 290a  sk_stream, 100).
-00026b00: 2020 2020 646f 632e 6164 645f 726f 6f74      doc.add_root
-00026b10: 2874 6173 6b5f 7374 7265 616d 2e72 6f6f  (task_stream.roo
-00026b20: 7429 0a0a 2020 2020 7461 736b 5f70 726f  t)..    task_pro
-00026b30: 6772 6573 7320 3d20 5461 736b 5072 6f67  gress = TaskProg
-00026b40: 7265 7373 2873 6368 6564 756c 6572 2c20  ress(scheduler, 
-00026b50: 7369 7a69 6e67 5f6d 6f64 653d 2273 7472  sizing_mode="str
-00026b60: 6574 6368 5f62 6f74 6822 290a 2020 2020  etch_both").    
-00026b70: 7461 736b 5f70 726f 6772 6573 732e 7570  task_progress.up
-00026b80: 6461 7465 2829 0a20 2020 2061 6464 5f70  date().    add_p
-00026b90: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
-00026ba0: 2864 6f63 2c20 7461 736b 5f70 726f 6772  (doc, task_progr
-00026bb0: 6573 732c 2031 3030 290a 2020 2020 646f  ess, 100).    do
-00026bc0: 632e 6164 645f 726f 6f74 2874 6173 6b5f  c.add_root(task_
-00026bd0: 7072 6f67 7265 7373 2e72 6f6f 7429 0a0a  progress.root)..
-00026be0: 2020 2020 646f 632e 7469 746c 6520 3d20      doc.title = 
-00026bf0: 2244 6173 6b3a 2053 7461 7475 7322 0a20  "Dask: Status". 
-00026c00: 2020 2064 6f63 2e74 6865 6d65 203d 2042     doc.theme = B
-00026c10: 4f4b 4548 5f54 4845 4d45 0a20 2020 2064  OKEH_THEME.    d
-00026c20: 6f63 2e74 656d 706c 6174 6520 3d20 656e  oc.template = en
-00026c30: 762e 6765 745f 7465 6d70 6c61 7465 2822  v.get_template("
-00026c40: 7374 6174 7573 2e68 746d 6c22 290a 2020  status.html").  
-00026c50: 2020 646f 632e 7465 6d70 6c61 7465 5f76    doc.template_v
-00026c60: 6172 6961 626c 6573 2e75 7064 6174 6528  ariables.update(
-00026c70: 6578 7472 6129 0a0a 0a40 6375 7272 790a  extra)...@curry.
-00026c80: 6465 6620 696e 6469 7669 6475 616c 5f64  def individual_d
-00026c90: 6f63 2863 6c73 2c20 696e 7465 7276 616c  oc(cls, interval
-00026ca0: 2c20 7363 6865 6475 6c65 722c 2065 7874  , scheduler, ext
-00026cb0: 7261 2c20 646f 632c 2066 6967 5f61 7474  ra, doc, fig_att
-00026cc0: 723d 2272 6f6f 7422 2c20 2a2a 6b77 6172  r="root", **kwar
-00026cd0: 6773 293a 0a20 2020 2023 204e 6f74 653a  gs):.    # Note:
-00026ce0: 2040 6c6f 675f 6572 726f 7273 2061 6e64   @log_errors and
-00026cf0: 2040 6375 7272 7920 6172 6520 6e6f 7420   @curry are not 
-00026d00: 636f 6d70 6174 6962 6c65 0a20 2020 2077  compatible.    w
-00026d10: 6974 6820 6c6f 675f 6572 726f 7273 2829  ith log_errors()
-00026d20: 3a0a 2020 2020 2020 2020 6669 6720 3d20  :.        fig = 
-00026d30: 636c 7328 7363 6865 6475 6c65 722c 2073  cls(scheduler, s
-00026d40: 697a 696e 675f 6d6f 6465 3d22 7374 7265  izing_mode="stre
-00026d50: 7463 685f 626f 7468 222c 202a 2a6b 7761  tch_both", **kwa
-00026d60: 7267 7329 0a20 2020 2020 2020 2066 6967  rgs).        fig
-00026d70: 2e75 7064 6174 6528 290a 2020 2020 2020  .update().      
-00026d80: 2020 6164 645f 7065 7269 6f64 6963 5f63    add_periodic_c
-00026d90: 616c 6c62 6163 6b28 646f 632c 2066 6967  allback(doc, fig
-00026da0: 2c20 696e 7465 7276 616c 290a 2020 2020  , interval).    
-00026db0: 2020 2020 646f 632e 6164 645f 726f 6f74      doc.add_root
-00026dc0: 2867 6574 6174 7472 2866 6967 2c20 6669  (getattr(fig, fi
-00026dd0: 675f 6174 7472 2929 0a20 2020 2020 2020  g_attr)).       
-00026de0: 2064 6f63 2e74 6865 6d65 203d 2042 4f4b   doc.theme = BOK
-00026df0: 4548 5f54 4845 4d45 0a20 2020 2020 2020  EH_THEME.       
-00026e00: 2064 6f63 2e74 6974 6c65 203d 2022 4461   doc.title = "Da
-00026e10: 736b 3a20 2220 2b20 6675 6e63 6e61 6d65  sk: " + funcname
-00026e20: 2863 6c73 290a 0a0a 406c 6f67 5f65 7272  (cls)...@log_err
-00026e30: 6f72 730a 6465 6620 696e 6469 7669 6475  ors.def individu
-00026e40: 616c 5f70 726f 6669 6c65 5f64 6f63 2873  al_profile_doc(s
-00026e50: 6368 6564 756c 6572 2c20 6578 7472 612c  cheduler, extra,
-00026e60: 2064 6f63 293a 0a20 2020 2070 726f 6620   doc):.    prof 
-00026e70: 3d20 5072 6f66 696c 6554 696d 6550 6c6f  = ProfileTimePlo
-00026e80: 7428 7363 6865 6475 6c65 722c 2073 697a  t(scheduler, siz
-00026e90: 696e 675f 6d6f 6465 3d22 7374 7265 7463  ing_mode="stretc
-00026ea0: 685f 626f 7468 222c 2064 6f63 3d64 6f63  h_both", doc=doc
-00026eb0: 290a 2020 2020 646f 632e 6164 645f 726f  ).    doc.add_ro
-00026ec0: 6f74 2870 726f 662e 726f 6f74 290a 2020  ot(prof.root).  
-00026ed0: 2020 7072 6f66 2e74 7269 6767 6572 5f75    prof.trigger_u
-00026ee0: 7064 6174 6528 290a 2020 2020 646f 632e  pdate().    doc.
-00026ef0: 7468 656d 6520 3d20 424f 4b45 485f 5448  theme = BOKEH_TH
-00026f00: 454d 450a 0a0a 406c 6f67 5f65 7272 6f72  EME...@log_error
-00026f10: 730a 6465 6620 696e 6469 7669 6475 616c  s.def individual
-00026f20: 5f70 726f 6669 6c65 5f73 6572 7665 725f  _profile_server_
-00026f30: 646f 6328 7363 6865 6475 6c65 722c 2065  doc(scheduler, e
-00026f40: 7874 7261 2c20 646f 6329 3a0a 2020 2020  xtra, doc):.    
-00026f50: 7072 6f66 203d 2050 726f 6669 6c65 5365  prof = ProfileSe
-00026f60: 7276 6572 2873 6368 6564 756c 6572 2c20  rver(scheduler, 
-00026f70: 7369 7a69 6e67 5f6d 6f64 653d 2273 7472  sizing_mode="str
-00026f80: 6574 6368 5f62 6f74 6822 2c20 646f 633d  etch_both", doc=
-00026f90: 646f 6329 0a20 2020 2064 6f63 2e61 6464  doc).    doc.add
-00026fa0: 5f72 6f6f 7428 7072 6f66 2e72 6f6f 7429  _root(prof.root)
-00026fb0: 0a20 2020 2070 726f 662e 7472 6967 6765  .    prof.trigge
-00026fc0: 725f 7570 6461 7465 2829 0a20 2020 2064  r_update().    d
-00026fd0: 6f63 2e74 6865 6d65 203d 2042 4f4b 4548  oc.theme = BOKEH
-00026fe0: 5f54 4845 4d45 0a0a 0a40 6c6f 675f 6572  _THEME...@log_er
-00026ff0: 726f 7273 0a64 6566 2070 726f 6669 6c65  rors.def profile
-00027000: 5f64 6f63 2873 6368 6564 756c 6572 2c20  _doc(scheduler, 
-00027010: 6578 7472 612c 2064 6f63 293a 0a20 2020  extra, doc):.   
-00027020: 2064 6f63 2e74 6974 6c65 203d 2022 4461   doc.title = "Da
-00027030: 736b 3a20 5072 6f66 696c 6522 0a20 2020  sk: Profile".   
-00027040: 2070 726f 6620 3d20 5072 6f66 696c 6554   prof = ProfileT
-00027050: 696d 6550 6c6f 7428 7363 6865 6475 6c65  imePlot(schedule
-00027060: 722c 2073 697a 696e 675f 6d6f 6465 3d22  r, sizing_mode="
-00027070: 7374 7265 7463 685f 626f 7468 222c 2064  stretch_both", d
-00027080: 6f63 3d64 6f63 290a 2020 2020 646f 632e  oc=doc).    doc.
-00027090: 6164 645f 726f 6f74 2870 726f 662e 726f  add_root(prof.ro
-000270a0: 6f74 290a 2020 2020 646f 632e 7465 6d70  ot).    doc.temp
-000270b0: 6c61 7465 203d 2065 6e76 2e67 6574 5f74  late = env.get_t
-000270c0: 656d 706c 6174 6528 2273 696d 706c 652e  emplate("simple.
-000270d0: 6874 6d6c 2229 0a20 2020 2064 6f63 2e74  html").    doc.t
-000270e0: 656d 706c 6174 655f 7661 7269 6162 6c65  emplate_variable
-000270f0: 732e 7570 6461 7465 2865 7874 7261 290a  s.update(extra).
-00027100: 2020 2020 646f 632e 7468 656d 6520 3d20      doc.theme = 
-00027110: 424f 4b45 485f 5448 454d 450a 0a20 2020  BOKEH_THEME..   
-00027120: 2070 726f 662e 7472 6967 6765 725f 7570   prof.trigger_up
-00027130: 6461 7465 2829 0a0a 0a40 6c6f 675f 6572  date()...@log_er
-00027140: 726f 7273 0a64 6566 2070 726f 6669 6c65  rors.def profile
-00027150: 5f73 6572 7665 725f 646f 6328 7363 6865  _server_doc(sche
-00027160: 6475 6c65 722c 2065 7874 7261 2c20 646f  duler, extra, do
-00027170: 6329 3a0a 2020 2020 646f 632e 7469 746c  c):.    doc.titl
-00027180: 6520 3d20 2244 6173 6b3a 2050 726f 6669  e = "Dask: Profi
-00027190: 6c65 206f 6620 4576 656e 7420 4c6f 6f70  le of Event Loop
-000271a0: 220a 2020 2020 7072 6f66 203d 2050 726f  ".    prof = Pro
-000271b0: 6669 6c65 5365 7276 6572 2873 6368 6564  fileServer(sched
-000271c0: 756c 6572 2c20 7369 7a69 6e67 5f6d 6f64  uler, sizing_mod
-000271d0: 653d 2273 7472 6574 6368 5f62 6f74 6822  e="stretch_both"
-000271e0: 2c20 646f 633d 646f 6329 0a20 2020 2064  , doc=doc).    d
-000271f0: 6f63 2e61 6464 5f72 6f6f 7428 7072 6f66  oc.add_root(prof
-00027200: 2e72 6f6f 7429 0a20 2020 2064 6f63 2e74  .root).    doc.t
-00027210: 656d 706c 6174 6520 3d20 656e 762e 6765  emplate = env.ge
-00027220: 745f 7465 6d70 6c61 7465 2822 7369 6d70  t_template("simp
-00027230: 6c65 2e68 746d 6c22 290a 2020 2020 646f  le.html").    do
-00027240: 632e 7465 6d70 6c61 7465 5f76 6172 6961  c.template_varia
-00027250: 626c 6573 2e75 7064 6174 6528 6578 7472  bles.update(extr
-00027260: 6129 0a20 2020 2064 6f63 2e74 6865 6d65  a).    doc.theme
-00027270: 203d 2042 4f4b 4548 5f54 4845 4d45 0a0a   = BOKEH_THEME..
-00027280: 2020 2020 7072 6f66 2e74 7269 6767 6572      prof.trigger
-00027290: 5f75 7064 6174 6528 290a                 _update().
+0001c820: 7469 616c 5f63 6861 6e67 6520 3d20 4661  tial_change = Fa
+0001c830: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+0001c840: 7365 6c66 2e5f 7570 6461 7465 5f74 6173  self._update_tas
+0001c850: 6b5f 6578 6563 7574 696f 6e5f 6279 5f70  k_execution_by_p
+0001c860: 7265 6669 785f 6368 6172 7428 290a 2020  refix_chart().  
+0001c870: 2020 2020 2020 2020 2020 6669 6775 7265            figure
+0001c880: 735f 726f 7720 3d20 726f 7728 0a20 2020  s_row = row(.   
+0001c890: 2020 2020 2020 2020 2020 2020 2063 6869               chi
+0001c8a0: 6c64 7265 6e3d 5b0a 2020 2020 2020 2020  ldren=[.        
+0001c8b0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001c8c0: 2e74 6173 6b5f 6578 6563 5f62 795f 7072  .task_exec_by_pr
+0001c8d0: 6566 6978 5f63 6861 7274 2c0a 2020 2020  efix_chart,.    
+0001c8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c8f0: 7365 6c66 2e74 6173 6b5f 6578 6563 5f62  self.task_exec_b
+0001c900: 795f 6163 7469 7669 7479 5f63 6861 7274  y_activity_chart
+0001c910: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001c920: 2020 2020 2020 7365 6c66 2e67 6574 5f64        self.get_d
+0001c930: 6174 615f 6279 5f61 6374 6976 6974 795f  ata_by_activity_
+0001c940: 6368 6172 742c 0a20 2020 2020 2020 2020  chart,.         
+0001c950: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+0001c960: 2020 2020 2020 2020 2020 7369 7a69 6e67            sizing
+0001c970: 5f6d 6f64 653d 2273 7472 6574 6368 5f77  _mode="stretch_w
+0001c980: 6964 7468 222c 0a20 2020 2020 2020 2020  idth",.         
+0001c990: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+0001c9a0: 2020 6966 206e 6565 6473 5f66 6967 7572    if needs_figur
+0001c9b0: 6573 5f72 6f77 3a0a 2020 2020 2020 2020  es_row:.        
+0001c9c0: 2020 2020 2020 2020 2320 4669 7273 7420          # First 
+0001c9d0: 6974 6572 6174 696f 6e2c 2069 6e69 7469  iteration, initi
+0001c9e0: 616c 2061 7373 6967 6e6d 656e 7420 6f66  al assignment of
+0001c9f0: 2066 6967 7572 6573 2072 6f77 0a20 2020   figures row.   
+0001ca00: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0001ca10: 662e 726f 6f74 2e63 6869 6c64 7265 6e2e  f.root.children.
+0001ca20: 6170 7065 6e64 2866 6967 7572 6573 5f72  append(figures_r
+0001ca30: 6f77 290a 2020 2020 2020 2020 2020 2020  ow).            
+0001ca40: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0001ca50: 2020 2020 2020 2320 4f74 6865 7277 6973        # Otherwis
+0001ca60: 6520 6e65 6564 7320 666f 7263 6564 2072  e needs forced r
+0001ca70: 6566 7265 7368 2062 7920 7265 706c 6163  efresh by replac
+0001ca80: 696e 6720 7468 6520 6669 6775 7265 7320  ing the figures 
+0001ca90: 726f 770a 2020 2020 2020 2020 2020 2020  row.            
+0001caa0: 2020 2020 7365 6c66 2e72 6f6f 742e 6368      self.root.ch
+0001cab0: 696c 6472 656e 5b2d 315d 203d 2066 6967  ildren[-1] = fig
+0001cac0: 7572 6573 5f72 6f77 0a0a 2020 2020 6465  ures_row..    de
+0001cad0: 6620 5f75 7064 6174 655f 7365 6c65 6374  f _update_select
+0001cae0: 6f72 7328 7365 6c66 2920 2d3e 204e 6f6e  ors(self) -> Non
+0001caf0: 653a 0a20 2020 2020 2020 2022 2222 5570  e:.        """Up
+0001cb00: 6461 7465 2063 686f 6963 6573 2061 7661  date choices ava
+0001cb10: 696c 6162 6c65 2069 6e0a 0a20 2020 2020  ilable in..     
+0001cb20: 2020 202d 2073 656c 662e 756e 6974 5f73     - self.unit_s
+0001cb30: 656c 6563 746f 720a 2020 2020 2020 2020  elector.        
+0001cb40: 2d20 7365 6c66 2e66 756e 6374 696f 6e5f  - self.function_
+0001cb50: 7365 6c65 6374 6f72 0a20 2020 2020 2020  selector.       
+0001cb60: 202d 2073 656c 662e 7370 616e 5f74 6167   - self.span_tag
+0001cb70: 5f73 656c 6563 746f 720a 2020 2020 2020  _selector.      
+0001cb80: 2020 2222 220a 2020 2020 2020 2020 756e    """.        un
+0001cb90: 6974 7320 3d20 7365 7428 290a 2020 2020  its = set().    
+0001cba0: 2020 2020 6675 6e63 7469 6f6e 7320 3d20      functions = 
+0001cbb0: 7365 7428 290a 0a20 2020 2020 2020 2066  set()..        f
+0001cbc0: 6f72 206b 2069 6e20 7365 6c66 2e73 6368  or k in self.sch
+0001cbd0: 6564 756c 6572 2e63 756d 756c 6174 6976  eduler.cumulativ
+0001cbe0: 655f 776f 726b 6572 5f6d 6574 7269 6373  e_worker_metrics
+0001cbf0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0001cc00: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+0001cc10: 6b2c 2074 7570 6c65 293a 0a20 2020 2020  k, tuple):.     
+0001cc20: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+0001cc30: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
+0001cc40: 636f 6e74 6578 742c 202a 6f74 6865 722c  context, *other,
+0001cc50: 2061 6374 6976 6974 792c 2075 6e69 7420   activity, unit 
+0001cc60: 3d20 6b0a 0a20 2020 2020 2020 2020 2020  = k..           
+0001cc70: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
+0001cc80: 6365 2875 6e69 742c 2073 7472 290a 2020  ce(unit, str).  
+0001cc90: 2020 2020 2020 2020 2020 756e 6974 732e            units.
+0001cca0: 6164 6428 756e 6974 290a 0a20 2020 2020  add(unit)..     
+0001ccb0: 2020 2020 2020 2069 6620 636f 6e74 6578         if contex
+0001ccc0: 7420 3d3d 2022 6578 6563 7574 6522 3a0a  t == "execute":.
+0001ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cce0: 2866 756e 6374 696f 6e2c 2920 3d20 6f74  (function,) = ot
+0001ccf0: 6865 720a 2020 2020 2020 2020 2020 2020  her.            
+0001cd00: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+0001cd10: 7461 6e63 6528 6675 6e63 7469 6f6e 2c20  tance(function, 
+0001cd20: 7374 7229 0a20 2020 2020 2020 2020 2020  str).           
+0001cd30: 2020 2020 2066 756e 6374 696f 6e73 2e61       functions.a
+0001cd40: 6464 2866 756e 6374 696f 6e29 0a0a 2020  dd(function)..  
+0001cd50: 2020 2020 2020 756e 6974 732e 6469 6666        units.diff
+0001cd60: 6572 656e 6365 5f75 7064 6174 6528 7365  erence_update(se
+0001cd70: 6c66 2e75 6e69 745f 7365 6c65 6374 6f72  lf.unit_selector
+0001cd80: 2e6f 7074 696f 6e73 290a 2020 2020 2020  .options).      
+0001cd90: 2020 6966 2075 6e69 7473 3a0a 2020 2020    if units:.    
+0001cda0: 2020 2020 2020 2020 7365 6c66 2e75 6e69          self.uni
+0001cdb0: 745f 7365 6c65 6374 6f72 2e6f 7074 696f  t_selector.optio
+0001cdc0: 6e73 2e65 7874 656e 6428 756e 6974 7329  ns.extend(units)
+0001cdd0: 0a0a 2020 2020 2020 2020 6966 2066 756e  ..        if fun
+0001cde0: 6374 696f 6e73 3a0a 2020 2020 2020 2020  ctions:.        
+0001cdf0: 2020 2020 2320 4164 6465 6420 6f6e 2074      # Added on t
+0001ce00: 6865 2066 6c79 2062 7920 5370 616e 2e63  he fly by Span.c
+0001ce10: 756d 756c 6174 6976 655f 776f 726b 6572  umulative_worker
+0001ce20: 5f6d 6574 7269 6373 0a20 2020 2020 2020  _metrics.       
+0001ce30: 2020 2020 2066 756e 6374 696f 6e73 2e61       functions.a
+0001ce40: 6464 2822 4e2f 4122 290a 2020 2020 2020  dd("N/A").      
+0001ce50: 2020 6675 6e63 7469 6f6e 732e 6469 6666    functions.diff
+0001ce60: 6572 656e 6365 5f75 7064 6174 6528 7365  erence_update(se
+0001ce70: 6c66 2e66 756e 6374 696f 6e5f 7365 6c65  lf.function_sele
+0001ce80: 6374 6f72 2e6f 7074 696f 6e73 290a 2020  ctor.options).  
+0001ce90: 2020 2020 2020 6966 2066 756e 6374 696f        if functio
+0001cea0: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+0001ceb0: 7365 6c66 2e66 756e 6374 696f 6e5f 7365  self.function_se
+0001cec0: 6c65 6374 6f72 2e6f 7074 696f 6e73 2e65  lector.options.e
+0001ced0: 7874 656e 6428 6675 6e63 7469 6f6e 7329  xtend(functions)
+0001cee0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0001cef0: 662e 6675 6e63 7469 6f6e 5f73 656c 6563  f.function_selec
+0001cf00: 746f 722e 7469 746c 6520 3d20 280a 2020  tor.title = (.  
+0001cf10: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0001cf20: 4669 6c74 6572 2062 7920 6675 6e63 7469  Filter by functi
+0001cf30: 6f6e 2028 7b6c 656e 2873 656c 662e 6675  on ({len(self.fu
+0001cf40: 6e63 7469 6f6e 5f73 656c 6563 746f 722e  nction_selector.
+0001cf50: 6f70 7469 6f6e 7329 7d29 3a22 0a20 2020  options)}):".   
+0001cf60: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+0001cf70: 2020 2020 7370 616e 735f 6578 743a 2053      spans_ext: S
+0001cf80: 7061 6e73 5363 6865 6475 6c65 7245 7874  pansSchedulerExt
+0001cf90: 656e 7369 6f6e 207c 204e 6f6e 6520 3d20  ension | None = 
+0001cfa0: 7365 6c66 2e73 6368 6564 756c 6572 2e65  self.scheduler.e
+0001cfb0: 7874 656e 7369 6f6e 732e 6765 7428 0a20  xtensions.get(. 
+0001cfc0: 2020 2020 2020 2020 2020 2022 7370 616e             "span
+0001cfd0: 7322 0a20 2020 2020 2020 2029 0a20 2020  s".        ).   
+0001cfe0: 2020 2020 2069 6620 7370 616e 735f 6578       if spans_ex
+0001cff0: 743a 0a20 2020 2020 2020 2020 2020 2074  t:.            t
+0001d000: 6167 7320 3d20 7365 7428 7370 616e 735f  ags = set(spans_
+0001d010: 6578 742e 7370 616e 735f 7365 6172 6368  ext.spans_search
+0001d020: 5f62 795f 7461 6729 0a20 2020 2020 2020  _by_tag).       
+0001d030: 2020 2020 2074 6167 732e 6469 6666 6572       tags.differ
+0001d040: 656e 6365 5f75 7064 6174 6528 7365 6c66  ence_update(self
+0001d050: 2e73 7061 6e5f 7461 675f 7365 6c65 6374  .span_tag_select
+0001d060: 6f72 2e6f 7074 696f 6e73 290a 2020 2020  or.options).    
+0001d070: 2020 2020 2020 2020 6966 2074 6167 733a          if tags:
+0001d080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d090: 2073 656c 662e 7370 616e 5f74 6167 5f73   self.span_tag_s
+0001d0a0: 656c 6563 746f 722e 6f70 7469 6f6e 732e  elector.options.
+0001d0b0: 6578 7465 6e64 2874 6167 7329 0a20 2020  extend(tags).   
+0001d0c0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0001d0d0: 662e 7370 616e 5f74 6167 5f73 656c 6563  f.span_tag_selec
+0001d0e0: 746f 722e 7469 746c 6520 3d20 280a 2020  tor.title = (.  
+0001d0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d100: 2020 6622 4669 6c74 6572 2062 7920 7370    f"Filter by sp
+0001d110: 616e 2074 6167 2028 7b6c 656e 2873 656c  an tag ({len(sel
+0001d120: 662e 7370 616e 5f74 6167 5f73 656c 6563  f.span_tag_selec
+0001d130: 746f 722e 6f70 7469 6f6e 7329 7d29 3a22  tor.options)}):"
+0001d140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d150: 2029 0a0a 2020 2020 6465 6620 5f66 6f72   )..    def _for
+0001d160: 6d61 7428 7365 6c66 2c20 7661 6c3a 2066  mat(self, val: f
+0001d170: 6c6f 6174 2920 2d3e 2073 7472 3a0a 2020  loat) -> str:.  
+0001d180: 2020 2020 2020 756e 6974 203d 2073 656c        unit = sel
+0001d190: 662e 756e 6974 5f73 656c 6563 746f 722e  f.unit_selector.
+0001d1a0: 7661 6c75 650a 2020 2020 2020 2020 6173  value.        as
+0001d1b0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+0001d1c0: 756e 6974 2c20 7374 7229 0a20 2020 2020  unit, str).     
+0001d1d0: 2020 2069 6620 756e 6974 203d 3d20 2273     if unit == "s
+0001d1e0: 6563 6f6e 6473 223a 0a20 2020 2020 2020  econds":.       
+0001d1f0: 2020 2020 2072 6574 7572 6e20 666f 726d       return form
+0001d200: 6174 5f74 696d 6528 7661 6c29 0a20 2020  at_time(val).   
+0001d210: 2020 2020 2065 6c69 6620 756e 6974 203d       elif unit =
+0001d220: 3d20 2262 7974 6573 223a 0a20 2020 2020  = "bytes":.     
+0001d230: 2020 2020 2020 2072 6574 7572 6e20 666f         return fo
+0001d240: 726d 6174 5f62 7974 6573 2869 6e74 2876  rmat_bytes(int(v
+0001d250: 616c 2929 0a20 2020 2020 2020 2023 2063  al)).        # c
+0001d260: 6f75 6e74 206f 7220 6375 7374 6f6d 2075  ount or custom u
+0001d270: 7365 722d 6465 6669 6e65 6420 6d65 7472  ser-defined metr
+0001d280: 6963 0a20 2020 2020 2020 2065 6c69 6620  ic.        elif 
+0001d290: 2869 7661 6c20 3a3d 2069 6e74 2876 616c  (ival := int(val
+0001d2a0: 2929 203d 3d20 7661 6c3a 0a20 2020 2020  )) == val:.     
+0001d2b0: 2020 2020 2020 2072 6574 7572 6e20 7374         return st
+0001d2c0: 7228 6976 616c 290a 2020 2020 2020 2020  r(ival).        
+0001d2d0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0001d2e0: 2020 7265 7475 726e 2073 7472 2876 616c    return str(val
+0001d2f0: 290a 0a20 2020 2064 6566 205f 6765 745f  )..    def _get_
+0001d300: 7061 6c65 7474 6528 7365 6c66 2920 2d3e  palette(self) ->
+0001d310: 206c 6973 745b 7374 725d 3a0a 2020 2020   list[str]:.    
+0001d320: 2020 2020 6e20 3d20 6c65 6e28 7365 6c66      n = len(self
+0001d330: 2e76 6973 6962 6c65 5f61 6374 6976 6974  .visible_activit
+0001d340: 6965 7329 0a20 2020 2020 2020 2074 7279  ies).        try
+0001d350: 3a0a 2020 2020 2020 2020 2020 2020 6672  :.            fr
+0001d360: 6f6d 2062 6f6b 6568 2e70 616c 6574 7465  om bokeh.palette
+0001d370: 7320 696d 706f 7274 2069 6e74 6572 705f  s import interp_
+0001d380: 7061 6c65 7474 650a 0a20 2020 2020 2020  palette..       
+0001d390: 2020 2020 2072 6574 7572 6e20 6c69 7374       return list
+0001d3a0: 2869 6e74 6572 705f 7061 6c65 7474 6528  (interp_palette(
+0001d3b0: 5669 7269 6469 7331 312c 206e 2929 0a20  Viridis11, n)). 
+0001d3c0: 2020 2020 2020 2065 7863 6570 7420 496d         except Im
+0001d3d0: 706f 7274 4572 726f 723a 0a20 2020 2020  portError:.     
+0001d3e0: 2020 2020 2020 2023 2042 6f6b 6568 2032         # Bokeh 2
+0001d3f0: 2e34 0a20 2020 2020 2020 2020 2020 2072  .4.            r
+0001d400: 6574 7572 6e20 5b56 6972 6964 6973 3131  eturn [Viridis11
+0001d410: 5b69 2025 206c 656e 2856 6972 6964 6973  [i % len(Viridis
+0001d420: 3131 295d 2066 6f72 2069 2069 6e20 7261  11)] for i in ra
+0001d430: 6e67 6528 6e29 5d0a 0a20 2020 2064 6566  nge(n)]..    def
+0001d440: 205f 6275 696c 645f 6461 7461 5f73 6f75   _build_data_sou
+0001d450: 7263 6573 2873 656c 6629 202d 3e20 4e6f  rces(self) -> No
+0001d460: 6e65 3a0a 2020 2020 2020 2020 2222 2250  ne:.        """P
+0001d470: 7265 2d70 726f 6365 7373 2061 6e64 2066  re-process and f
+0001d480: 696c 7465 7220 6669 6e65 2070 6572 666f  ilter fine perfo
+0001d490: 726d 616e 6365 206d 6574 7269 6373 3b20  rmance metrics; 
+0001d4a0: 6275 696c 6420 6461 7461 2074 6162 6c65  build data table
+0001d4b0: 7320 696e 0a20 2020 2020 2020 2042 6f6b  s in.        Bok
+0001d4c0: 6568 2066 6f72 6d61 740a 0a20 2020 2020  eh format..     
+0001d4d0: 2020 2055 7064 6174 6573 3a0a 0a20 2020     Updates:..   
+0001d4e0: 2020 2020 202d 2073 656c 662e 7375 6273       - self.subs
+0001d4f0: 7461 6e74 6961 6c5f 6368 616e 6765 0a20  tantial_change. 
+0001d500: 2020 2020 2020 202d 2073 656c 662e 7669         - self.vi
+0001d510: 7369 626c 655f 6163 7469 7669 7469 6573  sible_activities
+0001d520: 0a20 2020 2020 2020 202d 2073 656c 662e  .        - self.
+0001d530: 7669 7369 626c 655f 6675 6e63 7469 6f6e  visible_function
+0001d540: 730a 2020 2020 2020 2020 2d20 7365 6c66  s.        - self
+0001d550: 2e74 6173 6b5f 6578 6563 5f62 795f 7072  .task_exec_by_pr
+0001d560: 6566 6978 5f73 7263 2e64 6174 610a 2020  efix_src.data.  
+0001d570: 2020 2020 2020 2d20 7365 6c66 2e74 6173        - self.tas
+0001d580: 6b5f 6578 6563 5f62 795f 6163 7469 7669  k_exec_by_activi
+0001d590: 7479 5f73 7263 2e64 6174 610a 2020 2020  ty_src.data.    
+0001d5a0: 2020 2020 2d20 7365 6c66 2e67 6574 5f64      - self.get_d
+0001d5b0: 6174 615f 6279 5f61 6374 6976 6974 795f  ata_by_activity_
+0001d5c0: 7372 632e 6461 7461 0a20 2020 2020 2020  src.data.       
+0001d5d0: 2022 2222 0a20 2020 2020 2020 2076 6973   """.        vis
+0001d5e0: 6962 6c65 5f66 756e 6374 696f 6e73 203d  ible_functions =
+0001d5f0: 2073 6574 2829 0a20 2020 2020 2020 2076   set().        v
+0001d600: 6973 6962 6c65 5f61 6374 6976 6974 6965  isible_activitie
+0001d610: 7320 3d20 7365 7428 290a 2020 2020 2020  s = set().      
+0001d620: 2020 6578 6563 7574 655f 6279 5f66 756e    execute_by_fun
+0001d630: 633a 2064 6566 6175 6c74 6469 6374 5b74  c: defaultdict[t
+0001d640: 7570 6c65 5b73 7472 2c20 7374 725d 2c20  uple[str, str], 
+0001d650: 666c 6f61 745d 203d 2064 6566 6175 6c74  float] = default
+0001d660: 6469 6374 2866 6c6f 6174 290a 2020 2020  dict(float).    
+0001d670: 2020 2020 6578 6563 7574 653a 2064 6566      execute: def
+0001d680: 6175 6c74 6469 6374 5b73 7472 2c20 666c  aultdict[str, fl
+0001d690: 6f61 745d 203d 2064 6566 6175 6c74 6469  oat] = defaultdi
+0001d6a0: 6374 2866 6c6f 6174 290a 2020 2020 2020  ct(float).      
+0001d6b0: 2020 6765 745f 6461 7461 3a20 6465 6661    get_data: defa
+0001d6c0: 756c 7464 6963 745b 7374 722c 2066 6c6f  ultdict[str, flo
+0001d6d0: 6174 5d20 3d20 6465 6661 756c 7464 6963  at] = defaultdic
+0001d6e0: 7428 666c 6f61 7429 0a0a 2020 2020 2020  t(float)..      
+0001d6f0: 2020 6675 6e63 7469 6f6e 5f73 656c 203d    function_sel =
+0001d700: 2073 6574 2873 656c 662e 6675 6e63 7469   set(self.functi
+0001d710: 6f6e 5f73 656c 6563 746f 722e 7661 6c75  on_selector.valu
+0001d720: 6529 0a0a 2020 2020 2020 2020 7370 616e  e)..        span
+0001d730: 735f 6578 743a 2053 7061 6e73 5363 6865  s_ext: SpansSche
+0001d740: 6475 6c65 7245 7874 656e 7369 6f6e 207c  dulerExtension |
+0001d750: 204e 6f6e 6520 3d20 7365 6c66 2e73 6368   None = self.sch
+0001d760: 6564 756c 6572 2e65 7874 656e 7369 6f6e  eduler.extension
+0001d770: 732e 6765 7428 0a20 2020 2020 2020 2020  s.get(.         
+0001d780: 2020 2022 7370 616e 7322 0a20 2020 2020     "spans".     
+0001d790: 2020 2029 0a20 2020 2020 2020 2069 6620     ).        if 
+0001d7a0: 7370 616e 735f 6578 7420 616e 6420 7365  spans_ext and se
+0001d7b0: 6c66 2e73 7061 6e5f 7461 675f 7365 6c65  lf.span_tag_sele
+0001d7c0: 6374 6f72 2e76 616c 7565 3a0a 2020 2020  ctor.value:.    
+0001d7d0: 2020 2020 2020 2020 7370 616e 203d 2073          span = s
+0001d7e0: 7061 6e73 5f65 7874 2e6d 6572 6765 5f62  pans_ext.merge_b
+0001d7f0: 795f 7461 6773 282a 7365 6c66 2e73 7061  y_tags(*self.spa
+0001d800: 6e5f 7461 675f 7365 6c65 6374 6f72 2e76  n_tag_selector.v
+0001d810: 616c 7565 290a 2020 2020 2020 2020 2020  alue).          
+0001d820: 2020 6578 6563 7574 655f 6d65 7472 6963    execute_metric
+0001d830: 7320 3d20 7370 616e 2e63 756d 756c 6174  s = span.cumulat
+0001d840: 6976 655f 776f 726b 6572 5f6d 6574 7269  ive_worker_metri
+0001d850: 6373 0a20 2020 2020 2020 2065 6c69 6620  cs.        elif 
+0001d860: 7370 616e 735f 6578 7420 616e 6420 7370  spans_ext and sp
+0001d870: 616e 735f 6578 742e 7370 616e 733a 0a20  ans_ext.spans:. 
+0001d880: 2020 2020 2020 2020 2020 2023 2043 616c             # Cal
+0001d890: 6375 6c61 7465 2069 646c 6520 7469 6d65  culate idle time
+0001d8a0: 0a20 2020 2020 2020 2020 2020 2073 7061  .            spa
+0001d8b0: 6e20 3d20 7370 616e 735f 6578 742e 6d65  n = spans_ext.me
+0001d8c0: 7267 655f 616c 6c28 290a 2020 2020 2020  rge_all().      
+0001d8d0: 2020 2020 2020 6578 6563 7574 655f 6d65        execute_me
+0001d8e0: 7472 6963 7320 3d20 7370 616e 2e63 756d  trics = span.cum
+0001d8f0: 756c 6174 6976 655f 776f 726b 6572 5f6d  ulative_worker_m
+0001d900: 6574 7269 6373 0a20 2020 2020 2020 2065  etrics.        e
+0001d910: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001d920: 2023 2053 7061 6e73 2065 7874 656e 7369   # Spans extensi
+0001d930: 6f6e 2069 7320 6e6f 7420 6c6f 6164 6564  on is not loaded
+0001d940: 0a20 2020 2020 2020 2020 2020 2065 7865  .            exe
+0001d950: 6375 7465 5f6d 6574 7269 6373 203d 207b  cute_metrics = {
+0001d960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d970: 206b 3a20 760a 2020 2020 2020 2020 2020   k: v.          
+0001d980: 2020 2020 2020 666f 7220 6b2c 2076 2069        for k, v i
+0001d990: 6e20 7365 6c66 2e73 6368 6564 756c 6572  n self.scheduler
+0001d9a0: 2e63 756d 756c 6174 6976 655f 776f 726b  .cumulative_work
+0001d9b0: 6572 5f6d 6574 7269 6373 2e69 7465 6d73  er_metrics.items
+0001d9c0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0001d9d0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+0001d9e0: 286b 2c20 7475 706c 6529 2061 6e64 206b  (k, tuple) and k
+0001d9f0: 5b30 5d20 3d3d 2022 6578 6563 7574 6522  [0] == "execute"
+0001da00: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
+0001da10: 2020 2020 2020 2020 666f 7220 2863 6f6e          for (con
+0001da20: 7465 7874 2c20 6675 6e63 7469 6f6e 2c20  text, function, 
+0001da30: 6163 7469 7669 7479 2c20 756e 6974 292c  activity, unit),
+0001da40: 2076 2069 6e20 6578 6563 7574 655f 6d65   v in execute_me
+0001da50: 7472 6963 732e 6974 656d 7328 293a 0a20  trics.items():. 
+0001da60: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0001da70: 7420 636f 6e74 6578 7420 3d3d 2022 6578  t context == "ex
+0001da80: 6563 7574 6522 0a20 2020 2020 2020 2020  ecute".         
+0001da90: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
+0001daa0: 616e 6365 2866 756e 6374 696f 6e2c 2073  ance(function, s
+0001dab0: 7472 290a 2020 2020 2020 2020 2020 2020  tr).            
+0001dac0: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+0001dad0: 6528 756e 6974 2c20 7374 7229 0a20 2020  e(unit, str).   
+0001dae0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0001daf0: 7365 6c66 2e75 6e69 745f 7365 6c65 6374  self.unit_select
+0001db00: 6f72 2e76 616c 7565 0a20 2020 2020 2020  or.value.       
+0001db10: 2020 2020 2069 6620 756e 6974 2021 3d20       if unit != 
+0001db20: 7365 6c66 2e75 6e69 745f 7365 6c65 6374  self.unit_select
+0001db30: 6f72 2e76 616c 7565 3a0a 2020 2020 2020  or.value:.      
+0001db40: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+0001db50: 7565 0a20 2020 2020 2020 2020 2020 2069  ue.            i
+0001db60: 6620 6675 6e63 7469 6f6e 5f73 656c 2061  f function_sel a
+0001db70: 6e64 2066 756e 6374 696f 6e20 6e6f 7420  nd function not 
+0001db80: 696e 2066 756e 6374 696f 6e5f 7365 6c3a  in function_sel:
+0001db90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001dba0: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
+0001dbb0: 2020 2020 2020 2023 2043 7573 746f 6d20         # Custom 
+0001dbc0: 6d65 7472 6963 7320 776f 6e27 7420 6e65  metrics won't ne
+0001dbd0: 6365 7373 6172 696c 7920 636f 6e74 6169  cessarily contai
+0001dbe0: 6e20 6120 7374 7269 6e67 2061 7320 7468  n a string as th
+0001dbf0: 6520 6c61 6265 6c0a 2020 2020 2020 2020  e label.        
+0001dc00: 2020 2020 6163 7469 7669 7479 203d 2073      activity = s
+0001dc10: 7472 2861 6374 6976 6974 7929 0a20 2020  tr(activity).   
+0001dc20: 2020 2020 2020 2020 2065 7865 6375 7465           execute
+0001dc30: 5f62 795f 6675 6e63 5b66 756e 6374 696f  _by_func[functio
+0001dc40: 6e2c 2061 6374 6976 6974 795d 202b 3d20  n, activity] += 
+0001dc50: 760a 2020 2020 2020 2020 2020 2020 6578  v.            ex
+0001dc60: 6563 7574 655b 6163 7469 7669 7479 5d20  ecute[activity] 
+0001dc70: 2b3d 2076 0a20 2020 2020 2020 2020 2020  += v.           
+0001dc80: 2076 6973 6962 6c65 5f66 756e 6374 696f   visible_functio
+0001dc90: 6e73 2e61 6464 2866 756e 6374 696f 6e29  ns.add(function)
+0001dca0: 0a20 2020 2020 2020 2020 2020 2076 6973  .            vis
+0001dcb0: 6962 6c65 5f61 6374 6976 6974 6965 732e  ible_activities.
+0001dcc0: 6164 6428 6163 7469 7669 7479 290a 0a20  add(activity).. 
+0001dcd0: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
+0001dce0: 6c66 2e66 756e 6374 696f 6e5f 7365 6c65  lf.function_sele
+0001dcf0: 6374 6f72 2e76 616c 7565 2061 6e64 206e  ctor.value and n
+0001dd00: 6f74 2073 656c 662e 7370 616e 5f74 6167  ot self.span_tag
+0001dd10: 5f73 656c 6563 746f 722e 7661 6c75 653a  _selector.value:
+0001dd20: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0001dd30: 206b 2c20 7620 696e 2073 656c 662e 7363   k, v in self.sc
+0001dd40: 6865 6475 6c65 722e 6375 6d75 6c61 7469  heduler.cumulati
+0001dd50: 7665 5f77 6f72 6b65 725f 6d65 7472 6963  ve_worker_metric
+0001dd60: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
+0001dd70: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+0001dd80: 696e 7374 616e 6365 286b 2c20 7475 706c  instance(k, tupl
+0001dd90: 6529 2061 6e64 206b 5b30 5d20 3d3d 2022  e) and k[0] == "
+0001dda0: 6765 742d 6461 7461 223a 0a20 2020 2020  get-data":.     
+0001ddb0: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+0001ddc0: 2c20 6163 7469 7669 7479 2c20 756e 6974  , activity, unit
+0001ddd0: 203d 206b 0a20 2020 2020 2020 2020 2020   = k.           
+0001dde0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0001ddf0: 6973 696e 7374 616e 6365 2861 6374 6976  isinstance(activ
+0001de00: 6974 792c 2073 7472 290a 2020 2020 2020  ity, str).      
+0001de10: 2020 2020 2020 2020 2020 2020 2020 6173                as
+0001de20: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+0001de30: 756e 6974 2c20 7374 7229 0a20 2020 2020  unit, str).     
+0001de40: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0001de50: 7373 6572 7420 7365 6c66 2e75 6e69 745f  ssert self.unit_
+0001de60: 7365 6c65 6374 6f72 2e76 616c 7565 0a20  selector.value. 
+0001de70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001de80: 2020 2069 6620 756e 6974 203d 3d20 7365     if unit == se
+0001de90: 6c66 2e75 6e69 745f 7365 6c65 6374 6f72  lf.unit_selector
+0001dea0: 2e76 616c 7565 3a0a 2020 2020 2020 2020  .value:.        
+0001deb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dec0: 7669 7369 626c 655f 6163 7469 7669 7469  visible_activiti
+0001ded0: 6573 2e61 6464 2861 6374 6976 6974 7929  es.add(activity)
+0001dee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001def0: 2020 2020 2020 2020 2067 6574 5f64 6174           get_dat
+0001df00: 615b 6163 7469 7669 7479 5d20 2b3d 2076  a[activity] += v
+0001df10: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0001df20: 4967 6e6f 7265 206d 656d 6f72 792d 6d6f  Ignore memory-mo
+0001df30: 6e69 746f 7220 616e 6420 6761 7468 6572  nitor and gather
+0001df40: 2d64 6570 206d 6574 7269 6373 0a0a 2020  -dep metrics..  
+0001df50: 2020 2020 2020 6966 2076 6973 6962 6c65        if visible
+0001df60: 5f66 756e 6374 696f 6e73 2021 3d20 7365  _functions != se
+0001df70: 7428 7365 6c66 2e76 6973 6962 6c65 5f66  t(self.visible_f
+0001df80: 756e 6374 696f 6e73 293a 0a20 2020 2020  unctions):.     
+0001df90: 2020 2020 2020 2073 656c 662e 7375 6273         self.subs
+0001dfa0: 7461 6e74 6961 6c5f 6368 616e 6765 203d  tantial_change =
+0001dfb0: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
+0001dfc0: 2020 7365 6c66 2e76 6973 6962 6c65 5f66    self.visible_f
+0001dfd0: 756e 6374 696f 6e73 203d 2073 6f72 7465  unctions = sorte
+0001dfe0: 6428 7669 7369 626c 655f 6675 6e63 7469  d(visible_functi
+0001dff0: 6f6e 7329 0a0a 2020 2020 2020 2020 6966  ons)..        if
+0001e000: 2076 6973 6962 6c65 5f61 6374 6976 6974   visible_activit
+0001e010: 6965 7320 213d 2073 6574 2873 656c 662e  ies != set(self.
+0001e020: 7669 7369 626c 655f 6163 7469 7669 7469  visible_activiti
+0001e030: 6573 293a 0a20 2020 2020 2020 2020 2020  es):.           
+0001e040: 2073 656c 662e 7375 6273 7461 6e74 6961   self.substantia
+0001e050: 6c5f 6368 616e 6765 203d 2054 7275 650a  l_change = True.
+0001e060: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001e070: 2e76 6973 6962 6c65 5f61 6374 6976 6974  .visible_activit
+0001e080: 6965 7320 3d20 736f 7274 6564 2876 6973  ies = sorted(vis
+0001e090: 6962 6c65 5f61 6374 6976 6974 6965 7329  ible_activities)
+0001e0a0: 0a0a 2020 2020 2020 2020 280a 2020 2020  ..        (.    
+0001e0b0: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
+0001e0c0: 6b5f 6578 6563 5f62 795f 7072 6566 6978  k_exec_by_prefix
+0001e0d0: 5f73 7263 2e64 6174 612c 0a20 2020 2020  _src.data,.     
+0001e0e0: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
+0001e0f0: 5f65 7865 635f 6279 5f70 7265 6669 785f  _exec_by_prefix_
+0001e100: 796d 6178 2c0a 2020 2020 2020 2020 2920  ymax,.        ) 
+0001e110: 3d20 7365 6c66 2e5f 6275 696c 645f 7461  = self._build_ta
+0001e120: 736b 5f65 7865 6375 7469 6f6e 5f62 795f  sk_execution_by_
+0001e130: 7072 6566 6978 5f64 6174 6128 6578 6563  prefix_data(exec
+0001e140: 7574 655f 6279 5f66 756e 6329 0a20 2020  ute_by_func).   
+0001e150: 2020 2020 2073 656c 662e 7461 736b 5f65       self.task_e
+0001e160: 7865 635f 6279 5f61 6374 6976 6974 795f  xec_by_activity_
+0001e170: 7372 632e 6461 7461 203d 2073 656c 662e  src.data = self.
+0001e180: 5f62 7569 6c64 5f70 6965 5f64 6174 6128  _build_pie_data(
+0001e190: 6578 6563 7574 6529 0a20 2020 2020 2020  execute).       
+0001e1a0: 2073 656c 662e 6765 745f 6461 7461 5f62   self.get_data_b
+0001e1b0: 795f 6163 7469 7669 7479 5f73 7263 2e64  y_activity_src.d
+0001e1c0: 6174 6120 3d20 7365 6c66 2e5f 6275 696c  ata = self._buil
+0001e1d0: 645f 7069 655f 6461 7461 2867 6574 5f64  d_pie_data(get_d
+0001e1e0: 6174 6129 0a0a 2020 2020 6465 6620 5f62  ata)..    def _b
+0001e1f0: 7569 6c64 5f70 6965 5f64 6174 6128 7365  uild_pie_data(se
+0001e200: 6c66 2c20 6461 7461 3a20 6465 6661 756c  lf, data: defaul
+0001e210: 7464 6963 745b 7374 722c 2066 6c6f 6174  tdict[str, float
+0001e220: 5d29 202d 3e20 6469 6374 5b73 7472 2c20  ]) -> dict[str, 
+0001e230: 6c69 7374 5d3a 0a20 2020 2020 2020 2022  list]:.        "
+0001e240: 2222 4275 696c 6420 7468 6520 6461 7461  ""Build the data
+0001e250: 2073 6f75 7263 6520 666f 7220 6120 7069   source for a pi
+0001e260: 6520 6368 6172 7420 6279 2061 6374 6976  e chart by activ
+0001e270: 6974 790a 0a20 2020 2020 2020 2053 6565  ity..        See
+0001e280: 2061 6c73 6f0a 2020 2020 2020 2020 2d2d   also.        --
+0001e290: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 205f  ------.        _
+0001e2a0: 6275 696c 645f 7069 655f 6368 6172 740a  build_pie_chart.
+0001e2b0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0001e2c0: 2020 2020 746f 7461 6c5f 7661 6c75 6520      total_value 
+0001e2d0: 3d20 7375 6d28 6461 7461 2e76 616c 7565  = sum(data.value
+0001e2e0: 7328 2929 0a20 2020 2020 2020 2070 6572  s()).        per
+0001e2f0: 6365 6e74 5f6b 203d 2031 3030 2e30 202f  cent_k = 100.0 /
+0001e300: 2074 6f74 616c 5f76 616c 7565 2069 6620   total_value if 
+0001e310: 746f 7461 6c5f 7661 6c75 6520 656c 7365  total_value else
+0001e320: 2030 2e30 0a20 2020 2020 2020 2061 6e67   0.0.        ang
+0001e330: 6c65 5f6b 203d 2032 2e30 202a 206d 6174  le_k = 2.0 * mat
+0001e340: 682e 7069 202f 2074 6f74 616c 5f76 616c  h.pi / total_val
+0001e350: 7565 2069 6620 746f 7461 6c5f 7661 6c75  ue if total_valu
+0001e360: 6520 656c 7365 2030 2e30 0a20 2020 2020  e else 0.0.     
+0001e370: 2020 2061 6374 6976 6974 6965 7320 3d20     activities = 
+0001e380: 7365 6c66 2e76 6973 6962 6c65 5f61 6374  self.visible_act
+0001e390: 6976 6974 6965 730a 2020 2020 2020 2020  ivities.        
+0001e3a0: 7661 6c75 6573 203d 205b 6461 7461 5b61  values = [data[a
+0001e3b0: 6374 6976 6974 795d 2066 6f72 2061 6374  ctivity] for act
+0001e3c0: 6976 6974 7920 696e 2061 6374 6976 6974  ivity in activit
+0001e3d0: 6965 735d 0a20 2020 2020 2020 2074 6f74  ies].        tot
+0001e3e0: 616c 5f74 6578 7420 3d20 7365 6c66 2e5f  al_text = self._
+0001e3f0: 666f 726d 6174 2873 756d 2876 616c 7565  format(sum(value
+0001e400: 7329 290a 2020 2020 2020 2020 7265 7475  s)).        retu
+0001e410: 726e 207b 0a20 2020 2020 2020 2020 2020  rn {.           
+0001e420: 2022 6163 7469 7669 7479 223a 2061 6374   "activity": act
+0001e430: 6976 6974 6965 732c 0a20 2020 2020 2020  ivities,.       
+0001e440: 2020 2020 2022 7661 6c75 6522 3a20 7661       "value": va
+0001e450: 6c75 6573 2c0a 2020 2020 2020 2020 2020  lues,.          
+0001e460: 2020 2274 6578 7422 3a20 5b73 656c 662e    "text": [self.
+0001e470: 5f66 6f72 6d61 7428 7629 202b 2066 2220  _format(v) + f" 
+0001e480: 287b 7620 2a20 7065 7263 656e 745f 6b3a  ({v * percent_k:
+0001e490: 2e30 667d 2529 2220 666f 7220 7620 696e  .0f}%)" for v in
+0001e4a0: 2076 616c 7565 735d 2c0a 2020 2020 2020   values],.      
+0001e4b0: 2020 2020 2020 2261 6e67 6c65 223a 205b        "angle": [
+0001e4c0: 7620 2a20 616e 676c 655f 6b20 666f 7220  v * angle_k for 
+0001e4d0: 7620 696e 2076 616c 7565 735d 2c0a 2020  v in values],.  
+0001e4e0: 2020 2020 2020 2020 2020 2263 6f6c 6f72            "color
+0001e4f0: 223a 2073 656c 662e 5f67 6574 5f70 616c  ": self._get_pal
+0001e500: 6574 7465 2829 2c0a 2020 2020 2020 2020  ette(),.        
+0001e510: 2020 2020 2274 6f74 616c 5f74 6578 7422      "total_text"
+0001e520: 3a20 5b74 6f74 616c 5f74 6578 745d 202a  : [total_text] *
+0001e530: 206c 656e 2876 616c 7565 7329 2c0a 2020   len(values),.  
+0001e540: 2020 2020 2020 7d0a 0a20 2020 2064 6566        }..    def
+0001e550: 205f 6275 696c 645f 7069 655f 6368 6172   _build_pie_char
+0001e560: 7428 7365 6c66 2c20 736f 7572 6365 3a20  t(self, source: 
+0001e570: 436f 6c75 6d6e 4461 7461 536f 7572 6365  ColumnDataSource
+0001e580: 2c20 7469 746c 653a 2073 7472 2920 2d3e  , title: str) ->
+0001e590: 2066 6967 7572 653a 0a20 2020 2020 2020   figure:.       
+0001e5a0: 2022 2222 4372 6561 7465 2070 6965 2063   """Create pie c
+0001e5b0: 6861 7274 2062 7920 6163 7469 7669 7479  hart by activity
+0001e5c0: 0a0a 2020 2020 2020 2020 5365 6520 616c  ..        See al
+0001e5d0: 736f 0a20 2020 2020 2020 202d 2d2d 2d2d  so.        -----
+0001e5e0: 2d2d 2d0a 2020 2020 2020 2020 5f62 7569  ---.        _bui
+0001e5f0: 6c64 5f70 6965 5f64 6174 610a 2020 2020  ld_pie_data.    
+0001e600: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0001e610: 7069 6563 6861 7274 203d 2066 6967 7572  piechart = figur
+0001e620: 6528 0a20 2020 2020 2020 2020 2020 2068  e(.            h
+0001e630: 6569 6768 743d 3530 302c 0a20 2020 2020  eight=500,.     
+0001e640: 2020 2020 2020 2073 697a 696e 675f 6d6f         sizing_mo
+0001e650: 6465 3d22 7363 616c 655f 626f 7468 222c  de="scale_both",
+0001e660: 0a20 2020 2020 2020 2020 2020 2074 6974  .            tit
+0001e670: 6c65 3d74 6974 6c65 2c0a 2020 2020 2020  le=title,.      
+0001e680: 2020 2020 2020 746f 6f6c 733d 2268 6f76        tools="hov
+0001e690: 6572 222c 0a20 2020 2020 2020 2020 2020  er",.           
+0001e6a0: 2074 6f6f 6c74 6970 733d 2240 7b61 6374   tooltips="@{act
+0001e6b0: 6976 6974 797d 3a20 4074 6578 743c 6272  ivity}: @text<br
+0001e6c0: 3e74 6f74 616c 3a20 407b 746f 7461 6c5f  >total: @{total_
+0001e6d0: 7465 7874 7d22 2c0a 2020 2020 2020 2020  text}",.        
+0001e6e0: 2020 2020 785f 7261 6e67 653d 282d 302e      x_range=(-0.
+0001e6f0: 352c 2031 2e30 292c 0a20 2020 2020 2020  5, 1.0),.       
+0001e700: 2029 0a20 2020 2020 2020 2070 6965 6368   ).        piech
+0001e710: 6172 742e 6178 6973 2e61 7869 735f 6c61  art.axis.axis_la
+0001e720: 6265 6c20 3d20 4e6f 6e65 0a20 2020 2020  bel = None.     
+0001e730: 2020 2070 6965 6368 6172 742e 6178 6973     piechart.axis
+0001e740: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
+0001e750: 0a20 2020 2020 2020 2070 6965 6368 6172  .        piechar
+0001e760: 742e 6772 6964 2e67 7269 645f 6c69 6e65  t.grid.grid_line
+0001e770: 5f63 6f6c 6f72 203d 204e 6f6e 650a 0a20  _color = None.. 
+0001e780: 2020 2020 2020 2070 6965 6368 6172 742e         piechart.
+0001e790: 7765 6467 6528 0a20 2020 2020 2020 2020  wedge(.         
+0001e7a0: 2020 2078 3d30 2c0a 2020 2020 2020 2020     x=0,.        
+0001e7b0: 2020 2020 793d 312c 0a20 2020 2020 2020      y=1,.       
+0001e7c0: 2020 2020 2072 6164 6975 733d 302e 342c       radius=0.4,
+0001e7d0: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
+0001e7e0: 7274 5f61 6e67 6c65 3d63 756d 7375 6d28  rt_angle=cumsum(
+0001e7f0: 2261 6e67 6c65 222c 2069 6e63 6c75 6465  "angle", include
+0001e800: 5f7a 6572 6f3d 5472 7565 292c 0a20 2020  _zero=True),.   
+0001e810: 2020 2020 2020 2020 2065 6e64 5f61 6e67           end_ang
+0001e820: 6c65 3d63 756d 7375 6d28 2261 6e67 6c65  le=cumsum("angle
+0001e830: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+0001e840: 6c69 6e65 5f63 6f6c 6f72 3d22 7768 6974  line_color="whit
+0001e850: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+0001e860: 6669 6c6c 5f63 6f6c 6f72 3d22 636f 6c6f  fill_color="colo
+0001e870: 7222 2c0a 2020 2020 2020 2020 2020 2020  r",.            
+0001e880: 6c65 6765 6e64 5f66 6965 6c64 3d22 6163  legend_field="ac
+0001e890: 7469 7669 7479 222c 0a20 2020 2020 2020  tivity",.       
+0001e8a0: 2020 2020 2073 6f75 7263 653d 736f 7572       source=sour
+0001e8b0: 6365 2c0a 2020 2020 2020 2020 290a 2020  ce,.        ).  
+0001e8c0: 2020 2020 2020 7265 7475 726e 2070 6965        return pie
+0001e8d0: 6368 6172 740a 0a20 2020 2064 6566 205f  chart..    def _
+0001e8e0: 6275 696c 645f 7461 736b 5f65 7865 6375  build_task_execu
+0001e8f0: 7469 6f6e 5f62 795f 7072 6566 6978 5f64  tion_by_prefix_d
+0001e900: 6174 6128 0a20 2020 2020 2020 2073 656c  ata(.        sel
+0001e910: 662c 2064 6174 613a 2064 6566 6175 6c74  f, data: default
+0001e920: 6469 6374 5b74 7570 6c65 5b73 7472 2c20  dict[tuple[str, 
+0001e930: 7374 725d 2c20 666c 6f61 745d 0a20 2020  str], float].   
+0001e940: 2029 202d 3e20 7475 706c 655b 6469 6374   ) -> tuple[dict
+0001e950: 5b73 7472 2c20 6c69 7374 5d2c 2066 6c6f  [str, list], flo
+0001e960: 6174 5d3a 0a20 2020 2020 2020 2022 2222  at]:.        """
+0001e970: 4275 696c 6420 7468 6520 6461 7461 2073  Build the data s
+0001e980: 6f75 7263 6520 666f 7220 7468 6520 6578  ource for the ex
+0001e990: 6563 7574 6520 6279 2066 756e 6374 696f  ecute by functio
+0001e9a0: 6e20 7374 6163 6b65 6420 6368 6172 740a  n stacked chart.
+0001e9b0: 0a20 2020 2020 2020 2053 6565 2061 6c73  .        See als
+0001e9c0: 6f0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  o.        ------
+0001e9d0: 2d2d 0a20 2020 2020 2020 205f 6275 696c  --.        _buil
+0001e9e0: 645f 7461 736b 5f65 7865 6375 7469 6f6e  d_task_execution
+0001e9f0: 5f62 795f 7072 6566 6978 5f63 6861 7274  _by_prefix_chart
+0001ea00: 0a20 2020 2020 2020 205f 7570 6461 7465  .        _update
+0001ea10: 5f74 6173 6b5f 6578 6563 7574 696f 6e5f  _task_execution_
+0001ea20: 6279 5f70 7265 6669 785f 6368 6172 740a  by_prefix_chart.
+0001ea30: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0001ea40: 2020 2020 6675 6e63 5f74 6f74 616c 7320      func_totals 
+0001ea50: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+0001ea60: 7375 6d28 6461 7461 5b66 756e 6374 696f  sum(data[functio
+0001ea70: 6e2c 2061 6374 6976 6974 795d 2066 6f72  n, activity] for
+0001ea80: 2061 6374 6976 6974 7920 696e 2073 656c   activity in sel
+0001ea90: 662e 7669 7369 626c 655f 6163 7469 7669  f.visible_activi
+0001eaa0: 7469 6573 290a 2020 2020 2020 2020 2020  ties).          
+0001eab0: 2020 666f 7220 6675 6e63 7469 6f6e 2069    for function i
+0001eac0: 6e20 7365 6c66 2e76 6973 6962 6c65 5f66  n self.visible_f
+0001ead0: 756e 6374 696f 6e73 0a20 2020 2020 2020  unctions.       
+0001eae0: 205d 0a20 2020 2020 2020 2070 6572 635f   ].        perc_
+0001eaf0: 6b20 3d20 5b31 3030 2e30 202f 2076 2069  k = [100.0 / v i
+0001eb00: 6620 7620 656c 7365 2030 2e30 2066 6f72  f v else 0.0 for
+0001eb10: 2076 2069 6e20 6675 6e63 5f74 6f74 616c   v in func_total
+0001eb20: 735d 0a20 2020 2020 2020 206f 7574 3a20  s].        out: 
+0001eb30: 6469 6374 5b73 7472 2c20 6c69 7374 5d20  dict[str, list] 
+0001eb40: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+0001eb50: 225f 5f66 756e 6374 696f 6e73 223a 2073  "__functions": s
+0001eb60: 656c 662e 7669 7369 626c 655f 6675 6e63  elf.visible_func
+0001eb70: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
+0001eb80: 2020 2022 5f5f 5f5f 746f 7461 6c5f 7465     "____total_te
+0001eb90: 7874 223a 205b 7365 6c66 2e5f 666f 726d  xt": [self._form
+0001eba0: 6174 2876 2920 666f 7220 7620 696e 2066  at(v) for v in f
+0001ebb0: 756e 635f 746f 7461 6c73 5d2c 0a20 2020  unc_totals],.   
+0001ebc0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+0001ebd0: 666f 7220 6163 7469 7669 7479 2069 6e20  for activity in 
+0001ebe0: 7365 6c66 2e76 6973 6962 6c65 5f61 6374  self.visible_act
+0001ebf0: 6976 6974 6965 733a 0a20 2020 2020 2020  ivities:.       
+0001ec00: 2020 2020 2076 616c 7565 7320 3d20 5b64       values = [d
+0001ec10: 6174 615b 6675 6e63 7469 6f6e 2c20 6163  ata[function, ac
+0001ec20: 7469 7669 7479 5d20 666f 7220 6675 6e63  tivity] for func
+0001ec30: 7469 6f6e 2069 6e20 7365 6c66 2e76 6973  tion in self.vis
+0001ec40: 6962 6c65 5f66 756e 6374 696f 6e73 5d0a  ible_functions].
+0001ec50: 2020 2020 2020 2020 2020 2020 6f75 745b              out[
+0001ec60: 6163 7469 7669 7479 5d20 3d20 7661 6c75  activity] = valu
+0001ec70: 6573 0a20 2020 2020 2020 2020 2020 206f  es.            o
+0001ec80: 7574 5b66 225f 5f7b 6163 7469 7669 7479  ut[f"__{activity
+0001ec90: 7d5f 7465 7874 225d 203d 205b 0a20 2020  }_text"] = [.   
+0001eca0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0001ecb0: 662e 5f66 6f72 6d61 7428 7629 202b 2066  f._format(v) + f
+0001ecc0: 2220 287b 7620 2a20 7065 7263 5f6b 693a  " ({v * perc_ki:
+0001ecd0: 2e30 667d 2529 220a 2020 2020 2020 2020  .0f}%)".        
+0001ece0: 2020 2020 2020 2020 666f 7220 762c 2070          for v, p
+0001ecf0: 6572 635f 6b69 2069 6e20 7a69 7028 7661  erc_ki in zip(va
+0001ed00: 6c75 6573 2c20 7065 7263 5f6b 290a 2020  lues, perc_k).  
+0001ed10: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
+0001ed20: 2020 2020 7265 7475 726e 206f 7574 2c20      return out, 
+0001ed30: 6d61 7828 6675 6e63 5f74 6f74 616c 732c  max(func_totals,
+0001ed40: 2064 6566 6175 6c74 3d30 2e30 290a 0a20   default=0.0).. 
+0001ed50: 2020 2064 6566 205f 6275 696c 645f 7461     def _build_ta
+0001ed60: 736b 5f65 7865 6375 7469 6f6e 5f62 795f  sk_execution_by_
+0001ed70: 7072 6566 6978 5f63 6861 7274 2873 656c  prefix_chart(sel
+0001ed80: 6629 202d 3e20 6669 6775 7265 3a0a 2020  f) -> figure:.  
+0001ed90: 2020 2020 2020 2222 2243 7265 6174 6520        """Create 
+0001eda0: 656d 7074 7920 7374 6163 6b65 6420 6261  empty stacked ba
+0001edb0: 7220 6368 6172 7420 666f 7220 6578 6563  r chart for exec
+0001edc0: 7574 6520 6279 2066 756e 6374 696f 6e0a  ute by function.
+0001edd0: 0a20 2020 2020 2020 2053 6565 2061 6c73  .        See als
+0001ede0: 6f0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  o.        ------
+0001edf0: 2d2d 0a20 2020 2020 2020 205f 6275 696c  --.        _buil
+0001ee00: 645f 7461 736b 5f65 7865 6375 7469 6f6e  d_task_execution
+0001ee10: 5f62 795f 7072 6566 6978 5f64 6174 610a  _by_prefix_data.
+0001ee20: 2020 2020 2020 2020 5f75 7064 6174 655f          _update_
+0001ee30: 7461 736b 5f65 7865 6375 7469 6f6e 5f62  task_execution_b
+0001ee40: 795f 7072 6566 6978 5f63 6861 7274 0a20  y_prefix_chart. 
+0001ee50: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0001ee60: 2020 2062 6172 6368 6172 7420 3d20 6669     barchart = fi
+0001ee70: 6775 7265 280a 2020 2020 2020 2020 2020  gure(.          
+0001ee80: 2020 785f 7261 6e67 653d 5b5d 2c0a 2020    x_range=[],.  
+0001ee90: 2020 2020 2020 2020 2020 6865 6967 6874            height
+0001eea0: 3d35 3030 2c0a 2020 2020 2020 2020 2020  =500,.          
+0001eeb0: 2020 7369 7a69 6e67 5f6d 6f64 653d 2273    sizing_mode="s
+0001eec0: 6361 6c65 5f62 6f74 6822 2c0a 2020 2020  cale_both",.    
+0001eed0: 2020 2020 2020 2020 7469 746c 653d 2254          title="T
+0001eee0: 6173 6b20 6578 6563 7574 696f 6e2c 2062  ask execution, b
+0001eef0: 7920 6675 6e63 7469 6f6e 222c 0a20 2020  y function",.   
+0001ef00: 2020 2020 2020 2020 2074 6f6f 6c73 3d22           tools="
+0001ef10: 2c22 2e6a 6f69 6e28 7365 6c66 2e42 4153  ,".join(self.BAS
+0001ef20: 455f 544f 4f4c 5329 2c0a 2020 2020 2020  E_TOOLS),.      
+0001ef30: 2020 290a 2020 2020 2020 2020 6261 7263    ).        barc
+0001ef40: 6861 7274 2e79 6178 6973 2e76 6973 6962  hart.yaxis.visib
+0001ef50: 6c65 203d 2054 7275 650a 2020 2020 2020  le = True.      
+0001ef60: 2020 2320 4173 206f 6620 426f 6b65 6820    # As of Bokeh 
+0001ef70: 332e 312c 2044 6174 6152 616e 6765 3144  3.1, DataRange1D
+0001ef80: 2028 7468 6520 6465 6661 756c 7429 2064   (the default) d
+0001ef90: 6f65 7320 6e6f 7420 776f 726b 2077 6865  oes not work whe
+0001efa0: 6e20 7377 6974 6368 696e 6720 6261 636b  n switching back
+0001efb0: 0a20 2020 2020 2020 2023 2066 726f 6d20  .        # from 
+0001efc0: 6279 7465 7320 2847 6942 7329 2074 6f20  bytes (GiBs) to 
+0001efd0: 7365 636f 6e64 7320 2868 756e 6472 6564  seconds (hundred
+0001efe0: 7329 2e20 536f 2077 6520 6e65 6564 2074  s). So we need t
+0001eff0: 6f20 6d61 6e75 616c 6c79 2075 7064 6174  o manually updat
+0001f000: 6520 6974 2e0a 2020 2020 2020 2020 6261  e it..        ba
+0001f010: 7263 6861 7274 2e79 5f72 616e 6765 203d  rchart.y_range =
+0001f020: 2052 616e 6765 3164 2830 2c20 3129 0a20   Range1d(0, 1). 
+0001f030: 2020 2020 2020 2062 6172 6368 6172 742e         barchart.
+0001f040: 7961 7869 735b 305d 2e66 6f72 6d61 7474  yaxis[0].formatt
+0001f050: 6572 203d 204e 756d 6572 616c 5469 636b  er = NumeralTick
+0001f060: 466f 726d 6174 7465 7228 666f 726d 6174  Formatter(format
+0001f070: 3d22 3030 3a30 303a 3030 2229 0a20 2020  ="00:00:00").   
+0001f080: 2020 2020 2062 6172 6368 6172 742e 7861       barchart.xa
+0001f090: 7869 732e 6d61 6a6f 725f 6c61 6265 6c5f  xis.major_label_
+0001f0a0: 6f72 6965 6e74 6174 696f 6e20 3d20 302e  orientation = 0.
+0001f0b0: 320a 2020 2020 2020 2020 6261 7263 6861  2.        barcha
+0001f0c0: 7274 2e67 7269 642e 6772 6964 5f6c 696e  rt.grid.grid_lin
+0001f0d0: 655f 636f 6c6f 7220 3d20 4e6f 6e65 0a20  e_color = None. 
+0001f0e0: 2020 2020 2020 2072 6574 7572 6e20 6261         return ba
+0001f0f0: 7263 6861 7274 0a0a 2020 2020 6465 6620  rchart..    def 
+0001f100: 5f75 7064 6174 655f 7461 736b 5f65 7865  _update_task_exe
+0001f110: 6375 7469 6f6e 5f62 795f 7072 6566 6978  cution_by_prefix
+0001f120: 5f63 6861 7274 2873 656c 6629 202d 3e20  _chart(self) -> 
+0001f130: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
+0001f140: 2252 6562 7569 6c64 2058 2061 7869 7320  "Rebuild X axis 
+0001f150: 616e 6420 746f 6f6c 7469 7073 206f 6620  and tooltips of 
+0001f160: 6578 6563 7574 696f 6e20 6279 2070 7265  execution by pre
+0001f170: 6669 7820 7374 6163 6b65 6420 6368 6172  fix stacked char
+0001f180: 740a 0a20 2020 2020 2020 2053 6565 2061  t..        See a
+0001f190: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
+0001f1a0: 2d2d 2d2d 0a20 2020 2020 2020 205f 6275  ----.        _bu
+0001f1b0: 696c 645f 7461 736b 5f65 7865 6375 7469  ild_task_executi
+0001f1c0: 6f6e 5f62 795f 7072 6566 6978 5f64 6174  on_by_prefix_dat
+0001f1d0: 610a 2020 2020 2020 2020 5f62 7569 6c64  a.        _build
+0001f1e0: 5f74 6173 6b5f 6578 6563 7574 696f 6e5f  _task_execution_
+0001f1f0: 6279 5f70 7265 6669 785f 6368 6172 740a  by_prefix_chart.
+0001f200: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0001f210: 2020 2020 6261 7263 6861 7274 203d 2073      barchart = s
+0001f220: 656c 662e 7461 736b 5f65 7865 635f 6279  elf.task_exec_by
+0001f230: 5f70 7265 6669 785f 6368 6172 740a 2020  _prefix_chart.  
+0001f240: 2020 2020 2020 6173 7365 7274 2062 6172        assert bar
+0001f250: 6368 6172 7420 6973 206e 6f74 204e 6f6e  chart is not Non
+0001f260: 650a 2020 2020 2020 2020 6261 7263 6861  e.        barcha
+0001f270: 7274 2e78 5f72 616e 6765 203d 2046 6163  rt.x_range = Fac
+0001f280: 746f 7252 616e 6765 282a 7365 6c66 2e76  torRange(*self.v
+0001f290: 6973 6962 6c65 5f66 756e 6374 696f 6e73  isible_functions
+0001f2a0: 290a 2020 2020 2020 2020 7265 6e64 6572  ).        render
+0001f2b0: 6572 7320 3d20 6261 7263 6861 7274 2e76  ers = barchart.v
+0001f2c0: 6261 725f 7374 6163 6b28 0a20 2020 2020  bar_stack(.     
+0001f2d0: 2020 2020 2020 2073 656c 662e 7669 7369         self.visi
+0001f2e0: 626c 655f 6163 7469 7669 7469 6573 2c0a  ble_activities,.
+0001f2f0: 2020 2020 2020 2020 2020 2020 783d 225f              x="_
+0001f300: 5f66 756e 6374 696f 6e73 222c 0a20 2020  _functions",.   
+0001f310: 2020 2020 2020 2020 2077 6964 7468 3d30           width=0
+0001f320: 2e39 2c0a 2020 2020 2020 2020 2020 2020  .9,.            
+0001f330: 736f 7572 6365 3d73 656c 662e 7461 736b  source=self.task
+0001f340: 5f65 7865 635f 6279 5f70 7265 6669 785f  _exec_by_prefix_
+0001f350: 7372 632c 0a20 2020 2020 2020 2020 2020  src,.           
+0001f360: 2063 6f6c 6f72 3d73 656c 662e 5f67 6574   color=self._get
+0001f370: 5f70 616c 6574 7465 2829 2c0a 2020 2020  _palette(),.    
+0001f380: 2020 2020 2020 2020 6c65 6765 6e64 5f6c          legend_l
+0001f390: 6162 656c 3d73 656c 662e 7669 7369 626c  abel=self.visibl
+0001f3a0: 655f 6163 7469 7669 7469 6573 2c0a 2020  e_activities,.  
+0001f3b0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0001f3c0: 2023 2043 7265 6174 6520 6f72 2072 6566   # Create or ref
+0001f3d0: 7265 7368 2068 6f76 6572 746f 6f6c 7320  resh hovertools 
+0001f3e0: 6f6e 2074 6f70 206f 6620 6261 7365 2074  on top of base t
+0001f3f0: 6f6f 6c73 0a20 2020 2020 2020 2062 6172  ools.        bar
+0001f400: 6368 6172 742e 746f 6f6c 7320 3d20 6261  chart.tools = ba
+0001f410: 7263 6861 7274 2e74 6f6f 6c73 5b3a 206c  rchart.tools[: l
+0001f420: 656e 2873 656c 662e 4241 5345 5f54 4f4f  en(self.BASE_TOO
+0001f430: 4c53 295d 0a0a 2020 2020 2020 2020 666f  LS)]..        fo
+0001f440: 7220 7662 6172 2069 6e20 7265 6e64 6572  r vbar in render
+0001f450: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+0001f460: 2074 6f6f 6c74 6970 7320 3d20 5b0a 2020   tooltips = [.  
+0001f470: 2020 2020 2020 2020 2020 2020 2020 2822                ("
+0001f480: 6675 6e63 7469 6f6e 222c 2022 405f 5f66  function", "@__f
+0001f490: 756e 6374 696f 6e73 2229 2c0a 2020 2020  unctions"),.    
+0001f4a0: 2020 2020 2020 2020 2020 2020 2876 6261              (vba
+0001f4b0: 722e 6e61 6d65 2c20 6622 407b 7b5f 5f7b  r.name, f"@{{__{
+0001f4c0: 7662 6172 2e6e 616d 657d 5f74 6578 747d  vbar.name}_text}
+0001f4d0: 7d22 292c 0a20 2020 2020 2020 2020 2020  }"),.           
+0001f4e0: 2020 2020 2028 2274 6f74 616c 222c 2022       ("total", "
+0001f4f0: 405f 5f5f 5f74 6f74 616c 5f74 6578 7422  @____total_text"
+0001f500: 292c 0a20 2020 2020 2020 2020 2020 205d  ),.            ]
+0001f510: 0a20 2020 2020 2020 2020 2020 2062 6172  .            bar
+0001f520: 6368 6172 742e 6164 645f 746f 6f6c 7328  chart.add_tools(
+0001f530: 486f 7665 7254 6f6f 6c28 746f 6f6c 7469  HoverTool(toolti
+0001f540: 7073 3d74 6f6f 6c74 6970 732c 2072 656e  ps=tooltips, ren
+0001f550: 6465 7265 7273 3d5b 7662 6172 5d29 290a  derers=[vbar])).
+0001f560: 2020 2020 2020 2020 6261 7263 6861 7274          barchart
+0001f570: 2e72 656e 6465 7265 7273 203d 2072 656e  .renderers = ren
+0001f580: 6465 7265 7273 0a0a 0a63 6c61 7373 2043  derers...class C
+0001f590: 6f6e 7465 6e74 696f 6e28 4461 7368 626f  ontention(Dashbo
+0001f5a0: 6172 6443 6f6d 706f 6e65 6e74 293a 0a20  ardComponent):. 
+0001f5b0: 2020 2022 2222 0a20 2020 2045 7665 6e74     """.    Event
+0001f5c0: 204c 6f6f 7020 4865 616c 7468 2028 616e   Loop Health (an
+0001f5d0: 6420 4749 4c20 436f 6e74 656e 7469 6f6e  d GIL Contention
+0001f5e0: 2c20 6966 2063 6f6e 6669 6775 7265 6429  , if configured)
+0001f5f0: 0a20 2020 2022 2222 0a0a 2020 2020 406c  .    """..    @l
+0001f600: 6f67 5f65 7272 6f72 730a 2020 2020 6465  og_errors.    de
+0001f610: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+0001f620: 2073 6368 6564 756c 6572 2c20 2a2a 6b77   scheduler, **kw
+0001f630: 6172 6773 293a 0a20 2020 2020 2020 2073  args):.        s
+0001f640: 656c 662e 7363 6865 6475 6c65 7220 3d20  elf.scheduler = 
+0001f650: 7363 6865 6475 6c65 720a 2020 2020 2020  scheduler.      
+0001f660: 2020 7365 6c66 2e64 6174 6120 3d20 6469    self.data = di
+0001f670: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
+0001f680: 6e61 6d65 733d 5b0a 2020 2020 2020 2020  names=[.        
+0001f690: 2020 2020 2020 2020 2822 5363 6865 6475          ("Schedu
+0001f6a0: 6c65 7222 2c20 2245 7665 6e74 204c 6f6f  ler", "Event Loo
+0001f6b0: 7022 292c 0a20 2020 2020 2020 2020 2020  p"),.           
+0001f6c0: 2020 2020 2028 2253 6368 6564 756c 6572       ("Scheduler
+0001f6d0: 222c 2022 4749 4c20 436f 6e74 656e 7469  ", "GIL Contenti
+0001f6e0: 6f6e 2229 2c0a 2020 2020 2020 2020 2020  on"),.          
+0001f6f0: 2020 2020 2020 2822 576f 726b 6572 7322        ("Workers"
+0001f700: 2c20 2245 7665 6e74 204c 6f6f 7022 292c  , "Event Loop"),
+0001f710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001f720: 2028 2257 6f72 6b65 7273 222c 2022 4749   ("Workers", "GI
+0001f730: 4c20 436f 6e74 656e 7469 6f6e 2229 2c0a  L Contention"),.
+0001f740: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
+0001f750: 2020 2020 2020 2020 2020 2076 616c 7565             value
+0001f760: 733d 5b30 2c20 302c 2030 2c20 305d 2c0a  s=[0, 0, 0, 0],.
+0001f770: 2020 2020 2020 2020 2020 2020 7465 7874              text
+0001f780: 3d5b 2230 7322 2c20 2230 2522 2c20 2230  =["0s", "0%", "0
+0001f790: 7322 2c20 2230 2522 5d2c 0a20 2020 2020  s", "0%"],.     
+0001f7a0: 2020 2029 0a20 2020 2020 2020 2074 6974     ).        tit
+0001f7b0: 6c65 203d 2022 4576 656e 7420 4c6f 6f70  le = "Event Loop
+0001f7c0: 2026 2047 494c 2043 6f6e 7465 6e74 696f   & GIL Contentio
+0001f7d0: 6e22 0a0a 2020 2020 2020 2020 2320 5265  n"..        # Re
+0001f7e0: 6d6f 7665 2047 494c 2072 656c 6174 6564  move GIL related
+0001f7f0: 206e 616d 6573 2f76 616c 7565 7320 6966   names/values if
+0001f800: 206e 6f74 206d 6f6e 6974 6f72 696e 6720   not monitoring 
+0001f810: 4749 4c0a 2020 2020 2020 2020 6966 206e  GIL.        if n
+0001f820: 6f74 2073 656c 662e 7363 6865 6475 6c65  ot self.schedule
+0001f830: 722e 6d6f 6e69 746f 722e 6d6f 6e69 746f  r.monitor.monito
+0001f840: 725f 6769 6c5f 636f 6e74 656e 7469 6f6e  r_gil_contention
+0001f850: 3a0a 2020 2020 2020 2020 2020 2020 7469  :.            ti
+0001f860: 746c 6520 3d20 2245 7665 6e74 204c 6f6f  tle = "Event Loo
+0001f870: 7022 0a20 2020 2020 2020 2020 2020 2066  p".            f
+0001f880: 6f72 206b 6579 2069 6e20 7365 6c66 2e64  or key in self.d
+0001f890: 6174 613a 0a20 2020 2020 2020 2020 2020  ata:.           
+0001f8a0: 2020 2020 2073 656c 662e 6461 7461 5b6b       self.data[k
+0001f8b0: 6579 5d20 3d20 7365 6c66 2e64 6174 615b  ey] = self.data[
+0001f8c0: 6b65 795d 5b3a 3a32 5d0a 0a20 2020 2020  key][::2]..     
+0001f8d0: 2020 2073 656c 662e 736f 7572 6365 203d     self.source =
+0001f8e0: 2043 6f6c 756d 6e44 6174 6153 6f75 7263   ColumnDataSourc
+0001f8f0: 6528 6461 7461 3d73 656c 662e 6461 7461  e(data=self.data
+0001f900: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
+0001f910: 6f6f 7420 3d20 6669 6775 7265 280a 2020  oot = figure(.  
+0001f920: 2020 2020 2020 2020 2020 7469 746c 653d            title=
+0001f930: 7469 746c 652c 0a20 2020 2020 2020 2020  title,.         
+0001f940: 2020 2078 5f72 616e 6765 3d46 6163 746f     x_range=Facto
+0001f950: 7252 616e 6765 282a 7365 6c66 2e64 6174  rRange(*self.dat
+0001f960: 615b 226e 616d 6573 225d 292c 0a20 2020  a["names"]),.   
+0001f970: 2020 2020 2020 2020 2079 5f72 616e 6765           y_range
+0001f980: 3d28 302c 2031 292c 0a20 2020 2020 2020  =(0, 1),.       
+0001f990: 2020 2020 2074 6f6f 6c73 3d22 222c 0a20       tools="",. 
+0001f9a0: 2020 2020 2020 2020 2020 2074 6f6f 6c62             toolb
+0001f9b0: 6172 5f6c 6f63 6174 696f 6e3d 2261 626f  ar_location="abo
+0001f9c0: 7665 222c 0a20 2020 2020 2020 2020 2020  ve",.           
+0001f9d0: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
+0001f9e0: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
+0001f9f0: 662e 726f 6f74 2e76 6261 7228 0a20 2020  f.root.vbar(.   
+0001fa00: 2020 2020 2020 2020 2078 3d22 6e61 6d65           x="name
+0001fa10: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
+0001fa20: 746f 703d 2276 616c 7565 7322 2c0a 2020  top="values",.  
+0001fa30: 2020 2020 2020 2020 2020 7769 6474 683d            width=
+0001fa40: 302e 392c 0a20 2020 2020 2020 2020 2020  0.9,.           
+0001fa50: 206c 696e 655f 636f 6c6f 723d 2277 6869   line_color="whi
+0001fa60: 7465 222c 0a20 2020 2020 2020 2020 2020  te",.           
+0001fa70: 2073 6f75 7263 653d 7365 6c66 2e73 6f75   source=self.sou
+0001fa80: 7263 652c 0a20 2020 2020 2020 2020 2020  rce,.           
+0001fa90: 2066 696c 6c5f 636f 6c6f 723d 6661 6374   fill_color=fact
+0001faa0: 6f72 5f63 6d61 7028 0a20 2020 2020 2020  or_cmap(.       
+0001fab0: 2020 2020 2020 2020 2066 6965 6c64 5f6e           field_n
+0001fac0: 616d 653d 226e 616d 6573 222c 0a20 2020  ame="names",.   
+0001fad0: 2020 2020 2020 2020 2020 2020 2070 616c               pal
+0001fae0: 6574 7465 3d5b 2223 6238 6530 6365 222c  ette=["#b8e0ce",
+0001faf0: 2022 2338 3161 6165 3422 5d2c 0a20 2020   "#81aae4"],.   
+0001fb00: 2020 2020 2020 2020 2020 2020 2066 6163               fac
+0001fb10: 746f 7273 3d5b 2245 7665 6e74 204c 6f6f  tors=["Event Loo
+0001fb20: 7022 2c20 2247 494c 2043 6f6e 7465 6e74  p", "GIL Content
+0001fb30: 696f 6e22 5d2c 0a20 2020 2020 2020 2020  ion"],.         
+0001fb40: 2020 2020 2020 2073 7461 7274 3d31 2c0a         start=1,.
+0001fb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fb60: 656e 643d 322c 0a20 2020 2020 2020 2020  end=2,.         
+0001fb70: 2020 2029 2c0a 2020 2020 2020 2020 290a     ),.        ).
+0001fb80: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+0001fb90: 6f74 2e78 5f72 616e 6765 2e67 726f 7570  ot.x_range.group
+0001fba0: 5f70 6164 6469 6e67 203d 2030 2e32 350a  _padding = 0.25.
+0001fbb0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+0001fbc0: 742e 7861 7869 732e 6d69 6e6f 725f 7469  t.xaxis.minor_ti
+0001fbd0: 636b 5f6c 696e 655f 616c 7068 6120 3d20  ck_line_alpha = 
+0001fbe0: 300a 2020 2020 2020 2020 7365 6c66 2e72  0.        self.r
+0001fbf0: 6f6f 742e 7967 7269 642e 7669 7369 626c  oot.ygrid.visibl
+0001fc00: 6520 3d20 5472 7565 0a20 2020 2020 2020  e = True.       
+0001fc10: 2073 656c 662e 726f 6f74 2e78 6772 6964   self.root.xgrid
+0001fc20: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
+0001fc30: 0a0a 2020 2020 2020 2020 686f 7665 7220  ..        hover 
+0001fc40: 3d20 486f 7665 7254 6f6f 6c28 0a20 2020  = HoverTool(.   
+0001fc50: 2020 2020 2020 2020 2074 6f6f 6c74 6970           tooltip
+0001fc60: 733d 5b28 224e 616d 6522 2c20 2240 6e61  s=[("Name", "@na
+0001fc70: 6d65 7322 292c 2028 2256 616c 7565 222c  mes"), ("Value",
+0001fc80: 2022 4074 6578 7422 295d 2c20 6d6f 6465   "@text")], mode
+0001fc90: 3d22 766c 696e 6522 0a20 2020 2020 2020  ="vline".       
+0001fca0: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+0001fcb0: 726f 6f74 2e61 6464 5f74 6f6f 6c73 2868  root.add_tools(h
+0001fcc0: 6f76 6572 290a 0a20 2020 2040 7769 7468  over)..    @with
+0001fcd0: 6f75 745f 7072 6f70 6572 7479 5f76 616c  out_property_val
+0001fce0: 6964 6174 696f 6e0a 2020 2020 406c 6f67  idation.    @log
+0001fcf0: 5f65 7272 6f72 730a 2020 2020 6465 6620  _errors.    def 
+0001fd00: 7570 6461 7465 2873 656c 6629 3a0a 2020  update(self):.  
+0001fd10: 2020 2020 2020 7320 3d20 7365 6c66 2e73        s = self.s
+0001fd20: 6368 6564 756c 6572 0a20 2020 2020 2020  cheduler.       
+0001fd30: 206d 6f6e 6974 6f72 5f67 696c 203d 2073   monitor_gil = s
+0001fd40: 2e6d 6f6e 6974 6f72 2e6d 6f6e 6974 6f72  .monitor.monitor
+0001fd50: 5f67 696c 5f63 6f6e 7465 6e74 696f 6e0a  _gil_contention.
+0001fd60: 0a20 2020 2020 2020 2073 656c 662e 6461  .        self.da
+0001fd70: 7461 5b22 7661 6c75 6573 225d 203d 205b  ta["values"] = [
+0001fd80: 0a20 2020 2020 2020 2020 2020 2073 2e5f  .            s._
+0001fd90: 7469 636b 5f69 6e74 6572 7661 6c5f 6f62  tick_interval_ob
+0001fda0: 7365 7276 6564 2c0a 2020 2020 2020 2020  served,.        
+0001fdb0: 2020 2020 7365 6c66 2e67 696c 5f63 6f6e      self.gil_con
+0001fdc0: 7465 6e74 696f 6e5f 7363 6865 6475 6c65  tention_schedule
+0001fdd0: 722c 0a20 2020 2020 2020 2020 2020 2073  r,.            s
+0001fde0: 756d 2877 2e6d 6574 7269 6373 5b22 6576  um(w.metrics["ev
+0001fdf0: 656e 745f 6c6f 6f70 5f69 6e74 6572 7661  ent_loop_interva
+0001fe00: 6c22 5d20 666f 7220 7720 696e 2073 2e77  l"] for w in s.w
+0001fe10: 6f72 6b65 7273 2e76 616c 7565 7328 2929  orkers.values())
+0001fe20: 0a20 2020 2020 2020 2020 2020 202f 2028  .            / (
+0001fe30: 6c65 6e28 732e 776f 726b 6572 7329 206f  len(s.workers) o
+0001fe40: 7220 3129 2c0a 2020 2020 2020 2020 2020  r 1),.          
+0001fe50: 2020 7365 6c66 2e67 696c 5f63 6f6e 7465    self.gil_conte
+0001fe60: 6e74 696f 6e5f 776f 726b 6572 732c 0a20  ntion_workers,. 
+0001fe70: 2020 2020 2020 205d 5b3a 3a20 3120 6966         ][:: 1 if
+0001fe80: 206d 6f6e 6974 6f72 5f67 696c 2065 6c73   monitor_gil els
+0001fe90: 6520 325d 0a0a 2020 2020 2020 2020 2320  e 2]..        # 
+0001fea0: 466f 726d 6174 2065 7665 6e74 206c 6f6f  Format event loo
+0001feb0: 7020 6173 2074 696d 6520 616e 6420 4749  p as time and GI
+0001fec0: 4c20 2869 6620 636f 6e66 6967 7572 6564  L (if configured
+0001fed0: 2920 6173 2025 0a20 2020 2020 2020 2073  ) as %.        s
+0001fee0: 656c 662e 6461 7461 5b22 7465 7874 225d  elf.data["text"]
+0001fef0: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+0001ff00: 2066 227b 7820 2a20 3130 303a 2e31 667d   f"{x * 100:.1f}
+0001ff10: 2522 2069 6620 6920 2520 3220 616e 6420  %" if i % 2 and 
+0001ff20: 6d6f 6e69 746f 725f 6769 6c20 656c 7365  monitor_gil else
+0001ff30: 2066 6f72 6d61 745f 7469 6d65 2878 290a   format_time(x).
+0001ff40: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0001ff50: 692c 2078 2069 6e20 656e 756d 6572 6174  i, x in enumerat
+0001ff60: 6528 7365 6c66 2e64 6174 615b 2276 616c  e(self.data["val
+0001ff70: 7565 7322 5d29 0a20 2020 2020 2020 205d  ues"]).        ]
+0001ff80: 0a20 2020 2020 2020 2075 7064 6174 6528  .        update(
+0001ff90: 7365 6c66 2e73 6f75 7263 652c 2073 656c  self.source, sel
+0001ffa0: 662e 6461 7461 290a 0a20 2020 2040 7072  f.data)..    @pr
+0001ffb0: 6f70 6572 7479 0a20 2020 2064 6566 2067  operty.    def g
+0001ffc0: 696c 5f63 6f6e 7465 6e74 696f 6e5f 776f  il_contention_wo
+0001ffd0: 726b 6572 7328 7365 6c66 2920 2d3e 2066  rkers(self) -> f
+0001ffe0: 6c6f 6174 3a0a 2020 2020 2020 2020 776f  loat:.        wo
+0001fff0: 726b 6572 7320 3d20 7365 6c66 2e73 6368  rkers = self.sch
+00020000: 6564 756c 6572 2e77 6f72 6b65 7273 0a20  eduler.workers. 
+00020010: 2020 2020 2020 2069 6620 776f 726b 6572         if worker
+00020020: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
+00020030: 6574 7572 6e20 7375 6d28 0a20 2020 2020  eturn sum(.     
+00020040: 2020 2020 2020 2020 2020 2077 2e6d 6574             w.met
+00020050: 7269 6373 2e67 6574 2822 6769 6c5f 636f  rics.get("gil_co
+00020060: 6e74 656e 7469 6f6e 222c 2030 2920 666f  ntention", 0) fo
+00020070: 7220 7720 696e 2077 6f72 6b65 7273 2e76  r w in workers.v
+00020080: 616c 7565 7328 290a 2020 2020 2020 2020  alues().        
+00020090: 2020 2020 2920 2f20 6c65 6e28 776f 726b      ) / len(work
+000200a0: 6572 7329 0a20 2020 2020 2020 2072 6574  ers).        ret
+000200b0: 7572 6e20 666c 6f61 7428 224e 614e 2229  urn float("NaN")
+000200c0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+000200d0: 2020 2020 6465 6620 6769 6c5f 636f 6e74      def gil_cont
+000200e0: 656e 7469 6f6e 5f73 6368 6564 756c 6572  ention_scheduler
+000200f0: 2873 656c 6629 202d 3e20 666c 6f61 743a  (self) -> float:
+00020100: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00020110: 7365 6c66 2e73 6368 6564 756c 6572 2e6d  self.scheduler.m
+00020120: 6f6e 6974 6f72 2e72 6563 656e 7428 292e  onitor.recent().
+00020130: 6765 7428 2267 696c 5f63 6f6e 7465 6e74  get("gil_content
+00020140: 696f 6e22 2c20 666c 6f61 7428 224e 614e  ion", float("NaN
+00020150: 2229 290a 0a0a 636c 6173 7320 4578 6365  "))...class Exce
+00020160: 7074 696f 6e73 5461 626c 6528 4461 7368  ptionsTable(Dash
+00020170: 626f 6172 6443 6f6d 706f 6e65 6e74 293a  boardComponent):
+00020180: 0a20 2020 2022 2222 0a20 2020 2045 7863  .    """.    Exc
+00020190: 6570 7469 6f6e 7320 6c6f 6767 6564 2069  eptions logged i
+000201a0: 6e20 7461 736b 732e 0a0a 2020 2020 5369  n tasks...    Si
+000201b0: 6e63 6520 7468 6572 6520 6d69 6768 7420  nce there might 
+000201c0: 6265 206d 616e 7920 7265 6c61 7465 6420  be many related 
+000201d0: 6578 6365 7074 696f 6e73 2028 652e 672e  exceptions (e.g.
+000201e0: 2c20 616c 6c20 7461 736b 7320 696e 2061  , all tasks in a
+000201f0: 2067 6976 656e 0a20 2020 2074 6173 6b20   given.    task 
+00020200: 6772 6f75 7020 6661 696c 2066 6f72 2074  group fail for t
+00020210: 6865 2073 616d 6520 7265 6173 6f6e 292c  he same reason),
+00020220: 2077 6520 6d61 6b65 2061 2062 6573 742d   we make a best-
+00020230: 6566 666f 7274 2061 7474 656d 7074 2074  effort attempt t
+00020240: 6f0a 2020 2020 2831 2920 6167 6772 6567  o.    (1) aggreg
+00020250: 6174 6520 746f 2074 6865 2074 6173 6b20  ate to the task 
+00020260: 6772 6f75 702c 2061 6e64 2028 3229 2064  group, and (2) d
+00020270: 6564 7570 6c69 6361 7465 2073 696d 696c  eduplicate simil
+00020280: 6172 206c 6f6f 6b69 6e67 2074 6173 6b73  ar looking tasks
+00020290: 2e0a 2020 2020 2222 220a 0a20 2020 2073  ..    """..    s
+000202a0: 6368 6564 756c 6572 3a20 5363 6865 6475  cheduler: Schedu
+000202b0: 6c65 720a 0a20 2020 2064 6566 205f 5f69  ler..    def __i
+000202c0: 6e69 745f 5f28 7365 6c66 2c20 7363 6865  nit__(self, sche
+000202d0: 6475 6c65 723a 2053 6368 6564 756c 6572  duler: Scheduler
+000202e0: 2c20 7769 6474 683a 2069 6e74 203d 2031  , width: int = 1
+000202f0: 3030 302c 202a 2a6b 7761 7267 733a 2041  000, **kwargs: A
+00020300: 6e79 293a 0a20 2020 2020 2020 2073 656c  ny):.        sel
+00020310: 662e 7363 6865 6475 6c65 7220 3d20 7363  f.scheduler = sc
+00020320: 6865 6475 6c65 720a 0a20 2020 2020 2020  heduler..       
+00020330: 2073 656c 662e 6e61 6d65 7320 3d20 5b0a   self.names = [.
+00020340: 2020 2020 2020 2020 2020 2020 2254 6173              "Tas
+00020350: 6b22 2c0a 2020 2020 2020 2020 2020 2020  k",.            
+00020360: 2245 7863 6570 7469 6f6e 222c 0a20 2020  "Exception",.   
+00020370: 2020 2020 2020 2020 2022 5472 6163 6562           "Traceb
+00020380: 6163 6b22 2c0a 2020 2020 2020 2020 2020  ack",.          
+00020390: 2020 2257 6f72 6b65 7228 7329 222c 0a20    "Worker(s)",. 
+000203a0: 2020 2020 2020 2020 2020 2022 436f 756e             "Coun
+000203b0: 7422 2c0a 2020 2020 2020 2020 5d0a 0a20  t",.        ].. 
+000203c0: 2020 2020 2020 2073 656c 662e 736f 7572         self.sour
+000203d0: 6365 203d 2043 6f6c 756d 6e44 6174 6153  ce = ColumnDataS
+000203e0: 6f75 7263 6528 7b6b 3a20 5b5d 2066 6f72  ource({k: [] for
+000203f0: 206b 2069 6e20 7365 6c66 2e6e 616d 6573   k in self.names
+00020400: 7d29 0a0a 2020 2020 2020 2020 636f 6465  })..        code
+00020410: 5f66 6f72 6d61 7474 6572 203d 2048 544d  _formatter = HTM
+00020420: 4c54 656d 706c 6174 6546 6f72 6d61 7474  LTemplateFormatt
+00020430: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+00020440: 7465 6d70 6c61 7465 3d27 3c63 6f64 6520  template='<code 
+00020450: 7469 746c 653d 223c 252d 2076 616c 7565  title="<%- value
+00020460: 2025 3e22 3e3c 253d 2076 616c 7565 2025   %>"><%= value %
+00020470: 3e3c 2f63 6f64 653e 270a 2020 2020 2020  ></code>'.      
+00020480: 2020 290a 2020 2020 2020 2020 636f 6c75    ).        colu
+00020490: 6d6e 7320 3d20 5b0a 2020 2020 2020 2020  mns = [.        
+000204a0: 2020 2020 5461 626c 6543 6f6c 756d 6e28      TableColumn(
+000204b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000204c0: 2066 6965 6c64 3d22 5461 736b 222c 0a20   field="Task",. 
+000204d0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000204e0: 6974 6c65 3d22 5461 736b 222c 0a20 2020  itle="Task",.   
+000204f0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00020500: 6d61 7474 6572 3d63 6f64 655f 666f 726d  matter=code_form
+00020510: 6174 7465 722c 0a20 2020 2020 2020 2020  atter,.         
+00020520: 2020 2020 2020 2077 6964 7468 3d31 3530         width=150
+00020530: 2c0a 2020 2020 2020 2020 2020 2020 292c  ,.            ),
+00020540: 0a20 2020 2020 2020 2020 2020 2054 6162  .            Tab
+00020550: 6c65 436f 6c75 6d6e 280a 2020 2020 2020  leColumn(.      
+00020560: 2020 2020 2020 2020 2020 6669 656c 643d            field=
+00020570: 2245 7863 6570 7469 6f6e 222c 0a20 2020  "Exception",.   
+00020580: 2020 2020 2020 2020 2020 2020 2074 6974               tit
+00020590: 6c65 3d22 4578 6365 7074 696f 6e22 2c0a  le="Exception",.
+000205a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000205b0: 666f 726d 6174 7465 723d 636f 6465 5f66  formatter=code_f
+000205c0: 6f72 6d61 7474 6572 2c0a 2020 2020 2020  ormatter,.      
+000205d0: 2020 2020 2020 2020 2020 7769 6474 683d            width=
+000205e0: 3330 302c 0a20 2020 2020 2020 2020 2020  300,.           
+000205f0: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+00020600: 5461 626c 6543 6f6c 756d 6e28 0a20 2020  TableColumn(.   
+00020610: 2020 2020 2020 2020 2020 2020 2066 6965               fie
+00020620: 6c64 3d22 5472 6163 6562 6163 6b22 2c0a  ld="Traceback",.
+00020630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020640: 7469 746c 653d 2254 7261 6365 6261 636b  title="Traceback
+00020650: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00020660: 2020 2066 6f72 6d61 7474 6572 3d63 6f64     formatter=cod
+00020670: 655f 666f 726d 6174 7465 722c 0a20 2020  e_formatter,.   
+00020680: 2020 2020 2020 2020 2020 2020 2077 6964               wid
+00020690: 7468 3d33 3030 2c0a 2020 2020 2020 2020  th=300,.        
+000206a0: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
+000206b0: 2020 2054 6162 6c65 436f 6c75 6d6e 280a     TableColumn(.
+000206c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000206d0: 6669 656c 643d 2257 6f72 6b65 7228 7329  field="Worker(s)
+000206e0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+000206f0: 2020 2074 6974 6c65 3d22 576f 726b 6572     title="Worker
+00020700: 2873 2922 2c0a 2020 2020 2020 2020 2020  (s)",.          
+00020710: 2020 2020 2020 666f 726d 6174 7465 723d        formatter=
+00020720: 636f 6465 5f66 6f72 6d61 7474 6572 2c0a  code_formatter,.
+00020730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020740: 7769 6474 683d 3230 302c 0a20 2020 2020  width=200,.     
+00020750: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
+00020760: 2020 2020 2020 5461 626c 6543 6f6c 756d        TableColum
+00020770: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+00020780: 2020 2066 6965 6c64 3d22 436f 756e 7422     field="Count"
+00020790: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000207a0: 2020 7469 746c 653d 2243 6f75 6e74 222c    title="Count",
+000207b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000207c0: 2066 6f72 6d61 7474 6572 3d4e 756d 6265   formatter=Numbe
+000207d0: 7246 6f72 6d61 7474 6572 2866 6f72 6d61  rFormatter(forma
+000207e0: 743d 2230 2c30 2229 2c0a 2020 2020 2020  t="0,0"),.      
+000207f0: 2020 2020 2020 2020 2020 7769 6474 683d            width=
+00020800: 3530 2c0a 2020 2020 2020 2020 2020 2020  50,.            
+00020810: 292c 0a20 2020 2020 2020 205d 0a0a 2020  ),.        ]..  
+00020820: 2020 2020 2020 6966 2022 7369 7a69 6e67        if "sizing
+00020830: 5f6d 6f64 6522 2069 6e20 6b77 6172 6773  _mode" in kwargs
+00020840: 3a0a 2020 2020 2020 2020 2020 2020 7369  :.            si
+00020850: 7a69 6e67 5f6d 6f64 6520 3d20 7b22 7369  zing_mode = {"si
+00020860: 7a69 6e67 5f6d 6f64 6522 3a20 6b77 6172  zing_mode": kwar
+00020870: 6773 5b22 7369 7a69 6e67 5f6d 6f64 6522  gs["sizing_mode"
+00020880: 5d7d 0a20 2020 2020 2020 2065 6c73 653a  ]}.        else:
+00020890: 0a20 2020 2020 2020 2020 2020 2073 697a  .            siz
+000208a0: 696e 675f 6d6f 6465 203d 207b 7d0a 2020  ing_mode = {}.  
+000208b0: 2020 2020 2020 7365 6c66 2e72 6f6f 7420        self.root 
+000208c0: 3d20 4461 7461 5461 626c 6528 0a20 2020  = DataTable(.   
+000208d0: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
+000208e0: 7365 6c66 2e73 6f75 7263 652c 0a20 2020  self.source,.   
+000208f0: 2020 2020 2020 2020 2063 6f6c 756d 6e73           columns
+00020900: 3d63 6f6c 756d 6e73 2c0a 2020 2020 2020  =columns,.      
+00020910: 2020 2020 2020 7265 6f72 6465 7261 626c        reorderabl
+00020920: 653d 5472 7565 2c0a 2020 2020 2020 2020  e=True,.        
+00020930: 2020 2020 736f 7274 6162 6c65 3d54 7275      sortable=Tru
+00020940: 652c 0a20 2020 2020 2020 2020 2020 2077  e,.            w
+00020950: 6964 7468 3d77 6964 7468 2c0a 2020 2020  idth=width,.    
+00020960: 2020 2020 2020 2020 696e 6465 785f 706f          index_po
+00020970: 7369 7469 6f6e 3d4e 6f6e 652c 0a20 2020  sition=None,.   
+00020980: 2020 2020 2020 2020 202a 2a5f 4441 5441           **_DATA
+00020990: 5441 424c 455f 5354 594c 4553 4845 4554  TABLE_STYLESHEET
+000209a0: 535f 4b57 4152 4753 2c0a 2020 2020 2020  S_KWARGS,.      
+000209b0: 2020 2020 2020 2a2a 7369 7a69 6e67 5f6d        **sizing_m
+000209c0: 6f64 652c 0a20 2020 2020 2020 2029 0a0a  ode,.        )..
+000209d0: 2020 2020 4077 6974 686f 7574 5f70 726f      @without_pro
+000209e0: 7065 7274 795f 7661 6c69 6461 7469 6f6e  perty_validation
+000209f0: 0a20 2020 2064 6566 2075 7064 6174 6528  .    def update(
+00020a00: 7365 6c66 293a 0a20 2020 2020 2020 206e  self):.        n
+00020a10: 6577 5f64 6174 6120 3d20 7b6e 616d 653a  ew_data = {name:
+00020a20: 205b 5d20 666f 7220 6e61 6d65 2069 6e20   [] for name in 
+00020a30: 7365 6c66 2e6e 616d 6573 7d0a 2020 2020  self.names}.    
+00020a40: 2020 2020 6572 7265 645f 7461 736b 7320      erred_tasks 
+00020a50: 3d20 7365 6c66 2e73 6368 6564 756c 6572  = self.scheduler
+00020a60: 2e65 7272 6564 5f74 6173 6b73 0a0a 2020  .erred_tasks..  
+00020a70: 2020 2020 2020 666f 7220 7473 2069 6e20        for ts in 
+00020a80: 6572 7265 645f 7461 736b 733a 0a20 2020  erred_tasks:.   
+00020a90: 2020 2020 2020 2020 206e 6577 5f64 6174           new_dat
+00020aa0: 615b 2254 6173 6b22 5d2e 6170 7065 6e64  a["Task"].append
+00020ab0: 2874 732e 6b65 7929 0a20 2020 2020 2020  (ts.key).       
+00020ac0: 2020 2020 206e 6577 5f64 6174 615b 2245       new_data["E
+00020ad0: 7863 6570 7469 6f6e 225d 2e61 7070 656e  xception"].appen
+00020ae0: 6428 7473 2e65 7863 6570 7469 6f6e 5f74  d(ts.exception_t
+00020af0: 6578 7429 0a20 2020 2020 2020 2020 2020  ext).           
+00020b00: 206e 6577 5f64 6174 615b 2254 7261 6365   new_data["Trace
+00020b10: 6261 636b 225d 2e61 7070 656e 6428 7473  back"].append(ts
+00020b20: 2e74 7261 6365 6261 636b 5f74 6578 7429  .traceback_text)
+00020b30: 0a20 2020 2020 2020 2020 2020 206e 6577  .            new
+00020b40: 5f64 6174 615b 2257 6f72 6b65 7228 7329  _data["Worker(s)
+00020b50: 225d 2e61 7070 656e 6428 222c 5c6e 222e  "].append(",\n".
+00020b60: 6a6f 696e 2874 732e 6572 7265 645f 6f6e  join(ts.erred_on
+00020b70: 2929 0a20 2020 2020 2020 2020 2020 206e  )).            n
+00020b80: 6577 5f64 6174 615b 2243 6f75 6e74 225d  ew_data["Count"]
+00020b90: 2e61 7070 656e 6428 6c65 6e28 7473 2e65  .append(len(ts.e
+00020ba0: 7272 6564 5f6f 6e29 290a 0a20 2020 2020  rred_on))..     
+00020bb0: 2020 2075 7064 6174 6528 7365 6c66 2e73     update(self.s
+00020bc0: 6f75 7263 652c 206e 6577 5f64 6174 6129  ource, new_data)
+00020bd0: 0a0a 0a63 6c61 7373 2057 6f72 6b65 7254  ...class WorkerT
+00020be0: 6162 6c65 2844 6173 6862 6f61 7264 436f  able(DashboardCo
+00020bf0: 6d70 6f6e 656e 7429 3a0a 2020 2020 2222  mponent):.    ""
+00020c00: 2253 7461 7475 7320 6f66 2074 6865 2063  "Status of the c
+00020c10: 7572 7265 6e74 2077 6f72 6b65 7273 0a0a  urrent workers..
+00020c20: 2020 2020 5468 6973 2069 7320 7477 6f20      This is two 
+00020c30: 706c 6f74 732c 2061 2074 6578 742d 6261  plots, a text-ba
+00020c40: 7365 6420 7461 626c 6520 666f 7220 6561  sed table for ea
+00020c50: 6368 2068 6f73 7420 616e 6420 6120 7468  ch host and a th
+00020c60: 696e 2068 6f72 697a 6f6e 7461 6c0a 2020  in horizontal.  
+00020c70: 2020 706c 6f74 206c 6179 696e 6720 6f75    plot laying ou
+00020c80: 7420 686f 7374 7320 6279 2074 6865 6972  t hosts by their
+00020c90: 2063 7572 7265 6e74 206d 656d 6f72 7920   current memory 
+00020ca0: 7573 652e 0a20 2020 2022 2222 0a0a 2020  use..    """..  
+00020cb0: 2020 6578 636c 7564 6564 5f6e 616d 6573    excluded_names
+00020cc0: 203d 207b 0a20 2020 2020 2020 2022 6578   = {.        "ex
+00020cd0: 6563 7574 696e 6722 2c0a 2020 2020 2020  ecuting",.      
+00020ce0: 2020 2269 6e5f 666c 6967 6874 222c 0a20    "in_flight",. 
+00020cf0: 2020 2020 2020 2022 696e 5f6d 656d 6f72         "in_memor
+00020d00: 7922 2c0a 2020 2020 2020 2020 2272 6561  y",.        "rea
+00020d10: 6479 222c 0a20 2020 2020 2020 2022 7469  dy",.        "ti
+00020d20: 6d65 222c 0a20 2020 2020 2020 2023 2055  me",.        # U
+00020d30: 7365 2073 6368 6564 756c 6572 2e57 6f72  se scheduler.Wor
+00020d40: 6b65 7253 7461 7465 2e6d 656d 6f72 792e  kerState.memory.
+00020d50: 6d61 6e61 6765 6420 696e 7374 6561 6420  managed instead 
+00020d60: 6f66 0a20 2020 2020 2020 2023 2073 6368  of.        # sch
+00020d70: 6564 756c 6572 2e57 6f72 6b65 7253 7461  eduler.WorkerSta
+00020d80: 7465 2e6d 6574 7269 6373 5b22 6d61 6e61  te.metrics["mana
+00020d90: 6765 645f 6279 7465 7322 5d3b 2074 6865  ged_bytes"]; the
+00020da0: 2074 776f 206d 6561 7375 7265 7320 6172   two measures ar
+00020db0: 6520 736c 6967 6874 6c79 0a20 2020 2020  e slightly.     
+00020dc0: 2020 2023 2064 6966 6665 7265 6e74 2e20     # different. 
+00020dd0: 5365 6520 6578 706c 616e 6174 696f 6e20  See explanation 
+00020de0: 696e 2073 6368 6564 756c 6572 2e57 6f72  in scheduler.Wor
+00020df0: 6b65 7253 7461 7465 2e6d 656d 6f72 7928  kerState.memory(
+00020e00: 292e 0a20 2020 2020 2020 2022 6d61 6e61  )..        "mana
+00020e10: 6765 645f 6279 7465 7322 2c0a 2020 2020  ged_bytes",.    
+00020e20: 2020 2020 2273 7069 6c6c 6564 5f62 7974      "spilled_byt
+00020e30: 6573 222c 0a20 2020 207d 0a0a 2020 2020  es",.    }..    
+00020e40: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+00020e50: 662c 2073 6368 6564 756c 6572 2c20 7769  f, scheduler, wi
+00020e60: 6474 683d 3830 302c 202a 2a6b 7761 7267  dth=800, **kwarg
+00020e70: 7329 3a0a 2020 2020 2020 2020 7365 6c66  s):.        self
+00020e80: 2e73 6368 6564 756c 6572 203d 2073 6368  .scheduler = sch
+00020e90: 6564 756c 6572 0a20 2020 2020 2020 2073  eduler.        s
+00020ea0: 656c 662e 6e61 6d65 7320 3d20 5b0a 2020  elf.names = [.  
+00020eb0: 2020 2020 2020 2020 2020 226e 616d 6522            "name"
+00020ec0: 2c0a 2020 2020 2020 2020 2020 2020 2261  ,.            "a
+00020ed0: 6464 7265 7373 222c 0a20 2020 2020 2020  ddress",.       
+00020ee0: 2020 2020 2022 6e74 6872 6561 6473 222c       "nthreads",
+00020ef0: 0a20 2020 2020 2020 2020 2020 2022 6370  .            "cp
+00020f00: 7522 2c0a 2020 2020 2020 2020 2020 2020  u",.            
+00020f10: 226d 656d 6f72 7922 2c0a 2020 2020 2020  "memory",.      
+00020f20: 2020 2020 2020 226d 656d 6f72 795f 6c69        "memory_li
+00020f30: 6d69 7422 2c0a 2020 2020 2020 2020 2020  mit",.          
+00020f40: 2020 226d 656d 6f72 795f 7065 7263 656e    "memory_percen
+00020f50: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
+00020f60: 226d 656d 6f72 795f 6d61 6e61 6765 6422  "memory_managed"
+00020f70: 2c0a 2020 2020 2020 2020 2020 2020 226d  ,.            "m
+00020f80: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
+00020f90: 6f6c 6422 2c0a 2020 2020 2020 2020 2020  old",.          
+00020fa0: 2020 226d 656d 6f72 795f 756e 6d61 6e61    "memory_unmana
+00020fb0: 6765 645f 7265 6365 6e74 222c 0a20 2020  ged_recent",.   
+00020fc0: 2020 2020 2020 2020 2022 6d65 6d6f 7279           "memory
+00020fd0: 5f73 7069 6c6c 6564 222c 0a20 2020 2020  _spilled",.     
+00020fe0: 2020 2020 2020 2022 6e75 6d5f 6664 7322         "num_fds"
+00020ff0: 2c0a 2020 2020 2020 2020 2020 2020 2268  ,.            "h
+00021000: 6f73 745f 6e65 745f 696f 2e72 6561 645f  ost_net_io.read_
+00021010: 6270 7322 2c0a 2020 2020 2020 2020 2020  bps",.          
+00021020: 2020 2268 6f73 745f 6e65 745f 696f 2e77    "host_net_io.w
+00021030: 7269 7465 5f62 7073 222c 0a20 2020 2020  rite_bps",.     
+00021040: 2020 2020 2020 2022 686f 7374 5f64 6973         "host_dis
+00021050: 6b5f 696f 2e72 6561 645f 6270 7322 2c0a  k_io.read_bps",.
+00021060: 2020 2020 2020 2020 2020 2020 2268 6f73              "hos
+00021070: 745f 6469 736b 5f69 6f2e 7772 6974 655f  t_disk_io.write_
+00021080: 6270 7322 2c0a 2020 2020 2020 2020 2020  bps",.          
+00021090: 2020 2263 7075 5f66 7261 6374 696f 6e22    "cpu_fraction"
+000210a0: 2c0a 2020 2020 2020 2020 5d0a 2020 2020  ,.        ].    
+000210b0: 2020 2020 776f 726b 6572 7320 3d20 7365      workers = se
+000210c0: 6c66 2e73 6368 6564 756c 6572 2e77 6f72  lf.scheduler.wor
+000210d0: 6b65 7273 2e76 616c 7565 7328 290a 2020  kers.values().  
+000210e0: 2020 2020 2020 7365 6c66 2e65 7874 7261        self.extra
+000210f0: 5f6e 616d 6573 203d 2073 6f72 7465 6428  _names = sorted(
+00021100: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00021110: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00021120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021130: 2066 6f72 2077 7320 696e 2077 6f72 6b65   for ws in worke
+00021140: 7273 0a20 2020 2020 2020 2020 2020 2020  rs.             
+00021150: 2020 2066 6f72 206d 2c20 7620 696e 2077     for m, v in w
+00021160: 732e 6d65 7472 6963 732e 6974 656d 7328  s.metrics.items(
+00021170: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00021180: 2020 6966 206d 206e 6f74 2069 6e20 7365    if m not in se
+00021190: 6c66 2e6e 616d 6573 2061 6e64 2069 7369  lf.names and isi
+000211a0: 6e73 7461 6e63 6528 762c 2028 7374 722c  nstance(v, (str,
+000211b0: 2069 6e74 2c20 666c 6f61 7429 290a 2020   int, float)).  
+000211c0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+000211d0: 2020 2020 2020 2020 2d20 7365 6c66 2e65          - self.e
+000211e0: 7863 6c75 6465 645f 6e61 6d65 730a 2020  xcluded_names.  
+000211f0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00021200: 2074 6162 6c65 5f6e 616d 6573 203d 205b   table_names = [
+00021210: 0a20 2020 2020 2020 2020 2020 2022 6e61  .            "na
+00021220: 6d65 222c 0a20 2020 2020 2020 2020 2020  me",.           
+00021230: 2022 6164 6472 6573 7322 2c0a 2020 2020   "address",.    
+00021240: 2020 2020 2020 2020 226e 7468 7265 6164          "nthread
+00021250: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
+00021260: 2263 7075 222c 0a20 2020 2020 2020 2020  "cpu",.         
+00021270: 2020 2022 6d65 6d6f 7279 222c 0a20 2020     "memory",.   
+00021280: 2020 2020 2020 2020 2022 6d65 6d6f 7279           "memory
+00021290: 5f6c 696d 6974 222c 0a20 2020 2020 2020  _limit",.       
+000212a0: 2020 2020 2022 6d65 6d6f 7279 5f70 6572       "memory_per
+000212b0: 6365 6e74 222c 0a20 2020 2020 2020 2020  cent",.         
+000212c0: 2020 2022 6d65 6d6f 7279 5f6d 616e 6167     "memory_manag
+000212d0: 6564 222c 0a20 2020 2020 2020 2020 2020  ed",.           
+000212e0: 2022 6d65 6d6f 7279 5f75 6e6d 616e 6167   "memory_unmanag
+000212f0: 6564 5f6f 6c64 222c 0a20 2020 2020 2020  ed_old",.       
+00021300: 2020 2020 2022 6d65 6d6f 7279 5f75 6e6d       "memory_unm
+00021310: 616e 6167 6564 5f72 6563 656e 7422 2c0a  anaged_recent",.
+00021320: 2020 2020 2020 2020 2020 2020 226d 656d              "mem
+00021330: 6f72 795f 7370 696c 6c65 6422 2c0a 2020  ory_spilled",.  
+00021340: 2020 2020 2020 2020 2020 226e 756d 5f66            "num_f
+00021350: 6473 222c 0a20 2020 2020 2020 2020 2020  ds",.           
+00021360: 2022 686f 7374 5f6e 6574 5f69 6f2e 7265   "host_net_io.re
+00021370: 6164 5f62 7073 222c 0a20 2020 2020 2020  ad_bps",.       
+00021380: 2020 2020 2022 686f 7374 5f6e 6574 5f69       "host_net_i
+00021390: 6f2e 7772 6974 655f 6270 7322 2c0a 2020  o.write_bps",.  
+000213a0: 2020 2020 2020 2020 2020 2268 6f73 745f            "host_
+000213b0: 6469 736b 5f69 6f2e 7265 6164 5f62 7073  disk_io.read_bps
+000213c0: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+000213d0: 686f 7374 5f64 6973 6b5f 696f 2e77 7269  host_disk_io.wri
+000213e0: 7465 5f62 7073 222c 0a20 2020 2020 2020  te_bps",.       
+000213f0: 205d 0a20 2020 2020 2020 2063 6f6c 756d   ].        colum
+00021400: 6e5f 7469 746c 655f 7265 6e61 6d65 7320  n_title_renames 
+00021410: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+00021420: 226d 656d 6f72 795f 6c69 6d69 7422 3a20  "memory_limit": 
+00021430: 226c 696d 6974 222c 0a20 2020 2020 2020  "limit",.       
+00021440: 2020 2020 2022 6d65 6d6f 7279 5f70 6572       "memory_per
+00021450: 6365 6e74 223a 2022 6d65 6d6f 7279 2025  cent": "memory %
+00021460: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+00021470: 6d65 6d6f 7279 5f6d 616e 6167 6564 223a  memory_managed":
+00021480: 2022 6d61 6e61 6765 6422 2c0a 2020 2020   "managed",.    
+00021490: 2020 2020 2020 2020 226d 656d 6f72 795f          "memory_
+000214a0: 756e 6d61 6e61 6765 645f 6f6c 6422 3a20  unmanaged_old": 
+000214b0: 2275 6e6d 616e 6167 6564 206f 6c64 222c  "unmanaged old",
+000214c0: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
+000214d0: 6d6f 7279 5f75 6e6d 616e 6167 6564 5f72  mory_unmanaged_r
+000214e0: 6563 656e 7422 3a20 2275 6e6d 616e 6167  ecent": "unmanag
+000214f0: 6564 2072 6563 656e 7422 2c0a 2020 2020  ed recent",.    
+00021500: 2020 2020 2020 2020 226d 656d 6f72 795f          "memory_
+00021510: 7370 696c 6c65 6422 3a20 2273 7069 6c6c  spilled": "spill
+00021520: 6564 222c 0a20 2020 2020 2020 2020 2020  ed",.           
+00021530: 2022 6e75 6d5f 6664 7322 3a20 2223 2066   "num_fds": "# f
+00021540: 6473 222c 0a20 2020 2020 2020 2020 2020  ds",.           
+00021550: 2022 686f 7374 5f6e 6574 5f69 6f2e 7265   "host_net_io.re
+00021560: 6164 5f62 7073 223a 2022 6e65 7420 7265  ad_bps": "net re
+00021570: 6164 222c 0a20 2020 2020 2020 2020 2020  ad",.           
+00021580: 2022 686f 7374 5f6e 6574 5f69 6f2e 7772   "host_net_io.wr
+00021590: 6974 655f 6270 7322 3a20 226e 6574 2077  ite_bps": "net w
+000215a0: 7269 7465 222c 0a20 2020 2020 2020 2020  rite",.         
+000215b0: 2020 2022 686f 7374 5f64 6973 6b5f 696f     "host_disk_io
+000215c0: 2e72 6561 645f 6270 7322 3a20 2264 6973  .read_bps": "dis
+000215d0: 6b20 7265 6164 222c 0a20 2020 2020 2020  k read",.       
+000215e0: 2020 2020 2022 686f 7374 5f64 6973 6b5f       "host_disk_
+000215f0: 696f 2e77 7269 7465 5f62 7073 223a 2022  io.write_bps": "
+00021600: 6469 736b 2077 7269 7465 222c 0a20 2020  disk write",.   
+00021610: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+00021620: 7365 6c66 2e73 6f75 7263 6520 3d20 436f  self.source = Co
+00021630: 6c75 6d6e 4461 7461 536f 7572 6365 287b  lumnDataSource({
+00021640: 6b3a 205b 5d20 666f 7220 6b20 696e 2073  k: [] for k in s
+00021650: 656c 662e 6e61 6d65 737d 290a 0a20 2020  elf.names})..   
+00021660: 2020 2020 2063 6f6c 756d 6e73 203d 207b       columns = {
+00021670: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+00021680: 653a 2054 6162 6c65 436f 6c75 6d6e 2866  e: TableColumn(f
+00021690: 6965 6c64 3d6e 616d 652c 2074 6974 6c65  ield=name, title
+000216a0: 3d63 6f6c 756d 6e5f 7469 746c 655f 7265  =column_title_re
+000216b0: 6e61 6d65 732e 6765 7428 6e61 6d65 2c20  names.get(name, 
+000216c0: 6e61 6d65 2929 0a20 2020 2020 2020 2020  name)).         
+000216d0: 2020 2066 6f72 206e 616d 6520 696e 2074     for name in t
+000216e0: 6162 6c65 5f6e 616d 6573 0a20 2020 2020  able_names.     
+000216f0: 2020 207d 0a0a 2020 2020 2020 2020 666f     }..        fo
+00021700: 726d 6174 7465 7273 203d 207b 0a20 2020  rmatters = {.   
+00021710: 2020 2020 2020 2020 2022 6370 7522 3a20           "cpu": 
+00021720: 4e75 6d62 6572 466f 726d 6174 7465 7228  NumberFormatter(
+00021730: 666f 726d 6174 3d22 3020 2522 292c 0a20  format="0 %"),. 
+00021740: 2020 2020 2020 2020 2020 2022 6d65 6d6f             "memo
+00021750: 7279 5f70 6572 6365 6e74 223a 204e 756d  ry_percent": Num
+00021760: 6265 7246 6f72 6d61 7474 6572 2866 6f72  berFormatter(for
+00021770: 6d61 743d 2230 2e30 2025 2229 2c0a 2020  mat="0.0 %"),.  
+00021780: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
+00021790: 7922 3a20 4e75 6d62 6572 466f 726d 6174  y": NumberFormat
+000217a0: 7465 7228 666f 726d 6174 3d22 302e 3020  ter(format="0.0 
+000217b0: 6222 292c 0a20 2020 2020 2020 2020 2020  b"),.           
+000217c0: 2022 6d65 6d6f 7279 5f6c 696d 6974 223a   "memory_limit":
+000217d0: 204e 756d 6265 7246 6f72 6d61 7474 6572   NumberFormatter
+000217e0: 2866 6f72 6d61 743d 2230 2e30 2062 2229  (format="0.0 b")
+000217f0: 2c0a 2020 2020 2020 2020 2020 2020 226d  ,.            "m
+00021800: 656d 6f72 795f 6d61 6e61 6765 6422 3a20  emory_managed": 
+00021810: 4e75 6d62 6572 466f 726d 6174 7465 7228  NumberFormatter(
+00021820: 666f 726d 6174 3d22 302e 3020 6222 292c  format="0.0 b"),
+00021830: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
+00021840: 6d6f 7279 5f75 6e6d 616e 6167 6564 5f6f  mory_unmanaged_o
+00021850: 6c64 223a 204e 756d 6265 7246 6f72 6d61  ld": NumberForma
+00021860: 7474 6572 2866 6f72 6d61 743d 2230 2e30  tter(format="0.0
+00021870: 2062 2229 2c0a 2020 2020 2020 2020 2020   b"),.          
+00021880: 2020 226d 656d 6f72 795f 756e 6d61 6e61    "memory_unmana
+00021890: 6765 645f 7265 6365 6e74 223a 204e 756d  ged_recent": Num
+000218a0: 6265 7246 6f72 6d61 7474 6572 2866 6f72  berFormatter(for
+000218b0: 6d61 743d 2230 2e30 2062 2229 2c0a 2020  mat="0.0 b"),.  
+000218c0: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
+000218d0: 795f 7370 696c 6c65 6422 3a20 4e75 6d62  y_spilled": Numb
+000218e0: 6572 466f 726d 6174 7465 7228 666f 726d  erFormatter(form
+000218f0: 6174 3d22 302e 3020 6222 292c 0a20 2020  at="0.0 b"),.   
+00021900: 2020 2020 2020 2020 2022 686f 7374 5f6e           "host_n
+00021910: 6574 5f69 6f2e 7265 6164 5f62 7073 223a  et_io.read_bps":
+00021920: 204e 756d 6265 7246 6f72 6d61 7474 6572   NumberFormatter
+00021930: 2866 6f72 6d61 743d 2230 2062 2229 2c0a  (format="0 b"),.
+00021940: 2020 2020 2020 2020 2020 2020 2268 6f73              "hos
+00021950: 745f 6e65 745f 696f 2e77 7269 7465 5f62  t_net_io.write_b
+00021960: 7073 223a 204e 756d 6265 7246 6f72 6d61  ps": NumberForma
+00021970: 7474 6572 2866 6f72 6d61 743d 2230 2062  tter(format="0 b
+00021980: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+00021990: 226e 756d 5f66 6473 223a 204e 756d 6265  "num_fds": Numbe
+000219a0: 7246 6f72 6d61 7474 6572 2866 6f72 6d61  rFormatter(forma
+000219b0: 743d 2230 2229 2c0a 2020 2020 2020 2020  t="0"),.        
+000219c0: 2020 2020 226e 7468 7265 6164 7322 3a20      "nthreads": 
+000219d0: 4e75 6d62 6572 466f 726d 6174 7465 7228  NumberFormatter(
+000219e0: 666f 726d 6174 3d22 3022 292c 0a20 2020  format="0"),.   
+000219f0: 2020 2020 2020 2020 2022 686f 7374 5f64           "host_d
+00021a00: 6973 6b5f 696f 2e72 6561 645f 6270 7322  isk_io.read_bps"
+00021a10: 3a20 4e75 6d62 6572 466f 726d 6174 7465  : NumberFormatte
+00021a20: 7228 666f 726d 6174 3d22 3020 6222 292c  r(format="0 b"),
+00021a30: 0a20 2020 2020 2020 2020 2020 2022 686f  .            "ho
+00021a40: 7374 5f64 6973 6b5f 696f 2e77 7269 7465  st_disk_io.write
+00021a50: 5f62 7073 223a 204e 756d 6265 7246 6f72  _bps": NumberFor
+00021a60: 6d61 7474 6572 2866 6f72 6d61 743d 2230  matter(format="0
+00021a70: 2062 2229 2c0a 2020 2020 2020 2020 7d0a   b"),.        }.
+00021a80: 0a20 2020 2020 2020 2074 6162 6c65 203d  .        table =
+00021a90: 2044 6174 6154 6162 6c65 280a 2020 2020   DataTable(.    
+00021aa0: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
+00021ab0: 656c 662e 736f 7572 6365 2c0a 2020 2020  elf.source,.    
+00021ac0: 2020 2020 2020 2020 636f 6c75 6d6e 733d          columns=
+00021ad0: 5b63 6f6c 756d 6e73 5b6e 5d20 666f 7220  [columns[n] for 
+00021ae0: 6e20 696e 2074 6162 6c65 5f6e 616d 6573  n in table_names
+00021af0: 5d2c 0a20 2020 2020 2020 2020 2020 2072  ],.            r
+00021b00: 656f 7264 6572 6162 6c65 3d54 7275 652c  eorderable=True,
+00021b10: 0a20 2020 2020 2020 2020 2020 2073 6f72  .            sor
+00021b20: 7461 626c 653d 5472 7565 2c0a 2020 2020  table=True,.    
+00021b30: 2020 2020 2020 2020 7769 6474 683d 7769          width=wi
+00021b40: 6474 682c 0a20 2020 2020 2020 2020 2020  dth,.           
+00021b50: 2069 6e64 6578 5f70 6f73 6974 696f 6e3d   index_position=
+00021b60: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+00021b70: 2020 2a2a 5f44 4154 4154 4142 4c45 5f53    **_DATATABLE_S
+00021b80: 5459 4c45 5348 4545 5453 5f4b 5741 5247  TYLESHEETS_KWARG
+00021b90: 532c 0a20 2020 2020 2020 2029 0a0a 2020  S,.        )..  
+00021ba0: 2020 2020 2020 666f 7220 6e61 6d65 2069        for name i
+00021bb0: 6e20 7461 626c 655f 6e61 6d65 733a 0a20  n table_names:. 
+00021bc0: 2020 2020 2020 2020 2020 2069 6620 6e61             if na
+00021bd0: 6d65 2069 6e20 666f 726d 6174 7465 7273  me in formatters
+00021be0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00021bf0: 2020 7461 626c 652e 636f 6c75 6d6e 735b    table.columns[
+00021c00: 7461 626c 655f 6e61 6d65 732e 696e 6465  table_names.inde
+00021c10: 7828 6e61 6d65 295d 2e66 6f72 6d61 7474  x(name)].formatt
+00021c20: 6572 203d 2066 6f72 6d61 7474 6572 735b  er = formatters[
+00021c30: 6e61 6d65 5d0a 0a20 2020 2020 2020 2065  name]..        e
+00021c40: 7874 7261 5f6e 616d 6573 203d 205b 226e  xtra_names = ["n
+00021c50: 616d 6522 2c20 2261 6464 7265 7373 225d  ame", "address"]
+00021c60: 202b 2073 656c 662e 6578 7472 615f 6e61   + self.extra_na
+00021c70: 6d65 730a 2020 2020 2020 2020 6578 7472  mes.        extr
+00021c80: 615f 636f 6c75 6d6e 7320 3d20 7b0a 2020  a_columns = {.  
+00021c90: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
+00021ca0: 5461 626c 6543 6f6c 756d 6e28 6669 656c  TableColumn(fiel
+00021cb0: 643d 6e61 6d65 2c20 7469 746c 653d 636f  d=name, title=co
+00021cc0: 6c75 6d6e 5f74 6974 6c65 5f72 656e 616d  lumn_title_renam
+00021cd0: 6573 2e67 6574 286e 616d 652c 206e 616d  es.get(name, nam
+00021ce0: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
+00021cf0: 666f 7220 6e61 6d65 2069 6e20 6578 7472  for name in extr
+00021d00: 615f 6e61 6d65 730a 2020 2020 2020 2020  a_names.        
+00021d10: 7d0a 0a20 2020 2020 2020 2065 7874 7261  }..        extra
+00021d20: 5f74 6162 6c65 203d 2044 6174 6154 6162  _table = DataTab
+00021d30: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
+00021d40: 736f 7572 6365 3d73 656c 662e 736f 7572  source=self.sour
+00021d50: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
+00021d60: 636f 6c75 6d6e 733d 5b65 7874 7261 5f63  columns=[extra_c
+00021d70: 6f6c 756d 6e73 5b6e 5d20 666f 7220 6e20  olumns[n] for n 
+00021d80: 696e 2065 7874 7261 5f6e 616d 6573 5d2c  in extra_names],
+00021d90: 0a20 2020 2020 2020 2020 2020 2072 656f  .            reo
+00021da0: 7264 6572 6162 6c65 3d54 7275 652c 0a20  rderable=True,. 
+00021db0: 2020 2020 2020 2020 2020 2073 6f72 7461             sorta
+00021dc0: 626c 653d 5472 7565 2c0a 2020 2020 2020  ble=True,.      
+00021dd0: 2020 2020 2020 7769 6474 683d 7769 6474        width=widt
+00021de0: 682c 0a20 2020 2020 2020 2020 2020 2069  h,.            i
+00021df0: 6e64 6578 5f70 6f73 6974 696f 6e3d 4e6f  ndex_position=No
+00021e00: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+00021e10: 2a2a 5f44 4154 4154 4142 4c45 5f53 5459  **_DATATABLE_STY
+00021e20: 4c45 5348 4545 5453 5f4b 5741 5247 532c  LESHEETS_KWARGS,
+00021e30: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00021e40: 2020 2020 666f 7220 6e61 6d65 2069 6e20      for name in 
+00021e50: 6578 7472 615f 6e61 6d65 733a 0a20 2020  extra_names:.   
+00021e60: 2020 2020 2020 2020 2069 6620 6e61 6d65           if name
+00021e70: 2069 6e20 666f 726d 6174 7465 7273 3a0a   in formatters:.
+00021e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021e90: 6578 7472 615f 7461 626c 652e 636f 6c75  extra_table.colu
+00021ea0: 6d6e 735b 6578 7472 615f 6e61 6d65 732e  mns[extra_names.
+00021eb0: 696e 6465 7828 6e61 6d65 295d 2e66 6f72  index(name)].for
+00021ec0: 6d61 7474 6572 203d 2066 6f72 6d61 7474  matter = formatt
+00021ed0: 6572 735b 0a20 2020 2020 2020 2020 2020  ers[.           
+00021ee0: 2020 2020 2020 2020 206e 616d 650a 2020           name.  
+00021ef0: 2020 2020 2020 2020 2020 2020 2020 5d0a                ].
+00021f00: 0a20 2020 2020 2020 2068 6f76 6572 203d  .        hover =
+00021f10: 2048 6f76 6572 546f 6f6c 280a 2020 2020   HoverTool(.    
+00021f20: 2020 2020 2020 2020 706f 696e 745f 706f          point_po
+00021f30: 6c69 6379 3d22 666f 6c6c 6f77 5f6d 6f75  licy="follow_mou
+00021f40: 7365 222c 0a20 2020 2020 2020 2020 2020  se",.           
+00021f50: 2074 6f6f 6c74 6970 733d 2222 220a 2020   tooltips=""".  
+00021f60: 2020 2020 2020 2020 2020 2020 2020 3c64                <d
+00021f70: 6976 3e0a 2020 2020 2020 2020 2020 2020  iv>.            
+00021f80: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
+00021f90: 653d 2266 6f6e 742d 7369 7a65 3a20 3130  e="font-size: 10
+00021fa0: 7078 3b20 666f 6e74 2d66 616d 696c 793a  px; font-family:
+00021fb0: 204d 6f6e 6163 6f2c 206d 6f6e 6f73 7061   Monaco, monospa
+00021fc0: 6365 3b22 3e57 6f72 6b65 7220 2840 6e61  ce;">Worker (@na
+00021fd0: 6d65 293a 203c 2f73 7061 6e3e 0a20 2020  me): </span>.   
+00021fe0: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+00021ff0: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
+00022000: 2d73 697a 653a 2031 3070 783b 2066 6f6e  -size: 10px; fon
+00022010: 742d 6661 6d69 6c79 3a20 4d6f 6e61 636f  t-family: Monaco
+00022020: 2c20 6d6f 6e6f 7370 6163 653b 223e 406d  , monospace;">@m
+00022030: 656d 6f72 795f 7065 7263 656e 747b 302e  emory_percent{0.
+00022040: 3020 257d 3c2f 7370 616e 3e0a 2020 2020  0 %}</span>.    
+00022050: 2020 2020 2020 2020 2020 2020 3c2f 6469              </di
+00022060: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
+00022070: 2020 2022 2222 2c0a 2020 2020 2020 2020     """,.        
+00022080: 290a 0a20 2020 2020 2020 206d 656d 5f70  )..        mem_p
+00022090: 6c6f 7420 3d20 6669 6775 7265 280a 2020  lot = figure(.  
+000220a0: 2020 2020 2020 2020 2020 7469 746c 653d            title=
+000220b0: 224d 656d 6f72 7920 5573 6520 2825 2922  "Memory Use (%)"
+000220c0: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
+000220d0: 6f6c 6261 725f 6c6f 6361 7469 6f6e 3d4e  olbar_location=N
+000220e0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+000220f0: 2078 5f72 616e 6765 3d28 302c 2031 292c   x_range=(0, 1),
+00022100: 0a20 2020 2020 2020 2020 2020 2079 5f72  .            y_r
+00022110: 616e 6765 3d28 2d30 2e31 2c20 302e 3129  ange=(-0.1, 0.1)
+00022120: 2c0a 2020 2020 2020 2020 2020 2020 6865  ,.            he
+00022130: 6967 6874 3d36 302c 0a20 2020 2020 2020  ight=60,.       
+00022140: 2020 2020 2077 6964 7468 3d77 6964 7468       width=width
+00022150: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
+00022160: 6f6c 733d 2222 2c0a 2020 2020 2020 2020  ols="",.        
+00022170: 2020 2020 6d69 6e5f 626f 7264 6572 5f72      min_border_r
+00022180: 6967 6874 3d30 2c0a 2020 2020 2020 2020  ight=0,.        
+00022190: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
+000221a0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000221b0: 6d65 6d5f 706c 6f74 2e63 6972 636c 6528  mem_plot.circle(
+000221c0: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
+000221d0: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
+000221e0: 2078 3d22 6d65 6d6f 7279 5f70 6572 6365   x="memory_perce
+000221f0: 6e74 222c 2079 3d30 2c20 7369 7a65 3d31  nt", y=0, size=1
+00022200: 302c 2066 696c 6c5f 616c 7068 613d 302e  0, fill_alpha=0.
+00022210: 350a 2020 2020 2020 2020 290a 2020 2020  5.        ).    
+00022220: 2020 2020 6d65 6d5f 706c 6f74 2e79 6772      mem_plot.ygr
+00022230: 6964 2e76 6973 6962 6c65 203d 2046 616c  id.visible = Fal
+00022240: 7365 0a20 2020 2020 2020 206d 656d 5f70  se.        mem_p
+00022250: 6c6f 742e 7961 7869 732e 6d69 6e6f 725f  lot.yaxis.minor_
+00022260: 7469 636b 5f6c 696e 655f 616c 7068 6120  tick_line_alpha 
+00022270: 3d20 300a 2020 2020 2020 2020 6d65 6d5f  = 0.        mem_
+00022280: 706c 6f74 2e78 6178 6973 2e76 6973 6962  plot.xaxis.visib
+00022290: 6c65 203d 2046 616c 7365 0a20 2020 2020  le = False.     
+000222a0: 2020 206d 656d 5f70 6c6f 742e 7961 7869     mem_plot.yaxi
+000222b0: 732e 7669 7369 626c 6520 3d20 4661 6c73  s.visible = Fals
+000222c0: 650a 2020 2020 2020 2020 6d65 6d5f 706c  e.        mem_pl
+000222d0: 6f74 2e61 6464 5f74 6f6f 6c73 2868 6f76  ot.add_tools(hov
+000222e0: 6572 2c20 426f 7853 656c 6563 7454 6f6f  er, BoxSelectToo
+000222f0: 6c28 2929 0a0a 2020 2020 2020 2020 686f  l())..        ho
+00022300: 7665 7220 3d20 486f 7665 7254 6f6f 6c28  ver = HoverTool(
+00022310: 0a20 2020 2020 2020 2020 2020 2070 6f69  .            poi
+00022320: 6e74 5f70 6f6c 6963 793d 2266 6f6c 6c6f  nt_policy="follo
+00022330: 775f 6d6f 7573 6522 2c0a 2020 2020 2020  w_mouse",.      
+00022340: 2020 2020 2020 746f 6f6c 7469 7073 3d22        tooltips="
+00022350: 2222 0a20 2020 2020 2020 2020 2020 2020  "".             
+00022360: 2020 203c 6469 763e 0a20 2020 2020 2020     <div>.       
+00022370: 2020 2020 2020 2020 2020 203c 7370 616e             <span
+00022380: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
+00022390: 653a 2031 3070 783b 2066 6f6e 742d 6661  e: 10px; font-fa
+000223a0: 6d69 6c79 3a20 4d6f 6e61 636f 2c20 6d6f  mily: Monaco, mo
+000223b0: 6e6f 7370 6163 653b 223e 576f 726b 6572  nospace;">Worker
+000223c0: 2028 406e 616d 6529 3a20 3c2f 7370 616e   (@name): </span
+000223d0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+000223e0: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
+000223f0: 2266 6f6e 742d 7369 7a65 3a20 3130 7078  "font-size: 10px
+00022400: 3b20 666f 6e74 2d66 616d 696c 793a 204d  ; font-family: M
+00022410: 6f6e 6163 6f2c 206d 6f6e 6f73 7061 6365  onaco, monospace
+00022420: 3b22 3e40 6370 755f 6672 6163 7469 6f6e  ;">@cpu_fraction
+00022430: 7b30 2025 7d3c 2f73 7061 6e3e 0a20 2020  {0 %}</span>.   
+00022440: 2020 2020 2020 2020 2020 2020 203c 2f64               </d
+00022450: 6976 3e0a 2020 2020 2020 2020 2020 2020  iv>.            
+00022460: 2020 2020 2222 222c 0a20 2020 2020 2020      """,.       
+00022470: 2029 0a0a 2020 2020 2020 2020 6370 755f   )..        cpu_
+00022480: 706c 6f74 203d 2066 6967 7572 6528 0a20  plot = figure(. 
+00022490: 2020 2020 2020 2020 2020 2074 6974 6c65             title
+000224a0: 3d22 4350 5520 5573 6520 2825 2922 2c0a  ="CPU Use (%)",.
+000224b0: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
+000224c0: 6261 725f 6c6f 6361 7469 6f6e 3d4e 6f6e  bar_location=Non
+000224d0: 652c 0a20 2020 2020 2020 2020 2020 2078  e,.            x
+000224e0: 5f72 616e 6765 3d28 302c 2031 292c 0a20  _range=(0, 1),. 
+000224f0: 2020 2020 2020 2020 2020 2079 5f72 616e             y_ran
+00022500: 6765 3d28 2d30 2e31 2c20 302e 3129 2c0a  ge=(-0.1, 0.1),.
+00022510: 2020 2020 2020 2020 2020 2020 6865 6967              heig
+00022520: 6874 3d36 302c 0a20 2020 2020 2020 2020  ht=60,.         
+00022530: 2020 2077 6964 7468 3d77 6964 7468 2c0a     width=width,.
+00022540: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
+00022550: 733d 2222 2c0a 2020 2020 2020 2020 2020  s="",.          
+00022560: 2020 6d69 6e5f 626f 7264 6572 5f72 6967    min_border_rig
+00022570: 6874 3d30 2c0a 2020 2020 2020 2020 2020  ht=0,.          
+00022580: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
+00022590: 2020 2020 290a 2020 2020 2020 2020 6370      ).        cp
+000225a0: 755f 706c 6f74 2e63 6972 636c 6528 0a20  u_plot.circle(. 
+000225b0: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
+000225c0: 653d 7365 6c66 2e73 6f75 7263 652c 2078  e=self.source, x
+000225d0: 3d22 6370 755f 6672 6163 7469 6f6e 222c  ="cpu_fraction",
+000225e0: 2079 3d30 2c20 7369 7a65 3d31 302c 2066   y=0, size=10, f
+000225f0: 696c 6c5f 616c 7068 613d 302e 350a 2020  ill_alpha=0.5.  
+00022600: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00022610: 6370 755f 706c 6f74 2e79 6772 6964 2e76  cpu_plot.ygrid.v
+00022620: 6973 6962 6c65 203d 2046 616c 7365 0a20  isible = False. 
+00022630: 2020 2020 2020 2063 7075 5f70 6c6f 742e         cpu_plot.
+00022640: 7961 7869 732e 6d69 6e6f 725f 7469 636b  yaxis.minor_tick
+00022650: 5f6c 696e 655f 616c 7068 6120 3d20 300a  _line_alpha = 0.
+00022660: 2020 2020 2020 2020 6370 755f 706c 6f74          cpu_plot
+00022670: 2e78 6178 6973 2e76 6973 6962 6c65 203d  .xaxis.visible =
+00022680: 2046 616c 7365 0a20 2020 2020 2020 2063   False.        c
+00022690: 7075 5f70 6c6f 742e 7961 7869 732e 7669  pu_plot.yaxis.vi
+000226a0: 7369 626c 6520 3d20 4661 6c73 650a 2020  sible = False.  
+000226b0: 2020 2020 2020 6370 755f 706c 6f74 2e61        cpu_plot.a
+000226c0: 6464 5f74 6f6f 6c73 2868 6f76 6572 2c20  dd_tools(hover, 
+000226d0: 426f 7853 656c 6563 7454 6f6f 6c28 2929  BoxSelectTool())
+000226e0: 0a20 2020 2020 2020 2073 656c 662e 6370  .        self.cp
+000226f0: 755f 706c 6f74 203d 2063 7075 5f70 6c6f  u_plot = cpu_plo
+00022700: 740a 0a20 2020 2020 2020 2069 6620 2273  t..        if "s
+00022710: 697a 696e 675f 6d6f 6465 2220 696e 206b  izing_mode" in k
+00022720: 7761 7267 733a 0a20 2020 2020 2020 2020  wargs:.         
+00022730: 2020 2073 697a 696e 675f 6d6f 6465 203d     sizing_mode =
+00022740: 207b 2273 697a 696e 675f 6d6f 6465 223a   {"sizing_mode":
+00022750: 206b 7761 7267 735b 2273 697a 696e 675f   kwargs["sizing_
+00022760: 6d6f 6465 225d 7d0a 2020 2020 2020 2020  mode"]}.        
+00022770: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00022780: 2020 7369 7a69 6e67 5f6d 6f64 6520 3d20    sizing_mode = 
+00022790: 7b7d 0a0a 2020 2020 2020 2020 636f 6d70  {}..        comp
+000227a0: 6f6e 656e 7473 203d 205b 6370 755f 706c  onents = [cpu_pl
+000227b0: 6f74 2c20 6d65 6d5f 706c 6f74 2c20 7461  ot, mem_plot, ta
+000227c0: 626c 655d 0a20 2020 2020 2020 2069 6620  ble].        if 
+000227d0: 7365 6c66 2e65 7874 7261 5f6e 616d 6573  self.extra_names
+000227e0: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
+000227f0: 6d70 6f6e 656e 7473 2e61 7070 656e 6428  mponents.append(
+00022800: 6578 7472 615f 7461 626c 6529 0a0a 2020  extra_table)..  
+00022810: 2020 2020 2020 7365 6c66 2e72 6f6f 7420        self.root 
+00022820: 3d20 636f 6c75 6d6e 282a 636f 6d70 6f6e  = column(*compon
+00022830: 656e 7473 2c20 2a2a 7369 7a69 6e67 5f6d  ents, **sizing_m
+00022840: 6f64 6529 0a0a 2020 2020 4077 6974 686f  ode)..    @witho
+00022850: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
+00022860: 6461 7469 6f6e 0a20 2020 2064 6566 2075  dation.    def u
+00022870: 7064 6174 6528 7365 6c66 293a 0a20 2020  pdate(self):.   
+00022880: 2020 2020 2064 6174 6120 3d20 7b6e 616d       data = {nam
+00022890: 653a 205b 5d20 666f 7220 6e61 6d65 2069  e: [] for name i
+000228a0: 6e20 7365 6c66 2e6e 616d 6573 202b 2073  n self.names + s
+000228b0: 656c 662e 6578 7472 615f 6e61 6d65 737d  elf.extra_names}
+000228c0: 0a20 2020 2020 2020 2066 6f72 2069 2c20  .        for i, 
+000228d0: 7773 2069 6e20 656e 756d 6572 6174 6528  ws in enumerate(
+000228e0: 0a20 2020 2020 2020 2020 2020 2073 6f72  .            sor
+000228f0: 7465 6428 7365 6c66 2e73 6368 6564 756c  ted(self.schedul
+00022900: 6572 2e77 6f72 6b65 7273 2e76 616c 7565  er.workers.value
+00022910: 7328 292c 206b 6579 3d6c 616d 6264 6120  s(), key=lambda 
+00022920: 7773 3a20 7374 7228 7773 2e6e 616d 6529  ws: str(ws.name)
+00022930: 290a 2020 2020 2020 2020 293a 0a20 2020  ).        ):.   
+00022940: 2020 2020 2020 2020 206d 696e 666f 203d           minfo =
+00022950: 2077 732e 6d65 6d6f 7279 0a0a 2020 2020   ws.memory..    
+00022960: 2020 2020 2020 2020 666f 7220 6e61 6d65          for name
+00022970: 2069 6e20 7365 6c66 2e6e 616d 6573 202b   in self.names +
+00022980: 2073 656c 662e 6578 7472 615f 6e61 6d65   self.extra_name
+00022990: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+000229a0: 2020 2069 6620 222e 2220 696e 206e 616d     if "." in nam
+000229b0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000229c0: 2020 2020 2020 206e 302c 205f 2c20 6e31         n0, _, n1
+000229d0: 203d 206e 616d 652e 7061 7274 6974 696f   = name.partitio
+000229e0: 6e28 222e 2229 0a20 2020 2020 2020 2020  n(".").         
+000229f0: 2020 2020 2020 2020 2020 2076 203d 2077             v = w
+00022a00: 732e 6d65 7472 6963 732e 6765 7428 6e30  s.metrics.get(n0
+00022a10: 2c20 7b7d 292e 6765 7428 6e31 2c20 4e6f  , {}).get(n1, No
+00022a20: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
+00022a30: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00022a40: 2020 2020 2020 2020 2020 2020 2020 7620                v 
+00022a50: 3d20 7773 2e6d 6574 7269 6373 2e67 6574  = ws.metrics.get
+00022a60: 286e 616d 652c 204e 6f6e 6529 0a20 2020  (name, None).   
+00022a70: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+00022a80: 615b 6e61 6d65 5d2e 6170 7065 6e64 2876  a[name].append(v
+00022a90: 290a 0a20 2020 2020 2020 2020 2020 2064  )..            d
+00022aa0: 6174 615b 226e 616d 6522 5d5b 2d31 5d20  ata["name"][-1] 
+00022ab0: 3d20 7773 2e6e 616d 6520 6966 2077 732e  = ws.name if ws.
+00022ac0: 6e61 6d65 2069 7320 6e6f 7420 4e6f 6e65  name is not None
+00022ad0: 2065 6c73 6520 690a 2020 2020 2020 2020   else i.        
+00022ae0: 2020 2020 6461 7461 5b22 6164 6472 6573      data["addres
+00022af0: 7322 5d5b 2d31 5d20 3d20 7773 2e61 6464  s"][-1] = ws.add
+00022b00: 7265 7373 0a20 2020 2020 2020 2020 2020  ress.           
+00022b10: 2069 6620 7773 2e6d 656d 6f72 795f 6c69   if ws.memory_li
+00022b20: 6d69 743a 0a20 2020 2020 2020 2020 2020  mit:.           
+00022b30: 2020 2020 2064 6174 615b 226d 656d 6f72       data["memor
+00022b40: 795f 7065 7263 656e 7422 5d5b 2d31 5d20  y_percent"][-1] 
+00022b50: 3d20 7773 2e6d 6574 7269 6373 5b22 6d65  = ws.metrics["me
+00022b60: 6d6f 7279 225d 202f 2077 732e 6d65 6d6f  mory"] / ws.memo
+00022b70: 7279 5f6c 696d 6974 0a20 2020 2020 2020  ry_limit.       
+00022b80: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00022b90: 2020 2020 2020 2020 2020 2064 6174 615b             data[
+00022ba0: 226d 656d 6f72 795f 7065 7263 656e 7422  "memory_percent"
+00022bb0: 5d5b 2d31 5d20 3d20 2222 0a20 2020 2020  ][-1] = "".     
+00022bc0: 2020 2020 2020 2064 6174 615b 226d 656d         data["mem
+00022bd0: 6f72 795f 6c69 6d69 7422 5d5b 2d31 5d20  ory_limit"][-1] 
+00022be0: 3d20 7773 2e6d 656d 6f72 795f 6c69 6d69  = ws.memory_limi
+00022bf0: 740a 2020 2020 2020 2020 2020 2020 6461  t.            da
+00022c00: 7461 5b22 6d65 6d6f 7279 5f6d 616e 6167  ta["memory_manag
+00022c10: 6564 225d 5b2d 315d 203d 206d 696e 666f  ed"][-1] = minfo
+00022c20: 2e6d 616e 6167 6564 0a20 2020 2020 2020  .managed.       
+00022c30: 2020 2020 2064 6174 615b 226d 656d 6f72       data["memor
+00022c40: 795f 756e 6d61 6e61 6765 645f 6f6c 6422  y_unmanaged_old"
+00022c50: 5d5b 2d31 5d20 3d20 6d69 6e66 6f2e 756e  ][-1] = minfo.un
+00022c60: 6d61 6e61 6765 645f 6f6c 640a 2020 2020  managed_old.    
+00022c70: 2020 2020 2020 2020 6461 7461 5b22 6d65          data["me
+00022c80: 6d6f 7279 5f75 6e6d 616e 6167 6564 5f72  mory_unmanaged_r
+00022c90: 6563 656e 7422 5d5b 2d31 5d20 3d20 6d69  ecent"][-1] = mi
+00022ca0: 6e66 6f2e 756e 6d61 6e61 6765 645f 7265  nfo.unmanaged_re
+00022cb0: 6365 6e74 0a20 2020 2020 2020 2020 2020  cent.           
+00022cc0: 2064 6174 615b 226d 656d 6f72 795f 756e   data["memory_un
+00022cd0: 6d61 6e61 6765 645f 7265 6365 6e74 225d  managed_recent"]
+00022ce0: 5b2d 315d 203d 206d 696e 666f 2e75 6e6d  [-1] = minfo.unm
+00022cf0: 616e 6167 6564 5f72 6563 656e 740a 2020  anaged_recent.  
+00022d00: 2020 2020 2020 2020 2020 6461 7461 5b22            data["
+00022d10: 6d65 6d6f 7279 5f73 7069 6c6c 6564 225d  memory_spilled"]
+00022d20: 5b2d 315d 203d 206d 696e 666f 2e73 7069  [-1] = minfo.spi
+00022d30: 6c6c 6564 0a20 2020 2020 2020 2020 2020  lled.           
+00022d40: 2064 6174 615b 2263 7075 225d 5b2d 315d   data["cpu"][-1]
+00022d50: 203d 2077 732e 6d65 7472 6963 735b 2263   = ws.metrics["c
+00022d60: 7075 225d 202f 2031 3030 2e30 0a20 2020  pu"] / 100.0.   
+00022d70: 2020 2020 2020 2020 2064 6174 615b 2263           data["c
+00022d80: 7075 5f66 7261 6374 696f 6e22 5d5b 2d31  pu_fraction"][-1
+00022d90: 5d20 3d20 7773 2e6d 6574 7269 6373 5b22  ] = ws.metrics["
+00022da0: 6370 7522 5d20 2f20 3130 302e 3020 2f20  cpu"] / 100.0 / 
+00022db0: 7773 2e6e 7468 7265 6164 730a 2020 2020  ws.nthreads.    
+00022dc0: 2020 2020 2020 2020 6461 7461 5b22 6e74          data["nt
+00022dd0: 6872 6561 6473 225d 5b2d 315d 203d 2077  hreads"][-1] = w
+00022de0: 732e 6e74 6872 6561 6473 0a0a 2020 2020  s.nthreads..    
+00022df0: 2020 2020 666f 7220 6e61 6d65 2069 6e20      for name in 
+00022e00: 7365 6c66 2e6e 616d 6573 202b 2073 656c  self.names + sel
+00022e10: 662e 6578 7472 615f 6e61 6d65 733a 0a20  f.extra_names:. 
+00022e20: 2020 2020 2020 2020 2020 2069 6620 6e61             if na
+00022e30: 6d65 203d 3d20 226e 616d 6522 3a0a 2020  me == "name":.  
+00022e40: 2020 2020 2020 2020 2020 2020 2020 6461                da
+00022e50: 7461 5b6e 616d 655d 2e69 6e73 6572 7428  ta[name].insert(
+00022e60: 302c 2066 2254 6f74 616c 2028 7b6c 656e  0, f"Total ({len
+00022e70: 2864 6174 615b 6e61 6d65 5d29 7d29 2229  (data[name])})")
+00022e80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022e90: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
+00022ea0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00022eb0: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
+00022ec0: 6e28 7365 6c66 2e73 6368 6564 756c 6572  n(self.scheduler
+00022ed0: 2e77 6f72 6b65 7273 2920 3d3d 2030 3a0a  .workers) == 0:.
+00022ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022ef0: 2020 2020 746f 7461 6c5f 6461 7461 203d      total_data =
+00022f00: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+00022f10: 2020 2020 2020 656c 6966 206e 616d 6520        elif name 
+00022f20: 3d3d 2022 6d65 6d6f 7279 5f70 6572 6365  == "memory_perce
+00022f30: 6e74 223a 0a20 2020 2020 2020 2020 2020  nt":.           
+00022f40: 2020 2020 2020 2020 2074 6f74 616c 5f6d           total_m
+00022f50: 656d 203d 2073 756d 280a 2020 2020 2020  em = sum(.      
+00022f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022f70: 2020 7773 2e6d 656d 6f72 795f 6c69 6d69    ws.memory_limi
+00022f80: 7420 666f 7220 7773 2069 6e20 7365 6c66  t for ws in self
+00022f90: 2e73 6368 6564 756c 6572 2e77 6f72 6b65  .scheduler.worke
+00022fa0: 7273 2e76 616c 7565 7328 290a 2020 2020  rs.values().    
+00022fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022fc0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00022fd0: 2020 2020 2020 746f 7461 6c5f 6461 7461        total_data
+00022fe0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+00022ff0: 2020 2020 2020 2020 2020 2020 2028 0a20               (. 
+00023000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023010: 2020 2020 2020 2020 2020 2073 756d 280a             sum(.
+00023020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023040: 7773 2e6d 6574 7269 6373 5b22 6d65 6d6f  ws.metrics["memo
+00023050: 7279 225d 0a20 2020 2020 2020 2020 2020  ry"].           
+00023060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023070: 2020 2020 2066 6f72 2077 7320 696e 2073       for ws in s
+00023080: 656c 662e 7363 6865 6475 6c65 722e 776f  elf.scheduler.wo
+00023090: 726b 6572 732e 7661 6c75 6573 2829 0a20  rkers.values(). 
+000230a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000230b0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+000230c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000230d0: 2020 2020 2020 2020 202f 2074 6f74 616c           / total
+000230e0: 5f6d 656d 0a20 2020 2020 2020 2020 2020  _mem.           
+000230f0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00023100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023110: 2020 2020 2020 2069 6620 746f 7461 6c5f         if total_
+00023120: 6d65 6d0a 2020 2020 2020 2020 2020 2020  mem.            
+00023130: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00023140: 2022 220a 2020 2020 2020 2020 2020 2020   "".            
+00023150: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00023160: 2020 2020 2020 2020 2020 656c 6966 206e            elif n
+00023170: 616d 6520 3d3d 2022 6370 7522 3a0a 2020  ame == "cpu":.  
+00023180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023190: 2020 746f 7461 6c5f 6461 7461 203d 2028    total_data = (
+000231a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000231b0: 2020 2020 2020 2020 2073 756d 2877 732e           sum(ws.
+000231c0: 6d65 7472 6963 735b 2263 7075 225d 2066  metrics["cpu"] f
+000231d0: 6f72 2077 7320 696e 2073 656c 662e 7363  or ws in self.sc
+000231e0: 6865 6475 6c65 722e 776f 726b 6572 732e  heduler.workers.
+000231f0: 7661 6c75 6573 2829 290a 2020 2020 2020  values()).      
+00023200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023210: 2020 2f20 3130 300a 2020 2020 2020 2020    / 100.        
+00023220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023230: 2f20 6c65 6e28 7365 6c66 2e73 6368 6564  / len(self.sched
+00023240: 756c 6572 2e77 6f72 6b65 7273 2e76 616c  uler.workers.val
+00023250: 7565 7328 2929 0a20 2020 2020 2020 2020  ues()).         
+00023260: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00023270: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+00023280: 6620 6e61 6d65 203d 3d20 2263 7075 5f66  f name == "cpu_f
+00023290: 7261 6374 696f 6e22 3a0a 2020 2020 2020  raction":.      
+000232a0: 2020 2020 2020 2020 2020 2020 2020 746f                to
+000232b0: 7461 6c5f 6461 7461 203d 2028 0a20 2020  tal_data = (.   
+000232c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000232d0: 2020 2020 2073 756d 2877 732e 6d65 7472       sum(ws.metr
+000232e0: 6963 735b 2263 7075 225d 2066 6f72 2077  ics["cpu"] for w
+000232f0: 7320 696e 2073 656c 662e 7363 6865 6475  s in self.schedu
+00023300: 6c65 722e 776f 726b 6572 732e 7661 6c75  ler.workers.valu
+00023310: 6573 2829 290a 2020 2020 2020 2020 2020  es()).          
+00023320: 2020 2020 2020 2020 2020 2020 2020 2f20                / 
+00023330: 3130 300a 2020 2020 2020 2020 2020 2020  100.            
+00023340: 2020 2020 2020 2020 2020 2020 2f20 7375              / su
+00023350: 6d28 7773 2e6e 7468 7265 6164 7320 666f  m(ws.nthreads fo
+00023360: 7220 7773 2069 6e20 7365 6c66 2e73 6368  r ws in self.sch
+00023370: 6564 756c 6572 2e77 6f72 6b65 7273 2e76  eduler.workers.v
+00023380: 616c 7565 7328 2929 0a20 2020 2020 2020  alues()).       
+00023390: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+000233a0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+000233b0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000233c0: 2020 2020 2020 2020 2074 6f74 616c 5f64           total_d
+000233d0: 6174 6120 3d20 7375 6d28 6461 7461 5b6e  ata = sum(data[n
+000233e0: 616d 655d 290a 0a20 2020 2020 2020 2020  ame])..         
+000233f0: 2020 2020 2020 2064 6174 615b 6e61 6d65         data[name
+00023400: 5d2e 696e 7365 7274 2830 2c20 746f 7461  ].insert(0, tota
+00023410: 6c5f 6461 7461 290a 2020 2020 2020 2020  l_data).        
+00023420: 2020 2020 6578 6365 7074 2054 7970 6545      except TypeE
+00023430: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+00023440: 2020 2020 2020 6461 7461 5b6e 616d 655d        data[name]
+00023450: 2e69 6e73 6572 7428 302c 204e 6f6e 6529  .insert(0, None)
+00023460: 0a0a 2020 2020 2020 2020 7365 6c66 2e73  ..        self.s
+00023470: 6f75 7263 652e 6461 7461 2e75 7064 6174  ource.data.updat
+00023480: 6528 6461 7461 290a 0a0a 636c 6173 7320  e(data)...class 
+00023490: 5368 7566 666c 696e 6728 4461 7368 626f  Shuffling(Dashbo
+000234a0: 6172 6443 6f6d 706f 6e65 6e74 293a 0a20  ardComponent):. 
+000234b0: 2020 2022 2222 4f63 6375 7061 6e63 7920     """Occupancy 
+000234c0: 2869 6e20 7469 6d65 2920 7065 7220 776f  (in time) per wo
+000234d0: 726b 6572 2222 220a 0a20 2020 2064 6566  rker"""..    def
+000234e0: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+000234f0: 7363 6865 6475 6c65 722c 202a 2a6b 7761  scheduler, **kwa
+00023500: 7267 7329 3a0a 2020 2020 2020 2020 7769  rgs):.        wi
+00023510: 7468 206c 6f67 5f65 7272 6f72 7328 293a  th log_errors():
+00023520: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00023530: 662e 7363 6865 6475 6c65 7220 3d20 7363  f.scheduler = sc
+00023540: 6865 6475 6c65 720a 2020 2020 2020 2020  heduler.        
+00023550: 2020 2020 7365 6c66 2e73 6f75 7263 6520      self.source 
+00023560: 3d20 436f 6c75 6d6e 4461 7461 536f 7572  = ColumnDataSour
+00023570: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
+00023580: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00023590: 2020 2020 2020 2020 2020 2277 6f72 6b65            "worke
+000235a0: 7222 3a20 5b5d 2c0a 2020 2020 2020 2020  r": [],.        
+000235b0: 2020 2020 2020 2020 2020 2020 2279 223a              "y":
+000235c0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+000235d0: 2020 2020 2020 2020 2022 636f 6d6d 5f6d           "comm_m
+000235e0: 656d 6f72 7922 3a20 5b5d 2c0a 2020 2020  emory": [],.    
+000235f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023600: 2263 6f6d 6d5f 6d65 6d6f 7279 5f6c 696d  "comm_memory_lim
+00023610: 6974 223a 205b 5d2c 0a20 2020 2020 2020  it": [],.       
+00023620: 2020 2020 2020 2020 2020 2020 2022 636f               "co
+00023630: 6d6d 5f62 7563 6b65 7473 223a 205b 5d2c  mm_buckets": [],
+00023640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023650: 2020 2020 2022 636f 6d6d 5f61 7667 5f64       "comm_avg_d
+00023660: 7572 6174 696f 6e22 3a20 5b5d 2c0a 2020  uration": [],.  
+00023670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023680: 2020 2263 6f6d 6d5f 6176 675f 7369 7a65    "comm_avg_size
+00023690: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+000236a0: 2020 2020 2020 2020 2020 2022 636f 6d6d             "comm
+000236b0: 5f72 6561 6422 3a20 5b5d 2c0a 2020 2020  _read": [],.    
+000236c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000236d0: 2263 6f6d 6d5f 7772 6974 7465 6e22 3a20  "comm_written": 
+000236e0: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+000236f0: 2020 2020 2020 2020 2263 6f6d 6d5f 636f          "comm_co
+00023700: 6c6f 7222 3a20 5b5d 2c0a 2020 2020 2020  lor": [],.      
+00023710: 2020 2020 2020 2020 2020 2020 2020 2264                "d
+00023720: 6973 6b5f 6d65 6d6f 7279 223a 205b 5d2c  isk_memory": [],
+00023730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023740: 2020 2020 2022 6469 736b 5f6d 656d 6f72       "disk_memor
+00023750: 795f 6c69 6d69 7422 3a20 5b5d 2c0a 2020  y_limit": [],.  
+00023760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023770: 2020 2264 6973 6b5f 6275 636b 6574 7322    "disk_buckets"
+00023780: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+00023790: 2020 2020 2020 2020 2020 2264 6973 6b5f            "disk_
+000237a0: 6176 675f 6475 7261 7469 6f6e 223a 205b  avg_duration": [
+000237b0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+000237c0: 2020 2020 2020 2022 6469 736b 5f61 7667         "disk_avg
+000237d0: 5f73 697a 6522 3a20 5b5d 2c0a 2020 2020  _size": [],.    
+000237e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000237f0: 2264 6973 6b5f 7265 6164 223a 205b 5d2c  "disk_read": [],
+00023800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023810: 2020 2020 2022 6469 736b 5f77 7269 7474       "disk_writt
+00023820: 656e 223a 205b 5d2c 0a20 2020 2020 2020  en": [],.       
+00023830: 2020 2020 2020 2020 2020 2020 2022 6469               "di
+00023840: 736b 5f63 6f6c 6f72 223a 205b 5d2c 0a20  sk_color": [],. 
+00023850: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00023860: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00023870: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00023880: 746f 7461 6c73 5f73 6f75 7263 6520 3d20  totals_source = 
+00023890: 436f 6c75 6d6e 4461 7461 536f 7572 6365  ColumnDataSource
+000238a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000238b0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+000238c0: 2020 2020 2020 2020 2278 223a 205b 224e          "x": ["N
+000238d0: 6574 776f 726b 2053 656e 6422 2c20 224e  etwork Send", "N
+000238e0: 6574 776f 726b 2052 6563 6569 7665 222c  etwork Receive",
+000238f0: 2022 4469 736b 2057 7269 7465 222c 2022   "Disk Write", "
+00023900: 4469 736b 2052 6561 6422 5d2c 0a20 2020  Disk Read"],.   
+00023910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023920: 2022 7661 6c75 6573 223a 205b 302c 2030   "values": [0, 0
+00023930: 2c20 302c 2030 5d2c 0a20 2020 2020 2020  , 0, 0],.       
+00023940: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00023950: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00023960: 2020 2020 2020 7365 6c66 2e63 6f6d 6d5f        self.comm_
+00023970: 6d65 6d6f 7279 203d 2066 6967 7572 6528  memory = figure(
+00023980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023990: 2074 6974 6c65 3d22 436f 6d6d 7320 4275   title="Comms Bu
+000239a0: 6666 6572 222c 0a20 2020 2020 2020 2020  ffer",.         
+000239b0: 2020 2020 2020 2074 6f6f 6c73 3d22 222c         tools="",
+000239c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000239d0: 2074 6f6f 6c62 6172 5f6c 6f63 6174 696f   toolbar_locatio
+000239e0: 6e3d 2261 626f 7665 222c 0a20 2020 2020  n="above",.     
+000239f0: 2020 2020 2020 2020 2020 2078 5f72 616e             x_ran
+00023a00: 6765 3d52 616e 6765 3164 2830 2c20 3130  ge=Range1d(0, 10
+00023a10: 305f 3030 305f 3030 3029 2c0a 2020 2020  0_000_000),.    
+00023a20: 2020 2020 2020 2020 2020 2020 2a2a 6b77              **kw
+00023a30: 6172 6773 2c0a 2020 2020 2020 2020 2020  args,.          
+00023a40: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00023a50: 7365 6c66 2e63 6f6d 6d5f 6d65 6d6f 7279  self.comm_memory
+00023a60: 2e68 6261 7228 0a20 2020 2020 2020 2020  .hbar(.         
+00023a70: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
+00023a80: 6c66 2e73 6f75 7263 652c 0a20 2020 2020  lf.source,.     
+00023a90: 2020 2020 2020 2020 2020 2072 6967 6874             right
+00023aa0: 3d22 636f 6d6d 5f6d 656d 6f72 7922 2c0a  ="comm_memory",.
+00023ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023ac0: 793d 2279 222c 0a20 2020 2020 2020 2020  y="y",.         
+00023ad0: 2020 2020 2020 2068 6569 6768 743d 302e         height=0.
+00023ae0: 392c 0a20 2020 2020 2020 2020 2020 2020  9,.             
+00023af0: 2020 2063 6f6c 6f72 3d22 636f 6d6d 5f63     color="comm_c
+00023b00: 6f6c 6f72 222c 0a20 2020 2020 2020 2020  olor",.         
+00023b10: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00023b20: 2068 6f76 6572 203d 2048 6f76 6572 546f   hover = HoverTo
+00023b30: 6f6c 280a 2020 2020 2020 2020 2020 2020  ol(.            
+00023b40: 2020 2020 746f 6f6c 7469 7073 3d5b 0a20      tooltips=[. 
+00023b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023b60: 2020 2028 224d 656d 6f72 7920 5573 6564     ("Memory Used
+00023b70: 222c 2022 4063 6f6d 6d5f 6d65 6d6f 7279  ", "@comm_memory
+00023b80: 7b30 2e30 3020 627d 2229 2c0a 2020 2020  {0.00 b}"),.    
+00023b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023ba0: 2822 4176 6572 6167 6520 5772 6974 6522  ("Average Write"
+00023bb0: 2c20 2240 636f 6d6d 5f61 7667 5f73 697a  , "@comm_avg_siz
+00023bc0: 657b 302e 3030 2062 7d22 292c 0a20 2020  e{0.00 b}"),.   
+00023bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023be0: 2028 2223 2042 7563 6b65 7473 222c 2022   ("# Buckets", "
+00023bf0: 4063 6f6d 6d5f 6275 636b 6574 7322 292c  @comm_buckets"),
+00023c00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023c10: 2020 2020 2028 2241 7665 7261 6765 2044       ("Average D
+00023c20: 7572 6174 696f 6e22 2c20 2240 636f 6d6d  uration", "@comm
+00023c30: 5f61 7667 5f64 7572 6174 696f 6e22 292c  _avg_duration"),
+00023c40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023c50: 205d 2c0a 2020 2020 2020 2020 2020 2020   ],.            
+00023c60: 2020 2020 666f 726d 6174 7465 7273 3d7b      formatters={
+00023c70: 2240 636f 6d6d 5f61 7667 5f64 7572 6174  "@comm_avg_durat
+00023c80: 696f 6e22 3a20 2264 6174 6574 696d 6522  ion": "datetime"
+00023c90: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+00023ca0: 2020 206d 6f64 653d 2268 6c69 6e65 222c     mode="hline",
+00023cb0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00023cc0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00023cd0: 636f 6d6d 5f6d 656d 6f72 792e 6164 645f  comm_memory.add_
+00023ce0: 746f 6f6c 7328 686f 7665 7229 0a20 2020  tools(hover).   
+00023cf0: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
+00023d00: 6d6d 5f6d 656d 6f72 792e 785f 7261 6e67  mm_memory.x_rang
+00023d10: 652e 7374 6172 7420 3d20 300a 2020 2020  e.start = 0.    
+00023d20: 2020 2020 2020 2020 7365 6c66 2e63 6f6d          self.com
+00023d30: 6d5f 6d65 6d6f 7279 2e78 5f72 616e 6765  m_memory.x_range
+00023d40: 2e65 6e64 203d 2031 0a20 2020 2020 2020  .end = 1.       
+00023d50: 2020 2020 2073 656c 662e 636f 6d6d 5f6d       self.comm_m
+00023d60: 656d 6f72 792e 7861 7869 735b 305d 2e66  emory.xaxis[0].f
+00023d70: 6f72 6d61 7474 6572 203d 204e 756d 6572  ormatter = Numer
+00023d80: 616c 5469 636b 466f 726d 6174 7465 7228  alTickFormatter(
+00023d90: 666f 726d 6174 3d22 302e 3020 6222 290a  format="0.0 b").
+00023da0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00023db0: 662e 6469 736b 5f6d 656d 6f72 7920 3d20  f.disk_memory = 
+00023dc0: 6669 6775 7265 280a 2020 2020 2020 2020  figure(.        
+00023dd0: 2020 2020 2020 2020 7469 746c 653d 2244          title="D
+00023de0: 6973 6b20 4275 6666 6572 222c 0a20 2020  isk Buffer",.   
+00023df0: 2020 2020 2020 2020 2020 2020 2074 6f6f               too
+00023e00: 6c73 3d22 222c 0a20 2020 2020 2020 2020  ls="",.         
+00023e10: 2020 2020 2020 2074 6f6f 6c62 6172 5f6c         toolbar_l
+00023e20: 6f63 6174 696f 6e3d 2261 626f 7665 222c  ocation="above",
+00023e30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023e40: 2078 5f72 616e 6765 3d52 616e 6765 3164   x_range=Range1d
+00023e50: 2830 2c20 3130 305f 3030 305f 3030 3029  (0, 100_000_000)
+00023e60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00023e70: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
+00023e80: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00023e90: 2020 2020 2020 7365 6c66 2e64 6973 6b5f        self.disk_
+00023ea0: 6d65 6d6f 7279 2e79 6178 6973 2e76 6973  memory.yaxis.vis
+00023eb0: 6962 6c65 203d 2046 616c 7365 0a0a 2020  ible = False..  
+00023ec0: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
+00023ed0: 6973 6b5f 6d65 6d6f 7279 2e68 6261 7228  isk_memory.hbar(
+00023ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023ef0: 2073 6f75 7263 653d 7365 6c66 2e73 6f75   source=self.sou
+00023f00: 7263 652c 0a20 2020 2020 2020 2020 2020  rce,.           
+00023f10: 2020 2020 2072 6967 6874 3d22 6469 736b       right="disk
+00023f20: 5f6d 656d 6f72 7922 2c0a 2020 2020 2020  _memory",.      
+00023f30: 2020 2020 2020 2020 2020 793d 2279 222c            y="y",
+00023f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023f50: 2068 6569 6768 743d 302e 392c 0a20 2020   height=0.9,.   
+00023f60: 2020 2020 2020 2020 2020 2020 2063 6f6c               col
+00023f70: 6f72 3d22 6469 736b 5f63 6f6c 6f72 222c  or="disk_color",
+00023f80: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+00023f90: 2020 2020 2020 2020 2020 2020 686f 7665              hove
+00023fa0: 7220 3d20 486f 7665 7254 6f6f 6c28 0a20  r = HoverTool(. 
+00023fb0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00023fc0: 6f6f 6c74 6970 733d 5b0a 2020 2020 2020  ooltips=[.      
+00023fd0: 2020 2020 2020 2020 2020 2020 2020 2822                ("
+00023fe0: 4d65 6d6f 7279 2055 7365 6422 2c20 2240  Memory Used", "@
+00023ff0: 6469 736b 5f6d 656d 6f72 797b 302e 3030  disk_memory{0.00
+00024000: 2062 7d22 292c 0a20 2020 2020 2020 2020   b}"),.         
+00024010: 2020 2020 2020 2020 2020 2028 2241 7665             ("Ave
+00024020: 7261 6765 2057 7269 7465 222c 2022 4064  rage Write", "@d
+00024030: 6973 6b5f 6176 675f 7369 7a65 7b30 2e30  isk_avg_size{0.0
+00024040: 3020 627d 2229 2c0a 2020 2020 2020 2020  0 b}"),.        
+00024050: 2020 2020 2020 2020 2020 2020 2822 2320              ("# 
+00024060: 4275 636b 6574 7322 2c20 2240 6469 736b  Buckets", "@disk
+00024070: 5f62 7563 6b65 7473 2229 2c0a 2020 2020  _buckets"),.    
+00024080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024090: 2822 4176 6572 6167 6520 4475 7261 7469  ("Average Durati
+000240a0: 6f6e 222c 2022 4064 6973 6b5f 6176 675f  on", "@disk_avg_
+000240b0: 6475 7261 7469 6f6e 2229 2c0a 2020 2020  duration"),.    
+000240c0: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
+000240d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000240e0: 6f72 6d61 7474 6572 733d 7b22 4064 6973  ormatters={"@dis
+000240f0: 6b5f 6176 675f 6475 7261 7469 6f6e 223a  k_avg_duration":
+00024100: 2022 6461 7465 7469 6d65 227d 2c0a 2020   "datetime"},.  
+00024110: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
+00024120: 6465 3d22 686c 696e 6522 2c0a 2020 2020  de="hline",.    
+00024130: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00024140: 2020 2020 2020 7365 6c66 2e64 6973 6b5f        self.disk_
+00024150: 6d65 6d6f 7279 2e61 6464 5f74 6f6f 6c73  memory.add_tools
+00024160: 2868 6f76 6572 290a 2020 2020 2020 2020  (hover).        
+00024170: 2020 2020 7365 6c66 2e64 6973 6b5f 6d65      self.disk_me
+00024180: 6d6f 7279 2e78 6178 6973 5b30 5d2e 666f  mory.xaxis[0].fo
+00024190: 726d 6174 7465 7220 3d20 4e75 6d65 7261  rmatter = Numera
+000241a0: 6c54 6963 6b46 6f72 6d61 7474 6572 2866  lTickFormatter(f
+000241b0: 6f72 6d61 743d 2230 2e30 2062 2229 0a0a  ormat="0.0 b")..
+000241c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000241d0: 2e74 6f74 616c 7320 3d20 6669 6775 7265  .totals = figure
+000241e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000241f0: 2020 7469 746c 653d 2254 6f74 616c 206d    title="Total m
+00024200: 6f76 656d 656e 7422 2c0a 2020 2020 2020  ovement",.      
+00024210: 2020 2020 2020 2020 2020 746f 6f6c 733d            tools=
+00024220: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
+00024230: 2020 2020 746f 6f6c 6261 725f 6c6f 6361      toolbar_loca
+00024240: 7469 6f6e 3d22 6162 6f76 6522 2c0a 2020  tion="above",.  
+00024250: 2020 2020 2020 2020 2020 2020 2020 2a2a                **
+00024260: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
+00024270: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00024280: 2020 7469 746c 6573 203d 205b 224e 6574    titles = ["Net
+00024290: 776f 726b 2053 656e 6422 2c20 224e 6574  work Send", "Net
+000242a0: 776f 726b 2052 6563 6569 7665 222c 2022  work Receive", "
+000242b0: 4469 736b 2057 7269 7465 222c 2022 4469  Disk Write", "Di
+000242c0: 736b 2052 6561 6422 5d0a 2020 2020 2020  sk Read"].      
+000242d0: 2020 2020 2020 7365 6c66 2e74 6f74 616c        self.total
+000242e0: 7320 3d20 6669 6775 7265 280a 2020 2020  s = figure(.    
+000242f0: 2020 2020 2020 2020 2020 2020 785f 7261              x_ra
+00024300: 6e67 653d 7469 746c 6573 2c0a 2020 2020  nge=titles,.    
+00024310: 2020 2020 2020 2020 2020 2020 7469 746c              titl
+00024320: 653d 2254 6f74 616c 7322 2c0a 2020 2020  e="Totals",.    
+00024330: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
+00024340: 6261 725f 6c6f 6361 7469 6f6e 3d4e 6f6e  bar_location=Non
+00024350: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00024360: 2020 2074 6f6f 6c73 3d22 222c 0a20 2020     tools="",.   
+00024370: 2020 2020 2020 2020 2020 2020 202a 2a6b               **k
+00024380: 7761 7267 732c 0a20 2020 2020 2020 2020  wargs,.         
+00024390: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+000243a0: 2020 7365 6c66 2e74 6f74 616c 732e 7662    self.totals.vb
+000243b0: 6172 280a 2020 2020 2020 2020 2020 2020  ar(.            
+000243c0: 2020 2020 783d 2278 222c 0a20 2020 2020      x="x",.     
+000243d0: 2020 2020 2020 2020 2020 2074 6f70 3d22             top="
+000243e0: 7661 6c75 6573 222c 0a20 2020 2020 2020  values",.       
+000243f0: 2020 2020 2020 2020 2077 6964 7468 3d30           width=0
+00024400: 2e39 2c0a 2020 2020 2020 2020 2020 2020  .9,.            
+00024410: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
+00024420: 746f 7461 6c73 5f73 6f75 7263 652c 0a20  totals_source,. 
+00024430: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00024440: 2020 2020 2020 2020 2020 7365 6c66 2e74            self.t
+00024450: 6f74 616c 732e 7867 7269 642e 6772 6964  otals.xgrid.grid
+00024460: 5f6c 696e 655f 636f 6c6f 7220 3d20 4e6f  _line_color = No
+00024470: 6e65 0a20 2020 2020 2020 2020 2020 2073  ne.            s
+00024480: 656c 662e 746f 7461 6c73 2e79 5f72 616e  elf.totals.y_ran
+00024490: 6765 2e73 7461 7274 203d 2030 0a20 2020  ge.start = 0.   
+000244a0: 2020 2020 2020 2020 2073 656c 662e 746f           self.to
+000244b0: 7461 6c73 2e79 6178 6973 5b30 5d2e 666f  tals.yaxis[0].fo
+000244c0: 726d 6174 7465 7220 3d20 4e75 6d65 7261  rmatter = Numera
+000244d0: 6c54 6963 6b46 6f72 6d61 7474 6572 2866  lTickFormatter(f
+000244e0: 6f72 6d61 743d 2230 2e30 2062 2229 0a0a  ormat="0.0 b")..
+000244f0: 2020 2020 2020 2020 2020 2020 686f 7665              hove
+00024500: 7220 3d20 486f 7665 7254 6f6f 6c28 0a20  r = HoverTool(. 
+00024510: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00024520: 6f6f 6c74 6970 733d 5b28 2254 6f74 616c  ooltips=[("Total
+00024530: 222c 2022 4076 616c 7565 737b 302e 3030  ", "@values{0.00
+00024540: 627d 2229 5d2c 0a20 2020 2020 2020 2020  b}")],.         
+00024550: 2020 2020 2020 206d 6f64 653d 2276 6c69         mode="vli
+00024560: 6e65 222c 0a20 2020 2020 2020 2020 2020  ne",.           
+00024570: 2029 0a20 2020 2020 2020 2020 2020 2073   ).            s
+00024580: 656c 662e 746f 7461 6c73 2e61 6464 5f74  elf.totals.add_t
+00024590: 6f6f 6c73 2868 6f76 6572 290a 0a20 2020  ools(hover)..   
+000245a0: 2020 2020 2020 2020 2073 656c 662e 726f           self.ro
+000245b0: 6f74 203d 2072 6f77 2873 656c 662e 636f  ot = row(self.co
+000245c0: 6d6d 5f6d 656d 6f72 792c 2073 656c 662e  mm_memory, self.
+000245d0: 6469 736b 5f6d 656d 6f72 7929 0a0a 2020  disk_memory)..  
+000245e0: 2020 4077 6974 686f 7574 5f70 726f 7065    @without_prope
+000245f0: 7274 795f 7661 6c69 6461 7469 6f6e 0a20  rty_validation. 
+00024600: 2020 2064 6566 2075 7064 6174 6528 7365     def update(se
+00024610: 6c66 293a 0a20 2020 2020 2020 2077 6974  lf):.        wit
+00024620: 6820 6c6f 675f 6572 726f 7273 2829 3a0a  h log_errors():.
+00024630: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+00024640: 7420 3d20 7365 6c66 2e73 6368 6564 756c  t = self.schedul
+00024650: 6572 2e65 7874 656e 7369 6f6e 735b 2273  er.extensions["s
+00024660: 6875 6666 6c65 225d 2e68 6561 7274 6265  huffle"].heartbe
+00024670: 6174 730a 2020 2020 2020 2020 2020 2020  ats.            
+00024680: 6966 206e 6f74 2069 6e70 7574 3a0a 2020  if not input:.  
+00024690: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000246a0: 7475 726e 0a0a 2020 2020 2020 2020 2020  turn..          
+000246b0: 2020 696e 7075 7420 3d20 6c69 7374 2869    input = list(i
+000246c0: 6e70 7574 2e76 616c 7565 7328 2929 5b2d  nput.values())[-
+000246d0: 315d 2020 2320 544f 444f 3a20 6d75 6c74  1]  # TODO: mult
+000246e0: 6970 6c65 2063 6f6e 6375 7272 656e 7420  iple concurrent 
+000246f0: 7368 7566 666c 6573 0a0a 2020 2020 2020  shuffles..      
+00024700: 2020 2020 2020 6461 7461 203d 2064 6566        data = def
+00024710: 6175 6c74 6469 6374 286c 6973 7429 0a20  aultdict(list). 
+00024720: 2020 2020 2020 2020 2020 206e 6f77 203d             now =
+00024730: 2074 696d 6528 290a 0a20 2020 2020 2020   time()..       
+00024740: 2020 2020 2066 6f72 2069 2c20 2877 6f72       for i, (wor
+00024750: 6b65 722c 2064 2920 696e 2065 6e75 6d65  ker, d) in enume
+00024760: 7261 7465 2869 6e70 7574 2e69 7465 6d73  rate(input.items
+00024770: 2829 293a 0a20 2020 2020 2020 2020 2020  ()):.           
+00024780: 2020 2020 2064 6174 615b 2279 225d 2e61       data["y"].a
+00024790: 7070 656e 6428 6929 0a20 2020 2020 2020  ppend(i).       
+000247a0: 2020 2020 2020 2020 2064 6174 615b 2277           data["w
+000247b0: 6f72 6b65 7222 5d2e 6170 7065 6e64 2877  orker"].append(w
+000247c0: 6f72 6b65 7229 0a20 2020 2020 2020 2020  orker).         
+000247d0: 2020 2020 2020 2066 6f72 2070 7265 6669         for prefi
+000247e0: 7820 696e 205b 2263 6f6d 6d22 2c20 2264  x in ["comm", "d
+000247f0: 6973 6b22 5d3a 0a20 2020 2020 2020 2020  isk"]:.         
+00024800: 2020 2020 2020 2020 2020 2064 6174 615b             data[
+00024810: 6622 7b70 7265 6669 787d 5f74 6f74 616c  f"{prefix}_total
+00024820: 225d 2e61 7070 656e 6428 645b 7072 6566  "].append(d[pref
+00024830: 6978 5d5b 2274 6f74 616c 225d 290a 2020  ix]["total"]).  
+00024840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024850: 2020 6461 7461 5b66 227b 7072 6566 6978    data[f"{prefix
+00024860: 7d5f 6d65 6d6f 7279 225d 2e61 7070 656e  }_memory"].appen
+00024870: 6428 645b 7072 6566 6978 5d5b 226d 656d  d(d[prefix]["mem
+00024880: 6f72 7922 5d29 0a20 2020 2020 2020 2020  ory"]).         
+00024890: 2020 2020 2020 2020 2020 2064 6174 615b             data[
+000248a0: 6622 7b70 7265 6669 787d 5f6d 656d 6f72  f"{prefix}_memor
+000248b0: 795f 6c69 6d69 7422 5d2e 6170 7065 6e64  y_limit"].append
+000248c0: 2864 5b70 7265 6669 785d 5b22 6d65 6d6f  (d[prefix]["memo
+000248d0: 7279 5f6c 696d 6974 225d 290a 2020 2020  ry_limit"]).    
+000248e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000248f0: 6461 7461 5b66 227b 7072 6566 6978 7d5f  data[f"{prefix}_
+00024900: 6275 636b 6574 7322 5d2e 6170 7065 6e64  buckets"].append
+00024910: 2864 5b70 7265 6669 785d 5b22 6275 636b  (d[prefix]["buck
+00024920: 6574 7322 5d29 0a20 2020 2020 2020 2020  ets"]).         
+00024930: 2020 2020 2020 2020 2020 2064 6174 615b             data[
+00024940: 6622 7b70 7265 6669 787d 5f61 7667 5f64  f"{prefix}_avg_d
+00024950: 7572 6174 696f 6e22 5d2e 6170 7065 6e64  uration"].append
+00024960: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00024970: 2020 2020 2020 2020 2020 645b 7072 6566            d[pref
+00024980: 6978 5d5b 2264 6961 676e 6f73 7469 6373  ix]["diagnostics
+00024990: 225d 2e67 6574 2822 6176 675f 6475 7261  "].get("avg_dura
+000249a0: 7469 6f6e 222c 2030 290a 2020 2020 2020  tion", 0).      
+000249b0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+000249c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000249d0: 2020 2020 6461 7461 5b66 227b 7072 6566      data[f"{pref
+000249e0: 6978 7d5f 6176 675f 7369 7a65 225d 2e61  ix}_avg_size"].a
+000249f0: 7070 656e 6428 0a20 2020 2020 2020 2020  ppend(.         
+00024a00: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00024a10: 5b70 7265 6669 785d 5b22 6469 6167 6e6f  [prefix]["diagno
+00024a20: 7374 6963 7322 5d2e 6765 7428 2261 7667  stics"].get("avg
+00024a30: 5f73 697a 6522 2c20 3029 0a20 2020 2020  _size", 0).     
+00024a40: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00024a50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024a60: 2020 2020 2064 6174 615b 6622 7b70 7265       data[f"{pre
+00024a70: 6669 787d 5f72 6561 6422 5d2e 6170 7065  fix}_read"].appe
+00024a80: 6e64 2864 5b70 7265 6669 785d 5b22 7265  nd(d[prefix]["re
+00024a90: 6164 225d 290a 2020 2020 2020 2020 2020  ad"]).          
+00024aa0: 2020 2020 2020 2020 2020 6461 7461 5b66            data[f
+00024ab0: 227b 7072 6566 6978 7d5f 7772 6974 7465  "{prefix}_writte
+00024ac0: 6e22 5d2e 6170 7065 6e64 2864 5b70 7265  n"].append(d[pre
+00024ad0: 6669 785d 5b22 7772 6974 7465 6e22 5d29  fix]["written"])
+00024ae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024af0: 2020 2020 2069 6620 7365 6c66 2e73 6368       if self.sch
+00024b00: 6564 756c 6572 2e77 6f72 6b65 7273 5b77  eduler.workers[w
+00024b10: 6f72 6b65 725d 2e6c 6173 745f 7365 656e  orker].last_seen
+00024b20: 203c 206e 6f77 202d 2035 3a0a 2020 2020   < now - 5:.    
+00024b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024b40: 2020 2020 6461 7461 5b66 227b 7072 6566      data[f"{pref
+00024b50: 6978 7d5f 636f 6c6f 7222 5d2e 6170 7065  ix}_color"].appe
+00024b60: 6e64 2822 6772 6179 2229 0a20 2020 2020  nd("gray").     
+00024b70: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00024b80: 6c69 6620 645b 7072 6566 6978 5d5b 226d  lif d[prefix]["m
+00024b90: 656d 6f72 7922 5d20 3e20 645b 7072 6566  emory"] > d[pref
+00024ba0: 6978 5d5b 226d 656d 6f72 795f 6c69 6d69  ix]["memory_limi
+00024bb0: 7422 5d3a 0a20 2020 2020 2020 2020 2020  t"]:.           
+00024bc0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+00024bd0: 615b 6622 7b70 7265 6669 787d 5f63 6f6c  a[f"{prefix}_col
+00024be0: 6f72 225d 2e61 7070 656e 6428 2272 6564  or"].append("red
+00024bf0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+00024c00: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00024c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024c20: 2020 2020 2064 6174 615b 6622 7b70 7265       data[f"{pre
+00024c30: 6669 787d 5f63 6f6c 6f72 225d 2e61 7070  fix}_color"].app
+00024c40: 656e 6428 2262 6c75 6522 290a 0a20 2020  end("blue")..   
+00024c50: 2020 2020 2020 2020 2022 2222 0a20 2020           """.   
+00024c60: 2020 2020 2020 2020 2073 696e 676c 6574           singlet
+00024c70: 6f6e 7320 3d20 7b0a 2020 2020 2020 2020  ons = {.        
+00024c80: 2020 2020 2020 2020 6622 7b70 7265 6669          f"{prefi
+00024c90: 787d 5f61 7667 5f64 7572 6174 696f 6e22  x}_avg_duration"
+00024ca0: 3a20 5b0a 2020 2020 2020 2020 2020 2020  : [.            
+00024cb0: 2020 2020 2020 2020 7375 6d28 6461 7461          sum(data
+00024cc0: 5b66 227b 7072 6566 6978 7d5f 6176 675f  [f"{prefix}_avg_
+00024cd0: 6475 7261 7469 6f6e 225d 2920 2f20 6c65  duration"]) / le
+00024ce0: 6e28 6461 7461 5b66 227b 7072 6566 6978  n(data[f"{prefix
+00024cf0: 7d5f 6176 675f 6475 7261 7469 6f6e 225d  }_avg_duration"]
+00024d00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00024d10: 2020 5d2c 0a20 2020 2020 2020 2020 2020    ],.           
+00024d20: 2020 2020 2066 227b 7072 6566 6978 7d5f       f"{prefix}_
+00024d30: 6176 675f 7369 7a65 223a 205b 0a20 2020  avg_size": [.   
+00024d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024d50: 2073 756d 2864 6174 615b 6622 7b70 7265   sum(data[f"{pre
+00024d60: 6669 787d 5f61 7667 5f73 697a 6522 5d29  fix}_avg_size"])
+00024d70: 202f 206c 656e 2864 6174 615b 6622 7b70   / len(data[f"{p
+00024d80: 7265 6669 787d 5f61 7667 5f73 697a 6522  refix}_avg_size"
+00024d90: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+00024da0: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
+00024db0: 2020 2020 2020 2264 6973 6b5f 6176 675f        "disk_avg_
+00024dc0: 6475 7261 7469 6f6e 223a 205b 0a20 2020  duration": [.   
+00024dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024de0: 2073 756d 2864 6174 615b 2264 6973 6b5f   sum(data["disk_
+00024df0: 6176 675f 6475 7261 7469 6f6e 225d 2920  avg_duration"]) 
+00024e00: 2f20 6c65 6e28 6461 7461 5b22 6469 736b  / len(data["disk
+00024e10: 5f61 7667 5f64 7572 6174 696f 6e22 5d29  _avg_duration"])
+00024e20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024e30: 205d 2c0a 2020 2020 2020 2020 2020 2020   ],.            
+00024e40: 2020 2020 2264 6973 6b5f 6176 675f 7369      "disk_avg_si
+00024e50: 7a65 223a 205b 0a20 2020 2020 2020 2020  ze": [.         
+00024e60: 2020 2020 2020 2020 2020 2073 756d 2864             sum(d
+00024e70: 6174 615b 2264 6973 6b5f 6176 675f 7369  ata["disk_avg_si
+00024e80: 7a65 225d 2920 2f20 6c65 6e28 6461 7461  ze"]) / len(data
+00024e90: 5b22 6469 736b 5f61 7667 5f73 697a 6522  ["disk_avg_size"
+00024ea0: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+00024eb0: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
+00024ec0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00024ed0: 7369 6e67 6c65 746f 6e73 5b66 227b 7072  singletons[f"{pr
+00024ee0: 6566 6978 7d5f 6176 675f 6261 6e64 7769  efix}_avg_bandwi
+00024ef0: 6474 6822 5d20 3d20 5b0a 2020 2020 2020  dth"] = [.      
+00024f00: 2020 2020 2020 2020 2020 7369 6e67 6c65            single
+00024f10: 746f 6e73 5b66 227b 7072 6566 6978 7d5f  tons[f"{prefix}_
+00024f20: 6176 675f 7369 7a65 225d 5b30 5d20 2f20  avg_size"][0] / 
+00024f30: 7369 6e67 6c65 746f 6e73 5b66 227b 7072  singletons[f"{pr
+00024f40: 6566 6978 7d5f 6176 675f 6475 7261 7469  efix}_avg_durati
+00024f50: 6f6e 225d 5b30 5d0a 2020 2020 2020 2020  on"][0].        
+00024f60: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
+00024f70: 2020 7369 6e67 6c65 746f 6e73 5b22 6469    singletons["di
+00024f80: 736b 5f61 7667 5f62 616e 6477 6964 7468  sk_avg_bandwidth
+00024f90: 225d 203d 205b 0a20 2020 2020 2020 2020  "] = [.         
+00024fa0: 2020 2020 2020 2073 696e 676c 6574 6f6e         singleton
+00024fb0: 735b 2264 6973 6b5f 6176 675f 7369 7a65  s["disk_avg_size
+00024fc0: 225d 5b30 5d20 2f20 7369 6e67 6c65 746f  "][0] / singleto
+00024fd0: 6e73 5b22 6469 736b 5f61 7667 5f64 7572  ns["disk_avg_dur
+00024fe0: 6174 696f 6e22 5d5b 305d 0a20 2020 2020  ation"][0].     
+00024ff0: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+00025000: 2020 2020 2073 696e 676c 6574 6f6e 735b       singletons[
+00025010: 2279 225d 203d 205b 6461 7461 5b22 7922  "y"] = [data["y"
+00025020: 5d5b 2d31 5d20 2f20 325d 0a20 2020 2020  ][-1] / 2].     
+00025030: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
+00025040: 2020 2020 2020 2020 746f 7461 6c73 203d          totals =
+00025050: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00025060: 2020 2022 7822 3a20 5b22 4e65 7477 6f72     "x": ["Networ
+00025070: 6b20 5365 6e64 222c 2022 4e65 7477 6f72  k Send", "Networ
+00025080: 6b20 5265 6365 6976 6522 2c20 2244 6973  k Receive", "Dis
+00025090: 6b20 5772 6974 6522 2c20 2244 6973 6b20  k Write", "Disk 
+000250a0: 5265 6164 225d 2c0a 2020 2020 2020 2020  Read"],.        
+000250b0: 2020 2020 2020 2020 2276 616c 7565 7322          "values"
+000250c0: 3a20 5b0a 2020 2020 2020 2020 2020 2020  : [.            
+000250d0: 2020 2020 2020 2020 7375 6d28 6461 7461          sum(data
+000250e0: 5b22 636f 6d6d 5f77 7269 7474 656e 225d  ["comm_written"]
+000250f0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00025100: 2020 2020 2020 2073 756d 2864 6174 615b         sum(data[
+00025110: 2263 6f6d 6d5f 7265 6164 225d 292c 0a20  "comm_read"]),. 
+00025120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025130: 2020 2073 756d 2864 6174 615b 2264 6973     sum(data["dis
+00025140: 6b5f 7772 6974 7465 6e22 5d29 2c0a 2020  k_written"]),.  
+00025150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025160: 2020 7375 6d28 6461 7461 5b22 6469 736b    sum(data["disk
+00025170: 5f72 6561 6422 5d29 2c0a 2020 2020 2020  _read"]),.      
+00025180: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
+00025190: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+000251a0: 2020 2020 2020 2075 7064 6174 6528 7365         update(se
+000251b0: 6c66 2e74 6f74 616c 735f 736f 7572 6365  lf.totals_source
+000251c0: 2c20 746f 7461 6c73 290a 0a20 2020 2020  , totals)..     
+000251d0: 2020 2020 2020 2075 7064 6174 6528 7365         update(se
+000251e0: 6c66 2e73 6f75 7263 652c 2064 6963 7428  lf.source, dict(
+000251f0: 6461 7461 2929 0a20 2020 2020 2020 2020  data)).         
+00025200: 2020 206c 696d 6974 203d 206d 6178 2864     limit = max(d
+00025210: 6174 615b 2263 6f6d 6d5f 6d65 6d6f 7279  ata["comm_memory
+00025220: 5f6c 696d 6974 225d 202b 2064 6174 615b  _limit"] + data[
+00025230: 2264 6973 6b5f 6d65 6d6f 7279 5f6c 696d  "disk_memory_lim
+00025240: 6974 225d 2920 2a20 312e 320a 2020 2020  it"]) * 1.2.    
+00025250: 2020 2020 2020 2020 7365 6c66 2e63 6f6d          self.com
+00025260: 6d5f 6d65 6d6f 7279 2e78 5f72 616e 6765  m_memory.x_range
+00025270: 2e65 6e64 203d 206c 696d 6974 0a20 2020  .end = limit.   
+00025280: 2020 2020 2020 2020 2073 656c 662e 6469           self.di
+00025290: 736b 5f6d 656d 6f72 792e 785f 7261 6e67  sk_memory.x_rang
+000252a0: 652e 656e 6420 3d20 6c69 6d69 740a 0a0a  e.end = limit...
+000252b0: 5f53 5459 4c45 5320 3d20 7b0a 2020 2020  _STYLES = {.    
+000252c0: 2277 6964 7468 223a 2022 3130 3025 222c  "width": "100%",
+000252d0: 0a20 2020 2022 6865 6967 6874 223a 2022  .    "height": "
+000252e0: 3130 3025 222c 0a20 2020 2022 6d61 782d  100%",.    "max-
+000252f0: 7769 6474 6822 3a20 2231 3932 3070 7822  width": "1920px"
+00025300: 2c0a 2020 2020 226d 6178 2d68 6569 6768  ,.    "max-heigh
+00025310: 7422 3a20 2231 3038 3070 7822 2c0a 2020  t": "1080px",.  
+00025320: 2020 2270 6164 6469 6e67 223a 2022 3132    "padding": "12
+00025330: 7078 222c 0a20 2020 2022 626f 7264 6572  px",.    "border
+00025340: 223a 2022 3170 7820 736f 6c69 6420 6c69  ": "1px solid li
+00025350: 6768 7467 7261 7922 2c0a 2020 2020 2262  ghtgray",.    "b
+00025360: 6f78 2d73 6861 646f 7722 3a20 2269 6e73  ox-shadow": "ins
+00025370: 6574 2031 7078 2030 2038 7078 2030 206c  et 1px 0 8px 0 l
+00025380: 6967 6874 6772 6179 222c 0a20 2020 2022  ightgray",.    "
+00025390: 6f76 6572 666c 6f77 223a 2022 6175 746f  overflow": "auto
+000253a0: 222c 0a7d 0a69 6620 424f 4b45 485f 5645  ",.}.if BOKEH_VE
+000253b0: 5253 494f 4e2e 6d61 6a6f 7220 3c20 333a  RSION.major < 3:
+000253c0: 0a20 2020 205f 424f 4b45 485f 5354 594c  .    _BOKEH_STYL
+000253d0: 4553 5f4b 5741 5247 5320 3d20 7b22 7374  ES_KWARGS = {"st
+000253e0: 796c 6522 3a20 5f53 5459 4c45 537d 0a65  yle": _STYLES}.e
+000253f0: 6c73 653a 0a20 2020 205f 424f 4b45 485f  lse:.    _BOKEH_
+00025400: 5354 594c 4553 5f4b 5741 5247 5320 3d20  STYLES_KWARGS = 
+00025410: 7b22 7374 796c 6573 223a 205f 5354 594c  {"styles": _STYL
+00025420: 4553 7d0a 0a0a 636c 6173 7320 5363 6865  ES}...class Sche
+00025430: 6475 6c65 724c 6f67 733a 0a20 2020 2064  dulerLogs:.    d
+00025440: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+00025450: 2c20 7363 6865 6475 6c65 722c 2073 7461  , scheduler, sta
+00025460: 7274 3d4e 6f6e 6529 3a0a 2020 2020 2020  rt=None):.      
+00025470: 2020 6c6f 6773 203d 2073 6368 6564 756c    logs = schedul
+00025480: 6572 2e67 6574 5f6c 6f67 7328 7374 6172  er.get_logs(star
+00025490: 743d 7374 6172 742c 2074 696d 6573 7461  t=start, timesta
+000254a0: 6d70 733d 5472 7565 290a 0a20 2020 2020  mps=True)..     
+000254b0: 2020 2069 6620 6e6f 7420 6c6f 6773 3a0a     if not logs:.
+000254c0: 2020 2020 2020 2020 2020 2020 6c6f 6773              logs
+000254d0: 5f68 746d 6c20 3d20 280a 2020 2020 2020  _html = (.      
+000254e0: 2020 2020 2020 2020 2020 273c 7020 7374            '<p st
+000254f0: 796c 653d 2266 6f6e 742d 6661 6d69 6c79  yle="font-family
+00025500: 3a20 6d6f 6e6f 7370 6163 653b 206d 6172  : monospace; mar
+00025510: 6769 6e3a 2030 3b22 3e4e 6f20 6c6f 6773  gin: 0;">No logs
+00025520: 2074 6f20 7265 706f 7274 3c2f 703e 270a   to report</p>'.
+00025530: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00025540: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00025550: 2020 2020 2020 2020 6c6f 6773 5f68 746d          logs_htm
+00025560: 6c20 3d20 4c6f 6728 0a20 2020 2020 2020  l = Log(.       
+00025570: 2020 2020 2020 2020 2022 5c6e 222e 6a6f           "\n".jo
+00025580: 696e 280a 2020 2020 2020 2020 2020 2020  in(.            
+00025590: 2020 2020 2020 2020 2225 7320 2d20 2573          "%s - %s
+000255a0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+000255b0: 2020 2020 2020 2520 2864 6174 6574 696d        % (datetim
+000255c0: 652e 6672 6f6d 7469 6d65 7374 616d 7028  e.fromtimestamp(
+000255d0: 7469 6d65 292e 7374 7266 7469 6d65 2822  time).strftime("
+000255e0: 2548 3a25 4d3a 2553 2e25 6622 292c 206c  %H:%M:%S.%f"), l
+000255f0: 696e 6529 0a20 2020 2020 2020 2020 2020  ine).           
+00025600: 2020 2020 2020 2020 2066 6f72 2074 696d           for tim
+00025610: 652c 206c 6576 656c 2c20 6c69 6e65 2069  e, level, line i
+00025620: 6e20 6c6f 6773 0a20 2020 2020 2020 2020  n logs.         
+00025630: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00025640: 2020 2020 2029 2e5f 7265 7072 5f68 746d       )._repr_htm
+00025650: 6c5f 2829 0a0a 2020 2020 2020 2020 7365  l_()..        se
+00025660: 6c66 2e72 6f6f 7420 3d20 4469 7628 7465  lf.root = Div(te
+00025670: 7874 3d6c 6f67 735f 6874 6d6c 2c20 2a2a  xt=logs_html, **
+00025680: 5f42 4f4b 4548 5f53 5459 4c45 535f 4b57  _BOKEH_STYLES_KW
+00025690: 4152 4753 290a 0a0a 406c 6f67 5f65 7272  ARGS)...@log_err
+000256a0: 6f72 730a 6465 6620 7379 7374 656d 6d6f  ors.def systemmo
+000256b0: 6e69 746f 725f 646f 6328 7363 6865 6475  nitor_doc(schedu
+000256c0: 6c65 722c 2065 7874 7261 2c20 646f 6329  ler, extra, doc)
+000256d0: 3a0a 2020 2020 7379 736d 6f6e 203d 2053  :.    sysmon = S
+000256e0: 7973 7465 6d4d 6f6e 6974 6f72 2873 6368  ystemMonitor(sch
+000256f0: 6564 756c 6572 2c20 7369 7a69 6e67 5f6d  eduler, sizing_m
+00025700: 6f64 653d 2273 7472 6574 6368 5f62 6f74  ode="stretch_bot
+00025710: 6822 290a 2020 2020 646f 632e 7469 746c  h").    doc.titl
+00025720: 6520 3d20 2244 6173 6b3a 2053 6368 6564  e = "Dask: Sched
+00025730: 756c 6572 2053 7973 7465 6d20 4d6f 6e69  uler System Moni
+00025740: 746f 7222 0a20 2020 2061 6464 5f70 6572  tor".    add_per
+00025750: 696f 6469 635f 6361 6c6c 6261 636b 2864  iodic_callback(d
+00025760: 6f63 2c20 7379 736d 6f6e 2c20 3530 3029  oc, sysmon, 500)
+00025770: 0a0a 2020 2020 646f 632e 6164 645f 726f  ..    doc.add_ro
+00025780: 6f74 2873 7973 6d6f 6e2e 726f 6f74 290a  ot(sysmon.root).
+00025790: 2020 2020 646f 632e 7465 6d70 6c61 7465      doc.template
+000257a0: 203d 2065 6e76 2e67 6574 5f74 656d 706c   = env.get_templ
+000257b0: 6174 6528 2273 696d 706c 652e 6874 6d6c  ate("simple.html
+000257c0: 2229 0a20 2020 2064 6f63 2e74 656d 706c  ").    doc.templ
+000257d0: 6174 655f 7661 7269 6162 6c65 732e 7570  ate_variables.up
+000257e0: 6461 7465 2865 7874 7261 290a 2020 2020  date(extra).    
+000257f0: 646f 632e 7468 656d 6520 3d20 424f 4b45  doc.theme = BOKE
+00025800: 485f 5448 454d 450a 0a0a 406c 6f67 5f65  H_THEME...@log_e
+00025810: 7272 6f72 730a 6465 6620 7368 7566 666c  rrors.def shuffl
+00025820: 696e 675f 646f 6328 7363 6865 6475 6c65  ing_doc(schedule
+00025830: 722c 2065 7874 7261 2c20 646f 6329 3a0a  r, extra, doc):.
+00025840: 2020 2020 646f 632e 7469 746c 6520 3d20      doc.title = 
+00025850: 2244 6173 6b3a 2053 6875 6666 6c69 6e67  "Dask: Shuffling
+00025860: 220a 0a20 2020 2073 6875 6666 6c69 6e67  "..    shuffling
+00025870: 203d 2053 6875 6666 6c69 6e67 2873 6368   = Shuffling(sch
+00025880: 6564 756c 6572 2c20 7769 6474 683d 3430  eduler, width=40
+00025890: 302c 2068 6569 6768 743d 3430 3029 0a20  0, height=400). 
+000258a0: 2020 2077 6f72 6b65 7273 5f6d 656d 6f72     workers_memor
+000258b0: 7920 3d20 576f 726b 6572 734d 656d 6f72  y = WorkersMemor
+000258c0: 7928 7363 6865 6475 6c65 722c 2077 6964  y(scheduler, wid
+000258d0: 7468 3d34 3030 2c20 6865 6967 6874 3d34  th=400, height=4
+000258e0: 3030 290a 2020 2020 7469 6d65 7365 7269  00).    timeseri
+000258f0: 6573 203d 2053 7973 7465 6d54 696d 6573  es = SystemTimes
+00025900: 6572 6965 7328 0a20 2020 2020 2020 2073  eries(.        s
+00025910: 6368 6564 756c 6572 2c20 7769 6474 683d  cheduler, width=
+00025920: 3136 3030 2c20 6865 6967 6874 3d32 3030  1600, height=200
+00025930: 2c20 666f 6c6c 6f77 5f69 6e74 6572 7661  , follow_interva
+00025940: 6c3d 3330 3030 0a20 2020 2029 0a20 2020  l=3000.    ).   
+00025950: 2065 7665 6e74 5f6c 6f6f 7020 3d20 436f   event_loop = Co
+00025960: 6e74 656e 7469 6f6e 2873 6368 6564 756c  ntention(schedul
+00025970: 6572 2c20 7769 6474 683d 3230 302c 2068  er, width=200, h
+00025980: 6569 6768 743d 3430 3029 0a0a 2020 2020  eight=400)..    
+00025990: 6164 645f 7065 7269 6f64 6963 5f63 616c  add_periodic_cal
+000259a0: 6c62 6163 6b28 646f 632c 2073 6875 6666  lback(doc, shuff
+000259b0: 6c69 6e67 2c20 3230 3029 0a20 2020 2061  ling, 200).    a
+000259c0: 6464 5f70 6572 696f 6469 635f 6361 6c6c  dd_periodic_call
+000259d0: 6261 636b 2864 6f63 2c20 776f 726b 6572  back(doc, worker
+000259e0: 735f 6d65 6d6f 7279 2c20 3230 3029 0a20  s_memory, 200). 
+000259f0: 2020 2061 6464 5f70 6572 696f 6469 635f     add_periodic_
+00025a00: 6361 6c6c 6261 636b 2864 6f63 2c20 7469  callback(doc, ti
+00025a10: 6d65 7365 7269 6573 2c20 3530 3029 0a20  meseries, 500). 
+00025a20: 2020 2061 6464 5f70 6572 696f 6469 635f     add_periodic_
+00025a30: 6361 6c6c 6261 636b 2864 6f63 2c20 6576  callback(doc, ev
+00025a40: 656e 745f 6c6f 6f70 2c20 3530 3029 0a0a  ent_loop, 500)..
+00025a50: 2020 2020 7469 6d65 7365 7269 6573 2e62      timeseries.b
+00025a60: 616e 6477 6964 7468 2e79 5f72 616e 6765  andwidth.y_range
+00025a70: 203d 2074 696d 6573 6572 6965 732e 6469   = timeseries.di
+00025a80: 736b 2e79 5f72 616e 6765 0a0a 2020 2020  sk.y_range..    
+00025a90: 646f 632e 6164 645f 726f 6f74 280a 2020  doc.add_root(.  
+00025aa0: 2020 2020 2020 636f 6c75 6d6e 280a 2020        column(.  
+00025ab0: 2020 2020 2020 2020 2020 726f 7728 0a20            row(. 
+00025ac0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00025ad0: 6f72 6b65 7273 5f6d 656d 6f72 792e 726f  orkers_memory.ro
+00025ae0: 6f74 2c0a 2020 2020 2020 2020 2020 2020  ot,.            
+00025af0: 2020 2020 7368 7566 666c 696e 672e 636f      shuffling.co
+00025b00: 6d6d 5f6d 656d 6f72 792c 0a20 2020 2020  mm_memory,.     
+00025b10: 2020 2020 2020 2020 2020 2073 6875 6666             shuff
+00025b20: 6c69 6e67 2e64 6973 6b5f 6d65 6d6f 7279  ling.disk_memory
+00025b30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00025b40: 2020 7368 7566 666c 696e 672e 746f 7461    shuffling.tota
+00025b50: 6c73 2c0a 2020 2020 2020 2020 2020 2020  ls,.            
+00025b60: 2020 2020 6576 656e 745f 6c6f 6f70 2e72      event_loop.r
+00025b70: 6f6f 742c 0a20 2020 2020 2020 2020 2020  oot,.           
+00025b80: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+00025b90: 726f 7728 636f 6c75 6d6e 2874 696d 6573  row(column(times
+00025ba0: 6572 6965 732e 6261 6e64 7769 6474 682c  eries.bandwidth,
+00025bb0: 2074 696d 6573 6572 6965 732e 6469 736b   timeseries.disk
+00025bc0: 2929 2c0a 2020 2020 2020 2020 290a 2020  )),.        ).  
+00025bd0: 2020 290a 2020 2020 646f 632e 7465 6d70    ).    doc.temp
+00025be0: 6c61 7465 203d 2065 6e76 2e67 6574 5f74  late = env.get_t
+00025bf0: 656d 706c 6174 6528 2273 696d 706c 652e  emplate("simple.
+00025c00: 6874 6d6c 2229 0a20 2020 2064 6f63 2e74  html").    doc.t
+00025c10: 656d 706c 6174 655f 7661 7269 6162 6c65  emplate_variable
+00025c20: 732e 7570 6461 7465 2865 7874 7261 290a  s.update(extra).
+00025c30: 2020 2020 646f 632e 7468 656d 6520 3d20      doc.theme = 
+00025c40: 424f 4b45 485f 5448 454d 450a 0a0a 406c  BOKEH_THEME...@l
+00025c50: 6f67 5f65 7272 6f72 730a 6465 6620 7374  og_errors.def st
+00025c60: 6561 6c69 6e67 5f64 6f63 2873 6368 6564  ealing_doc(sched
+00025c70: 756c 6572 2c20 6578 7472 612c 2064 6f63  uler, extra, doc
+00025c80: 293a 0a20 2020 206f 6363 7570 616e 6379  ):.    occupancy
+00025c90: 203d 204f 6363 7570 616e 6379 2873 6368   = Occupancy(sch
+00025ca0: 6564 756c 6572 290a 2020 2020 7374 6561  eduler).    stea
+00025cb0: 6c69 6e67 5f74 7320 3d20 5374 6561 6c69  ling_ts = Steali
+00025cc0: 6e67 5469 6d65 5365 7269 6573 2873 6368  ngTimeSeries(sch
+00025cd0: 6564 756c 6572 290a 2020 2020 7374 6561  eduler).    stea
+00025ce0: 6c69 6e67 5f65 7665 6e74 7320 3d20 5374  ling_events = St
+00025cf0: 6561 6c69 6e67 4576 656e 7473 2873 6368  ealingEvents(sch
+00025d00: 6564 756c 6572 290a 2020 2020 7374 6561  eduler).    stea
+00025d10: 6c69 6e67 5f65 7665 6e74 732e 726f 6f74  ling_events.root
+00025d20: 2e78 5f72 616e 6765 203d 2073 7465 616c  .x_range = steal
+00025d30: 696e 675f 7473 2e72 6f6f 742e 785f 7261  ing_ts.root.x_ra
+00025d40: 6e67 650a 2020 2020 646f 632e 7469 746c  nge.    doc.titl
+00025d50: 6520 3d20 2244 6173 6b3a 2057 6f72 6b20  e = "Dask: Work 
+00025d60: 5374 6561 6c69 6e67 220a 2020 2020 6164  Stealing".    ad
+00025d70: 645f 7065 7269 6f64 6963 5f63 616c 6c62  d_periodic_callb
+00025d80: 6163 6b28 646f 632c 206f 6363 7570 616e  ack(doc, occupan
+00025d90: 6379 2c20 3530 3029 0a20 2020 2061 6464  cy, 500).    add
+00025da0: 5f70 6572 696f 6469 635f 6361 6c6c 6261  _periodic_callba
+00025db0: 636b 2864 6f63 2c20 7374 6561 6c69 6e67  ck(doc, stealing
+00025dc0: 5f74 732c 2035 3030 290a 2020 2020 6164  _ts, 500).    ad
+00025dd0: 645f 7065 7269 6f64 6963 5f63 616c 6c62  d_periodic_callb
+00025de0: 6163 6b28 646f 632c 2073 7465 616c 696e  ack(doc, stealin
+00025df0: 675f 6576 656e 7473 2c20 3530 3029 0a0a  g_events, 500)..
+00025e00: 2020 2020 646f 632e 6164 645f 726f 6f74      doc.add_root
+00025e10: 280a 2020 2020 2020 2020 726f 7728 0a20  (.        row(. 
+00025e20: 2020 2020 2020 2020 2020 206f 6363 7570             occup
+00025e30: 616e 6379 2e72 6f6f 742c 0a20 2020 2020  ancy.root,.     
+00025e40: 2020 2020 2020 2063 6f6c 756d 6e28 0a20         column(. 
+00025e50: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00025e60: 7465 616c 696e 675f 7473 2e72 6f6f 742c  tealing_ts.root,
+00025e70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025e80: 2073 7465 616c 696e 675f 6576 656e 7473   stealing_events
+00025e90: 2e72 6f6f 742c 0a20 2020 2020 2020 2020  .root,.         
+00025ea0: 2020 2020 2020 2073 697a 696e 675f 6d6f         sizing_mo
+00025eb0: 6465 3d22 7374 7265 7463 685f 626f 7468  de="stretch_both
+00025ec0: 222c 0a20 2020 2020 2020 2020 2020 2029  ",.            )
+00025ed0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+00025ee0: 290a 0a20 2020 2064 6f63 2e74 656d 706c  )..    doc.templ
+00025ef0: 6174 6520 3d20 656e 762e 6765 745f 7465  ate = env.get_te
+00025f00: 6d70 6c61 7465 2822 7369 6d70 6c65 2e68  mplate("simple.h
+00025f10: 746d 6c22 290a 2020 2020 646f 632e 7465  tml").    doc.te
+00025f20: 6d70 6c61 7465 5f76 6172 6961 626c 6573  mplate_variables
+00025f30: 2e75 7064 6174 6528 6578 7472 6129 0a20  .update(extra). 
+00025f40: 2020 2064 6f63 2e74 6865 6d65 203d 2042     doc.theme = B
+00025f50: 4f4b 4548 5f54 4845 4d45 0a0a 0a40 6c6f  OKEH_THEME...@lo
+00025f60: 675f 6572 726f 7273 0a64 6566 2065 7665  g_errors.def eve
+00025f70: 6e74 735f 646f 6328 7363 6865 6475 6c65  nts_doc(schedule
+00025f80: 722c 2065 7874 7261 2c20 646f 6329 3a0a  r, extra, doc):.
+00025f90: 2020 2020 6576 656e 7473 203d 2045 7665      events = Eve
+00025fa0: 6e74 7328 7363 6865 6475 6c65 722c 2022  nts(scheduler, "
+00025fb0: 616c 6c22 2c20 6865 6967 6874 3d32 3530  all", height=250
+00025fc0: 290a 2020 2020 6576 656e 7473 2e75 7064  ).    events.upd
+00025fd0: 6174 6528 290a 2020 2020 6164 645f 7065  ate().    add_pe
+00025fe0: 7269 6f64 6963 5f63 616c 6c62 6163 6b28  riodic_callback(
+00025ff0: 646f 632c 2065 7665 6e74 732c 2035 3030  doc, events, 500
+00026000: 290a 2020 2020 646f 632e 7469 746c 6520  ).    doc.title 
+00026010: 3d20 2244 6173 6b3a 2053 6368 6564 756c  = "Dask: Schedul
+00026020: 6572 2045 7665 6e74 7322 0a20 2020 2064  er Events".    d
+00026030: 6f63 2e61 6464 5f72 6f6f 7428 636f 6c75  oc.add_root(colu
+00026040: 6d6e 2865 7665 6e74 732e 726f 6f74 2c20  mn(events.root, 
+00026050: 7369 7a69 6e67 5f6d 6f64 653d 2273 6361  sizing_mode="sca
+00026060: 6c65 5f77 6964 7468 2229 290a 2020 2020  le_width")).    
+00026070: 646f 632e 7465 6d70 6c61 7465 203d 2065  doc.template = e
+00026080: 6e76 2e67 6574 5f74 656d 706c 6174 6528  nv.get_template(
+00026090: 2273 696d 706c 652e 6874 6d6c 2229 0a20  "simple.html"). 
+000260a0: 2020 2064 6f63 2e74 656d 706c 6174 655f     doc.template_
+000260b0: 7661 7269 6162 6c65 732e 7570 6461 7465  variables.update
+000260c0: 2865 7874 7261 290a 2020 2020 646f 632e  (extra).    doc.
+000260d0: 7468 656d 6520 3d20 424f 4b45 485f 5448  theme = BOKEH_TH
+000260e0: 454d 450a 0a0a 406c 6f67 5f65 7272 6f72  EME...@log_error
+000260f0: 730a 6465 6620 6578 6365 7074 696f 6e73  s.def exceptions
+00026100: 5f64 6f63 2873 6368 6564 756c 6572 2c20  _doc(scheduler, 
+00026110: 6578 7472 612c 2064 6f63 293a 0a20 2020  extra, doc):.   
+00026120: 2074 6162 6c65 203d 2045 7863 6570 7469   table = Excepti
+00026130: 6f6e 7354 6162 6c65 2873 6368 6564 756c  onsTable(schedul
+00026140: 6572 290a 2020 2020 7461 626c 652e 7570  er).    table.up
+00026150: 6461 7465 2829 0a20 2020 2061 6464 5f70  date().    add_p
+00026160: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
+00026170: 2864 6f63 2c20 7461 626c 652c 2031 3030  (doc, table, 100
+00026180: 3029 0a20 2020 2064 6f63 2e74 6974 6c65  0).    doc.title
+00026190: 203d 2022 4461 736b 3a20 4578 6365 7074   = "Dask: Except
+000261a0: 696f 6e73 220a 2020 2020 646f 632e 6164  ions".    doc.ad
+000261b0: 645f 726f 6f74 2874 6162 6c65 2e72 6f6f  d_root(table.roo
+000261c0: 7429 0a20 2020 2064 6f63 2e74 656d 706c  t).    doc.templ
+000261d0: 6174 6520 3d20 656e 762e 6765 745f 7465  ate = env.get_te
+000261e0: 6d70 6c61 7465 2822 7369 6d70 6c65 2e68  mplate("simple.h
+000261f0: 746d 6c22 290a 2020 2020 646f 632e 7465  tml").    doc.te
+00026200: 6d70 6c61 7465 5f76 6172 6961 626c 6573  mplate_variables
+00026210: 2e75 7064 6174 6528 6578 7472 6129 0a20  .update(extra). 
+00026220: 2020 2064 6f63 2e74 6865 6d65 203d 2042     doc.theme = B
+00026230: 4f4b 4548 5f54 4845 4d45 0a0a 0a40 6c6f  OKEH_THEME...@lo
+00026240: 675f 6572 726f 7273 0a64 6566 2077 6f72  g_errors.def wor
+00026250: 6b65 7273 5f64 6f63 2873 6368 6564 756c  kers_doc(schedul
+00026260: 6572 2c20 6578 7472 612c 2064 6f63 293a  er, extra, doc):
+00026270: 0a20 2020 2074 6162 6c65 203d 2057 6f72  .    table = Wor
+00026280: 6b65 7254 6162 6c65 2873 6368 6564 756c  kerTable(schedul
+00026290: 6572 290a 2020 2020 7461 626c 652e 7570  er).    table.up
+000262a0: 6461 7465 2829 0a20 2020 2061 6464 5f70  date().    add_p
+000262b0: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
+000262c0: 2864 6f63 2c20 7461 626c 652c 2035 3030  (doc, table, 500
+000262d0: 290a 2020 2020 646f 632e 7469 746c 6520  ).    doc.title 
+000262e0: 3d20 2244 6173 6b3a 2057 6f72 6b65 7273  = "Dask: Workers
+000262f0: 220a 2020 2020 646f 632e 6164 645f 726f  ".    doc.add_ro
+00026300: 6f74 2874 6162 6c65 2e72 6f6f 7429 0a20  ot(table.root). 
+00026310: 2020 2064 6f63 2e74 656d 706c 6174 6520     doc.template 
+00026320: 3d20 656e 762e 6765 745f 7465 6d70 6c61  = env.get_templa
+00026330: 7465 2822 7369 6d70 6c65 2e68 746d 6c22  te("simple.html"
+00026340: 290a 2020 2020 646f 632e 7465 6d70 6c61  ).    doc.templa
+00026350: 7465 5f76 6172 6961 626c 6573 2e75 7064  te_variables.upd
+00026360: 6174 6528 6578 7472 6129 0a20 2020 2064  ate(extra).    d
+00026370: 6f63 2e74 6865 6d65 203d 2042 4f4b 4548  oc.theme = BOKEH
+00026380: 5f54 4845 4d45 0a0a 0a40 6c6f 675f 6572  _THEME...@log_er
+00026390: 726f 7273 0a64 6566 2068 6172 6477 6172  rors.def hardwar
+000263a0: 655f 646f 6328 7363 6865 6475 6c65 722c  e_doc(scheduler,
+000263b0: 2065 7874 7261 2c20 646f 6329 3a0a 2020   extra, doc):.  
+000263c0: 2020 6877 203d 2048 6172 6477 6172 6528    hw = Hardware(
+000263d0: 7363 6865 6475 6c65 7229 0a20 2020 2068  scheduler).    h
+000263e0: 772e 7570 6461 7465 2829 0a20 2020 2064  w.update().    d
+000263f0: 6f63 2e74 6974 6c65 203d 2022 4461 736b  oc.title = "Dask
+00026400: 3a20 436c 7573 7465 7220 4861 7264 7761  : Cluster Hardwa
+00026410: 7265 2042 616e 6477 6964 7468 220a 2020  re Bandwidth".  
+00026420: 2020 646f 632e 6164 645f 726f 6f74 2868    doc.add_root(h
+00026430: 772e 726f 6f74 290a 2020 2020 646f 632e  w.root).    doc.
+00026440: 7465 6d70 6c61 7465 203d 2065 6e76 2e67  template = env.g
+00026450: 6574 5f74 656d 706c 6174 6528 2273 696d  et_template("sim
+00026460: 706c 652e 6874 6d6c 2229 0a20 2020 2064  ple.html").    d
+00026470: 6f63 2e74 656d 706c 6174 655f 7661 7269  oc.template_vari
+00026480: 6162 6c65 732e 7570 6461 7465 2865 7874  ables.update(ext
+00026490: 7261 290a 2020 2020 646f 632e 7468 656d  ra).    doc.them
+000264a0: 6520 3d20 424f 4b45 485f 5448 454d 450a  e = BOKEH_THEME.
+000264b0: 0a20 2020 2061 6464 5f70 6572 696f 6469  .    add_periodi
+000264c0: 635f 6361 6c6c 6261 636b 2864 6f63 2c20  c_callback(doc, 
+000264d0: 6877 2c20 3530 3029 0a0a 0a40 6c6f 675f  hw, 500)...@log_
+000264e0: 6572 726f 7273 0a64 6566 2074 6173 6b73  errors.def tasks
+000264f0: 5f64 6f63 2873 6368 6564 756c 6572 2c20  _doc(scheduler, 
+00026500: 6578 7472 612c 2064 6f63 293a 0a20 2020  extra, doc):.   
+00026510: 2074 7320 3d20 5461 736b 5374 7265 616d   ts = TaskStream
+00026520: 280a 2020 2020 2020 2020 7363 6865 6475  (.        schedu
+00026530: 6c65 722c 0a20 2020 2020 2020 206e 5f72  ler,.        n_r
+00026540: 6563 7461 6e67 6c65 733d 6461 736b 2e63  ectangles=dask.c
+00026550: 6f6e 6669 672e 6765 7428 0a20 2020 2020  onfig.get(.     
+00026560: 2020 2020 2020 2022 6469 7374 7269 6275         "distribu
+00026570: 7465 642e 7363 6865 6475 6c65 722e 6461  ted.scheduler.da
+00026580: 7368 626f 6172 642e 7461 736b 732e 7461  shboard.tasks.ta
+00026590: 736b 2d73 7472 6561 6d2d 6c65 6e67 7468  sk-stream-length
+000265a0: 220a 2020 2020 2020 2020 292c 0a20 2020  ".        ),.   
+000265b0: 2020 2020 2063 6c65 6172 5f69 6e74 6572       clear_inter
+000265c0: 7661 6c3d 2236 3073 222c 0a20 2020 2020  val="60s",.     
+000265d0: 2020 2073 697a 696e 675f 6d6f 6465 3d22     sizing_mode="
+000265e0: 7374 7265 7463 685f 626f 7468 222c 0a20  stretch_both",. 
+000265f0: 2020 2029 0a20 2020 2074 732e 7570 6461     ).    ts.upda
+00026600: 7465 2829 0a20 2020 2061 6464 5f70 6572  te().    add_per
+00026610: 696f 6469 635f 6361 6c6c 6261 636b 2864  iodic_callback(d
+00026620: 6f63 2c20 7473 2c20 3530 3030 290a 2020  oc, ts, 5000).  
+00026630: 2020 646f 632e 7469 746c 6520 3d20 2244    doc.title = "D
+00026640: 6173 6b3a 2054 6173 6b20 5374 7265 616d  ask: Task Stream
+00026650: 220a 2020 2020 646f 632e 6164 645f 726f  ".    doc.add_ro
+00026660: 6f74 2874 732e 726f 6f74 290a 2020 2020  ot(ts.root).    
+00026670: 646f 632e 7465 6d70 6c61 7465 203d 2065  doc.template = e
+00026680: 6e76 2e67 6574 5f74 656d 706c 6174 6528  nv.get_template(
+00026690: 2273 696d 706c 652e 6874 6d6c 2229 0a20  "simple.html"). 
+000266a0: 2020 2064 6f63 2e74 656d 706c 6174 655f     doc.template_
+000266b0: 7661 7269 6162 6c65 732e 7570 6461 7465  variables.update
+000266c0: 2865 7874 7261 290a 2020 2020 646f 632e  (extra).    doc.
+000266d0: 7468 656d 6520 3d20 424f 4b45 485f 5448  theme = BOKEH_TH
+000266e0: 454d 450a 0a0a 406c 6f67 5f65 7272 6f72  EME...@log_error
+000266f0: 730a 6465 6620 6772 6170 685f 646f 6328  s.def graph_doc(
+00026700: 7363 6865 6475 6c65 722c 2065 7874 7261  scheduler, extra
+00026710: 2c20 646f 6329 3a0a 2020 2020 6772 6170  , doc):.    grap
+00026720: 6820 3d20 5461 736b 4772 6170 6828 7363  h = TaskGraph(sc
+00026730: 6865 6475 6c65 722c 2073 697a 696e 675f  heduler, sizing_
+00026740: 6d6f 6465 3d22 7374 7265 7463 685f 626f  mode="stretch_bo
+00026750: 7468 2229 0a20 2020 2064 6f63 2e74 6974  th").    doc.tit
+00026760: 6c65 203d 2022 4461 736b 3a20 5461 736b  le = "Dask: Task
+00026770: 2047 7261 7068 220a 2020 2020 6772 6170   Graph".    grap
+00026780: 682e 7570 6461 7465 2829 0a20 2020 2061  h.update().    a
+00026790: 6464 5f70 6572 696f 6469 635f 6361 6c6c  dd_periodic_call
+000267a0: 6261 636b 2864 6f63 2c20 6772 6170 682c  back(doc, graph,
+000267b0: 2032 3030 290a 2020 2020 646f 632e 6164   200).    doc.ad
+000267c0: 645f 726f 6f74 2867 7261 7068 2e72 6f6f  d_root(graph.roo
+000267d0: 7429 0a0a 2020 2020 646f 632e 7465 6d70  t)..    doc.temp
+000267e0: 6c61 7465 203d 2065 6e76 2e67 6574 5f74  late = env.get_t
+000267f0: 656d 706c 6174 6528 2273 696d 706c 652e  emplate("simple.
+00026800: 6874 6d6c 2229 0a20 2020 2064 6f63 2e74  html").    doc.t
+00026810: 656d 706c 6174 655f 7661 7269 6162 6c65  emplate_variable
+00026820: 732e 7570 6461 7465 2865 7874 7261 290a  s.update(extra).
+00026830: 2020 2020 646f 632e 7468 656d 6520 3d20      doc.theme = 
+00026840: 424f 4b45 485f 5448 454d 450a 0a0a 406c  BOKEH_THEME...@l
+00026850: 6f67 5f65 7272 6f72 730a 6465 6620 7467  og_errors.def tg
+00026860: 5f67 7261 7068 5f64 6f63 2873 6368 6564  _graph_doc(sched
+00026870: 756c 6572 2c20 6578 7472 612c 2064 6f63  uler, extra, doc
+00026880: 293a 0a20 2020 2074 675f 6772 6170 6820  ):.    tg_graph 
+00026890: 3d20 5461 736b 4772 6f75 7047 7261 7068  = TaskGroupGraph
+000268a0: 2873 6368 6564 756c 6572 2c20 7369 7a69  (scheduler, sizi
+000268b0: 6e67 5f6d 6f64 653d 2273 7472 6574 6368  ng_mode="stretch
+000268c0: 5f62 6f74 6822 290a 2020 2020 646f 632e  _both").    doc.
+000268d0: 7469 746c 6520 3d20 2244 6173 6b3a 2054  title = "Dask: T
+000268e0: 6173 6b20 4772 6f75 7073 2047 7261 7068  ask Groups Graph
+000268f0: 220a 2020 2020 7467 5f67 7261 7068 2e75  ".    tg_graph.u
+00026900: 7064 6174 6528 290a 2020 2020 6164 645f  pdate().    add_
+00026910: 7065 7269 6f64 6963 5f63 616c 6c62 6163  periodic_callbac
+00026920: 6b28 646f 632c 2074 675f 6772 6170 682c  k(doc, tg_graph,
+00026930: 2032 3030 290a 2020 2020 646f 632e 6164   200).    doc.ad
+00026940: 645f 726f 6f74 2874 675f 6772 6170 682e  d_root(tg_graph.
+00026950: 726f 6f74 290a 2020 2020 646f 632e 7465  root).    doc.te
+00026960: 6d70 6c61 7465 203d 2065 6e76 2e67 6574  mplate = env.get
+00026970: 5f74 656d 706c 6174 6528 2273 696d 706c  _template("simpl
+00026980: 652e 6874 6d6c 2229 0a20 2020 2064 6f63  e.html").    doc
+00026990: 2e74 656d 706c 6174 655f 7661 7269 6162  .template_variab
+000269a0: 6c65 732e 7570 6461 7465 2865 7874 7261  les.update(extra
+000269b0: 290a 2020 2020 646f 632e 7468 656d 6520  ).    doc.theme 
+000269c0: 3d20 424f 4b45 485f 5448 454d 450a 0a0a  = BOKEH_THEME...
+000269d0: 406c 6f67 5f65 7272 6f72 730a 6465 6620  @log_errors.def 
+000269e0: 7374 6174 7573 5f64 6f63 2873 6368 6564  status_doc(sched
+000269f0: 756c 6572 2c20 6578 7472 612c 2064 6f63  uler, extra, doc
+00026a00: 293a 0a20 2020 2063 6c75 7374 6572 5f6d  ):.    cluster_m
+00026a10: 656d 6f72 7920 3d20 436c 7573 7465 724d  emory = ClusterM
+00026a20: 656d 6f72 7928 7363 6865 6475 6c65 722c  emory(scheduler,
+00026a30: 2073 697a 696e 675f 6d6f 6465 3d22 7374   sizing_mode="st
+00026a40: 7265 7463 685f 626f 7468 2229 0a20 2020  retch_both").   
+00026a50: 2063 6c75 7374 6572 5f6d 656d 6f72 792e   cluster_memory.
+00026a60: 7570 6461 7465 2829 0a20 2020 2061 6464  update().    add
+00026a70: 5f70 6572 696f 6469 635f 6361 6c6c 6261  _periodic_callba
+00026a80: 636b 2864 6f63 2c20 636c 7573 7465 725f  ck(doc, cluster_
+00026a90: 6d65 6d6f 7279 2c20 3130 3029 0a20 2020  memory, 100).   
+00026aa0: 2064 6f63 2e61 6464 5f72 6f6f 7428 636c   doc.add_root(cl
+00026ab0: 7573 7465 725f 6d65 6d6f 7279 2e72 6f6f  uster_memory.roo
+00026ac0: 7429 0a0a 2020 2020 6966 206c 656e 2873  t)..    if len(s
+00026ad0: 6368 6564 756c 6572 2e77 6f72 6b65 7273  cheduler.workers
+00026ae0: 2920 3c3d 2031 3030 3a0a 2020 2020 2020  ) <= 100:.      
+00026af0: 2020 776f 726b 6572 735f 6d65 6d6f 7279    workers_memory
+00026b00: 203d 2057 6f72 6b65 7273 4d65 6d6f 7279   = WorkersMemory
+00026b10: 2873 6368 6564 756c 6572 2c20 7369 7a69  (scheduler, sizi
+00026b20: 6e67 5f6d 6f64 653d 2273 7472 6574 6368  ng_mode="stretch
+00026b30: 5f62 6f74 6822 290a 0a20 2020 2020 2020  _both")..       
+00026b40: 2070 726f 6365 7373 696e 6720 3d20 4375   processing = Cu
+00026b50: 7272 656e 744c 6f61 6428 7363 6865 6475  rrentLoad(schedu
+00026b60: 6c65 722c 2073 697a 696e 675f 6d6f 6465  ler, sizing_mode
+00026b70: 3d22 7374 7265 7463 685f 626f 7468 2229  ="stretch_both")
+00026b80: 0a0a 2020 2020 2020 2020 7072 6f63 6573  ..        proces
+00026b90: 7369 6e67 5f72 6f6f 7420 3d20 7072 6f63  sing_root = proc
+00026ba0: 6573 7369 6e67 2e70 726f 6365 7373 696e  essing.processin
+00026bb0: 675f 6669 6775 7265 0a20 2020 2065 6c73  g_figure.    els
+00026bc0: 653a 0a20 2020 2020 2020 2077 6f72 6b65  e:.        worke
+00026bd0: 7273 5f6d 656d 6f72 7920 3d20 576f 726b  rs_memory = Work
+00026be0: 6572 734d 656d 6f72 7948 6973 746f 6772  ersMemoryHistogr
+00026bf0: 616d 2873 6368 6564 756c 6572 2c20 7369  am(scheduler, si
+00026c00: 7a69 6e67 5f6d 6f64 653d 2273 7472 6574  zing_mode="stret
+00026c10: 6368 5f62 6f74 6822 290a 2020 2020 2020  ch_both").      
+00026c20: 2020 7072 6f63 6573 7369 6e67 203d 2050    processing = P
+00026c30: 726f 6365 7373 696e 6748 6973 746f 6772  rocessingHistogr
+00026c40: 616d 2873 6368 6564 756c 6572 2c20 7369  am(scheduler, si
+00026c50: 7a69 6e67 5f6d 6f64 653d 2273 7472 6574  zing_mode="stret
+00026c60: 6368 5f62 6f74 6822 290a 0a20 2020 2020  ch_both")..     
+00026c70: 2020 2070 726f 6365 7373 696e 675f 726f     processing_ro
+00026c80: 6f74 203d 2070 726f 6365 7373 696e 672e  ot = processing.
+00026c90: 726f 6f74 0a0a 2020 2020 6375 7272 656e  root..    curren
+00026ca0: 745f 6c6f 6164 203d 2043 7572 7265 6e74  t_load = Current
+00026cb0: 4c6f 6164 2873 6368 6564 756c 6572 2c20  Load(scheduler, 
+00026cc0: 7369 7a69 6e67 5f6d 6f64 653d 2273 7472  sizing_mode="str
+00026cd0: 6574 6368 5f62 6f74 6822 290a 2020 2020  etch_both").    
+00026ce0: 6f63 6375 7061 6e63 7920 3d20 4f63 6375  occupancy = Occu
+00026cf0: 7061 6e63 7928 7363 6865 6475 6c65 722c  pancy(scheduler,
+00026d00: 2073 697a 696e 675f 6d6f 6465 3d22 7374   sizing_mode="st
+00026d10: 7265 7463 685f 626f 7468 2229 0a20 2020  retch_both").   
+00026d20: 2077 6f72 6b65 7273 5f74 7261 6e73 6665   workers_transfe
+00026d30: 725f 6279 7465 7320 3d20 576f 726b 6572  r_bytes = Worker
+00026d40: 7354 7261 6e73 6665 7242 7974 6573 2873  sTransferBytes(s
+00026d50: 6368 6564 756c 6572 2c20 7369 7a69 6e67  cheduler, sizing
+00026d60: 5f6d 6f64 653d 2273 7472 6574 6368 5f62  _mode="stretch_b
+00026d70: 6f74 6822 290a 0a20 2020 2063 7075 5f72  oth")..    cpu_r
+00026d80: 6f6f 7420 3d20 6375 7272 656e 745f 6c6f  oot = current_lo
+00026d90: 6164 2e63 7075 5f66 6967 7572 650a 2020  ad.cpu_figure.  
+00026da0: 2020 6f63 6375 7061 6e63 795f 726f 6f74    occupancy_root
+00026db0: 203d 206f 6363 7570 616e 6379 2e72 6f6f   = occupancy.roo
+00026dc0: 740a 0a20 2020 2077 6f72 6b65 7273 5f6d  t..    workers_m
+00026dd0: 656d 6f72 792e 7570 6461 7465 2829 0a20  emory.update(). 
+00026de0: 2020 2077 6f72 6b65 7273 5f74 7261 6e73     workers_trans
+00026df0: 6665 725f 6279 7465 732e 7570 6461 7465  fer_bytes.update
+00026e00: 2829 0a20 2020 2070 726f 6365 7373 696e  ().    processin
+00026e10: 672e 7570 6461 7465 2829 0a20 2020 2063  g.update().    c
+00026e20: 7572 7265 6e74 5f6c 6f61 642e 7570 6461  urrent_load.upda
+00026e30: 7465 2829 0a20 2020 206f 6363 7570 616e  te().    occupan
+00026e40: 6379 2e75 7064 6174 6528 290a 0a20 2020  cy.update()..   
+00026e50: 2061 6464 5f70 6572 696f 6469 635f 6361   add_periodic_ca
+00026e60: 6c6c 6261 636b 2864 6f63 2c20 776f 726b  llback(doc, work
+00026e70: 6572 735f 6d65 6d6f 7279 2c20 3130 3029  ers_memory, 100)
+00026e80: 0a20 2020 2061 6464 5f70 6572 696f 6469  .    add_periodi
+00026e90: 635f 6361 6c6c 6261 636b 2864 6f63 2c20  c_callback(doc, 
+00026ea0: 776f 726b 6572 735f 7472 616e 7366 6572  workers_transfer
+00026eb0: 5f62 7974 6573 2c20 3130 3029 0a20 2020  _bytes, 100).   
+00026ec0: 2061 6464 5f70 6572 696f 6469 635f 6361   add_periodic_ca
+00026ed0: 6c6c 6261 636b 2864 6f63 2c20 7072 6f63  llback(doc, proc
+00026ee0: 6573 7369 6e67 2c20 3130 3029 0a20 2020  essing, 100).   
+00026ef0: 2061 6464 5f70 6572 696f 6469 635f 6361   add_periodic_ca
+00026f00: 6c6c 6261 636b 2864 6f63 2c20 6375 7272  llback(doc, curr
+00026f10: 656e 745f 6c6f 6164 2c20 3130 3029 0a20  ent_load, 100). 
+00026f20: 2020 2061 6464 5f70 6572 696f 6469 635f     add_periodic_
+00026f30: 6361 6c6c 6261 636b 2864 6f63 2c20 6f63  callback(doc, oc
+00026f40: 6375 7061 6e63 792c 2031 3030 290a 0a20  cupancy, 100).. 
+00026f50: 2020 2064 6f63 2e61 6464 5f72 6f6f 7428     doc.add_root(
+00026f60: 776f 726b 6572 735f 6d65 6d6f 7279 2e72  workers_memory.r
+00026f70: 6f6f 7429 0a0a 2020 2020 7461 6273 203d  oot)..    tabs =
+00026f80: 205b 0a20 2020 2020 2020 2054 6162 5061   [.        TabPa
+00026f90: 6e65 6c28 6368 696c 643d 7072 6f63 6573  nel(child=proces
+00026fa0: 7369 6e67 5f72 6f6f 742c 2074 6974 6c65  sing_root, title
+00026fb0: 3d22 5072 6f63 6573 7369 6e67 2229 2c0a  ="Processing"),.
+00026fc0: 2020 2020 2020 2020 5461 6250 616e 656c          TabPanel
+00026fd0: 2863 6869 6c64 3d63 7075 5f72 6f6f 742c  (child=cpu_root,
+00026fe0: 2074 6974 6c65 3d22 4350 5522 292c 0a20   title="CPU"),. 
+00026ff0: 2020 2020 2020 2054 6162 5061 6e65 6c28         TabPanel(
+00027000: 6368 696c 643d 6f63 6375 7061 6e63 795f  child=occupancy_
+00027010: 726f 6f74 2c20 7469 746c 653d 224f 6363  root, title="Occ
+00027020: 7570 616e 6379 2229 2c0a 2020 2020 2020  upancy"),.      
+00027030: 2020 5461 6250 616e 656c 2863 6869 6c64    TabPanel(child
+00027040: 3d77 6f72 6b65 7273 5f74 7261 6e73 6665  =workers_transfe
+00027050: 725f 6279 7465 732e 726f 6f74 2c20 7469  r_bytes.root, ti
+00027060: 746c 653d 2244 6174 6120 5472 616e 7366  tle="Data Transf
+00027070: 6572 2229 2c0a 2020 2020 5d0a 0a20 2020  er"),.    ]..   
+00027080: 2068 656c 705f 203d 2048 656c 7054 6f6f   help_ = HelpToo
+00027090: 6c28 0a20 2020 2020 2020 2072 6564 6972  l(.        redir
+000270a0: 6563 743d 2268 7474 7073 3a2f 2f64 6f63  ect="https://doc
+000270b0: 732e 6461 736b 2e6f 7267 2f65 6e2f 7374  s.dask.org/en/st
+000270c0: 6162 6c65 2f64 6173 6862 6f61 7264 2e68  able/dashboard.h
+000270d0: 746d 6c23 7461 736b 2d70 726f 6365 7373  tml#task-process
+000270e0: 696e 672d 6370 752d 7574 696c 697a 6174  ing-cpu-utilizat
+000270f0: 696f 6e2d 6f63 6375 7061 6e63 792d 6461  ion-occupancy-da
+00027100: 7461 2d74 7261 6e73 6665 7222 2c0a 2020  ta-transfer",.  
+00027110: 2020 2020 2020 6465 7363 7269 7074 696f        descriptio
+00027120: 6e3d 2241 2064 6573 6372 6970 7469 6f6e  n="A description
+00027130: 206f 6620 5461 736b 2050 726f 6365 7373   of Task Process
+00027140: 696e 672f 4350 5520 5574 696c 697a 6174  ing/CPU Utilizat
+00027150: 696f 6e2f 4f63 6375 7061 6e63 7922 2c0a  ion/Occupancy",.
+00027160: 2020 2020 290a 2020 2020 666f 7220 7461      ).    for ta
+00027170: 6220 696e 2074 6162 733a 0a20 2020 2020  b in tabs:.     
+00027180: 2020 2074 6162 2e63 6869 6c64 2e74 6f6f     tab.child.too
+00027190: 6c62 6172 5f6c 6f63 6174 696f 6e20 3d20  lbar_location = 
+000271a0: 2261 626f 7665 220a 2020 2020 2020 2020  "above".        
+000271b0: 7461 622e 6368 696c 642e 6164 645f 746f  tab.child.add_to
+000271c0: 6f6c 7328 6865 6c70 5f29 0a0a 2020 2020  ols(help_)..    
+000271d0: 7072 6f63 5f74 6162 7320 3d20 5461 6273  proc_tabs = Tabs
+000271e0: 2874 6162 733d 7461 6273 2c20 6e61 6d65  (tabs=tabs, name
+000271f0: 3d22 7072 6f63 6573 7369 6e67 5f74 6162  ="processing_tab
+00027200: 7322 2c20 7369 7a69 6e67 5f6d 6f64 653d  s", sizing_mode=
+00027210: 2273 7472 6574 6368 5f62 6f74 6822 290a  "stretch_both").
+00027220: 2020 2020 646f 632e 6164 645f 726f 6f74      doc.add_root
+00027230: 2870 726f 635f 7461 6273 290a 0a20 2020  (proc_tabs)..   
+00027240: 2074 6173 6b5f 7374 7265 616d 203d 2054   task_stream = T
+00027250: 6173 6b53 7472 6561 6d28 0a20 2020 2020  askStream(.     
+00027260: 2020 2073 6368 6564 756c 6572 2c0a 2020     scheduler,.  
+00027270: 2020 2020 2020 6e5f 7265 6374 616e 676c        n_rectangl
+00027280: 6573 3d64 6173 6b2e 636f 6e66 6967 2e67  es=dask.config.g
+00027290: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
+000272a0: 2264 6973 7472 6962 7574 6564 2e73 6368  "distributed.sch
+000272b0: 6564 756c 6572 2e64 6173 6862 6f61 7264  eduler.dashboard
+000272c0: 2e73 7461 7475 732e 7461 736b 2d73 7472  .status.task-str
+000272d0: 6561 6d2d 6c65 6e67 7468 220a 2020 2020  eam-length".    
+000272e0: 2020 2020 292c 0a20 2020 2020 2020 2063      ),.        c
+000272f0: 6c65 6172 5f69 6e74 6572 7661 6c3d 2235  lear_interval="5
+00027300: 7322 2c0a 2020 2020 2020 2020 7369 7a69  s",.        sizi
+00027310: 6e67 5f6d 6f64 653d 2273 7472 6574 6368  ng_mode="stretch
+00027320: 5f62 6f74 6822 2c0a 2020 2020 290a 2020  _both",.    ).  
+00027330: 2020 7461 736b 5f73 7472 6561 6d2e 7570    task_stream.up
+00027340: 6461 7465 2829 0a20 2020 2061 6464 5f70  date().    add_p
+00027350: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
+00027360: 2864 6f63 2c20 7461 736b 5f73 7472 6561  (doc, task_strea
+00027370: 6d2c 2031 3030 290a 2020 2020 646f 632e  m, 100).    doc.
+00027380: 6164 645f 726f 6f74 2874 6173 6b5f 7374  add_root(task_st
+00027390: 7265 616d 2e72 6f6f 7429 0a0a 2020 2020  ream.root)..    
+000273a0: 7461 736b 5f70 726f 6772 6573 7320 3d20  task_progress = 
+000273b0: 5461 736b 5072 6f67 7265 7373 2873 6368  TaskProgress(sch
+000273c0: 6564 756c 6572 2c20 7369 7a69 6e67 5f6d  eduler, sizing_m
+000273d0: 6f64 653d 2273 7472 6574 6368 5f62 6f74  ode="stretch_bot
+000273e0: 6822 290a 2020 2020 7461 736b 5f70 726f  h").    task_pro
+000273f0: 6772 6573 732e 7570 6461 7465 2829 0a20  gress.update(). 
+00027400: 2020 2061 6464 5f70 6572 696f 6469 635f     add_periodic_
+00027410: 6361 6c6c 6261 636b 2864 6f63 2c20 7461  callback(doc, ta
+00027420: 736b 5f70 726f 6772 6573 732c 2031 3030  sk_progress, 100
+00027430: 290a 2020 2020 646f 632e 6164 645f 726f  ).    doc.add_ro
+00027440: 6f74 2874 6173 6b5f 7072 6f67 7265 7373  ot(task_progress
+00027450: 2e72 6f6f 7429 0a0a 2020 2020 646f 632e  .root)..    doc.
+00027460: 7469 746c 6520 3d20 2244 6173 6b3a 2053  title = "Dask: S
+00027470: 7461 7475 7322 0a20 2020 2064 6f63 2e74  tatus".    doc.t
+00027480: 6865 6d65 203d 2042 4f4b 4548 5f54 4845  heme = BOKEH_THE
+00027490: 4d45 0a20 2020 2064 6f63 2e74 656d 706c  ME.    doc.templ
+000274a0: 6174 6520 3d20 656e 762e 6765 745f 7465  ate = env.get_te
+000274b0: 6d70 6c61 7465 2822 7374 6174 7573 2e68  mplate("status.h
+000274c0: 746d 6c22 290a 2020 2020 646f 632e 7465  tml").    doc.te
+000274d0: 6d70 6c61 7465 5f76 6172 6961 626c 6573  mplate_variables
+000274e0: 2e75 7064 6174 6528 6578 7472 6129 0a0a  .update(extra)..
+000274f0: 0a40 6375 7272 790a 6465 6620 696e 6469  .@curry.def indi
+00027500: 7669 6475 616c 5f64 6f63 2863 6c73 2c20  vidual_doc(cls, 
+00027510: 696e 7465 7276 616c 2c20 7363 6865 6475  interval, schedu
+00027520: 6c65 722c 2065 7874 7261 2c20 646f 632c  ler, extra, doc,
+00027530: 2066 6967 5f61 7474 723d 2272 6f6f 7422   fig_attr="root"
+00027540: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+00027550: 2023 204e 6f74 653a 2040 6c6f 675f 6572   # Note: @log_er
+00027560: 726f 7273 2061 6e64 2040 6375 7272 7920  rors and @curry 
+00027570: 6172 6520 6e6f 7420 636f 6d70 6174 6962  are not compatib
+00027580: 6c65 0a20 2020 2077 6974 6820 6c6f 675f  le.    with log_
+00027590: 6572 726f 7273 2829 3a0a 2020 2020 2020  errors():.      
+000275a0: 2020 6669 6720 3d20 636c 7328 7363 6865    fig = cls(sche
+000275b0: 6475 6c65 722c 2073 697a 696e 675f 6d6f  duler, sizing_mo
+000275c0: 6465 3d22 7374 7265 7463 685f 626f 7468  de="stretch_both
+000275d0: 222c 202a 2a6b 7761 7267 7329 0a20 2020  ", **kwargs).   
+000275e0: 2020 2020 2066 6967 2e75 7064 6174 6528       fig.update(
+000275f0: 290a 2020 2020 2020 2020 6164 645f 7065  ).        add_pe
+00027600: 7269 6f64 6963 5f63 616c 6c62 6163 6b28  riodic_callback(
+00027610: 646f 632c 2066 6967 2c20 696e 7465 7276  doc, fig, interv
+00027620: 616c 290a 2020 2020 2020 2020 646f 632e  al).        doc.
+00027630: 6164 645f 726f 6f74 2867 6574 6174 7472  add_root(getattr
+00027640: 2866 6967 2c20 6669 675f 6174 7472 2929  (fig, fig_attr))
+00027650: 0a20 2020 2020 2020 2064 6f63 2e74 6865  .        doc.the
+00027660: 6d65 203d 2042 4f4b 4548 5f54 4845 4d45  me = BOKEH_THEME
+00027670: 0a20 2020 2020 2020 2064 6f63 2e74 6974  .        doc.tit
+00027680: 6c65 203d 2022 4461 736b 3a20 2220 2b20  le = "Dask: " + 
+00027690: 6675 6e63 6e61 6d65 2863 6c73 290a 0a0a  funcname(cls)...
+000276a0: 406c 6f67 5f65 7272 6f72 730a 6465 6620  @log_errors.def 
+000276b0: 696e 6469 7669 6475 616c 5f70 726f 6669  individual_profi
+000276c0: 6c65 5f64 6f63 2873 6368 6564 756c 6572  le_doc(scheduler
+000276d0: 2c20 6578 7472 612c 2064 6f63 293a 0a20  , extra, doc):. 
+000276e0: 2020 2070 726f 6620 3d20 5072 6f66 696c     prof = Profil
+000276f0: 6554 696d 6550 6c6f 7428 7363 6865 6475  eTimePlot(schedu
+00027700: 6c65 722c 2073 697a 696e 675f 6d6f 6465  ler, sizing_mode
+00027710: 3d22 7374 7265 7463 685f 626f 7468 222c  ="stretch_both",
+00027720: 2064 6f63 3d64 6f63 290a 2020 2020 646f   doc=doc).    do
+00027730: 632e 6164 645f 726f 6f74 2870 726f 662e  c.add_root(prof.
+00027740: 726f 6f74 290a 2020 2020 7072 6f66 2e74  root).    prof.t
+00027750: 7269 6767 6572 5f75 7064 6174 6528 290a  rigger_update().
+00027760: 2020 2020 646f 632e 7468 656d 6520 3d20      doc.theme = 
+00027770: 424f 4b45 485f 5448 454d 450a 0a0a 406c  BOKEH_THEME...@l
+00027780: 6f67 5f65 7272 6f72 730a 6465 6620 696e  og_errors.def in
+00027790: 6469 7669 6475 616c 5f70 726f 6669 6c65  dividual_profile
+000277a0: 5f73 6572 7665 725f 646f 6328 7363 6865  _server_doc(sche
+000277b0: 6475 6c65 722c 2065 7874 7261 2c20 646f  duler, extra, do
+000277c0: 6329 3a0a 2020 2020 7072 6f66 203d 2050  c):.    prof = P
+000277d0: 726f 6669 6c65 5365 7276 6572 2873 6368  rofileServer(sch
+000277e0: 6564 756c 6572 2c20 7369 7a69 6e67 5f6d  eduler, sizing_m
+000277f0: 6f64 653d 2273 7472 6574 6368 5f62 6f74  ode="stretch_bot
+00027800: 6822 2c20 646f 633d 646f 6329 0a20 2020  h", doc=doc).   
+00027810: 2064 6f63 2e61 6464 5f72 6f6f 7428 7072   doc.add_root(pr
+00027820: 6f66 2e72 6f6f 7429 0a20 2020 2070 726f  of.root).    pro
+00027830: 662e 7472 6967 6765 725f 7570 6461 7465  f.trigger_update
+00027840: 2829 0a20 2020 2064 6f63 2e74 6865 6d65  ().    doc.theme
+00027850: 203d 2042 4f4b 4548 5f54 4845 4d45 0a0a   = BOKEH_THEME..
+00027860: 0a40 6c6f 675f 6572 726f 7273 0a64 6566  .@log_errors.def
+00027870: 2070 726f 6669 6c65 5f64 6f63 2873 6368   profile_doc(sch
+00027880: 6564 756c 6572 2c20 6578 7472 612c 2064  eduler, extra, d
+00027890: 6f63 293a 0a20 2020 2064 6f63 2e74 6974  oc):.    doc.tit
+000278a0: 6c65 203d 2022 4461 736b 3a20 5072 6f66  le = "Dask: Prof
+000278b0: 696c 6522 0a20 2020 2070 726f 6620 3d20  ile".    prof = 
+000278c0: 5072 6f66 696c 6554 696d 6550 6c6f 7428  ProfileTimePlot(
+000278d0: 7363 6865 6475 6c65 722c 2073 697a 696e  scheduler, sizin
+000278e0: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
+000278f0: 626f 7468 222c 2064 6f63 3d64 6f63 290a  both", doc=doc).
+00027900: 2020 2020 646f 632e 6164 645f 726f 6f74      doc.add_root
+00027910: 2870 726f 662e 726f 6f74 290a 2020 2020  (prof.root).    
+00027920: 646f 632e 7465 6d70 6c61 7465 203d 2065  doc.template = e
+00027930: 6e76 2e67 6574 5f74 656d 706c 6174 6528  nv.get_template(
+00027940: 2273 696d 706c 652e 6874 6d6c 2229 0a20  "simple.html"). 
+00027950: 2020 2064 6f63 2e74 656d 706c 6174 655f     doc.template_
+00027960: 7661 7269 6162 6c65 732e 7570 6461 7465  variables.update
+00027970: 2865 7874 7261 290a 2020 2020 646f 632e  (extra).    doc.
+00027980: 7468 656d 6520 3d20 424f 4b45 485f 5448  theme = BOKEH_TH
+00027990: 454d 450a 0a20 2020 2070 726f 662e 7472  EME..    prof.tr
+000279a0: 6967 6765 725f 7570 6461 7465 2829 0a0a  igger_update()..
+000279b0: 0a40 6c6f 675f 6572 726f 7273 0a64 6566  .@log_errors.def
+000279c0: 2070 726f 6669 6c65 5f73 6572 7665 725f   profile_server_
+000279d0: 646f 6328 7363 6865 6475 6c65 722c 2065  doc(scheduler, e
+000279e0: 7874 7261 2c20 646f 6329 3a0a 2020 2020  xtra, doc):.    
+000279f0: 646f 632e 7469 746c 6520 3d20 2244 6173  doc.title = "Das
+00027a00: 6b3a 2050 726f 6669 6c65 206f 6620 4576  k: Profile of Ev
+00027a10: 656e 7420 4c6f 6f70 220a 2020 2020 7072  ent Loop".    pr
+00027a20: 6f66 203d 2050 726f 6669 6c65 5365 7276  of = ProfileServ
+00027a30: 6572 2873 6368 6564 756c 6572 2c20 7369  er(scheduler, si
+00027a40: 7a69 6e67 5f6d 6f64 653d 2273 7472 6574  zing_mode="stret
+00027a50: 6368 5f62 6f74 6822 2c20 646f 633d 646f  ch_both", doc=do
+00027a60: 6329 0a20 2020 2064 6f63 2e61 6464 5f72  c).    doc.add_r
+00027a70: 6f6f 7428 7072 6f66 2e72 6f6f 7429 0a20  oot(prof.root). 
+00027a80: 2020 2064 6f63 2e74 656d 706c 6174 6520     doc.template 
+00027a90: 3d20 656e 762e 6765 745f 7465 6d70 6c61  = env.get_templa
+00027aa0: 7465 2822 7369 6d70 6c65 2e68 746d 6c22  te("simple.html"
+00027ab0: 290a 2020 2020 646f 632e 7465 6d70 6c61  ).    doc.templa
+00027ac0: 7465 5f76 6172 6961 626c 6573 2e75 7064  te_variables.upd
+00027ad0: 6174 6528 6578 7472 6129 0a20 2020 2064  ate(extra).    d
+00027ae0: 6f63 2e74 6865 6d65 203d 2042 4f4b 4548  oc.theme = BOKEH
+00027af0: 5f54 4845 4d45 0a0a 2020 2020 7072 6f66  _THEME..    prof
+00027b00: 2e74 7269 6767 6572 5f75 7064 6174 6528  .trigger_update(
+00027b10: 290a                                     ).
```

### Comparing `distributed-2023.6.0/distributed/dashboard/components/shared.py` & `distributed-2023.6.1/distributed/dashboard/components/shared.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/dashboard/components/worker.py` & `distributed-2023.6.1/distributed/dashboard/components/worker.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/dashboard/core.py` & `distributed-2023.6.1/distributed/dashboard/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/dashboard/export_tool.js` & `distributed-2023.6.1/distributed/dashboard/export_tool.js`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/dashboard/export_tool.py` & `distributed-2023.6.1/distributed/dashboard/export_tool.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/dashboard/scheduler.py` & `distributed-2023.6.1/distributed/dashboard/scheduler.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/dashboard/utils.py` & `distributed-2023.6.1/distributed/dashboard/utils.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,9 +1,10 @@
 from __future__ import annotations
 
+from itertools import chain
 from numbers import Number
 
 import bokeh
 from bokeh.core.properties import without_property_validation
 from bokeh.io import curdoc
 from packaging.version import Version
 from tlz.curried import first
@@ -42,15 +43,17 @@
     This checks a few things first
 
     1.  If the data is the same, then don't update
     2.  If numpy is available and the data is numeric, then convert to numpy
         arrays
     3.  If profiling then perform the update in another callback
     """
-    if not np or not any(isinstance(v, np.ndarray) for v in source.data.values()):
+    if not np or not any(
+        isinstance(v, np.ndarray) for v in chain(source.data.values(), data.values())
+    ):
         if source.data == data:
             return
     if np and len(data[first(data)]) > 10:
         d = {}
         for k, v in data.items():
             if type(v) is not np.ndarray and isinstance(v[0], Number):
                 d[k] = np.array(v)
```

### Comparing `distributed-2023.6.0/distributed/dashboard/worker.py` & `distributed-2023.6.1/distributed/dashboard/worker.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/deploy/adaptive.py` & `distributed-2023.6.1/distributed/deploy/adaptive.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/deploy/adaptive_core.py` & `distributed-2023.6.1/distributed/deploy/adaptive_core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/deploy/cluster.py` & `distributed-2023.6.1/distributed/deploy/cluster.py`

 * *Files 2% similar despite different names*

```diff
@@ -2,15 +2,14 @@
 
 import asyncio
 import datetime
 import logging
 import uuid
 import warnings
 from contextlib import suppress
-from inspect import isawaitable
 from typing import Any
 
 from packaging.version import parse as parse_version
 from tornado.ioloop import IOLoop
 
 import dask.config
 from dask.utils import _deprecated, format_bytes, parse_timedelta, typename
@@ -68,14 +67,15 @@
         asynchronous=False,
         loop=None,
         quiet=False,
         name=None,
         scheduler_sync_interval=1,
     ):
         self._loop_runner = LoopRunner(loop=loop, asynchronous=asynchronous)
+        self.__asynchronous = asynchronous
 
         self.scheduler_info = {"workers": {}}
         self.periodic_callbacks = {}
         self._watch_worker_status_comm = None
         self._watch_worker_status_task = None
         self._cluster_manager_logs = []
         self.quiet = quiet
@@ -112,14 +112,23 @@
             "setting the loop property is deprecated", DeprecationWarning, stacklevel=2
         )
         if value is None:
             raise ValueError("expected an IOLoop, got None")
         self.__loop = value
 
     @property
+    def called_from_running_loop(self):
+        try:
+            return (
+                getattr(self.loop, "asyncio_loop", None) is asyncio.get_running_loop()
+            )
+        except RuntimeError:
+            return self.__asynchronous
+
+    @property
     def name(self):
         return self._cluster_info["name"]
 
     @name.setter
     def name(self, name):
         self._cluster_info["name"] = name
 
@@ -202,24 +211,25 @@
             await self.scheduler_comm.close_rpc()
 
         for pc in self.periodic_callbacks.values():
             pc.stop()
 
         self.status = Status.closed
 
-    def close(self, timeout=None):
+    def close(self, timeout: float | None = None) -> Any:
         # If the cluster is already closed, we're already done
         if self.status == Status.closed:
             if self.asynchronous:
                 return NoOpAwaitable()
-            else:
-                return
+            return None
 
-        with suppress(RuntimeError):  # loop closed during process shutdown
+        try:
             return self.sync(self._close, callback_timeout=timeout)
+        except RuntimeError:  # loop closed during process shutdown
+            return None
 
     def __del__(self, _warn=warnings.warn):
         if getattr(self, "status", Status.closed) != Status.closed:
             try:
                 self_r = repr(self)
             except Exception:
                 self_r = f"with a broken __repr__ {object.__repr__(self)}"
@@ -515,31 +525,35 @@
             else:
                 display(widget, **kwargs)
         else:
             mimebundle = {"text/plain": repr(self), "text/html": self._repr_html_()}
             display(mimebundle, raw=True)
 
     def __enter__(self):
+        if self.asynchronous:
+            raise TypeError(
+                "Used 'with' with asynchronous class; please use 'async with'"
+            )
+
         return self.sync(self.__aenter__)
 
     def __exit__(self, exc_type, exc_value, traceback):
-        return self.sync(self.__aexit__, exc_type, exc_value, traceback)
+        aw = self.close()
+        assert aw is None, aw
 
     def __await__(self):
         return self
         yield
 
     async def __aenter__(self):
         await self
         return self
 
     async def __aexit__(self, exc_type, exc_value, traceback):
-        f = self.close()
-        if isawaitable(f):
-            await f
+        await self.close()
 
     @property
     def scheduler_address(self) -> str:
         if not self.scheduler_comm:
             return "<Not Connected>"
         return self.scheduler_comm.address
```

### Comparing `distributed-2023.6.0/distributed/deploy/local.py` & `distributed-2023.6.1/distributed/deploy/local.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/deploy/old_ssh.py` & `distributed-2023.6.1/distributed/deploy/old_ssh.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/deploy/spec.py` & `distributed-2023.6.1/distributed/deploy/spec.py`

 * *Files 2% similar despite different names*

```diff
@@ -275,30 +275,30 @@
         super().__init__(
             asynchronous=asynchronous,
             loop=loop,
             name=name,
             scheduler_sync_interval=scheduler_sync_interval,
         )
 
-        try:
-            called_from_running_loop = (
-                getattr(loop, "asyncio_loop", None) is asyncio.get_running_loop()
-            )
-        except RuntimeError:
-            called_from_running_loop = asynchronous
-
-        if not called_from_running_loop:
+        if not self.called_from_running_loop:
             self._loop_runner.start()
             self.sync(self._start)
             try:
                 self.sync(self._correct_state)
             except Exception:
                 self.sync(self.close)
+                self._loop_runner.stop()
                 raise
 
+    def close(self, timeout: float | None = None) -> Awaitable[None] | None:
+        aw = super().close(timeout)
+        if not self.asynchronous:
+            self._loop_runner.stop()
+        return aw
+
     async def _start(self):
         while self.status == Status.starting:
             await asyncio.sleep(0.01)
         if self.status == Status.running:
             return
         if self.status == Status.closed:
             raise ValueError("Cluster is closed")
@@ -468,18 +468,14 @@
 
     async def __aenter__(self):
         await self
         await self._correct_state()
         assert self.status == Status.running
         return self
 
-    def __exit__(self, exc_type, exc_value, traceback):
-        super().__exit__(exc_type, exc_value, traceback)
-        self._loop_runner.stop()
-
     def _threads_per_worker(self) -> int:
         """Return the number of threads per worker for new workers"""
         if not self.new_spec:  # pragma: no cover
             raise ValueError("To scale by cores= you must specify cores per worker")
 
         for name in ["nthreads", "ncores", "threads", "cores"]:
             with suppress(KeyError):
```

### Comparing `distributed-2023.6.0/distributed/deploy/ssh.py` & `distributed-2023.6.1/distributed/deploy/ssh.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/deploy/subprocess.py` & `distributed-2023.6.1/distributed/deploy/subprocess.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/deploy/utils.py` & `distributed-2023.6.1/distributed/deploy/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/diagnostics/cluster_dump.py` & `distributed-2023.6.1/distributed/diagnostics/cluster_dump.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/diagnostics/eventstream.py` & `distributed-2023.6.1/distributed/diagnostics/eventstream.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/diagnostics/graph_layout.py` & `distributed-2023.6.1/distributed/diagnostics/graph_layout.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/diagnostics/memory_sampler.py` & `distributed-2023.6.1/distributed/diagnostics/memory_sampler.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/diagnostics/nvml.py` & `distributed-2023.6.1/distributed/diagnostics/nvml.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/diagnostics/plugin.py` & `distributed-2023.6.1/distributed/diagnostics/plugin.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/diagnostics/progress.py` & `distributed-2023.6.1/distributed/diagnostics/progress.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/diagnostics/progress_stream.py` & `distributed-2023.6.1/distributed/diagnostics/progress_stream.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/diagnostics/progressbar.py` & `distributed-2023.6.1/distributed/diagnostics/progressbar.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/diagnostics/rmm.py` & `distributed-2023.6.1/distributed/diagnostics/rmm.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/diagnostics/task_stream.py` & `distributed-2023.6.1/distributed/diagnostics/task_stream.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/diagnostics/websocket.py` & `distributed-2023.6.1/distributed/diagnostics/websocket.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/diskutils.py` & `distributed-2023.6.1/distributed/diskutils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/distributed-schema.yaml` & `distributed-2023.6.1/distributed/distributed-schema.yaml`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/distributed.yaml` & `distributed-2023.6.1/distributed/distributed.yaml`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/event.py` & `distributed-2023.6.1/distributed/event.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/exceptions.py` & `distributed-2023.6.1/distributed/exceptions.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/prometheus.py` & `distributed-2023.6.1/distributed/http/prometheus.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/proxy.py` & `distributed-2023.6.1/distributed/http/proxy.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/routing.py` & `distributed-2023.6.1/distributed/http/routing.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/scheduler/api.py` & `distributed-2023.6.1/distributed/http/scheduler/api.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/scheduler/info.py` & `distributed-2023.6.1/distributed/http/scheduler/info.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/scheduler/json.py` & `distributed-2023.6.1/distributed/http/scheduler/json.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/scheduler/missing_bokeh.py` & `distributed-2023.6.1/distributed/http/scheduler/missing_bokeh.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/scheduler/prometheus/core.py` & `distributed-2023.6.1/distributed/http/scheduler/prometheus/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/scheduler/prometheus/semaphore.py` & `distributed-2023.6.1/distributed/http/scheduler/prometheus/semaphore.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/scheduler/prometheus/stealing.py` & `distributed-2023.6.1/distributed/http/scheduler/prometheus/stealing.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/static/css/base.css` & `distributed-2023.6.1/distributed/http/static/css/base.css`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/static/css/individual-cluster-map.css` & `distributed-2023.6.1/distributed/http/static/css/individual-cluster-map.css`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/static/css/status.css` & `distributed-2023.6.1/distributed/http/static/css/status.css`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/static/images/dask-logo.svg` & `distributed-2023.6.1/distributed/http/static/images/dask-logo.svg`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/static/images/fa-bars.svg` & `distributed-2023.6.1/distributed/http/static/images/fa-bars.svg`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/static/images/favicon.ico` & `distributed-2023.6.1/distributed/http/static/images/favicon.ico`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/static/images/jupyter.svg` & `distributed-2023.6.1/distributed/http/static/images/jupyter.svg`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/static/images/numpy.png` & `distributed-2023.6.1/distributed/http/static/images/numpy.png`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/static/images/pandas.png` & `distributed-2023.6.1/distributed/http/static/images/pandas.png`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/static/images/python.png` & `distributed-2023.6.1/distributed/http/static/images/python.png`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/static/individual-cluster-map.html` & `distributed-2023.6.1/distributed/http/static/individual-cluster-map.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/static/js/anime.min.js` & `distributed-2023.6.1/distributed/http/static/js/anime.min.js`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/static/js/individual-cluster-map.js` & `distributed-2023.6.1/distributed/http/static/js/individual-cluster-map.js`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/static/js/reconnecting-websocket.min.js` & `distributed-2023.6.1/distributed/http/static/js/reconnecting-websocket.min.js`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/templates/base.html` & `distributed-2023.6.1/distributed/http/templates/base.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/templates/exceptions.html` & `distributed-2023.6.1/distributed/http/templates/exceptions.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/templates/status.html` & `distributed-2023.6.1/distributed/http/templates/status.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/templates/task.html` & `distributed-2023.6.1/distributed/http/templates/task.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/templates/worker-table.html` & `distributed-2023.6.1/distributed/http/templates/worker-table.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/templates/worker.html` & `distributed-2023.6.1/distributed/http/templates/worker.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/utils.py` & `distributed-2023.6.1/distributed/http/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/http/worker/prometheus/core.py` & `distributed-2023.6.1/distributed/http/worker/prometheus/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/lock.py` & `distributed-2023.6.1/distributed/lock.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/metrics.py` & `distributed-2023.6.1/distributed/metrics.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/multi_lock.py` & `distributed-2023.6.1/distributed/multi_lock.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/nanny.py` & `distributed-2023.6.1/distributed/nanny.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/node.py` & `distributed-2023.6.1/distributed/node.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/objects.py` & `distributed-2023.6.1/distributed/objects.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/preloading.py` & `distributed-2023.6.1/distributed/preloading.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/process.py` & `distributed-2023.6.1/distributed/process.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/proctitle.py` & `distributed-2023.6.1/distributed/proctitle.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/profile.py` & `distributed-2023.6.1/distributed/profile.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/protocol/__init__.py` & `distributed-2023.6.1/distributed/protocol/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/protocol/arrow.py` & `distributed-2023.6.1/distributed/protocol/arrow.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/protocol/compression.py` & `distributed-2023.6.1/distributed/protocol/compression.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/protocol/core.py` & `distributed-2023.6.1/distributed/protocol/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/protocol/cuda.py` & `distributed-2023.6.1/distributed/protocol/cuda.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/protocol/cupy.py` & `distributed-2023.6.1/distributed/protocol/cupy.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/protocol/h5py.py` & `distributed-2023.6.1/distributed/protocol/h5py.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/protocol/keras.py` & `distributed-2023.6.1/distributed/protocol/keras.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/protocol/netcdf4.py` & `distributed-2023.6.1/distributed/protocol/netcdf4.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/protocol/numba.py` & `distributed-2023.6.1/distributed/protocol/numba.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/protocol/numpy.py` & `distributed-2023.6.1/distributed/protocol/numpy.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/protocol/pickle.py` & `distributed-2023.6.1/distributed/protocol/pickle.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/protocol/rmm.py` & `distributed-2023.6.1/distributed/protocol/rmm.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/protocol/scipy.py` & `distributed-2023.6.1/distributed/protocol/scipy.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/protocol/serialize.py` & `distributed-2023.6.1/distributed/protocol/serialize.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/protocol/sparse.py` & `distributed-2023.6.1/distributed/protocol/sparse.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/protocol/torch.py` & `distributed-2023.6.1/distributed/protocol/torch.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/protocol/utils.py` & `distributed-2023.6.1/distributed/protocol/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/publish.py` & `distributed-2023.6.1/distributed/publish.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/pubsub.py` & `distributed-2023.6.1/distributed/pubsub.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/queues.py` & `distributed-2023.6.1/distributed/queues.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/recreate_tasks.py` & `distributed-2023.6.1/distributed/recreate_tasks.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/scheduler.py` & `distributed-2023.6.1/distributed/scheduler.py`

 * *Files 0% similar despite different names*

```diff
@@ -1776,17275 +1776,17305 @@
 00006ef0: 720a 2020 2020 7472 6163 6562 6163 6b5f  r.    traceback_
 00006f00: 7465 7874 3a20 7374 720a 0a0a 636c 6173  text: str...clas
 00006f10: 7320 436f 6d70 7574 6174 696f 6e3a 0a20  s Computation:. 
 00006f20: 2020 2022 2222 436f 6c6c 6563 7469 6f6e     """Collection
 00006f30: 2074 7261 636b 696e 6720 6120 7369 6e67   tracking a sing
 00006f40: 6c65 2063 6f6d 7075 7465 206f 7220 7065  le compute or pe
 00006f50: 7273 6973 7420 6361 6c6c 0a0a 2020 2020  rsist call..    
-00006f60: 5365 6520 616c 736f 0a20 2020 202d 2d2d  See also.    ---
-00006f70: 2d2d 2d2d 2d0a 2020 2020 5461 736b 5072  -----.    TaskPr
-00006f80: 6566 6978 0a20 2020 2054 6173 6b47 726f  efix.    TaskGro
-00006f90: 7570 0a20 2020 2054 6173 6b53 7461 7465  up.    TaskState
-00006fa0: 0a20 2020 2022 2222 0a0a 2020 2020 7374  .    """..    st
-00006fb0: 6172 743a 2066 6c6f 6174 0a20 2020 2067  art: float.    g
-00006fc0: 726f 7570 733a 2073 6574 5b54 6173 6b47  roups: set[TaskG
-00006fd0: 726f 7570 5d0a 2020 2020 636f 6465 3a20  roup].    code: 
-00006fe0: 536f 7274 6564 5365 745b 536f 7572 6365  SortedSet[Source
-00006ff0: 436f 6465 5d0a 2020 2020 6964 3a20 7575  Code].    id: uu
-00007000: 6964 2e55 5549 440a 2020 2020 616e 6e6f  id.UUID.    anno
-00007010: 7461 7469 6f6e 733a 2064 6963 740a 0a20  tations: dict.. 
-00007020: 2020 205f 5f73 6c6f 7473 5f5f 203d 2074     __slots__ = t
-00007030: 7570 6c65 285f 5f61 6e6e 6f74 6174 696f  uple(__annotatio
-00007040: 6e73 5f5f 290a 0a20 2020 2064 6566 205f  ns__)..    def _
-00007050: 5f69 6e69 745f 5f28 7365 6c66 293a 0a20  _init__(self):. 
-00007060: 2020 2020 2020 2073 656c 662e 7374 6172         self.star
-00007070: 7420 3d20 7469 6d65 2829 0a20 2020 2020  t = time().     
-00007080: 2020 2073 656c 662e 6772 6f75 7073 203d     self.groups =
-00007090: 2073 6574 2829 0a20 2020 2020 2020 2073   set().        s
-000070a0: 656c 662e 636f 6465 203d 2053 6f72 7465  elf.code = Sorte
-000070b0: 6453 6574 2829 0a20 2020 2020 2020 2073  dSet().        s
-000070c0: 656c 662e 6964 203d 2075 7569 642e 7575  elf.id = uuid.uu
-000070d0: 6964 3428 290a 2020 2020 2020 2020 7365  id4().        se
-000070e0: 6c66 2e61 6e6e 6f74 6174 696f 6e73 203d  lf.annotations =
-000070f0: 207b 7d0a 0a20 2020 2040 7072 6f70 6572   {}..    @proper
-00007100: 7479 0a20 2020 2064 6566 2073 746f 7028  ty.    def stop(
-00007110: 7365 6c66 2920 2d3e 2066 6c6f 6174 3a0a  self) -> float:.
-00007120: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00007130: 6772 6f75 7073 3a0a 2020 2020 2020 2020  groups:.        
-00007140: 2020 2020 7265 7475 726e 206d 6178 2874      return max(t
-00007150: 672e 7374 6f70 2066 6f72 2074 6720 696e  g.stop for tg in
-00007160: 2073 656c 662e 6772 6f75 7073 290a 2020   self.groups).  
-00007170: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00007180: 2020 2020 2020 2020 7265 7475 726e 202d          return -
-00007190: 310a 0a20 2020 2040 7072 6f70 6572 7479  1..    @property
-000071a0: 0a20 2020 2064 6566 2073 7461 7465 7328  .    def states(
-000071b0: 7365 6c66 2920 2d3e 2064 6963 745b 5461  self) -> dict[Ta
-000071c0: 736b 5374 6174 6553 7461 7465 2c20 696e  skStateState, in
-000071d0: 745d 3a0a 2020 2020 2020 2020 7265 7475  t]:.        retu
-000071e0: 726e 206d 6572 6765 5f77 6974 6828 7375  rn merge_with(su
-000071f0: 6d2c 2028 7467 2e73 7461 7465 7320 666f  m, (tg.states fo
-00007200: 7220 7467 2069 6e20 7365 6c66 2e67 726f  r tg in self.gro
-00007210: 7570 7329 290a 0a20 2020 2064 6566 205f  ups))..    def _
-00007220: 5f72 6570 725f 5f28 7365 6c66 2920 2d3e  _repr__(self) ->
-00007230: 2073 7472 3a0a 2020 2020 2020 2020 7265   str:.        re
-00007240: 7475 726e 2028 0a20 2020 2020 2020 2020  turn (.         
-00007250: 2020 2066 223c 436f 6d70 7574 6174 696f     f"<Computatio
-00007260: 6e20 7b73 656c 662e 6964 7d3a 2022 0a20  n {self.id}: ". 
-00007270: 2020 2020 2020 2020 2020 202b 2022 5461             + "Ta
-00007280: 736b 733a 2022 0a20 2020 2020 2020 2020  sks: ".         
-00007290: 2020 202b 2022 2c20 222e 6a6f 696e 280a     + ", ".join(.
-000072a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000072b0: 2225 733a 2025 6422 2025 2028 6b2c 2076  "%s: %d" % (k, v
-000072c0: 2920 666f 7220 286b 2c20 7629 2069 6e20  ) for (k, v) in 
-000072d0: 736f 7274 6564 2873 656c 662e 7374 6174  sorted(self.stat
-000072e0: 6573 2e69 7465 6d73 2829 2920 6966 2076  es.items()) if v
-000072f0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00007300: 2020 2020 2020 2020 2020 202b 2022 3e22             + ">"
-00007310: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00007320: 6465 6620 5f72 6570 725f 6874 6d6c 5f28  def _repr_html_(
-00007330: 7365 6c66 2920 2d3e 2073 7472 3a0a 2020  self) -> str:.  
-00007340: 2020 2020 2020 7265 7475 726e 2067 6574        return get
-00007350: 5f74 656d 706c 6174 6528 2263 6f6d 7075  _template("compu
-00007360: 7461 7469 6f6e 2e68 746d 6c2e 6a32 2229  tation.html.j2")
-00007370: 2e72 656e 6465 7228 0a20 2020 2020 2020  .render(.       
-00007380: 2020 2020 2069 643d 7365 6c66 2e69 642c       id=self.id,
-00007390: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-000073a0: 7274 3d73 656c 662e 7374 6172 742c 0a20  rt=self.start,. 
-000073b0: 2020 2020 2020 2020 2020 2073 746f 703d             stop=
-000073c0: 7365 6c66 2e73 746f 702c 0a20 2020 2020  self.stop,.     
-000073d0: 2020 2020 2020 2067 726f 7570 733d 7365         groups=se
-000073e0: 6c66 2e67 726f 7570 732c 0a20 2020 2020  lf.groups,.     
-000073f0: 2020 2020 2020 2073 7461 7465 733d 7365         states=se
-00007400: 6c66 2e73 7461 7465 732c 0a20 2020 2020  lf.states,.     
-00007410: 2020 2020 2020 2063 6f64 653d 7365 6c66         code=self
-00007420: 2e63 6f64 652c 0a20 2020 2020 2020 2029  .code,.        )
-00007430: 0a0a 0a63 6c61 7373 2054 6173 6b50 7265  ...class TaskPre
-00007440: 6669 783a 0a20 2020 2022 2222 436f 6c6c  fix:.    """Coll
-00007450: 6563 7469 6f6e 2074 7261 636b 696e 6720  ection tracking 
-00007460: 616c 6c20 7461 736b 7320 7769 7468 696e  all tasks within
-00007470: 2061 2067 726f 7570 0a0a 2020 2020 4b65   a group..    Ke
-00007480: 7973 206f 6674 656e 2068 6176 6520 6120  ys often have a 
-00007490: 7374 7275 6374 7572 6520 6c69 6b65 2060  structure like `
-000074a0: 6028 2278 2d31 3233 222c 2030 2960 600a  `("x-123", 0)``.
-000074b0: 2020 2020 4120 6772 6f75 7020 7461 6b65      A group take
-000074c0: 7320 7468 6520 6669 7273 7420 7365 6374  s the first sect
-000074d0: 696f 6e2c 206c 696b 6520 6060 2278 2260  ion, like ``"x"`
-000074e0: 600a 0a20 2020 2053 6565 2041 6c73 6f0a  `..    See Also.
-000074f0: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
-00007500: 2054 6173 6b47 726f 7570 0a20 2020 2022   TaskGroup.    "
-00007510: 2222 0a0a 2020 2020 233a 2054 6865 206e  ""..    #: The n
-00007520: 616d 6520 6f66 2061 2067 726f 7570 206f  ame of a group o
-00007530: 6620 7461 736b 732e 0a20 2020 2023 3a20  f tasks..    #: 
-00007540: 466f 7220 6120 7461 736b 206c 696b 6520  For a task like 
-00007550: 6060 2822 782d 3132 3322 2c20 3029 6060  ``("x-123", 0)``
-00007560: 2074 6869 7320 6973 2074 6865 2074 6578   this is the tex
-00007570: 7420 6060 2278 2260 600a 2020 2020 6e61  t ``"x"``.    na
-00007580: 6d65 3a20 7374 720a 0a20 2020 2023 3a20  me: str..    #: 
-00007590: 416e 2065 7870 6f6e 656e 7469 616c 6c79  An exponentially
-000075a0: 2077 6569 6768 7465 6420 6d6f 7669 6e67   weighted moving
-000075b0: 2061 7665 7261 6765 2064 7572 6174 696f   average duratio
-000075c0: 6e20 6f66 2061 6c6c 2074 6173 6b73 2077  n of all tasks w
-000075d0: 6974 6820 7468 6973 2070 7265 6669 780a  ith this prefix.
-000075e0: 2020 2020 6475 7261 7469 6f6e 5f61 7665      duration_ave
-000075f0: 7261 6765 3a20 666c 6f61 740a 0a20 2020  rage: float..   
-00007600: 2023 3a20 4e75 6d62 6572 7320 6f66 2074   #: Numbers of t
-00007610: 696d 6573 2061 2074 6173 6b20 7761 7320  imes a task was 
-00007620: 6d61 726b 6564 2061 7320 7375 7370 6963  marked as suspic
-00007630: 696f 7573 2077 6974 6820 7468 6973 2070  ious with this p
-00007640: 7265 6669 780a 2020 2020 7375 7370 6963  refix.    suspic
-00007650: 696f 7573 3a20 696e 740a 0a20 2020 2023  ious: int..    #
-00007660: 3a20 5374 6f72 6520 7469 6d69 6e67 7320  : Store timings 
-00007670: 666f 7220 6561 6368 2070 7265 6669 782d  for each prefix-
-00007680: 6163 7469 6f6e 0a20 2020 2061 6c6c 5f64  action.    all_d
-00007690: 7572 6174 696f 6e73 3a20 6465 6661 756c  urations: defaul
-000076a0: 7464 6963 745b 7374 722c 2066 6c6f 6174  tdict[str, float
-000076b0: 5d0a 0a20 2020 2023 3a20 5468 6973 206d  ]..    #: This m
-000076c0: 6561 7375 7265 7320 7468 6520 6d61 7869  easures the maxi
-000076d0: 6d75 6d20 7265 636f 7264 6564 206c 6976  mum recorded liv
-000076e0: 6520 6578 6563 7574 696f 6e20 7469 6d65  e execution time
-000076f0: 2061 6e64 2063 616e 2062 6520 7573 6564   and can be used
-00007700: 2074 6f0a 2020 2020 233a 2064 6574 6563   to.    #: detec
-00007710: 7420 6f75 746c 6965 7273 0a20 2020 206d  t outliers.    m
-00007720: 6178 5f65 7865 635f 7469 6d65 3a20 666c  ax_exec_time: fl
-00007730: 6f61 740a 0a20 2020 2023 3a20 5461 736b  oat..    #: Task
-00007740: 2067 726f 7570 7320 6173 736f 6369 6174   groups associat
-00007750: 6564 2074 6f20 7468 6973 2070 7265 6669  ed to this prefi
-00007760: 780a 2020 2020 6772 6f75 7073 3a20 6c69  x.    groups: li
-00007770: 7374 5b54 6173 6b47 726f 7570 5d0a 0a20  st[TaskGroup].. 
-00007780: 2020 2023 3a20 4163 6375 6d75 6c61 7465     #: Accumulate
-00007790: 2063 6f75 6e74 206f 6620 6e75 6d62 6572   count of number
-000077a0: 206f 6620 7461 736b 7320 696e 2065 6163   of tasks in eac
-000077b0: 6820 7374 6174 650a 2020 2020 7374 6174  h state.    stat
-000077c0: 655f 636f 756e 7473 3a20 6465 6661 756c  e_counts: defaul
-000077d0: 7464 6963 745b 5461 736b 5374 6174 6553  tdict[TaskStateS
-000077e0: 7461 7465 2c20 696e 745d 0a0a 2020 2020  tate, int]..    
-000077f0: 5f5f 736c 6f74 735f 5f20 3d20 7475 706c  __slots__ = tupl
-00007800: 6528 5f5f 616e 6e6f 7461 7469 6f6e 735f  e(__annotations_
-00007810: 5f29 0a0a 2020 2020 6465 6620 5f5f 696e  _)..    def __in
-00007820: 6974 5f5f 2873 656c 662c 206e 616d 653a  it__(self, name:
-00007830: 2073 7472 293a 0a20 2020 2020 2020 2073   str):.        s
-00007840: 656c 662e 6e61 6d65 203d 206e 616d 650a  elf.name = name.
-00007850: 2020 2020 2020 2020 7365 6c66 2e67 726f          self.gro
-00007860: 7570 7320 3d20 5b5d 0a20 2020 2020 2020  ups = [].       
-00007870: 2073 656c 662e 616c 6c5f 6475 7261 7469   self.all_durati
-00007880: 6f6e 7320 3d20 6465 6661 756c 7464 6963  ons = defaultdic
-00007890: 7428 666c 6f61 7429 0a20 2020 2020 2020  t(float).       
-000078a0: 2073 656c 662e 7374 6174 655f 636f 756e   self.state_coun
-000078b0: 7473 203d 2064 6566 6175 6c74 6469 6374  ts = defaultdict
-000078c0: 2869 6e74 290a 2020 2020 2020 2020 7461  (int).        ta
-000078d0: 736b 5f64 7572 6174 696f 6e73 203d 2064  sk_durations = d
-000078e0: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
-000078f0: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
-00007900: 6475 6c65 722e 6465 6661 756c 742d 7461  duler.default-ta
-00007910: 736b 2d64 7572 6174 696f 6e73 2229 0a20  sk-durations"). 
-00007920: 2020 2020 2020 2069 6620 7365 6c66 2e6e         if self.n
-00007930: 616d 6520 696e 2074 6173 6b5f 6475 7261  ame in task_dura
-00007940: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
-00007950: 2020 2073 656c 662e 6475 7261 7469 6f6e     self.duration
-00007960: 5f61 7665 7261 6765 203d 2070 6172 7365  _average = parse
-00007970: 5f74 696d 6564 656c 7461 2874 6173 6b5f  _timedelta(task_
-00007980: 6475 7261 7469 6f6e 735b 7365 6c66 2e6e  durations[self.n
-00007990: 616d 655d 290a 2020 2020 2020 2020 656c  ame]).        el
-000079a0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000079b0: 7365 6c66 2e64 7572 6174 696f 6e5f 6176  self.duration_av
-000079c0: 6572 6167 6520 3d20 2d31 0a20 2020 2020  erage = -1.     
-000079d0: 2020 2073 656c 662e 6d61 785f 6578 6563     self.max_exec
-000079e0: 5f74 696d 6520 3d20 2d31 0a20 2020 2020  _time = -1.     
-000079f0: 2020 2073 656c 662e 7375 7370 6963 696f     self.suspicio
-00007a00: 7573 203d 2030 0a0a 2020 2020 6465 6620  us = 0..    def 
-00007a10: 6164 645f 6578 6563 5f74 696d 6528 7365  add_exec_time(se
-00007a20: 6c66 2c20 6475 7261 7469 6f6e 3a20 666c  lf, duration: fl
-00007a30: 6f61 7429 202d 3e20 4e6f 6e65 3a0a 2020  oat) -> None:.  
-00007a40: 2020 2020 2020 7365 6c66 2e6d 6178 5f65        self.max_e
-00007a50: 7865 635f 7469 6d65 203d 206d 6178 2864  xec_time = max(d
-00007a60: 7572 6174 696f 6e2c 2073 656c 662e 6d61  uration, self.ma
-00007a70: 785f 6578 6563 5f74 696d 6529 0a20 2020  x_exec_time).   
-00007a80: 2020 2020 2069 6620 6475 7261 7469 6f6e       if duration
-00007a90: 203e 2032 202a 2073 656c 662e 6475 7261   > 2 * self.dura
-00007aa0: 7469 6f6e 5f61 7665 7261 6765 3a0a 2020  tion_average:.  
-00007ab0: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
-00007ac0: 7572 6174 696f 6e5f 6176 6572 6167 6520  uration_average 
-00007ad0: 3d20 2d31 0a0a 2020 2020 6465 6620 6164  = -1..    def ad
-00007ae0: 645f 6475 7261 7469 6f6e 2873 656c 662c  d_duration(self,
-00007af0: 2061 6374 696f 6e3a 2073 7472 2c20 7374   action: str, st
-00007b00: 6172 743a 2066 6c6f 6174 2c20 7374 6f70  art: float, stop
-00007b10: 3a20 666c 6f61 7429 202d 3e20 4e6f 6e65  : float) -> None
-00007b20: 3a0a 2020 2020 2020 2020 6475 7261 7469  :.        durati
-00007b30: 6f6e 203d 2073 746f 7020 2d20 7374 6172  on = stop - star
-00007b40: 740a 2020 2020 2020 2020 7365 6c66 2e61  t.        self.a
-00007b50: 6c6c 5f64 7572 6174 696f 6e73 5b61 6374  ll_durations[act
-00007b60: 696f 6e5d 202b 3d20 6475 7261 7469 6f6e  ion] += duration
-00007b70: 0a20 2020 2020 2020 2069 6620 6163 7469  .        if acti
-00007b80: 6f6e 203d 3d20 2263 6f6d 7075 7465 223a  on == "compute":
-00007b90: 0a20 2020 2020 2020 2020 2020 206f 6c64  .            old
-00007ba0: 203d 2073 656c 662e 6475 7261 7469 6f6e   = self.duration
-00007bb0: 5f61 7665 7261 6765 0a20 2020 2020 2020  _average.       
-00007bc0: 2020 2020 2069 6620 6f6c 6420 3c20 303a       if old < 0:
-00007bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007be0: 2073 656c 662e 6475 7261 7469 6f6e 5f61   self.duration_a
-00007bf0: 7665 7261 6765 203d 2064 7572 6174 696f  verage = duratio
-00007c00: 6e0a 2020 2020 2020 2020 2020 2020 656c  n.            el
-00007c10: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00007c20: 2020 2020 7365 6c66 2e64 7572 6174 696f      self.duratio
-00007c30: 6e5f 6176 6572 6167 6520 3d20 302e 3520  n_average = 0.5 
-00007c40: 2a20 6475 7261 7469 6f6e 202b 2030 2e35  * duration + 0.5
-00007c50: 202a 206f 6c64 0a0a 2020 2020 4070 726f   * old..    @pro
-00007c60: 7065 7274 790a 2020 2020 6465 6620 7374  perty.    def st
-00007c70: 6174 6573 2873 656c 6629 202d 3e20 6469  ates(self) -> di
-00007c80: 6374 5b73 7472 2c20 696e 745d 3a0a 2020  ct[str, int]:.  
-00007c90: 2020 2020 2020 2222 2254 6865 206e 756d        """The num
-00007ca0: 6265 7220 6f66 2074 6173 6b73 2069 6e20  ber of tasks in 
-00007cb0: 6561 6368 2073 7461 7465 2c0a 2020 2020  each state,.    
-00007cc0: 2020 2020 6c69 6b65 2060 607b 226d 656d      like ``{"mem
-00007cd0: 6f72 7922 3a20 3130 2c20 2270 726f 6365  ory": 10, "proce
-00007ce0: 7373 696e 6722 3a20 332c 2022 7265 6c65  ssing": 3, "rele
-00007cf0: 6173 6564 223a 2034 2c20 2e2e 2e7d 6060  ased": 4, ...}``
-00007d00: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00007d10: 2020 2020 2072 6574 7572 6e20 6d65 7267       return merg
-00007d20: 655f 7769 7468 2873 756d 2c20 5b74 672e  e_with(sum, [tg.
-00007d30: 7374 6174 6573 2066 6f72 2074 6720 696e  states for tg in
-00007d40: 2073 656c 662e 6772 6f75 7073 5d29 0a0a   self.groups])..
-00007d50: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-00007d60: 2020 6465 6620 6163 7469 7665 2873 656c    def active(sel
-00007d70: 6629 202d 3e20 6c69 7374 5b54 6173 6b47  f) -> list[TaskG
-00007d80: 726f 7570 5d3a 0a20 2020 2020 2020 2072  roup]:.        r
-00007d90: 6574 7572 6e20 5b0a 2020 2020 2020 2020  eturn [.        
-00007da0: 2020 2020 7467 0a20 2020 2020 2020 2020      tg.         
-00007db0: 2020 2066 6f72 2074 6720 696e 2073 656c     for tg in sel
-00007dc0: 662e 6772 6f75 7073 0a20 2020 2020 2020  f.groups.       
-00007dd0: 2020 2020 2069 6620 616e 7928 6b20 213d       if any(k !=
-00007de0: 2022 666f 7267 6f74 7465 6e22 2061 6e64   "forgotten" and
-00007df0: 2076 2021 3d20 3020 666f 7220 6b2c 2076   v != 0 for k, v
-00007e00: 2069 6e20 7467 2e73 7461 7465 732e 6974   in tg.states.it
-00007e10: 656d 7328 2929 0a20 2020 2020 2020 205d  ems()).        ]
-00007e20: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-00007e30: 2020 2020 6465 6620 6163 7469 7665 5f73      def active_s
-00007e40: 7461 7465 7328 7365 6c66 2920 2d3e 2064  tates(self) -> d
-00007e50: 6963 745b 7374 722c 2069 6e74 5d3a 0a20  ict[str, int]:. 
-00007e60: 2020 2020 2020 2072 6574 7572 6e20 6d65         return me
-00007e70: 7267 655f 7769 7468 2873 756d 2c20 5b74  rge_with(sum, [t
-00007e80: 672e 7374 6174 6573 2066 6f72 2074 6720  g.states for tg 
-00007e90: 696e 2073 656c 662e 6163 7469 7665 5d29  in self.active])
-00007ea0: 0a0a 2020 2020 6465 6620 5f5f 7265 7072  ..    def __repr
-00007eb0: 5f5f 2873 656c 6629 202d 3e20 7374 723a  __(self) -> str:
-00007ec0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00007ed0: 280a 2020 2020 2020 2020 2020 2020 223c  (.            "<
-00007ee0: 220a 2020 2020 2020 2020 2020 2020 2b20  ".            + 
-00007ef0: 7365 6c66 2e6e 616d 650a 2020 2020 2020  self.name.      
-00007f00: 2020 2020 2020 2b20 223a 2022 0a20 2020        + ": ".   
-00007f10: 2020 2020 2020 2020 202b 2022 2c20 222e           + ", ".
-00007f20: 6a6f 696e 280a 2020 2020 2020 2020 2020  join(.          
-00007f30: 2020 2020 2020 2225 733a 2025 6422 2025        "%s: %d" %
-00007f40: 2028 6b2c 2076 2920 666f 7220 286b 2c20   (k, v) for (k, 
-00007f50: 7629 2069 6e20 736f 7274 6564 2873 656c  v) in sorted(sel
-00007f60: 662e 7374 6174 6573 2e69 7465 6d73 2829  f.states.items()
-00007f70: 2920 6966 2076 0a20 2020 2020 2020 2020  ) if v.         
-00007f80: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00007f90: 202b 2022 3e22 0a20 2020 2020 2020 2029   + ">".        )
-00007fa0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-00007fb0: 2020 2020 6465 6620 6e62 7974 6573 5f74      def nbytes_t
-00007fc0: 6f74 616c 2873 656c 6629 202d 3e20 696e  otal(self) -> in
-00007fd0: 743a 0a20 2020 2020 2020 2072 6574 7572  t:.        retur
-00007fe0: 6e20 7375 6d28 7467 2e6e 6279 7465 735f  n sum(tg.nbytes_
-00007ff0: 746f 7461 6c20 666f 7220 7467 2069 6e20  total for tg in 
-00008000: 7365 6c66 2e67 726f 7570 7329 0a0a 2020  self.groups)..  
-00008010: 2020 6465 6620 5f5f 6c65 6e5f 5f28 7365    def __len__(se
-00008020: 6c66 2920 2d3e 2069 6e74 3a0a 2020 2020  lf) -> int:.    
-00008030: 2020 2020 7265 7475 726e 2073 756d 286d      return sum(m
-00008040: 6170 286c 656e 2c20 7365 6c66 2e67 726f  ap(len, self.gro
-00008050: 7570 7329 290a 0a20 2020 2040 7072 6f70  ups))..    @prop
-00008060: 6572 7479 0a20 2020 2064 6566 2064 7572  erty.    def dur
-00008070: 6174 696f 6e28 7365 6c66 2920 2d3e 2066  ation(self) -> f
-00008080: 6c6f 6174 3a0a 2020 2020 2020 2020 7265  loat:.        re
-00008090: 7475 726e 2073 756d 2874 672e 6475 7261  turn sum(tg.dura
-000080a0: 7469 6f6e 2066 6f72 2074 6720 696e 2073  tion for tg in s
-000080b0: 656c 662e 6772 6f75 7073 290a 0a20 2020  elf.groups)..   
-000080c0: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-000080d0: 6566 2074 7970 6573 2873 656c 6629 202d  ef types(self) -
-000080e0: 3e20 7365 745b 7374 725d 3a0a 2020 2020  > set[str]:.    
-000080f0: 2020 2020 7265 7475 726e 207b 7479 7020      return {typ 
-00008100: 666f 7220 7467 2069 6e20 7365 6c66 2e67  for tg in self.g
-00008110: 726f 7570 7320 666f 7220 7479 7020 696e  roups for typ in
-00008120: 2074 672e 7479 7065 737d 0a0a 0a63 6c61   tg.types}...cla
-00008130: 7373 2054 6173 6b47 726f 7570 3a0a 2020  ss TaskGroup:.  
-00008140: 2020 2222 2243 6f6c 6c65 6374 696f 6e20    """Collection 
-00008150: 7472 6163 6b69 6e67 2061 6c6c 2074 6173  tracking all tas
-00008160: 6b73 2077 6974 6869 6e20 6120 6772 6f75  ks within a grou
-00008170: 700a 0a20 2020 204b 6579 7320 6f66 7465  p..    Keys ofte
-00008180: 6e20 6861 7665 2061 2073 7472 7563 7475  n have a structu
-00008190: 7265 206c 696b 6520 6060 2822 782d 3132  re like ``("x-12
-000081a0: 3322 2c20 3029 6060 0a20 2020 2041 2067  3", 0)``.    A g
-000081b0: 726f 7570 2074 616b 6573 2074 6865 2066  roup takes the f
-000081c0: 6972 7374 2073 6563 7469 6f6e 2c20 6c69  irst section, li
-000081d0: 6b65 2060 6022 782d 3132 3322 6060 0a0a  ke ``"x-123"``..
-000081e0: 2020 2020 5365 6520 616c 736f 0a20 2020      See also.   
-000081f0: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 5461   --------.    Ta
-00008200: 736b 5072 6566 6978 0a20 2020 2022 2222  skPrefix.    """
-00008210: 0a0a 2020 2020 233a 2054 6865 206e 616d  ..    #: The nam
-00008220: 6520 6f66 2061 2067 726f 7570 206f 6620  e of a group of 
-00008230: 7461 736b 732e 0a20 2020 2023 3a20 466f  tasks..    #: Fo
-00008240: 7220 6120 7461 736b 206c 696b 6520 6060  r a task like ``
-00008250: 2822 782d 3132 3322 2c20 3029 6060 2074  ("x-123", 0)`` t
-00008260: 6869 7320 6973 2074 6865 2074 6578 7420  his is the text 
-00008270: 6060 2278 2d31 3233 2260 600a 2020 2020  ``"x-123"``.    
-00008280: 6e61 6d65 3a20 7374 720a 0a20 2020 2023  name: str..    #
-00008290: 3a20 5468 6520 6e75 6d62 6572 206f 6620  : The number of 
-000082a0: 7461 736b 7320 696e 2065 6163 6820 7374  tasks in each st
-000082b0: 6174 652c 0a20 2020 2023 3a20 6c69 6b65  ate,.    #: like
-000082c0: 2060 607b 226d 656d 6f72 7922 3a20 3130   ``{"memory": 10
-000082d0: 2c20 2270 726f 6365 7373 696e 6722 3a20  , "processing": 
-000082e0: 332c 2022 7265 6c65 6173 6564 223a 2034  3, "released": 4
-000082f0: 2c20 2e2e 2e7d 6060 0a20 2020 2073 7461  , ...}``.    sta
-00008300: 7465 733a 2064 6963 745b 5461 736b 5374  tes: dict[TaskSt
-00008310: 6174 6553 7461 7465 2c20 696e 745d 0a0a  ateState, int]..
-00008320: 2020 2020 233a 2054 6865 206f 7468 6572      #: The other
-00008330: 2054 6173 6b47 726f 7570 7320 6f6e 2077   TaskGroups on w
-00008340: 6869 6368 2074 6869 7320 6f6e 6520 6465  hich this one de
-00008350: 7065 6e64 730a 2020 2020 6465 7065 6e64  pends.    depend
-00008360: 656e 6369 6573 3a20 7365 745b 5461 736b  encies: set[Task
-00008370: 4772 6f75 705d 0a0a 2020 2020 233a 2054  Group]..    #: T
-00008380: 6865 2074 6f74 616c 206e 756d 6265 7220  he total number 
-00008390: 6f66 2062 7974 6573 2074 6861 7420 7468  of bytes that th
-000083a0: 6973 2074 6173 6b20 6772 6f75 7020 6861  is task group ha
-000083b0: 7320 7072 6f64 7563 6564 0a20 2020 206e  s produced.    n
-000083c0: 6279 7465 735f 746f 7461 6c3a 2069 6e74  bytes_total: int
-000083d0: 0a0a 2020 2020 233a 2054 6865 2074 6f74  ..    #: The tot
-000083e0: 616c 2061 6d6f 756e 7420 6f66 2074 696d  al amount of tim
-000083f0: 6520 7370 656e 7420 6f6e 2061 6c6c 2074  e spent on all t
-00008400: 6173 6b73 2069 6e20 7468 6973 2054 6173  asks in this Tas
-00008410: 6b47 726f 7570 0a20 2020 2064 7572 6174  kGroup.    durat
-00008420: 696f 6e3a 2066 6c6f 6174 0a0a 2020 2020  ion: float..    
-00008430: 233a 2054 6865 2072 6573 756c 7420 7479  #: The result ty
-00008440: 7065 7320 6f66 2074 6869 7320 5461 736b  pes of this Task
-00008450: 4772 6f75 700a 2020 2020 7479 7065 733a  Group.    types:
-00008460: 2073 6574 5b73 7472 5d0a 0a20 2020 2023   set[str]..    #
-00008470: 3a20 5468 6520 776f 726b 6572 206d 6f73  : The worker mos
-00008480: 7420 7265 6365 6e74 6c79 2061 7373 6967  t recently assig
-00008490: 6e65 6420 6120 7461 736b 2066 726f 6d20  ned a task from 
-000084a0: 7468 6973 2067 726f 7570 2c20 6f72 204e  this group, or N
-000084b0: 6f6e 6520 7768 656e 2074 6865 2067 726f  one when the gro
-000084c0: 7570 0a20 2020 2023 3a20 6973 206e 6f74  up.    #: is not
-000084d0: 2069 6465 6e74 6966 6965 6420 746f 2062   identified to b
-000084e0: 6520 726f 6f74 2d6c 696b 6520 6279 2060  e root-like by `
-000084f0: 5363 6865 6475 6c65 7253 7461 7465 2e64  SchedulerState.d
-00008500: 6563 6964 655f 776f 726b 6572 602e 0a20  ecide_worker`.. 
-00008510: 2020 206c 6173 745f 776f 726b 6572 3a20     last_worker: 
-00008520: 576f 726b 6572 5374 6174 6520 7c20 4e6f  WorkerState | No
-00008530: 6e65 0a0a 2020 2020 233a 2049 6620 606c  ne..    #: If `l
-00008540: 6173 745f 776f 726b 6572 6020 6973 206e  ast_worker` is n
-00008550: 6f74 204e 6f6e 652c 2074 6865 206e 756d  ot None, the num
-00008560: 6265 7220 6f66 2074 696d 6573 2074 6861  ber of times tha
-00008570: 7420 776f 726b 6572 2073 686f 756c 6420  t worker should 
-00008580: 6265 2061 7373 6967 6e65 640a 2020 2020  be assigned.    
-00008590: 233a 2073 7562 7365 7175 656e 7420 7461  #: subsequent ta
-000085a0: 736b 7320 756e 7469 6c20 6120 6e65 7720  sks until a new 
-000085b0: 776f 726b 6572 2069 7320 6368 6f73 656e  worker is chosen
-000085c0: 2e0a 2020 2020 6c61 7374 5f77 6f72 6b65  ..    last_worke
-000085d0: 725f 7461 736b 735f 6c65 6674 3a20 696e  r_tasks_left: in
-000085e0: 740a 0a20 2020 2070 7265 6669 783a 2054  t..    prefix: T
-000085f0: 6173 6b50 7265 6669 7820 7c20 4e6f 6e65  askPrefix | None
-00008600: 0a0a 2020 2020 233a 2045 6172 6c69 6573  ..    #: Earlies
-00008610: 7420 7469 6d65 2077 6865 6e20 6120 7461  t time when a ta
-00008620: 736b 2062 656c 6f6e 6769 6e67 2074 6f20  sk belonging to 
-00008630: 7468 6973 2067 726f 7570 2073 7461 7274  this group start
-00008640: 6564 2063 6f6d 7075 7469 6e67 3b0a 2020  ed computing;.  
-00008650: 2020 233a 2030 2069 6620 6e6f 2074 6173    #: 0 if no tas
-00008660: 6b20 6861 7320 2a66 696e 6973 6865 642a  k has *finished*
-00008670: 2063 6f6d 7075 7469 6e67 2079 6574 0a20   computing yet. 
-00008680: 2020 2023 3a0a 2020 2020 233a 204e 6f74     #:.    #: Not
-00008690: 6573 0a20 2020 2023 3a20 2d2d 2d2d 2d0a  es.    #: -----.
-000086a0: 2020 2020 233a 2054 6869 7320 6973 206e      #: This is n
-000086b0: 6f74 2075 7064 6174 6564 2075 6e74 696c  ot updated until
-000086c0: 2061 7420 6c65 6173 7420 6f6e 6520 7461   at least one ta
-000086d0: 736b 2068 6173 202a 6669 6e69 7368 6564  sk has *finished
-000086e0: 2a20 636f 6d70 7574 696e 672e 0a20 2020  * computing..   
-000086f0: 2023 3a20 4974 2063 6f75 6c64 206d 6f76   #: It could mov
-00008700: 6520 6261 636b 7761 7264 7320 6173 2074  e backwards as t
-00008710: 6173 6b73 2063 6f6d 706c 6574 652e 0a20  asks complete.. 
-00008720: 2020 2073 7461 7274 3a20 666c 6f61 740a     start: float.
-00008730: 0a20 2020 2023 3a20 4c61 7465 7374 2074  .    #: Latest t
-00008740: 696d 6520 7768 656e 2061 2074 6173 6b20  ime when a task 
-00008750: 6265 6c6f 6e67 696e 6720 746f 2074 6869  belonging to thi
-00008760: 7320 6772 6f75 7020 6669 6e69 7368 6564  s group finished
-00008770: 2063 6f6d 7075 7469 6e67 2c0a 2020 2020   computing,.    
-00008780: 233a 2030 2069 6620 6e6f 2074 6173 6b20  #: 0 if no task 
-00008790: 6861 7320 6669 6e69 7368 6564 2063 6f6d  has finished com
-000087a0: 7075 7469 6e67 2079 6574 0a20 2020 2073  puting yet.    s
-000087b0: 746f 703a 2066 6c6f 6174 0a0a 2020 2020  top: float..    
-000087c0: 233a 2043 756d 756c 6174 6976 6520 6475  #: Cumulative du
-000087d0: 7261 7469 6f6e 206f 6620 616c 6c20 636f  ration of all co
-000087e0: 6d70 6c65 7465 6420 6163 7469 6f6e 732c  mpleted actions,
-000087f0: 2062 7920 6163 7469 6f6e 0a20 2020 2061   by action.    a
-00008800: 6c6c 5f64 7572 6174 696f 6e73 3a20 6465  ll_durations: de
-00008810: 6661 756c 7464 6963 745b 7374 722c 2066  faultdict[str, f
-00008820: 6c6f 6174 5d0a 0a20 2020 2023 3a20 5370  loat]..    #: Sp
-00008830: 616e 2049 4420 2873 6565 2060 6064 6973  an ID (see ``dis
-00008840: 7472 6962 7574 6564 2e73 7061 6e73 6060  tributed.spans``
-00008850: 292e 0a20 2020 2023 3a20 4d61 7463 6865  )..    #: Matche
-00008860: 7320 6060 6469 7374 7269 6275 7465 642e  s ``distributed.
-00008870: 776f 726b 6572 5f73 7461 7465 5f6d 6163  worker_state_mac
-00008880: 6869 6e65 2e54 6173 6b53 7461 7465 2e73  hine.TaskState.s
-00008890: 7061 6e5f 6964 6060 2e0a 2020 2020 233a  pan_id``..    #:
-000088a0: 2049 7420 6973 2070 6f73 7369 626c 6520   It is possible 
-000088b0: 746f 2065 6e64 2075 7020 696e 2073 6974  to end up in sit
-000088c0: 7561 7469 6f6e 2077 6865 7265 2064 6966  uation where dif
-000088d0: 6665 7265 6e74 2074 6173 6b73 206f 6620  ferent tasks of 
-000088e0: 7468 6520 7361 6d65 2054 6173 6b47 726f  the same TaskGro
-000088f0: 7570 0a20 2020 2023 3a20 6265 6c6f 6e67  up.    #: belong
-00008900: 2074 6f20 6469 6666 6572 656e 7420 7370   to different sp
-00008910: 616e 733b 2074 6865 2070 7572 706f 7365  ans; the purpose
-00008920: 206f 6620 7468 6973 2061 7474 7269 6275   of this attribu
-00008930: 7465 2069 7320 746f 2061 7262 6974 7261  te is to arbitra
-00008940: 7269 6c79 2066 6f72 6365 0a20 2020 2023  rily force.    #
-00008950: 3a20 6576 6572 7974 6869 6e67 206f 6e74  : everything ont
-00008960: 6f20 7468 6520 6561 726c 6965 7374 2065  o the earliest e
-00008970: 6e63 6f75 6e74 6572 6564 206f 6e65 2e0a  ncountered one..
-00008980: 2020 2020 7370 616e 5f69 643a 2073 7472      span_id: str
-00008990: 207c 204e 6f6e 650a 0a20 2020 205f 5f73   | None..    __s
-000089a0: 6c6f 7473 5f5f 203d 2074 7570 6c65 285f  lots__ = tuple(_
-000089b0: 5f61 6e6e 6f74 6174 696f 6e73 5f5f 290a  _annotations__).
-000089c0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-000089d0: 5f28 7365 6c66 2c20 6e61 6d65 3a20 7374  _(self, name: st
-000089e0: 7229 3a0a 2020 2020 2020 2020 7365 6c66  r):.        self
-000089f0: 2e6e 616d 6520 3d20 6e61 6d65 0a20 2020  .name = name.   
-00008a00: 2020 2020 2073 656c 662e 7072 6566 6978       self.prefix
-00008a10: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00008a20: 7365 6c66 2e73 7461 7465 7320 3d20 6469  self.states = di
-00008a30: 6374 2e66 726f 6d6b 6579 7328 414c 4c5f  ct.fromkeys(ALL_
-00008a40: 5441 534b 5f53 5441 5445 532c 2030 290a  TASK_STATES, 0).
-00008a50: 2020 2020 2020 2020 7365 6c66 2e64 6570          self.dep
-00008a60: 656e 6465 6e63 6965 7320 3d20 7365 7428  endencies = set(
-00008a70: 290a 2020 2020 2020 2020 7365 6c66 2e6e  ).        self.n
-00008a80: 6279 7465 735f 746f 7461 6c20 3d20 300a  bytes_total = 0.
-00008a90: 2020 2020 2020 2020 7365 6c66 2e64 7572          self.dur
-00008aa0: 6174 696f 6e20 3d20 300a 2020 2020 2020  ation = 0.      
-00008ab0: 2020 7365 6c66 2e74 7970 6573 203d 2073    self.types = s
-00008ac0: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
-00008ad0: 662e 7374 6172 7420 3d20 302e 300a 2020  f.start = 0.0.  
-00008ae0: 2020 2020 2020 7365 6c66 2e73 746f 7020        self.stop 
-00008af0: 3d20 302e 300a 2020 2020 2020 2020 7365  = 0.0.        se
-00008b00: 6c66 2e61 6c6c 5f64 7572 6174 696f 6e73  lf.all_durations
-00008b10: 203d 2064 6566 6175 6c74 6469 6374 2866   = defaultdict(f
-00008b20: 6c6f 6174 290a 2020 2020 2020 2020 7365  loat).        se
-00008b30: 6c66 2e6c 6173 745f 776f 726b 6572 203d  lf.last_worker =
-00008b40: 204e 6f6e 650a 2020 2020 2020 2020 7365   None.        se
-00008b50: 6c66 2e6c 6173 745f 776f 726b 6572 5f74  lf.last_worker_t
-00008b60: 6173 6b73 5f6c 6566 7420 3d20 300a 2020  asks_left = 0.  
-00008b70: 2020 2020 2020 7365 6c66 2e73 7061 6e5f        self.span_
-00008b80: 6964 203d 204e 6f6e 650a 0a20 2020 2064  id = None..    d
-00008b90: 6566 2061 6464 5f64 7572 6174 696f 6e28  ef add_duration(
-00008ba0: 7365 6c66 2c20 6163 7469 6f6e 3a20 7374  self, action: st
-00008bb0: 722c 2073 7461 7274 3a20 666c 6f61 742c  r, start: float,
-00008bc0: 2073 746f 703a 2066 6c6f 6174 2920 2d3e   stop: float) ->
-00008bd0: 204e 6f6e 653a 0a20 2020 2020 2020 2064   None:.        d
-00008be0: 7572 6174 696f 6e20 3d20 7374 6f70 202d  uration = stop -
-00008bf0: 2073 7461 7274 0a20 2020 2020 2020 2073   start.        s
-00008c00: 656c 662e 6475 7261 7469 6f6e 202b 3d20  elf.duration += 
-00008c10: 6475 7261 7469 6f6e 0a20 2020 2020 2020  duration.       
-00008c20: 2073 656c 662e 616c 6c5f 6475 7261 7469   self.all_durati
-00008c30: 6f6e 735b 6163 7469 6f6e 5d20 2b3d 2064  ons[action] += d
-00008c40: 7572 6174 696f 6e0a 2020 2020 2020 2020  uration.        
-00008c50: 6966 2061 6374 696f 6e20 3d3d 2022 636f  if action == "co
-00008c60: 6d70 7574 6522 3a0a 2020 2020 2020 2020  mpute":.        
-00008c70: 2020 2020 6966 2073 656c 662e 7374 6f70      if self.stop
-00008c80: 203c 2073 746f 703a 0a20 2020 2020 2020   < stop:.       
-00008c90: 2020 2020 2020 2020 2073 656c 662e 7374           self.st
-00008ca0: 6f70 203d 2073 746f 700a 2020 2020 2020  op = stop.      
-00008cb0: 2020 2020 2020 6966 2073 656c 662e 7374        if self.st
-00008cc0: 6172 7420 3d3d 2030 2e30 206f 7220 7365  art == 0.0 or se
-00008cd0: 6c66 2e73 7461 7274 203e 2073 7461 7274  lf.start > start
-00008ce0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00008cf0: 2020 7365 6c66 2e73 7461 7274 203d 2073    self.start = s
-00008d00: 7461 7274 0a20 2020 2020 2020 2061 7373  tart.        ass
-00008d10: 6572 7420 7365 6c66 2e70 7265 6669 7820  ert self.prefix 
-00008d20: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
-00008d30: 2020 2020 7365 6c66 2e70 7265 6669 782e      self.prefix.
-00008d40: 6164 645f 6475 7261 7469 6f6e 2861 6374  add_duration(act
-00008d50: 696f 6e2c 2073 7461 7274 2c20 7374 6f70  ion, start, stop
-00008d60: 290a 0a20 2020 2064 6566 2061 6464 2873  )..    def add(s
-00008d70: 656c 662c 206f 7468 6572 3a20 5461 736b  elf, other: Task
-00008d80: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
-00008d90: 2020 2020 2020 2020 7365 6c66 2e73 7461          self.sta
-00008da0: 7465 735b 6f74 6865 722e 7374 6174 655d  tes[other.state]
-00008db0: 202b 3d20 310a 2020 2020 2020 2020 6f74   += 1.        ot
-00008dc0: 6865 722e 6772 6f75 7020 3d20 7365 6c66  her.group = self
-00008dd0: 0a0a 2020 2020 6465 6620 5f5f 7265 7072  ..    def __repr
-00008de0: 5f5f 2873 656c 6629 202d 3e20 7374 723a  __(self) -> str:
-00008df0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00008e00: 280a 2020 2020 2020 2020 2020 2020 223c  (.            "<
-00008e10: 220a 2020 2020 2020 2020 2020 2020 2b20  ".            + 
-00008e20: 2873 656c 662e 6e61 6d65 206f 7220 226e  (self.name or "n
-00008e30: 6f2d 6772 6f75 7022 290a 2020 2020 2020  o-group").      
-00008e40: 2020 2020 2020 2b20 223a 2022 0a20 2020        + ": ".   
-00008e50: 2020 2020 2020 2020 202b 2022 2c20 222e           + ", ".
-00008e60: 6a6f 696e 280a 2020 2020 2020 2020 2020  join(.          
-00008e70: 2020 2020 2020 2225 733a 2025 6422 2025        "%s: %d" %
-00008e80: 2028 6b2c 2076 2920 666f 7220 286b 2c20   (k, v) for (k, 
-00008e90: 7629 2069 6e20 736f 7274 6564 2873 656c  v) in sorted(sel
-00008ea0: 662e 7374 6174 6573 2e69 7465 6d73 2829  f.states.items()
-00008eb0: 2920 6966 2076 0a20 2020 2020 2020 2020  ) if v.         
-00008ec0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00008ed0: 202b 2022 3e22 0a20 2020 2020 2020 2029   + ">".        )
-00008ee0: 0a0a 2020 2020 6465 6620 5f5f 6c65 6e5f  ..    def __len_
-00008ef0: 5f28 7365 6c66 2920 2d3e 2069 6e74 3a0a  _(self) -> int:.
-00008f00: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00008f10: 756d 2873 656c 662e 7374 6174 6573 2e76  um(self.states.v
-00008f20: 616c 7565 7328 2929 0a0a 2020 2020 6465  alues())..    de
-00008f30: 6620 5f74 6f5f 6469 6374 5f6e 6f5f 6e65  f _to_dict_no_ne
-00008f40: 7374 2873 656c 662c 202a 2c20 6578 636c  st(self, *, excl
-00008f50: 7564 653a 2043 6f6e 7461 696e 6572 5b73  ude: Container[s
-00008f60: 7472 5d20 3d20 2829 2920 2d3e 2064 6963  tr] = ()) -> dic
-00008f70: 745b 7374 722c 2041 6e79 5d3a 0a20 2020  t[str, Any]:.   
-00008f80: 2020 2020 2022 2222 4469 6374 696f 6e61       """Dictiona
-00008f90: 7279 2072 6570 7265 7365 6e74 6174 696f  ry representatio
-00008fa0: 6e20 666f 7220 6465 6275 6767 696e 6720  n for debugging 
-00008fb0: 7075 7270 6f73 6573 2e0a 2020 2020 2020  purposes..      
-00008fc0: 2020 4e6f 7420 7479 7065 2073 7461 626c    Not type stabl
-00008fd0: 6520 616e 6420 6e6f 7420 696e 7465 6e64  e and not intend
-00008fe0: 6564 2066 6f72 2072 6f75 6e64 7472 6970  ed for roundtrip
-00008ff0: 732e 0a0a 2020 2020 2020 2020 5365 6520  s...        See 
-00009000: 616c 736f 0a20 2020 2020 2020 202d 2d2d  also.        ---
-00009010: 2d2d 2d2d 2d0a 2020 2020 2020 2020 436c  -----.        Cl
-00009020: 6965 6e74 2e64 756d 705f 636c 7573 7465  ient.dump_cluste
-00009030: 725f 7374 6174 650a 2020 2020 2020 2020  r_state.        
-00009040: 6469 7374 7269 6275 7465 642e 7574 696c  distributed.util
-00009050: 732e 7265 6375 7273 6976 655f 746f 5f64  s.recursive_to_d
-00009060: 6963 740a 2020 2020 2020 2020 5461 736b  ict.        Task
-00009070: 5374 6174 652e 5f74 6f5f 6469 6374 0a20  State._to_dict. 
-00009080: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00009090: 2020 2072 6574 7572 6e20 7265 6375 7273     return recurs
-000090a0: 6976 655f 746f 5f64 6963 7428 7365 6c66  ive_to_dict(self
-000090b0: 2c20 6578 636c 7564 653d 6578 636c 7564  , exclude=exclud
-000090c0: 652c 206d 656d 6265 7273 3d54 7275 6529  e, members=True)
-000090d0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-000090e0: 2020 2020 6465 6620 646f 6e65 2873 656c      def done(sel
-000090f0: 6629 202d 3e20 626f 6f6c 3a0a 2020 2020  f) -> bool:.    
-00009100: 2020 2020 2222 2252 6574 7572 6e20 5472      """Return Tr
-00009110: 7565 2069 6620 616c 6c20 636f 6d70 7574  ue if all comput
-00009120: 6174 696f 6e73 2066 6f72 2074 6869 7320  ations for this 
-00009130: 6772 6f75 7020 6861 7665 2063 6f6d 706c  group have compl
-00009140: 6574 6564 3b20 4661 6c73 650a 2020 2020  eted; False.    
-00009150: 2020 2020 6f74 6865 7277 6973 652e 0a0a      otherwise...
-00009160: 2020 2020 2020 2020 4e6f 7465 730a 2020          Notes.  
-00009170: 2020 2020 2020 2d2d 2d2d 2d0a 2020 2020        -----.    
-00009180: 2020 2020 5468 6973 2070 726f 7065 7274      This propert
-00009190: 7920 6d61 7920 7472 616e 7369 7469 6f6e  y may transition
-000091a0: 2066 726f 6d20 5472 7565 2074 6f20 4661   from True to Fa
-000091b0: 6c73 652c 2065 2e67 2e20 7768 656e 2061  lse, e.g. when a
-000091c0: 2077 6f72 6b65 7220 7468 6174 0a20 2020   worker that.   
-000091d0: 2020 2020 2063 6f6e 7461 696e 6564 2074       contained t
-000091e0: 6865 206f 6e6c 7920 7265 706c 6963 6120  he only replica 
-000091f0: 6f66 2061 2074 6173 6b20 696e 206d 656d  of a task in mem
-00009200: 6f72 7920 6372 6173 6865 7320 616e 6420  ory crashes and 
-00009210: 7468 6520 7461 736b 206e 6565 6420 746f  the task need to
-00009220: 2062 650a 2020 2020 2020 2020 7265 636f   be.        reco
-00009230: 6d70 7574 6564 2e0a 2020 2020 2020 2020  mputed..        
-00009240: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
-00009250: 726e 2061 6c6c 280a 2020 2020 2020 2020  rn all(.        
-00009260: 2020 2020 636f 756e 7420 3d3d 2030 206f      count == 0 o
-00009270: 7220 7374 6174 6520 696e 207b 226d 656d  r state in {"mem
-00009280: 6f72 7922 2c20 2265 7272 6564 222c 2022  ory", "erred", "
-00009290: 7265 6c65 6173 6564 222c 2022 666f 7267  released", "forg
-000092a0: 6f74 7465 6e22 7d0a 2020 2020 2020 2020  otten"}.        
-000092b0: 2020 2020 666f 7220 7374 6174 652c 2063      for state, c
-000092c0: 6f75 6e74 2069 6e20 7365 6c66 2e73 7461  ount in self.sta
-000092d0: 7465 732e 6974 656d 7328 290a 2020 2020  tes.items().    
-000092e0: 2020 2020 290a 0a0a 636c 6173 7320 5461      )...class Ta
-000092f0: 736b 5374 6174 653a 0a20 2020 2022 2222  skState:.    """
-00009300: 4120 7369 6d70 6c65 206f 626a 6563 7420  A simple object 
-00009310: 686f 6c64 696e 6720 696e 666f 726d 6174  holding informat
-00009320: 696f 6e20 6162 6f75 7420 6120 7461 736b  ion about a task
-00009330: 2e0a 0a20 2020 204e 6f74 2074 6f20 6265  ...    Not to be
-00009340: 2063 6f6e 6675 7365 6420 7769 7468 203a   confused with :
-00009350: 636c 6173 733a 6064 6973 7472 6962 7574  class:`distribut
-00009360: 6564 2e77 6f72 6b65 725f 7374 6174 655f  ed.worker_state_
-00009370: 6d61 6368 696e 652e 5461 736b 5374 6174  machine.TaskStat
-00009380: 6560 2c20 7768 6963 680a 2020 2020 686f  e`, which.    ho
-00009390: 6c64 7320 7369 6d69 6c61 7220 696e 666f  lds similar info
-000093a0: 726d 6174 696f 6e20 6f6e 2074 6865 2057  rmation on the W
-000093b0: 6f72 6b65 7220 7369 6465 2e0a 2020 2020  orker side..    
-000093c0: 2222 220a 0a20 2020 2023 3a20 5468 6520  """..    #: The 
-000093d0: 6b65 7920 6973 2074 6865 2075 6e69 7175  key is the uniqu
-000093e0: 6520 6964 656e 7469 6669 6572 206f 6620  e identifier of 
-000093f0: 6120 7461 736b 2c20 6765 6e65 7261 6c6c  a task, generall
-00009400: 7920 666f 726d 6564 2066 726f 6d20 7468  y formed from th
-00009410: 6520 6e61 6d65 206f 6620 7468 650a 2020  e name of the.  
-00009420: 2020 233a 2066 756e 6374 696f 6e2c 2066    #: function, f
-00009430: 6f6c 6c6f 7765 6420 6279 2061 2068 6173  ollowed by a has
-00009440: 6820 6f66 2074 6865 2066 756e 6374 696f  h of the functio
-00009450: 6e20 616e 6420 6172 6775 6d65 6e74 732c  n and arguments,
-00009460: 206c 696b 650a 2020 2020 233a 2060 6027   like.    #: ``'
-00009470: 696e 632d 6162 3331 6330 3130 3434 3439  inc-ab31c0104449
-00009480: 3737 3030 3464 3635 3636 3130 6432 6434  77004d656610d2d4
-00009490: 3231 6563 2760 602e 0a20 2020 206b 6579  21ec'``..    key
-000094a0: 3a20 7374 720a 0a20 2020 2023 3a20 5468  : str..    #: Th
-000094b0: 6520 6272 6f61 6420 636c 6173 7320 6f66  e broad class of
-000094c0: 2074 6173 6b73 2074 6f20 7768 6963 6820   tasks to which 
-000094d0: 7468 6973 2074 6173 6b20 6265 6c6f 6e67  this task belong
-000094e0: 7320 6c69 6b65 2022 696e 6322 206f 7220  s like "inc" or 
-000094f0: 2272 6561 645f 6373 7622 0a20 2020 2070  "read_csv".    p
-00009500: 7265 6669 783a 2054 6173 6b50 7265 6669  refix: TaskPrefi
-00009510: 780a 0a20 2020 2023 3a20 4120 7370 6563  x..    #: A spec
-00009520: 6966 6963 6174 696f 6e20 6f66 2068 6f77  ification of how
-00009530: 2074 6f20 7275 6e20 7468 6520 7461 736b   to run the task
-00009540: 2e20 2054 6865 2074 7970 6520 616e 6420  .  The type and 
-00009550: 6d65 616e 696e 6720 6f66 2074 6869 7320  meaning of this 
-00009560: 7661 6c75 6520 6973 0a20 2020 2023 3a20  value is.    #: 
-00009570: 6f70 6171 7565 2074 6f20 7468 6520 7363  opaque to the sc
-00009580: 6865 6475 6c65 722c 2061 7320 6974 2069  heduler, as it i
-00009590: 7320 6f6e 6c79 2069 6e74 6572 7072 6574  s only interpret
-000095a0: 6564 2062 7920 7468 6520 776f 726b 6572  ed by the worker
-000095b0: 2074 6f20 7768 6963 6820 7468 650a 2020   to which the.  
-000095c0: 2020 233a 2074 6173 6b20 6973 2073 656e    #: task is sen
-000095d0: 7420 666f 7220 6578 6563 7574 696e 672e  t for executing.
-000095e0: 0a20 2020 2023 3a0a 2020 2020 233a 2041  .    #:.    #: A
-000095f0: 7320 6120 7370 6563 6961 6c20 6361 7365  s a special case
-00009600: 2c20 7468 6973 2061 7474 7269 6275 7465  , this attribute
-00009610: 206d 6179 2061 6c73 6f20 6265 2060 604e   may also be ``N
-00009620: 6f6e 6560 602c 2069 6e20 7768 6963 6820  one``, in which 
-00009630: 6361 7365 2074 6865 2074 6173 6b20 6973  case the task is
-00009640: 0a20 2020 2023 3a20 2270 7572 6520 6461  .    #: "pure da
-00009650: 7461 2220 2873 7563 6820 6173 2c20 666f  ta" (such as, fo
-00009660: 7220 6578 616d 706c 652c 2061 2070 6965  r example, a pie
-00009670: 6365 206f 6620 6461 7461 206c 6f61 6465  ce of data loade
-00009680: 6420 696e 2074 6865 2073 6368 6564 756c  d in the schedul
-00009690: 6572 2075 7369 6e67 0a20 2020 2023 3a20  er using.    #: 
-000096a0: 3a6d 6574 683a 6043 6c69 656e 742e 7363  :meth:`Client.sc
-000096b0: 6174 7465 7260 292e 2020 4120 2270 7572  atter`).  A "pur
-000096c0: 6520 6461 7461 2220 7461 736b 2063 616e  e data" task can
-000096d0: 6e6f 7420 6265 2063 6f6d 7075 7465 6420  not be computed 
-000096e0: 6167 6169 6e20 6966 2069 7473 0a20 2020  again if its.   
-000096f0: 2023 3a20 7661 6c75 6520 6973 206c 6f73   #: value is los
-00009700: 742e 0a20 2020 2072 756e 5f73 7065 633a  t..    run_spec:
-00009710: 206f 626a 6563 740a 0a20 2020 2023 3a20   object..    #: 
-00009720: 5468 6520 7072 696f 7269 7479 2070 726f  The priority pro
-00009730: 7669 6465 7320 6561 6368 2074 6173 6b20  vides each task 
-00009740: 7769 7468 2061 2072 656c 6174 6976 6520  with a relative 
-00009750: 7261 6e6b 696e 6720 7768 6963 6820 6973  ranking which is
-00009760: 2075 7365 6420 746f 2062 7265 616b 0a20   used to break. 
-00009770: 2020 2023 3a20 7469 6573 2077 6865 6e20     #: ties when 
-00009780: 6d61 6e79 2074 6173 6b73 2061 7265 2062  many tasks are b
-00009790: 6569 6e67 2063 6f6e 7369 6465 7265 6420  eing considered 
-000097a0: 666f 7220 6578 6563 7574 696f 6e2e 0a20  for execution.. 
-000097b0: 2020 2023 3a0a 2020 2020 233a 2054 6869     #:.    #: Thi
-000097c0: 7320 7261 6e6b 696e 6720 6973 2067 656e  s ranking is gen
-000097d0: 6572 616c 6c79 2061 2032 2d69 7465 6d20  erally a 2-item 
-000097e0: 7475 706c 652e 2020 5468 6520 6669 7273  tuple.  The firs
-000097f0: 7420 2861 6e64 2064 6f6d 696e 616e 7429  t (and dominant)
-00009800: 2069 7465 6d0a 2020 2020 233a 2063 6f72   item.    #: cor
-00009810: 7265 7370 6f6e 6473 2074 6f20 7768 656e  responds to when
-00009820: 2069 7420 7761 7320 7375 626d 6974 7465   it was submitte
-00009830: 642e 2020 4765 6e65 7261 6c6c 792c 2065  d.  Generally, e
-00009840: 6172 6c69 6572 2074 6173 6b73 2074 616b  arlier tasks tak
-00009850: 6520 7072 6563 6564 656e 6365 2e0a 2020  e precedence..  
-00009860: 2020 233a 2054 6865 2073 6563 6f6e 6420    #: The second 
-00009870: 6974 656d 2069 7320 6465 7465 726d 696e  item is determin
-00009880: 6564 2062 7920 7468 6520 636c 6965 6e74  ed by the client
-00009890: 2c20 616e 6420 6973 2061 2077 6179 2074  , and is a way t
-000098a0: 6f20 7072 696f 7269 7469 7a65 2074 6173  o prioritize tas
-000098b0: 6b73 0a20 2020 2023 3a20 7769 7468 696e  ks.    #: within
-000098c0: 2061 206c 6172 6765 2067 7261 7068 2074   a large graph t
-000098d0: 6861 7420 6d61 7920 6265 2069 6d70 6f72  hat may be impor
-000098e0: 7461 6e74 2c20 7375 6368 2061 7320 6966  tant, such as if
-000098f0: 2074 6865 7920 6172 6520 6f6e 2074 6865   they are on the
-00009900: 2063 7269 7469 6361 6c0a 2020 2020 233a   critical.    #:
-00009910: 2070 6174 682c 206f 7220 676f 6f64 2074   path, or good t
-00009920: 6f20 7275 6e20 696e 206f 7264 6572 2074  o run in order t
-00009930: 6f20 7265 6c65 6173 6520 6d61 6e79 2064  o release many d
-00009940: 6570 656e 6465 6e63 6965 732e 2020 5468  ependencies.  Th
-00009950: 6973 2069 7320 6578 706c 6169 6e65 640a  is is explained.
-00009960: 2020 2020 233a 2066 7572 7468 6572 2069      #: further i
-00009970: 6e20 3a64 6f63 3a60 5363 6865 6475 6c69  n :doc:`Scheduli
-00009980: 6e67 2050 6f6c 6963 7920 3c73 6368 6564  ng Policy <sched
-00009990: 756c 696e 672d 706f 6c69 6369 6573 3e60  uling-policies>`
-000099a0: 2e0a 2020 2020 7072 696f 7269 7479 3a20  ..    priority: 
-000099b0: 7475 706c 655b 666c 6f61 742c 202e 2e2e  tuple[float, ...
-000099c0: 5d20 7c20 4e6f 6e65 0a0a 2020 2020 2320  ] | None..    # 
-000099d0: 4174 7472 6962 7574 6520 756e 6465 726c  Attribute underl
-000099e0: 7969 6e67 2074 6865 2073 7461 7465 2070  ying the state p
-000099f0: 726f 7065 7274 790a 2020 2020 5f73 7461  roperty.    _sta
-00009a00: 7465 3a20 5461 736b 5374 6174 6553 7461  te: TaskStateSta
-00009a10: 7465 0a0a 2020 2020 233a 2054 6865 2073  te..    #: The s
-00009a20: 6574 206f 6620 7461 736b 7320 7468 6973  et of tasks this
-00009a30: 2074 6173 6b20 6465 7065 6e64 7320 6f6e   task depends on
-00009a40: 2066 6f72 2070 726f 7065 7220 6578 6563   for proper exec
-00009a50: 7574 696f 6e2e 204f 6e6c 7920 7461 736b  ution. Only task
-00009a60: 7320 7374 696c 6c0a 2020 2020 233a 2061  s still.    #: a
-00009a70: 6c69 7665 2061 7265 206c 6973 7465 6420  live are listed 
-00009a80: 696e 2074 6869 7320 7365 742e 2049 662c  in this set. If,
-00009a90: 2066 6f72 2077 6861 7465 7665 7220 7265   for whatever re
-00009aa0: 6173 6f6e 2c20 7468 6973 2074 6173 6b20  ason, this task 
-00009ab0: 616c 736f 2064 6570 656e 6473 206f 6e0a  also depends on.
-00009ac0: 2020 2020 233a 2061 2066 6f72 676f 7474      #: a forgott
-00009ad0: 656e 2074 6173 6b2c 2074 6865 203a 6174  en task, the :at
-00009ae0: 7472 3a60 6861 735f 6c6f 7374 5f64 6570  tr:`has_lost_dep
-00009af0: 656e 6465 6e63 6965 7360 2066 6c61 6720  endencies` flag 
-00009b00: 6973 2073 6574 2e0a 2020 2020 233a 0a20  is set..    #:. 
-00009b10: 2020 2023 3a20 4120 7461 736b 2063 616e     #: A task can
-00009b20: 206f 6e6c 7920 6265 2065 7865 6375 7465   only be execute
-00009b30: 6420 6f6e 6365 2061 6c6c 2069 7473 2064  d once all its d
-00009b40: 6570 656e 6465 6e63 6965 7320 6861 7665  ependencies have
-00009b50: 2061 6c72 6561 6479 2062 6565 6e0a 2020   already been.  
-00009b60: 2020 233a 2073 7563 6365 7373 6675 6c6c    #: successfull
-00009b70: 7920 6578 6563 7574 6564 2061 6e64 2068  y executed and h
-00009b80: 6176 6520 7468 6569 7220 7265 7375 6c74  ave their result
-00009b90: 2073 746f 7265 6420 6f6e 2061 7420 6c65   stored on at le
-00009ba0: 6173 7420 6f6e 6520 776f 726b 6572 2e20  ast one worker. 
-00009bb0: 5468 6973 0a20 2020 2023 3a20 6973 2074  This.    #: is t
-00009bc0: 7261 636b 6564 2062 7920 7072 6f67 7265  racked by progre
-00009bd0: 7373 6976 656c 7920 6472 6169 6e69 6e67  ssively draining
-00009be0: 2074 6865 203a 6174 7472 3a60 7761 6974   the :attr:`wait
-00009bf0: 696e 675f 6f6e 6020 7365 742e 0a20 2020  ing_on` set..   
-00009c00: 2064 6570 656e 6465 6e63 6965 733a 2073   dependencies: s
-00009c10: 6574 5b54 6173 6b53 7461 7465 5d0a 0a20  et[TaskState].. 
-00009c20: 2020 2023 3a20 5468 6520 7365 7420 6f66     #: The set of
-00009c30: 2074 6173 6b73 2077 6869 6368 2064 6570   tasks which dep
-00009c40: 656e 6420 6f6e 2074 6869 7320 7461 736b  end on this task
-00009c50: 2e20 204f 6e6c 7920 7461 736b 7320 7374  .  Only tasks st
-00009c60: 696c 6c20 616c 6976 6520 6172 6520 6c69  ill alive are li
-00009c70: 7374 6564 2069 6e0a 2020 2020 233a 2074  sted in.    #: t
-00009c80: 6869 7320 7365 742e 2054 6869 7320 6973  his set. This is
-00009c90: 2074 6865 2072 6576 6572 7365 206d 6170   the reverse map
-00009ca0: 7069 6e67 206f 6620 3a61 7474 723a 6064  ping of :attr:`d
-00009cb0: 6570 656e 6465 6e63 6965 7360 2e0a 2020  ependencies`..  
-00009cc0: 2020 6465 7065 6e64 656e 7473 3a20 7365    dependents: se
-00009cd0: 745b 5461 736b 5374 6174 655d 0a0a 2020  t[TaskState]..  
-00009ce0: 2020 233a 2057 6865 7468 6572 2061 6e79    #: Whether any
-00009cf0: 206f 6620 7468 6520 6465 7065 6e64 656e   of the dependen
-00009d00: 6369 6573 206f 6620 7468 6973 2074 6173  cies of this tas
-00009d10: 6b20 6861 7320 6265 656e 2066 6f72 676f  k has been forgo
-00009d20: 7474 656e 2e20 466f 7220 6d65 6d6f 7279  tten. For memory
-00009d30: 0a20 2020 2023 3a20 636f 6e73 756d 7074  .    #: consumpt
-00009d40: 696f 6e20 7265 6173 6f6e 732c 2066 6f72  ion reasons, for
-00009d50: 676f 7474 656e 2074 6173 6b73 2061 7265  gotten tasks are
-00009d60: 206e 6f74 206b 6570 7420 696e 206d 656d   not kept in mem
-00009d70: 6f72 7920 6576 656e 2074 686f 7567 6820  ory even though 
-00009d80: 7468 6579 206d 6179 0a20 2020 2023 3a20  they may.    #: 
-00009d90: 6861 7665 2064 6570 656e 6465 6e74 2074  have dependent t
-00009da0: 6173 6b73 2e20 2057 6865 6e20 6120 7461  asks.  When a ta
-00009db0: 736b 2069 7320 666f 7267 6f74 7465 6e2c  sk is forgotten,
-00009dc0: 2074 6865 7265 666f 7265 2c20 6561 6368   therefore, each
-00009dd0: 206f 6620 6974 730a 2020 2020 233a 2064   of its.    #: d
-00009de0: 6570 656e 6465 6e74 7320 6861 7320 7468  ependents has th
-00009df0: 6569 7220 3a61 7474 723a 6068 6173 5f6c  eir :attr:`has_l
-00009e00: 6f73 745f 6465 7065 6e64 656e 6369 6573  ost_dependencies
-00009e10: 6020 6174 7472 6962 7574 6520 7365 7420  ` attribute set 
-00009e20: 746f 2060 6054 7275 6560 602e 0a20 2020  to ``True``..   
-00009e30: 2023 3a0a 2020 2020 233a 2049 6620 3a61   #:.    #: If :a
-00009e40: 7474 723a 6068 6173 5f6c 6f73 745f 6465  ttr:`has_lost_de
-00009e50: 7065 6e64 656e 6369 6573 6020 6973 2074  pendencies` is t
-00009e60: 7275 652c 2074 6869 7320 7461 736b 2063  rue, this task c
-00009e70: 616e 6e6f 7420 676f 2069 6e74 6f20 7468  annot go into th
-00009e80: 650a 2020 2020 233a 2022 7072 6f63 6573  e.    #: "proces
-00009e90: 7369 6e67 2220 7374 6174 6520 616e 796d  sing" state anym
-00009ea0: 6f72 652e 0a20 2020 2068 6173 5f6c 6f73  ore..    has_los
-00009eb0: 745f 6465 7065 6e64 656e 6369 6573 3a20  t_dependencies: 
-00009ec0: 626f 6f6c 0a0a 2020 2020 233a 2054 6865  bool..    #: The
-00009ed0: 2073 6574 206f 6620 7461 736b 7320 7468   set of tasks th
-00009ee0: 6973 2074 6173 6b20 6973 2077 6169 7469  is task is waiti
-00009ef0: 6e67 206f 6e20 2a62 6566 6f72 652a 2069  ng on *before* i
-00009f00: 7420 6361 6e20 6265 2065 7865 6375 7465  t can be execute
-00009f10: 642e 2054 6869 7320 6973 0a20 2020 2023  d. This is.    #
-00009f20: 3a20 616c 7761 7973 2061 2073 7562 7365  : always a subse
-00009f30: 7420 6f66 203a 6174 7472 3a60 6465 7065  t of :attr:`depe
-00009f40: 6e64 656e 6369 6573 602e 2020 4561 6368  ndencies`.  Each
-00009f50: 2074 696d 6520 6f6e 6520 6f66 2074 6865   time one of the
-00009f60: 2064 6570 656e 6465 6e63 6965 7320 6861   dependencies ha
-00009f70: 730a 2020 2020 233a 2066 696e 6973 6865  s.    #: finishe
-00009f80: 6420 7072 6f63 6573 7369 6e67 2c20 6974  d processing, it
-00009f90: 2069 7320 7265 6d6f 7665 6420 6672 6f6d   is removed from
-00009fa0: 2074 6865 203a 6174 7472 3a60 7761 6974   the :attr:`wait
-00009fb0: 696e 675f 6f6e 6020 7365 742e 0a20 2020  ing_on` set..   
-00009fc0: 2023 3a0a 2020 2020 233a 204f 6e63 6520   #:.    #: Once 
-00009fd0: 3a61 7474 723a 6077 6169 7469 6e67 5f6f  :attr:`waiting_o
-00009fe0: 6e60 2062 6563 6f6d 6573 2065 6d70 7479  n` becomes empty
-00009ff0: 2c20 7468 6973 2074 6173 6b20 6361 6e20  , this task can 
-0000a000: 6d6f 7665 2066 726f 6d20 7468 6520 2277  move from the "w
-0000a010: 6169 7469 6e67 220a 2020 2020 233a 2073  aiting".    #: s
-0000a020: 7461 7465 2074 6f20 7468 6520 2270 726f  tate to the "pro
-0000a030: 6365 7373 696e 6722 2073 7461 7465 2028  cessing" state (
-0000a040: 756e 6c65 7373 206f 6e65 206f 6620 7468  unless one of th
-0000a050: 6520 6465 7065 6e64 656e 6369 6573 2065  e dependencies e
-0000a060: 7272 6f72 6564 206f 7574 2c20 696e 0a20  rrored out, in. 
-0000a070: 2020 2023 3a20 7768 6963 6820 6361 7365     #: which case
-0000a080: 2074 6869 7320 7461 736b 2069 7320 696e   this task is in
-0000a090: 7374 6561 6420 6d61 726b 6564 2022 6572  stead marked "er
-0000a0a0: 7265 6422 292e 0a20 2020 2077 6169 7469  red")..    waiti
-0000a0b0: 6e67 5f6f 6e3a 2073 6574 5b54 6173 6b53  ng_on: set[TaskS
-0000a0c0: 7461 7465 5d0a 0a20 2020 2023 3a20 5468  tate]..    #: Th
-0000a0d0: 6520 7365 7420 6f66 2074 6173 6b73 2077  e set of tasks w
-0000a0e0: 6869 6368 206e 6565 6420 7468 6973 2074  hich need this t
-0000a0f0: 6173 6b20 746f 2072 656d 6169 6e20 616c  ask to remain al
-0000a100: 6976 652e 2020 5468 6973 2069 7320 616c  ive.  This is al
-0000a110: 7761 7973 2061 2073 7562 7365 740a 2020  ways a subset.  
-0000a120: 2020 233a 206f 6620 3a61 7474 723a 6064    #: of :attr:`d
-0000a130: 6570 656e 6465 6e74 7360 2e20 2045 6163  ependents`.  Eac
-0000a140: 6820 7469 6d65 206f 6e65 206f 6620 7468  h time one of th
-0000a150: 6520 6465 7065 6e64 656e 7473 2068 6173  e dependents has
-0000a160: 2066 696e 6973 6865 6420 7072 6f63 6573   finished proces
-0000a170: 7369 6e67 2c0a 2020 2020 233a 2069 7420  sing,.    #: it 
-0000a180: 6973 2072 656d 6f76 6564 2066 726f 6d20  is removed from 
-0000a190: 7468 6520 3a61 7474 723a 6077 6169 7465  the :attr:`waite
-0000a1a0: 7273 6020 7365 742e 0a20 2020 2023 3a0a  rs` set..    #:.
-0000a1b0: 2020 2020 233a 204f 6e63 6520 626f 7468      #: Once both
-0000a1c0: 203a 6174 7472 3a60 7761 6974 6572 7360   :attr:`waiters`
-0000a1d0: 2061 6e64 203a 6174 7472 3a60 7768 6f5f   and :attr:`who_
-0000a1e0: 7761 6e74 7360 2062 6563 6f6d 6520 656d  wants` become em
-0000a1f0: 7074 792c 2074 6869 7320 7461 736b 2063  pty, this task c
-0000a200: 616e 2062 650a 2020 2020 233a 2072 656c  an be.    #: rel
-0000a210: 6561 7365 6420 2869 6620 6974 2068 6173  eased (if it has
-0000a220: 2061 206e 6f6e 2d65 6d70 7479 203a 6174   a non-empty :at
-0000a230: 7472 3a60 7275 6e5f 7370 6563 6029 206f  tr:`run_spec`) o
-0000a240: 7220 666f 7267 6f74 7465 6e20 286f 7468  r forgotten (oth
-0000a250: 6572 7769 7365 2920 6279 2074 6865 0a20  erwise) by the. 
-0000a260: 2020 2023 3a20 7363 6865 6475 6c65 722c     #: scheduler,
-0000a270: 2061 6e64 2062 7920 616e 7920 776f 726b   and by any work
-0000a280: 6572 7320 696e 203a 6174 7472 3a60 7768  ers in :attr:`wh
-0000a290: 6f5f 6861 7360 2e0a 2020 2020 233a 0a20  o_has`..    #:. 
-0000a2a0: 2020 2023 3a20 2e2e 206e 6f74 653a 3a0a     #: .. note::.
-0000a2b0: 2020 2020 233a 2020 2020 436f 756e 7465      #:    Counte
-0000a2c0: 722d 696e 7475 6974 6976 656c 792c 203a  r-intuitively, :
-0000a2d0: 6174 7472 3a60 7761 6974 696e 675f 6f6e  attr:`waiting_on
-0000a2e0: 6020 616e 6420 3a61 7474 723a 6077 6169  ` and :attr:`wai
-0000a2f0: 7465 7273 6020 6172 6520 6e6f 7420 7265  ters` are not re
-0000a300: 7665 7273 650a 2020 2020 233a 2020 2020  verse.    #:    
-0000a310: 6d61 7070 696e 6773 206f 6620 6561 6368  mappings of each
-0000a320: 206f 7468 6572 2e0a 2020 2020 7761 6974   other..    wait
-0000a330: 6572 733a 2073 6574 5b54 6173 6b53 7461  ers: set[TaskSta
-0000a340: 7465 5d0a 0a20 2020 2023 3a20 5468 6520  te]..    #: The 
-0000a350: 7365 7420 6f66 2063 6c69 656e 7473 2077  set of clients w
-0000a360: 686f 2077 616e 7420 7468 6520 7265 7375  ho want the resu
-0000a370: 6c74 206f 6620 7468 6973 2074 6173 6b20  lt of this task 
-0000a380: 746f 2072 656d 6169 6e20 616c 6976 652e  to remain alive.
-0000a390: 0a20 2020 2023 3a20 5468 6973 2069 7320  .    #: This is 
-0000a3a0: 7468 6520 7265 7665 7273 6520 6d61 7070  the reverse mapp
-0000a3b0: 696e 6720 6f66 203a 6174 7472 3a60 436c  ing of :attr:`Cl
-0000a3c0: 6965 6e74 5374 6174 652e 7761 6e74 735f  ientState.wants_
-0000a3d0: 7768 6174 602e 0a20 2020 2023 3a0a 2020  what`..    #:.  
-0000a3e0: 2020 233a 2057 6865 6e20 6120 636c 6965    #: When a clie
-0000a3f0: 6e74 2073 7562 6d69 7473 2061 2067 7261  nt submits a gra
-0000a400: 7068 2074 6f20 7468 6520 7363 6865 6475  ph to the schedu
-0000a410: 6c65 7220 6974 2061 6c73 6f20 7370 6563  ler it also spec
-0000a420: 6966 6965 7320 7768 6963 6820 6f75 7470  ifies which outp
-0000a430: 7574 0a20 2020 2023 3a20 7461 736b 7320  ut.    #: tasks 
-0000a440: 6974 2064 6573 6972 6573 2c20 7375 6368  it desires, such
-0000a450: 2074 6861 7420 7468 6569 7220 7265 7375   that their resu
-0000a460: 6c74 7320 6172 6520 6e6f 7420 7265 6c65  lts are not rele
-0000a470: 6173 6564 2066 726f 6d20 6d65 6d6f 7279  ased from memory
-0000a480: 2e0a 2020 2020 233a 0a20 2020 2023 3a20  ..    #:.    #: 
-0000a490: 4f6e 6365 2061 2074 6173 6b20 6861 7320  Once a task has 
-0000a4a0: 6669 6e69 7368 6564 2065 7865 6375 7469  finished executi
-0000a4b0: 6e67 2028 692e 652e 206d 6f76 6573 2069  ng (i.e. moves i
-0000a4c0: 6e74 6f20 7468 6520 226d 656d 6f72 7922  nto the "memory"
-0000a4d0: 206f 7220 2265 7272 6564 220a 2020 2020   or "erred".    
-0000a4e0: 233a 2073 7461 7465 292c 2074 6865 2063  #: state), the c
-0000a4f0: 6c69 656e 7473 2069 6e20 3a61 7474 723a  lients in :attr:
-0000a500: 6077 686f 5f77 616e 7473 6020 6172 6520  `who_wants` are 
-0000a510: 6e6f 7469 6669 6564 2e0a 2020 2020 233a  notified..    #:
-0000a520: 0a20 2020 2023 3a20 4f6e 6365 2062 6f74  .    #: Once bot
-0000a530: 6820 3a61 7474 723a 6077 6169 7465 7273  h :attr:`waiters
-0000a540: 6020 616e 6420 3a61 7474 723a 6077 686f  ` and :attr:`who
-0000a550: 5f77 616e 7473 6020 6265 636f 6d65 2065  _wants` become e
-0000a560: 6d70 7479 2c20 7468 6973 2074 6173 6b20  mpty, this task 
-0000a570: 6361 6e20 6265 0a20 2020 2023 3a20 7265  can be.    #: re
-0000a580: 6c65 6173 6564 2028 6966 2069 7420 6861  leased (if it ha
-0000a590: 7320 6120 6e6f 6e2d 656d 7074 7920 3a61  s a non-empty :a
-0000a5a0: 7474 723a 6072 756e 5f73 7065 6360 2920  ttr:`run_spec`) 
-0000a5b0: 6f72 2066 6f72 676f 7474 656e 2028 6f74  or forgotten (ot
-0000a5c0: 6865 7277 6973 6529 2062 7920 7468 650a  herwise) by the.
-0000a5d0: 2020 2020 233a 2073 6368 6564 756c 6572      #: scheduler
-0000a5e0: 2c20 616e 6420 6279 2061 6e79 2077 6f72  , and by any wor
-0000a5f0: 6b65 7273 2069 6e20 3a61 7474 723a 6077  kers in :attr:`w
-0000a600: 686f 5f68 6173 602e 0a20 2020 2077 686f  ho_has`..    who
-0000a610: 5f77 616e 7473 3a20 7365 745b 436c 6965  _wants: set[Clie
-0000a620: 6e74 5374 6174 655d 0a0a 2020 2020 233a  ntState]..    #:
-0000a630: 2054 6865 2073 6574 206f 6620 776f 726b   The set of work
-0000a640: 6572 7320 7768 6f20 6861 7665 2074 6869  ers who have thi
-0000a650: 7320 7461 736b 2773 2072 6573 756c 7420  s task's result 
-0000a660: 696e 206d 656d 6f72 792e 2049 7420 6973  in memory. It is
-0000a670: 206e 6f6e 2d65 6d70 7479 2069 6666 2074   non-empty iff t
-0000a680: 6865 0a20 2020 2023 3a20 7461 736b 2069  he.    #: task i
-0000a690: 7320 696e 2074 6865 2022 6d65 6d6f 7279  s in the "memory
-0000a6a0: 2220 7374 6174 652e 2020 5468 6572 6520  " state.  There 
-0000a6b0: 6361 6e20 6265 206d 6f72 6520 7468 616e  can be more than
-0000a6c0: 206f 6e65 2077 6f72 6b65 7220 696e 2074   one worker in t
-0000a6d0: 6869 7320 7365 7420 6966 2c0a 2020 2020  his set if,.    
-0000a6e0: 233a 2066 6f72 2065 7861 6d70 6c65 2c20  #: for example, 
-0000a6f0: 3a6d 6574 683a 6043 6c69 656e 742e 7363  :meth:`Client.sc
-0000a700: 6174 7465 7260 206f 7220 3a6d 6574 683a  atter` or :meth:
-0000a710: 6043 6c69 656e 742e 7265 706c 6963 6174  `Client.replicat
-0000a720: 6560 2077 6173 2075 7365 642e 0a20 2020  e` was used..   
-0000a730: 2023 3a0a 2020 2020 233a 2054 6869 7320   #:.    #: This 
-0000a740: 6973 2074 6865 2072 6576 6572 7365 206d  is the reverse m
-0000a750: 6170 7069 6e67 206f 6620 3a61 7474 723a  apping of :attr:
-0000a760: 6057 6f72 6b65 7253 7461 7465 2e68 6173  `WorkerState.has
-0000a770: 5f77 6861 7460 2e0a 2020 2020 7768 6f5f  _what`..    who_
-0000a780: 6861 733a 2073 6574 5b57 6f72 6b65 7253  has: set[WorkerS
-0000a790: 7461 7465 5d0a 0a20 2020 2023 3a20 4966  tate]..    #: If
-0000a7a0: 2074 6869 7320 7461 736b 2069 7320 696e   this task is in
-0000a7b0: 2074 6865 2022 7072 6f63 6573 7369 6e67   the "processing
-0000a7c0: 2220 7374 6174 652c 2077 6869 6368 2077  " state, which w
-0000a7d0: 6f72 6b65 7220 6973 2063 7572 7265 6e74  orker is current
-0000a7e0: 6c79 2070 726f 6365 7373 696e 670a 2020  ly processing.  
-0000a7f0: 2020 233a 2069 742e 2054 6869 7320 6174    #: it. This at
-0000a800: 7472 6962 7574 6520 6973 206b 6570 7420  tribute is kept 
-0000a810: 696e 2073 796e 6320 7769 7468 203a 6174  in sync with :at
-0000a820: 7472 3a60 576f 726b 6572 5374 6174 652e  tr:`WorkerState.
-0000a830: 7072 6f63 6573 7369 6e67 602e 0a20 2020  processing`..   
-0000a840: 2070 726f 6365 7373 696e 675f 6f6e 3a20   processing_on: 
-0000a850: 576f 726b 6572 5374 6174 6520 7c20 4e6f  WorkerState | No
-0000a860: 6e65 0a0a 2020 2020 233a 2054 6865 206e  ne..    #: The n
-0000a870: 756d 6265 7220 6f66 2074 696d 6573 2074  umber of times t
-0000a880: 6869 7320 7461 736b 2063 616e 2061 7574  his task can aut
-0000a890: 6f6d 6174 6963 616c 6c79 2062 6520 7265  omatically be re
-0000a8a0: 7472 6965 6420 696e 2063 6173 6520 6f66  tried in case of
-0000a8b0: 2066 6169 6c75 7265 2e0a 2020 2020 233a   failure..    #:
-0000a8c0: 2049 6620 6120 7461 736b 2066 6169 6c73   If a task fails
-0000a8d0: 2065 7865 6375 7469 6e67 2028 7468 6520   executing (the 
-0000a8e0: 776f 726b 6572 2072 6574 7572 6e73 2077  worker returns w
-0000a8f0: 6974 6820 616e 2065 7272 6f72 292c 2069  ith an error), i
-0000a900: 7473 203a 6174 7472 3a60 7265 7472 6965  ts :attr:`retrie
-0000a910: 7360 0a20 2020 2023 3a20 6174 7472 6962  s`.    #: attrib
-0000a920: 7574 6520 6973 2063 6865 636b 6564 2e20  ute is checked. 
-0000a930: 4966 2069 7420 6973 2065 7175 616c 2074  If it is equal t
-0000a940: 6f20 302c 2074 6865 2074 6173 6b20 6973  o 0, the task is
-0000a950: 206d 6172 6b65 6420 2265 7272 6564 222e   marked "erred".
-0000a960: 2049 6620 6974 2069 730a 2020 2020 233a   If it is.    #:
-0000a970: 2067 7265 6174 6572 2074 6861 6e20 302c   greater than 0,
-0000a980: 2074 6865 203a 6174 7472 3a60 7265 7472   the :attr:`retr
-0000a990: 6965 7360 2061 7474 7269 6275 7465 2069  ies` attribute i
-0000a9a0: 7320 6465 6372 656d 656e 7465 6420 616e  s decremented an
-0000a9b0: 6420 6578 6563 7574 696f 6e20 6973 0a20  d execution is. 
-0000a9c0: 2020 2023 3a20 6174 7465 6d70 7465 6420     #: attempted 
-0000a9d0: 6167 6169 6e2e 0a20 2020 2072 6574 7269  again..    retri
-0000a9e0: 6573 3a20 696e 740a 0a20 2020 2023 3a20  es: int..    #: 
-0000a9f0: 5468 6520 6e75 6d62 6572 206f 6620 6279  The number of by
-0000aa00: 7465 732c 2061 7320 6465 7465 726d 696e  tes, as determin
-0000aa10: 6564 2062 7920 6060 7369 7a65 6f66 6060  ed by ``sizeof``
-0000aa20: 2c20 6f66 2074 6865 2072 6573 756c 7420  , of the result 
-0000aa30: 6f66 2061 2066 696e 6973 6865 640a 2020  of a finished.  
-0000aa40: 2020 233a 2074 6173 6b2e 2054 6869 7320    #: task. This 
-0000aa50: 6e75 6d62 6572 2069 7320 7573 6564 2066  number is used f
-0000aa60: 6f72 2064 6961 676e 6f73 7469 6373 2061  or diagnostics a
-0000aa70: 6e64 2074 6f20 6865 6c70 2070 7269 6f72  nd to help prior
-0000aa80: 6974 697a 6520 776f 726b 2e0a 2020 2020  itize work..    
-0000aa90: 233a 2053 6574 2074 6f20 2d31 2066 6f72  #: Set to -1 for
-0000aaa0: 2075 6e66 696e 6973 6865 6420 7461 736b   unfinished task
-0000aab0: 732e 0a20 2020 206e 6279 7465 733a 2069  s..    nbytes: i
-0000aac0: 6e74 0a0a 2020 2020 233a 2054 6865 2074  nt..    #: The t
-0000aad0: 7970 6520 6f66 2074 6865 206f 626a 6563  ype of the objec
-0000aae0: 7420 6173 2061 2073 7472 696e 672e 204f  t as a string. O
-0000aaf0: 6e6c 7920 7072 6573 656e 7420 666f 7220  nly present for 
-0000ab00: 7461 736b 7320 7468 6174 2068 6176 6520  tasks that have 
-0000ab10: 6265 656e 0a20 2020 2023 3a20 636f 6d70  been.    #: comp
-0000ab20: 7574 6564 2e0a 2020 2020 7479 7065 3a20  uted..    type: 
-0000ab30: 7374 720a 0a20 2020 2023 3a20 4966 2074  str..    #: If t
-0000ab40: 6869 7320 7461 736b 2066 6169 6c65 6420  his task failed 
-0000ab50: 6578 6563 7574 696e 672c 2074 6865 2065  executing, the e
-0000ab60: 7863 6570 7469 6f6e 206f 626a 6563 7420  xception object 
-0000ab70: 6973 2073 746f 7265 6420 6865 7265 2e0a  is stored here..
-0000ab80: 2020 2020 6578 6365 7074 696f 6e3a 2053      exception: S
-0000ab90: 6572 6961 6c69 7a65 6420 7c20 4e6f 6e65  erialized | None
-0000aba0: 0a0a 2020 2020 233a 2049 6620 7468 6973  ..    #: If this
-0000abb0: 2074 6173 6b20 6661 696c 6564 2065 7865   task failed exe
-0000abc0: 6375 7469 6e67 2c20 7468 6520 7472 6163  cuting, the trac
-0000abd0: 6562 6163 6b20 6f62 6a65 6374 2069 7320  eback object is 
-0000abe0: 7374 6f72 6564 2068 6572 652e 0a20 2020  stored here..   
-0000abf0: 2074 7261 6365 6261 636b 3a20 5365 7269   traceback: Seri
-0000ac00: 616c 697a 6564 207c 204e 6f6e 650a 0a20  alized | None.. 
-0000ac10: 2020 2023 3a20 7374 7269 6e67 2072 6570     #: string rep
-0000ac20: 7265 7365 6e74 6174 696f 6e20 6f66 2065  resentation of e
-0000ac30: 7863 6570 7469 6f6e 0a20 2020 2065 7863  xception.    exc
-0000ac40: 6570 7469 6f6e 5f74 6578 743a 2073 7472  eption_text: str
-0000ac50: 0a0a 2020 2020 233a 2073 7472 696e 6720  ..    #: string 
-0000ac60: 7265 7072 6573 656e 7461 7469 6f6e 206f  representation o
-0000ac70: 6620 7472 6163 6562 6163 6b0a 2020 2020  f traceback.    
-0000ac80: 7472 6163 6562 6163 6b5f 7465 7874 3a20  traceback_text: 
-0000ac90: 7374 720a 0a20 2020 2023 3a20 4966 2074  str..    #: If t
-0000aca0: 6869 7320 7461 736b 206f 7220 6f6e 6520  his task or one 
-0000acb0: 6f66 2069 7473 2064 6570 656e 6465 6e63  of its dependenc
-0000acc0: 6965 7320 6661 696c 6564 2065 7865 6375  ies failed execu
-0000acd0: 7469 6e67 2c20 7468 6520 6661 696c 6564  ting, the failed
-0000ace0: 2074 6173 6b20 6973 0a20 2020 2023 3a20   task is.    #: 
-0000acf0: 7374 6f72 6564 2068 6572 6520 2870 6f73  stored here (pos
-0000ad00: 7369 626c 7920 6974 7365 6c66 292e 0a20  sibly itself).. 
-0000ad10: 2020 2065 7863 6570 7469 6f6e 5f62 6c61     exception_bla
-0000ad20: 6d65 3a20 5461 736b 5374 6174 6520 7c20  me: TaskState | 
-0000ad30: 4e6f 6e65 0a0a 2020 2020 233a 2057 6f72  None..    #: Wor
-0000ad40: 6b65 7220 6164 6472 6573 7365 7320 6f6e  ker addresses on
-0000ad50: 2077 6869 6368 2065 7272 6f72 7320 6170   which errors ap
-0000ad60: 7065 6172 6564 2c20 6361 7573 696e 6720  peared, causing 
-0000ad70: 7468 6973 2074 6173 6b20 746f 2062 6520  this task to be 
-0000ad80: 696e 2061 6e20 6572 726f 720a 2020 2020  in an error.    
-0000ad90: 233a 2073 7461 7465 2e0a 2020 2020 6572  #: state..    er
-0000ada0: 7265 645f 6f6e 3a20 7365 745b 7374 725d  red_on: set[str]
-0000adb0: 0a0a 2020 2020 233a 2054 6865 206e 756d  ..    #: The num
-0000adc0: 6265 7220 6f66 2074 696d 6573 2074 6869  ber of times thi
-0000add0: 7320 7461 736b 2068 6173 2062 6565 6e20  s task has been 
-0000ade0: 696e 766f 6c76 6564 2069 6e20 6120 776f  involved in a wo
-0000adf0: 726b 6572 2064 6561 7468 2e0a 2020 2020  rker death..    
-0000ae00: 233a 0a20 2020 2023 3a20 536f 6d65 2074  #:.    #: Some t
-0000ae10: 6173 6b73 206d 6179 2063 6175 7365 2077  asks may cause w
-0000ae20: 6f72 6b65 7273 2074 6f20 6469 6520 2873  orkers to die (s
-0000ae30: 7563 6820 6173 2063 616c 6c69 6e67 2060  uch as calling `
-0000ae40: 606f 732e 5f65 7869 7428 3029 6060 292e  `os._exit(0)``).
-0000ae50: 2057 6865 6e20 610a 2020 2020 233a 2077   When a.    #: w
-0000ae60: 6f72 6b65 7220 6469 6573 2c20 616c 6c20  orker dies, all 
-0000ae70: 6f66 2074 6865 2074 6173 6b73 206f 6e20  of the tasks on 
-0000ae80: 7468 6174 2077 6f72 6b65 7220 6172 6520  that worker are 
-0000ae90: 7265 6173 7369 676e 6564 2074 6f20 6f74  reassigned to ot
-0000aea0: 6865 7273 2e20 5468 6973 0a20 2020 2023  hers. This.    #
-0000aeb0: 3a20 636f 6d62 696e 6174 696f 6e20 6f66  : combination of
-0000aec0: 2062 6568 6176 696f 7273 2063 616e 2063   behaviors can c
-0000aed0: 6175 7365 2061 2062 6164 2074 6173 6b20  ause a bad task 
-0000aee0: 746f 2063 6174 6173 7472 6f70 6869 6361  to catastrophica
-0000aef0: 6c6c 7920 6465 7374 726f 7920 616c 6c0a  lly destroy all.
-0000af00: 2020 2020 233a 2077 6f72 6b65 7273 206f      #: workers o
-0000af10: 6e20 7468 6520 636c 7573 7465 722c 206f  n the cluster, o
-0000af20: 6e65 2061 6674 6572 2061 6e6f 7468 6572  ne after another
-0000af30: 2e20 5768 656e 6576 6572 2061 2077 6f72  . Whenever a wor
-0000af40: 6b65 7220 6469 6573 2c20 7765 206d 6172  ker dies, we mar
-0000af50: 6b20 6561 6368 0a20 2020 2023 3a20 7461  k each.    #: ta
-0000af60: 736b 2063 7572 7265 6e74 6c79 2070 726f  sk currently pro
-0000af70: 6365 7373 696e 6720 6f6e 2074 6861 7420  cessing on that 
-0000af80: 776f 726b 6572 2028 6173 2072 6563 6f72  worker (as recor
-0000af90: 6465 6420 6279 0a20 2020 2023 3a20 3a61  ded by.    #: :a
-0000afa0: 7474 723a 6057 6f72 6b65 7253 7461 7465  ttr:`WorkerState
-0000afb0: 2e70 726f 6365 7373 696e 6760 2920 6173  .processing`) as
-0000afc0: 2073 7573 7069 6369 6f75 732e 2049 6620   suspicious. If 
-0000afd0: 6120 7461 736b 2069 7320 696e 766f 6c76  a task is involv
-0000afe0: 6564 2069 6e20 7468 7265 650a 2020 2020  ed in three.    
-0000aff0: 233a 2064 6561 7468 7320 286f 7220 736f  #: deaths (or so
-0000b000: 6d65 206f 7468 6572 2066 6978 6564 2063  me other fixed c
-0000b010: 6f6e 7374 616e 7429 2074 6865 6e20 7765  onstant) then we
-0000b020: 206d 6172 6b20 7468 6520 7461 736b 2061   mark the task a
-0000b030: 7320 6060 6572 7265 6460 602e 0a20 2020  s ``erred``..   
-0000b040: 2073 7573 7069 6369 6f75 733a 2069 6e74   suspicious: int
-0000b050: 0a0a 2020 2020 233a 2041 2073 6574 206f  ..    #: A set o
-0000b060: 6620 686f 7374 6e61 6d65 7320 7768 6572  f hostnames wher
-0000b070: 6520 7468 6973 2074 6173 6b20 6361 6e20  e this task can 
-0000b080: 6265 2072 756e 2028 6f72 2060 604e 6f6e  be run (or ``Non
-0000b090: 6560 6020 6966 2065 6d70 7479 292e 2055  e`` if empty). U
-0000b0a0: 7375 616c 6c79 0a20 2020 2023 3a20 7468  sually.    #: th
-0000b0b0: 6973 2069 7320 656d 7074 7920 756e 6c65  is is empty unle
-0000b0c0: 7373 2074 6865 2074 6173 6b20 6861 7320  ss the task has 
-0000b0d0: 6265 656e 2073 7065 6369 6669 6361 6c6c  been specificall
-0000b0e0: 7920 7265 7374 7269 6374 6564 2074 6f20  y restricted to 
-0000b0f0: 6f6e 6c79 2072 756e 206f 6e0a 2020 2020  only run on.    
-0000b100: 233a 2063 6572 7461 696e 2068 6f73 7473  #: certain hosts
-0000b110: 2e20 4120 686f 7374 6e61 6d65 206d 6179  . A hostname may
-0000b120: 2063 6f72 7265 7370 6f6e 6420 746f 206f   correspond to o
-0000b130: 6e65 206f 7220 7365 7665 7261 6c20 636f  ne or several co
-0000b140: 6e6e 6563 7465 6420 776f 726b 6572 732e  nnected workers.
-0000b150: 0a20 2020 2068 6f73 745f 7265 7374 7269  .    host_restri
-0000b160: 6374 696f 6e73 3a20 7365 745b 7374 725d  ctions: set[str]
-0000b170: 0a0a 2020 2020 233a 2041 2073 6574 206f  ..    #: A set o
-0000b180: 6620 636f 6d70 6c65 7465 2077 6f72 6b65  f complete worke
-0000b190: 7220 6164 6472 6573 7365 7320 7768 6572  r addresses wher
-0000b1a0: 6520 7468 6973 2063 616e 2062 6520 7275  e this can be ru
-0000b1b0: 6e20 286f 7220 6060 4e6f 6e65 6060 2069  n (or ``None`` i
-0000b1c0: 6620 656d 7074 7929 2e0a 2020 2020 233a  f empty)..    #:
-0000b1d0: 2055 7375 616c 6c79 2074 6869 7320 6973   Usually this is
-0000b1e0: 2065 6d70 7479 2075 6e6c 6573 7320 7468   empty unless th
-0000b1f0: 6520 7461 736b 2068 6173 2062 6565 6e20  e task has been 
-0000b200: 7370 6563 6966 6963 616c 6c79 2072 6573  specifically res
-0000b210: 7472 6963 7465 6420 746f 206f 6e6c 790a  tricted to only.
-0000b220: 2020 2020 233a 2072 756e 206f 6e20 6365      #: run on ce
-0000b230: 7274 6169 6e20 776f 726b 6572 732e 0a20  rtain workers.. 
-0000b240: 2020 2023 3a20 4e6f 7465 2074 6869 7320     #: Note this 
-0000b250: 6973 2074 7261 636b 696e 6720 776f 726b  is tracking work
-0000b260: 6572 2061 6464 7265 7373 6573 2c20 6e6f  er addresses, no
-0000b270: 7420 776f 726b 6572 2073 7461 7465 732c  t worker states,
-0000b280: 2073 696e 6365 2074 6865 2073 7065 6369   since the speci
-0000b290: 6669 630a 2020 2020 233a 2077 6f72 6b65  fic.    #: worke
-0000b2a0: 7273 206d 6179 206e 6f74 2062 6520 636f  rs may not be co
-0000b2b0: 6e6e 6563 7465 6420 6174 2074 6869 7320  nnected at this 
-0000b2c0: 7469 6d65 2e0a 2020 2020 776f 726b 6572  time..    worker
-0000b2d0: 5f72 6573 7472 6963 7469 6f6e 733a 2073  _restrictions: s
-0000b2e0: 6574 5b73 7472 5d0a 0a20 2020 2023 3a20  et[str]..    #: 
-0000b2f0: 5265 736f 7572 6365 7320 7265 7175 6972  Resources requir
-0000b300: 6564 2062 7920 7468 6973 2074 6173 6b2c  ed by this task,
-0000b310: 2073 7563 6820 6173 2060 607b 2767 7075   such as ``{'gpu
-0000b320: 273a 2031 7d60 6020 6f72 2060 607b 276d  ': 1}`` or ``{'m
-0000b330: 656d 6f72 7927 3a20 3165 397d 6060 0a20  emory': 1e9}``. 
-0000b340: 2020 2023 3a20 5468 6573 6520 6172 6520     #: These are 
-0000b350: 7573 6572 2d64 6566 696e 6564 206e 616d  user-defined nam
-0000b360: 6573 2061 6e64 2061 7265 206d 6174 6368  es and are match
-0000b370: 6564 2061 6761 696e 7374 2074 6865 203a  ed against the :
-0000b380: 2063 6f6e 7465 6e74 7320 6f66 2065 6163   contents of eac
-0000b390: 680a 2020 2020 233a 203a 6174 7472 3a60  h.    #: :attr:`
-0000b3a0: 576f 726b 6572 5374 6174 652e 7265 736f  WorkerState.reso
-0000b3b0: 7572 6365 7360 2064 6963 7469 6f6e 6172  urces` dictionar
-0000b3c0: 792e 0a20 2020 2072 6573 6f75 7263 655f  y..    resource_
-0000b3d0: 7265 7374 7269 6374 696f 6e73 3a20 6469  restrictions: di
-0000b3e0: 6374 5b73 7472 2c20 666c 6f61 745d 0a0a  ct[str, float]..
-0000b3f0: 2020 2020 233a 2046 616c 7365 0a20 2020      #: False.   
-0000b400: 2023 3a20 2020 2020 4561 6368 206f 6620   #:     Each of 
-0000b410: 3a61 7474 723a 6068 6f73 745f 7265 7374  :attr:`host_rest
-0000b420: 7269 6374 696f 6e73 602c 203a 6174 7472  rictions`, :attr
-0000b430: 3a60 776f 726b 6572 5f72 6573 7472 6963  :`worker_restric
-0000b440: 7469 6f6e 7360 2061 6e64 0a20 2020 2023  tions` and.    #
-0000b450: 3a20 2020 2020 3a61 7474 723a 6072 6573  :     :attr:`res
-0000b460: 6f75 7263 655f 7265 7374 7269 6374 696f  ource_restrictio
-0000b470: 6e73 6020 6973 2061 2068 6172 6420 636f  ns` is a hard co
-0000b480: 6e73 7472 6169 6e74 3a20 6966 206e 6f20  nstraint: if no 
-0000b490: 776f 726b 6572 2069 7320 6176 6169 6c61  worker is availa
-0000b4a0: 626c 650a 2020 2020 233a 2020 2020 2073  ble.    #:     s
-0000b4b0: 6174 6973 6679 696e 6720 7468 6f73 6520  atisfying those 
-0000b4c0: 7265 7374 7269 6374 696f 6e73 2c20 7468  restrictions, th
-0000b4d0: 6520 7461 736b 2063 616e 6e6f 7420 676f  e task cannot go
-0000b4e0: 2069 6e74 6f20 7468 6520 2270 726f 6365   into the "proce
-0000b4f0: 7373 696e 6722 2073 7461 7465 0a20 2020  ssing" state.   
-0000b500: 2023 3a20 2020 2020 616e 6420 7769 6c6c   #:     and will
-0000b510: 2069 6e73 7465 6164 2067 6f20 696e 746f   instead go into
-0000b520: 2074 6865 2022 6e6f 2d77 6f72 6b65 7222   the "no-worker"
-0000b530: 2073 7461 7465 2e0a 2020 2020 233a 2054   state..    #: T
-0000b540: 7275 650a 2020 2020 233a 2020 2020 2054  rue.    #:     T
-0000b550: 6865 2061 626f 7665 2072 6573 7472 6963  he above restric
-0000b560: 7469 6f6e 7320 6172 6520 6d65 7265 2070  tions are mere p
-0000b570: 7265 6665 7265 6e63 6573 3a20 6966 206e  references: if n
-0000b580: 6f20 776f 726b 6572 2069 7320 6176 6169  o worker is avai
-0000b590: 6c61 626c 650a 2020 2020 233a 2020 2020  lable.    #:    
-0000b5a0: 2073 6174 6973 6679 696e 6720 7468 6f73   satisfying thos
-0000b5b0: 6520 7265 7374 7269 6374 696f 6e73 2c20  e restrictions, 
-0000b5c0: 7468 6520 7461 736b 2063 616e 2073 7469  the task can sti
-0000b5d0: 6c6c 2067 6f20 696e 746f 2074 6865 0a20  ll go into the. 
-0000b5e0: 2020 2023 3a20 2020 2020 2270 726f 6365     #:     "proce
-0000b5f0: 7373 696e 6722 2073 7461 7465 2061 6e64  ssing" state and
-0000b600: 2062 6520 7365 6e74 2066 6f72 2065 7865   be sent for exe
-0000b610: 6375 7469 6f6e 2074 6f20 616e 6f74 6865  cution to anothe
-0000b620: 7220 636f 6e6e 6563 7465 6420 776f 726b  r connected work
-0000b630: 6572 2e0a 2020 2020 6c6f 6f73 655f 7265  er..    loose_re
-0000b640: 7374 7269 6374 696f 6e73 3a20 626f 6f6c  strictions: bool
-0000b650: 0a0a 2020 2020 233a 2057 6865 7468 6572  ..    #: Whether
-0000b660: 2074 6869 7320 7461 736b 2069 7320 616e   this task is an
-0000b670: 2041 6374 6f72 0a20 2020 2061 6374 6f72   Actor.    actor
-0000b680: 3a20 626f 6f6c 0a0a 2020 2020 233a 2054  : bool..    #: T
-0000b690: 6865 2067 726f 7570 206f 6620 7461 736b  he group of task
-0000b6a0: 7320 746f 2077 6869 6368 2074 6869 7320  s to which this 
-0000b6b0: 6f6e 6520 6265 6c6f 6e67 730a 2020 2020  one belongs.    
-0000b6c0: 6772 6f75 703a 2054 6173 6b47 726f 7570  group: TaskGroup
-0000b6d0: 0a0a 2020 2020 233a 2053 616d 6520 6173  ..    #: Same as
-0000b6e0: 206f 6620 6772 6f75 702e 6e61 6d65 0a20   of group.name. 
-0000b6f0: 2020 2067 726f 7570 5f6b 6579 3a20 7374     group_key: st
-0000b700: 720a 0a20 2020 2023 3a20 4d65 7461 6461  r..    #: Metada
-0000b710: 7461 2072 656c 6174 6564 2074 6f20 7461  ta related to ta
-0000b720: 736b 0a20 2020 206d 6574 6164 6174 613a  sk.    metadata:
-0000b730: 2064 6963 745b 7374 722c 2041 6e79 5d0a   dict[str, Any].
-0000b740: 0a20 2020 2023 3a20 5461 736b 2061 6e6e  .    #: Task ann
-0000b750: 6f74 6174 696f 6e73 0a20 2020 2061 6e6e  otations.    ann
-0000b760: 6f74 6174 696f 6e73 3a20 6469 6374 5b73  otations: dict[s
-0000b770: 7472 2c20 416e 795d 0a0a 2020 2020 233a  tr, Any]..    #:
-0000b780: 2054 6865 2075 6e69 7175 6520 6964 656e   The unique iden
-0000b790: 7469 6669 6572 206f 6620 6120 7370 6563  tifier of a spec
-0000b7a0: 6966 6963 2065 7865 6375 7469 6f6e 206f  ific execution o
-0000b7b0: 6620 6120 7461 736b 2e20 5468 6973 2069  f a task. This i
-0000b7c0: 6465 6e74 6966 6965 720a 2020 2020 233a  dentifier.    #:
-0000b7d0: 2069 7320 7573 6564 2074 6f20 7369 676e   is used to sign
-0000b7e0: 2061 2074 6173 6b20 7375 6368 2074 6861   a task such tha
-0000b7f0: 7420 7468 6520 6173 7369 676e 6564 2077  t the assigned w
-0000b800: 6f72 6b65 7220 6973 2065 7870 6563 7465  orker is expecte
-0000b810: 6420 746f 2072 6574 7572 6e0a 2020 2020  d to return.    
-0000b820: 233a 2074 6865 2073 616d 6520 6964 656e  #: the same iden
-0000b830: 7469 6669 6572 2069 6e20 7468 6520 7461  tifier in the ta
-0000b840: 736b 2d66 696e 6973 6865 6420 6d65 7373  sk-finished mess
-0000b850: 6167 652e 2054 6869 7320 6973 2075 7365  age. This is use
-0000b860: 6420 746f 2063 6f72 7265 6c61 7465 0a20  d to correlate. 
-0000b870: 2020 2023 3a20 7265 7370 6f6e 7365 732e     #: responses.
-0000b880: 0a20 2020 2023 3a20 4f6e 6c79 2074 6865  .    #: Only the
-0000b890: 206d 6f73 7420 7265 6365 6e74 6c79 2061   most recently a
-0000b8a0: 7373 6967 6e65 6420 776f 726b 6572 2069  ssigned worker i
-0000b8b0: 7320 7472 7573 7465 642e 2041 6c6c 206f  s trusted. All o
-0000b8c0: 7468 6572 2072 6573 756c 7473 2077 696c  ther results wil
-0000b8d0: 6c0a 2020 2020 233a 2062 6520 7265 6a65  l.    #: be reje
-0000b8e0: 6374 6564 2e0a 2020 2020 7275 6e5f 6964  cted..    run_id
-0000b8f0: 3a20 696e 7420 7c20 4e6f 6e65 0a0a 2020  : int | None..  
-0000b900: 2020 233a 2043 6163 6865 6420 6861 7368    #: Cached hash
-0000b910: 206f 6620 3a61 7474 723a 607e 5461 736b   of :attr:`~Task
-0000b920: 5374 6174 652e 636c 6965 6e74 5f6b 6579  State.client_key
-0000b930: 600a 2020 2020 5f68 6173 683a 2069 6e74  `.    _hash: int
-0000b940: 0a0a 2020 2020 2320 5375 7070 6f72 7420  ..    # Support 
-0000b950: 666f 7220 7765 616b 7265 6673 2074 6f20  for weakrefs to 
-0000b960: 6120 636c 6173 7320 7769 7468 205f 5f73  a class with __s
-0000b970: 6c6f 7473 5f5f 0a20 2020 205f 5f77 6561  lots__.    __wea
-0000b980: 6b72 6566 5f5f 3a20 416e 7920 3d20 4e6f  kref__: Any = No
-0000b990: 6e65 0a20 2020 205f 5f73 6c6f 7473 5f5f  ne.    __slots__
-0000b9a0: 203d 2074 7570 6c65 285f 5f61 6e6e 6f74   = tuple(__annot
-0000b9b0: 6174 696f 6e73 5f5f 290a 0a20 2020 2023  ations__)..    #
-0000b9c0: 3a20 476c 6f62 616c 2069 7465 7261 746f  : Global iterato
-0000b9d0: 7220 7573 6564 2074 6f20 6372 6561 7465  r used to create
-0000b9e0: 2075 6e69 7175 6520 7461 736b 2072 756e   unique task run
-0000b9f0: 2049 4473 0a20 2020 205f 7275 6e5f 6964   IDs.    _run_id
-0000ba00: 5f69 7465 7261 746f 723a 2043 6c61 7373  _iterator: Class
-0000ba10: 5661 725b 6974 6572 746f 6f6c 732e 636f  Var[itertools.co
-0000ba20: 756e 745d 203d 2069 7465 7274 6f6f 6c73  unt] = itertools
-0000ba30: 2e63 6f75 6e74 2829 0a0a 2020 2020 2320  .count()..    # 
-0000ba40: 496e 7374 616e 6365 7320 6e6f 7420 7061  Instances not pa
-0000ba50: 7274 206f 6620 736c 6f74 7320 7369 6e63  rt of slots sinc
-0000ba60: 6520 636c 6173 7320 7661 7269 6162 6c65  e class variable
-0000ba70: 0a20 2020 205f 696e 7374 616e 6365 733a  .    _instances:
-0000ba80: 2043 6c61 7373 5661 725b 7765 616b 7265   ClassVar[weakre
-0000ba90: 662e 5765 616b 5365 745b 5461 736b 5374  f.WeakSet[TaskSt
-0000baa0: 6174 655d 5d20 3d20 7765 616b 7265 662e  ate]] = weakref.
-0000bab0: 5765 616b 5365 7428 290a 0a20 2020 2064  WeakSet()..    d
-0000bac0: 6566 205f 5f69 6e69 745f 5f28 0a20 2020  ef __init__(.   
-0000bad0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-0000bae0: 2020 206b 6579 3a20 7374 722c 0a20 2020     key: str,.   
-0000baf0: 2020 2020 2072 756e 5f73 7065 633a 206f       run_spec: o
-0000bb00: 626a 6563 742c 0a20 2020 2020 2020 2073  bject,.        s
-0000bb10: 7461 7465 3a20 5461 736b 5374 6174 6553  tate: TaskStateS
-0000bb20: 7461 7465 2c0a 2020 2020 293a 0a20 2020  tate,.    ):.   
-0000bb30: 2020 2020 2073 656c 662e 6b65 7920 3d20       self.key = 
-0000bb40: 6b65 790a 2020 2020 2020 2020 7365 6c66  key.        self
-0000bb50: 2e5f 6861 7368 203d 2068 6173 6828 6b65  ._hash = hash(ke
-0000bb60: 7929 0a20 2020 2020 2020 2073 656c 662e  y).        self.
-0000bb70: 7275 6e5f 7370 6563 203d 2072 756e 5f73  run_spec = run_s
-0000bb80: 7065 630a 2020 2020 2020 2020 7365 6c66  pec.        self
-0000bb90: 2e5f 7374 6174 6520 3d20 7374 6174 650a  ._state = state.
-0000bba0: 2020 2020 2020 2020 7365 6c66 2e65 7863          self.exc
-0000bbb0: 6570 7469 6f6e 203d 204e 6f6e 650a 2020  eption = None.  
-0000bbc0: 2020 2020 2020 7365 6c66 2e65 7863 6570        self.excep
-0000bbd0: 7469 6f6e 5f62 6c61 6d65 203d 204e 6f6e  tion_blame = Non
-0000bbe0: 650a 2020 2020 2020 2020 7365 6c66 2e74  e.        self.t
-0000bbf0: 7261 6365 6261 636b 203d 204e 6f6e 650a  raceback = None.
-0000bc00: 2020 2020 2020 2020 7365 6c66 2e65 7863          self.exc
-0000bc10: 6570 7469 6f6e 5f74 6578 7420 3d20 2222  eption_text = ""
-0000bc20: 0a20 2020 2020 2020 2073 656c 662e 7472  .        self.tr
-0000bc30: 6163 6562 6163 6b5f 7465 7874 203d 2022  aceback_text = "
-0000bc40: 220a 2020 2020 2020 2020 7365 6c66 2e73  ".        self.s
-0000bc50: 7573 7069 6369 6f75 7320 3d20 300a 2020  uspicious = 0.  
-0000bc60: 2020 2020 2020 7365 6c66 2e72 6574 7269        self.retri
-0000bc70: 6573 203d 2030 0a20 2020 2020 2020 2073  es = 0.        s
-0000bc80: 656c 662e 6e62 7974 6573 203d 202d 310a  elf.nbytes = -1.
-0000bc90: 2020 2020 2020 2020 7365 6c66 2e70 7269          self.pri
-0000bca0: 6f72 6974 7920 3d20 4e6f 6e65 0a20 2020  ority = None.   
-0000bcb0: 2020 2020 2073 656c 662e 7768 6f5f 7761       self.who_wa
-0000bcc0: 6e74 7320 3d20 7365 7428 290a 2020 2020  nts = set().    
-0000bcd0: 2020 2020 7365 6c66 2e64 6570 656e 6465      self.depende
-0000bce0: 6e63 6965 7320 3d20 7365 7428 290a 2020  ncies = set().  
-0000bcf0: 2020 2020 2020 7365 6c66 2e64 6570 656e        self.depen
-0000bd00: 6465 6e74 7320 3d20 7365 7428 290a 2020  dents = set().  
-0000bd10: 2020 2020 2020 7365 6c66 2e77 6169 7469        self.waiti
-0000bd20: 6e67 5f6f 6e20 3d20 7365 7428 290a 2020  ng_on = set().  
-0000bd30: 2020 2020 2020 7365 6c66 2e77 6169 7465        self.waite
-0000bd40: 7273 203d 2073 6574 2829 0a20 2020 2020  rs = set().     
-0000bd50: 2020 2073 656c 662e 7768 6f5f 6861 7320     self.who_has 
-0000bd60: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-0000bd70: 7365 6c66 2e70 726f 6365 7373 696e 675f  self.processing_
-0000bd80: 6f6e 203d 204e 6f6e 650a 2020 2020 2020  on = None.      
-0000bd90: 2020 7365 6c66 2e68 6173 5f6c 6f73 745f    self.has_lost_
-0000bda0: 6465 7065 6e64 656e 6369 6573 203d 2046  dependencies = F
-0000bdb0: 616c 7365 0a20 2020 2020 2020 2073 656c  alse.        sel
-0000bdc0: 662e 686f 7374 5f72 6573 7472 6963 7469  f.host_restricti
-0000bdd0: 6f6e 7320 3d20 7365 7428 290a 2020 2020  ons = set().    
-0000bde0: 2020 2020 7365 6c66 2e77 6f72 6b65 725f      self.worker_
-0000bdf0: 7265 7374 7269 6374 696f 6e73 203d 2073  restrictions = s
-0000be00: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
-0000be10: 662e 7265 736f 7572 6365 5f72 6573 7472  f.resource_restr
-0000be20: 6963 7469 6f6e 7320 3d20 7b7d 0a20 2020  ictions = {}.   
-0000be30: 2020 2020 2073 656c 662e 6c6f 6f73 655f       self.loose_
-0000be40: 7265 7374 7269 6374 696f 6e73 203d 2046  restrictions = F
-0000be50: 616c 7365 0a20 2020 2020 2020 2073 656c  alse.        sel
-0000be60: 662e 6163 746f 7220 3d20 4661 6c73 650a  f.actor = False.
-0000be70: 2020 2020 2020 2020 7365 6c66 2e70 7265          self.pre
-0000be80: 6669 7820 3d20 4e6f 6e65 2020 2320 7479  fix = None  # ty
-0000be90: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
-0000bea0: 2020 2073 656c 662e 7479 7065 203d 204e     self.type = N
-0000beb0: 6f6e 6520 2023 2074 7970 653a 2069 676e  one  # type: ign
-0000bec0: 6f72 650a 2020 2020 2020 2020 7365 6c66  ore.        self
-0000bed0: 2e67 726f 7570 5f6b 6579 203d 206b 6579  .group_key = key
-0000bee0: 5f73 706c 6974 5f67 726f 7570 286b 6579  _split_group(key
-0000bef0: 290a 2020 2020 2020 2020 7365 6c66 2e67  ).        self.g
-0000bf00: 726f 7570 203d 204e 6f6e 6520 2023 2074  roup = None  # t
-0000bf10: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
-0000bf20: 2020 2020 7365 6c66 2e6d 6574 6164 6174      self.metadat
-0000bf30: 6120 3d20 7b7d 0a20 2020 2020 2020 2073  a = {}.        s
-0000bf40: 656c 662e 616e 6e6f 7461 7469 6f6e 7320  elf.annotations 
-0000bf50: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
-0000bf60: 662e 6572 7265 645f 6f6e 203d 2073 6574  f.erred_on = set
-0000bf70: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-0000bf80: 7275 6e5f 6964 203d 204e 6f6e 650a 2020  run_id = None.  
-0000bf90: 2020 2020 2020 5461 736b 5374 6174 652e        TaskState.
-0000bfa0: 5f69 6e73 7461 6e63 6573 2e61 6464 2873  _instances.add(s
-0000bfb0: 656c 6629 0a0a 2020 2020 6465 6620 5f5f  elf)..    def __
-0000bfc0: 6861 7368 5f5f 2873 656c 6629 202d 3e20  hash__(self) -> 
-0000bfd0: 696e 743a 0a20 2020 2020 2020 2072 6574  int:.        ret
-0000bfe0: 7572 6e20 7365 6c66 2e5f 6861 7368 0a0a  urn self._hash..
-0000bff0: 2020 2020 6465 6620 5f5f 6571 5f5f 2873      def __eq__(s
-0000c000: 656c 662c 206f 7468 6572 3a20 6f62 6a65  elf, other: obje
-0000c010: 6374 2920 2d3e 2062 6f6f 6c3a 0a20 2020  ct) -> bool:.   
-0000c020: 2020 2020 2072 6574 7572 6e20 6973 696e       return isin
-0000c030: 7374 616e 6365 286f 7468 6572 2c20 5461  stance(other, Ta
-0000c040: 736b 5374 6174 6529 2061 6e64 2073 656c  skState) and sel
-0000c050: 662e 6b65 7920 3d3d 206f 7468 6572 2e6b  f.key == other.k
-0000c060: 6579 0a0a 2020 2020 4070 726f 7065 7274  ey..    @propert
-0000c070: 790a 2020 2020 6465 6620 7374 6174 6528  y.    def state(
-0000c080: 7365 6c66 2920 2d3e 2054 6173 6b53 7461  self) -> TaskSta
-0000c090: 7465 5374 6174 653a 0a20 2020 2020 2020  teState:.       
-0000c0a0: 2022 2222 5468 6973 2074 6173 6b27 7320   """This task's 
-0000c0b0: 6375 7272 656e 7420 7374 6174 652e 2020  current state.  
-0000c0c0: 5661 6c69 6420 7374 6174 6573 2061 7265  Valid states are
-0000c0d0: 2060 6072 656c 6561 7365 6460 602c 2060   ``released``, `
-0000c0e0: 6077 6169 7469 6e67 6060 2c0a 2020 2020  `waiting``,.    
-0000c0f0: 2020 2020 6060 6e6f 2d77 6f72 6b65 7260      ``no-worker`
-0000c100: 602c 2060 6070 726f 6365 7373 696e 6760  `, ``processing`
-0000c110: 602c 2060 606d 656d 6f72 7960 602c 2060  `, ``memory``, `
-0000c120: 6065 7272 6564 6060 2061 6e64 2060 6066  `erred`` and ``f
-0000c130: 6f72 676f 7474 656e 6060 2e20 2049 6620  orgotten``.  If 
-0000c140: 6974 0a20 2020 2020 2020 2069 7320 6060  it.        is ``
-0000c150: 666f 7267 6f74 7465 6e60 602c 2074 6865  forgotten``, the
-0000c160: 2074 6173 6b20 6973 6e27 7420 7374 6f72   task isn't stor
-0000c170: 6564 2069 6e20 7468 6520 6060 7461 736b  ed in the ``task
-0000c180: 7360 6020 6469 6374 696f 6e61 7279 2061  s`` dictionary a
-0000c190: 6e79 6d6f 7265 2061 6e64 0a20 2020 2020  nymore and.     
-0000c1a0: 2020 2077 696c 6c20 7072 6f62 6162 6c79     will probably
-0000c1b0: 2064 6973 6170 7065 6172 2073 6f6f 6e20   disappear soon 
-0000c1c0: 6672 6f6d 206d 656d 6f72 792e 0a20 2020  from memory..   
-0000c1d0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0000c1e0: 2072 6574 7572 6e20 7365 6c66 2e5f 7374   return self._st
-0000c1f0: 6174 650a 0a20 2020 2040 7374 6174 652e  ate..    @state.
-0000c200: 7365 7474 6572 0a20 2020 2064 6566 2073  setter.    def s
-0000c210: 7461 7465 2873 656c 662c 2076 616c 7565  tate(self, value
-0000c220: 3a20 5461 736b 5374 6174 6553 7461 7465  : TaskStateState
-0000c230: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0000c240: 2020 2073 656c 662e 6772 6f75 702e 7374     self.group.st
-0000c250: 6174 6573 5b73 656c 662e 5f73 7461 7465  ates[self._state
-0000c260: 5d20 2d3d 2031 0a20 2020 2020 2020 2073  ] -= 1.        s
-0000c270: 656c 662e 6772 6f75 702e 7374 6174 6573  elf.group.states
-0000c280: 5b76 616c 7565 5d20 2b3d 2031 0a20 2020  [value] += 1.   
-0000c290: 2020 2020 2073 656c 662e 5f73 7461 7465       self._state
-0000c2a0: 203d 2076 616c 7565 0a20 2020 2020 2020   = value.       
-0000c2b0: 2073 656c 662e 7072 6566 6978 2e73 7461   self.prefix.sta
-0000c2c0: 7465 5f63 6f75 6e74 735b 7661 6c75 655d  te_counts[value]
-0000c2d0: 202b 3d20 310a 0a20 2020 2064 6566 2061   += 1..    def a
-0000c2e0: 6464 5f64 6570 656e 6465 6e63 7928 7365  dd_dependency(se
-0000c2f0: 6c66 2c20 6f74 6865 723a 2054 6173 6b53  lf, other: TaskS
-0000c300: 7461 7465 2920 2d3e 204e 6f6e 653a 0a20  tate) -> None:. 
-0000c310: 2020 2020 2020 2022 2222 4164 6420 616e         """Add an
-0000c320: 6f74 6865 7220 7461 736b 2061 7320 6120  other task as a 
-0000c330: 6465 7065 6e64 656e 6379 206f 6620 7468  dependency of th
-0000c340: 6973 2074 6173 6b22 2222 0a20 2020 2020  is task""".     
-0000c350: 2020 2073 656c 662e 6465 7065 6e64 656e     self.dependen
-0000c360: 6369 6573 2e61 6464 286f 7468 6572 290a  cies.add(other).
-0000c370: 2020 2020 2020 2020 7365 6c66 2e67 726f          self.gro
-0000c380: 7570 2e64 6570 656e 6465 6e63 6965 732e  up.dependencies.
-0000c390: 6164 6428 6f74 6865 722e 6772 6f75 7029  add(other.group)
-0000c3a0: 0a20 2020 2020 2020 206f 7468 6572 2e64  .        other.d
-0000c3b0: 6570 656e 6465 6e74 732e 6164 6428 7365  ependents.add(se
-0000c3c0: 6c66 290a 0a20 2020 2064 6566 2067 6574  lf)..    def get
-0000c3d0: 5f6e 6279 7465 7328 7365 6c66 2920 2d3e  _nbytes(self) ->
-0000c3e0: 2069 6e74 3a0a 2020 2020 2020 2020 7265   int:.        re
-0000c3f0: 7475 726e 2073 656c 662e 6e62 7974 6573  turn self.nbytes
-0000c400: 2069 6620 7365 6c66 2e6e 6279 7465 7320   if self.nbytes 
-0000c410: 3e3d 2030 2065 6c73 6520 4445 4641 554c  >= 0 else DEFAUL
-0000c420: 545f 4441 5441 5f53 495a 450a 0a20 2020  T_DATA_SIZE..   
-0000c430: 2064 6566 2073 6574 5f6e 6279 7465 7328   def set_nbytes(
-0000c440: 7365 6c66 2c20 6e62 7974 6573 3a20 696e  self, nbytes: in
-0000c450: 7429 202d 3e20 4e6f 6e65 3a0a 2020 2020  t) -> None:.    
-0000c460: 2020 2020 6469 6666 203d 206e 6279 7465      diff = nbyte
-0000c470: 730a 2020 2020 2020 2020 6f6c 645f 6e62  s.        old_nb
-0000c480: 7974 6573 203d 2073 656c 662e 6e62 7974  ytes = self.nbyt
-0000c490: 6573 0a20 2020 2020 2020 2069 6620 6f6c  es.        if ol
-0000c4a0: 645f 6e62 7974 6573 203e 3d20 303a 0a20  d_nbytes >= 0:. 
-0000c4b0: 2020 2020 2020 2020 2020 2064 6966 6620             diff 
-0000c4c0: 2d3d 206f 6c64 5f6e 6279 7465 730a 2020  -= old_nbytes.  
-0000c4d0: 2020 2020 2020 7365 6c66 2e67 726f 7570        self.group
-0000c4e0: 2e6e 6279 7465 735f 746f 7461 6c20 2b3d  .nbytes_total +=
-0000c4f0: 2064 6966 660a 2020 2020 2020 2020 666f   diff.        fo
-0000c500: 7220 7773 2069 6e20 7365 6c66 2e77 686f  r ws in self.who
-0000c510: 5f68 6173 3a0a 2020 2020 2020 2020 2020  _has:.          
-0000c520: 2020 7773 2e6e 6279 7465 7320 2b3d 2064    ws.nbytes += d
-0000c530: 6966 660a 2020 2020 2020 2020 7365 6c66  iff.        self
-0000c540: 2e6e 6279 7465 7320 3d20 6e62 7974 6573  .nbytes = nbytes
-0000c550: 0a0a 2020 2020 6465 6620 5f5f 7265 7072  ..    def __repr
-0000c560: 5f5f 2873 656c 6629 202d 3e20 7374 723a  __(self) -> str:
-0000c570: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000c580: 6622 3c54 6173 6b53 7461 7465 207b 7365  f"<TaskState {se
-0000c590: 6c66 2e6b 6579 2172 7d20 7b73 656c 662e  lf.key!r} {self.
-0000c5a0: 5f73 7461 7465 7d3e 220a 0a20 2020 2064  _state}>"..    d
-0000c5b0: 6566 205f 7265 7072 5f68 746d 6c5f 2873  ef _repr_html_(s
-0000c5c0: 656c 6629 202d 3e20 7374 723a 0a20 2020  elf) -> str:.   
-0000c5d0: 2020 2020 2072 6574 7572 6e20 6765 745f       return get_
-0000c5e0: 7465 6d70 6c61 7465 2822 7461 736b 5f73  template("task_s
-0000c5f0: 7461 7465 2e68 746d 6c2e 6a32 2229 2e72  tate.html.j2").r
-0000c600: 656e 6465 7228 0a20 2020 2020 2020 2020  ender(.         
-0000c610: 2020 2073 7461 7465 3d73 656c 662e 7374     state=self.st
-0000c620: 6174 652c 0a20 2020 2020 2020 2020 2020  ate,.           
-0000c630: 206e 6279 7465 733d 7365 6c66 2e6e 6279   nbytes=self.nby
-0000c640: 7465 732c 0a20 2020 2020 2020 2020 2020  tes,.           
-0000c650: 206b 6579 3d73 656c 662e 6b65 792c 0a20   key=self.key,. 
-0000c660: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
-0000c670: 6620 7661 6c69 6461 7465 2873 656c 6629  f validate(self)
-0000c680: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0000c690: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0000c6a0: 2020 2066 6f72 2063 7320 696e 2073 656c     for cs in sel
-0000c6b0: 662e 7768 6f5f 7761 6e74 733a 0a20 2020  f.who_wants:.   
-0000c6c0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-0000c6d0: 6572 7420 6973 696e 7374 616e 6365 2863  ert isinstance(c
-0000c6e0: 732c 2043 6c69 656e 7453 7461 7465 292c  s, ClientState),
-0000c6f0: 2028 7265 7072 2863 7329 2c20 7365 6c66   (repr(cs), self
-0000c700: 2e77 686f 5f77 616e 7473 290a 2020 2020  .who_wants).    
-0000c710: 2020 2020 2020 2020 666f 7220 7773 2069          for ws i
-0000c720: 6e20 7365 6c66 2e77 686f 5f68 6173 3a0a  n self.who_has:.
-0000c730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c740: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
-0000c750: 6528 7773 2c20 576f 726b 6572 5374 6174  e(ws, WorkerStat
-0000c760: 6529 2c20 2872 6570 7228 7773 292c 2073  e), (repr(ws), s
-0000c770: 656c 662e 7768 6f5f 6861 7329 0a20 2020  elf.who_has).   
-0000c780: 2020 2020 2020 2020 2066 6f72 2074 7320           for ts 
-0000c790: 696e 2073 656c 662e 6465 7065 6e64 656e  in self.dependen
-0000c7a0: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
-0000c7b0: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
-0000c7c0: 6e73 7461 6e63 6528 7473 2c20 5461 736b  nstance(ts, Task
-0000c7d0: 5374 6174 6529 2c20 2872 6570 7228 7473  State), (repr(ts
-0000c7e0: 292c 2073 656c 662e 6465 7065 6e64 656e  ), self.dependen
-0000c7f0: 6369 6573 290a 2020 2020 2020 2020 2020  cies).          
-0000c800: 2020 666f 7220 7473 2069 6e20 7365 6c66    for ts in self
-0000c810: 2e64 6570 656e 6465 6e74 733a 0a20 2020  .dependents:.   
-0000c820: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-0000c830: 6572 7420 6973 696e 7374 616e 6365 2874  ert isinstance(t
-0000c840: 732c 2054 6173 6b53 7461 7465 292c 2028  s, TaskState), (
-0000c850: 7265 7072 2874 7329 2c20 7365 6c66 2e64  repr(ts), self.d
-0000c860: 6570 656e 6465 6e74 7329 0a20 2020 2020  ependents).     
-0000c870: 2020 2020 2020 2076 616c 6964 6174 655f         validate_
-0000c880: 7461 736b 5f73 7461 7465 2873 656c 6629  task_state(self)
-0000c890: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-0000c8a0: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
-0000c8b0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-0000c8c0: 6572 2e65 7863 6570 7469 6f6e 2865 290a  er.exception(e).
-0000c8d0: 2020 2020 2020 2020 2020 2020 6966 204c              if L
-0000c8e0: 4f47 5f50 4442 3a0a 2020 2020 2020 2020  OG_PDB:.        
-0000c8f0: 2020 2020 2020 2020 696d 706f 7274 2070          import p
-0000c900: 6462 0a0a 2020 2020 2020 2020 2020 2020  db..            
-0000c910: 2020 2020 7064 622e 7365 745f 7472 6163      pdb.set_trac
-0000c920: 6528 290a 0a20 2020 2064 6566 2067 6574  e()..    def get
-0000c930: 5f6e 6279 7465 735f 6465 7073 2873 656c  _nbytes_deps(sel
-0000c940: 6629 202d 3e20 696e 743a 0a20 2020 2020  f) -> int:.     
-0000c950: 2020 2072 6574 7572 6e20 7375 6d28 7473     return sum(ts
-0000c960: 2e67 6574 5f6e 6279 7465 7328 2920 666f  .get_nbytes() fo
-0000c970: 7220 7473 2069 6e20 7365 6c66 2e64 6570  r ts in self.dep
-0000c980: 656e 6465 6e63 6965 7329 0a0a 2020 2020  endencies)..    
-0000c990: 6465 6620 5f74 6f5f 6469 6374 5f6e 6f5f  def _to_dict_no_
-0000c9a0: 6e65 7374 2873 656c 662c 202a 2c20 6578  nest(self, *, ex
-0000c9b0: 636c 7564 653a 2043 6f6e 7461 696e 6572  clude: Container
-0000c9c0: 5b73 7472 5d20 3d20 2829 2920 2d3e 2064  [str] = ()) -> d
-0000c9d0: 6963 745b 7374 722c 2041 6e79 5d3a 0a20  ict[str, Any]:. 
-0000c9e0: 2020 2020 2020 2022 2222 4469 6374 696f         """Dictio
-0000c9f0: 6e61 7279 2072 6570 7265 7365 6e74 6174  nary representat
-0000ca00: 696f 6e20 666f 7220 6465 6275 6767 696e  ion for debuggin
-0000ca10: 6720 7075 7270 6f73 6573 2e0a 2020 2020  g purposes..    
-0000ca20: 2020 2020 4e6f 7420 7479 7065 2073 7461      Not type sta
-0000ca30: 626c 6520 616e 6420 6e6f 7420 696e 7465  ble and not inte
-0000ca40: 6e64 6564 2066 6f72 2072 6f75 6e64 7472  nded for roundtr
-0000ca50: 6970 732e 0a0a 2020 2020 2020 2020 5365  ips...        Se
-0000ca60: 6520 616c 736f 0a20 2020 2020 2020 202d  e also.        -
-0000ca70: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-0000ca80: 436c 6965 6e74 2e64 756d 705f 636c 7573  Client.dump_clus
-0000ca90: 7465 725f 7374 6174 650a 2020 2020 2020  ter_state.      
-0000caa0: 2020 6469 7374 7269 6275 7465 642e 7574    distributed.ut
-0000cab0: 696c 732e 7265 6375 7273 6976 655f 746f  ils.recursive_to
-0000cac0: 5f64 6963 740a 0a20 2020 2020 2020 204e  _dict..        N
-0000cad0: 6f74 6573 0a20 2020 2020 2020 202d 2d2d  otes.        ---
-0000cae0: 2d2d 0a20 2020 2020 2020 2054 6869 7320  --.        This 
-0000caf0: 636c 6173 7320 7573 6573 2060 605f 746f  class uses ``_to
-0000cb00: 5f64 6963 745f 6e6f 5f6e 6573 7460 6020  _dict_no_nest`` 
-0000cb10: 696e 7374 6561 6420 6f66 2060 605f 746f  instead of ``_to
-0000cb20: 5f64 6963 7460 602e 0a20 2020 2020 2020  _dict``..       
-0000cb30: 2057 6865 6e20 6120 7461 736b 2072 6566   When a task ref
-0000cb40: 6572 656e 6365 7320 616e 6f74 6865 7220  erences another 
-0000cb50: 7461 736b 2c20 6f72 2077 6865 6e20 6120  task, or when a 
-0000cb60: 576f 726b 6572 5374 6174 652e 7461 736b  WorkerState.task
-0000cb70: 7320 636f 6e74 6169 6e73 2074 6173 6b73  s contains tasks
-0000cb80: 2c0a 2020 2020 2020 2020 7468 6973 206d  ,.        this m
-0000cb90: 6574 686f 6420 6973 206e 6f74 2065 7865  ethod is not exe
-0000cba0: 6375 7465 6420 666f 7220 7468 6520 696e  cuted for the in
-0000cbb0: 6e65 7220 7461 736b 2c20 6576 656e 2069  ner task, even i
-0000cbc0: 6620 7468 6520 696e 6e65 7220 7461 736b  f the inner task
-0000cbd0: 2077 6173 206e 6576 6572 0a20 2020 2020   was never.     
-0000cbe0: 2020 2073 6565 6e20 6265 666f 7265 3b20     seen before; 
-0000cbf0: 796f 7520 6765 7420 6120 7265 7072 2069  you get a repr i
-0000cc00: 6e73 7465 6164 2e20 416c 6c20 7461 736b  nstead. All task
-0000cc10: 7320 7368 6f75 6c64 206e 6561 746c 7920  s should neatly 
-0000cc20: 6170 7065 6172 2075 6e64 6572 0a20 2020  appear under.   
-0000cc30: 2020 2020 2053 6368 6564 756c 6572 2e74       Scheduler.t
-0000cc40: 6173 6b73 2e20 5468 6973 2061 6c73 6f20  asks. This also 
-0000cc50: 7072 6576 656e 7473 2061 2052 6563 7572  prevents a Recur
-0000cc60: 7369 6f6e 4572 726f 7220 6475 7269 6e67  sionError during
-0000cc70: 2070 6172 7469 6375 6c61 726c 7920 6865   particularly he
-0000cc80: 6176 790a 2020 2020 2020 2020 6c6f 6164  avy.        load
-0000cc90: 732c 2077 6869 6368 2068 6176 6520 6265  s, which have be
-0000cca0: 656e 206f 6273 6572 7665 6420 746f 2068  en observed to h
-0000ccb0: 6170 7065 6e20 7768 656e 6576 6572 2074  appen whenever t
-0000ccc0: 6865 7265 2773 2061 6e20 6163 7963 6c69  here's an acycli
-0000ccd0: 6320 6465 7065 6e64 656e 6379 0a20 2020  c dependency.   
-0000cce0: 2020 2020 2063 6861 696e 206f 6620 7e32       chain of ~2
-0000ccf0: 3030 2b20 7461 736b 732e 0a20 2020 2020  00+ tasks..     
-0000cd00: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
-0000cd10: 6574 7572 6e20 7265 6375 7273 6976 655f  eturn recursive_
-0000cd20: 746f 5f64 6963 7428 7365 6c66 2c20 6578  to_dict(self, ex
-0000cd30: 636c 7564 653d 6578 636c 7564 652c 206d  clude=exclude, m
-0000cd40: 656d 6265 7273 3d54 7275 6529 0a0a 0a63  embers=True)...c
-0000cd50: 6c61 7373 2054 7261 6e73 6974 696f 6e28  lass Transition(
-0000cd60: 4e61 6d65 6454 7570 6c65 293a 0a20 2020  NamedTuple):.   
-0000cd70: 2022 2222 416e 2065 6e74 7279 2069 6e20   """An entry in 
-0000cd80: 3a61 7474 723a 6053 6368 6564 756c 6572  :attr:`Scheduler
-0000cd90: 5374 6174 652e 7472 616e 7369 7469 6f6e  State.transition
-0000cda0: 5f6c 6f67 6022 2222 0a0a 2020 2020 6b65  _log`"""..    ke
-0000cdb0: 793a 2073 7472 0a20 2020 2073 7461 7274  y: str.    start
-0000cdc0: 3a20 5461 736b 5374 6174 6553 7461 7465  : TaskStateState
-0000cdd0: 0a20 2020 2066 696e 6973 683a 2054 6173  .    finish: Tas
-0000cde0: 6b53 7461 7465 5374 6174 650a 2020 2020  kStateState.    
-0000cdf0: 7265 636f 6d6d 656e 6461 7469 6f6e 733a  recommendations:
-0000ce00: 2052 6563 730a 2020 2020 7374 696d 756c   Recs.    stimul
-0000ce10: 7573 5f69 643a 2073 7472 0a20 2020 2074  us_id: str.    t
-0000ce20: 696d 6573 7461 6d70 3a20 666c 6f61 740a  imestamp: float.
-0000ce30: 0a0a 636c 6173 7320 5363 6865 6475 6c65  ..class Schedule
-0000ce40: 7253 7461 7465 3a0a 2020 2020 2222 2255  rState:.    """U
-0000ce50: 6e64 6572 6c79 696e 6720 7461 736b 2073  nderlying task s
-0000ce60: 7461 7465 206f 6620 6479 6e61 6d69 6320  tate of dynamic 
-0000ce70: 7363 6865 6475 6c65 720a 0a20 2020 2054  scheduler..    T
-0000ce80: 7261 636b 7320 7468 6520 6375 7272 656e  racks the curren
-0000ce90: 7420 7374 6174 6520 6f66 2077 6f72 6b65  t state of worke
-0000cea0: 7273 2c20 6461 7461 2c20 616e 6420 636f  rs, data, and co
-0000ceb0: 6d70 7574 6174 696f 6e73 2e0a 0a20 2020  mputations...   
-0000cec0: 2048 616e 646c 6573 2074 7261 6e73 6974   Handles transit
-0000ced0: 696f 6e73 2062 6574 7765 656e 2064 6966  ions between dif
-0000cee0: 6665 7265 6e74 2074 6173 6b20 7374 6174  ferent task stat
-0000cef0: 6573 2e20 4e6f 7469 6669 6573 2074 6865  es. Notifies the
-0000cf00: 0a20 2020 2053 6368 6564 756c 6572 206f  .    Scheduler o
-0000cf10: 6620 6368 616e 6765 7320 6279 206d 6573  f changes by mes
-0000cf20: 7361 6769 6e67 2070 6173 7369 6e67 2074  saging passing t
-0000cf30: 6872 6f75 6768 2051 7565 7565 732c 2077  hrough Queues, w
-0000cf40: 6869 6368 2074 6865 0a20 2020 2053 6368  hich the.    Sch
-0000cf50: 6564 756c 6572 206c 6973 7465 6e73 2074  eduler listens t
-0000cf60: 6f20 7265 7370 6f6e 6473 2061 6363 6f72  o responds accor
-0000cf70: 6469 6e67 6c79 2e0a 0a20 2020 2041 6c6c  dingly...    All
-0000cf80: 2065 7665 6e74 7320 6172 6520 6861 6e64   events are hand
-0000cf90: 6c65 6420 7175 6963 6b6c 792c 2069 6e20  led quickly, in 
-0000cfa0: 6c69 6e65 6172 2074 696d 6520 7769 7468  linear time with
-0000cfb0: 2072 6573 7065 6374 2074 6f20 7468 6569   respect to thei
-0000cfc0: 720a 2020 2020 696e 7075 7420 2877 6869  r.    input (whi
-0000cfd0: 6368 2069 7320 6f66 7465 6e20 6f66 2063  ch is often of c
-0000cfe0: 6f6e 7374 616e 7420 7369 7a65 2920 616e  onstant size) an
-0000cff0: 6420 6765 6e65 7261 6c6c 7920 7769 7468  d generally with
-0000d000: 696e 2061 0a20 2020 206d 696c 6c69 7365  in a.    millise
-0000d010: 636f 6e64 2e0a 0a20 2020 2055 7365 7273  cond...    Users
-0000d020: 2074 7970 6963 616c 6c79 2064 6f20 6e6f   typically do no
-0000d030: 7420 696e 7465 7261 6374 2077 6974 6820  t interact with 
-0000d040: 6060 5472 616e 7369 7469 6f6e 7360 6020  ``Transitions`` 
-0000d050: 6469 7265 6374 6c79 2e20 496e 7374 6561  directly. Instea
-0000d060: 640a 2020 2020 7573 6572 7320 696e 7465  d.    users inte
-0000d070: 7261 6374 2077 6974 6820 7468 6520 6060  ract with the ``
-0000d080: 436c 6965 6e74 6060 2c20 7768 6963 6820  Client``, which 
-0000d090: 696e 2074 7572 6e20 656e 6761 6765 7320  in turn engages 
-0000d0a0: 7468 650a 2020 2020 6060 5363 6865 6475  the.    ``Schedu
-0000d0b0: 6c65 7260 6020 6166 6665 6374 696e 6720  ler`` affecting 
-0000d0c0: 6469 6666 6572 656e 7420 7472 616e 7369  different transi
-0000d0d0: 7469 6f6e 7320 6865 7265 2075 6e64 6572  tions here under
-0000d0e0: 2d74 6865 2d68 6f6f 642e 2049 6e0a 2020  -the-hood. In.  
-0000d0f0: 2020 7468 6520 6261 636b 6772 6f75 6e64    the background
-0000d100: 2060 6057 6f72 6b65 7260 6073 2061 6c73   ``Worker``s als
-0000d110: 6f20 656e 6761 6765 2077 6974 6820 7468  o engage with th
-0000d120: 6520 6060 5363 6865 6475 6c65 7260 600a  e ``Scheduler``.
-0000d130: 2020 2020 6166 6665 6374 696e 6720 7468      affecting th
-0000d140: 6573 6520 7374 6174 6520 7472 616e 7369  ese state transi
-0000d150: 7469 6f6e 7320 6173 2077 656c 6c2e 0a20  tions as well.. 
-0000d160: 2020 2022 2222 0a0a 2020 2020 6261 6e64     """..    band
-0000d170: 7769 6474 683a 2069 6e74 0a0a 2020 2020  width: int..    
-0000d180: 233a 2043 6c69 656e 7473 2063 7572 7265  #: Clients curre
-0000d190: 6e74 6c79 2063 6f6e 6e65 6374 6564 2074  ntly connected t
-0000d1a0: 6f20 7468 6520 7363 6865 6475 6c65 720a  o the scheduler.
-0000d1b0: 2020 2020 636c 6965 6e74 733a 2064 6963      clients: dic
-0000d1c0: 745b 7374 722c 2043 6c69 656e 7453 7461  t[str, ClientSta
-0000d1d0: 7465 5d0a 0a20 2020 2065 7874 656e 7369  te]..    extensi
-0000d1e0: 6f6e 733a 2064 6963 745b 7374 722c 2041  ons: dict[str, A
-0000d1f0: 6e79 5d20 2023 2054 4f44 4f20 7772 6974  ny]  # TODO writ
-0000d200: 6520 6120 7363 6865 6475 6c65 7220 6578  e a scheduler ex
-0000d210: 7465 6e73 696f 6e20 5072 6f74 6f63 6f6c  tension Protocol
-0000d220: 0a20 2020 2070 6c75 6769 6e73 3a20 6469  .    plugins: di
-0000d230: 6374 5b73 7472 2c20 5363 6865 6475 6c65  ct[str, Schedule
-0000d240: 7250 6c75 6769 6e5d 0a20 2020 2068 6f73  rPlugin].    hos
-0000d250: 745f 696e 666f 3a20 6469 6374 5b73 7472  t_info: dict[str
-0000d260: 2c20 6469 6374 5b73 7472 2c20 416e 795d  , dict[str, Any]
-0000d270: 5d0a 0a20 2020 2023 3a20 4966 2054 7275  ]..    #: If Tru
-0000d280: 652c 2065 6e61 626c 6520 6578 7065 6e73  e, enable expens
-0000d290: 6976 6520 696e 7465 726e 616c 2063 6f6e  ive internal con
-0000d2a0: 7369 7374 656e 6379 2063 6865 636b 2e0a  sistency check..
-0000d2b0: 2020 2020 233a 2054 7970 6963 616c 6c79      #: Typically
-0000d2c0: 2064 6973 6162 6c65 6420 696e 2070 726f   disabled in pro
-0000d2d0: 6475 6374 696f 6e2e 0a20 2020 2076 616c  duction..    val
-0000d2e0: 6964 6174 653a 2062 6f6f 6c0a 0a20 2020  idate: bool..   
-0000d2f0: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
-0000d300: 2323 2323 2323 2323 0a20 2020 2023 2057  ########.    # W
-0000d310: 6f72 6b65 7273 2d72 656c 6174 6564 2073  orkers-related s
-0000d320: 7461 7465 0a20 2020 2023 2323 2323 2323  tate.    #######
-0000d330: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d340: 0a0a 2020 2020 233a 2057 6f72 6b65 7273  ..    #: Workers
-0000d350: 2063 7572 7265 6e74 6c79 2063 6f6e 6e65   currently conne
-0000d360: 6374 6564 2074 6f20 7468 6520 7363 6865  cted to the sche
-0000d370: 6475 6c65 720a 2020 2020 233a 2028 6163  duler.    #: (ac
-0000d380: 7475 616c 6c79 2061 2053 6f72 7465 6444  tually a SortedD
-0000d390: 6963 742c 2062 7574 2074 6865 2073 6f72  ict, but the sor
-0000d3a0: 7465 6463 6f6e 7461 696e 6572 7320 7061  tedcontainers pa
-0000d3b0: 636b 6167 6520 6973 6e27 7420 616e 6e6f  ckage isn't anno
-0000d3c0: 7461 7465 6429 0a20 2020 2077 6f72 6b65  tated).    worke
-0000d3d0: 7273 3a20 6469 6374 5b73 7472 2c20 576f  rs: dict[str, Wo
-0000d3e0: 726b 6572 5374 6174 655d 0a20 2020 2023  rkerState].    #
-0000d3f0: 3a20 576f 726b 6572 207b 6e61 6d65 3a20  : Worker {name: 
-0000d400: 6164 6472 6573 737d 0a20 2020 2061 6c69  address}.    ali
-0000d410: 6173 6573 3a20 6469 6374 5b48 6173 6861  ases: dict[Hasha
-0000d420: 626c 652c 2073 7472 5d0a 2020 2020 233a  ble, str].    #:
-0000d430: 2057 6f72 6b65 7273 2074 6861 7420 6172   Workers that ar
-0000d440: 6520 6375 7272 656e 746c 7920 696e 2072  e currently in r
-0000d450: 756e 6e69 6e67 2073 7461 7465 0a20 2020  unning state.   
-0000d460: 2072 756e 6e69 6e67 3a20 7365 745b 576f   running: set[Wo
-0000d470: 726b 6572 5374 6174 655d 0a20 2020 2023  rkerState].    #
-0000d480: 3a20 576f 726b 6572 7320 7468 6174 2061  : Workers that a
-0000d490: 7265 2063 7572 7265 6e74 6c79 2069 6e20  re currently in 
-0000d4a0: 7275 6e6e 696e 6720 7374 6174 6520 616e  running state an
-0000d4b0: 6420 6e6f 7420 6675 6c6c 7920 7574 696c  d not fully util
-0000d4c0: 697a 6564 0a20 2020 2023 3a20 4465 6669  ized.    #: Defi
-0000d4d0: 6e69 7469 6f6e 2062 6173 6564 206f 6e20  nition based on 
-0000d4e0: 6f63 6375 7061 6e63 790a 2020 2020 233a  occupancy.    #:
-0000d4f0: 2028 6163 7475 616c 6c79 2061 2053 6f72   (actually a Sor
-0000d500: 7465 6444 6963 742c 2062 7574 2074 6865  tedDict, but the
-0000d510: 2073 6f72 7465 6463 6f6e 7461 696e 6572   sortedcontainer
-0000d520: 7320 7061 636b 6167 6520 6973 6e27 7420  s package isn't 
-0000d530: 616e 6e6f 7461 7465 6429 2e0a 2020 2020  annotated)..    
-0000d540: 233a 204e 6f74 2074 6f20 6265 2063 6f6e  #: Not to be con
-0000d550: 6675 7365 6420 7769 7468 203a 6d65 7468  fused with :meth
-0000d560: 3a60 6973 5f69 646c 6560 2e0a 2020 2020  :`is_idle`..    
-0000d570: 6964 6c65 3a20 6469 6374 5b73 7472 2c20  idle: dict[str, 
-0000d580: 576f 726b 6572 5374 6174 655d 0a20 2020  WorkerState].   
-0000d590: 2023 3a20 5369 6d69 6c61 7220 746f 2060   #: Similar to `
-0000d5a0: 6964 6c65 600a 2020 2020 233a 2044 6566  idle`.    #: Def
-0000d5b0: 696e 6974 696f 6e20 6261 7365 6420 6f6e  inition based on
-0000d5c0: 2061 7373 6967 6e65 6420 7461 736b 730a   assigned tasks.
-0000d5d0: 2020 2020 6964 6c65 5f74 6173 6b5f 636f      idle_task_co
-0000d5e0: 756e 743a 2073 6574 5b57 6f72 6b65 7253  unt: set[WorkerS
-0000d5f0: 7461 7465 5d0a 2020 2020 233a 2057 6f72  tate].    #: Wor
-0000d600: 6b65 7273 2074 6861 7420 6172 6520 6675  kers that are fu
-0000d610: 6c6c 7920 7574 696c 697a 6564 2e20 4d61  lly utilized. Ma
-0000d620: 7920 696e 636c 7564 6520 6e6f 6e2d 7275  y include non-ru
-0000d630: 6e6e 696e 6720 776f 726b 6572 732e 0a20  nning workers.. 
-0000d640: 2020 2073 6174 7572 6174 6564 3a20 7365     saturated: se
-0000d650: 745b 576f 726b 6572 5374 6174 655d 0a20  t[WorkerState]. 
-0000d660: 2020 2074 6f74 616c 5f6e 7468 7265 6164     total_nthread
-0000d670: 733a 2069 6e74 0a20 2020 2023 3a20 436c  s: int.    #: Cl
-0000d680: 7573 7465 722d 7769 6465 2072 6573 6f75  uster-wide resou
-0000d690: 7263 6573 2e20 7b72 6573 6f75 7263 6520  rces. {resource 
-0000d6a0: 6e61 6d65 3a20 7b77 6f72 6b65 7220 6164  name: {worker ad
-0000d6b0: 6472 6573 733a 2061 6d6f 756e 747d 7d0a  dress: amount}}.
-0000d6c0: 2020 2020 7265 736f 7572 6365 733a 2064      resources: d
-0000d6d0: 6963 745b 7374 722c 2064 6963 745b 7374  ict[str, dict[st
-0000d6e0: 722c 2066 6c6f 6174 5d5d 0a0a 2020 2020  r, float]]..    
-0000d6f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d700: 2323 2323 230a 2020 2020 2320 5461 736b  #####.    # Task
-0000d710: 732d 7265 6c61 7465 6420 7374 6174 650a  s-related state.
-0000d720: 2020 2020 2323 2323 2323 2323 2323 2323      ############
-0000d730: 2323 2323 2323 2323 230a 0a20 2020 2023  #########..    #
-0000d740: 3a20 546f 7461 6c20 6e75 6d62 6572 206f  : Total number o
-0000d750: 6620 7461 736b 7320 6576 6572 2070 726f  f tasks ever pro
-0000d760: 6365 7373 6564 0a20 2020 206e 5f74 6173  cessed.    n_tas
-0000d770: 6b73 3a20 696e 740a 0a20 2020 2023 3a20  ks: int..    #: 
-0000d780: 416c 6c20 7461 736b 7320 6375 7272 656e  All tasks curren
-0000d790: 746c 7920 6b6e 6f77 6e20 746f 2074 6865  tly known to the
-0000d7a0: 2073 6368 6564 756c 6572 0a20 2020 2074   scheduler.    t
-0000d7b0: 6173 6b73 3a20 6469 6374 5b73 7472 2c20  asks: dict[str, 
-0000d7c0: 5461 736b 5374 6174 655d 0a0a 2020 2020  TaskState]..    
-0000d7d0: 233a 2054 6173 6b73 2069 6e20 7468 6520  #: Tasks in the 
-0000d7e0: 2271 7565 7565 6422 2073 7461 7465 2c20  "queued" state, 
-0000d7f0: 6f72 6465 7265 6420 6279 2070 7269 6f72  ordered by prior
-0000d800: 6974 790a 2020 2020 7175 6575 6564 3a20  ity.    queued: 
-0000d810: 4865 6170 5365 745b 5461 736b 5374 6174  HeapSet[TaskStat
-0000d820: 655d 0a0a 2020 2020 233a 2054 6173 6b73  e]..    #: Tasks
-0000d830: 2069 6e20 7468 6520 226e 6f2d 776f 726b   in the "no-work
-0000d840: 6572 2220 7374 6174 650a 2020 2020 756e  er" state.    un
-0000d850: 7275 6e6e 6162 6c65 3a20 7365 745b 5461  runnable: set[Ta
-0000d860: 736b 5374 6174 655d 0a0a 2020 2020 233a  skState]..    #:
-0000d870: 2053 7562 7365 7420 6f66 2074 6173 6b73   Subset of tasks
-0000d880: 2074 6861 7420 6578 6973 7420 696e 206d   that exist in m
-0000d890: 656d 6f72 7920 6f6e 206d 6f72 6520 7468  emory on more th
-0000d8a0: 616e 206f 6e65 2077 6f72 6b65 720a 2020  an one worker.  
-0000d8b0: 2020 7265 706c 6963 6174 6564 5f74 6173    replicated_tas
-0000d8c0: 6b73 3a20 7365 745b 5461 736b 5374 6174  ks: set[TaskStat
-0000d8d0: 655d 0a0a 2020 2020 756e 6b6e 6f77 6e5f  e]..    unknown_
-0000d8e0: 6475 7261 7469 6f6e 733a 2064 6963 745b  durations: dict[
-0000d8f0: 7374 722c 2073 6574 5b54 6173 6b53 7461  str, set[TaskSta
-0000d900: 7465 5d5d 0a20 2020 2074 6173 6b5f 6772  te]].    task_gr
-0000d910: 6f75 7073 3a20 6469 6374 5b73 7472 2c20  oups: dict[str, 
-0000d920: 5461 736b 4772 6f75 705d 0a20 2020 2074  TaskGroup].    t
-0000d930: 6173 6b5f 7072 6566 6978 6573 3a20 6469  ask_prefixes: di
-0000d940: 6374 5b73 7472 2c20 5461 736b 5072 6566  ct[str, TaskPref
-0000d950: 6978 5d0a 2020 2020 7461 736b 5f6d 6574  ix].    task_met
-0000d960: 6164 6174 613a 2064 6963 745b 7374 722c  adata: dict[str,
-0000d970: 2041 6e79 5d0a 0a20 2020 2023 2323 2323   Any]..    #####
-0000d980: 2323 2323 0a20 2020 2023 2048 6973 746f  ####.    # Histo
-0000d990: 7279 0a20 2020 2023 2323 2323 2323 2323  ry.    #########
-0000d9a0: 0a0a 2020 2020 233a 2048 6973 746f 7279  ..    #: History
-0000d9b0: 206f 6620 636f 6d70 7574 6174 696f 6e73   of computations
-0000d9c0: 2e0a 2020 2020 233a 2054 6865 206c 656e  ..    #: The len
-0000d9d0: 6774 6820 6361 6e20 6265 2074 7765 616b  gth can be tweak
-0000d9e0: 6564 2074 6872 6f75 6768 0a20 2020 2023  ed through.    #
-0000d9f0: 3a20 6469 7374 7269 6275 7465 642e 6469  : distributed.di
-0000da00: 6167 6e6f 7374 6963 732e 636f 6d70 7574  agnostics.comput
-0000da10: 6174 696f 6e73 2e6d 6178 2d68 6973 746f  ations.max-histo
-0000da20: 7279 0a20 2020 2063 6f6d 7075 7461 7469  ry.    computati
-0000da30: 6f6e 733a 2064 6571 7565 5b43 6f6d 7075  ons: deque[Compu
-0000da40: 7461 7469 6f6e 5d0a 0a20 2020 2023 3a20  tation]..    #: 
-0000da50: 4869 7374 6f72 7920 6f66 2065 7272 6564  History of erred
-0000da60: 2074 6173 6b73 2e0a 2020 2020 233a 2054   tasks..    #: T
-0000da70: 6865 206c 656e 6774 6820 6361 6e20 6265  he length can be
-0000da80: 2074 7765 616b 6564 2074 6872 6f75 6768   tweaked through
-0000da90: 0a20 2020 2023 3a20 6469 7374 7269 6275  .    #: distribu
-0000daa0: 7465 642e 6469 6167 6e6f 7374 6963 732e  ted.diagnostics.
-0000dab0: 6572 7265 642d 7461 736b 732e 6d61 782d  erred-tasks.max-
-0000dac0: 6869 7374 6f72 790a 2020 2020 6572 7265  history.    erre
-0000dad0: 645f 7461 736b 733a 2064 6571 7565 5b45  d_tasks: deque[E
-0000dae0: 7272 6564 5461 736b 5d0a 0a20 2020 2023  rredTask]..    #
-0000daf0: 3a20 4869 7374 6f72 7920 6f66 2074 6173  : History of tas
-0000db00: 6b20 7374 6174 6520 7472 616e 7369 7469  k state transiti
-0000db10: 6f6e 732e 0a20 2020 2023 3a20 5468 6520  ons..    #: The 
-0000db20: 6c65 6e67 7468 2063 616e 2062 6520 7477  length can be tw
-0000db30: 6561 6b65 6420 7468 726f 7567 680a 2020  eaked through.  
-0000db40: 2020 233a 2064 6973 7472 6962 7574 6564    #: distributed
-0000db50: 2e73 6368 6564 756c 6572 2e74 7261 6e73  .scheduler.trans
-0000db60: 6974 696f 6e2d 6c6f 672d 6c65 6e67 7468  ition-log-length
-0000db70: 0a20 2020 2074 7261 6e73 6974 696f 6e5f  .    transition_
-0000db80: 6c6f 673a 2064 6571 7565 5b54 7261 6e73  log: deque[Trans
-0000db90: 6974 696f 6e5d 0a0a 2020 2020 233a 2054  ition]..    #: T
-0000dba0: 6f74 616c 206e 756d 6265 7220 6f66 2074  otal number of t
-0000dbb0: 7261 6e73 6974 696f 6e73 2073 696e 6365  ransitions since
-0000dbc0: 2074 6865 2063 6c75 7374 6572 2077 6173   the cluster was
-0000dbd0: 2073 7461 7274 6564 0a20 2020 2074 7261   started.    tra
-0000dbe0: 6e73 6974 696f 6e5f 636f 756e 7465 723a  nsition_counter:
-0000dbf0: 2069 6e74 0a0a 2020 2020 233a 2054 6f74   int..    #: Tot
-0000dc00: 616c 206e 756d 6265 7220 6f66 2074 7261  al number of tra
-0000dc10: 6e73 6974 696f 6e73 2061 7320 6f66 2074  nsitions as of t
-0000dc20: 6865 2070 7265 7669 6f75 7320 6361 6c6c  he previous call
-0000dc30: 2074 6f20 6368 6563 6b5f 6964 6c65 2829   to check_idle()
-0000dc40: 0a20 2020 205f 6964 6c65 5f74 7261 6e73  .    _idle_trans
-0000dc50: 6974 696f 6e5f 636f 756e 7465 723a 2069  ition_counter: i
-0000dc60: 6e74 0a0a 2020 2020 233a 2052 6169 7365  nt..    #: Raise
-0000dc70: 2061 6e20 6572 726f 7220 6966 2074 6865   an error if the
-0000dc80: 203a 6174 7472 3a60 7472 616e 7369 7469   :attr:`transiti
-0000dc90: 6f6e 5f63 6f75 6e74 6572 6020 6576 6572  on_counter` ever
-0000dca0: 2072 6561 6368 6573 2074 6869 7320 7661   reaches this va
-0000dcb0: 6c75 652e 0a20 2020 2023 3a20 5468 6973  lue..    #: This
-0000dcc0: 2069 7320 6d65 616e 7420 666f 7220 6465   is meant for de
-0000dcd0: 6275 6767 696e 6720 6f6e 6c79 2c20 746f  bugging only, to
-0000dce0: 2063 6174 6368 2069 6e66 696e 6974 6520   catch infinite 
-0000dcf0: 7265 6375 7273 696f 6e20 6c6f 6f70 732e  recursion loops.
-0000dd00: 0a20 2020 2023 3a20 496e 2070 726f 6475  .    #: In produ
-0000dd10: 6374 696f 6e2c 2069 7420 7368 6f75 6c64  ction, it should
-0000dd20: 2061 6c77 6179 7320 6265 2073 6574 2074   always be set t
-0000dd30: 6f20 4661 6c73 652e 0a20 2020 2074 7261  o False..    tra
-0000dd40: 6e73 6974 696f 6e5f 636f 756e 7465 725f  nsition_counter_
-0000dd50: 6d61 783a 2069 6e74 207c 204c 6974 6572  max: int | Liter
-0000dd60: 616c 5b46 616c 7365 5d0a 0a20 2020 205f  al[False]..    _
-0000dd70: 7461 736b 5f70 7265 6669 785f 636f 756e  task_prefix_coun
-0000dd80: 745f 676c 6f62 616c 3a20 6465 6661 756c  t_global: defaul
-0000dd90: 7464 6963 745b 7374 722c 2069 6e74 5d0a  tdict[str, int].
-0000dda0: 2020 2020 5f6e 6574 776f 726b 5f6f 6363      _network_occ
-0000ddb0: 5f67 6c6f 6261 6c3a 2066 6c6f 6174 0a20  _global: float. 
-0000ddc0: 2020 2023 2323 2323 2323 2323 2323 2323     #############
-0000ddd0: 2323 2323 2323 2323 230a 2020 2020 2320  #########.    # 
-0000dde0: 4361 6368 6564 2063 6f6e 6669 6775 7261  Cached configura
-0000ddf0: 7469 6f6e 0a20 2020 2023 2323 2323 2323  tion.    #######
-0000de00: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-0000de10: 0a20 2020 2023 3a20 6469 7374 7269 6275  .    #: distribu
-0000de20: 7465 642e 7363 6865 6475 6c65 722e 756e  ted.scheduler.un
-0000de30: 6b6e 6f77 6e2d 7461 736b 2d64 7572 6174  known-task-durat
-0000de40: 696f 6e0a 2020 2020 554e 4b4e 4f57 4e5f  ion.    UNKNOWN_
-0000de50: 5441 534b 5f44 5552 4154 494f 4e3a 2066  TASK_DURATION: f
-0000de60: 6c6f 6174 0a20 2020 2023 3a20 6469 7374  loat.    #: dist
-0000de70: 7269 6275 7465 642e 776f 726b 6572 2e6d  ributed.worker.m
-0000de80: 656d 6f72 792e 7265 6365 6e74 2d74 6f2d  emory.recent-to-
-0000de90: 6f6c 642d 7469 6d65 0a20 2020 204d 454d  old-time.    MEM
-0000dea0: 4f52 595f 5245 4345 4e54 5f54 4f5f 4f4c  ORY_RECENT_TO_OL
-0000deb0: 445f 5449 4d45 3a20 666c 6f61 740a 2020  D_TIME: float.  
-0000dec0: 2020 233a 2064 6973 7472 6962 7574 6564    #: distributed
-0000ded0: 2e77 6f72 6b65 722e 6d65 6d6f 7279 2e72  .worker.memory.r
-0000dee0: 6562 616c 616e 6365 2e6d 6561 7375 7265  ebalance.measure
-0000def0: 0a20 2020 204d 454d 4f52 595f 5245 4241  .    MEMORY_REBA
-0000df00: 4c41 4e43 455f 4d45 4153 5552 453a 2073  LANCE_MEASURE: s
-0000df10: 7472 0a20 2020 2023 3a20 6469 7374 7269  tr.    #: distri
-0000df20: 6275 7465 642e 776f 726b 6572 2e6d 656d  buted.worker.mem
-0000df30: 6f72 792e 7265 6261 6c61 6e63 652e 7365  ory.rebalance.se
-0000df40: 6e64 6572 2d6d 696e 0a20 2020 204d 454d  nder-min.    MEM
-0000df50: 4f52 595f 5245 4241 4c41 4e43 455f 5345  ORY_REBALANCE_SE
-0000df60: 4e44 4552 5f4d 494e 3a20 666c 6f61 740a  NDER_MIN: float.
-0000df70: 2020 2020 233a 2064 6973 7472 6962 7574      #: distribut
-0000df80: 6564 2e77 6f72 6b65 722e 6d65 6d6f 7279  ed.worker.memory
-0000df90: 2e72 6562 616c 616e 6365 2e72 6563 6970  .rebalance.recip
-0000dfa0: 6965 6e74 2d6d 6178 0a20 2020 204d 454d  ient-max.    MEM
-0000dfb0: 4f52 595f 5245 4241 4c41 4e43 455f 5245  ORY_REBALANCE_RE
-0000dfc0: 4349 5049 454e 545f 4d41 583a 2066 6c6f  CIPIENT_MAX: flo
-0000dfd0: 6174 0a20 2020 2023 3a20 6469 7374 7269  at.    #: distri
-0000dfe0: 6275 7465 642e 776f 726b 6572 2e6d 656d  buted.worker.mem
-0000dff0: 6f72 792e 7265 6261 6c61 6e63 652e 7365  ory.rebalance.se
-0000e000: 6e64 6572 2d72 6563 6970 6965 6e74 2d67  nder-recipient-g
-0000e010: 6170 202f 2032 0a20 2020 204d 454d 4f52  ap / 2.    MEMOR
-0000e020: 595f 5245 4241 4c41 4e43 455f 4841 4c46  Y_REBALANCE_HALF
-0000e030: 5f47 4150 3a20 666c 6f61 740a 2020 2020  _GAP: float.    
-0000e040: 233a 2064 6973 7472 6962 7574 6564 2e73  #: distributed.s
-0000e050: 6368 6564 756c 6572 2e77 6f72 6b65 722d  cheduler.worker-
-0000e060: 7361 7475 7261 7469 6f6e 0a20 2020 2057  saturation.    W
-0000e070: 4f52 4b45 525f 5341 5455 5241 5449 4f4e  ORKER_SATURATION
-0000e080: 3a20 666c 6f61 740a 0a20 2020 205f 5f73  : float..    __s
-0000e090: 6c6f 7473 5f5f 203d 2074 7570 6c65 285f  lots__ = tuple(_
-0000e0a0: 5f61 6e6e 6f74 6174 696f 6e73 5f5f 290a  _annotations__).
-0000e0b0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-0000e0c0: 5f28 0a20 2020 2020 2020 2073 656c 662c  _(.        self,
-0000e0d0: 0a20 2020 2020 2020 2061 6c69 6173 6573  .        aliases
-0000e0e0: 3a20 6469 6374 5b48 6173 6861 626c 652c  : dict[Hashable,
-0000e0f0: 2073 7472 5d2c 0a20 2020 2020 2020 2063   str],.        c
-0000e100: 6c69 656e 7473 3a20 6469 6374 5b73 7472  lients: dict[str
-0000e110: 2c20 436c 6965 6e74 5374 6174 655d 2c0a  , ClientState],.
-0000e120: 2020 2020 2020 2020 776f 726b 6572 733a          workers:
-0000e130: 2053 6f72 7465 6444 6963 745b 7374 722c   SortedDict[str,
-0000e140: 2057 6f72 6b65 7253 7461 7465 5d2c 0a20   WorkerState],. 
-0000e150: 2020 2020 2020 2068 6f73 745f 696e 666f         host_info
-0000e160: 3a20 6469 6374 5b73 7472 2c20 6469 6374  : dict[str, dict
-0000e170: 5b73 7472 2c20 416e 795d 5d2c 0a20 2020  [str, Any]],.   
-0000e180: 2020 2020 2072 6573 6f75 7263 6573 3a20       resources: 
-0000e190: 6469 6374 5b73 7472 2c20 6469 6374 5b73  dict[str, dict[s
-0000e1a0: 7472 2c20 666c 6f61 745d 5d2c 0a20 2020  tr, float]],.   
-0000e1b0: 2020 2020 2074 6173 6b73 3a20 6469 6374       tasks: dict
-0000e1c0: 5b73 7472 2c20 5461 736b 5374 6174 655d  [str, TaskState]
-0000e1d0: 2c0a 2020 2020 2020 2020 756e 7275 6e6e  ,.        unrunn
-0000e1e0: 6162 6c65 3a20 7365 745b 5461 736b 5374  able: set[TaskSt
-0000e1f0: 6174 655d 2c0a 2020 2020 2020 2020 7175  ate],.        qu
-0000e200: 6575 6564 3a20 4865 6170 5365 745b 5461  eued: HeapSet[Ta
-0000e210: 736b 5374 6174 655d 2c0a 2020 2020 2020  skState],.      
-0000e220: 2020 7661 6c69 6461 7465 3a20 626f 6f6c    validate: bool
-0000e230: 2c0a 2020 2020 2020 2020 706c 7567 696e  ,.        plugin
-0000e240: 733a 2049 7465 7261 626c 655b 5363 6865  s: Iterable[Sche
-0000e250: 6475 6c65 7250 6c75 6769 6e5d 203d 2028  dulerPlugin] = (
-0000e260: 292c 0a20 2020 2020 2020 2074 7261 6e73  ),.        trans
-0000e270: 6974 696f 6e5f 636f 756e 7465 725f 6d61  ition_counter_ma
-0000e280: 783a 2069 6e74 207c 204c 6974 6572 616c  x: int | Literal
-0000e290: 5b46 616c 7365 5d20 3d20 4661 6c73 652c  [False] = False,
-0000e2a0: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
-0000e2b0: 733a 2041 6e79 2c20 2023 2050 6173 7365  s: Any,  # Passe
-0000e2c0: 6420 7665 7262 6174 696d 2074 6f20 5365  d verbatim to Se
-0000e2d0: 7276 6572 2e5f 5f69 6e69 745f 5f28 290a  rver.__init__().
-0000e2e0: 2020 2020 293a 0a20 2020 2020 2020 206c      ):.        l
-0000e2f0: 6f67 6765 722e 696e 666f 2822 5374 6174  ogger.info("Stat
-0000e300: 6520 7374 6172 7422 290a 2020 2020 2020  e start").      
-0000e310: 2020 7365 6c66 2e61 6c69 6173 6573 203d    self.aliases =
-0000e320: 2061 6c69 6173 6573 0a20 2020 2020 2020   aliases.       
-0000e330: 2073 656c 662e 6261 6e64 7769 6474 6820   self.bandwidth 
-0000e340: 3d20 7061 7273 655f 6279 7465 7328 6461  = parse_bytes(da
-0000e350: 736b 2e63 6f6e 6669 672e 6765 7428 2264  sk.config.get("d
-0000e360: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
-0000e370: 756c 6572 2e62 616e 6477 6964 7468 2229  uler.bandwidth")
-0000e380: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
-0000e390: 6c69 656e 7473 203d 2063 6c69 656e 7473  lients = clients
-0000e3a0: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
-0000e3b0: 6965 6e74 735b 2266 6972 652d 616e 642d  ients["fire-and-
-0000e3c0: 666f 7267 6574 225d 203d 2043 6c69 656e  forget"] = Clien
-0000e3d0: 7453 7461 7465 2822 6669 7265 2d61 6e64  tState("fire-and
-0000e3e0: 2d66 6f72 6765 7422 290a 2020 2020 2020  -forget").      
-0000e3f0: 2020 7365 6c66 2e65 7874 656e 7369 6f6e    self.extension
-0000e400: 7320 3d20 7b7d 0a20 2020 2020 2020 2073  s = {}.        s
-0000e410: 656c 662e 686f 7374 5f69 6e66 6f20 3d20  elf.host_info = 
-0000e420: 686f 7374 5f69 6e66 6f0a 2020 2020 2020  host_info.      
-0000e430: 2020 7365 6c66 2e69 646c 6520 3d20 536f    self.idle = So
-0000e440: 7274 6564 4469 6374 2829 0a20 2020 2020  rtedDict().     
-0000e450: 2020 2073 656c 662e 6964 6c65 5f74 6173     self.idle_tas
-0000e460: 6b5f 636f 756e 7420 3d20 7365 7428 290a  k_count = set().
-0000e470: 2020 2020 2020 2020 7365 6c66 2e6e 5f74          self.n_t
-0000e480: 6173 6b73 203d 2030 0a20 2020 2020 2020  asks = 0.       
-0000e490: 2073 656c 662e 7265 736f 7572 6365 7320   self.resources 
-0000e4a0: 3d20 7265 736f 7572 6365 730a 2020 2020  = resources.    
-0000e4b0: 2020 2020 7365 6c66 2e73 6174 7572 6174      self.saturat
-0000e4c0: 6564 203d 2073 6574 2829 0a20 2020 2020  ed = set().     
-0000e4d0: 2020 2073 656c 662e 7461 736b 7320 3d20     self.tasks = 
-0000e4e0: 7461 736b 730a 2020 2020 2020 2020 7365  tasks.        se
-0000e4f0: 6c66 2e72 6570 6c69 6361 7465 645f 7461  lf.replicated_ta
-0000e500: 736b 7320 3d20 7b0a 2020 2020 2020 2020  sks = {.        
-0000e510: 2020 2020 7473 2066 6f72 2074 7320 696e      ts for ts in
-0000e520: 2073 656c 662e 7461 736b 732e 7661 6c75   self.tasks.valu
-0000e530: 6573 2829 2069 6620 6c65 6e28 7473 2e77  es() if len(ts.w
-0000e540: 686f 5f68 6173 2920 3e20 310a 2020 2020  ho_has) > 1.    
-0000e550: 2020 2020 7d0a 2020 2020 2020 2020 7365      }.        se
-0000e560: 6c66 2e63 6f6d 7075 7461 7469 6f6e 7320  lf.computations 
-0000e570: 3d20 6465 7175 6528 0a20 2020 2020 2020  = deque(.       
-0000e580: 2020 2020 206d 6178 6c65 6e3d 6461 736b       maxlen=dask
-0000e590: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
-0000e5a0: 7472 6962 7574 6564 2e64 6961 676e 6f73  tributed.diagnos
-0000e5b0: 7469 6373 2e63 6f6d 7075 7461 7469 6f6e  tics.computation
-0000e5c0: 732e 6d61 782d 6869 7374 6f72 7922 290a  s.max-history").
-0000e5d0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000e5e0: 2020 7365 6c66 2e65 7272 6564 5f74 6173    self.erred_tas
-0000e5f0: 6b73 203d 2064 6571 7565 280a 2020 2020  ks = deque(.    
-0000e600: 2020 2020 2020 2020 6d61 786c 656e 3d64          maxlen=d
-0000e610: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
-0000e620: 6469 7374 7269 6275 7465 642e 6469 6167  distributed.diag
-0000e630: 6e6f 7374 6963 732e 6572 7265 642d 7461  nostics.erred-ta
-0000e640: 736b 732e 6d61 782d 6869 7374 6f72 7922  sks.max-history"
-0000e650: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
-0000e660: 2020 2020 7365 6c66 2e74 6173 6b5f 6772      self.task_gr
-0000e670: 6f75 7073 203d 207b 7d0a 2020 2020 2020  oups = {}.      
-0000e680: 2020 7365 6c66 2e74 6173 6b5f 7072 6566    self.task_pref
-0000e690: 6978 6573 203d 207b 7d0a 2020 2020 2020  ixes = {}.      
-0000e6a0: 2020 7365 6c66 2e74 6173 6b5f 6d65 7461    self.task_meta
-0000e6b0: 6461 7461 203d 207b 7d0a 2020 2020 2020  data = {}.      
-0000e6c0: 2020 7365 6c66 2e74 6f74 616c 5f6e 7468    self.total_nth
-0000e6d0: 7265 6164 7320 3d20 300a 2020 2020 2020  reads = 0.      
-0000e6e0: 2020 7365 6c66 2e75 6e6b 6e6f 776e 5f64    self.unknown_d
-0000e6f0: 7572 6174 696f 6e73 203d 207b 7d0a 2020  urations = {}.  
-0000e700: 2020 2020 2020 7365 6c66 2e71 7565 7565        self.queue
-0000e710: 6420 3d20 7175 6575 6564 0a20 2020 2020  d = queued.     
-0000e720: 2020 2073 656c 662e 756e 7275 6e6e 6162     self.unrunnab
-0000e730: 6c65 203d 2075 6e72 756e 6e61 626c 650a  le = unrunnable.
-0000e740: 2020 2020 2020 2020 7365 6c66 2e76 616c          self.val
-0000e750: 6964 6174 6520 3d20 7661 6c69 6461 7465  idate = validate
-0000e760: 0a20 2020 2020 2020 2073 656c 662e 776f  .        self.wo
-0000e770: 726b 6572 7320 3d20 776f 726b 6572 730a  rkers = workers.
-0000e780: 2020 2020 2020 2020 7365 6c66 2e5f 7461          self._ta
-0000e790: 736b 5f70 7265 6669 785f 636f 756e 745f  sk_prefix_count_
-0000e7a0: 676c 6f62 616c 203d 2064 6566 6175 6c74  global = default
-0000e7b0: 6469 6374 2869 6e74 290a 2020 2020 2020  dict(int).      
-0000e7c0: 2020 7365 6c66 2e5f 6e65 7477 6f72 6b5f    self._network_
-0000e7d0: 6f63 635f 676c 6f62 616c 203d 2030 2e30  occ_global = 0.0
-0000e7e0: 0a20 2020 2020 2020 2073 656c 662e 7275  .        self.ru
-0000e7f0: 6e6e 696e 6720 3d20 7b0a 2020 2020 2020  nning = {.      
-0000e800: 2020 2020 2020 7773 2066 6f72 2077 7320        ws for ws 
-0000e810: 696e 2073 656c 662e 776f 726b 6572 732e  in self.workers.
-0000e820: 7661 6c75 6573 2829 2069 6620 7773 2e73  values() if ws.s
-0000e830: 7461 7475 7320 3d3d 2053 7461 7475 732e  tatus == Status.
-0000e840: 7275 6e6e 696e 670a 2020 2020 2020 2020  running.        
-0000e850: 7d0a 2020 2020 2020 2020 7365 6c66 2e70  }.        self.p
-0000e860: 6c75 6769 6e73 203d 207b 7d20 6966 206e  lugins = {} if n
-0000e870: 6f74 2070 6c75 6769 6e73 2065 6c73 6520  ot plugins else 
-0000e880: 7b5f 6765 745f 706c 7567 696e 5f6e 616d  {_get_plugin_nam
-0000e890: 6528 7029 3a20 7020 666f 7220 7020 696e  e(p): p for p in
-0000e8a0: 2070 6c75 6769 6e73 7d0a 0a20 2020 2020   plugins}..     
-0000e8b0: 2020 2073 656c 662e 7472 616e 7369 7469     self.transiti
-0000e8c0: 6f6e 5f6c 6f67 203d 2064 6571 7565 280a  on_log = deque(.
-0000e8d0: 2020 2020 2020 2020 2020 2020 6d61 786c              maxl
-0000e8e0: 656e 3d64 6173 6b2e 636f 6e66 6967 2e67  en=dask.config.g
-0000e8f0: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
-0000e900: 7363 6865 6475 6c65 722e 7472 616e 7369  scheduler.transi
-0000e910: 7469 6f6e 2d6c 6f67 2d6c 656e 6774 6822  tion-log-length"
-0000e920: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
-0000e930: 2020 2020 7365 6c66 2e74 7261 6e73 6974      self.transit
-0000e940: 696f 6e5f 636f 756e 7465 7220 3d20 300a  ion_counter = 0.
-0000e950: 2020 2020 2020 2020 7365 6c66 2e5f 6964          self._id
-0000e960: 6c65 5f74 7261 6e73 6974 696f 6e5f 636f  le_transition_co
-0000e970: 756e 7465 7220 3d20 300a 2020 2020 2020  unter = 0.      
-0000e980: 2020 7365 6c66 2e74 7261 6e73 6974 696f    self.transitio
-0000e990: 6e5f 636f 756e 7465 725f 6d61 7820 3d20  n_counter_max = 
-0000e9a0: 7472 616e 7369 7469 6f6e 5f63 6f75 6e74  transition_count
-0000e9b0: 6572 5f6d 6178 0a0a 2020 2020 2020 2020  er_max..        
-0000e9c0: 2320 5661 7269 6162 6c65 7320 6672 6f6d  # Variables from
-0000e9d0: 2064 6173 6b2e 636f 6e66 6967 2c20 6361   dask.config, ca
-0000e9e0: 6368 6564 2062 7920 5f5f 696e 6974 5f5f  ched by __init__
-0000e9f0: 2066 6f72 2070 6572 666f 726d 616e 6365   for performance
-0000ea00: 0a20 2020 2020 2020 2073 656c 662e 554e  .        self.UN
-0000ea10: 4b4e 4f57 4e5f 5441 534b 5f44 5552 4154  KNOWN_TASK_DURAT
-0000ea20: 494f 4e20 3d20 7061 7273 655f 7469 6d65  ION = parse_time
-0000ea30: 6465 6c74 6128 0a20 2020 2020 2020 2020  delta(.         
-0000ea40: 2020 2064 6173 6b2e 636f 6e66 6967 2e67     dask.config.g
-0000ea50: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
-0000ea60: 7363 6865 6475 6c65 722e 756e 6b6e 6f77  scheduler.unknow
-0000ea70: 6e2d 7461 736b 2d64 7572 6174 696f 6e22  n-task-duration"
-0000ea80: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
-0000ea90: 2020 2020 7365 6c66 2e4d 454d 4f52 595f      self.MEMORY_
-0000eaa0: 5245 4345 4e54 5f54 4f5f 4f4c 445f 5449  RECENT_TO_OLD_TI
-0000eab0: 4d45 203d 2070 6172 7365 5f74 696d 6564  ME = parse_timed
-0000eac0: 656c 7461 280a 2020 2020 2020 2020 2020  elta(.          
-0000ead0: 2020 6461 736b 2e63 6f6e 6669 672e 6765    dask.config.ge
-0000eae0: 7428 2264 6973 7472 6962 7574 6564 2e77  t("distributed.w
-0000eaf0: 6f72 6b65 722e 6d65 6d6f 7279 2e72 6563  orker.memory.rec
-0000eb00: 656e 742d 746f 2d6f 6c64 2d74 696d 6522  ent-to-old-time"
-0000eb10: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
-0000eb20: 2020 2020 7365 6c66 2e4d 454d 4f52 595f      self.MEMORY_
-0000eb30: 5245 4241 4c41 4e43 455f 4d45 4153 5552  REBALANCE_MEASUR
-0000eb40: 4520 3d20 6461 736b 2e63 6f6e 6669 672e  E = dask.config.
-0000eb50: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
-0000eb60: 2022 6469 7374 7269 6275 7465 642e 776f   "distributed.wo
-0000eb70: 726b 6572 2e6d 656d 6f72 792e 7265 6261  rker.memory.reba
-0000eb80: 6c61 6e63 652e 6d65 6173 7572 6522 0a20  lance.measure". 
-0000eb90: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000eba0: 2073 656c 662e 4d45 4d4f 5259 5f52 4542   self.MEMORY_REB
-0000ebb0: 414c 414e 4345 5f53 454e 4445 525f 4d49  ALANCE_SENDER_MI
-0000ebc0: 4e20 3d20 6461 736b 2e63 6f6e 6669 672e  N = dask.config.
-0000ebd0: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
-0000ebe0: 2022 6469 7374 7269 6275 7465 642e 776f   "distributed.wo
-0000ebf0: 726b 6572 2e6d 656d 6f72 792e 7265 6261  rker.memory.reba
-0000ec00: 6c61 6e63 652e 7365 6e64 6572 2d6d 696e  lance.sender-min
-0000ec10: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
-0000ec20: 2020 2020 7365 6c66 2e4d 454d 4f52 595f      self.MEMORY_
-0000ec30: 5245 4241 4c41 4e43 455f 5245 4349 5049  REBALANCE_RECIPI
-0000ec40: 454e 545f 4d41 5820 3d20 6461 736b 2e63  ENT_MAX = dask.c
-0000ec50: 6f6e 6669 672e 6765 7428 0a20 2020 2020  onfig.get(.     
-0000ec60: 2020 2020 2020 2022 6469 7374 7269 6275         "distribu
-0000ec70: 7465 642e 776f 726b 6572 2e6d 656d 6f72  ted.worker.memor
-0000ec80: 792e 7265 6261 6c61 6e63 652e 7265 6369  y.rebalance.reci
-0000ec90: 7069 656e 742d 6d61 7822 0a20 2020 2020  pient-max".     
-0000eca0: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
-0000ecb0: 662e 4d45 4d4f 5259 5f52 4542 414c 414e  f.MEMORY_REBALAN
-0000ecc0: 4345 5f48 414c 465f 4741 5020 3d20 280a  CE_HALF_GAP = (.
-0000ecd0: 2020 2020 2020 2020 2020 2020 6461 736b              dask
-0000ece0: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
-0000ecf0: 7472 6962 7574 6564 2e77 6f72 6b65 722e  tributed.worker.
-0000ed00: 6d65 6d6f 7279 2e72 6562 616c 616e 6365  memory.rebalance
-0000ed10: 2e73 656e 6465 722d 7265 6369 7069 656e  .sender-recipien
-0000ed20: 742d 6761 7022 290a 2020 2020 2020 2020  t-gap").        
-0000ed30: 2020 2020 2f20 322e 300a 2020 2020 2020      / 2.0.      
-0000ed40: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
-0000ed50: 662e 574f 524b 4552 5f53 4154 5552 4154  f.WORKER_SATURAT
-0000ed60: 494f 4e20 3d20 6461 736b 2e63 6f6e 6669  ION = dask.confi
-0000ed70: 672e 6765 7428 0a20 2020 2020 2020 2020  g.get(.         
-0000ed80: 2020 2022 6469 7374 7269 6275 7465 642e     "distributed.
-0000ed90: 7363 6865 6475 6c65 722e 776f 726b 6572  scheduler.worker
-0000eda0: 2d73 6174 7572 6174 696f 6e22 0a20 2020  -saturation".   
-0000edb0: 2020 2020 2029 0a20 2020 2020 2020 2069       ).        i
-0000edc0: 6620 7365 6c66 2e57 4f52 4b45 525f 5341  f self.WORKER_SA
-0000edd0: 5455 5241 5449 4f4e 203d 3d20 2269 6e66  TURATION == "inf
-0000ede0: 223a 0a20 2020 2020 2020 2020 2020 2023  ":.            #
-0000edf0: 2053 7065 6369 616c 2063 6173 6520 6e65   Special case ne
-0000ee00: 6365 7373 6172 7920 6265 6361 7573 6520  cessary because 
-0000ee10: 7468 6572 6527 7320 6e6f 2077 6179 2074  there's no way t
-0000ee20: 6f20 7061 7273 6520 6120 666c 6f61 7420  o parse a float 
-0000ee30: 696e 6669 6e69 7479 0a20 2020 2020 2020  infinity.       
-0000ee40: 2020 2020 2023 2066 726f 6d20 6120 4441       # from a DA
-0000ee50: 534b 5f2a 2065 6e76 6972 6f6e 6d65 6e74  SK_* environment
-0000ee60: 2076 6172 6961 626c 650a 2020 2020 2020   variable.      
-0000ee70: 2020 2020 2020 7365 6c66 2e57 4f52 4b45        self.WORKE
-0000ee80: 525f 5341 5455 5241 5449 4f4e 203d 206d  R_SATURATION = m
-0000ee90: 6174 682e 696e 660a 2020 2020 2020 2020  ath.inf.        
-0000eea0: 6966 2028 0a20 2020 2020 2020 2020 2020  if (.           
-0000eeb0: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
-0000eec0: 7365 6c66 2e57 4f52 4b45 525f 5341 5455  self.WORKER_SATU
-0000eed0: 5241 5449 4f4e 2c20 2869 6e74 2c20 666c  RATION, (int, fl
-0000eee0: 6f61 7429 290a 2020 2020 2020 2020 2020  oat)).          
-0000eef0: 2020 6f72 2073 656c 662e 574f 524b 4552    or self.WORKER
-0000ef00: 5f53 4154 5552 4154 494f 4e20 3c3d 2030  _SATURATION <= 0
-0000ef10: 0a20 2020 2020 2020 2029 3a0a 2020 2020  .        ):.    
-0000ef20: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-0000ef30: 6c75 6545 7272 6f72 2820 2023 2070 7261  lueError(  # pra
-0000ef40: 676d 613a 206e 6f63 6f76 6572 0a20 2020  gma: nocover.   
-0000ef50: 2020 2020 2020 2020 2020 2020 2022 6064               "`d
-0000ef60: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
-0000ef70: 756c 6572 2e77 6f72 6b65 722d 7361 7475  uler.worker-satu
-0000ef80: 7261 7469 6f6e 6020 6d75 7374 2062 6520  ration` must be 
-0000ef90: 6120 666c 6f61 7420 3e20 303b 2067 6f74  a float > 0; got
-0000efa0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-0000efb0: 2020 202b 2072 6570 7228 7365 6c66 2e57     + repr(self.W
-0000efc0: 4f52 4b45 525f 5341 5455 5241 5449 4f4e  ORKER_SATURATION
-0000efd0: 290a 2020 2020 2020 2020 2020 2020 290a  ).            ).
-0000efe0: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-0000eff0: 2020 2064 6566 206d 656d 6f72 7928 7365     def memory(se
-0000f000: 6c66 2920 2d3e 204d 656d 6f72 7953 7461  lf) -> MemorySta
-0000f010: 7465 3a0a 2020 2020 2020 2020 7265 7475  te:.        retu
-0000f020: 726e 204d 656d 6f72 7953 7461 7465 2e73  rn MemoryState.s
-0000f030: 756d 282a 2877 2e6d 656d 6f72 7920 666f  um(*(w.memory fo
-0000f040: 7220 7720 696e 2073 656c 662e 776f 726b  r w in self.work
-0000f050: 6572 732e 7661 6c75 6573 2829 2929 0a0a  ers.values()))..
-0000f060: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-0000f070: 2020 6465 6620 5f5f 7064 6963 745f 5f28    def __pdict__(
-0000f080: 7365 6c66 2920 2d3e 2064 6963 745b 7374  self) -> dict[st
-0000f090: 722c 2041 6e79 5d3a 0a20 2020 2020 2020  r, Any]:.       
-0000f0a0: 2072 6574 7572 6e20 7b0a 2020 2020 2020   return {.      
-0000f0b0: 2020 2020 2020 2262 616e 6477 6964 7468        "bandwidth
-0000f0c0: 223a 2073 656c 662e 6261 6e64 7769 6474  ": self.bandwidt
-0000f0d0: 682c 0a20 2020 2020 2020 2020 2020 2022  h,.            "
-0000f0e0: 7265 736f 7572 6365 7322 3a20 7365 6c66  resources": self
-0000f0f0: 2e72 6573 6f75 7263 6573 2c0a 2020 2020  .resources,.    
-0000f100: 2020 2020 2020 2020 2273 6174 7572 6174          "saturat
-0000f110: 6564 223a 2073 656c 662e 7361 7475 7261  ed": self.satura
-0000f120: 7465 642c 0a20 2020 2020 2020 2020 2020  ted,.           
-0000f130: 2022 756e 7275 6e6e 6162 6c65 223a 2073   "unrunnable": s
-0000f140: 656c 662e 756e 7275 6e6e 6162 6c65 2c0a  elf.unrunnable,.
-0000f150: 2020 2020 2020 2020 2020 2020 2271 7565              "que
-0000f160: 7565 6422 3a20 7365 6c66 2e71 7565 7565  ued": self.queue
-0000f170: 642c 0a20 2020 2020 2020 2020 2020 2022  d,.            "
-0000f180: 6e5f 7461 736b 7322 3a20 7365 6c66 2e6e  n_tasks": self.n
-0000f190: 5f74 6173 6b73 2c0a 2020 2020 2020 2020  _tasks,.        
-0000f1a0: 2020 2020 2275 6e6b 6e6f 776e 5f64 7572      "unknown_dur
-0000f1b0: 6174 696f 6e73 223a 2073 656c 662e 756e  ations": self.un
-0000f1c0: 6b6e 6f77 6e5f 6475 7261 7469 6f6e 732c  known_durations,
-0000f1d0: 0a20 2020 2020 2020 2020 2020 2022 7661  .            "va
-0000f1e0: 6c69 6461 7465 223a 2073 656c 662e 7661  lidate": self.va
-0000f1f0: 6c69 6461 7465 2c0a 2020 2020 2020 2020  lidate,.        
-0000f200: 2020 2020 2274 6173 6b73 223a 2073 656c      "tasks": sel
-0000f210: 662e 7461 736b 732c 0a20 2020 2020 2020  f.tasks,.       
-0000f220: 2020 2020 2022 7461 736b 5f67 726f 7570       "task_group
-0000f230: 7322 3a20 7365 6c66 2e74 6173 6b5f 6772  s": self.task_gr
-0000f240: 6f75 7073 2c0a 2020 2020 2020 2020 2020  oups,.          
-0000f250: 2020 2274 6173 6b5f 7072 6566 6978 6573    "task_prefixes
-0000f260: 223a 2073 656c 662e 7461 736b 5f70 7265  ": self.task_pre
-0000f270: 6669 7865 732c 0a20 2020 2020 2020 2020  fixes,.         
-0000f280: 2020 2022 746f 7461 6c5f 6e74 6872 6561     "total_nthrea
-0000f290: 6473 223a 2073 656c 662e 746f 7461 6c5f  ds": self.total_
-0000f2a0: 6e74 6872 6561 6473 2c0a 2020 2020 2020  nthreads,.      
-0000f2b0: 2020 2020 2020 2274 6f74 616c 5f6f 6363        "total_occ
-0000f2c0: 7570 616e 6379 223a 2073 656c 662e 746f  upancy": self.to
-0000f2d0: 7461 6c5f 6f63 6375 7061 6e63 792c 0a20  tal_occupancy,. 
-0000f2e0: 2020 2020 2020 2020 2020 2022 6572 7265             "erre
-0000f2f0: 645f 7461 736b 7322 3a20 7365 6c66 2e65  d_tasks": self.e
-0000f300: 7272 6564 5f74 6173 6b73 2c0a 2020 2020  rred_tasks,.    
-0000f310: 2020 2020 2020 2020 2265 7874 656e 7369          "extensi
-0000f320: 6f6e 7322 3a20 7365 6c66 2e65 7874 656e  ons": self.exten
-0000f330: 7369 6f6e 732c 0a20 2020 2020 2020 2020  sions,.         
-0000f340: 2020 2022 636c 6965 6e74 7322 3a20 7365     "clients": se
-0000f350: 6c66 2e63 6c69 656e 7473 2c0a 2020 2020  lf.clients,.    
-0000f360: 2020 2020 2020 2020 2277 6f72 6b65 7273          "workers
-0000f370: 223a 2073 656c 662e 776f 726b 6572 732c  ": self.workers,
-0000f380: 0a20 2020 2020 2020 2020 2020 2022 6964  .            "id
-0000f390: 6c65 223a 2073 656c 662e 6964 6c65 2c0a  le": self.idle,.
-0000f3a0: 2020 2020 2020 2020 2020 2020 2268 6f73              "hos
-0000f3b0: 745f 696e 666f 223a 2073 656c 662e 686f  t_info": self.ho
-0000f3c0: 7374 5f69 6e66 6f2c 0a20 2020 2020 2020  st_info,.       
-0000f3d0: 207d 0a0a 2020 2020 6465 6620 6e65 775f   }..    def new_
-0000f3e0: 7461 736b 280a 2020 2020 2020 2020 7365  task(.        se
-0000f3f0: 6c66 2c0a 2020 2020 2020 2020 6b65 793a  lf,.        key:
-0000f400: 2073 7472 2c0a 2020 2020 2020 2020 7370   str,.        sp
-0000f410: 6563 3a20 6f62 6a65 6374 2c0a 2020 2020  ec: object,.    
-0000f420: 2020 2020 7374 6174 653a 2054 6173 6b53      state: TaskS
-0000f430: 7461 7465 5374 6174 652c 0a20 2020 2020  tateState,.     
-0000f440: 2020 2063 6f6d 7075 7461 7469 6f6e 3a20     computation: 
-0000f450: 436f 6d70 7574 6174 696f 6e20 7c20 4e6f  Computation | No
-0000f460: 6e65 203d 204e 6f6e 652c 0a20 2020 2029  ne = None,.    )
-0000f470: 202d 3e20 5461 736b 5374 6174 653a 0a20   -> TaskState:. 
-0000f480: 2020 2020 2020 2022 2222 4372 6561 7465         """Create
-0000f490: 2061 206e 6577 2074 6173 6b2c 2061 6e64   a new task, and
-0000f4a0: 2061 7373 6f63 6961 7465 6420 7374 6174   associated stat
-0000f4b0: 6573 2222 220a 2020 2020 2020 2020 7473  es""".        ts
-0000f4c0: 203d 2054 6173 6b53 7461 7465 286b 6579   = TaskState(key
-0000f4d0: 2c20 7370 6563 2c20 7374 6174 6529 0a0a  , spec, state)..
-0000f4e0: 2020 2020 2020 2020 7072 6566 6978 5f6b          prefix_k
-0000f4f0: 6579 203d 206b 6579 5f73 706c 6974 286b  ey = key_split(k
-0000f500: 6579 290a 2020 2020 2020 2020 7470 203d  ey).        tp =
-0000f510: 2073 656c 662e 7461 736b 5f70 7265 6669   self.task_prefi
-0000f520: 7865 732e 6765 7428 7072 6566 6978 5f6b  xes.get(prefix_k
-0000f530: 6579 290a 2020 2020 2020 2020 6966 2074  ey).        if t
-0000f540: 7020 6973 204e 6f6e 653a 0a20 2020 2020  p is None:.     
-0000f550: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
-0000f560: 5f70 7265 6669 7865 735b 7072 6566 6978  _prefixes[prefix
-0000f570: 5f6b 6579 5d20 3d20 7470 203d 2054 6173  _key] = tp = Tas
-0000f580: 6b50 7265 6669 7828 7072 6566 6978 5f6b  kPrefix(prefix_k
-0000f590: 6579 290a 2020 2020 2020 2020 7473 2e70  ey).        ts.p
-0000f5a0: 7265 6669 7820 3d20 7470 0a0a 2020 2020  refix = tp..    
-0000f5b0: 2020 2020 6772 6f75 705f 6b65 7920 3d20      group_key = 
-0000f5c0: 7473 2e67 726f 7570 5f6b 6579 0a20 2020  ts.group_key.   
-0000f5d0: 2020 2020 2074 6720 3d20 7365 6c66 2e74       tg = self.t
-0000f5e0: 6173 6b5f 6772 6f75 7073 2e67 6574 2867  ask_groups.get(g
-0000f5f0: 726f 7570 5f6b 6579 290a 2020 2020 2020  roup_key).      
-0000f600: 2020 6966 2074 6720 6973 204e 6f6e 653a    if tg is None:
-0000f610: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000f620: 662e 7461 736b 5f67 726f 7570 735b 6772  f.task_groups[gr
-0000f630: 6f75 705f 6b65 795d 203d 2074 6720 3d20  oup_key] = tg = 
-0000f640: 5461 736b 4772 6f75 7028 6772 6f75 705f  TaskGroup(group_
-0000f650: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
-0000f660: 2069 6620 636f 6d70 7574 6174 696f 6e3a   if computation:
-0000f670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f680: 2063 6f6d 7075 7461 7469 6f6e 2e67 726f   computation.gro
-0000f690: 7570 732e 6164 6428 7467 290a 2020 2020  ups.add(tg).    
-0000f6a0: 2020 2020 2020 2020 7467 2e70 7265 6669          tg.prefi
-0000f6b0: 7820 3d20 7470 0a20 2020 2020 2020 2020  x = tp.         
-0000f6c0: 2020 2074 702e 6772 6f75 7073 2e61 7070     tp.groups.app
-0000f6d0: 656e 6428 7467 290a 2020 2020 2020 2020  end(tg).        
-0000f6e0: 7467 2e61 6464 2874 7329 0a0a 2020 2020  tg.add(ts)..    
-0000f6f0: 2020 2020 7365 6c66 2e74 6173 6b73 5b6b      self.tasks[k
-0000f700: 6579 5d20 3d20 7473 0a0a 2020 2020 2020  ey] = ts..      
-0000f710: 2020 7265 7475 726e 2074 730a 0a20 2020    return ts..   
-0000f720: 2064 6566 205f 636c 6561 725f 7461 736b   def _clear_task
-0000f730: 5f73 7461 7465 2873 656c 6629 202d 3e20  _state(self) -> 
-0000f740: 4e6f 6e65 3a0a 2020 2020 2020 2020 6c6f  None:.        lo
-0000f750: 6767 6572 2e64 6562 7567 2822 436c 6561  gger.debug("Clea
-0000f760: 7220 7461 736b 2073 7461 7465 2229 0a20  r task state"). 
-0000f770: 2020 2020 2020 2066 6f72 2063 6f6c 6c65         for colle
-0000f780: 6374 696f 6e20 696e 2028 0a20 2020 2020  ction in (.     
-0000f790: 2020 2020 2020 2073 656c 662e 756e 7275         self.unru
-0000f7a0: 6e6e 6162 6c65 2c0a 2020 2020 2020 2020  nnable,.        
-0000f7b0: 2020 2020 7365 6c66 2e65 7272 6564 5f74      self.erred_t
-0000f7c0: 6173 6b73 2c0a 2020 2020 2020 2020 2020  asks,.          
-0000f7d0: 2020 7365 6c66 2e63 6f6d 7075 7461 7469    self.computati
-0000f7e0: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
-0000f7f0: 2073 656c 662e 7461 736b 5f70 7265 6669   self.task_prefi
-0000f800: 7865 732c 0a20 2020 2020 2020 2020 2020  xes,.           
-0000f810: 2073 656c 662e 7461 736b 5f67 726f 7570   self.task_group
-0000f820: 732c 0a20 2020 2020 2020 2020 2020 2073  s,.            s
-0000f830: 656c 662e 7461 736b 5f6d 6574 6164 6174  elf.task_metadat
-0000f840: 612c 0a20 2020 2020 2020 2020 2020 2073  a,.            s
-0000f850: 656c 662e 756e 6b6e 6f77 6e5f 6475 7261  elf.unknown_dura
-0000f860: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
-0000f870: 2020 2073 656c 662e 7265 706c 6963 6174     self.replicat
-0000f880: 6564 5f74 6173 6b73 2c0a 2020 2020 2020  ed_tasks,.      
-0000f890: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-0000f8a0: 2063 6f6c 6c65 6374 696f 6e2e 636c 6561   collection.clea
-0000f8b0: 7228 2920 2023 2074 7970 653a 2069 676e  r()  # type: ign
-0000f8c0: 6f72 650a 0a20 2020 2040 7072 6f70 6572  ore..    @proper
-0000f8d0: 7479 0a20 2020 2064 6566 2069 735f 6964  ty.    def is_id
-0000f8e0: 6c65 2873 656c 6629 202d 3e20 626f 6f6c  le(self) -> bool
-0000f8f0: 3a0a 2020 2020 2020 2020 2222 2252 6574  :.        """Ret
-0000f900: 7572 6e20 5472 7565 2069 6666 2074 6865  urn True iff the
-0000f910: 7265 2061 7265 206e 6f20 7461 736b 7320  re are no tasks 
-0000f920: 7468 6174 2068 6176 656e 2774 2066 696e  that haven't fin
-0000f930: 6973 6865 6420 636f 6d70 7574 696e 672e  ished computing.
-0000f940: 0a0a 2020 2020 2020 2020 556e 6c69 6b65  ..        Unlike
-0000f950: 2074 6573 7469 6e67 2060 6073 656c 662e   testing ``self.
-0000f960: 746f 7461 6c5f 6f63 6375 7061 6e63 7960  total_occupancy`
-0000f970: 602c 2074 6869 7320 7072 6f70 6572 7479  `, this property
-0000f980: 2072 6574 7572 6e73 2046 616c 7365 2069   returns False i
-0000f990: 6620 7468 6572 650a 2020 2020 2020 2020  f there.        
-0000f9a0: 6172 6520 6c6f 6e67 2d72 756e 6e69 6e67  are long-running
-0000f9b0: 2074 6173 6b73 2c20 6e6f 2d77 6f72 6b65   tasks, no-worke
-0000f9c0: 722c 206f 7220 7175 6575 6564 2074 6173  r, or queued tas
-0000f9d0: 6b73 2028 6475 6520 746f 206e 6f74 2068  ks (due to not h
-0000f9e0: 6176 696e 6720 616e 790a 2020 2020 2020  aving any.      
-0000f9f0: 2020 776f 726b 6572 7329 2e0a 0a20 2020    workers)...   
-0000fa00: 2020 2020 204e 6f74 2074 6f20 6265 2063       Not to be c
-0000fa10: 6f6e 6675 7365 6420 7769 7468 2060 6069  onfused with ``i
-0000fa20: 646c 6560 602e 0a20 2020 2020 2020 2022  dle``..        "
-0000fa30: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
-0000fa40: 6e20 616c 6c28 7467 2e64 6f6e 6520 666f  n all(tg.done fo
-0000fa50: 7220 7467 2069 6e20 7365 6c66 2e74 6173  r tg in self.tas
-0000fa60: 6b5f 6772 6f75 7073 2e76 616c 7565 7328  k_groups.values(
-0000fa70: 2929 0a0a 2020 2020 4070 726f 7065 7274  ))..    @propert
-0000fa80: 790a 2020 2020 6465 6620 746f 7461 6c5f  y.    def total_
-0000fa90: 6f63 6375 7061 6e63 7928 7365 6c66 2920  occupancy(self) 
-0000faa0: 2d3e 2066 6c6f 6174 3a0a 2020 2020 2020  -> float:.      
-0000fab0: 2020 7265 7475 726e 2073 656c 662e 5f63    return self._c
-0000fac0: 616c 635f 6f63 6375 7061 6e63 7928 0a20  alc_occupancy(. 
-0000fad0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000fae0: 5f74 6173 6b5f 7072 6566 6978 5f63 6f75  _task_prefix_cou
-0000faf0: 6e74 5f67 6c6f 6261 6c2c 0a20 2020 2020  nt_global,.     
-0000fb00: 2020 2020 2020 2073 656c 662e 5f6e 6574         self._net
-0000fb10: 776f 726b 5f6f 6363 5f67 6c6f 6261 6c2c  work_occ_global,
-0000fb20: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-0000fb30: 6465 6620 5f63 616c 635f 6f63 6375 7061  def _calc_occupa
-0000fb40: 6e63 7928 0a20 2020 2020 2020 2073 656c  ncy(.        sel
-0000fb50: 662c 0a20 2020 2020 2020 2074 6173 6b5f  f,.        task_
-0000fb60: 7072 6566 6978 5f63 6f75 6e74 3a20 6469  prefix_count: di
-0000fb70: 6374 5b73 7472 2c20 696e 745d 2c0a 2020  ct[str, int],.  
-0000fb80: 2020 2020 2020 6e65 7477 6f72 6b5f 6f63        network_oc
-0000fb90: 633a 2066 6c6f 6174 2c0a 2020 2020 2920  c: float,.    ) 
-0000fba0: 2d3e 2066 6c6f 6174 3a0a 2020 2020 2020  -> float:.      
-0000fbb0: 2020 7265 7320 3d20 302e 300a 2020 2020    res = 0.0.    
-0000fbc0: 2020 2020 666f 7220 7072 6566 6978 5f6e      for prefix_n
-0000fbd0: 616d 652c 2063 6f75 6e74 2069 6e20 7461  ame, count in ta
-0000fbe0: 736b 5f70 7265 6669 785f 636f 756e 742e  sk_prefix_count.
-0000fbf0: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-0000fc00: 2020 2020 2023 2054 4f44 4f3a 2044 6561       # TODO: Dea
-0000fc10: 6c20 7769 7468 2075 6e6b 6e6f 776e 2074  l with unknown t
-0000fc20: 6173 6b73 2062 6574 7465 720a 2020 2020  asks better.    
-0000fc30: 2020 2020 2020 2020 7072 6566 6978 203d          prefix =
-0000fc40: 2073 656c 662e 7461 736b 5f70 7265 6669   self.task_prefi
-0000fc50: 7865 735b 7072 6566 6978 5f6e 616d 655d  xes[prefix_name]
-0000fc60: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0000fc70: 6572 7420 7072 6566 6978 2069 7320 6e6f  ert prefix is no
-0000fc80: 7420 4e6f 6e65 0a20 2020 2020 2020 2020  t None.         
-0000fc90: 2020 2064 7572 6174 696f 6e20 3d20 7072     duration = pr
-0000fca0: 6566 6978 2e64 7572 6174 696f 6e5f 6176  efix.duration_av
-0000fcb0: 6572 6167 650a 2020 2020 2020 2020 2020  erage.          
-0000fcc0: 2020 6966 2064 7572 6174 696f 6e20 3c20    if duration < 
-0000fcd0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-0000fce0: 2020 2069 6620 7072 6566 6978 2e6d 6178     if prefix.max
-0000fcf0: 5f65 7865 635f 7469 6d65 203e 2030 3a0a  _exec_time > 0:.
-0000fd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fd10: 2020 2020 6475 7261 7469 6f6e 203d 2032      duration = 2
-0000fd20: 202a 2070 7265 6669 782e 6d61 785f 6578   * prefix.max_ex
-0000fd30: 6563 5f74 696d 650a 2020 2020 2020 2020  ec_time.        
-0000fd40: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000fd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fd60: 2020 6475 7261 7469 6f6e 203d 2073 656c    duration = sel
-0000fd70: 662e 554e 4b4e 4f57 4e5f 5441 534b 5f44  f.UNKNOWN_TASK_D
-0000fd80: 5552 4154 494f 4e0a 2020 2020 2020 2020  URATION.        
-0000fd90: 2020 2020 7265 7320 2b3d 2064 7572 6174      res += durat
-0000fda0: 696f 6e20 2a20 636f 756e 740a 2020 2020  ion * count.    
-0000fdb0: 2020 2020 6f63 6320 3d20 7265 7320 2b20      occ = res + 
-0000fdc0: 6e65 7477 6f72 6b5f 6f63 6320 2f20 7365  network_occ / se
-0000fdd0: 6c66 2e62 616e 6477 6964 7468 0a20 2020  lf.bandwidth.   
-0000fde0: 2020 2020 2061 7373 6572 7420 6f63 6320       assert occ 
-0000fdf0: 3e3d 2030 2c20 6f63 630a 2020 2020 2020  >= 0, occ.      
-0000fe00: 2020 7265 7475 726e 206f 6363 0a0a 2020    return occ..  
-0000fe10: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
-0000fe20: 2323 2323 2323 230a 2020 2020 2320 5374  #######.    # St
-0000fe30: 6174 6520 5472 616e 7369 7469 6f6e 7320  ate Transitions 
-0000fe40: 230a 2020 2020 2323 2323 2323 2323 2323  #.    ##########
-0000fe50: 2323 2323 2323 2323 2323 230a 0a20 2020  ###########..   
-0000fe60: 2064 6566 205f 7472 616e 7369 7469 6f6e   def _transition
-0000fe70: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
-0000fe80: 6b65 793a 2073 7472 2c20 6669 6e69 7368  key: str, finish
-0000fe90: 3a20 5461 736b 5374 6174 6553 7461 7465  : TaskStateState
-0000fea0: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
-0000feb0: 7472 2c20 2a2a 6b77 6172 6773 3a20 416e  tr, **kwargs: An
-0000fec0: 790a 2020 2020 2920 2d3e 2052 6563 734d  y.    ) -> RecsM
-0000fed0: 7367 733a 0a20 2020 2020 2020 2022 2222  sgs:.        """
-0000fee0: 5472 616e 7369 7469 6f6e 2061 206b 6579  Transition a key
-0000fef0: 2066 726f 6d20 6974 7320 6375 7272 656e   from its curren
-0000ff00: 7420 7374 6174 6520 746f 2074 6865 2066  t state to the f
-0000ff10: 696e 6973 6820 7374 6174 650a 0a20 2020  inish state..   
-0000ff20: 2020 2020 2045 7861 6d70 6c65 730a 2020       Examples.  
-0000ff30: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
-0000ff40: 2020 2020 2020 203e 3e3e 2073 656c 662e         >>> self.
-0000ff50: 5f74 7261 6e73 6974 696f 6e28 2778 272c  _transition('x',
-0000ff60: 2027 7761 6974 696e 6727 290a 2020 2020   'waiting').    
-0000ff70: 2020 2020 7b27 7827 3a20 2770 726f 6365      {'x': 'proce
-0000ff80: 7373 696e 6727 7d2c 207b 7d2c 207b 7d0a  ssing'}, {}, {}.
-0000ff90: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-0000ffa0: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-0000ffb0: 0a20 2020 2020 2020 2054 7570 6c65 206f  .        Tuple o
-0000ffc0: 663a 0a0a 2020 2020 2020 2020 2d20 4469  f:..        - Di
-0000ffd0: 6374 696f 6e61 7279 206f 6620 7265 636f  ctionary of reco
-0000ffe0: 6d6d 656e 6461 7469 6f6e 7320 666f 7220  mmendations for 
-0000fff0: 6675 7475 7265 2074 7261 6e73 6974 696f  future transitio
-00010000: 6e73 207b 6b65 793a 206e 6577 2073 7461  ns {key: new sta
-00010010: 7465 7d0a 2020 2020 2020 2020 2d20 4d65  te}.        - Me
-00010020: 7373 6167 6573 2074 6f20 636c 6965 6e74  ssages to client
-00010030: 7320 7b63 6c69 656e 7420 6164 6472 6573  s {client addres
-00010040: 733a 205b 6d73 672c 206d 7367 2c20 2e2e  s: [msg, msg, ..
-00010050: 2e5d 7d0a 2020 2020 2020 2020 2d20 4d65  .]}.        - Me
-00010060: 7373 6167 6573 2074 6f20 776f 726b 6572  ssages to worker
-00010070: 7320 7b77 6f72 6b65 7220 6164 6472 6573  s {worker addres
-00010080: 733a 205b 6d73 672c 206d 7367 2c20 2e2e  s: [msg, msg, ..
-00010090: 2e5d 7d0a 0a20 2020 2020 2020 2053 6565  .]}..        See
-000100a0: 2041 6c73 6f0a 2020 2020 2020 2020 2d2d   Also.        --
-000100b0: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2053  ------.        S
-000100c0: 6368 6564 756c 6572 2e74 7261 6e73 6974  cheduler.transit
-000100d0: 696f 6e73 203a 2074 7261 6e73 6974 6976  ions : transitiv
-000100e0: 6520 7665 7273 696f 6e20 6f66 2074 6869  e version of thi
-000100f0: 7320 6675 6e63 7469 6f6e 0a20 2020 2020  s function.     
-00010100: 2020 2022 2222 0a20 2020 2020 2020 2074     """.        t
-00010110: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00010120: 7473 203d 2073 656c 662e 7461 736b 732e  ts = self.tasks.
-00010130: 6765 7428 6b65 7929 0a20 2020 2020 2020  get(key).       
-00010140: 2020 2020 2069 6620 7473 2069 7320 4e6f       if ts is No
-00010150: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00010160: 2020 2020 7265 7475 726e 207b 7d2c 207b      return {}, {
-00010170: 7d2c 207b 7d0a 2020 2020 2020 2020 2020  }, {}.          
-00010180: 2020 7374 6172 7420 3d20 7473 2e5f 7374    start = ts._st
-00010190: 6174 650a 2020 2020 2020 2020 2020 2020  ate.            
-000101a0: 6966 2073 7461 7274 203d 3d20 6669 6e69  if start == fini
-000101b0: 7368 3a0a 2020 2020 2020 2020 2020 2020  sh:.            
-000101c0: 2020 2020 7265 7475 726e 207b 7d2c 207b      return {}, {
-000101d0: 7d2c 207b 7d0a 0a20 2020 2020 2020 2020  }, {}..         
-000101e0: 2020 2023 204e 6f74 6573 3a0a 2020 2020     # Notes:.    
-000101f0: 2020 2020 2020 2020 2320 2d20 696e 2063          # - in c
-00010200: 6173 6520 6f66 2074 7261 6e73 6974 696f  ase of transitio
-00010210: 6e20 7468 726f 7567 6820 7265 6c65 6173  n through releas
-00010220: 6564 2c20 7468 6973 2063 6f75 6e74 6572  ed, this counter
-00010230: 2069 7320 696e 6372 656d 656e 7465 6420   is incremented 
-00010240: 6279 2032 0a20 2020 2020 2020 2020 2020  by 2.           
-00010250: 2023 202d 2074 6869 7320 696e 6372 6561   # - this increa
-00010260: 7365 2068 6170 7065 6e73 2062 6566 6f72  se happens befor
-00010270: 6520 7468 6520 6163 7475 616c 2074 7261  e the actual tra
-00010280: 6e73 6974 696f 6e73 2c20 736f 2074 6861  nsitions, so tha
-00010290: 7420 6974 2063 616e 0a20 2020 2020 2020  t it can.       
-000102a0: 2020 2020 2023 2020 2063 6174 6368 2070       #   catch p
-000102b0: 6f74 656e 7469 616c 2069 6e66 696e 6974  otential infinit
-000102c0: 6520 7265 6375 7273 696f 6e73 0a20 2020  e recursions.   
-000102d0: 2020 2020 2020 2020 2073 656c 662e 7472           self.tr
-000102e0: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
-000102f0: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
-00010300: 2020 6966 2073 656c 662e 7472 616e 7369    if self.transi
-00010310: 7469 6f6e 5f63 6f75 6e74 6572 5f6d 6178  tion_counter_max
-00010320: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00010330: 2020 6173 7365 7274 2073 656c 662e 7472    assert self.tr
-00010340: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
-00010350: 203c 2073 656c 662e 7472 616e 7369 7469   < self.transiti
-00010360: 6f6e 5f63 6f75 6e74 6572 5f6d 6178 0a0a  on_counter_max..
-00010370: 2020 2020 2020 2020 2020 2020 7265 636f              reco
-00010380: 6d6d 656e 6461 7469 6f6e 733a 2064 6963  mmendations: dic
-00010390: 7420 3d20 7b7d 0a20 2020 2020 2020 2020  t = {}.         
-000103a0: 2020 2077 6f72 6b65 725f 6d73 6773 3a20     worker_msgs: 
-000103b0: 6469 6374 203d 207b 7d0a 2020 2020 2020  dict = {}.      
-000103c0: 2020 2020 2020 636c 6965 6e74 5f6d 7367        client_msg
-000103d0: 733a 2064 6963 7420 3d20 7b7d 0a0a 2020  s: dict = {}..  
-000103e0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-000103f0: 662e 706c 7567 696e 733a 0a20 2020 2020  f.plugins:.     
-00010400: 2020 2020 2020 2020 2020 2064 6570 656e             depen
-00010410: 6465 6e74 7320 3d20 7365 7428 7473 2e64  dents = set(ts.d
-00010420: 6570 656e 6465 6e74 7329 0a20 2020 2020  ependents).     
-00010430: 2020 2020 2020 2020 2020 2064 6570 656e             depen
-00010440: 6465 6e63 6965 7320 3d20 7365 7428 7473  dencies = set(ts
-00010450: 2e64 6570 656e 6465 6e63 6965 7329 0a0a  .dependencies)..
-00010460: 2020 2020 2020 2020 2020 2020 6675 6e63              func
-00010470: 203d 2073 656c 662e 5f54 5241 4e53 4954   = self._TRANSIT
-00010480: 494f 4e53 5f54 4142 4c45 2e67 6574 2828  IONS_TABLE.get((
-00010490: 7374 6172 742c 2066 696e 6973 6829 290a  start, finish)).
-000104a0: 2020 2020 2020 2020 2020 2020 6966 2066              if f
-000104b0: 756e 6320 6973 206e 6f74 204e 6f6e 653a  unc is not None:
-000104c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000104d0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-000104e0: 2c20 636c 6965 6e74 5f6d 7367 732c 2077  , client_msgs, w
-000104f0: 6f72 6b65 725f 6d73 6773 203d 2066 756e  orker_msgs = fun
-00010500: 6328 0a20 2020 2020 2020 2020 2020 2020  c(.             
-00010510: 2020 2020 2020 2073 656c 662c 206b 6579         self, key
-00010520: 2c20 7374 696d 756c 7573 5f69 642c 202a  , stimulus_id, *
-00010530: 2a6b 7761 7267 730a 2020 2020 2020 2020  *kwargs.        
-00010540: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00010550: 2020 2020 2020 2065 6c69 6620 2272 656c         elif "rel
-00010560: 6561 7365 6422 206e 6f74 2069 6e20 2873  eased" not in (s
-00010570: 7461 7274 2c20 6669 6e69 7368 293a 0a20  tart, finish):. 
-00010580: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00010590: 7373 6572 7420 6e6f 7420 6b77 6172 6773  ssert not kwargs
-000105a0: 2c20 286b 7761 7267 732c 2073 7461 7274  , (kwargs, start
-000105b0: 2c20 6669 6e69 7368 290a 2020 2020 2020  , finish).      
-000105c0: 2020 2020 2020 2020 2020 615f 7265 6373            a_recs
-000105d0: 2c20 615f 636d 7367 732c 2061 5f77 6d73  , a_cmsgs, a_wms
-000105e0: 6773 203d 2073 656c 662e 5f74 7261 6e73  gs = self._trans
-000105f0: 6974 696f 6e28 0a20 2020 2020 2020 2020  ition(.         
-00010600: 2020 2020 2020 2020 2020 206b 6579 2c20             key, 
-00010610: 2272 656c 6561 7365 6422 2c20 7374 696d  "released", stim
-00010620: 756c 7573 5f69 640a 2020 2020 2020 2020  ulus_id.        
-00010630: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00010640: 2020 2020 2020 2020 2020 2076 203d 2061             v = a
-00010650: 5f72 6563 732e 6765 7428 6b65 792c 2066  _recs.get(key, f
-00010660: 696e 6973 6829 0a20 2020 2020 2020 2020  inish).         
-00010670: 2020 2020 2020 2066 756e 6320 3d20 7365         func = se
-00010680: 6c66 2e5f 5452 414e 5349 5449 4f4e 535f  lf._TRANSITIONS_
-00010690: 5441 424c 455b 2272 656c 6561 7365 6422  TABLE["released"
-000106a0: 2c20 765d 0a20 2020 2020 2020 2020 2020  , v].           
-000106b0: 2020 2020 2062 5f72 6563 732c 2062 5f63       b_recs, b_c
-000106c0: 6d73 6773 2c20 625f 776d 7367 7320 3d20  msgs, b_wmsgs = 
-000106d0: 6675 6e63 2873 656c 662c 206b 6579 2c20  func(self, key, 
-000106e0: 7374 696d 756c 7573 5f69 6429 0a0a 2020  stimulus_id)..  
-000106f0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00010700: 636f 6d6d 656e 6461 7469 6f6e 732e 7570  commendations.up
-00010710: 6461 7465 2861 5f72 6563 7329 0a20 2020  date(a_recs).   
-00010720: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00010730: 2063 2c20 6e65 775f 6d73 6773 2069 6e20   c, new_msgs in 
-00010740: 615f 636d 7367 732e 6974 656d 7328 293a  a_cmsgs.items():
-00010750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010760: 2020 2020 2063 6c69 656e 745f 6d73 6773       client_msgs
-00010770: 2e73 6574 6465 6661 756c 7428 632c 205b  .setdefault(c, [
-00010780: 5d29 2e65 7874 656e 6428 6e65 775f 6d73  ]).extend(new_ms
-00010790: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
-000107a0: 2020 2020 666f 7220 772c 206e 6577 5f6d      for w, new_m
-000107b0: 7367 7320 696e 2061 5f77 6d73 6773 2e69  sgs in a_wmsgs.i
-000107c0: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
-000107d0: 2020 2020 2020 2020 2020 2020 776f 726b              work
-000107e0: 6572 5f6d 7367 732e 7365 7464 6566 6175  er_msgs.setdefau
-000107f0: 6c74 2877 2c20 5b5d 292e 6578 7465 6e64  lt(w, []).extend
-00010800: 286e 6577 5f6d 7367 7329 0a0a 2020 2020  (new_msgs)..    
-00010810: 2020 2020 2020 2020 2020 2020 7265 636f              reco
-00010820: 6d6d 656e 6461 7469 6f6e 732e 7570 6461  mmendations.upda
-00010830: 7465 2862 5f72 6563 7329 0a20 2020 2020  te(b_recs).     
-00010840: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
-00010850: 2c20 6e65 775f 6d73 6773 2069 6e20 625f  , new_msgs in b_
-00010860: 636d 7367 732e 6974 656d 7328 293a 0a20  cmsgs.items():. 
-00010870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010880: 2020 2063 6c69 656e 745f 6d73 6773 2e73     client_msgs.s
-00010890: 6574 6465 6661 756c 7428 632c 205b 5d29  etdefault(c, [])
-000108a0: 2e65 7874 656e 6428 6e65 775f 6d73 6773  .extend(new_msgs
-000108b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000108c0: 2020 666f 7220 772c 206e 6577 5f6d 7367    for w, new_msg
-000108d0: 7320 696e 2062 5f77 6d73 6773 2e69 7465  s in b_wmsgs.ite
-000108e0: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-000108f0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-00010900: 5f6d 7367 732e 7365 7464 6566 6175 6c74  _msgs.setdefault
-00010910: 2877 2c20 5b5d 292e 6578 7465 6e64 286e  (w, []).extend(n
-00010920: 6577 5f6d 7367 7329 0a0a 2020 2020 2020  ew_msgs)..      
-00010930: 2020 2020 2020 2020 2020 7374 6172 7420            start 
-00010940: 3d20 2272 656c 6561 7365 6422 0a20 2020  = "released".   
-00010950: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00010960: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00010970: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
-00010980: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-00010990: 2020 2020 2020 2066 2249 6d70 6f73 7369         f"Impossi
-000109a0: 626c 6520 7472 616e 7369 7469 6f6e 2066  ble transition f
-000109b0: 726f 6d20 7b73 7461 7274 7d20 746f 207b  rom {start} to {
-000109c0: 6669 6e69 7368 7d20 666f 7220 7b6b 6579  finish} for {key
-000109d0: 2172 7d3a 2022 0a20 2020 2020 2020 2020  !r}: ".         
-000109e0: 2020 2020 2020 2020 2020 2066 227b 7374             f"{st
-000109f0: 696d 756c 7573 5f69 643d 7d2c 207b 6b77  imulus_id=}, {kw
-00010a00: 6172 6773 3d7d 2c20 7374 6f72 793d 7b73  args=}, story={s
-00010a10: 656c 662e 7374 6f72 7928 7473 297d 220a  elf.story(ts)}".
-00010a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010a30: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
-00010a40: 6620 6e6f 7420 7374 696d 756c 7573 5f69  f not stimulus_i
-00010a50: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
-00010a60: 2020 2073 7469 6d75 6c75 735f 6964 203d     stimulus_id =
-00010a70: 2053 5449 4d55 4c55 535f 4944 5f55 4e53   STIMULUS_ID_UNS
-00010a80: 4554 0a0a 2020 2020 2020 2020 2020 2020  ET..            
-00010a90: 6163 7475 616c 5f66 696e 6973 6820 3d20  actual_finish = 
-00010aa0: 7473 2e5f 7374 6174 650a 2020 2020 2020  ts._state.      
-00010ab0: 2020 2020 2020 7365 6c66 2e74 7261 6e73        self.trans
-00010ac0: 6974 696f 6e5f 6c6f 672e 6170 7065 6e64  ition_log.append
-00010ad0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00010ae0: 2020 5472 616e 7369 7469 6f6e 280a 2020    Transition(.  
-00010af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010b00: 2020 6b65 792c 2073 7461 7274 2c20 6163    key, start, ac
-00010b10: 7475 616c 5f66 696e 6973 682c 2072 6563  tual_finish, rec
-00010b20: 6f6d 6d65 6e64 6174 696f 6e73 2c20 7374  ommendations, st
-00010b30: 696d 756c 7573 5f69 642c 2074 696d 6528  imulus_id, time(
-00010b40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00010b50: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00010b60: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00010b70: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
-00010b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010b90: 6966 2073 7469 6d75 6c75 735f 6964 203d  if stimulus_id =
-00010ba0: 3d20 5354 494d 554c 5553 5f49 445f 554e  = STIMULUS_ID_UN
-00010bb0: 5345 543a 0a20 2020 2020 2020 2020 2020  SET:.           
-00010bc0: 2020 2020 2020 2020 2072 6169 7365 2052           raise R
-00010bd0: 756e 7469 6d65 4572 726f 7228 0a20 2020  untimeError(.   
-00010be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010bf0: 2020 2020 2022 7374 696d 756c 7573 5f69       "stimulus_i
-00010c00: 6420 6e6f 7420 7365 7420 6475 7269 6e67  d not set during
-00010c10: 2053 6368 6564 756c 6572 2074 7261 6e73   Scheduler trans
-00010c20: 6974 696f 6e22 0a20 2020 2020 2020 2020  ition".         
-00010c30: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00010c40: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-00010c50: 6765 722e 6465 6275 6728 0a20 2020 2020  ger.debug(.     
-00010c60: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00010c70: 5472 616e 7369 7469 6f6e 6564 2025 7220  Transitioned %r 
-00010c80: 2573 2d3e 2573 2028 6163 7475 616c 3a20  %s->%s (actual: 
-00010c90: 2573 292e 2020 436f 6e73 6571 7565 6e63  %s).  Consequenc
-00010ca0: 653a 2025 7322 2c0a 2020 2020 2020 2020  e: %s",.        
-00010cb0: 2020 2020 2020 2020 2020 2020 6b65 792c              key,
-00010cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010cd0: 2020 2020 2073 7461 7274 2c0a 2020 2020       start,.    
-00010ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010cf0: 6669 6e69 7368 2c0a 2020 2020 2020 2020  finish,.        
-00010d00: 2020 2020 2020 2020 2020 2020 6163 7475              actu
-00010d10: 616c 5f66 696e 6973 682c 0a20 2020 2020  al_finish,.     
-00010d20: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00010d30: 6963 7428 7265 636f 6d6d 656e 6461 7469  ict(recommendati
-00010d40: 6f6e 7329 2c0a 2020 2020 2020 2020 2020  ons),.          
-00010d50: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00010d60: 2020 2020 6966 2073 656c 662e 706c 7567      if self.plug
-00010d70: 696e 733a 0a20 2020 2020 2020 2020 2020  ins:.           
-00010d80: 2020 2020 2023 2054 656d 706f 7261 7269       # Temporari
-00010d90: 6c79 2070 7574 2062 6163 6b20 666f 7267  ly put back forg
-00010da0: 6f74 7465 6e20 6b65 7920 666f 7220 706c  otten key for pl
-00010db0: 7567 696e 2074 6f20 7265 7472 6965 7665  ugin to retrieve
-00010dc0: 2069 740a 2020 2020 2020 2020 2020 2020   it.            
-00010dd0: 2020 2020 6966 2074 732e 5f73 7461 7465      if ts._state
-00010de0: 203d 3d20 2266 6f72 676f 7474 656e 223a   == "forgotten":
-00010df0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010e00: 2020 2020 2074 732e 6465 7065 6e64 656e       ts.dependen
-00010e10: 7473 203d 2064 6570 656e 6465 6e74 730a  ts = dependents.
+00006f60: 4445 5052 4543 4154 4544 3a20 706c 6561  DEPRECATED: plea
+00006f70: 7365 2075 7365 2073 7061 6e73 2069 6e73  se use spans ins
+00006f80: 7465 6164 0a0a 2020 2020 5365 6520 616c  tead..    See al
+00006f90: 736f 0a20 2020 202d 2d2d 2d2d 2d2d 2d0a  so.    --------.
+00006fa0: 2020 2020 5461 736b 5072 6566 6978 0a20      TaskPrefix. 
+00006fb0: 2020 2054 6173 6b47 726f 7570 0a20 2020     TaskGroup.   
+00006fc0: 2054 6173 6b53 7461 7465 0a20 2020 2022   TaskState.    "
+00006fd0: 2222 0a0a 2020 2020 7374 6172 743a 2066  ""..    start: f
+00006fe0: 6c6f 6174 0a20 2020 2067 726f 7570 733a  loat.    groups:
+00006ff0: 2073 6574 5b54 6173 6b47 726f 7570 5d0a   set[TaskGroup].
+00007000: 2020 2020 636f 6465 3a20 536f 7274 6564      code: Sorted
+00007010: 5365 745b 7475 706c 655b 536f 7572 6365  Set[tuple[Source
+00007020: 436f 6465 2c20 2e2e 2e5d 5d0a 2020 2020  Code, ...]].    
+00007030: 6964 3a20 7575 6964 2e55 5549 440a 2020  id: uuid.UUID.  
+00007040: 2020 616e 6e6f 7461 7469 6f6e 733a 2064    annotations: d
+00007050: 6963 740a 0a20 2020 205f 5f73 6c6f 7473  ict..    __slots
+00007060: 5f5f 203d 2074 7570 6c65 285f 5f61 6e6e  __ = tuple(__ann
+00007070: 6f74 6174 696f 6e73 5f5f 290a 0a20 2020  otations__)..   
+00007080: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+00007090: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+000070a0: 662e 7374 6172 7420 3d20 7469 6d65 2829  f.start = time()
+000070b0: 0a20 2020 2020 2020 2073 656c 662e 6772  .        self.gr
+000070c0: 6f75 7073 203d 2073 6574 2829 0a20 2020  oups = set().   
+000070d0: 2020 2020 2073 656c 662e 636f 6465 203d       self.code =
+000070e0: 2053 6f72 7465 6453 6574 2829 0a20 2020   SortedSet().   
+000070f0: 2020 2020 2073 656c 662e 6964 203d 2075       self.id = u
+00007100: 7569 642e 7575 6964 3428 290a 2020 2020  uid.uuid4().    
+00007110: 2020 2020 7365 6c66 2e61 6e6e 6f74 6174      self.annotat
+00007120: 696f 6e73 203d 207b 7d0a 0a20 2020 2040  ions = {}..    @
+00007130: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+00007140: 2073 746f 7028 7365 6c66 2920 2d3e 2066   stop(self) -> f
+00007150: 6c6f 6174 3a0a 2020 2020 2020 2020 6966  loat:.        if
+00007160: 2073 656c 662e 6772 6f75 7073 3a0a 2020   self.groups:.  
+00007170: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00007180: 206d 6178 2874 672e 7374 6f70 2066 6f72   max(tg.stop for
+00007190: 2074 6720 696e 2073 656c 662e 6772 6f75   tg in self.grou
+000071a0: 7073 290a 2020 2020 2020 2020 656c 7365  ps).        else
+000071b0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+000071c0: 7475 726e 202d 310a 0a20 2020 2040 7072  turn -1..    @pr
+000071d0: 6f70 6572 7479 0a20 2020 2064 6566 2073  operty.    def s
+000071e0: 7461 7465 7328 7365 6c66 2920 2d3e 2064  tates(self) -> d
+000071f0: 6963 745b 5461 736b 5374 6174 6553 7461  ict[TaskStateSta
+00007200: 7465 2c20 696e 745d 3a0a 2020 2020 2020  te, int]:.      
+00007210: 2020 7265 7475 726e 206d 6572 6765 5f77    return merge_w
+00007220: 6974 6828 7375 6d2c 2028 7467 2e73 7461  ith(sum, (tg.sta
+00007230: 7465 7320 666f 7220 7467 2069 6e20 7365  tes for tg in se
+00007240: 6c66 2e67 726f 7570 7329 290a 0a20 2020  lf.groups))..   
+00007250: 2064 6566 205f 5f72 6570 725f 5f28 7365   def __repr__(se
+00007260: 6c66 2920 2d3e 2073 7472 3a0a 2020 2020  lf) -> str:.    
+00007270: 2020 2020 7265 7475 726e 2028 0a20 2020      return (.   
+00007280: 2020 2020 2020 2020 2066 223c 436f 6d70           f"<Comp
+00007290: 7574 6174 696f 6e20 7b73 656c 662e 6964  utation {self.id
+000072a0: 7d3a 2022 0a20 2020 2020 2020 2020 2020  }: ".           
+000072b0: 202b 2022 5461 736b 733a 2022 0a20 2020   + "Tasks: ".   
+000072c0: 2020 2020 2020 2020 202b 2022 2c20 222e           + ", ".
+000072d0: 6a6f 696e 280a 2020 2020 2020 2020 2020  join(.          
+000072e0: 2020 2020 2020 2225 733a 2025 6422 2025        "%s: %d" %
+000072f0: 2028 6b2c 2076 2920 666f 7220 286b 2c20   (k, v) for (k, 
+00007300: 7629 2069 6e20 736f 7274 6564 2873 656c  v) in sorted(sel
+00007310: 662e 7374 6174 6573 2e69 7465 6d73 2829  f.states.items()
+00007320: 2920 6966 2076 0a20 2020 2020 2020 2020  ) if v.         
+00007330: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00007340: 202b 2022 3e22 0a20 2020 2020 2020 2029   + ">".        )
+00007350: 0a0a 2020 2020 6465 6620 5f72 6570 725f  ..    def _repr_
+00007360: 6874 6d6c 5f28 7365 6c66 2920 2d3e 2073  html_(self) -> s
+00007370: 7472 3a0a 2020 2020 2020 2020 7265 7475  tr:.        retu
+00007380: 726e 2067 6574 5f74 656d 706c 6174 6528  rn get_template(
+00007390: 2263 6f6d 7075 7461 7469 6f6e 2e68 746d  "computation.htm
+000073a0: 6c2e 6a32 2229 2e72 656e 6465 7228 0a20  l.j2").render(. 
+000073b0: 2020 2020 2020 2020 2020 2069 643d 7365             id=se
+000073c0: 6c66 2e69 642c 0a20 2020 2020 2020 2020  lf.id,.         
+000073d0: 2020 2073 7461 7274 3d73 656c 662e 7374     start=self.st
+000073e0: 6172 742c 0a20 2020 2020 2020 2020 2020  art,.           
+000073f0: 2073 746f 703d 7365 6c66 2e73 746f 702c   stop=self.stop,
+00007400: 0a20 2020 2020 2020 2020 2020 2067 726f  .            gro
+00007410: 7570 733d 7365 6c66 2e67 726f 7570 732c  ups=self.groups,
+00007420: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
+00007430: 7465 733d 7365 6c66 2e73 7461 7465 732c  tes=self.states,
+00007440: 0a20 2020 2020 2020 2020 2020 2063 6f64  .            cod
+00007450: 653d 7365 6c66 2e63 6f64 652c 0a20 2020  e=self.code,.   
+00007460: 2020 2020 2029 0a0a 0a63 6c61 7373 2054       )...class T
+00007470: 6173 6b50 7265 6669 783a 0a20 2020 2022  askPrefix:.    "
+00007480: 2222 436f 6c6c 6563 7469 6f6e 2074 7261  ""Collection tra
+00007490: 636b 696e 6720 616c 6c20 7461 736b 7320  cking all tasks 
+000074a0: 7769 7468 696e 2061 2067 726f 7570 0a0a  within a group..
+000074b0: 2020 2020 4b65 7973 206f 6674 656e 2068      Keys often h
+000074c0: 6176 6520 6120 7374 7275 6374 7572 6520  ave a structure 
+000074d0: 6c69 6b65 2060 6028 2278 2d31 3233 222c  like ``("x-123",
+000074e0: 2030 2960 600a 2020 2020 4120 6772 6f75   0)``.    A grou
+000074f0: 7020 7461 6b65 7320 7468 6520 6669 7273  p takes the firs
+00007500: 7420 7365 6374 696f 6e2c 206c 696b 6520  t section, like 
+00007510: 6060 2278 2260 600a 0a20 2020 2053 6565  ``"x"``..    See
+00007520: 2041 6c73 6f0a 2020 2020 2d2d 2d2d 2d2d   Also.    ------
+00007530: 2d2d 0a20 2020 2054 6173 6b47 726f 7570  --.    TaskGroup
+00007540: 0a20 2020 2022 2222 0a0a 2020 2020 233a  .    """..    #:
+00007550: 2054 6865 206e 616d 6520 6f66 2061 2067   The name of a g
+00007560: 726f 7570 206f 6620 7461 736b 732e 0a20  roup of tasks.. 
+00007570: 2020 2023 3a20 466f 7220 6120 7461 736b     #: For a task
+00007580: 206c 696b 6520 6060 2822 782d 3132 3322   like ``("x-123"
+00007590: 2c20 3029 6060 2074 6869 7320 6973 2074  , 0)`` this is t
+000075a0: 6865 2074 6578 7420 6060 2278 2260 600a  he text ``"x"``.
+000075b0: 2020 2020 6e61 6d65 3a20 7374 720a 0a20      name: str.. 
+000075c0: 2020 2023 3a20 416e 2065 7870 6f6e 656e     #: An exponen
+000075d0: 7469 616c 6c79 2077 6569 6768 7465 6420  tially weighted 
+000075e0: 6d6f 7669 6e67 2061 7665 7261 6765 2064  moving average d
+000075f0: 7572 6174 696f 6e20 6f66 2061 6c6c 2074  uration of all t
+00007600: 6173 6b73 2077 6974 6820 7468 6973 2070  asks with this p
+00007610: 7265 6669 780a 2020 2020 6475 7261 7469  refix.    durati
+00007620: 6f6e 5f61 7665 7261 6765 3a20 666c 6f61  on_average: floa
+00007630: 740a 0a20 2020 2023 3a20 4e75 6d62 6572  t..    #: Number
+00007640: 7320 6f66 2074 696d 6573 2061 2074 6173  s of times a tas
+00007650: 6b20 7761 7320 6d61 726b 6564 2061 7320  k was marked as 
+00007660: 7375 7370 6963 696f 7573 2077 6974 6820  suspicious with 
+00007670: 7468 6973 2070 7265 6669 780a 2020 2020  this prefix.    
+00007680: 7375 7370 6963 696f 7573 3a20 696e 740a  suspicious: int.
+00007690: 0a20 2020 2023 3a20 5374 6f72 6520 7469  .    #: Store ti
+000076a0: 6d69 6e67 7320 666f 7220 6561 6368 2070  mings for each p
+000076b0: 7265 6669 782d 6163 7469 6f6e 0a20 2020  refix-action.   
+000076c0: 2061 6c6c 5f64 7572 6174 696f 6e73 3a20   all_durations: 
+000076d0: 6465 6661 756c 7464 6963 745b 7374 722c  defaultdict[str,
+000076e0: 2066 6c6f 6174 5d0a 0a20 2020 2023 3a20   float]..    #: 
+000076f0: 5468 6973 206d 6561 7375 7265 7320 7468  This measures th
+00007700: 6520 6d61 7869 6d75 6d20 7265 636f 7264  e maximum record
+00007710: 6564 206c 6976 6520 6578 6563 7574 696f  ed live executio
+00007720: 6e20 7469 6d65 2061 6e64 2063 616e 2062  n time and can b
+00007730: 6520 7573 6564 2074 6f0a 2020 2020 233a  e used to.    #:
+00007740: 2064 6574 6563 7420 6f75 746c 6965 7273   detect outliers
+00007750: 0a20 2020 206d 6178 5f65 7865 635f 7469  .    max_exec_ti
+00007760: 6d65 3a20 666c 6f61 740a 0a20 2020 2023  me: float..    #
+00007770: 3a20 5461 736b 2067 726f 7570 7320 6173  : Task groups as
+00007780: 736f 6369 6174 6564 2074 6f20 7468 6973  sociated to this
+00007790: 2070 7265 6669 780a 2020 2020 6772 6f75   prefix.    grou
+000077a0: 7073 3a20 6c69 7374 5b54 6173 6b47 726f  ps: list[TaskGro
+000077b0: 7570 5d0a 0a20 2020 2023 3a20 4163 6375  up]..    #: Accu
+000077c0: 6d75 6c61 7465 2063 6f75 6e74 206f 6620  mulate count of 
+000077d0: 6e75 6d62 6572 206f 6620 7461 736b 7320  number of tasks 
+000077e0: 696e 2065 6163 6820 7374 6174 650a 2020  in each state.  
+000077f0: 2020 7374 6174 655f 636f 756e 7473 3a20    state_counts: 
+00007800: 6465 6661 756c 7464 6963 745b 5461 736b  defaultdict[Task
+00007810: 5374 6174 6553 7461 7465 2c20 696e 745d  StateState, int]
+00007820: 0a0a 2020 2020 5f5f 736c 6f74 735f 5f20  ..    __slots__ 
+00007830: 3d20 7475 706c 6528 5f5f 616e 6e6f 7461  = tuple(__annota
+00007840: 7469 6f6e 735f 5f29 0a0a 2020 2020 6465  tions__)..    de
+00007850: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+00007860: 206e 616d 653a 2073 7472 293a 0a20 2020   name: str):.   
+00007870: 2020 2020 2073 656c 662e 6e61 6d65 203d       self.name =
+00007880: 206e 616d 650a 2020 2020 2020 2020 7365   name.        se
+00007890: 6c66 2e67 726f 7570 7320 3d20 5b5d 0a20  lf.groups = []. 
+000078a0: 2020 2020 2020 2073 656c 662e 616c 6c5f         self.all_
+000078b0: 6475 7261 7469 6f6e 7320 3d20 6465 6661  durations = defa
+000078c0: 756c 7464 6963 7428 666c 6f61 7429 0a20  ultdict(float). 
+000078d0: 2020 2020 2020 2073 656c 662e 7374 6174         self.stat
+000078e0: 655f 636f 756e 7473 203d 2064 6566 6175  e_counts = defau
+000078f0: 6c74 6469 6374 2869 6e74 290a 2020 2020  ltdict(int).    
+00007900: 2020 2020 7461 736b 5f64 7572 6174 696f      task_duratio
+00007910: 6e73 203d 2064 6173 6b2e 636f 6e66 6967  ns = dask.config
+00007920: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
+00007930: 642e 7363 6865 6475 6c65 722e 6465 6661  d.scheduler.defa
+00007940: 756c 742d 7461 736b 2d64 7572 6174 696f  ult-task-duratio
+00007950: 6e73 2229 0a20 2020 2020 2020 2069 6620  ns").        if 
+00007960: 7365 6c66 2e6e 616d 6520 696e 2074 6173  self.name in tas
+00007970: 6b5f 6475 7261 7469 6f6e 733a 0a20 2020  k_durations:.   
+00007980: 2020 2020 2020 2020 2073 656c 662e 6475           self.du
+00007990: 7261 7469 6f6e 5f61 7665 7261 6765 203d  ration_average =
+000079a0: 2070 6172 7365 5f74 696d 6564 656c 7461   parse_timedelta
+000079b0: 2874 6173 6b5f 6475 7261 7469 6f6e 735b  (task_durations[
+000079c0: 7365 6c66 2e6e 616d 655d 290a 2020 2020  self.name]).    
+000079d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000079e0: 2020 2020 2020 7365 6c66 2e64 7572 6174        self.durat
+000079f0: 696f 6e5f 6176 6572 6167 6520 3d20 2d31  ion_average = -1
+00007a00: 0a20 2020 2020 2020 2073 656c 662e 6d61  .        self.ma
+00007a10: 785f 6578 6563 5f74 696d 6520 3d20 2d31  x_exec_time = -1
+00007a20: 0a20 2020 2020 2020 2073 656c 662e 7375  .        self.su
+00007a30: 7370 6963 696f 7573 203d 2030 0a0a 2020  spicious = 0..  
+00007a40: 2020 6465 6620 6164 645f 6578 6563 5f74    def add_exec_t
+00007a50: 696d 6528 7365 6c66 2c20 6475 7261 7469  ime(self, durati
+00007a60: 6f6e 3a20 666c 6f61 7429 202d 3e20 4e6f  on: float) -> No
+00007a70: 6e65 3a0a 2020 2020 2020 2020 7365 6c66  ne:.        self
+00007a80: 2e6d 6178 5f65 7865 635f 7469 6d65 203d  .max_exec_time =
+00007a90: 206d 6178 2864 7572 6174 696f 6e2c 2073   max(duration, s
+00007aa0: 656c 662e 6d61 785f 6578 6563 5f74 696d  elf.max_exec_tim
+00007ab0: 6529 0a20 2020 2020 2020 2069 6620 6475  e).        if du
+00007ac0: 7261 7469 6f6e 203e 2032 202a 2073 656c  ration > 2 * sel
+00007ad0: 662e 6475 7261 7469 6f6e 5f61 7665 7261  f.duration_avera
+00007ae0: 6765 3a0a 2020 2020 2020 2020 2020 2020  ge:.            
+00007af0: 7365 6c66 2e64 7572 6174 696f 6e5f 6176  self.duration_av
+00007b00: 6572 6167 6520 3d20 2d31 0a0a 2020 2020  erage = -1..    
+00007b10: 6465 6620 6164 645f 6475 7261 7469 6f6e  def add_duration
+00007b20: 2873 656c 662c 2061 6374 696f 6e3a 2073  (self, action: s
+00007b30: 7472 2c20 7374 6172 743a 2066 6c6f 6174  tr, start: float
+00007b40: 2c20 7374 6f70 3a20 666c 6f61 7429 202d  , stop: float) -
+00007b50: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00007b60: 6475 7261 7469 6f6e 203d 2073 746f 7020  duration = stop 
+00007b70: 2d20 7374 6172 740a 2020 2020 2020 2020  - start.        
+00007b80: 7365 6c66 2e61 6c6c 5f64 7572 6174 696f  self.all_duratio
+00007b90: 6e73 5b61 6374 696f 6e5d 202b 3d20 6475  ns[action] += du
+00007ba0: 7261 7469 6f6e 0a20 2020 2020 2020 2069  ration.        i
+00007bb0: 6620 6163 7469 6f6e 203d 3d20 2263 6f6d  f action == "com
+00007bc0: 7075 7465 223a 0a20 2020 2020 2020 2020  pute":.         
+00007bd0: 2020 206f 6c64 203d 2073 656c 662e 6475     old = self.du
+00007be0: 7261 7469 6f6e 5f61 7665 7261 6765 0a20  ration_average. 
+00007bf0: 2020 2020 2020 2020 2020 2069 6620 6f6c             if ol
+00007c00: 6420 3c20 303a 0a20 2020 2020 2020 2020  d < 0:.         
+00007c10: 2020 2020 2020 2073 656c 662e 6475 7261         self.dura
+00007c20: 7469 6f6e 5f61 7665 7261 6765 203d 2064  tion_average = d
+00007c30: 7572 6174 696f 6e0a 2020 2020 2020 2020  uration.        
+00007c40: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00007c50: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
+00007c60: 7572 6174 696f 6e5f 6176 6572 6167 6520  uration_average 
+00007c70: 3d20 302e 3520 2a20 6475 7261 7469 6f6e  = 0.5 * duration
+00007c80: 202b 2030 2e35 202a 206f 6c64 0a0a 2020   + 0.5 * old..  
+00007c90: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
+00007ca0: 6465 6620 7374 6174 6573 2873 656c 6629  def states(self)
+00007cb0: 202d 3e20 6469 6374 5b73 7472 2c20 696e   -> dict[str, in
+00007cc0: 745d 3a0a 2020 2020 2020 2020 2222 2254  t]:.        """T
+00007cd0: 6865 206e 756d 6265 7220 6f66 2074 6173  he number of tas
+00007ce0: 6b73 2069 6e20 6561 6368 2073 7461 7465  ks in each state
+00007cf0: 2c0a 2020 2020 2020 2020 6c69 6b65 2060  ,.        like `
+00007d00: 607b 226d 656d 6f72 7922 3a20 3130 2c20  `{"memory": 10, 
+00007d10: 2270 726f 6365 7373 696e 6722 3a20 332c  "processing": 3,
+00007d20: 2022 7265 6c65 6173 6564 223a 2034 2c20   "released": 4, 
+00007d30: 2e2e 2e7d 6060 0a20 2020 2020 2020 2022  ...}``.        "
+00007d40: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
+00007d50: 6e20 6d65 7267 655f 7769 7468 2873 756d  n merge_with(sum
+00007d60: 2c20 5b74 672e 7374 6174 6573 2066 6f72  , [tg.states for
+00007d70: 2074 6720 696e 2073 656c 662e 6772 6f75   tg in self.grou
+00007d80: 7073 5d29 0a0a 2020 2020 4070 726f 7065  ps])..    @prope
+00007d90: 7274 790a 2020 2020 6465 6620 6163 7469  rty.    def acti
+00007da0: 7665 2873 656c 6629 202d 3e20 6c69 7374  ve(self) -> list
+00007db0: 5b54 6173 6b47 726f 7570 5d3a 0a20 2020  [TaskGroup]:.   
+00007dc0: 2020 2020 2072 6574 7572 6e20 5b0a 2020       return [.  
+00007dd0: 2020 2020 2020 2020 2020 7467 0a20 2020            tg.   
+00007de0: 2020 2020 2020 2020 2066 6f72 2074 6720           for tg 
+00007df0: 696e 2073 656c 662e 6772 6f75 7073 0a20  in self.groups. 
+00007e00: 2020 2020 2020 2020 2020 2069 6620 616e             if an
+00007e10: 7928 6b20 213d 2022 666f 7267 6f74 7465  y(k != "forgotte
+00007e20: 6e22 2061 6e64 2076 2021 3d20 3020 666f  n" and v != 0 fo
+00007e30: 7220 6b2c 2076 2069 6e20 7467 2e73 7461  r k, v in tg.sta
+00007e40: 7465 732e 6974 656d 7328 2929 0a20 2020  tes.items()).   
+00007e50: 2020 2020 205d 0a0a 2020 2020 4070 726f       ]..    @pro
+00007e60: 7065 7274 790a 2020 2020 6465 6620 6163  perty.    def ac
+00007e70: 7469 7665 5f73 7461 7465 7328 7365 6c66  tive_states(self
+00007e80: 2920 2d3e 2064 6963 745b 7374 722c 2069  ) -> dict[str, i
+00007e90: 6e74 5d3a 0a20 2020 2020 2020 2072 6574  nt]:.        ret
+00007ea0: 7572 6e20 6d65 7267 655f 7769 7468 2873  urn merge_with(s
+00007eb0: 756d 2c20 5b74 672e 7374 6174 6573 2066  um, [tg.states f
+00007ec0: 6f72 2074 6720 696e 2073 656c 662e 6163  or tg in self.ac
+00007ed0: 7469 7665 5d29 0a0a 2020 2020 6465 6620  tive])..    def 
+00007ee0: 5f5f 7265 7072 5f5f 2873 656c 6629 202d  __repr__(self) -
+00007ef0: 3e20 7374 723a 0a20 2020 2020 2020 2072  > str:.        r
+00007f00: 6574 7572 6e20 280a 2020 2020 2020 2020  eturn (.        
+00007f10: 2020 2020 223c 220a 2020 2020 2020 2020      "<".        
+00007f20: 2020 2020 2b20 7365 6c66 2e6e 616d 650a      + self.name.
+00007f30: 2020 2020 2020 2020 2020 2020 2b20 223a              + ":
+00007f40: 2022 0a20 2020 2020 2020 2020 2020 202b   ".            +
+00007f50: 2022 2c20 222e 6a6f 696e 280a 2020 2020   ", ".join(.    
+00007f60: 2020 2020 2020 2020 2020 2020 2225 733a              "%s:
+00007f70: 2025 6422 2025 2028 6b2c 2076 2920 666f   %d" % (k, v) fo
+00007f80: 7220 286b 2c20 7629 2069 6e20 736f 7274  r (k, v) in sort
+00007f90: 6564 2873 656c 662e 7374 6174 6573 2e69  ed(self.states.i
+00007fa0: 7465 6d73 2829 2920 6966 2076 0a20 2020  tems()) if v.   
+00007fb0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00007fc0: 2020 2020 2020 202b 2022 3e22 0a20 2020         + ">".   
+00007fd0: 2020 2020 2029 0a0a 2020 2020 4070 726f       )..    @pro
+00007fe0: 7065 7274 790a 2020 2020 6465 6620 6e62  perty.    def nb
+00007ff0: 7974 6573 5f74 6f74 616c 2873 656c 6629  ytes_total(self)
+00008000: 202d 3e20 696e 743a 0a20 2020 2020 2020   -> int:.       
+00008010: 2072 6574 7572 6e20 7375 6d28 7467 2e6e   return sum(tg.n
+00008020: 6279 7465 735f 746f 7461 6c20 666f 7220  bytes_total for 
+00008030: 7467 2069 6e20 7365 6c66 2e67 726f 7570  tg in self.group
+00008040: 7329 0a0a 2020 2020 6465 6620 5f5f 6c65  s)..    def __le
+00008050: 6e5f 5f28 7365 6c66 2920 2d3e 2069 6e74  n__(self) -> int
+00008060: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00008070: 2073 756d 286d 6170 286c 656e 2c20 7365   sum(map(len, se
+00008080: 6c66 2e67 726f 7570 7329 290a 0a20 2020  lf.groups))..   
+00008090: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+000080a0: 6566 2064 7572 6174 696f 6e28 7365 6c66  ef duration(self
+000080b0: 2920 2d3e 2066 6c6f 6174 3a0a 2020 2020  ) -> float:.    
+000080c0: 2020 2020 7265 7475 726e 2073 756d 2874      return sum(t
+000080d0: 672e 6475 7261 7469 6f6e 2066 6f72 2074  g.duration for t
+000080e0: 6720 696e 2073 656c 662e 6772 6f75 7073  g in self.groups
+000080f0: 290a 0a20 2020 2040 7072 6f70 6572 7479  )..    @property
+00008100: 0a20 2020 2064 6566 2074 7970 6573 2873  .    def types(s
+00008110: 656c 6629 202d 3e20 7365 745b 7374 725d  elf) -> set[str]
+00008120: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00008130: 207b 7479 7020 666f 7220 7467 2069 6e20   {typ for tg in 
+00008140: 7365 6c66 2e67 726f 7570 7320 666f 7220  self.groups for 
+00008150: 7479 7020 696e 2074 672e 7479 7065 737d  typ in tg.types}
+00008160: 0a0a 0a63 6c61 7373 2054 6173 6b47 726f  ...class TaskGro
+00008170: 7570 3a0a 2020 2020 2222 2243 6f6c 6c65  up:.    """Colle
+00008180: 6374 696f 6e20 7472 6163 6b69 6e67 2061  ction tracking a
+00008190: 6c6c 2074 6173 6b73 2077 6974 6869 6e20  ll tasks within 
+000081a0: 6120 6772 6f75 700a 0a20 2020 204b 6579  a group..    Key
+000081b0: 7320 6f66 7465 6e20 6861 7665 2061 2073  s often have a s
+000081c0: 7472 7563 7475 7265 206c 696b 6520 6060  tructure like ``
+000081d0: 2822 782d 3132 3322 2c20 3029 6060 0a20  ("x-123", 0)``. 
+000081e0: 2020 2041 2067 726f 7570 2074 616b 6573     A group takes
+000081f0: 2074 6865 2066 6972 7374 2073 6563 7469   the first secti
+00008200: 6f6e 2c20 6c69 6b65 2060 6022 782d 3132  on, like ``"x-12
+00008210: 3322 6060 0a0a 2020 2020 5365 6520 616c  3"``..    See al
+00008220: 736f 0a20 2020 202d 2d2d 2d2d 2d2d 2d0a  so.    --------.
+00008230: 2020 2020 5461 736b 5072 6566 6978 0a20      TaskPrefix. 
+00008240: 2020 2022 2222 0a0a 2020 2020 233a 2054     """..    #: T
+00008250: 6865 206e 616d 6520 6f66 2061 2067 726f  he name of a gro
+00008260: 7570 206f 6620 7461 736b 732e 0a20 2020  up of tasks..   
+00008270: 2023 3a20 466f 7220 6120 7461 736b 206c   #: For a task l
+00008280: 696b 6520 6060 2822 782d 3132 3322 2c20  ike ``("x-123", 
+00008290: 3029 6060 2074 6869 7320 6973 2074 6865  0)`` this is the
+000082a0: 2074 6578 7420 6060 2278 2d31 3233 2260   text ``"x-123"`
+000082b0: 600a 2020 2020 6e61 6d65 3a20 7374 720a  `.    name: str.
+000082c0: 0a20 2020 2023 3a20 5468 6520 6e75 6d62  .    #: The numb
+000082d0: 6572 206f 6620 7461 736b 7320 696e 2065  er of tasks in e
+000082e0: 6163 6820 7374 6174 652c 0a20 2020 2023  ach state,.    #
+000082f0: 3a20 6c69 6b65 2060 607b 226d 656d 6f72  : like ``{"memor
+00008300: 7922 3a20 3130 2c20 2270 726f 6365 7373  y": 10, "process
+00008310: 696e 6722 3a20 332c 2022 7265 6c65 6173  ing": 3, "releas
+00008320: 6564 223a 2034 2c20 2e2e 2e7d 6060 0a20  ed": 4, ...}``. 
+00008330: 2020 2073 7461 7465 733a 2064 6963 745b     states: dict[
+00008340: 5461 736b 5374 6174 6553 7461 7465 2c20  TaskStateState, 
+00008350: 696e 745d 0a0a 2020 2020 233a 2054 6865  int]..    #: The
+00008360: 206f 7468 6572 2054 6173 6b47 726f 7570   other TaskGroup
+00008370: 7320 6f6e 2077 6869 6368 2074 6869 7320  s on which this 
+00008380: 6f6e 6520 6465 7065 6e64 730a 2020 2020  one depends.    
+00008390: 6465 7065 6e64 656e 6369 6573 3a20 7365  dependencies: se
+000083a0: 745b 5461 736b 4772 6f75 705d 0a0a 2020  t[TaskGroup]..  
+000083b0: 2020 233a 2054 6865 2074 6f74 616c 206e    #: The total n
+000083c0: 756d 6265 7220 6f66 2062 7974 6573 2074  umber of bytes t
+000083d0: 6861 7420 7468 6973 2074 6173 6b20 6772  hat this task gr
+000083e0: 6f75 7020 6861 7320 7072 6f64 7563 6564  oup has produced
+000083f0: 0a20 2020 206e 6279 7465 735f 746f 7461  .    nbytes_tota
+00008400: 6c3a 2069 6e74 0a0a 2020 2020 233a 2054  l: int..    #: T
+00008410: 6865 2074 6f74 616c 2061 6d6f 756e 7420  he total amount 
+00008420: 6f66 2074 696d 6520 7370 656e 7420 6f6e  of time spent on
+00008430: 2061 6c6c 2074 6173 6b73 2069 6e20 7468   all tasks in th
+00008440: 6973 2054 6173 6b47 726f 7570 0a20 2020  is TaskGroup.   
+00008450: 2064 7572 6174 696f 6e3a 2066 6c6f 6174   duration: float
+00008460: 0a0a 2020 2020 233a 2054 6865 2072 6573  ..    #: The res
+00008470: 756c 7420 7479 7065 7320 6f66 2074 6869  ult types of thi
+00008480: 7320 5461 736b 4772 6f75 700a 2020 2020  s TaskGroup.    
+00008490: 7479 7065 733a 2073 6574 5b73 7472 5d0a  types: set[str].
+000084a0: 0a20 2020 2023 3a20 5468 6520 776f 726b  .    #: The work
+000084b0: 6572 206d 6f73 7420 7265 6365 6e74 6c79  er most recently
+000084c0: 2061 7373 6967 6e65 6420 6120 7461 736b   assigned a task
+000084d0: 2066 726f 6d20 7468 6973 2067 726f 7570   from this group
+000084e0: 2c20 6f72 204e 6f6e 6520 7768 656e 2074  , or None when t
+000084f0: 6865 2067 726f 7570 0a20 2020 2023 3a20  he group.    #: 
+00008500: 6973 206e 6f74 2069 6465 6e74 6966 6965  is not identifie
+00008510: 6420 746f 2062 6520 726f 6f74 2d6c 696b  d to be root-lik
+00008520: 6520 6279 2060 5363 6865 6475 6c65 7253  e by `SchedulerS
+00008530: 7461 7465 2e64 6563 6964 655f 776f 726b  tate.decide_work
+00008540: 6572 602e 0a20 2020 206c 6173 745f 776f  er`..    last_wo
+00008550: 726b 6572 3a20 576f 726b 6572 5374 6174  rker: WorkerStat
+00008560: 6520 7c20 4e6f 6e65 0a0a 2020 2020 233a  e | None..    #:
+00008570: 2049 6620 606c 6173 745f 776f 726b 6572   If `last_worker
+00008580: 6020 6973 206e 6f74 204e 6f6e 652c 2074  ` is not None, t
+00008590: 6865 206e 756d 6265 7220 6f66 2074 696d  he number of tim
+000085a0: 6573 2074 6861 7420 776f 726b 6572 2073  es that worker s
+000085b0: 686f 756c 6420 6265 2061 7373 6967 6e65  hould be assigne
+000085c0: 640a 2020 2020 233a 2073 7562 7365 7175  d.    #: subsequ
+000085d0: 656e 7420 7461 736b 7320 756e 7469 6c20  ent tasks until 
+000085e0: 6120 6e65 7720 776f 726b 6572 2069 7320  a new worker is 
+000085f0: 6368 6f73 656e 2e0a 2020 2020 6c61 7374  chosen..    last
+00008600: 5f77 6f72 6b65 725f 7461 736b 735f 6c65  _worker_tasks_le
+00008610: 6674 3a20 696e 740a 0a20 2020 2070 7265  ft: int..    pre
+00008620: 6669 783a 2054 6173 6b50 7265 6669 7820  fix: TaskPrefix 
+00008630: 7c20 4e6f 6e65 0a0a 2020 2020 233a 2045  | None..    #: E
+00008640: 6172 6c69 6573 7420 7469 6d65 2077 6865  arliest time whe
+00008650: 6e20 6120 7461 736b 2062 656c 6f6e 6769  n a task belongi
+00008660: 6e67 2074 6f20 7468 6973 2067 726f 7570  ng to this group
+00008670: 2073 7461 7274 6564 2063 6f6d 7075 7469   started computi
+00008680: 6e67 3b0a 2020 2020 233a 2030 2069 6620  ng;.    #: 0 if 
+00008690: 6e6f 2074 6173 6b20 6861 7320 2a66 696e  no task has *fin
+000086a0: 6973 6865 642a 2063 6f6d 7075 7469 6e67  ished* computing
+000086b0: 2079 6574 0a20 2020 2023 3a0a 2020 2020   yet.    #:.    
+000086c0: 233a 204e 6f74 6573 0a20 2020 2023 3a20  #: Notes.    #: 
+000086d0: 2d2d 2d2d 2d0a 2020 2020 233a 2054 6869  -----.    #: Thi
+000086e0: 7320 6973 206e 6f74 2075 7064 6174 6564  s is not updated
+000086f0: 2075 6e74 696c 2061 7420 6c65 6173 7420   until at least 
+00008700: 6f6e 6520 7461 736b 2068 6173 202a 6669  one task has *fi
+00008710: 6e69 7368 6564 2a20 636f 6d70 7574 696e  nished* computin
+00008720: 672e 0a20 2020 2023 3a20 4974 2063 6f75  g..    #: It cou
+00008730: 6c64 206d 6f76 6520 6261 636b 7761 7264  ld move backward
+00008740: 7320 6173 2074 6173 6b73 2063 6f6d 706c  s as tasks compl
+00008750: 6574 652e 0a20 2020 2073 7461 7274 3a20  ete..    start: 
+00008760: 666c 6f61 740a 0a20 2020 2023 3a20 4c61  float..    #: La
+00008770: 7465 7374 2074 696d 6520 7768 656e 2061  test time when a
+00008780: 2074 6173 6b20 6265 6c6f 6e67 696e 6720   task belonging 
+00008790: 746f 2074 6869 7320 6772 6f75 7020 6669  to this group fi
+000087a0: 6e69 7368 6564 2063 6f6d 7075 7469 6e67  nished computing
+000087b0: 2c0a 2020 2020 233a 2030 2069 6620 6e6f  ,.    #: 0 if no
+000087c0: 2074 6173 6b20 6861 7320 6669 6e69 7368   task has finish
+000087d0: 6564 2063 6f6d 7075 7469 6e67 2079 6574  ed computing yet
+000087e0: 0a20 2020 2073 746f 703a 2066 6c6f 6174  .    stop: float
+000087f0: 0a0a 2020 2020 233a 2043 756d 756c 6174  ..    #: Cumulat
+00008800: 6976 6520 6475 7261 7469 6f6e 206f 6620  ive duration of 
+00008810: 616c 6c20 636f 6d70 6c65 7465 6420 6163  all completed ac
+00008820: 7469 6f6e 732c 2062 7920 6163 7469 6f6e  tions, by action
+00008830: 0a20 2020 2061 6c6c 5f64 7572 6174 696f  .    all_duratio
+00008840: 6e73 3a20 6465 6661 756c 7464 6963 745b  ns: defaultdict[
+00008850: 7374 722c 2066 6c6f 6174 5d0a 0a20 2020  str, float]..   
+00008860: 2023 3a20 5370 616e 2049 4420 2873 6565   #: Span ID (see
+00008870: 2060 6064 6973 7472 6962 7574 6564 2e73   ``distributed.s
+00008880: 7061 6e73 6060 292e 0a20 2020 2023 3a20  pans``)..    #: 
+00008890: 4d61 7463 6865 7320 6060 6469 7374 7269  Matches ``distri
+000088a0: 6275 7465 642e 776f 726b 6572 5f73 7461  buted.worker_sta
+000088b0: 7465 5f6d 6163 6869 6e65 2e54 6173 6b53  te_machine.TaskS
+000088c0: 7461 7465 2e73 7061 6e5f 6964 6060 2e0a  tate.span_id``..
+000088d0: 2020 2020 233a 2049 7420 6973 2070 6f73      #: It is pos
+000088e0: 7369 626c 6520 746f 2065 6e64 2075 7020  sible to end up 
+000088f0: 696e 2073 6974 7561 7469 6f6e 2077 6865  in situation whe
+00008900: 7265 2064 6966 6665 7265 6e74 2074 6173  re different tas
+00008910: 6b73 206f 6620 7468 6520 7361 6d65 2054  ks of the same T
+00008920: 6173 6b47 726f 7570 0a20 2020 2023 3a20  askGroup.    #: 
+00008930: 6265 6c6f 6e67 2074 6f20 6469 6666 6572  belong to differ
+00008940: 656e 7420 7370 616e 733b 2074 6865 2070  ent spans; the p
+00008950: 7572 706f 7365 206f 6620 7468 6973 2061  urpose of this a
+00008960: 7474 7269 6275 7465 2069 7320 746f 2061  ttribute is to a
+00008970: 7262 6974 7261 7269 6c79 2066 6f72 6365  rbitrarily force
+00008980: 0a20 2020 2023 3a20 6576 6572 7974 6869  .    #: everythi
+00008990: 6e67 206f 6e74 6f20 7468 6520 6561 726c  ng onto the earl
+000089a0: 6965 7374 2065 6e63 6f75 6e74 6572 6564  iest encountered
+000089b0: 206f 6e65 2e0a 2020 2020 7370 616e 5f69   one..    span_i
+000089c0: 643a 2073 7472 207c 204e 6f6e 650a 0a20  d: str | None.. 
+000089d0: 2020 205f 5f73 6c6f 7473 5f5f 203d 2074     __slots__ = t
+000089e0: 7570 6c65 285f 5f61 6e6e 6f74 6174 696f  uple(__annotatio
+000089f0: 6e73 5f5f 290a 0a20 2020 2064 6566 205f  ns__)..    def _
+00008a00: 5f69 6e69 745f 5f28 7365 6c66 2c20 6e61  _init__(self, na
+00008a10: 6d65 3a20 7374 7229 3a0a 2020 2020 2020  me: str):.      
+00008a20: 2020 7365 6c66 2e6e 616d 6520 3d20 6e61    self.name = na
+00008a30: 6d65 0a20 2020 2020 2020 2073 656c 662e  me.        self.
+00008a40: 7072 6566 6978 203d 204e 6f6e 650a 2020  prefix = None.  
+00008a50: 2020 2020 2020 7365 6c66 2e73 7461 7465        self.state
+00008a60: 7320 3d20 6469 6374 2e66 726f 6d6b 6579  s = dict.fromkey
+00008a70: 7328 414c 4c5f 5441 534b 5f53 5441 5445  s(ALL_TASK_STATE
+00008a80: 532c 2030 290a 2020 2020 2020 2020 7365  S, 0).        se
+00008a90: 6c66 2e64 6570 656e 6465 6e63 6965 7320  lf.dependencies 
+00008aa0: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
+00008ab0: 7365 6c66 2e6e 6279 7465 735f 746f 7461  self.nbytes_tota
+00008ac0: 6c20 3d20 300a 2020 2020 2020 2020 7365  l = 0.        se
+00008ad0: 6c66 2e64 7572 6174 696f 6e20 3d20 300a  lf.duration = 0.
+00008ae0: 2020 2020 2020 2020 7365 6c66 2e74 7970          self.typ
+00008af0: 6573 203d 2073 6574 2829 0a20 2020 2020  es = set().     
+00008b00: 2020 2073 656c 662e 7374 6172 7420 3d20     self.start = 
+00008b10: 302e 300a 2020 2020 2020 2020 7365 6c66  0.0.        self
+00008b20: 2e73 746f 7020 3d20 302e 300a 2020 2020  .stop = 0.0.    
+00008b30: 2020 2020 7365 6c66 2e61 6c6c 5f64 7572      self.all_dur
+00008b40: 6174 696f 6e73 203d 2064 6566 6175 6c74  ations = default
+00008b50: 6469 6374 2866 6c6f 6174 290a 2020 2020  dict(float).    
+00008b60: 2020 2020 7365 6c66 2e6c 6173 745f 776f      self.last_wo
+00008b70: 726b 6572 203d 204e 6f6e 650a 2020 2020  rker = None.    
+00008b80: 2020 2020 7365 6c66 2e6c 6173 745f 776f      self.last_wo
+00008b90: 726b 6572 5f74 6173 6b73 5f6c 6566 7420  rker_tasks_left 
+00008ba0: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
+00008bb0: 2e73 7061 6e5f 6964 203d 204e 6f6e 650a  .span_id = None.
+00008bc0: 0a20 2020 2064 6566 2061 6464 5f64 7572  .    def add_dur
+00008bd0: 6174 696f 6e28 7365 6c66 2c20 6163 7469  ation(self, acti
+00008be0: 6f6e 3a20 7374 722c 2073 7461 7274 3a20  on: str, start: 
+00008bf0: 666c 6f61 742c 2073 746f 703a 2066 6c6f  float, stop: flo
+00008c00: 6174 2920 2d3e 204e 6f6e 653a 0a20 2020  at) -> None:.   
+00008c10: 2020 2020 2064 7572 6174 696f 6e20 3d20       duration = 
+00008c20: 7374 6f70 202d 2073 7461 7274 0a20 2020  stop - start.   
+00008c30: 2020 2020 2073 656c 662e 6475 7261 7469       self.durati
+00008c40: 6f6e 202b 3d20 6475 7261 7469 6f6e 0a20  on += duration. 
+00008c50: 2020 2020 2020 2073 656c 662e 616c 6c5f         self.all_
+00008c60: 6475 7261 7469 6f6e 735b 6163 7469 6f6e  durations[action
+00008c70: 5d20 2b3d 2064 7572 6174 696f 6e0a 2020  ] += duration.  
+00008c80: 2020 2020 2020 6966 2061 6374 696f 6e20        if action 
+00008c90: 3d3d 2022 636f 6d70 7574 6522 3a0a 2020  == "compute":.  
+00008ca0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+00008cb0: 662e 7374 6f70 203c 2073 746f 703a 0a20  f.stop < stop:. 
+00008cc0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00008cd0: 656c 662e 7374 6f70 203d 2073 746f 700a  elf.stop = stop.
+00008ce0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00008cf0: 656c 662e 7374 6172 7420 3d3d 2030 2e30  elf.start == 0.0
+00008d00: 206f 7220 7365 6c66 2e73 7461 7274 203e   or self.start >
+00008d10: 2073 7461 7274 3a0a 2020 2020 2020 2020   start:.        
+00008d20: 2020 2020 2020 2020 7365 6c66 2e73 7461          self.sta
+00008d30: 7274 203d 2073 7461 7274 0a20 2020 2020  rt = start.     
+00008d40: 2020 2061 7373 6572 7420 7365 6c66 2e70     assert self.p
+00008d50: 7265 6669 7820 6973 206e 6f74 204e 6f6e  refix is not Non
+00008d60: 650a 2020 2020 2020 2020 7365 6c66 2e70  e.        self.p
+00008d70: 7265 6669 782e 6164 645f 6475 7261 7469  refix.add_durati
+00008d80: 6f6e 2861 6374 696f 6e2c 2073 7461 7274  on(action, start
+00008d90: 2c20 7374 6f70 290a 0a20 2020 2064 6566  , stop)..    def
+00008da0: 2061 6464 2873 656c 662c 206f 7468 6572   add(self, other
+00008db0: 3a20 5461 736b 5374 6174 6529 202d 3e20  : TaskState) -> 
+00008dc0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7365  None:.        se
+00008dd0: 6c66 2e73 7461 7465 735b 6f74 6865 722e  lf.states[other.
+00008de0: 7374 6174 655d 202b 3d20 310a 2020 2020  state] += 1.    
+00008df0: 2020 2020 6f74 6865 722e 6772 6f75 7020      other.group 
+00008e00: 3d20 7365 6c66 0a0a 2020 2020 6465 6620  = self..    def 
+00008e10: 5f5f 7265 7072 5f5f 2873 656c 6629 202d  __repr__(self) -
+00008e20: 3e20 7374 723a 0a20 2020 2020 2020 2072  > str:.        r
+00008e30: 6574 7572 6e20 280a 2020 2020 2020 2020  eturn (.        
+00008e40: 2020 2020 223c 220a 2020 2020 2020 2020      "<".        
+00008e50: 2020 2020 2b20 2873 656c 662e 6e61 6d65      + (self.name
+00008e60: 206f 7220 226e 6f2d 6772 6f75 7022 290a   or "no-group").
+00008e70: 2020 2020 2020 2020 2020 2020 2b20 223a              + ":
+00008e80: 2022 0a20 2020 2020 2020 2020 2020 202b   ".            +
+00008e90: 2022 2c20 222e 6a6f 696e 280a 2020 2020   ", ".join(.    
+00008ea0: 2020 2020 2020 2020 2020 2020 2225 733a              "%s:
+00008eb0: 2025 6422 2025 2028 6b2c 2076 2920 666f   %d" % (k, v) fo
+00008ec0: 7220 286b 2c20 7629 2069 6e20 736f 7274  r (k, v) in sort
+00008ed0: 6564 2873 656c 662e 7374 6174 6573 2e69  ed(self.states.i
+00008ee0: 7465 6d73 2829 2920 6966 2076 0a20 2020  tems()) if v.   
+00008ef0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00008f00: 2020 2020 2020 202b 2022 3e22 0a20 2020         + ">".   
+00008f10: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
+00008f20: 5f5f 6c65 6e5f 5f28 7365 6c66 2920 2d3e  __len__(self) ->
+00008f30: 2069 6e74 3a0a 2020 2020 2020 2020 7265   int:.        re
+00008f40: 7475 726e 2073 756d 2873 656c 662e 7374  turn sum(self.st
+00008f50: 6174 6573 2e76 616c 7565 7328 2929 0a0a  ates.values())..
+00008f60: 2020 2020 6465 6620 5f74 6f5f 6469 6374      def _to_dict
+00008f70: 5f6e 6f5f 6e65 7374 2873 656c 662c 202a  _no_nest(self, *
+00008f80: 2c20 6578 636c 7564 653a 2043 6f6e 7461  , exclude: Conta
+00008f90: 696e 6572 5b73 7472 5d20 3d20 2829 2920  iner[str] = ()) 
+00008fa0: 2d3e 2064 6963 745b 7374 722c 2041 6e79  -> dict[str, Any
+00008fb0: 5d3a 0a20 2020 2020 2020 2022 2222 4469  ]:.        """Di
+00008fc0: 6374 696f 6e61 7279 2072 6570 7265 7365  ctionary represe
+00008fd0: 6e74 6174 696f 6e20 666f 7220 6465 6275  ntation for debu
+00008fe0: 6767 696e 6720 7075 7270 6f73 6573 2e0a  gging purposes..
+00008ff0: 2020 2020 2020 2020 4e6f 7420 7479 7065          Not type
+00009000: 2073 7461 626c 6520 616e 6420 6e6f 7420   stable and not 
+00009010: 696e 7465 6e64 6564 2066 6f72 2072 6f75  intended for rou
+00009020: 6e64 7472 6970 732e 0a0a 2020 2020 2020  ndtrips...      
+00009030: 2020 5365 6520 616c 736f 0a20 2020 2020    See also.     
+00009040: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
+00009050: 2020 2020 436c 6965 6e74 2e64 756d 705f      Client.dump_
+00009060: 636c 7573 7465 725f 7374 6174 650a 2020  cluster_state.  
+00009070: 2020 2020 2020 6469 7374 7269 6275 7465        distribute
+00009080: 642e 7574 696c 732e 7265 6375 7273 6976  d.utils.recursiv
+00009090: 655f 746f 5f64 6963 740a 2020 2020 2020  e_to_dict.      
+000090a0: 2020 5461 736b 5374 6174 652e 5f74 6f5f    TaskState._to_
+000090b0: 6469 6374 0a20 2020 2020 2020 2022 2222  dict.        """
+000090c0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000090d0: 7265 6375 7273 6976 655f 746f 5f64 6963  recursive_to_dic
+000090e0: 7428 7365 6c66 2c20 6578 636c 7564 653d  t(self, exclude=
+000090f0: 6578 636c 7564 652c 206d 656d 6265 7273  exclude, members
+00009100: 3d54 7275 6529 0a0a 2020 2020 4070 726f  =True)..    @pro
+00009110: 7065 7274 790a 2020 2020 6465 6620 646f  perty.    def do
+00009120: 6e65 2873 656c 6629 202d 3e20 626f 6f6c  ne(self) -> bool
+00009130: 3a0a 2020 2020 2020 2020 2222 2252 6574  :.        """Ret
+00009140: 7572 6e20 5472 7565 2069 6620 616c 6c20  urn True if all 
+00009150: 636f 6d70 7574 6174 696f 6e73 2066 6f72  computations for
+00009160: 2074 6869 7320 6772 6f75 7020 6861 7665   this group have
+00009170: 2063 6f6d 706c 6574 6564 3b20 4661 6c73   completed; Fals
+00009180: 650a 2020 2020 2020 2020 6f74 6865 7277  e.        otherw
+00009190: 6973 652e 0a0a 2020 2020 2020 2020 4e6f  ise...        No
+000091a0: 7465 730a 2020 2020 2020 2020 2d2d 2d2d  tes.        ----
+000091b0: 2d0a 2020 2020 2020 2020 5468 6973 2070  -.        This p
+000091c0: 726f 7065 7274 7920 6d61 7920 7472 616e  roperty may tran
+000091d0: 7369 7469 6f6e 2066 726f 6d20 5472 7565  sition from True
+000091e0: 2074 6f20 4661 6c73 652c 2065 2e67 2e20   to False, e.g. 
+000091f0: 7768 656e 2061 2077 6f72 6b65 7220 7468  when a worker th
+00009200: 6174 0a20 2020 2020 2020 2063 6f6e 7461  at.        conta
+00009210: 696e 6564 2074 6865 206f 6e6c 7920 7265  ined the only re
+00009220: 706c 6963 6120 6f66 2061 2074 6173 6b20  plica of a task 
+00009230: 696e 206d 656d 6f72 7920 6372 6173 6865  in memory crashe
+00009240: 7320 616e 6420 7468 6520 7461 736b 206e  s and the task n
+00009250: 6565 6420 746f 2062 650a 2020 2020 2020  eed to be.      
+00009260: 2020 7265 636f 6d70 7574 6564 2e0a 2020    recomputed..  
+00009270: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00009280: 2020 7265 7475 726e 2061 6c6c 280a 2020    return all(.  
+00009290: 2020 2020 2020 2020 2020 636f 756e 7420            count 
+000092a0: 3d3d 2030 206f 7220 7374 6174 6520 696e  == 0 or state in
+000092b0: 207b 226d 656d 6f72 7922 2c20 2265 7272   {"memory", "err
+000092c0: 6564 222c 2022 7265 6c65 6173 6564 222c  ed", "released",
+000092d0: 2022 666f 7267 6f74 7465 6e22 7d0a 2020   "forgotten"}.  
+000092e0: 2020 2020 2020 2020 2020 666f 7220 7374            for st
+000092f0: 6174 652c 2063 6f75 6e74 2069 6e20 7365  ate, count in se
+00009300: 6c66 2e73 7461 7465 732e 6974 656d 7328  lf.states.items(
+00009310: 290a 2020 2020 2020 2020 290a 0a0a 636c  ).        )...cl
+00009320: 6173 7320 5461 736b 5374 6174 653a 0a20  ass TaskState:. 
+00009330: 2020 2022 2222 4120 7369 6d70 6c65 206f     """A simple o
+00009340: 626a 6563 7420 686f 6c64 696e 6720 696e  bject holding in
+00009350: 666f 726d 6174 696f 6e20 6162 6f75 7420  formation about 
+00009360: 6120 7461 736b 2e0a 0a20 2020 204e 6f74  a task...    Not
+00009370: 2074 6f20 6265 2063 6f6e 6675 7365 6420   to be confused 
+00009380: 7769 7468 203a 636c 6173 733a 6064 6973  with :class:`dis
+00009390: 7472 6962 7574 6564 2e77 6f72 6b65 725f  tributed.worker_
+000093a0: 7374 6174 655f 6d61 6368 696e 652e 5461  state_machine.Ta
+000093b0: 736b 5374 6174 6560 2c20 7768 6963 680a  skState`, which.
+000093c0: 2020 2020 686f 6c64 7320 7369 6d69 6c61      holds simila
+000093d0: 7220 696e 666f 726d 6174 696f 6e20 6f6e  r information on
+000093e0: 2074 6865 2057 6f72 6b65 7220 7369 6465   the Worker side
+000093f0: 2e0a 2020 2020 2222 220a 0a20 2020 2023  ..    """..    #
+00009400: 3a20 5468 6520 6b65 7920 6973 2074 6865  : The key is the
+00009410: 2075 6e69 7175 6520 6964 656e 7469 6669   unique identifi
+00009420: 6572 206f 6620 6120 7461 736b 2c20 6765  er of a task, ge
+00009430: 6e65 7261 6c6c 7920 666f 726d 6564 2066  nerally formed f
+00009440: 726f 6d20 7468 6520 6e61 6d65 206f 6620  rom the name of 
+00009450: 7468 650a 2020 2020 233a 2066 756e 6374  the.    #: funct
+00009460: 696f 6e2c 2066 6f6c 6c6f 7765 6420 6279  ion, followed by
+00009470: 2061 2068 6173 6820 6f66 2074 6865 2066   a hash of the f
+00009480: 756e 6374 696f 6e20 616e 6420 6172 6775  unction and argu
+00009490: 6d65 6e74 732c 206c 696b 650a 2020 2020  ments, like.    
+000094a0: 233a 2060 6027 696e 632d 6162 3331 6330  #: ``'inc-ab31c0
+000094b0: 3130 3434 3439 3737 3030 3464 3635 3636  10444977004d6566
+000094c0: 3130 6432 6434 3231 6563 2760 602e 0a20  10d2d421ec'``.. 
+000094d0: 2020 206b 6579 3a20 7374 720a 0a20 2020     key: str..   
+000094e0: 2023 3a20 5468 6520 6272 6f61 6420 636c   #: The broad cl
+000094f0: 6173 7320 6f66 2074 6173 6b73 2074 6f20  ass of tasks to 
+00009500: 7768 6963 6820 7468 6973 2074 6173 6b20  which this task 
+00009510: 6265 6c6f 6e67 7320 6c69 6b65 2022 696e  belongs like "in
+00009520: 6322 206f 7220 2272 6561 645f 6373 7622  c" or "read_csv"
+00009530: 0a20 2020 2070 7265 6669 783a 2054 6173  .    prefix: Tas
+00009540: 6b50 7265 6669 780a 0a20 2020 2023 3a20  kPrefix..    #: 
+00009550: 4120 7370 6563 6966 6963 6174 696f 6e20  A specification 
+00009560: 6f66 2068 6f77 2074 6f20 7275 6e20 7468  of how to run th
+00009570: 6520 7461 736b 2e20 2054 6865 2074 7970  e task.  The typ
+00009580: 6520 616e 6420 6d65 616e 696e 6720 6f66  e and meaning of
+00009590: 2074 6869 7320 7661 6c75 6520 6973 0a20   this value is. 
+000095a0: 2020 2023 3a20 6f70 6171 7565 2074 6f20     #: opaque to 
+000095b0: 7468 6520 7363 6865 6475 6c65 722c 2061  the scheduler, a
+000095c0: 7320 6974 2069 7320 6f6e 6c79 2069 6e74  s it is only int
+000095d0: 6572 7072 6574 6564 2062 7920 7468 6520  erpreted by the 
+000095e0: 776f 726b 6572 2074 6f20 7768 6963 6820  worker to which 
+000095f0: 7468 650a 2020 2020 233a 2074 6173 6b20  the.    #: task 
+00009600: 6973 2073 656e 7420 666f 7220 6578 6563  is sent for exec
+00009610: 7574 696e 672e 0a20 2020 2023 3a0a 2020  uting..    #:.  
+00009620: 2020 233a 2041 7320 6120 7370 6563 6961    #: As a specia
+00009630: 6c20 6361 7365 2c20 7468 6973 2061 7474  l case, this att
+00009640: 7269 6275 7465 206d 6179 2061 6c73 6f20  ribute may also 
+00009650: 6265 2060 604e 6f6e 6560 602c 2069 6e20  be ``None``, in 
+00009660: 7768 6963 6820 6361 7365 2074 6865 2074  which case the t
+00009670: 6173 6b20 6973 0a20 2020 2023 3a20 2270  ask is.    #: "p
+00009680: 7572 6520 6461 7461 2220 2873 7563 6820  ure data" (such 
+00009690: 6173 2c20 666f 7220 6578 616d 706c 652c  as, for example,
+000096a0: 2061 2070 6965 6365 206f 6620 6461 7461   a piece of data
+000096b0: 206c 6f61 6465 6420 696e 2074 6865 2073   loaded in the s
+000096c0: 6368 6564 756c 6572 2075 7369 6e67 0a20  cheduler using. 
+000096d0: 2020 2023 3a20 3a6d 6574 683a 6043 6c69     #: :meth:`Cli
+000096e0: 656e 742e 7363 6174 7465 7260 292e 2020  ent.scatter`).  
+000096f0: 4120 2270 7572 6520 6461 7461 2220 7461  A "pure data" ta
+00009700: 736b 2063 616e 6e6f 7420 6265 2063 6f6d  sk cannot be com
+00009710: 7075 7465 6420 6167 6169 6e20 6966 2069  puted again if i
+00009720: 7473 0a20 2020 2023 3a20 7661 6c75 6520  ts.    #: value 
+00009730: 6973 206c 6f73 742e 0a20 2020 2072 756e  is lost..    run
+00009740: 5f73 7065 633a 206f 626a 6563 740a 0a20  _spec: object.. 
+00009750: 2020 2023 3a20 5468 6520 7072 696f 7269     #: The priori
+00009760: 7479 2070 726f 7669 6465 7320 6561 6368  ty provides each
+00009770: 2074 6173 6b20 7769 7468 2061 2072 656c   task with a rel
+00009780: 6174 6976 6520 7261 6e6b 696e 6720 7768  ative ranking wh
+00009790: 6963 6820 6973 2075 7365 6420 746f 2062  ich is used to b
+000097a0: 7265 616b 0a20 2020 2023 3a20 7469 6573  reak.    #: ties
+000097b0: 2077 6865 6e20 6d61 6e79 2074 6173 6b73   when many tasks
+000097c0: 2061 7265 2062 6569 6e67 2063 6f6e 7369   are being consi
+000097d0: 6465 7265 6420 666f 7220 6578 6563 7574  dered for execut
+000097e0: 696f 6e2e 0a20 2020 2023 3a0a 2020 2020  ion..    #:.    
+000097f0: 233a 2054 6869 7320 7261 6e6b 696e 6720  #: This ranking 
+00009800: 6973 2067 656e 6572 616c 6c79 2061 2032  is generally a 2
+00009810: 2d69 7465 6d20 7475 706c 652e 2020 5468  -item tuple.  Th
+00009820: 6520 6669 7273 7420 2861 6e64 2064 6f6d  e first (and dom
+00009830: 696e 616e 7429 2069 7465 6d0a 2020 2020  inant) item.    
+00009840: 233a 2063 6f72 7265 7370 6f6e 6473 2074  #: corresponds t
+00009850: 6f20 7768 656e 2069 7420 7761 7320 7375  o when it was su
+00009860: 626d 6974 7465 642e 2020 4765 6e65 7261  bmitted.  Genera
+00009870: 6c6c 792c 2065 6172 6c69 6572 2074 6173  lly, earlier tas
+00009880: 6b73 2074 616b 6520 7072 6563 6564 656e  ks take preceden
+00009890: 6365 2e0a 2020 2020 233a 2054 6865 2073  ce..    #: The s
+000098a0: 6563 6f6e 6420 6974 656d 2069 7320 6465  econd item is de
+000098b0: 7465 726d 696e 6564 2062 7920 7468 6520  termined by the 
+000098c0: 636c 6965 6e74 2c20 616e 6420 6973 2061  client, and is a
+000098d0: 2077 6179 2074 6f20 7072 696f 7269 7469   way to prioriti
+000098e0: 7a65 2074 6173 6b73 0a20 2020 2023 3a20  ze tasks.    #: 
+000098f0: 7769 7468 696e 2061 206c 6172 6765 2067  within a large g
+00009900: 7261 7068 2074 6861 7420 6d61 7920 6265  raph that may be
+00009910: 2069 6d70 6f72 7461 6e74 2c20 7375 6368   important, such
+00009920: 2061 7320 6966 2074 6865 7920 6172 6520   as if they are 
+00009930: 6f6e 2074 6865 2063 7269 7469 6361 6c0a  on the critical.
+00009940: 2020 2020 233a 2070 6174 682c 206f 7220      #: path, or 
+00009950: 676f 6f64 2074 6f20 7275 6e20 696e 206f  good to run in o
+00009960: 7264 6572 2074 6f20 7265 6c65 6173 6520  rder to release 
+00009970: 6d61 6e79 2064 6570 656e 6465 6e63 6965  many dependencie
+00009980: 732e 2020 5468 6973 2069 7320 6578 706c  s.  This is expl
+00009990: 6169 6e65 640a 2020 2020 233a 2066 7572  ained.    #: fur
+000099a0: 7468 6572 2069 6e20 3a64 6f63 3a60 5363  ther in :doc:`Sc
+000099b0: 6865 6475 6c69 6e67 2050 6f6c 6963 7920  heduling Policy 
+000099c0: 3c73 6368 6564 756c 696e 672d 706f 6c69  <scheduling-poli
+000099d0: 6369 6573 3e60 2e0a 2020 2020 7072 696f  cies>`..    prio
+000099e0: 7269 7479 3a20 7475 706c 655b 666c 6f61  rity: tuple[floa
+000099f0: 742c 202e 2e2e 5d20 7c20 4e6f 6e65 0a0a  t, ...] | None..
+00009a00: 2020 2020 2320 4174 7472 6962 7574 6520      # Attribute 
+00009a10: 756e 6465 726c 7969 6e67 2074 6865 2073  underlying the s
+00009a20: 7461 7465 2070 726f 7065 7274 790a 2020  tate property.  
+00009a30: 2020 5f73 7461 7465 3a20 5461 736b 5374    _state: TaskSt
+00009a40: 6174 6553 7461 7465 0a0a 2020 2020 233a  ateState..    #:
+00009a50: 2054 6865 2073 6574 206f 6620 7461 736b   The set of task
+00009a60: 7320 7468 6973 2074 6173 6b20 6465 7065  s this task depe
+00009a70: 6e64 7320 6f6e 2066 6f72 2070 726f 7065  nds on for prope
+00009a80: 7220 6578 6563 7574 696f 6e2e 204f 6e6c  r execution. Onl
+00009a90: 7920 7461 736b 7320 7374 696c 6c0a 2020  y tasks still.  
+00009aa0: 2020 233a 2061 6c69 7665 2061 7265 206c    #: alive are l
+00009ab0: 6973 7465 6420 696e 2074 6869 7320 7365  isted in this se
+00009ac0: 742e 2049 662c 2066 6f72 2077 6861 7465  t. If, for whate
+00009ad0: 7665 7220 7265 6173 6f6e 2c20 7468 6973  ver reason, this
+00009ae0: 2074 6173 6b20 616c 736f 2064 6570 656e   task also depen
+00009af0: 6473 206f 6e0a 2020 2020 233a 2061 2066  ds on.    #: a f
+00009b00: 6f72 676f 7474 656e 2074 6173 6b2c 2074  orgotten task, t
+00009b10: 6865 203a 6174 7472 3a60 6861 735f 6c6f  he :attr:`has_lo
+00009b20: 7374 5f64 6570 656e 6465 6e63 6965 7360  st_dependencies`
+00009b30: 2066 6c61 6720 6973 2073 6574 2e0a 2020   flag is set..  
+00009b40: 2020 233a 0a20 2020 2023 3a20 4120 7461    #:.    #: A ta
+00009b50: 736b 2063 616e 206f 6e6c 7920 6265 2065  sk can only be e
+00009b60: 7865 6375 7465 6420 6f6e 6365 2061 6c6c  xecuted once all
+00009b70: 2069 7473 2064 6570 656e 6465 6e63 6965   its dependencie
+00009b80: 7320 6861 7665 2061 6c72 6561 6479 2062  s have already b
+00009b90: 6565 6e0a 2020 2020 233a 2073 7563 6365  een.    #: succe
+00009ba0: 7373 6675 6c6c 7920 6578 6563 7574 6564  ssfully executed
+00009bb0: 2061 6e64 2068 6176 6520 7468 6569 7220   and have their 
+00009bc0: 7265 7375 6c74 2073 746f 7265 6420 6f6e  result stored on
+00009bd0: 2061 7420 6c65 6173 7420 6f6e 6520 776f   at least one wo
+00009be0: 726b 6572 2e20 5468 6973 0a20 2020 2023  rker. This.    #
+00009bf0: 3a20 6973 2074 7261 636b 6564 2062 7920  : is tracked by 
+00009c00: 7072 6f67 7265 7373 6976 656c 7920 6472  progressively dr
+00009c10: 6169 6e69 6e67 2074 6865 203a 6174 7472  aining the :attr
+00009c20: 3a60 7761 6974 696e 675f 6f6e 6020 7365  :`waiting_on` se
+00009c30: 742e 0a20 2020 2064 6570 656e 6465 6e63  t..    dependenc
+00009c40: 6965 733a 2073 6574 5b54 6173 6b53 7461  ies: set[TaskSta
+00009c50: 7465 5d0a 0a20 2020 2023 3a20 5468 6520  te]..    #: The 
+00009c60: 7365 7420 6f66 2074 6173 6b73 2077 6869  set of tasks whi
+00009c70: 6368 2064 6570 656e 6420 6f6e 2074 6869  ch depend on thi
+00009c80: 7320 7461 736b 2e20 204f 6e6c 7920 7461  s task.  Only ta
+00009c90: 736b 7320 7374 696c 6c20 616c 6976 6520  sks still alive 
+00009ca0: 6172 6520 6c69 7374 6564 2069 6e0a 2020  are listed in.  
+00009cb0: 2020 233a 2074 6869 7320 7365 742e 2054    #: this set. T
+00009cc0: 6869 7320 6973 2074 6865 2072 6576 6572  his is the rever
+00009cd0: 7365 206d 6170 7069 6e67 206f 6620 3a61  se mapping of :a
+00009ce0: 7474 723a 6064 6570 656e 6465 6e63 6965  ttr:`dependencie
+00009cf0: 7360 2e0a 2020 2020 6465 7065 6e64 656e  s`..    dependen
+00009d00: 7473 3a20 7365 745b 5461 736b 5374 6174  ts: set[TaskStat
+00009d10: 655d 0a0a 2020 2020 233a 2057 6865 7468  e]..    #: Wheth
+00009d20: 6572 2061 6e79 206f 6620 7468 6520 6465  er any of the de
+00009d30: 7065 6e64 656e 6369 6573 206f 6620 7468  pendencies of th
+00009d40: 6973 2074 6173 6b20 6861 7320 6265 656e  is task has been
+00009d50: 2066 6f72 676f 7474 656e 2e20 466f 7220   forgotten. For 
+00009d60: 6d65 6d6f 7279 0a20 2020 2023 3a20 636f  memory.    #: co
+00009d70: 6e73 756d 7074 696f 6e20 7265 6173 6f6e  nsumption reason
+00009d80: 732c 2066 6f72 676f 7474 656e 2074 6173  s, forgotten tas
+00009d90: 6b73 2061 7265 206e 6f74 206b 6570 7420  ks are not kept 
+00009da0: 696e 206d 656d 6f72 7920 6576 656e 2074  in memory even t
+00009db0: 686f 7567 6820 7468 6579 206d 6179 0a20  hough they may. 
+00009dc0: 2020 2023 3a20 6861 7665 2064 6570 656e     #: have depen
+00009dd0: 6465 6e74 2074 6173 6b73 2e20 2057 6865  dent tasks.  Whe
+00009de0: 6e20 6120 7461 736b 2069 7320 666f 7267  n a task is forg
+00009df0: 6f74 7465 6e2c 2074 6865 7265 666f 7265  otten, therefore
+00009e00: 2c20 6561 6368 206f 6620 6974 730a 2020  , each of its.  
+00009e10: 2020 233a 2064 6570 656e 6465 6e74 7320    #: dependents 
+00009e20: 6861 7320 7468 6569 7220 3a61 7474 723a  has their :attr:
+00009e30: 6068 6173 5f6c 6f73 745f 6465 7065 6e64  `has_lost_depend
+00009e40: 656e 6369 6573 6020 6174 7472 6962 7574  encies` attribut
+00009e50: 6520 7365 7420 746f 2060 6054 7275 6560  e set to ``True`
+00009e60: 602e 0a20 2020 2023 3a0a 2020 2020 233a  `..    #:.    #:
+00009e70: 2049 6620 3a61 7474 723a 6068 6173 5f6c   If :attr:`has_l
+00009e80: 6f73 745f 6465 7065 6e64 656e 6369 6573  ost_dependencies
+00009e90: 6020 6973 2074 7275 652c 2074 6869 7320  ` is true, this 
+00009ea0: 7461 736b 2063 616e 6e6f 7420 676f 2069  task cannot go i
+00009eb0: 6e74 6f20 7468 650a 2020 2020 233a 2022  nto the.    #: "
+00009ec0: 7072 6f63 6573 7369 6e67 2220 7374 6174  processing" stat
+00009ed0: 6520 616e 796d 6f72 652e 0a20 2020 2068  e anymore..    h
+00009ee0: 6173 5f6c 6f73 745f 6465 7065 6e64 656e  as_lost_dependen
+00009ef0: 6369 6573 3a20 626f 6f6c 0a0a 2020 2020  cies: bool..    
+00009f00: 233a 2054 6865 2073 6574 206f 6620 7461  #: The set of ta
+00009f10: 736b 7320 7468 6973 2074 6173 6b20 6973  sks this task is
+00009f20: 2077 6169 7469 6e67 206f 6e20 2a62 6566   waiting on *bef
+00009f30: 6f72 652a 2069 7420 6361 6e20 6265 2065  ore* it can be e
+00009f40: 7865 6375 7465 642e 2054 6869 7320 6973  xecuted. This is
+00009f50: 0a20 2020 2023 3a20 616c 7761 7973 2061  .    #: always a
+00009f60: 2073 7562 7365 7420 6f66 203a 6174 7472   subset of :attr
+00009f70: 3a60 6465 7065 6e64 656e 6369 6573 602e  :`dependencies`.
+00009f80: 2020 4561 6368 2074 696d 6520 6f6e 6520    Each time one 
+00009f90: 6f66 2074 6865 2064 6570 656e 6465 6e63  of the dependenc
+00009fa0: 6965 7320 6861 730a 2020 2020 233a 2066  ies has.    #: f
+00009fb0: 696e 6973 6865 6420 7072 6f63 6573 7369  inished processi
+00009fc0: 6e67 2c20 6974 2069 7320 7265 6d6f 7665  ng, it is remove
+00009fd0: 6420 6672 6f6d 2074 6865 203a 6174 7472  d from the :attr
+00009fe0: 3a60 7761 6974 696e 675f 6f6e 6020 7365  :`waiting_on` se
+00009ff0: 742e 0a20 2020 2023 3a0a 2020 2020 233a  t..    #:.    #:
+0000a000: 204f 6e63 6520 3a61 7474 723a 6077 6169   Once :attr:`wai
+0000a010: 7469 6e67 5f6f 6e60 2062 6563 6f6d 6573  ting_on` becomes
+0000a020: 2065 6d70 7479 2c20 7468 6973 2074 6173   empty, this tas
+0000a030: 6b20 6361 6e20 6d6f 7665 2066 726f 6d20  k can move from 
+0000a040: 7468 6520 2277 6169 7469 6e67 220a 2020  the "waiting".  
+0000a050: 2020 233a 2073 7461 7465 2074 6f20 7468    #: state to th
+0000a060: 6520 2270 726f 6365 7373 696e 6722 2073  e "processing" s
+0000a070: 7461 7465 2028 756e 6c65 7373 206f 6e65  tate (unless one
+0000a080: 206f 6620 7468 6520 6465 7065 6e64 656e   of the dependen
+0000a090: 6369 6573 2065 7272 6f72 6564 206f 7574  cies errored out
+0000a0a0: 2c20 696e 0a20 2020 2023 3a20 7768 6963  , in.    #: whic
+0000a0b0: 6820 6361 7365 2074 6869 7320 7461 736b  h case this task
+0000a0c0: 2069 7320 696e 7374 6561 6420 6d61 726b   is instead mark
+0000a0d0: 6564 2022 6572 7265 6422 292e 0a20 2020  ed "erred")..   
+0000a0e0: 2077 6169 7469 6e67 5f6f 6e3a 2073 6574   waiting_on: set
+0000a0f0: 5b54 6173 6b53 7461 7465 5d0a 0a20 2020  [TaskState]..   
+0000a100: 2023 3a20 5468 6520 7365 7420 6f66 2074   #: The set of t
+0000a110: 6173 6b73 2077 6869 6368 206e 6565 6420  asks which need 
+0000a120: 7468 6973 2074 6173 6b20 746f 2072 656d  this task to rem
+0000a130: 6169 6e20 616c 6976 652e 2020 5468 6973  ain alive.  This
+0000a140: 2069 7320 616c 7761 7973 2061 2073 7562   is always a sub
+0000a150: 7365 740a 2020 2020 233a 206f 6620 3a61  set.    #: of :a
+0000a160: 7474 723a 6064 6570 656e 6465 6e74 7360  ttr:`dependents`
+0000a170: 2e20 2045 6163 6820 7469 6d65 206f 6e65  .  Each time one
+0000a180: 206f 6620 7468 6520 6465 7065 6e64 656e   of the dependen
+0000a190: 7473 2068 6173 2066 696e 6973 6865 6420  ts has finished 
+0000a1a0: 7072 6f63 6573 7369 6e67 2c0a 2020 2020  processing,.    
+0000a1b0: 233a 2069 7420 6973 2072 656d 6f76 6564  #: it is removed
+0000a1c0: 2066 726f 6d20 7468 6520 3a61 7474 723a   from the :attr:
+0000a1d0: 6077 6169 7465 7273 6020 7365 742e 0a20  `waiters` set.. 
+0000a1e0: 2020 2023 3a0a 2020 2020 233a 204f 6e63     #:.    #: Onc
+0000a1f0: 6520 626f 7468 203a 6174 7472 3a60 7761  e both :attr:`wa
+0000a200: 6974 6572 7360 2061 6e64 203a 6174 7472  iters` and :attr
+0000a210: 3a60 7768 6f5f 7761 6e74 7360 2062 6563  :`who_wants` bec
+0000a220: 6f6d 6520 656d 7074 792c 2074 6869 7320  ome empty, this 
+0000a230: 7461 736b 2063 616e 2062 650a 2020 2020  task can be.    
+0000a240: 233a 2072 656c 6561 7365 6420 2869 6620  #: released (if 
+0000a250: 6974 2068 6173 2061 206e 6f6e 2d65 6d70  it has a non-emp
+0000a260: 7479 203a 6174 7472 3a60 7275 6e5f 7370  ty :attr:`run_sp
+0000a270: 6563 6029 206f 7220 666f 7267 6f74 7465  ec`) or forgotte
+0000a280: 6e20 286f 7468 6572 7769 7365 2920 6279  n (otherwise) by
+0000a290: 2074 6865 0a20 2020 2023 3a20 7363 6865   the.    #: sche
+0000a2a0: 6475 6c65 722c 2061 6e64 2062 7920 616e  duler, and by an
+0000a2b0: 7920 776f 726b 6572 7320 696e 203a 6174  y workers in :at
+0000a2c0: 7472 3a60 7768 6f5f 6861 7360 2e0a 2020  tr:`who_has`..  
+0000a2d0: 2020 233a 0a20 2020 2023 3a20 2e2e 206e    #:.    #: .. n
+0000a2e0: 6f74 653a 3a0a 2020 2020 233a 2020 2020  ote::.    #:    
+0000a2f0: 436f 756e 7465 722d 696e 7475 6974 6976  Counter-intuitiv
+0000a300: 656c 792c 203a 6174 7472 3a60 7761 6974  ely, :attr:`wait
+0000a310: 696e 675f 6f6e 6020 616e 6420 3a61 7474  ing_on` and :att
+0000a320: 723a 6077 6169 7465 7273 6020 6172 6520  r:`waiters` are 
+0000a330: 6e6f 7420 7265 7665 7273 650a 2020 2020  not reverse.    
+0000a340: 233a 2020 2020 6d61 7070 696e 6773 206f  #:    mappings o
+0000a350: 6620 6561 6368 206f 7468 6572 2e0a 2020  f each other..  
+0000a360: 2020 7761 6974 6572 733a 2073 6574 5b54    waiters: set[T
+0000a370: 6173 6b53 7461 7465 5d0a 0a20 2020 2023  askState]..    #
+0000a380: 3a20 5468 6520 7365 7420 6f66 2063 6c69  : The set of cli
+0000a390: 656e 7473 2077 686f 2077 616e 7420 7468  ents who want th
+0000a3a0: 6520 7265 7375 6c74 206f 6620 7468 6973  e result of this
+0000a3b0: 2074 6173 6b20 746f 2072 656d 6169 6e20   task to remain 
+0000a3c0: 616c 6976 652e 0a20 2020 2023 3a20 5468  alive..    #: Th
+0000a3d0: 6973 2069 7320 7468 6520 7265 7665 7273  is is the revers
+0000a3e0: 6520 6d61 7070 696e 6720 6f66 203a 6174  e mapping of :at
+0000a3f0: 7472 3a60 436c 6965 6e74 5374 6174 652e  tr:`ClientState.
+0000a400: 7761 6e74 735f 7768 6174 602e 0a20 2020  wants_what`..   
+0000a410: 2023 3a0a 2020 2020 233a 2057 6865 6e20   #:.    #: When 
+0000a420: 6120 636c 6965 6e74 2073 7562 6d69 7473  a client submits
+0000a430: 2061 2067 7261 7068 2074 6f20 7468 6520   a graph to the 
+0000a440: 7363 6865 6475 6c65 7220 6974 2061 6c73  scheduler it als
+0000a450: 6f20 7370 6563 6966 6965 7320 7768 6963  o specifies whic
+0000a460: 6820 6f75 7470 7574 0a20 2020 2023 3a20  h output.    #: 
+0000a470: 7461 736b 7320 6974 2064 6573 6972 6573  tasks it desires
+0000a480: 2c20 7375 6368 2074 6861 7420 7468 6569  , such that thei
+0000a490: 7220 7265 7375 6c74 7320 6172 6520 6e6f  r results are no
+0000a4a0: 7420 7265 6c65 6173 6564 2066 726f 6d20  t released from 
+0000a4b0: 6d65 6d6f 7279 2e0a 2020 2020 233a 0a20  memory..    #:. 
+0000a4c0: 2020 2023 3a20 4f6e 6365 2061 2074 6173     #: Once a tas
+0000a4d0: 6b20 6861 7320 6669 6e69 7368 6564 2065  k has finished e
+0000a4e0: 7865 6375 7469 6e67 2028 692e 652e 206d  xecuting (i.e. m
+0000a4f0: 6f76 6573 2069 6e74 6f20 7468 6520 226d  oves into the "m
+0000a500: 656d 6f72 7922 206f 7220 2265 7272 6564  emory" or "erred
+0000a510: 220a 2020 2020 233a 2073 7461 7465 292c  ".    #: state),
+0000a520: 2074 6865 2063 6c69 656e 7473 2069 6e20   the clients in 
+0000a530: 3a61 7474 723a 6077 686f 5f77 616e 7473  :attr:`who_wants
+0000a540: 6020 6172 6520 6e6f 7469 6669 6564 2e0a  ` are notified..
+0000a550: 2020 2020 233a 0a20 2020 2023 3a20 4f6e      #:.    #: On
+0000a560: 6365 2062 6f74 6820 3a61 7474 723a 6077  ce both :attr:`w
+0000a570: 6169 7465 7273 6020 616e 6420 3a61 7474  aiters` and :att
+0000a580: 723a 6077 686f 5f77 616e 7473 6020 6265  r:`who_wants` be
+0000a590: 636f 6d65 2065 6d70 7479 2c20 7468 6973  come empty, this
+0000a5a0: 2074 6173 6b20 6361 6e20 6265 0a20 2020   task can be.   
+0000a5b0: 2023 3a20 7265 6c65 6173 6564 2028 6966   #: released (if
+0000a5c0: 2069 7420 6861 7320 6120 6e6f 6e2d 656d   it has a non-em
+0000a5d0: 7074 7920 3a61 7474 723a 6072 756e 5f73  pty :attr:`run_s
+0000a5e0: 7065 6360 2920 6f72 2066 6f72 676f 7474  pec`) or forgott
+0000a5f0: 656e 2028 6f74 6865 7277 6973 6529 2062  en (otherwise) b
+0000a600: 7920 7468 650a 2020 2020 233a 2073 6368  y the.    #: sch
+0000a610: 6564 756c 6572 2c20 616e 6420 6279 2061  eduler, and by a
+0000a620: 6e79 2077 6f72 6b65 7273 2069 6e20 3a61  ny workers in :a
+0000a630: 7474 723a 6077 686f 5f68 6173 602e 0a20  ttr:`who_has`.. 
+0000a640: 2020 2077 686f 5f77 616e 7473 3a20 7365     who_wants: se
+0000a650: 745b 436c 6965 6e74 5374 6174 655d 0a0a  t[ClientState]..
+0000a660: 2020 2020 233a 2054 6865 2073 6574 206f      #: The set o
+0000a670: 6620 776f 726b 6572 7320 7768 6f20 6861  f workers who ha
+0000a680: 7665 2074 6869 7320 7461 736b 2773 2072  ve this task's r
+0000a690: 6573 756c 7420 696e 206d 656d 6f72 792e  esult in memory.
+0000a6a0: 2049 7420 6973 206e 6f6e 2d65 6d70 7479   It is non-empty
+0000a6b0: 2069 6666 2074 6865 0a20 2020 2023 3a20   iff the.    #: 
+0000a6c0: 7461 736b 2069 7320 696e 2074 6865 2022  task is in the "
+0000a6d0: 6d65 6d6f 7279 2220 7374 6174 652e 2020  memory" state.  
+0000a6e0: 5468 6572 6520 6361 6e20 6265 206d 6f72  There can be mor
+0000a6f0: 6520 7468 616e 206f 6e65 2077 6f72 6b65  e than one worke
+0000a700: 7220 696e 2074 6869 7320 7365 7420 6966  r in this set if
+0000a710: 2c0a 2020 2020 233a 2066 6f72 2065 7861  ,.    #: for exa
+0000a720: 6d70 6c65 2c20 3a6d 6574 683a 6043 6c69  mple, :meth:`Cli
+0000a730: 656e 742e 7363 6174 7465 7260 206f 7220  ent.scatter` or 
+0000a740: 3a6d 6574 683a 6043 6c69 656e 742e 7265  :meth:`Client.re
+0000a750: 706c 6963 6174 6560 2077 6173 2075 7365  plicate` was use
+0000a760: 642e 0a20 2020 2023 3a0a 2020 2020 233a  d..    #:.    #:
+0000a770: 2054 6869 7320 6973 2074 6865 2072 6576   This is the rev
+0000a780: 6572 7365 206d 6170 7069 6e67 206f 6620  erse mapping of 
+0000a790: 3a61 7474 723a 6057 6f72 6b65 7253 7461  :attr:`WorkerSta
+0000a7a0: 7465 2e68 6173 5f77 6861 7460 2e0a 2020  te.has_what`..  
+0000a7b0: 2020 7768 6f5f 6861 733a 2073 6574 5b57    who_has: set[W
+0000a7c0: 6f72 6b65 7253 7461 7465 5d0a 0a20 2020  orkerState]..   
+0000a7d0: 2023 3a20 4966 2074 6869 7320 7461 736b   #: If this task
+0000a7e0: 2069 7320 696e 2074 6865 2022 7072 6f63   is in the "proc
+0000a7f0: 6573 7369 6e67 2220 7374 6174 652c 2077  essing" state, w
+0000a800: 6869 6368 2077 6f72 6b65 7220 6973 2063  hich worker is c
+0000a810: 7572 7265 6e74 6c79 2070 726f 6365 7373  urrently process
+0000a820: 696e 670a 2020 2020 233a 2069 742e 2054  ing.    #: it. T
+0000a830: 6869 7320 6174 7472 6962 7574 6520 6973  his attribute is
+0000a840: 206b 6570 7420 696e 2073 796e 6320 7769   kept in sync wi
+0000a850: 7468 203a 6174 7472 3a60 576f 726b 6572  th :attr:`Worker
+0000a860: 5374 6174 652e 7072 6f63 6573 7369 6e67  State.processing
+0000a870: 602e 0a20 2020 2070 726f 6365 7373 696e  `..    processin
+0000a880: 675f 6f6e 3a20 576f 726b 6572 5374 6174  g_on: WorkerStat
+0000a890: 6520 7c20 4e6f 6e65 0a0a 2020 2020 233a  e | None..    #:
+0000a8a0: 2054 6865 206e 756d 6265 7220 6f66 2074   The number of t
+0000a8b0: 696d 6573 2074 6869 7320 7461 736b 2063  imes this task c
+0000a8c0: 616e 2061 7574 6f6d 6174 6963 616c 6c79  an automatically
+0000a8d0: 2062 6520 7265 7472 6965 6420 696e 2063   be retried in c
+0000a8e0: 6173 6520 6f66 2066 6169 6c75 7265 2e0a  ase of failure..
+0000a8f0: 2020 2020 233a 2049 6620 6120 7461 736b      #: If a task
+0000a900: 2066 6169 6c73 2065 7865 6375 7469 6e67   fails executing
+0000a910: 2028 7468 6520 776f 726b 6572 2072 6574   (the worker ret
+0000a920: 7572 6e73 2077 6974 6820 616e 2065 7272  urns with an err
+0000a930: 6f72 292c 2069 7473 203a 6174 7472 3a60  or), its :attr:`
+0000a940: 7265 7472 6965 7360 0a20 2020 2023 3a20  retries`.    #: 
+0000a950: 6174 7472 6962 7574 6520 6973 2063 6865  attribute is che
+0000a960: 636b 6564 2e20 4966 2069 7420 6973 2065  cked. If it is e
+0000a970: 7175 616c 2074 6f20 302c 2074 6865 2074  qual to 0, the t
+0000a980: 6173 6b20 6973 206d 6172 6b65 6420 2265  ask is marked "e
+0000a990: 7272 6564 222e 2049 6620 6974 2069 730a  rred". If it is.
+0000a9a0: 2020 2020 233a 2067 7265 6174 6572 2074      #: greater t
+0000a9b0: 6861 6e20 302c 2074 6865 203a 6174 7472  han 0, the :attr
+0000a9c0: 3a60 7265 7472 6965 7360 2061 7474 7269  :`retries` attri
+0000a9d0: 6275 7465 2069 7320 6465 6372 656d 656e  bute is decremen
+0000a9e0: 7465 6420 616e 6420 6578 6563 7574 696f  ted and executio
+0000a9f0: 6e20 6973 0a20 2020 2023 3a20 6174 7465  n is.    #: atte
+0000aa00: 6d70 7465 6420 6167 6169 6e2e 0a20 2020  mpted again..   
+0000aa10: 2072 6574 7269 6573 3a20 696e 740a 0a20   retries: int.. 
+0000aa20: 2020 2023 3a20 5468 6520 6e75 6d62 6572     #: The number
+0000aa30: 206f 6620 6279 7465 732c 2061 7320 6465   of bytes, as de
+0000aa40: 7465 726d 696e 6564 2062 7920 6060 7369  termined by ``si
+0000aa50: 7a65 6f66 6060 2c20 6f66 2074 6865 2072  zeof``, of the r
+0000aa60: 6573 756c 7420 6f66 2061 2066 696e 6973  esult of a finis
+0000aa70: 6865 640a 2020 2020 233a 2074 6173 6b2e  hed.    #: task.
+0000aa80: 2054 6869 7320 6e75 6d62 6572 2069 7320   This number is 
+0000aa90: 7573 6564 2066 6f72 2064 6961 676e 6f73  used for diagnos
+0000aaa0: 7469 6373 2061 6e64 2074 6f20 6865 6c70  tics and to help
+0000aab0: 2070 7269 6f72 6974 697a 6520 776f 726b   prioritize work
+0000aac0: 2e0a 2020 2020 233a 2053 6574 2074 6f20  ..    #: Set to 
+0000aad0: 2d31 2066 6f72 2075 6e66 696e 6973 6865  -1 for unfinishe
+0000aae0: 6420 7461 736b 732e 0a20 2020 206e 6279  d tasks..    nby
+0000aaf0: 7465 733a 2069 6e74 0a0a 2020 2020 233a  tes: int..    #:
+0000ab00: 2054 6865 2074 7970 6520 6f66 2074 6865   The type of the
+0000ab10: 206f 626a 6563 7420 6173 2061 2073 7472   object as a str
+0000ab20: 696e 672e 204f 6e6c 7920 7072 6573 656e  ing. Only presen
+0000ab30: 7420 666f 7220 7461 736b 7320 7468 6174  t for tasks that
+0000ab40: 2068 6176 6520 6265 656e 0a20 2020 2023   have been.    #
+0000ab50: 3a20 636f 6d70 7574 6564 2e0a 2020 2020  : computed..    
+0000ab60: 7479 7065 3a20 7374 720a 0a20 2020 2023  type: str..    #
+0000ab70: 3a20 4966 2074 6869 7320 7461 736b 2066  : If this task f
+0000ab80: 6169 6c65 6420 6578 6563 7574 696e 672c  ailed executing,
+0000ab90: 2074 6865 2065 7863 6570 7469 6f6e 206f   the exception o
+0000aba0: 626a 6563 7420 6973 2073 746f 7265 6420  bject is stored 
+0000abb0: 6865 7265 2e0a 2020 2020 6578 6365 7074  here..    except
+0000abc0: 696f 6e3a 2053 6572 6961 6c69 7a65 6420  ion: Serialized 
+0000abd0: 7c20 4e6f 6e65 0a0a 2020 2020 233a 2049  | None..    #: I
+0000abe0: 6620 7468 6973 2074 6173 6b20 6661 696c  f this task fail
+0000abf0: 6564 2065 7865 6375 7469 6e67 2c20 7468  ed executing, th
+0000ac00: 6520 7472 6163 6562 6163 6b20 6f62 6a65  e traceback obje
+0000ac10: 6374 2069 7320 7374 6f72 6564 2068 6572  ct is stored her
+0000ac20: 652e 0a20 2020 2074 7261 6365 6261 636b  e..    traceback
+0000ac30: 3a20 5365 7269 616c 697a 6564 207c 204e  : Serialized | N
+0000ac40: 6f6e 650a 0a20 2020 2023 3a20 7374 7269  one..    #: stri
+0000ac50: 6e67 2072 6570 7265 7365 6e74 6174 696f  ng representatio
+0000ac60: 6e20 6f66 2065 7863 6570 7469 6f6e 0a20  n of exception. 
+0000ac70: 2020 2065 7863 6570 7469 6f6e 5f74 6578     exception_tex
+0000ac80: 743a 2073 7472 0a0a 2020 2020 233a 2073  t: str..    #: s
+0000ac90: 7472 696e 6720 7265 7072 6573 656e 7461  tring representa
+0000aca0: 7469 6f6e 206f 6620 7472 6163 6562 6163  tion of tracebac
+0000acb0: 6b0a 2020 2020 7472 6163 6562 6163 6b5f  k.    traceback_
+0000acc0: 7465 7874 3a20 7374 720a 0a20 2020 2023  text: str..    #
+0000acd0: 3a20 4966 2074 6869 7320 7461 736b 206f  : If this task o
+0000ace0: 7220 6f6e 6520 6f66 2069 7473 2064 6570  r one of its dep
+0000acf0: 656e 6465 6e63 6965 7320 6661 696c 6564  endencies failed
+0000ad00: 2065 7865 6375 7469 6e67 2c20 7468 6520   executing, the 
+0000ad10: 6661 696c 6564 2074 6173 6b20 6973 0a20  failed task is. 
+0000ad20: 2020 2023 3a20 7374 6f72 6564 2068 6572     #: stored her
+0000ad30: 6520 2870 6f73 7369 626c 7920 6974 7365  e (possibly itse
+0000ad40: 6c66 292e 0a20 2020 2065 7863 6570 7469  lf)..    excepti
+0000ad50: 6f6e 5f62 6c61 6d65 3a20 5461 736b 5374  on_blame: TaskSt
+0000ad60: 6174 6520 7c20 4e6f 6e65 0a0a 2020 2020  ate | None..    
+0000ad70: 233a 2057 6f72 6b65 7220 6164 6472 6573  #: Worker addres
+0000ad80: 7365 7320 6f6e 2077 6869 6368 2065 7272  ses on which err
+0000ad90: 6f72 7320 6170 7065 6172 6564 2c20 6361  ors appeared, ca
+0000ada0: 7573 696e 6720 7468 6973 2074 6173 6b20  using this task 
+0000adb0: 746f 2062 6520 696e 2061 6e20 6572 726f  to be in an erro
+0000adc0: 720a 2020 2020 233a 2073 7461 7465 2e0a  r.    #: state..
+0000add0: 2020 2020 6572 7265 645f 6f6e 3a20 7365      erred_on: se
+0000ade0: 745b 7374 725d 0a0a 2020 2020 233a 2054  t[str]..    #: T
+0000adf0: 6865 206e 756d 6265 7220 6f66 2074 696d  he number of tim
+0000ae00: 6573 2074 6869 7320 7461 736b 2068 6173  es this task has
+0000ae10: 2062 6565 6e20 696e 766f 6c76 6564 2069   been involved i
+0000ae20: 6e20 6120 776f 726b 6572 2064 6561 7468  n a worker death
+0000ae30: 2e0a 2020 2020 233a 0a20 2020 2023 3a20  ..    #:.    #: 
+0000ae40: 536f 6d65 2074 6173 6b73 206d 6179 2063  Some tasks may c
+0000ae50: 6175 7365 2077 6f72 6b65 7273 2074 6f20  ause workers to 
+0000ae60: 6469 6520 2873 7563 6820 6173 2063 616c  die (such as cal
+0000ae70: 6c69 6e67 2060 606f 732e 5f65 7869 7428  ling ``os._exit(
+0000ae80: 3029 6060 292e 2057 6865 6e20 610a 2020  0)``). When a.  
+0000ae90: 2020 233a 2077 6f72 6b65 7220 6469 6573    #: worker dies
+0000aea0: 2c20 616c 6c20 6f66 2074 6865 2074 6173  , all of the tas
+0000aeb0: 6b73 206f 6e20 7468 6174 2077 6f72 6b65  ks on that worke
+0000aec0: 7220 6172 6520 7265 6173 7369 676e 6564  r are reassigned
+0000aed0: 2074 6f20 6f74 6865 7273 2e20 5468 6973   to others. This
+0000aee0: 0a20 2020 2023 3a20 636f 6d62 696e 6174  .    #: combinat
+0000aef0: 696f 6e20 6f66 2062 6568 6176 696f 7273  ion of behaviors
+0000af00: 2063 616e 2063 6175 7365 2061 2062 6164   can cause a bad
+0000af10: 2074 6173 6b20 746f 2063 6174 6173 7472   task to catastr
+0000af20: 6f70 6869 6361 6c6c 7920 6465 7374 726f  ophically destro
+0000af30: 7920 616c 6c0a 2020 2020 233a 2077 6f72  y all.    #: wor
+0000af40: 6b65 7273 206f 6e20 7468 6520 636c 7573  kers on the clus
+0000af50: 7465 722c 206f 6e65 2061 6674 6572 2061  ter, one after a
+0000af60: 6e6f 7468 6572 2e20 5768 656e 6576 6572  nother. Whenever
+0000af70: 2061 2077 6f72 6b65 7220 6469 6573 2c20   a worker dies, 
+0000af80: 7765 206d 6172 6b20 6561 6368 0a20 2020  we mark each.   
+0000af90: 2023 3a20 7461 736b 2063 7572 7265 6e74   #: task current
+0000afa0: 6c79 2070 726f 6365 7373 696e 6720 6f6e  ly processing on
+0000afb0: 2074 6861 7420 776f 726b 6572 2028 6173   that worker (as
+0000afc0: 2072 6563 6f72 6465 6420 6279 0a20 2020   recorded by.   
+0000afd0: 2023 3a20 3a61 7474 723a 6057 6f72 6b65   #: :attr:`Worke
+0000afe0: 7253 7461 7465 2e70 726f 6365 7373 696e  rState.processin
+0000aff0: 6760 2920 6173 2073 7573 7069 6369 6f75  g`) as suspiciou
+0000b000: 732e 2049 6620 6120 7461 736b 2069 7320  s. If a task is 
+0000b010: 696e 766f 6c76 6564 2069 6e20 7468 7265  involved in thre
+0000b020: 650a 2020 2020 233a 2064 6561 7468 7320  e.    #: deaths 
+0000b030: 286f 7220 736f 6d65 206f 7468 6572 2066  (or some other f
+0000b040: 6978 6564 2063 6f6e 7374 616e 7429 2074  ixed constant) t
+0000b050: 6865 6e20 7765 206d 6172 6b20 7468 6520  hen we mark the 
+0000b060: 7461 736b 2061 7320 6060 6572 7265 6460  task as ``erred`
+0000b070: 602e 0a20 2020 2073 7573 7069 6369 6f75  `..    suspiciou
+0000b080: 733a 2069 6e74 0a0a 2020 2020 233a 2041  s: int..    #: A
+0000b090: 2073 6574 206f 6620 686f 7374 6e61 6d65   set of hostname
+0000b0a0: 7320 7768 6572 6520 7468 6973 2074 6173  s where this tas
+0000b0b0: 6b20 6361 6e20 6265 2072 756e 2028 6f72  k can be run (or
+0000b0c0: 2060 604e 6f6e 6560 6020 6966 2065 6d70   ``None`` if emp
+0000b0d0: 7479 292e 2055 7375 616c 6c79 0a20 2020  ty). Usually.   
+0000b0e0: 2023 3a20 7468 6973 2069 7320 656d 7074   #: this is empt
+0000b0f0: 7920 756e 6c65 7373 2074 6865 2074 6173  y unless the tas
+0000b100: 6b20 6861 7320 6265 656e 2073 7065 6369  k has been speci
+0000b110: 6669 6361 6c6c 7920 7265 7374 7269 6374  fically restrict
+0000b120: 6564 2074 6f20 6f6e 6c79 2072 756e 206f  ed to only run o
+0000b130: 6e0a 2020 2020 233a 2063 6572 7461 696e  n.    #: certain
+0000b140: 2068 6f73 7473 2e20 4120 686f 7374 6e61   hosts. A hostna
+0000b150: 6d65 206d 6179 2063 6f72 7265 7370 6f6e  me may correspon
+0000b160: 6420 746f 206f 6e65 206f 7220 7365 7665  d to one or seve
+0000b170: 7261 6c20 636f 6e6e 6563 7465 6420 776f  ral connected wo
+0000b180: 726b 6572 732e 0a20 2020 2068 6f73 745f  rkers..    host_
+0000b190: 7265 7374 7269 6374 696f 6e73 3a20 7365  restrictions: se
+0000b1a0: 745b 7374 725d 0a0a 2020 2020 233a 2041  t[str]..    #: A
+0000b1b0: 2073 6574 206f 6620 636f 6d70 6c65 7465   set of complete
+0000b1c0: 2077 6f72 6b65 7220 6164 6472 6573 7365   worker addresse
+0000b1d0: 7320 7768 6572 6520 7468 6973 2063 616e  s where this can
+0000b1e0: 2062 6520 7275 6e20 286f 7220 6060 4e6f   be run (or ``No
+0000b1f0: 6e65 6060 2069 6620 656d 7074 7929 2e0a  ne`` if empty)..
+0000b200: 2020 2020 233a 2055 7375 616c 6c79 2074      #: Usually t
+0000b210: 6869 7320 6973 2065 6d70 7479 2075 6e6c  his is empty unl
+0000b220: 6573 7320 7468 6520 7461 736b 2068 6173  ess the task has
+0000b230: 2062 6565 6e20 7370 6563 6966 6963 616c   been specifical
+0000b240: 6c79 2072 6573 7472 6963 7465 6420 746f  ly restricted to
+0000b250: 206f 6e6c 790a 2020 2020 233a 2072 756e   only.    #: run
+0000b260: 206f 6e20 6365 7274 6169 6e20 776f 726b   on certain work
+0000b270: 6572 732e 0a20 2020 2023 3a20 4e6f 7465  ers..    #: Note
+0000b280: 2074 6869 7320 6973 2074 7261 636b 696e   this is trackin
+0000b290: 6720 776f 726b 6572 2061 6464 7265 7373  g worker address
+0000b2a0: 6573 2c20 6e6f 7420 776f 726b 6572 2073  es, not worker s
+0000b2b0: 7461 7465 732c 2073 696e 6365 2074 6865  tates, since the
+0000b2c0: 2073 7065 6369 6669 630a 2020 2020 233a   specific.    #:
+0000b2d0: 2077 6f72 6b65 7273 206d 6179 206e 6f74   workers may not
+0000b2e0: 2062 6520 636f 6e6e 6563 7465 6420 6174   be connected at
+0000b2f0: 2074 6869 7320 7469 6d65 2e0a 2020 2020   this time..    
+0000b300: 776f 726b 6572 5f72 6573 7472 6963 7469  worker_restricti
+0000b310: 6f6e 733a 2073 6574 5b73 7472 5d0a 0a20  ons: set[str].. 
+0000b320: 2020 2023 3a20 5265 736f 7572 6365 7320     #: Resources 
+0000b330: 7265 7175 6972 6564 2062 7920 7468 6973  required by this
+0000b340: 2074 6173 6b2c 2073 7563 6820 6173 2060   task, such as `
+0000b350: 607b 2767 7075 273a 2031 7d60 6020 6f72  `{'gpu': 1}`` or
+0000b360: 2060 607b 276d 656d 6f72 7927 3a20 3165   ``{'memory': 1e
+0000b370: 397d 6060 0a20 2020 2023 3a20 5468 6573  9}``.    #: Thes
+0000b380: 6520 6172 6520 7573 6572 2d64 6566 696e  e are user-defin
+0000b390: 6564 206e 616d 6573 2061 6e64 2061 7265  ed names and are
+0000b3a0: 206d 6174 6368 6564 2061 6761 696e 7374   matched against
+0000b3b0: 2074 6865 203a 2063 6f6e 7465 6e74 7320   the : contents 
+0000b3c0: 6f66 2065 6163 680a 2020 2020 233a 203a  of each.    #: :
+0000b3d0: 6174 7472 3a60 576f 726b 6572 5374 6174  attr:`WorkerStat
+0000b3e0: 652e 7265 736f 7572 6365 7360 2064 6963  e.resources` dic
+0000b3f0: 7469 6f6e 6172 792e 0a20 2020 2072 6573  tionary..    res
+0000b400: 6f75 7263 655f 7265 7374 7269 6374 696f  ource_restrictio
+0000b410: 6e73 3a20 6469 6374 5b73 7472 2c20 666c  ns: dict[str, fl
+0000b420: 6f61 745d 0a0a 2020 2020 233a 2046 616c  oat]..    #: Fal
+0000b430: 7365 0a20 2020 2023 3a20 2020 2020 4561  se.    #:     Ea
+0000b440: 6368 206f 6620 3a61 7474 723a 6068 6f73  ch of :attr:`hos
+0000b450: 745f 7265 7374 7269 6374 696f 6e73 602c  t_restrictions`,
+0000b460: 203a 6174 7472 3a60 776f 726b 6572 5f72   :attr:`worker_r
+0000b470: 6573 7472 6963 7469 6f6e 7360 2061 6e64  estrictions` and
+0000b480: 0a20 2020 2023 3a20 2020 2020 3a61 7474  .    #:     :att
+0000b490: 723a 6072 6573 6f75 7263 655f 7265 7374  r:`resource_rest
+0000b4a0: 7269 6374 696f 6e73 6020 6973 2061 2068  rictions` is a h
+0000b4b0: 6172 6420 636f 6e73 7472 6169 6e74 3a20  ard constraint: 
+0000b4c0: 6966 206e 6f20 776f 726b 6572 2069 7320  if no worker is 
+0000b4d0: 6176 6169 6c61 626c 650a 2020 2020 233a  available.    #:
+0000b4e0: 2020 2020 2073 6174 6973 6679 696e 6720       satisfying 
+0000b4f0: 7468 6f73 6520 7265 7374 7269 6374 696f  those restrictio
+0000b500: 6e73 2c20 7468 6520 7461 736b 2063 616e  ns, the task can
+0000b510: 6e6f 7420 676f 2069 6e74 6f20 7468 6520  not go into the 
+0000b520: 2270 726f 6365 7373 696e 6722 2073 7461  "processing" sta
+0000b530: 7465 0a20 2020 2023 3a20 2020 2020 616e  te.    #:     an
+0000b540: 6420 7769 6c6c 2069 6e73 7465 6164 2067  d will instead g
+0000b550: 6f20 696e 746f 2074 6865 2022 6e6f 2d77  o into the "no-w
+0000b560: 6f72 6b65 7222 2073 7461 7465 2e0a 2020  orker" state..  
+0000b570: 2020 233a 2054 7275 650a 2020 2020 233a    #: True.    #:
+0000b580: 2020 2020 2054 6865 2061 626f 7665 2072       The above r
+0000b590: 6573 7472 6963 7469 6f6e 7320 6172 6520  estrictions are 
+0000b5a0: 6d65 7265 2070 7265 6665 7265 6e63 6573  mere preferences
+0000b5b0: 3a20 6966 206e 6f20 776f 726b 6572 2069  : if no worker i
+0000b5c0: 7320 6176 6169 6c61 626c 650a 2020 2020  s available.    
+0000b5d0: 233a 2020 2020 2073 6174 6973 6679 696e  #:     satisfyin
+0000b5e0: 6720 7468 6f73 6520 7265 7374 7269 6374  g those restrict
+0000b5f0: 696f 6e73 2c20 7468 6520 7461 736b 2063  ions, the task c
+0000b600: 616e 2073 7469 6c6c 2067 6f20 696e 746f  an still go into
+0000b610: 2074 6865 0a20 2020 2023 3a20 2020 2020   the.    #:     
+0000b620: 2270 726f 6365 7373 696e 6722 2073 7461  "processing" sta
+0000b630: 7465 2061 6e64 2062 6520 7365 6e74 2066  te and be sent f
+0000b640: 6f72 2065 7865 6375 7469 6f6e 2074 6f20  or execution to 
+0000b650: 616e 6f74 6865 7220 636f 6e6e 6563 7465  another connecte
+0000b660: 6420 776f 726b 6572 2e0a 2020 2020 6c6f  d worker..    lo
+0000b670: 6f73 655f 7265 7374 7269 6374 696f 6e73  ose_restrictions
+0000b680: 3a20 626f 6f6c 0a0a 2020 2020 233a 2057  : bool..    #: W
+0000b690: 6865 7468 6572 2074 6869 7320 7461 736b  hether this task
+0000b6a0: 2069 7320 616e 2041 6374 6f72 0a20 2020   is an Actor.   
+0000b6b0: 2061 6374 6f72 3a20 626f 6f6c 0a0a 2020   actor: bool..  
+0000b6c0: 2020 233a 2054 6865 2067 726f 7570 206f    #: The group o
+0000b6d0: 6620 7461 736b 7320 746f 2077 6869 6368  f tasks to which
+0000b6e0: 2074 6869 7320 6f6e 6520 6265 6c6f 6e67   this one belong
+0000b6f0: 730a 2020 2020 6772 6f75 703a 2054 6173  s.    group: Tas
+0000b700: 6b47 726f 7570 0a0a 2020 2020 233a 2053  kGroup..    #: S
+0000b710: 616d 6520 6173 206f 6620 6772 6f75 702e  ame as of group.
+0000b720: 6e61 6d65 0a20 2020 2067 726f 7570 5f6b  name.    group_k
+0000b730: 6579 3a20 7374 720a 0a20 2020 2023 3a20  ey: str..    #: 
+0000b740: 4d65 7461 6461 7461 2072 656c 6174 6564  Metadata related
+0000b750: 2074 6f20 7461 736b 0a20 2020 206d 6574   to task.    met
+0000b760: 6164 6174 613a 2064 6963 745b 7374 722c  adata: dict[str,
+0000b770: 2041 6e79 5d0a 0a20 2020 2023 3a20 5461   Any]..    #: Ta
+0000b780: 736b 2061 6e6e 6f74 6174 696f 6e73 0a20  sk annotations. 
+0000b790: 2020 2061 6e6e 6f74 6174 696f 6e73 3a20     annotations: 
+0000b7a0: 6469 6374 5b73 7472 2c20 416e 795d 0a0a  dict[str, Any]..
+0000b7b0: 2020 2020 233a 2054 6865 2075 6e69 7175      #: The uniqu
+0000b7c0: 6520 6964 656e 7469 6669 6572 206f 6620  e identifier of 
+0000b7d0: 6120 7370 6563 6966 6963 2065 7865 6375  a specific execu
+0000b7e0: 7469 6f6e 206f 6620 6120 7461 736b 2e20  tion of a task. 
+0000b7f0: 5468 6973 2069 6465 6e74 6966 6965 720a  This identifier.
+0000b800: 2020 2020 233a 2069 7320 7573 6564 2074      #: is used t
+0000b810: 6f20 7369 676e 2061 2074 6173 6b20 7375  o sign a task su
+0000b820: 6368 2074 6861 7420 7468 6520 6173 7369  ch that the assi
+0000b830: 676e 6564 2077 6f72 6b65 7220 6973 2065  gned worker is e
+0000b840: 7870 6563 7465 6420 746f 2072 6574 7572  xpected to retur
+0000b850: 6e0a 2020 2020 233a 2074 6865 2073 616d  n.    #: the sam
+0000b860: 6520 6964 656e 7469 6669 6572 2069 6e20  e identifier in 
+0000b870: 7468 6520 7461 736b 2d66 696e 6973 6865  the task-finishe
+0000b880: 6420 6d65 7373 6167 652e 2054 6869 7320  d message. This 
+0000b890: 6973 2075 7365 6420 746f 2063 6f72 7265  is used to corre
+0000b8a0: 6c61 7465 0a20 2020 2023 3a20 7265 7370  late.    #: resp
+0000b8b0: 6f6e 7365 732e 0a20 2020 2023 3a20 4f6e  onses..    #: On
+0000b8c0: 6c79 2074 6865 206d 6f73 7420 7265 6365  ly the most rece
+0000b8d0: 6e74 6c79 2061 7373 6967 6e65 6420 776f  ntly assigned wo
+0000b8e0: 726b 6572 2069 7320 7472 7573 7465 642e  rker is trusted.
+0000b8f0: 2041 6c6c 206f 7468 6572 2072 6573 756c   All other resul
+0000b900: 7473 2077 696c 6c0a 2020 2020 233a 2062  ts will.    #: b
+0000b910: 6520 7265 6a65 6374 6564 2e0a 2020 2020  e rejected..    
+0000b920: 7275 6e5f 6964 3a20 696e 7420 7c20 4e6f  run_id: int | No
+0000b930: 6e65 0a0a 2020 2020 233a 2043 6163 6865  ne..    #: Cache
+0000b940: 6420 6861 7368 206f 6620 3a61 7474 723a  d hash of :attr:
+0000b950: 607e 5461 736b 5374 6174 652e 636c 6965  `~TaskState.clie
+0000b960: 6e74 5f6b 6579 600a 2020 2020 5f68 6173  nt_key`.    _has
+0000b970: 683a 2069 6e74 0a0a 2020 2020 2320 5375  h: int..    # Su
+0000b980: 7070 6f72 7420 666f 7220 7765 616b 7265  pport for weakre
+0000b990: 6673 2074 6f20 6120 636c 6173 7320 7769  fs to a class wi
+0000b9a0: 7468 205f 5f73 6c6f 7473 5f5f 0a20 2020  th __slots__.   
+0000b9b0: 205f 5f77 6561 6b72 6566 5f5f 3a20 416e   __weakref__: An
+0000b9c0: 7920 3d20 4e6f 6e65 0a20 2020 205f 5f73  y = None.    __s
+0000b9d0: 6c6f 7473 5f5f 203d 2074 7570 6c65 285f  lots__ = tuple(_
+0000b9e0: 5f61 6e6e 6f74 6174 696f 6e73 5f5f 290a  _annotations__).
+0000b9f0: 0a20 2020 2023 3a20 476c 6f62 616c 2069  .    #: Global i
+0000ba00: 7465 7261 746f 7220 7573 6564 2074 6f20  terator used to 
+0000ba10: 6372 6561 7465 2075 6e69 7175 6520 7461  create unique ta
+0000ba20: 736b 2072 756e 2049 4473 0a20 2020 205f  sk run IDs.    _
+0000ba30: 7275 6e5f 6964 5f69 7465 7261 746f 723a  run_id_iterator:
+0000ba40: 2043 6c61 7373 5661 725b 6974 6572 746f   ClassVar[iterto
+0000ba50: 6f6c 732e 636f 756e 745d 203d 2069 7465  ols.count] = ite
+0000ba60: 7274 6f6f 6c73 2e63 6f75 6e74 2829 0a0a  rtools.count()..
+0000ba70: 2020 2020 2320 496e 7374 616e 6365 7320      # Instances 
+0000ba80: 6e6f 7420 7061 7274 206f 6620 736c 6f74  not part of slot
+0000ba90: 7320 7369 6e63 6520 636c 6173 7320 7661  s since class va
+0000baa0: 7269 6162 6c65 0a20 2020 205f 696e 7374  riable.    _inst
+0000bab0: 616e 6365 733a 2043 6c61 7373 5661 725b  ances: ClassVar[
+0000bac0: 7765 616b 7265 662e 5765 616b 5365 745b  weakref.WeakSet[
+0000bad0: 5461 736b 5374 6174 655d 5d20 3d20 7765  TaskState]] = we
+0000bae0: 616b 7265 662e 5765 616b 5365 7428 290a  akref.WeakSet().
+0000baf0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+0000bb00: 5f28 0a20 2020 2020 2020 2073 656c 662c  _(.        self,
+0000bb10: 0a20 2020 2020 2020 206b 6579 3a20 7374  .        key: st
+0000bb20: 722c 0a20 2020 2020 2020 2072 756e 5f73  r,.        run_s
+0000bb30: 7065 633a 206f 626a 6563 742c 0a20 2020  pec: object,.   
+0000bb40: 2020 2020 2073 7461 7465 3a20 5461 736b       state: Task
+0000bb50: 5374 6174 6553 7461 7465 2c0a 2020 2020  StateState,.    
+0000bb60: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+0000bb70: 6b65 7920 3d20 6b65 790a 2020 2020 2020  key = key.      
+0000bb80: 2020 7365 6c66 2e5f 6861 7368 203d 2068    self._hash = h
+0000bb90: 6173 6828 6b65 7929 0a20 2020 2020 2020  ash(key).       
+0000bba0: 2073 656c 662e 7275 6e5f 7370 6563 203d   self.run_spec =
+0000bbb0: 2072 756e 5f73 7065 630a 2020 2020 2020   run_spec.      
+0000bbc0: 2020 7365 6c66 2e5f 7374 6174 6520 3d20    self._state = 
+0000bbd0: 7374 6174 650a 2020 2020 2020 2020 7365  state.        se
+0000bbe0: 6c66 2e65 7863 6570 7469 6f6e 203d 204e  lf.exception = N
+0000bbf0: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
+0000bc00: 2e65 7863 6570 7469 6f6e 5f62 6c61 6d65  .exception_blame
+0000bc10: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+0000bc20: 7365 6c66 2e74 7261 6365 6261 636b 203d  self.traceback =
+0000bc30: 204e 6f6e 650a 2020 2020 2020 2020 7365   None.        se
+0000bc40: 6c66 2e65 7863 6570 7469 6f6e 5f74 6578  lf.exception_tex
+0000bc50: 7420 3d20 2222 0a20 2020 2020 2020 2073  t = "".        s
+0000bc60: 656c 662e 7472 6163 6562 6163 6b5f 7465  elf.traceback_te
+0000bc70: 7874 203d 2022 220a 2020 2020 2020 2020  xt = "".        
+0000bc80: 7365 6c66 2e73 7573 7069 6369 6f75 7320  self.suspicious 
+0000bc90: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
+0000bca0: 2e72 6574 7269 6573 203d 2030 0a20 2020  .retries = 0.   
+0000bcb0: 2020 2020 2073 656c 662e 6e62 7974 6573       self.nbytes
+0000bcc0: 203d 202d 310a 2020 2020 2020 2020 7365   = -1.        se
+0000bcd0: 6c66 2e70 7269 6f72 6974 7920 3d20 4e6f  lf.priority = No
+0000bce0: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
+0000bcf0: 7768 6f5f 7761 6e74 7320 3d20 7365 7428  who_wants = set(
+0000bd00: 290a 2020 2020 2020 2020 7365 6c66 2e64  ).        self.d
+0000bd10: 6570 656e 6465 6e63 6965 7320 3d20 7365  ependencies = se
+0000bd20: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
+0000bd30: 2e64 6570 656e 6465 6e74 7320 3d20 7365  .dependents = se
+0000bd40: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
+0000bd50: 2e77 6169 7469 6e67 5f6f 6e20 3d20 7365  .waiting_on = se
+0000bd60: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
+0000bd70: 2e77 6169 7465 7273 203d 2073 6574 2829  .waiters = set()
+0000bd80: 0a20 2020 2020 2020 2073 656c 662e 7768  .        self.wh
+0000bd90: 6f5f 6861 7320 3d20 7365 7428 290a 2020  o_has = set().  
+0000bda0: 2020 2020 2020 7365 6c66 2e70 726f 6365        self.proce
+0000bdb0: 7373 696e 675f 6f6e 203d 204e 6f6e 650a  ssing_on = None.
+0000bdc0: 2020 2020 2020 2020 7365 6c66 2e68 6173          self.has
+0000bdd0: 5f6c 6f73 745f 6465 7065 6e64 656e 6369  _lost_dependenci
+0000bde0: 6573 203d 2046 616c 7365 0a20 2020 2020  es = False.     
+0000bdf0: 2020 2073 656c 662e 686f 7374 5f72 6573     self.host_res
+0000be00: 7472 6963 7469 6f6e 7320 3d20 7365 7428  trictions = set(
+0000be10: 290a 2020 2020 2020 2020 7365 6c66 2e77  ).        self.w
+0000be20: 6f72 6b65 725f 7265 7374 7269 6374 696f  orker_restrictio
+0000be30: 6e73 203d 2073 6574 2829 0a20 2020 2020  ns = set().     
+0000be40: 2020 2073 656c 662e 7265 736f 7572 6365     self.resource
+0000be50: 5f72 6573 7472 6963 7469 6f6e 7320 3d20  _restrictions = 
+0000be60: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
+0000be70: 6c6f 6f73 655f 7265 7374 7269 6374 696f  loose_restrictio
+0000be80: 6e73 203d 2046 616c 7365 0a20 2020 2020  ns = False.     
+0000be90: 2020 2073 656c 662e 6163 746f 7220 3d20     self.actor = 
+0000bea0: 4661 6c73 650a 2020 2020 2020 2020 7365  False.        se
+0000beb0: 6c66 2e70 7265 6669 7820 3d20 4e6f 6e65  lf.prefix = None
+0000bec0: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
+0000bed0: 0a20 2020 2020 2020 2073 656c 662e 7479  .        self.ty
+0000bee0: 7065 203d 204e 6f6e 6520 2023 2074 7970  pe = None  # typ
+0000bef0: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
+0000bf00: 2020 7365 6c66 2e67 726f 7570 5f6b 6579    self.group_key
+0000bf10: 203d 206b 6579 5f73 706c 6974 5f67 726f   = key_split_gro
+0000bf20: 7570 286b 6579 290a 2020 2020 2020 2020  up(key).        
+0000bf30: 7365 6c66 2e67 726f 7570 203d 204e 6f6e  self.group = Non
+0000bf40: 6520 2023 2074 7970 653a 2069 676e 6f72  e  # type: ignor
+0000bf50: 650a 2020 2020 2020 2020 7365 6c66 2e6d  e.        self.m
+0000bf60: 6574 6164 6174 6120 3d20 7b7d 0a20 2020  etadata = {}.   
+0000bf70: 2020 2020 2073 656c 662e 616e 6e6f 7461       self.annota
+0000bf80: 7469 6f6e 7320 3d20 7b7d 0a20 2020 2020  tions = {}.     
+0000bf90: 2020 2073 656c 662e 6572 7265 645f 6f6e     self.erred_on
+0000bfa0: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
+0000bfb0: 2073 656c 662e 7275 6e5f 6964 203d 204e   self.run_id = N
+0000bfc0: 6f6e 650a 2020 2020 2020 2020 5461 736b  one.        Task
+0000bfd0: 5374 6174 652e 5f69 6e73 7461 6e63 6573  State._instances
+0000bfe0: 2e61 6464 2873 656c 6629 0a0a 2020 2020  .add(self)..    
+0000bff0: 6465 6620 5f5f 6861 7368 5f5f 2873 656c  def __hash__(sel
+0000c000: 6629 202d 3e20 696e 743a 0a20 2020 2020  f) -> int:.     
+0000c010: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+0000c020: 6861 7368 0a0a 2020 2020 6465 6620 5f5f  hash..    def __
+0000c030: 6571 5f5f 2873 656c 662c 206f 7468 6572  eq__(self, other
+0000c040: 3a20 6f62 6a65 6374 2920 2d3e 2062 6f6f  : object) -> boo
+0000c050: 6c3a 0a20 2020 2020 2020 2072 6574 7572  l:.        retur
+0000c060: 6e20 6973 696e 7374 616e 6365 286f 7468  n isinstance(oth
+0000c070: 6572 2c20 5461 736b 5374 6174 6529 2061  er, TaskState) a
+0000c080: 6e64 2073 656c 662e 6b65 7920 3d3d 206f  nd self.key == o
+0000c090: 7468 6572 2e6b 6579 0a0a 2020 2020 4070  ther.key..    @p
+0000c0a0: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+0000c0b0: 7374 6174 6528 7365 6c66 2920 2d3e 2054  state(self) -> T
+0000c0c0: 6173 6b53 7461 7465 5374 6174 653a 0a20  askStateState:. 
+0000c0d0: 2020 2020 2020 2022 2222 5468 6973 2074         """This t
+0000c0e0: 6173 6b27 7320 6375 7272 656e 7420 7374  ask's current st
+0000c0f0: 6174 652e 2020 5661 6c69 6420 7374 6174  ate.  Valid stat
+0000c100: 6573 2061 7265 2060 6072 656c 6561 7365  es are ``release
+0000c110: 6460 602c 2060 6077 6169 7469 6e67 6060  d``, ``waiting``
+0000c120: 2c0a 2020 2020 2020 2020 6060 6e6f 2d77  ,.        ``no-w
+0000c130: 6f72 6b65 7260 602c 2060 6070 726f 6365  orker``, ``proce
+0000c140: 7373 696e 6760 602c 2060 606d 656d 6f72  ssing``, ``memor
+0000c150: 7960 602c 2060 6065 7272 6564 6060 2061  y``, ``erred`` a
+0000c160: 6e64 2060 6066 6f72 676f 7474 656e 6060  nd ``forgotten``
+0000c170: 2e20 2049 6620 6974 0a20 2020 2020 2020  .  If it.       
+0000c180: 2069 7320 6060 666f 7267 6f74 7465 6e60   is ``forgotten`
+0000c190: 602c 2074 6865 2074 6173 6b20 6973 6e27  `, the task isn'
+0000c1a0: 7420 7374 6f72 6564 2069 6e20 7468 6520  t stored in the 
+0000c1b0: 6060 7461 736b 7360 6020 6469 6374 696f  ``tasks`` dictio
+0000c1c0: 6e61 7279 2061 6e79 6d6f 7265 2061 6e64  nary anymore and
+0000c1d0: 0a20 2020 2020 2020 2077 696c 6c20 7072  .        will pr
+0000c1e0: 6f62 6162 6c79 2064 6973 6170 7065 6172  obably disappear
+0000c1f0: 2073 6f6f 6e20 6672 6f6d 206d 656d 6f72   soon from memor
+0000c200: 792e 0a20 2020 2020 2020 2022 2222 0a20  y..        """. 
+0000c210: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0000c220: 6c66 2e5f 7374 6174 650a 0a20 2020 2040  lf._state..    @
+0000c230: 7374 6174 652e 7365 7474 6572 0a20 2020  state.setter.   
+0000c240: 2064 6566 2073 7461 7465 2873 656c 662c   def state(self,
+0000c250: 2076 616c 7565 3a20 5461 736b 5374 6174   value: TaskStat
+0000c260: 6553 7461 7465 2920 2d3e 204e 6f6e 653a  eState) -> None:
+0000c270: 0a20 2020 2020 2020 2073 656c 662e 6772  .        self.gr
+0000c280: 6f75 702e 7374 6174 6573 5b73 656c 662e  oup.states[self.
+0000c290: 5f73 7461 7465 5d20 2d3d 2031 0a20 2020  _state] -= 1.   
+0000c2a0: 2020 2020 2073 656c 662e 6772 6f75 702e       self.group.
+0000c2b0: 7374 6174 6573 5b76 616c 7565 5d20 2b3d  states[value] +=
+0000c2c0: 2031 0a20 2020 2020 2020 2073 656c 662e   1.        self.
+0000c2d0: 5f73 7461 7465 203d 2076 616c 7565 0a20  _state = value. 
+0000c2e0: 2020 2020 2020 2073 656c 662e 7072 6566         self.pref
+0000c2f0: 6978 2e73 7461 7465 5f63 6f75 6e74 735b  ix.state_counts[
+0000c300: 7661 6c75 655d 202b 3d20 310a 0a20 2020  value] += 1..   
+0000c310: 2064 6566 2061 6464 5f64 6570 656e 6465   def add_depende
+0000c320: 6e63 7928 7365 6c66 2c20 6f74 6865 723a  ncy(self, other:
+0000c330: 2054 6173 6b53 7461 7465 2920 2d3e 204e   TaskState) -> N
+0000c340: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+0000c350: 4164 6420 616e 6f74 6865 7220 7461 736b  Add another task
+0000c360: 2061 7320 6120 6465 7065 6e64 656e 6379   as a dependency
+0000c370: 206f 6620 7468 6973 2074 6173 6b22 2222   of this task"""
+0000c380: 0a20 2020 2020 2020 2073 656c 662e 6465  .        self.de
+0000c390: 7065 6e64 656e 6369 6573 2e61 6464 286f  pendencies.add(o
+0000c3a0: 7468 6572 290a 2020 2020 2020 2020 7365  ther).        se
+0000c3b0: 6c66 2e67 726f 7570 2e64 6570 656e 6465  lf.group.depende
+0000c3c0: 6e63 6965 732e 6164 6428 6f74 6865 722e  ncies.add(other.
+0000c3d0: 6772 6f75 7029 0a20 2020 2020 2020 206f  group).        o
+0000c3e0: 7468 6572 2e64 6570 656e 6465 6e74 732e  ther.dependents.
+0000c3f0: 6164 6428 7365 6c66 290a 0a20 2020 2064  add(self)..    d
+0000c400: 6566 2067 6574 5f6e 6279 7465 7328 7365  ef get_nbytes(se
+0000c410: 6c66 2920 2d3e 2069 6e74 3a0a 2020 2020  lf) -> int:.    
+0000c420: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0000c430: 6e62 7974 6573 2069 6620 7365 6c66 2e6e  nbytes if self.n
+0000c440: 6279 7465 7320 3e3d 2030 2065 6c73 6520  bytes >= 0 else 
+0000c450: 4445 4641 554c 545f 4441 5441 5f53 495a  DEFAULT_DATA_SIZ
+0000c460: 450a 0a20 2020 2064 6566 2073 6574 5f6e  E..    def set_n
+0000c470: 6279 7465 7328 7365 6c66 2c20 6e62 7974  bytes(self, nbyt
+0000c480: 6573 3a20 696e 7429 202d 3e20 4e6f 6e65  es: int) -> None
+0000c490: 3a0a 2020 2020 2020 2020 6469 6666 203d  :.        diff =
+0000c4a0: 206e 6279 7465 730a 2020 2020 2020 2020   nbytes.        
+0000c4b0: 6f6c 645f 6e62 7974 6573 203d 2073 656c  old_nbytes = sel
+0000c4c0: 662e 6e62 7974 6573 0a20 2020 2020 2020  f.nbytes.       
+0000c4d0: 2069 6620 6f6c 645f 6e62 7974 6573 203e   if old_nbytes >
+0000c4e0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
+0000c4f0: 2064 6966 6620 2d3d 206f 6c64 5f6e 6279   diff -= old_nby
+0000c500: 7465 730a 2020 2020 2020 2020 7365 6c66  tes.        self
+0000c510: 2e67 726f 7570 2e6e 6279 7465 735f 746f  .group.nbytes_to
+0000c520: 7461 6c20 2b3d 2064 6966 660a 2020 2020  tal += diff.    
+0000c530: 2020 2020 666f 7220 7773 2069 6e20 7365      for ws in se
+0000c540: 6c66 2e77 686f 5f68 6173 3a0a 2020 2020  lf.who_has:.    
+0000c550: 2020 2020 2020 2020 7773 2e6e 6279 7465          ws.nbyte
+0000c560: 7320 2b3d 2064 6966 660a 2020 2020 2020  s += diff.      
+0000c570: 2020 7365 6c66 2e6e 6279 7465 7320 3d20    self.nbytes = 
+0000c580: 6e62 7974 6573 0a0a 2020 2020 6465 6620  nbytes..    def 
+0000c590: 5f5f 7265 7072 5f5f 2873 656c 6629 202d  __repr__(self) -
+0000c5a0: 3e20 7374 723a 0a20 2020 2020 2020 2072  > str:.        r
+0000c5b0: 6574 7572 6e20 6622 3c54 6173 6b53 7461  eturn f"<TaskSta
+0000c5c0: 7465 207b 7365 6c66 2e6b 6579 2172 7d20  te {self.key!r} 
+0000c5d0: 7b73 656c 662e 5f73 7461 7465 7d3e 220a  {self._state}>".
+0000c5e0: 0a20 2020 2064 6566 205f 7265 7072 5f68  .    def _repr_h
+0000c5f0: 746d 6c5f 2873 656c 6629 202d 3e20 7374  tml_(self) -> st
+0000c600: 723a 0a20 2020 2020 2020 2072 6574 7572  r:.        retur
+0000c610: 6e20 6765 745f 7465 6d70 6c61 7465 2822  n get_template("
+0000c620: 7461 736b 5f73 7461 7465 2e68 746d 6c2e  task_state.html.
+0000c630: 6a32 2229 2e72 656e 6465 7228 0a20 2020  j2").render(.   
+0000c640: 2020 2020 2020 2020 2073 7461 7465 3d73           state=s
+0000c650: 656c 662e 7374 6174 652c 0a20 2020 2020  elf.state,.     
+0000c660: 2020 2020 2020 206e 6279 7465 733d 7365         nbytes=se
+0000c670: 6c66 2e6e 6279 7465 732c 0a20 2020 2020  lf.nbytes,.     
+0000c680: 2020 2020 2020 206b 6579 3d73 656c 662e         key=self.
+0000c690: 6b65 792c 0a20 2020 2020 2020 2029 0a0a  key,.        )..
+0000c6a0: 2020 2020 6465 6620 7661 6c69 6461 7465      def validate
+0000c6b0: 2873 656c 6629 202d 3e20 4e6f 6e65 3a0a  (self) -> None:.
+0000c6c0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0000c6d0: 2020 2020 2020 2020 2066 6f72 2063 7320           for cs 
+0000c6e0: 696e 2073 656c 662e 7768 6f5f 7761 6e74  in self.who_want
+0000c6f0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0000c700: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
+0000c710: 616e 6365 2863 732c 2043 6c69 656e 7453  ance(cs, ClientS
+0000c720: 7461 7465 292c 2028 7265 7072 2863 7329  tate), (repr(cs)
+0000c730: 2c20 7365 6c66 2e77 686f 5f77 616e 7473  , self.who_wants
+0000c740: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+0000c750: 7220 7773 2069 6e20 7365 6c66 2e77 686f  r ws in self.who
+0000c760: 5f68 6173 3a0a 2020 2020 2020 2020 2020  _has:.          
+0000c770: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
+0000c780: 6e73 7461 6e63 6528 7773 2c20 576f 726b  nstance(ws, Work
+0000c790: 6572 5374 6174 6529 2c20 2872 6570 7228  erState), (repr(
+0000c7a0: 7773 292c 2073 656c 662e 7768 6f5f 6861  ws), self.who_ha
+0000c7b0: 7329 0a20 2020 2020 2020 2020 2020 2066  s).            f
+0000c7c0: 6f72 2074 7320 696e 2073 656c 662e 6465  or ts in self.de
+0000c7d0: 7065 6e64 656e 6369 6573 3a0a 2020 2020  pendencies:.    
+0000c7e0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0000c7f0: 7274 2069 7369 6e73 7461 6e63 6528 7473  rt isinstance(ts
+0000c800: 2c20 5461 736b 5374 6174 6529 2c20 2872  , TaskState), (r
+0000c810: 6570 7228 7473 292c 2073 656c 662e 6465  epr(ts), self.de
+0000c820: 7065 6e64 656e 6369 6573 290a 2020 2020  pendencies).    
+0000c830: 2020 2020 2020 2020 666f 7220 7473 2069          for ts i
+0000c840: 6e20 7365 6c66 2e64 6570 656e 6465 6e74  n self.dependent
+0000c850: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0000c860: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
+0000c870: 616e 6365 2874 732c 2054 6173 6b53 7461  ance(ts, TaskSta
+0000c880: 7465 292c 2028 7265 7072 2874 7329 2c20  te), (repr(ts), 
+0000c890: 7365 6c66 2e64 6570 656e 6465 6e74 7329  self.dependents)
+0000c8a0: 0a20 2020 2020 2020 2020 2020 2076 616c  .            val
+0000c8b0: 6964 6174 655f 7461 736b 5f73 7461 7465  idate_task_state
+0000c8c0: 2873 656c 6629 0a20 2020 2020 2020 2065  (self).        e
+0000c8d0: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+0000c8e0: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+0000c8f0: 2020 6c6f 6767 6572 2e65 7863 6570 7469    logger.excepti
+0000c900: 6f6e 2865 290a 2020 2020 2020 2020 2020  on(e).          
+0000c910: 2020 6966 204c 4f47 5f50 4442 3a0a 2020    if LOG_PDB:.  
+0000c920: 2020 2020 2020 2020 2020 2020 2020 696d                im
+0000c930: 706f 7274 2070 6462 0a0a 2020 2020 2020  port pdb..      
+0000c940: 2020 2020 2020 2020 2020 7064 622e 7365            pdb.se
+0000c950: 745f 7472 6163 6528 290a 0a20 2020 2064  t_trace()..    d
+0000c960: 6566 2067 6574 5f6e 6279 7465 735f 6465  ef get_nbytes_de
+0000c970: 7073 2873 656c 6629 202d 3e20 696e 743a  ps(self) -> int:
+0000c980: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000c990: 7375 6d28 7473 2e67 6574 5f6e 6279 7465  sum(ts.get_nbyte
+0000c9a0: 7328 2920 666f 7220 7473 2069 6e20 7365  s() for ts in se
+0000c9b0: 6c66 2e64 6570 656e 6465 6e63 6965 7329  lf.dependencies)
+0000c9c0: 0a0a 2020 2020 6465 6620 5f74 6f5f 6469  ..    def _to_di
+0000c9d0: 6374 5f6e 6f5f 6e65 7374 2873 656c 662c  ct_no_nest(self,
+0000c9e0: 202a 2c20 6578 636c 7564 653a 2043 6f6e   *, exclude: Con
+0000c9f0: 7461 696e 6572 5b73 7472 5d20 3d20 2829  tainer[str] = ()
+0000ca00: 2920 2d3e 2064 6963 745b 7374 722c 2041  ) -> dict[str, A
+0000ca10: 6e79 5d3a 0a20 2020 2020 2020 2022 2222  ny]:.        """
+0000ca20: 4469 6374 696f 6e61 7279 2072 6570 7265  Dictionary repre
+0000ca30: 7365 6e74 6174 696f 6e20 666f 7220 6465  sentation for de
+0000ca40: 6275 6767 696e 6720 7075 7270 6f73 6573  bugging purposes
+0000ca50: 2e0a 2020 2020 2020 2020 4e6f 7420 7479  ..        Not ty
+0000ca60: 7065 2073 7461 626c 6520 616e 6420 6e6f  pe stable and no
+0000ca70: 7420 696e 7465 6e64 6564 2066 6f72 2072  t intended for r
+0000ca80: 6f75 6e64 7472 6970 732e 0a0a 2020 2020  oundtrips...    
+0000ca90: 2020 2020 5365 6520 616c 736f 0a20 2020      See also.   
+0000caa0: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 2020       --------.  
+0000cab0: 2020 2020 2020 436c 6965 6e74 2e64 756d        Client.dum
+0000cac0: 705f 636c 7573 7465 725f 7374 6174 650a  p_cluster_state.
+0000cad0: 2020 2020 2020 2020 6469 7374 7269 6275          distribu
+0000cae0: 7465 642e 7574 696c 732e 7265 6375 7273  ted.utils.recurs
+0000caf0: 6976 655f 746f 5f64 6963 740a 0a20 2020  ive_to_dict..   
+0000cb00: 2020 2020 204e 6f74 6573 0a20 2020 2020       Notes.     
+0000cb10: 2020 202d 2d2d 2d2d 0a20 2020 2020 2020     -----.       
+0000cb20: 2054 6869 7320 636c 6173 7320 7573 6573   This class uses
+0000cb30: 2060 605f 746f 5f64 6963 745f 6e6f 5f6e   ``_to_dict_no_n
+0000cb40: 6573 7460 6020 696e 7374 6561 6420 6f66  est`` instead of
+0000cb50: 2060 605f 746f 5f64 6963 7460 602e 0a20   ``_to_dict``.. 
+0000cb60: 2020 2020 2020 2057 6865 6e20 6120 7461         When a ta
+0000cb70: 736b 2072 6566 6572 656e 6365 7320 616e  sk references an
+0000cb80: 6f74 6865 7220 7461 736b 2c20 6f72 2077  other task, or w
+0000cb90: 6865 6e20 6120 576f 726b 6572 5374 6174  hen a WorkerStat
+0000cba0: 652e 7461 736b 7320 636f 6e74 6169 6e73  e.tasks contains
+0000cbb0: 2074 6173 6b73 2c0a 2020 2020 2020 2020   tasks,.        
+0000cbc0: 7468 6973 206d 6574 686f 6420 6973 206e  this method is n
+0000cbd0: 6f74 2065 7865 6375 7465 6420 666f 7220  ot executed for 
+0000cbe0: 7468 6520 696e 6e65 7220 7461 736b 2c20  the inner task, 
+0000cbf0: 6576 656e 2069 6620 7468 6520 696e 6e65  even if the inne
+0000cc00: 7220 7461 736b 2077 6173 206e 6576 6572  r task was never
+0000cc10: 0a20 2020 2020 2020 2073 6565 6e20 6265  .        seen be
+0000cc20: 666f 7265 3b20 796f 7520 6765 7420 6120  fore; you get a 
+0000cc30: 7265 7072 2069 6e73 7465 6164 2e20 416c  repr instead. Al
+0000cc40: 6c20 7461 736b 7320 7368 6f75 6c64 206e  l tasks should n
+0000cc50: 6561 746c 7920 6170 7065 6172 2075 6e64  eatly appear und
+0000cc60: 6572 0a20 2020 2020 2020 2053 6368 6564  er.        Sched
+0000cc70: 756c 6572 2e74 6173 6b73 2e20 5468 6973  uler.tasks. This
+0000cc80: 2061 6c73 6f20 7072 6576 656e 7473 2061   also prevents a
+0000cc90: 2052 6563 7572 7369 6f6e 4572 726f 7220   RecursionError 
+0000cca0: 6475 7269 6e67 2070 6172 7469 6375 6c61  during particula
+0000ccb0: 726c 7920 6865 6176 790a 2020 2020 2020  rly heavy.      
+0000ccc0: 2020 6c6f 6164 732c 2077 6869 6368 2068    loads, which h
+0000ccd0: 6176 6520 6265 656e 206f 6273 6572 7665  ave been observe
+0000cce0: 6420 746f 2068 6170 7065 6e20 7768 656e  d to happen when
+0000ccf0: 6576 6572 2074 6865 7265 2773 2061 6e20  ever there's an 
+0000cd00: 6163 7963 6c69 6320 6465 7065 6e64 656e  acyclic dependen
+0000cd10: 6379 0a20 2020 2020 2020 2063 6861 696e  cy.        chain
+0000cd20: 206f 6620 7e32 3030 2b20 7461 736b 732e   of ~200+ tasks.
+0000cd30: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0000cd40: 2020 2020 2072 6574 7572 6e20 7265 6375       return recu
+0000cd50: 7273 6976 655f 746f 5f64 6963 7428 7365  rsive_to_dict(se
+0000cd60: 6c66 2c20 6578 636c 7564 653d 6578 636c  lf, exclude=excl
+0000cd70: 7564 652c 206d 656d 6265 7273 3d54 7275  ude, members=Tru
+0000cd80: 6529 0a0a 0a63 6c61 7373 2054 7261 6e73  e)...class Trans
+0000cd90: 6974 696f 6e28 4e61 6d65 6454 7570 6c65  ition(NamedTuple
+0000cda0: 293a 0a20 2020 2022 2222 416e 2065 6e74  ):.    """An ent
+0000cdb0: 7279 2069 6e20 3a61 7474 723a 6053 6368  ry in :attr:`Sch
+0000cdc0: 6564 756c 6572 5374 6174 652e 7472 616e  edulerState.tran
+0000cdd0: 7369 7469 6f6e 5f6c 6f67 6022 2222 0a0a  sition_log`"""..
+0000cde0: 2020 2020 6b65 793a 2073 7472 0a20 2020      key: str.   
+0000cdf0: 2073 7461 7274 3a20 5461 736b 5374 6174   start: TaskStat
+0000ce00: 6553 7461 7465 0a20 2020 2066 696e 6973  eState.    finis
+0000ce10: 683a 2054 6173 6b53 7461 7465 5374 6174  h: TaskStateStat
+0000ce20: 650a 2020 2020 7265 636f 6d6d 656e 6461  e.    recommenda
+0000ce30: 7469 6f6e 733a 2052 6563 730a 2020 2020  tions: Recs.    
+0000ce40: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
+0000ce50: 0a20 2020 2074 696d 6573 7461 6d70 3a20  .    timestamp: 
+0000ce60: 666c 6f61 740a 0a0a 636c 6173 7320 5363  float...class Sc
+0000ce70: 6865 6475 6c65 7253 7461 7465 3a0a 2020  hedulerState:.  
+0000ce80: 2020 2222 2255 6e64 6572 6c79 696e 6720    """Underlying 
+0000ce90: 7461 736b 2073 7461 7465 206f 6620 6479  task state of dy
+0000cea0: 6e61 6d69 6320 7363 6865 6475 6c65 720a  namic scheduler.
+0000ceb0: 0a20 2020 2054 7261 636b 7320 7468 6520  .    Tracks the 
+0000cec0: 6375 7272 656e 7420 7374 6174 6520 6f66  current state of
+0000ced0: 2077 6f72 6b65 7273 2c20 6461 7461 2c20   workers, data, 
+0000cee0: 616e 6420 636f 6d70 7574 6174 696f 6e73  and computations
+0000cef0: 2e0a 0a20 2020 2048 616e 646c 6573 2074  ...    Handles t
+0000cf00: 7261 6e73 6974 696f 6e73 2062 6574 7765  ransitions betwe
+0000cf10: 656e 2064 6966 6665 7265 6e74 2074 6173  en different tas
+0000cf20: 6b20 7374 6174 6573 2e20 4e6f 7469 6669  k states. Notifi
+0000cf30: 6573 2074 6865 0a20 2020 2053 6368 6564  es the.    Sched
+0000cf40: 756c 6572 206f 6620 6368 616e 6765 7320  uler of changes 
+0000cf50: 6279 206d 6573 7361 6769 6e67 2070 6173  by messaging pas
+0000cf60: 7369 6e67 2074 6872 6f75 6768 2051 7565  sing through Que
+0000cf70: 7565 732c 2077 6869 6368 2074 6865 0a20  ues, which the. 
+0000cf80: 2020 2053 6368 6564 756c 6572 206c 6973     Scheduler lis
+0000cf90: 7465 6e73 2074 6f20 7265 7370 6f6e 6473  tens to responds
+0000cfa0: 2061 6363 6f72 6469 6e67 6c79 2e0a 0a20   accordingly... 
+0000cfb0: 2020 2041 6c6c 2065 7665 6e74 7320 6172     All events ar
+0000cfc0: 6520 6861 6e64 6c65 6420 7175 6963 6b6c  e handled quickl
+0000cfd0: 792c 2069 6e20 6c69 6e65 6172 2074 696d  y, in linear tim
+0000cfe0: 6520 7769 7468 2072 6573 7065 6374 2074  e with respect t
+0000cff0: 6f20 7468 6569 720a 2020 2020 696e 7075  o their.    inpu
+0000d000: 7420 2877 6869 6368 2069 7320 6f66 7465  t (which is ofte
+0000d010: 6e20 6f66 2063 6f6e 7374 616e 7420 7369  n of constant si
+0000d020: 7a65 2920 616e 6420 6765 6e65 7261 6c6c  ze) and generall
+0000d030: 7920 7769 7468 696e 2061 0a20 2020 206d  y within a.    m
+0000d040: 696c 6c69 7365 636f 6e64 2e0a 0a20 2020  illisecond...   
+0000d050: 2055 7365 7273 2074 7970 6963 616c 6c79   Users typically
+0000d060: 2064 6f20 6e6f 7420 696e 7465 7261 6374   do not interact
+0000d070: 2077 6974 6820 6060 5472 616e 7369 7469   with ``Transiti
+0000d080: 6f6e 7360 6020 6469 7265 6374 6c79 2e20  ons`` directly. 
+0000d090: 496e 7374 6561 640a 2020 2020 7573 6572  Instead.    user
+0000d0a0: 7320 696e 7465 7261 6374 2077 6974 6820  s interact with 
+0000d0b0: 7468 6520 6060 436c 6965 6e74 6060 2c20  the ``Client``, 
+0000d0c0: 7768 6963 6820 696e 2074 7572 6e20 656e  which in turn en
+0000d0d0: 6761 6765 7320 7468 650a 2020 2020 6060  gages the.    ``
+0000d0e0: 5363 6865 6475 6c65 7260 6020 6166 6665  Scheduler`` affe
+0000d0f0: 6374 696e 6720 6469 6666 6572 656e 7420  cting different 
+0000d100: 7472 616e 7369 7469 6f6e 7320 6865 7265  transitions here
+0000d110: 2075 6e64 6572 2d74 6865 2d68 6f6f 642e   under-the-hood.
+0000d120: 2049 6e0a 2020 2020 7468 6520 6261 636b   In.    the back
+0000d130: 6772 6f75 6e64 2060 6057 6f72 6b65 7260  ground ``Worker`
+0000d140: 6073 2061 6c73 6f20 656e 6761 6765 2077  `s also engage w
+0000d150: 6974 6820 7468 6520 6060 5363 6865 6475  ith the ``Schedu
+0000d160: 6c65 7260 600a 2020 2020 6166 6665 6374  ler``.    affect
+0000d170: 696e 6720 7468 6573 6520 7374 6174 6520  ing these state 
+0000d180: 7472 616e 7369 7469 6f6e 7320 6173 2077  transitions as w
+0000d190: 656c 6c2e 0a20 2020 2022 2222 0a0a 2020  ell..    """..  
+0000d1a0: 2020 6261 6e64 7769 6474 683a 2069 6e74    bandwidth: int
+0000d1b0: 0a0a 2020 2020 233a 2043 6c69 656e 7473  ..    #: Clients
+0000d1c0: 2063 7572 7265 6e74 6c79 2063 6f6e 6e65   currently conne
+0000d1d0: 6374 6564 2074 6f20 7468 6520 7363 6865  cted to the sche
+0000d1e0: 6475 6c65 720a 2020 2020 636c 6965 6e74  duler.    client
+0000d1f0: 733a 2064 6963 745b 7374 722c 2043 6c69  s: dict[str, Cli
+0000d200: 656e 7453 7461 7465 5d0a 0a20 2020 2065  entState]..    e
+0000d210: 7874 656e 7369 6f6e 733a 2064 6963 745b  xtensions: dict[
+0000d220: 7374 722c 2041 6e79 5d20 2023 2054 4f44  str, Any]  # TOD
+0000d230: 4f20 7772 6974 6520 6120 7363 6865 6475  O write a schedu
+0000d240: 6c65 7220 6578 7465 6e73 696f 6e20 5072  ler extension Pr
+0000d250: 6f74 6f63 6f6c 0a20 2020 2070 6c75 6769  otocol.    plugi
+0000d260: 6e73 3a20 6469 6374 5b73 7472 2c20 5363  ns: dict[str, Sc
+0000d270: 6865 6475 6c65 7250 6c75 6769 6e5d 0a20  hedulerPlugin]. 
+0000d280: 2020 2068 6f73 745f 696e 666f 3a20 6469     host_info: di
+0000d290: 6374 5b73 7472 2c20 6469 6374 5b73 7472  ct[str, dict[str
+0000d2a0: 2c20 416e 795d 5d0a 0a20 2020 2023 3a20  , Any]]..    #: 
+0000d2b0: 4966 2054 7275 652c 2065 6e61 626c 6520  If True, enable 
+0000d2c0: 6578 7065 6e73 6976 6520 696e 7465 726e  expensive intern
+0000d2d0: 616c 2063 6f6e 7369 7374 656e 6379 2063  al consistency c
+0000d2e0: 6865 636b 2e0a 2020 2020 233a 2054 7970  heck..    #: Typ
+0000d2f0: 6963 616c 6c79 2064 6973 6162 6c65 6420  ically disabled 
+0000d300: 696e 2070 726f 6475 6374 696f 6e2e 0a20  in production.. 
+0000d310: 2020 2076 616c 6964 6174 653a 2062 6f6f     validate: boo
+0000d320: 6c0a 0a20 2020 2023 2323 2323 2323 2323  l..    #########
+0000d330: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
+0000d340: 2020 2023 2057 6f72 6b65 7273 2d72 656c     # Workers-rel
+0000d350: 6174 6564 2073 7461 7465 0a20 2020 2023  ated state.    #
+0000d360: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d370: 2323 2323 2323 0a0a 2020 2020 233a 2057  ######..    #: W
+0000d380: 6f72 6b65 7273 2063 7572 7265 6e74 6c79  orkers currently
+0000d390: 2063 6f6e 6e65 6374 6564 2074 6f20 7468   connected to th
+0000d3a0: 6520 7363 6865 6475 6c65 720a 2020 2020  e scheduler.    
+0000d3b0: 233a 2028 6163 7475 616c 6c79 2061 2053  #: (actually a S
+0000d3c0: 6f72 7465 6444 6963 742c 2062 7574 2074  ortedDict, but t
+0000d3d0: 6865 2073 6f72 7465 6463 6f6e 7461 696e  he sortedcontain
+0000d3e0: 6572 7320 7061 636b 6167 6520 6973 6e27  ers package isn'
+0000d3f0: 7420 616e 6e6f 7461 7465 6429 0a20 2020  t annotated).   
+0000d400: 2077 6f72 6b65 7273 3a20 6469 6374 5b73   workers: dict[s
+0000d410: 7472 2c20 576f 726b 6572 5374 6174 655d  tr, WorkerState]
+0000d420: 0a20 2020 2023 3a20 576f 726b 6572 207b  .    #: Worker {
+0000d430: 6e61 6d65 3a20 6164 6472 6573 737d 0a20  name: address}. 
+0000d440: 2020 2061 6c69 6173 6573 3a20 6469 6374     aliases: dict
+0000d450: 5b48 6173 6861 626c 652c 2073 7472 5d0a  [Hashable, str].
+0000d460: 2020 2020 233a 2057 6f72 6b65 7273 2074      #: Workers t
+0000d470: 6861 7420 6172 6520 6375 7272 656e 746c  hat are currentl
+0000d480: 7920 696e 2072 756e 6e69 6e67 2073 7461  y in running sta
+0000d490: 7465 0a20 2020 2072 756e 6e69 6e67 3a20  te.    running: 
+0000d4a0: 7365 745b 576f 726b 6572 5374 6174 655d  set[WorkerState]
+0000d4b0: 0a20 2020 2023 3a20 576f 726b 6572 7320  .    #: Workers 
+0000d4c0: 7468 6174 2061 7265 2063 7572 7265 6e74  that are current
+0000d4d0: 6c79 2069 6e20 7275 6e6e 696e 6720 7374  ly in running st
+0000d4e0: 6174 6520 616e 6420 6e6f 7420 6675 6c6c  ate and not full
+0000d4f0: 7920 7574 696c 697a 6564 0a20 2020 2023  y utilized.    #
+0000d500: 3a20 4465 6669 6e69 7469 6f6e 2062 6173  : Definition bas
+0000d510: 6564 206f 6e20 6f63 6375 7061 6e63 790a  ed on occupancy.
+0000d520: 2020 2020 233a 2028 6163 7475 616c 6c79      #: (actually
+0000d530: 2061 2053 6f72 7465 6444 6963 742c 2062   a SortedDict, b
+0000d540: 7574 2074 6865 2073 6f72 7465 6463 6f6e  ut the sortedcon
+0000d550: 7461 696e 6572 7320 7061 636b 6167 6520  tainers package 
+0000d560: 6973 6e27 7420 616e 6e6f 7461 7465 6429  isn't annotated)
+0000d570: 2e0a 2020 2020 233a 204e 6f74 2074 6f20  ..    #: Not to 
+0000d580: 6265 2063 6f6e 6675 7365 6420 7769 7468  be confused with
+0000d590: 203a 6d65 7468 3a60 6973 5f69 646c 6560   :meth:`is_idle`
+0000d5a0: 2e0a 2020 2020 6964 6c65 3a20 6469 6374  ..    idle: dict
+0000d5b0: 5b73 7472 2c20 576f 726b 6572 5374 6174  [str, WorkerStat
+0000d5c0: 655d 0a20 2020 2023 3a20 5369 6d69 6c61  e].    #: Simila
+0000d5d0: 7220 746f 2060 6964 6c65 600a 2020 2020  r to `idle`.    
+0000d5e0: 233a 2044 6566 696e 6974 696f 6e20 6261  #: Definition ba
+0000d5f0: 7365 6420 6f6e 2061 7373 6967 6e65 6420  sed on assigned 
+0000d600: 7461 736b 730a 2020 2020 6964 6c65 5f74  tasks.    idle_t
+0000d610: 6173 6b5f 636f 756e 743a 2073 6574 5b57  ask_count: set[W
+0000d620: 6f72 6b65 7253 7461 7465 5d0a 2020 2020  orkerState].    
+0000d630: 233a 2057 6f72 6b65 7273 2074 6861 7420  #: Workers that 
+0000d640: 6172 6520 6675 6c6c 7920 7574 696c 697a  are fully utiliz
+0000d650: 6564 2e20 4d61 7920 696e 636c 7564 6520  ed. May include 
+0000d660: 6e6f 6e2d 7275 6e6e 696e 6720 776f 726b  non-running work
+0000d670: 6572 732e 0a20 2020 2073 6174 7572 6174  ers..    saturat
+0000d680: 6564 3a20 7365 745b 576f 726b 6572 5374  ed: set[WorkerSt
+0000d690: 6174 655d 0a20 2020 2023 3a20 4375 7272  ate].    #: Curr
+0000d6a0: 656e 7420 6e75 6d62 6572 206f 6620 7468  ent number of th
+0000d6b0: 7265 6164 7320 6163 726f 7373 2061 6c6c  reads across all
+0000d6c0: 2077 6f72 6b65 7273 0a20 2020 2074 6f74   workers.    tot
+0000d6d0: 616c 5f6e 7468 7265 6164 733a 2069 6e74  al_nthreads: int
+0000d6e0: 0a20 2020 2023 3a20 4869 7374 6f72 7920  .    #: History 
+0000d6f0: 6f66 206e 756d 6265 7220 6f66 2074 6872  of number of thr
+0000d700: 6561 6473 0a20 2020 2023 3a20 2874 696d  eads.    #: (tim
+0000d710: 6573 7461 6d70 2c20 6e65 7720 6e75 6d62  estamp, new numb
+0000d720: 6572 206f 6620 7468 7265 6164 7329 0a20  er of threads). 
+0000d730: 2020 2074 6f74 616c 5f6e 7468 7265 6164     total_nthread
+0000d740: 735f 6869 7374 6f72 793a 206c 6973 745b  s_history: list[
+0000d750: 7475 706c 655b 666c 6f61 742c 2069 6e74  tuple[float, int
+0000d760: 5d5d 0a20 2020 2023 3a20 436c 7573 7465  ]].    #: Cluste
+0000d770: 722d 7769 6465 2072 6573 6f75 7263 6573  r-wide resources
+0000d780: 2e20 7b72 6573 6f75 7263 6520 6e61 6d65  . {resource name
+0000d790: 3a20 7b77 6f72 6b65 7220 6164 6472 6573  : {worker addres
+0000d7a0: 733a 2061 6d6f 756e 747d 7d0a 2020 2020  s: amount}}.    
+0000d7b0: 7265 736f 7572 6365 733a 2064 6963 745b  resources: dict[
+0000d7c0: 7374 722c 2064 6963 745b 7374 722c 2066  str, dict[str, f
+0000d7d0: 6c6f 6174 5d5d 0a0a 2020 2020 2323 2323  loat]]..    ####
+0000d7e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d7f0: 230a 2020 2020 2320 5461 736b 732d 7265  #.    # Tasks-re
+0000d800: 6c61 7465 6420 7374 6174 650a 2020 2020  lated state.    
+0000d810: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d820: 2323 2323 230a 0a20 2020 2023 3a20 546f  #####..    #: To
+0000d830: 7461 6c20 6e75 6d62 6572 206f 6620 7461  tal number of ta
+0000d840: 736b 7320 6576 6572 2070 726f 6365 7373  sks ever process
+0000d850: 6564 0a20 2020 206e 5f74 6173 6b73 3a20  ed.    n_tasks: 
+0000d860: 696e 740a 0a20 2020 2023 3a20 416c 6c20  int..    #: All 
+0000d870: 7461 736b 7320 6375 7272 656e 746c 7920  tasks currently 
+0000d880: 6b6e 6f77 6e20 746f 2074 6865 2073 6368  known to the sch
+0000d890: 6564 756c 6572 0a20 2020 2074 6173 6b73  eduler.    tasks
+0000d8a0: 3a20 6469 6374 5b73 7472 2c20 5461 736b  : dict[str, Task
+0000d8b0: 5374 6174 655d 0a0a 2020 2020 233a 2054  State]..    #: T
+0000d8c0: 6173 6b73 2069 6e20 7468 6520 2271 7565  asks in the "que
+0000d8d0: 7565 6422 2073 7461 7465 2c20 6f72 6465  ued" state, orde
+0000d8e0: 7265 6420 6279 2070 7269 6f72 6974 790a  red by priority.
+0000d8f0: 2020 2020 7175 6575 6564 3a20 4865 6170      queued: Heap
+0000d900: 5365 745b 5461 736b 5374 6174 655d 0a0a  Set[TaskState]..
+0000d910: 2020 2020 233a 2054 6173 6b73 2069 6e20      #: Tasks in 
+0000d920: 7468 6520 226e 6f2d 776f 726b 6572 2220  the "no-worker" 
+0000d930: 7374 6174 650a 2020 2020 756e 7275 6e6e  state.    unrunn
+0000d940: 6162 6c65 3a20 7365 745b 5461 736b 5374  able: set[TaskSt
+0000d950: 6174 655d 0a0a 2020 2020 233a 2053 7562  ate]..    #: Sub
+0000d960: 7365 7420 6f66 2074 6173 6b73 2074 6861  set of tasks tha
+0000d970: 7420 6578 6973 7420 696e 206d 656d 6f72  t exist in memor
+0000d980: 7920 6f6e 206d 6f72 6520 7468 616e 206f  y on more than o
+0000d990: 6e65 2077 6f72 6b65 720a 2020 2020 7265  ne worker.    re
+0000d9a0: 706c 6963 6174 6564 5f74 6173 6b73 3a20  plicated_tasks: 
+0000d9b0: 7365 745b 5461 736b 5374 6174 655d 0a0a  set[TaskState]..
+0000d9c0: 2020 2020 756e 6b6e 6f77 6e5f 6475 7261      unknown_dura
+0000d9d0: 7469 6f6e 733a 2064 6963 745b 7374 722c  tions: dict[str,
+0000d9e0: 2073 6574 5b54 6173 6b53 7461 7465 5d5d   set[TaskState]]
+0000d9f0: 0a20 2020 2074 6173 6b5f 6772 6f75 7073  .    task_groups
+0000da00: 3a20 6469 6374 5b73 7472 2c20 5461 736b  : dict[str, Task
+0000da10: 4772 6f75 705d 0a20 2020 2074 6173 6b5f  Group].    task_
+0000da20: 7072 6566 6978 6573 3a20 6469 6374 5b73  prefixes: dict[s
+0000da30: 7472 2c20 5461 736b 5072 6566 6978 5d0a  tr, TaskPrefix].
+0000da40: 2020 2020 7461 736b 5f6d 6574 6164 6174      task_metadat
+0000da50: 613a 2064 6963 745b 7374 722c 2041 6e79  a: dict[str, Any
+0000da60: 5d0a 0a20 2020 2023 2323 2323 2323 2323  ]..    #########
+0000da70: 0a20 2020 2023 2048 6973 746f 7279 0a20  .    # History. 
+0000da80: 2020 2023 2323 2323 2323 2323 0a0a 2020     #########..  
+0000da90: 2020 233a 2048 6973 746f 7279 206f 6620    #: History of 
+0000daa0: 636f 6d70 7574 6174 696f 6e73 2e0a 2020  computations..  
+0000dab0: 2020 233a 2054 6865 206c 656e 6774 6820    #: The length 
+0000dac0: 6361 6e20 6265 2074 7765 616b 6564 2074  can be tweaked t
+0000dad0: 6872 6f75 6768 0a20 2020 2023 3a20 6469  hrough.    #: di
+0000dae0: 7374 7269 6275 7465 642e 6469 6167 6e6f  stributed.diagno
+0000daf0: 7374 6963 732e 636f 6d70 7574 6174 696f  stics.computatio
+0000db00: 6e73 2e6d 6178 2d68 6973 746f 7279 0a20  ns.max-history. 
+0000db10: 2020 2063 6f6d 7075 7461 7469 6f6e 733a     computations:
+0000db20: 2064 6571 7565 5b43 6f6d 7075 7461 7469   deque[Computati
+0000db30: 6f6e 5d0a 0a20 2020 2023 3a20 4869 7374  on]..    #: Hist
+0000db40: 6f72 7920 6f66 2065 7272 6564 2074 6173  ory of erred tas
+0000db50: 6b73 2e0a 2020 2020 233a 2054 6865 206c  ks..    #: The l
+0000db60: 656e 6774 6820 6361 6e20 6265 2074 7765  ength can be twe
+0000db70: 616b 6564 2074 6872 6f75 6768 0a20 2020  aked through.   
+0000db80: 2023 3a20 6469 7374 7269 6275 7465 642e   #: distributed.
+0000db90: 6469 6167 6e6f 7374 6963 732e 6572 7265  diagnostics.erre
+0000dba0: 642d 7461 736b 732e 6d61 782d 6869 7374  d-tasks.max-hist
+0000dbb0: 6f72 790a 2020 2020 6572 7265 645f 7461  ory.    erred_ta
+0000dbc0: 736b 733a 2064 6571 7565 5b45 7272 6564  sks: deque[Erred
+0000dbd0: 5461 736b 5d0a 0a20 2020 2023 3a20 4869  Task]..    #: Hi
+0000dbe0: 7374 6f72 7920 6f66 2074 6173 6b20 7374  story of task st
+0000dbf0: 6174 6520 7472 616e 7369 7469 6f6e 732e  ate transitions.
+0000dc00: 0a20 2020 2023 3a20 5468 6520 6c65 6e67  .    #: The leng
+0000dc10: 7468 2063 616e 2062 6520 7477 6561 6b65  th can be tweake
+0000dc20: 6420 7468 726f 7567 680a 2020 2020 233a  d through.    #:
+0000dc30: 2064 6973 7472 6962 7574 6564 2e73 6368   distributed.sch
+0000dc40: 6564 756c 6572 2e74 7261 6e73 6974 696f  eduler.transitio
+0000dc50: 6e2d 6c6f 672d 6c65 6e67 7468 0a20 2020  n-log-length.   
+0000dc60: 2074 7261 6e73 6974 696f 6e5f 6c6f 673a   transition_log:
+0000dc70: 2064 6571 7565 5b54 7261 6e73 6974 696f   deque[Transitio
+0000dc80: 6e5d 0a0a 2020 2020 233a 2054 6f74 616c  n]..    #: Total
+0000dc90: 206e 756d 6265 7220 6f66 2074 7261 6e73   number of trans
+0000dca0: 6974 696f 6e73 2073 696e 6365 2074 6865  itions since the
+0000dcb0: 2063 6c75 7374 6572 2077 6173 2073 7461   cluster was sta
+0000dcc0: 7274 6564 0a20 2020 2074 7261 6e73 6974  rted.    transit
+0000dcd0: 696f 6e5f 636f 756e 7465 723a 2069 6e74  ion_counter: int
+0000dce0: 0a0a 2020 2020 233a 2054 6f74 616c 206e  ..    #: Total n
+0000dcf0: 756d 6265 7220 6f66 2074 7261 6e73 6974  umber of transit
+0000dd00: 696f 6e73 2061 7320 6f66 2074 6865 2070  ions as of the p
+0000dd10: 7265 7669 6f75 7320 6361 6c6c 2074 6f20  revious call to 
+0000dd20: 6368 6563 6b5f 6964 6c65 2829 0a20 2020  check_idle().   
+0000dd30: 205f 6964 6c65 5f74 7261 6e73 6974 696f   _idle_transitio
+0000dd40: 6e5f 636f 756e 7465 723a 2069 6e74 0a0a  n_counter: int..
+0000dd50: 2020 2020 233a 2052 6169 7365 2061 6e20      #: Raise an 
+0000dd60: 6572 726f 7220 6966 2074 6865 203a 6174  error if the :at
+0000dd70: 7472 3a60 7472 616e 7369 7469 6f6e 5f63  tr:`transition_c
+0000dd80: 6f75 6e74 6572 6020 6576 6572 2072 6561  ounter` ever rea
+0000dd90: 6368 6573 2074 6869 7320 7661 6c75 652e  ches this value.
+0000dda0: 0a20 2020 2023 3a20 5468 6973 2069 7320  .    #: This is 
+0000ddb0: 6d65 616e 7420 666f 7220 6465 6275 6767  meant for debugg
+0000ddc0: 696e 6720 6f6e 6c79 2c20 746f 2063 6174  ing only, to cat
+0000ddd0: 6368 2069 6e66 696e 6974 6520 7265 6375  ch infinite recu
+0000dde0: 7273 696f 6e20 6c6f 6f70 732e 0a20 2020  rsion loops..   
+0000ddf0: 2023 3a20 496e 2070 726f 6475 6374 696f   #: In productio
+0000de00: 6e2c 2069 7420 7368 6f75 6c64 2061 6c77  n, it should alw
+0000de10: 6179 7320 6265 2073 6574 2074 6f20 4661  ays be set to Fa
+0000de20: 6c73 652e 0a20 2020 2074 7261 6e73 6974  lse..    transit
+0000de30: 696f 6e5f 636f 756e 7465 725f 6d61 783a  ion_counter_max:
+0000de40: 2069 6e74 207c 204c 6974 6572 616c 5b46   int | Literal[F
+0000de50: 616c 7365 5d0a 0a20 2020 205f 7461 736b  alse]..    _task
+0000de60: 5f70 7265 6669 785f 636f 756e 745f 676c  _prefix_count_gl
+0000de70: 6f62 616c 3a20 6465 6661 756c 7464 6963  obal: defaultdic
+0000de80: 745b 7374 722c 2069 6e74 5d0a 2020 2020  t[str, int].    
+0000de90: 5f6e 6574 776f 726b 5f6f 6363 5f67 6c6f  _network_occ_glo
+0000dea0: 6261 6c3a 2066 6c6f 6174 0a20 2020 2023  bal: float.    #
+0000deb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000dec0: 2323 2323 230a 2020 2020 2320 4361 6368  #####.    # Cach
+0000ded0: 6564 2063 6f6e 6669 6775 7261 7469 6f6e  ed configuration
+0000dee0: 0a20 2020 2023 2323 2323 2323 2323 2323  .    ###########
+0000def0: 2323 2323 2323 2323 2323 230a 0a20 2020  ###########..   
+0000df00: 2023 3a20 6469 7374 7269 6275 7465 642e   #: distributed.
+0000df10: 7363 6865 6475 6c65 722e 756e 6b6e 6f77  scheduler.unknow
+0000df20: 6e2d 7461 736b 2d64 7572 6174 696f 6e0a  n-task-duration.
+0000df30: 2020 2020 554e 4b4e 4f57 4e5f 5441 534b      UNKNOWN_TASK
+0000df40: 5f44 5552 4154 494f 4e3a 2066 6c6f 6174  _DURATION: float
+0000df50: 0a20 2020 2023 3a20 6469 7374 7269 6275  .    #: distribu
+0000df60: 7465 642e 776f 726b 6572 2e6d 656d 6f72  ted.worker.memor
+0000df70: 792e 7265 6365 6e74 2d74 6f2d 6f6c 642d  y.recent-to-old-
+0000df80: 7469 6d65 0a20 2020 204d 454d 4f52 595f  time.    MEMORY_
+0000df90: 5245 4345 4e54 5f54 4f5f 4f4c 445f 5449  RECENT_TO_OLD_TI
+0000dfa0: 4d45 3a20 666c 6f61 740a 2020 2020 233a  ME: float.    #:
+0000dfb0: 2064 6973 7472 6962 7574 6564 2e77 6f72   distributed.wor
+0000dfc0: 6b65 722e 6d65 6d6f 7279 2e72 6562 616c  ker.memory.rebal
+0000dfd0: 616e 6365 2e6d 6561 7375 7265 0a20 2020  ance.measure.   
+0000dfe0: 204d 454d 4f52 595f 5245 4241 4c41 4e43   MEMORY_REBALANC
+0000dff0: 455f 4d45 4153 5552 453a 2073 7472 0a20  E_MEASURE: str. 
+0000e000: 2020 2023 3a20 6469 7374 7269 6275 7465     #: distribute
+0000e010: 642e 776f 726b 6572 2e6d 656d 6f72 792e  d.worker.memory.
+0000e020: 7265 6261 6c61 6e63 652e 7365 6e64 6572  rebalance.sender
+0000e030: 2d6d 696e 0a20 2020 204d 454d 4f52 595f  -min.    MEMORY_
+0000e040: 5245 4241 4c41 4e43 455f 5345 4e44 4552  REBALANCE_SENDER
+0000e050: 5f4d 494e 3a20 666c 6f61 740a 2020 2020  _MIN: float.    
+0000e060: 233a 2064 6973 7472 6962 7574 6564 2e77  #: distributed.w
+0000e070: 6f72 6b65 722e 6d65 6d6f 7279 2e72 6562  orker.memory.reb
+0000e080: 616c 616e 6365 2e72 6563 6970 6965 6e74  alance.recipient
+0000e090: 2d6d 6178 0a20 2020 204d 454d 4f52 595f  -max.    MEMORY_
+0000e0a0: 5245 4241 4c41 4e43 455f 5245 4349 5049  REBALANCE_RECIPI
+0000e0b0: 454e 545f 4d41 583a 2066 6c6f 6174 0a20  ENT_MAX: float. 
+0000e0c0: 2020 2023 3a20 6469 7374 7269 6275 7465     #: distribute
+0000e0d0: 642e 776f 726b 6572 2e6d 656d 6f72 792e  d.worker.memory.
+0000e0e0: 7265 6261 6c61 6e63 652e 7365 6e64 6572  rebalance.sender
+0000e0f0: 2d72 6563 6970 6965 6e74 2d67 6170 202f  -recipient-gap /
+0000e100: 2032 0a20 2020 204d 454d 4f52 595f 5245   2.    MEMORY_RE
+0000e110: 4241 4c41 4e43 455f 4841 4c46 5f47 4150  BALANCE_HALF_GAP
+0000e120: 3a20 666c 6f61 740a 2020 2020 233a 2064  : float.    #: d
+0000e130: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
+0000e140: 756c 6572 2e77 6f72 6b65 722d 7361 7475  uler.worker-satu
+0000e150: 7261 7469 6f6e 0a20 2020 2057 4f52 4b45  ration.    WORKE
+0000e160: 525f 5341 5455 5241 5449 4f4e 3a20 666c  R_SATURATION: fl
+0000e170: 6f61 740a 0a20 2020 205f 5f73 6c6f 7473  oat..    __slots
+0000e180: 5f5f 203d 2074 7570 6c65 285f 5f61 6e6e  __ = tuple(__ann
+0000e190: 6f74 6174 696f 6e73 5f5f 290a 0a20 2020  otations__)..   
+0000e1a0: 2064 6566 205f 5f69 6e69 745f 5f28 0a20   def __init__(. 
+0000e1b0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0000e1c0: 2020 2020 2061 6c69 6173 6573 3a20 6469       aliases: di
+0000e1d0: 6374 5b48 6173 6861 626c 652c 2073 7472  ct[Hashable, str
+0000e1e0: 5d2c 0a20 2020 2020 2020 2063 6c69 656e  ],.        clien
+0000e1f0: 7473 3a20 6469 6374 5b73 7472 2c20 436c  ts: dict[str, Cl
+0000e200: 6965 6e74 5374 6174 655d 2c0a 2020 2020  ientState],.    
+0000e210: 2020 2020 776f 726b 6572 733a 2053 6f72      workers: Sor
+0000e220: 7465 6444 6963 745b 7374 722c 2057 6f72  tedDict[str, Wor
+0000e230: 6b65 7253 7461 7465 5d2c 0a20 2020 2020  kerState],.     
+0000e240: 2020 2068 6f73 745f 696e 666f 3a20 6469     host_info: di
+0000e250: 6374 5b73 7472 2c20 6469 6374 5b73 7472  ct[str, dict[str
+0000e260: 2c20 416e 795d 5d2c 0a20 2020 2020 2020  , Any]],.       
+0000e270: 2072 6573 6f75 7263 6573 3a20 6469 6374   resources: dict
+0000e280: 5b73 7472 2c20 6469 6374 5b73 7472 2c20  [str, dict[str, 
+0000e290: 666c 6f61 745d 5d2c 0a20 2020 2020 2020  float]],.       
+0000e2a0: 2074 6173 6b73 3a20 6469 6374 5b73 7472   tasks: dict[str
+0000e2b0: 2c20 5461 736b 5374 6174 655d 2c0a 2020  , TaskState],.  
+0000e2c0: 2020 2020 2020 756e 7275 6e6e 6162 6c65        unrunnable
+0000e2d0: 3a20 7365 745b 5461 736b 5374 6174 655d  : set[TaskState]
+0000e2e0: 2c0a 2020 2020 2020 2020 7175 6575 6564  ,.        queued
+0000e2f0: 3a20 4865 6170 5365 745b 5461 736b 5374  : HeapSet[TaskSt
+0000e300: 6174 655d 2c0a 2020 2020 2020 2020 7661  ate],.        va
+0000e310: 6c69 6461 7465 3a20 626f 6f6c 2c0a 2020  lidate: bool,.  
+0000e320: 2020 2020 2020 706c 7567 696e 733a 2049        plugins: I
+0000e330: 7465 7261 626c 655b 5363 6865 6475 6c65  terable[Schedule
+0000e340: 7250 6c75 6769 6e5d 203d 2028 292c 0a20  rPlugin] = (),. 
+0000e350: 2020 2020 2020 2074 7261 6e73 6974 696f         transitio
+0000e360: 6e5f 636f 756e 7465 725f 6d61 783a 2069  n_counter_max: i
+0000e370: 6e74 207c 204c 6974 6572 616c 5b46 616c  nt | Literal[Fal
+0000e380: 7365 5d20 3d20 4661 6c73 652c 0a20 2020  se] = False,.   
+0000e390: 2020 2020 202a 2a6b 7761 7267 733a 2041       **kwargs: A
+0000e3a0: 6e79 2c20 2023 2050 6173 7365 6420 7665  ny,  # Passed ve
+0000e3b0: 7262 6174 696d 2074 6f20 5365 7276 6572  rbatim to Server
+0000e3c0: 2e5f 5f69 6e69 745f 5f28 290a 2020 2020  .__init__().    
+0000e3d0: 293a 0a20 2020 2020 2020 206c 6f67 6765  ):.        logge
+0000e3e0: 722e 696e 666f 2822 5374 6174 6520 7374  r.info("State st
+0000e3f0: 6172 7422 290a 2020 2020 2020 2020 7365  art").        se
+0000e400: 6c66 2e61 6c69 6173 6573 203d 2061 6c69  lf.aliases = ali
+0000e410: 6173 6573 0a20 2020 2020 2020 2073 656c  ases.        sel
+0000e420: 662e 6261 6e64 7769 6474 6820 3d20 7061  f.bandwidth = pa
+0000e430: 7273 655f 6279 7465 7328 6461 736b 2e63  rse_bytes(dask.c
+0000e440: 6f6e 6669 672e 6765 7428 2264 6973 7472  onfig.get("distr
+0000e450: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
+0000e460: 2e62 616e 6477 6964 7468 2229 290a 2020  .bandwidth")).  
+0000e470: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+0000e480: 7473 203d 2063 6c69 656e 7473 0a20 2020  ts = clients.   
+0000e490: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
+0000e4a0: 735b 2266 6972 652d 616e 642d 666f 7267  s["fire-and-forg
+0000e4b0: 6574 225d 203d 2043 6c69 656e 7453 7461  et"] = ClientSta
+0000e4c0: 7465 2822 6669 7265 2d61 6e64 2d66 6f72  te("fire-and-for
+0000e4d0: 6765 7422 290a 2020 2020 2020 2020 7365  get").        se
+0000e4e0: 6c66 2e65 7874 656e 7369 6f6e 7320 3d20  lf.extensions = 
+0000e4f0: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
+0000e500: 686f 7374 5f69 6e66 6f20 3d20 686f 7374  host_info = host
+0000e510: 5f69 6e66 6f0a 2020 2020 2020 2020 7365  _info.        se
+0000e520: 6c66 2e69 646c 6520 3d20 536f 7274 6564  lf.idle = Sorted
+0000e530: 4469 6374 2829 0a20 2020 2020 2020 2073  Dict().        s
+0000e540: 656c 662e 6964 6c65 5f74 6173 6b5f 636f  elf.idle_task_co
+0000e550: 756e 7420 3d20 7365 7428 290a 2020 2020  unt = set().    
+0000e560: 2020 2020 7365 6c66 2e6e 5f74 6173 6b73      self.n_tasks
+0000e570: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
+0000e580: 662e 7265 736f 7572 6365 7320 3d20 7265  f.resources = re
+0000e590: 736f 7572 6365 730a 2020 2020 2020 2020  sources.        
+0000e5a0: 7365 6c66 2e73 6174 7572 6174 6564 203d  self.saturated =
+0000e5b0: 2073 6574 2829 0a20 2020 2020 2020 2073   set().        s
+0000e5c0: 656c 662e 7461 736b 7320 3d20 7461 736b  elf.tasks = task
+0000e5d0: 730a 2020 2020 2020 2020 7365 6c66 2e72  s.        self.r
+0000e5e0: 6570 6c69 6361 7465 645f 7461 736b 7320  eplicated_tasks 
+0000e5f0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+0000e600: 7473 2066 6f72 2074 7320 696e 2073 656c  ts for ts in sel
+0000e610: 662e 7461 736b 732e 7661 6c75 6573 2829  f.tasks.values()
+0000e620: 2069 6620 6c65 6e28 7473 2e77 686f 5f68   if len(ts.who_h
+0000e630: 6173 2920 3e20 310a 2020 2020 2020 2020  as) > 1.        
+0000e640: 7d0a 2020 2020 2020 2020 7365 6c66 2e63  }.        self.c
+0000e650: 6f6d 7075 7461 7469 6f6e 7320 3d20 6465  omputations = de
+0000e660: 7175 6528 0a20 2020 2020 2020 2020 2020  que(.           
+0000e670: 206d 6178 6c65 6e3d 6461 736b 2e63 6f6e   maxlen=dask.con
+0000e680: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
+0000e690: 7574 6564 2e64 6961 676e 6f73 7469 6373  uted.diagnostics
+0000e6a0: 2e63 6f6d 7075 7461 7469 6f6e 732e 6d61  .computations.ma
+0000e6b0: 782d 6869 7374 6f72 7922 290a 2020 2020  x-history").    
+0000e6c0: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+0000e6d0: 6c66 2e65 7272 6564 5f74 6173 6b73 203d  lf.erred_tasks =
+0000e6e0: 2064 6571 7565 280a 2020 2020 2020 2020   deque(.        
+0000e6f0: 2020 2020 6d61 786c 656e 3d64 6173 6b2e      maxlen=dask.
+0000e700: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
+0000e710: 7269 6275 7465 642e 6469 6167 6e6f 7374  ributed.diagnost
+0000e720: 6963 732e 6572 7265 642d 7461 736b 732e  ics.erred-tasks.
+0000e730: 6d61 782d 6869 7374 6f72 7922 290a 2020  max-history").  
+0000e740: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000e750: 7365 6c66 2e74 6173 6b5f 6772 6f75 7073  self.task_groups
+0000e760: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
+0000e770: 6c66 2e74 6173 6b5f 7072 6566 6978 6573  lf.task_prefixes
+0000e780: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
+0000e790: 6c66 2e74 6173 6b5f 6d65 7461 6461 7461  lf.task_metadata
+0000e7a0: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
+0000e7b0: 6c66 2e74 6f74 616c 5f6e 7468 7265 6164  lf.total_nthread
+0000e7c0: 7320 3d20 300a 2020 2020 2020 2020 7365  s = 0.        se
+0000e7d0: 6c66 2e74 6f74 616c 5f6e 7468 7265 6164  lf.total_nthread
+0000e7e0: 735f 6869 7374 6f72 7920 3d20 5b28 7469  s_history = [(ti
+0000e7f0: 6d65 2829 2c20 3029 5d0a 2020 2020 2020  me(), 0)].      
+0000e800: 2020 7365 6c66 2e75 6e6b 6e6f 776e 5f64    self.unknown_d
+0000e810: 7572 6174 696f 6e73 203d 207b 7d0a 2020  urations = {}.  
+0000e820: 2020 2020 2020 7365 6c66 2e71 7565 7565        self.queue
+0000e830: 6420 3d20 7175 6575 6564 0a20 2020 2020  d = queued.     
+0000e840: 2020 2073 656c 662e 756e 7275 6e6e 6162     self.unrunnab
+0000e850: 6c65 203d 2075 6e72 756e 6e61 626c 650a  le = unrunnable.
+0000e860: 2020 2020 2020 2020 7365 6c66 2e76 616c          self.val
+0000e870: 6964 6174 6520 3d20 7661 6c69 6461 7465  idate = validate
+0000e880: 0a20 2020 2020 2020 2073 656c 662e 776f  .        self.wo
+0000e890: 726b 6572 7320 3d20 776f 726b 6572 730a  rkers = workers.
+0000e8a0: 2020 2020 2020 2020 7365 6c66 2e5f 7461          self._ta
+0000e8b0: 736b 5f70 7265 6669 785f 636f 756e 745f  sk_prefix_count_
+0000e8c0: 676c 6f62 616c 203d 2064 6566 6175 6c74  global = default
+0000e8d0: 6469 6374 2869 6e74 290a 2020 2020 2020  dict(int).      
+0000e8e0: 2020 7365 6c66 2e5f 6e65 7477 6f72 6b5f    self._network_
+0000e8f0: 6f63 635f 676c 6f62 616c 203d 2030 2e30  occ_global = 0.0
+0000e900: 0a20 2020 2020 2020 2073 656c 662e 7275  .        self.ru
+0000e910: 6e6e 696e 6720 3d20 7b0a 2020 2020 2020  nning = {.      
+0000e920: 2020 2020 2020 7773 2066 6f72 2077 7320        ws for ws 
+0000e930: 696e 2073 656c 662e 776f 726b 6572 732e  in self.workers.
+0000e940: 7661 6c75 6573 2829 2069 6620 7773 2e73  values() if ws.s
+0000e950: 7461 7475 7320 3d3d 2053 7461 7475 732e  tatus == Status.
+0000e960: 7275 6e6e 696e 670a 2020 2020 2020 2020  running.        
+0000e970: 7d0a 2020 2020 2020 2020 7365 6c66 2e70  }.        self.p
+0000e980: 6c75 6769 6e73 203d 207b 7d20 6966 206e  lugins = {} if n
+0000e990: 6f74 2070 6c75 6769 6e73 2065 6c73 6520  ot plugins else 
+0000e9a0: 7b5f 6765 745f 706c 7567 696e 5f6e 616d  {_get_plugin_nam
+0000e9b0: 6528 7029 3a20 7020 666f 7220 7020 696e  e(p): p for p in
+0000e9c0: 2070 6c75 6769 6e73 7d0a 0a20 2020 2020   plugins}..     
+0000e9d0: 2020 2073 656c 662e 7472 616e 7369 7469     self.transiti
+0000e9e0: 6f6e 5f6c 6f67 203d 2064 6571 7565 280a  on_log = deque(.
+0000e9f0: 2020 2020 2020 2020 2020 2020 6d61 786c              maxl
+0000ea00: 656e 3d64 6173 6b2e 636f 6e66 6967 2e67  en=dask.config.g
+0000ea10: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
+0000ea20: 7363 6865 6475 6c65 722e 7472 616e 7369  scheduler.transi
+0000ea30: 7469 6f6e 2d6c 6f67 2d6c 656e 6774 6822  tion-log-length"
+0000ea40: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
+0000ea50: 2020 2020 7365 6c66 2e74 7261 6e73 6974      self.transit
+0000ea60: 696f 6e5f 636f 756e 7465 7220 3d20 300a  ion_counter = 0.
+0000ea70: 2020 2020 2020 2020 7365 6c66 2e5f 6964          self._id
+0000ea80: 6c65 5f74 7261 6e73 6974 696f 6e5f 636f  le_transition_co
+0000ea90: 756e 7465 7220 3d20 300a 2020 2020 2020  unter = 0.      
+0000eaa0: 2020 7365 6c66 2e74 7261 6e73 6974 696f    self.transitio
+0000eab0: 6e5f 636f 756e 7465 725f 6d61 7820 3d20  n_counter_max = 
+0000eac0: 7472 616e 7369 7469 6f6e 5f63 6f75 6e74  transition_count
+0000ead0: 6572 5f6d 6178 0a0a 2020 2020 2020 2020  er_max..        
+0000eae0: 2320 5661 7269 6162 6c65 7320 6672 6f6d  # Variables from
+0000eaf0: 2064 6173 6b2e 636f 6e66 6967 2c20 6361   dask.config, ca
+0000eb00: 6368 6564 2062 7920 5f5f 696e 6974 5f5f  ched by __init__
+0000eb10: 2066 6f72 2070 6572 666f 726d 616e 6365   for performance
+0000eb20: 0a20 2020 2020 2020 2073 656c 662e 554e  .        self.UN
+0000eb30: 4b4e 4f57 4e5f 5441 534b 5f44 5552 4154  KNOWN_TASK_DURAT
+0000eb40: 494f 4e20 3d20 7061 7273 655f 7469 6d65  ION = parse_time
+0000eb50: 6465 6c74 6128 0a20 2020 2020 2020 2020  delta(.         
+0000eb60: 2020 2064 6173 6b2e 636f 6e66 6967 2e67     dask.config.g
+0000eb70: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
+0000eb80: 7363 6865 6475 6c65 722e 756e 6b6e 6f77  scheduler.unknow
+0000eb90: 6e2d 7461 736b 2d64 7572 6174 696f 6e22  n-task-duration"
+0000eba0: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
+0000ebb0: 2020 2020 7365 6c66 2e4d 454d 4f52 595f      self.MEMORY_
+0000ebc0: 5245 4345 4e54 5f54 4f5f 4f4c 445f 5449  RECENT_TO_OLD_TI
+0000ebd0: 4d45 203d 2070 6172 7365 5f74 696d 6564  ME = parse_timed
+0000ebe0: 656c 7461 280a 2020 2020 2020 2020 2020  elta(.          
+0000ebf0: 2020 6461 736b 2e63 6f6e 6669 672e 6765    dask.config.ge
+0000ec00: 7428 2264 6973 7472 6962 7574 6564 2e77  t("distributed.w
+0000ec10: 6f72 6b65 722e 6d65 6d6f 7279 2e72 6563  orker.memory.rec
+0000ec20: 656e 742d 746f 2d6f 6c64 2d74 696d 6522  ent-to-old-time"
+0000ec30: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
+0000ec40: 2020 2020 7365 6c66 2e4d 454d 4f52 595f      self.MEMORY_
+0000ec50: 5245 4241 4c41 4e43 455f 4d45 4153 5552  REBALANCE_MEASUR
+0000ec60: 4520 3d20 6461 736b 2e63 6f6e 6669 672e  E = dask.config.
+0000ec70: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
+0000ec80: 2022 6469 7374 7269 6275 7465 642e 776f   "distributed.wo
+0000ec90: 726b 6572 2e6d 656d 6f72 792e 7265 6261  rker.memory.reba
+0000eca0: 6c61 6e63 652e 6d65 6173 7572 6522 0a20  lance.measure". 
+0000ecb0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000ecc0: 2073 656c 662e 4d45 4d4f 5259 5f52 4542   self.MEMORY_REB
+0000ecd0: 414c 414e 4345 5f53 454e 4445 525f 4d49  ALANCE_SENDER_MI
+0000ece0: 4e20 3d20 6461 736b 2e63 6f6e 6669 672e  N = dask.config.
+0000ecf0: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
+0000ed00: 2022 6469 7374 7269 6275 7465 642e 776f   "distributed.wo
+0000ed10: 726b 6572 2e6d 656d 6f72 792e 7265 6261  rker.memory.reba
+0000ed20: 6c61 6e63 652e 7365 6e64 6572 2d6d 696e  lance.sender-min
+0000ed30: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
+0000ed40: 2020 2020 7365 6c66 2e4d 454d 4f52 595f      self.MEMORY_
+0000ed50: 5245 4241 4c41 4e43 455f 5245 4349 5049  REBALANCE_RECIPI
+0000ed60: 454e 545f 4d41 5820 3d20 6461 736b 2e63  ENT_MAX = dask.c
+0000ed70: 6f6e 6669 672e 6765 7428 0a20 2020 2020  onfig.get(.     
+0000ed80: 2020 2020 2020 2022 6469 7374 7269 6275         "distribu
+0000ed90: 7465 642e 776f 726b 6572 2e6d 656d 6f72  ted.worker.memor
+0000eda0: 792e 7265 6261 6c61 6e63 652e 7265 6369  y.rebalance.reci
+0000edb0: 7069 656e 742d 6d61 7822 0a20 2020 2020  pient-max".     
+0000edc0: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
+0000edd0: 662e 4d45 4d4f 5259 5f52 4542 414c 414e  f.MEMORY_REBALAN
+0000ede0: 4345 5f48 414c 465f 4741 5020 3d20 280a  CE_HALF_GAP = (.
+0000edf0: 2020 2020 2020 2020 2020 2020 6461 736b              dask
+0000ee00: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
+0000ee10: 7472 6962 7574 6564 2e77 6f72 6b65 722e  tributed.worker.
+0000ee20: 6d65 6d6f 7279 2e72 6562 616c 616e 6365  memory.rebalance
+0000ee30: 2e73 656e 6465 722d 7265 6369 7069 656e  .sender-recipien
+0000ee40: 742d 6761 7022 290a 2020 2020 2020 2020  t-gap").        
+0000ee50: 2020 2020 2f20 322e 300a 2020 2020 2020      / 2.0.      
+0000ee60: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
+0000ee70: 662e 574f 524b 4552 5f53 4154 5552 4154  f.WORKER_SATURAT
+0000ee80: 494f 4e20 3d20 6461 736b 2e63 6f6e 6669  ION = dask.confi
+0000ee90: 672e 6765 7428 0a20 2020 2020 2020 2020  g.get(.         
+0000eea0: 2020 2022 6469 7374 7269 6275 7465 642e     "distributed.
+0000eeb0: 7363 6865 6475 6c65 722e 776f 726b 6572  scheduler.worker
+0000eec0: 2d73 6174 7572 6174 696f 6e22 0a20 2020  -saturation".   
+0000eed0: 2020 2020 2029 0a20 2020 2020 2020 2069       ).        i
+0000eee0: 6620 7365 6c66 2e57 4f52 4b45 525f 5341  f self.WORKER_SA
+0000eef0: 5455 5241 5449 4f4e 203d 3d20 2269 6e66  TURATION == "inf
+0000ef00: 223a 0a20 2020 2020 2020 2020 2020 2023  ":.            #
+0000ef10: 2053 7065 6369 616c 2063 6173 6520 6e65   Special case ne
+0000ef20: 6365 7373 6172 7920 6265 6361 7573 6520  cessary because 
+0000ef30: 7468 6572 6527 7320 6e6f 2077 6179 2074  there's no way t
+0000ef40: 6f20 7061 7273 6520 6120 666c 6f61 7420  o parse a float 
+0000ef50: 696e 6669 6e69 7479 0a20 2020 2020 2020  infinity.       
+0000ef60: 2020 2020 2023 2066 726f 6d20 6120 4441       # from a DA
+0000ef70: 534b 5f2a 2065 6e76 6972 6f6e 6d65 6e74  SK_* environment
+0000ef80: 2076 6172 6961 626c 650a 2020 2020 2020   variable.      
+0000ef90: 2020 2020 2020 7365 6c66 2e57 4f52 4b45        self.WORKE
+0000efa0: 525f 5341 5455 5241 5449 4f4e 203d 206d  R_SATURATION = m
+0000efb0: 6174 682e 696e 660a 2020 2020 2020 2020  ath.inf.        
+0000efc0: 6966 2028 0a20 2020 2020 2020 2020 2020  if (.           
+0000efd0: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+0000efe0: 7365 6c66 2e57 4f52 4b45 525f 5341 5455  self.WORKER_SATU
+0000eff0: 5241 5449 4f4e 2c20 2869 6e74 2c20 666c  RATION, (int, fl
+0000f000: 6f61 7429 290a 2020 2020 2020 2020 2020  oat)).          
+0000f010: 2020 6f72 2073 656c 662e 574f 524b 4552    or self.WORKER
+0000f020: 5f53 4154 5552 4154 494f 4e20 3c3d 2030  _SATURATION <= 0
+0000f030: 0a20 2020 2020 2020 2029 3a0a 2020 2020  .        ):.    
+0000f040: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+0000f050: 6c75 6545 7272 6f72 2820 2023 2070 7261  lueError(  # pra
+0000f060: 676d 613a 206e 6f63 6f76 6572 0a20 2020  gma: nocover.   
+0000f070: 2020 2020 2020 2020 2020 2020 2022 6064               "`d
+0000f080: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
+0000f090: 756c 6572 2e77 6f72 6b65 722d 7361 7475  uler.worker-satu
+0000f0a0: 7261 7469 6f6e 6020 6d75 7374 2062 6520  ration` must be 
+0000f0b0: 6120 666c 6f61 7420 3e20 303b 2067 6f74  a float > 0; got
+0000f0c0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+0000f0d0: 2020 202b 2072 6570 7228 7365 6c66 2e57     + repr(self.W
+0000f0e0: 4f52 4b45 525f 5341 5455 5241 5449 4f4e  ORKER_SATURATION
+0000f0f0: 290a 2020 2020 2020 2020 2020 2020 290a  ).            ).
+0000f100: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
+0000f110: 2020 2064 6566 206d 656d 6f72 7928 7365     def memory(se
+0000f120: 6c66 2920 2d3e 204d 656d 6f72 7953 7461  lf) -> MemorySta
+0000f130: 7465 3a0a 2020 2020 2020 2020 7265 7475  te:.        retu
+0000f140: 726e 204d 656d 6f72 7953 7461 7465 2e73  rn MemoryState.s
+0000f150: 756d 282a 2877 2e6d 656d 6f72 7920 666f  um(*(w.memory fo
+0000f160: 7220 7720 696e 2073 656c 662e 776f 726b  r w in self.work
+0000f170: 6572 732e 7661 6c75 6573 2829 2929 0a0a  ers.values()))..
+0000f180: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+0000f190: 2020 6465 6620 5f5f 7064 6963 745f 5f28    def __pdict__(
+0000f1a0: 7365 6c66 2920 2d3e 2064 6963 745b 7374  self) -> dict[st
+0000f1b0: 722c 2041 6e79 5d3a 0a20 2020 2020 2020  r, Any]:.       
+0000f1c0: 2072 6574 7572 6e20 7b0a 2020 2020 2020   return {.      
+0000f1d0: 2020 2020 2020 2262 616e 6477 6964 7468        "bandwidth
+0000f1e0: 223a 2073 656c 662e 6261 6e64 7769 6474  ": self.bandwidt
+0000f1f0: 682c 0a20 2020 2020 2020 2020 2020 2022  h,.            "
+0000f200: 7265 736f 7572 6365 7322 3a20 7365 6c66  resources": self
+0000f210: 2e72 6573 6f75 7263 6573 2c0a 2020 2020  .resources,.    
+0000f220: 2020 2020 2020 2020 2273 6174 7572 6174          "saturat
+0000f230: 6564 223a 2073 656c 662e 7361 7475 7261  ed": self.satura
+0000f240: 7465 642c 0a20 2020 2020 2020 2020 2020  ted,.           
+0000f250: 2022 756e 7275 6e6e 6162 6c65 223a 2073   "unrunnable": s
+0000f260: 656c 662e 756e 7275 6e6e 6162 6c65 2c0a  elf.unrunnable,.
+0000f270: 2020 2020 2020 2020 2020 2020 2271 7565              "que
+0000f280: 7565 6422 3a20 7365 6c66 2e71 7565 7565  ued": self.queue
+0000f290: 642c 0a20 2020 2020 2020 2020 2020 2022  d,.            "
+0000f2a0: 6e5f 7461 736b 7322 3a20 7365 6c66 2e6e  n_tasks": self.n
+0000f2b0: 5f74 6173 6b73 2c0a 2020 2020 2020 2020  _tasks,.        
+0000f2c0: 2020 2020 2275 6e6b 6e6f 776e 5f64 7572      "unknown_dur
+0000f2d0: 6174 696f 6e73 223a 2073 656c 662e 756e  ations": self.un
+0000f2e0: 6b6e 6f77 6e5f 6475 7261 7469 6f6e 732c  known_durations,
+0000f2f0: 0a20 2020 2020 2020 2020 2020 2022 7661  .            "va
+0000f300: 6c69 6461 7465 223a 2073 656c 662e 7661  lidate": self.va
+0000f310: 6c69 6461 7465 2c0a 2020 2020 2020 2020  lidate,.        
+0000f320: 2020 2020 2274 6173 6b73 223a 2073 656c      "tasks": sel
+0000f330: 662e 7461 736b 732c 0a20 2020 2020 2020  f.tasks,.       
+0000f340: 2020 2020 2022 7461 736b 5f67 726f 7570       "task_group
+0000f350: 7322 3a20 7365 6c66 2e74 6173 6b5f 6772  s": self.task_gr
+0000f360: 6f75 7073 2c0a 2020 2020 2020 2020 2020  oups,.          
+0000f370: 2020 2274 6173 6b5f 7072 6566 6978 6573    "task_prefixes
+0000f380: 223a 2073 656c 662e 7461 736b 5f70 7265  ": self.task_pre
+0000f390: 6669 7865 732c 0a20 2020 2020 2020 2020  fixes,.         
+0000f3a0: 2020 2022 746f 7461 6c5f 6e74 6872 6561     "total_nthrea
+0000f3b0: 6473 223a 2073 656c 662e 746f 7461 6c5f  ds": self.total_
+0000f3c0: 6e74 6872 6561 6473 2c0a 2020 2020 2020  nthreads,.      
+0000f3d0: 2020 2020 2020 2274 6f74 616c 5f6f 6363        "total_occ
+0000f3e0: 7570 616e 6379 223a 2073 656c 662e 746f  upancy": self.to
+0000f3f0: 7461 6c5f 6f63 6375 7061 6e63 792c 0a20  tal_occupancy,. 
+0000f400: 2020 2020 2020 2020 2020 2022 6572 7265             "erre
+0000f410: 645f 7461 736b 7322 3a20 7365 6c66 2e65  d_tasks": self.e
+0000f420: 7272 6564 5f74 6173 6b73 2c0a 2020 2020  rred_tasks,.    
+0000f430: 2020 2020 2020 2020 2265 7874 656e 7369          "extensi
+0000f440: 6f6e 7322 3a20 7365 6c66 2e65 7874 656e  ons": self.exten
+0000f450: 7369 6f6e 732c 0a20 2020 2020 2020 2020  sions,.         
+0000f460: 2020 2022 636c 6965 6e74 7322 3a20 7365     "clients": se
+0000f470: 6c66 2e63 6c69 656e 7473 2c0a 2020 2020  lf.clients,.    
+0000f480: 2020 2020 2020 2020 2277 6f72 6b65 7273          "workers
+0000f490: 223a 2073 656c 662e 776f 726b 6572 732c  ": self.workers,
+0000f4a0: 0a20 2020 2020 2020 2020 2020 2022 6964  .            "id
+0000f4b0: 6c65 223a 2073 656c 662e 6964 6c65 2c0a  le": self.idle,.
+0000f4c0: 2020 2020 2020 2020 2020 2020 2268 6f73              "hos
+0000f4d0: 745f 696e 666f 223a 2073 656c 662e 686f  t_info": self.ho
+0000f4e0: 7374 5f69 6e66 6f2c 0a20 2020 2020 2020  st_info,.       
+0000f4f0: 207d 0a0a 2020 2020 6465 6620 6e65 775f   }..    def new_
+0000f500: 7461 736b 280a 2020 2020 2020 2020 7365  task(.        se
+0000f510: 6c66 2c0a 2020 2020 2020 2020 6b65 793a  lf,.        key:
+0000f520: 2073 7472 2c0a 2020 2020 2020 2020 7370   str,.        sp
+0000f530: 6563 3a20 6f62 6a65 6374 2c0a 2020 2020  ec: object,.    
+0000f540: 2020 2020 7374 6174 653a 2054 6173 6b53      state: TaskS
+0000f550: 7461 7465 5374 6174 652c 0a20 2020 2020  tateState,.     
+0000f560: 2020 2063 6f6d 7075 7461 7469 6f6e 3a20     computation: 
+0000f570: 436f 6d70 7574 6174 696f 6e20 7c20 4e6f  Computation | No
+0000f580: 6e65 203d 204e 6f6e 652c 0a20 2020 2029  ne = None,.    )
+0000f590: 202d 3e20 5461 736b 5374 6174 653a 0a20   -> TaskState:. 
+0000f5a0: 2020 2020 2020 2022 2222 4372 6561 7465         """Create
+0000f5b0: 2061 206e 6577 2074 6173 6b2c 2061 6e64   a new task, and
+0000f5c0: 2061 7373 6f63 6961 7465 6420 7374 6174   associated stat
+0000f5d0: 6573 2222 220a 2020 2020 2020 2020 7473  es""".        ts
+0000f5e0: 203d 2054 6173 6b53 7461 7465 286b 6579   = TaskState(key
+0000f5f0: 2c20 7370 6563 2c20 7374 6174 6529 0a0a  , spec, state)..
+0000f600: 2020 2020 2020 2020 7072 6566 6978 5f6b          prefix_k
+0000f610: 6579 203d 206b 6579 5f73 706c 6974 286b  ey = key_split(k
+0000f620: 6579 290a 2020 2020 2020 2020 7470 203d  ey).        tp =
+0000f630: 2073 656c 662e 7461 736b 5f70 7265 6669   self.task_prefi
+0000f640: 7865 732e 6765 7428 7072 6566 6978 5f6b  xes.get(prefix_k
+0000f650: 6579 290a 2020 2020 2020 2020 6966 2074  ey).        if t
+0000f660: 7020 6973 204e 6f6e 653a 0a20 2020 2020  p is None:.     
+0000f670: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
+0000f680: 5f70 7265 6669 7865 735b 7072 6566 6978  _prefixes[prefix
+0000f690: 5f6b 6579 5d20 3d20 7470 203d 2054 6173  _key] = tp = Tas
+0000f6a0: 6b50 7265 6669 7828 7072 6566 6978 5f6b  kPrefix(prefix_k
+0000f6b0: 6579 290a 2020 2020 2020 2020 7473 2e70  ey).        ts.p
+0000f6c0: 7265 6669 7820 3d20 7470 0a0a 2020 2020  refix = tp..    
+0000f6d0: 2020 2020 6772 6f75 705f 6b65 7920 3d20      group_key = 
+0000f6e0: 7473 2e67 726f 7570 5f6b 6579 0a20 2020  ts.group_key.   
+0000f6f0: 2020 2020 2074 6720 3d20 7365 6c66 2e74       tg = self.t
+0000f700: 6173 6b5f 6772 6f75 7073 2e67 6574 2867  ask_groups.get(g
+0000f710: 726f 7570 5f6b 6579 290a 2020 2020 2020  roup_key).      
+0000f720: 2020 6966 2074 6720 6973 204e 6f6e 653a    if tg is None:
+0000f730: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000f740: 662e 7461 736b 5f67 726f 7570 735b 6772  f.task_groups[gr
+0000f750: 6f75 705f 6b65 795d 203d 2074 6720 3d20  oup_key] = tg = 
+0000f760: 5461 736b 4772 6f75 7028 6772 6f75 705f  TaskGroup(group_
+0000f770: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
+0000f780: 2069 6620 636f 6d70 7574 6174 696f 6e3a   if computation:
+0000f790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f7a0: 2063 6f6d 7075 7461 7469 6f6e 2e67 726f   computation.gro
+0000f7b0: 7570 732e 6164 6428 7467 290a 2020 2020  ups.add(tg).    
+0000f7c0: 2020 2020 2020 2020 7467 2e70 7265 6669          tg.prefi
+0000f7d0: 7820 3d20 7470 0a20 2020 2020 2020 2020  x = tp.         
+0000f7e0: 2020 2074 702e 6772 6f75 7073 2e61 7070     tp.groups.app
+0000f7f0: 656e 6428 7467 290a 2020 2020 2020 2020  end(tg).        
+0000f800: 7467 2e61 6464 2874 7329 0a0a 2020 2020  tg.add(ts)..    
+0000f810: 2020 2020 7365 6c66 2e74 6173 6b73 5b6b      self.tasks[k
+0000f820: 6579 5d20 3d20 7473 0a0a 2020 2020 2020  ey] = ts..      
+0000f830: 2020 7265 7475 726e 2074 730a 0a20 2020    return ts..   
+0000f840: 2064 6566 205f 636c 6561 725f 7461 736b   def _clear_task
+0000f850: 5f73 7461 7465 2873 656c 6629 202d 3e20  _state(self) -> 
+0000f860: 4e6f 6e65 3a0a 2020 2020 2020 2020 6c6f  None:.        lo
+0000f870: 6767 6572 2e64 6562 7567 2822 436c 6561  gger.debug("Clea
+0000f880: 7220 7461 736b 2073 7461 7465 2229 0a20  r task state"). 
+0000f890: 2020 2020 2020 2066 6f72 2063 6f6c 6c65         for colle
+0000f8a0: 6374 696f 6e20 696e 2028 0a20 2020 2020  ction in (.     
+0000f8b0: 2020 2020 2020 2073 656c 662e 756e 7275         self.unru
+0000f8c0: 6e6e 6162 6c65 2c0a 2020 2020 2020 2020  nnable,.        
+0000f8d0: 2020 2020 7365 6c66 2e65 7272 6564 5f74      self.erred_t
+0000f8e0: 6173 6b73 2c0a 2020 2020 2020 2020 2020  asks,.          
+0000f8f0: 2020 7365 6c66 2e63 6f6d 7075 7461 7469    self.computati
+0000f900: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+0000f910: 2073 656c 662e 7461 736b 5f70 7265 6669   self.task_prefi
+0000f920: 7865 732c 0a20 2020 2020 2020 2020 2020  xes,.           
+0000f930: 2073 656c 662e 7461 736b 5f67 726f 7570   self.task_group
+0000f940: 732c 0a20 2020 2020 2020 2020 2020 2073  s,.            s
+0000f950: 656c 662e 7461 736b 5f6d 6574 6164 6174  elf.task_metadat
+0000f960: 612c 0a20 2020 2020 2020 2020 2020 2073  a,.            s
+0000f970: 656c 662e 756e 6b6e 6f77 6e5f 6475 7261  elf.unknown_dura
+0000f980: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
+0000f990: 2020 2073 656c 662e 7265 706c 6963 6174     self.replicat
+0000f9a0: 6564 5f74 6173 6b73 2c0a 2020 2020 2020  ed_tasks,.      
+0000f9b0: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
+0000f9c0: 2063 6f6c 6c65 6374 696f 6e2e 636c 6561   collection.clea
+0000f9d0: 7228 2920 2023 2074 7970 653a 2069 676e  r()  # type: ign
+0000f9e0: 6f72 650a 0a20 2020 2040 7072 6f70 6572  ore..    @proper
+0000f9f0: 7479 0a20 2020 2064 6566 2069 735f 6964  ty.    def is_id
+0000fa00: 6c65 2873 656c 6629 202d 3e20 626f 6f6c  le(self) -> bool
+0000fa10: 3a0a 2020 2020 2020 2020 2222 2252 6574  :.        """Ret
+0000fa20: 7572 6e20 5472 7565 2069 6666 2074 6865  urn True iff the
+0000fa30: 7265 2061 7265 206e 6f20 7461 736b 7320  re are no tasks 
+0000fa40: 7468 6174 2068 6176 656e 2774 2066 696e  that haven't fin
+0000fa50: 6973 6865 6420 636f 6d70 7574 696e 672e  ished computing.
+0000fa60: 0a0a 2020 2020 2020 2020 556e 6c69 6b65  ..        Unlike
+0000fa70: 2074 6573 7469 6e67 2060 6073 656c 662e   testing ``self.
+0000fa80: 746f 7461 6c5f 6f63 6375 7061 6e63 7960  total_occupancy`
+0000fa90: 602c 2074 6869 7320 7072 6f70 6572 7479  `, this property
+0000faa0: 2072 6574 7572 6e73 2046 616c 7365 2069   returns False i
+0000fab0: 6620 7468 6572 650a 2020 2020 2020 2020  f there.        
+0000fac0: 6172 6520 6c6f 6e67 2d72 756e 6e69 6e67  are long-running
+0000fad0: 2074 6173 6b73 2c20 6e6f 2d77 6f72 6b65   tasks, no-worke
+0000fae0: 722c 206f 7220 7175 6575 6564 2074 6173  r, or queued tas
+0000faf0: 6b73 2028 6475 6520 746f 206e 6f74 2068  ks (due to not h
+0000fb00: 6176 696e 6720 616e 790a 2020 2020 2020  aving any.      
+0000fb10: 2020 776f 726b 6572 7329 2e0a 0a20 2020    workers)...   
+0000fb20: 2020 2020 204e 6f74 2074 6f20 6265 2063       Not to be c
+0000fb30: 6f6e 6675 7365 6420 7769 7468 2060 6069  onfused with ``i
+0000fb40: 646c 6560 602e 0a20 2020 2020 2020 2022  dle``..        "
+0000fb50: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
+0000fb60: 6e20 616c 6c28 7467 2e64 6f6e 6520 666f  n all(tg.done fo
+0000fb70: 7220 7467 2069 6e20 7365 6c66 2e74 6173  r tg in self.tas
+0000fb80: 6b5f 6772 6f75 7073 2e76 616c 7565 7328  k_groups.values(
+0000fb90: 2929 0a0a 2020 2020 4070 726f 7065 7274  ))..    @propert
+0000fba0: 790a 2020 2020 6465 6620 746f 7461 6c5f  y.    def total_
+0000fbb0: 6f63 6375 7061 6e63 7928 7365 6c66 2920  occupancy(self) 
+0000fbc0: 2d3e 2066 6c6f 6174 3a0a 2020 2020 2020  -> float:.      
+0000fbd0: 2020 7265 7475 726e 2073 656c 662e 5f63    return self._c
+0000fbe0: 616c 635f 6f63 6375 7061 6e63 7928 0a20  alc_occupancy(. 
+0000fbf0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000fc00: 5f74 6173 6b5f 7072 6566 6978 5f63 6f75  _task_prefix_cou
+0000fc10: 6e74 5f67 6c6f 6261 6c2c 0a20 2020 2020  nt_global,.     
+0000fc20: 2020 2020 2020 2073 656c 662e 5f6e 6574         self._net
+0000fc30: 776f 726b 5f6f 6363 5f67 6c6f 6261 6c2c  work_occ_global,
+0000fc40: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0000fc50: 6465 6620 5f63 616c 635f 6f63 6375 7061  def _calc_occupa
+0000fc60: 6e63 7928 0a20 2020 2020 2020 2073 656c  ncy(.        sel
+0000fc70: 662c 0a20 2020 2020 2020 2074 6173 6b5f  f,.        task_
+0000fc80: 7072 6566 6978 5f63 6f75 6e74 3a20 6469  prefix_count: di
+0000fc90: 6374 5b73 7472 2c20 696e 745d 2c0a 2020  ct[str, int],.  
+0000fca0: 2020 2020 2020 6e65 7477 6f72 6b5f 6f63        network_oc
+0000fcb0: 633a 2066 6c6f 6174 2c0a 2020 2020 2920  c: float,.    ) 
+0000fcc0: 2d3e 2066 6c6f 6174 3a0a 2020 2020 2020  -> float:.      
+0000fcd0: 2020 7265 7320 3d20 302e 300a 2020 2020    res = 0.0.    
+0000fce0: 2020 2020 666f 7220 7072 6566 6978 5f6e      for prefix_n
+0000fcf0: 616d 652c 2063 6f75 6e74 2069 6e20 7461  ame, count in ta
+0000fd00: 736b 5f70 7265 6669 785f 636f 756e 742e  sk_prefix_count.
+0000fd10: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+0000fd20: 2020 2020 2023 2054 4f44 4f3a 2044 6561       # TODO: Dea
+0000fd30: 6c20 7769 7468 2075 6e6b 6e6f 776e 2074  l with unknown t
+0000fd40: 6173 6b73 2062 6574 7465 720a 2020 2020  asks better.    
+0000fd50: 2020 2020 2020 2020 7072 6566 6978 203d          prefix =
+0000fd60: 2073 656c 662e 7461 736b 5f70 7265 6669   self.task_prefi
+0000fd70: 7865 735b 7072 6566 6978 5f6e 616d 655d  xes[prefix_name]
+0000fd80: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0000fd90: 6572 7420 7072 6566 6978 2069 7320 6e6f  ert prefix is no
+0000fda0: 7420 4e6f 6e65 0a20 2020 2020 2020 2020  t None.         
+0000fdb0: 2020 2064 7572 6174 696f 6e20 3d20 7072     duration = pr
+0000fdc0: 6566 6978 2e64 7572 6174 696f 6e5f 6176  efix.duration_av
+0000fdd0: 6572 6167 650a 2020 2020 2020 2020 2020  erage.          
+0000fde0: 2020 6966 2064 7572 6174 696f 6e20 3c20    if duration < 
+0000fdf0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+0000fe00: 2020 2069 6620 7072 6566 6978 2e6d 6178     if prefix.max
+0000fe10: 5f65 7865 635f 7469 6d65 203e 2030 3a0a  _exec_time > 0:.
+0000fe20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fe30: 2020 2020 6475 7261 7469 6f6e 203d 2032      duration = 2
+0000fe40: 202a 2070 7265 6669 782e 6d61 785f 6578   * prefix.max_ex
+0000fe50: 6563 5f74 696d 650a 2020 2020 2020 2020  ec_time.        
+0000fe60: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000fe70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fe80: 2020 6475 7261 7469 6f6e 203d 2073 656c    duration = sel
+0000fe90: 662e 554e 4b4e 4f57 4e5f 5441 534b 5f44  f.UNKNOWN_TASK_D
+0000fea0: 5552 4154 494f 4e0a 2020 2020 2020 2020  URATION.        
+0000feb0: 2020 2020 7265 7320 2b3d 2064 7572 6174      res += durat
+0000fec0: 696f 6e20 2a20 636f 756e 740a 2020 2020  ion * count.    
+0000fed0: 2020 2020 6f63 6320 3d20 7265 7320 2b20      occ = res + 
+0000fee0: 6e65 7477 6f72 6b5f 6f63 6320 2f20 7365  network_occ / se
+0000fef0: 6c66 2e62 616e 6477 6964 7468 0a20 2020  lf.bandwidth.   
+0000ff00: 2020 2020 2061 7373 6572 7420 6f63 6320       assert occ 
+0000ff10: 3e3d 2030 2c20 286f 6363 2c20 7265 732c  >= 0, (occ, res,
+0000ff20: 206e 6574 776f 726b 5f6f 6363 2c20 7365   network_occ, se
+0000ff30: 6c66 2e62 616e 6477 6964 7468 290a 2020  lf.bandwidth).  
+0000ff40: 2020 2020 2020 7265 7475 726e 206f 6363        return occ
+0000ff50: 0a0a 2020 2020 2323 2323 2323 2323 2323  ..    ##########
+0000ff60: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
+0000ff70: 2320 5374 6174 6520 5472 616e 7369 7469  # State Transiti
+0000ff80: 6f6e 7320 230a 2020 2020 2323 2323 2323  ons #.    ######
+0000ff90: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+0000ffa0: 0a20 2020 2064 6566 205f 7472 616e 7369  .    def _transi
+0000ffb0: 7469 6f6e 280a 2020 2020 2020 2020 7365  tion(.        se
+0000ffc0: 6c66 2c20 6b65 793a 2073 7472 2c20 6669  lf, key: str, fi
+0000ffd0: 6e69 7368 3a20 5461 736b 5374 6174 6553  nish: TaskStateS
+0000ffe0: 7461 7465 2c20 7374 696d 756c 7573 5f69  tate, stimulus_i
+0000fff0: 643a 2073 7472 2c20 2a2a 6b77 6172 6773  d: str, **kwargs
+00010000: 3a20 416e 790a 2020 2020 2920 2d3e 2052  : Any.    ) -> R
+00010010: 6563 734d 7367 733a 0a20 2020 2020 2020  ecsMsgs:.       
+00010020: 2022 2222 5472 616e 7369 7469 6f6e 2061   """Transition a
+00010030: 206b 6579 2066 726f 6d20 6974 7320 6375   key from its cu
+00010040: 7272 656e 7420 7374 6174 6520 746f 2074  rrent state to t
+00010050: 6865 2066 696e 6973 6820 7374 6174 650a  he finish state.
+00010060: 0a20 2020 2020 2020 2045 7861 6d70 6c65  .        Example
+00010070: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
+00010080: 2d2d 0a20 2020 2020 2020 203e 3e3e 2073  --.        >>> s
+00010090: 656c 662e 5f74 7261 6e73 6974 696f 6e28  elf._transition(
+000100a0: 2778 272c 2027 7761 6974 696e 6727 290a  'x', 'waiting').
+000100b0: 2020 2020 2020 2020 7b27 7827 3a20 2770          {'x': 'p
+000100c0: 726f 6365 7373 696e 6727 7d2c 207b 7d2c  rocessing'}, {},
+000100d0: 207b 7d0a 0a20 2020 2020 2020 2052 6574   {}..        Ret
+000100e0: 7572 6e73 0a20 2020 2020 2020 202d 2d2d  urns.        ---
+000100f0: 2d2d 2d2d 0a20 2020 2020 2020 2054 7570  ----.        Tup
+00010100: 6c65 206f 663a 0a0a 2020 2020 2020 2020  le of:..        
+00010110: 2d20 4469 6374 696f 6e61 7279 206f 6620  - Dictionary of 
+00010120: 7265 636f 6d6d 656e 6461 7469 6f6e 7320  recommendations 
+00010130: 666f 7220 6675 7475 7265 2074 7261 6e73  for future trans
+00010140: 6974 696f 6e73 207b 6b65 793a 206e 6577  itions {key: new
+00010150: 2073 7461 7465 7d0a 2020 2020 2020 2020   state}.        
+00010160: 2d20 4d65 7373 6167 6573 2074 6f20 636c  - Messages to cl
+00010170: 6965 6e74 7320 7b63 6c69 656e 7420 6164  ients {client ad
+00010180: 6472 6573 733a 205b 6d73 672c 206d 7367  dress: [msg, msg
+00010190: 2c20 2e2e 2e5d 7d0a 2020 2020 2020 2020  , ...]}.        
+000101a0: 2d20 4d65 7373 6167 6573 2074 6f20 776f  - Messages to wo
+000101b0: 726b 6572 7320 7b77 6f72 6b65 7220 6164  rkers {worker ad
+000101c0: 6472 6573 733a 205b 6d73 672c 206d 7367  dress: [msg, msg
+000101d0: 2c20 2e2e 2e5d 7d0a 0a20 2020 2020 2020  , ...]}..       
+000101e0: 2053 6565 2041 6c73 6f0a 2020 2020 2020   See Also.      
+000101f0: 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020    --------.     
+00010200: 2020 2053 6368 6564 756c 6572 2e74 7261     Scheduler.tra
+00010210: 6e73 6974 696f 6e73 203a 2074 7261 6e73  nsitions : trans
+00010220: 6974 6976 6520 7665 7273 696f 6e20 6f66  itive version of
+00010230: 2074 6869 7320 6675 6e63 7469 6f6e 0a20   this function. 
+00010240: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00010250: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00010260: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
+00010270: 736b 732e 6765 7428 6b65 7929 0a20 2020  sks.get(key).   
+00010280: 2020 2020 2020 2020 2069 6620 7473 2069           if ts i
+00010290: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+000102a0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+000102b0: 7d2c 207b 7d2c 207b 7d0a 2020 2020 2020  }, {}, {}.      
+000102c0: 2020 2020 2020 7374 6172 7420 3d20 7473        start = ts
+000102d0: 2e5f 7374 6174 650a 2020 2020 2020 2020  ._state.        
+000102e0: 2020 2020 6966 2073 7461 7274 203d 3d20      if start == 
+000102f0: 6669 6e69 7368 3a0a 2020 2020 2020 2020  finish:.        
+00010300: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+00010310: 7d2c 207b 7d2c 207b 7d0a 0a20 2020 2020  }, {}, {}..     
+00010320: 2020 2020 2020 2023 204e 6f74 6573 3a0a         # Notes:.
+00010330: 2020 2020 2020 2020 2020 2020 2320 2d20              # - 
+00010340: 696e 2063 6173 6520 6f66 2074 7261 6e73  in case of trans
+00010350: 6974 696f 6e20 7468 726f 7567 6820 7265  ition through re
+00010360: 6c65 6173 6564 2c20 7468 6973 2063 6f75  leased, this cou
+00010370: 6e74 6572 2069 7320 696e 6372 656d 656e  nter is incremen
+00010380: 7465 6420 6279 2032 0a20 2020 2020 2020  ted by 2.       
+00010390: 2020 2020 2023 202d 2074 6869 7320 696e       # - this in
+000103a0: 6372 6561 7365 2068 6170 7065 6e73 2062  crease happens b
+000103b0: 6566 6f72 6520 7468 6520 6163 7475 616c  efore the actual
+000103c0: 2074 7261 6e73 6974 696f 6e73 2c20 736f   transitions, so
+000103d0: 2074 6861 7420 6974 2063 616e 0a20 2020   that it can.   
+000103e0: 2020 2020 2020 2020 2023 2020 2063 6174           #   cat
+000103f0: 6368 2070 6f74 656e 7469 616c 2069 6e66  ch potential inf
+00010400: 696e 6974 6520 7265 6375 7273 696f 6e73  inite recursions
+00010410: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00010420: 662e 7472 616e 7369 7469 6f6e 5f63 6f75  f.transition_cou
+00010430: 6e74 6572 202b 3d20 310a 2020 2020 2020  nter += 1.      
+00010440: 2020 2020 2020 6966 2073 656c 662e 7472        if self.tr
+00010450: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
+00010460: 5f6d 6178 3a0a 2020 2020 2020 2020 2020  _max:.          
+00010470: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
+00010480: 662e 7472 616e 7369 7469 6f6e 5f63 6f75  f.transition_cou
+00010490: 6e74 6572 203c 2073 656c 662e 7472 616e  nter < self.tran
+000104a0: 7369 7469 6f6e 5f63 6f75 6e74 6572 5f6d  sition_counter_m
+000104b0: 6178 0a0a 2020 2020 2020 2020 2020 2020  ax..            
+000104c0: 7265 636f 6d6d 656e 6461 7469 6f6e 733a  recommendations:
+000104d0: 2064 6963 7420 3d20 7b7d 0a20 2020 2020   dict = {}.     
+000104e0: 2020 2020 2020 2077 6f72 6b65 725f 6d73         worker_ms
+000104f0: 6773 3a20 6469 6374 203d 207b 7d0a 2020  gs: dict = {}.  
+00010500: 2020 2020 2020 2020 2020 636c 6965 6e74            client
+00010510: 5f6d 7367 733a 2064 6963 7420 3d20 7b7d  _msgs: dict = {}
+00010520: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+00010530: 2073 656c 662e 706c 7567 696e 733a 0a20   self.plugins:. 
+00010540: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00010550: 6570 656e 6465 6e74 7320 3d20 7365 7428  ependents = set(
+00010560: 7473 2e64 6570 656e 6465 6e74 7329 0a20  ts.dependents). 
+00010570: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00010580: 6570 656e 6465 6e63 6965 7320 3d20 7365  ependencies = se
+00010590: 7428 7473 2e64 6570 656e 6465 6e63 6965  t(ts.dependencie
+000105a0: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
+000105b0: 6675 6e63 203d 2073 656c 662e 5f54 5241  func = self._TRA
+000105c0: 4e53 4954 494f 4e53 5f54 4142 4c45 2e67  NSITIONS_TABLE.g
+000105d0: 6574 2828 7374 6172 742c 2066 696e 6973  et((start, finis
+000105e0: 6829 290a 2020 2020 2020 2020 2020 2020  h)).            
+000105f0: 6966 2066 756e 6320 6973 206e 6f74 204e  if func is not N
+00010600: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00010610: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+00010620: 696f 6e73 2c20 636c 6965 6e74 5f6d 7367  ions, client_msg
+00010630: 732c 2077 6f72 6b65 725f 6d73 6773 203d  s, worker_msgs =
+00010640: 2066 756e 6328 0a20 2020 2020 2020 2020   func(.         
+00010650: 2020 2020 2020 2020 2020 2073 656c 662c             self,
+00010660: 206b 6579 2c20 7374 696d 756c 7573 5f69   key, stimulus_i
+00010670: 642c 202a 2a6b 7761 7267 730a 2020 2020  d, **kwargs.    
+00010680: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00010690: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+000106a0: 2272 656c 6561 7365 6422 206e 6f74 2069  "released" not i
+000106b0: 6e20 2873 7461 7274 2c20 6669 6e69 7368  n (start, finish
+000106c0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000106d0: 2020 2061 7373 6572 7420 6e6f 7420 6b77     assert not kw
+000106e0: 6172 6773 2c20 286b 7761 7267 732c 2073  args, (kwargs, s
+000106f0: 7461 7274 2c20 6669 6e69 7368 290a 2020  tart, finish).  
+00010700: 2020 2020 2020 2020 2020 2020 2020 615f                a_
+00010710: 7265 6373 2c20 615f 636d 7367 732c 2061  recs, a_cmsgs, a
+00010720: 5f77 6d73 6773 203d 2073 656c 662e 5f74  _wmsgs = self._t
+00010730: 7261 6e73 6974 696f 6e28 0a20 2020 2020  ransition(.     
+00010740: 2020 2020 2020 2020 2020 2020 2020 206b                 k
+00010750: 6579 2c20 2272 656c 6561 7365 6422 2c20  ey, "released", 
+00010760: 7374 696d 756c 7573 5f69 640a 2020 2020  stimulus_id.    
+00010770: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00010780: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+00010790: 203d 2061 5f72 6563 732e 6765 7428 6b65   = a_recs.get(ke
+000107a0: 792c 2066 696e 6973 6829 0a20 2020 2020  y, finish).     
+000107b0: 2020 2020 2020 2020 2020 2066 756e 6320             func 
+000107c0: 3d20 7365 6c66 2e5f 5452 414e 5349 5449  = self._TRANSITI
+000107d0: 4f4e 535f 5441 424c 455b 2272 656c 6561  ONS_TABLE["relea
+000107e0: 7365 6422 2c20 765d 0a20 2020 2020 2020  sed", v].       
+000107f0: 2020 2020 2020 2020 2062 5f72 6563 732c           b_recs,
+00010800: 2062 5f63 6d73 6773 2c20 625f 776d 7367   b_cmsgs, b_wmsg
+00010810: 7320 3d20 6675 6e63 2873 656c 662c 206b  s = func(self, k
+00010820: 6579 2c20 7374 696d 756c 7573 5f69 6429  ey, stimulus_id)
+00010830: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00010840: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+00010850: 732e 7570 6461 7465 2861 5f72 6563 7329  s.update(a_recs)
+00010860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010870: 2066 6f72 2063 2c20 6e65 775f 6d73 6773   for c, new_msgs
+00010880: 2069 6e20 615f 636d 7367 732e 6974 656d   in a_cmsgs.item
+00010890: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+000108a0: 2020 2020 2020 2020 2063 6c69 656e 745f           client_
+000108b0: 6d73 6773 2e73 6574 6465 6661 756c 7428  msgs.setdefault(
+000108c0: 632c 205b 5d29 2e65 7874 656e 6428 6e65  c, []).extend(ne
+000108d0: 775f 6d73 6773 290a 2020 2020 2020 2020  w_msgs).        
+000108e0: 2020 2020 2020 2020 666f 7220 772c 206e          for w, n
+000108f0: 6577 5f6d 7367 7320 696e 2061 5f77 6d73  ew_msgs in a_wms
+00010900: 6773 2e69 7465 6d73 2829 3a0a 2020 2020  gs.items():.    
+00010910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010920: 776f 726b 6572 5f6d 7367 732e 7365 7464  worker_msgs.setd
+00010930: 6566 6175 6c74 2877 2c20 5b5d 292e 6578  efault(w, []).ex
+00010940: 7465 6e64 286e 6577 5f6d 7367 7329 0a0a  tend(new_msgs)..
+00010950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010960: 7265 636f 6d6d 656e 6461 7469 6f6e 732e  recommendations.
+00010970: 7570 6461 7465 2862 5f72 6563 7329 0a20  update(b_recs). 
+00010980: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00010990: 6f72 2063 2c20 6e65 775f 6d73 6773 2069  or c, new_msgs i
+000109a0: 6e20 625f 636d 7367 732e 6974 656d 7328  n b_cmsgs.items(
+000109b0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000109c0: 2020 2020 2020 2063 6c69 656e 745f 6d73         client_ms
+000109d0: 6773 2e73 6574 6465 6661 756c 7428 632c  gs.setdefault(c,
+000109e0: 205b 5d29 2e65 7874 656e 6428 6e65 775f   []).extend(new_
+000109f0: 6d73 6773 290a 2020 2020 2020 2020 2020  msgs).          
+00010a00: 2020 2020 2020 666f 7220 772c 206e 6577        for w, new
+00010a10: 5f6d 7367 7320 696e 2062 5f77 6d73 6773  _msgs in b_wmsgs
+00010a20: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+00010a30: 2020 2020 2020 2020 2020 2020 2020 776f                wo
+00010a40: 726b 6572 5f6d 7367 732e 7365 7464 6566  rker_msgs.setdef
+00010a50: 6175 6c74 2877 2c20 5b5d 292e 6578 7465  ault(w, []).exte
+00010a60: 6e64 286e 6577 5f6d 7367 7329 0a0a 2020  nd(new_msgs)..  
+00010a70: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00010a80: 6172 7420 3d20 2272 656c 6561 7365 6422  art = "released"
+00010a90: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00010aa0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00010ab0: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
+00010ac0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+00010ad0: 2020 2020 2020 2020 2020 2066 2249 6d70             f"Imp
+00010ae0: 6f73 7369 626c 6520 7472 616e 7369 7469  ossible transiti
+00010af0: 6f6e 2066 726f 6d20 7b73 7461 7274 7d20  on from {start} 
+00010b00: 746f 207b 6669 6e69 7368 7d20 666f 7220  to {finish} for 
+00010b10: 7b6b 6579 2172 7d3a 2022 0a20 2020 2020  {key!r}: ".     
+00010b20: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00010b30: 227b 7374 696d 756c 7573 5f69 643d 7d2c  "{stimulus_id=},
+00010b40: 207b 6b77 6172 6773 3d7d 2c20 7374 6f72   {kwargs=}, stor
+00010b50: 793d 7b73 656c 662e 7374 6f72 7928 7473  y={self.story(ts
+00010b60: 297d 220a 2020 2020 2020 2020 2020 2020  )}".            
+00010b70: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+00010b80: 2020 2069 6620 6e6f 7420 7374 696d 756c     if not stimul
+00010b90: 7573 5f69 643a 0a20 2020 2020 2020 2020  us_id:.         
+00010ba0: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
+00010bb0: 6964 203d 2053 5449 4d55 4c55 535f 4944  id = STIMULUS_ID
+00010bc0: 5f55 4e53 4554 0a0a 2020 2020 2020 2020  _UNSET..        
+00010bd0: 2020 2020 6163 7475 616c 5f66 696e 6973      actual_finis
+00010be0: 6820 3d20 7473 2e5f 7374 6174 650a 2020  h = ts._state.  
+00010bf0: 2020 2020 2020 2020 2020 7365 6c66 2e74            self.t
+00010c00: 7261 6e73 6974 696f 6e5f 6c6f 672e 6170  ransition_log.ap
+00010c10: 7065 6e64 280a 2020 2020 2020 2020 2020  pend(.          
+00010c20: 2020 2020 2020 5472 616e 7369 7469 6f6e        Transition
+00010c30: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00010c40: 2020 2020 2020 6b65 792c 2073 7461 7274        key, start
+00010c50: 2c20 6163 7475 616c 5f66 696e 6973 682c  , actual_finish,
+00010c60: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00010c70: 2c20 7374 696d 756c 7573 5f69 642c 2074  , stimulus_id, t
+00010c80: 696d 6528 290a 2020 2020 2020 2020 2020  ime().          
+00010c90: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00010ca0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00010cb0: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
+00010cc0: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+00010cd0: 2020 2020 6966 2073 7469 6d75 6c75 735f      if stimulus_
+00010ce0: 6964 203d 3d20 5354 494d 554c 5553 5f49  id == STIMULUS_I
+00010cf0: 445f 554e 5345 543a 0a20 2020 2020 2020  D_UNSET:.       
+00010d00: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00010d10: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
+00010d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010d30: 2020 2020 2020 2020 2022 7374 696d 756c           "stimul
+00010d40: 7573 5f69 6420 6e6f 7420 7365 7420 6475  us_id not set du
+00010d50: 7269 6e67 2053 6368 6564 756c 6572 2074  ring Scheduler t
+00010d60: 7261 6e73 6974 696f 6e22 0a20 2020 2020  ransition".     
+00010d70: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00010d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010d90: 206c 6f67 6765 722e 6465 6275 6728 0a20   logger.debug(. 
+00010da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010db0: 2020 2022 5472 616e 7369 7469 6f6e 6564     "Transitioned
+00010dc0: 2025 7220 2573 2d3e 2573 2028 6163 7475   %r %s->%s (actu
+00010dd0: 616c 3a20 2573 292e 2020 436f 6e73 6571  al: %s).  Conseq
+00010de0: 7565 6e63 653a 2025 7322 2c0a 2020 2020  uence: %s",.    
+00010df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010e00: 6b65 792c 0a20 2020 2020 2020 2020 2020  key,.           
+00010e10: 2020 2020 2020 2020 2073 7461 7274 2c0a           start,.
 00010e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010e30: 2020 2020 7473 2e64 6570 656e 6465 6e63      ts.dependenc
-00010e40: 6965 7320 3d20 6465 7065 6e64 656e 6369  ies = dependenci
-00010e50: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
-00010e60: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
-00010e70: 735b 7473 2e6b 6579 5d20 3d20 7473 0a20  s[ts.key] = ts. 
-00010e80: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00010e90: 6f72 2070 6c75 6769 6e20 696e 206c 6973  or plugin in lis
-00010ea0: 7428 7365 6c66 2e70 6c75 6769 6e73 2e76  t(self.plugins.v
-00010eb0: 616c 7565 7328 2929 3a0a 2020 2020 2020  alues()):.      
-00010ec0: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-00010ed0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00010ee0: 2020 2020 2020 2020 2020 2070 6c75 6769             plugi
-00010ef0: 6e2e 7472 616e 7369 7469 6f6e 286b 6579  n.transition(key
-00010f00: 2c20 7374 6172 742c 2061 6374 7561 6c5f  , start, actual_
-00010f10: 6669 6e69 7368 2c20 2a2a 6b77 6172 6773  finish, **kwargs
-00010f20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00010f30: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-00010f40: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-00010f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f60: 6c6f 6767 6572 2e69 6e66 6f28 2250 6c75  logger.info("Plu
-00010f70: 6769 6e20 6661 696c 6564 2077 6974 6820  gin failed with 
-00010f80: 6578 6365 7074 696f 6e22 2c20 6578 635f  exception", exc_
-00010f90: 696e 666f 3d54 7275 6529 0a20 2020 2020  info=True).     
-00010fa0: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
-00010fb0: 2e73 7461 7465 203d 3d20 2266 6f72 676f  .state == "forgo
-00010fc0: 7474 656e 223a 0a20 2020 2020 2020 2020  tten":.         
-00010fd0: 2020 2020 2020 2020 2020 2064 656c 2073             del s
-00010fe0: 656c 662e 7461 736b 735b 7473 2e6b 6579  elf.tasks[ts.key
-00010ff0: 5d0a 0a20 2020 2020 2020 2020 2020 2074  ]..            t
-00011000: 6720 3d20 7473 2e67 726f 7570 0a20 2020  g = ts.group.   
-00011010: 2020 2020 2020 2020 2069 6620 7473 2e73           if ts.s
-00011020: 7461 7465 203d 3d20 2266 6f72 676f 7474  tate == "forgott
-00011030: 656e 2220 616e 6420 7467 2e6e 616d 6520  en" and tg.name 
-00011040: 696e 2073 656c 662e 7461 736b 5f67 726f  in self.task_gro
-00011050: 7570 733a 0a20 2020 2020 2020 2020 2020  ups:.           
-00011060: 2020 2020 2023 2052 656d 6f76 6520 5461       # Remove Ta
-00011070: 736b 4772 6f75 7020 6966 2061 6c6c 2074  skGroup if all t
-00011080: 6173 6b73 2061 7265 2069 6e20 7468 6520  asks are in the 
-00011090: 666f 7267 6f74 7465 6e20 7374 6174 650a  forgotten state.
-000110a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000110b0: 6966 2061 6c6c 2876 203d 3d20 3020 6f72  if all(v == 0 or
-000110c0: 206b 203d 3d20 2266 6f72 676f 7474 656e   k == "forgotten
-000110d0: 2220 666f 7220 6b2c 2076 2069 6e20 7467  " for k, v in tg
-000110e0: 2e73 7461 7465 732e 6974 656d 7328 2929  .states.items())
-000110f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00011100: 2020 2020 2020 7473 2e70 7265 6669 782e        ts.prefix.
-00011110: 6772 6f75 7073 2e72 656d 6f76 6528 7467  groups.remove(tg
-00011120: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00011130: 2020 2020 2020 6465 6c20 7365 6c66 2e74        del self.t
-00011140: 6173 6b5f 6772 6f75 7073 5b74 672e 6e61  ask_groups[tg.na
-00011150: 6d65 5d0a 0a20 2020 2020 2020 2020 2020  me]..           
-00011160: 2072 6574 7572 6e20 7265 636f 6d6d 656e   return recommen
-00011170: 6461 7469 6f6e 732c 2063 6c69 656e 745f  dations, client_
-00011180: 6d73 6773 2c20 776f 726b 6572 5f6d 7367  msgs, worker_msg
-00011190: 730a 2020 2020 2020 2020 6578 6365 7074  s.        except
-000111a0: 2045 7863 6570 7469 6f6e 3a0a 2020 2020   Exception:.    
-000111b0: 2020 2020 2020 2020 6c6f 6767 6572 2e65          logger.e
-000111c0: 7863 6570 7469 6f6e 2822 4572 726f 7220  xception("Error 
-000111d0: 7472 616e 7369 7469 6f6e 696e 6720 2572  transitioning %r
-000111e0: 2066 726f 6d20 2572 2074 6f20 2572 222c   from %r to %r",
-000111f0: 206b 6579 2c20 7374 6172 742c 2066 696e   key, start, fin
-00011200: 6973 6829 0a20 2020 2020 2020 2020 2020  ish).           
-00011210: 2069 6620 4c4f 475f 5044 423a 0a20 2020   if LOG_PDB:.   
-00011220: 2020 2020 2020 2020 2020 2020 2069 6d70               imp
-00011230: 6f72 7420 7064 620a 0a20 2020 2020 2020  ort pdb..       
-00011240: 2020 2020 2020 2020 2070 6462 2e73 6574           pdb.set
-00011250: 5f74 7261 6365 2829 0a20 2020 2020 2020  _trace().       
-00011260: 2020 2020 2072 6169 7365 0a0a 2020 2020       raise..    
-00011270: 6465 6620 5f74 7261 6e73 6974 696f 6e73  def _transitions
-00011280: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-00011290: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-000112a0: 6461 7469 6f6e 733a 2052 6563 732c 0a20  dations: Recs,. 
-000112b0: 2020 2020 2020 2063 6c69 656e 745f 6d73         client_ms
-000112c0: 6773 3a20 4d73 6773 2c0a 2020 2020 2020  gs: Msgs,.      
-000112d0: 2020 776f 726b 6572 5f6d 7367 733a 204d    worker_msgs: M
-000112e0: 7367 732c 0a20 2020 2020 2020 2073 7469  sgs,.        sti
-000112f0: 6d75 6c75 735f 6964 3a20 7374 722c 0a20  mulus_id: str,. 
-00011300: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
-00011310: 2020 2020 2020 2222 2250 726f 6365 7373        """Process
-00011320: 2074 7261 6e73 6974 696f 6e73 2075 6e74   transitions unt
-00011330: 696c 206e 6f6e 6520 6172 6520 6c65 6674  il none are left
-00011340: 0a0a 2020 2020 2020 2020 5468 6973 2069  ..        This i
-00011350: 6e63 6c75 6465 7320 6665 6564 6261 636b  ncludes feedback
-00011360: 2066 726f 6d20 7072 6576 696f 7573 2074   from previous t
-00011370: 7261 6e73 6974 696f 6e73 2061 6e64 2063  ransitions and c
-00011380: 6f6e 7469 6e75 6573 2075 6e74 696c 2077  ontinues until w
-00011390: 650a 2020 2020 2020 2020 7265 6163 6820  e.        reach 
-000113a0: 6120 7374 6561 6479 2073 7461 7465 0a20  a steady state. 
-000113b0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-000113c0: 2020 206b 6579 733a 2073 6574 5b73 7472     keys: set[str
-000113d0: 5d20 3d20 7365 7428 290a 2020 2020 2020  ] = set().      
-000113e0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-000113f0: 7320 3d20 7265 636f 6d6d 656e 6461 7469  s = recommendati
-00011400: 6f6e 732e 636f 7079 2829 0a0a 2020 2020  ons.copy()..    
-00011410: 2020 2020 7768 696c 6520 7265 636f 6d6d      while recomm
-00011420: 656e 6461 7469 6f6e 733a 0a20 2020 2020  endations:.     
-00011430: 2020 2020 2020 206b 6579 2c20 6669 6e69         key, fini
-00011440: 7368 203d 2072 6563 6f6d 6d65 6e64 6174  sh = recommendat
-00011450: 696f 6e73 2e70 6f70 6974 656d 2829 0a20  ions.popitem(). 
-00011460: 2020 2020 2020 2020 2020 206b 6579 732e             keys.
-00011470: 6164 6428 6b65 7929 0a0a 2020 2020 2020  add(key)..      
-00011480: 2020 2020 2020 6e65 775f 7265 6373 2c20        new_recs, 
-00011490: 6e65 775f 636d 7367 732c 206e 6577 5f77  new_cmsgs, new_w
-000114a0: 6d73 6773 203d 2073 656c 662e 5f74 7261  msgs = self._tra
-000114b0: 6e73 6974 696f 6e28 6b65 792c 2066 696e  nsition(key, fin
-000114c0: 6973 682c 2073 7469 6d75 6c75 735f 6964  ish, stimulus_id
-000114d0: 290a 0a20 2020 2020 2020 2020 2020 2072  )..            r
-000114e0: 6563 6f6d 6d65 6e64 6174 696f 6e73 2e75  ecommendations.u
-000114f0: 7064 6174 6528 6e65 775f 7265 6373 290a  pdate(new_recs).
-00011500: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00011510: 632c 206e 6577 5f6d 7367 7320 696e 206e  c, new_msgs in n
-00011520: 6577 5f63 6d73 6773 2e69 7465 6d73 2829  ew_cmsgs.items()
-00011530: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00011540: 2020 636c 6965 6e74 5f6d 7367 732e 7365    client_msgs.se
-00011550: 7464 6566 6175 6c74 2863 2c20 5b5d 292e  tdefault(c, []).
-00011560: 6578 7465 6e64 286e 6577 5f6d 7367 7329  extend(new_msgs)
-00011570: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00011580: 2077 2c20 6e65 775f 6d73 6773 2069 6e20   w, new_msgs in 
-00011590: 6e65 775f 776d 7367 732e 6974 656d 7328  new_wmsgs.items(
-000115a0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000115b0: 2020 2077 6f72 6b65 725f 6d73 6773 2e73     worker_msgs.s
-000115c0: 6574 6465 6661 756c 7428 772c 205b 5d29  etdefault(w, [])
-000115d0: 2e65 7874 656e 6428 6e65 775f 6d73 6773  .extend(new_msgs
-000115e0: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
-000115f0: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
-00011600: 2020 2020 2020 2020 2023 2046 4958 4d45           # FIXME
-00011610: 2064 6f77 6e63 6173 7420 616e 7469 7061   downcast antipa
-00011620: 7474 6572 6e0a 2020 2020 2020 2020 2020  ttern.          
-00011630: 2020 7363 6865 6475 6c65 7220 3d20 6361    scheduler = ca
-00011640: 7374 2853 6368 6564 756c 6572 2c20 7365  st(Scheduler, se
-00011650: 6c66 290a 2020 2020 2020 2020 2020 2020  lf).            
-00011660: 666f 7220 6b65 7920 696e 206b 6579 733a  for key in keys:
-00011670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011680: 2073 6368 6564 756c 6572 2e76 616c 6964   scheduler.valid
-00011690: 6174 655f 6b65 7928 6b65 7929 0a0a 2020  ate_key(key)..  
-000116a0: 2020 6465 6620 7472 616e 7369 7469 6f6e    def transition
-000116b0: 5f72 656c 6561 7365 645f 7761 6974 696e  _released_waitin
-000116c0: 6728 7365 6c66 2c20 6b65 793a 2073 7472  g(self, key: str
-000116d0: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
-000116e0: 7472 2920 2d3e 2052 6563 734d 7367 733a  tr) -> RecsMsgs:
-000116f0: 0a20 2020 2020 2020 2074 7320 3d20 7365  .        ts = se
-00011700: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 0a20  lf.tasks[key].. 
-00011710: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
-00011720: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
-00011730: 2020 2020 2061 7373 6572 7420 7473 2e72       assert ts.r
-00011740: 756e 5f73 7065 630a 2020 2020 2020 2020  un_spec.        
-00011750: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
-00011760: 732e 7761 6974 696e 675f 6f6e 0a20 2020  s.waiting_on.   
-00011770: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00011780: 6e6f 7420 7473 2e77 686f 5f68 6173 0a20  not ts.who_has. 
-00011790: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-000117a0: 7420 6e6f 7420 7473 2e70 726f 6365 7373  t not ts.process
-000117b0: 696e 675f 6f6e 0a20 2020 2020 2020 2020  ing_on.         
-000117c0: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
-000117d0: 2e64 6570 656e 6465 6e63 6965 733a 0a20  .dependencies:. 
-000117e0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-000117f0: 7373 6572 7420 6474 732e 7374 6174 6520  ssert dts.state 
-00011800: 6e6f 7420 696e 207b 2266 6f72 676f 7474  not in {"forgott
-00011810: 656e 222c 2022 6572 7265 6422 7d0a 0a20  en", "erred"}.. 
-00011820: 2020 2020 2020 2069 6620 7473 2e68 6173         if ts.has
-00011830: 5f6c 6f73 745f 6465 7065 6e64 656e 6369  _lost_dependenci
-00011840: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00011850: 7265 7475 726e 207b 6b65 793a 2022 666f  return {key: "fo
-00011860: 7267 6f74 7465 6e22 7d2c 207b 7d2c 207b  rgotten"}, {}, {
-00011870: 7d0a 0a20 2020 2020 2020 2074 732e 7374  }..        ts.st
-00011880: 6174 6520 3d20 2277 6169 7469 6e67 220a  ate = "waiting".
-00011890: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
-000118a0: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
-000118b0: 207b 7d0a 0a20 2020 2020 2020 2066 6f72   {}..        for
-000118c0: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
-000118d0: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
-000118e0: 2020 2020 2069 6620 6e6f 7420 6474 732e       if not dts.
-000118f0: 7768 6f5f 6861 733a 0a20 2020 2020 2020  who_has:.       
-00011900: 2020 2020 2020 2020 2074 732e 7761 6974           ts.wait
-00011910: 696e 675f 6f6e 2e61 6464 2864 7473 290a  ing_on.add(dts).
-00011920: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-00011930: 7473 2e73 7461 7465 203d 3d20 2272 656c  ts.state == "rel
-00011940: 6561 7365 6422 3a0a 2020 2020 2020 2020  eased":.        
-00011950: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-00011960: 6461 7469 6f6e 735b 6474 732e 6b65 795d  dations[dts.key]
-00011970: 203d 2022 7761 6974 696e 6722 0a20 2020   = "waiting".   
-00011980: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00011990: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000119a0: 7473 2e77 6169 7465 7273 2e61 6464 2874  ts.waiters.add(t
-000119b0: 7329 0a0a 2020 2020 2020 2020 7473 2e77  s)..        ts.w
-000119c0: 6169 7465 7273 203d 207b 6474 7320 666f  aiters = {dts fo
-000119d0: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
-000119e0: 6e64 656e 7473 2069 6620 6474 732e 7374  ndents if dts.st
-000119f0: 6174 6520 3d3d 2022 7761 6974 696e 6722  ate == "waiting"
-00011a00: 7d0a 0a20 2020 2020 2020 2069 6620 6e6f  }..        if no
-00011a10: 7420 7473 2e77 6169 7469 6e67 5f6f 6e3a  t ts.waiting_on:
-00011a20: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
-00011a30: 4f54 453a 2077 6169 7469 6e67 2d3e 7072  OTE: waiting->pr
-00011a40: 6f63 6573 7369 6e67 2077 696c 6c20 7365  ocessing will se
-00011a50: 6e64 2074 6173 6b73 2074 6f20 7175 6575  nd tasks to queu
-00011a60: 6564 206f 7220 6e6f 2d77 6f72 6b65 7220  ed or no-worker 
-00011a70: 6173 0a20 2020 2020 2020 2020 2020 2023  as.            #
-00011a80: 206e 6563 6573 7361 7279 0a20 2020 2020   necessary.     
-00011a90: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
-00011aa0: 6174 696f 6e73 5b6b 6579 5d20 3d20 2270  ations[key] = "p
-00011ab0: 726f 6365 7373 696e 6722 0a0a 2020 2020  rocessing"..    
-00011ac0: 2020 2020 7265 7475 726e 2072 6563 6f6d      return recom
-00011ad0: 6d65 6e64 6174 696f 6e73 2c20 7b7d 2c20  mendations, {}, 
-00011ae0: 7b7d 0a0a 2020 2020 6465 6620 7472 616e  {}..    def tran
-00011af0: 7369 7469 6f6e 5f6e 6f5f 776f 726b 6572  sition_no_worker
-00011b00: 5f70 726f 6365 7373 696e 6728 7365 6c66  _processing(self
-00011b10: 2c20 6b65 793a 2073 7472 2c20 7374 696d  , key: str, stim
-00011b20: 756c 7573 5f69 643a 2073 7472 2920 2d3e  ulus_id: str) ->
-00011b30: 2052 6563 734d 7367 733a 0a20 2020 2020   RecsMsgs:.     
-00011b40: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
-00011b50: 6b73 5b6b 6579 5d0a 2020 2020 2020 2020  ks[key].        
-00011b60: 776f 726b 6572 5f6d 7367 733a 204d 7367  worker_msgs: Msg
-00011b70: 7320 3d20 7b7d 0a0a 2020 2020 2020 2020  s = {}..        
-00011b80: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
-00011b90: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-00011ba0: 7365 7274 206e 6f74 2074 732e 6163 746f  sert not ts.acto
-00011bb0: 722c 2066 2241 6374 6f72 7320 6361 6e27  r, f"Actors can'
-00011bc0: 7420 6265 2069 6e20 606e 6f2d 776f 726b  t be in `no-work
-00011bd0: 6572 603a 207b 7473 7d22 0a20 2020 2020  er`: {ts}".     
-00011be0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-00011bf0: 2069 6e20 7365 6c66 2e75 6e72 756e 6e61   in self.unrunna
-00011c00: 626c 650a 0a20 2020 2020 2020 2069 6620  ble..        if 
-00011c10: 7773 203a 3d20 7365 6c66 2e64 6563 6964  ws := self.decid
-00011c20: 655f 776f 726b 6572 5f6e 6f6e 5f72 6f6f  e_worker_non_roo
-00011c30: 7469 7368 2874 7329 3a0a 2020 2020 2020  tish(ts):.      
-00011c40: 2020 2020 2020 7365 6c66 2e75 6e72 756e        self.unrun
-00011c50: 6e61 626c 652e 6469 7363 6172 6428 7473  nable.discard(ts
-00011c60: 290a 2020 2020 2020 2020 2020 2020 776f  ).            wo
-00011c70: 726b 6572 5f6d 7367 7320 3d20 7365 6c66  rker_msgs = self
-00011c80: 2e5f 6164 645f 746f 5f70 726f 6365 7373  ._add_to_process
-00011c90: 696e 6728 7473 2c20 7773 290a 2020 2020  ing(ts, ws).    
-00011ca0: 2020 2020 2320 4966 206e 6f20 776f 726b      # If no work
-00011cb0: 6572 2c20 7461 736b 206a 7573 7420 7374  er, task just st
-00011cc0: 6179 7320 696e 2060 6e6f 2d77 6f72 6b65  ays in `no-worke
-00011cd0: 7260 0a0a 2020 2020 2020 2020 7265 7475  r`..        retu
-00011ce0: 726e 207b 7d2c 207b 7d2c 2077 6f72 6b65  rn {}, {}, worke
-00011cf0: 725f 6d73 6773 0a0a 2020 2020 6465 6620  r_msgs..    def 
-00011d00: 6465 6369 6465 5f77 6f72 6b65 725f 726f  decide_worker_ro
-00011d10: 6f74 6973 685f 7175 6575 696e 675f 6469  otish_queuing_di
-00011d20: 7361 626c 6564 280a 2020 2020 2020 2020  sabled(.        
-00011d30: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
-00011d40: 6174 650a 2020 2020 2920 2d3e 2057 6f72  ate.    ) -> Wor
-00011d50: 6b65 7253 7461 7465 207c 204e 6f6e 653a  kerState | None:
-00011d60: 0a20 2020 2020 2020 2022 2222 5069 636b  .        """Pick
-00011d70: 2061 2077 6f72 6b65 7220 666f 7220 6120   a worker for a 
-00011d80: 7275 6e6e 6162 6c65 2072 6f6f 742d 6973  runnable root-is
-00011d90: 6820 7461 736b 2c20 7769 7468 6f75 7420  h task, without 
-00011da0: 7175 6575 696e 672e 0a0a 2020 2020 2020  queuing...      
-00011db0: 2020 5468 6973 2061 7474 656d 7074 7320    This attempts 
-00011dc0: 746f 2073 6368 6564 756c 6520 7369 626c  to schedule sibl
-00011dd0: 696e 6720 7461 736b 7320 6f6e 2074 6865  ing tasks on the
-00011de0: 2073 616d 6520 776f 726b 6572 2c20 7265   same worker, re
-00011df0: 6475 6369 6e67 2066 7574 7572 6520 6461  ducing future da
-00011e00: 7461 0a20 2020 2020 2020 2074 7261 6e73  ta.        trans
-00011e10: 6665 722e 2049 7420 646f 6573 206e 6f74  fer. It does not
-00011e20: 2063 6f6e 7369 6465 7220 7468 6520 6c6f   consider the lo
-00011e30: 6361 7469 6f6e 206f 6620 6465 7065 6e64  cation of depend
-00011e40: 656e 6369 6573 2c20 7369 6e63 6520 7468  encies, since th
-00011e50: 6579 276c 6c20 656e 640a 2020 2020 2020  ey'll end.      
-00011e60: 2020 7570 206f 6e20 6576 6572 7920 776f    up on every wo
-00011e70: 726b 6572 2061 6e79 7761 792e 0a0a 2020  rker anyway...  
-00011e80: 2020 2020 2020 4974 2061 7373 756d 6573        It assumes
-00011e90: 2069 7427 7320 6265 696e 6720 6361 6c6c   it's being call
-00011ea0: 6564 206f 6e20 6120 6261 7463 6820 6f66  ed on a batch of
-00011eb0: 2074 6173 6b73 2069 6e20 7072 696f 7269   tasks in priori
-00011ec0: 7479 206f 7264 6572 2c20 616e 640a 2020  ty order, and.  
-00011ed0: 2020 2020 2020 6d61 696e 7461 696e 7320        maintains 
-00011ee0: 7374 6174 6520 696e 2060 5363 6865 6475  state in `Schedu
-00011ef0: 6c65 7253 7461 7465 2e6c 6173 745f 726f  lerState.last_ro
-00011f00: 6f74 5f77 6f72 6b65 7260 2061 6e64 0a20  ot_worker` and. 
-00011f10: 2020 2020 2020 2060 5363 6865 6475 6c65         `Schedule
-00011f20: 7253 7461 7465 2e6c 6173 745f 726f 6f74  rState.last_root
-00011f30: 5f77 6f72 6b65 725f 7461 736b 735f 6c65  _worker_tasks_le
-00011f40: 6674 6020 746f 2061 6368 6965 7665 2074  ft` to achieve t
-00011f50: 6869 732e 0a0a 2020 2020 2020 2020 5468  his...        Th
-00011f60: 6973 2077 696c 6c20 7365 6e64 2065 7665  is will send eve
-00011f70: 7279 2072 756e 6e61 626c 6520 7461 736b  ry runnable task
-00011f80: 2074 6f20 6120 776f 726b 6572 2c20 6f66   to a worker, of
-00011f90: 7465 6e20 6361 7573 696e 6720 726f 6f74  ten causing root
-00011fa0: 2074 6173 6b0a 2020 2020 2020 2020 6f76   task.        ov
-00011fb0: 6572 7072 6f64 7563 7469 6f6e 2e0a 0a20  erproduction... 
-00011fc0: 2020 2020 2020 2052 6574 7572 6e73 0a20         Returns. 
-00011fd0: 2020 2020 2020 202d 2d2d 2d2d 2d2d 0a20         -------. 
-00011fe0: 2020 2020 2020 2077 733a 2057 6f72 6b65         ws: Worke
-00011ff0: 7253 7461 7465 207c 204e 6f6e 650a 2020  rState | None.  
-00012000: 2020 2020 2020 2020 2020 5468 6520 776f            The wo
-00012010: 726b 6572 2074 6f20 6173 7369 676e 2074  rker to assign t
-00012020: 6865 2074 6173 6b20 746f 2e20 4966 2074  he task to. If t
-00012030: 6865 7265 2061 7265 206e 6f20 776f 726b  here are no work
-00012040: 6572 7320 696e 2074 6865 2063 6c75 7374  ers in the clust
-00012050: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
-00012060: 7265 7475 726e 7320 4e6f 6e65 2c20 696e  returns None, in
-00012070: 2077 6869 6368 2063 6173 6520 7468 6520   which case the 
-00012080: 7461 736b 2073 686f 756c 6420 6265 2074  task should be t
-00012090: 7261 6e73 6974 696f 6e65 6420 746f 0a20  ransitioned to. 
-000120a0: 2020 2020 2020 2020 2020 2060 606e 6f2d             ``no-
-000120b0: 776f 726b 6572 6060 2e0a 2020 2020 2020  worker``..      
-000120c0: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
-000120d0: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
-000120e0: 2020 2020 2020 2020 2020 2020 2320 5365              # Se
-000120f0: 6520 726f 6f74 2d69 7368 2d6e 6573 7320  e root-ish-ness 
-00012100: 6e6f 7465 2062 656c 6f77 2069 6e20 6064  note below in `d
-00012110: 6563 6964 655f 776f 726b 6572 5f72 6f6f  ecide_worker_roo
-00012120: 7469 7368 5f71 7565 7569 6e67 5f65 6e61  tish_queuing_ena
-00012130: 626c 6564 600a 2020 2020 2020 2020 2020  bled`.          
-00012140: 2020 6173 7365 7274 206d 6174 682e 6973    assert math.is
-00012150: 696e 6628 7365 6c66 2e57 4f52 4b45 525f  inf(self.WORKER_
-00012160: 5341 5455 5241 5449 4f4e 290a 0a20 2020  SATURATION)..   
-00012170: 2020 2020 2070 6f6f 6c20 3d20 7365 6c66       pool = self
-00012180: 2e69 646c 652e 7661 6c75 6573 2829 2069  .idle.values() i
-00012190: 6620 7365 6c66 2e69 646c 6520 656c 7365  f self.idle else
-000121a0: 2073 656c 662e 7275 6e6e 696e 670a 2020   self.running.  
-000121b0: 2020 2020 2020 6966 206e 6f74 2070 6f6f        if not poo
-000121c0: 6c3a 0a20 2020 2020 2020 2020 2020 2072  l:.            r
-000121d0: 6574 7572 6e20 4e6f 6e65 0a0a 2020 2020  eturn None..    
-000121e0: 2020 2020 7467 203d 2074 732e 6772 6f75      tg = ts.grou
-000121f0: 700a 2020 2020 2020 2020 6c77 7320 3d20  p.        lws = 
-00012200: 7467 2e6c 6173 745f 776f 726b 6572 0a20  tg.last_worker. 
-00012210: 2020 2020 2020 2069 6620 280a 2020 2020         if (.    
-00012220: 2020 2020 2020 2020 6c77 730a 2020 2020          lws.    
-00012230: 2020 2020 2020 2020 616e 6420 7467 2e6c          and tg.l
-00012240: 6173 745f 776f 726b 6572 5f74 6173 6b73  ast_worker_tasks
-00012250: 5f6c 6566 740a 2020 2020 2020 2020 2020  _left.          
-00012260: 2020 616e 6420 6c77 732e 7374 6174 7573    and lws.status
-00012270: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
-00012280: 6e67 0a20 2020 2020 2020 2020 2020 2061  ng.            a
-00012290: 6e64 2073 656c 662e 776f 726b 6572 732e  nd self.workers.
-000122a0: 6765 7428 6c77 732e 6164 6472 6573 7329  get(lws.address)
-000122b0: 2069 7320 6c77 730a 2020 2020 2020 2020   is lws.        
-000122c0: 293a 0a20 2020 2020 2020 2020 2020 2077  ):.            w
-000122d0: 7320 3d20 6c77 730a 2020 2020 2020 2020  s = lws.        
-000122e0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000122f0: 2020 2320 4c61 7374 2d75 7365 6420 776f    # Last-used wo
-00012300: 726b 6572 2069 7320 6675 6c6c 2c20 756e  rker is full, un
-00012310: 6b6e 6f77 6e2c 2072 6574 6972 696e 672c  known, retiring,
-00012320: 206f 7220 7061 7573 6564 3b0a 2020 2020   or paused;.    
-00012330: 2020 2020 2020 2020 2320 7069 636b 2061          # pick a
-00012340: 206e 6577 2077 6f72 6b65 7220 666f 7220   new worker for 
-00012350: 7468 6520 6e65 7874 2066 6577 2074 6173  the next few tas
-00012360: 6b73 0a20 2020 2020 2020 2020 2020 2077  ks.            w
-00012370: 7320 3d20 6d69 6e28 706f 6f6c 2c20 6b65  s = min(pool, ke
-00012380: 793d 7061 7274 6961 6c28 7365 6c66 2e77  y=partial(self.w
-00012390: 6f72 6b65 725f 6f62 6a65 6374 6976 652c  orker_objective,
-000123a0: 2074 7329 290a 2020 2020 2020 2020 2020   ts)).          
-000123b0: 2020 7467 2e6c 6173 745f 776f 726b 6572    tg.last_worker
-000123c0: 5f74 6173 6b73 5f6c 6566 7420 3d20 6d61  _tasks_left = ma
-000123d0: 7468 2e66 6c6f 6f72 280a 2020 2020 2020  th.floor(.      
-000123e0: 2020 2020 2020 2020 2020 286c 656e 2874            (len(t
-000123f0: 6729 202f 2073 656c 662e 746f 7461 6c5f  g) / self.total_
-00012400: 6e74 6872 6561 6473 2920 2a20 7773 2e6e  nthreads) * ws.n
-00012410: 7468 7265 6164 730a 2020 2020 2020 2020  threads.        
-00012420: 2020 2020 290a 0a20 2020 2020 2020 2023      )..        #
-00012430: 2052 6563 6f72 6420 606c 6173 745f 776f   Record `last_wo
-00012440: 726b 6572 602c 206f 7220 636c 6561 7220  rker`, or clear 
-00012450: 6974 206f 6e20 7468 6520 6669 6e61 6c20  it on the final 
-00012460: 7461 736b 0a20 2020 2020 2020 2074 672e  task.        tg.
-00012470: 6c61 7374 5f77 6f72 6b65 7220 3d20 280a  last_worker = (.
-00012480: 2020 2020 2020 2020 2020 2020 7773 2069              ws i
-00012490: 6620 7467 2e73 7461 7465 735b 2272 656c  f tg.states["rel
-000124a0: 6561 7365 6422 5d20 2b20 7467 2e73 7461  eased"] + tg.sta
-000124b0: 7465 735b 2277 6169 7469 6e67 225d 203e  tes["waiting"] >
-000124c0: 2031 2065 6c73 6520 4e6f 6e65 0a20 2020   1 else None.   
-000124d0: 2020 2020 2029 0a20 2020 2020 2020 2074       ).        t
-000124e0: 672e 6c61 7374 5f77 6f72 6b65 725f 7461  g.last_worker_ta
-000124f0: 736b 735f 6c65 6674 202d 3d20 310a 0a20  sks_left -= 1.. 
-00012500: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
-00012510: 616c 6964 6174 6520 616e 6420 7773 2069  alidate and ws i
-00012520: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00012530: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
-00012540: 656c 662e 776f 726b 6572 732e 6765 7428  elf.workers.get(
-00012550: 7773 2e61 6464 7265 7373 2920 6973 2077  ws.address) is w
-00012560: 730a 2020 2020 2020 2020 2020 2020 6173  s.            as
-00012570: 7365 7274 2077 7320 696e 2073 656c 662e  sert ws in self.
-00012580: 7275 6e6e 696e 672c 2028 7773 2c20 7365  running, (ws, se
-00012590: 6c66 2e72 756e 6e69 6e67 290a 0a20 2020  lf.running)..   
-000125a0: 2020 2020 2072 6574 7572 6e20 7773 0a0a       return ws..
-000125b0: 2020 2020 6465 6620 6465 6369 6465 5f77      def decide_w
-000125c0: 6f72 6b65 725f 726f 6f74 6973 685f 7175  orker_rootish_qu
-000125d0: 6575 696e 675f 656e 6162 6c65 6428 7365  euing_enabled(se
-000125e0: 6c66 2920 2d3e 2057 6f72 6b65 7253 7461  lf) -> WorkerSta
-000125f0: 7465 207c 204e 6f6e 653a 0a20 2020 2020  te | None:.     
-00012600: 2020 2022 2222 5069 636b 2061 2077 6f72     """Pick a wor
-00012610: 6b65 7220 666f 7220 6120 7275 6e6e 6162  ker for a runnab
-00012620: 6c65 2072 6f6f 742d 6973 6820 7461 736b  le root-ish task
-00012630: 2c20 6966 206e 6f74 2061 6c6c 2061 7265  , if not all are
-00012640: 2062 7573 792e 0a0a 2020 2020 2020 2020   busy...        
-00012650: 5069 636b 7320 7468 6520 6c65 6173 742d  Picks the least-
-00012660: 6275 7379 2077 6f72 6b65 7220 6f75 7420  busy worker out 
-00012670: 6f66 2074 6865 2060 6069 646c 6560 6020  of the ``idle`` 
-00012680: 776f 726b 6572 7320 2869 646c 6520 776f  workers (idle wo
-00012690: 726b 6572 7320 6861 7665 2066 6577 6572  rkers have fewer
-000126a0: 0a20 2020 2020 2020 2074 6173 6b73 2072  .        tasks r
-000126b0: 756e 6e69 6e67 2074 6861 6e20 7468 7265  unning than thre
-000126c0: 6164 732c 2061 7320 7365 7420 6279 2060  ads, as set by `
-000126d0: 6064 6973 7472 6962 7574 6564 2e73 6368  `distributed.sch
-000126e0: 6564 756c 6572 2e77 6f72 6b65 722d 7361  eduler.worker-sa
-000126f0: 7475 7261 7469 6f6e 6060 292e 0a20 2020  turation``)..   
-00012700: 2020 2020 2049 7420 646f 6573 206e 6f74       It does not
-00012710: 2063 6f6e 7369 6465 7220 7468 6520 6c6f   consider the lo
-00012720: 6361 7469 6f6e 206f 6620 6465 7065 6e64  cation of depend
-00012730: 656e 6369 6573 2c20 7369 6e63 6520 7468  encies, since th
-00012740: 6579 276c 6c20 656e 6420 7570 206f 6e20  ey'll end up on 
-00012750: 6576 6572 790a 2020 2020 2020 2020 776f  every.        wo
-00012760: 726b 6572 2061 6e79 7761 792e 0a0a 2020  rker anyway...  
-00012770: 2020 2020 2020 4966 2061 6c6c 2077 6f72        If all wor
-00012780: 6b65 7273 2061 7265 2066 756c 6c2c 2072  kers are full, r
-00012790: 6574 7572 6e73 204e 6f6e 652c 206d 6561  eturns None, mea
-000127a0: 6e69 6e67 2074 6865 2074 6173 6b20 7368  ning the task sh
-000127b0: 6f75 6c64 2074 7261 6e73 6974 696f 6e20  ould transition 
-000127c0: 746f 0a20 2020 2020 2020 2060 6071 7565  to.        ``que
-000127d0: 7565 6460 602e 2054 6865 2073 6368 6564  ued``. The sched
-000127e0: 756c 6572 2077 696c 6c20 7761 6974 2074  uler will wait t
-000127f0: 6f20 7365 6e64 2069 7420 746f 2061 2077  o send it to a w
-00012800: 6f72 6b65 7220 756e 7469 6c20 6120 7468  orker until a th
-00012810: 7265 6164 206f 7065 6e73 0a20 2020 2020  read opens.     
-00012820: 2020 2075 702e 2054 6869 7320 656e 7375     up. This ensu
-00012830: 7265 7320 7468 6174 2064 6f77 6e73 7472  res that downstr
-00012840: 6561 6d20 7461 736b 7320 616c 7761 7973  eam tasks always
-00012850: 2072 756e 2062 6566 6f72 6520 6e65 7720   run before new 
-00012860: 726f 6f74 2074 6173 6b73 2061 7265 0a20  root tasks are. 
-00012870: 2020 2020 2020 2073 7461 7274 6564 2e0a         started..
-00012880: 0a20 2020 2020 2020 2054 6869 7320 646f  .        This do
-00012890: 6573 206e 6f74 2074 7279 2074 6f20 7363  es not try to sc
-000128a0: 6865 6475 6c65 2073 6962 6c69 6e67 2074  hedule sibling t
-000128b0: 6173 6b73 206f 6e20 7468 6520 7361 6d65  asks on the same
-000128c0: 2077 6f72 6b65 723b 2069 6e20 6661 6374   worker; in fact
-000128d0: 2c20 6974 0a20 2020 2020 2020 2075 7375  , it.        usu
-000128e0: 616c 6c79 2064 6f65 7320 7468 6520 6f70  ally does the op
-000128f0: 706f 7369 7465 2e20 4576 656e 2074 686f  posite. Even tho
-00012900: 7567 6820 7468 6973 2069 6e63 7265 6173  ugh this increas
-00012910: 6573 2073 7562 7365 7175 656e 7420 6461  es subsequent da
-00012920: 7461 2074 7261 6e73 6665 722c 0a20 2020  ta transfer,.   
-00012930: 2020 2020 2069 7420 7479 7069 6361 6c6c       it typicall
-00012940: 7920 7265 6475 6365 7320 6f76 6572 616c  y reduces overal
-00012950: 6c20 6d65 6d6f 7279 2075 7365 2062 7920  l memory use by 
-00012960: 656c 696d 696e 6174 696e 6720 726f 6f74  eliminating root
-00012970: 2074 6173 6b20 6f76 6572 7072 6f64 7563   task overproduc
-00012980: 7469 6f6e 2e0a 0a20 2020 2020 2020 2052  tion...        R
-00012990: 6574 7572 6e73 0a20 2020 2020 2020 202d  eturns.        -
-000129a0: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2077  ------.        w
-000129b0: 733a 2057 6f72 6b65 7253 7461 7465 207c  s: WorkerState |
-000129c0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-000129d0: 2020 5468 6520 776f 726b 6572 2074 6f20    The worker to 
-000129e0: 6173 7369 676e 2074 6865 2074 6173 6b20  assign the task 
-000129f0: 746f 2e20 4966 2074 6865 7265 2061 7265  to. If there are
-00012a00: 206e 6f20 6964 6c65 2077 6f72 6b65 7273   no idle workers
-00012a10: 2c20 7265 7475 726e 730a 2020 2020 2020  , returns.      
-00012a20: 2020 2020 2020 4e6f 6e65 2c20 696e 2077        None, in w
-00012a30: 6869 6368 2063 6173 6520 7468 6520 7461  hich case the ta
-00012a40: 736b 2073 686f 756c 6420 6265 2074 7261  sk should be tra
-00012a50: 6e73 6974 696f 6e65 6420 746f 2060 6071  nsitioned to ``q
-00012a60: 7565 7565 6460 602e 0a0a 2020 2020 2020  ueued``...      
-00012a70: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
-00012a80: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
-00012a90: 2020 2020 2020 2020 2020 2020 2320 5765              # We
-00012aa0: 2064 6f6e 2774 2060 6173 7365 7274 2073   don't `assert s
-00012ab0: 656c 662e 6973 5f72 6f6f 7469 7368 2874  elf.is_rootish(t
-00012ac0: 7329 6020 6865 7265 2c20 6265 6361 7573  s)` here, becaus
-00012ad0: 6520 7468 6174 2063 6865 636b 2069 730a  e that check is.
-00012ae0: 2020 2020 2020 2020 2020 2020 2320 6465              # de
-00012af0: 7065 6e64 656e 7420 6f6e 2063 6c75 7374  pendent on clust
-00012b00: 6572 2073 697a 652e 2049 7427 7320 706f  er size. It's po
-00012b10: 7373 6962 6c65 2061 2074 6173 6b20 6c6f  ssible a task lo
-00012b20: 6f6b 6564 2072 6f6f 742d 6973 6820 7768  oked root-ish wh
-00012b30: 656e 2069 740a 2020 2020 2020 2020 2020  en it.          
-00012b40: 2020 2320 7761 7320 7175 6575 6564 2c20    # was queued, 
-00012b50: 6275 7420 7468 6520 636c 7573 7465 7220  but the cluster 
-00012b60: 6861 7320 7369 6e63 6520 7363 616c 6564  has since scaled
-00012b70: 2075 7020 616e 6420 6974 206e 6f20 6c6f   up and it no lo
-00012b80: 6e67 6572 2064 6f65 7320 7768 656e 0a20  nger does when. 
-00012b90: 2020 2020 2020 2020 2020 2023 2063 6f6d             # com
-00012ba0: 696e 6720 6f75 7420 6f66 2074 6865 2071  ing out of the q
-00012bb0: 7565 7565 2e20 4966 2060 6973 5f72 6f6f  ueue. If `is_roo
-00012bc0: 7469 7368 6020 6368 616e 6765 7320 746f  tish` changes to
-00012bd0: 2061 2073 7461 7469 6320 6465 6669 6e69   a static defini
-00012be0: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
-00012bf0: 2020 2320 7468 656e 2061 6464 2074 6861    # then add tha
-00012c00: 7420 6173 7365 7274 696f 6e20 6865 7265  t assertion here
-00012c10: 2028 616e 6420 6163 7475 616c 6c79 2070   (and actually p
-00012c20: 6173 7320 696e 2074 6865 2074 6173 6b29  ass in the task)
-00012c30: 2e0a 2020 2020 2020 2020 2020 2020 6173  ..            as
-00012c40: 7365 7274 206e 6f74 206d 6174 682e 6973  sert not math.is
-00012c50: 696e 6628 7365 6c66 2e57 4f52 4b45 525f  inf(self.WORKER_
-00012c60: 5341 5455 5241 5449 4f4e 290a 0a20 2020  SATURATION)..   
-00012c70: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
-00012c80: 2e69 646c 655f 7461 736b 5f63 6f75 6e74  .idle_task_count
-00012c90: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00012ca0: 416c 6c20 776f 726b 6572 7320 6275 7379  All workers busy
-00012cb0: 3f20 5461 736b 2067 6574 732f 7374 6179  ? Task gets/stay
-00012cc0: 7320 7175 6575 6564 2e0a 2020 2020 2020  s queued..      
-00012cd0: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-00012ce0: 650a 0a20 2020 2020 2020 2023 204a 7573  e..        # Jus
-00012cf0: 7420 7069 636b 2074 6865 206c 6561 7374  t pick the least
-00012d00: 2062 7573 7920 776f 726b 6572 2e0a 2020   busy worker..  
-00012d10: 2020 2020 2020 2320 4e4f 5445 3a20 7468        # NOTE: th
-00012d20: 6973 2077 696c 6c20 6c65 6164 2074 6f20  is will lead to 
-00012d30: 776f 7273 742d 6361 7365 2073 6368 6564  worst-case sched
-00012d40: 756c 696e 6720 7769 7468 2072 6567 6172  uling with regar
-00012d50: 6473 2074 6f20 636f 2d61 7373 6967 6e6d  ds to co-assignm
-00012d60: 656e 742e 0a20 2020 2020 2020 2077 7320  ent..        ws 
-00012d70: 3d20 6d69 6e28 0a20 2020 2020 2020 2020  = min(.         
-00012d80: 2020 2073 656c 662e 6964 6c65 5f74 6173     self.idle_tas
-00012d90: 6b5f 636f 756e 742c 0a20 2020 2020 2020  k_count,.       
-00012da0: 2020 2020 206b 6579 3d6c 616d 6264 6120       key=lambda 
-00012db0: 7773 3a20 6c65 6e28 7773 2e70 726f 6365  ws: len(ws.proce
-00012dc0: 7373 696e 6729 202f 2077 732e 6e74 6872  ssing) / ws.nthr
-00012dd0: 6561 6473 2c0a 2020 2020 2020 2020 290a  eads,.        ).
-00012de0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00012df0: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
-00012e00: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-00012e10: 205f 776f 726b 6572 5f66 756c 6c28 7773   _worker_full(ws
-00012e20: 2c20 7365 6c66 2e57 4f52 4b45 525f 5341  , self.WORKER_SA
-00012e30: 5455 5241 5449 4f4e 292c 2028 0a20 2020  TURATION), (.   
-00012e40: 2020 2020 2020 2020 2020 2020 2077 732c               ws,
-00012e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012e60: 205f 7461 736b 5f73 6c6f 7473 5f61 7661   _task_slots_ava
-00012e70: 696c 6162 6c65 2877 732c 2073 656c 662e  ilable(ws, self.
-00012e80: 574f 524b 4552 5f53 4154 5552 4154 494f  WORKER_SATURATIO
-00012e90: 4e29 2c0a 2020 2020 2020 2020 2020 2020  N),.            
-00012ea0: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
-00012eb0: 7365 7274 2077 7320 696e 2073 656c 662e  sert ws in self.
-00012ec0: 7275 6e6e 696e 672c 2028 7773 2c20 7365  running, (ws, se
-00012ed0: 6c66 2e72 756e 6e69 6e67 290a 0a20 2020  lf.running)..   
-00012ee0: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
-00012ef0: 6964 6174 6520 616e 6420 7773 2069 7320  idate and ws is 
-00012f00: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00012f10: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
-00012f20: 662e 776f 726b 6572 732e 6765 7428 7773  f.workers.get(ws
-00012f30: 2e61 6464 7265 7373 2920 6973 2077 730a  .address) is ws.
-00012f40: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00012f50: 7274 2077 7320 696e 2073 656c 662e 7275  rt ws in self.ru
-00012f60: 6e6e 696e 672c 2028 7773 2c20 7365 6c66  nning, (ws, self
-00012f70: 2e72 756e 6e69 6e67 290a 0a20 2020 2020  .running)..     
-00012f80: 2020 2072 6574 7572 6e20 7773 0a0a 2020     return ws..  
-00012f90: 2020 6465 6620 6465 6369 6465 5f77 6f72    def decide_wor
-00012fa0: 6b65 725f 6e6f 6e5f 726f 6f74 6973 6828  ker_non_rootish(
-00012fb0: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
-00012fc0: 6174 6529 202d 3e20 576f 726b 6572 5374  ate) -> WorkerSt
-00012fd0: 6174 6520 7c20 4e6f 6e65 3a0a 2020 2020  ate | None:.    
-00012fe0: 2020 2020 2222 2250 6963 6b20 6120 776f      """Pick a wo
-00012ff0: 726b 6572 2066 6f72 2061 2072 756e 6e61  rker for a runna
-00013000: 626c 6520 6e6f 6e2d 726f 6f74 2074 6173  ble non-root tas
-00013010: 6b2c 2063 6f6e 7369 6465 7269 6e67 2064  k, considering d
-00013020: 6570 656e 6465 6e63 6965 7320 616e 640a  ependencies and.
-00013030: 2020 2020 2020 2020 7265 7374 7269 6374          restrict
-00013040: 696f 6e73 2e0a 0a20 2020 2020 2020 204f  ions...        O
-00013050: 7574 206f 6620 656c 6967 6962 6c65 2077  ut of eligible w
-00013060: 6f72 6b65 7273 2068 6f6c 6469 6e67 2064  orkers holding d
-00013070: 6570 656e 6465 6e63 6965 7320 6f66 2060  ependencies of `
-00013080: 6074 7360 602c 2073 656c 6563 7473 2074  `ts``, selects t
-00013090: 6865 2077 6f72 6b65 720a 2020 2020 2020  he worker.      
-000130a0: 2020 7768 6572 652c 2063 6f6e 7369 6465    where, conside
-000130b0: 7269 6e67 2077 6f72 6b65 7220 6261 636b  ring worker back
-000130c0: 6c6f 6e67 2061 6e64 2064 6174 612d 7472  long and data-tr
-000130d0: 616e 7366 6572 2063 6f73 7473 2c20 7468  ansfer costs, th
-000130e0: 6520 7461 736b 2069 730a 2020 2020 2020  e task is.      
-000130f0: 2020 6573 7469 6d61 7465 6420 746f 2073    estimated to s
-00013100: 7461 7274 2072 756e 6e69 6e67 2074 6865  tart running the
-00013110: 2073 6f6f 6e65 7374 2e0a 0a20 2020 2020   soonest...     
-00013120: 2020 2052 6574 7572 6e73 0a20 2020 2020     Returns.     
-00013130: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2020     -------.     
-00013140: 2020 2077 733a 2057 6f72 6b65 7253 7461     ws: WorkerSta
-00013150: 7465 207c 204e 6f6e 650a 2020 2020 2020  te | None.      
-00013160: 2020 2020 2020 5468 6520 776f 726b 6572        The worker
-00013170: 2074 6f20 6173 7369 676e 2074 6865 2074   to assign the t
-00013180: 6173 6b20 746f 2e20 4966 206e 6f20 776f  ask to. If no wo
-00013190: 726b 6572 7320 7361 7469 7366 7920 7468  rkers satisfy th
-000131a0: 6520 7265 7374 7269 6374 696f 6e73 206f  e restrictions o
-000131b0: 660a 2020 2020 2020 2020 2020 2020 6060  f.            ``
-000131c0: 7473 6060 206f 7220 7468 6572 6520 6172  ts`` or there ar
-000131d0: 6520 6e6f 2072 756e 6e69 6e67 2077 6f72  e no running wor
-000131e0: 6b65 7273 2c20 7265 7475 726e 7320 4e6f  kers, returns No
-000131f0: 6e65 2c20 696e 2077 6869 6368 2063 6173  ne, in which cas
-00013200: 6520 7468 6520 7461 736b 0a20 2020 2020  e the task.     
-00013210: 2020 2020 2020 2073 686f 756c 6420 6265         should be
-00013220: 2074 7261 6e73 6974 696f 6e65 6420 746f   transitioned to
-00013230: 2060 606e 6f2d 776f 726b 6572 6060 2e0a   ``no-worker``..
-00013240: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00013250: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
-00013260: 7275 6e6e 696e 673a 0a20 2020 2020 2020  running:.       
-00013270: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
-00013280: 0a0a 2020 2020 2020 2020 7661 6c69 645f  ..        valid_
-00013290: 776f 726b 6572 7320 3d20 7365 6c66 2e76  workers = self.v
-000132a0: 616c 6964 5f77 6f72 6b65 7273 2874 7329  alid_workers(ts)
-000132b0: 0a20 2020 2020 2020 2069 6620 7661 6c69  .        if vali
-000132c0: 645f 776f 726b 6572 7320 6973 204e 6f6e  d_workers is Non
-000132d0: 6520 616e 6420 6c65 6e28 7365 6c66 2e72  e and len(self.r
-000132e0: 756e 6e69 6e67 2920 3c20 6c65 6e28 7365  unning) < len(se
-000132f0: 6c66 2e77 6f72 6b65 7273 293a 0a20 2020  lf.workers):.   
-00013300: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-00013310: 7365 6c66 2e72 756e 6e69 6e67 3a0a 2020  self.running:.  
-00013320: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00013330: 7475 726e 204e 6f6e 650a 0a20 2020 2020  turn None..     
-00013340: 2020 2020 2020 2023 2049 6620 7468 6572         # If ther
-00013350: 6520 7765 7265 206e 6f20 7265 7374 7269  e were no restri
-00013360: 6374 696f 6e73 2c20 6076 616c 6964 5f77  ctions, `valid_w
-00013370: 6f72 6b65 7273 2829 6020 6469 646e 2774  orkers()` didn't
-00013380: 2073 7562 7365 7420 6279 0a20 2020 2020   subset by.     
-00013390: 2020 2020 2020 2023 2060 7275 6e6e 696e         # `runnin
-000133a0: 6760 2e0a 2020 2020 2020 2020 2020 2020  g`..            
-000133b0: 7661 6c69 645f 776f 726b 6572 7320 3d20  valid_workers = 
-000133c0: 7365 6c66 2e72 756e 6e69 6e67 0a0a 2020  self.running..  
-000133d0: 2020 2020 2020 6966 2074 732e 6465 7065        if ts.depe
-000133e0: 6e64 656e 6369 6573 206f 7220 7661 6c69  ndencies or vali
-000133f0: 645f 776f 726b 6572 7320 6973 206e 6f74  d_workers is not
-00013400: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00013410: 2020 2077 7320 3d20 6465 6369 6465 5f77     ws = decide_w
-00013420: 6f72 6b65 7228 0a20 2020 2020 2020 2020  orker(.         
-00013430: 2020 2020 2020 2074 732c 0a20 2020 2020         ts,.     
-00013440: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00013450: 7275 6e6e 696e 672c 0a20 2020 2020 2020  running,.       
-00013460: 2020 2020 2020 2020 2076 616c 6964 5f77           valid_w
-00013470: 6f72 6b65 7273 2c0a 2020 2020 2020 2020  orkers,.        
-00013480: 2020 2020 2020 2020 7061 7274 6961 6c28          partial(
-00013490: 7365 6c66 2e77 6f72 6b65 725f 6f62 6a65  self.worker_obje
-000134a0: 6374 6976 652c 2074 7329 2c0a 2020 2020  ctive, ts),.    
-000134b0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000134c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000134d0: 2020 2020 2320 544f 444f 2069 6620 6069      # TODO if `i
-000134e0: 735f 726f 6f74 6973 6860 2077 6f75 6c64  s_rootish` would
-000134f0: 2061 6c77 6179 7320 7265 7475 726e 2054   always return T
-00013500: 7275 6520 666f 7220 7461 736b 7320 7769  rue for tasks wi
-00013510: 7468 6f75 740a 2020 2020 2020 2020 2020  thout.          
-00013520: 2020 2320 6465 7065 6e64 656e 6369 6573    # dependencies
-00013530: 2c20 7765 2063 6f75 6c64 2072 656d 6f76  , we could remov
-00013540: 6520 616c 6c20 7468 6973 206c 6f67 6963  e all this logic
-00013550: 2e20 5468 6520 726f 6f74 6973 6820 6173  . The rootish as
-00013560: 7369 676e 6d65 6e74 206c 6f67 6963 0a20  signment logic. 
-00013570: 2020 2020 2020 2020 2020 2023 2077 6f75             # wou
-00013580: 6c64 2062 6568 6176 6520 6d6f 7265 206f  ld behave more o
-00013590: 7220 6c65 7373 2074 6865 2073 616d 6520  r less the same 
-000135a0: 6173 2074 6869 732c 206d 6179 6265 2077  as this, maybe w
-000135b0: 6974 686f 7574 2067 7561 7261 6e74 6565  ithout guarantee
-000135c0: 640a 2020 2020 2020 2020 2020 2020 2320  d.            # 
-000135d0: 726f 756e 642d 726f 6269 6e20 7468 6f75  round-robin thou
-000135e0: 6768 3f20 5468 6973 2070 6174 6820 6973  gh? This path is
-000135f0: 206f 6e6c 7920 7265 6163 6861 626c 6520   only reachable 
-00013600: 7768 656e 2060 7473 6020 646f 6573 6e27  when `ts` doesn'
-00013610: 7420 6861 7665 0a20 2020 2020 2020 2020  t have.         
-00013620: 2020 2023 2064 6570 656e 6465 6e63 6965     # dependencie
-00013630: 732c 2062 7574 2069 7473 2067 726f 7570  s, but its group
-00013640: 2069 7320 616c 736f 2073 6d61 6c6c 6572   is also smaller
-00013650: 2074 6861 6e20 7468 6520 636c 7573 7465   than the cluste
-00013660: 722e 0a0a 2020 2020 2020 2020 2020 2020  r...            
-00013670: 2320 4661 7374 7061 7468 2077 6865 6e20  # Fastpath when 
-00013680: 7468 6572 6520 6172 6520 6e6f 2072 656c  there are no rel
-00013690: 6174 6564 2074 6173 6b73 206f 7220 7265  ated tasks or re
-000136a0: 7374 7269 6374 696f 6e73 0a20 2020 2020  strictions.     
-000136b0: 2020 2020 2020 2077 6f72 6b65 725f 706f         worker_po
-000136c0: 6f6c 203d 2073 656c 662e 6964 6c65 206f  ol = self.idle o
-000136d0: 7220 7365 6c66 2e77 6f72 6b65 7273 0a20  r self.workers. 
-000136e0: 2020 2020 2020 2020 2020 2023 2046 4958             # FIX
-000136f0: 4d45 2069 646c 6520 616e 6420 776f 726b  ME idle and work
-00013700: 6572 7320 6172 6520 536f 7274 6564 4469  ers are SortedDi
-00013710: 6374 2773 2064 6563 6c61 7265 6420 6173  ct's declared as
-00013720: 2064 6963 7473 0a20 2020 2020 2020 2020   dicts.         
-00013730: 2020 2023 2020 2020 2020 2062 6563 6175     #       becau
-00013740: 7365 2073 6f72 7465 6463 6f6e 7461 696e  se sortedcontain
-00013750: 6572 7320 6973 206e 6f74 2061 6e6e 6f74  ers is not annot
-00013760: 6174 6564 0a20 2020 2020 2020 2020 2020  ated.           
-00013770: 2077 705f 7661 6c73 203d 2063 6173 7428   wp_vals = cast(
-00013780: 2253 6571 7565 6e63 655b 576f 726b 6572  "Sequence[Worker
-00013790: 5374 6174 655d 222c 2077 6f72 6b65 725f  State]", worker_
-000137a0: 706f 6f6c 2e76 616c 7565 7328 2929 0a20  pool.values()). 
-000137b0: 2020 2020 2020 2020 2020 206e 5f77 6f72             n_wor
-000137c0: 6b65 7273 203d 206c 656e 2877 705f 7661  kers = len(wp_va
-000137d0: 6c73 290a 2020 2020 2020 2020 2020 2020  ls).            
-000137e0: 6966 206e 5f77 6f72 6b65 7273 203c 2032  if n_workers < 2
-000137f0: 303a 2020 2320 736d 6172 7420 6275 7420  0:  # smart but 
-00013800: 6c69 6e65 6172 2069 6e20 736d 616c 6c20  linear in small 
-00013810: 6361 7365 0a20 2020 2020 2020 2020 2020  case.           
-00013820: 2020 2020 2077 7320 3d20 6d69 6e28 7770       ws = min(wp
-00013830: 5f76 616c 732c 206b 6579 3d6f 7065 7261  _vals, key=opera
-00013840: 746f 722e 6174 7472 6765 7474 6572 2822  tor.attrgetter("
-00013850: 6f63 6375 7061 6e63 7922 2929 0a20 2020  occupancy")).   
-00013860: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-00013870: 6572 7420 7773 0a20 2020 2020 2020 2020  ert ws.         
-00013880: 2020 2020 2020 2069 6620 7773 2e6f 6363         if ws.occ
-00013890: 7570 616e 6379 203d 3d20 303a 0a20 2020  upancy == 0:.   
-000138a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000138b0: 2023 2073 7065 6369 616c 2063 6173 6520   # special case 
-000138c0: 746f 2075 7365 2072 6f75 6e64 2d72 6f62  to use round-rob
-000138d0: 696e 3b20 6c69 6e65 6172 2073 6561 7263  in; linear searc
-000138e0: 680a 2020 2020 2020 2020 2020 2020 2020  h.              
-000138f0: 2020 2020 2020 2320 666f 7220 6e65 7874        # for next
-00013900: 2077 6f72 6b65 7220 7769 7468 207a 6572   worker with zer
-00013910: 6f20 6f63 6375 7061 6e63 7920 286f 7220  o occupancy (or 
-00013920: 6a75 7374 0a20 2020 2020 2020 2020 2020  just.           
-00013930: 2020 2020 2020 2020 2023 206c 616e 6420           # land 
-00013940: 6261 636b 2077 6865 7265 2077 6520 7374  back where we st
-00013950: 6172 7465 6429 2e0a 2020 2020 2020 2020  arted)..        
-00013960: 2020 2020 2020 2020 2020 2020 7374 6172              star
-00013970: 7420 3d20 7365 6c66 2e6e 5f74 6173 6b73  t = self.n_tasks
-00013980: 2025 206e 5f77 6f72 6b65 7273 0a20 2020   % n_workers.   
-00013990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000139a0: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-000139b0: 6e5f 776f 726b 6572 7329 3a0a 2020 2020  n_workers):.    
-000139c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000139d0: 2020 2020 7770 5f69 203d 2077 705f 7661      wp_i = wp_va
-000139e0: 6c73 5b28 6920 2b20 7374 6172 7429 2025  ls[(i + start) %
-000139f0: 206e 5f77 6f72 6b65 7273 5d0a 2020 2020   n_workers].    
-00013a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013a10: 2020 2020 6966 2077 705f 692e 6f63 6375      if wp_i.occu
-00013a20: 7061 6e63 7920 3d3d 2030 3a0a 2020 2020  pancy == 0:.    
-00013a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013a40: 2020 2020 2020 2020 7773 203d 2077 705f          ws = wp_
-00013a50: 690a 2020 2020 2020 2020 2020 2020 2020  i.              
-00013a60: 2020 2020 2020 2020 2020 2020 2020 6272                br
-00013a70: 6561 6b0a 2020 2020 2020 2020 2020 2020  eak.            
-00013a80: 656c 7365 3a20 2023 2064 756d 6220 6275  else:  # dumb bu
-00013a90: 7420 6661 7374 2069 6e20 6c61 7267 6520  t fast in large 
-00013aa0: 6361 7365 0a20 2020 2020 2020 2020 2020  case.           
-00013ab0: 2020 2020 2077 7320 3d20 7770 5f76 616c       ws = wp_val
-00013ac0: 735b 7365 6c66 2e6e 5f74 6173 6b73 2025  s[self.n_tasks %
-00013ad0: 206e 5f77 6f72 6b65 7273 5d0a 0a20 2020   n_workers]..   
-00013ae0: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
-00013af0: 6964 6174 6520 616e 6420 7773 2069 7320  idate and ws is 
-00013b00: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00013b10: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
-00013b20: 662e 776f 726b 6572 732e 6765 7428 7773  f.workers.get(ws
-00013b30: 2e61 6464 7265 7373 2920 6973 2077 730a  .address) is ws.
-00013b40: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00013b50: 7274 2077 7320 696e 2073 656c 662e 7275  rt ws in self.ru
-00013b60: 6e6e 696e 672c 2028 7773 2c20 7365 6c66  nning, (ws, self
-00013b70: 2e72 756e 6e69 6e67 290a 0a20 2020 2020  .running)..     
-00013b80: 2020 2072 6574 7572 6e20 7773 0a0a 2020     return ws..  
-00013b90: 2020 6465 6620 7472 616e 7369 7469 6f6e    def transition
-00013ba0: 5f77 6169 7469 6e67 5f70 726f 6365 7373  _waiting_process
-00013bb0: 696e 6728 7365 6c66 2c20 6b65 793a 2073  ing(self, key: s
-00013bc0: 7472 2c20 7374 696d 756c 7573 5f69 643a  tr, stimulus_id:
-00013bd0: 2073 7472 2920 2d3e 2052 6563 734d 7367   str) -> RecsMsg
-00013be0: 733a 0a20 2020 2020 2020 2022 2222 506f  s:.        """Po
-00013bf0: 7373 6962 6c79 2073 6368 6564 756c 6520  ssibly schedule 
-00013c00: 6120 7265 6164 7920 7461 736b 2e20 5468  a ready task. Th
-00013c10: 6973 2069 7320 7468 6520 7072 696d 6172  is is the primar
-00013c20: 7920 6469 7370 6174 6368 2066 6f72 2072  y dispatch for r
-00013c30: 6561 6479 2074 6173 6b73 2e0a 0a20 2020  eady tasks...   
-00013c40: 2020 2020 2049 6620 7468 6572 6527 7320       If there's 
-00013c50: 6e6f 2061 7070 726f 7072 6961 7465 2077  no appropriate w
-00013c60: 6f72 6b65 7220 666f 7220 7468 6520 7461  orker for the ta
-00013c70: 736b 2028 6275 7420 7468 6520 7461 736b  sk (but the task
-00013c80: 2069 7320 6f74 6865 7277 6973 650a 2020   is otherwise.  
-00013c90: 2020 2020 2020 7275 6e6e 6162 6c65 292c        runnable),
-00013ca0: 2069 7420 7769 6c6c 2062 6520 7265 636f   it will be reco
-00013cb0: 6d6d 656e 6465 6420 746f 2060 606e 6f2d  mmended to ``no-
-00013cc0: 776f 726b 6572 6060 206f 7220 6060 7175  worker`` or ``qu
-00013cd0: 6575 6564 6060 2e0a 2020 2020 2020 2020  eued``..        
-00013ce0: 2222 220a 2020 2020 2020 2020 7473 203d  """.        ts =
-00013cf0: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
-00013d00: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00013d10: 662e 6973 5f72 6f6f 7469 7368 2874 7329  f.is_rootish(ts)
-00013d20: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00013d30: 4e4f 5445 3a20 6861 7669 6e67 2074 776f  NOTE: having two
-00013d40: 2072 6f6f 742d 6973 6820 6d65 7468 6f64   root-ish method
-00013d50: 7320 6973 2074 656d 706f 7261 7279 2e20  s is temporary. 
-00013d60: 5768 656e 2074 6865 2066 6561 7475 7265  When the feature
-00013d70: 2066 6c61 6720 6973 0a20 2020 2020 2020   flag is.       
-00013d80: 2020 2020 2023 2072 656d 6f76 6564 2c20       # removed, 
-00013d90: 7468 6572 6520 7368 6f75 6c64 206f 6e6c  there should onl
-00013da0: 7920 6265 206f 6e65 2c20 7768 6963 6820  y be one, which 
-00013db0: 636f 6d62 696e 6573 2063 6f2d 6173 7369  combines co-assi
-00013dc0: 676e 6d65 6e74 2061 6e64 0a20 2020 2020  gnment and.     
-00013dd0: 2020 2020 2020 2023 2071 7565 7569 6e67         # queuing
-00013de0: 2e20 4576 656e 7475 616c 6c79 2c20 7370  . Eventually, sp
-00013df0: 6563 6961 6c2d 6361 7369 6e67 2072 6f6f  ecial-casing roo
-00013e00: 7420 7461 736b 7320 6d69 6768 7420 6265  t tasks might be
-00013e10: 2072 656d 6f76 6564 2065 6e74 6972 656c   removed entirel
-00013e20: 792c 0a20 2020 2020 2020 2020 2020 2023  y,.            #
-00013e30: 2077 6974 6820 6265 7474 6572 2068 6575   with better heu
-00013e40: 7269 7374 6963 732e 0a20 2020 2020 2020  ristics..       
-00013e50: 2020 2020 2069 6620 6d61 7468 2e69 7369       if math.isi
-00013e60: 6e66 2873 656c 662e 574f 524b 4552 5f53  nf(self.WORKER_S
-00013e70: 4154 5552 4154 494f 4e29 3a0a 2020 2020  ATURATION):.    
-00013e80: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00013e90: 6f74 2028 7773 203a 3d20 7365 6c66 2e64  ot (ws := self.d
-00013ea0: 6563 6964 655f 776f 726b 6572 5f72 6f6f  ecide_worker_roo
-00013eb0: 7469 7368 5f71 7565 7569 6e67 5f64 6973  tish_queuing_dis
-00013ec0: 6162 6c65 6428 7473 2929 3a0a 2020 2020  abled(ts)):.    
-00013ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ee0: 7265 7475 726e 207b 7473 2e6b 6579 3a20  return {ts.key: 
-00013ef0: 226e 6f2d 776f 726b 6572 227d 2c20 7b7d  "no-worker"}, {}
-00013f00: 2c20 7b7d 0a20 2020 2020 2020 2020 2020  , {}.           
-00013f10: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00013f20: 2020 2020 2020 2069 6620 6e6f 7420 2877         if not (w
-00013f30: 7320 3a3d 2073 656c 662e 6465 6369 6465  s := self.decide
-00013f40: 5f77 6f72 6b65 725f 726f 6f74 6973 685f  _worker_rootish_
-00013f50: 7175 6575 696e 675f 656e 6162 6c65 6428  queuing_enabled(
-00013f60: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-00013f70: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-00013f80: 7473 2e6b 6579 3a20 2271 7565 7565 6422  ts.key: "queued"
-00013f90: 7d2c 207b 7d2c 207b 7d0a 2020 2020 2020  }, {}, {}.      
-00013fa0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00013fb0: 2020 2020 6966 206e 6f74 2028 7773 203a      if not (ws :
-00013fc0: 3d20 7365 6c66 2e64 6563 6964 655f 776f  = self.decide_wo
-00013fd0: 726b 6572 5f6e 6f6e 5f72 6f6f 7469 7368  rker_non_rootish
-00013fe0: 2874 7329 293a 0a20 2020 2020 2020 2020  (ts)):.         
-00013ff0: 2020 2020 2020 2072 6574 7572 6e20 7b74         return {t
-00014000: 732e 6b65 793a 2022 6e6f 2d77 6f72 6b65  s.key: "no-worke
-00014010: 7222 7d2c 207b 7d2c 207b 7d0a 0a20 2020  r"}, {}, {}..   
-00014020: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
-00014030: 203d 2073 656c 662e 5f61 6464 5f74 6f5f   = self._add_to_
-00014040: 7072 6f63 6573 7369 6e67 2874 732c 2077  processing(ts, w
-00014050: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
-00014060: 6e20 7b7d 2c20 7b7d 2c20 776f 726b 6572  n {}, {}, worker
-00014070: 5f6d 7367 730a 0a20 2020 2064 6566 2074  _msgs..    def t
-00014080: 7261 6e73 6974 696f 6e5f 7761 6974 696e  ransition_waitin
-00014090: 675f 6d65 6d6f 7279 280a 2020 2020 2020  g_memory(.      
-000140a0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-000140b0: 6b65 793a 2073 7472 2c0a 2020 2020 2020  key: str,.      
-000140c0: 2020 7374 696d 756c 7573 5f69 643a 2073    stimulus_id: s
-000140d0: 7472 2c0a 2020 2020 2020 2020 2a2c 0a20  tr,.        *,. 
-000140e0: 2020 2020 2020 206e 6279 7465 733a 2069         nbytes: i
-000140f0: 6e74 207c 204e 6f6e 6520 3d20 4e6f 6e65  nt | None = None
-00014100: 2c0a 2020 2020 2020 2020 7479 7065 3a20  ,.        type: 
-00014110: 6279 7465 7320 7c20 4e6f 6e65 203d 204e  bytes | None = N
-00014120: 6f6e 652c 0a20 2020 2020 2020 2074 7970  one,.        typ
-00014130: 656e 616d 653a 2073 7472 207c 204e 6f6e  ename: str | Non
-00014140: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-00014150: 2020 776f 726b 6572 3a20 7374 722c 0a20    worker: str,. 
-00014160: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
-00014170: 2041 6e79 2c0a 2020 2020 2920 2d3e 2052   Any,.    ) -> R
-00014180: 6563 734d 7367 733a 0a20 2020 2020 2020  ecsMsgs:.       
-00014190: 2022 2222 5468 6973 2074 7261 6e73 6974   """This transit
-000141a0: 696f 6e20 6578 636c 7573 6976 656c 7920  ion exclusively 
-000141b0: 6861 7070 656e 7320 696e 2061 2072 6163  happens in a rac
-000141c0: 6520 636f 6e64 6974 696f 6e20 7768 6572  e condition wher
-000141d0: 6520 7468 6520 7363 6865 6475 6c65 720a  e the scheduler.
-000141e0: 2020 2020 2020 2020 6265 6c69 6576 6573          believes
-000141f0: 2074 6861 7420 7468 6520 6f6e 6c79 2063   that the only c
-00014200: 6f70 7920 6f66 2061 2064 6570 656e 6465  opy of a depende
-00014210: 6e63 7920 7461 736b 2068 6173 206a 7573  ncy task has jus
-00014220: 7420 6265 656e 206c 6f73 742c 2073 6f20  t been lost, so 
-00014230: 6974 0a20 2020 2020 2020 2074 7261 6e73  it.        trans
-00014240: 6974 696f 6e73 2061 6c6c 2064 6570 656e  itions all depen
-00014250: 6465 6e74 7320 6261 636b 2074 6f20 7761  dents back to wa
-00014260: 6974 696e 672c 2062 7574 2061 6374 7561  iting, but actua
-00014270: 6c6c 7920 6120 7265 706c 6963 6120 6861  lly a replica ha
-00014280: 7320 616c 7265 6164 790a 2020 2020 2020  s already.      
-00014290: 2020 6265 656e 2061 6371 7569 7265 6420    been acquired 
-000142a0: 6279 2061 2077 6f72 6b65 7220 636f 6d70  by a worker comp
-000142b0: 7574 696e 6720 7468 6520 6465 7065 6e64  uting the depend
-000142c0: 656e 6379 202d 2074 6865 2073 6368 6564  ency - the sched
-000142d0: 756c 6572 206a 7573 7420 646f 6573 6e27  uler just doesn'
-000142e0: 740a 2020 2020 2020 2020 6b6e 6f77 2079  t.        know y
-000142f0: 6574 202d 2061 6e64 2074 6865 2065 7865  et - and the exe
-00014300: 6375 7469 6f6e 2066 696e 6973 6865 7320  cution finishes 
-00014310: 6265 666f 7265 2074 6865 2063 616e 6365  before the cance
-00014320: 6c6c 6174 696f 6e20 6d65 7373 6167 6520  llation message 
-00014330: 6672 6f6d 2074 6865 0a20 2020 2020 2020  from the.       
-00014340: 2073 6368 6564 756c 6572 2068 6173 2061   scheduler has a
-00014350: 2063 6861 6e63 6520 746f 2072 6561 6368   chance to reach
-00014360: 2074 6865 2077 6f72 6b65 722e 2053 686f   the worker. Sho
-00014370: 7274 6c79 2c20 7468 6520 6361 6e63 656c  rtly, the cancel
-00014380: 6c61 7469 6f6e 2072 6571 7565 7374 0a20  lation request. 
-00014390: 2020 2020 2020 2077 696c 6c20 7265 6163         will reac
-000143a0: 6820 7468 6520 776f 726b 6572 2c20 7468  h the worker, th
-000143b0: 7573 2064 656c 6574 696e 6720 7468 6520  us deleting the 
-000143c0: 6461 7461 2066 726f 6d20 6d65 6d6f 7279  data from memory
-000143d0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-000143e0: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
-000143f0: 7461 736b 735b 6b65 795d 0a0a 2020 2020  tasks[key]..    
-00014400: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
-00014410: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
-00014420: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
-00014430: 7072 6f63 6573 7369 6e67 5f6f 6e0a 2020  processing_on.  
-00014440: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00014450: 2074 732e 7761 6974 696e 675f 6f6e 0a20   ts.waiting_on. 
-00014460: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00014470: 7420 7473 2e73 7461 7465 203d 3d20 2277  t ts.state == "w
-00014480: 6169 7469 6e67 220a 0a20 2020 2020 2020  aiting"..       
-00014490: 2072 6574 7572 6e20 7b7d 2c20 7b7d 2c20   return {}, {}, 
-000144a0: 7b7d 0a0a 2020 2020 6465 6620 7472 616e  {}..    def tran
-000144b0: 7369 7469 6f6e 5f70 726f 6365 7373 696e  sition_processin
-000144c0: 675f 6d65 6d6f 7279 280a 2020 2020 2020  g_memory(.      
-000144d0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-000144e0: 6b65 793a 2073 7472 2c0a 2020 2020 2020  key: str,.      
-000144f0: 2020 7374 696d 756c 7573 5f69 643a 2073    stimulus_id: s
-00014500: 7472 2c0a 2020 2020 2020 2020 2a2c 0a20  tr,.        *,. 
-00014510: 2020 2020 2020 206e 6279 7465 733a 2069         nbytes: i
-00014520: 6e74 207c 204e 6f6e 6520 3d20 4e6f 6e65  nt | None = None
-00014530: 2c0a 2020 2020 2020 2020 7479 7065 3a20  ,.        type: 
-00014540: 6279 7465 7320 7c20 4e6f 6e65 203d 204e  bytes | None = N
-00014550: 6f6e 652c 0a20 2020 2020 2020 2074 7970  one,.        typ
-00014560: 656e 616d 653a 2073 7472 207c 204e 6f6e  ename: str | Non
-00014570: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-00014580: 2020 776f 726b 6572 3a20 7374 722c 0a20    worker: str,. 
-00014590: 2020 2020 2020 2073 7461 7274 7374 6f70         startstop
-000145a0: 733a 206c 6973 745b 6469 6374 5d20 7c20  s: list[dict] | 
-000145b0: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-000145c0: 2020 2020 202a 2a6b 7761 7267 733a 2041       **kwargs: A
-000145d0: 6e79 2c0a 2020 2020 2920 2d3e 2052 6563  ny,.    ) -> Rec
-000145e0: 734d 7367 733a 0a20 2020 2020 2020 2074  sMsgs:.        t
-000145f0: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
-00014600: 6579 5d0a 0a20 2020 2020 2020 2061 7373  ey]..        ass
-00014610: 6572 7420 776f 726b 6572 0a20 2020 2020  ert worker.     
-00014620: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
-00014630: 616e 6365 2877 6f72 6b65 722c 2073 7472  ance(worker, str
-00014640: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
-00014650: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
-00014660: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00014670: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-00014680: 0a20 2020 2020 2020 2020 2020 2077 7373  .            wss
-00014690: 203d 2074 732e 7072 6f63 6573 7369 6e67   = ts.processing
-000146a0: 5f6f 6e0a 2020 2020 2020 2020 2020 2020  _on.            
-000146b0: 6173 7365 7274 2077 7373 0a20 2020 2020  assert wss.     
-000146c0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-000146d0: 2069 6e20 7773 732e 7072 6f63 6573 7369   in wss.processi
-000146e0: 6e67 0a20 2020 2020 2020 2020 2020 2064  ng.            d
-000146f0: 656c 2077 7373 0a20 2020 2020 2020 2020  el wss.         
-00014700: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
-00014710: 2e77 6169 7469 6e67 5f6f 6e0a 2020 2020  .waiting_on.    
-00014720: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-00014730: 6f74 2074 732e 7768 6f5f 6861 732c 2028  ot ts.who_has, (
-00014740: 7473 2c20 7473 2e77 686f 5f68 6173 290a  ts, ts.who_has).
-00014750: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00014760: 7274 206e 6f74 2074 732e 6578 6365 7074  rt not ts.except
-00014770: 696f 6e5f 626c 616d 650a 2020 2020 2020  ion_blame.      
-00014780: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
-00014790: 7374 6174 6520 3d3d 2022 7072 6f63 6573  state == "proces
-000147a0: 7369 6e67 220a 0a20 2020 2020 2020 2077  sing"..        w
-000147b0: 7320 3d20 7365 6c66 2e77 6f72 6b65 7273  s = self.workers
-000147c0: 2e67 6574 2877 6f72 6b65 7229 0a20 2020  .get(worker).   
-000147d0: 2020 2020 2069 6620 7773 2069 7320 4e6f       if ws is No
-000147e0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-000147f0: 7265 7475 726e 207b 6b65 793a 2022 7265  return {key: "re
-00014800: 6c65 6173 6564 227d 2c20 7b7d 2c20 7b7d  leased"}, {}, {}
-00014810: 0a0a 2020 2020 2020 2020 6966 2077 7320  ..        if ws 
-00014820: 213d 2074 732e 7072 6f63 6573 7369 6e67  != ts.processing
-00014830: 5f6f 6e3a 2020 2320 7072 6167 6d61 3a20  _on:  # pragma: 
-00014840: 6e6f 636f 7665 720a 2020 2020 2020 2020  nocover.        
-00014850: 2020 2020 6173 7365 7274 2074 732e 7072      assert ts.pr
-00014860: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
-00014870: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
-00014880: 6e74 696d 6545 7272 6f72 280a 2020 2020  ntimeError(.    
-00014890: 2020 2020 2020 2020 2020 2020 6622 5461              f"Ta
-000148a0: 736b 207b 7473 2e6b 6579 2172 7d20 7472  sk {ts.key!r} tr
-000148b0: 616e 7369 7469 6f6e 6564 2066 726f 6d20  ansitioned from 
-000148c0: 7072 6f63 6573 7369 6e67 2074 6f20 6d65  processing to me
-000148d0: 6d6f 7279 206f 6e20 776f 726b 6572 2022  mory on worker "
-000148e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000148f0: 2066 227b 7773 7d2c 2077 6869 6c65 2069   f"{ws}, while i
-00014900: 7420 7761 7320 6578 7065 6374 6564 2066  t was expected f
-00014910: 726f 6d20 7b74 732e 7072 6f63 6573 7369  rom {ts.processi
-00014920: 6e67 5f6f 6e7d 2e20 5468 6973 2073 686f  ng_on}. This sho
-00014930: 756c 6420 220a 2020 2020 2020 2020 2020  uld ".          
-00014940: 2020 2020 2020 6622 6265 2069 6d70 6f73        f"be impos
-00014950: 7369 626c 652e 207b 7374 696d 756c 7573  sible. {stimulus
-00014960: 5f69 643d 7d2c 2073 746f 7279 3d7b 7365  _id=}, story={se
-00014970: 6c66 2e73 746f 7279 2874 7329 7d22 0a20  lf.story(ts)}". 
-00014980: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00014990: 2020 2020 2020 2323 2323 2323 2323 2323        ##########
-000149a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000149b0: 2323 230a 2020 2020 2020 2020 2320 5570  ###.        # Up
-000149c0: 6461 7465 2054 696d 696e 6720 496e 666f  date Timing Info
-000149d0: 726d 6174 696f 6e20 230a 2020 2020 2020  rmation #.      
-000149e0: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
-000149f0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-00014a00: 2020 2020 2020 2020 6966 2073 7461 7274          if start
-00014a10: 7374 6f70 733a 0a20 2020 2020 2020 2020  stops:.         
-00014a20: 2020 2066 6f72 2073 7461 7274 7374 6f70     for startstop
-00014a30: 2069 6e20 7374 6172 7473 746f 7073 3a0a   in startstops:.
-00014a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a50: 7473 2e67 726f 7570 2e61 6464 5f64 7572  ts.group.add_dur
-00014a60: 6174 696f 6e28 0a20 2020 2020 2020 2020  ation(.         
-00014a70: 2020 2020 2020 2020 2020 2073 746f 703d             stop=
-00014a80: 7374 6172 7473 746f 705b 2273 746f 7022  startstop["stop"
-00014a90: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00014aa0: 2020 2020 2020 2073 7461 7274 3d73 7461         start=sta
-00014ab0: 7274 7374 6f70 5b22 7374 6172 7422 5d2c  rtstop["start"],
-00014ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014ad0: 2020 2020 2061 6374 696f 6e3d 7374 6172       action=star
-00014ae0: 7473 746f 705b 2261 6374 696f 6e22 5d2c  tstop["action"],
-00014af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014b00: 2029 0a0a 2020 2020 2020 2020 7320 3d20   )..        s = 
-00014b10: 7365 6c66 2e75 6e6b 6e6f 776e 5f64 7572  self.unknown_dur
-00014b20: 6174 696f 6e73 2e70 6f70 2874 732e 7072  ations.pop(ts.pr
-00014b30: 6566 6978 2e6e 616d 652c 2073 6574 2829  efix.name, set()
-00014b40: 290a 2020 2020 2020 2020 7374 6561 6c20  ).        steal 
-00014b50: 3d20 7365 6c66 2e65 7874 656e 7369 6f6e  = self.extension
-00014b60: 732e 6765 7428 2273 7465 616c 696e 6722  s.get("stealing"
-00014b70: 290a 2020 2020 2020 2020 6966 2073 7465  ).        if ste
-00014b80: 616c 3a0a 2020 2020 2020 2020 2020 2020  al:.            
-00014b90: 666f 7220 7474 7320 696e 2073 3a0a 2020  for tts in s:.  
-00014ba0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00014bb0: 2074 7473 2e70 726f 6365 7373 696e 675f   tts.processing_
-00014bc0: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
-00014bd0: 2020 2020 2020 2020 7374 6561 6c2e 7265          steal.re
-00014be0: 6361 6c63 756c 6174 655f 636f 7374 2874  calculate_cost(t
-00014bf0: 7473 290a 0a20 2020 2020 2020 2023 2323  ts)..        ###
-00014c00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00014c10: 2323 2323 2323 2323 230a 2020 2020 2020  #########.      
-00014c20: 2020 2320 5570 6461 7465 2053 7461 7465    # Update State
-00014c30: 2049 6e66 6f72 6d61 7469 6f6e 2023 0a20   Information #. 
-00014c40: 2020 2020 2020 2023 2323 2323 2323 2323         #########
-00014c50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00014c60: 2323 230a 2020 2020 2020 2020 6966 206e  ###.        if n
-00014c70: 6279 7465 7320 6973 206e 6f74 204e 6f6e  bytes is not Non
-00014c80: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
-00014c90: 732e 7365 745f 6e62 7974 6573 286e 6279  s.set_nbytes(nby
-00014ca0: 7465 7329 0a0a 2020 2020 2020 2020 7365  tes)..        se
-00014cb0: 6c66 2e5f 6578 6974 5f70 726f 6365 7373  lf._exit_process
-00014cc0: 696e 675f 636f 6d6d 6f6e 2874 7329 0a0a  ing_common(ts)..
-00014cd0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-00014ce0: 6461 7469 6f6e 733a 2052 6563 7320 3d20  dations: Recs = 
-00014cf0: 7b7d 0a20 2020 2020 2020 2063 6c69 656e  {}.        clien
-00014d00: 745f 6d73 6773 3a20 4d73 6773 203d 207b  t_msgs: Msgs = {
-00014d10: 7d0a 2020 2020 2020 2020 7365 6c66 2e5f  }.        self._
-00014d20: 6164 645f 746f 5f6d 656d 6f72 7928 0a20  add_to_memory(. 
-00014d30: 2020 2020 2020 2020 2020 2074 732c 2077             ts, w
-00014d40: 732c 2072 6563 6f6d 6d65 6e64 6174 696f  s, recommendatio
-00014d50: 6e73 2c20 636c 6965 6e74 5f6d 7367 732c  ns, client_msgs,
-00014d60: 2074 7970 653d 7479 7065 2c20 7479 7065   type=type, type
-00014d70: 6e61 6d65 3d74 7970 656e 616d 650a 2020  name=typename.  
-00014d80: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00014d90: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
-00014da0: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
-00014db0: 7373 6572 7420 6e6f 7420 7473 2e70 726f  ssert not ts.pro
-00014dc0: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
-00014dd0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-00014de0: 7420 7473 2e77 6169 7469 6e67 5f6f 6e0a  t ts.waiting_on.
-00014df0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00014e00: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
-00014e10: 2063 6c69 656e 745f 6d73 6773 2c20 7b7d   client_msgs, {}
-00014e20: 0a0a 2020 2020 6465 6620 7472 616e 7369  ..    def transi
-00014e30: 7469 6f6e 5f6d 656d 6f72 795f 7265 6c65  tion_memory_rele
-00014e40: 6173 6564 280a 2020 2020 2020 2020 7365  ased(.        se
-00014e50: 6c66 2c20 6b65 793a 2073 7472 2c20 7374  lf, key: str, st
-00014e60: 696d 756c 7573 5f69 643a 2073 7472 2c20  imulus_id: str, 
-00014e70: 2a2c 2073 6166 653a 2062 6f6f 6c20 3d20  *, safe: bool = 
-00014e80: 4661 6c73 650a 2020 2020 2920 2d3e 2052  False.    ) -> R
-00014e90: 6563 734d 7367 733a 0a20 2020 2020 2020  ecsMsgs:.       
-00014ea0: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
-00014eb0: 5b6b 6579 5d0a 0a20 2020 2020 2020 2069  [key]..        i
-00014ec0: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
-00014ed0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00014ee0: 6572 7420 6e6f 7420 7473 2e77 6169 7469  ert not ts.waiti
-00014ef0: 6e67 5f6f 6e0a 2020 2020 2020 2020 2020  ng_on.          
-00014f00: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
-00014f10: 7072 6f63 6573 7369 6e67 5f6f 6e0a 2020  processing_on.  
-00014f20: 2020 2020 2020 2020 2020 6966 2073 6166            if saf
-00014f30: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00014f40: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
-00014f50: 2e77 6169 7465 7273 0a0a 2020 2020 2020  .waiters..      
-00014f60: 2020 6966 2074 732e 6163 746f 723a 0a20    if ts.actor:. 
-00014f70: 2020 2020 2020 2020 2020 2066 6f72 2077             for w
-00014f80: 7320 696e 2074 732e 7768 6f5f 6861 733a  s in ts.who_has:
-00014f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014fa0: 2077 732e 6163 746f 7273 2e64 6973 6361   ws.actors.disca
-00014fb0: 7264 2874 7329 0a20 2020 2020 2020 2020  rd(ts).         
-00014fc0: 2020 2069 6620 7473 2e77 686f 5f77 616e     if ts.who_wan
-00014fd0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-00014fe0: 2020 2020 7473 2e65 7863 6570 7469 6f6e      ts.exception
-00014ff0: 5f62 6c61 6d65 203d 2074 730a 2020 2020  _blame = ts.    
-00015000: 2020 2020 2020 2020 2020 2020 7473 2e65              ts.e
-00015010: 7863 6570 7469 6f6e 203d 2053 6572 6961  xception = Seria
-00015020: 6c69 7a65 6428 0a20 2020 2020 2020 2020  lized(.         
-00015030: 2020 2020 2020 2020 2020 202a 7365 7269             *seri
-00015040: 616c 697a 6528 5661 6c75 6545 7272 6f72  alize(ValueError
-00015050: 2822 576f 726b 6572 2068 6f6c 6469 6e67  ("Worker holding
-00015060: 2041 6374 6f72 2077 6173 206c 6f73 7422   Actor was lost"
-00015070: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-00015080: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00015090: 2020 2020 2072 6574 7572 6e20 7b74 732e       return {ts.
-000150a0: 6b65 793a 2022 6572 7265 6422 7d2c 207b  key: "erred"}, {
-000150b0: 7d2c 207b 7d20 2023 2064 6f6e 2774 2074  }, {}  # don't t
-000150c0: 7279 2074 6f20 7265 6372 6561 7465 0a0a  ry to recreate..
-000150d0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-000150e0: 6461 7469 6f6e 733a 2052 6563 7320 3d20  dations: Recs = 
-000150f0: 7b7d 0a20 2020 2020 2020 2063 6c69 656e  {}.        clien
-00015100: 745f 6d73 6773 3a20 4d73 6773 203d 207b  t_msgs: Msgs = {
-00015110: 7d0a 2020 2020 2020 2020 776f 726b 6572  }.        worker
-00015120: 5f6d 7367 733a 204d 7367 7320 3d20 7b7d  _msgs: Msgs = {}
-00015130: 0a0a 2020 2020 2020 2020 2320 5858 5820  ..        # XXX 
-00015140: 6661 6374 6f72 2074 6869 7320 6f75 743f  factor this out?
-00015150: 0a20 2020 2020 2020 2077 6f72 6b65 725f  .        worker_
-00015160: 6d73 6720 3d20 7b0a 2020 2020 2020 2020  msg = {.        
-00015170: 2020 2020 226f 7022 3a20 2266 7265 652d      "op": "free-
-00015180: 6b65 7973 222c 0a20 2020 2020 2020 2020  keys",.         
-00015190: 2020 2022 6b65 7973 223a 205b 6b65 795d     "keys": [key]
-000151a0: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
-000151b0: 7469 6d75 6c75 735f 6964 223a 2073 7469  timulus_id": sti
-000151c0: 6d75 6c75 735f 6964 2c0a 2020 2020 2020  mulus_id,.      
-000151d0: 2020 7d0a 2020 2020 2020 2020 666f 7220    }.        for 
-000151e0: 7773 2069 6e20 7473 2e77 686f 5f68 6173  ws in ts.who_has
-000151f0: 3a0a 2020 2020 2020 2020 2020 2020 776f  :.            wo
-00015200: 726b 6572 5f6d 7367 735b 7773 2e61 6464  rker_msgs[ws.add
-00015210: 7265 7373 5d20 3d20 5b77 6f72 6b65 725f  ress] = [worker_
-00015220: 6d73 675d 0a20 2020 2020 2020 2073 656c  msg].        sel
-00015230: 662e 7265 6d6f 7665 5f61 6c6c 5f72 6570  f.remove_all_rep
-00015240: 6c69 6361 7328 7473 290a 0a20 2020 2020  licas(ts)..     
-00015250: 2020 2074 732e 7374 6174 6520 3d20 2272     ts.state = "r
-00015260: 656c 6561 7365 6422 0a0a 2020 2020 2020  eleased"..      
-00015270: 2020 7265 706f 7274 5f6d 7367 203d 207b    report_msg = {
-00015280: 226f 7022 3a20 226c 6f73 742d 6461 7461  "op": "lost-data
-00015290: 222c 2022 6b65 7922 3a20 6b65 797d 0a20  ", "key": key}. 
-000152a0: 2020 2020 2020 2066 6f72 2063 7320 696e         for cs in
-000152b0: 2074 732e 7768 6f5f 7761 6e74 733a 0a20   ts.who_wants:. 
-000152c0: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
-000152d0: 745f 6d73 6773 5b63 732e 636c 6965 6e74  t_msgs[cs.client
-000152e0: 5f6b 6579 5d20 3d20 5b72 6570 6f72 745f  _key] = [report_
-000152f0: 6d73 675d 0a0a 2020 2020 2020 2020 6966  msg]..        if
-00015300: 206e 6f74 2074 732e 7275 6e5f 7370 6563   not ts.run_spec
-00015310: 3a20 2023 2070 7572 6520 6461 7461 0a20  :  # pure data. 
-00015320: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
-00015330: 6d65 6e64 6174 696f 6e73 5b6b 6579 5d20  mendations[key] 
-00015340: 3d20 2266 6f72 676f 7474 656e 220a 2020  = "forgotten".  
-00015350: 2020 2020 2020 656c 6966 2074 732e 6861        elif ts.ha
-00015360: 735f 6c6f 7374 5f64 6570 656e 6465 6e63  s_lost_dependenc
-00015370: 6965 733a 0a20 2020 2020 2020 2020 2020  ies:.           
-00015380: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00015390: 5b6b 6579 5d20 3d20 2266 6f72 676f 7474  [key] = "forgott
-000153a0: 656e 220a 2020 2020 2020 2020 656c 6966  en".        elif
-000153b0: 2074 732e 7768 6f5f 7761 6e74 7320 6f72   ts.who_wants or
-000153c0: 2074 732e 7761 6974 6572 733a 0a20 2020   ts.waiters:.   
-000153d0: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
-000153e0: 6e64 6174 696f 6e73 5b6b 6579 5d20 3d20  ndations[key] = 
-000153f0: 2277 6169 7469 6e67 220a 0a20 2020 2020  "waiting"..     
-00015400: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
-00015410: 2e77 6169 7465 7273 3a0a 2020 2020 2020  .waiters:.      
-00015420: 2020 2020 2020 6966 2064 7473 2e73 7461        if dts.sta
-00015430: 7465 2069 6e20 2822 6e6f 2d77 6f72 6b65  te in ("no-worke
-00015440: 7222 2c20 2270 726f 6365 7373 696e 6722  r", "processing"
-00015450: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00015460: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
-00015470: 6e73 5b64 7473 2e6b 6579 5d20 3d20 2277  ns[dts.key] = "w
-00015480: 6169 7469 6e67 220a 2020 2020 2020 2020  aiting".        
-00015490: 2020 2020 656c 6966 2064 7473 2e73 7461      elif dts.sta
-000154a0: 7465 203d 3d20 2277 6169 7469 6e67 223a  te == "waiting":
-000154b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000154c0: 2064 7473 2e77 6169 7469 6e67 5f6f 6e2e   dts.waiting_on.
-000154d0: 6164 6428 7473 290a 0a20 2020 2020 2020  add(ts)..       
-000154e0: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
-000154f0: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
-00015500: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
-00015510: 7469 6e67 5f6f 6e0a 0a20 2020 2020 2020  ting_on..       
-00015520: 2072 6574 7572 6e20 7265 636f 6d6d 656e   return recommen
-00015530: 6461 7469 6f6e 732c 2063 6c69 656e 745f  dations, client_
-00015540: 6d73 6773 2c20 776f 726b 6572 5f6d 7367  msgs, worker_msg
-00015550: 730a 0a20 2020 2064 6566 2074 7261 6e73  s..    def trans
-00015560: 6974 696f 6e5f 7265 6c65 6173 6564 5f65  ition_released_e
-00015570: 7272 6564 2873 656c 662c 206b 6579 3a20  rred(self, key: 
-00015580: 7374 722c 2073 7469 6d75 6c75 735f 6964  str, stimulus_id
-00015590: 3a20 7374 7229 202d 3e20 5265 6373 4d73  : str) -> RecsMs
-000155a0: 6773 3a0a 2020 2020 2020 2020 7473 203d  gs:.        ts =
-000155b0: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
-000155c0: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
-000155d0: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
-000155e0: 207b 7d0a 2020 2020 2020 2020 636c 6965   {}.        clie
-000155f0: 6e74 5f6d 7367 733a 204d 7367 7320 3d20  nt_msgs: Msgs = 
-00015600: 7b7d 0a0a 2020 2020 2020 2020 6966 2073  {}..        if s
-00015610: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
-00015620: 2020 2020 2020 2020 2020 7769 7468 206c            with l
-00015630: 6f67 5f65 7272 6f72 7328 7064 623d 4c4f  og_errors(pdb=LO
-00015640: 475f 5044 4229 3a0a 2020 2020 2020 2020  G_PDB):.        
-00015650: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-00015660: 732e 6578 6365 7074 696f 6e5f 626c 616d  s.exception_blam
-00015670: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00015680: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
-00015690: 7768 6f5f 6861 730a 2020 2020 2020 2020  who_has.        
-000156a0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-000156b0: 6f74 2074 732e 7761 6974 696e 675f 6f6e  ot ts.waiting_on
-000156c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000156d0: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
-000156e0: 6169 7465 7273 0a0a 2020 2020 2020 2020  aiters..        
-000156f0: 6661 696c 696e 675f 7473 203d 2074 732e  failing_ts = ts.
-00015700: 6578 6365 7074 696f 6e5f 626c 616d 650a  exception_blame.
-00015710: 2020 2020 2020 2020 6173 7365 7274 2066          assert f
-00015720: 6169 6c69 6e67 5f74 730a 0a20 2020 2020  ailing_ts..     
-00015730: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
-00015740: 2e64 6570 656e 6465 6e74 733a 0a20 2020  .dependents:.   
-00015750: 2020 2020 2020 2020 2064 7473 2e65 7863           dts.exc
-00015760: 6570 7469 6f6e 5f62 6c61 6d65 203d 2066  eption_blame = f
-00015770: 6169 6c69 6e67 5f74 730a 2020 2020 2020  ailing_ts.      
-00015780: 2020 2020 2020 6966 206e 6f74 2064 7473        if not dts
-00015790: 2e77 686f 5f68 6173 3a0a 2020 2020 2020  .who_has:.      
-000157a0: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
-000157b0: 656e 6461 7469 6f6e 735b 6474 732e 6b65  endations[dts.ke
-000157c0: 795d 203d 2022 6572 7265 6422 0a0a 2020  y] = "erred"..  
-000157d0: 2020 2020 2020 7265 706f 7274 5f6d 7367        report_msg
-000157e0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-000157f0: 2022 6f70 223a 2022 7461 736b 2d65 7272   "op": "task-err
-00015800: 6564 222c 0a20 2020 2020 2020 2020 2020  ed",.           
-00015810: 2022 6b65 7922 3a20 6b65 792c 0a20 2020   "key": key,.   
-00015820: 2020 2020 2020 2020 2022 6578 6365 7074           "except
-00015830: 696f 6e22 3a20 6661 696c 696e 675f 7473  ion": failing_ts
-00015840: 2e65 7863 6570 7469 6f6e 2c0a 2020 2020  .exception,.    
-00015850: 2020 2020 2020 2020 2274 7261 6365 6261          "traceba
-00015860: 636b 223a 2066 6169 6c69 6e67 5f74 732e  ck": failing_ts.
-00015870: 7472 6163 6562 6163 6b2c 0a20 2020 2020  traceback,.     
-00015880: 2020 207d 0a20 2020 2020 2020 2066 6f72     }.        for
-00015890: 2063 7320 696e 2074 732e 7768 6f5f 7761   cs in ts.who_wa
-000158a0: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
-000158b0: 2063 6c69 656e 745f 6d73 6773 5b63 732e   client_msgs[cs.
-000158c0: 636c 6965 6e74 5f6b 6579 5d20 3d20 5b72  client_key] = [r
-000158d0: 6570 6f72 745f 6d73 675d 0a0a 2020 2020  eport_msg]..    
-000158e0: 2020 2020 7473 2e73 7461 7465 203d 2022      ts.state = "
-000158f0: 6572 7265 6422 0a0a 2020 2020 2020 2020  erred"..        
-00015900: 2320 544f 444f 3a20 7761 6974 696e 6720  # TODO: waiting 
-00015910: 6461 7461 3f0a 2020 2020 2020 2020 7265  data?.        re
-00015920: 7475 726e 2072 6563 6f6d 6d65 6e64 6174  turn recommendat
-00015930: 696f 6e73 2c20 636c 6965 6e74 5f6d 7367  ions, client_msg
-00015940: 732c 207b 7d0a 0a20 2020 2064 6566 2074  s, {}..    def t
-00015950: 7261 6e73 6974 696f 6e5f 6572 7265 645f  ransition_erred_
-00015960: 7265 6c65 6173 6564 2873 656c 662c 206b  released(self, k
-00015970: 6579 3a20 7374 722c 2073 7469 6d75 6c75  ey: str, stimulu
-00015980: 735f 6964 3a20 7374 7229 202d 3e20 5265  s_id: str) -> Re
-00015990: 6373 4d73 6773 3a0a 2020 2020 2020 2020  csMsgs:.        
-000159a0: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
-000159b0: 6b65 795d 0a20 2020 2020 2020 2072 6563  key].        rec
-000159c0: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
-000159d0: 6373 203d 207b 7d0a 2020 2020 2020 2020  cs = {}.        
-000159e0: 636c 6965 6e74 5f6d 7367 733a 204d 7367  client_msgs: Msg
-000159f0: 7320 3d20 7b7d 0a20 2020 2020 2020 2077  s = {}.        w
-00015a00: 6f72 6b65 725f 6d73 6773 3a20 4d73 6773  orker_msgs: Msgs
-00015a10: 203d 207b 7d0a 0a20 2020 2020 2020 2069   = {}..        i
-00015a20: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
-00015a30: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
-00015a40: 6820 6c6f 675f 6572 726f 7273 2870 6462  h log_errors(pdb
-00015a50: 3d4c 4f47 5f50 4442 293a 0a20 2020 2020  =LOG_PDB):.     
-00015a60: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00015a70: 7420 7473 2e65 7863 6570 7469 6f6e 5f62  t ts.exception_b
-00015a80: 6c61 6d65 0a20 2020 2020 2020 2020 2020  lame.           
-00015a90: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-00015aa0: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
-00015ab0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00015ac0: 7420 6e6f 7420 7473 2e77 6169 7469 6e67  t not ts.waiting
-00015ad0: 5f6f 6e0a 2020 2020 2020 2020 2020 2020  _on.            
-00015ae0: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
-00015af0: 732e 7761 6974 6572 730a 0a20 2020 2020  s.waiters..     
-00015b00: 2020 2074 732e 6578 6365 7074 696f 6e20     ts.exception 
-00015b10: 3d20 4e6f 6e65 0a20 2020 2020 2020 2074  = None.        t
-00015b20: 732e 6578 6365 7074 696f 6e5f 626c 616d  s.exception_blam
-00015b30: 6520 3d20 4e6f 6e65 0a20 2020 2020 2020  e = None.       
-00015b40: 2074 732e 7472 6163 6562 6163 6b20 3d20   ts.traceback = 
-00015b50: 4e6f 6e65 0a0a 2020 2020 2020 2020 666f  None..        fo
-00015b60: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
-00015b70: 6e64 656e 7473 3a0a 2020 2020 2020 2020  ndents:.        
-00015b80: 2020 2020 6966 2064 7473 2e73 7461 7465      if dts.state
-00015b90: 203d 3d20 2265 7272 6564 223a 0a20 2020   == "erred":.   
-00015ba0: 2020 2020 2020 2020 2020 2020 2072 6563               rec
-00015bb0: 6f6d 6d65 6e64 6174 696f 6e73 5b64 7473  ommendations[dts
-00015bc0: 2e6b 6579 5d20 3d20 2277 6169 7469 6e67  .key] = "waiting
-00015bd0: 220a 0a20 2020 2020 2020 2077 5f6d 7367  "..        w_msg
-00015be0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00015bf0: 2022 6f70 223a 2022 6672 6565 2d6b 6579   "op": "free-key
-00015c00: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-00015c10: 226b 6579 7322 3a20 5b6b 6579 5d2c 0a20  "keys": [key],. 
-00015c20: 2020 2020 2020 2020 2020 2022 7374 696d             "stim
-00015c30: 756c 7573 5f69 6422 3a20 7374 696d 756c  ulus_id": stimul
-00015c40: 7573 5f69 642c 0a20 2020 2020 2020 207d  us_id,.        }
-00015c50: 0a20 2020 2020 2020 2066 6f72 2077 735f  .        for ws_
-00015c60: 6164 6472 2069 6e20 7473 2e65 7272 6564  addr in ts.erred
-00015c70: 5f6f 6e3a 0a20 2020 2020 2020 2020 2020  _on:.           
-00015c80: 2077 6f72 6b65 725f 6d73 6773 5b77 735f   worker_msgs[ws_
-00015c90: 6164 6472 5d20 3d20 5b77 5f6d 7367 5d0a  addr] = [w_msg].
-00015ca0: 2020 2020 2020 2020 7473 2e65 7272 6564          ts.erred
-00015cb0: 5f6f 6e2e 636c 6561 7228 290a 0a20 2020  _on.clear()..   
-00015cc0: 2020 2020 2072 6570 6f72 745f 6d73 6720       report_msg 
-00015cd0: 3d20 7b22 6f70 223a 2022 7461 736b 2d72  = {"op": "task-r
-00015ce0: 6574 7269 6564 222c 2022 6b65 7922 3a20  etried", "key": 
-00015cf0: 6b65 797d 0a20 2020 2020 2020 2066 6f72  key}.        for
-00015d00: 2063 7320 696e 2074 732e 7768 6f5f 7761   cs in ts.who_wa
-00015d10: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
-00015d20: 2063 6c69 656e 745f 6d73 6773 5b63 732e   client_msgs[cs.
-00015d30: 636c 6965 6e74 5f6b 6579 5d20 3d20 5b72  client_key] = [r
-00015d40: 6570 6f72 745f 6d73 675d 0a0a 2020 2020  eport_msg]..    
-00015d50: 2020 2020 7473 2e73 7461 7465 203d 2022      ts.state = "
-00015d60: 7265 6c65 6173 6564 220a 0a20 2020 2020  released"..     
-00015d70: 2020 2072 6574 7572 6e20 7265 636f 6d6d     return recomm
-00015d80: 656e 6461 7469 6f6e 732c 2063 6c69 656e  endations, clien
-00015d90: 745f 6d73 6773 2c20 776f 726b 6572 5f6d  t_msgs, worker_m
-00015da0: 7367 730a 0a20 2020 2064 6566 2074 7261  sgs..    def tra
-00015db0: 6e73 6974 696f 6e5f 7761 6974 696e 675f  nsition_waiting_
-00015dc0: 7265 6c65 6173 6564 2873 656c 662c 206b  released(self, k
-00015dd0: 6579 3a20 7374 722c 2073 7469 6d75 6c75  ey: str, stimulu
-00015de0: 735f 6964 3a20 7374 7229 202d 3e20 5265  s_id: str) -> Re
-00015df0: 6373 4d73 6773 3a0a 2020 2020 2020 2020  csMsgs:.        
-00015e00: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
-00015e10: 6b65 795d 0a20 2020 2020 2020 2072 6563  key].        rec
-00015e20: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
-00015e30: 6373 203d 207b 7d0a 0a20 2020 2020 2020  cs = {}..       
-00015e40: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
-00015e50: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
-00015e60: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
-00015e70: 5f68 6173 0a20 2020 2020 2020 2020 2020  _has.           
-00015e80: 2061 7373 6572 7420 6e6f 7420 7473 2e70   assert not ts.p
-00015e90: 726f 6365 7373 696e 675f 6f6e 0a0a 2020  rocessing_on..  
-00015ea0: 2020 2020 2020 666f 7220 6474 7320 696e        for dts in
-00015eb0: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
-00015ec0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00015ed0: 2074 7320 696e 2064 7473 2e77 6169 7465   ts in dts.waite
-00015ee0: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-00015ef0: 2020 2020 6474 732e 7761 6974 6572 732e      dts.waiters.
-00015f00: 6469 7363 6172 6428 7473 290a 2020 2020  discard(ts).    
-00015f10: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00015f20: 6f74 2064 7473 2e77 6169 7465 7273 2061  ot dts.waiters a
-00015f30: 6e64 206e 6f74 2064 7473 2e77 686f 5f77  nd not dts.who_w
-00015f40: 616e 7473 3a0a 2020 2020 2020 2020 2020  ants:.          
-00015f50: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
-00015f60: 656e 6461 7469 6f6e 735b 6474 732e 6b65  endations[dts.ke
-00015f70: 795d 203d 2022 7265 6c65 6173 6564 220a  y] = "released".
-00015f80: 2020 2020 2020 2020 7473 2e77 6169 7469          ts.waiti
-00015f90: 6e67 5f6f 6e2e 636c 6561 7228 290a 0a20  ng_on.clear().. 
-00015fa0: 2020 2020 2020 2074 732e 7374 6174 6520         ts.state 
-00015fb0: 3d20 2272 656c 6561 7365 6422 0a0a 2020  = "released"..  
-00015fc0: 2020 2020 2020 6966 2074 732e 6861 735f        if ts.has_
-00015fd0: 6c6f 7374 5f64 6570 656e 6465 6e63 6965  lost_dependencie
-00015fe0: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
-00015ff0: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b6b  ecommendations[k
-00016000: 6579 5d20 3d20 2266 6f72 676f 7474 656e  ey] = "forgotten
-00016010: 220a 2020 2020 2020 2020 656c 6966 206e  ".        elif n
-00016020: 6f74 2074 732e 6578 6365 7074 696f 6e5f  ot ts.exception_
-00016030: 626c 616d 6520 616e 6420 2874 732e 7768  blame and (ts.wh
-00016040: 6f5f 7761 6e74 7320 6f72 2074 732e 7761  o_wants or ts.wa
-00016050: 6974 6572 7329 3a0a 2020 2020 2020 2020  iters):.        
-00016060: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-00016070: 6f6e 735b 6b65 795d 203d 2022 7761 6974  ons[key] = "wait
-00016080: 696e 6722 0a20 2020 2020 2020 2065 6c73  ing".        els
-00016090: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
-000160a0: 732e 7761 6974 6572 732e 636c 6561 7228  s.waiters.clear(
-000160b0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-000160c0: 6e20 7265 636f 6d6d 656e 6461 7469 6f6e  n recommendation
-000160d0: 732c 207b 7d2c 207b 7d0a 0a20 2020 2064  s, {}, {}..    d
-000160e0: 6566 2074 7261 6e73 6974 696f 6e5f 7072  ef transition_pr
-000160f0: 6f63 6573 7369 6e67 5f72 656c 6561 7365  ocessing_release
-00016100: 6428 7365 6c66 2c20 6b65 793a 2073 7472  d(self, key: str
-00016110: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
-00016120: 7472 2920 2d3e 2052 6563 734d 7367 733a  tr) -> RecsMsgs:
-00016130: 0a20 2020 2020 2020 2074 7320 3d20 7365  .        ts = se
-00016140: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 2020  lf.tasks[key].  
-00016150: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-00016160: 7469 6f6e 733a 2052 6563 7320 3d20 7b7d  tions: Recs = {}
-00016170: 0a20 2020 2020 2020 2077 6f72 6b65 725f  .        worker_
-00016180: 6d73 6773 3a20 4d73 6773 203d 207b 7d0a  msgs: Msgs = {}.
-00016190: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-000161a0: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
-000161b0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-000161c0: 2e70 726f 6365 7373 696e 675f 6f6e 0a20  .processing_on. 
-000161d0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-000161e0: 7420 6e6f 7420 7473 2e77 686f 5f68 6173  t not ts.who_has
-000161f0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00016200: 6572 7420 6e6f 7420 7473 2e77 6169 7469  ert not ts.waiti
-00016210: 6e67 5f6f 6e0a 2020 2020 2020 2020 2020  ng_on.          
-00016220: 2020 6173 7365 7274 2074 732e 7374 6174    assert ts.stat
-00016230: 6520 3d3d 2022 7072 6f63 6573 7369 6e67  e == "processing
-00016240: 220a 0a20 2020 2020 2020 2077 7320 3d20  "..        ws = 
-00016250: 7365 6c66 2e5f 6578 6974 5f70 726f 6365  self._exit_proce
-00016260: 7373 696e 675f 636f 6d6d 6f6e 2874 7329  ssing_common(ts)
-00016270: 0a20 2020 2020 2020 2069 6620 7773 3a0a  .        if ws:.
-00016280: 2020 2020 2020 2020 2020 2020 776f 726b              work
-00016290: 6572 5f6d 7367 735b 7773 2e61 6464 7265  er_msgs[ws.addre
-000162a0: 7373 5d20 3d20 5b0a 2020 2020 2020 2020  ss] = [.        
-000162b0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-000162c0: 2020 2020 2020 2020 2020 2020 2020 226f                "o
-000162d0: 7022 3a20 2266 7265 652d 6b65 7973 222c  p": "free-keys",
-000162e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000162f0: 2020 2020 2022 6b65 7973 223a 205b 6b65       "keys": [ke
-00016300: 795d 2c0a 2020 2020 2020 2020 2020 2020  y],.            
-00016310: 2020 2020 2020 2020 2273 7469 6d75 6c75          "stimulu
-00016320: 735f 6964 223a 2073 7469 6d75 6c75 735f  s_id": stimulus_
-00016330: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-00016340: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00016350: 2020 5d0a 0a20 2020 2020 2020 2073 656c    ]..        sel
-00016360: 662e 5f70 726f 7061 6761 7465 5f72 656c  f._propagate_rel
-00016370: 6561 7365 6428 7473 2c20 7265 636f 6d6d  eased(ts, recomm
-00016380: 656e 6461 7469 6f6e 7329 0a20 2020 2020  endations).     
-00016390: 2020 2072 6574 7572 6e20 7265 636f 6d6d     return recomm
-000163a0: 656e 6461 7469 6f6e 732c 207b 7d2c 2077  endations, {}, w
-000163b0: 6f72 6b65 725f 6d73 6773 0a0a 2020 2020  orker_msgs..    
-000163c0: 6465 6620 7472 616e 7369 7469 6f6e 5f70  def transition_p
-000163d0: 726f 6365 7373 696e 675f 6572 7265 6428  rocessing_erred(
-000163e0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-000163f0: 2020 2020 2020 206b 6579 3a20 7374 722c         key: str,
-00016400: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
-00016410: 735f 6964 3a20 7374 722c 0a20 2020 2020  s_id: str,.     
-00016420: 2020 202a 2c0a 2020 2020 2020 2020 776f     *,.        wo
-00016430: 726b 6572 3a20 7374 722c 0a20 2020 2020  rker: str,.     
-00016440: 2020 2063 6175 7365 3a20 7374 7220 7c20     cause: str | 
-00016450: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-00016460: 2020 2020 2065 7863 6570 7469 6f6e 3a20       exception: 
-00016470: 5365 7269 616c 697a 6564 207c 204e 6f6e  Serialized | Non
-00016480: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-00016490: 2020 7472 6163 6562 6163 6b3a 2053 6572    traceback: Ser
-000164a0: 6961 6c69 7a65 6420 7c20 4e6f 6e65 203d  ialized | None =
-000164b0: 204e 6f6e 652c 0a20 2020 2020 2020 2065   None,.        e
-000164c0: 7863 6570 7469 6f6e 5f74 6578 743a 2073  xception_text: s
-000164d0: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
-000164e0: 2c0a 2020 2020 2020 2020 7472 6163 6562  ,.        traceb
-000164f0: 6163 6b5f 7465 7874 3a20 7374 7220 7c20  ack_text: str | 
-00016500: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-00016510: 2020 2020 202a 2a6b 7761 7267 733a 2041       **kwargs: A
-00016520: 6e79 2c0a 2020 2020 2920 2d3e 2052 6563  ny,.    ) -> Rec
-00016530: 734d 7367 733a 0a20 2020 2020 2020 2022  sMsgs:.        "
-00016540: 2222 5072 6f63 6573 7365 6420 6120 7265  ""Processed a re
-00016550: 636f 6d6d 656e 6465 6420 7472 616e 7369  commended transi
-00016560: 7469 6f6e 2070 726f 6365 7373 696e 6720  tion processing 
-00016570: 2d3e 2065 7272 6564 2e0a 0a20 2020 2020  -> erred...     
-00016580: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-00016590: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d        ----------
-000165a0: 0a20 2020 2020 2020 206b 6579 0a20 2020  .        key.   
-000165b0: 2020 2020 2020 2020 4b65 7920 6f66 2074          Key of t
-000165c0: 6865 2074 6173 6b20 746f 2074 7261 6e73  he task to trans
-000165d0: 6974 696f 6e0a 2020 2020 2020 2020 7374  ition.        st
-000165e0: 696d 756c 7573 5f69 640a 2020 2020 2020  imulus_id.      
-000165f0: 2020 2020 2020 4944 206f 6620 7468 6520        ID of the 
-00016600: 7374 696d 756c 7573 2063 6175 7369 6e67  stimulus causing
-00016610: 2074 6865 2074 7261 6e73 6974 696f 6e0a   the transition.
-00016620: 2020 2020 2020 2020 776f 726b 6572 0a20          worker. 
-00016630: 2020 2020 2020 2020 2020 2041 6464 7265             Addre
-00016640: 7373 206f 6620 7468 6520 776f 726b 6572  ss of the worker
-00016650: 2077 6865 7265 2074 6865 2074 6173 6b20   where the task 
-00016660: 6572 7265 642e 0a20 2020 2020 2020 2020  erred..         
-00016670: 2020 204e 6f74 206e 6563 6573 7361 7269     Not necessari
-00016680: 6c79 2060 6074 732e 7072 6f63 6573 7369  ly ``ts.processi
-00016690: 6e67 5f6f 6e60 602e 0a20 2020 2020 2020  ng_on``..       
-000166a0: 2063 6175 7365 0a20 2020 2020 2020 2020   cause.         
-000166b0: 2020 2041 6464 7265 7373 206f 6620 7468     Address of th
-000166c0: 6520 7461 736b 2074 6861 7420 6361 7573  e task that caus
-000166d0: 6564 2074 6869 7320 7461 736b 2074 6f20  ed this task to 
-000166e0: 6265 2074 7261 6e73 6974 696f 6e65 6420  be transitioned 
-000166f0: 746f 2065 7272 6564 0a20 2020 2020 2020  to erred.       
-00016700: 2065 7863 6570 7469 6f6e 0a20 2020 2020   exception.     
-00016710: 2020 2020 2020 2045 7863 6570 7469 6f6e         Exception
-00016720: 2063 6175 7365 6420 6279 2074 6865 2074   caused by the t
-00016730: 6173 6b0a 2020 2020 2020 2020 7472 6163  ask.        trac
-00016740: 6562 6163 6b0a 2020 2020 2020 2020 2020  eback.          
-00016750: 2020 5472 6163 6562 6163 6b20 6361 7573    Traceback caus
-00016760: 6564 2062 7920 7468 6520 7461 736b 0a20  ed by the task. 
-00016770: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
-00016780: 5f74 6578 740a 2020 2020 2020 2020 2020  _text.          
-00016790: 2020 5374 7269 6e67 2072 6570 7265 7365    String represe
-000167a0: 6e74 6174 696f 6e20 6f66 2074 6865 2065  ntation of the e
-000167b0: 7863 6570 7469 6f6e 0a20 2020 2020 2020  xception.       
-000167c0: 2074 7261 6365 6261 636b 5f74 6578 740a   traceback_text.
-000167d0: 2020 2020 2020 2020 2020 2020 5374 7269              Stri
-000167e0: 6e67 2072 6570 7265 7365 6e74 6174 696f  ng representatio
-000167f0: 6e20 6f66 2074 6865 2074 7261 6365 6261  n of the traceba
-00016800: 636b 0a0a 2020 2020 2020 2020 5265 7475  ck..        Retu
-00016810: 726e 730a 2020 2020 2020 2020 2d2d 2d2d  rns.        ----
-00016820: 2d2d 2d0a 2020 2020 2020 2020 5265 636f  ---.        Reco
-00016830: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
-00016840: 656e 7420 6d65 7373 6167 6573 2061 6e64  ent messages and
-00016850: 2077 6f72 6b65 7220 6d65 7373 6167 6573   worker messages
-00016860: 2074 6f20 7072 6f63 6573 730a 2020 2020   to process.    
-00016870: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00016880: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
-00016890: 6b65 795d 0a20 2020 2020 2020 2072 6563  key].        rec
-000168a0: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
-000168b0: 6373 203d 207b 7d0a 2020 2020 2020 2020  cs = {}.        
-000168c0: 636c 6965 6e74 5f6d 7367 733a 204d 7367  client_msgs: Msg
-000168d0: 7320 3d20 7b7d 0a0a 2020 2020 2020 2020  s = {}..        
-000168e0: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
-000168f0: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-00016900: 7365 7274 2063 6175 7365 206f 7220 7473  sert cause or ts
-00016910: 2e65 7863 6570 7469 6f6e 5f62 6c61 6d65  .exception_blame
-00016920: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00016930: 6572 7420 7473 2e70 726f 6365 7373 696e  ert ts.processin
-00016940: 675f 6f6e 0a20 2020 2020 2020 2020 2020  g_on.           
-00016950: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
-00016960: 686f 5f68 6173 0a20 2020 2020 2020 2020  ho_has.         
-00016970: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
-00016980: 2e77 6169 7469 6e67 5f6f 6e0a 0a20 2020  .waiting_on..   
-00016990: 2020 2020 2069 6620 7473 2e61 6374 6f72       if ts.actor
-000169a0: 3a0a 2020 2020 2020 2020 2020 2020 7773  :.            ws
-000169b0: 203d 2074 732e 7072 6f63 6573 7369 6e67   = ts.processing
-000169c0: 5f6f 6e0a 2020 2020 2020 2020 2020 2020  _on.            
-000169d0: 6173 7365 7274 2077 730a 2020 2020 2020  assert ws.      
-000169e0: 2020 2020 2020 7773 2e61 6374 6f72 732e        ws.actors.
-000169f0: 7265 6d6f 7665 2874 7329 0a0a 2020 2020  remove(ts)..    
-00016a00: 2020 2020 7365 6c66 2e5f 6578 6974 5f70      self._exit_p
-00016a10: 726f 6365 7373 696e 675f 636f 6d6d 6f6e  rocessing_common
-00016a20: 2874 7329 0a0a 2020 2020 2020 2020 7473  (ts)..        ts
-00016a30: 2e65 7272 6564 5f6f 6e2e 6164 6428 776f  .erred_on.add(wo
-00016a40: 726b 6572 290a 2020 2020 2020 2020 6966  rker).        if
-00016a50: 2065 7863 6570 7469 6f6e 2069 7320 6e6f   exception is no
-00016a60: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00016a70: 2020 2020 7473 2e65 7863 6570 7469 6f6e      ts.exception
-00016a80: 203d 2065 7863 6570 7469 6f6e 0a20 2020   = exception.   
-00016a90: 2020 2020 2020 2020 2074 732e 6578 6365           ts.exce
-00016aa0: 7074 696f 6e5f 7465 7874 203d 2065 7863  ption_text = exc
-00016ab0: 6570 7469 6f6e 5f74 6578 7420 2023 2074  eption_text  # t
-00016ac0: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
-00016ad0: 2020 2020 6966 2074 7261 6365 6261 636b      if traceback
-00016ae0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00016af0: 2020 2020 2020 2020 2020 7473 2e74 7261            ts.tra
-00016b00: 6365 6261 636b 203d 2074 7261 6365 6261  ceback = traceba
-00016b10: 636b 0a20 2020 2020 2020 2020 2020 2074  ck.            t
-00016b20: 732e 7472 6163 6562 6163 6b5f 7465 7874  s.traceback_text
-00016b30: 203d 2074 7261 6365 6261 636b 5f74 6578   = traceback_tex
-00016b40: 7420 2023 2074 7970 653a 2069 676e 6f72  t  # type: ignor
-00016b50: 650a 2020 2020 2020 2020 6966 2063 6175  e.        if cau
-00016b60: 7365 2069 7320 6e6f 7420 4e6f 6e65 3a0a  se is not None:.
-00016b70: 2020 2020 2020 2020 2020 2020 6661 696c              fail
-00016b80: 696e 675f 7473 203d 2073 656c 662e 7461  ing_ts = self.ta
-00016b90: 736b 735b 6361 7573 655d 0a20 2020 2020  sks[cause].     
-00016ba0: 2020 2020 2020 2074 732e 6578 6365 7074         ts.except
-00016bb0: 696f 6e5f 626c 616d 6520 3d20 6661 696c  ion_blame = fail
-00016bc0: 696e 675f 7473 0a20 2020 2020 2020 2065  ing_ts.        e
-00016bd0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00016be0: 2066 6169 6c69 6e67 5f74 7320 3d20 7473   failing_ts = ts
-00016bf0: 2e65 7863 6570 7469 6f6e 5f62 6c61 6d65  .exception_blame
-00016c00: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
-00016c10: 0a0a 2020 2020 2020 2020 7365 6c66 2e65  ..        self.e
-00016c20: 7272 6564 5f74 6173 6b73 2e61 7070 656e  rred_tasks.appen
-00016c30: 646c 6566 7428 0a20 2020 2020 2020 2020  dleft(.         
-00016c40: 2020 2045 7272 6564 5461 736b 280a 2020     ErredTask(.  
-00016c50: 2020 2020 2020 2020 2020 2020 2020 7473                ts
-00016c60: 2e6b 6579 2c0a 2020 2020 2020 2020 2020  .key,.          
-00016c70: 2020 2020 2020 7469 6d65 2829 2c0a 2020        time(),.  
-00016c80: 2020 2020 2020 2020 2020 2020 2020 7473                ts
-00016c90: 2e65 7272 6564 5f6f 6e2e 636f 7079 2829  .erred_on.copy()
-00016ca0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00016cb0: 2020 6578 6365 7074 696f 6e5f 7465 7874    exception_text
-00016cc0: 206f 7220 2222 2c0a 2020 2020 2020 2020   or "",.        
-00016cd0: 2020 2020 2020 2020 7472 6163 6562 6163          tracebac
-00016ce0: 6b5f 7465 7874 206f 7220 2222 2c0a 2020  k_text or "",.  
-00016cf0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00016d00: 2020 2020 290a 0a20 2020 2020 2020 2066      )..        f
-00016d10: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
-00016d20: 656e 6465 6e74 733a 0a20 2020 2020 2020  endents:.       
-00016d30: 2020 2020 2064 7473 2e65 7863 6570 7469       dts.excepti
-00016d40: 6f6e 5f62 6c61 6d65 203d 2066 6169 6c69  on_blame = faili
-00016d50: 6e67 5f74 730a 2020 2020 2020 2020 2020  ng_ts.          
-00016d60: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-00016d70: 735b 6474 732e 6b65 795d 203d 2022 6572  s[dts.key] = "er
-00016d80: 7265 6422 0a0a 2020 2020 2020 2020 666f  red"..        fo
-00016d90: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
-00016da0: 6e64 656e 6369 6573 3a0a 2020 2020 2020  ndencies:.      
-00016db0: 2020 2020 2020 6474 732e 7761 6974 6572        dts.waiter
-00016dc0: 732e 6469 7363 6172 6428 7473 290a 2020  s.discard(ts).  
-00016dd0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-00016de0: 2064 7473 2e77 6169 7465 7273 2061 6e64   dts.waiters and
-00016df0: 206e 6f74 2064 7473 2e77 686f 5f77 616e   not dts.who_wan
-00016e00: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-00016e10: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-00016e20: 6f6e 735b 6474 732e 6b65 795d 203d 2022  ons[dts.key] = "
-00016e30: 7265 6c65 6173 6564 220a 0a20 2020 2020  released"..     
-00016e40: 2020 2074 732e 7761 6974 6572 732e 636c     ts.waiters.cl
-00016e50: 6561 7228 2920 2023 2064 6f20 616e 7974  ear()  # do anyt
-00016e60: 6869 6e67 2077 6974 6820 7468 6973 3f0a  hing with this?.
-00016e70: 0a20 2020 2020 2020 2074 732e 7374 6174  .        ts.stat
-00016e80: 6520 3d20 2265 7272 6564 220a 0a20 2020  e = "erred"..   
-00016e90: 2020 2020 2072 6570 6f72 745f 6d73 6720       report_msg 
-00016ea0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-00016eb0: 226f 7022 3a20 2274 6173 6b2d 6572 7265  "op": "task-erre
-00016ec0: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
-00016ed0: 226b 6579 223a 206b 6579 2c0a 2020 2020  "key": key,.    
-00016ee0: 2020 2020 2020 2020 2265 7863 6570 7469          "excepti
-00016ef0: 6f6e 223a 2066 6169 6c69 6e67 5f74 732e  on": failing_ts.
-00016f00: 6578 6365 7074 696f 6e2c 0a20 2020 2020  exception,.     
-00016f10: 2020 2020 2020 2022 7472 6163 6562 6163         "tracebac
-00016f20: 6b22 3a20 6661 696c 696e 675f 7473 2e74  k": failing_ts.t
-00016f30: 7261 6365 6261 636b 2c0a 2020 2020 2020  raceback,.      
-00016f40: 2020 7d0a 2020 2020 2020 2020 666f 7220    }.        for 
-00016f50: 6373 2069 6e20 7473 2e77 686f 5f77 616e  cs in ts.who_wan
-00016f60: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-00016f70: 636c 6965 6e74 5f6d 7367 735b 6373 2e63  client_msgs[cs.c
-00016f80: 6c69 656e 745f 6b65 795d 203d 205b 7265  lient_key] = [re
-00016f90: 706f 7274 5f6d 7367 5d0a 0a20 2020 2020  port_msg]..     
-00016fa0: 2020 2063 7320 3d20 7365 6c66 2e63 6c69     cs = self.cli
-00016fb0: 656e 7473 5b22 6669 7265 2d61 6e64 2d66  ents["fire-and-f
-00016fc0: 6f72 6765 7422 5d0a 2020 2020 2020 2020  orget"].        
-00016fd0: 6966 2074 7320 696e 2063 732e 7761 6e74  if ts in cs.want
-00016fe0: 735f 7768 6174 3a0a 2020 2020 2020 2020  s_what:.        
-00016ff0: 2020 2020 7365 6c66 2e5f 636c 6965 6e74      self._client
-00017000: 5f72 656c 6561 7365 735f 6b65 7973 280a  _releases_keys(.
-00017010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017020: 6373 3d63 732c 0a20 2020 2020 2020 2020  cs=cs,.         
-00017030: 2020 2020 2020 206b 6579 733d 5b6b 6579         keys=[key
-00017040: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00017050: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
-00017060: 6e73 3d72 6563 6f6d 6d65 6e64 6174 696f  ns=recommendatio
-00017070: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
-00017080: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
-00017090: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
-000170a0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-000170b0: 6e6f 7420 7473 2e70 726f 6365 7373 696e  not ts.processin
-000170c0: 675f 6f6e 0a0a 2020 2020 2020 2020 7265  g_on..        re
-000170d0: 7475 726e 2072 6563 6f6d 6d65 6e64 6174  turn recommendat
-000170e0: 696f 6e73 2c20 636c 6965 6e74 5f6d 7367  ions, client_msg
-000170f0: 732c 207b 7d0a 0a20 2020 2064 6566 2074  s, {}..    def t
-00017100: 7261 6e73 6974 696f 6e5f 6e6f 5f77 6f72  ransition_no_wor
-00017110: 6b65 725f 7265 6c65 6173 6564 2873 656c  ker_released(sel
-00017120: 662c 206b 6579 3a20 7374 722c 2073 7469  f, key: str, sti
-00017130: 6d75 6c75 735f 6964 3a20 7374 7229 202d  mulus_id: str) -
-00017140: 3e20 5265 6373 4d73 6773 3a0a 2020 2020  > RecsMsgs:.    
-00017150: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-00017160: 736b 735b 6b65 795d 0a0a 2020 2020 2020  sks[key]..      
-00017170: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
-00017180: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
-00017190: 6173 7365 7274 2073 656c 662e 7461 736b  assert self.task
-000171a0: 735b 6b65 795d 2e73 7461 7465 203d 3d20  s[key].state == 
-000171b0: 226e 6f2d 776f 726b 6572 220a 2020 2020  "no-worker".    
-000171c0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-000171d0: 6f74 2074 732e 7768 6f5f 6861 730a 2020  ot ts.who_has.  
-000171e0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-000171f0: 206e 6f74 2074 732e 7761 6974 696e 675f   not ts.waiting_
-00017200: 6f6e 0a0a 2020 2020 2020 2020 7365 6c66  on..        self
-00017210: 2e75 6e72 756e 6e61 626c 652e 7265 6d6f  .unrunnable.remo
-00017220: 7665 2874 7329 0a20 2020 2020 2020 2074  ve(ts).        t
-00017230: 732e 7374 6174 6520 3d20 2272 656c 6561  s.state = "relea
-00017240: 7365 6422 0a0a 2020 2020 2020 2020 666f  sed"..        fo
-00017250: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
-00017260: 6e64 656e 6369 6573 3a0a 2020 2020 2020  ndencies:.      
-00017270: 2020 2020 2020 6474 732e 7761 6974 6572        dts.waiter
-00017280: 732e 6469 7363 6172 6428 7473 290a 0a20  s.discard(ts).. 
-00017290: 2020 2020 2020 2074 732e 7761 6974 6572         ts.waiter
-000172a0: 732e 636c 6561 7228 290a 0a20 2020 2020  s.clear()..     
-000172b0: 2020 2072 6574 7572 6e20 7b7d 2c20 7b7d     return {}, {}
-000172c0: 2c20 7b7d 0a0a 2020 2020 6465 6620 7472  , {}..    def tr
-000172d0: 616e 7369 7469 6f6e 5f77 6169 7469 6e67  ansition_waiting
-000172e0: 5f71 7565 7565 6428 7365 6c66 2c20 6b65  _queued(self, ke
-000172f0: 793a 2073 7472 2c20 7374 696d 756c 7573  y: str, stimulus
-00017300: 5f69 643a 2073 7472 2920 2d3e 2052 6563  _id: str) -> Rec
-00017310: 734d 7367 733a 0a20 2020 2020 2020 2074  sMsgs:.        t
-00017320: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
-00017330: 6579 5d0a 0a20 2020 2020 2020 2069 6620  ey]..        if 
-00017340: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
-00017350: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00017360: 7420 6e6f 7420 7365 6c66 2e69 646c 655f  t not self.idle_
-00017370: 7461 736b 5f63 6f75 6e74 2c20 2874 732c  task_count, (ts,
-00017380: 2073 656c 662e 6964 6c65 5f74 6173 6b5f   self.idle_task_
-00017390: 636f 756e 7429 0a20 2020 2020 2020 2020  count).         
-000173a0: 2020 2073 656c 662e 5f76 616c 6964 6174     self._validat
-000173b0: 655f 7265 6164 7928 7473 290a 0a20 2020  e_ready(ts)..   
-000173c0: 2020 2020 2074 732e 7374 6174 6520 3d20       ts.state = 
-000173d0: 2271 7565 7565 6422 0a20 2020 2020 2020  "queued".       
-000173e0: 2073 656c 662e 7175 6575 6564 2e61 6464   self.queued.add
-000173f0: 2874 7329 0a0a 2020 2020 2020 2020 7265  (ts)..        re
-00017400: 7475 726e 207b 7d2c 207b 7d2c 207b 7d0a  turn {}, {}, {}.
-00017410: 0a20 2020 2064 6566 2074 7261 6e73 6974  .    def transit
-00017420: 696f 6e5f 7761 6974 696e 675f 6e6f 5f77  ion_waiting_no_w
-00017430: 6f72 6b65 7228 7365 6c66 2c20 6b65 793a  orker(self, key:
-00017440: 2073 7472 2c20 7374 696d 756c 7573 5f69   str, stimulus_i
-00017450: 643a 2073 7472 2920 2d3e 2052 6563 734d  d: str) -> RecsM
-00017460: 7367 733a 0a20 2020 2020 2020 2074 7320  sgs:.        ts 
-00017470: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-00017480: 5d0a 0a20 2020 2020 2020 2069 6620 7365  ]..        if se
-00017490: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
-000174a0: 2020 2020 2020 2020 2073 656c 662e 5f76           self._v
-000174b0: 616c 6964 6174 655f 7265 6164 7928 7473  alidate_ready(ts
-000174c0: 290a 0a20 2020 2020 2020 2074 732e 7374  )..        ts.st
-000174d0: 6174 6520 3d20 226e 6f2d 776f 726b 6572  ate = "no-worker
-000174e0: 220a 2020 2020 2020 2020 7365 6c66 2e75  ".        self.u
-000174f0: 6e72 756e 6e61 626c 652e 6164 6428 7473  nrunnable.add(ts
-00017500: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-00017510: 6e20 7b7d 2c20 7b7d 2c20 7b7d 0a0a 2020  n {}, {}, {}..  
-00017520: 2020 6465 6620 7472 616e 7369 7469 6f6e    def transition
-00017530: 5f71 7565 7565 645f 7265 6c65 6173 6564  _queued_released
-00017540: 2873 656c 662c 206b 6579 3a20 7374 722c  (self, key: str,
-00017550: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
-00017560: 7229 202d 3e20 5265 6373 4d73 6773 3a0a  r) -> RecsMsgs:.
-00017570: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-00017580: 662e 7461 736b 735b 6b65 795d 0a0a 2020  f.tasks[key]..  
-00017590: 2020 2020 2020 6966 2073 656c 662e 7661        if self.va
-000175a0: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
-000175b0: 2020 2020 6173 7365 7274 2074 7320 696e      assert ts in
-000175c0: 2073 656c 662e 7175 6575 6564 0a20 2020   self.queued.   
-000175d0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-000175e0: 6e6f 7420 7473 2e70 726f 6365 7373 696e  not ts.processin
-000175f0: 675f 6f6e 0a0a 2020 2020 2020 2020 7365  g_on..        se
-00017600: 6c66 2e71 7565 7565 642e 7265 6d6f 7665  lf.queued.remove
-00017610: 2874 7329 0a0a 2020 2020 2020 2020 7265  (ts)..        re
-00017620: 636f 6d6d 656e 6461 7469 6f6e 733a 2052  commendations: R
-00017630: 6563 7320 3d20 7b7d 0a20 2020 2020 2020  ecs = {}.       
-00017640: 2073 656c 662e 5f70 726f 7061 6761 7465   self._propagate
-00017650: 5f72 656c 6561 7365 6428 7473 2c20 7265  _released(ts, re
-00017660: 636f 6d6d 656e 6461 7469 6f6e 7329 0a20  commendations). 
-00017670: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-00017680: 636f 6d6d 656e 6461 7469 6f6e 732c 207b  commendations, {
-00017690: 7d2c 207b 7d0a 0a20 2020 2064 6566 2074  }, {}..    def t
-000176a0: 7261 6e73 6974 696f 6e5f 7175 6575 6564  ransition_queued
-000176b0: 5f70 726f 6365 7373 696e 6728 7365 6c66  _processing(self
-000176c0: 2c20 6b65 793a 2073 7472 2c20 7374 696d  , key: str, stim
-000176d0: 756c 7573 5f69 643a 2073 7472 2920 2d3e  ulus_id: str) ->
-000176e0: 2052 6563 734d 7367 733a 0a20 2020 2020   RecsMsgs:.     
-000176f0: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
-00017700: 6b73 5b6b 6579 5d0a 2020 2020 2020 2020  ks[key].        
-00017710: 7265 636f 6d6d 656e 6461 7469 6f6e 733a  recommendations:
-00017720: 2052 6563 7320 3d20 7b7d 0a20 2020 2020   Recs = {}.     
-00017730: 2020 2077 6f72 6b65 725f 6d73 6773 3a20     worker_msgs: 
-00017740: 4d73 6773 203d 207b 7d0a 0a20 2020 2020  Msgs = {}..     
-00017750: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
-00017760: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
-00017770: 2061 7373 6572 7420 6e6f 7420 7473 2e61   assert not ts.a
-00017780: 6374 6f72 2c20 6622 4163 746f 7273 2063  ctor, f"Actors c
-00017790: 616e 2774 2062 6520 7175 6575 6564 3a20  an't be queued: 
-000177a0: 7b74 737d 220a 2020 2020 2020 2020 2020  {ts}".          
-000177b0: 2020 6173 7365 7274 2074 7320 696e 2073    assert ts in s
-000177c0: 656c 662e 7175 6575 6564 0a0a 2020 2020  elf.queued..    
-000177d0: 2020 2020 6966 2077 7320 3a3d 2073 656c      if ws := sel
-000177e0: 662e 6465 6369 6465 5f77 6f72 6b65 725f  f.decide_worker_
-000177f0: 726f 6f74 6973 685f 7175 6575 696e 675f  rootish_queuing_
-00017800: 656e 6162 6c65 6428 293a 0a20 2020 2020  enabled():.     
-00017810: 2020 2020 2020 2073 656c 662e 7175 6575         self.queu
-00017820: 6564 2e64 6973 6361 7264 2874 7329 0a20  ed.discard(ts). 
-00017830: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
-00017840: 725f 6d73 6773 203d 2073 656c 662e 5f61  r_msgs = self._a
-00017850: 6464 5f74 6f5f 7072 6f63 6573 7369 6e67  dd_to_processing
-00017860: 2874 732c 2077 7329 0a20 2020 2020 2020  (ts, ws).       
-00017870: 2023 2049 6620 6e6f 2077 6f72 6b65 722c   # If no worker,
-00017880: 2074 6173 6b20 6a75 7374 2073 7461 7973   task just stays
-00017890: 2060 7175 6575 6564 600a 0a20 2020 2020   `queued`..     
-000178a0: 2020 2072 6574 7572 6e20 7265 636f 6d6d     return recomm
-000178b0: 656e 6461 7469 6f6e 732c 207b 7d2c 2077  endations, {}, w
-000178c0: 6f72 6b65 725f 6d73 6773 0a0a 2020 2020  orker_msgs..    
-000178d0: 6465 6620 5f72 656d 6f76 655f 6b65 7928  def _remove_key(
-000178e0: 7365 6c66 2c20 6b65 793a 2073 7472 2920  self, key: str) 
-000178f0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00017900: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
-00017910: 2e70 6f70 286b 6579 290a 2020 2020 2020  .pop(key).      
-00017920: 2020 6173 7365 7274 2074 732e 7374 6174    assert ts.stat
-00017930: 6520 3d3d 2022 666f 7267 6f74 7465 6e22  e == "forgotten"
-00017940: 0a20 2020 2020 2020 2073 656c 662e 756e  .        self.un
-00017950: 7275 6e6e 6162 6c65 2e64 6973 6361 7264  runnable.discard
-00017960: 2874 7329 0a20 2020 2020 2020 2066 6f72  (ts).        for
-00017970: 2063 7320 696e 2074 732e 7768 6f5f 7761   cs in ts.who_wa
-00017980: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
-00017990: 2063 732e 7761 6e74 735f 7768 6174 2e72   cs.wants_what.r
-000179a0: 656d 6f76 6528 7473 290a 2020 2020 2020  emove(ts).      
-000179b0: 2020 7473 2e77 686f 5f77 616e 7473 2e63    ts.who_wants.c
-000179c0: 6c65 6172 2829 0a20 2020 2020 2020 2074  lear().        t
-000179d0: 732e 7072 6f63 6573 7369 6e67 5f6f 6e20  s.processing_on 
-000179e0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2074  = None.        t
-000179f0: 732e 6578 6365 7074 696f 6e5f 626c 616d  s.exception_blam
-00017a00: 6520 3d20 7473 2e65 7863 6570 7469 6f6e  e = ts.exception
-00017a10: 203d 2074 732e 7472 6163 6562 6163 6b20   = ts.traceback 
-00017a20: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
-00017a30: 656c 662e 7461 736b 5f6d 6574 6164 6174  elf.task_metadat
-00017a40: 612e 706f 7028 6b65 792c 204e 6f6e 6529  a.pop(key, None)
-00017a50: 0a0a 2020 2020 6465 6620 7472 616e 7369  ..    def transi
-00017a60: 7469 6f6e 5f6d 656d 6f72 795f 666f 7267  tion_memory_forg
-00017a70: 6f74 7465 6e28 7365 6c66 2c20 6b65 793a  otten(self, key:
-00017a80: 2073 7472 2c20 7374 696d 756c 7573 5f69   str, stimulus_i
-00017a90: 643a 2073 7472 2920 2d3e 2052 6563 734d  d: str) -> RecsM
-00017aa0: 7367 733a 0a20 2020 2020 2020 2074 7320  sgs:.        ts 
-00017ab0: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-00017ac0: 5d0a 0a20 2020 2020 2020 2069 6620 7365  ]..        if se
-00017ad0: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
-00017ae0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00017af0: 7473 2e73 7461 7465 203d 3d20 226d 656d  ts.state == "mem
-00017b00: 6f72 7922 0a20 2020 2020 2020 2020 2020  ory".           
-00017b10: 2061 7373 6572 7420 6e6f 7420 7473 2e70   assert not ts.p
-00017b20: 726f 6365 7373 696e 675f 6f6e 0a20 2020  rocessing_on.   
-00017b30: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00017b40: 6e6f 7420 7473 2e77 6169 7469 6e67 5f6f  not ts.waiting_o
-00017b50: 6e0a 2020 2020 2020 2020 2020 2020 6966  n.            if
-00017b60: 206e 6f74 2074 732e 7275 6e5f 7370 6563   not ts.run_spec
-00017b70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00017b80: 2020 2320 4974 2773 206f 6b20 746f 2066    # It's ok to f
-00017b90: 6f72 6765 7420 6120 7075 7265 2064 6174  orget a pure dat
-00017ba0: 6120 7461 736b 0a20 2020 2020 2020 2020  a task.         
-00017bb0: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
-00017bc0: 2020 2020 2020 2020 656c 6966 2074 732e          elif ts.
-00017bd0: 6861 735f 6c6f 7374 5f64 6570 656e 6465  has_lost_depende
-00017be0: 6e63 6965 733a 0a20 2020 2020 2020 2020  ncies:.         
-00017bf0: 2020 2020 2020 2023 2049 7427 7320 6f6b         # It's ok
-00017c00: 2074 6f20 666f 7267 6574 2061 2074 6173   to forget a tas
-00017c10: 6b20 7769 7468 2066 6f72 676f 7474 656e  k with forgotten
-00017c20: 2064 6570 656e 6465 6e63 6965 730a 2020   dependencies.  
-00017c30: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-00017c40: 7373 0a20 2020 2020 2020 2020 2020 2065  ss.            e
-00017c50: 6c69 6620 6e6f 7420 7473 2e77 686f 5f77  lif not ts.who_w
-00017c60: 616e 7473 2061 6e64 206e 6f74 2074 732e  ants and not ts.
-00017c70: 7761 6974 6572 7320 616e 6420 6e6f 7420  waiters and not 
-00017c80: 7473 2e64 6570 656e 6465 6e74 733a 0a20  ts.dependents:. 
-00017c90: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00017ca0: 2049 7427 7320 6f6b 2074 6f20 666f 7267   It's ok to forg
-00017cb0: 6574 2061 2074 6173 6b20 7468 6174 206e  et a task that n
-00017cc0: 6f62 6f64 7920 6e65 6564 730a 2020 2020  obody needs.    
-00017cd0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-00017ce0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00017cf0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00017d00: 2020 2072 6169 7365 2041 7373 6572 7469     raise Asserti
-00017d10: 6f6e 4572 726f 7228 2255 6e72 6561 6368  onError("Unreach
-00017d20: 6162 6c65 222c 2074 7329 2020 2320 7072  able", ts)  # pr
-00017d30: 6167 6d61 3a20 6e6f 636f 7665 720a 0a20  agma: nocover.. 
-00017d40: 2020 2020 2020 2069 6620 7473 2e61 6374         if ts.act
-00017d50: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-00017d60: 666f 7220 7773 2069 6e20 7473 2e77 686f  for ws in ts.who
-00017d70: 5f68 6173 3a0a 2020 2020 2020 2020 2020  _has:.          
-00017d80: 2020 2020 2020 7773 2e61 6374 6f72 732e        ws.actors.
-00017d90: 6469 7363 6172 6428 7473 290a 0a20 2020  discard(ts)..   
-00017da0: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-00017db0: 696f 6e73 3a20 5265 6373 203d 207b 7d0a  ions: Recs = {}.
-00017dc0: 2020 2020 2020 2020 776f 726b 6572 5f6d          worker_m
-00017dd0: 7367 733a 204d 7367 7320 3d20 7b7d 0a20  sgs: Msgs = {}. 
-00017de0: 2020 2020 2020 2073 656c 662e 5f70 726f         self._pro
-00017df0: 7061 6761 7465 5f66 6f72 676f 7474 656e  pagate_forgotten
-00017e00: 2874 732c 2072 6563 6f6d 6d65 6e64 6174  (ts, recommendat
-00017e10: 696f 6e73 2c20 776f 726b 6572 5f6d 7367  ions, worker_msg
-00017e20: 732c 2073 7469 6d75 6c75 735f 6964 290a  s, stimulus_id).
-00017e30: 0a20 2020 2020 2020 2063 6c69 656e 745f  .        client_
-00017e40: 6d73 6773 203d 205f 7461 736b 5f74 6f5f  msgs = _task_to_
-00017e50: 636c 6965 6e74 5f6d 7367 7328 7473 290a  client_msgs(ts).
-00017e60: 2020 2020 2020 2020 7365 6c66 2e5f 7265          self._re
-00017e70: 6d6f 7665 5f6b 6579 286b 6579 290a 0a20  move_key(key).. 
-00017e80: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-00017e90: 636f 6d6d 656e 6461 7469 6f6e 732c 2063  commendations, c
-00017ea0: 6c69 656e 745f 6d73 6773 2c20 776f 726b  lient_msgs, work
-00017eb0: 6572 5f6d 7367 730a 0a20 2020 2064 6566  er_msgs..    def
-00017ec0: 2074 7261 6e73 6974 696f 6e5f 7265 6c65   transition_rele
-00017ed0: 6173 6564 5f66 6f72 676f 7474 656e 2873  ased_forgotten(s
-00017ee0: 656c 662c 206b 6579 3a20 7374 722c 2073  elf, key: str, s
-00017ef0: 7469 6d75 6c75 735f 6964 3a20 7374 7229  timulus_id: str)
-00017f00: 202d 3e20 5265 6373 4d73 6773 3a0a 2020   -> RecsMsgs:.  
-00017f10: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
-00017f20: 7461 736b 735b 6b65 795d 0a0a 2020 2020  tasks[key]..    
-00017f30: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
-00017f40: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
-00017f50: 2020 6173 7365 7274 2074 732e 7374 6174    assert ts.stat
-00017f60: 6520 696e 2028 2272 656c 6561 7365 6422  e in ("released"
-00017f70: 2c20 2265 7272 6564 2229 0a20 2020 2020  , "erred").     
-00017f80: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-00017f90: 7420 7473 2e77 686f 5f68 6173 0a20 2020  t ts.who_has.   
-00017fa0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00017fb0: 6e6f 7420 7473 2e70 726f 6365 7373 696e  not ts.processin
-00017fc0: 675f 6f6e 0a20 2020 2020 2020 2020 2020  g_on.           
-00017fd0: 2061 7373 6572 7420 7473 206e 6f74 2069   assert ts not i
-00017fe0: 6e20 7365 6c66 2e71 7565 7565 640a 2020  n self.queued.  
-00017ff0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00018000: 206e 6f74 2074 732e 7761 6974 696e 675f   not ts.waiting_
-00018010: 6f6e 2c20 2874 732c 2074 732e 7761 6974  on, (ts, ts.wait
-00018020: 696e 675f 6f6e 290a 2020 2020 2020 2020  ing_on).        
-00018030: 2020 2020 6966 206e 6f74 2074 732e 7275      if not ts.ru
-00018040: 6e5f 7370 6563 3a0a 2020 2020 2020 2020  n_spec:.        
-00018050: 2020 2020 2020 2020 2320 4974 2773 206f          # It's o
-00018060: 6b20 746f 2066 6f72 6765 7420 6120 7075  k to forget a pu
-00018070: 7265 2064 6174 6120 7461 736b 0a20 2020  re data task.   
-00018080: 2020 2020 2020 2020 2020 2020 2070 6173               pas
-00018090: 730a 2020 2020 2020 2020 2020 2020 656c  s.            el
-000180a0: 6966 2074 732e 6861 735f 6c6f 7374 5f64  if ts.has_lost_d
-000180b0: 6570 656e 6465 6e63 6965 733a 0a20 2020  ependencies:.   
-000180c0: 2020 2020 2020 2020 2020 2020 2023 2049               # I
-000180d0: 7427 7320 6f6b 2074 6f20 666f 7267 6574  t's ok to forget
-000180e0: 2061 2074 6173 6b20 7769 7468 2066 6f72   a task with for
-000180f0: 676f 7474 656e 2064 6570 656e 6465 6e63  gotten dependenc
-00018100: 6965 730a 2020 2020 2020 2020 2020 2020  ies.            
-00018110: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
-00018120: 2020 2020 2065 6c69 6620 6e6f 7420 7473       elif not ts
-00018130: 2e77 686f 5f77 616e 7473 2061 6e64 206e  .who_wants and n
-00018140: 6f74 2074 732e 7761 6974 6572 7320 616e  ot ts.waiters an
-00018150: 6420 6e6f 7420 7473 2e64 6570 656e 6465  d not ts.depende
-00018160: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
-00018170: 2020 2020 2023 2049 7427 7320 6f6b 2074       # It's ok t
-00018180: 6f20 666f 7267 6574 2061 2074 6173 6b20  o forget a task 
-00018190: 7468 6174 206e 6f62 6f64 7920 6e65 6564  that nobody need
-000181a0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-000181b0: 2020 7061 7373 0a20 2020 2020 2020 2020    pass.         
-000181c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000181d0: 2020 2020 2020 2020 2072 6169 7365 2041           raise A
-000181e0: 7373 6572 7469 6f6e 4572 726f 7228 2255  ssertionError("U
-000181f0: 6e72 6561 6368 6162 6c65 222c 2073 7472  nreachable", str
-00018200: 2874 7329 2920 2023 2070 7261 676d 613a  (ts))  # pragma:
-00018210: 206e 6f63 6f76 6572 0a0a 2020 2020 2020   nocover..      
-00018220: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-00018230: 733a 2052 6563 7320 3d20 7b7d 0a20 2020  s: Recs = {}.   
-00018240: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
-00018250: 3a20 4d73 6773 203d 207b 7d0a 2020 2020  : Msgs = {}.    
-00018260: 2020 2020 7365 6c66 2e5f 7072 6f70 6167      self._propag
-00018270: 6174 655f 666f 7267 6f74 7465 6e28 7473  ate_forgotten(ts
-00018280: 2c20 7265 636f 6d6d 656e 6461 7469 6f6e  , recommendation
-00018290: 732c 2077 6f72 6b65 725f 6d73 6773 2c20  s, worker_msgs, 
-000182a0: 7374 696d 756c 7573 5f69 6429 0a0a 2020  stimulus_id)..  
-000182b0: 2020 2020 2020 636c 6965 6e74 5f6d 7367        client_msg
-000182c0: 7320 3d20 5f74 6173 6b5f 746f 5f63 6c69  s = _task_to_cli
-000182d0: 656e 745f 6d73 6773 2874 7329 0a20 2020  ent_msgs(ts).   
-000182e0: 2020 2020 2073 656c 662e 5f72 656d 6f76       self._remov
-000182f0: 655f 6b65 7928 6b65 7929 0a0a 2020 2020  e_key(key)..    
-00018300: 2020 2020 7265 7475 726e 2072 6563 6f6d      return recom
-00018310: 6d65 6e64 6174 696f 6e73 2c20 636c 6965  mendations, clie
-00018320: 6e74 5f6d 7367 732c 2077 6f72 6b65 725f  nt_msgs, worker_
-00018330: 6d73 6773 0a0a 2020 2020 2320 7b0a 2020  msgs..    # {.  
-00018340: 2020 2320 2020 2020 2873 7461 7274 2c20    #     (start, 
-00018350: 6669 6e69 7368 293a 0a20 2020 2023 2020  finish):.    #  
-00018360: 2020 2074 7261 6e73 6974 696f 6e5f 3c73     transition_<s
-00018370: 7461 7274 3e5f 3c66 696e 6973 683e 280a  tart>_<finish>(.
-00018380: 2020 2020 2320 2020 2020 2020 2020 7365      #         se
-00018390: 6c66 2c20 6b65 793a 2073 7472 2c20 7374  lf, key: str, st
-000183a0: 696d 756c 7573 5f69 643a 2073 7472 2c20  imulus_id: str, 
-000183b0: 2a2a 6b77 6172 6773 0a20 2020 2023 2020  **kwargs.    #  
-000183c0: 2020 2029 202d 3e20 2872 6563 6f6d 6d65     ) -> (recomme
-000183d0: 6e64 6174 696f 6e73 2c20 636c 6965 6e74  ndations, client
-000183e0: 5f6d 7367 732c 2077 6f72 6b65 725f 6d73  _msgs, worker_ms
-000183f0: 6773 290a 2020 2020 2320 7d0a 2020 2020  gs).    # }.    
-00018400: 5f54 5241 4e53 4954 494f 4e53 5f54 4142  _TRANSITIONS_TAB
-00018410: 4c45 3a20 436c 6173 7356 6172 5b0a 2020  LE: ClassVar[.  
-00018420: 2020 2020 2020 4d61 7070 696e 675b 0a20        Mapping[. 
-00018430: 2020 2020 2020 2020 2020 2074 7570 6c65             tuple
-00018440: 5b54 6173 6b53 7461 7465 5374 6174 652c  [TaskStateState,
-00018450: 2054 6173 6b53 7461 7465 5374 6174 655d   TaskStateState]
-00018460: 2c0a 2020 2020 2020 2020 2020 2020 4361  ,.            Ca
-00018470: 6c6c 6162 6c65 5b2e 2e2e 2c20 5265 6373  llable[..., Recs
-00018480: 4d73 6773 5d2c 0a20 2020 2020 2020 205d  Msgs],.        ]
-00018490: 0a20 2020 205d 203d 207b 0a20 2020 2020  .    ] = {.     
-000184a0: 2020 2028 2272 656c 6561 7365 6422 2c20     ("released", 
-000184b0: 2277 6169 7469 6e67 2229 3a20 7472 616e  "waiting"): tran
-000184c0: 7369 7469 6f6e 5f72 656c 6561 7365 645f  sition_released_
-000184d0: 7761 6974 696e 672c 0a20 2020 2020 2020  waiting,.       
-000184e0: 2028 2277 6169 7469 6e67 222c 2022 7265   ("waiting", "re
-000184f0: 6c65 6173 6564 2229 3a20 7472 616e 7369  leased"): transi
-00018500: 7469 6f6e 5f77 6169 7469 6e67 5f72 656c  tion_waiting_rel
-00018510: 6561 7365 642c 0a20 2020 2020 2020 2028  eased,.        (
-00018520: 2277 6169 7469 6e67 222c 2022 7072 6f63  "waiting", "proc
-00018530: 6573 7369 6e67 2229 3a20 7472 616e 7369  essing"): transi
-00018540: 7469 6f6e 5f77 6169 7469 6e67 5f70 726f  tion_waiting_pro
-00018550: 6365 7373 696e 672c 0a20 2020 2020 2020  cessing,.       
-00018560: 2028 2277 6169 7469 6e67 222c 2022 6e6f   ("waiting", "no
-00018570: 2d77 6f72 6b65 7222 293a 2074 7261 6e73  -worker"): trans
-00018580: 6974 696f 6e5f 7761 6974 696e 675f 6e6f  ition_waiting_no
-00018590: 5f77 6f72 6b65 722c 0a20 2020 2020 2020  _worker,.       
-000185a0: 2028 2277 6169 7469 6e67 222c 2022 7175   ("waiting", "qu
-000185b0: 6575 6564 2229 3a20 7472 616e 7369 7469  eued"): transiti
-000185c0: 6f6e 5f77 6169 7469 6e67 5f71 7565 7565  on_waiting_queue
-000185d0: 642c 0a20 2020 2020 2020 2028 2277 6169  d,.        ("wai
-000185e0: 7469 6e67 222c 2022 6d65 6d6f 7279 2229  ting", "memory")
-000185f0: 3a20 7472 616e 7369 7469 6f6e 5f77 6169  : transition_wai
-00018600: 7469 6e67 5f6d 656d 6f72 792c 0a20 2020  ting_memory,.   
-00018610: 2020 2020 2028 2271 7565 7565 6422 2c20       ("queued", 
-00018620: 2272 656c 6561 7365 6422 293a 2074 7261  "released"): tra
-00018630: 6e73 6974 696f 6e5f 7175 6575 6564 5f72  nsition_queued_r
-00018640: 656c 6561 7365 642c 0a20 2020 2020 2020  eleased,.       
-00018650: 2028 2271 7565 7565 6422 2c20 2270 726f   ("queued", "pro
-00018660: 6365 7373 696e 6722 293a 2074 7261 6e73  cessing"): trans
-00018670: 6974 696f 6e5f 7175 6575 6564 5f70 726f  ition_queued_pro
-00018680: 6365 7373 696e 672c 0a20 2020 2020 2020  cessing,.       
-00018690: 2028 2270 726f 6365 7373 696e 6722 2c20   ("processing", 
-000186a0: 2272 656c 6561 7365 6422 293a 2074 7261  "released"): tra
-000186b0: 6e73 6974 696f 6e5f 7072 6f63 6573 7369  nsition_processi
-000186c0: 6e67 5f72 656c 6561 7365 642c 0a20 2020  ng_released,.   
-000186d0: 2020 2020 2028 2270 726f 6365 7373 696e       ("processin
-000186e0: 6722 2c20 226d 656d 6f72 7922 293a 2074  g", "memory"): t
-000186f0: 7261 6e73 6974 696f 6e5f 7072 6f63 6573  ransition_proces
-00018700: 7369 6e67 5f6d 656d 6f72 792c 0a20 2020  sing_memory,.   
-00018710: 2020 2020 2028 2270 726f 6365 7373 696e       ("processin
-00018720: 6722 2c20 2265 7272 6564 2229 3a20 7472  g", "erred"): tr
-00018730: 616e 7369 7469 6f6e 5f70 726f 6365 7373  ansition_process
-00018740: 696e 675f 6572 7265 642c 0a20 2020 2020  ing_erred,.     
-00018750: 2020 2028 226e 6f2d 776f 726b 6572 222c     ("no-worker",
-00018760: 2022 7265 6c65 6173 6564 2229 3a20 7472   "released"): tr
-00018770: 616e 7369 7469 6f6e 5f6e 6f5f 776f 726b  ansition_no_work
-00018780: 6572 5f72 656c 6561 7365 642c 0a20 2020  er_released,.   
-00018790: 2020 2020 2028 226e 6f2d 776f 726b 6572       ("no-worker
-000187a0: 222c 2022 7072 6f63 6573 7369 6e67 2229  ", "processing")
-000187b0: 3a20 7472 616e 7369 7469 6f6e 5f6e 6f5f  : transition_no_
-000187c0: 776f 726b 6572 5f70 726f 6365 7373 696e  worker_processin
-000187d0: 672c 0a20 2020 2020 2020 2028 2272 656c  g,.        ("rel
-000187e0: 6561 7365 6422 2c20 2266 6f72 676f 7474  eased", "forgott
-000187f0: 656e 2229 3a20 7472 616e 7369 7469 6f6e  en"): transition
-00018800: 5f72 656c 6561 7365 645f 666f 7267 6f74  _released_forgot
-00018810: 7465 6e2c 0a20 2020 2020 2020 2028 226d  ten,.        ("m
-00018820: 656d 6f72 7922 2c20 2266 6f72 676f 7474  emory", "forgott
-00018830: 656e 2229 3a20 7472 616e 7369 7469 6f6e  en"): transition
-00018840: 5f6d 656d 6f72 795f 666f 7267 6f74 7465  _memory_forgotte
-00018850: 6e2c 0a20 2020 2020 2020 2028 2265 7272  n,.        ("err
-00018860: 6564 222c 2022 7265 6c65 6173 6564 2229  ed", "released")
-00018870: 3a20 7472 616e 7369 7469 6f6e 5f65 7272  : transition_err
-00018880: 6564 5f72 656c 6561 7365 642c 0a20 2020  ed_released,.   
-00018890: 2020 2020 2028 226d 656d 6f72 7922 2c20       ("memory", 
-000188a0: 2272 656c 6561 7365 6422 293a 2074 7261  "released"): tra
-000188b0: 6e73 6974 696f 6e5f 6d65 6d6f 7279 5f72  nsition_memory_r
-000188c0: 656c 6561 7365 642c 0a20 2020 2020 2020  eleased,.       
-000188d0: 2028 2272 656c 6561 7365 6422 2c20 2265   ("released", "e
-000188e0: 7272 6564 2229 3a20 7472 616e 7369 7469  rred"): transiti
-000188f0: 6f6e 5f72 656c 6561 7365 645f 6572 7265  on_released_erre
-00018900: 642c 0a20 2020 207d 0a0a 2020 2020 6465  d,.    }..    de
-00018910: 6620 7374 6f72 7928 7365 6c66 2c20 2a6b  f story(self, *k
-00018920: 6579 735f 6f72 5f74 6173 6b73 5f6f 725f  eys_or_tasks_or_
-00018930: 7374 696d 756c 693a 2073 7472 207c 2054  stimuli: str | T
-00018940: 6173 6b53 7461 7465 2920 2d3e 206c 6973  askState) -> lis
-00018950: 745b 5472 616e 7369 7469 6f6e 5d3a 0a20  t[Transition]:. 
-00018960: 2020 2020 2020 2022 2222 4765 7420 616c         """Get al
-00018970: 6c20 7472 616e 7369 7469 6f6e 7320 7468  l transitions th
-00018980: 6174 2074 6f75 6368 206f 6e65 206f 6620  at touch one of 
-00018990: 7468 6520 696e 7075 7420 6b65 7973 206f  the input keys o
-000189a0: 7220 7374 696d 756c 7573 5f69 6427 7322  r stimulus_id's"
-000189b0: 2222 0a20 2020 2020 2020 206b 6579 735f  "".        keys_
-000189c0: 6f72 5f73 7469 6d75 6c69 203d 207b 0a20  or_stimuli = {. 
-000189d0: 2020 2020 2020 2020 2020 206b 6579 2e6b             key.k
-000189e0: 6579 2069 6620 6973 696e 7374 616e 6365  ey if isinstance
-000189f0: 286b 6579 2c20 5461 736b 5374 6174 6529  (key, TaskState)
-00018a00: 2065 6c73 6520 6b65 790a 2020 2020 2020   else key.      
-00018a10: 2020 2020 2020 666f 7220 6b65 7920 696e        for key in
-00018a20: 206b 6579 735f 6f72 5f74 6173 6b73 5f6f   keys_or_tasks_o
-00018a30: 725f 7374 696d 756c 690a 2020 2020 2020  r_stimuli.      
-00018a40: 2020 7d0a 2020 2020 2020 2020 7265 7475    }.        retu
-00018a50: 726e 2073 6368 6564 756c 6572 5f73 746f  rn scheduler_sto
-00018a60: 7279 286b 6579 735f 6f72 5f73 7469 6d75  ry(keys_or_stimu
-00018a70: 6c69 2c20 7365 6c66 2e74 7261 6e73 6974  li, self.transit
-00018a80: 696f 6e5f 6c6f 6729 0a0a 2020 2020 2323  ion_log)..    ##
-00018a90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00018aa0: 2323 2323 2323 2323 2323 2323 0a20 2020  ############.   
-00018ab0: 2023 2041 7373 6967 6e69 6e67 2054 6173   # Assigning Tas
-00018ac0: 6b73 2074 6f20 576f 726b 6572 7320 230a  ks to Workers #.
-00018ad0: 2020 2020 2323 2323 2323 2323 2323 2323      ############
-00018ae0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00018af0: 2323 0a0a 2020 2020 6465 6620 6973 5f72  ##..    def is_r
-00018b00: 6f6f 7469 7368 2873 656c 662c 2074 733a  ootish(self, ts:
-00018b10: 2054 6173 6b53 7461 7465 2920 2d3e 2062   TaskState) -> b
-00018b20: 6f6f 6c3a 0a20 2020 2020 2020 2022 2222  ool:.        """
-00018b30: 0a20 2020 2020 2020 2057 6865 7468 6572  .        Whether
-00018b40: 2060 6074 7360 6020 6973 2061 2072 6f6f   ``ts`` is a roo
-00018b50: 7420 6f72 2072 6f6f 742d 6c69 6b65 2074  t or root-like t
-00018b60: 6173 6b2e 0a0a 2020 2020 2020 2020 526f  ask...        Ro
-00018b70: 6f74 2d69 7368 2074 6173 6b73 2061 7265  ot-ish tasks are
-00018b80: 2070 6172 7420 6f66 2061 2067 726f 7570   part of a group
-00018b90: 2074 6861 7427 7320 6d75 6368 206c 6172   that's much lar
-00018ba0: 6765 7220 7468 616e 2074 6865 2063 6c75  ger than the clu
-00018bb0: 7374 6572 2c0a 2020 2020 2020 2020 616e  ster,.        an
-00018bc0: 6420 6861 7665 2066 6577 206f 7220 6e6f  d have few or no
-00018bd0: 2064 6570 656e 6465 6e63 6965 732e 0a20   dependencies.. 
-00018be0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00018bf0: 2020 2069 6620 7473 2e72 6573 6f75 7263     if ts.resourc
-00018c00: 655f 7265 7374 7269 6374 696f 6e73 206f  e_restrictions o
-00018c10: 7220 7473 2e77 6f72 6b65 725f 7265 7374  r ts.worker_rest
-00018c20: 7269 6374 696f 6e73 206f 7220 7473 2e68  rictions or ts.h
-00018c30: 6f73 745f 7265 7374 7269 6374 696f 6e73  ost_restrictions
-00018c40: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00018c50: 7475 726e 2046 616c 7365 0a20 2020 2020  turn False.     
-00018c60: 2020 2074 6720 3d20 7473 2e67 726f 7570     tg = ts.group
-00018c70: 0a20 2020 2020 2020 2023 2054 4f44 4f20  .        # TODO 
-00018c80: 7368 6f72 742d 6369 7263 7569 7420 746f  short-circuit to
-00018c90: 2054 7275 6520 6966 2060 6e6f 7420 7473   True if `not ts
-00018ca0: 2e64 6570 656e 6465 6e63 6965 7360 3f0a  .dependencies`?.
-00018cb0: 2020 2020 2020 2020 7265 7475 726e 2028          return (
-00018cc0: 0a20 2020 2020 2020 2020 2020 206c 656e  .            len
-00018cd0: 2874 6729 203e 2073 656c 662e 746f 7461  (tg) > self.tota
-00018ce0: 6c5f 6e74 6872 6561 6473 202a 2032 0a20  l_nthreads * 2. 
-00018cf0: 2020 2020 2020 2020 2020 2061 6e64 206c             and l
-00018d00: 656e 2874 672e 6465 7065 6e64 656e 6369  en(tg.dependenci
-00018d10: 6573 2920 3c20 350a 2020 2020 2020 2020  es) < 5.        
-00018d20: 2020 2020 616e 6420 7375 6d28 6d61 7028      and sum(map(
-00018d30: 6c65 6e2c 2074 672e 6465 7065 6e64 656e  len, tg.dependen
-00018d40: 6369 6573 2929 203c 2035 0a20 2020 2020  cies)) < 5.     
-00018d50: 2020 2029 0a0a 2020 2020 6465 6620 6368     )..    def ch
-00018d60: 6563 6b5f 6964 6c65 5f73 6174 7572 6174  eck_idle_saturat
-00018d70: 6564 2873 656c 662c 2077 733a 2057 6f72  ed(self, ws: Wor
-00018d80: 6b65 7253 7461 7465 2c20 6f63 633a 2066  kerState, occ: f
-00018d90: 6c6f 6174 203d 202d 312e 3029 202d 3e20  loat = -1.0) -> 
-00018da0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
-00018db0: 2255 7064 6174 6520 7468 6520 7374 6174  "Update the stat
-00018dc0: 7573 206f 6620 7468 6520 6964 6c65 2061  us of the idle a
-00018dd0: 6e64 2073 6174 7572 6174 6564 2073 7461  nd saturated sta
-00018de0: 7465 0a0a 2020 2020 2020 2020 5468 6520  te..        The 
-00018df0: 7363 6865 6475 6c65 7220 6b65 6570 7320  scheduler keeps 
-00018e00: 7472 6163 6b20 6f66 2077 6f72 6b65 7273  track of workers
-00018e10: 2074 6861 7420 6172 6520 2e2e 0a0a 2020   that are ....  
-00018e20: 2020 2020 2020 2d20 2053 6174 7572 6174        -  Saturat
-00018e30: 6564 3a20 6861 7665 2065 6e6f 7567 6820  ed: have enough 
-00018e40: 776f 726b 2074 6f20 7374 6179 2062 7573  work to stay bus
-00018e50: 790a 2020 2020 2020 2020 2d20 2049 646c  y.        -  Idl
-00018e60: 653a 2064 6f20 6e6f 7420 6861 7665 2065  e: do not have e
-00018e70: 6e6f 7567 6820 776f 726b 2074 6f20 7374  nough work to st
-00018e80: 6179 2062 7573 790a 0a20 2020 2020 2020  ay busy..       
-00018e90: 2054 6865 7920 6172 6520 636f 6e73 6964   They are consid
-00018ea0: 6572 6564 2073 6174 7572 6174 6564 2069  ered saturated i
-00018eb0: 6620 7468 6579 2062 6f74 6820 6861 7665  f they both have
-00018ec0: 2065 6e6f 7567 6820 7461 736b 7320 746f   enough tasks to
-00018ed0: 206f 6363 7570 790a 2020 2020 2020 2020   occupy.        
-00018ee0: 616c 6c20 6f66 2074 6865 6972 2074 6872  all of their thr
-00018ef0: 6561 6473 2c20 616e 6420 6966 2074 6865  eads, and if the
-00018f00: 2065 7870 6563 7465 6420 7275 6e74 696d   expected runtim
-00018f10: 6520 6f66 2074 686f 7365 2074 6173 6b73  e of those tasks
-00018f20: 2069 730a 2020 2020 2020 2020 6c61 7267   is.        larg
-00018f30: 6520 656e 6f75 6768 2e0a 0a20 2020 2020  e enough...     
-00018f40: 2020 2049 6620 6060 6469 7374 7269 6275     If ``distribu
-00018f50: 7465 642e 7363 6865 6475 6c65 722e 776f  ted.scheduler.wo
-00018f60: 726b 6572 2d73 6174 7572 6174 696f 6e60  rker-saturation`
-00018f70: 6020 6973 206e 6f74 2060 6069 6e66 6060  ` is not ``inf``
-00018f80: 0a20 2020 2020 2020 2028 7363 6865 6475  .        (schedu
-00018f90: 6c65 722d 7369 6465 2071 7565 7569 6e67  ler-side queuing
-00018fa0: 2069 7320 656e 6162 6c65 6429 2c20 7468   is enabled), th
-00018fb0: 6579 2061 7265 2063 6f6e 7369 6465 7265  ey are considere
-00018fc0: 6420 6964 6c65 0a20 2020 2020 2020 2069  d idle.        i
-00018fd0: 6620 7468 6579 2068 6176 6520 6665 7765  f they have fewe
-00018fe0: 7220 7461 736b 7320 7072 6f63 6573 7369  r tasks processi
-00018ff0: 6e67 2074 6861 6e20 7468 6520 6060 776f  ng than the ``wo
-00019000: 726b 6572 2d73 6174 7572 6174 696f 6e60  rker-saturation`
-00019010: 600a 2020 2020 2020 2020 7468 7265 7368  `.        thresh
-00019020: 6f6c 6420 6469 6374 6174 6573 2e0a 0a20  old dictates... 
-00019030: 2020 2020 2020 204f 7468 6572 7769 7365         Otherwise
-00019040: 2c20 7468 6579 2061 7265 2063 6f6e 7369  , they are consi
-00019050: 6465 7265 6420 6964 6c65 2069 6620 7468  dered idle if th
-00019060: 6579 2068 6176 6520 6665 7765 7220 7461  ey have fewer ta
-00019070: 736b 7320 7072 6f63 6573 7369 6e67 0a20  sks processing. 
-00019080: 2020 2020 2020 2074 6861 6e20 7468 7265         than thre
-00019090: 6164 732c 206f 7220 6966 2074 6865 6972  ads, or if their
-000190a0: 2074 6173 6b73 2720 746f 7461 6c20 6578   tasks' total ex
-000190b0: 7065 6374 6564 2072 756e 7469 6d65 2069  pected runtime i
-000190c0: 7320 6c65 7373 2074 6861 6e20 6861 6c66  s less than half
-000190d0: 0a20 2020 2020 2020 2074 6865 2065 7870  .        the exp
-000190e0: 6563 7465 6420 7275 6e74 696d 6520 6f66  ected runtime of
-000190f0: 2074 6865 2073 616d 6520 6e75 6d62 6572   the same number
-00019100: 206f 6620 6176 6572 6167 6520 7461 736b   of average task
-00019110: 732e 0a0a 2020 2020 2020 2020 5468 6973  s...        This
-00019120: 2069 7320 7573 6566 756c 2066 6f72 206c   is useful for l
-00019130: 6f61 6420 6261 6c61 6e63 696e 6720 616e  oad balancing an
-00019140: 6420 6164 6170 7469 7669 7479 2e0a 2020  d adaptivity..  
-00019150: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00019160: 2020 6966 2073 656c 662e 746f 7461 6c5f    if self.total_
-00019170: 6e74 6872 6561 6473 203d 3d20 3020 6f72  nthreads == 0 or
-00019180: 2077 732e 7374 6174 7573 203d 3d20 5374   ws.status == St
-00019190: 6174 7573 2e63 6c6f 7365 643a 0a20 2020  atus.closed:.   
-000191a0: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-000191b0: 2020 2020 2020 2020 6966 206f 6363 203c          if occ <
-000191c0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-000191d0: 6f63 6320 3d20 7773 2e6f 6363 7570 616e  occ = ws.occupan
-000191e0: 6379 0a0a 2020 2020 2020 2020 7020 3d20  cy..        p = 
-000191f0: 6c65 6e28 7773 2e70 726f 6365 7373 696e  len(ws.processin
-00019200: 6729 0a0a 2020 2020 2020 2020 7365 6c66  g)..        self
-00019210: 2e73 6174 7572 6174 6564 2e64 6973 6361  .saturated.disca
-00019220: 7264 2877 7329 0a20 2020 2020 2020 2069  rd(ws).        i
-00019230: 6620 7773 2e73 7461 7475 7320 213d 2053  f ws.status != S
-00019240: 7461 7475 732e 7275 6e6e 696e 673a 0a20  tatus.running:. 
-00019250: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00019260: 6964 6c65 2e70 6f70 2877 732e 6164 6472  idle.pop(ws.addr
-00019270: 6573 732c 204e 6f6e 6529 0a20 2020 2020  ess, None).     
-00019280: 2020 2065 6c69 6620 7365 6c66 2e69 735f     elif self.is_
-00019290: 756e 6f63 6375 7069 6564 2877 732c 206f  unoccupied(ws, o
-000192a0: 6363 2c20 7029 3a0a 2020 2020 2020 2020  cc, p):.        
-000192b0: 2020 2020 7365 6c66 2e69 646c 655b 7773      self.idle[ws
-000192c0: 2e61 6464 7265 7373 5d20 3d20 7773 0a20  .address] = ws. 
-000192d0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000192e0: 2020 2020 2020 2020 2073 656c 662e 6964           self.id
-000192f0: 6c65 2e70 6f70 2877 732e 6164 6472 6573  le.pop(ws.addres
-00019300: 732c 204e 6f6e 6529 0a20 2020 2020 2020  s, None).       
-00019310: 2020 2020 206e 6320 3d20 7773 2e6e 7468       nc = ws.nth
-00019320: 7265 6164 730a 2020 2020 2020 2020 2020  reads.          
-00019330: 2020 6966 2070 203e 206e 633a 0a20 2020    if p > nc:.   
-00019340: 2020 2020 2020 2020 2020 2020 2070 656e               pen
-00019350: 6469 6e67 203d 206f 6363 202a 2028 7020  ding = occ * (p 
-00019360: 2d20 6e63 2920 2f20 2870 202a 206e 6329  - nc) / (p * nc)
-00019370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019380: 2069 6620 302e 3420 3c20 7065 6e64 696e   if 0.4 < pendin
-00019390: 6720 3e20 312e 3920 2a20 2873 656c 662e  g > 1.9 * (self.
-000193a0: 746f 7461 6c5f 6f63 6375 7061 6e63 7920  total_occupancy 
-000193b0: 2f20 7365 6c66 2e74 6f74 616c 5f6e 7468  / self.total_nth
-000193c0: 7265 6164 7329 3a0a 2020 2020 2020 2020  reads):.        
-000193d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000193e0: 2e73 6174 7572 6174 6564 2e61 6464 2877  .saturated.add(w
-000193f0: 7329 0a0a 2020 2020 2020 2020 6966 206e  s)..        if n
-00019400: 6f74 205f 776f 726b 6572 5f66 756c 6c28  ot _worker_full(
-00019410: 7773 2c20 7365 6c66 2e57 4f52 4b45 525f  ws, self.WORKER_
-00019420: 5341 5455 5241 5449 4f4e 2920 616e 6420  SATURATION) and 
-00019430: 7773 2e73 7461 7475 7320 3d3d 2053 7461  ws.status == Sta
-00019440: 7475 732e 7275 6e6e 696e 673a 0a20 2020  tus.running:.   
-00019450: 2020 2020 2020 2020 2073 656c 662e 6964           self.id
-00019460: 6c65 5f74 6173 6b5f 636f 756e 742e 6164  le_task_count.ad
-00019470: 6428 7773 290a 2020 2020 2020 2020 656c  d(ws).        el
-00019480: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00019490: 7365 6c66 2e69 646c 655f 7461 736b 5f63  self.idle_task_c
-000194a0: 6f75 6e74 2e64 6973 6361 7264 2877 7329  ount.discard(ws)
-000194b0: 0a0a 2020 2020 6465 6620 6973 5f75 6e6f  ..    def is_uno
-000194c0: 6363 7570 6965 6428 0a20 2020 2020 2020  ccupied(.       
-000194d0: 2073 656c 662c 2077 733a 2057 6f72 6b65   self, ws: Worke
-000194e0: 7253 7461 7465 2c20 6f63 6375 7061 6e63  rState, occupanc
-000194f0: 793a 2066 6c6f 6174 2c20 6e70 726f 6365  y: float, nproce
-00019500: 7373 696e 673a 2069 6e74 0a20 2020 2029  ssing: int.    )
-00019510: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
-00019520: 2020 6e74 6872 6561 6473 203d 2077 732e    nthreads = ws.
-00019530: 6e74 6872 6561 6473 0a20 2020 2020 2020  nthreads.       
-00019540: 2072 6574 7572 6e20 280a 2020 2020 2020   return (.      
-00019550: 2020 2020 2020 6e70 726f 6365 7373 696e        nprocessin
-00019560: 6720 3c20 6e74 6872 6561 6473 0a20 2020  g < nthreads.   
-00019570: 2020 2020 2020 2020 206f 7220 6f63 6375           or occu
-00019580: 7061 6e63 7920 3c20 6e74 6872 6561 6473  pancy < nthreads
-00019590: 202a 2028 7365 6c66 2e74 6f74 616c 5f6f   * (self.total_o
-000195a0: 6363 7570 616e 6379 202f 2073 656c 662e  ccupancy / self.
-000195b0: 746f 7461 6c5f 6e74 6872 6561 6473 2920  total_nthreads) 
-000195c0: 2f20 320a 2020 2020 2020 2020 290a 0a20  / 2.        ).. 
-000195d0: 2020 2064 6566 2067 6574 5f63 6f6d 6d5f     def get_comm_
-000195e0: 636f 7374 2873 656c 662c 2074 733a 2054  cost(self, ts: T
-000195f0: 6173 6b53 7461 7465 2c20 7773 3a20 576f  askState, ws: Wo
-00019600: 726b 6572 5374 6174 6529 202d 3e20 666c  rkerState) -> fl
-00019610: 6f61 743a 0a20 2020 2020 2020 2022 2222  oat:.        """
-00019620: 0a20 2020 2020 2020 2047 6574 2074 6865  .        Get the
-00019630: 2065 7374 696d 6174 6564 2063 6f6d 6d75   estimated commu
-00019640: 6e69 6361 7469 6f6e 2063 6f73 7420 2869  nication cost (i
-00019650: 6e20 732e 2920 746f 2063 6f6d 7075 7465  n s.) to compute
-00019660: 2074 6865 2074 6173 6b0a 2020 2020 2020   the task.      
-00019670: 2020 6f6e 2074 6865 2067 6976 656e 2077    on the given w
-00019680: 6f72 6b65 722e 0a20 2020 2020 2020 2022  orker..        "
-00019690: 2222 0a20 2020 2020 2020 2069 6620 3130  "".        if 10
-000196a0: 202a 206c 656e 2874 732e 6465 7065 6e64   * len(ts.depend
-000196b0: 656e 6369 6573 2920 3c20 6c65 6e28 7773  encies) < len(ws
-000196c0: 2e68 6173 5f77 6861 7429 3a0a 2020 2020  .has_what):.    
-000196d0: 2020 2020 2020 2020 2320 496e 2074 6865          # In the
-000196e0: 2063 6f6d 6d6f 6e20 6361 7365 2077 6865   common case whe
-000196f0: 7265 2074 6865 206e 756d 6265 7220 6f66  re the number of
-00019700: 2064 6570 656e 6465 6e63 6965 7320 6973   dependencies is
-00019710: 0a20 2020 2020 2020 2020 2020 2023 206d  .            # m
-00019720: 7563 6820 6c65 7373 2074 6861 6e20 7468  uch less than th
-00019730: 6520 6e75 6d62 6572 206f 6620 7461 736b  e number of task
-00019740: 7320 7468 6174 2077 6520 6861 7665 2c0a  s that we have,.
-00019750: 2020 2020 2020 2020 2020 2020 2320 636f              # co
-00019760: 6e73 7472 7563 7420 7468 6520 7365 7420  nstruct the set 
-00019770: 6f66 2064 6570 7320 7468 6174 2072 6571  of deps that req
-00019780: 7569 7265 2063 6f6d 6d75 6e69 6361 7469  uire communicati
-00019790: 6f6e 2069 6e0a 2020 2020 2020 2020 2020  on in.          
-000197a0: 2020 2320 4f28 6c65 6e28 6465 7065 6e64    # O(len(depend
-000197b0: 656e 6369 6573 2929 2072 6174 6865 7220  encies)) rather 
-000197c0: 7468 616e 204f 286c 656e 2868 6173 5f77  than O(len(has_w
-000197d0: 6861 7429 2920 7469 6d65 2e0a 2020 2020  hat)) time..    
-000197e0: 2020 2020 2020 2020 2320 4661 6374 6f72          # Factor
-000197f0: 206f 6620 3130 2069 7320 6120 6775 6573   of 10 is a gues
-00019800: 7320 6174 2074 6865 206f 7665 7268 6561  s at the overhea
-00019810: 6420 6f66 2065 7870 6c69 6369 740a 2020  d of explicit.  
-00019820: 2020 2020 2020 2020 2020 2320 6974 6572            # iter
-00019830: 6174 696f 6e20 6173 206f 7070 6f73 6564  ation as opposed
-00019840: 2074 6f20 6a75 7374 2063 616c 6c69 6e67   to just calling
-00019850: 2073 6574 2e64 6966 6665 7265 6e63 650a   set.difference.
-00019860: 2020 2020 2020 2020 2020 2020 6465 7073              deps
-00019870: 203d 207b 6465 7020 666f 7220 6465 7020   = {dep for dep 
-00019880: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
-00019890: 6573 2069 6620 6465 7020 6e6f 7420 696e  es if dep not in
-000198a0: 2077 732e 6861 735f 7768 6174 7d0a 2020   ws.has_what}.  
-000198b0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000198c0: 2020 2020 2020 2020 6465 7073 203d 2074          deps = t
-000198d0: 732e 6465 7065 6e64 656e 6369 6573 2e64  s.dependencies.d
-000198e0: 6966 6665 7265 6e63 6528 7773 2e68 6173  ifference(ws.has
-000198f0: 5f77 6861 7429 0a20 2020 2020 2020 206e  _what).        n
-00019900: 6279 7465 7320 3d20 7375 6d28 6474 732e  bytes = sum(dts.
-00019910: 6e62 7974 6573 2066 6f72 2064 7473 2069  nbytes for dts i
-00019920: 6e20 6465 7073 290a 2020 2020 2020 2020  n deps).        
-00019930: 7265 7475 726e 206e 6279 7465 7320 2f20  return nbytes / 
-00019940: 7365 6c66 2e62 616e 6477 6964 7468 0a0a  self.bandwidth..
-00019950: 2020 2020 6465 6620 6765 745f 7461 736b      def get_task
-00019960: 5f64 7572 6174 696f 6e28 7365 6c66 2c20  _duration(self, 
-00019970: 7473 3a20 5461 736b 5374 6174 6529 202d  ts: TaskState) -
-00019980: 3e20 666c 6f61 743a 0a20 2020 2020 2020  > float:.       
-00019990: 2022 2222 4765 7420 7468 6520 6573 7469   """Get the esti
-000199a0: 6d61 7465 6420 636f 6d70 7574 6174 696f  mated computatio
-000199b0: 6e20 636f 7374 206f 6620 7468 6520 6769  n cost of the gi
-000199c0: 7665 6e20 7461 736b 2028 6e6f 7420 696e  ven task (not in
-000199d0: 636c 7564 696e 670a 2020 2020 2020 2020  cluding.        
-000199e0: 616e 7920 636f 6d6d 756e 6963 6174 696f  any communicatio
-000199f0: 6e20 636f 7374 292e 0a0a 2020 2020 2020  n cost)...      
-00019a00: 2020 4966 206e 6f20 6461 7461 2068 6173    If no data has
-00019a10: 2062 6565 6e20 6f62 7365 7276 6564 2c20   been observed, 
-00019a20: 7661 6c75 6520 6f66 0a20 2020 2020 2020  value of.       
-00019a30: 2060 6469 7374 7269 6275 7465 642e 7363   `distributed.sc
-00019a40: 6865 6475 6c65 722e 6465 6661 756c 742d  heduler.default-
-00019a50: 7461 736b 2d64 7572 6174 696f 6e73 6020  task-durations` 
-00019a60: 6172 6520 7573 6564 2e20 4966 206e 6f6e  are used. If non
-00019a70: 6520 6973 2073 6574 0a20 2020 2020 2020  e is set.       
-00019a80: 2066 6f72 2074 6869 7320 7461 736b 2c20   for this task, 
-00019a90: 6064 6973 7472 6962 7574 6564 2e73 6368  `distributed.sch
-00019aa0: 6564 756c 6572 2e75 6e6b 6e6f 776e 2d74  eduler.unknown-t
-00019ab0: 6173 6b2d 6475 7261 7469 6f6e 6020 6973  ask-duration` is
-00019ac0: 2075 7365 640a 2020 2020 2020 2020 696e   used.        in
-00019ad0: 7374 6561 642e 0a20 2020 2020 2020 2022  stead..        "
-00019ae0: 2222 0a20 2020 2020 2020 2064 7572 6174  "".        durat
-00019af0: 696f 6e3a 2066 6c6f 6174 203d 2074 732e  ion: float = ts.
-00019b00: 7072 6566 6978 2e64 7572 6174 696f 6e5f  prefix.duration_
-00019b10: 6176 6572 6167 650a 2020 2020 2020 2020  average.        
-00019b20: 6966 2064 7572 6174 696f 6e20 3e3d 2030  if duration >= 0
-00019b30: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00019b40: 7475 726e 2064 7572 6174 696f 6e0a 0a20  turn duration.. 
-00019b50: 2020 2020 2020 2073 203d 2073 656c 662e         s = self.
-00019b60: 756e 6b6e 6f77 6e5f 6475 7261 7469 6f6e  unknown_duration
-00019b70: 732e 6765 7428 7473 2e70 7265 6669 782e  s.get(ts.prefix.
-00019b80: 6e61 6d65 290a 2020 2020 2020 2020 6966  name).        if
-00019b90: 2073 2069 7320 4e6f 6e65 3a0a 2020 2020   s is None:.    
-00019ba0: 2020 2020 2020 2020 7365 6c66 2e75 6e6b          self.unk
-00019bb0: 6e6f 776e 5f64 7572 6174 696f 6e73 5b74  nown_durations[t
-00019bc0: 732e 7072 6566 6978 2e6e 616d 655d 203d  s.prefix.name] =
-00019bd0: 2073 203d 2073 6574 2829 0a20 2020 2020   s = set().     
-00019be0: 2020 2073 2e61 6464 2874 7329 0a20 2020     s.add(ts).   
-00019bf0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00019c00: 2e55 4e4b 4e4f 574e 5f54 4153 4b5f 4455  .UNKNOWN_TASK_DU
-00019c10: 5241 5449 4f4e 0a0a 2020 2020 6465 6620  RATION..    def 
-00019c20: 7661 6c69 645f 776f 726b 6572 7328 7365  valid_workers(se
-00019c30: 6c66 2c20 7473 3a20 5461 736b 5374 6174  lf, ts: TaskStat
-00019c40: 6529 202d 3e20 7365 745b 576f 726b 6572  e) -> set[Worker
-00019c50: 5374 6174 655d 207c 204e 6f6e 653a 0a20  State] | None:. 
-00019c60: 2020 2020 2020 2022 2222 5265 7475 726e         """Return
-00019c70: 2073 6574 206f 6620 6375 7272 656e 746c   set of currentl
-00019c80: 7920 7661 6c69 6420 776f 726b 6572 7320  y valid workers 
-00019c90: 666f 7220 6b65 790a 0a20 2020 2020 2020  for key..       
-00019ca0: 2049 6620 616c 6c20 776f 726b 6572 7320   If all workers 
-00019cb0: 6172 6520 7661 6c69 6420 7468 656e 2074  are valid then t
-00019cc0: 6869 7320 7265 7475 726e 7320 6060 4e6f  his returns ``No
-00019cd0: 6e65 6060 2c20 696e 2077 6869 6368 2063  ne``, in which c
-00019ce0: 6173 650a 2020 2020 2020 2020 616e 7920  ase.        any 
-00019cf0: 2a72 756e 6e69 6e67 2a20 776f 726b 6572  *running* worker
-00019d00: 2063 616e 2062 6520 7573 6564 2e0a 2020   can be used..  
-00019d10: 2020 2020 2020 4f74 6865 7277 6973 652c        Otherwise,
-00019d20: 2074 6865 2073 7562 7365 7420 6f66 2072   the subset of r
-00019d30: 756e 6e69 6e67 2077 6f72 6b65 7273 2076  unning workers v
-00019d40: 616c 6964 2066 6f72 2074 6869 7320 7461  alid for this ta
-00019d50: 736b 0a20 2020 2020 2020 2069 7320 7265  sk.        is re
-00019d60: 7475 726e 6564 2e0a 2020 2020 2020 2020  turned..        
-00019d70: 5468 6973 2063 6865 636b 7320 7472 6163  This checks trac
-00019d80: 6b73 2074 6865 2066 6f6c 6c6f 7769 6e67  ks the following
-00019d90: 2073 7461 7465 3a0a 0a20 2020 2020 2020   state:..       
-00019da0: 202a 2020 776f 726b 6572 5f72 6573 7472   *  worker_restr
-00019db0: 6963 7469 6f6e 730a 2020 2020 2020 2020  ictions.        
-00019dc0: 2a20 2068 6f73 745f 7265 7374 7269 6374  *  host_restrict
-00019dd0: 696f 6e73 0a20 2020 2020 2020 202a 2020  ions.        *  
-00019de0: 7265 736f 7572 6365 5f72 6573 7472 6963  resource_restric
-00019df0: 7469 6f6e 730a 2020 2020 2020 2020 2222  tions.        ""
-00019e00: 220a 2020 2020 2020 2020 733a 2073 6574  ".        s: set
-00019e10: 5b73 7472 5d20 7c20 4e6f 6e65 203d 204e  [str] | None = N
-00019e20: 6f6e 650a 0a20 2020 2020 2020 2069 6620  one..        if 
-00019e30: 7473 2e77 6f72 6b65 725f 7265 7374 7269  ts.worker_restri
-00019e40: 6374 696f 6e73 3a0a 2020 2020 2020 2020  ctions:.        
-00019e50: 2020 2020 7320 3d20 7b61 6464 7220 666f      s = {addr fo
-00019e60: 7220 6164 6472 2069 6e20 7473 2e77 6f72  r addr in ts.wor
-00019e70: 6b65 725f 7265 7374 7269 6374 696f 6e73  ker_restrictions
-00019e80: 2069 6620 6164 6472 2069 6e20 7365 6c66   if addr in self
-00019e90: 2e77 6f72 6b65 7273 7d0a 0a20 2020 2020  .workers}..     
-00019ea0: 2020 2069 6620 7473 2e68 6f73 745f 7265     if ts.host_re
-00019eb0: 7374 7269 6374 696f 6e73 3a0a 2020 2020  strictions:.    
-00019ec0: 2020 2020 2020 2020 2320 5265 736f 6c76          # Resolv
-00019ed0: 6520 7468 6520 616c 6961 7320 6865 7265  e the alias here
-00019ee0: 2072 6174 6865 7220 7468 616e 2065 6172   rather than ear
-00019ef0: 6c79 2c20 666f 7220 7468 6520 776f 726b  ly, for the work
-00019f00: 6572 0a20 2020 2020 2020 2020 2020 2023  er.            #
-00019f10: 206d 6179 206e 6f74 2062 6520 636f 6e6e   may not be conn
-00019f20: 6563 7465 6420 7768 656e 2068 6f73 745f  ected when host_
-00019f30: 7265 7374 7269 6374 696f 6e73 2069 7320  restrictions is 
-00019f40: 706f 7075 6c61 7465 640a 2020 2020 2020  populated.      
-00019f50: 2020 2020 2020 6872 203d 205b 7365 6c66        hr = [self
-00019f60: 2e63 6f65 7263 655f 686f 7374 6e61 6d65  .coerce_hostname
-00019f70: 2868 2920 666f 7220 6820 696e 2074 732e  (h) for h in ts.
-00019f80: 686f 7374 5f72 6573 7472 6963 7469 6f6e  host_restriction
-00019f90: 735d 0a20 2020 2020 2020 2020 2020 2023  s].            #
-00019fa0: 2058 5858 206e 6565 6420 486f 7374 5374   XXX need HostSt
-00019fb0: 6174 653f 0a20 2020 2020 2020 2020 2020  ate?.           
-00019fc0: 2073 6c20 3d20 5b5d 0a20 2020 2020 2020   sl = [].       
-00019fd0: 2020 2020 2066 6f72 2068 2069 6e20 6872       for h in hr
-00019fe0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00019ff0: 2020 6468 203d 2073 656c 662e 686f 7374    dh = self.host
-0001a000: 5f69 6e66 6f2e 6765 7428 6829 0a20 2020  _info.get(h).   
-0001a010: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0001a020: 6468 2069 7320 6e6f 7420 4e6f 6e65 3a0a  dh is not None:.
-0001a030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a040: 2020 2020 736c 2e61 7070 656e 6428 6468      sl.append(dh
-0001a050: 5b22 6164 6472 6573 7365 7322 5d29 0a0a  ["addresses"])..
-0001a060: 2020 2020 2020 2020 2020 2020 7373 203d              ss =
-0001a070: 2073 6574 2e75 6e69 6f6e 282a 736c 2920   set.union(*sl) 
-0001a080: 6966 2073 6c20 656c 7365 2073 6574 2829  if sl else set()
-0001a090: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0001a0a0: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
-0001a0b0: 2020 2020 2020 2020 2020 2073 203d 2073             s = s
-0001a0c0: 730a 2020 2020 2020 2020 2020 2020 656c  s.            el
-0001a0d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001a0e0: 2020 2020 7320 7c3d 2073 730a 0a20 2020      s |= ss..   
-0001a0f0: 2020 2020 2069 6620 7473 2e72 6573 6f75       if ts.resou
-0001a100: 7263 655f 7265 7374 7269 6374 696f 6e73  rce_restrictions
-0001a110: 3a0a 2020 2020 2020 2020 2020 2020 6477  :.            dw
-0001a120: 203d 207b 7d0a 2020 2020 2020 2020 2020   = {}.          
-0001a130: 2020 666f 7220 7265 736f 7572 6365 2c20    for resource, 
-0001a140: 7265 7175 6972 6564 2069 6e20 7473 2e72  required in ts.r
-0001a150: 6573 6f75 7263 655f 7265 7374 7269 6374  esource_restrict
-0001a160: 696f 6e73 2e69 7465 6d73 2829 3a0a 2020  ions.items():.  
-0001a170: 2020 2020 2020 2020 2020 2020 2020 6472                dr
-0001a180: 203d 2073 656c 662e 7265 736f 7572 6365   = self.resource
-0001a190: 732e 6765 7428 7265 736f 7572 6365 290a  s.get(resource).
-0001a1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a1b0: 6966 2064 7220 6973 204e 6f6e 653a 0a20  if dr is None:. 
-0001a1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a1d0: 2020 2073 656c 662e 7265 736f 7572 6365     self.resource
-0001a1e0: 735b 7265 736f 7572 6365 5d20 3d20 6472  s[resource] = dr
-0001a1f0: 203d 207b 7d0a 0a20 2020 2020 2020 2020   = {}..         
-0001a200: 2020 2020 2020 2073 7720 3d20 7365 7428         sw = set(
-0001a210: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001a220: 2020 666f 7220 6164 6472 2c20 7375 7070    for addr, supp
-0001a230: 6c69 6564 2069 6e20 6472 2e69 7465 6d73  lied in dr.items
-0001a240: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0001a250: 2020 2020 2020 2020 6966 2073 7570 706c          if suppl
-0001a260: 6965 6420 3e3d 2072 6571 7569 7265 643a  ied >= required:
-0001a270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a280: 2020 2020 2020 2020 2073 772e 6164 6428           sw.add(
-0001a290: 6164 6472 290a 0a20 2020 2020 2020 2020  addr)..         
-0001a2a0: 2020 2020 2020 2064 775b 7265 736f 7572         dw[resour
-0001a2b0: 6365 5d20 3d20 7377 0a0a 2020 2020 2020  ce] = sw..      
-0001a2c0: 2020 2020 2020 7777 203d 2073 6574 2e69        ww = set.i
-0001a2d0: 6e74 6572 7365 6374 696f 6e28 2a64 772e  ntersection(*dw.
-0001a2e0: 7661 6c75 6573 2829 290a 2020 2020 2020  values()).      
-0001a2f0: 2020 2020 2020 6966 2073 2069 7320 4e6f        if s is No
-0001a300: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0001a310: 2020 2020 7320 3d20 7777 0a20 2020 2020      s = ww.     
-0001a320: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001a330: 2020 2020 2020 2020 2020 2020 2073 2026               s &
-0001a340: 3d20 7777 0a0a 2020 2020 2020 2020 6966  = ww..        if
-0001a350: 2073 2069 7320 4e6f 6e65 3a0a 2020 2020   s is None:.    
-0001a360: 2020 2020 2020 2020 7265 7475 726e 204e          return N
-0001a370: 6f6e 6520 2023 2041 6c6c 2077 6f72 6b65  one  # All worke
-0001a380: 7273 2061 7265 2076 616c 6964 0a20 2020  rs are valid.   
-0001a390: 2020 2020 2069 6620 6e6f 7420 733a 0a20       if not s:. 
-0001a3a0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001a3b0: 6e20 7365 7428 2920 2023 204e 6f20 776f  n set()  # No wo
-0001a3c0: 726b 6572 7320 6172 6520 7661 6c69 640a  rkers are valid.
-0001a3d0: 0a20 2020 2020 2020 2023 2053 6f6d 6520  .        # Some 
-0001a3e0: 776f 726b 6572 7320 6172 6520 7661 6c69  workers are vali
-0001a3f0: 640a 2020 2020 2020 2020 735f 7773 203d  d.        s_ws =
-0001a400: 207b 7365 6c66 2e77 6f72 6b65 7273 5b61   {self.workers[a
-0001a410: 6464 725d 2066 6f72 2061 6464 7220 696e  ddr] for addr in
-0001a420: 2073 7d0a 2020 2020 2020 2020 6966 206c   s}.        if l
-0001a430: 656e 2873 656c 662e 7275 6e6e 696e 6729  en(self.running)
-0001a440: 203c 206c 656e 2873 656c 662e 776f 726b   < len(self.work
-0001a450: 6572 7329 3a0a 2020 2020 2020 2020 2020  ers):.          
-0001a460: 2020 735f 7773 2026 3d20 7365 6c66 2e72    s_ws &= self.r
-0001a470: 756e 6e69 6e67 0a20 2020 2020 2020 2072  unning.        r
-0001a480: 6574 7572 6e20 735f 7773 0a0a 2020 2020  eturn s_ws..    
-0001a490: 6465 6620 6163 7175 6972 655f 7265 736f  def acquire_reso
-0001a4a0: 7572 6365 7328 7365 6c66 2c20 7473 3a20  urces(self, ts: 
-0001a4b0: 5461 736b 5374 6174 652c 2077 733a 2057  TaskState, ws: W
-0001a4c0: 6f72 6b65 7253 7461 7465 2920 2d3e 204e  orkerState) -> N
-0001a4d0: 6f6e 653a 0a20 2020 2020 2020 2066 6f72  one:.        for
-0001a4e0: 2072 2c20 7265 7175 6972 6564 2069 6e20   r, required in 
-0001a4f0: 7473 2e72 6573 6f75 7263 655f 7265 7374  ts.resource_rest
-0001a500: 7269 6374 696f 6e73 2e69 7465 6d73 2829  rictions.items()
-0001a510: 3a0a 2020 2020 2020 2020 2020 2020 7773  :.            ws
-0001a520: 2e75 7365 645f 7265 736f 7572 6365 735b  .used_resources[
-0001a530: 725d 202b 3d20 7265 7175 6972 6564 0a0a  r] += required..
-0001a540: 2020 2020 6465 6620 7265 6c65 6173 655f      def release_
-0001a550: 7265 736f 7572 6365 7328 7365 6c66 2c20  resources(self, 
-0001a560: 7473 3a20 5461 736b 5374 6174 652c 2077  ts: TaskState, w
-0001a570: 733a 2057 6f72 6b65 7253 7461 7465 2920  s: WorkerState) 
-0001a580: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-0001a590: 2066 6f72 2072 2c20 7265 7175 6972 6564   for r, required
-0001a5a0: 2069 6e20 7473 2e72 6573 6f75 7263 655f   in ts.resource_
-0001a5b0: 7265 7374 7269 6374 696f 6e73 2e69 7465  restrictions.ite
-0001a5c0: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-0001a5d0: 2020 7773 2e75 7365 645f 7265 736f 7572    ws.used_resour
-0001a5e0: 6365 735b 725d 202d 3d20 7265 7175 6972  ces[r] -= requir
-0001a5f0: 6564 0a0a 2020 2020 6465 6620 636f 6572  ed..    def coer
-0001a600: 6365 5f68 6f73 746e 616d 6528 7365 6c66  ce_hostname(self
-0001a610: 2c20 686f 7374 3a20 4861 7368 6162 6c65  , host: Hashable
-0001a620: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
-0001a630: 2020 2222 220a 2020 2020 2020 2020 436f    """.        Co
-0001a640: 6572 6365 2074 6865 2068 6f73 746e 616d  erce the hostnam
-0001a650: 6520 6f66 2061 2077 6f72 6b65 722e 0a20  e of a worker.. 
-0001a660: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0001a670: 2020 2061 6c69 6173 203d 2073 656c 662e     alias = self.
-0001a680: 616c 6961 7365 732e 6765 7428 686f 7374  aliases.get(host
-0001a690: 290a 2020 2020 2020 2020 6966 2061 6c69  ).        if ali
-0001a6a0: 6173 2069 7320 6e6f 7420 4e6f 6e65 3a0a  as is not None:.
-0001a6b0: 2020 2020 2020 2020 2020 2020 7773 203d              ws =
-0001a6c0: 2073 656c 662e 776f 726b 6572 735b 616c   self.workers[al
-0001a6d0: 6961 735d 0a20 2020 2020 2020 2020 2020  ias].           
-0001a6e0: 2072 6574 7572 6e20 7773 2e68 6f73 740a   return ws.host.
-0001a6f0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001a700: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0001a710: 2069 7369 6e73 7461 6e63 6528 686f 7374   isinstance(host
-0001a720: 2c20 7374 7229 0a20 2020 2020 2020 2020  , str).         
-0001a730: 2020 2072 6574 7572 6e20 686f 7374 0a0a     return host..
-0001a740: 2020 2020 6465 6620 776f 726b 6572 5f6f      def worker_o
-0001a750: 626a 6563 7469 7665 2873 656c 662c 2074  bjective(self, t
-0001a760: 733a 2054 6173 6b53 7461 7465 2c20 7773  s: TaskState, ws
-0001a770: 3a20 576f 726b 6572 5374 6174 6529 202d  : WorkerState) -
-0001a780: 3e20 7475 706c 653a 0a20 2020 2020 2020  > tuple:.       
-0001a790: 2022 2222 4f62 6a65 6374 6976 6520 6675   """Objective fu
-0001a7a0: 6e63 7469 6f6e 2074 6f20 6465 7465 726d  nction to determ
-0001a7b0: 696e 6520 7768 6963 6820 776f 726b 6572  ine which worker
-0001a7c0: 2073 686f 756c 6420 6765 7420 7468 6520   should get the 
-0001a7d0: 7461 736b 0a0a 2020 2020 2020 2020 4d69  task..        Mi
-0001a7e0: 6e69 6d69 7a65 2065 7870 6563 7465 6420  nimize expected 
-0001a7f0: 7374 6172 7420 7469 6d65 2e20 2049 6620  start time.  If 
-0001a800: 6120 7469 6520 7468 656e 2062 7265 616b  a tie then break
-0001a810: 2077 6974 6820 6461 7461 2073 746f 7261   with data stora
-0001a820: 6765 2e0a 2020 2020 2020 2020 2222 220a  ge..        """.
-0001a830: 2020 2020 2020 2020 636f 6d6d 5f62 7974          comm_byt
-0001a840: 6573 203d 2073 756d 280a 2020 2020 2020  es = sum(.      
-0001a850: 2020 2020 2020 6474 732e 6765 745f 6e62        dts.get_nb
-0001a860: 7974 6573 2829 2066 6f72 2064 7473 2069  ytes() for dts i
-0001a870: 6e20 7473 2e64 6570 656e 6465 6e63 6965  n ts.dependencie
-0001a880: 7320 6966 2077 7320 6e6f 7420 696e 2064  s if ws not in d
-0001a890: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
-0001a8a0: 2020 2029 0a0a 2020 2020 2020 2020 7374     )..        st
-0001a8b0: 6163 6b5f 7469 6d65 203d 2077 732e 6f63  ack_time = ws.oc
-0001a8c0: 6375 7061 6e63 7920 2f20 7773 2e6e 7468  cupancy / ws.nth
-0001a8d0: 7265 6164 730a 2020 2020 2020 2020 7374  reads.        st
-0001a8e0: 6172 745f 7469 6d65 203d 2073 7461 636b  art_time = stack
-0001a8f0: 5f74 696d 6520 2b20 636f 6d6d 5f62 7974  _time + comm_byt
-0001a900: 6573 202f 2073 656c 662e 6261 6e64 7769  es / self.bandwi
-0001a910: 6474 680a 0a20 2020 2020 2020 2069 6620  dth..        if 
-0001a920: 7473 2e61 6374 6f72 3a0a 2020 2020 2020  ts.actor:.      
-0001a930: 2020 2020 2020 7265 7475 726e 2028 6c65        return (le
-0001a940: 6e28 7773 2e61 6374 6f72 7329 2c20 7374  n(ws.actors), st
-0001a950: 6172 745f 7469 6d65 2c20 7773 2e6e 6279  art_time, ws.nby
-0001a960: 7465 7329 0a20 2020 2020 2020 2065 6c73  tes).        els
-0001a970: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-0001a980: 6574 7572 6e20 2873 7461 7274 5f74 696d  eturn (start_tim
-0001a990: 652c 2077 732e 6e62 7974 6573 290a 0a20  e, ws.nbytes).. 
-0001a9a0: 2020 2064 6566 2061 6464 5f72 6570 6c69     def add_repli
-0001a9b0: 6361 2873 656c 662c 2074 733a 2054 6173  ca(self, ts: Tas
-0001a9c0: 6b53 7461 7465 2c20 7773 3a20 576f 726b  kState, ws: Work
-0001a9d0: 6572 5374 6174 6529 202d 3e20 4e6f 6e65  erState) -> None
-0001a9e0: 3a0a 2020 2020 2020 2020 2222 224e 6f74  :.        """Not
-0001a9f0: 6520 7468 6174 2061 2077 6f72 6b65 7220  e that a worker 
-0001aa00: 686f 6c64 7320 6120 7265 706c 6963 6120  holds a replica 
-0001aa10: 6f66 2061 2074 6173 6b20 7769 7468 2073  of a task with s
-0001aa20: 7461 7465 3d27 6d65 6d6f 7279 2722 2222  tate='memory'"""
-0001aa30: 0a20 2020 2020 2020 2077 732e 6164 645f  .        ws.add_
-0001aa40: 7265 706c 6963 6128 7473 290a 2020 2020  replica(ts).    
-0001aa50: 2020 2020 6966 206c 656e 2874 732e 7768      if len(ts.wh
-0001aa60: 6f5f 6861 7329 203d 3d20 323a 0a20 2020  o_has) == 2:.   
-0001aa70: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
-0001aa80: 706c 6963 6174 6564 5f74 6173 6b73 2e61  plicated_tasks.a
-0001aa90: 6464 2874 7329 0a0a 2020 2020 6465 6620  dd(ts)..    def 
-0001aaa0: 7265 6d6f 7665 5f72 6570 6c69 6361 2873  remove_replica(s
-0001aab0: 656c 662c 2074 733a 2054 6173 6b53 7461  elf, ts: TaskSta
-0001aac0: 7465 2c20 7773 3a20 576f 726b 6572 5374  te, ws: WorkerSt
-0001aad0: 6174 6529 202d 3e20 4e6f 6e65 3a0a 2020  ate) -> None:.  
-0001aae0: 2020 2020 2020 2222 224e 6f74 6520 7468        """Note th
-0001aaf0: 6174 2061 2077 6f72 6b65 7220 6e6f 206c  at a worker no l
-0001ab00: 6f6e 6765 7220 686f 6c64 7320 6120 7265  onger holds a re
-0001ab10: 706c 6963 6120 6f66 2061 2074 6173 6b22  plica of a task"
-0001ab20: 2222 0a20 2020 2020 2020 2077 732e 7265  "".        ws.re
-0001ab30: 6d6f 7665 5f72 6570 6c69 6361 2874 7329  move_replica(ts)
-0001ab40: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-0001ab50: 7473 2e77 686f 5f68 6173 2920 3d3d 2031  ts.who_has) == 1
-0001ab60: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0001ab70: 6c66 2e72 6570 6c69 6361 7465 645f 7461  lf.replicated_ta
-0001ab80: 736b 732e 7265 6d6f 7665 2874 7329 0a0a  sks.remove(ts)..
-0001ab90: 2020 2020 6465 6620 7265 6d6f 7665 5f61      def remove_a
-0001aba0: 6c6c 5f72 6570 6c69 6361 7328 7365 6c66  ll_replicas(self
-0001abb0: 2c20 7473 3a20 5461 736b 5374 6174 6529  , ts: TaskState)
-0001abc0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0001abd0: 2020 2222 2252 656d 6f76 6520 616c 6c20    """Remove all 
-0001abe0: 7265 706c 6963 6173 206f 6620 6120 7461  replicas of a ta
-0001abf0: 736b 2066 726f 6d20 616c 6c20 776f 726b  sk from all work
-0001ac00: 6572 7322 2222 0a20 2020 2020 2020 206e  ers""".        n
-0001ac10: 6279 7465 7320 3d20 7473 2e67 6574 5f6e  bytes = ts.get_n
-0001ac20: 6279 7465 7328 290a 2020 2020 2020 2020  bytes().        
-0001ac30: 666f 7220 7773 2069 6e20 7473 2e77 686f  for ws in ts.who
-0001ac40: 5f68 6173 3a0a 2020 2020 2020 2020 2020  _has:.          
-0001ac50: 2020 7773 2e6e 6279 7465 7320 2d3d 206e    ws.nbytes -= n
-0001ac60: 6279 7465 730a 2020 2020 2020 2020 2020  bytes.          
-0001ac70: 2020 6465 6c20 7773 2e5f 6861 735f 7768    del ws._has_wh
-0001ac80: 6174 5b74 735d 0a20 2020 2020 2020 2069  at[ts].        i
-0001ac90: 6620 6c65 6e28 7473 2e77 686f 5f68 6173  f len(ts.who_has
-0001aca0: 2920 3e20 313a 0a20 2020 2020 2020 2020  ) > 1:.         
-0001acb0: 2020 2073 656c 662e 7265 706c 6963 6174     self.replicat
-0001acc0: 6564 5f74 6173 6b73 2e72 656d 6f76 6528  ed_tasks.remove(
-0001acd0: 7473 290a 2020 2020 2020 2020 7473 2e77  ts).        ts.w
-0001ace0: 686f 5f68 6173 2e63 6c65 6172 2829 0a0a  ho_has.clear()..
-0001acf0: 2020 2020 6465 6620 6275 6c6b 5f73 6368      def bulk_sch
-0001ad00: 6564 756c 655f 756e 7275 6e6e 6162 6c65  edule_unrunnable
-0001ad10: 5f61 6674 6572 5f61 6464 696e 675f 776f  _after_adding_wo
-0001ad20: 726b 6572 2873 656c 662c 2077 733a 2057  rker(self, ws: W
-0001ad30: 6f72 6b65 7253 7461 7465 2920 2d3e 2052  orkerState) -> R
-0001ad40: 6563 733a 0a20 2020 2020 2020 2022 2222  ecs:.        """
-0001ad50: 5365 6e64 2060 606e 6f2d 776f 726b 6572  Send ``no-worker
-0001ad60: 6060 2074 6173 6b73 2074 6f20 6060 7072  `` tasks to ``pr
-0001ad70: 6f63 6573 7369 6e67 6060 2074 6861 7420  ocessing`` that 
-0001ad80: 7468 6973 2077 6f72 6b65 7220 6361 6e20  this worker can 
-0001ad90: 6861 6e64 6c65 2e0a 0a20 2020 2020 2020  handle...       
-0001ada0: 2052 6574 7572 6e73 2070 7269 6f72 6974   Returns priorit
-0001adb0: 792d 6f72 6465 7265 6420 7265 636f 6d6d  y-ordered recomm
-0001adc0: 656e 6461 7469 6f6e 732e 0a20 2020 2020  endations..     
-0001add0: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
-0001ade0: 756e 6e61 626c 653a 206c 6973 745b 5461  unnable: list[Ta
-0001adf0: 736b 5374 6174 655d 203d 205b 5d0a 2020  skState] = [].  
-0001ae00: 2020 2020 2020 666f 7220 7473 2069 6e20        for ts in 
-0001ae10: 7365 6c66 2e75 6e72 756e 6e61 626c 653a  self.unrunnable:
-0001ae20: 0a20 2020 2020 2020 2020 2020 2076 616c  .            val
-0001ae30: 6964 203d 2073 656c 662e 7661 6c69 645f  id = self.valid_
-0001ae40: 776f 726b 6572 7328 7473 290a 2020 2020  workers(ts).    
-0001ae50: 2020 2020 2020 2020 6966 2076 616c 6964          if valid
-0001ae60: 2069 7320 4e6f 6e65 206f 7220 7773 2069   is None or ws i
-0001ae70: 6e20 7661 6c69 643a 0a20 2020 2020 2020  n valid:.       
-0001ae80: 2020 2020 2020 2020 2072 756e 6e61 626c           runnabl
-0001ae90: 652e 6170 7065 6e64 2874 7329 0a0a 2020  e.append(ts)..  
-0001aea0: 2020 2020 2020 2320 5265 636f 6d6d 656e        # Recommen
-0001aeb0: 6461 7469 6f6e 7320 6172 6520 7072 6f63  dations are proc
-0001aec0: 6573 7365 6420 4c49 464f 2c20 6865 6e63  essed LIFO, henc
-0001aed0: 6520 7468 6520 7265 7665 7273 6564 206f  e the reversed o
-0001aee0: 7264 6572 0a20 2020 2020 2020 2072 756e  rder.        run
-0001aef0: 6e61 626c 652e 736f 7274 286b 6579 3d6f  nable.sort(key=o
-0001af00: 7065 7261 746f 722e 6174 7472 6765 7474  perator.attrgett
-0001af10: 6572 2822 7072 696f 7269 7479 2229 2c20  er("priority"), 
-0001af20: 7265 7665 7273 653d 5472 7565 290a 2020  reverse=True).  
-0001af30: 2020 2020 2020 7265 7475 726e 207b 7473        return {ts
-0001af40: 2e6b 6579 3a20 2270 726f 6365 7373 696e  .key: "processin
-0001af50: 6722 2066 6f72 2074 7320 696e 2072 756e  g" for ts in run
-0001af60: 6e61 626c 657d 0a0a 2020 2020 6465 6620  nable}..    def 
-0001af70: 5f76 616c 6964 6174 655f 7265 6164 7928  _validate_ready(
-0001af80: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
-0001af90: 6174 6529 202d 3e20 4e6f 6e65 3a0a 2020  ate) -> None:.  
-0001afa0: 2020 2020 2020 2222 2256 616c 6964 6174        """Validat
-0001afb0: 696f 6e20 666f 7220 7265 6164 7920 7374  ion for ready st
-0001afc0: 6174 6573 2028 7072 6f63 6573 7369 6e67  ates (processing
-0001afd0: 2c20 7175 6575 6564 2c20 6e6f 2d77 6f72  , queued, no-wor
-0001afe0: 6b65 7229 2222 220a 2020 2020 2020 2020  ker)""".        
-0001aff0: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
-0001b000: 6974 696e 675f 6f6e 0a20 2020 2020 2020  iting_on.       
-0001b010: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
-0001b020: 686f 5f68 6173 0a20 2020 2020 2020 2061  ho_has.        a
-0001b030: 7373 6572 7420 6e6f 7420 7473 2e65 7863  ssert not ts.exc
-0001b040: 6570 7469 6f6e 5f62 6c61 6d65 0a20 2020  eption_blame.   
-0001b050: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-0001b060: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-0001b070: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0001b080: 6e6f 7420 7473 2e68 6173 5f6c 6f73 745f  not ts.has_lost_
-0001b090: 6465 7065 6e64 656e 6369 6573 0a20 2020  dependencies.   
-0001b0a0: 2020 2020 2061 7373 6572 7420 7473 206e       assert ts n
-0001b0b0: 6f74 2069 6e20 7365 6c66 2e75 6e72 756e  ot in self.unrun
-0001b0c0: 6e61 626c 650a 2020 2020 2020 2020 6173  nable.        as
-0001b0d0: 7365 7274 2074 7320 6e6f 7420 696e 2073  sert ts not in s
-0001b0e0: 656c 662e 7175 6575 6564 0a20 2020 2020  elf.queued.     
-0001b0f0: 2020 2061 7373 6572 7420 616c 6c28 6474     assert all(dt
-0001b100: 732e 7768 6f5f 6861 7320 666f 7220 6474  s.who_has for dt
-0001b110: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-0001b120: 6369 6573 290a 0a20 2020 2064 6566 205f  cies)..    def _
-0001b130: 6164 645f 746f 5f70 726f 6365 7373 696e  add_to_processin
-0001b140: 6728 7365 6c66 2c20 7473 3a20 5461 736b  g(self, ts: Task
-0001b150: 5374 6174 652c 2077 733a 2057 6f72 6b65  State, ws: Worke
-0001b160: 7253 7461 7465 2920 2d3e 204d 7367 733a  rState) -> Msgs:
-0001b170: 0a20 2020 2020 2020 2022 2222 5365 7420  .        """Set 
-0001b180: 6120 7461 736b 2061 7320 7072 6f63 6573  a task as proces
-0001b190: 7369 6e67 206f 6e20 6120 776f 726b 6572  sing on a worker
-0001b1a0: 2061 6e64 2072 6574 7572 6e20 7468 6520   and return the 
-0001b1b0: 776f 726b 6572 206d 6573 7361 6765 7320  worker messages 
-0001b1c0: 746f 2073 656e 6422 2222 0a20 2020 2020  to send""".     
-0001b1d0: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
-0001b1e0: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
-0001b1f0: 2073 656c 662e 5f76 616c 6964 6174 655f   self._validate_
-0001b200: 7265 6164 7928 7473 290a 2020 2020 2020  ready(ts).      
-0001b210: 2020 2020 2020 6173 7365 7274 2077 7320        assert ws 
-0001b220: 696e 2073 656c 662e 7275 6e6e 696e 672c  in self.running,
-0001b230: 2073 656c 662e 7275 6e6e 696e 670a 2020   self.running.  
-0001b240: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0001b250: 2028 6f20 3a3d 2073 656c 662e 776f 726b   (o := self.work
-0001b260: 6572 732e 6765 7428 7773 2e61 6464 7265  ers.get(ws.addre
-0001b270: 7373 2929 2069 7320 7773 2c20 2877 732c  ss)) is ws, (ws,
-0001b280: 206f 290a 0a20 2020 2020 2020 2077 732e   o)..        ws.
-0001b290: 6164 645f 746f 5f70 726f 6365 7373 696e  add_to_processin
-0001b2a0: 6728 7473 290a 2020 2020 2020 2020 7473  g(ts).        ts
-0001b2b0: 2e70 726f 6365 7373 696e 675f 6f6e 203d  .processing_on =
-0001b2c0: 2077 730a 2020 2020 2020 2020 7473 2e73   ws.        ts.s
-0001b2d0: 7461 7465 203d 2022 7072 6f63 6573 7369  tate = "processi
-0001b2e0: 6e67 220a 2020 2020 2020 2020 7365 6c66  ng".        self
-0001b2f0: 2e61 6371 7569 7265 5f72 6573 6f75 7263  .acquire_resourc
-0001b300: 6573 2874 732c 2077 7329 0a20 2020 2020  es(ts, ws).     
-0001b310: 2020 2073 656c 662e 6368 6563 6b5f 6964     self.check_id
-0001b320: 6c65 5f73 6174 7572 6174 6564 2877 7329  le_saturated(ws)
-0001b330: 0a20 2020 2020 2020 2073 656c 662e 6e5f  .        self.n_
-0001b340: 7461 736b 7320 2b3d 2031 0a0a 2020 2020  tasks += 1..    
-0001b350: 2020 2020 6966 2074 732e 6163 746f 723a      if ts.actor:
-0001b360: 0a20 2020 2020 2020 2020 2020 2077 732e  .            ws.
-0001b370: 6163 746f 7273 2e61 6464 2874 7329 0a0a  actors.add(ts)..
-0001b380: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-0001b390: 7773 2e61 6464 7265 7373 3a20 5b73 656c  ws.address: [sel
-0001b3a0: 662e 5f74 6173 6b5f 746f 5f6d 7367 2874  f._task_to_msg(t
-0001b3b0: 7329 5d7d 0a0a 2020 2020 6465 6620 5f65  s)]}..    def _e
-0001b3c0: 7869 745f 7072 6f63 6573 7369 6e67 5f63  xit_processing_c
-0001b3d0: 6f6d 6d6f 6e28 7365 6c66 2c20 7473 3a20  ommon(self, ts: 
-0001b3e0: 5461 736b 5374 6174 6529 202d 3e20 576f  TaskState) -> Wo
-0001b3f0: 726b 6572 5374 6174 6520 7c20 4e6f 6e65  rkerState | None
-0001b400: 3a0a 2020 2020 2020 2020 2222 2252 656d  :.        """Rem
-0001b410: 6f76 6520 2a74 732a 2066 726f 6d20 7468  ove *ts* from th
-0001b420: 6520 7365 7420 6f66 2070 726f 6365 7373  e set of process
-0001b430: 696e 6720 7461 736b 732e 0a0a 2020 2020  ing tasks...    
-0001b440: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-0001b450: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-0001b460: 2020 2020 576f 726b 6572 2073 7461 7465      Worker state
-0001b470: 206f 6620 7468 6520 776f 726b 6572 2074   of the worker t
-0001b480: 6861 7420 7072 6f63 6573 7365 6420 2a74  hat processed *t
-0001b490: 732a 2069 6620 7468 6520 776f 726b 6572  s* if the worker
-0001b4a0: 2069 7320 6375 7272 656e 742c 0a20 2020   is current,.   
-0001b4b0: 2020 2020 204e 6f6e 6520 6966 2074 6865       None if the
-0001b4c0: 2077 6f72 6b65 7220 6973 2073 7461 6c65   worker is stale
-0001b4d0: 2e0a 0a20 2020 2020 2020 2053 6565 2061  ...        See a
-0001b4e0: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
-0001b4f0: 2d2d 2d2d 0a20 2020 2020 2020 2053 6368  ----.        Sch
-0001b500: 6564 756c 6572 2e5f 7365 745f 6475 7261  eduler._set_dura
-0001b510: 7469 6f6e 5f65 7374 696d 6174 650a 2020  tion_estimate.  
-0001b520: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0001b530: 2020 7773 203d 2074 732e 7072 6f63 6573    ws = ts.proces
-0001b540: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
-0001b550: 6173 7365 7274 2077 730a 2020 2020 2020  assert ws.      
-0001b560: 2020 7473 2e70 726f 6365 7373 696e 675f    ts.processing_
-0001b570: 6f6e 203d 204e 6f6e 650a 0a20 2020 2020  on = None..     
-0001b580: 2020 2077 732e 7265 6d6f 7665 5f66 726f     ws.remove_fro
-0001b590: 6d5f 7072 6f63 6573 7369 6e67 2874 7329  m_processing(ts)
-0001b5a0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0001b5b0: 2e77 6f72 6b65 7273 2e67 6574 2877 732e  .workers.get(ws.
-0001b5c0: 6164 6472 6573 7329 2069 7320 6e6f 7420  address) is not 
-0001b5d0: 7773 3a20 2023 206d 6179 2068 6176 6520  ws:  # may have 
-0001b5e0: 6265 656e 2072 656d 6f76 6564 0a20 2020  been removed.   
-0001b5f0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001b600: 4e6f 6e65 0a0a 2020 2020 2020 2020 7365  None..        se
-0001b610: 6c66 2e63 6865 636b 5f69 646c 655f 7361  lf.check_idle_sa
-0001b620: 7475 7261 7465 6428 7773 290a 2020 2020  turated(ws).    
-0001b630: 2020 2020 7365 6c66 2e72 656c 6561 7365      self.release
-0001b640: 5f72 6573 6f75 7263 6573 2874 732c 2077  _resources(ts, w
-0001b650: 7329 0a0a 2020 2020 2020 2020 7265 7475  s)..        retu
-0001b660: 726e 2077 730a 0a20 2020 2064 6566 205f  rn ws..    def _
-0001b670: 6164 645f 746f 5f6d 656d 6f72 7928 0a20  add_to_memory(. 
-0001b680: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-0001b690: 2020 2020 2074 733a 2054 6173 6b53 7461       ts: TaskSta
-0001b6a0: 7465 2c0a 2020 2020 2020 2020 7773 3a20  te,.        ws: 
-0001b6b0: 576f 726b 6572 5374 6174 652c 0a20 2020  WorkerState,.   
-0001b6c0: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-0001b6d0: 696f 6e73 3a20 5265 6373 2c0a 2020 2020  ions: Recs,.    
-0001b6e0: 2020 2020 636c 6965 6e74 5f6d 7367 733a      client_msgs:
-0001b6f0: 204d 7367 732c 0a20 2020 2020 2020 2074   Msgs,.        t
-0001b700: 7970 653a 2062 7974 6573 207c 204e 6f6e  ype: bytes | Non
-0001b710: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-0001b720: 2020 7479 7065 6e61 6d65 3a20 7374 7220    typename: str 
-0001b730: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-0001b740: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
-0001b750: 2020 2020 2020 2222 2241 6464 2074 7320        """Add ts 
-0001b760: 746f 2074 6865 2073 6574 206f 6620 696e  to the set of in
-0001b770: 2d6d 656d 6f72 7920 7461 736b 7322 2222  -memory tasks"""
-0001b780: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0001b790: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
-0001b7a0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-0001b7b0: 206e 6f74 2069 6e20 7773 2e68 6173 5f77   not in ws.has_w
-0001b7c0: 6861 740a 0a20 2020 2020 2020 2073 656c  hat..        sel
-0001b7d0: 662e 6164 645f 7265 706c 6963 6128 7473  f.add_replica(ts
-0001b7e0: 2c20 7773 290a 0a20 2020 2020 2020 2064  , ws)..        d
-0001b7f0: 6570 7320 3d20 6c69 7374 2874 732e 6465  eps = list(ts.de
-0001b800: 7065 6e64 656e 7473 290a 2020 2020 2020  pendents).      
-0001b810: 2020 6966 206c 656e 2864 6570 7329 203e    if len(deps) >
-0001b820: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-0001b830: 6465 7073 2e73 6f72 7428 6b65 793d 6f70  deps.sort(key=op
-0001b840: 6572 6174 6f72 2e61 7474 7267 6574 7465  erator.attrgette
-0001b850: 7228 2270 7269 6f72 6974 7922 292c 2072  r("priority"), r
-0001b860: 6576 6572 7365 3d54 7275 6529 0a0a 2020  everse=True)..  
-0001b870: 2020 2020 2020 666f 7220 6474 7320 696e        for dts in
-0001b880: 2064 6570 733a 0a20 2020 2020 2020 2020   deps:.         
-0001b890: 2020 2073 203d 2064 7473 2e77 6169 7469     s = dts.waiti
-0001b8a0: 6e67 5f6f 6e0a 2020 2020 2020 2020 2020  ng_on.          
-0001b8b0: 2020 6966 2074 7320 696e 2073 3a0a 2020    if ts in s:.  
-0001b8c0: 2020 2020 2020 2020 2020 2020 2020 732e                s.
-0001b8d0: 6469 7363 6172 6428 7473 290a 2020 2020  discard(ts).    
-0001b8e0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0001b8f0: 6f74 2073 3a20 2023 206e 6577 2074 6173  ot s:  # new tas
-0001b900: 6b20 7265 6164 7920 746f 2072 756e 0a20  k ready to run. 
-0001b910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b920: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
-0001b930: 6e73 5b64 7473 2e6b 6579 5d20 3d20 2270  ns[dts.key] = "p
-0001b940: 726f 6365 7373 696e 6722 0a0a 2020 2020  rocessing"..    
-0001b950: 2020 2020 666f 7220 6474 7320 696e 2074      for dts in t
-0001b960: 732e 6465 7065 6e64 656e 6369 6573 3a0a  s.dependencies:.
-0001b970: 2020 2020 2020 2020 2020 2020 7320 3d20              s = 
-0001b980: 6474 732e 7761 6974 6572 730a 2020 2020  dts.waiters.    
-0001b990: 2020 2020 2020 2020 732e 6469 7363 6172          s.discar
-0001b9a0: 6428 7473 290a 2020 2020 2020 2020 2020  d(ts).          
-0001b9b0: 2020 6966 206e 6f74 2073 2061 6e64 206e    if not s and n
-0001b9c0: 6f74 2064 7473 2e77 686f 5f77 616e 7473  ot dts.who_wants
-0001b9d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001b9e0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-0001b9f0: 735b 6474 732e 6b65 795d 203d 2022 7265  s[dts.key] = "re
-0001ba00: 6c65 6173 6564 220a 0a20 2020 2020 2020  leased"..       
-0001ba10: 2069 6620 6e6f 7420 7473 2e77 6169 7465   if not ts.waite
-0001ba20: 7273 2061 6e64 206e 6f74 2074 732e 7768  rs and not ts.wh
-0001ba30: 6f5f 7761 6e74 733a 0a20 2020 2020 2020  o_wants:.       
-0001ba40: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-0001ba50: 696f 6e73 5b74 732e 6b65 795d 203d 2022  ions[ts.key] = "
-0001ba60: 7265 6c65 6173 6564 220a 2020 2020 2020  released".      
-0001ba70: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001ba80: 2020 2020 7265 706f 7274 5f6d 7367 3a20      report_msg: 
-0001ba90: 6469 6374 5b73 7472 2c20 416e 795d 203d  dict[str, Any] =
-0001baa0: 207b 226f 7022 3a20 226b 6579 2d69 6e2d   {"op": "key-in-
-0001bab0: 6d65 6d6f 7279 222c 2022 6b65 7922 3a20  memory", "key": 
-0001bac0: 7473 2e6b 6579 7d0a 2020 2020 2020 2020  ts.key}.        
-0001bad0: 2020 2020 6966 2074 7970 6520 6973 206e      if type is n
-0001bae0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-0001baf0: 2020 2020 2020 2020 2072 6570 6f72 745f           report_
-0001bb00: 6d73 675b 2274 7970 6522 5d20 3d20 7479  msg["type"] = ty
-0001bb10: 7065 0a20 2020 2020 2020 2020 2020 2066  pe.            f
-0001bb20: 6f72 2063 7320 696e 2074 732e 7768 6f5f  or cs in ts.who_
-0001bb30: 7761 6e74 733a 0a20 2020 2020 2020 2020  wants:.         
-0001bb40: 2020 2020 2020 2063 6c69 656e 745f 6d73         client_ms
-0001bb50: 6773 5b63 732e 636c 6965 6e74 5f6b 6579  gs[cs.client_key
-0001bb60: 5d20 3d20 5b72 6570 6f72 745f 6d73 675d  ] = [report_msg]
-0001bb70: 0a0a 2020 2020 2020 2020 7473 2e73 7461  ..        ts.sta
-0001bb80: 7465 203d 2022 6d65 6d6f 7279 220a 2020  te = "memory".  
-0001bb90: 2020 2020 2020 7473 2e74 7970 6520 3d20        ts.type = 
-0001bba0: 7479 7065 6e61 6d65 2020 2320 7479 7065  typename  # type
-0001bbb0: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
-0001bbc0: 2074 732e 6772 6f75 702e 7479 7065 732e   ts.group.types.
-0001bbd0: 6164 6428 7479 7065 6e61 6d65 2920 2023  add(typename)  #
-0001bbe0: 2074 7970 653a 2069 676e 6f72 650a 0a20   type: ignore.. 
-0001bbf0: 2020 2020 2020 2063 7320 3d20 7365 6c66         cs = self
-0001bc00: 2e63 6c69 656e 7473 5b22 6669 7265 2d61  .clients["fire-a
-0001bc10: 6e64 2d66 6f72 6765 7422 5d0a 2020 2020  nd-forget"].    
-0001bc20: 2020 2020 6966 2074 7320 696e 2063 732e      if ts in cs.
-0001bc30: 7761 6e74 735f 7768 6174 3a0a 2020 2020  wants_what:.    
-0001bc40: 2020 2020 2020 2020 7365 6c66 2e5f 636c          self._cl
-0001bc50: 6965 6e74 5f72 656c 6561 7365 735f 6b65  ient_releases_ke
-0001bc60: 7973 280a 2020 2020 2020 2020 2020 2020  ys(.            
-0001bc70: 2020 2020 6373 3d63 732c 0a20 2020 2020      cs=cs,.     
-0001bc80: 2020 2020 2020 2020 2020 206b 6579 733d             keys=
-0001bc90: 5b74 732e 6b65 795d 2c0a 2020 2020 2020  [ts.key],.      
-0001bca0: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
-0001bcb0: 656e 6461 7469 6f6e 733d 7265 636f 6d6d  endations=recomm
-0001bcc0: 656e 6461 7469 6f6e 732c 0a20 2020 2020  endations,.     
-0001bcd0: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
-0001bce0: 6620 5f70 726f 7061 6761 7465 5f72 656c  f _propagate_rel
-0001bcf0: 6561 7365 6428 7365 6c66 2c20 7473 3a20  eased(self, ts: 
-0001bd00: 5461 736b 5374 6174 652c 2072 6563 6f6d  TaskState, recom
-0001bd10: 6d65 6e64 6174 696f 6e73 3a20 5265 6373  mendations: Recs
-0001bd20: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0001bd30: 2020 2074 732e 7374 6174 6520 3d20 2272     ts.state = "r
-0001bd40: 656c 6561 7365 6422 0a20 2020 2020 2020  eleased".       
-0001bd50: 206b 6579 203d 2074 732e 6b65 790a 0a20   key = ts.key.. 
-0001bd60: 2020 2020 2020 2069 6620 7473 2e68 6173         if ts.has
-0001bd70: 5f6c 6f73 745f 6465 7065 6e64 656e 6369  _lost_dependenci
-0001bd80: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-0001bd90: 7265 636f 6d6d 656e 6461 7469 6f6e 735b  recommendations[
-0001bda0: 6b65 795d 203d 2022 666f 7267 6f74 7465  key] = "forgotte
-0001bdb0: 6e22 0a20 2020 2020 2020 2065 6c69 6620  n".        elif 
-0001bdc0: 7473 2e77 6169 7465 7273 206f 7220 7473  ts.waiters or ts
-0001bdd0: 2e77 686f 5f77 616e 7473 3a0a 2020 2020  .who_wants:.    
-0001bde0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-0001bdf0: 6461 7469 6f6e 735b 6b65 795d 203d 2022  dations[key] = "
-0001be00: 7761 6974 696e 6722 0a0a 2020 2020 2020  waiting"..      
-0001be10: 2020 6966 2072 6563 6f6d 6d65 6e64 6174    if recommendat
-0001be20: 696f 6e73 2e67 6574 286b 6579 2920 213d  ions.get(key) !=
-0001be30: 2022 7761 6974 696e 6722 3a0a 2020 2020   "waiting":.    
-0001be40: 2020 2020 2020 2020 666f 7220 6474 7320          for dts 
-0001be50: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
-0001be60: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-0001be70: 2020 2020 6966 2064 7473 2e73 7461 7465      if dts.state
-0001be80: 2021 3d20 2272 656c 6561 7365 6422 3a0a   != "released":.
-0001be90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bea0: 2020 2020 6474 732e 7761 6974 6572 732e      dts.waiters.
-0001beb0: 6469 7363 6172 6428 7473 290a 2020 2020  discard(ts).    
-0001bec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bed0: 6966 206e 6f74 2064 7473 2e77 6169 7465  if not dts.waite
-0001bee0: 7273 2061 6e64 206e 6f74 2064 7473 2e77  rs and not dts.w
-0001bef0: 686f 5f77 616e 7473 3a0a 2020 2020 2020  ho_wants:.      
-0001bf00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bf10: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-0001bf20: 735b 6474 732e 6b65 795d 203d 2022 7265  s[dts.key] = "re
-0001bf30: 6c65 6173 6564 220a 2020 2020 2020 2020  leased".        
-0001bf40: 2020 2020 7473 2e77 6169 7465 7273 2e63      ts.waiters.c
-0001bf50: 6c65 6172 2829 0a0a 2020 2020 2020 2020  lear()..        
-0001bf60: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
-0001bf70: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-0001bf80: 7365 7274 206e 6f74 2074 732e 7072 6f63  sert not ts.proc
-0001bf90: 6573 7369 6e67 5f6f 6e0a 2020 2020 2020  essing_on.      
-0001bfa0: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
-0001bfb0: 6e6f 7420 696e 2073 656c 662e 7175 6575  not in self.queu
-0001bfc0: 6564 0a0a 2020 2020 6465 6620 5f70 726f  ed..    def _pro
-0001bfd0: 7061 6761 7465 5f66 6f72 676f 7474 656e  pagate_forgotten
-0001bfe0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-0001bff0: 2020 2020 2020 2020 7473 3a20 5461 736b          ts: Task
-0001c000: 5374 6174 652c 0a20 2020 2020 2020 2072  State,.        r
-0001c010: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
-0001c020: 5265 6373 2c0a 2020 2020 2020 2020 776f  Recs,.        wo
-0001c030: 726b 6572 5f6d 7367 733a 204d 7367 732c  rker_msgs: Msgs,
-0001c040: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
-0001c050: 735f 6964 3a20 7374 722c 0a20 2020 2029  s_id: str,.    )
-0001c060: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0001c070: 2020 7473 2e73 7461 7465 203d 2022 666f    ts.state = "fo
-0001c080: 7267 6f74 7465 6e22 0a20 2020 2020 2020  rgotten".       
-0001c090: 2066 6f72 2064 7473 2069 6e20 7473 2e64   for dts in ts.d
-0001c0a0: 6570 656e 6465 6e74 733a 0a20 2020 2020  ependents:.     
-0001c0b0: 2020 2020 2020 2064 7473 2e68 6173 5f6c         dts.has_l
-0001c0c0: 6f73 745f 6465 7065 6e64 656e 6369 6573  ost_dependencies
-0001c0d0: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-0001c0e0: 2020 2020 6474 732e 6465 7065 6e64 656e      dts.dependen
-0001c0f0: 6369 6573 2e72 656d 6f76 6528 7473 290a  cies.remove(ts).
-0001c100: 2020 2020 2020 2020 2020 2020 6474 732e              dts.
-0001c110: 7761 6974 696e 675f 6f6e 2e64 6973 6361  waiting_on.disca
-0001c120: 7264 2874 7329 0a20 2020 2020 2020 2020  rd(ts).         
-0001c130: 2020 2069 6620 6474 732e 7374 6174 6520     if dts.state 
-0001c140: 6e6f 7420 696e 2028 226d 656d 6f72 7922  not in ("memory"
-0001c150: 2c20 2265 7272 6564 2229 3a0a 2020 2020  , "erred"):.    
-0001c160: 2020 2020 2020 2020 2020 2020 2320 4361              # Ca
-0001c170: 6e6e 6f74 2063 6f6d 7075 7465 2074 6173  nnot compute tas
-0001c180: 6b20 616e 796d 6f72 650a 2020 2020 2020  k anymore.      
-0001c190: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
-0001c1a0: 656e 6461 7469 6f6e 735b 6474 732e 6b65  endations[dts.ke
-0001c1b0: 795d 203d 2022 666f 7267 6f74 7465 6e22  y] = "forgotten"
-0001c1c0: 0a20 2020 2020 2020 2074 732e 6465 7065  .        ts.depe
-0001c1d0: 6e64 656e 7473 2e63 6c65 6172 2829 0a20  ndents.clear(). 
-0001c1e0: 2020 2020 2020 2074 732e 7761 6974 6572         ts.waiter
-0001c1f0: 732e 636c 6561 7228 290a 0a20 2020 2020  s.clear()..     
-0001c200: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
-0001c210: 2e64 6570 656e 6465 6e63 6965 733a 0a20  .dependencies:. 
-0001c220: 2020 2020 2020 2020 2020 2064 7473 2e64             dts.d
-0001c230: 6570 656e 6465 6e74 732e 7265 6d6f 7665  ependents.remove
-0001c240: 2874 7329 0a20 2020 2020 2020 2020 2020  (ts).           
-0001c250: 2064 7473 2e77 6169 7465 7273 2e64 6973   dts.waiters.dis
-0001c260: 6361 7264 2874 7329 0a20 2020 2020 2020  card(ts).       
-0001c270: 2020 2020 2069 6620 6e6f 7420 6474 732e       if not dts.
-0001c280: 6465 7065 6e64 656e 7473 2061 6e64 206e  dependents and n
-0001c290: 6f74 2064 7473 2e77 686f 5f77 616e 7473  ot dts.who_wants
-0001c2a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001c2b0: 2020 2320 5461 736b 206e 6f74 206e 6565    # Task not nee
-0001c2c0: 6465 6420 616e 796d 6f72 650a 2020 2020  ded anymore.    
-0001c2d0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0001c2e0: 7274 2064 7473 2069 7320 6e6f 7420 7473  rt dts is not ts
-0001c2f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c300: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-0001c310: 5b64 7473 2e6b 6579 5d20 3d20 2266 6f72  [dts.key] = "for
-0001c320: 676f 7474 656e 220a 2020 2020 2020 2020  gotten".        
-0001c330: 7473 2e64 6570 656e 6465 6e63 6965 732e  ts.dependencies.
-0001c340: 636c 6561 7228 290a 2020 2020 2020 2020  clear().        
-0001c350: 7473 2e77 6169 7469 6e67 5f6f 6e2e 636c  ts.waiting_on.cl
-0001c360: 6561 7228 290a 0a20 2020 2020 2020 2066  ear()..        f
-0001c370: 6f72 2077 7320 696e 2074 732e 7768 6f5f  or ws in ts.who_
-0001c380: 6861 733a 0a20 2020 2020 2020 2020 2020  has:.           
-0001c390: 2069 6620 7773 2e61 6464 7265 7373 2069   if ws.address i
-0001c3a0: 6e20 7365 6c66 2e77 6f72 6b65 7273 3a20  n self.workers: 
-0001c3b0: 2023 2069 6e20 6361 7365 2077 6f72 6b65   # in case worke
-0001c3c0: 7220 6861 7320 6469 6564 0a20 2020 2020  r has died.     
-0001c3d0: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
-0001c3e0: 725f 6d73 6773 5b77 732e 6164 6472 6573  r_msgs[ws.addres
-0001c3f0: 735d 203d 205b 0a20 2020 2020 2020 2020  s] = [.         
-0001c400: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00010e30: 2020 2020 6669 6e69 7368 2c0a 2020 2020      finish,.    
+00010e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010e50: 6163 7475 616c 5f66 696e 6973 682c 0a20  actual_finish,. 
+00010e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010e70: 2020 2064 6963 7428 7265 636f 6d6d 656e     dict(recommen
+00010e80: 6461 7469 6f6e 7329 2c0a 2020 2020 2020  dations),.      
+00010e90: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00010ea0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00010eb0: 706c 7567 696e 733a 0a20 2020 2020 2020  plugins:.       
+00010ec0: 2020 2020 2020 2020 2023 2054 656d 706f           # Tempo
+00010ed0: 7261 7269 6c79 2070 7574 2062 6163 6b20  rarily put back 
+00010ee0: 666f 7267 6f74 7465 6e20 6b65 7920 666f  forgotten key fo
+00010ef0: 7220 706c 7567 696e 2074 6f20 7265 7472  r plugin to retr
+00010f00: 6965 7665 2069 740a 2020 2020 2020 2020  ieve it.        
+00010f10: 2020 2020 2020 2020 6966 2074 732e 5f73          if ts._s
+00010f20: 7461 7465 203d 3d20 2266 6f72 676f 7474  tate == "forgott
+00010f30: 656e 223a 0a20 2020 2020 2020 2020 2020  en":.           
+00010f40: 2020 2020 2020 2020 2074 732e 6465 7065           ts.depe
+00010f50: 6e64 656e 7473 203d 2064 6570 656e 6465  ndents = depende
+00010f60: 6e74 730a 2020 2020 2020 2020 2020 2020  nts.            
+00010f70: 2020 2020 2020 2020 7473 2e64 6570 656e          ts.depen
+00010f80: 6465 6e63 6965 7320 3d20 6465 7065 6e64  dencies = depend
+00010f90: 656e 6369 6573 0a20 2020 2020 2020 2020  encies.         
+00010fa0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00010fb0: 7461 736b 735b 7473 2e6b 6579 5d20 3d20  tasks[ts.key] = 
+00010fc0: 7473 0a20 2020 2020 2020 2020 2020 2020  ts.             
+00010fd0: 2020 2066 6f72 2070 6c75 6769 6e20 696e     for plugin in
+00010fe0: 206c 6973 7428 7365 6c66 2e70 6c75 6769   list(self.plugi
+00010ff0: 6e73 2e76 616c 7565 7328 2929 3a0a 2020  ns.values()):.  
+00011000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011010: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00011020: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00011030: 6c75 6769 6e2e 7472 616e 7369 7469 6f6e  lugin.transition
+00011040: 286b 6579 2c20 7374 6172 742c 2061 6374  (key, start, act
+00011050: 7561 6c5f 6669 6e69 7368 2c20 2a2a 6b77  ual_finish, **kw
+00011060: 6172 6773 290a 2020 2020 2020 2020 2020  args).          
+00011070: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00011080: 2045 7863 6570 7469 6f6e 3a0a 2020 2020   Exception:.    
+00011090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000110a0: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+000110b0: 2250 6c75 6769 6e20 6661 696c 6564 2077  "Plugin failed w
+000110c0: 6974 6820 6578 6365 7074 696f 6e22 2c20  ith exception", 
+000110d0: 6578 635f 696e 666f 3d54 7275 6529 0a20  exc_info=True). 
+000110e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000110f0: 6620 7473 2e73 7461 7465 203d 3d20 2266  f ts.state == "f
+00011100: 6f72 676f 7474 656e 223a 0a20 2020 2020  orgotten":.     
+00011110: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00011120: 656c 2073 656c 662e 7461 736b 735b 7473  el self.tasks[ts
+00011130: 2e6b 6579 5d0a 0a20 2020 2020 2020 2020  .key]..         
+00011140: 2020 2074 6720 3d20 7473 2e67 726f 7570     tg = ts.group
+00011150: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00011160: 7473 2e73 7461 7465 203d 3d20 2266 6f72  ts.state == "for
+00011170: 676f 7474 656e 2220 616e 6420 7467 2e6e  gotten" and tg.n
+00011180: 616d 6520 696e 2073 656c 662e 7461 736b  ame in self.task
+00011190: 5f67 726f 7570 733a 0a20 2020 2020 2020  _groups:.       
+000111a0: 2020 2020 2020 2020 2023 2052 656d 6f76           # Remov
+000111b0: 6520 5461 736b 4772 6f75 7020 6966 2061  e TaskGroup if a
+000111c0: 6c6c 2074 6173 6b73 2061 7265 2069 6e20  ll tasks are in 
+000111d0: 7468 6520 666f 7267 6f74 7465 6e20 7374  the forgotten st
+000111e0: 6174 650a 2020 2020 2020 2020 2020 2020  ate.            
+000111f0: 2020 2020 6966 2061 6c6c 2876 203d 3d20      if all(v == 
+00011200: 3020 6f72 206b 203d 3d20 2266 6f72 676f  0 or k == "forgo
+00011210: 7474 656e 2220 666f 7220 6b2c 2076 2069  tten" for k, v i
+00011220: 6e20 7467 2e73 7461 7465 732e 6974 656d  n tg.states.item
+00011230: 7328 2929 3a0a 2020 2020 2020 2020 2020  s()):.          
+00011240: 2020 2020 2020 2020 2020 7473 2e70 7265            ts.pre
+00011250: 6669 782e 6772 6f75 7073 2e72 656d 6f76  fix.groups.remov
+00011260: 6528 7467 290a 2020 2020 2020 2020 2020  e(tg).          
+00011270: 2020 2020 2020 2020 2020 6465 6c20 7365            del se
+00011280: 6c66 2e74 6173 6b5f 6772 6f75 7073 5b74  lf.task_groups[t
+00011290: 672e 6e61 6d65 5d0a 0a20 2020 2020 2020  g.name]..       
+000112a0: 2020 2020 2072 6574 7572 6e20 7265 636f       return reco
+000112b0: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
+000112c0: 656e 745f 6d73 6773 2c20 776f 726b 6572  ent_msgs, worker
+000112d0: 5f6d 7367 730a 2020 2020 2020 2020 6578  _msgs.        ex
+000112e0: 6365 7074 2045 7863 6570 7469 6f6e 3a0a  cept Exception:.
+000112f0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00011300: 6572 2e65 7863 6570 7469 6f6e 2822 4572  er.exception("Er
+00011310: 726f 7220 7472 616e 7369 7469 6f6e 696e  ror transitionin
+00011320: 6720 2572 2066 726f 6d20 2572 2074 6f20  g %r from %r to 
+00011330: 2572 222c 206b 6579 2c20 7374 6172 742c  %r", key, start,
+00011340: 2066 696e 6973 6829 0a20 2020 2020 2020   finish).       
+00011350: 2020 2020 2069 6620 4c4f 475f 5044 423a       if LOG_PDB:
+00011360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011370: 2069 6d70 6f72 7420 7064 620a 0a20 2020   import pdb..   
+00011380: 2020 2020 2020 2020 2020 2020 2070 6462               pdb
+00011390: 2e73 6574 5f74 7261 6365 2829 0a20 2020  .set_trace().   
+000113a0: 2020 2020 2020 2020 2072 6169 7365 0a0a           raise..
+000113b0: 2020 2020 6465 6620 5f74 7261 6e73 6974      def _transit
+000113c0: 696f 6e73 280a 2020 2020 2020 2020 7365  ions(.        se
+000113d0: 6c66 2c0a 2020 2020 2020 2020 7265 636f  lf,.        reco
+000113e0: 6d6d 656e 6461 7469 6f6e 733a 2052 6563  mmendations: Rec
+000113f0: 732c 0a20 2020 2020 2020 2063 6c69 656e  s,.        clien
+00011400: 745f 6d73 6773 3a20 4d73 6773 2c0a 2020  t_msgs: Msgs,.  
+00011410: 2020 2020 2020 776f 726b 6572 5f6d 7367        worker_msg
+00011420: 733a 204d 7367 732c 0a20 2020 2020 2020  s: Msgs,.       
+00011430: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
+00011440: 722c 0a20 2020 2029 202d 3e20 4e6f 6e65  r,.    ) -> None
+00011450: 3a0a 2020 2020 2020 2020 2222 2250 726f  :.        """Pro
+00011460: 6365 7373 2074 7261 6e73 6974 696f 6e73  cess transitions
+00011470: 2075 6e74 696c 206e 6f6e 6520 6172 6520   until none are 
+00011480: 6c65 6674 0a0a 2020 2020 2020 2020 5468  left..        Th
+00011490: 6973 2069 6e63 6c75 6465 7320 6665 6564  is includes feed
+000114a0: 6261 636b 2066 726f 6d20 7072 6576 696f  back from previo
+000114b0: 7573 2074 7261 6e73 6974 696f 6e73 2061  us transitions a
+000114c0: 6e64 2063 6f6e 7469 6e75 6573 2075 6e74  nd continues unt
+000114d0: 696c 2077 650a 2020 2020 2020 2020 7265  il we.        re
+000114e0: 6163 6820 6120 7374 6561 6479 2073 7461  ach a steady sta
+000114f0: 7465 0a20 2020 2020 2020 2022 2222 0a20  te.        """. 
+00011500: 2020 2020 2020 206b 6579 733a 2073 6574         keys: set
+00011510: 5b73 7472 5d20 3d20 7365 7428 290a 2020  [str] = set().  
+00011520: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
+00011530: 7469 6f6e 7320 3d20 7265 636f 6d6d 656e  tions = recommen
+00011540: 6461 7469 6f6e 732e 636f 7079 2829 0a0a  dations.copy()..
+00011550: 2020 2020 2020 2020 7768 696c 6520 7265          while re
+00011560: 636f 6d6d 656e 6461 7469 6f6e 733a 0a20  commendations:. 
+00011570: 2020 2020 2020 2020 2020 206b 6579 2c20             key, 
+00011580: 6669 6e69 7368 203d 2072 6563 6f6d 6d65  finish = recomme
+00011590: 6e64 6174 696f 6e73 2e70 6f70 6974 656d  ndations.popitem
+000115a0: 2829 0a20 2020 2020 2020 2020 2020 206b  ().            k
+000115b0: 6579 732e 6164 6428 6b65 7929 0a0a 2020  eys.add(key)..  
+000115c0: 2020 2020 2020 2020 2020 6e65 775f 7265            new_re
+000115d0: 6373 2c20 6e65 775f 636d 7367 732c 206e  cs, new_cmsgs, n
+000115e0: 6577 5f77 6d73 6773 203d 2073 656c 662e  ew_wmsgs = self.
+000115f0: 5f74 7261 6e73 6974 696f 6e28 6b65 792c  _transition(key,
+00011600: 2066 696e 6973 682c 2073 7469 6d75 6c75   finish, stimulu
+00011610: 735f 6964 290a 0a20 2020 2020 2020 2020  s_id)..         
+00011620: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
+00011630: 6e73 2e75 7064 6174 6528 6e65 775f 7265  ns.update(new_re
+00011640: 6373 290a 2020 2020 2020 2020 2020 2020  cs).            
+00011650: 666f 7220 632c 206e 6577 5f6d 7367 7320  for c, new_msgs 
+00011660: 696e 206e 6577 5f63 6d73 6773 2e69 7465  in new_cmsgs.ite
+00011670: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+00011680: 2020 2020 2020 636c 6965 6e74 5f6d 7367        client_msg
+00011690: 732e 7365 7464 6566 6175 6c74 2863 2c20  s.setdefault(c, 
+000116a0: 5b5d 292e 6578 7465 6e64 286e 6577 5f6d  []).extend(new_m
+000116b0: 7367 7329 0a20 2020 2020 2020 2020 2020  sgs).           
+000116c0: 2066 6f72 2077 2c20 6e65 775f 6d73 6773   for w, new_msgs
+000116d0: 2069 6e20 6e65 775f 776d 7367 732e 6974   in new_wmsgs.it
+000116e0: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
+000116f0: 2020 2020 2020 2077 6f72 6b65 725f 6d73         worker_ms
+00011700: 6773 2e73 6574 6465 6661 756c 7428 772c  gs.setdefault(w,
+00011710: 205b 5d29 2e65 7874 656e 6428 6e65 775f   []).extend(new_
+00011720: 6d73 6773 290a 0a20 2020 2020 2020 2069  msgs)..        i
+00011730: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
+00011740: 0a20 2020 2020 2020 2020 2020 2023 2046  .            # F
+00011750: 4958 4d45 2064 6f77 6e63 6173 7420 616e  IXME downcast an
+00011760: 7469 7061 7474 6572 6e0a 2020 2020 2020  tipattern.      
+00011770: 2020 2020 2020 7363 6865 6475 6c65 7220        scheduler 
+00011780: 3d20 6361 7374 2853 6368 6564 756c 6572  = cast(Scheduler
+00011790: 2c20 7365 6c66 290a 2020 2020 2020 2020  , self).        
+000117a0: 2020 2020 666f 7220 6b65 7920 696e 206b      for key in k
+000117b0: 6579 733a 0a20 2020 2020 2020 2020 2020  eys:.           
+000117c0: 2020 2020 2073 6368 6564 756c 6572 2e76       scheduler.v
+000117d0: 616c 6964 6174 655f 6b65 7928 6b65 7929  alidate_key(key)
+000117e0: 0a0a 2020 2020 6465 6620 7472 616e 7369  ..    def transi
+000117f0: 7469 6f6e 5f72 656c 6561 7365 645f 7761  tion_released_wa
+00011800: 6974 696e 6728 7365 6c66 2c20 6b65 793a  iting(self, key:
+00011810: 2073 7472 2c20 7374 696d 756c 7573 5f69   str, stimulus_i
+00011820: 643a 2073 7472 2920 2d3e 2052 6563 734d  d: str) -> RecsM
+00011830: 7367 733a 0a20 2020 2020 2020 2074 7320  sgs:.        ts 
+00011840: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
+00011850: 5d0a 0a20 2020 2020 2020 2069 6620 7365  ]..        if se
+00011860: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
+00011870: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00011880: 7473 2e72 756e 5f73 7065 630a 2020 2020  ts.run_spec.    
+00011890: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+000118a0: 6f74 2074 732e 7761 6974 696e 675f 6f6e  ot ts.waiting_on
+000118b0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+000118c0: 6572 7420 6e6f 7420 7473 2e77 686f 5f68  ert not ts.who_h
+000118d0: 6173 0a20 2020 2020 2020 2020 2020 2061  as.            a
+000118e0: 7373 6572 7420 6e6f 7420 7473 2e70 726f  ssert not ts.pro
+000118f0: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
+00011900: 2020 2020 2020 2066 6f72 2064 7473 2069         for dts i
+00011910: 6e20 7473 2e64 6570 656e 6465 6e63 6965  n ts.dependencie
+00011920: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00011930: 2020 2061 7373 6572 7420 6474 732e 7374     assert dts.st
+00011940: 6174 6520 6e6f 7420 696e 207b 2266 6f72  ate not in {"for
+00011950: 676f 7474 656e 222c 2022 6572 7265 6422  gotten", "erred"
+00011960: 7d0a 0a20 2020 2020 2020 2069 6620 7473  }..        if ts
+00011970: 2e68 6173 5f6c 6f73 745f 6465 7065 6e64  .has_lost_depend
+00011980: 656e 6369 6573 3a0a 2020 2020 2020 2020  encies:.        
+00011990: 2020 2020 7265 7475 726e 207b 6b65 793a      return {key:
+000119a0: 2022 666f 7267 6f74 7465 6e22 7d2c 207b   "forgotten"}, {
+000119b0: 7d2c 207b 7d0a 0a20 2020 2020 2020 2074  }, {}..        t
+000119c0: 732e 7374 6174 6520 3d20 2277 6169 7469  s.state = "waiti
+000119d0: 6e67 220a 0a20 2020 2020 2020 2072 6563  ng"..        rec
+000119e0: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
+000119f0: 6373 203d 207b 7d0a 0a20 2020 2020 2020  cs = {}..       
+00011a00: 2066 6f72 2064 7473 2069 6e20 7473 2e64   for dts in ts.d
+00011a10: 6570 656e 6465 6e63 6965 733a 0a20 2020  ependencies:.   
+00011a20: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00011a30: 6474 732e 7768 6f5f 6861 733a 0a20 2020  dts.who_has:.   
+00011a40: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
+00011a50: 7761 6974 696e 675f 6f6e 2e61 6464 2864  waiting_on.add(d
+00011a60: 7473 290a 2020 2020 2020 2020 2020 2020  ts).            
+00011a70: 6966 2064 7473 2e73 7461 7465 203d 3d20  if dts.state == 
+00011a80: 2272 656c 6561 7365 6422 3a0a 2020 2020  "released":.    
+00011a90: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+00011aa0: 6d6d 656e 6461 7469 6f6e 735b 6474 732e  mmendations[dts.
+00011ab0: 6b65 795d 203d 2022 7761 6974 696e 6722  key] = "waiting"
+00011ac0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00011ad0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00011ae0: 2020 2064 7473 2e77 6169 7465 7273 2e61     dts.waiters.a
+00011af0: 6464 2874 7329 0a0a 2020 2020 2020 2020  dd(ts)..        
+00011b00: 7473 2e77 6169 7465 7273 203d 207b 6474  ts.waiters = {dt
+00011b10: 7320 666f 7220 6474 7320 696e 2074 732e  s for dts in ts.
+00011b20: 6465 7065 6e64 656e 7473 2069 6620 6474  dependents if dt
+00011b30: 732e 7374 6174 6520 3d3d 2022 7761 6974  s.state == "wait
+00011b40: 696e 6722 7d0a 0a20 2020 2020 2020 2069  ing"}..        i
+00011b50: 6620 6e6f 7420 7473 2e77 6169 7469 6e67  f not ts.waiting
+00011b60: 5f6f 6e3a 0a20 2020 2020 2020 2020 2020  _on:.           
+00011b70: 2023 204e 4f54 453a 2077 6169 7469 6e67   # NOTE: waiting
+00011b80: 2d3e 7072 6f63 6573 7369 6e67 2077 696c  ->processing wil
+00011b90: 6c20 7365 6e64 2074 6173 6b73 2074 6f20  l send tasks to 
+00011ba0: 7175 6575 6564 206f 7220 6e6f 2d77 6f72  queued or no-wor
+00011bb0: 6b65 7220 6173 0a20 2020 2020 2020 2020  ker as.         
+00011bc0: 2020 2023 206e 6563 6573 7361 7279 0a20     # necessary. 
+00011bd0: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
+00011be0: 6d65 6e64 6174 696f 6e73 5b6b 6579 5d20  mendations[key] 
+00011bf0: 3d20 2270 726f 6365 7373 696e 6722 0a0a  = "processing"..
+00011c00: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+00011c10: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
+00011c20: 7b7d 2c20 7b7d 0a0a 2020 2020 6465 6620  {}, {}..    def 
+00011c30: 7472 616e 7369 7469 6f6e 5f6e 6f5f 776f  transition_no_wo
+00011c40: 726b 6572 5f70 726f 6365 7373 696e 6728  rker_processing(
+00011c50: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
+00011c60: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
+00011c70: 2920 2d3e 2052 6563 734d 7367 733a 0a20  ) -> RecsMsgs:. 
+00011c80: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+00011c90: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
+00011ca0: 2020 2020 776f 726b 6572 5f6d 7367 733a      worker_msgs:
+00011cb0: 204d 7367 7320 3d20 7b7d 0a0a 2020 2020   Msgs = {}..    
+00011cc0: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
+00011cd0: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
+00011ce0: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
+00011cf0: 6163 746f 722c 2066 2241 6374 6f72 7320  actor, f"Actors 
+00011d00: 6361 6e27 7420 6265 2069 6e20 606e 6f2d  can't be in `no-
+00011d10: 776f 726b 6572 603a 207b 7473 7d22 0a20  worker`: {ts}". 
+00011d20: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00011d30: 7420 7473 2069 6e20 7365 6c66 2e75 6e72  t ts in self.unr
+00011d40: 756e 6e61 626c 650a 0a20 2020 2020 2020  unnable..       
+00011d50: 2069 6620 7773 203a 3d20 7365 6c66 2e64   if ws := self.d
+00011d60: 6563 6964 655f 776f 726b 6572 5f6e 6f6e  ecide_worker_non
+00011d70: 5f72 6f6f 7469 7368 2874 7329 3a0a 2020  _rootish(ts):.  
+00011d80: 2020 2020 2020 2020 2020 7365 6c66 2e75            self.u
+00011d90: 6e72 756e 6e61 626c 652e 6469 7363 6172  nrunnable.discar
+00011da0: 6428 7473 290a 2020 2020 2020 2020 2020  d(ts).          
+00011db0: 2020 776f 726b 6572 5f6d 7367 7320 3d20    worker_msgs = 
+00011dc0: 7365 6c66 2e5f 6164 645f 746f 5f70 726f  self._add_to_pro
+00011dd0: 6365 7373 696e 6728 7473 2c20 7773 290a  cessing(ts, ws).
+00011de0: 2020 2020 2020 2020 2320 4966 206e 6f20          # If no 
+00011df0: 776f 726b 6572 2c20 7461 736b 206a 7573  worker, task jus
+00011e00: 7420 7374 6179 7320 696e 2060 6e6f 2d77  t stays in `no-w
+00011e10: 6f72 6b65 7260 0a0a 2020 2020 2020 2020  orker`..        
+00011e20: 7265 7475 726e 207b 7d2c 207b 7d2c 2077  return {}, {}, w
+00011e30: 6f72 6b65 725f 6d73 6773 0a0a 2020 2020  orker_msgs..    
+00011e40: 6465 6620 6465 6369 6465 5f77 6f72 6b65  def decide_worke
+00011e50: 725f 726f 6f74 6973 685f 7175 6575 696e  r_rootish_queuin
+00011e60: 675f 6469 7361 626c 6564 280a 2020 2020  g_disabled(.    
+00011e70: 2020 2020 7365 6c66 2c20 7473 3a20 5461      self, ts: Ta
+00011e80: 736b 5374 6174 650a 2020 2020 2920 2d3e  skState.    ) ->
+00011e90: 2057 6f72 6b65 7253 7461 7465 207c 204e   WorkerState | N
+00011ea0: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+00011eb0: 5069 636b 2061 2077 6f72 6b65 7220 666f  Pick a worker fo
+00011ec0: 7220 6120 7275 6e6e 6162 6c65 2072 6f6f  r a runnable roo
+00011ed0: 742d 6973 6820 7461 736b 2c20 7769 7468  t-ish task, with
+00011ee0: 6f75 7420 7175 6575 696e 672e 0a0a 2020  out queuing...  
+00011ef0: 2020 2020 2020 5468 6973 2061 7474 656d        This attem
+00011f00: 7074 7320 746f 2073 6368 6564 756c 6520  pts to schedule 
+00011f10: 7369 626c 696e 6720 7461 736b 7320 6f6e  sibling tasks on
+00011f20: 2074 6865 2073 616d 6520 776f 726b 6572   the same worker
+00011f30: 2c20 7265 6475 6369 6e67 2066 7574 7572  , reducing futur
+00011f40: 6520 6461 7461 0a20 2020 2020 2020 2074  e data.        t
+00011f50: 7261 6e73 6665 722e 2049 7420 646f 6573  ransfer. It does
+00011f60: 206e 6f74 2063 6f6e 7369 6465 7220 7468   not consider th
+00011f70: 6520 6c6f 6361 7469 6f6e 206f 6620 6465  e location of de
+00011f80: 7065 6e64 656e 6369 6573 2c20 7369 6e63  pendencies, sinc
+00011f90: 6520 7468 6579 276c 6c20 656e 640a 2020  e they'll end.  
+00011fa0: 2020 2020 2020 7570 206f 6e20 6576 6572        up on ever
+00011fb0: 7920 776f 726b 6572 2061 6e79 7761 792e  y worker anyway.
+00011fc0: 0a0a 2020 2020 2020 2020 4974 2061 7373  ..        It ass
+00011fd0: 756d 6573 2069 7427 7320 6265 696e 6720  umes it's being 
+00011fe0: 6361 6c6c 6564 206f 6e20 6120 6261 7463  called on a batc
+00011ff0: 6820 6f66 2074 6173 6b73 2069 6e20 7072  h of tasks in pr
+00012000: 696f 7269 7479 206f 7264 6572 2c20 616e  iority order, an
+00012010: 640a 2020 2020 2020 2020 6d61 696e 7461  d.        mainta
+00012020: 696e 7320 7374 6174 6520 696e 2060 5363  ins state in `Sc
+00012030: 6865 6475 6c65 7253 7461 7465 2e6c 6173  hedulerState.las
+00012040: 745f 726f 6f74 5f77 6f72 6b65 7260 2061  t_root_worker` a
+00012050: 6e64 0a20 2020 2020 2020 2060 5363 6865  nd.        `Sche
+00012060: 6475 6c65 7253 7461 7465 2e6c 6173 745f  dulerState.last_
+00012070: 726f 6f74 5f77 6f72 6b65 725f 7461 736b  root_worker_task
+00012080: 735f 6c65 6674 6020 746f 2061 6368 6965  s_left` to achie
+00012090: 7665 2074 6869 732e 0a0a 2020 2020 2020  ve this...      
+000120a0: 2020 5468 6973 2077 696c 6c20 7365 6e64    This will send
+000120b0: 2065 7665 7279 2072 756e 6e61 626c 6520   every runnable 
+000120c0: 7461 736b 2074 6f20 6120 776f 726b 6572  task to a worker
+000120d0: 2c20 6f66 7465 6e20 6361 7573 696e 6720  , often causing 
+000120e0: 726f 6f74 2074 6173 6b0a 2020 2020 2020  root task.      
+000120f0: 2020 6f76 6572 7072 6f64 7563 7469 6f6e    overproduction
+00012100: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
+00012110: 6e73 0a20 2020 2020 2020 202d 2d2d 2d2d  ns.        -----
+00012120: 2d2d 0a20 2020 2020 2020 2077 733a 2057  --.        ws: W
+00012130: 6f72 6b65 7253 7461 7465 207c 204e 6f6e  orkerState | Non
+00012140: 650a 2020 2020 2020 2020 2020 2020 5468  e.            Th
+00012150: 6520 776f 726b 6572 2074 6f20 6173 7369  e worker to assi
+00012160: 676e 2074 6865 2074 6173 6b20 746f 2e20  gn the task to. 
+00012170: 4966 2074 6865 7265 2061 7265 206e 6f20  If there are no 
+00012180: 776f 726b 6572 7320 696e 2074 6865 2063  workers in the c
+00012190: 6c75 7374 6572 2c0a 2020 2020 2020 2020  luster,.        
+000121a0: 2020 2020 7265 7475 726e 7320 4e6f 6e65      returns None
+000121b0: 2c20 696e 2077 6869 6368 2063 6173 6520  , in which case 
+000121c0: 7468 6520 7461 736b 2073 686f 756c 6420  the task should 
+000121d0: 6265 2074 7261 6e73 6974 696f 6e65 6420  be transitioned 
+000121e0: 746f 0a20 2020 2020 2020 2020 2020 2060  to.            `
+000121f0: 606e 6f2d 776f 726b 6572 6060 2e0a 2020  `no-worker``..  
+00012200: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00012210: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
+00012220: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+00012230: 2320 5365 6520 726f 6f74 2d69 7368 2d6e  # See root-ish-n
+00012240: 6573 7320 6e6f 7465 2062 656c 6f77 2069  ess note below i
+00012250: 6e20 6064 6563 6964 655f 776f 726b 6572  n `decide_worker
+00012260: 5f72 6f6f 7469 7368 5f71 7565 7569 6e67  _rootish_queuing
+00012270: 5f65 6e61 626c 6564 600a 2020 2020 2020  _enabled`.      
+00012280: 2020 2020 2020 6173 7365 7274 206d 6174        assert mat
+00012290: 682e 6973 696e 6628 7365 6c66 2e57 4f52  h.isinf(self.WOR
+000122a0: 4b45 525f 5341 5455 5241 5449 4f4e 290a  KER_SATURATION).
+000122b0: 0a20 2020 2020 2020 2070 6f6f 6c20 3d20  .        pool = 
+000122c0: 7365 6c66 2e69 646c 652e 7661 6c75 6573  self.idle.values
+000122d0: 2829 2069 6620 7365 6c66 2e69 646c 6520  () if self.idle 
+000122e0: 656c 7365 2073 656c 662e 7275 6e6e 696e  else self.runnin
+000122f0: 670a 2020 2020 2020 2020 6966 206e 6f74  g.        if not
+00012300: 2070 6f6f 6c3a 0a20 2020 2020 2020 2020   pool:.         
+00012310: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
+00012320: 2020 2020 2020 2020 7467 203d 2074 732e          tg = ts.
+00012330: 6772 6f75 700a 2020 2020 2020 2020 6c77  group.        lw
+00012340: 7320 3d20 7467 2e6c 6173 745f 776f 726b  s = tg.last_work
+00012350: 6572 0a20 2020 2020 2020 2069 6620 280a  er.        if (.
+00012360: 2020 2020 2020 2020 2020 2020 6c77 730a              lws.
+00012370: 2020 2020 2020 2020 2020 2020 616e 6420              and 
+00012380: 7467 2e6c 6173 745f 776f 726b 6572 5f74  tg.last_worker_t
+00012390: 6173 6b73 5f6c 6566 740a 2020 2020 2020  asks_left.      
+000123a0: 2020 2020 2020 616e 6420 6c77 732e 7374        and lws.st
+000123b0: 6174 7573 203d 3d20 5374 6174 7573 2e72  atus == Status.r
+000123c0: 756e 6e69 6e67 0a20 2020 2020 2020 2020  unning.         
+000123d0: 2020 2061 6e64 2073 656c 662e 776f 726b     and self.work
+000123e0: 6572 732e 6765 7428 6c77 732e 6164 6472  ers.get(lws.addr
+000123f0: 6573 7329 2069 7320 6c77 730a 2020 2020  ess) is lws.    
+00012400: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
+00012410: 2020 2077 7320 3d20 6c77 730a 2020 2020     ws = lws.    
+00012420: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00012430: 2020 2020 2020 2320 4c61 7374 2d75 7365        # Last-use
+00012440: 6420 776f 726b 6572 2069 7320 6675 6c6c  d worker is full
+00012450: 2c20 756e 6b6e 6f77 6e2c 2072 6574 6972  , unknown, retir
+00012460: 696e 672c 206f 7220 7061 7573 6564 3b0a  ing, or paused;.
+00012470: 2020 2020 2020 2020 2020 2020 2320 7069              # pi
+00012480: 636b 2061 206e 6577 2077 6f72 6b65 7220  ck a new worker 
+00012490: 666f 7220 7468 6520 6e65 7874 2066 6577  for the next few
+000124a0: 2074 6173 6b73 0a20 2020 2020 2020 2020   tasks.         
+000124b0: 2020 2077 7320 3d20 6d69 6e28 706f 6f6c     ws = min(pool
+000124c0: 2c20 6b65 793d 7061 7274 6961 6c28 7365  , key=partial(se
+000124d0: 6c66 2e77 6f72 6b65 725f 6f62 6a65 6374  lf.worker_object
+000124e0: 6976 652c 2074 7329 290a 2020 2020 2020  ive, ts)).      
+000124f0: 2020 2020 2020 7467 2e6c 6173 745f 776f        tg.last_wo
+00012500: 726b 6572 5f74 6173 6b73 5f6c 6566 7420  rker_tasks_left 
+00012510: 3d20 6d61 7468 2e66 6c6f 6f72 280a 2020  = math.floor(.  
+00012520: 2020 2020 2020 2020 2020 2020 2020 286c                (l
+00012530: 656e 2874 6729 202f 2073 656c 662e 746f  en(tg) / self.to
+00012540: 7461 6c5f 6e74 6872 6561 6473 2920 2a20  tal_nthreads) * 
+00012550: 7773 2e6e 7468 7265 6164 730a 2020 2020  ws.nthreads.    
+00012560: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00012570: 2020 2023 2052 6563 6f72 6420 606c 6173     # Record `las
+00012580: 745f 776f 726b 6572 602c 206f 7220 636c  t_worker`, or cl
+00012590: 6561 7220 6974 206f 6e20 7468 6520 6669  ear it on the fi
+000125a0: 6e61 6c20 7461 736b 0a20 2020 2020 2020  nal task.       
+000125b0: 2074 672e 6c61 7374 5f77 6f72 6b65 7220   tg.last_worker 
+000125c0: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+000125d0: 7773 2069 6620 7467 2e73 7461 7465 735b  ws if tg.states[
+000125e0: 2272 656c 6561 7365 6422 5d20 2b20 7467  "released"] + tg
+000125f0: 2e73 7461 7465 735b 2277 6169 7469 6e67  .states["waiting
+00012600: 225d 203e 2031 2065 6c73 6520 4e6f 6e65  "] > 1 else None
+00012610: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00012620: 2020 2074 672e 6c61 7374 5f77 6f72 6b65     tg.last_worke
+00012630: 725f 7461 736b 735f 6c65 6674 202d 3d20  r_tasks_left -= 
+00012640: 310a 0a20 2020 2020 2020 2069 6620 7365  1..        if se
+00012650: 6c66 2e76 616c 6964 6174 6520 616e 6420  lf.validate and 
+00012660: 7773 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ws is not None:.
+00012670: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00012680: 7274 2073 656c 662e 776f 726b 6572 732e  rt self.workers.
+00012690: 6765 7428 7773 2e61 6464 7265 7373 2920  get(ws.address) 
+000126a0: 6973 2077 730a 2020 2020 2020 2020 2020  is ws.          
+000126b0: 2020 6173 7365 7274 2077 7320 696e 2073    assert ws in s
+000126c0: 656c 662e 7275 6e6e 696e 672c 2028 7773  elf.running, (ws
+000126d0: 2c20 7365 6c66 2e72 756e 6e69 6e67 290a  , self.running).
+000126e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000126f0: 7773 0a0a 2020 2020 6465 6620 6465 6369  ws..    def deci
+00012700: 6465 5f77 6f72 6b65 725f 726f 6f74 6973  de_worker_rootis
+00012710: 685f 7175 6575 696e 675f 656e 6162 6c65  h_queuing_enable
+00012720: 6428 7365 6c66 2920 2d3e 2057 6f72 6b65  d(self) -> Worke
+00012730: 7253 7461 7465 207c 204e 6f6e 653a 0a20  rState | None:. 
+00012740: 2020 2020 2020 2022 2222 5069 636b 2061         """Pick a
+00012750: 2077 6f72 6b65 7220 666f 7220 6120 7275   worker for a ru
+00012760: 6e6e 6162 6c65 2072 6f6f 742d 6973 6820  nnable root-ish 
+00012770: 7461 736b 2c20 6966 206e 6f74 2061 6c6c  task, if not all
+00012780: 2061 7265 2062 7573 792e 0a0a 2020 2020   are busy...    
+00012790: 2020 2020 5069 636b 7320 7468 6520 6c65      Picks the le
+000127a0: 6173 742d 6275 7379 2077 6f72 6b65 7220  ast-busy worker 
+000127b0: 6f75 7420 6f66 2074 6865 2060 6069 646c  out of the ``idl
+000127c0: 6560 6020 776f 726b 6572 7320 2869 646c  e`` workers (idl
+000127d0: 6520 776f 726b 6572 7320 6861 7665 2066  e workers have f
+000127e0: 6577 6572 0a20 2020 2020 2020 2074 6173  ewer.        tas
+000127f0: 6b73 2072 756e 6e69 6e67 2074 6861 6e20  ks running than 
+00012800: 7468 7265 6164 732c 2061 7320 7365 7420  threads, as set 
+00012810: 6279 2060 6064 6973 7472 6962 7574 6564  by ``distributed
+00012820: 2e73 6368 6564 756c 6572 2e77 6f72 6b65  .scheduler.worke
+00012830: 722d 7361 7475 7261 7469 6f6e 6060 292e  r-saturation``).
+00012840: 0a20 2020 2020 2020 2049 7420 646f 6573  .        It does
+00012850: 206e 6f74 2063 6f6e 7369 6465 7220 7468   not consider th
+00012860: 6520 6c6f 6361 7469 6f6e 206f 6620 6465  e location of de
+00012870: 7065 6e64 656e 6369 6573 2c20 7369 6e63  pendencies, sinc
+00012880: 6520 7468 6579 276c 6c20 656e 6420 7570  e they'll end up
+00012890: 206f 6e20 6576 6572 790a 2020 2020 2020   on every.      
+000128a0: 2020 776f 726b 6572 2061 6e79 7761 792e    worker anyway.
+000128b0: 0a0a 2020 2020 2020 2020 4966 2061 6c6c  ..        If all
+000128c0: 2077 6f72 6b65 7273 2061 7265 2066 756c   workers are ful
+000128d0: 6c2c 2072 6574 7572 6e73 204e 6f6e 652c  l, returns None,
+000128e0: 206d 6561 6e69 6e67 2074 6865 2074 6173   meaning the tas
+000128f0: 6b20 7368 6f75 6c64 2074 7261 6e73 6974  k should transit
+00012900: 696f 6e20 746f 0a20 2020 2020 2020 2060  ion to.        `
+00012910: 6071 7565 7565 6460 602e 2054 6865 2073  `queued``. The s
+00012920: 6368 6564 756c 6572 2077 696c 6c20 7761  cheduler will wa
+00012930: 6974 2074 6f20 7365 6e64 2069 7420 746f  it to send it to
+00012940: 2061 2077 6f72 6b65 7220 756e 7469 6c20   a worker until 
+00012950: 6120 7468 7265 6164 206f 7065 6e73 0a20  a thread opens. 
+00012960: 2020 2020 2020 2075 702e 2054 6869 7320         up. This 
+00012970: 656e 7375 7265 7320 7468 6174 2064 6f77  ensures that dow
+00012980: 6e73 7472 6561 6d20 7461 736b 7320 616c  nstream tasks al
+00012990: 7761 7973 2072 756e 2062 6566 6f72 6520  ways run before 
+000129a0: 6e65 7720 726f 6f74 2074 6173 6b73 2061  new root tasks a
+000129b0: 7265 0a20 2020 2020 2020 2073 7461 7274  re.        start
+000129c0: 6564 2e0a 0a20 2020 2020 2020 2054 6869  ed...        Thi
+000129d0: 7320 646f 6573 206e 6f74 2074 7279 2074  s does not try t
+000129e0: 6f20 7363 6865 6475 6c65 2073 6962 6c69  o schedule sibli
+000129f0: 6e67 2074 6173 6b73 206f 6e20 7468 6520  ng tasks on the 
+00012a00: 7361 6d65 2077 6f72 6b65 723b 2069 6e20  same worker; in 
+00012a10: 6661 6374 2c20 6974 0a20 2020 2020 2020  fact, it.       
+00012a20: 2075 7375 616c 6c79 2064 6f65 7320 7468   usually does th
+00012a30: 6520 6f70 706f 7369 7465 2e20 4576 656e  e opposite. Even
+00012a40: 2074 686f 7567 6820 7468 6973 2069 6e63   though this inc
+00012a50: 7265 6173 6573 2073 7562 7365 7175 656e  reases subsequen
+00012a60: 7420 6461 7461 2074 7261 6e73 6665 722c  t data transfer,
+00012a70: 0a20 2020 2020 2020 2069 7420 7479 7069  .        it typi
+00012a80: 6361 6c6c 7920 7265 6475 6365 7320 6f76  cally reduces ov
+00012a90: 6572 616c 6c20 6d65 6d6f 7279 2075 7365  erall memory use
+00012aa0: 2062 7920 656c 696d 696e 6174 696e 6720   by eliminating 
+00012ab0: 726f 6f74 2074 6173 6b20 6f76 6572 7072  root task overpr
+00012ac0: 6f64 7563 7469 6f6e 2e0a 0a20 2020 2020  oduction...     
+00012ad0: 2020 2052 6574 7572 6e73 0a20 2020 2020     Returns.     
+00012ae0: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2020     -------.     
+00012af0: 2020 2077 733a 2057 6f72 6b65 7253 7461     ws: WorkerSta
+00012b00: 7465 207c 204e 6f6e 650a 2020 2020 2020  te | None.      
+00012b10: 2020 2020 2020 5468 6520 776f 726b 6572        The worker
+00012b20: 2074 6f20 6173 7369 676e 2074 6865 2074   to assign the t
+00012b30: 6173 6b20 746f 2e20 4966 2074 6865 7265  ask to. If there
+00012b40: 2061 7265 206e 6f20 6964 6c65 2077 6f72   are no idle wor
+00012b50: 6b65 7273 2c20 7265 7475 726e 730a 2020  kers, returns.  
+00012b60: 2020 2020 2020 2020 2020 4e6f 6e65 2c20            None, 
+00012b70: 696e 2077 6869 6368 2063 6173 6520 7468  in which case th
+00012b80: 6520 7461 736b 2073 686f 756c 6420 6265  e task should be
+00012b90: 2074 7261 6e73 6974 696f 6e65 6420 746f   transitioned to
+00012ba0: 2060 6071 7565 7565 6460 602e 0a0a 2020   ``queued``...  
+00012bb0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00012bc0: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
+00012bd0: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+00012be0: 2320 5765 2064 6f6e 2774 2060 6173 7365  # We don't `asse
+00012bf0: 7274 2073 656c 662e 6973 5f72 6f6f 7469  rt self.is_rooti
+00012c00: 7368 2874 7329 6020 6865 7265 2c20 6265  sh(ts)` here, be
+00012c10: 6361 7573 6520 7468 6174 2063 6865 636b  cause that check
+00012c20: 2069 730a 2020 2020 2020 2020 2020 2020   is.            
+00012c30: 2320 6465 7065 6e64 656e 7420 6f6e 2063  # dependent on c
+00012c40: 6c75 7374 6572 2073 697a 652e 2049 7427  luster size. It'
+00012c50: 7320 706f 7373 6962 6c65 2061 2074 6173  s possible a tas
+00012c60: 6b20 6c6f 6f6b 6564 2072 6f6f 742d 6973  k looked root-is
+00012c70: 6820 7768 656e 2069 740a 2020 2020 2020  h when it.      
+00012c80: 2020 2020 2020 2320 7761 7320 7175 6575        # was queu
+00012c90: 6564 2c20 6275 7420 7468 6520 636c 7573  ed, but the clus
+00012ca0: 7465 7220 6861 7320 7369 6e63 6520 7363  ter has since sc
+00012cb0: 616c 6564 2075 7020 616e 6420 6974 206e  aled up and it n
+00012cc0: 6f20 6c6f 6e67 6572 2064 6f65 7320 7768  o longer does wh
+00012cd0: 656e 0a20 2020 2020 2020 2020 2020 2023  en.            #
+00012ce0: 2063 6f6d 696e 6720 6f75 7420 6f66 2074   coming out of t
+00012cf0: 6865 2071 7565 7565 2e20 4966 2060 6973  he queue. If `is
+00012d00: 5f72 6f6f 7469 7368 6020 6368 616e 6765  _rootish` change
+00012d10: 7320 746f 2061 2073 7461 7469 6320 6465  s to a static de
+00012d20: 6669 6e69 7469 6f6e 2c0a 2020 2020 2020  finition,.      
+00012d30: 2020 2020 2020 2320 7468 656e 2061 6464        # then add
+00012d40: 2074 6861 7420 6173 7365 7274 696f 6e20   that assertion 
+00012d50: 6865 7265 2028 616e 6420 6163 7475 616c  here (and actual
+00012d60: 6c79 2070 6173 7320 696e 2074 6865 2074  ly pass in the t
+00012d70: 6173 6b29 2e0a 2020 2020 2020 2020 2020  ask)..          
+00012d80: 2020 6173 7365 7274 206e 6f74 206d 6174    assert not mat
+00012d90: 682e 6973 696e 6628 7365 6c66 2e57 4f52  h.isinf(self.WOR
+00012da0: 4b45 525f 5341 5455 5241 5449 4f4e 290a  KER_SATURATION).
+00012db0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00012dc0: 7365 6c66 2e69 646c 655f 7461 736b 5f63  self.idle_task_c
+00012dd0: 6f75 6e74 3a0a 2020 2020 2020 2020 2020  ount:.          
+00012de0: 2020 2320 416c 6c20 776f 726b 6572 7320    # All workers 
+00012df0: 6275 7379 3f20 5461 736b 2067 6574 732f  busy? Task gets/
+00012e00: 7374 6179 7320 7175 6575 6564 2e0a 2020  stays queued..  
+00012e10: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00012e20: 204e 6f6e 650a 0a20 2020 2020 2020 2023   None..        #
+00012e30: 204a 7573 7420 7069 636b 2074 6865 206c   Just pick the l
+00012e40: 6561 7374 2062 7573 7920 776f 726b 6572  east busy worker
+00012e50: 2e0a 2020 2020 2020 2020 2320 4e4f 5445  ..        # NOTE
+00012e60: 3a20 7468 6973 2077 696c 6c20 6c65 6164  : this will lead
+00012e70: 2074 6f20 776f 7273 742d 6361 7365 2073   to worst-case s
+00012e80: 6368 6564 756c 696e 6720 7769 7468 2072  cheduling with r
+00012e90: 6567 6172 6473 2074 6f20 636f 2d61 7373  egards to co-ass
+00012ea0: 6967 6e6d 656e 742e 0a20 2020 2020 2020  ignment..       
+00012eb0: 2077 7320 3d20 6d69 6e28 0a20 2020 2020   ws = min(.     
+00012ec0: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
+00012ed0: 5f74 6173 6b5f 636f 756e 742c 0a20 2020  _task_count,.   
+00012ee0: 2020 2020 2020 2020 206b 6579 3d6c 616d           key=lam
+00012ef0: 6264 6120 7773 3a20 6c65 6e28 7773 2e70  bda ws: len(ws.p
+00012f00: 726f 6365 7373 696e 6729 202f 2077 732e  rocessing) / ws.
+00012f10: 6e74 6872 6561 6473 2c0a 2020 2020 2020  nthreads,.      
+00012f20: 2020 290a 2020 2020 2020 2020 6966 2073    ).        if s
+00012f30: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
+00012f40: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00012f50: 206e 6f74 205f 776f 726b 6572 5f66 756c   not _worker_ful
+00012f60: 6c28 7773 2c20 7365 6c66 2e57 4f52 4b45  l(ws, self.WORKE
+00012f70: 525f 5341 5455 5241 5449 4f4e 292c 2028  R_SATURATION), (
+00012f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012f90: 2077 732c 0a20 2020 2020 2020 2020 2020   ws,.           
+00012fa0: 2020 2020 205f 7461 736b 5f73 6c6f 7473       _task_slots
+00012fb0: 5f61 7661 696c 6162 6c65 2877 732c 2073  _available(ws, s
+00012fc0: 656c 662e 574f 524b 4552 5f53 4154 5552  elf.WORKER_SATUR
+00012fd0: 4154 494f 4e29 2c0a 2020 2020 2020 2020  ATION),.        
+00012fe0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00012ff0: 2020 6173 7365 7274 2077 7320 696e 2073    assert ws in s
+00013000: 656c 662e 7275 6e6e 696e 672c 2028 7773  elf.running, (ws
+00013010: 2c20 7365 6c66 2e72 756e 6e69 6e67 290a  , self.running).
+00013020: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00013030: 2e76 616c 6964 6174 6520 616e 6420 7773  .validate and ws
+00013040: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00013050: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00013060: 2073 656c 662e 776f 726b 6572 732e 6765   self.workers.ge
+00013070: 7428 7773 2e61 6464 7265 7373 2920 6973  t(ws.address) is
+00013080: 2077 730a 2020 2020 2020 2020 2020 2020   ws.            
+00013090: 6173 7365 7274 2077 7320 696e 2073 656c  assert ws in sel
+000130a0: 662e 7275 6e6e 696e 672c 2028 7773 2c20  f.running, (ws, 
+000130b0: 7365 6c66 2e72 756e 6e69 6e67 290a 0a20  self.running).. 
+000130c0: 2020 2020 2020 2072 6574 7572 6e20 7773         return ws
+000130d0: 0a0a 2020 2020 6465 6620 6465 6369 6465  ..    def decide
+000130e0: 5f77 6f72 6b65 725f 6e6f 6e5f 726f 6f74  _worker_non_root
+000130f0: 6973 6828 7365 6c66 2c20 7473 3a20 5461  ish(self, ts: Ta
+00013100: 736b 5374 6174 6529 202d 3e20 576f 726b  skState) -> Work
+00013110: 6572 5374 6174 6520 7c20 4e6f 6e65 3a0a  erState | None:.
+00013120: 2020 2020 2020 2020 2222 2250 6963 6b20          """Pick 
+00013130: 6120 776f 726b 6572 2066 6f72 2061 2072  a worker for a r
+00013140: 756e 6e61 626c 6520 6e6f 6e2d 726f 6f74  unnable non-root
+00013150: 2074 6173 6b2c 2063 6f6e 7369 6465 7269   task, consideri
+00013160: 6e67 2064 6570 656e 6465 6e63 6965 7320  ng dependencies 
+00013170: 616e 640a 2020 2020 2020 2020 7265 7374  and.        rest
+00013180: 7269 6374 696f 6e73 2e0a 0a20 2020 2020  rictions...     
+00013190: 2020 204f 7574 206f 6620 656c 6967 6962     Out of eligib
+000131a0: 6c65 2077 6f72 6b65 7273 2068 6f6c 6469  le workers holdi
+000131b0: 6e67 2064 6570 656e 6465 6e63 6965 7320  ng dependencies 
+000131c0: 6f66 2060 6074 7360 602c 2073 656c 6563  of ``ts``, selec
+000131d0: 7473 2074 6865 2077 6f72 6b65 720a 2020  ts the worker.  
+000131e0: 2020 2020 2020 7768 6572 652c 2063 6f6e        where, con
+000131f0: 7369 6465 7269 6e67 2077 6f72 6b65 7220  sidering worker 
+00013200: 6261 636b 6c6f 6e67 2061 6e64 2064 6174  backlong and dat
+00013210: 612d 7472 616e 7366 6572 2063 6f73 7473  a-transfer costs
+00013220: 2c20 7468 6520 7461 736b 2069 730a 2020  , the task is.  
+00013230: 2020 2020 2020 6573 7469 6d61 7465 6420        estimated 
+00013240: 746f 2073 7461 7274 2072 756e 6e69 6e67  to start running
+00013250: 2074 6865 2073 6f6f 6e65 7374 2e0a 0a20   the soonest... 
+00013260: 2020 2020 2020 2052 6574 7572 6e73 0a20         Returns. 
+00013270: 2020 2020 2020 202d 2d2d 2d2d 2d2d 0a20         -------. 
+00013280: 2020 2020 2020 2077 733a 2057 6f72 6b65         ws: Worke
+00013290: 7253 7461 7465 207c 204e 6f6e 650a 2020  rState | None.  
+000132a0: 2020 2020 2020 2020 2020 5468 6520 776f            The wo
+000132b0: 726b 6572 2074 6f20 6173 7369 676e 2074  rker to assign t
+000132c0: 6865 2074 6173 6b20 746f 2e20 4966 206e  he task to. If n
+000132d0: 6f20 776f 726b 6572 7320 7361 7469 7366  o workers satisf
+000132e0: 7920 7468 6520 7265 7374 7269 6374 696f  y the restrictio
+000132f0: 6e73 206f 660a 2020 2020 2020 2020 2020  ns of.          
+00013300: 2020 6060 7473 6060 206f 7220 7468 6572    ``ts`` or ther
+00013310: 6520 6172 6520 6e6f 2072 756e 6e69 6e67  e are no running
+00013320: 2077 6f72 6b65 7273 2c20 7265 7475 726e   workers, return
+00013330: 7320 4e6f 6e65 2c20 696e 2077 6869 6368  s None, in which
+00013340: 2063 6173 6520 7468 6520 7461 736b 0a20   case the task. 
+00013350: 2020 2020 2020 2020 2020 2073 686f 756c             shoul
+00013360: 6420 6265 2074 7261 6e73 6974 696f 6e65  d be transitione
+00013370: 6420 746f 2060 606e 6f2d 776f 726b 6572  d to ``no-worker
+00013380: 6060 2e0a 2020 2020 2020 2020 2222 220a  ``..        """.
+00013390: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+000133a0: 656c 662e 7275 6e6e 696e 673a 0a20 2020  elf.running:.   
+000133b0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000133c0: 4e6f 6e65 0a0a 2020 2020 2020 2020 7661  None..        va
+000133d0: 6c69 645f 776f 726b 6572 7320 3d20 7365  lid_workers = se
+000133e0: 6c66 2e76 616c 6964 5f77 6f72 6b65 7273  lf.valid_workers
+000133f0: 2874 7329 0a20 2020 2020 2020 2069 6620  (ts).        if 
+00013400: 7661 6c69 645f 776f 726b 6572 7320 6973  valid_workers is
+00013410: 204e 6f6e 6520 616e 6420 6c65 6e28 7365   None and len(se
+00013420: 6c66 2e72 756e 6e69 6e67 2920 3c20 6c65  lf.running) < le
+00013430: 6e28 7365 6c66 2e77 6f72 6b65 7273 293a  n(self.workers):
+00013440: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00013450: 6e6f 7420 7365 6c66 2e72 756e 6e69 6e67  not self.running
+00013460: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00013470: 2020 7265 7475 726e 204e 6f6e 650a 0a20    return None.. 
+00013480: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
+00013490: 7468 6572 6520 7765 7265 206e 6f20 7265  there were no re
+000134a0: 7374 7269 6374 696f 6e73 2c20 6076 616c  strictions, `val
+000134b0: 6964 5f77 6f72 6b65 7273 2829 6020 6469  id_workers()` di
+000134c0: 646e 2774 2073 7562 7365 7420 6279 0a20  dn't subset by. 
+000134d0: 2020 2020 2020 2020 2020 2023 2060 7275             # `ru
+000134e0: 6e6e 696e 6760 2e0a 2020 2020 2020 2020  nning`..        
+000134f0: 2020 2020 7661 6c69 645f 776f 726b 6572      valid_worker
+00013500: 7320 3d20 7365 6c66 2e72 756e 6e69 6e67  s = self.running
+00013510: 0a0a 2020 2020 2020 2020 6966 2074 732e  ..        if ts.
+00013520: 6465 7065 6e64 656e 6369 6573 206f 7220  dependencies or 
+00013530: 7661 6c69 645f 776f 726b 6572 7320 6973  valid_workers is
+00013540: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00013550: 2020 2020 2020 2077 7320 3d20 6465 6369         ws = deci
+00013560: 6465 5f77 6f72 6b65 7228 0a20 2020 2020  de_worker(.     
+00013570: 2020 2020 2020 2020 2020 2074 732c 0a20             ts,. 
+00013580: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00013590: 656c 662e 7275 6e6e 696e 672c 0a20 2020  elf.running,.   
+000135a0: 2020 2020 2020 2020 2020 2020 2076 616c               val
+000135b0: 6964 5f77 6f72 6b65 7273 2c0a 2020 2020  id_workers,.    
+000135c0: 2020 2020 2020 2020 2020 2020 7061 7274              part
+000135d0: 6961 6c28 7365 6c66 2e77 6f72 6b65 725f  ial(self.worker_
+000135e0: 6f62 6a65 6374 6976 652c 2074 7329 2c0a  objective, ts),.
+000135f0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00013600: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00013610: 2020 2020 2020 2020 2320 544f 444f 2069          # TODO i
+00013620: 6620 6069 735f 726f 6f74 6973 6860 2077  f `is_rootish` w
+00013630: 6f75 6c64 2061 6c77 6179 7320 7265 7475  ould always retu
+00013640: 726e 2054 7275 6520 666f 7220 7461 736b  rn True for task
+00013650: 7320 7769 7468 6f75 740a 2020 2020 2020  s without.      
+00013660: 2020 2020 2020 2320 6465 7065 6e64 656e        # dependen
+00013670: 6369 6573 2c20 7765 2063 6f75 6c64 2072  cies, we could r
+00013680: 656d 6f76 6520 616c 6c20 7468 6973 206c  emove all this l
+00013690: 6f67 6963 2e20 5468 6520 726f 6f74 6973  ogic. The rootis
+000136a0: 6820 6173 7369 676e 6d65 6e74 206c 6f67  h assignment log
+000136b0: 6963 0a20 2020 2020 2020 2020 2020 2023  ic.            #
+000136c0: 2077 6f75 6c64 2062 6568 6176 6520 6d6f   would behave mo
+000136d0: 7265 206f 7220 6c65 7373 2074 6865 2073  re or less the s
+000136e0: 616d 6520 6173 2074 6869 732c 206d 6179  ame as this, may
+000136f0: 6265 2077 6974 686f 7574 2067 7561 7261  be without guara
+00013700: 6e74 6565 640a 2020 2020 2020 2020 2020  nteed.          
+00013710: 2020 2320 726f 756e 642d 726f 6269 6e20    # round-robin 
+00013720: 7468 6f75 6768 3f20 5468 6973 2070 6174  though? This pat
+00013730: 6820 6973 206f 6e6c 7920 7265 6163 6861  h is only reacha
+00013740: 626c 6520 7768 656e 2060 7473 6020 646f  ble when `ts` do
+00013750: 6573 6e27 7420 6861 7665 0a20 2020 2020  esn't have.     
+00013760: 2020 2020 2020 2023 2064 6570 656e 6465         # depende
+00013770: 6e63 6965 732c 2062 7574 2069 7473 2067  ncies, but its g
+00013780: 726f 7570 2069 7320 616c 736f 2073 6d61  roup is also sma
+00013790: 6c6c 6572 2074 6861 6e20 7468 6520 636c  ller than the cl
+000137a0: 7573 7465 722e 0a0a 2020 2020 2020 2020  uster...        
+000137b0: 2020 2020 2320 4661 7374 7061 7468 2077      # Fastpath w
+000137c0: 6865 6e20 7468 6572 6520 6172 6520 6e6f  hen there are no
+000137d0: 2072 656c 6174 6564 2074 6173 6b73 206f   related tasks o
+000137e0: 7220 7265 7374 7269 6374 696f 6e73 0a20  r restrictions. 
+000137f0: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
+00013800: 725f 706f 6f6c 203d 2073 656c 662e 6964  r_pool = self.id
+00013810: 6c65 206f 7220 7365 6c66 2e77 6f72 6b65  le or self.worke
+00013820: 7273 0a20 2020 2020 2020 2020 2020 2023  rs.            #
+00013830: 2046 4958 4d45 2069 646c 6520 616e 6420   FIXME idle and 
+00013840: 776f 726b 6572 7320 6172 6520 536f 7274  workers are Sort
+00013850: 6564 4469 6374 2773 2064 6563 6c61 7265  edDict's declare
+00013860: 6420 6173 2064 6963 7473 0a20 2020 2020  d as dicts.     
+00013870: 2020 2020 2020 2023 2020 2020 2020 2062         #       b
+00013880: 6563 6175 7365 2073 6f72 7465 6463 6f6e  ecause sortedcon
+00013890: 7461 696e 6572 7320 6973 206e 6f74 2061  tainers is not a
+000138a0: 6e6e 6f74 6174 6564 0a20 2020 2020 2020  nnotated.       
+000138b0: 2020 2020 2077 705f 7661 6c73 203d 2063       wp_vals = c
+000138c0: 6173 7428 2253 6571 7565 6e63 655b 576f  ast("Sequence[Wo
+000138d0: 726b 6572 5374 6174 655d 222c 2077 6f72  rkerState]", wor
+000138e0: 6b65 725f 706f 6f6c 2e76 616c 7565 7328  ker_pool.values(
+000138f0: 2929 0a20 2020 2020 2020 2020 2020 206e  )).            n
+00013900: 5f77 6f72 6b65 7273 203d 206c 656e 2877  _workers = len(w
+00013910: 705f 7661 6c73 290a 2020 2020 2020 2020  p_vals).        
+00013920: 2020 2020 6966 206e 5f77 6f72 6b65 7273      if n_workers
+00013930: 203c 2032 303a 2020 2320 736d 6172 7420   < 20:  # smart 
+00013940: 6275 7420 6c69 6e65 6172 2069 6e20 736d  but linear in sm
+00013950: 616c 6c20 6361 7365 0a20 2020 2020 2020  all case.       
+00013960: 2020 2020 2020 2020 2077 7320 3d20 6d69           ws = mi
+00013970: 6e28 7770 5f76 616c 732c 206b 6579 3d6f  n(wp_vals, key=o
+00013980: 7065 7261 746f 722e 6174 7472 6765 7474  perator.attrgett
+00013990: 6572 2822 6f63 6375 7061 6e63 7922 2929  er("occupancy"))
+000139a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000139b0: 2061 7373 6572 7420 7773 0a20 2020 2020   assert ws.     
+000139c0: 2020 2020 2020 2020 2020 2069 6620 7773             if ws
+000139d0: 2e6f 6363 7570 616e 6379 203d 3d20 303a  .occupancy == 0:
+000139e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000139f0: 2020 2020 2023 2073 7065 6369 616c 2063       # special c
+00013a00: 6173 6520 746f 2075 7365 2072 6f75 6e64  ase to use round
+00013a10: 2d72 6f62 696e 3b20 6c69 6e65 6172 2073  -robin; linear s
+00013a20: 6561 7263 680a 2020 2020 2020 2020 2020  earch.          
+00013a30: 2020 2020 2020 2020 2020 2320 666f 7220            # for 
+00013a40: 6e65 7874 2077 6f72 6b65 7220 7769 7468  next worker with
+00013a50: 207a 6572 6f20 6f63 6375 7061 6e63 7920   zero occupancy 
+00013a60: 286f 7220 6a75 7374 0a20 2020 2020 2020  (or just.       
+00013a70: 2020 2020 2020 2020 2020 2020 2023 206c               # l
+00013a80: 616e 6420 6261 636b 2077 6865 7265 2077  and back where w
+00013a90: 6520 7374 6172 7465 6429 2e0a 2020 2020  e started)..    
+00013aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013ab0: 7374 6172 7420 3d20 7365 6c66 2e6e 5f74  start = self.n_t
+00013ac0: 6173 6b73 2025 206e 5f77 6f72 6b65 7273  asks % n_workers
+00013ad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013ae0: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
+00013af0: 6e67 6528 6e5f 776f 726b 6572 7329 3a0a  nge(n_workers):.
+00013b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013b10: 2020 2020 2020 2020 7770 5f69 203d 2077          wp_i = w
+00013b20: 705f 7661 6c73 5b28 6920 2b20 7374 6172  p_vals[(i + star
+00013b30: 7429 2025 206e 5f77 6f72 6b65 7273 5d0a  t) % n_workers].
+00013b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013b50: 2020 2020 2020 2020 6966 2077 705f 692e          if wp_i.
+00013b60: 6f63 6375 7061 6e63 7920 3d3d 2030 3a0a  occupancy == 0:.
+00013b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013b80: 2020 2020 2020 2020 2020 2020 7773 203d              ws =
+00013b90: 2077 705f 690a 2020 2020 2020 2020 2020   wp_i.          
+00013ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013bb0: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
+00013bc0: 2020 2020 656c 7365 3a20 2023 2064 756d      else:  # dum
+00013bd0: 6220 6275 7420 6661 7374 2069 6e20 6c61  b but fast in la
+00013be0: 7267 6520 6361 7365 0a20 2020 2020 2020  rge case.       
+00013bf0: 2020 2020 2020 2020 2077 7320 3d20 7770           ws = wp
+00013c00: 5f76 616c 735b 7365 6c66 2e6e 5f74 6173  _vals[self.n_tas
+00013c10: 6b73 2025 206e 5f77 6f72 6b65 7273 5d0a  ks % n_workers].
+00013c20: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00013c30: 2e76 616c 6964 6174 6520 616e 6420 7773  .validate and ws
+00013c40: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00013c50: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00013c60: 2073 656c 662e 776f 726b 6572 732e 6765   self.workers.ge
+00013c70: 7428 7773 2e61 6464 7265 7373 2920 6973  t(ws.address) is
+00013c80: 2077 730a 2020 2020 2020 2020 2020 2020   ws.            
+00013c90: 6173 7365 7274 2077 7320 696e 2073 656c  assert ws in sel
+00013ca0: 662e 7275 6e6e 696e 672c 2028 7773 2c20  f.running, (ws, 
+00013cb0: 7365 6c66 2e72 756e 6e69 6e67 290a 0a20  self.running).. 
+00013cc0: 2020 2020 2020 2072 6574 7572 6e20 7773         return ws
+00013cd0: 0a0a 2020 2020 6465 6620 7472 616e 7369  ..    def transi
+00013ce0: 7469 6f6e 5f77 6169 7469 6e67 5f70 726f  tion_waiting_pro
+00013cf0: 6365 7373 696e 6728 7365 6c66 2c20 6b65  cessing(self, ke
+00013d00: 793a 2073 7472 2c20 7374 696d 756c 7573  y: str, stimulus
+00013d10: 5f69 643a 2073 7472 2920 2d3e 2052 6563  _id: str) -> Rec
+00013d20: 734d 7367 733a 0a20 2020 2020 2020 2022  sMsgs:.        "
+00013d30: 2222 506f 7373 6962 6c79 2073 6368 6564  ""Possibly sched
+00013d40: 756c 6520 6120 7265 6164 7920 7461 736b  ule a ready task
+00013d50: 2e20 5468 6973 2069 7320 7468 6520 7072  . This is the pr
+00013d60: 696d 6172 7920 6469 7370 6174 6368 2066  imary dispatch f
+00013d70: 6f72 2072 6561 6479 2074 6173 6b73 2e0a  or ready tasks..
+00013d80: 0a20 2020 2020 2020 2049 6620 7468 6572  .        If ther
+00013d90: 6527 7320 6e6f 2061 7070 726f 7072 6961  e's no appropria
+00013da0: 7465 2077 6f72 6b65 7220 666f 7220 7468  te worker for th
+00013db0: 6520 7461 736b 2028 6275 7420 7468 6520  e task (but the 
+00013dc0: 7461 736b 2069 7320 6f74 6865 7277 6973  task is otherwis
+00013dd0: 650a 2020 2020 2020 2020 7275 6e6e 6162  e.        runnab
+00013de0: 6c65 292c 2069 7420 7769 6c6c 2062 6520  le), it will be 
+00013df0: 7265 636f 6d6d 656e 6465 6420 746f 2060  recommended to `
+00013e00: 606e 6f2d 776f 726b 6572 6060 206f 7220  `no-worker`` or 
+00013e10: 6060 7175 6575 6564 6060 2e0a 2020 2020  ``queued``..    
+00013e20: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00013e30: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
+00013e40: 6b65 795d 0a0a 2020 2020 2020 2020 6966  key]..        if
+00013e50: 2073 656c 662e 6973 5f72 6f6f 7469 7368   self.is_rootish
+00013e60: 2874 7329 3a0a 2020 2020 2020 2020 2020  (ts):.          
+00013e70: 2020 2320 4e4f 5445 3a20 6861 7669 6e67    # NOTE: having
+00013e80: 2074 776f 2072 6f6f 742d 6973 6820 6d65   two root-ish me
+00013e90: 7468 6f64 7320 6973 2074 656d 706f 7261  thods is tempora
+00013ea0: 7279 2e20 5768 656e 2074 6865 2066 6561  ry. When the fea
+00013eb0: 7475 7265 2066 6c61 6720 6973 0a20 2020  ture flag is.   
+00013ec0: 2020 2020 2020 2020 2023 2072 656d 6f76           # remov
+00013ed0: 6564 2c20 7468 6572 6520 7368 6f75 6c64  ed, there should
+00013ee0: 206f 6e6c 7920 6265 206f 6e65 2c20 7768   only be one, wh
+00013ef0: 6963 6820 636f 6d62 696e 6573 2063 6f2d  ich combines co-
+00013f00: 6173 7369 676e 6d65 6e74 2061 6e64 0a20  assignment and. 
+00013f10: 2020 2020 2020 2020 2020 2023 2071 7565             # que
+00013f20: 7569 6e67 2e20 4576 656e 7475 616c 6c79  uing. Eventually
+00013f30: 2c20 7370 6563 6961 6c2d 6361 7369 6e67  , special-casing
+00013f40: 2072 6f6f 7420 7461 736b 7320 6d69 6768   root tasks migh
+00013f50: 7420 6265 2072 656d 6f76 6564 2065 6e74  t be removed ent
+00013f60: 6972 656c 792c 0a20 2020 2020 2020 2020  irely,.         
+00013f70: 2020 2023 2077 6974 6820 6265 7474 6572     # with better
+00013f80: 2068 6575 7269 7374 6963 732e 0a20 2020   heuristics..   
+00013f90: 2020 2020 2020 2020 2069 6620 6d61 7468           if math
+00013fa0: 2e69 7369 6e66 2873 656c 662e 574f 524b  .isinf(self.WORK
+00013fb0: 4552 5f53 4154 5552 4154 494f 4e29 3a0a  ER_SATURATION):.
+00013fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013fd0: 6966 206e 6f74 2028 7773 203a 3d20 7365  if not (ws := se
+00013fe0: 6c66 2e64 6563 6964 655f 776f 726b 6572  lf.decide_worker
+00013ff0: 5f72 6f6f 7469 7368 5f71 7565 7569 6e67  _rootish_queuing
+00014000: 5f64 6973 6162 6c65 6428 7473 2929 3a0a  _disabled(ts)):.
+00014010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014020: 2020 2020 7265 7475 726e 207b 7473 2e6b      return {ts.k
+00014030: 6579 3a20 226e 6f2d 776f 726b 6572 227d  ey: "no-worker"}
+00014040: 2c20 7b7d 2c20 7b7d 0a20 2020 2020 2020  , {}, {}.       
+00014050: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00014060: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00014070: 7420 2877 7320 3a3d 2073 656c 662e 6465  t (ws := self.de
+00014080: 6369 6465 5f77 6f72 6b65 725f 726f 6f74  cide_worker_root
+00014090: 6973 685f 7175 6575 696e 675f 656e 6162  ish_queuing_enab
+000140a0: 6c65 6428 2929 3a0a 2020 2020 2020 2020  led()):.        
+000140b0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000140c0: 726e 207b 7473 2e6b 6579 3a20 2271 7565  rn {ts.key: "que
+000140d0: 7565 6422 7d2c 207b 7d2c 207b 7d0a 2020  ued"}, {}, {}.  
+000140e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000140f0: 2020 2020 2020 2020 6966 206e 6f74 2028          if not (
+00014100: 7773 203a 3d20 7365 6c66 2e64 6563 6964  ws := self.decid
+00014110: 655f 776f 726b 6572 5f6e 6f6e 5f72 6f6f  e_worker_non_roo
+00014120: 7469 7368 2874 7329 293a 0a20 2020 2020  tish(ts)):.     
+00014130: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00014140: 6e20 7b74 732e 6b65 793a 2022 6e6f 2d77  n {ts.key: "no-w
+00014150: 6f72 6b65 7222 7d2c 207b 7d2c 207b 7d0a  orker"}, {}, {}.
+00014160: 0a20 2020 2020 2020 2077 6f72 6b65 725f  .        worker_
+00014170: 6d73 6773 203d 2073 656c 662e 5f61 6464  msgs = self._add
+00014180: 5f74 6f5f 7072 6f63 6573 7369 6e67 2874  _to_processing(t
+00014190: 732c 2077 7329 0a20 2020 2020 2020 2072  s, ws).        r
+000141a0: 6574 7572 6e20 7b7d 2c20 7b7d 2c20 776f  eturn {}, {}, wo
+000141b0: 726b 6572 5f6d 7367 730a 0a20 2020 2064  rker_msgs..    d
+000141c0: 6566 2074 7261 6e73 6974 696f 6e5f 7761  ef transition_wa
+000141d0: 6974 696e 675f 6d65 6d6f 7279 280a 2020  iting_memory(.  
+000141e0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+000141f0: 2020 2020 6b65 793a 2073 7472 2c0a 2020      key: str,.  
+00014200: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
+00014210: 643a 2073 7472 2c0a 2020 2020 2020 2020  d: str,.        
+00014220: 2a2c 0a20 2020 2020 2020 206e 6279 7465  *,.        nbyte
+00014230: 733a 2069 6e74 207c 204e 6f6e 6520 3d20  s: int | None = 
+00014240: 4e6f 6e65 2c0a 2020 2020 2020 2020 7479  None,.        ty
+00014250: 7065 3a20 6279 7465 7320 7c20 4e6f 6e65  pe: bytes | None
+00014260: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00014270: 2074 7970 656e 616d 653a 2073 7472 207c   typename: str |
+00014280: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+00014290: 2020 2020 2020 776f 726b 6572 3a20 7374        worker: st
+000142a0: 722c 0a20 2020 2020 2020 202a 2a6b 7761  r,.        **kwa
+000142b0: 7267 733a 2041 6e79 2c0a 2020 2020 2920  rgs: Any,.    ) 
+000142c0: 2d3e 2052 6563 734d 7367 733a 0a20 2020  -> RecsMsgs:.   
+000142d0: 2020 2020 2022 2222 5468 6973 2074 7261       """This tra
+000142e0: 6e73 6974 696f 6e20 6578 636c 7573 6976  nsition exclusiv
+000142f0: 656c 7920 6861 7070 656e 7320 696e 2061  ely happens in a
+00014300: 2072 6163 6520 636f 6e64 6974 696f 6e20   race condition 
+00014310: 7768 6572 6520 7468 6520 7363 6865 6475  where the schedu
+00014320: 6c65 720a 2020 2020 2020 2020 6265 6c69  ler.        beli
+00014330: 6576 6573 2074 6861 7420 7468 6520 6f6e  eves that the on
+00014340: 6c79 2063 6f70 7920 6f66 2061 2064 6570  ly copy of a dep
+00014350: 656e 6465 6e63 7920 7461 736b 2068 6173  endency task has
+00014360: 206a 7573 7420 6265 656e 206c 6f73 742c   just been lost,
+00014370: 2073 6f20 6974 0a20 2020 2020 2020 2074   so it.        t
+00014380: 7261 6e73 6974 696f 6e73 2061 6c6c 2064  ransitions all d
+00014390: 6570 656e 6465 6e74 7320 6261 636b 2074  ependents back t
+000143a0: 6f20 7761 6974 696e 672c 2062 7574 2061  o waiting, but a
+000143b0: 6374 7561 6c6c 7920 6120 7265 706c 6963  ctually a replic
+000143c0: 6120 6861 7320 616c 7265 6164 790a 2020  a has already.  
+000143d0: 2020 2020 2020 6265 656e 2061 6371 7569        been acqui
+000143e0: 7265 6420 6279 2061 2077 6f72 6b65 7220  red by a worker 
+000143f0: 636f 6d70 7574 696e 6720 7468 6520 6465  computing the de
+00014400: 7065 6e64 656e 6379 202d 2074 6865 2073  pendency - the s
+00014410: 6368 6564 756c 6572 206a 7573 7420 646f  cheduler just do
+00014420: 6573 6e27 740a 2020 2020 2020 2020 6b6e  esn't.        kn
+00014430: 6f77 2079 6574 202d 2061 6e64 2074 6865  ow yet - and the
+00014440: 2065 7865 6375 7469 6f6e 2066 696e 6973   execution finis
+00014450: 6865 7320 6265 666f 7265 2074 6865 2063  hes before the c
+00014460: 616e 6365 6c6c 6174 696f 6e20 6d65 7373  ancellation mess
+00014470: 6167 6520 6672 6f6d 2074 6865 0a20 2020  age from the.   
+00014480: 2020 2020 2073 6368 6564 756c 6572 2068       scheduler h
+00014490: 6173 2061 2063 6861 6e63 6520 746f 2072  as a chance to r
+000144a0: 6561 6368 2074 6865 2077 6f72 6b65 722e  each the worker.
+000144b0: 2053 686f 7274 6c79 2c20 7468 6520 6361   Shortly, the ca
+000144c0: 6e63 656c 6c61 7469 6f6e 2072 6571 7565  ncellation reque
+000144d0: 7374 0a20 2020 2020 2020 2077 696c 6c20  st.        will 
+000144e0: 7265 6163 6820 7468 6520 776f 726b 6572  reach the worker
+000144f0: 2c20 7468 7573 2064 656c 6574 696e 6720  , thus deleting 
+00014500: 7468 6520 6461 7461 2066 726f 6d20 6d65  the data from me
+00014510: 6d6f 7279 2e0a 2020 2020 2020 2020 2222  mory..        ""
+00014520: 220a 2020 2020 2020 2020 7473 203d 2073  ".        ts = s
+00014530: 656c 662e 7461 736b 735b 6b65 795d 0a0a  elf.tasks[key]..
+00014540: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00014550: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
+00014560: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+00014570: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
+00014580: 6e0a 2020 2020 2020 2020 2020 2020 6173  n.            as
+00014590: 7365 7274 2074 732e 7761 6974 696e 675f  sert ts.waiting_
+000145a0: 6f6e 0a20 2020 2020 2020 2020 2020 2061  on.            a
+000145b0: 7373 6572 7420 7473 2e73 7461 7465 203d  ssert ts.state =
+000145c0: 3d20 2277 6169 7469 6e67 220a 0a20 2020  = "waiting"..   
+000145d0: 2020 2020 2072 6574 7572 6e20 7b7d 2c20       return {}, 
+000145e0: 7b7d 2c20 7b7d 0a0a 2020 2020 6465 6620  {}, {}..    def 
+000145f0: 7472 616e 7369 7469 6f6e 5f70 726f 6365  transition_proce
+00014600: 7373 696e 675f 6d65 6d6f 7279 280a 2020  ssing_memory(.  
+00014610: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00014620: 2020 2020 6b65 793a 2073 7472 2c0a 2020      key: str,.  
+00014630: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
+00014640: 643a 2073 7472 2c0a 2020 2020 2020 2020  d: str,.        
+00014650: 2a2c 0a20 2020 2020 2020 206e 6279 7465  *,.        nbyte
+00014660: 733a 2069 6e74 207c 204e 6f6e 6520 3d20  s: int | None = 
+00014670: 4e6f 6e65 2c0a 2020 2020 2020 2020 7479  None,.        ty
+00014680: 7065 3a20 6279 7465 7320 7c20 4e6f 6e65  pe: bytes | None
+00014690: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+000146a0: 2074 7970 656e 616d 653a 2073 7472 207c   typename: str |
+000146b0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+000146c0: 2020 2020 2020 776f 726b 6572 3a20 7374        worker: st
+000146d0: 722c 0a20 2020 2020 2020 2073 7461 7274  r,.        start
+000146e0: 7374 6f70 733a 206c 6973 745b 6469 6374  stops: list[dict
+000146f0: 5d20 7c20 4e6f 6e65 203d 204e 6f6e 652c  ] | None = None,
+00014700: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
+00014710: 733a 2041 6e79 2c0a 2020 2020 2920 2d3e  s: Any,.    ) ->
+00014720: 2052 6563 734d 7367 733a 0a20 2020 2020   RecsMsgs:.     
+00014730: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
+00014740: 6b73 5b6b 6579 5d0a 0a20 2020 2020 2020  ks[key]..       
+00014750: 2061 7373 6572 7420 776f 726b 6572 0a20   assert worker. 
+00014760: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
+00014770: 696e 7374 616e 6365 2877 6f72 6b65 722c  instance(worker,
+00014780: 2073 7472 290a 0a20 2020 2020 2020 2069   str)..        i
+00014790: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
+000147a0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+000147b0: 6572 7420 7473 2e70 726f 6365 7373 696e  ert ts.processin
+000147c0: 675f 6f6e 0a20 2020 2020 2020 2020 2020  g_on.           
+000147d0: 2077 7373 203d 2074 732e 7072 6f63 6573   wss = ts.proces
+000147e0: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
+000147f0: 2020 2020 6173 7365 7274 2077 7373 0a20      assert wss. 
+00014800: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00014810: 7420 7473 2069 6e20 7773 732e 7072 6f63  t ts in wss.proc
+00014820: 6573 7369 6e67 0a20 2020 2020 2020 2020  essing.         
+00014830: 2020 2064 656c 2077 7373 0a20 2020 2020     del wss.     
+00014840: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00014850: 7420 7473 2e77 6169 7469 6e67 5f6f 6e0a  t ts.waiting_on.
+00014860: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00014870: 7274 206e 6f74 2074 732e 7768 6f5f 6861  rt not ts.who_ha
+00014880: 732c 2028 7473 2c20 7473 2e77 686f 5f68  s, (ts, ts.who_h
+00014890: 6173 290a 2020 2020 2020 2020 2020 2020  as).            
+000148a0: 6173 7365 7274 206e 6f74 2074 732e 6578  assert not ts.ex
+000148b0: 6365 7074 696f 6e5f 626c 616d 650a 2020  ception_blame.  
+000148c0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000148d0: 2074 732e 7374 6174 6520 3d3d 2022 7072   ts.state == "pr
+000148e0: 6f63 6573 7369 6e67 220a 0a20 2020 2020  ocessing"..     
+000148f0: 2020 2077 7320 3d20 7365 6c66 2e77 6f72     ws = self.wor
+00014900: 6b65 7273 2e67 6574 2877 6f72 6b65 7229  kers.get(worker)
+00014910: 0a20 2020 2020 2020 2069 6620 7773 2069  .        if ws i
+00014920: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00014930: 2020 2020 7265 7475 726e 207b 6b65 793a      return {key:
+00014940: 2022 7265 6c65 6173 6564 227d 2c20 7b7d   "released"}, {}
+00014950: 2c20 7b7d 0a0a 2020 2020 2020 2020 6966  , {}..        if
+00014960: 2077 7320 213d 2074 732e 7072 6f63 6573   ws != ts.proces
+00014970: 7369 6e67 5f6f 6e3a 2020 2320 7072 6167  sing_on:  # prag
+00014980: 6d61 3a20 6e6f 636f 7665 720a 2020 2020  ma: nocover.    
+00014990: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+000149a0: 732e 7072 6f63 6573 7369 6e67 5f6f 6e0a  s.processing_on.
+000149b0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+000149c0: 6520 5275 6e74 696d 6545 7272 6f72 280a  e RuntimeError(.
+000149d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000149e0: 6622 5461 736b 207b 7473 2e6b 6579 2172  f"Task {ts.key!r
+000149f0: 7d20 7472 616e 7369 7469 6f6e 6564 2066  } transitioned f
+00014a00: 726f 6d20 7072 6f63 6573 7369 6e67 2074  rom processing t
+00014a10: 6f20 6d65 6d6f 7279 206f 6e20 776f 726b  o memory on work
+00014a20: 6572 2022 0a20 2020 2020 2020 2020 2020  er ".           
+00014a30: 2020 2020 2066 227b 7773 7d2c 2077 6869       f"{ws}, whi
+00014a40: 6c65 2069 7420 7761 7320 6578 7065 6374  le it was expect
+00014a50: 6564 2066 726f 6d20 7b74 732e 7072 6f63  ed from {ts.proc
+00014a60: 6573 7369 6e67 5f6f 6e7d 2e20 5468 6973  essing_on}. This
+00014a70: 2073 686f 756c 6420 220a 2020 2020 2020   should ".      
+00014a80: 2020 2020 2020 2020 2020 6622 6265 2069            f"be i
+00014a90: 6d70 6f73 7369 626c 652e 207b 7374 696d  mpossible. {stim
+00014aa0: 756c 7573 5f69 643d 7d2c 2073 746f 7279  ulus_id=}, story
+00014ab0: 3d7b 7365 6c66 2e73 746f 7279 2874 7329  ={self.story(ts)
+00014ac0: 7d22 0a20 2020 2020 2020 2020 2020 2029  }".            )
+00014ad0: 0a0a 2020 2020 2020 2020 2323 2323 2323  ..        ######
+00014ae0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00014af0: 2323 2323 2323 230a 2020 2020 2020 2020  #######.        
+00014b00: 2320 5570 6461 7465 2054 696d 696e 6720  # Update Timing 
+00014b10: 496e 666f 726d 6174 696f 6e20 230a 2020  Information #.  
+00014b20: 2020 2020 2020 2323 2323 2323 2323 2323        ##########
+00014b30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00014b40: 2323 230a 2020 2020 2020 2020 6966 2073  ###.        if s
+00014b50: 7461 7274 7374 6f70 733a 0a20 2020 2020  tartstops:.     
+00014b60: 2020 2020 2020 2066 6f72 2073 7461 7274         for start
+00014b70: 7374 6f70 2069 6e20 7374 6172 7473 746f  stop in startsto
+00014b80: 7073 3a0a 2020 2020 2020 2020 2020 2020  ps:.            
+00014b90: 2020 2020 7473 2e67 726f 7570 2e61 6464      ts.group.add
+00014ba0: 5f64 7572 6174 696f 6e28 0a20 2020 2020  _duration(.     
+00014bb0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00014bc0: 746f 703d 7374 6172 7473 746f 705b 2273  top=startstop["s
+00014bd0: 746f 7022 5d2c 0a20 2020 2020 2020 2020  top"],.         
+00014be0: 2020 2020 2020 2020 2020 2073 7461 7274             start
+00014bf0: 3d73 7461 7274 7374 6f70 5b22 7374 6172  =startstop["star
+00014c00: 7422 5d2c 0a20 2020 2020 2020 2020 2020  t"],.           
+00014c10: 2020 2020 2020 2020 2061 6374 696f 6e3d           action=
+00014c20: 7374 6172 7473 746f 705b 2261 6374 696f  startstop["actio
+00014c30: 6e22 5d2c 0a20 2020 2020 2020 2020 2020  n"],.           
+00014c40: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00014c50: 7320 3d20 7365 6c66 2e75 6e6b 6e6f 776e  s = self.unknown
+00014c60: 5f64 7572 6174 696f 6e73 2e70 6f70 2874  _durations.pop(t
+00014c70: 732e 7072 6566 6978 2e6e 616d 652c 2073  s.prefix.name, s
+00014c80: 6574 2829 290a 2020 2020 2020 2020 7374  et()).        st
+00014c90: 6561 6c20 3d20 7365 6c66 2e65 7874 656e  eal = self.exten
+00014ca0: 7369 6f6e 732e 6765 7428 2273 7465 616c  sions.get("steal
+00014cb0: 696e 6722 290a 2020 2020 2020 2020 6966  ing").        if
+00014cc0: 2073 7465 616c 3a0a 2020 2020 2020 2020   steal:.        
+00014cd0: 2020 2020 666f 7220 7474 7320 696e 2073      for tts in s
+00014ce0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00014cf0: 2020 6966 2074 7473 2e70 726f 6365 7373    if tts.process
+00014d00: 696e 675f 6f6e 3a0a 2020 2020 2020 2020  ing_on:.        
+00014d10: 2020 2020 2020 2020 2020 2020 7374 6561              stea
+00014d20: 6c2e 7265 6361 6c63 756c 6174 655f 636f  l.recalculate_co
+00014d30: 7374 2874 7473 290a 0a20 2020 2020 2020  st(tts)..       
+00014d40: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+00014d50: 2323 2323 2323 2323 2323 2323 230a 2020  #############.  
+00014d60: 2020 2020 2020 2320 5570 6461 7465 2053        # Update S
+00014d70: 7461 7465 2049 6e66 6f72 6d61 7469 6f6e  tate Information
+00014d80: 2023 0a20 2020 2020 2020 2023 2323 2323   #.        #####
+00014d90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00014da0: 2323 2323 2323 230a 2020 2020 2020 2020  #######.        
+00014db0: 6966 206e 6279 7465 7320 6973 206e 6f74  if nbytes is not
+00014dc0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00014dd0: 2020 2074 732e 7365 745f 6e62 7974 6573     ts.set_nbytes
+00014de0: 286e 6279 7465 7329 0a0a 2020 2020 2020  (nbytes)..      
+00014df0: 2020 7365 6c66 2e5f 6578 6974 5f70 726f    self._exit_pro
+00014e00: 6365 7373 696e 675f 636f 6d6d 6f6e 2874  cessing_common(t
+00014e10: 7329 0a0a 2020 2020 2020 2020 7265 636f  s)..        reco
+00014e20: 6d6d 656e 6461 7469 6f6e 733a 2052 6563  mmendations: Rec
+00014e30: 7320 3d20 7b7d 0a20 2020 2020 2020 2063  s = {}.        c
+00014e40: 6c69 656e 745f 6d73 6773 3a20 4d73 6773  lient_msgs: Msgs
+00014e50: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
+00014e60: 6c66 2e5f 6164 645f 746f 5f6d 656d 6f72  lf._add_to_memor
+00014e70: 7928 0a20 2020 2020 2020 2020 2020 2074  y(.            t
+00014e80: 732c 2077 732c 2072 6563 6f6d 6d65 6e64  s, ws, recommend
+00014e90: 6174 696f 6e73 2c20 636c 6965 6e74 5f6d  ations, client_m
+00014ea0: 7367 732c 2074 7970 653d 7479 7065 2c20  sgs, type=type, 
+00014eb0: 7479 7065 6e61 6d65 3d74 7970 656e 616d  typename=typenam
+00014ec0: 650a 2020 2020 2020 2020 290a 0a20 2020  e.        )..   
+00014ed0: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
+00014ee0: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
+00014ef0: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
+00014f00: 2e70 726f 6365 7373 696e 675f 6f6e 0a20  .processing_on. 
+00014f10: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00014f20: 7420 6e6f 7420 7473 2e77 6169 7469 6e67  t not ts.waiting
+00014f30: 5f6f 6e0a 0a20 2020 2020 2020 2072 6574  _on..        ret
+00014f40: 7572 6e20 7265 636f 6d6d 656e 6461 7469  urn recommendati
+00014f50: 6f6e 732c 2063 6c69 656e 745f 6d73 6773  ons, client_msgs
+00014f60: 2c20 7b7d 0a0a 2020 2020 6465 6620 7472  , {}..    def tr
+00014f70: 616e 7369 7469 6f6e 5f6d 656d 6f72 795f  ansition_memory_
+00014f80: 7265 6c65 6173 6564 280a 2020 2020 2020  released(.      
+00014f90: 2020 7365 6c66 2c20 6b65 793a 2073 7472    self, key: str
+00014fa0: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
+00014fb0: 7472 2c20 2a2c 2073 6166 653a 2062 6f6f  tr, *, safe: boo
+00014fc0: 6c20 3d20 4661 6c73 650a 2020 2020 2920  l = False.    ) 
+00014fd0: 2d3e 2052 6563 734d 7367 733a 0a20 2020  -> RecsMsgs:.   
+00014fe0: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
+00014ff0: 6173 6b73 5b6b 6579 5d0a 0a20 2020 2020  asks[key]..     
+00015000: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
+00015010: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
+00015020: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
+00015030: 6169 7469 6e67 5f6f 6e0a 2020 2020 2020  aiting_on.      
+00015040: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+00015050: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
+00015060: 6e0a 2020 2020 2020 2020 2020 2020 6966  n.            if
+00015070: 2073 6166 653a 0a20 2020 2020 2020 2020   safe:.         
+00015080: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00015090: 7420 7473 2e77 6169 7465 7273 0a0a 2020  t ts.waiters..  
+000150a0: 2020 2020 2020 6966 2074 732e 6163 746f        if ts.acto
+000150b0: 723a 0a20 2020 2020 2020 2020 2020 2066  r:.            f
+000150c0: 6f72 2077 7320 696e 2074 732e 7768 6f5f  or ws in ts.who_
+000150d0: 6861 733a 0a20 2020 2020 2020 2020 2020  has:.           
+000150e0: 2020 2020 2077 732e 6163 746f 7273 2e64       ws.actors.d
+000150f0: 6973 6361 7264 2874 7329 0a20 2020 2020  iscard(ts).     
+00015100: 2020 2020 2020 2069 6620 7473 2e77 686f         if ts.who
+00015110: 5f77 616e 7473 3a0a 2020 2020 2020 2020  _wants:.        
+00015120: 2020 2020 2020 2020 7473 2e65 7863 6570          ts.excep
+00015130: 7469 6f6e 5f62 6c61 6d65 203d 2074 730a  tion_blame = ts.
+00015140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015150: 7473 2e65 7863 6570 7469 6f6e 203d 2053  ts.exception = S
+00015160: 6572 6961 6c69 7a65 6428 0a20 2020 2020  erialized(.     
+00015170: 2020 2020 2020 2020 2020 2020 2020 202a                 *
+00015180: 7365 7269 616c 697a 6528 5661 6c75 6545  serialize(ValueE
+00015190: 7272 6f72 2822 576f 726b 6572 2068 6f6c  rror("Worker hol
+000151a0: 6469 6e67 2041 6374 6f72 2077 6173 206c  ding Actor was l
+000151b0: 6f73 7422 2929 0a20 2020 2020 2020 2020  ost")).         
+000151c0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000151d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000151e0: 7b74 732e 6b65 793a 2022 6572 7265 6422  {ts.key: "erred"
+000151f0: 7d2c 207b 7d2c 207b 7d20 2023 2064 6f6e  }, {}, {}  # don
+00015200: 2774 2074 7279 2074 6f20 7265 6372 6561  't try to recrea
+00015210: 7465 0a0a 2020 2020 2020 2020 7265 636f  te..        reco
+00015220: 6d6d 656e 6461 7469 6f6e 733a 2052 6563  mmendations: Rec
+00015230: 7320 3d20 7b7d 0a20 2020 2020 2020 2063  s = {}.        c
+00015240: 6c69 656e 745f 6d73 6773 3a20 4d73 6773  lient_msgs: Msgs
+00015250: 203d 207b 7d0a 2020 2020 2020 2020 776f   = {}.        wo
+00015260: 726b 6572 5f6d 7367 733a 204d 7367 7320  rker_msgs: Msgs 
+00015270: 3d20 7b7d 0a0a 2020 2020 2020 2020 2320  = {}..        # 
+00015280: 5858 5820 6661 6374 6f72 2074 6869 7320  XXX factor this 
+00015290: 6f75 743f 0a20 2020 2020 2020 2077 6f72  out?.        wor
+000152a0: 6b65 725f 6d73 6720 3d20 7b0a 2020 2020  ker_msg = {.    
+000152b0: 2020 2020 2020 2020 226f 7022 3a20 2266          "op": "f
+000152c0: 7265 652d 6b65 7973 222c 0a20 2020 2020  ree-keys",.     
+000152d0: 2020 2020 2020 2022 6b65 7973 223a 205b         "keys": [
+000152e0: 6b65 795d 2c0a 2020 2020 2020 2020 2020  key],.          
+000152f0: 2020 2273 7469 6d75 6c75 735f 6964 223a    "stimulus_id":
+00015300: 2073 7469 6d75 6c75 735f 6964 2c0a 2020   stimulus_id,.  
+00015310: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00015320: 666f 7220 7773 2069 6e20 7473 2e77 686f  for ws in ts.who
+00015330: 5f68 6173 3a0a 2020 2020 2020 2020 2020  _has:.          
+00015340: 2020 776f 726b 6572 5f6d 7367 735b 7773    worker_msgs[ws
+00015350: 2e61 6464 7265 7373 5d20 3d20 5b77 6f72  .address] = [wor
+00015360: 6b65 725f 6d73 675d 0a20 2020 2020 2020  ker_msg].       
+00015370: 2073 656c 662e 7265 6d6f 7665 5f61 6c6c   self.remove_all
+00015380: 5f72 6570 6c69 6361 7328 7473 290a 0a20  _replicas(ts).. 
+00015390: 2020 2020 2020 2074 732e 7374 6174 6520         ts.state 
+000153a0: 3d20 2272 656c 6561 7365 6422 0a0a 2020  = "released"..  
+000153b0: 2020 2020 2020 7265 706f 7274 5f6d 7367        report_msg
+000153c0: 203d 207b 226f 7022 3a20 226c 6f73 742d   = {"op": "lost-
+000153d0: 6461 7461 222c 2022 6b65 7922 3a20 6b65  data", "key": ke
+000153e0: 797d 0a20 2020 2020 2020 2066 6f72 2063  y}.        for c
+000153f0: 7320 696e 2074 732e 7768 6f5f 7761 6e74  s in ts.who_want
+00015400: 733a 0a20 2020 2020 2020 2020 2020 2063  s:.            c
+00015410: 6c69 656e 745f 6d73 6773 5b63 732e 636c  lient_msgs[cs.cl
+00015420: 6965 6e74 5f6b 6579 5d20 3d20 5b72 6570  ient_key] = [rep
+00015430: 6f72 745f 6d73 675d 0a0a 2020 2020 2020  ort_msg]..      
+00015440: 2020 6966 206e 6f74 2074 732e 7275 6e5f    if not ts.run_
+00015450: 7370 6563 3a20 2023 2070 7572 6520 6461  spec:  # pure da
+00015460: 7461 0a20 2020 2020 2020 2020 2020 2072  ta.            r
+00015470: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b6b  ecommendations[k
+00015480: 6579 5d20 3d20 2266 6f72 676f 7474 656e  ey] = "forgotten
+00015490: 220a 2020 2020 2020 2020 656c 6966 2074  ".        elif t
+000154a0: 732e 6861 735f 6c6f 7374 5f64 6570 656e  s.has_lost_depen
+000154b0: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
+000154c0: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+000154d0: 696f 6e73 5b6b 6579 5d20 3d20 2266 6f72  ions[key] = "for
+000154e0: 676f 7474 656e 220a 2020 2020 2020 2020  gotten".        
+000154f0: 656c 6966 2074 732e 7768 6f5f 7761 6e74  elif ts.who_want
+00015500: 7320 6f72 2074 732e 7761 6974 6572 733a  s or ts.waiters:
+00015510: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
+00015520: 6f6d 6d65 6e64 6174 696f 6e73 5b6b 6579  ommendations[key
+00015530: 5d20 3d20 2277 6169 7469 6e67 220a 0a20  ] = "waiting".. 
+00015540: 2020 2020 2020 2066 6f72 2064 7473 2069         for dts i
+00015550: 6e20 7473 2e77 6169 7465 7273 3a0a 2020  n ts.waiters:.  
+00015560: 2020 2020 2020 2020 2020 6966 2064 7473            if dts
+00015570: 2e73 7461 7465 2069 6e20 2822 6e6f 2d77  .state in ("no-w
+00015580: 6f72 6b65 7222 2c20 2270 726f 6365 7373  orker", "process
+00015590: 696e 6722 293a 0a20 2020 2020 2020 2020  ing"):.         
+000155a0: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
+000155b0: 6174 696f 6e73 5b64 7473 2e6b 6579 5d20  ations[dts.key] 
+000155c0: 3d20 2277 6169 7469 6e67 220a 2020 2020  = "waiting".    
+000155d0: 2020 2020 2020 2020 656c 6966 2064 7473          elif dts
+000155e0: 2e73 7461 7465 203d 3d20 2277 6169 7469  .state == "waiti
+000155f0: 6e67 223a 0a20 2020 2020 2020 2020 2020  ng":.           
+00015600: 2020 2020 2064 7473 2e77 6169 7469 6e67       dts.waiting
+00015610: 5f6f 6e2e 6164 6428 7473 290a 0a20 2020  _on.add(ts)..   
+00015620: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
+00015630: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
+00015640: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
+00015650: 2e77 6169 7469 6e67 5f6f 6e0a 0a20 2020  .waiting_on..   
+00015660: 2020 2020 2072 6574 7572 6e20 7265 636f       return reco
+00015670: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
+00015680: 656e 745f 6d73 6773 2c20 776f 726b 6572  ent_msgs, worker
+00015690: 5f6d 7367 730a 0a20 2020 2064 6566 2074  _msgs..    def t
+000156a0: 7261 6e73 6974 696f 6e5f 7265 6c65 6173  ransition_releas
+000156b0: 6564 5f65 7272 6564 2873 656c 662c 206b  ed_erred(self, k
+000156c0: 6579 3a20 7374 722c 2073 7469 6d75 6c75  ey: str, stimulu
+000156d0: 735f 6964 3a20 7374 7229 202d 3e20 5265  s_id: str) -> Re
+000156e0: 6373 4d73 6773 3a0a 2020 2020 2020 2020  csMsgs:.        
+000156f0: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
+00015700: 6b65 795d 0a20 2020 2020 2020 2072 6563  key].        rec
+00015710: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
+00015720: 6373 203d 207b 7d0a 2020 2020 2020 2020  cs = {}.        
+00015730: 636c 6965 6e74 5f6d 7367 733a 204d 7367  client_msgs: Msg
+00015740: 7320 3d20 7b7d 0a0a 2020 2020 2020 2020  s = {}..        
+00015750: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
+00015760: 3a0a 2020 2020 2020 2020 2020 2020 7769  :.            wi
+00015770: 7468 206c 6f67 5f65 7272 6f72 7328 7064  th log_errors(pd
+00015780: 623d 4c4f 475f 5044 4229 3a0a 2020 2020  b=LOG_PDB):.    
+00015790: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000157a0: 7274 2074 732e 6578 6365 7074 696f 6e5f  rt ts.exception_
+000157b0: 626c 616d 650a 2020 2020 2020 2020 2020  blame.          
+000157c0: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+000157d0: 2074 732e 7768 6f5f 6861 730a 2020 2020   ts.who_has.    
+000157e0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000157f0: 7274 206e 6f74 2074 732e 7761 6974 696e  rt not ts.waitin
+00015800: 675f 6f6e 0a20 2020 2020 2020 2020 2020  g_on.           
+00015810: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+00015820: 7473 2e77 6169 7465 7273 0a0a 2020 2020  ts.waiters..    
+00015830: 2020 2020 6661 696c 696e 675f 7473 203d      failing_ts =
+00015840: 2074 732e 6578 6365 7074 696f 6e5f 626c   ts.exception_bl
+00015850: 616d 650a 2020 2020 2020 2020 6173 7365  ame.        asse
+00015860: 7274 2066 6169 6c69 6e67 5f74 730a 0a20  rt failing_ts.. 
+00015870: 2020 2020 2020 2066 6f72 2064 7473 2069         for dts i
+00015880: 6e20 7473 2e64 6570 656e 6465 6e74 733a  n ts.dependents:
+00015890: 0a20 2020 2020 2020 2020 2020 2064 7473  .            dts
+000158a0: 2e65 7863 6570 7469 6f6e 5f62 6c61 6d65  .exception_blame
+000158b0: 203d 2066 6169 6c69 6e67 5f74 730a 2020   = failing_ts.  
+000158c0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+000158d0: 2064 7473 2e77 686f 5f68 6173 3a0a 2020   dts.who_has:.  
+000158e0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000158f0: 636f 6d6d 656e 6461 7469 6f6e 735b 6474  commendations[dt
+00015900: 732e 6b65 795d 203d 2022 6572 7265 6422  s.key] = "erred"
+00015910: 0a0a 2020 2020 2020 2020 7265 706f 7274  ..        report
+00015920: 5f6d 7367 203d 207b 0a20 2020 2020 2020  _msg = {.       
+00015930: 2020 2020 2022 6f70 223a 2022 7461 736b       "op": "task
+00015940: 2d65 7272 6564 222c 0a20 2020 2020 2020  -erred",.       
+00015950: 2020 2020 2022 6b65 7922 3a20 6b65 792c       "key": key,
+00015960: 0a20 2020 2020 2020 2020 2020 2022 6578  .            "ex
+00015970: 6365 7074 696f 6e22 3a20 6661 696c 696e  ception": failin
+00015980: 675f 7473 2e65 7863 6570 7469 6f6e 2c0a  g_ts.exception,.
+00015990: 2020 2020 2020 2020 2020 2020 2274 7261              "tra
+000159a0: 6365 6261 636b 223a 2066 6169 6c69 6e67  ceback": failing
+000159b0: 5f74 732e 7472 6163 6562 6163 6b2c 0a20  _ts.traceback,. 
+000159c0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+000159d0: 2066 6f72 2063 7320 696e 2074 732e 7768   for cs in ts.wh
+000159e0: 6f5f 7761 6e74 733a 0a20 2020 2020 2020  o_wants:.       
+000159f0: 2020 2020 2063 6c69 656e 745f 6d73 6773       client_msgs
+00015a00: 5b63 732e 636c 6965 6e74 5f6b 6579 5d20  [cs.client_key] 
+00015a10: 3d20 5b72 6570 6f72 745f 6d73 675d 0a0a  = [report_msg]..
+00015a20: 2020 2020 2020 2020 7473 2e73 7461 7465          ts.state
+00015a30: 203d 2022 6572 7265 6422 0a0a 2020 2020   = "erred"..    
+00015a40: 2020 2020 2320 544f 444f 3a20 7761 6974      # TODO: wait
+00015a50: 696e 6720 6461 7461 3f0a 2020 2020 2020  ing data?.      
+00015a60: 2020 7265 7475 726e 2072 6563 6f6d 6d65    return recomme
+00015a70: 6e64 6174 696f 6e73 2c20 636c 6965 6e74  ndations, client
+00015a80: 5f6d 7367 732c 207b 7d0a 0a20 2020 2064  _msgs, {}..    d
+00015a90: 6566 2074 7261 6e73 6974 696f 6e5f 6572  ef transition_er
+00015aa0: 7265 645f 7265 6c65 6173 6564 2873 656c  red_released(sel
+00015ab0: 662c 206b 6579 3a20 7374 722c 2073 7469  f, key: str, sti
+00015ac0: 6d75 6c75 735f 6964 3a20 7374 7229 202d  mulus_id: str) -
+00015ad0: 3e20 5265 6373 4d73 6773 3a0a 2020 2020  > RecsMsgs:.    
+00015ae0: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
+00015af0: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
+00015b00: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00015b10: 3a20 5265 6373 203d 207b 7d0a 2020 2020  : Recs = {}.    
+00015b20: 2020 2020 636c 6965 6e74 5f6d 7367 733a      client_msgs:
+00015b30: 204d 7367 7320 3d20 7b7d 0a20 2020 2020   Msgs = {}.     
+00015b40: 2020 2077 6f72 6b65 725f 6d73 6773 3a20     worker_msgs: 
+00015b50: 4d73 6773 203d 207b 7d0a 0a20 2020 2020  Msgs = {}..     
+00015b60: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
+00015b70: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
+00015b80: 2077 6974 6820 6c6f 675f 6572 726f 7273   with log_errors
+00015b90: 2870 6462 3d4c 4f47 5f50 4442 293a 0a20  (pdb=LOG_PDB):. 
+00015ba0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00015bb0: 7373 6572 7420 7473 2e65 7863 6570 7469  ssert ts.excepti
+00015bc0: 6f6e 5f62 6c61 6d65 0a20 2020 2020 2020  on_blame.       
+00015bd0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00015be0: 6e6f 7420 7473 2e77 686f 5f68 6173 0a20  not ts.who_has. 
+00015bf0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00015c00: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
+00015c10: 7469 6e67 5f6f 6e0a 2020 2020 2020 2020  ting_on.        
+00015c20: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+00015c30: 6f74 2074 732e 7761 6974 6572 730a 0a20  ot ts.waiters.. 
+00015c40: 2020 2020 2020 2074 732e 6578 6365 7074         ts.except
+00015c50: 696f 6e20 3d20 4e6f 6e65 0a20 2020 2020  ion = None.     
+00015c60: 2020 2074 732e 6578 6365 7074 696f 6e5f     ts.exception_
+00015c70: 626c 616d 6520 3d20 4e6f 6e65 0a20 2020  blame = None.   
+00015c80: 2020 2020 2074 732e 7472 6163 6562 6163       ts.tracebac
+00015c90: 6b20 3d20 4e6f 6e65 0a0a 2020 2020 2020  k = None..      
+00015ca0: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
+00015cb0: 6465 7065 6e64 656e 7473 3a0a 2020 2020  dependents:.    
+00015cc0: 2020 2020 2020 2020 6966 2064 7473 2e73          if dts.s
+00015cd0: 7461 7465 203d 3d20 2265 7272 6564 223a  tate == "erred":
+00015ce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015cf0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00015d00: 5b64 7473 2e6b 6579 5d20 3d20 2277 6169  [dts.key] = "wai
+00015d10: 7469 6e67 220a 0a20 2020 2020 2020 2077  ting"..        w
+00015d20: 5f6d 7367 203d 207b 0a20 2020 2020 2020  _msg = {.       
+00015d30: 2020 2020 2022 6f70 223a 2022 6672 6565       "op": "free
+00015d40: 2d6b 6579 7322 2c0a 2020 2020 2020 2020  -keys",.        
+00015d50: 2020 2020 226b 6579 7322 3a20 5b6b 6579      "keys": [key
+00015d60: 5d2c 0a20 2020 2020 2020 2020 2020 2022  ],.            "
+00015d70: 7374 696d 756c 7573 5f69 6422 3a20 7374  stimulus_id": st
+00015d80: 696d 756c 7573 5f69 642c 0a20 2020 2020  imulus_id,.     
+00015d90: 2020 207d 0a20 2020 2020 2020 2066 6f72     }.        for
+00015da0: 2077 735f 6164 6472 2069 6e20 7473 2e65   ws_addr in ts.e
+00015db0: 7272 6564 5f6f 6e3a 0a20 2020 2020 2020  rred_on:.       
+00015dc0: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
+00015dd0: 5b77 735f 6164 6472 5d20 3d20 5b77 5f6d  [ws_addr] = [w_m
+00015de0: 7367 5d0a 2020 2020 2020 2020 7473 2e65  sg].        ts.e
+00015df0: 7272 6564 5f6f 6e2e 636c 6561 7228 290a  rred_on.clear().
+00015e00: 0a20 2020 2020 2020 2072 6570 6f72 745f  .        report_
+00015e10: 6d73 6720 3d20 7b22 6f70 223a 2022 7461  msg = {"op": "ta
+00015e20: 736b 2d72 6574 7269 6564 222c 2022 6b65  sk-retried", "ke
+00015e30: 7922 3a20 6b65 797d 0a20 2020 2020 2020  y": key}.       
+00015e40: 2066 6f72 2063 7320 696e 2074 732e 7768   for cs in ts.wh
+00015e50: 6f5f 7761 6e74 733a 0a20 2020 2020 2020  o_wants:.       
+00015e60: 2020 2020 2063 6c69 656e 745f 6d73 6773       client_msgs
+00015e70: 5b63 732e 636c 6965 6e74 5f6b 6579 5d20  [cs.client_key] 
+00015e80: 3d20 5b72 6570 6f72 745f 6d73 675d 0a0a  = [report_msg]..
+00015e90: 2020 2020 2020 2020 7473 2e73 7461 7465          ts.state
+00015ea0: 203d 2022 7265 6c65 6173 6564 220a 0a20   = "released".. 
+00015eb0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+00015ec0: 636f 6d6d 656e 6461 7469 6f6e 732c 2063  commendations, c
+00015ed0: 6c69 656e 745f 6d73 6773 2c20 776f 726b  lient_msgs, work
+00015ee0: 6572 5f6d 7367 730a 0a20 2020 2064 6566  er_msgs..    def
+00015ef0: 2074 7261 6e73 6974 696f 6e5f 7761 6974   transition_wait
+00015f00: 696e 675f 7265 6c65 6173 6564 2873 656c  ing_released(sel
+00015f10: 662c 206b 6579 3a20 7374 722c 2073 7469  f, key: str, sti
+00015f20: 6d75 6c75 735f 6964 3a20 7374 7229 202d  mulus_id: str) -
+00015f30: 3e20 5265 6373 4d73 6773 3a0a 2020 2020  > RecsMsgs:.    
+00015f40: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
+00015f50: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
+00015f60: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00015f70: 3a20 5265 6373 203d 207b 7d0a 0a20 2020  : Recs = {}..   
+00015f80: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
+00015f90: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
+00015fa0: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
+00015fb0: 2e77 686f 5f68 6173 0a20 2020 2020 2020  .who_has.       
+00015fc0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+00015fd0: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
+00015fe0: 0a0a 2020 2020 2020 2020 666f 7220 6474  ..        for dt
+00015ff0: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+00016000: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
+00016010: 2020 6966 2074 7320 696e 2064 7473 2e77    if ts in dts.w
+00016020: 6169 7465 7273 3a0a 2020 2020 2020 2020  aiters:.        
+00016030: 2020 2020 2020 2020 6474 732e 7761 6974          dts.wait
+00016040: 6572 732e 6469 7363 6172 6428 7473 290a  ers.discard(ts).
+00016050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016060: 6966 206e 6f74 2064 7473 2e77 6169 7465  if not dts.waite
+00016070: 7273 2061 6e64 206e 6f74 2064 7473 2e77  rs and not dts.w
+00016080: 686f 5f77 616e 7473 3a0a 2020 2020 2020  ho_wants:.      
+00016090: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000160a0: 636f 6d6d 656e 6461 7469 6f6e 735b 6474  commendations[dt
+000160b0: 732e 6b65 795d 203d 2022 7265 6c65 6173  s.key] = "releas
+000160c0: 6564 220a 2020 2020 2020 2020 7473 2e77  ed".        ts.w
+000160d0: 6169 7469 6e67 5f6f 6e2e 636c 6561 7228  aiting_on.clear(
+000160e0: 290a 0a20 2020 2020 2020 2074 732e 7374  )..        ts.st
+000160f0: 6174 6520 3d20 2272 656c 6561 7365 6422  ate = "released"
+00016100: 0a0a 2020 2020 2020 2020 6966 2074 732e  ..        if ts.
+00016110: 6861 735f 6c6f 7374 5f64 6570 656e 6465  has_lost_depende
+00016120: 6e63 6965 733a 0a20 2020 2020 2020 2020  ncies:.         
+00016130: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
+00016140: 6e73 5b6b 6579 5d20 3d20 2266 6f72 676f  ns[key] = "forgo
+00016150: 7474 656e 220a 2020 2020 2020 2020 656c  tten".        el
+00016160: 6966 206e 6f74 2074 732e 6578 6365 7074  if not ts.except
+00016170: 696f 6e5f 626c 616d 6520 616e 6420 2874  ion_blame and (t
+00016180: 732e 7768 6f5f 7761 6e74 7320 6f72 2074  s.who_wants or t
+00016190: 732e 7761 6974 6572 7329 3a0a 2020 2020  s.waiters):.    
+000161a0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+000161b0: 6461 7469 6f6e 735b 6b65 795d 203d 2022  dations[key] = "
+000161c0: 7761 6974 696e 6722 0a20 2020 2020 2020  waiting".       
+000161d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000161e0: 2020 2074 732e 7761 6974 6572 732e 636c     ts.waiters.cl
+000161f0: 6561 7228 290a 0a20 2020 2020 2020 2072  ear()..        r
+00016200: 6574 7572 6e20 7265 636f 6d6d 656e 6461  eturn recommenda
+00016210: 7469 6f6e 732c 207b 7d2c 207b 7d0a 0a20  tions, {}, {}.. 
+00016220: 2020 2064 6566 2074 7261 6e73 6974 696f     def transitio
+00016230: 6e5f 7072 6f63 6573 7369 6e67 5f72 656c  n_processing_rel
+00016240: 6561 7365 6428 7365 6c66 2c20 6b65 793a  eased(self, key:
+00016250: 2073 7472 2c20 7374 696d 756c 7573 5f69   str, stimulus_i
+00016260: 643a 2073 7472 2920 2d3e 2052 6563 734d  d: str) -> RecsM
+00016270: 7367 733a 0a20 2020 2020 2020 2074 7320  sgs:.        ts 
+00016280: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
+00016290: 5d0a 2020 2020 2020 2020 7265 636f 6d6d  ].        recomm
+000162a0: 656e 6461 7469 6f6e 733a 2052 6563 7320  endations: Recs 
+000162b0: 3d20 7b7d 0a20 2020 2020 2020 2077 6f72  = {}.        wor
+000162c0: 6b65 725f 6d73 6773 3a20 4d73 6773 203d  ker_msgs: Msgs =
+000162d0: 207b 7d0a 0a20 2020 2020 2020 2069 6620   {}..        if 
+000162e0: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
+000162f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00016300: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
+00016310: 6f6e 0a20 2020 2020 2020 2020 2020 2061  on.            a
+00016320: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
+00016330: 5f68 6173 0a20 2020 2020 2020 2020 2020  _has.           
+00016340: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
+00016350: 6169 7469 6e67 5f6f 6e0a 2020 2020 2020  aiting_on.      
+00016360: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
+00016370: 7374 6174 6520 3d3d 2022 7072 6f63 6573  state == "proces
+00016380: 7369 6e67 220a 0a20 2020 2020 2020 2077  sing"..        w
+00016390: 7320 3d20 7365 6c66 2e5f 6578 6974 5f70  s = self._exit_p
+000163a0: 726f 6365 7373 696e 675f 636f 6d6d 6f6e  rocessing_common
+000163b0: 2874 7329 0a20 2020 2020 2020 2069 6620  (ts).        if 
+000163c0: 7773 3a0a 2020 2020 2020 2020 2020 2020  ws:.            
+000163d0: 776f 726b 6572 5f6d 7367 735b 7773 2e61  worker_msgs[ws.a
+000163e0: 6464 7265 7373 5d20 3d20 5b0a 2020 2020  ddress] = [.    
+000163f0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00016400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016410: 2020 226f 7022 3a20 2266 7265 652d 6b65    "op": "free-ke
+00016420: 7973 222c 0a20 2020 2020 2020 2020 2020  ys",.           
+00016430: 2020 2020 2020 2020 2022 6b65 7973 223a           "keys":
+00016440: 205b 6b65 795d 2c0a 2020 2020 2020 2020   [key],.        
+00016450: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
+00016460: 6d75 6c75 735f 6964 223a 2073 7469 6d75  mulus_id": stimu
+00016470: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
+00016480: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00016490: 2020 2020 2020 5d0a 0a20 2020 2020 2020        ]..       
+000164a0: 2073 656c 662e 5f70 726f 7061 6761 7465   self._propagate
+000164b0: 5f72 656c 6561 7365 6428 7473 2c20 7265  _released(ts, re
+000164c0: 636f 6d6d 656e 6461 7469 6f6e 7329 0a20  commendations). 
+000164d0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+000164e0: 636f 6d6d 656e 6461 7469 6f6e 732c 207b  commendations, {
+000164f0: 7d2c 2077 6f72 6b65 725f 6d73 6773 0a0a  }, worker_msgs..
+00016500: 2020 2020 6465 6620 7472 616e 7369 7469      def transiti
+00016510: 6f6e 5f70 726f 6365 7373 696e 675f 6572  on_processing_er
+00016520: 7265 6428 0a20 2020 2020 2020 2073 656c  red(.        sel
+00016530: 662c 0a20 2020 2020 2020 206b 6579 3a20  f,.        key: 
+00016540: 7374 722c 0a20 2020 2020 2020 2073 7469  str,.        sti
+00016550: 6d75 6c75 735f 6964 3a20 7374 722c 0a20  mulus_id: str,. 
+00016560: 2020 2020 2020 202a 2c0a 2020 2020 2020         *,.      
+00016570: 2020 776f 726b 6572 3a20 7374 722c 0a20    worker: str,. 
+00016580: 2020 2020 2020 2063 6175 7365 3a20 7374         cause: st
+00016590: 7220 7c20 4e6f 6e65 203d 204e 6f6e 652c  r | None = None,
+000165a0: 0a20 2020 2020 2020 2065 7863 6570 7469  .        excepti
+000165b0: 6f6e 3a20 5365 7269 616c 697a 6564 207c  on: Serialized |
+000165c0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+000165d0: 2020 2020 2020 7472 6163 6562 6163 6b3a        traceback:
+000165e0: 2053 6572 6961 6c69 7a65 6420 7c20 4e6f   Serialized | No
+000165f0: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
+00016600: 2020 2065 7863 6570 7469 6f6e 5f74 6578     exception_tex
+00016610: 743a 2073 7472 207c 204e 6f6e 6520 3d20  t: str | None = 
+00016620: 4e6f 6e65 2c0a 2020 2020 2020 2020 7472  None,.        tr
+00016630: 6163 6562 6163 6b5f 7465 7874 3a20 7374  aceback_text: st
+00016640: 7220 7c20 4e6f 6e65 203d 204e 6f6e 652c  r | None = None,
+00016650: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
+00016660: 733a 2041 6e79 2c0a 2020 2020 2920 2d3e  s: Any,.    ) ->
+00016670: 2052 6563 734d 7367 733a 0a20 2020 2020   RecsMsgs:.     
+00016680: 2020 2022 2222 5072 6f63 6573 7365 6420     """Processed 
+00016690: 6120 7265 636f 6d6d 656e 6465 6420 7472  a recommended tr
+000166a0: 616e 7369 7469 6f6e 2070 726f 6365 7373  ansition process
+000166b0: 696e 6720 2d3e 2065 7272 6564 2e0a 0a20  ing -> erred... 
+000166c0: 2020 2020 2020 2050 6172 616d 6574 6572         Parameter
+000166d0: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
+000166e0: 2d2d 2d2d 0a20 2020 2020 2020 206b 6579  ----.        key
+000166f0: 0a20 2020 2020 2020 2020 2020 4b65 7920  .           Key 
+00016700: 6f66 2074 6865 2074 6173 6b20 746f 2074  of the task to t
+00016710: 7261 6e73 6974 696f 6e0a 2020 2020 2020  ransition.      
+00016720: 2020 7374 696d 756c 7573 5f69 640a 2020    stimulus_id.  
+00016730: 2020 2020 2020 2020 2020 4944 206f 6620            ID of 
+00016740: 7468 6520 7374 696d 756c 7573 2063 6175  the stimulus cau
+00016750: 7369 6e67 2074 6865 2074 7261 6e73 6974  sing the transit
+00016760: 696f 6e0a 2020 2020 2020 2020 776f 726b  ion.        work
+00016770: 6572 0a20 2020 2020 2020 2020 2020 2041  er.            A
+00016780: 6464 7265 7373 206f 6620 7468 6520 776f  ddress of the wo
+00016790: 726b 6572 2077 6865 7265 2074 6865 2074  rker where the t
+000167a0: 6173 6b20 6572 7265 642e 0a20 2020 2020  ask erred..     
+000167b0: 2020 2020 2020 204e 6f74 206e 6563 6573         Not neces
+000167c0: 7361 7269 6c79 2060 6074 732e 7072 6f63  sarily ``ts.proc
+000167d0: 6573 7369 6e67 5f6f 6e60 602e 0a20 2020  essing_on``..   
+000167e0: 2020 2020 2063 6175 7365 0a20 2020 2020       cause.     
+000167f0: 2020 2020 2020 2041 6464 7265 7373 206f         Address o
+00016800: 6620 7468 6520 7461 736b 2074 6861 7420  f the task that 
+00016810: 6361 7573 6564 2074 6869 7320 7461 736b  caused this task
+00016820: 2074 6f20 6265 2074 7261 6e73 6974 696f   to be transitio
+00016830: 6e65 6420 746f 2065 7272 6564 0a20 2020  ned to erred.   
+00016840: 2020 2020 2065 7863 6570 7469 6f6e 0a20       exception. 
+00016850: 2020 2020 2020 2020 2020 2045 7863 6570             Excep
+00016860: 7469 6f6e 2063 6175 7365 6420 6279 2074  tion caused by t
+00016870: 6865 2074 6173 6b0a 2020 2020 2020 2020  he task.        
+00016880: 7472 6163 6562 6163 6b0a 2020 2020 2020  traceback.      
+00016890: 2020 2020 2020 5472 6163 6562 6163 6b20        Traceback 
+000168a0: 6361 7573 6564 2062 7920 7468 6520 7461  caused by the ta
+000168b0: 736b 0a20 2020 2020 2020 2065 7863 6570  sk.        excep
+000168c0: 7469 6f6e 5f74 6578 740a 2020 2020 2020  tion_text.      
+000168d0: 2020 2020 2020 5374 7269 6e67 2072 6570        String rep
+000168e0: 7265 7365 6e74 6174 696f 6e20 6f66 2074  resentation of t
+000168f0: 6865 2065 7863 6570 7469 6f6e 0a20 2020  he exception.   
+00016900: 2020 2020 2074 7261 6365 6261 636b 5f74       traceback_t
+00016910: 6578 740a 2020 2020 2020 2020 2020 2020  ext.            
+00016920: 5374 7269 6e67 2072 6570 7265 7365 6e74  String represent
+00016930: 6174 696f 6e20 6f66 2074 6865 2074 7261  ation of the tra
+00016940: 6365 6261 636b 0a0a 2020 2020 2020 2020  ceback..        
+00016950: 5265 7475 726e 730a 2020 2020 2020 2020  Returns.        
+00016960: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+00016970: 5265 636f 6d6d 656e 6461 7469 6f6e 732c  Recommendations,
+00016980: 2063 6c69 656e 7420 6d65 7373 6167 6573   client messages
+00016990: 2061 6e64 2077 6f72 6b65 7220 6d65 7373   and worker mess
+000169a0: 6167 6573 2074 6f20 7072 6f63 6573 730a  ages to process.
+000169b0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+000169c0: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
+000169d0: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
+000169e0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+000169f0: 3a20 5265 6373 203d 207b 7d0a 2020 2020  : Recs = {}.    
+00016a00: 2020 2020 636c 6965 6e74 5f6d 7367 733a      client_msgs:
+00016a10: 204d 7367 7320 3d20 7b7d 0a0a 2020 2020   Msgs = {}..    
+00016a20: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
+00016a30: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
+00016a40: 2020 6173 7365 7274 2063 6175 7365 206f    assert cause o
+00016a50: 7220 7473 2e65 7863 6570 7469 6f6e 5f62  r ts.exception_b
+00016a60: 6c61 6d65 0a20 2020 2020 2020 2020 2020  lame.           
+00016a70: 2061 7373 6572 7420 7473 2e70 726f 6365   assert ts.proce
+00016a80: 7373 696e 675f 6f6e 0a20 2020 2020 2020  ssing_on.       
+00016a90: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+00016aa0: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
+00016ab0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00016ac0: 7420 7473 2e77 6169 7469 6e67 5f6f 6e0a  t ts.waiting_on.
+00016ad0: 0a20 2020 2020 2020 2069 6620 7473 2e61  .        if ts.a
+00016ae0: 6374 6f72 3a0a 2020 2020 2020 2020 2020  ctor:.          
+00016af0: 2020 7773 203d 2074 732e 7072 6f63 6573    ws = ts.proces
+00016b00: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
+00016b10: 2020 2020 6173 7365 7274 2077 730a 2020      assert ws.  
+00016b20: 2020 2020 2020 2020 2020 7773 2e61 6374            ws.act
+00016b30: 6f72 732e 7265 6d6f 7665 2874 7329 0a0a  ors.remove(ts)..
+00016b40: 2020 2020 2020 2020 7365 6c66 2e5f 6578          self._ex
+00016b50: 6974 5f70 726f 6365 7373 696e 675f 636f  it_processing_co
+00016b60: 6d6d 6f6e 2874 7329 0a0a 2020 2020 2020  mmon(ts)..      
+00016b70: 2020 7473 2e65 7272 6564 5f6f 6e2e 6164    ts.erred_on.ad
+00016b80: 6428 776f 726b 6572 290a 2020 2020 2020  d(worker).      
+00016b90: 2020 6966 2065 7863 6570 7469 6f6e 2069    if exception i
+00016ba0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00016bb0: 2020 2020 2020 2020 7473 2e65 7863 6570          ts.excep
+00016bc0: 7469 6f6e 203d 2065 7863 6570 7469 6f6e  tion = exception
+00016bd0: 0a20 2020 2020 2020 2020 2020 2074 732e  .            ts.
+00016be0: 6578 6365 7074 696f 6e5f 7465 7874 203d  exception_text =
+00016bf0: 2065 7863 6570 7469 6f6e 5f74 6578 7420   exception_text 
+00016c00: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
+00016c10: 2020 2020 2020 2020 6966 2074 7261 6365          if trace
+00016c20: 6261 636b 2069 7320 6e6f 7420 4e6f 6e65  back is not None
+00016c30: 3a0a 2020 2020 2020 2020 2020 2020 7473  :.            ts
+00016c40: 2e74 7261 6365 6261 636b 203d 2074 7261  .traceback = tra
+00016c50: 6365 6261 636b 0a20 2020 2020 2020 2020  ceback.         
+00016c60: 2020 2074 732e 7472 6163 6562 6163 6b5f     ts.traceback_
+00016c70: 7465 7874 203d 2074 7261 6365 6261 636b  text = traceback
+00016c80: 5f74 6578 7420 2023 2074 7970 653a 2069  _text  # type: i
+00016c90: 676e 6f72 650a 2020 2020 2020 2020 6966  gnore.        if
+00016ca0: 2063 6175 7365 2069 7320 6e6f 7420 4e6f   cause is not No
+00016cb0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00016cc0: 6661 696c 696e 675f 7473 203d 2073 656c  failing_ts = sel
+00016cd0: 662e 7461 736b 735b 6361 7573 655d 0a20  f.tasks[cause]. 
+00016ce0: 2020 2020 2020 2020 2020 2074 732e 6578             ts.ex
+00016cf0: 6365 7074 696f 6e5f 626c 616d 6520 3d20  ception_blame = 
+00016d00: 6661 696c 696e 675f 7473 0a20 2020 2020  failing_ts.     
+00016d10: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00016d20: 2020 2020 2066 6169 6c69 6e67 5f74 7320       failing_ts 
+00016d30: 3d20 7473 2e65 7863 6570 7469 6f6e 5f62  = ts.exception_b
+00016d40: 6c61 6d65 2020 2320 7479 7065 3a20 6967  lame  # type: ig
+00016d50: 6e6f 7265 0a0a 2020 2020 2020 2020 7365  nore..        se
+00016d60: 6c66 2e65 7272 6564 5f74 6173 6b73 2e61  lf.erred_tasks.a
+00016d70: 7070 656e 646c 6566 7428 0a20 2020 2020  ppendleft(.     
+00016d80: 2020 2020 2020 2045 7272 6564 5461 736b         ErredTask
+00016d90: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00016da0: 2020 7473 2e6b 6579 2c0a 2020 2020 2020    ts.key,.      
+00016db0: 2020 2020 2020 2020 2020 7469 6d65 2829            time()
+00016dc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00016dd0: 2020 7473 2e65 7272 6564 5f6f 6e2e 636f    ts.erred_on.co
+00016de0: 7079 2829 2c0a 2020 2020 2020 2020 2020  py(),.          
+00016df0: 2020 2020 2020 6578 6365 7074 696f 6e5f        exception_
+00016e00: 7465 7874 206f 7220 2222 2c0a 2020 2020  text or "",.    
+00016e10: 2020 2020 2020 2020 2020 2020 7472 6163              trac
+00016e20: 6562 6163 6b5f 7465 7874 206f 7220 2222  eback_text or ""
+00016e30: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00016e40: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00016e50: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
+00016e60: 2e64 6570 656e 6465 6e74 733a 0a20 2020  .dependents:.   
+00016e70: 2020 2020 2020 2020 2064 7473 2e65 7863           dts.exc
+00016e80: 6570 7469 6f6e 5f62 6c61 6d65 203d 2066  eption_blame = f
+00016e90: 6169 6c69 6e67 5f74 730a 2020 2020 2020  ailing_ts.      
+00016ea0: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
+00016eb0: 7469 6f6e 735b 6474 732e 6b65 795d 203d  tions[dts.key] =
+00016ec0: 2022 6572 7265 6422 0a0a 2020 2020 2020   "erred"..      
+00016ed0: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
+00016ee0: 6465 7065 6e64 656e 6369 6573 3a0a 2020  dependencies:.  
+00016ef0: 2020 2020 2020 2020 2020 6474 732e 7761            dts.wa
+00016f00: 6974 6572 732e 6469 7363 6172 6428 7473  iters.discard(ts
+00016f10: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00016f20: 206e 6f74 2064 7473 2e77 6169 7465 7273   not dts.waiters
+00016f30: 2061 6e64 206e 6f74 2064 7473 2e77 686f   and not dts.who
+00016f40: 5f77 616e 7473 3a0a 2020 2020 2020 2020  _wants:.        
+00016f50: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+00016f60: 6461 7469 6f6e 735b 6474 732e 6b65 795d  dations[dts.key]
+00016f70: 203d 2022 7265 6c65 6173 6564 220a 0a20   = "released".. 
+00016f80: 2020 2020 2020 2074 732e 7761 6974 6572         ts.waiter
+00016f90: 732e 636c 6561 7228 2920 2023 2064 6f20  s.clear()  # do 
+00016fa0: 616e 7974 6869 6e67 2077 6974 6820 7468  anything with th
+00016fb0: 6973 3f0a 0a20 2020 2020 2020 2074 732e  is?..        ts.
+00016fc0: 7374 6174 6520 3d20 2265 7272 6564 220a  state = "erred".
+00016fd0: 0a20 2020 2020 2020 2072 6570 6f72 745f  .        report_
+00016fe0: 6d73 6720 3d20 7b0a 2020 2020 2020 2020  msg = {.        
+00016ff0: 2020 2020 226f 7022 3a20 2274 6173 6b2d      "op": "task-
+00017000: 6572 7265 6422 2c0a 2020 2020 2020 2020  erred",.        
+00017010: 2020 2020 226b 6579 223a 206b 6579 2c0a      "key": key,.
+00017020: 2020 2020 2020 2020 2020 2020 2265 7863              "exc
+00017030: 6570 7469 6f6e 223a 2066 6169 6c69 6e67  eption": failing
+00017040: 5f74 732e 6578 6365 7074 696f 6e2c 0a20  _ts.exception,. 
+00017050: 2020 2020 2020 2020 2020 2022 7472 6163             "trac
+00017060: 6562 6163 6b22 3a20 6661 696c 696e 675f  eback": failing_
+00017070: 7473 2e74 7261 6365 6261 636b 2c0a 2020  ts.traceback,.  
+00017080: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00017090: 666f 7220 6373 2069 6e20 7473 2e77 686f  for cs in ts.who
+000170a0: 5f77 616e 7473 3a0a 2020 2020 2020 2020  _wants:.        
+000170b0: 2020 2020 636c 6965 6e74 5f6d 7367 735b      client_msgs[
+000170c0: 6373 2e63 6c69 656e 745f 6b65 795d 203d  cs.client_key] =
+000170d0: 205b 7265 706f 7274 5f6d 7367 5d0a 0a20   [report_msg].. 
+000170e0: 2020 2020 2020 2063 7320 3d20 7365 6c66         cs = self
+000170f0: 2e63 6c69 656e 7473 5b22 6669 7265 2d61  .clients["fire-a
+00017100: 6e64 2d66 6f72 6765 7422 5d0a 2020 2020  nd-forget"].    
+00017110: 2020 2020 6966 2074 7320 696e 2063 732e      if ts in cs.
+00017120: 7761 6e74 735f 7768 6174 3a0a 2020 2020  wants_what:.    
+00017130: 2020 2020 2020 2020 7365 6c66 2e5f 636c          self._cl
+00017140: 6965 6e74 5f72 656c 6561 7365 735f 6b65  ient_releases_ke
+00017150: 7973 280a 2020 2020 2020 2020 2020 2020  ys(.            
+00017160: 2020 2020 6373 3d63 732c 0a20 2020 2020      cs=cs,.     
+00017170: 2020 2020 2020 2020 2020 206b 6579 733d             keys=
+00017180: 5b6b 6579 5d2c 0a20 2020 2020 2020 2020  [key],.         
+00017190: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
+000171a0: 6174 696f 6e73 3d72 6563 6f6d 6d65 6e64  ations=recommend
+000171b0: 6174 696f 6e73 2c0a 2020 2020 2020 2020  ations,.        
+000171c0: 2020 2020 290a 0a20 2020 2020 2020 2069      )..        i
+000171d0: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
+000171e0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+000171f0: 6572 7420 6e6f 7420 7473 2e70 726f 6365  ert not ts.proce
+00017200: 7373 696e 675f 6f6e 0a0a 2020 2020 2020  ssing_on..      
+00017210: 2020 7265 7475 726e 2072 6563 6f6d 6d65    return recomme
+00017220: 6e64 6174 696f 6e73 2c20 636c 6965 6e74  ndations, client
+00017230: 5f6d 7367 732c 207b 7d0a 0a20 2020 2064  _msgs, {}..    d
+00017240: 6566 2074 7261 6e73 6974 696f 6e5f 6e6f  ef transition_no
+00017250: 5f77 6f72 6b65 725f 7265 6c65 6173 6564  _worker_released
+00017260: 2873 656c 662c 206b 6579 3a20 7374 722c  (self, key: str,
+00017270: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
+00017280: 7229 202d 3e20 5265 6373 4d73 6773 3a0a  r) -> RecsMsgs:.
+00017290: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
+000172a0: 662e 7461 736b 735b 6b65 795d 0a0a 2020  f.tasks[key]..  
+000172b0: 2020 2020 2020 6966 2073 656c 662e 7661        if self.va
+000172c0: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
+000172d0: 2020 2020 6173 7365 7274 2073 656c 662e      assert self.
+000172e0: 7461 736b 735b 6b65 795d 2e73 7461 7465  tasks[key].state
+000172f0: 203d 3d20 226e 6f2d 776f 726b 6572 220a   == "no-worker".
+00017300: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00017310: 7274 206e 6f74 2074 732e 7768 6f5f 6861  rt not ts.who_ha
+00017320: 730a 2020 2020 2020 2020 2020 2020 6173  s.            as
+00017330: 7365 7274 206e 6f74 2074 732e 7761 6974  sert not ts.wait
+00017340: 696e 675f 6f6e 0a0a 2020 2020 2020 2020  ing_on..        
+00017350: 7365 6c66 2e75 6e72 756e 6e61 626c 652e  self.unrunnable.
+00017360: 7265 6d6f 7665 2874 7329 0a20 2020 2020  remove(ts).     
+00017370: 2020 2074 732e 7374 6174 6520 3d20 2272     ts.state = "r
+00017380: 656c 6561 7365 6422 0a0a 2020 2020 2020  eleased"..      
+00017390: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
+000173a0: 6465 7065 6e64 656e 6369 6573 3a0a 2020  dependencies:.  
+000173b0: 2020 2020 2020 2020 2020 6474 732e 7761            dts.wa
+000173c0: 6974 6572 732e 6469 7363 6172 6428 7473  iters.discard(ts
+000173d0: 290a 0a20 2020 2020 2020 2074 732e 7761  )..        ts.wa
+000173e0: 6974 6572 732e 636c 6561 7228 290a 0a20  iters.clear().. 
+000173f0: 2020 2020 2020 2072 6574 7572 6e20 7b7d         return {}
+00017400: 2c20 7b7d 2c20 7b7d 0a0a 2020 2020 6465  , {}, {}..    de
+00017410: 6620 7472 616e 7369 7469 6f6e 5f77 6169  f transition_wai
+00017420: 7469 6e67 5f71 7565 7565 6428 7365 6c66  ting_queued(self
+00017430: 2c20 6b65 793a 2073 7472 2c20 7374 696d  , key: str, stim
+00017440: 756c 7573 5f69 643a 2073 7472 2920 2d3e  ulus_id: str) ->
+00017450: 2052 6563 734d 7367 733a 0a20 2020 2020   RecsMsgs:.     
+00017460: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
+00017470: 6b73 5b6b 6579 5d0a 0a20 2020 2020 2020  ks[key]..       
+00017480: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
+00017490: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
+000174a0: 7373 6572 7420 6e6f 7420 7365 6c66 2e69  ssert not self.i
+000174b0: 646c 655f 7461 736b 5f63 6f75 6e74 2c20  dle_task_count, 
+000174c0: 2874 732c 2073 656c 662e 6964 6c65 5f74  (ts, self.idle_t
+000174d0: 6173 6b5f 636f 756e 7429 0a20 2020 2020  ask_count).     
+000174e0: 2020 2020 2020 2073 656c 662e 5f76 616c         self._val
+000174f0: 6964 6174 655f 7265 6164 7928 7473 290a  idate_ready(ts).
+00017500: 0a20 2020 2020 2020 2074 732e 7374 6174  .        ts.stat
+00017510: 6520 3d20 2271 7565 7565 6422 0a20 2020  e = "queued".   
+00017520: 2020 2020 2073 656c 662e 7175 6575 6564       self.queued
+00017530: 2e61 6464 2874 7329 0a0a 2020 2020 2020  .add(ts)..      
+00017540: 2020 7265 7475 726e 207b 7d2c 207b 7d2c    return {}, {},
+00017550: 207b 7d0a 0a20 2020 2064 6566 2074 7261   {}..    def tra
+00017560: 6e73 6974 696f 6e5f 7761 6974 696e 675f  nsition_waiting_
+00017570: 6e6f 5f77 6f72 6b65 7228 7365 6c66 2c20  no_worker(self, 
+00017580: 6b65 793a 2073 7472 2c20 7374 696d 756c  key: str, stimul
+00017590: 7573 5f69 643a 2073 7472 2920 2d3e 2052  us_id: str) -> R
+000175a0: 6563 734d 7367 733a 0a20 2020 2020 2020  ecsMsgs:.       
+000175b0: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
+000175c0: 5b6b 6579 5d0a 0a20 2020 2020 2020 2069  [key]..        i
+000175d0: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
+000175e0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000175f0: 662e 5f76 616c 6964 6174 655f 7265 6164  f._validate_read
+00017600: 7928 7473 290a 0a20 2020 2020 2020 2074  y(ts)..        t
+00017610: 732e 7374 6174 6520 3d20 226e 6f2d 776f  s.state = "no-wo
+00017620: 726b 6572 220a 2020 2020 2020 2020 7365  rker".        se
+00017630: 6c66 2e75 6e72 756e 6e61 626c 652e 6164  lf.unrunnable.ad
+00017640: 6428 7473 290a 0a20 2020 2020 2020 2072  d(ts)..        r
+00017650: 6574 7572 6e20 7b7d 2c20 7b7d 2c20 7b7d  eturn {}, {}, {}
+00017660: 0a0a 2020 2020 6465 6620 7472 616e 7369  ..    def transi
+00017670: 7469 6f6e 5f71 7565 7565 645f 7265 6c65  tion_queued_rele
+00017680: 6173 6564 2873 656c 662c 206b 6579 3a20  ased(self, key: 
+00017690: 7374 722c 2073 7469 6d75 6c75 735f 6964  str, stimulus_id
+000176a0: 3a20 7374 7229 202d 3e20 5265 6373 4d73  : str) -> RecsMs
+000176b0: 6773 3a0a 2020 2020 2020 2020 7473 203d  gs:.        ts =
+000176c0: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
+000176d0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+000176e0: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
+000176f0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+00017700: 7320 696e 2073 656c 662e 7175 6575 6564  s in self.queued
+00017710: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00017720: 6572 7420 6e6f 7420 7473 2e70 726f 6365  ert not ts.proce
+00017730: 7373 696e 675f 6f6e 0a0a 2020 2020 2020  ssing_on..      
+00017740: 2020 7365 6c66 2e71 7565 7565 642e 7265    self.queued.re
+00017750: 6d6f 7665 2874 7329 0a0a 2020 2020 2020  move(ts)..      
+00017760: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+00017770: 733a 2052 6563 7320 3d20 7b7d 0a20 2020  s: Recs = {}.   
+00017780: 2020 2020 2073 656c 662e 5f70 726f 7061       self._propa
+00017790: 6761 7465 5f72 656c 6561 7365 6428 7473  gate_released(ts
+000177a0: 2c20 7265 636f 6d6d 656e 6461 7469 6f6e  , recommendation
+000177b0: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
+000177c0: 6e20 7265 636f 6d6d 656e 6461 7469 6f6e  n recommendation
+000177d0: 732c 207b 7d2c 207b 7d0a 0a20 2020 2064  s, {}, {}..    d
+000177e0: 6566 2074 7261 6e73 6974 696f 6e5f 7175  ef transition_qu
+000177f0: 6575 6564 5f70 726f 6365 7373 696e 6728  eued_processing(
+00017800: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
+00017810: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
+00017820: 2920 2d3e 2052 6563 734d 7367 733a 0a20  ) -> RecsMsgs:. 
+00017830: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+00017840: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
+00017850: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+00017860: 6f6e 733a 2052 6563 7320 3d20 7b7d 0a20  ons: Recs = {}. 
+00017870: 2020 2020 2020 2077 6f72 6b65 725f 6d73         worker_ms
+00017880: 6773 3a20 4d73 6773 203d 207b 7d0a 0a20  gs: Msgs = {}.. 
+00017890: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
+000178a0: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
+000178b0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+000178c0: 7473 2e61 6374 6f72 2c20 6622 4163 746f  ts.actor, f"Acto
+000178d0: 7273 2063 616e 2774 2062 6520 7175 6575  rs can't be queu
+000178e0: 6564 3a20 7b74 737d 220a 2020 2020 2020  ed: {ts}".      
+000178f0: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
+00017900: 696e 2073 656c 662e 7175 6575 6564 0a0a  in self.queued..
+00017910: 2020 2020 2020 2020 6966 2077 7320 3a3d          if ws :=
+00017920: 2073 656c 662e 6465 6369 6465 5f77 6f72   self.decide_wor
+00017930: 6b65 725f 726f 6f74 6973 685f 7175 6575  ker_rootish_queu
+00017940: 696e 675f 656e 6162 6c65 6428 293a 0a20  ing_enabled():. 
+00017950: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00017960: 7175 6575 6564 2e64 6973 6361 7264 2874  queued.discard(t
+00017970: 7329 0a20 2020 2020 2020 2020 2020 2077  s).            w
+00017980: 6f72 6b65 725f 6d73 6773 203d 2073 656c  orker_msgs = sel
+00017990: 662e 5f61 6464 5f74 6f5f 7072 6f63 6573  f._add_to_proces
+000179a0: 7369 6e67 2874 732c 2077 7329 0a20 2020  sing(ts, ws).   
+000179b0: 2020 2020 2023 2049 6620 6e6f 2077 6f72       # If no wor
+000179c0: 6b65 722c 2074 6173 6b20 6a75 7374 2073  ker, task just s
+000179d0: 7461 7973 2060 7175 6575 6564 600a 0a20  tays `queued`.. 
+000179e0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+000179f0: 636f 6d6d 656e 6461 7469 6f6e 732c 207b  commendations, {
+00017a00: 7d2c 2077 6f72 6b65 725f 6d73 6773 0a0a  }, worker_msgs..
+00017a10: 2020 2020 6465 6620 5f72 656d 6f76 655f      def _remove_
+00017a20: 6b65 7928 7365 6c66 2c20 6b65 793a 2073  key(self, key: s
+00017a30: 7472 2920 2d3e 204e 6f6e 653a 0a20 2020  tr) -> None:.   
+00017a40: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
+00017a50: 6173 6b73 2e70 6f70 286b 6579 290a 2020  asks.pop(key).  
+00017a60: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
+00017a70: 7374 6174 6520 3d3d 2022 666f 7267 6f74  state == "forgot
+00017a80: 7465 6e22 0a20 2020 2020 2020 2073 656c  ten".        sel
+00017a90: 662e 756e 7275 6e6e 6162 6c65 2e64 6973  f.unrunnable.dis
+00017aa0: 6361 7264 2874 7329 0a20 2020 2020 2020  card(ts).       
+00017ab0: 2066 6f72 2063 7320 696e 2074 732e 7768   for cs in ts.wh
+00017ac0: 6f5f 7761 6e74 733a 0a20 2020 2020 2020  o_wants:.       
+00017ad0: 2020 2020 2063 732e 7761 6e74 735f 7768       cs.wants_wh
+00017ae0: 6174 2e72 656d 6f76 6528 7473 290a 2020  at.remove(ts).  
+00017af0: 2020 2020 2020 7473 2e77 686f 5f77 616e        ts.who_wan
+00017b00: 7473 2e63 6c65 6172 2829 0a20 2020 2020  ts.clear().     
+00017b10: 2020 2074 732e 7072 6f63 6573 7369 6e67     ts.processing
+00017b20: 5f6f 6e20 3d20 4e6f 6e65 0a20 2020 2020  _on = None.     
+00017b30: 2020 2074 732e 6578 6365 7074 696f 6e5f     ts.exception_
+00017b40: 626c 616d 6520 3d20 7473 2e65 7863 6570  blame = ts.excep
+00017b50: 7469 6f6e 203d 2074 732e 7472 6163 6562  tion = ts.traceb
+00017b60: 6163 6b20 3d20 4e6f 6e65 0a20 2020 2020  ack = None.     
+00017b70: 2020 2073 656c 662e 7461 736b 5f6d 6574     self.task_met
+00017b80: 6164 6174 612e 706f 7028 6b65 792c 204e  adata.pop(key, N
+00017b90: 6f6e 6529 0a0a 2020 2020 6465 6620 7472  one)..    def tr
+00017ba0: 616e 7369 7469 6f6e 5f6d 656d 6f72 795f  ansition_memory_
+00017bb0: 666f 7267 6f74 7465 6e28 7365 6c66 2c20  forgotten(self, 
+00017bc0: 6b65 793a 2073 7472 2c20 7374 696d 756c  key: str, stimul
+00017bd0: 7573 5f69 643a 2073 7472 2920 2d3e 2052  us_id: str) -> R
+00017be0: 6563 734d 7367 733a 0a20 2020 2020 2020  ecsMsgs:.       
+00017bf0: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
+00017c00: 5b6b 6579 5d0a 0a20 2020 2020 2020 2069  [key]..        i
+00017c10: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
+00017c20: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00017c30: 6572 7420 7473 2e73 7461 7465 203d 3d20  ert ts.state == 
+00017c40: 226d 656d 6f72 7922 0a20 2020 2020 2020  "memory".       
+00017c50: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+00017c60: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
+00017c70: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00017c80: 6572 7420 6e6f 7420 7473 2e77 6169 7469  ert not ts.waiti
+00017c90: 6e67 5f6f 6e0a 2020 2020 2020 2020 2020  ng_on.          
+00017ca0: 2020 6966 206e 6f74 2074 732e 7275 6e5f    if not ts.run_
+00017cb0: 7370 6563 3a0a 2020 2020 2020 2020 2020  spec:.          
+00017cc0: 2020 2020 2020 2320 4974 2773 206f 6b20        # It's ok 
+00017cd0: 746f 2066 6f72 6765 7420 6120 7075 7265  to forget a pure
+00017ce0: 2064 6174 6120 7461 736b 0a20 2020 2020   data task.     
+00017cf0: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+00017d00: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00017d10: 2074 732e 6861 735f 6c6f 7374 5f64 6570   ts.has_lost_dep
+00017d20: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
+00017d30: 2020 2020 2020 2020 2020 2023 2049 7427             # It'
+00017d40: 7320 6f6b 2074 6f20 666f 7267 6574 2061  s ok to forget a
+00017d50: 2074 6173 6b20 7769 7468 2066 6f72 676f   task with forgo
+00017d60: 7474 656e 2064 6570 656e 6465 6e63 6965  tten dependencie
+00017d70: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00017d80: 2020 7061 7373 0a20 2020 2020 2020 2020    pass.         
+00017d90: 2020 2065 6c69 6620 6e6f 7420 7473 2e77     elif not ts.w
+00017da0: 686f 5f77 616e 7473 2061 6e64 206e 6f74  ho_wants and not
+00017db0: 2074 732e 7761 6974 6572 7320 616e 6420   ts.waiters and 
+00017dc0: 6e6f 7420 7473 2e64 6570 656e 6465 6e74  not ts.dependent
+00017dd0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00017de0: 2020 2023 2049 7427 7320 6f6b 2074 6f20     # It's ok to 
+00017df0: 666f 7267 6574 2061 2074 6173 6b20 7468  forget a task th
+00017e00: 6174 206e 6f62 6f64 7920 6e65 6564 730a  at nobody needs.
+00017e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017e20: 7061 7373 0a20 2020 2020 2020 2020 2020  pass.           
+00017e30: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00017e40: 2020 2020 2020 2072 6169 7365 2041 7373         raise Ass
+00017e50: 6572 7469 6f6e 4572 726f 7228 2255 6e72  ertionError("Unr
+00017e60: 6561 6368 6162 6c65 222c 2074 7329 2020  eachable", ts)  
+00017e70: 2320 7072 6167 6d61 3a20 6e6f 636f 7665  # pragma: nocove
+00017e80: 720a 0a20 2020 2020 2020 2069 6620 7473  r..        if ts
+00017e90: 2e61 6374 6f72 3a0a 2020 2020 2020 2020  .actor:.        
+00017ea0: 2020 2020 666f 7220 7773 2069 6e20 7473      for ws in ts
+00017eb0: 2e77 686f 5f68 6173 3a0a 2020 2020 2020  .who_has:.      
+00017ec0: 2020 2020 2020 2020 2020 7773 2e61 6374            ws.act
+00017ed0: 6f72 732e 6469 7363 6172 6428 7473 290a  ors.discard(ts).
+00017ee0: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
+00017ef0: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
+00017f00: 207b 7d0a 2020 2020 2020 2020 776f 726b   {}.        work
+00017f10: 6572 5f6d 7367 733a 204d 7367 7320 3d20  er_msgs: Msgs = 
+00017f20: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
+00017f30: 5f70 726f 7061 6761 7465 5f66 6f72 676f  _propagate_forgo
+00017f40: 7474 656e 2874 732c 2072 6563 6f6d 6d65  tten(ts, recomme
+00017f50: 6e64 6174 696f 6e73 2c20 776f 726b 6572  ndations, worker
+00017f60: 5f6d 7367 732c 2073 7469 6d75 6c75 735f  _msgs, stimulus_
+00017f70: 6964 290a 0a20 2020 2020 2020 2063 6c69  id)..        cli
+00017f80: 656e 745f 6d73 6773 203d 205f 7461 736b  ent_msgs = _task
+00017f90: 5f74 6f5f 636c 6965 6e74 5f6d 7367 7328  _to_client_msgs(
+00017fa0: 7473 290a 2020 2020 2020 2020 7365 6c66  ts).        self
+00017fb0: 2e5f 7265 6d6f 7665 5f6b 6579 286b 6579  ._remove_key(key
+00017fc0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00017fd0: 6e20 7265 636f 6d6d 656e 6461 7469 6f6e  n recommendation
+00017fe0: 732c 2063 6c69 656e 745f 6d73 6773 2c20  s, client_msgs, 
+00017ff0: 776f 726b 6572 5f6d 7367 730a 0a20 2020  worker_msgs..   
+00018000: 2064 6566 2074 7261 6e73 6974 696f 6e5f   def transition_
+00018010: 7265 6c65 6173 6564 5f66 6f72 676f 7474  released_forgott
+00018020: 656e 2873 656c 662c 206b 6579 3a20 7374  en(self, key: st
+00018030: 722c 2073 7469 6d75 6c75 735f 6964 3a20  r, stimulus_id: 
+00018040: 7374 7229 202d 3e20 5265 6373 4d73 6773  str) -> RecsMsgs
+00018050: 3a0a 2020 2020 2020 2020 7473 203d 2073  :.        ts = s
+00018060: 656c 662e 7461 736b 735b 6b65 795d 0a0a  elf.tasks[key]..
+00018070: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00018080: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
+00018090: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
+000180a0: 7374 6174 6520 696e 2028 2272 656c 6561  state in ("relea
+000180b0: 7365 6422 2c20 2265 7272 6564 2229 0a20  sed", "erred"). 
+000180c0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000180d0: 7420 6e6f 7420 7473 2e77 686f 5f68 6173  t not ts.who_has
+000180e0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+000180f0: 6572 7420 6e6f 7420 7473 2e70 726f 6365  ert not ts.proce
+00018100: 7373 696e 675f 6f6e 0a20 2020 2020 2020  ssing_on.       
+00018110: 2020 2020 2061 7373 6572 7420 7473 206e       assert ts n
+00018120: 6f74 2069 6e20 7365 6c66 2e71 7565 7565  ot in self.queue
+00018130: 640a 2020 2020 2020 2020 2020 2020 6173  d.            as
+00018140: 7365 7274 206e 6f74 2074 732e 7761 6974  sert not ts.wait
+00018150: 696e 675f 6f6e 2c20 2874 732c 2074 732e  ing_on, (ts, ts.
+00018160: 7761 6974 696e 675f 6f6e 290a 2020 2020  waiting_on).    
+00018170: 2020 2020 2020 2020 6966 206e 6f74 2074          if not t
+00018180: 732e 7275 6e5f 7370 6563 3a0a 2020 2020  s.run_spec:.    
+00018190: 2020 2020 2020 2020 2020 2020 2320 4974              # It
+000181a0: 2773 206f 6b20 746f 2066 6f72 6765 7420  's ok to forget 
+000181b0: 6120 7075 7265 2064 6174 6120 7461 736b  a pure data task
+000181c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000181d0: 2070 6173 730a 2020 2020 2020 2020 2020   pass.          
+000181e0: 2020 656c 6966 2074 732e 6861 735f 6c6f    elif ts.has_lo
+000181f0: 7374 5f64 6570 656e 6465 6e63 6965 733a  st_dependencies:
+00018200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018210: 2023 2049 7427 7320 6f6b 2074 6f20 666f   # It's ok to fo
+00018220: 7267 6574 2061 2074 6173 6b20 7769 7468  rget a task with
+00018230: 2066 6f72 676f 7474 656e 2064 6570 656e   forgotten depen
+00018240: 6465 6e63 6965 730a 2020 2020 2020 2020  dencies.        
+00018250: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
+00018260: 2020 2020 2020 2020 2065 6c69 6620 6e6f           elif no
+00018270: 7420 7473 2e77 686f 5f77 616e 7473 2061  t ts.who_wants a
+00018280: 6e64 206e 6f74 2074 732e 7761 6974 6572  nd not ts.waiter
+00018290: 7320 616e 6420 6e6f 7420 7473 2e64 6570  s and not ts.dep
+000182a0: 656e 6465 6e74 733a 0a20 2020 2020 2020  endents:.       
+000182b0: 2020 2020 2020 2020 2023 2049 7427 7320           # It's 
+000182c0: 6f6b 2074 6f20 666f 7267 6574 2061 2074  ok to forget a t
+000182d0: 6173 6b20 7468 6174 206e 6f62 6f64 7920  ask that nobody 
+000182e0: 6e65 6564 730a 2020 2020 2020 2020 2020  needs.          
+000182f0: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
+00018300: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00018310: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00018320: 7365 2041 7373 6572 7469 6f6e 4572 726f  se AssertionErro
+00018330: 7228 2255 6e72 6561 6368 6162 6c65 222c  r("Unreachable",
+00018340: 2073 7472 2874 7329 2920 2023 2070 7261   str(ts))  # pra
+00018350: 676d 613a 206e 6f63 6f76 6572 0a0a 2020  gma: nocover..  
+00018360: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
+00018370: 7469 6f6e 733a 2052 6563 7320 3d20 7b7d  tions: Recs = {}
+00018380: 0a20 2020 2020 2020 2077 6f72 6b65 725f  .        worker_
+00018390: 6d73 6773 3a20 4d73 6773 203d 207b 7d0a  msgs: Msgs = {}.
+000183a0: 2020 2020 2020 2020 7365 6c66 2e5f 7072          self._pr
+000183b0: 6f70 6167 6174 655f 666f 7267 6f74 7465  opagate_forgotte
+000183c0: 6e28 7473 2c20 7265 636f 6d6d 656e 6461  n(ts, recommenda
+000183d0: 7469 6f6e 732c 2077 6f72 6b65 725f 6d73  tions, worker_ms
+000183e0: 6773 2c20 7374 696d 756c 7573 5f69 6429  gs, stimulus_id)
+000183f0: 0a0a 2020 2020 2020 2020 636c 6965 6e74  ..        client
+00018400: 5f6d 7367 7320 3d20 5f74 6173 6b5f 746f  _msgs = _task_to
+00018410: 5f63 6c69 656e 745f 6d73 6773 2874 7329  _client_msgs(ts)
+00018420: 0a20 2020 2020 2020 2073 656c 662e 5f72  .        self._r
+00018430: 656d 6f76 655f 6b65 7928 6b65 7929 0a0a  emove_key(key)..
+00018440: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+00018450: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
+00018460: 636c 6965 6e74 5f6d 7367 732c 2077 6f72  client_msgs, wor
+00018470: 6b65 725f 6d73 6773 0a0a 2020 2020 2320  ker_msgs..    # 
+00018480: 7b0a 2020 2020 2320 2020 2020 2873 7461  {.    #     (sta
+00018490: 7274 2c20 6669 6e69 7368 293a 0a20 2020  rt, finish):.   
+000184a0: 2023 2020 2020 2074 7261 6e73 6974 696f   #     transitio
+000184b0: 6e5f 3c73 7461 7274 3e5f 3c66 696e 6973  n_<start>_<finis
+000184c0: 683e 280a 2020 2020 2320 2020 2020 2020  h>(.    #       
+000184d0: 2020 7365 6c66 2c20 6b65 793a 2073 7472    self, key: str
+000184e0: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
+000184f0: 7472 2c20 2a2a 6b77 6172 6773 0a20 2020  tr, **kwargs.   
+00018500: 2023 2020 2020 2029 202d 3e20 2872 6563   #     ) -> (rec
+00018510: 6f6d 6d65 6e64 6174 696f 6e73 2c20 636c  ommendations, cl
+00018520: 6965 6e74 5f6d 7367 732c 2077 6f72 6b65  ient_msgs, worke
+00018530: 725f 6d73 6773 290a 2020 2020 2320 7d0a  r_msgs).    # }.
+00018540: 2020 2020 5f54 5241 4e53 4954 494f 4e53      _TRANSITIONS
+00018550: 5f54 4142 4c45 3a20 436c 6173 7356 6172  _TABLE: ClassVar
+00018560: 5b0a 2020 2020 2020 2020 4d61 7070 696e  [.        Mappin
+00018570: 675b 0a20 2020 2020 2020 2020 2020 2074  g[.            t
+00018580: 7570 6c65 5b54 6173 6b53 7461 7465 5374  uple[TaskStateSt
+00018590: 6174 652c 2054 6173 6b53 7461 7465 5374  ate, TaskStateSt
+000185a0: 6174 655d 2c0a 2020 2020 2020 2020 2020  ate],.          
+000185b0: 2020 4361 6c6c 6162 6c65 5b2e 2e2e 2c20    Callable[..., 
+000185c0: 5265 6373 4d73 6773 5d2c 0a20 2020 2020  RecsMsgs],.     
+000185d0: 2020 205d 0a20 2020 205d 203d 207b 0a20     ].    ] = {. 
+000185e0: 2020 2020 2020 2028 2272 656c 6561 7365         ("release
+000185f0: 6422 2c20 2277 6169 7469 6e67 2229 3a20  d", "waiting"): 
+00018600: 7472 616e 7369 7469 6f6e 5f72 656c 6561  transition_relea
+00018610: 7365 645f 7761 6974 696e 672c 0a20 2020  sed_waiting,.   
+00018620: 2020 2020 2028 2277 6169 7469 6e67 222c       ("waiting",
+00018630: 2022 7265 6c65 6173 6564 2229 3a20 7472   "released"): tr
+00018640: 616e 7369 7469 6f6e 5f77 6169 7469 6e67  ansition_waiting
+00018650: 5f72 656c 6561 7365 642c 0a20 2020 2020  _released,.     
+00018660: 2020 2028 2277 6169 7469 6e67 222c 2022     ("waiting", "
+00018670: 7072 6f63 6573 7369 6e67 2229 3a20 7472  processing"): tr
+00018680: 616e 7369 7469 6f6e 5f77 6169 7469 6e67  ansition_waiting
+00018690: 5f70 726f 6365 7373 696e 672c 0a20 2020  _processing,.   
+000186a0: 2020 2020 2028 2277 6169 7469 6e67 222c       ("waiting",
+000186b0: 2022 6e6f 2d77 6f72 6b65 7222 293a 2074   "no-worker"): t
+000186c0: 7261 6e73 6974 696f 6e5f 7761 6974 696e  ransition_waitin
+000186d0: 675f 6e6f 5f77 6f72 6b65 722c 0a20 2020  g_no_worker,.   
+000186e0: 2020 2020 2028 2277 6169 7469 6e67 222c       ("waiting",
+000186f0: 2022 7175 6575 6564 2229 3a20 7472 616e   "queued"): tran
+00018700: 7369 7469 6f6e 5f77 6169 7469 6e67 5f71  sition_waiting_q
+00018710: 7565 7565 642c 0a20 2020 2020 2020 2028  ueued,.        (
+00018720: 2277 6169 7469 6e67 222c 2022 6d65 6d6f  "waiting", "memo
+00018730: 7279 2229 3a20 7472 616e 7369 7469 6f6e  ry"): transition
+00018740: 5f77 6169 7469 6e67 5f6d 656d 6f72 792c  _waiting_memory,
+00018750: 0a20 2020 2020 2020 2028 2271 7565 7565  .        ("queue
+00018760: 6422 2c20 2272 656c 6561 7365 6422 293a  d", "released"):
+00018770: 2074 7261 6e73 6974 696f 6e5f 7175 6575   transition_queu
+00018780: 6564 5f72 656c 6561 7365 642c 0a20 2020  ed_released,.   
+00018790: 2020 2020 2028 2271 7565 7565 6422 2c20       ("queued", 
+000187a0: 2270 726f 6365 7373 696e 6722 293a 2074  "processing"): t
+000187b0: 7261 6e73 6974 696f 6e5f 7175 6575 6564  ransition_queued
+000187c0: 5f70 726f 6365 7373 696e 672c 0a20 2020  _processing,.   
+000187d0: 2020 2020 2028 2270 726f 6365 7373 696e       ("processin
+000187e0: 6722 2c20 2272 656c 6561 7365 6422 293a  g", "released"):
+000187f0: 2074 7261 6e73 6974 696f 6e5f 7072 6f63   transition_proc
+00018800: 6573 7369 6e67 5f72 656c 6561 7365 642c  essing_released,
+00018810: 0a20 2020 2020 2020 2028 2270 726f 6365  .        ("proce
+00018820: 7373 696e 6722 2c20 226d 656d 6f72 7922  ssing", "memory"
+00018830: 293a 2074 7261 6e73 6974 696f 6e5f 7072  ): transition_pr
+00018840: 6f63 6573 7369 6e67 5f6d 656d 6f72 792c  ocessing_memory,
+00018850: 0a20 2020 2020 2020 2028 2270 726f 6365  .        ("proce
+00018860: 7373 696e 6722 2c20 2265 7272 6564 2229  ssing", "erred")
+00018870: 3a20 7472 616e 7369 7469 6f6e 5f70 726f  : transition_pro
+00018880: 6365 7373 696e 675f 6572 7265 642c 0a20  cessing_erred,. 
+00018890: 2020 2020 2020 2028 226e 6f2d 776f 726b         ("no-work
+000188a0: 6572 222c 2022 7265 6c65 6173 6564 2229  er", "released")
+000188b0: 3a20 7472 616e 7369 7469 6f6e 5f6e 6f5f  : transition_no_
+000188c0: 776f 726b 6572 5f72 656c 6561 7365 642c  worker_released,
+000188d0: 0a20 2020 2020 2020 2028 226e 6f2d 776f  .        ("no-wo
+000188e0: 726b 6572 222c 2022 7072 6f63 6573 7369  rker", "processi
+000188f0: 6e67 2229 3a20 7472 616e 7369 7469 6f6e  ng"): transition
+00018900: 5f6e 6f5f 776f 726b 6572 5f70 726f 6365  _no_worker_proce
+00018910: 7373 696e 672c 0a20 2020 2020 2020 2028  ssing,.        (
+00018920: 2272 656c 6561 7365 6422 2c20 2266 6f72  "released", "for
+00018930: 676f 7474 656e 2229 3a20 7472 616e 7369  gotten"): transi
+00018940: 7469 6f6e 5f72 656c 6561 7365 645f 666f  tion_released_fo
+00018950: 7267 6f74 7465 6e2c 0a20 2020 2020 2020  rgotten,.       
+00018960: 2028 226d 656d 6f72 7922 2c20 2266 6f72   ("memory", "for
+00018970: 676f 7474 656e 2229 3a20 7472 616e 7369  gotten"): transi
+00018980: 7469 6f6e 5f6d 656d 6f72 795f 666f 7267  tion_memory_forg
+00018990: 6f74 7465 6e2c 0a20 2020 2020 2020 2028  otten,.        (
+000189a0: 2265 7272 6564 222c 2022 7265 6c65 6173  "erred", "releas
+000189b0: 6564 2229 3a20 7472 616e 7369 7469 6f6e  ed"): transition
+000189c0: 5f65 7272 6564 5f72 656c 6561 7365 642c  _erred_released,
+000189d0: 0a20 2020 2020 2020 2028 226d 656d 6f72  .        ("memor
+000189e0: 7922 2c20 2272 656c 6561 7365 6422 293a  y", "released"):
+000189f0: 2074 7261 6e73 6974 696f 6e5f 6d65 6d6f   transition_memo
+00018a00: 7279 5f72 656c 6561 7365 642c 0a20 2020  ry_released,.   
+00018a10: 2020 2020 2028 2272 656c 6561 7365 6422       ("released"
+00018a20: 2c20 2265 7272 6564 2229 3a20 7472 616e  , "erred"): tran
+00018a30: 7369 7469 6f6e 5f72 656c 6561 7365 645f  sition_released_
+00018a40: 6572 7265 642c 0a20 2020 207d 0a0a 2020  erred,.    }..  
+00018a50: 2020 6465 6620 7374 6f72 7928 7365 6c66    def story(self
+00018a60: 2c20 2a6b 6579 735f 6f72 5f74 6173 6b73  , *keys_or_tasks
+00018a70: 5f6f 725f 7374 696d 756c 693a 2073 7472  _or_stimuli: str
+00018a80: 207c 2054 6173 6b53 7461 7465 2920 2d3e   | TaskState) ->
+00018a90: 206c 6973 745b 5472 616e 7369 7469 6f6e   list[Transition
+00018aa0: 5d3a 0a20 2020 2020 2020 2022 2222 4765  ]:.        """Ge
+00018ab0: 7420 616c 6c20 7472 616e 7369 7469 6f6e  t all transition
+00018ac0: 7320 7468 6174 2074 6f75 6368 206f 6e65  s that touch one
+00018ad0: 206f 6620 7468 6520 696e 7075 7420 6b65   of the input ke
+00018ae0: 7973 206f 7220 7374 696d 756c 7573 5f69  ys or stimulus_i
+00018af0: 6427 7322 2222 0a20 2020 2020 2020 206b  d's""".        k
+00018b00: 6579 735f 6f72 5f73 7469 6d75 6c69 203d  eys_or_stimuli =
+00018b10: 207b 0a20 2020 2020 2020 2020 2020 206b   {.            k
+00018b20: 6579 2e6b 6579 2069 6620 6973 696e 7374  ey.key if isinst
+00018b30: 616e 6365 286b 6579 2c20 5461 736b 5374  ance(key, TaskSt
+00018b40: 6174 6529 2065 6c73 6520 6b65 790a 2020  ate) else key.  
+00018b50: 2020 2020 2020 2020 2020 666f 7220 6b65            for ke
+00018b60: 7920 696e 206b 6579 735f 6f72 5f74 6173  y in keys_or_tas
+00018b70: 6b73 5f6f 725f 7374 696d 756c 690a 2020  ks_or_stimuli.  
+00018b80: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00018b90: 7265 7475 726e 2073 6368 6564 756c 6572  return scheduler
+00018ba0: 5f73 746f 7279 286b 6579 735f 6f72 5f73  _story(keys_or_s
+00018bb0: 7469 6d75 6c69 2c20 7365 6c66 2e74 7261  timuli, self.tra
+00018bc0: 6e73 6974 696f 6e5f 6c6f 6729 0a0a 2020  nsition_log)..  
+00018bd0: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
+00018be0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00018bf0: 0a20 2020 2023 2041 7373 6967 6e69 6e67  .    # Assigning
+00018c00: 2054 6173 6b73 2074 6f20 576f 726b 6572   Tasks to Worker
+00018c10: 7320 230a 2020 2020 2323 2323 2323 2323  s #.    ########
+00018c20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00018c30: 2323 2323 2323 0a0a 2020 2020 6465 6620  ######..    def 
+00018c40: 6973 5f72 6f6f 7469 7368 2873 656c 662c  is_rootish(self,
+00018c50: 2074 733a 2054 6173 6b53 7461 7465 2920   ts: TaskState) 
+00018c60: 2d3e 2062 6f6f 6c3a 0a20 2020 2020 2020  -> bool:.       
+00018c70: 2022 2222 0a20 2020 2020 2020 2057 6865   """.        Whe
+00018c80: 7468 6572 2060 6074 7360 6020 6973 2061  ther ``ts`` is a
+00018c90: 2072 6f6f 7420 6f72 2072 6f6f 742d 6c69   root or root-li
+00018ca0: 6b65 2074 6173 6b2e 0a0a 2020 2020 2020  ke task...      
+00018cb0: 2020 526f 6f74 2d69 7368 2074 6173 6b73    Root-ish tasks
+00018cc0: 2061 7265 2070 6172 7420 6f66 2061 2067   are part of a g
+00018cd0: 726f 7570 2074 6861 7427 7320 6d75 6368  roup that's much
+00018ce0: 206c 6172 6765 7220 7468 616e 2074 6865   larger than the
+00018cf0: 2063 6c75 7374 6572 2c0a 2020 2020 2020   cluster,.      
+00018d00: 2020 616e 6420 6861 7665 2066 6577 206f    and have few o
+00018d10: 7220 6e6f 2064 6570 656e 6465 6e63 6965  r no dependencie
+00018d20: 732e 0a20 2020 2020 2020 2022 2222 0a20  s..        """. 
+00018d30: 2020 2020 2020 2069 6620 7473 2e72 6573         if ts.res
+00018d40: 6f75 7263 655f 7265 7374 7269 6374 696f  ource_restrictio
+00018d50: 6e73 206f 7220 7473 2e77 6f72 6b65 725f  ns or ts.worker_
+00018d60: 7265 7374 7269 6374 696f 6e73 206f 7220  restrictions or 
+00018d70: 7473 2e68 6f73 745f 7265 7374 7269 6374  ts.host_restrict
+00018d80: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
+00018d90: 2020 7265 7475 726e 2046 616c 7365 0a20    return False. 
+00018da0: 2020 2020 2020 2074 6720 3d20 7473 2e67         tg = ts.g
+00018db0: 726f 7570 0a20 2020 2020 2020 2023 2054  roup.        # T
+00018dc0: 4f44 4f20 7368 6f72 742d 6369 7263 7569  ODO short-circui
+00018dd0: 7420 746f 2054 7275 6520 6966 2060 6e6f  t to True if `no
+00018de0: 7420 7473 2e64 6570 656e 6465 6e63 6965  t ts.dependencie
+00018df0: 7360 3f0a 2020 2020 2020 2020 7265 7475  s`?.        retu
+00018e00: 726e 2028 0a20 2020 2020 2020 2020 2020  rn (.           
+00018e10: 206c 656e 2874 6729 203e 2073 656c 662e   len(tg) > self.
+00018e20: 746f 7461 6c5f 6e74 6872 6561 6473 202a  total_nthreads *
+00018e30: 2032 0a20 2020 2020 2020 2020 2020 2061   2.            a
+00018e40: 6e64 206c 656e 2874 672e 6465 7065 6e64  nd len(tg.depend
+00018e50: 656e 6369 6573 2920 3c20 350a 2020 2020  encies) < 5.    
+00018e60: 2020 2020 2020 2020 616e 6420 7375 6d28          and sum(
+00018e70: 6d61 7028 6c65 6e2c 2074 672e 6465 7065  map(len, tg.depe
+00018e80: 6e64 656e 6369 6573 2929 203c 2035 0a20  ndencies)) < 5. 
+00018e90: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
+00018ea0: 6620 6368 6563 6b5f 6964 6c65 5f73 6174  f check_idle_sat
+00018eb0: 7572 6174 6564 2873 656c 662c 2077 733a  urated(self, ws:
+00018ec0: 2057 6f72 6b65 7253 7461 7465 2c20 6f63   WorkerState, oc
+00018ed0: 633a 2066 6c6f 6174 203d 202d 312e 3029  c: float = -1.0)
+00018ee0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00018ef0: 2020 2222 2255 7064 6174 6520 7468 6520    """Update the 
+00018f00: 7374 6174 7573 206f 6620 7468 6520 6964  status of the id
+00018f10: 6c65 2061 6e64 2073 6174 7572 6174 6564  le and saturated
+00018f20: 2073 7461 7465 0a0a 2020 2020 2020 2020   state..        
+00018f30: 5468 6520 7363 6865 6475 6c65 7220 6b65  The scheduler ke
+00018f40: 6570 7320 7472 6163 6b20 6f66 2077 6f72  eps track of wor
+00018f50: 6b65 7273 2074 6861 7420 6172 6520 2e2e  kers that are ..
+00018f60: 0a0a 2020 2020 2020 2020 2d20 2053 6174  ..        -  Sat
+00018f70: 7572 6174 6564 3a20 6861 7665 2065 6e6f  urated: have eno
+00018f80: 7567 6820 776f 726b 2074 6f20 7374 6179  ugh work to stay
+00018f90: 2062 7573 790a 2020 2020 2020 2020 2d20   busy.        - 
+00018fa0: 2049 646c 653a 2064 6f20 6e6f 7420 6861   Idle: do not ha
+00018fb0: 7665 2065 6e6f 7567 6820 776f 726b 2074  ve enough work t
+00018fc0: 6f20 7374 6179 2062 7573 790a 0a20 2020  o stay busy..   
+00018fd0: 2020 2020 2054 6865 7920 6172 6520 636f       They are co
+00018fe0: 6e73 6964 6572 6564 2073 6174 7572 6174  nsidered saturat
+00018ff0: 6564 2069 6620 7468 6579 2062 6f74 6820  ed if they both 
+00019000: 6861 7665 2065 6e6f 7567 6820 7461 736b  have enough task
+00019010: 7320 746f 206f 6363 7570 790a 2020 2020  s to occupy.    
+00019020: 2020 2020 616c 6c20 6f66 2074 6865 6972      all of their
+00019030: 2074 6872 6561 6473 2c20 616e 6420 6966   threads, and if
+00019040: 2074 6865 2065 7870 6563 7465 6420 7275   the expected ru
+00019050: 6e74 696d 6520 6f66 2074 686f 7365 2074  ntime of those t
+00019060: 6173 6b73 2069 730a 2020 2020 2020 2020  asks is.        
+00019070: 6c61 7267 6520 656e 6f75 6768 2e0a 0a20  large enough... 
+00019080: 2020 2020 2020 2049 6620 6060 6469 7374         If ``dist
+00019090: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
+000190a0: 722e 776f 726b 6572 2d73 6174 7572 6174  r.worker-saturat
+000190b0: 696f 6e60 6020 6973 206e 6f74 2060 6069  ion`` is not ``i
+000190c0: 6e66 6060 0a20 2020 2020 2020 2028 7363  nf``.        (sc
+000190d0: 6865 6475 6c65 722d 7369 6465 2071 7565  heduler-side que
+000190e0: 7569 6e67 2069 7320 656e 6162 6c65 6429  uing is enabled)
+000190f0: 2c20 7468 6579 2061 7265 2063 6f6e 7369  , they are consi
+00019100: 6465 7265 6420 6964 6c65 0a20 2020 2020  dered idle.     
+00019110: 2020 2069 6620 7468 6579 2068 6176 6520     if they have 
+00019120: 6665 7765 7220 7461 736b 7320 7072 6f63  fewer tasks proc
+00019130: 6573 7369 6e67 2074 6861 6e20 7468 6520  essing than the 
+00019140: 6060 776f 726b 6572 2d73 6174 7572 6174  ``worker-saturat
+00019150: 696f 6e60 600a 2020 2020 2020 2020 7468  ion``.        th
+00019160: 7265 7368 6f6c 6420 6469 6374 6174 6573  reshold dictates
+00019170: 2e0a 0a20 2020 2020 2020 204f 7468 6572  ...        Other
+00019180: 7769 7365 2c20 7468 6579 2061 7265 2063  wise, they are c
+00019190: 6f6e 7369 6465 7265 6420 6964 6c65 2069  onsidered idle i
+000191a0: 6620 7468 6579 2068 6176 6520 6665 7765  f they have fewe
+000191b0: 7220 7461 736b 7320 7072 6f63 6573 7369  r tasks processi
+000191c0: 6e67 0a20 2020 2020 2020 2074 6861 6e20  ng.        than 
+000191d0: 7468 7265 6164 732c 206f 7220 6966 2074  threads, or if t
+000191e0: 6865 6972 2074 6173 6b73 2720 746f 7461  heir tasks' tota
+000191f0: 6c20 6578 7065 6374 6564 2072 756e 7469  l expected runti
+00019200: 6d65 2069 7320 6c65 7373 2074 6861 6e20  me is less than 
+00019210: 6861 6c66 0a20 2020 2020 2020 2074 6865  half.        the
+00019220: 2065 7870 6563 7465 6420 7275 6e74 696d   expected runtim
+00019230: 6520 6f66 2074 6865 2073 616d 6520 6e75  e of the same nu
+00019240: 6d62 6572 206f 6620 6176 6572 6167 6520  mber of average 
+00019250: 7461 736b 732e 0a0a 2020 2020 2020 2020  tasks...        
+00019260: 5468 6973 2069 7320 7573 6566 756c 2066  This is useful f
+00019270: 6f72 206c 6f61 6420 6261 6c61 6e63 696e  or load balancin
+00019280: 6720 616e 6420 6164 6170 7469 7669 7479  g and adaptivity
+00019290: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+000192a0: 2020 2020 2020 6966 2073 656c 662e 746f        if self.to
+000192b0: 7461 6c5f 6e74 6872 6561 6473 203d 3d20  tal_nthreads == 
+000192c0: 3020 6f72 2077 732e 7374 6174 7573 203d  0 or ws.status =
+000192d0: 3d20 5374 6174 7573 2e63 6c6f 7365 643a  = Status.closed:
+000192e0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000192f0: 7572 6e0a 2020 2020 2020 2020 6966 206f  urn.        if o
+00019300: 6363 203c 2030 3a0a 2020 2020 2020 2020  cc < 0:.        
+00019310: 2020 2020 6f63 6320 3d20 7773 2e6f 6363      occ = ws.occ
+00019320: 7570 616e 6379 0a0a 2020 2020 2020 2020  upancy..        
+00019330: 7020 3d20 6c65 6e28 7773 2e70 726f 6365  p = len(ws.proce
+00019340: 7373 696e 6729 0a0a 2020 2020 2020 2020  ssing)..        
+00019350: 7365 6c66 2e73 6174 7572 6174 6564 2e64  self.saturated.d
+00019360: 6973 6361 7264 2877 7329 0a20 2020 2020  iscard(ws).     
+00019370: 2020 2069 6620 7773 2e73 7461 7475 7320     if ws.status 
+00019380: 213d 2053 7461 7475 732e 7275 6e6e 696e  != Status.runnin
+00019390: 673a 0a20 2020 2020 2020 2020 2020 2073  g:.            s
+000193a0: 656c 662e 6964 6c65 2e70 6f70 2877 732e  elf.idle.pop(ws.
+000193b0: 6164 6472 6573 732c 204e 6f6e 6529 0a20  address, None). 
+000193c0: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
+000193d0: 2e69 735f 756e 6f63 6375 7069 6564 2877  .is_unoccupied(w
+000193e0: 732c 206f 6363 2c20 7029 3a0a 2020 2020  s, occ, p):.    
+000193f0: 2020 2020 2020 2020 7365 6c66 2e69 646c          self.idl
+00019400: 655b 7773 2e61 6464 7265 7373 5d20 3d20  e[ws.address] = 
+00019410: 7773 0a20 2020 2020 2020 2065 6c73 653a  ws.        else:
+00019420: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00019430: 662e 6964 6c65 2e70 6f70 2877 732e 6164  f.idle.pop(ws.ad
+00019440: 6472 6573 732c 204e 6f6e 6529 0a20 2020  dress, None).   
+00019450: 2020 2020 2020 2020 206e 6320 3d20 7773           nc = ws
+00019460: 2e6e 7468 7265 6164 730a 2020 2020 2020  .nthreads.      
+00019470: 2020 2020 2020 6966 2070 203e 206e 633a        if p > nc:
+00019480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019490: 2070 656e 6469 6e67 203d 206f 6363 202a   pending = occ *
+000194a0: 2028 7020 2d20 6e63 2920 2f20 2870 202a   (p - nc) / (p *
+000194b0: 206e 6329 0a20 2020 2020 2020 2020 2020   nc).           
+000194c0: 2020 2020 2069 6620 302e 3420 3c20 7065       if 0.4 < pe
+000194d0: 6e64 696e 6720 3e20 312e 3920 2a20 2873  nding > 1.9 * (s
+000194e0: 656c 662e 746f 7461 6c5f 6f63 6375 7061  elf.total_occupa
+000194f0: 6e63 7920 2f20 7365 6c66 2e74 6f74 616c  ncy / self.total
+00019500: 5f6e 7468 7265 6164 7329 3a0a 2020 2020  _nthreads):.    
+00019510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019520: 7365 6c66 2e73 6174 7572 6174 6564 2e61  self.saturated.a
+00019530: 6464 2877 7329 0a0a 2020 2020 2020 2020  dd(ws)..        
+00019540: 6966 206e 6f74 205f 776f 726b 6572 5f66  if not _worker_f
+00019550: 756c 6c28 7773 2c20 7365 6c66 2e57 4f52  ull(ws, self.WOR
+00019560: 4b45 525f 5341 5455 5241 5449 4f4e 2920  KER_SATURATION) 
+00019570: 616e 6420 7773 2e73 7461 7475 7320 3d3d  and ws.status ==
+00019580: 2053 7461 7475 732e 7275 6e6e 696e 673a   Status.running:
+00019590: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000195a0: 662e 6964 6c65 5f74 6173 6b5f 636f 756e  f.idle_task_coun
+000195b0: 742e 6164 6428 7773 290a 2020 2020 2020  t.add(ws).      
+000195c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000195d0: 2020 2020 7365 6c66 2e69 646c 655f 7461      self.idle_ta
+000195e0: 736b 5f63 6f75 6e74 2e64 6973 6361 7264  sk_count.discard
+000195f0: 2877 7329 0a0a 2020 2020 6465 6620 6973  (ws)..    def is
+00019600: 5f75 6e6f 6363 7570 6965 6428 0a20 2020  _unoccupied(.   
+00019610: 2020 2020 2073 656c 662c 2077 733a 2057       self, ws: W
+00019620: 6f72 6b65 7253 7461 7465 2c20 6f63 6375  orkerState, occu
+00019630: 7061 6e63 793a 2066 6c6f 6174 2c20 6e70  pancy: float, np
+00019640: 726f 6365 7373 696e 673a 2069 6e74 0a20  rocessing: int. 
+00019650: 2020 2029 202d 3e20 626f 6f6c 3a0a 2020     ) -> bool:.  
+00019660: 2020 2020 2020 6e74 6872 6561 6473 203d        nthreads =
+00019670: 2077 732e 6e74 6872 6561 6473 0a20 2020   ws.nthreads.   
+00019680: 2020 2020 2072 6574 7572 6e20 280a 2020       return (.  
+00019690: 2020 2020 2020 2020 2020 6e70 726f 6365            nproce
+000196a0: 7373 696e 6720 3c20 6e74 6872 6561 6473  ssing < nthreads
+000196b0: 0a20 2020 2020 2020 2020 2020 206f 7220  .            or 
+000196c0: 6f63 6375 7061 6e63 7920 3c20 6e74 6872  occupancy < nthr
+000196d0: 6561 6473 202a 2028 7365 6c66 2e74 6f74  eads * (self.tot
+000196e0: 616c 5f6f 6363 7570 616e 6379 202f 2073  al_occupancy / s
+000196f0: 656c 662e 746f 7461 6c5f 6e74 6872 6561  elf.total_nthrea
+00019700: 6473 2920 2f20 320a 2020 2020 2020 2020  ds) / 2.        
+00019710: 290a 0a20 2020 2064 6566 2067 6574 5f63  )..    def get_c
+00019720: 6f6d 6d5f 636f 7374 2873 656c 662c 2074  omm_cost(self, t
+00019730: 733a 2054 6173 6b53 7461 7465 2c20 7773  s: TaskState, ws
+00019740: 3a20 576f 726b 6572 5374 6174 6529 202d  : WorkerState) -
+00019750: 3e20 666c 6f61 743a 0a20 2020 2020 2020  > float:.       
+00019760: 2022 2222 0a20 2020 2020 2020 2047 6574   """.        Get
+00019770: 2074 6865 2065 7374 696d 6174 6564 2063   the estimated c
+00019780: 6f6d 6d75 6e69 6361 7469 6f6e 2063 6f73  ommunication cos
+00019790: 7420 2869 6e20 732e 2920 746f 2063 6f6d  t (in s.) to com
+000197a0: 7075 7465 2074 6865 2074 6173 6b0a 2020  pute the task.  
+000197b0: 2020 2020 2020 6f6e 2074 6865 2067 6976        on the giv
+000197c0: 656e 2077 6f72 6b65 722e 0a20 2020 2020  en worker..     
+000197d0: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
+000197e0: 6620 3130 202a 206c 656e 2874 732e 6465  f 10 * len(ts.de
+000197f0: 7065 6e64 656e 6369 6573 2920 3c20 6c65  pendencies) < le
+00019800: 6e28 7773 2e68 6173 5f77 6861 7429 3a0a  n(ws.has_what):.
+00019810: 2020 2020 2020 2020 2020 2020 2320 496e              # In
+00019820: 2074 6865 2063 6f6d 6d6f 6e20 6361 7365   the common case
+00019830: 2077 6865 7265 2074 6865 206e 756d 6265   where the numbe
+00019840: 7220 6f66 2064 6570 656e 6465 6e63 6965  r of dependencie
+00019850: 7320 6973 0a20 2020 2020 2020 2020 2020  s is.           
+00019860: 2023 206d 7563 6820 6c65 7373 2074 6861   # much less tha
+00019870: 6e20 7468 6520 6e75 6d62 6572 206f 6620  n the number of 
+00019880: 7461 736b 7320 7468 6174 2077 6520 6861  tasks that we ha
+00019890: 7665 2c0a 2020 2020 2020 2020 2020 2020  ve,.            
+000198a0: 2320 636f 6e73 7472 7563 7420 7468 6520  # construct the 
+000198b0: 7365 7420 6f66 2064 6570 7320 7468 6174  set of deps that
+000198c0: 2072 6571 7569 7265 2063 6f6d 6d75 6e69   require communi
+000198d0: 6361 7469 6f6e 2069 6e0a 2020 2020 2020  cation in.      
+000198e0: 2020 2020 2020 2320 4f28 6c65 6e28 6465        # O(len(de
+000198f0: 7065 6e64 656e 6369 6573 2929 2072 6174  pendencies)) rat
+00019900: 6865 7220 7468 616e 204f 286c 656e 2868  her than O(len(h
+00019910: 6173 5f77 6861 7429 2920 7469 6d65 2e0a  as_what)) time..
+00019920: 2020 2020 2020 2020 2020 2020 2320 4661              # Fa
+00019930: 6374 6f72 206f 6620 3130 2069 7320 6120  ctor of 10 is a 
+00019940: 6775 6573 7320 6174 2074 6865 206f 7665  guess at the ove
+00019950: 7268 6561 6420 6f66 2065 7870 6c69 6369  rhead of explici
+00019960: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
+00019970: 6974 6572 6174 696f 6e20 6173 206f 7070  iteration as opp
+00019980: 6f73 6564 2074 6f20 6a75 7374 2063 616c  osed to just cal
+00019990: 6c69 6e67 2073 6574 2e64 6966 6665 7265  ling set.differe
+000199a0: 6e63 650a 2020 2020 2020 2020 2020 2020  nce.            
+000199b0: 6465 7073 203d 207b 6465 7020 666f 7220  deps = {dep for 
+000199c0: 6465 7020 696e 2074 732e 6465 7065 6e64  dep in ts.depend
+000199d0: 656e 6369 6573 2069 6620 6465 7020 6e6f  encies if dep no
+000199e0: 7420 696e 2077 732e 6861 735f 7768 6174  t in ws.has_what
+000199f0: 7d0a 2020 2020 2020 2020 656c 7365 3a0a  }.        else:.
+00019a00: 2020 2020 2020 2020 2020 2020 6465 7073              deps
+00019a10: 203d 2074 732e 6465 7065 6e64 656e 6369   = ts.dependenci
+00019a20: 6573 2e64 6966 6665 7265 6e63 6528 7773  es.difference(ws
+00019a30: 2e68 6173 5f77 6861 7429 0a20 2020 2020  .has_what).     
+00019a40: 2020 206e 6279 7465 7320 3d20 7375 6d28     nbytes = sum(
+00019a50: 6474 732e 6e62 7974 6573 2066 6f72 2064  dts.nbytes for d
+00019a60: 7473 2069 6e20 6465 7073 290a 2020 2020  ts in deps).    
+00019a70: 2020 2020 7265 7475 726e 206e 6279 7465      return nbyte
+00019a80: 7320 2f20 7365 6c66 2e62 616e 6477 6964  s / self.bandwid
+00019a90: 7468 0a0a 2020 2020 6465 6620 6765 745f  th..    def get_
+00019aa0: 7461 736b 5f64 7572 6174 696f 6e28 7365  task_duration(se
+00019ab0: 6c66 2c20 7473 3a20 5461 736b 5374 6174  lf, ts: TaskStat
+00019ac0: 6529 202d 3e20 666c 6f61 743a 0a20 2020  e) -> float:.   
+00019ad0: 2020 2020 2022 2222 4765 7420 7468 6520       """Get the 
+00019ae0: 6573 7469 6d61 7465 6420 636f 6d70 7574  estimated comput
+00019af0: 6174 696f 6e20 636f 7374 206f 6620 7468  ation cost of th
+00019b00: 6520 6769 7665 6e20 7461 736b 2028 6e6f  e given task (no
+00019b10: 7420 696e 636c 7564 696e 670a 2020 2020  t including.    
+00019b20: 2020 2020 616e 7920 636f 6d6d 756e 6963      any communic
+00019b30: 6174 696f 6e20 636f 7374 292e 0a0a 2020  ation cost)...  
+00019b40: 2020 2020 2020 4966 206e 6f20 6461 7461        If no data
+00019b50: 2068 6173 2062 6565 6e20 6f62 7365 7276   has been observ
+00019b60: 6564 2c20 7661 6c75 6520 6f66 0a20 2020  ed, value of.   
+00019b70: 2020 2020 2060 6469 7374 7269 6275 7465       `distribute
+00019b80: 642e 7363 6865 6475 6c65 722e 6465 6661  d.scheduler.defa
+00019b90: 756c 742d 7461 736b 2d64 7572 6174 696f  ult-task-duratio
+00019ba0: 6e73 6020 6172 6520 7573 6564 2e20 4966  ns` are used. If
+00019bb0: 206e 6f6e 6520 6973 2073 6574 0a20 2020   none is set.   
+00019bc0: 2020 2020 2066 6f72 2074 6869 7320 7461       for this ta
+00019bd0: 736b 2c20 6064 6973 7472 6962 7574 6564  sk, `distributed
+00019be0: 2e73 6368 6564 756c 6572 2e75 6e6b 6e6f  .scheduler.unkno
+00019bf0: 776e 2d74 6173 6b2d 6475 7261 7469 6f6e  wn-task-duration
+00019c00: 6020 6973 2075 7365 640a 2020 2020 2020  ` is used.      
+00019c10: 2020 696e 7374 6561 642e 0a20 2020 2020    instead..     
+00019c20: 2020 2022 2222 0a20 2020 2020 2020 2064     """.        d
+00019c30: 7572 6174 696f 6e3a 2066 6c6f 6174 203d  uration: float =
+00019c40: 2074 732e 7072 6566 6978 2e64 7572 6174   ts.prefix.durat
+00019c50: 696f 6e5f 6176 6572 6167 650a 2020 2020  ion_average.    
+00019c60: 2020 2020 6966 2064 7572 6174 696f 6e20      if duration 
+00019c70: 3e3d 2030 3a0a 2020 2020 2020 2020 2020  >= 0:.          
+00019c80: 2020 7265 7475 726e 2064 7572 6174 696f    return duratio
+00019c90: 6e0a 0a20 2020 2020 2020 2073 203d 2073  n..        s = s
+00019ca0: 656c 662e 756e 6b6e 6f77 6e5f 6475 7261  elf.unknown_dura
+00019cb0: 7469 6f6e 732e 6765 7428 7473 2e70 7265  tions.get(ts.pre
+00019cc0: 6669 782e 6e61 6d65 290a 2020 2020 2020  fix.name).      
+00019cd0: 2020 6966 2073 2069 7320 4e6f 6e65 3a0a    if s is None:.
+00019ce0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00019cf0: 2e75 6e6b 6e6f 776e 5f64 7572 6174 696f  .unknown_duratio
+00019d00: 6e73 5b74 732e 7072 6566 6978 2e6e 616d  ns[ts.prefix.nam
+00019d10: 655d 203d 2073 203d 2073 6574 2829 0a20  e] = s = set(). 
+00019d20: 2020 2020 2020 2073 2e61 6464 2874 7329         s.add(ts)
+00019d30: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00019d40: 7365 6c66 2e55 4e4b 4e4f 574e 5f54 4153  self.UNKNOWN_TAS
+00019d50: 4b5f 4455 5241 5449 4f4e 0a0a 2020 2020  K_DURATION..    
+00019d60: 6465 6620 7661 6c69 645f 776f 726b 6572  def valid_worker
+00019d70: 7328 7365 6c66 2c20 7473 3a20 5461 736b  s(self, ts: Task
+00019d80: 5374 6174 6529 202d 3e20 7365 745b 576f  State) -> set[Wo
+00019d90: 726b 6572 5374 6174 655d 207c 204e 6f6e  rkerState] | Non
+00019da0: 653a 0a20 2020 2020 2020 2022 2222 5265  e:.        """Re
+00019db0: 7475 726e 2073 6574 206f 6620 6375 7272  turn set of curr
+00019dc0: 656e 746c 7920 7661 6c69 6420 776f 726b  ently valid work
+00019dd0: 6572 7320 666f 7220 6b65 790a 0a20 2020  ers for key..   
+00019de0: 2020 2020 2049 6620 616c 6c20 776f 726b       If all work
+00019df0: 6572 7320 6172 6520 7661 6c69 6420 7468  ers are valid th
+00019e00: 656e 2074 6869 7320 7265 7475 726e 7320  en this returns 
+00019e10: 6060 4e6f 6e65 6060 2c20 696e 2077 6869  ``None``, in whi
+00019e20: 6368 2063 6173 650a 2020 2020 2020 2020  ch case.        
+00019e30: 616e 7920 2a72 756e 6e69 6e67 2a20 776f  any *running* wo
+00019e40: 726b 6572 2063 616e 2062 6520 7573 6564  rker can be used
+00019e50: 2e0a 2020 2020 2020 2020 4f74 6865 7277  ..        Otherw
+00019e60: 6973 652c 2074 6865 2073 7562 7365 7420  ise, the subset 
+00019e70: 6f66 2072 756e 6e69 6e67 2077 6f72 6b65  of running worke
+00019e80: 7273 2076 616c 6964 2066 6f72 2074 6869  rs valid for thi
+00019e90: 7320 7461 736b 0a20 2020 2020 2020 2069  s task.        i
+00019ea0: 7320 7265 7475 726e 6564 2e0a 2020 2020  s returned..    
+00019eb0: 2020 2020 5468 6973 2063 6865 636b 7320      This checks 
+00019ec0: 7472 6163 6b73 2074 6865 2066 6f6c 6c6f  tracks the follo
+00019ed0: 7769 6e67 2073 7461 7465 3a0a 0a20 2020  wing state:..   
+00019ee0: 2020 2020 202a 2020 776f 726b 6572 5f72       *  worker_r
+00019ef0: 6573 7472 6963 7469 6f6e 730a 2020 2020  estrictions.    
+00019f00: 2020 2020 2a20 2068 6f73 745f 7265 7374      *  host_rest
+00019f10: 7269 6374 696f 6e73 0a20 2020 2020 2020  rictions.       
+00019f20: 202a 2020 7265 736f 7572 6365 5f72 6573   *  resource_res
+00019f30: 7472 6963 7469 6f6e 730a 2020 2020 2020  trictions.      
+00019f40: 2020 2222 220a 2020 2020 2020 2020 733a    """.        s:
+00019f50: 2073 6574 5b73 7472 5d20 7c20 4e6f 6e65   set[str] | None
+00019f60: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
+00019f70: 2069 6620 7473 2e77 6f72 6b65 725f 7265   if ts.worker_re
+00019f80: 7374 7269 6374 696f 6e73 3a0a 2020 2020  strictions:.    
+00019f90: 2020 2020 2020 2020 7320 3d20 7b61 6464          s = {add
+00019fa0: 7220 666f 7220 6164 6472 2069 6e20 7473  r for addr in ts
+00019fb0: 2e77 6f72 6b65 725f 7265 7374 7269 6374  .worker_restrict
+00019fc0: 696f 6e73 2069 6620 6164 6472 2069 6e20  ions if addr in 
+00019fd0: 7365 6c66 2e77 6f72 6b65 7273 7d0a 0a20  self.workers}.. 
+00019fe0: 2020 2020 2020 2069 6620 7473 2e68 6f73         if ts.hos
+00019ff0: 745f 7265 7374 7269 6374 696f 6e73 3a0a  t_restrictions:.
+0001a000: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
+0001a010: 736f 6c76 6520 7468 6520 616c 6961 7320  solve the alias 
+0001a020: 6865 7265 2072 6174 6865 7220 7468 616e  here rather than
+0001a030: 2065 6172 6c79 2c20 666f 7220 7468 6520   early, for the 
+0001a040: 776f 726b 6572 0a20 2020 2020 2020 2020  worker.         
+0001a050: 2020 2023 206d 6179 206e 6f74 2062 6520     # may not be 
+0001a060: 636f 6e6e 6563 7465 6420 7768 656e 2068  connected when h
+0001a070: 6f73 745f 7265 7374 7269 6374 696f 6e73  ost_restrictions
+0001a080: 2069 7320 706f 7075 6c61 7465 640a 2020   is populated.  
+0001a090: 2020 2020 2020 2020 2020 6872 203d 205b            hr = [
+0001a0a0: 7365 6c66 2e63 6f65 7263 655f 686f 7374  self.coerce_host
+0001a0b0: 6e61 6d65 2868 2920 666f 7220 6820 696e  name(h) for h in
+0001a0c0: 2074 732e 686f 7374 5f72 6573 7472 6963   ts.host_restric
+0001a0d0: 7469 6f6e 735d 0a20 2020 2020 2020 2020  tions].         
+0001a0e0: 2020 2023 2058 5858 206e 6565 6420 486f     # XXX need Ho
+0001a0f0: 7374 5374 6174 653f 0a20 2020 2020 2020  stState?.       
+0001a100: 2020 2020 2073 6c20 3d20 5b5d 0a20 2020       sl = [].   
+0001a110: 2020 2020 2020 2020 2066 6f72 2068 2069           for h i
+0001a120: 6e20 6872 3a0a 2020 2020 2020 2020 2020  n hr:.          
+0001a130: 2020 2020 2020 6468 203d 2073 656c 662e        dh = self.
+0001a140: 686f 7374 5f69 6e66 6f2e 6765 7428 6829  host_info.get(h)
+0001a150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a160: 2069 6620 6468 2069 7320 6e6f 7420 4e6f   if dh is not No
+0001a170: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0001a180: 2020 2020 2020 2020 736c 2e61 7070 656e          sl.appen
+0001a190: 6428 6468 5b22 6164 6472 6573 7365 7322  d(dh["addresses"
+0001a1a0: 5d29 0a0a 2020 2020 2020 2020 2020 2020  ])..            
+0001a1b0: 7373 203d 2073 6574 2e75 6e69 6f6e 282a  ss = set.union(*
+0001a1c0: 736c 2920 6966 2073 6c20 656c 7365 2073  sl) if sl else s
+0001a1d0: 6574 2829 0a20 2020 2020 2020 2020 2020  et().           
+0001a1e0: 2069 6620 7320 6973 204e 6f6e 653a 0a20   if s is None:. 
+0001a1f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001a200: 203d 2073 730a 2020 2020 2020 2020 2020   = ss.          
+0001a210: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001a220: 2020 2020 2020 2020 7320 7c3d 2073 730a          s |= ss.
+0001a230: 0a20 2020 2020 2020 2069 6620 7473 2e72  .        if ts.r
+0001a240: 6573 6f75 7263 655f 7265 7374 7269 6374  esource_restrict
+0001a250: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
+0001a260: 2020 6477 203d 207b 7d0a 2020 2020 2020    dw = {}.      
+0001a270: 2020 2020 2020 666f 7220 7265 736f 7572        for resour
+0001a280: 6365 2c20 7265 7175 6972 6564 2069 6e20  ce, required in 
+0001a290: 7473 2e72 6573 6f75 7263 655f 7265 7374  ts.resource_rest
+0001a2a0: 7269 6374 696f 6e73 2e69 7465 6d73 2829  rictions.items()
+0001a2b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001a2c0: 2020 6472 203d 2073 656c 662e 7265 736f    dr = self.reso
+0001a2d0: 7572 6365 732e 6765 7428 7265 736f 7572  urces.get(resour
+0001a2e0: 6365 290a 2020 2020 2020 2020 2020 2020  ce).            
+0001a2f0: 2020 2020 6966 2064 7220 6973 204e 6f6e      if dr is Non
+0001a300: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001a310: 2020 2020 2020 2073 656c 662e 7265 736f         self.reso
+0001a320: 7572 6365 735b 7265 736f 7572 6365 5d20  urces[resource] 
+0001a330: 3d20 6472 203d 207b 7d0a 0a20 2020 2020  = dr = {}..     
+0001a340: 2020 2020 2020 2020 2020 2073 7720 3d20             sw = 
+0001a350: 7365 7428 290a 2020 2020 2020 2020 2020  set().          
+0001a360: 2020 2020 2020 666f 7220 6164 6472 2c20        for addr, 
+0001a370: 7375 7070 6c69 6564 2069 6e20 6472 2e69  supplied in dr.i
+0001a380: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
+0001a390: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+0001a3a0: 7570 706c 6965 6420 3e3d 2072 6571 7569  upplied >= requi
+0001a3b0: 7265 643a 0a20 2020 2020 2020 2020 2020  red:.           
+0001a3c0: 2020 2020 2020 2020 2020 2020 2073 772e               sw.
+0001a3d0: 6164 6428 6164 6472 290a 0a20 2020 2020  add(addr)..     
+0001a3e0: 2020 2020 2020 2020 2020 2064 775b 7265             dw[re
+0001a3f0: 736f 7572 6365 5d20 3d20 7377 0a0a 2020  source] = sw..  
+0001a400: 2020 2020 2020 2020 2020 7777 203d 2073            ww = s
+0001a410: 6574 2e69 6e74 6572 7365 6374 696f 6e28  et.intersection(
+0001a420: 2a64 772e 7661 6c75 6573 2829 290a 2020  *dw.values()).  
+0001a430: 2020 2020 2020 2020 2020 6966 2073 2069            if s i
+0001a440: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0001a450: 2020 2020 2020 2020 7320 3d20 7777 0a20          s = ww. 
+0001a460: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0001a470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a480: 2073 2026 3d20 7777 0a0a 2020 2020 2020   s &= ww..      
+0001a490: 2020 6966 2073 2069 7320 4e6f 6e65 3a0a    if s is None:.
+0001a4a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001a4b0: 726e 204e 6f6e 6520 2023 2041 6c6c 2077  rn None  # All w
+0001a4c0: 6f72 6b65 7273 2061 7265 2076 616c 6964  orkers are valid
+0001a4d0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0001a4e0: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
+0001a4f0: 6574 7572 6e20 7365 7428 2920 2023 204e  eturn set()  # N
+0001a500: 6f20 776f 726b 6572 7320 6172 6520 7661  o workers are va
+0001a510: 6c69 640a 0a20 2020 2020 2020 2023 2053  lid..        # S
+0001a520: 6f6d 6520 776f 726b 6572 7320 6172 6520  ome workers are 
+0001a530: 7661 6c69 640a 2020 2020 2020 2020 735f  valid.        s_
+0001a540: 7773 203d 207b 7365 6c66 2e77 6f72 6b65  ws = {self.worke
+0001a550: 7273 5b61 6464 725d 2066 6f72 2061 6464  rs[addr] for add
+0001a560: 7220 696e 2073 7d0a 2020 2020 2020 2020  r in s}.        
+0001a570: 6966 206c 656e 2873 656c 662e 7275 6e6e  if len(self.runn
+0001a580: 696e 6729 203c 206c 656e 2873 656c 662e  ing) < len(self.
+0001a590: 776f 726b 6572 7329 3a0a 2020 2020 2020  workers):.      
+0001a5a0: 2020 2020 2020 735f 7773 2026 3d20 7365        s_ws &= se
+0001a5b0: 6c66 2e72 756e 6e69 6e67 0a20 2020 2020  lf.running.     
+0001a5c0: 2020 2072 6574 7572 6e20 735f 7773 0a0a     return s_ws..
+0001a5d0: 2020 2020 6465 6620 6163 7175 6972 655f      def acquire_
+0001a5e0: 7265 736f 7572 6365 7328 7365 6c66 2c20  resources(self, 
+0001a5f0: 7473 3a20 5461 736b 5374 6174 652c 2077  ts: TaskState, w
+0001a600: 733a 2057 6f72 6b65 7253 7461 7465 2920  s: WorkerState) 
+0001a610: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+0001a620: 2066 6f72 2072 2c20 7265 7175 6972 6564   for r, required
+0001a630: 2069 6e20 7473 2e72 6573 6f75 7263 655f   in ts.resource_
+0001a640: 7265 7374 7269 6374 696f 6e73 2e69 7465  restrictions.ite
+0001a650: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+0001a660: 2020 7773 2e75 7365 645f 7265 736f 7572    ws.used_resour
+0001a670: 6365 735b 725d 202b 3d20 7265 7175 6972  ces[r] += requir
+0001a680: 6564 0a0a 2020 2020 6465 6620 7265 6c65  ed..    def rele
+0001a690: 6173 655f 7265 736f 7572 6365 7328 7365  ase_resources(se
+0001a6a0: 6c66 2c20 7473 3a20 5461 736b 5374 6174  lf, ts: TaskStat
+0001a6b0: 652c 2077 733a 2057 6f72 6b65 7253 7461  e, ws: WorkerSta
+0001a6c0: 7465 2920 2d3e 204e 6f6e 653a 0a20 2020  te) -> None:.   
+0001a6d0: 2020 2020 2066 6f72 2072 2c20 7265 7175       for r, requ
+0001a6e0: 6972 6564 2069 6e20 7473 2e72 6573 6f75  ired in ts.resou
+0001a6f0: 7263 655f 7265 7374 7269 6374 696f 6e73  rce_restrictions
+0001a700: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+0001a710: 2020 2020 2020 7773 2e75 7365 645f 7265        ws.used_re
+0001a720: 736f 7572 6365 735b 725d 202d 3d20 7265  sources[r] -= re
+0001a730: 7175 6972 6564 0a0a 2020 2020 6465 6620  quired..    def 
+0001a740: 636f 6572 6365 5f68 6f73 746e 616d 6528  coerce_hostname(
+0001a750: 7365 6c66 2c20 686f 7374 3a20 4861 7368  self, host: Hash
+0001a760: 6162 6c65 2920 2d3e 2073 7472 3a0a 2020  able) -> str:.  
+0001a770: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0001a780: 2020 436f 6572 6365 2074 6865 2068 6f73    Coerce the hos
+0001a790: 746e 616d 6520 6f66 2061 2077 6f72 6b65  tname of a worke
+0001a7a0: 722e 0a20 2020 2020 2020 2022 2222 0a20  r..        """. 
+0001a7b0: 2020 2020 2020 2061 6c69 6173 203d 2073         alias = s
+0001a7c0: 656c 662e 616c 6961 7365 732e 6765 7428  elf.aliases.get(
+0001a7d0: 686f 7374 290a 2020 2020 2020 2020 6966  host).        if
+0001a7e0: 2061 6c69 6173 2069 7320 6e6f 7420 4e6f   alias is not No
+0001a7f0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0001a800: 7773 203d 2073 656c 662e 776f 726b 6572  ws = self.worker
+0001a810: 735b 616c 6961 735d 0a20 2020 2020 2020  s[alias].       
+0001a820: 2020 2020 2072 6574 7572 6e20 7773 2e68       return ws.h
+0001a830: 6f73 740a 2020 2020 2020 2020 656c 7365  ost.        else
+0001a840: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
+0001a850: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+0001a860: 686f 7374 2c20 7374 7229 0a20 2020 2020  host, str).     
+0001a870: 2020 2020 2020 2072 6574 7572 6e20 686f         return ho
+0001a880: 7374 0a0a 2020 2020 6465 6620 776f 726b  st..    def work
+0001a890: 6572 5f6f 626a 6563 7469 7665 2873 656c  er_objective(sel
+0001a8a0: 662c 2074 733a 2054 6173 6b53 7461 7465  f, ts: TaskState
+0001a8b0: 2c20 7773 3a20 576f 726b 6572 5374 6174  , ws: WorkerStat
+0001a8c0: 6529 202d 3e20 7475 706c 653a 0a20 2020  e) -> tuple:.   
+0001a8d0: 2020 2020 2022 2222 4f62 6a65 6374 6976       """Objectiv
+0001a8e0: 6520 6675 6e63 7469 6f6e 2074 6f20 6465  e function to de
+0001a8f0: 7465 726d 696e 6520 7768 6963 6820 776f  termine which wo
+0001a900: 726b 6572 2073 686f 756c 6420 6765 7420  rker should get 
+0001a910: 7468 6520 7461 736b 0a0a 2020 2020 2020  the task..      
+0001a920: 2020 4d69 6e69 6d69 7a65 2065 7870 6563    Minimize expec
+0001a930: 7465 6420 7374 6172 7420 7469 6d65 2e20  ted start time. 
+0001a940: 2049 6620 6120 7469 6520 7468 656e 2062   If a tie then b
+0001a950: 7265 616b 2077 6974 6820 6461 7461 2073  reak with data s
+0001a960: 746f 7261 6765 2e0a 2020 2020 2020 2020  torage..        
+0001a970: 2222 220a 2020 2020 2020 2020 636f 6d6d  """.        comm
+0001a980: 5f62 7974 6573 203d 2073 756d 280a 2020  _bytes = sum(.  
+0001a990: 2020 2020 2020 2020 2020 6474 732e 6765            dts.ge
+0001a9a0: 745f 6e62 7974 6573 2829 2066 6f72 2064  t_nbytes() for d
+0001a9b0: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
+0001a9c0: 6e63 6965 7320 6966 2077 7320 6e6f 7420  ncies if ws not 
+0001a9d0: 696e 2064 7473 2e77 686f 5f68 6173 0a20  in dts.who_has. 
+0001a9e0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0001a9f0: 2020 7374 6163 6b5f 7469 6d65 203d 2077    stack_time = w
+0001aa00: 732e 6f63 6375 7061 6e63 7920 2f20 7773  s.occupancy / ws
+0001aa10: 2e6e 7468 7265 6164 730a 2020 2020 2020  .nthreads.      
+0001aa20: 2020 7374 6172 745f 7469 6d65 203d 2073    start_time = s
+0001aa30: 7461 636b 5f74 696d 6520 2b20 636f 6d6d  tack_time + comm
+0001aa40: 5f62 7974 6573 202f 2073 656c 662e 6261  _bytes / self.ba
+0001aa50: 6e64 7769 6474 680a 0a20 2020 2020 2020  ndwidth..       
+0001aa60: 2069 6620 7473 2e61 6374 6f72 3a0a 2020   if ts.actor:.  
+0001aa70: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001aa80: 2028 6c65 6e28 7773 2e61 6374 6f72 7329   (len(ws.actors)
+0001aa90: 2c20 7374 6172 745f 7469 6d65 2c20 7773  , start_time, ws
+0001aaa0: 2e6e 6279 7465 7329 0a20 2020 2020 2020  .nbytes).       
+0001aab0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001aac0: 2020 2072 6574 7572 6e20 2873 7461 7274     return (start
+0001aad0: 5f74 696d 652c 2077 732e 6e62 7974 6573  _time, ws.nbytes
+0001aae0: 290a 0a20 2020 2064 6566 2061 6464 5f72  )..    def add_r
+0001aaf0: 6570 6c69 6361 2873 656c 662c 2074 733a  eplica(self, ts:
+0001ab00: 2054 6173 6b53 7461 7465 2c20 7773 3a20   TaskState, ws: 
+0001ab10: 576f 726b 6572 5374 6174 6529 202d 3e20  WorkerState) -> 
+0001ab20: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
+0001ab30: 224e 6f74 6520 7468 6174 2061 2077 6f72  "Note that a wor
+0001ab40: 6b65 7220 686f 6c64 7320 6120 7265 706c  ker holds a repl
+0001ab50: 6963 6120 6f66 2061 2074 6173 6b20 7769  ica of a task wi
+0001ab60: 7468 2073 7461 7465 3d27 6d65 6d6f 7279  th state='memory
+0001ab70: 2722 2222 0a20 2020 2020 2020 2077 732e  '""".        ws.
+0001ab80: 6164 645f 7265 706c 6963 6128 7473 290a  add_replica(ts).
+0001ab90: 2020 2020 2020 2020 6966 206c 656e 2874          if len(t
+0001aba0: 732e 7768 6f5f 6861 7329 203d 3d20 323a  s.who_has) == 2:
+0001abb0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0001abc0: 662e 7265 706c 6963 6174 6564 5f74 6173  f.replicated_tas
+0001abd0: 6b73 2e61 6464 2874 7329 0a0a 2020 2020  ks.add(ts)..    
+0001abe0: 6465 6620 7265 6d6f 7665 5f72 6570 6c69  def remove_repli
+0001abf0: 6361 2873 656c 662c 2074 733a 2054 6173  ca(self, ts: Tas
+0001ac00: 6b53 7461 7465 2c20 7773 3a20 576f 726b  kState, ws: Work
+0001ac10: 6572 5374 6174 6529 202d 3e20 4e6f 6e65  erState) -> None
+0001ac20: 3a0a 2020 2020 2020 2020 2222 224e 6f74  :.        """Not
+0001ac30: 6520 7468 6174 2061 2077 6f72 6b65 7220  e that a worker 
+0001ac40: 6e6f 206c 6f6e 6765 7220 686f 6c64 7320  no longer holds 
+0001ac50: 6120 7265 706c 6963 6120 6f66 2061 2074  a replica of a t
+0001ac60: 6173 6b22 2222 0a20 2020 2020 2020 2077  ask""".        w
+0001ac70: 732e 7265 6d6f 7665 5f72 6570 6c69 6361  s.remove_replica
+0001ac80: 2874 7329 0a20 2020 2020 2020 2069 6620  (ts).        if 
+0001ac90: 6c65 6e28 7473 2e77 686f 5f68 6173 2920  len(ts.who_has) 
+0001aca0: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
+0001acb0: 2020 7365 6c66 2e72 6570 6c69 6361 7465    self.replicate
+0001acc0: 645f 7461 736b 732e 7265 6d6f 7665 2874  d_tasks.remove(t
+0001acd0: 7329 0a0a 2020 2020 6465 6620 7265 6d6f  s)..    def remo
+0001ace0: 7665 5f61 6c6c 5f72 6570 6c69 6361 7328  ve_all_replicas(
+0001acf0: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
+0001ad00: 6174 6529 202d 3e20 4e6f 6e65 3a0a 2020  ate) -> None:.  
+0001ad10: 2020 2020 2020 2222 2252 656d 6f76 6520        """Remove 
+0001ad20: 616c 6c20 7265 706c 6963 6173 206f 6620  all replicas of 
+0001ad30: 6120 7461 736b 2066 726f 6d20 616c 6c20  a task from all 
+0001ad40: 776f 726b 6572 7322 2222 0a20 2020 2020  workers""".     
+0001ad50: 2020 206e 6279 7465 7320 3d20 7473 2e67     nbytes = ts.g
+0001ad60: 6574 5f6e 6279 7465 7328 290a 2020 2020  et_nbytes().    
+0001ad70: 2020 2020 666f 7220 7773 2069 6e20 7473      for ws in ts
+0001ad80: 2e77 686f 5f68 6173 3a0a 2020 2020 2020  .who_has:.      
+0001ad90: 2020 2020 2020 7773 2e6e 6279 7465 7320        ws.nbytes 
+0001ada0: 2d3d 206e 6279 7465 730a 2020 2020 2020  -= nbytes.      
+0001adb0: 2020 2020 2020 6465 6c20 7773 2e5f 6861        del ws._ha
+0001adc0: 735f 7768 6174 5b74 735d 0a20 2020 2020  s_what[ts].     
+0001add0: 2020 2069 6620 6c65 6e28 7473 2e77 686f     if len(ts.who
+0001ade0: 5f68 6173 2920 3e20 313a 0a20 2020 2020  _has) > 1:.     
+0001adf0: 2020 2020 2020 2073 656c 662e 7265 706c         self.repl
+0001ae00: 6963 6174 6564 5f74 6173 6b73 2e72 656d  icated_tasks.rem
+0001ae10: 6f76 6528 7473 290a 2020 2020 2020 2020  ove(ts).        
+0001ae20: 7473 2e77 686f 5f68 6173 2e63 6c65 6172  ts.who_has.clear
+0001ae30: 2829 0a0a 2020 2020 6465 6620 6275 6c6b  ()..    def bulk
+0001ae40: 5f73 6368 6564 756c 655f 756e 7275 6e6e  _schedule_unrunn
+0001ae50: 6162 6c65 5f61 6674 6572 5f61 6464 696e  able_after_addin
+0001ae60: 675f 776f 726b 6572 2873 656c 662c 2077  g_worker(self, w
+0001ae70: 733a 2057 6f72 6b65 7253 7461 7465 2920  s: WorkerState) 
+0001ae80: 2d3e 2052 6563 733a 0a20 2020 2020 2020  -> Recs:.       
+0001ae90: 2022 2222 5365 6e64 2060 606e 6f2d 776f   """Send ``no-wo
+0001aea0: 726b 6572 6060 2074 6173 6b73 2074 6f20  rker`` tasks to 
+0001aeb0: 6060 7072 6f63 6573 7369 6e67 6060 2074  ``processing`` t
+0001aec0: 6861 7420 7468 6973 2077 6f72 6b65 7220  hat this worker 
+0001aed0: 6361 6e20 6861 6e64 6c65 2e0a 0a20 2020  can handle...   
+0001aee0: 2020 2020 2052 6574 7572 6e73 2070 7269       Returns pri
+0001aef0: 6f72 6974 792d 6f72 6465 7265 6420 7265  ority-ordered re
+0001af00: 636f 6d6d 656e 6461 7469 6f6e 732e 0a20  commendations.. 
+0001af10: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0001af20: 2020 2072 756e 6e61 626c 653a 206c 6973     runnable: lis
+0001af30: 745b 5461 736b 5374 6174 655d 203d 205b  t[TaskState] = [
+0001af40: 5d0a 2020 2020 2020 2020 666f 7220 7473  ].        for ts
+0001af50: 2069 6e20 7365 6c66 2e75 6e72 756e 6e61   in self.unrunna
+0001af60: 626c 653a 0a20 2020 2020 2020 2020 2020  ble:.           
+0001af70: 2076 616c 6964 203d 2073 656c 662e 7661   valid = self.va
+0001af80: 6c69 645f 776f 726b 6572 7328 7473 290a  lid_workers(ts).
+0001af90: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+0001afa0: 616c 6964 2069 7320 4e6f 6e65 206f 7220  alid is None or 
+0001afb0: 7773 2069 6e20 7661 6c69 643a 0a20 2020  ws in valid:.   
+0001afc0: 2020 2020 2020 2020 2020 2020 2072 756e               run
+0001afd0: 6e61 626c 652e 6170 7065 6e64 2874 7329  nable.append(ts)
+0001afe0: 0a0a 2020 2020 2020 2020 2320 5265 636f  ..        # Reco
+0001aff0: 6d6d 656e 6461 7469 6f6e 7320 6172 6520  mmendations are 
+0001b000: 7072 6f63 6573 7365 6420 4c49 464f 2c20  processed LIFO, 
+0001b010: 6865 6e63 6520 7468 6520 7265 7665 7273  hence the revers
+0001b020: 6564 206f 7264 6572 0a20 2020 2020 2020  ed order.       
+0001b030: 2072 756e 6e61 626c 652e 736f 7274 286b   runnable.sort(k
+0001b040: 6579 3d6f 7065 7261 746f 722e 6174 7472  ey=operator.attr
+0001b050: 6765 7474 6572 2822 7072 696f 7269 7479  getter("priority
+0001b060: 2229 2c20 7265 7665 7273 653d 5472 7565  "), reverse=True
+0001b070: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+0001b080: 207b 7473 2e6b 6579 3a20 2270 726f 6365   {ts.key: "proce
+0001b090: 7373 696e 6722 2066 6f72 2074 7320 696e  ssing" for ts in
+0001b0a0: 2072 756e 6e61 626c 657d 0a0a 2020 2020   runnable}..    
+0001b0b0: 6465 6620 5f76 616c 6964 6174 655f 7265  def _validate_re
+0001b0c0: 6164 7928 7365 6c66 2c20 7473 3a20 5461  ady(self, ts: Ta
+0001b0d0: 736b 5374 6174 6529 202d 3e20 4e6f 6e65  skState) -> None
+0001b0e0: 3a0a 2020 2020 2020 2020 2222 2256 616c  :.        """Val
+0001b0f0: 6964 6174 696f 6e20 666f 7220 7265 6164  idation for read
+0001b100: 7920 7374 6174 6573 2028 7072 6f63 6573  y states (proces
+0001b110: 7369 6e67 2c20 7175 6575 6564 2c20 6e6f  sing, queued, no
+0001b120: 2d77 6f72 6b65 7229 2222 220a 2020 2020  -worker)""".    
+0001b130: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+0001b140: 732e 7761 6974 696e 675f 6f6e 0a20 2020  s.waiting_on.   
+0001b150: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+0001b160: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
+0001b170: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
+0001b180: 2e65 7863 6570 7469 6f6e 5f62 6c61 6d65  .exception_blame
+0001b190: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0001b1a0: 6e6f 7420 7473 2e70 726f 6365 7373 696e  not ts.processin
+0001b1b0: 675f 6f6e 0a20 2020 2020 2020 2061 7373  g_on.        ass
+0001b1c0: 6572 7420 6e6f 7420 7473 2e68 6173 5f6c  ert not ts.has_l
+0001b1d0: 6f73 745f 6465 7065 6e64 656e 6369 6573  ost_dependencies
+0001b1e0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0001b1f0: 7473 206e 6f74 2069 6e20 7365 6c66 2e75  ts not in self.u
+0001b200: 6e72 756e 6e61 626c 650a 2020 2020 2020  nrunnable.      
+0001b210: 2020 6173 7365 7274 2074 7320 6e6f 7420    assert ts not 
+0001b220: 696e 2073 656c 662e 7175 6575 6564 0a20  in self.queued. 
+0001b230: 2020 2020 2020 2061 7373 6572 7420 616c         assert al
+0001b240: 6c28 6474 732e 7768 6f5f 6861 7320 666f  l(dts.who_has fo
+0001b250: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
+0001b260: 6e64 656e 6369 6573 290a 0a20 2020 2064  ndencies)..    d
+0001b270: 6566 205f 6164 645f 746f 5f70 726f 6365  ef _add_to_proce
+0001b280: 7373 696e 6728 7365 6c66 2c20 7473 3a20  ssing(self, ts: 
+0001b290: 5461 736b 5374 6174 652c 2077 733a 2057  TaskState, ws: W
+0001b2a0: 6f72 6b65 7253 7461 7465 2920 2d3e 204d  orkerState) -> M
+0001b2b0: 7367 733a 0a20 2020 2020 2020 2022 2222  sgs:.        """
+0001b2c0: 5365 7420 6120 7461 736b 2061 7320 7072  Set a task as pr
+0001b2d0: 6f63 6573 7369 6e67 206f 6e20 6120 776f  ocessing on a wo
+0001b2e0: 726b 6572 2061 6e64 2072 6574 7572 6e20  rker and return 
+0001b2f0: 7468 6520 776f 726b 6572 206d 6573 7361  the worker messa
+0001b300: 6765 7320 746f 2073 656e 6422 2222 0a20  ges to send""". 
+0001b310: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
+0001b320: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
+0001b330: 2020 2020 2073 656c 662e 5f76 616c 6964       self._valid
+0001b340: 6174 655f 7265 6164 7928 7473 290a 2020  ate_ready(ts).  
+0001b350: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0001b360: 2077 7320 696e 2073 656c 662e 7275 6e6e   ws in self.runn
+0001b370: 696e 672c 2073 656c 662e 7275 6e6e 696e  ing, self.runnin
+0001b380: 670a 2020 2020 2020 2020 2020 2020 6173  g.            as
+0001b390: 7365 7274 2028 6f20 3a3d 2073 656c 662e  sert (o := self.
+0001b3a0: 776f 726b 6572 732e 6765 7428 7773 2e61  workers.get(ws.a
+0001b3b0: 6464 7265 7373 2929 2069 7320 7773 2c20  ddress)) is ws, 
+0001b3c0: 2877 732c 206f 290a 0a20 2020 2020 2020  (ws, o)..       
+0001b3d0: 2077 732e 6164 645f 746f 5f70 726f 6365   ws.add_to_proce
+0001b3e0: 7373 696e 6728 7473 290a 2020 2020 2020  ssing(ts).      
+0001b3f0: 2020 7473 2e70 726f 6365 7373 696e 675f    ts.processing_
+0001b400: 6f6e 203d 2077 730a 2020 2020 2020 2020  on = ws.        
+0001b410: 7473 2e73 7461 7465 203d 2022 7072 6f63  ts.state = "proc
+0001b420: 6573 7369 6e67 220a 2020 2020 2020 2020  essing".        
+0001b430: 7365 6c66 2e61 6371 7569 7265 5f72 6573  self.acquire_res
+0001b440: 6f75 7263 6573 2874 732c 2077 7329 0a20  ources(ts, ws). 
+0001b450: 2020 2020 2020 2073 656c 662e 6368 6563         self.chec
+0001b460: 6b5f 6964 6c65 5f73 6174 7572 6174 6564  k_idle_saturated
+0001b470: 2877 7329 0a20 2020 2020 2020 2073 656c  (ws).        sel
+0001b480: 662e 6e5f 7461 736b 7320 2b3d 2031 0a0a  f.n_tasks += 1..
+0001b490: 2020 2020 2020 2020 6966 2074 732e 6163          if ts.ac
+0001b4a0: 746f 723a 0a20 2020 2020 2020 2020 2020  tor:.           
+0001b4b0: 2077 732e 6163 746f 7273 2e61 6464 2874   ws.actors.add(t
+0001b4c0: 7329 0a0a 2020 2020 2020 2020 7265 7475  s)..        retu
+0001b4d0: 726e 207b 7773 2e61 6464 7265 7373 3a20  rn {ws.address: 
+0001b4e0: 5b73 656c 662e 5f74 6173 6b5f 746f 5f6d  [self._task_to_m
+0001b4f0: 7367 2874 7329 5d7d 0a0a 2020 2020 6465  sg(ts)]}..    de
+0001b500: 6620 5f65 7869 745f 7072 6f63 6573 7369  f _exit_processi
+0001b510: 6e67 5f63 6f6d 6d6f 6e28 7365 6c66 2c20  ng_common(self, 
+0001b520: 7473 3a20 5461 736b 5374 6174 6529 202d  ts: TaskState) -
+0001b530: 3e20 576f 726b 6572 5374 6174 6520 7c20  > WorkerState | 
+0001b540: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
+0001b550: 2252 656d 6f76 6520 2a74 732a 2066 726f  "Remove *ts* fro
+0001b560: 6d20 7468 6520 7365 7420 6f66 2070 726f  m the set of pro
+0001b570: 6365 7373 696e 6720 7461 736b 732e 0a0a  cessing tasks...
+0001b580: 2020 2020 2020 2020 5265 7475 726e 730a          Returns.
+0001b590: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d0a          -------.
+0001b5a0: 2020 2020 2020 2020 576f 726b 6572 2073          Worker s
+0001b5b0: 7461 7465 206f 6620 7468 6520 776f 726b  tate of the work
+0001b5c0: 6572 2074 6861 7420 7072 6f63 6573 7365  er that processe
+0001b5d0: 6420 2a74 732a 2069 6620 7468 6520 776f  d *ts* if the wo
+0001b5e0: 726b 6572 2069 7320 6375 7272 656e 742c  rker is current,
+0001b5f0: 0a20 2020 2020 2020 204e 6f6e 6520 6966  .        None if
+0001b600: 2074 6865 2077 6f72 6b65 7220 6973 2073   the worker is s
+0001b610: 7461 6c65 2e0a 0a20 2020 2020 2020 2053  tale...        S
+0001b620: 6565 2061 6c73 6f0a 2020 2020 2020 2020  ee also.        
+0001b630: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
+0001b640: 2053 6368 6564 756c 6572 2e5f 7365 745f   Scheduler._set_
+0001b650: 6475 7261 7469 6f6e 5f65 7374 696d 6174  duration_estimat
+0001b660: 650a 2020 2020 2020 2020 2222 220a 2020  e.        """.  
+0001b670: 2020 2020 2020 7773 203d 2074 732e 7072        ws = ts.pr
+0001b680: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
+0001b690: 2020 2020 6173 7365 7274 2077 730a 2020      assert ws.  
+0001b6a0: 2020 2020 2020 7473 2e70 726f 6365 7373        ts.process
+0001b6b0: 696e 675f 6f6e 203d 204e 6f6e 650a 0a20  ing_on = None.. 
+0001b6c0: 2020 2020 2020 2077 732e 7265 6d6f 7665         ws.remove
+0001b6d0: 5f66 726f 6d5f 7072 6f63 6573 7369 6e67  _from_processing
+0001b6e0: 2874 7329 0a20 2020 2020 2020 2069 6620  (ts).        if 
+0001b6f0: 7365 6c66 2e77 6f72 6b65 7273 2e67 6574  self.workers.get
+0001b700: 2877 732e 6164 6472 6573 7329 2069 7320  (ws.address) is 
+0001b710: 6e6f 7420 7773 3a20 2023 206d 6179 2068  not ws:  # may h
+0001b720: 6176 6520 6265 656e 2072 656d 6f76 6564  ave been removed
+0001b730: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0001b740: 7572 6e20 4e6f 6e65 0a0a 2020 2020 2020  urn None..      
+0001b750: 2020 7365 6c66 2e63 6865 636b 5f69 646c    self.check_idl
+0001b760: 655f 7361 7475 7261 7465 6428 7773 290a  e_saturated(ws).
+0001b770: 2020 2020 2020 2020 7365 6c66 2e72 656c          self.rel
+0001b780: 6561 7365 5f72 6573 6f75 7263 6573 2874  ease_resources(t
+0001b790: 732c 2077 7329 0a0a 2020 2020 2020 2020  s, ws)..        
+0001b7a0: 7265 7475 726e 2077 730a 0a20 2020 2064  return ws..    d
+0001b7b0: 6566 205f 6164 645f 746f 5f6d 656d 6f72  ef _add_to_memor
+0001b7c0: 7928 0a20 2020 2020 2020 2073 656c 662c  y(.        self,
+0001b7d0: 0a20 2020 2020 2020 2074 733a 2054 6173  .        ts: Tas
+0001b7e0: 6b53 7461 7465 2c0a 2020 2020 2020 2020  kState,.        
+0001b7f0: 7773 3a20 576f 726b 6572 5374 6174 652c  ws: WorkerState,
+0001b800: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
+0001b810: 6e64 6174 696f 6e73 3a20 5265 6373 2c0a  ndations: Recs,.
+0001b820: 2020 2020 2020 2020 636c 6965 6e74 5f6d          client_m
+0001b830: 7367 733a 204d 7367 732c 0a20 2020 2020  sgs: Msgs,.     
+0001b840: 2020 2074 7970 653a 2062 7974 6573 207c     type: bytes |
+0001b850: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+0001b860: 2020 2020 2020 7479 7065 6e61 6d65 3a20        typename: 
+0001b870: 7374 7220 7c20 4e6f 6e65 203d 204e 6f6e  str | None = Non
+0001b880: 652c 0a20 2020 2029 202d 3e20 4e6f 6e65  e,.    ) -> None
+0001b890: 3a0a 2020 2020 2020 2020 2222 2241 6464  :.        """Add
+0001b8a0: 2074 7320 746f 2074 6865 2073 6574 206f   ts to the set o
+0001b8b0: 6620 696e 2d6d 656d 6f72 7920 7461 736b  f in-memory task
+0001b8c0: 7322 2222 0a20 2020 2020 2020 2069 6620  s""".        if 
+0001b8d0: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
+0001b8e0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0001b8f0: 7420 7473 206e 6f74 2069 6e20 7773 2e68  t ts not in ws.h
+0001b900: 6173 5f77 6861 740a 0a20 2020 2020 2020  as_what..       
+0001b910: 2073 656c 662e 6164 645f 7265 706c 6963   self.add_replic
+0001b920: 6128 7473 2c20 7773 290a 0a20 2020 2020  a(ts, ws)..     
+0001b930: 2020 2064 6570 7320 3d20 6c69 7374 2874     deps = list(t
+0001b940: 732e 6465 7065 6e64 656e 7473 290a 2020  s.dependents).  
+0001b950: 2020 2020 2020 6966 206c 656e 2864 6570        if len(dep
+0001b960: 7329 203e 2031 3a0a 2020 2020 2020 2020  s) > 1:.        
+0001b970: 2020 2020 6465 7073 2e73 6f72 7428 6b65      deps.sort(ke
+0001b980: 793d 6f70 6572 6174 6f72 2e61 7474 7267  y=operator.attrg
+0001b990: 6574 7465 7228 2270 7269 6f72 6974 7922  etter("priority"
+0001b9a0: 292c 2072 6576 6572 7365 3d54 7275 6529  ), reverse=True)
+0001b9b0: 0a0a 2020 2020 2020 2020 666f 7220 6474  ..        for dt
+0001b9c0: 7320 696e 2064 6570 733a 0a20 2020 2020  s in deps:.     
+0001b9d0: 2020 2020 2020 2073 203d 2064 7473 2e77         s = dts.w
+0001b9e0: 6169 7469 6e67 5f6f 6e0a 2020 2020 2020  aiting_on.      
+0001b9f0: 2020 2020 2020 6966 2074 7320 696e 2073        if ts in s
+0001ba00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001ba10: 2020 732e 6469 7363 6172 6428 7473 290a    s.discard(ts).
+0001ba20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ba30: 6966 206e 6f74 2073 3a20 2023 206e 6577  if not s:  # new
+0001ba40: 2074 6173 6b20 7265 6164 7920 746f 2072   task ready to r
+0001ba50: 756e 0a20 2020 2020 2020 2020 2020 2020  un.             
+0001ba60: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
+0001ba70: 6174 696f 6e73 5b64 7473 2e6b 6579 5d20  ations[dts.key] 
+0001ba80: 3d20 2270 726f 6365 7373 696e 6722 0a0a  = "processing"..
+0001ba90: 2020 2020 2020 2020 666f 7220 6474 7320          for dts 
+0001baa0: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
+0001bab0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+0001bac0: 7320 3d20 6474 732e 7761 6974 6572 730a  s = dts.waiters.
+0001bad0: 2020 2020 2020 2020 2020 2020 732e 6469              s.di
+0001bae0: 7363 6172 6428 7473 290a 2020 2020 2020  scard(ts).      
+0001baf0: 2020 2020 2020 6966 206e 6f74 2073 2061        if not s a
+0001bb00: 6e64 206e 6f74 2064 7473 2e77 686f 5f77  nd not dts.who_w
+0001bb10: 616e 7473 3a0a 2020 2020 2020 2020 2020  ants:.          
+0001bb20: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
+0001bb30: 7469 6f6e 735b 6474 732e 6b65 795d 203d  tions[dts.key] =
+0001bb40: 2022 7265 6c65 6173 6564 220a 0a20 2020   "released"..   
+0001bb50: 2020 2020 2069 6620 6e6f 7420 7473 2e77       if not ts.w
+0001bb60: 6169 7465 7273 2061 6e64 206e 6f74 2074  aiters and not t
+0001bb70: 732e 7768 6f5f 7761 6e74 733a 0a20 2020  s.who_wants:.   
+0001bb80: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
+0001bb90: 6e64 6174 696f 6e73 5b74 732e 6b65 795d  ndations[ts.key]
+0001bba0: 203d 2022 7265 6c65 6173 6564 220a 2020   = "released".  
+0001bbb0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001bbc0: 2020 2020 2020 2020 7265 706f 7274 5f6d          report_m
+0001bbd0: 7367 3a20 6469 6374 5b73 7472 2c20 416e  sg: dict[str, An
+0001bbe0: 795d 203d 207b 226f 7022 3a20 226b 6579  y] = {"op": "key
+0001bbf0: 2d69 6e2d 6d65 6d6f 7279 222c 2022 6b65  -in-memory", "ke
+0001bc00: 7922 3a20 7473 2e6b 6579 7d0a 2020 2020  y": ts.key}.    
+0001bc10: 2020 2020 2020 2020 6966 2074 7970 6520          if type 
+0001bc20: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0001bc30: 2020 2020 2020 2020 2020 2020 2072 6570               rep
+0001bc40: 6f72 745f 6d73 675b 2274 7970 6522 5d20  ort_msg["type"] 
+0001bc50: 3d20 7479 7065 0a20 2020 2020 2020 2020  = type.         
+0001bc60: 2020 2066 6f72 2063 7320 696e 2074 732e     for cs in ts.
+0001bc70: 7768 6f5f 7761 6e74 733a 0a20 2020 2020  who_wants:.     
+0001bc80: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
+0001bc90: 745f 6d73 6773 5b63 732e 636c 6965 6e74  t_msgs[cs.client
+0001bca0: 5f6b 6579 5d20 3d20 5b72 6570 6f72 745f  _key] = [report_
+0001bcb0: 6d73 675d 0a0a 2020 2020 2020 2020 7473  msg]..        ts
+0001bcc0: 2e73 7461 7465 203d 2022 6d65 6d6f 7279  .state = "memory
+0001bcd0: 220a 2020 2020 2020 2020 7473 2e74 7970  ".        ts.typ
+0001bce0: 6520 3d20 7479 7065 6e61 6d65 2020 2320  e = typename  # 
+0001bcf0: 7479 7065 3a20 6967 6e6f 7265 0a20 2020  type: ignore.   
+0001bd00: 2020 2020 2074 732e 6772 6f75 702e 7479       ts.group.ty
+0001bd10: 7065 732e 6164 6428 7479 7065 6e61 6d65  pes.add(typename
+0001bd20: 2920 2023 2074 7970 653a 2069 676e 6f72  )  # type: ignor
+0001bd30: 650a 0a20 2020 2020 2020 2063 7320 3d20  e..        cs = 
+0001bd40: 7365 6c66 2e63 6c69 656e 7473 5b22 6669  self.clients["fi
+0001bd50: 7265 2d61 6e64 2d66 6f72 6765 7422 5d0a  re-and-forget"].
+0001bd60: 2020 2020 2020 2020 6966 2074 7320 696e          if ts in
+0001bd70: 2063 732e 7761 6e74 735f 7768 6174 3a0a   cs.wants_what:.
+0001bd80: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001bd90: 2e5f 636c 6965 6e74 5f72 656c 6561 7365  ._client_release
+0001bda0: 735f 6b65 7973 280a 2020 2020 2020 2020  s_keys(.        
+0001bdb0: 2020 2020 2020 2020 6373 3d63 732c 0a20          cs=cs,. 
+0001bdc0: 2020 2020 2020 2020 2020 2020 2020 206b                 k
+0001bdd0: 6579 733d 5b74 732e 6b65 795d 2c0a 2020  eys=[ts.key],.  
+0001bde0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0001bdf0: 636f 6d6d 656e 6461 7469 6f6e 733d 7265  commendations=re
+0001be00: 636f 6d6d 656e 6461 7469 6f6e 732c 0a20  commendations,. 
+0001be10: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+0001be20: 2020 6465 6620 5f70 726f 7061 6761 7465    def _propagate
+0001be30: 5f72 656c 6561 7365 6428 7365 6c66 2c20  _released(self, 
+0001be40: 7473 3a20 5461 736b 5374 6174 652c 2072  ts: TaskState, r
+0001be50: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
+0001be60: 5265 6373 2920 2d3e 204e 6f6e 653a 0a20  Recs) -> None:. 
+0001be70: 2020 2020 2020 2074 732e 7374 6174 6520         ts.state 
+0001be80: 3d20 2272 656c 6561 7365 6422 0a20 2020  = "released".   
+0001be90: 2020 2020 206b 6579 203d 2074 732e 6b65       key = ts.ke
+0001bea0: 790a 0a20 2020 2020 2020 2069 6620 7473  y..        if ts
+0001beb0: 2e68 6173 5f6c 6f73 745f 6465 7065 6e64  .has_lost_depend
+0001bec0: 656e 6369 6573 3a0a 2020 2020 2020 2020  encies:.        
+0001bed0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+0001bee0: 6f6e 735b 6b65 795d 203d 2022 666f 7267  ons[key] = "forg
+0001bef0: 6f74 7465 6e22 0a20 2020 2020 2020 2065  otten".        e
+0001bf00: 6c69 6620 7473 2e77 6169 7465 7273 206f  lif ts.waiters o
+0001bf10: 7220 7473 2e77 686f 5f77 616e 7473 3a0a  r ts.who_wants:.
+0001bf20: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+0001bf30: 6d6d 656e 6461 7469 6f6e 735b 6b65 795d  mmendations[key]
+0001bf40: 203d 2022 7761 6974 696e 6722 0a0a 2020   = "waiting"..  
+0001bf50: 2020 2020 2020 6966 2072 6563 6f6d 6d65        if recomme
+0001bf60: 6e64 6174 696f 6e73 2e67 6574 286b 6579  ndations.get(key
+0001bf70: 2920 213d 2022 7761 6974 696e 6722 3a0a  ) != "waiting":.
+0001bf80: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0001bf90: 6474 7320 696e 2074 732e 6465 7065 6e64  dts in ts.depend
+0001bfa0: 656e 6369 6573 3a0a 2020 2020 2020 2020  encies:.        
+0001bfb0: 2020 2020 2020 2020 6966 2064 7473 2e73          if dts.s
+0001bfc0: 7461 7465 2021 3d20 2272 656c 6561 7365  tate != "release
+0001bfd0: 6422 3a0a 2020 2020 2020 2020 2020 2020  d":.            
+0001bfe0: 2020 2020 2020 2020 6474 732e 7761 6974          dts.wait
+0001bff0: 6572 732e 6469 7363 6172 6428 7473 290a  ers.discard(ts).
+0001c000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c010: 2020 2020 6966 206e 6f74 2064 7473 2e77      if not dts.w
+0001c020: 6169 7465 7273 2061 6e64 206e 6f74 2064  aiters and not d
+0001c030: 7473 2e77 686f 5f77 616e 7473 3a0a 2020  ts.who_wants:.  
+0001c040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c050: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
+0001c060: 7469 6f6e 735b 6474 732e 6b65 795d 203d  tions[dts.key] =
+0001c070: 2022 7265 6c65 6173 6564 220a 2020 2020   "released".    
+0001c080: 2020 2020 2020 2020 7473 2e77 6169 7465          ts.waite
+0001c090: 7273 2e63 6c65 6172 2829 0a0a 2020 2020  rs.clear()..    
+0001c0a0: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
+0001c0b0: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
+0001c0c0: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
+0001c0d0: 7072 6f63 6573 7369 6e67 5f6f 6e0a 2020  processing_on.  
+0001c0e0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0001c0f0: 2074 7320 6e6f 7420 696e 2073 656c 662e   ts not in self.
+0001c100: 7175 6575 6564 0a0a 2020 2020 6465 6620  queued..    def 
+0001c110: 5f70 726f 7061 6761 7465 5f66 6f72 676f  _propagate_forgo
+0001c120: 7474 656e 280a 2020 2020 2020 2020 7365  tten(.        se
+0001c130: 6c66 2c0a 2020 2020 2020 2020 7473 3a20  lf,.        ts: 
+0001c140: 5461 736b 5374 6174 652c 0a20 2020 2020  TaskState,.     
+0001c150: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
+0001c160: 6e73 3a20 5265 6373 2c0a 2020 2020 2020  ns: Recs,.      
+0001c170: 2020 776f 726b 6572 5f6d 7367 733a 204d    worker_msgs: M
+0001c180: 7367 732c 0a20 2020 2020 2020 2073 7469  sgs,.        sti
+0001c190: 6d75 6c75 735f 6964 3a20 7374 722c 0a20  mulus_id: str,. 
+0001c1a0: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
+0001c1b0: 2020 2020 2020 7473 2e73 7461 7465 203d        ts.state =
+0001c1c0: 2022 666f 7267 6f74 7465 6e22 0a20 2020   "forgotten".   
+0001c1d0: 2020 2020 2066 6f72 2064 7473 2069 6e20       for dts in 
+0001c1e0: 7473 2e64 6570 656e 6465 6e74 733a 0a20  ts.dependents:. 
+0001c1f0: 2020 2020 2020 2020 2020 2064 7473 2e68             dts.h
+0001c200: 6173 5f6c 6f73 745f 6465 7065 6e64 656e  as_lost_dependen
+0001c210: 6369 6573 203d 2054 7275 650a 2020 2020  cies = True.    
+0001c220: 2020 2020 2020 2020 6474 732e 6465 7065          dts.depe
+0001c230: 6e64 656e 6369 6573 2e72 656d 6f76 6528  ndencies.remove(
+0001c240: 7473 290a 2020 2020 2020 2020 2020 2020  ts).            
+0001c250: 6474 732e 7761 6974 696e 675f 6f6e 2e64  dts.waiting_on.d
+0001c260: 6973 6361 7264 2874 7329 0a20 2020 2020  iscard(ts).     
+0001c270: 2020 2020 2020 2069 6620 6474 732e 7374         if dts.st
+0001c280: 6174 6520 6e6f 7420 696e 2028 226d 656d  ate not in ("mem
+0001c290: 6f72 7922 2c20 2265 7272 6564 2229 3a0a  ory", "erred"):.
+0001c2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c2b0: 2320 4361 6e6e 6f74 2063 6f6d 7075 7465  # Cannot compute
+0001c2c0: 2074 6173 6b20 616e 796d 6f72 650a 2020   task anymore.  
+0001c2d0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0001c2e0: 636f 6d6d 656e 6461 7469 6f6e 735b 6474  commendations[dt
+0001c2f0: 732e 6b65 795d 203d 2022 666f 7267 6f74  s.key] = "forgot
+0001c300: 7465 6e22 0a20 2020 2020 2020 2074 732e  ten".        ts.
+0001c310: 6465 7065 6e64 656e 7473 2e63 6c65 6172  dependents.clear
+0001c320: 2829 0a20 2020 2020 2020 2074 732e 7761  ().        ts.wa
+0001c330: 6974 6572 732e 636c 6561 7228 290a 0a20  iters.clear().. 
+0001c340: 2020 2020 2020 2066 6f72 2064 7473 2069         for dts i
+0001c350: 6e20 7473 2e64 6570 656e 6465 6e63 6965  n ts.dependencie
+0001c360: 733a 0a20 2020 2020 2020 2020 2020 2064  s:.            d
+0001c370: 7473 2e64 6570 656e 6465 6e74 732e 7265  ts.dependents.re
+0001c380: 6d6f 7665 2874 7329 0a20 2020 2020 2020  move(ts).       
+0001c390: 2020 2020 2064 7473 2e77 6169 7465 7273       dts.waiters
+0001c3a0: 2e64 6973 6361 7264 2874 7329 0a20 2020  .discard(ts).   
+0001c3b0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0001c3c0: 6474 732e 6465 7065 6e64 656e 7473 2061  dts.dependents a
+0001c3d0: 6e64 206e 6f74 2064 7473 2e77 686f 5f77  nd not dts.who_w
+0001c3e0: 616e 7473 3a0a 2020 2020 2020 2020 2020  ants:.          
+0001c3f0: 2020 2020 2020 2320 5461 736b 206e 6f74        # Task not
+0001c400: 206e 6565 6465 6420 616e 796d 6f72 650a   needed anymore.
 0001c410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c420: 2020 2020 2022 6f70 223a 2022 6672 6565       "op": "free
-0001c430: 2d6b 6579 7322 2c0a 2020 2020 2020 2020  -keys",.        
-0001c440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c450: 226b 6579 7322 3a20 5b74 732e 6b65 795d  "keys": [ts.key]
-0001c460: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001c470: 2020 2020 2020 2020 2020 2273 7469 6d75            "stimu
-0001c480: 6c75 735f 6964 223a 2073 7469 6d75 6c75  lus_id": stimulu
-0001c490: 735f 6964 2c0a 2020 2020 2020 2020 2020  s_id,.          
-0001c4a0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0001c4b0: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-0001c4c0: 2020 2020 2020 7365 6c66 2e72 656d 6f76        self.remov
-0001c4d0: 655f 616c 6c5f 7265 706c 6963 6173 2874  e_all_replicas(t
-0001c4e0: 7329 0a0a 2020 2020 6465 6620 5f63 6c69  s)..    def _cli
-0001c4f0: 656e 745f 7265 6c65 6173 6573 5f6b 6579  ent_releases_key
-0001c500: 7328 0a20 2020 2020 2020 2073 656c 662c  s(.        self,
-0001c510: 0a20 2020 2020 2020 206b 6579 733a 2043  .        keys: C
-0001c520: 6f6c 6c65 6374 696f 6e5b 7374 725d 2c0a  ollection[str],.
-0001c530: 2020 2020 2020 2020 6373 3a20 436c 6965          cs: Clie
-0001c540: 6e74 5374 6174 652c 0a20 2020 2020 2020  ntState,.       
-0001c550: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-0001c560: 3a20 5265 6373 2c0a 2020 2020 2920 2d3e  : Recs,.    ) ->
-0001c570: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-0001c580: 2222 5265 6d6f 7665 206b 6579 7320 6672  ""Remove keys fr
-0001c590: 6f6d 2063 6c69 656e 7420 6465 7369 7265  om client desire
-0001c5a0: 6420 6c69 7374 2222 220a 2020 2020 2020  d list""".      
-0001c5b0: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
-0001c5c0: 436c 6965 6e74 2025 7320 7265 6c65 6173  Client %s releas
-0001c5d0: 6573 206b 6579 733a 2025 7322 2c20 6373  es keys: %s", cs
-0001c5e0: 2e63 6c69 656e 745f 6b65 792c 206b 6579  .client_key, key
-0001c5f0: 7329 0a20 2020 2020 2020 2066 6f72 206b  s).        for k
-0001c600: 6579 2069 6e20 6b65 7973 3a0a 2020 2020  ey in keys:.    
-0001c610: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-0001c620: 662e 7461 736b 732e 6765 7428 6b65 7929  f.tasks.get(key)
-0001c630: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0001c640: 7473 2069 7320 6e6f 7420 4e6f 6e65 2061  ts is not None a
-0001c650: 6e64 2074 7320 696e 2063 732e 7761 6e74  nd ts in cs.want
-0001c660: 735f 7768 6174 3a0a 2020 2020 2020 2020  s_what:.        
-0001c670: 2020 2020 2020 2020 6373 2e77 616e 7473          cs.wants
-0001c680: 5f77 6861 742e 7265 6d6f 7665 2874 7329  _what.remove(ts)
-0001c690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c6a0: 2074 732e 7768 6f5f 7761 6e74 732e 7265   ts.who_wants.re
-0001c6b0: 6d6f 7665 2863 7329 0a20 2020 2020 2020  move(cs).       
-0001c6c0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-0001c6d0: 7473 2e77 686f 5f77 616e 7473 3a0a 2020  ts.who_wants:.  
-0001c6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c6f0: 2020 6966 206e 6f74 2074 732e 6465 7065    if not ts.depe
-0001c700: 6e64 656e 7473 3a0a 2020 2020 2020 2020  ndents:.        
-0001c710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c720: 2320 4e6f 206c 6976 6520 6465 7065 6e64  # No live depend
-0001c730: 656e 7473 2c20 6361 6e20 666f 7267 6574  ents, can forget
-0001c740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c750: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
-0001c760: 6e64 6174 696f 6e73 5b74 732e 6b65 795d  ndations[ts.key]
-0001c770: 203d 2022 666f 7267 6f74 7465 6e22 0a20   = "forgotten". 
-0001c780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c790: 2020 2065 6c69 6620 7473 2e73 7461 7465     elif ts.state
-0001c7a0: 2021 3d20 2265 7272 6564 2220 616e 6420   != "erred" and 
-0001c7b0: 6e6f 7420 7473 2e77 6169 7465 7273 3a0a  not ts.waiters:.
-0001c7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c7d0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-0001c7e0: 6461 7469 6f6e 735b 7473 2e6b 6579 5d20  dations[ts.key] 
-0001c7f0: 3d20 2272 656c 6561 7365 6422 0a0a 2020  = "released"..  
-0001c800: 2020 6465 6620 5f74 6173 6b5f 746f 5f6d    def _task_to_m
-0001c810: 7367 2873 656c 662c 2074 733a 2054 6173  sg(self, ts: Tas
-0001c820: 6b53 7461 7465 2c20 6475 7261 7469 6f6e  kState, duration
-0001c830: 3a20 666c 6f61 7420 3d20 2d31 2920 2d3e  : float = -1) ->
-0001c840: 2064 6963 745b 7374 722c 2041 6e79 5d3a   dict[str, Any]:
-0001c850: 0a20 2020 2020 2020 2022 2222 436f 6e76  .        """Conv
-0001c860: 6572 7420 6120 7369 6e67 6c65 2063 6f6d  ert a single com
-0001c870: 7075 7461 7469 6f6e 616c 2074 6173 6b20  putational task 
-0001c880: 746f 2061 206d 6573 7361 6765 2222 220a  to a message""".
-0001c890: 2020 2020 2020 2020 2320 4649 584d 453a          # FIXME:
-0001c8a0: 2054 6865 2064 7572 6174 696f 6e20 6174   The duration at
-0001c8b0: 7472 6962 7574 6520 6973 206e 6f74 2075  tribute is not u
-0001c8c0: 7365 6420 6f6e 2077 6f72 6b65 722e 2057  sed on worker. W
-0001c8d0: 6520 636f 756c 6420 7361 7665 206f 7572  e could save our
-0001c8e0: 7365 6c76 6573 2074 6865 0a20 2020 2020  selves the.     
-0001c8f0: 2020 2023 2020 2020 2020 2020 7469 6d65     #        time
-0001c900: 2074 6f20 636f 6d70 7574 6520 616e 6420   to compute and 
-0001c910: 7375 626d 6974 2074 6869 730a 2020 2020  submit this.    
-0001c920: 2020 2020 6966 2064 7572 6174 696f 6e20      if duration 
-0001c930: 3c20 303a 0a20 2020 2020 2020 2020 2020  < 0:.           
-0001c940: 2064 7572 6174 696f 6e20 3d20 7365 6c66   duration = self
-0001c950: 2e67 6574 5f74 6173 6b5f 6475 7261 7469  .get_task_durati
-0001c960: 6f6e 2874 7329 0a20 2020 2020 2020 2074  on(ts).        t
-0001c970: 732e 7275 6e5f 6964 203d 206e 6578 7428  s.run_id = next(
-0001c980: 5461 736b 5374 6174 652e 5f72 756e 5f69  TaskState._run_i
-0001c990: 645f 6974 6572 6174 6f72 290a 2020 2020  d_iterator).    
-0001c9a0: 2020 2020 6173 7365 7274 2074 732e 7072      assert ts.pr
-0001c9b0: 696f 7269 7479 2c20 7473 0a20 2020 2020  iority, ts.     
-0001c9c0: 2020 206d 7367 3a20 6469 6374 5b73 7472     msg: dict[str
-0001c9d0: 2c20 416e 795d 203d 207b 0a20 2020 2020  , Any] = {.     
-0001c9e0: 2020 2020 2020 2022 6f70 223a 2022 636f         "op": "co
-0001c9f0: 6d70 7574 652d 7461 736b 222c 0a20 2020  mpute-task",.   
-0001ca00: 2020 2020 2020 2020 2022 6b65 7922 3a20           "key": 
-0001ca10: 7473 2e6b 6579 2c0a 2020 2020 2020 2020  ts.key,.        
-0001ca20: 2020 2020 2272 756e 5f69 6422 3a20 7473      "run_id": ts
-0001ca30: 2e72 756e 5f69 642c 0a20 2020 2020 2020  .run_id,.       
-0001ca40: 2020 2020 2022 7072 696f 7269 7479 223a       "priority":
-0001ca50: 2074 732e 7072 696f 7269 7479 2c0a 2020   ts.priority,.  
-0001ca60: 2020 2020 2020 2020 2020 2264 7572 6174            "durat
-0001ca70: 696f 6e22 3a20 6475 7261 7469 6f6e 2c0a  ion": duration,.
-0001ca80: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
-0001ca90: 6d75 6c75 735f 6964 223a 2066 2263 6f6d  mulus_id": f"com
-0001caa0: 7075 7465 2d74 6173 6b2d 7b74 696d 6528  pute-task-{time(
-0001cab0: 297d 222c 0a20 2020 2020 2020 2020 2020  )}",.           
-0001cac0: 2022 7768 6f5f 6861 7322 3a20 7b0a 2020   "who_has": {.  
-0001cad0: 2020 2020 2020 2020 2020 2020 2020 6474                dt
-0001cae0: 732e 6b65 793a 205b 7773 2e61 6464 7265  s.key: [ws.addre
-0001caf0: 7373 2066 6f72 2077 7320 696e 2064 7473  ss for ws in dts
-0001cb00: 2e77 686f 5f68 6173 5d20 666f 7220 6474  .who_has] for dt
-0001cb10: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-0001cb20: 6369 6573 0a20 2020 2020 2020 2020 2020  cies.           
-0001cb30: 207d 2c0a 2020 2020 2020 2020 2020 2020   },.            
-0001cb40: 226e 6279 7465 7322 3a20 7b64 7473 2e6b  "nbytes": {dts.k
-0001cb50: 6579 3a20 6474 732e 6e62 7974 6573 2066  ey: dts.nbytes f
-0001cb60: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
-0001cb70: 656e 6465 6e63 6965 737d 2c0a 2020 2020  endencies},.    
-0001cb80: 2020 2020 2020 2020 2272 756e 5f73 7065          "run_spe
-0001cb90: 6322 3a20 4e6f 6e65 2c0a 2020 2020 2020  c": None,.      
-0001cba0: 2020 2020 2020 2266 756e 6374 696f 6e22        "function"
-0001cbb0: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-0001cbc0: 2020 2020 2261 7267 7322 3a20 4e6f 6e65      "args": None
-0001cbd0: 2c0a 2020 2020 2020 2020 2020 2020 226b  ,.            "k
-0001cbe0: 7761 7267 7322 3a20 4e6f 6e65 2c0a 2020  wargs": None,.  
-0001cbf0: 2020 2020 2020 2020 2020 2272 6573 6f75            "resou
-0001cc00: 7263 655f 7265 7374 7269 6374 696f 6e73  rce_restrictions
-0001cc10: 223a 2074 732e 7265 736f 7572 6365 5f72  ": ts.resource_r
-0001cc20: 6573 7472 6963 7469 6f6e 732c 0a20 2020  estrictions,.   
-0001cc30: 2020 2020 2020 2020 2022 6163 746f 7222           "actor"
-0001cc40: 3a20 7473 2e61 6374 6f72 2c0a 2020 2020  : ts.actor,.    
-0001cc50: 2020 2020 2020 2020 2261 6e6e 6f74 6174          "annotat
-0001cc60: 696f 6e73 223a 2074 732e 616e 6e6f 7461  ions": ts.annota
-0001cc70: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
-0001cc80: 2020 2022 7370 616e 5f69 6422 3a20 7473     "span_id": ts
-0001cc90: 2e67 726f 7570 2e73 7061 6e5f 6964 2c0a  .group.span_id,.
-0001cca0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0001ccb0: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
-0001ccc0: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
-0001ccd0: 6173 7365 7274 2061 6c6c 286d 7367 5b22  assert all(msg["
-0001cce0: 7768 6f5f 6861 7322 5d2e 7661 6c75 6573  who_has"].values
-0001ccf0: 2829 290a 0a20 2020 2020 2020 2069 6620  ())..        if 
-0001cd00: 6973 696e 7374 616e 6365 2874 732e 7275  isinstance(ts.ru
-0001cd10: 6e5f 7370 6563 2c20 6469 6374 293a 0a20  n_spec, dict):. 
-0001cd20: 2020 2020 2020 2020 2020 206d 7367 2e75             msg.u
-0001cd30: 7064 6174 6528 7473 2e72 756e 5f73 7065  pdate(ts.run_spe
-0001cd40: 6329 0a20 2020 2020 2020 2065 6c73 653a  c).        else:
-0001cd50: 0a20 2020 2020 2020 2020 2020 206d 7367  .            msg
-0001cd60: 5b22 7275 6e5f 7370 6563 225d 203d 2074  ["run_spec"] = t
-0001cd70: 732e 7275 6e5f 7370 6563 0a0a 2020 2020  s.run_spec..    
-0001cd80: 2020 2020 7265 7475 726e 206d 7367 0a0a      return msg..
-0001cd90: 0a63 6c61 7373 2053 6368 6564 756c 6572  .class Scheduler
-0001cda0: 2853 6368 6564 756c 6572 5374 6174 652c  (SchedulerState,
-0001cdb0: 2053 6572 7665 724e 6f64 6529 3a0a 2020   ServerNode):.  
-0001cdc0: 2020 2222 2244 796e 616d 6963 2064 6973    """Dynamic dis
-0001cdd0: 7472 6962 7574 6564 2074 6173 6b20 7363  tributed task sc
-0001cde0: 6865 6475 6c65 720a 0a20 2020 2054 6865  heduler..    The
-0001cdf0: 2073 6368 6564 756c 6572 2074 7261 636b   scheduler track
-0001ce00: 7320 7468 6520 6375 7272 656e 7420 7374  s the current st
-0001ce10: 6174 6520 6f66 2077 6f72 6b65 7273 2c20  ate of workers, 
-0001ce20: 6461 7461 2c20 616e 6420 636f 6d70 7574  data, and comput
-0001ce30: 6174 696f 6e73 2e0a 2020 2020 5468 6520  ations..    The 
-0001ce40: 7363 6865 6475 6c65 7220 6c69 7374 656e  scheduler listen
-0001ce50: 7320 666f 7220 6576 656e 7473 2061 6e64  s for events and
-0001ce60: 2072 6573 706f 6e64 7320 6279 2063 6f6e   responds by con
-0001ce70: 7472 6f6c 6c69 6e67 2077 6f72 6b65 7273  trolling workers
-0001ce80: 0a20 2020 2061 7070 726f 7072 6961 7465  .    appropriate
-0001ce90: 6c79 2e20 2049 7420 636f 6e74 696e 756f  ly.  It continuo
-0001cea0: 7573 6c79 2074 7269 6573 2074 6f20 7573  usly tries to us
-0001ceb0: 6520 7468 6520 776f 726b 6572 7320 746f  e the workers to
-0001cec0: 2065 7865 6375 7465 2061 6e20 6576 6572   execute an ever
-0001ced0: 0a20 2020 2067 726f 7769 6e67 2064 6173  .    growing das
-0001cee0: 6b20 6772 6170 682e 0a0a 2020 2020 416c  k graph...    Al
-0001cef0: 6c20 6576 656e 7473 2061 7265 2068 616e  l events are han
-0001cf00: 646c 6564 2071 7569 636b 6c79 2c20 696e  dled quickly, in
-0001cf10: 206c 696e 6561 7220 7469 6d65 2077 6974   linear time wit
-0001cf20: 6820 7265 7370 6563 7420 746f 2074 6865  h respect to the
-0001cf30: 6972 2069 6e70 7574 0a20 2020 2028 7768  ir input.    (wh
-0001cf40: 6963 6820 6973 206f 6674 656e 206f 6620  ich is often of 
-0001cf50: 636f 6e73 7461 6e74 2073 697a 6529 2061  constant size) a
-0001cf60: 6e64 2067 656e 6572 616c 6c79 2077 6974  nd generally wit
-0001cf70: 6869 6e20 6120 6d69 6c6c 6973 6563 6f6e  hin a millisecon
-0001cf80: 642e 2020 546f 0a20 2020 2061 6363 6f6d  d.  To.    accom
-0001cf90: 706c 6973 6820 7468 6973 2074 6865 2073  plish this the s
-0001cfa0: 6368 6564 756c 6572 2074 7261 636b 7320  cheduler tracks 
-0001cfb0: 6120 6c6f 7420 6f66 2073 7461 7465 2e20  a lot of state. 
-0001cfc0: 2045 7665 7279 206f 7065 7261 7469 6f6e   Every operation
-0001cfd0: 0a20 2020 206d 6169 6e74 6169 6e73 2074  .    maintains t
-0001cfe0: 6865 2063 6f6e 7369 7374 656e 6379 206f  he consistency o
-0001cff0: 6620 7468 6973 2073 7461 7465 2e0a 0a20  f this state... 
-0001d000: 2020 2054 6865 2073 6368 6564 756c 6572     The scheduler
-0001d010: 2063 6f6d 6d75 6e69 6361 7465 7320 7769   communicates wi
-0001d020: 7468 2074 6865 206f 7574 7369 6465 2077  th the outside w
-0001d030: 6f72 6c64 2074 6872 6f75 6768 2043 6f6d  orld through Com
-0001d040: 6d20 6f62 6a65 6374 732e 0a20 2020 2049  m objects..    I
-0001d050: 7420 6d61 696e 7461 696e 7320 6120 636f  t maintains a co
-0001d060: 6e73 6973 7465 6e74 2061 6e64 2076 616c  nsistent and val
-0001d070: 6964 2076 6965 7720 6f66 2074 6865 2077  id view of the w
-0001d080: 6f72 6c64 2065 7665 6e20 7768 656e 206c  orld even when l
-0001d090: 6973 7465 6e69 6e67 0a20 2020 2074 6f20  istening.    to 
-0001d0a0: 7365 7665 7261 6c20 636c 6965 6e74 7320  several clients 
-0001d0b0: 6174 206f 6e63 652e 0a0a 2020 2020 4120  at once...    A 
-0001d0c0: 5363 6865 6475 6c65 7220 6973 2074 7970  Scheduler is typ
-0001d0d0: 6963 616c 6c79 2073 7461 7274 6564 2065  ically started e
-0001d0e0: 6974 6865 7220 7769 7468 2074 6865 2060  ither with the `
-0001d0f0: 6064 6173 6b20 7363 6865 6475 6c65 7260  `dask scheduler`
-0001d100: 600a 2020 2020 6578 6563 7574 6162 6c65  `.    executable
-0001d110: 3a3a 0a0a 2020 2020 2020 2020 2024 2064  ::..         $ d
-0001d120: 6173 6b20 7363 6865 6475 6c65 720a 2020  ask scheduler.  
-0001d130: 2020 2020 2020 2053 6368 6564 756c 6572         Scheduler
-0001d140: 2073 7461 7274 6564 2061 7420 3132 372e   started at 127.
-0001d150: 302e 302e 313a 3837 3836 0a0a 2020 2020  0.0.1:8786..    
-0001d160: 4f72 2077 6974 6869 6e20 6120 4c6f 6361  Or within a Loca
-0001d170: 6c43 6c75 7374 6572 2061 2043 6c69 656e  lCluster a Clien
-0001d180: 7420 7374 6172 7473 2075 7020 7769 7468  t starts up with
-0001d190: 6f75 7420 636f 6e6e 6563 7469 6f6e 0a20  out connection. 
-0001d1a0: 2020 2069 6e66 6f72 6d61 7469 6f6e 3a3a     information::
-0001d1b0: 0a0a 2020 2020 2020 2020 3e3e 3e20 6320  ..        >>> c 
-0001d1c0: 3d20 436c 6965 6e74 2829 2020 2320 646f  = Client()  # do
-0001d1d0: 6374 6573 743a 202b 534b 4950 0a20 2020  ctest: +SKIP.   
-0001d1e0: 2020 2020 203e 3e3e 2063 2e63 6c75 7374       >>> c.clust
-0001d1f0: 6572 2e73 6368 6564 756c 6572 2020 2320  er.scheduler  # 
-0001d200: 646f 6374 6573 743a 202b 534b 4950 0a20  doctest: +SKIP. 
-0001d210: 2020 2020 2020 2053 6368 6564 756c 6572         Scheduler
-0001d220: 282e 2e2e 290a 0a20 2020 2055 7365 7273  (...)..    Users
-0001d230: 2074 7970 6963 616c 6c79 2064 6f20 6e6f   typically do no
-0001d240: 7420 696e 7465 7261 6374 2077 6974 6820  t interact with 
-0001d250: 7468 6520 7363 6865 6475 6c65 7220 6469  the scheduler di
-0001d260: 7265 6374 6c79 2062 7574 2072 6174 6865  rectly but rathe
-0001d270: 7220 7769 7468 0a20 2020 2074 6865 2063  r with.    the c
-0001d280: 6c69 656e 7420 6f62 6a65 6374 2060 6043  lient object ``C
-0001d290: 6c69 656e 7460 602e 0a0a 2020 2020 5468  lient``...    Th
-0001d2a0: 6520 6060 636f 6e74 6163 745f 6164 6472  e ``contact_addr
-0001d2b0: 6573 7360 6020 7061 7261 6d65 7465 7220  ess`` parameter 
-0001d2c0: 616c 6c6f 7773 2074 6f20 6164 7665 7274  allows to advert
-0001d2d0: 6973 6520 6120 7370 6563 6966 6963 2061  ise a specific a
-0001d2e0: 6464 7265 7373 2074 6f0a 2020 2020 7468  ddress to.    th
-0001d2f0: 6520 776f 726b 6572 7320 666f 7220 636f  e workers for co
-0001d300: 6d6d 756e 6963 6174 696f 6e20 7769 7468  mmunication with
-0001d310: 2074 6865 2073 6368 6564 756c 6572 2c20   the scheduler, 
-0001d320: 7768 6963 6820 6973 2064 6966 6665 7265  which is differe
-0001d330: 6e74 2074 6861 6e0a 2020 2020 7468 6520  nt than.    the 
-0001d340: 6164 6472 6573 7320 7468 6520 7363 6865  address the sche
-0001d350: 6475 6c65 7220 6269 6e64 7320 746f 2e20  duler binds to. 
-0001d360: 5468 6973 2069 7320 7573 6566 756c 2077  This is useful w
-0001d370: 6865 6e20 7468 6520 7363 6865 6475 6c65  hen the schedule
-0001d380: 720a 2020 2020 6c69 7374 656e 7320 6f6e  r.    listens on
-0001d390: 2061 2070 7269 7661 7465 2061 6464 7265   a private addre
-0001d3a0: 7373 2c20 7768 6963 6820 7468 6572 6566  ss, which theref
-0001d3b0: 6f72 6520 6361 6e6e 6f74 2062 6520 7573  ore cannot be us
-0001d3c0: 6564 2062 7920 7468 6520 776f 726b 6572  ed by the worker
-0001d3d0: 730a 2020 2020 746f 2063 6f6e 7461 6374  s.    to contact
-0001d3e0: 2069 742e 0a0a 2020 2020 2a2a 5374 6174   it...    **Stat
-0001d3f0: 652a 2a0a 0a20 2020 2054 6865 2073 6368  e**..    The sch
-0001d400: 6564 756c 6572 2063 6f6e 7461 696e 7320  eduler contains 
-0001d410: 7468 6520 666f 6c6c 6f77 696e 6720 7374  the following st
-0001d420: 6174 6520 7661 7269 6162 6c65 732e 2020  ate variables.  
-0001d430: 4561 6368 2076 6172 6961 626c 6520 6973  Each variable is
-0001d440: 0a20 2020 206c 6973 7465 6420 616c 6f6e  .    listed alon
-0001d450: 6720 7769 7468 2077 6861 7420 6974 2073  g with what it s
-0001d460: 746f 7265 7320 616e 6420 6120 6272 6965  tores and a brie
-0001d470: 6620 6465 7363 7269 7074 696f 6e2e 0a0a  f description...
-0001d480: 2020 2020 2a20 2a2a 7461 736b 733a 2a2a      * **tasks:**
-0001d490: 2060 607b 7461 736b 206b 6579 3a20 5461   ``{task key: Ta
-0001d4a0: 736b 5374 6174 657d 6060 0a20 2020 2020  skState}``.     
-0001d4b0: 2020 2054 6173 6b73 2063 7572 7265 6e74     Tasks current
-0001d4c0: 6c79 206b 6e6f 776e 2074 6f20 7468 6520  ly known to the 
-0001d4d0: 7363 6865 6475 6c65 720a 2020 2020 2a20  scheduler.    * 
-0001d4e0: 2a2a 756e 7275 6e6e 6162 6c65 3a2a 2a20  **unrunnable:** 
-0001d4f0: 6060 7b54 6173 6b53 7461 7465 7d60 600a  ``{TaskState}``.
-0001d500: 2020 2020 2020 2020 5461 736b 7320 696e          Tasks in
-0001d510: 2074 6865 2022 6e6f 2d77 6f72 6b65 7222   the "no-worker"
-0001d520: 2073 7461 7465 0a0a 2020 2020 2a20 2a2a   state..    * **
-0001d530: 776f 726b 6572 733a 2a2a 2060 607b 776f  workers:** ``{wo
-0001d540: 726b 6572 206b 6579 3a20 576f 726b 6572  rker key: Worker
-0001d550: 5374 6174 657d 6060 0a20 2020 2020 2020  State}``.       
-0001d560: 2057 6f72 6b65 7273 2063 7572 7265 6e74   Workers current
-0001d570: 6c79 2063 6f6e 6e65 6374 6564 2074 6f20  ly connected to 
-0001d580: 7468 6520 7363 6865 6475 6c65 720a 2020  the scheduler.  
-0001d590: 2020 2a20 2a2a 6964 6c65 3a2a 2a20 6060    * **idle:** ``
-0001d5a0: 7b57 6f72 6b65 7253 7461 7465 7d60 603a  {WorkerState}``:
-0001d5b0: 0a20 2020 2020 2020 2053 6574 206f 6620  .        Set of 
-0001d5c0: 776f 726b 6572 7320 7468 6174 2061 7265  workers that are
-0001d5d0: 206e 6f74 2066 756c 6c79 2075 7469 6c69   not fully utili
-0001d5e0: 7a65 640a 2020 2020 2a20 2a2a 7361 7475  zed.    * **satu
-0001d5f0: 7261 7465 643a 2a2a 2060 607b 576f 726b  rated:** ``{Work
-0001d600: 6572 5374 6174 657d 6060 3a0a 2020 2020  erState}``:.    
-0001d610: 2020 2020 5365 7420 6f66 2077 6f72 6b65      Set of worke
-0001d620: 7273 2074 6861 7420 6172 6520 6e6f 7420  rs that are not 
-0001d630: 6f76 6572 2d75 7469 6c69 7a65 640a 0a20  over-utilized.. 
-0001d640: 2020 202a 202a 2a68 6f73 745f 696e 666f     * **host_info
-0001d650: 3a2a 2a20 6060 7b68 6f73 746e 616d 653a  :** ``{hostname:
-0001d660: 2064 6963 747d 6060 3a0a 2020 2020 2020   dict}``:.      
-0001d670: 2020 496e 666f 726d 6174 696f 6e20 6162    Information ab
-0001d680: 6f75 7420 6561 6368 2077 6f72 6b65 7220  out each worker 
-0001d690: 686f 7374 0a0a 2020 2020 2a20 2a2a 636c  host..    * **cl
-0001d6a0: 6965 6e74 733a 2a2a 2060 607b 636c 6965  ients:** ``{clie
-0001d6b0: 6e74 206b 6579 3a20 436c 6965 6e74 5374  nt key: ClientSt
-0001d6c0: 6174 657d 6060 0a20 2020 2020 2020 2043  ate}``.        C
-0001d6d0: 6c69 656e 7473 2063 7572 7265 6e74 6c79  lients currently
-0001d6e0: 2063 6f6e 6e65 6374 6564 2074 6f20 7468   connected to th
-0001d6f0: 6520 7363 6865 6475 6c65 720a 0a20 2020  e scheduler..   
-0001d700: 202a 202a 2a73 6572 7669 6365 733a 2a2a   * **services:**
-0001d710: 2060 607b 7374 723a 2070 6f72 747d 6060   ``{str: port}``
-0001d720: 3a0a 2020 2020 2020 2020 4f74 6865 7220  :.        Other 
-0001d730: 7365 7276 6963 6573 2072 756e 6e69 6e67  services running
-0001d740: 206f 6e20 7468 6973 2073 6368 6564 756c   on this schedul
-0001d750: 6572 2c20 6c69 6b65 2042 6f6b 6568 0a20  er, like Bokeh. 
-0001d760: 2020 202a 202a 2a6c 6f6f 703a 2a2a 2060     * **loop:** `
-0001d770: 6049 4f4c 6f6f 7060 603a 0a20 2020 2020  `IOLoop``:.     
-0001d780: 2020 2054 6865 2072 756e 6e69 6e67 2054     The running T
-0001d790: 6f72 6e61 646f 2049 4f4c 6f6f 700a 2020  ornado IOLoop.  
-0001d7a0: 2020 2a20 2a2a 636c 6965 6e74 5f63 6f6d    * **client_com
-0001d7b0: 6d73 3a2a 2a20 6060 7b63 6c69 656e 7420  ms:** ``{client 
-0001d7c0: 6b65 793a 2043 6f6d 6d7d 6060 0a20 2020  key: Comm}``.   
-0001d7d0: 2020 2020 2046 6f72 2065 6163 6820 636c       For each cl
-0001d7e0: 6965 6e74 2c20 6120 436f 6d6d 206f 626a  ient, a Comm obj
-0001d7f0: 6563 7420 7573 6564 2074 6f20 7265 6365  ect used to rece
-0001d800: 6976 6520 7461 736b 2072 6571 7565 7374  ive task request
-0001d810: 7320 616e 640a 2020 2020 2020 2020 7265  s and.        re
-0001d820: 706f 7274 2074 6173 6b20 7374 6174 7573  port task status
-0001d830: 2075 7064 6174 6573 2e0a 2020 2020 2a20   updates..    * 
-0001d840: 2a2a 7374 7265 616d 5f63 6f6d 6d73 3a2a  **stream_comms:*
-0001d850: 2a20 6060 7b77 6f72 6b65 7220 6b65 793a  * ``{worker key:
-0001d860: 2043 6f6d 6d7d 6060 0a20 2020 2020 2020   Comm}``.       
-0001d870: 2046 6f72 2065 6163 6820 776f 726b 6572   For each worker
-0001d880: 2c20 6120 436f 6d6d 206f 626a 6563 7420  , a Comm object 
-0001d890: 6672 6f6d 2077 6869 6368 2077 6520 626f  from which we bo
-0001d8a0: 7468 2061 6363 6570 7420 7374 696d 756c  th accept stimul
-0001d8b0: 6920 616e 640a 2020 2020 2020 2020 7265  i and.        re
-0001d8c0: 706f 7274 2072 6573 756c 7473 0a20 2020  port results.   
-0001d8d0: 202a 202a 2a74 6173 6b5f 6475 7261 7469   * **task_durati
-0001d8e0: 6f6e 3a2a 2a20 6060 7b6b 6579 2d70 7265  on:** ``{key-pre
-0001d8f0: 6669 783a 2074 696d 657d 6060 0a20 2020  fix: time}``.   
-0001d900: 2020 2020 2054 696d 6520 7765 2065 7870       Time we exp
-0001d910: 6563 7420 6365 7274 6169 6e20 6675 6e63  ect certain func
-0001d920: 7469 6f6e 7320 746f 2074 616b 652c 2065  tions to take, e
-0001d930: 2e67 2e20 6060 7b27 7375 6d27 3a20 302e  .g. ``{'sum': 0.
-0001d940: 3235 7d60 600a 2020 2020 2222 220a 0a20  25}``.    """.. 
-0001d950: 2020 2064 6566 6175 6c74 5f70 6f72 7420     default_port 
-0001d960: 3d20 3837 3836 0a20 2020 205f 696e 7374  = 8786.    _inst
-0001d970: 616e 6365 733a 2043 6c61 7373 5661 725b  ances: ClassVar[
-0001d980: 7765 616b 7265 662e 5765 616b 5365 745b  weakref.WeakSet[
-0001d990: 5363 6865 6475 6c65 725d 5d20 3d20 7765  Scheduler]] = we
-0001d9a0: 616b 7265 662e 5765 616b 5365 7428 290a  akref.WeakSet().
-0001d9b0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-0001d9c0: 5f28 0a20 2020 2020 2020 2073 656c 662c  _(.        self,
-0001d9d0: 0a20 2020 2020 2020 206c 6f6f 703d 4e6f  .        loop=No
-0001d9e0: 6e65 2c0a 2020 2020 2020 2020 6465 6c65  ne,.        dele
-0001d9f0: 7465 5f69 6e74 6572 7661 6c3d 2235 3030  te_interval="500
-0001da00: 6d73 222c 0a20 2020 2020 2020 2073 796e  ms",.        syn
-0001da10: 6368 726f 6e69 7a65 5f77 6f72 6b65 725f  chronize_worker_
-0001da20: 696e 7465 7276 616c 3d22 3630 7322 2c0a  interval="60s",.
-0001da30: 2020 2020 2020 2020 7365 7276 6963 6573          services
-0001da40: 3d4e 6f6e 652c 0a20 2020 2020 2020 2073  =None,.        s
-0001da50: 6572 7669 6365 5f6b 7761 7267 733d 4e6f  ervice_kwargs=No
-0001da60: 6e65 2c0a 2020 2020 2020 2020 616c 6c6f  ne,.        allo
-0001da70: 7765 645f 6661 696c 7572 6573 3d4e 6f6e  wed_failures=Non
-0001da80: 652c 0a20 2020 2020 2020 2065 7874 656e  e,.        exten
-0001da90: 7369 6f6e 733d 4e6f 6e65 2c0a 2020 2020  sions=None,.    
-0001daa0: 2020 2020 7661 6c69 6461 7465 3d4e 6f6e      validate=Non
-0001dab0: 652c 0a20 2020 2020 2020 2073 6368 6564  e,.        sched
-0001dac0: 756c 6572 5f66 696c 653d 4e6f 6e65 2c0a  uler_file=None,.
-0001dad0: 2020 2020 2020 2020 7365 6375 7269 7479          security
-0001dae0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2077  =None,.        w
-0001daf0: 6f72 6b65 725f 7474 6c3d 4e6f 6e65 2c0a  orker_ttl=None,.
-0001db00: 2020 2020 2020 2020 6964 6c65 5f74 696d          idle_tim
-0001db10: 656f 7574 3d4e 6f6e 652c 0a20 2020 2020  eout=None,.     
-0001db20: 2020 2069 6e74 6572 6661 6365 3d4e 6f6e     interface=Non
-0001db30: 652c 0a20 2020 2020 2020 2068 6f73 743d  e,.        host=
-0001db40: 4e6f 6e65 2c0a 2020 2020 2020 2020 706f  None,.        po
-0001db50: 7274 3d30 2c0a 2020 2020 2020 2020 7072  rt=0,.        pr
-0001db60: 6f74 6f63 6f6c 3d4e 6f6e 652c 0a20 2020  otocol=None,.   
-0001db70: 2020 2020 2064 6173 6862 6f61 7264 5f61       dashboard_a
-0001db80: 6464 7265 7373 3d4e 6f6e 652c 0a20 2020  ddress=None,.   
-0001db90: 2020 2020 2064 6173 6862 6f61 7264 3d4e       dashboard=N
-0001dba0: 6f6e 652c 0a20 2020 2020 2020 2068 7474  one,.        htt
-0001dbb0: 705f 7072 6566 6978 3d22 2f22 2c0a 2020  p_prefix="/",.  
-0001dbc0: 2020 2020 2020 7072 656c 6f61 643d 4e6f        preload=No
-0001dbd0: 6e65 2c0a 2020 2020 2020 2020 7072 656c  ne,.        prel
-0001dbe0: 6f61 645f 6172 6776 3d28 292c 0a20 2020  oad_argv=(),.   
-0001dbf0: 2020 2020 2070 6c75 6769 6e73 3d28 292c       plugins=(),
-0001dc00: 0a20 2020 2020 2020 2063 6f6e 7461 6374  .        contact
-0001dc10: 5f61 6464 7265 7373 3d4e 6f6e 652c 0a20  _address=None,. 
-0001dc20: 2020 2020 2020 2074 7261 6e73 6974 696f         transitio
-0001dc30: 6e5f 636f 756e 7465 725f 6d61 783d 4661  n_counter_max=Fa
-0001dc40: 6c73 652c 0a20 2020 2020 2020 206a 7570  lse,.        jup
-0001dc50: 7974 6572 3d46 616c 7365 2c0a 2020 2020  yter=False,.    
-0001dc60: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
-0001dc70: 2020 293a 0a20 2020 2020 2020 2069 6620    ):.        if 
-0001dc80: 6c6f 6f70 2069 7320 6e6f 7420 4e6f 6e65  loop is not None
-0001dc90: 3a0a 2020 2020 2020 2020 2020 2020 7761  :.            wa
-0001dca0: 726e 696e 6773 2e77 6172 6e28 0a20 2020  rnings.warn(.   
-0001dcb0: 2020 2020 2020 2020 2020 2020 2022 7468               "th
-0001dcc0: 6520 6c6f 6f70 206b 7761 7267 2074 6f20  e loop kwarg to 
-0001dcd0: 5363 6865 6475 6c65 7220 6973 2064 6570  Scheduler is dep
-0001dce0: 7265 6361 7465 6422 2c0a 2020 2020 2020  recated",.      
-0001dcf0: 2020 2020 2020 2020 2020 4465 7072 6563            Deprec
-0001dd00: 6174 696f 6e57 6172 6e69 6e67 2c0a 2020  ationWarning,.  
-0001dd10: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0001dd20: 6163 6b6c 6576 656c 3d32 2c0a 2020 2020  acklevel=2,.    
-0001dd30: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0001dd40: 2020 2073 656c 662e 6c6f 6f70 203d 2073     self.loop = s
-0001dd50: 656c 662e 696f 5f6c 6f6f 7020 3d20 494f  elf.io_loop = IO
-0001dd60: 4c6f 6f70 2e63 7572 7265 6e74 2829 0a20  Loop.current(). 
-0001dd70: 2020 2020 2020 2073 656c 662e 5f73 6574         self._set
-0001dd80: 7570 5f6c 6f67 6769 6e67 286c 6f67 6765  up_logging(logge
-0001dd90: 7229 0a0a 2020 2020 2020 2020 2320 4174  r)..        # At
-0001dda0: 7472 6962 7574 6573 0a20 2020 2020 2020  tributes.       
-0001ddb0: 2069 6620 636f 6e74 6163 745f 6164 6472   if contact_addr
-0001ddc0: 6573 7320 6973 204e 6f6e 653a 0a20 2020  ess is None:.   
-0001ddd0: 2020 2020 2020 2020 2063 6f6e 7461 6374           contact
-0001dde0: 5f61 6464 7265 7373 203d 2064 6173 6b2e  _address = dask.
-0001ddf0: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
-0001de00: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
-0001de10: 722e 636f 6e74 6163 742d 6164 6472 6573  r.contact-addres
-0001de20: 7322 290a 2020 2020 2020 2020 7365 6c66  s").        self
-0001de30: 2e63 6f6e 7461 6374 5f61 6464 7265 7373  .contact_address
-0001de40: 203d 2063 6f6e 7461 6374 5f61 6464 7265   = contact_addre
-0001de50: 7373 0a20 2020 2020 2020 2069 6620 616c  ss.        if al
-0001de60: 6c6f 7765 645f 6661 696c 7572 6573 2069  lowed_failures i
-0001de70: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0001de80: 2020 2020 616c 6c6f 7765 645f 6661 696c      allowed_fail
-0001de90: 7572 6573 203d 2064 6173 6b2e 636f 6e66  ures = dask.conf
-0001dea0: 6967 2e67 6574 2822 6469 7374 7269 6275  ig.get("distribu
-0001deb0: 7465 642e 7363 6865 6475 6c65 722e 616c  ted.scheduler.al
-0001dec0: 6c6f 7765 642d 6661 696c 7572 6573 2229  lowed-failures")
-0001ded0: 0a20 2020 2020 2020 2073 656c 662e 616c  .        self.al
-0001dee0: 6c6f 7765 645f 6661 696c 7572 6573 203d  lowed_failures =
-0001def0: 2061 6c6c 6f77 6564 5f66 6169 6c75 7265   allowed_failure
-0001df00: 730a 2020 2020 2020 2020 6966 2076 616c  s.        if val
-0001df10: 6964 6174 6520 6973 204e 6f6e 653a 0a20  idate is None:. 
-0001df20: 2020 2020 2020 2020 2020 2076 616c 6964             valid
-0001df30: 6174 6520 3d20 6461 736b 2e63 6f6e 6669  ate = dask.confi
-0001df40: 672e 6765 7428 2264 6973 7472 6962 7574  g.get("distribut
-0001df50: 6564 2e73 6368 6564 756c 6572 2e76 616c  ed.scheduler.val
-0001df60: 6964 6174 6522 290a 2020 2020 2020 2020  idate").        
-0001df70: 7365 6c66 2e70 726f 6320 3d20 7073 7574  self.proc = psut
-0001df80: 696c 2e50 726f 6365 7373 2829 0a20 2020  il.Process().   
-0001df90: 2020 2020 2073 656c 662e 6465 6c65 7465       self.delete
-0001dfa0: 5f69 6e74 6572 7661 6c20 3d20 7061 7273  _interval = pars
-0001dfb0: 655f 7469 6d65 6465 6c74 6128 6465 6c65  e_timedelta(dele
-0001dfc0: 7465 5f69 6e74 6572 7661 6c2c 2064 6566  te_interval, def
-0001dfd0: 6175 6c74 3d22 6d73 2229 0a20 2020 2020  ault="ms").     
-0001dfe0: 2020 2073 656c 662e 7379 6e63 6872 6f6e     self.synchron
-0001dff0: 697a 655f 776f 726b 6572 5f69 6e74 6572  ize_worker_inter
-0001e000: 7661 6c20 3d20 7061 7273 655f 7469 6d65  val = parse_time
-0001e010: 6465 6c74 6128 0a20 2020 2020 2020 2020  delta(.         
-0001e020: 2020 2073 796e 6368 726f 6e69 7a65 5f77     synchronize_w
-0001e030: 6f72 6b65 725f 696e 7465 7276 616c 2c20  orker_interval, 
-0001e040: 6465 6661 756c 743d 226d 7322 0a20 2020  default="ms".   
-0001e050: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
-0001e060: 656c 662e 7365 7276 6963 655f 7370 6563  elf.service_spec
-0001e070: 7320 3d20 7365 7276 6963 6573 206f 7220  s = services or 
-0001e080: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
-0001e090: 7365 7276 6963 655f 6b77 6172 6773 203d  service_kwargs =
-0001e0a0: 2073 6572 7669 6365 5f6b 7761 7267 7320   service_kwargs 
-0001e0b0: 6f72 207b 7d0a 2020 2020 2020 2020 7365  or {}.        se
-0001e0c0: 6c66 2e73 6572 7669 6365 7320 3d20 7b7d  lf.services = {}
-0001e0d0: 0a20 2020 2020 2020 2073 656c 662e 7363  .        self.sc
-0001e0e0: 6865 6475 6c65 725f 6669 6c65 203d 2073  heduler_file = s
-0001e0f0: 6368 6564 756c 6572 5f66 696c 650a 2020  cheduler_file.  
-0001e100: 2020 2020 2020 776f 726b 6572 5f74 746c        worker_ttl
-0001e110: 203d 2077 6f72 6b65 725f 7474 6c20 6f72   = worker_ttl or
-0001e120: 2064 6173 6b2e 636f 6e66 6967 2e67 6574   dask.config.get
-0001e130: 2822 6469 7374 7269 6275 7465 642e 7363  ("distributed.sc
-0001e140: 6865 6475 6c65 722e 776f 726b 6572 2d74  heduler.worker-t
-0001e150: 746c 2229 0a20 2020 2020 2020 2073 656c  tl").        sel
-0001e160: 662e 776f 726b 6572 5f74 746c 203d 2070  f.worker_ttl = p
-0001e170: 6172 7365 5f74 696d 6564 656c 7461 2877  arse_timedelta(w
-0001e180: 6f72 6b65 725f 7474 6c29 2069 6620 776f  orker_ttl) if wo
-0001e190: 726b 6572 5f74 746c 2065 6c73 6520 4e6f  rker_ttl else No
-0001e1a0: 6e65 0a20 2020 2020 2020 2069 646c 655f  ne.        idle_
-0001e1b0: 7469 6d65 6f75 7420 3d20 6964 6c65 5f74  timeout = idle_t
-0001e1c0: 696d 656f 7574 206f 7220 6461 736b 2e63  imeout or dask.c
-0001e1d0: 6f6e 6669 672e 6765 7428 0a20 2020 2020  onfig.get(.     
-0001e1e0: 2020 2020 2020 2022 6469 7374 7269 6275         "distribu
-0001e1f0: 7465 642e 7363 6865 6475 6c65 722e 6964  ted.scheduler.id
-0001e200: 6c65 2d74 696d 656f 7574 220a 2020 2020  le-timeout".    
-0001e210: 2020 2020 290a 2020 2020 2020 2020 6966      ).        if
-0001e220: 2069 646c 655f 7469 6d65 6f75 743a 0a20   idle_timeout:. 
-0001e230: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001e240: 6964 6c65 5f74 696d 656f 7574 203d 2070  idle_timeout = p
-0001e250: 6172 7365 5f74 696d 6564 656c 7461 2869  arse_timedelta(i
-0001e260: 646c 655f 7469 6d65 6f75 7429 0a20 2020  dle_timeout).   
-0001e270: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0001e280: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
-0001e290: 5f74 696d 656f 7574 203d 204e 6f6e 650a  _timeout = None.
-0001e2a0: 2020 2020 2020 2020 7365 6c66 2e69 646c          self.idl
-0001e2b0: 655f 7369 6e63 6520 3d20 7469 6d65 2829  e_since = time()
-0001e2c0: 0a20 2020 2020 2020 2073 656c 662e 7469  .        self.ti
-0001e2d0: 6d65 5f73 7461 7274 6564 203d 2073 656c  me_started = sel
-0001e2e0: 662e 6964 6c65 5f73 696e 6365 2020 2320  f.idle_since  # 
-0001e2f0: 636f 6d70 6174 6962 696c 6974 7920 666f  compatibility fo
-0001e300: 7220 6461 736b 2d67 6174 6577 6179 0a20  r dask-gateway. 
-0001e310: 2020 2020 2020 2073 656c 662e 5f6c 6f63         self._loc
-0001e320: 6b20 3d20 6173 796e 6369 6f2e 4c6f 636b  k = asyncio.Lock
-0001e330: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-0001e340: 6261 6e64 7769 6474 685f 776f 726b 6572  bandwidth_worker
-0001e350: 7320 3d20 6465 6661 756c 7464 6963 7428  s = defaultdict(
-0001e360: 666c 6f61 7429 0a20 2020 2020 2020 2073  float).        s
-0001e370: 656c 662e 6261 6e64 7769 6474 685f 7479  elf.bandwidth_ty
-0001e380: 7065 7320 3d20 6465 6661 756c 7464 6963  pes = defaultdic
-0001e390: 7428 666c 6f61 7429 0a0a 2020 2020 2020  t(float)..      
-0001e3a0: 2020 7365 6c66 2e63 756d 756c 6174 6976    self.cumulativ
-0001e3b0: 655f 776f 726b 6572 5f6d 6574 7269 6373  e_worker_metrics
-0001e3c0: 203d 2064 6566 6175 6c74 6469 6374 2866   = defaultdict(f
-0001e3d0: 6c6f 6174 290a 0a20 2020 2020 2020 2069  loat)..        i
-0001e3e0: 6620 6e6f 7420 7072 656c 6f61 643a 0a20  f not preload:. 
-0001e3f0: 2020 2020 2020 2020 2020 2070 7265 6c6f             prelo
-0001e400: 6164 203d 2064 6173 6b2e 636f 6e66 6967  ad = dask.config
-0001e410: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
-0001e420: 642e 7363 6865 6475 6c65 722e 7072 656c  d.scheduler.prel
-0001e430: 6f61 6422 290a 2020 2020 2020 2020 6966  oad").        if
-0001e440: 206e 6f74 2070 7265 6c6f 6164 5f61 7267   not preload_arg
-0001e450: 763a 0a20 2020 2020 2020 2020 2020 2070  v:.            p
-0001e460: 7265 6c6f 6164 5f61 7267 7620 3d20 6461  reload_argv = da
-0001e470: 736b 2e63 6f6e 6669 672e 6765 7428 2264  sk.config.get("d
-0001e480: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
-0001e490: 756c 6572 2e70 7265 6c6f 6164 2d61 7267  uler.preload-arg
-0001e4a0: 7622 290a 2020 2020 2020 2020 7365 6c66  v").        self
-0001e4b0: 2e70 7265 6c6f 6164 7320 3d20 7072 656c  .preloads = prel
-0001e4c0: 6f61 6469 6e67 2e70 726f 6365 7373 5f70  oading.process_p
-0001e4d0: 7265 6c6f 6164 7328 7365 6c66 2c20 7072  reloads(self, pr
-0001e4e0: 656c 6f61 642c 2070 7265 6c6f 6164 5f61  eload, preload_a
-0001e4f0: 7267 7629 0a0a 2020 2020 2020 2020 6966  rgv)..        if
-0001e500: 2069 7369 6e73 7461 6e63 6528 7365 6375   isinstance(secu
-0001e510: 7269 7479 2c20 6469 6374 293a 0a20 2020  rity, dict):.   
-0001e520: 2020 2020 2020 2020 2073 6563 7572 6974           securit
-0001e530: 7920 3d20 5365 6375 7269 7479 282a 2a73  y = Security(**s
-0001e540: 6563 7572 6974 7929 0a20 2020 2020 2020  ecurity).       
-0001e550: 2073 656c 662e 7365 6375 7269 7479 203d   self.security =
-0001e560: 2073 6563 7572 6974 7920 6f72 2053 6563   security or Sec
-0001e570: 7572 6974 7928 290a 2020 2020 2020 2020  urity().        
-0001e580: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
-0001e590: 6528 7365 6c66 2e73 6563 7572 6974 792c  e(self.security,
-0001e5a0: 2053 6563 7572 6974 7929 0a20 2020 2020   Security).     
-0001e5b0: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
-0001e5c0: 6f6e 5f61 7267 7320 3d20 7365 6c66 2e73  on_args = self.s
-0001e5d0: 6563 7572 6974 792e 6765 745f 636f 6e6e  ecurity.get_conn
-0001e5e0: 6563 7469 6f6e 5f61 7267 7328 2273 6368  ection_args("sch
-0001e5f0: 6564 756c 6572 2229 0a20 2020 2020 2020  eduler").       
-0001e600: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-0001e610: 5f61 7267 735b 2268 616e 6473 6861 6b65  _args["handshake
-0001e620: 5f6f 7665 7272 6964 6573 225d 203d 207b  _overrides"] = {
-0001e630: 2020 2320 636f 6d6d 6f6e 2064 656e 6f6d    # common denom
-0001e640: 696e 6174 6f72 0a20 2020 2020 2020 2020  inator.         
-0001e650: 2020 2022 7069 636b 6c65 2d70 726f 746f     "pickle-proto
-0001e660: 636f 6c22 3a20 340a 2020 2020 2020 2020  col": 4.        
-0001e670: 7d0a 0a20 2020 2020 2020 2073 656c 662e  }..        self.
-0001e680: 5f73 7461 7274 5f61 6464 7265 7373 203d  _start_address =
-0001e690: 2061 6464 7265 7373 6573 5f66 726f 6d5f   addresses_from_
-0001e6a0: 7573 6572 5f61 7267 7328 0a20 2020 2020  user_args(.     
-0001e6b0: 2020 2020 2020 2068 6f73 743d 686f 7374         host=host
-0001e6c0: 2c0a 2020 2020 2020 2020 2020 2020 706f  ,.            po
-0001e6d0: 7274 3d70 6f72 742c 0a20 2020 2020 2020  rt=port,.       
-0001e6e0: 2020 2020 2069 6e74 6572 6661 6365 3d69       interface=i
-0001e6f0: 6e74 6572 6661 6365 2c0a 2020 2020 2020  nterface,.      
-0001e700: 2020 2020 2020 7072 6f74 6f63 6f6c 3d70        protocol=p
-0001e710: 726f 746f 636f 6c2c 0a20 2020 2020 2020  rotocol,.       
-0001e720: 2020 2020 2073 6563 7572 6974 793d 7365       security=se
-0001e730: 6375 7269 7479 2c0a 2020 2020 2020 2020  curity,.        
-0001e740: 2020 2020 6465 6661 756c 745f 706f 7274      default_port
-0001e750: 3d73 656c 662e 6465 6661 756c 745f 706f  =self.default_po
-0001e760: 7274 2c0a 2020 2020 2020 2020 290a 0a20  rt,.        ).. 
-0001e770: 2020 2020 2020 2068 7474 705f 7365 7276         http_serv
-0001e780: 6572 5f6d 6f64 756c 6573 203d 2064 6173  er_modules = das
-0001e790: 6b2e 636f 6e66 6967 2e67 6574 2822 6469  k.config.get("di
-0001e7a0: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
-0001e7b0: 6c65 722e 6874 7470 2e72 6f75 7465 7322  ler.http.routes"
-0001e7c0: 290a 2020 2020 2020 2020 7368 6f77 5f64  ).        show_d
-0001e7d0: 6173 6862 6f61 7264 203d 2064 6173 6862  ashboard = dashb
-0001e7e0: 6f61 7264 206f 7220 2864 6173 6862 6f61  oard or (dashboa
-0001e7f0: 7264 2069 7320 4e6f 6e65 2061 6e64 2064  rd is None and d
-0001e800: 6173 6862 6f61 7264 5f61 6464 7265 7373  ashboard_address
-0001e810: 290a 2020 2020 2020 2020 2320 696e 7374  ).        # inst
-0001e820: 616c 6c20 7661 6e69 6c6c 6120 726f 7574  all vanilla rout
-0001e830: 6520 6966 2073 686f 775f 6461 7368 626f  e if show_dashbo
-0001e840: 6172 6420 6275 7420 626f 6b65 6820 6973  ard but bokeh is
-0001e850: 206e 6f74 2069 6e73 7461 6c6c 6564 0a20   not installed. 
-0001e860: 2020 2020 2020 2069 6620 7368 6f77 5f64         if show_d
-0001e870: 6173 6862 6f61 7264 3a0a 2020 2020 2020  ashboard:.      
-0001e880: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0001e890: 2020 2020 2020 2020 2020 2069 6d70 6f72             impor
-0001e8a0: 7420 6469 7374 7269 6275 7465 642e 6461  t distributed.da
-0001e8b0: 7368 626f 6172 642e 7363 6865 6475 6c65  shboard.schedule
-0001e8c0: 720a 2020 2020 2020 2020 2020 2020 6578  r.            ex
-0001e8d0: 6365 7074 2049 6d70 6f72 7445 7272 6f72  cept ImportError
-0001e8e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001e8f0: 2020 7368 6f77 5f64 6173 6862 6f61 7264    show_dashboard
-0001e900: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-0001e910: 2020 2020 2020 2020 2068 7474 705f 7365           http_se
-0001e920: 7276 6572 5f6d 6f64 756c 6573 2e61 7070  rver_modules.app
-0001e930: 656e 6428 2264 6973 7472 6962 7574 6564  end("distributed
-0001e940: 2e68 7474 702e 7363 6865 6475 6c65 722e  .http.scheduler.
-0001e950: 6d69 7373 696e 675f 626f 6b65 6822 290a  missing_bokeh").
-0001e960: 2020 2020 2020 2020 726f 7574 6573 203d          routes =
-0001e970: 2067 6574 5f68 616e 646c 6572 7328 0a20   get_handlers(. 
-0001e980: 2020 2020 2020 2020 2020 2073 6572 7665             serve
-0001e990: 723d 7365 6c66 2c20 6d6f 6475 6c65 733d  r=self, modules=
-0001e9a0: 6874 7470 5f73 6572 7665 725f 6d6f 6475  http_server_modu
-0001e9b0: 6c65 732c 2070 7265 6669 783d 6874 7470  les, prefix=http
-0001e9c0: 5f70 7265 6669 780a 2020 2020 2020 2020  _prefix.        
-0001e9d0: 290a 2020 2020 2020 2020 7365 6c66 2e73  ).        self.s
-0001e9e0: 7461 7274 5f68 7474 705f 7365 7276 6572  tart_http_server
-0001e9f0: 2872 6f75 7465 732c 2064 6173 6862 6f61  (routes, dashboa
-0001ea00: 7264 5f61 6464 7265 7373 2c20 6465 6661  rd_address, defa
-0001ea10: 756c 745f 706f 7274 3d38 3738 3729 0a20  ult_port=8787). 
-0001ea20: 2020 2020 2020 2073 656c 662e 6a75 7079         self.jupy
-0001ea30: 7465 7220 3d20 6a75 7079 7465 720a 2020  ter = jupyter.  
-0001ea40: 2020 2020 2020 6966 2073 686f 775f 6461        if show_da
-0001ea50: 7368 626f 6172 643a 0a20 2020 2020 2020  shboard:.       
-0001ea60: 2020 2020 2064 6973 7472 6962 7574 6564       distributed
-0001ea70: 2e64 6173 6862 6f61 7264 2e73 6368 6564  .dashboard.sched
-0001ea80: 756c 6572 2e63 6f6e 6e65 6374 280a 2020  uler.connect(.  
-0001ea90: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0001eaa0: 6c66 2e68 7474 705f 6170 706c 6963 6174  lf.http_applicat
-0001eab0: 696f 6e2c 2073 656c 662e 6874 7470 5f73  ion, self.http_s
-0001eac0: 6572 7665 722c 2073 656c 662c 2070 7265  erver, self, pre
-0001ead0: 6669 783d 6874 7470 5f70 7265 6669 780a  fix=http_prefix.
-0001eae0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0001eaf0: 2020 2020 2020 6966 2073 656c 662e 6a75        if self.ju
-0001eb00: 7079 7465 723a 0a20 2020 2020 2020 2020  pyter:.         
-0001eb10: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0001eb20: 2020 2020 2020 2020 6672 6f6d 206a 7570          from jup
-0001eb30: 7974 6572 5f73 6572 7665 722e 7365 7276  yter_server.serv
-0001eb40: 6572 6170 7020 696d 706f 7274 2053 6572  erapp import Ser
-0001eb50: 7665 7241 7070 0a20 2020 2020 2020 2020  verApp.         
-0001eb60: 2020 2065 7863 6570 7420 496d 706f 7274     except Import
-0001eb70: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-0001eb80: 2020 2020 2020 2072 6169 7365 2049 6d70         raise Imp
-0001eb90: 6f72 7445 7272 6f72 280a 2020 2020 2020  ortError(.      
-0001eba0: 2020 2020 2020 2020 2020 2020 2020 2249                "I
-0001ebb0: 6e20 6f72 6465 7220 746f 2075 7365 2074  n order to use t
-0001ebc0: 6865 2044 6173 6b20 6a75 7079 7465 7220  he Dask jupyter 
-0001ebd0: 6f70 7469 6f6e 2079 6f75 2022 0a20 2020  option you ".   
-0001ebe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ebf0: 2022 6e65 6564 2074 6f20 6861 7665 206a   "need to have j
-0001ec00: 7570 7974 6572 6c61 6220 696e 7374 616c  upyterlab instal
-0001ec10: 6c65 6422 0a20 2020 2020 2020 2020 2020  led".           
-0001ec20: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0001ec30: 2020 2066 726f 6d20 7472 6169 746c 6574     from traitlet
-0001ec40: 732e 636f 6e66 6967 2069 6d70 6f72 7420  s.config import 
-0001ec50: 436f 6e66 6967 0a0a 2020 2020 2020 2020  Config..        
-0001ec60: 2020 2020 6a20 3d20 5365 7276 6572 4170      j = ServerAp
-0001ec70: 702e 696e 7374 616e 6365 280a 2020 2020  p.instance(.    
-0001ec80: 2020 2020 2020 2020 2020 2020 636f 6e66              conf
-0001ec90: 6967 3d43 6f6e 6669 6728 0a20 2020 2020  ig=Config(.     
-0001eca0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-0001ecb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ecc0: 2020 2020 2020 2020 2022 5365 7276 6572           "Server
-0001ecd0: 4170 7022 3a20 7b0a 2020 2020 2020 2020  App": {.        
+0001c420: 6173 7365 7274 2064 7473 2069 7320 6e6f  assert dts is no
+0001c430: 7420 7473 0a20 2020 2020 2020 2020 2020  t ts.           
+0001c440: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+0001c450: 696f 6e73 5b64 7473 2e6b 6579 5d20 3d20  ions[dts.key] = 
+0001c460: 2266 6f72 676f 7474 656e 220a 2020 2020  "forgotten".    
+0001c470: 2020 2020 7473 2e64 6570 656e 6465 6e63      ts.dependenc
+0001c480: 6965 732e 636c 6561 7228 290a 2020 2020  ies.clear().    
+0001c490: 2020 2020 7473 2e77 6169 7469 6e67 5f6f      ts.waiting_o
+0001c4a0: 6e2e 636c 6561 7228 290a 0a20 2020 2020  n.clear()..     
+0001c4b0: 2020 2066 6f72 2077 7320 696e 2074 732e     for ws in ts.
+0001c4c0: 7768 6f5f 6861 733a 0a20 2020 2020 2020  who_has:.       
+0001c4d0: 2020 2020 2069 6620 7773 2e61 6464 7265       if ws.addre
+0001c4e0: 7373 2069 6e20 7365 6c66 2e77 6f72 6b65  ss in self.worke
+0001c4f0: 7273 3a20 2023 2069 6e20 6361 7365 2077  rs:  # in case w
+0001c500: 6f72 6b65 7220 6861 7320 6469 6564 0a20  orker has died. 
+0001c510: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0001c520: 6f72 6b65 725f 6d73 6773 5b77 732e 6164  orker_msgs[ws.ad
+0001c530: 6472 6573 735d 203d 205b 0a20 2020 2020  dress] = [.     
+0001c540: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+0001c550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c560: 2020 2020 2020 2020 2022 6f70 223a 2022           "op": "
+0001c570: 6672 6565 2d6b 6579 7322 2c0a 2020 2020  free-keys",.    
+0001c580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c590: 2020 2020 226b 6579 7322 3a20 5b74 732e      "keys": [ts.
+0001c5a0: 6b65 795d 2c0a 2020 2020 2020 2020 2020  key],.          
+0001c5b0: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+0001c5c0: 7469 6d75 6c75 735f 6964 223a 2073 7469  timulus_id": sti
+0001c5d0: 6d75 6c75 735f 6964 2c0a 2020 2020 2020  mulus_id,.      
+0001c5e0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0001c5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c600: 5d0a 2020 2020 2020 2020 7365 6c66 2e72  ].        self.r
+0001c610: 656d 6f76 655f 616c 6c5f 7265 706c 6963  emove_all_replic
+0001c620: 6173 2874 7329 0a0a 2020 2020 6465 6620  as(ts)..    def 
+0001c630: 5f63 6c69 656e 745f 7265 6c65 6173 6573  _client_releases
+0001c640: 5f6b 6579 7328 0a20 2020 2020 2020 2073  _keys(.        s
+0001c650: 656c 662c 0a20 2020 2020 2020 206b 6579  elf,.        key
+0001c660: 733a 2043 6f6c 6c65 6374 696f 6e5b 7374  s: Collection[st
+0001c670: 725d 2c0a 2020 2020 2020 2020 6373 3a20  r],.        cs: 
+0001c680: 436c 6965 6e74 5374 6174 652c 0a20 2020  ClientState,.   
+0001c690: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+0001c6a0: 696f 6e73 3a20 5265 6373 2c0a 2020 2020  ions: Recs,.    
+0001c6b0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0001c6c0: 2020 2022 2222 5265 6d6f 7665 206b 6579     """Remove key
+0001c6d0: 7320 6672 6f6d 2063 6c69 656e 7420 6465  s from client de
+0001c6e0: 7369 7265 6420 6c69 7374 2222 220a 2020  sired list""".  
+0001c6f0: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
+0001c700: 7567 2822 436c 6965 6e74 2025 7320 7265  ug("Client %s re
+0001c710: 6c65 6173 6573 206b 6579 733a 2025 7322  leases keys: %s"
+0001c720: 2c20 6373 2e63 6c69 656e 745f 6b65 792c  , cs.client_key,
+0001c730: 206b 6579 7329 0a20 2020 2020 2020 2066   keys).        f
+0001c740: 6f72 206b 6579 2069 6e20 6b65 7973 3a0a  or key in keys:.
+0001c750: 2020 2020 2020 2020 2020 2020 7473 203d              ts =
+0001c760: 2073 656c 662e 7461 736b 732e 6765 7428   self.tasks.get(
+0001c770: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
+0001c780: 2069 6620 7473 2069 7320 6e6f 7420 4e6f   if ts is not No
+0001c790: 6e65 2061 6e64 2074 7320 696e 2063 732e  ne and ts in cs.
+0001c7a0: 7761 6e74 735f 7768 6174 3a0a 2020 2020  wants_what:.    
+0001c7b0: 2020 2020 2020 2020 2020 2020 6373 2e77              cs.w
+0001c7c0: 616e 7473 5f77 6861 742e 7265 6d6f 7665  ants_what.remove
+0001c7d0: 2874 7329 0a20 2020 2020 2020 2020 2020  (ts).           
+0001c7e0: 2020 2020 2074 732e 7768 6f5f 7761 6e74       ts.who_want
+0001c7f0: 732e 7265 6d6f 7665 2863 7329 0a20 2020  s.remove(cs).   
+0001c800: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001c810: 6e6f 7420 7473 2e77 686f 5f77 616e 7473  not ts.who_wants
+0001c820: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001c830: 2020 2020 2020 6966 206e 6f74 2074 732e        if not ts.
+0001c840: 6465 7065 6e64 656e 7473 3a0a 2020 2020  dependents:.    
+0001c850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c860: 2020 2020 2320 4e6f 206c 6976 6520 6465      # No live de
+0001c870: 7065 6e64 656e 7473 2c20 6361 6e20 666f  pendents, can fo
+0001c880: 7267 6574 0a20 2020 2020 2020 2020 2020  rget.           
+0001c890: 2020 2020 2020 2020 2020 2020 2072 6563               rec
+0001c8a0: 6f6d 6d65 6e64 6174 696f 6e73 5b74 732e  ommendations[ts.
+0001c8b0: 6b65 795d 203d 2022 666f 7267 6f74 7465  key] = "forgotte
+0001c8c0: 6e22 0a20 2020 2020 2020 2020 2020 2020  n".             
+0001c8d0: 2020 2020 2020 2065 6c69 6620 7473 2e73         elif ts.s
+0001c8e0: 7461 7465 2021 3d20 2265 7272 6564 2220  tate != "erred" 
+0001c8f0: 616e 6420 6e6f 7420 7473 2e77 6169 7465  and not ts.waite
+0001c900: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
+0001c910: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+0001c920: 6d6d 656e 6461 7469 6f6e 735b 7473 2e6b  mmendations[ts.k
+0001c930: 6579 5d20 3d20 2272 656c 6561 7365 6422  ey] = "released"
+0001c940: 0a0a 2020 2020 6465 6620 5f74 6173 6b5f  ..    def _task_
+0001c950: 746f 5f6d 7367 2873 656c 662c 2074 733a  to_msg(self, ts:
+0001c960: 2054 6173 6b53 7461 7465 2c20 6475 7261   TaskState, dura
+0001c970: 7469 6f6e 3a20 666c 6f61 7420 3d20 2d31  tion: float = -1
+0001c980: 2920 2d3e 2064 6963 745b 7374 722c 2041  ) -> dict[str, A
+0001c990: 6e79 5d3a 0a20 2020 2020 2020 2022 2222  ny]:.        """
+0001c9a0: 436f 6e76 6572 7420 6120 7369 6e67 6c65  Convert a single
+0001c9b0: 2063 6f6d 7075 7461 7469 6f6e 616c 2074   computational t
+0001c9c0: 6173 6b20 746f 2061 206d 6573 7361 6765  ask to a message
+0001c9d0: 2222 220a 2020 2020 2020 2020 2320 4649  """.        # FI
+0001c9e0: 584d 453a 2054 6865 2064 7572 6174 696f  XME: The duratio
+0001c9f0: 6e20 6174 7472 6962 7574 6520 6973 206e  n attribute is n
+0001ca00: 6f74 2075 7365 6420 6f6e 2077 6f72 6b65  ot used on worke
+0001ca10: 722e 2057 6520 636f 756c 6420 7361 7665  r. We could save
+0001ca20: 206f 7572 7365 6c76 6573 2074 6865 0a20   ourselves the. 
+0001ca30: 2020 2020 2020 2023 2020 2020 2020 2020         #        
+0001ca40: 7469 6d65 2074 6f20 636f 6d70 7574 6520  time to compute 
+0001ca50: 616e 6420 7375 626d 6974 2074 6869 730a  and submit this.
+0001ca60: 2020 2020 2020 2020 6966 2064 7572 6174          if durat
+0001ca70: 696f 6e20 3c20 303a 0a20 2020 2020 2020  ion < 0:.       
+0001ca80: 2020 2020 2064 7572 6174 696f 6e20 3d20       duration = 
+0001ca90: 7365 6c66 2e67 6574 5f74 6173 6b5f 6475  self.get_task_du
+0001caa0: 7261 7469 6f6e 2874 7329 0a20 2020 2020  ration(ts).     
+0001cab0: 2020 2074 732e 7275 6e5f 6964 203d 206e     ts.run_id = n
+0001cac0: 6578 7428 5461 736b 5374 6174 652e 5f72  ext(TaskState._r
+0001cad0: 756e 5f69 645f 6974 6572 6174 6f72 290a  un_id_iterator).
+0001cae0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+0001caf0: 732e 7072 696f 7269 7479 2c20 7473 0a20  s.priority, ts. 
+0001cb00: 2020 2020 2020 206d 7367 3a20 6469 6374         msg: dict
+0001cb10: 5b73 7472 2c20 416e 795d 203d 207b 0a20  [str, Any] = {. 
+0001cb20: 2020 2020 2020 2020 2020 2022 6f70 223a             "op":
+0001cb30: 2022 636f 6d70 7574 652d 7461 736b 222c   "compute-task",
+0001cb40: 0a20 2020 2020 2020 2020 2020 2022 6b65  .            "ke
+0001cb50: 7922 3a20 7473 2e6b 6579 2c0a 2020 2020  y": ts.key,.    
+0001cb60: 2020 2020 2020 2020 2272 756e 5f69 6422          "run_id"
+0001cb70: 3a20 7473 2e72 756e 5f69 642c 0a20 2020  : ts.run_id,.   
+0001cb80: 2020 2020 2020 2020 2022 7072 696f 7269           "priori
+0001cb90: 7479 223a 2074 732e 7072 696f 7269 7479  ty": ts.priority
+0001cba0: 2c0a 2020 2020 2020 2020 2020 2020 2264  ,.            "d
+0001cbb0: 7572 6174 696f 6e22 3a20 6475 7261 7469  uration": durati
+0001cbc0: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
+0001cbd0: 2273 7469 6d75 6c75 735f 6964 223a 2066  "stimulus_id": f
+0001cbe0: 2263 6f6d 7075 7465 2d74 6173 6b2d 7b74  "compute-task-{t
+0001cbf0: 696d 6528 297d 222c 0a20 2020 2020 2020  ime()}",.       
+0001cc00: 2020 2020 2022 7768 6f5f 6861 7322 3a20       "who_has": 
+0001cc10: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0001cc20: 2020 6474 732e 6b65 793a 205b 7773 2e61    dts.key: [ws.a
+0001cc30: 6464 7265 7373 2066 6f72 2077 7320 696e  ddress for ws in
+0001cc40: 2064 7473 2e77 686f 5f68 6173 5d20 666f   dts.who_has] fo
+0001cc50: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
+0001cc60: 6e64 656e 6369 6573 0a20 2020 2020 2020  ndencies.       
+0001cc70: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+0001cc80: 2020 2020 226e 6279 7465 7322 3a20 7b64      "nbytes": {d
+0001cc90: 7473 2e6b 6579 3a20 6474 732e 6e62 7974  ts.key: dts.nbyt
+0001cca0: 6573 2066 6f72 2064 7473 2069 6e20 7473  es for dts in ts
+0001ccb0: 2e64 6570 656e 6465 6e63 6965 737d 2c0a  .dependencies},.
+0001ccc0: 2020 2020 2020 2020 2020 2020 2272 756e              "run
+0001ccd0: 5f73 7065 6322 3a20 4e6f 6e65 2c0a 2020  _spec": None,.  
+0001cce0: 2020 2020 2020 2020 2020 2266 756e 6374            "funct
+0001ccf0: 696f 6e22 3a20 4e6f 6e65 2c0a 2020 2020  ion": None,.    
+0001cd00: 2020 2020 2020 2020 2261 7267 7322 3a20          "args": 
+0001cd10: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+0001cd20: 2020 226b 7761 7267 7322 3a20 4e6f 6e65    "kwargs": None
+0001cd30: 2c0a 2020 2020 2020 2020 2020 2020 2272  ,.            "r
+0001cd40: 6573 6f75 7263 655f 7265 7374 7269 6374  esource_restrict
+0001cd50: 696f 6e73 223a 2074 732e 7265 736f 7572  ions": ts.resour
+0001cd60: 6365 5f72 6573 7472 6963 7469 6f6e 732c  ce_restrictions,
+0001cd70: 0a20 2020 2020 2020 2020 2020 2022 6163  .            "ac
+0001cd80: 746f 7222 3a20 7473 2e61 6374 6f72 2c0a  tor": ts.actor,.
+0001cd90: 2020 2020 2020 2020 2020 2020 2261 6e6e              "ann
+0001cda0: 6f74 6174 696f 6e73 223a 2074 732e 616e  otations": ts.an
+0001cdb0: 6e6f 7461 7469 6f6e 732c 0a20 2020 2020  notations,.     
+0001cdc0: 2020 2020 2020 2022 7370 616e 5f69 6422         "span_id"
+0001cdd0: 3a20 7473 2e67 726f 7570 2e73 7061 6e5f  : ts.group.span_
+0001cde0: 6964 2c0a 2020 2020 2020 2020 7d0a 2020  id,.        }.  
+0001cdf0: 2020 2020 2020 6966 2073 656c 662e 7661        if self.va
+0001ce00: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
+0001ce10: 2020 2020 6173 7365 7274 2061 6c6c 286d      assert all(m
+0001ce20: 7367 5b22 7768 6f5f 6861 7322 5d2e 7661  sg["who_has"].va
+0001ce30: 6c75 6573 2829 290a 0a20 2020 2020 2020  lues())..       
+0001ce40: 2069 6620 6973 696e 7374 616e 6365 2874   if isinstance(t
+0001ce50: 732e 7275 6e5f 7370 6563 2c20 6469 6374  s.run_spec, dict
+0001ce60: 293a 0a20 2020 2020 2020 2020 2020 206d  ):.            m
+0001ce70: 7367 2e75 7064 6174 6528 7473 2e72 756e  sg.update(ts.run
+0001ce80: 5f73 7065 6329 0a20 2020 2020 2020 2065  _spec).        e
+0001ce90: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001cea0: 206d 7367 5b22 7275 6e5f 7370 6563 225d   msg["run_spec"]
+0001ceb0: 203d 2074 732e 7275 6e5f 7370 6563 0a0a   = ts.run_spec..
+0001cec0: 2020 2020 2020 2020 7265 7475 726e 206d          return m
+0001ced0: 7367 0a0a 0a63 6c61 7373 2053 6368 6564  sg...class Sched
+0001cee0: 756c 6572 2853 6368 6564 756c 6572 5374  uler(SchedulerSt
+0001cef0: 6174 652c 2053 6572 7665 724e 6f64 6529  ate, ServerNode)
+0001cf00: 3a0a 2020 2020 2222 2244 796e 616d 6963  :.    """Dynamic
+0001cf10: 2064 6973 7472 6962 7574 6564 2074 6173   distributed tas
+0001cf20: 6b20 7363 6865 6475 6c65 720a 0a20 2020  k scheduler..   
+0001cf30: 2054 6865 2073 6368 6564 756c 6572 2074   The scheduler t
+0001cf40: 7261 636b 7320 7468 6520 6375 7272 656e  racks the curren
+0001cf50: 7420 7374 6174 6520 6f66 2077 6f72 6b65  t state of worke
+0001cf60: 7273 2c20 6461 7461 2c20 616e 6420 636f  rs, data, and co
+0001cf70: 6d70 7574 6174 696f 6e73 2e0a 2020 2020  mputations..    
+0001cf80: 5468 6520 7363 6865 6475 6c65 7220 6c69  The scheduler li
+0001cf90: 7374 656e 7320 666f 7220 6576 656e 7473  stens for events
+0001cfa0: 2061 6e64 2072 6573 706f 6e64 7320 6279   and responds by
+0001cfb0: 2063 6f6e 7472 6f6c 6c69 6e67 2077 6f72   controlling wor
+0001cfc0: 6b65 7273 0a20 2020 2061 7070 726f 7072  kers.    appropr
+0001cfd0: 6961 7465 6c79 2e20 2049 7420 636f 6e74  iately.  It cont
+0001cfe0: 696e 756f 7573 6c79 2074 7269 6573 2074  inuously tries t
+0001cff0: 6f20 7573 6520 7468 6520 776f 726b 6572  o use the worker
+0001d000: 7320 746f 2065 7865 6375 7465 2061 6e20  s to execute an 
+0001d010: 6576 6572 0a20 2020 2067 726f 7769 6e67  ever.    growing
+0001d020: 2064 6173 6b20 6772 6170 682e 0a0a 2020   dask graph...  
+0001d030: 2020 416c 6c20 6576 656e 7473 2061 7265    All events are
+0001d040: 2068 616e 646c 6564 2071 7569 636b 6c79   handled quickly
+0001d050: 2c20 696e 206c 696e 6561 7220 7469 6d65  , in linear time
+0001d060: 2077 6974 6820 7265 7370 6563 7420 746f   with respect to
+0001d070: 2074 6865 6972 2069 6e70 7574 0a20 2020   their input.   
+0001d080: 2028 7768 6963 6820 6973 206f 6674 656e   (which is often
+0001d090: 206f 6620 636f 6e73 7461 6e74 2073 697a   of constant siz
+0001d0a0: 6529 2061 6e64 2067 656e 6572 616c 6c79  e) and generally
+0001d0b0: 2077 6974 6869 6e20 6120 6d69 6c6c 6973   within a millis
+0001d0c0: 6563 6f6e 642e 2020 546f 0a20 2020 2061  econd.  To.    a
+0001d0d0: 6363 6f6d 706c 6973 6820 7468 6973 2074  ccomplish this t
+0001d0e0: 6865 2073 6368 6564 756c 6572 2074 7261  he scheduler tra
+0001d0f0: 636b 7320 6120 6c6f 7420 6f66 2073 7461  cks a lot of sta
+0001d100: 7465 2e20 2045 7665 7279 206f 7065 7261  te.  Every opera
+0001d110: 7469 6f6e 0a20 2020 206d 6169 6e74 6169  tion.    maintai
+0001d120: 6e73 2074 6865 2063 6f6e 7369 7374 656e  ns the consisten
+0001d130: 6379 206f 6620 7468 6973 2073 7461 7465  cy of this state
+0001d140: 2e0a 0a20 2020 2054 6865 2073 6368 6564  ...    The sched
+0001d150: 756c 6572 2063 6f6d 6d75 6e69 6361 7465  uler communicate
+0001d160: 7320 7769 7468 2074 6865 206f 7574 7369  s with the outsi
+0001d170: 6465 2077 6f72 6c64 2074 6872 6f75 6768  de world through
+0001d180: 2043 6f6d 6d20 6f62 6a65 6374 732e 0a20   Comm objects.. 
+0001d190: 2020 2049 7420 6d61 696e 7461 696e 7320     It maintains 
+0001d1a0: 6120 636f 6e73 6973 7465 6e74 2061 6e64  a consistent and
+0001d1b0: 2076 616c 6964 2076 6965 7720 6f66 2074   valid view of t
+0001d1c0: 6865 2077 6f72 6c64 2065 7665 6e20 7768  he world even wh
+0001d1d0: 656e 206c 6973 7465 6e69 6e67 0a20 2020  en listening.   
+0001d1e0: 2074 6f20 7365 7665 7261 6c20 636c 6965   to several clie
+0001d1f0: 6e74 7320 6174 206f 6e63 652e 0a0a 2020  nts at once...  
+0001d200: 2020 4120 5363 6865 6475 6c65 7220 6973    A Scheduler is
+0001d210: 2074 7970 6963 616c 6c79 2073 7461 7274   typically start
+0001d220: 6564 2065 6974 6865 7220 7769 7468 2074  ed either with t
+0001d230: 6865 2060 6064 6173 6b20 7363 6865 6475  he ``dask schedu
+0001d240: 6c65 7260 600a 2020 2020 6578 6563 7574  ler``.    execut
+0001d250: 6162 6c65 3a3a 0a0a 2020 2020 2020 2020  able::..        
+0001d260: 2024 2064 6173 6b20 7363 6865 6475 6c65   $ dask schedule
+0001d270: 720a 2020 2020 2020 2020 2053 6368 6564  r.         Sched
+0001d280: 756c 6572 2073 7461 7274 6564 2061 7420  uler started at 
+0001d290: 3132 372e 302e 302e 313a 3837 3836 0a0a  127.0.0.1:8786..
+0001d2a0: 2020 2020 4f72 2077 6974 6869 6e20 6120      Or within a 
+0001d2b0: 4c6f 6361 6c43 6c75 7374 6572 2061 2043  LocalCluster a C
+0001d2c0: 6c69 656e 7420 7374 6172 7473 2075 7020  lient starts up 
+0001d2d0: 7769 7468 6f75 7420 636f 6e6e 6563 7469  without connecti
+0001d2e0: 6f6e 0a20 2020 2069 6e66 6f72 6d61 7469  on.    informati
+0001d2f0: 6f6e 3a3a 0a0a 2020 2020 2020 2020 3e3e  on::..        >>
+0001d300: 3e20 6320 3d20 436c 6965 6e74 2829 2020  > c = Client()  
+0001d310: 2320 646f 6374 6573 743a 202b 534b 4950  # doctest: +SKIP
+0001d320: 0a20 2020 2020 2020 203e 3e3e 2063 2e63  .        >>> c.c
+0001d330: 6c75 7374 6572 2e73 6368 6564 756c 6572  luster.scheduler
+0001d340: 2020 2320 646f 6374 6573 743a 202b 534b    # doctest: +SK
+0001d350: 4950 0a20 2020 2020 2020 2053 6368 6564  IP.        Sched
+0001d360: 756c 6572 282e 2e2e 290a 0a20 2020 2055  uler(...)..    U
+0001d370: 7365 7273 2074 7970 6963 616c 6c79 2064  sers typically d
+0001d380: 6f20 6e6f 7420 696e 7465 7261 6374 2077  o not interact w
+0001d390: 6974 6820 7468 6520 7363 6865 6475 6c65  ith the schedule
+0001d3a0: 7220 6469 7265 6374 6c79 2062 7574 2072  r directly but r
+0001d3b0: 6174 6865 7220 7769 7468 0a20 2020 2074  ather with.    t
+0001d3c0: 6865 2063 6c69 656e 7420 6f62 6a65 6374  he client object
+0001d3d0: 2060 6043 6c69 656e 7460 602e 0a0a 2020   ``Client``...  
+0001d3e0: 2020 5468 6520 6060 636f 6e74 6163 745f    The ``contact_
+0001d3f0: 6164 6472 6573 7360 6020 7061 7261 6d65  address`` parame
+0001d400: 7465 7220 616c 6c6f 7773 2074 6f20 6164  ter allows to ad
+0001d410: 7665 7274 6973 6520 6120 7370 6563 6966  vertise a specif
+0001d420: 6963 2061 6464 7265 7373 2074 6f0a 2020  ic address to.  
+0001d430: 2020 7468 6520 776f 726b 6572 7320 666f    the workers fo
+0001d440: 7220 636f 6d6d 756e 6963 6174 696f 6e20  r communication 
+0001d450: 7769 7468 2074 6865 2073 6368 6564 756c  with the schedul
+0001d460: 6572 2c20 7768 6963 6820 6973 2064 6966  er, which is dif
+0001d470: 6665 7265 6e74 2074 6861 6e0a 2020 2020  ferent than.    
+0001d480: 7468 6520 6164 6472 6573 7320 7468 6520  the address the 
+0001d490: 7363 6865 6475 6c65 7220 6269 6e64 7320  scheduler binds 
+0001d4a0: 746f 2e20 5468 6973 2069 7320 7573 6566  to. This is usef
+0001d4b0: 756c 2077 6865 6e20 7468 6520 7363 6865  ul when the sche
+0001d4c0: 6475 6c65 720a 2020 2020 6c69 7374 656e  duler.    listen
+0001d4d0: 7320 6f6e 2061 2070 7269 7661 7465 2061  s on a private a
+0001d4e0: 6464 7265 7373 2c20 7768 6963 6820 7468  ddress, which th
+0001d4f0: 6572 6566 6f72 6520 6361 6e6e 6f74 2062  erefore cannot b
+0001d500: 6520 7573 6564 2062 7920 7468 6520 776f  e used by the wo
+0001d510: 726b 6572 730a 2020 2020 746f 2063 6f6e  rkers.    to con
+0001d520: 7461 6374 2069 742e 0a0a 2020 2020 2a2a  tact it...    **
+0001d530: 5374 6174 652a 2a0a 0a20 2020 2054 6865  State**..    The
+0001d540: 2073 6368 6564 756c 6572 2063 6f6e 7461   scheduler conta
+0001d550: 696e 7320 7468 6520 666f 6c6c 6f77 696e  ins the followin
+0001d560: 6720 7374 6174 6520 7661 7269 6162 6c65  g state variable
+0001d570: 732e 2020 4561 6368 2076 6172 6961 626c  s.  Each variabl
+0001d580: 6520 6973 0a20 2020 206c 6973 7465 6420  e is.    listed 
+0001d590: 616c 6f6e 6720 7769 7468 2077 6861 7420  along with what 
+0001d5a0: 6974 2073 746f 7265 7320 616e 6420 6120  it stores and a 
+0001d5b0: 6272 6965 6620 6465 7363 7269 7074 696f  brief descriptio
+0001d5c0: 6e2e 0a0a 2020 2020 2a20 2a2a 7461 736b  n...    * **task
+0001d5d0: 733a 2a2a 2060 607b 7461 736b 206b 6579  s:** ``{task key
+0001d5e0: 3a20 5461 736b 5374 6174 657d 6060 0a20  : TaskState}``. 
+0001d5f0: 2020 2020 2020 2054 6173 6b73 2063 7572         Tasks cur
+0001d600: 7265 6e74 6c79 206b 6e6f 776e 2074 6f20  rently known to 
+0001d610: 7468 6520 7363 6865 6475 6c65 720a 2020  the scheduler.  
+0001d620: 2020 2a20 2a2a 756e 7275 6e6e 6162 6c65    * **unrunnable
+0001d630: 3a2a 2a20 6060 7b54 6173 6b53 7461 7465  :** ``{TaskState
+0001d640: 7d60 600a 2020 2020 2020 2020 5461 736b  }``.        Task
+0001d650: 7320 696e 2074 6865 2022 6e6f 2d77 6f72  s in the "no-wor
+0001d660: 6b65 7222 2073 7461 7465 0a0a 2020 2020  ker" state..    
+0001d670: 2a20 2a2a 776f 726b 6572 733a 2a2a 2060  * **workers:** `
+0001d680: 607b 776f 726b 6572 206b 6579 3a20 576f  `{worker key: Wo
+0001d690: 726b 6572 5374 6174 657d 6060 0a20 2020  rkerState}``.   
+0001d6a0: 2020 2020 2057 6f72 6b65 7273 2063 7572       Workers cur
+0001d6b0: 7265 6e74 6c79 2063 6f6e 6e65 6374 6564  rently connected
+0001d6c0: 2074 6f20 7468 6520 7363 6865 6475 6c65   to the schedule
+0001d6d0: 720a 2020 2020 2a20 2a2a 6964 6c65 3a2a  r.    * **idle:*
+0001d6e0: 2a20 6060 7b57 6f72 6b65 7253 7461 7465  * ``{WorkerState
+0001d6f0: 7d60 603a 0a20 2020 2020 2020 2053 6574  }``:.        Set
+0001d700: 206f 6620 776f 726b 6572 7320 7468 6174   of workers that
+0001d710: 2061 7265 206e 6f74 2066 756c 6c79 2075   are not fully u
+0001d720: 7469 6c69 7a65 640a 2020 2020 2a20 2a2a  tilized.    * **
+0001d730: 7361 7475 7261 7465 643a 2a2a 2060 607b  saturated:** ``{
+0001d740: 576f 726b 6572 5374 6174 657d 6060 3a0a  WorkerState}``:.
+0001d750: 2020 2020 2020 2020 5365 7420 6f66 2077          Set of w
+0001d760: 6f72 6b65 7273 2074 6861 7420 6172 6520  orkers that are 
+0001d770: 6e6f 7420 6f76 6572 2d75 7469 6c69 7a65  not over-utilize
+0001d780: 640a 0a20 2020 202a 202a 2a68 6f73 745f  d..    * **host_
+0001d790: 696e 666f 3a2a 2a20 6060 7b68 6f73 746e  info:** ``{hostn
+0001d7a0: 616d 653a 2064 6963 747d 6060 3a0a 2020  ame: dict}``:.  
+0001d7b0: 2020 2020 2020 496e 666f 726d 6174 696f        Informatio
+0001d7c0: 6e20 6162 6f75 7420 6561 6368 2077 6f72  n about each wor
+0001d7d0: 6b65 7220 686f 7374 0a0a 2020 2020 2a20  ker host..    * 
+0001d7e0: 2a2a 636c 6965 6e74 733a 2a2a 2060 607b  **clients:** ``{
+0001d7f0: 636c 6965 6e74 206b 6579 3a20 436c 6965  client key: Clie
+0001d800: 6e74 5374 6174 657d 6060 0a20 2020 2020  ntState}``.     
+0001d810: 2020 2043 6c69 656e 7473 2063 7572 7265     Clients curre
+0001d820: 6e74 6c79 2063 6f6e 6e65 6374 6564 2074  ntly connected t
+0001d830: 6f20 7468 6520 7363 6865 6475 6c65 720a  o the scheduler.
+0001d840: 0a20 2020 202a 202a 2a73 6572 7669 6365  .    * **service
+0001d850: 733a 2a2a 2060 607b 7374 723a 2070 6f72  s:** ``{str: por
+0001d860: 747d 6060 3a0a 2020 2020 2020 2020 4f74  t}``:.        Ot
+0001d870: 6865 7220 7365 7276 6963 6573 2072 756e  her services run
+0001d880: 6e69 6e67 206f 6e20 7468 6973 2073 6368  ning on this sch
+0001d890: 6564 756c 6572 2c20 6c69 6b65 2042 6f6b  eduler, like Bok
+0001d8a0: 6568 0a20 2020 202a 202a 2a6c 6f6f 703a  eh.    * **loop:
+0001d8b0: 2a2a 2060 6049 4f4c 6f6f 7060 603a 0a20  ** ``IOLoop``:. 
+0001d8c0: 2020 2020 2020 2054 6865 2072 756e 6e69         The runni
+0001d8d0: 6e67 2054 6f72 6e61 646f 2049 4f4c 6f6f  ng Tornado IOLoo
+0001d8e0: 700a 2020 2020 2a20 2a2a 636c 6965 6e74  p.    * **client
+0001d8f0: 5f63 6f6d 6d73 3a2a 2a20 6060 7b63 6c69  _comms:** ``{cli
+0001d900: 656e 7420 6b65 793a 2043 6f6d 6d7d 6060  ent key: Comm}``
+0001d910: 0a20 2020 2020 2020 2046 6f72 2065 6163  .        For eac
+0001d920: 6820 636c 6965 6e74 2c20 6120 436f 6d6d  h client, a Comm
+0001d930: 206f 626a 6563 7420 7573 6564 2074 6f20   object used to 
+0001d940: 7265 6365 6976 6520 7461 736b 2072 6571  receive task req
+0001d950: 7565 7374 7320 616e 640a 2020 2020 2020  uests and.      
+0001d960: 2020 7265 706f 7274 2074 6173 6b20 7374    report task st
+0001d970: 6174 7573 2075 7064 6174 6573 2e0a 2020  atus updates..  
+0001d980: 2020 2a20 2a2a 7374 7265 616d 5f63 6f6d    * **stream_com
+0001d990: 6d73 3a2a 2a20 6060 7b77 6f72 6b65 7220  ms:** ``{worker 
+0001d9a0: 6b65 793a 2043 6f6d 6d7d 6060 0a20 2020  key: Comm}``.   
+0001d9b0: 2020 2020 2046 6f72 2065 6163 6820 776f       For each wo
+0001d9c0: 726b 6572 2c20 6120 436f 6d6d 206f 626a  rker, a Comm obj
+0001d9d0: 6563 7420 6672 6f6d 2077 6869 6368 2077  ect from which w
+0001d9e0: 6520 626f 7468 2061 6363 6570 7420 7374  e both accept st
+0001d9f0: 696d 756c 6920 616e 640a 2020 2020 2020  imuli and.      
+0001da00: 2020 7265 706f 7274 2072 6573 756c 7473    report results
+0001da10: 0a20 2020 202a 202a 2a74 6173 6b5f 6475  .    * **task_du
+0001da20: 7261 7469 6f6e 3a2a 2a20 6060 7b6b 6579  ration:** ``{key
+0001da30: 2d70 7265 6669 783a 2074 696d 657d 6060  -prefix: time}``
+0001da40: 0a20 2020 2020 2020 2054 696d 6520 7765  .        Time we
+0001da50: 2065 7870 6563 7420 6365 7274 6169 6e20   expect certain 
+0001da60: 6675 6e63 7469 6f6e 7320 746f 2074 616b  functions to tak
+0001da70: 652c 2065 2e67 2e20 6060 7b27 7375 6d27  e, e.g. ``{'sum'
+0001da80: 3a20 302e 3235 7d60 600a 2020 2020 2222  : 0.25}``.    ""
+0001da90: 220a 0a20 2020 2064 6566 6175 6c74 5f70  "..    default_p
+0001daa0: 6f72 7420 3d20 3837 3836 0a20 2020 205f  ort = 8786.    _
+0001dab0: 696e 7374 616e 6365 733a 2043 6c61 7373  instances: Class
+0001dac0: 5661 725b 7765 616b 7265 662e 5765 616b  Var[weakref.Weak
+0001dad0: 5365 745b 5363 6865 6475 6c65 725d 5d20  Set[Scheduler]] 
+0001dae0: 3d20 7765 616b 7265 662e 5765 616b 5365  = weakref.WeakSe
+0001daf0: 7428 290a 0a20 2020 2064 6566 205f 5f69  t()..    def __i
+0001db00: 6e69 745f 5f28 0a20 2020 2020 2020 2073  nit__(.        s
+0001db10: 656c 662c 0a20 2020 2020 2020 206c 6f6f  elf,.        loo
+0001db20: 703d 4e6f 6e65 2c0a 2020 2020 2020 2020  p=None,.        
+0001db30: 6465 6c65 7465 5f69 6e74 6572 7661 6c3d  delete_interval=
+0001db40: 2235 3030 6d73 222c 0a20 2020 2020 2020  "500ms",.       
+0001db50: 2073 796e 6368 726f 6e69 7a65 5f77 6f72   synchronize_wor
+0001db60: 6b65 725f 696e 7465 7276 616c 3d22 3630  ker_interval="60
+0001db70: 7322 2c0a 2020 2020 2020 2020 7365 7276  s",.        serv
+0001db80: 6963 6573 3d4e 6f6e 652c 0a20 2020 2020  ices=None,.     
+0001db90: 2020 2073 6572 7669 6365 5f6b 7761 7267     service_kwarg
+0001dba0: 733d 4e6f 6e65 2c0a 2020 2020 2020 2020  s=None,.        
+0001dbb0: 616c 6c6f 7765 645f 6661 696c 7572 6573  allowed_failures
+0001dbc0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2065  =None,.        e
+0001dbd0: 7874 656e 7369 6f6e 733d 4e6f 6e65 2c0a  xtensions=None,.
+0001dbe0: 2020 2020 2020 2020 7661 6c69 6461 7465          validate
+0001dbf0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2073  =None,.        s
+0001dc00: 6368 6564 756c 6572 5f66 696c 653d 4e6f  cheduler_file=No
+0001dc10: 6e65 2c0a 2020 2020 2020 2020 7365 6375  ne,.        secu
+0001dc20: 7269 7479 3d4e 6f6e 652c 0a20 2020 2020  rity=None,.     
+0001dc30: 2020 2077 6f72 6b65 725f 7474 6c3d 4e6f     worker_ttl=No
+0001dc40: 6e65 2c0a 2020 2020 2020 2020 6964 6c65  ne,.        idle
+0001dc50: 5f74 696d 656f 7574 3d4e 6f6e 652c 0a20  _timeout=None,. 
+0001dc60: 2020 2020 2020 2069 6e74 6572 6661 6365         interface
+0001dc70: 3d4e 6f6e 652c 0a20 2020 2020 2020 2068  =None,.        h
+0001dc80: 6f73 743d 4e6f 6e65 2c0a 2020 2020 2020  ost=None,.      
+0001dc90: 2020 706f 7274 3d30 2c0a 2020 2020 2020    port=0,.      
+0001dca0: 2020 7072 6f74 6f63 6f6c 3d4e 6f6e 652c    protocol=None,
+0001dcb0: 0a20 2020 2020 2020 2064 6173 6862 6f61  .        dashboa
+0001dcc0: 7264 5f61 6464 7265 7373 3d4e 6f6e 652c  rd_address=None,
+0001dcd0: 0a20 2020 2020 2020 2064 6173 6862 6f61  .        dashboa
+0001dce0: 7264 3d4e 6f6e 652c 0a20 2020 2020 2020  rd=None,.       
+0001dcf0: 2068 7474 705f 7072 6566 6978 3d22 2f22   http_prefix="/"
+0001dd00: 2c0a 2020 2020 2020 2020 7072 656c 6f61  ,.        preloa
+0001dd10: 643d 4e6f 6e65 2c0a 2020 2020 2020 2020  d=None,.        
+0001dd20: 7072 656c 6f61 645f 6172 6776 3d28 292c  preload_argv=(),
+0001dd30: 0a20 2020 2020 2020 2070 6c75 6769 6e73  .        plugins
+0001dd40: 3d28 292c 0a20 2020 2020 2020 2063 6f6e  =(),.        con
+0001dd50: 7461 6374 5f61 6464 7265 7373 3d4e 6f6e  tact_address=Non
+0001dd60: 652c 0a20 2020 2020 2020 2074 7261 6e73  e,.        trans
+0001dd70: 6974 696f 6e5f 636f 756e 7465 725f 6d61  ition_counter_ma
+0001dd80: 783d 4661 6c73 652c 0a20 2020 2020 2020  x=False,.       
+0001dd90: 206a 7570 7974 6572 3d46 616c 7365 2c0a   jupyter=False,.
+0001dda0: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+0001ddb0: 2c0a 2020 2020 293a 0a20 2020 2020 2020  ,.    ):.       
+0001ddc0: 2069 6620 6c6f 6f70 2069 7320 6e6f 7420   if loop is not 
+0001ddd0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0001dde0: 2020 7761 726e 696e 6773 2e77 6172 6e28    warnings.warn(
+0001ddf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001de00: 2022 7468 6520 6c6f 6f70 206b 7761 7267   "the loop kwarg
+0001de10: 2074 6f20 5363 6865 6475 6c65 7220 6973   to Scheduler is
+0001de20: 2064 6570 7265 6361 7465 6422 2c0a 2020   deprecated",.  
+0001de30: 2020 2020 2020 2020 2020 2020 2020 4465                De
+0001de40: 7072 6563 6174 696f 6e57 6172 6e69 6e67  precationWarning
+0001de50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001de60: 2020 7374 6163 6b6c 6576 656c 3d32 2c0a    stacklevel=2,.
+0001de70: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+0001de80: 2020 2020 2020 2073 656c 662e 6c6f 6f70         self.loop
+0001de90: 203d 2073 656c 662e 696f 5f6c 6f6f 7020   = self.io_loop 
+0001dea0: 3d20 494f 4c6f 6f70 2e63 7572 7265 6e74  = IOLoop.current
+0001deb0: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+0001dec0: 5f73 6574 7570 5f6c 6f67 6769 6e67 286c  _setup_logging(l
+0001ded0: 6f67 6765 7229 0a0a 2020 2020 2020 2020  ogger)..        
+0001dee0: 2320 4174 7472 6962 7574 6573 0a20 2020  # Attributes.   
+0001def0: 2020 2020 2069 6620 636f 6e74 6163 745f       if contact_
+0001df00: 6164 6472 6573 7320 6973 204e 6f6e 653a  address is None:
+0001df10: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0001df20: 7461 6374 5f61 6464 7265 7373 203d 2064  tact_address = d
+0001df30: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
+0001df40: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
+0001df50: 6475 6c65 722e 636f 6e74 6163 742d 6164  duler.contact-ad
+0001df60: 6472 6573 7322 290a 2020 2020 2020 2020  dress").        
+0001df70: 7365 6c66 2e63 6f6e 7461 6374 5f61 6464  self.contact_add
+0001df80: 7265 7373 203d 2063 6f6e 7461 6374 5f61  ress = contact_a
+0001df90: 6464 7265 7373 0a20 2020 2020 2020 2069  ddress.        i
+0001dfa0: 6620 616c 6c6f 7765 645f 6661 696c 7572  f allowed_failur
+0001dfb0: 6573 2069 7320 4e6f 6e65 3a0a 2020 2020  es is None:.    
+0001dfc0: 2020 2020 2020 2020 616c 6c6f 7765 645f          allowed_
+0001dfd0: 6661 696c 7572 6573 203d 2064 6173 6b2e  failures = dask.
+0001dfe0: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
+0001dff0: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
+0001e000: 722e 616c 6c6f 7765 642d 6661 696c 7572  r.allowed-failur
+0001e010: 6573 2229 0a20 2020 2020 2020 2073 656c  es").        sel
+0001e020: 662e 616c 6c6f 7765 645f 6661 696c 7572  f.allowed_failur
+0001e030: 6573 203d 2061 6c6c 6f77 6564 5f66 6169  es = allowed_fai
+0001e040: 6c75 7265 730a 2020 2020 2020 2020 6966  lures.        if
+0001e050: 2076 616c 6964 6174 6520 6973 204e 6f6e   validate is Non
+0001e060: 653a 0a20 2020 2020 2020 2020 2020 2076  e:.            v
+0001e070: 616c 6964 6174 6520 3d20 6461 736b 2e63  alidate = dask.c
+0001e080: 6f6e 6669 672e 6765 7428 2264 6973 7472  onfig.get("distr
+0001e090: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
+0001e0a0: 2e76 616c 6964 6174 6522 290a 2020 2020  .validate").    
+0001e0b0: 2020 2020 7365 6c66 2e70 726f 6320 3d20      self.proc = 
+0001e0c0: 7073 7574 696c 2e50 726f 6365 7373 2829  psutil.Process()
+0001e0d0: 0a20 2020 2020 2020 2073 656c 662e 6465  .        self.de
+0001e0e0: 6c65 7465 5f69 6e74 6572 7661 6c20 3d20  lete_interval = 
+0001e0f0: 7061 7273 655f 7469 6d65 6465 6c74 6128  parse_timedelta(
+0001e100: 6465 6c65 7465 5f69 6e74 6572 7661 6c2c  delete_interval,
+0001e110: 2064 6566 6175 6c74 3d22 6d73 2229 0a20   default="ms"). 
+0001e120: 2020 2020 2020 2073 656c 662e 7379 6e63         self.sync
+0001e130: 6872 6f6e 697a 655f 776f 726b 6572 5f69  hronize_worker_i
+0001e140: 6e74 6572 7661 6c20 3d20 7061 7273 655f  nterval = parse_
+0001e150: 7469 6d65 6465 6c74 6128 0a20 2020 2020  timedelta(.     
+0001e160: 2020 2020 2020 2073 796e 6368 726f 6e69         synchroni
+0001e170: 7a65 5f77 6f72 6b65 725f 696e 7465 7276  ze_worker_interv
+0001e180: 616c 2c20 6465 6661 756c 743d 226d 7322  al, default="ms"
+0001e190: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0001e1a0: 2020 2073 656c 662e 7365 7276 6963 655f     self.service_
+0001e1b0: 7370 6563 7320 3d20 7365 7276 6963 6573  specs = services
+0001e1c0: 206f 7220 7b7d 0a20 2020 2020 2020 2073   or {}.        s
+0001e1d0: 656c 662e 7365 7276 6963 655f 6b77 6172  elf.service_kwar
+0001e1e0: 6773 203d 2073 6572 7669 6365 5f6b 7761  gs = service_kwa
+0001e1f0: 7267 7320 6f72 207b 7d0a 2020 2020 2020  rgs or {}.      
+0001e200: 2020 7365 6c66 2e73 6572 7669 6365 7320    self.services 
+0001e210: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
+0001e220: 662e 7363 6865 6475 6c65 725f 6669 6c65  f.scheduler_file
+0001e230: 203d 2073 6368 6564 756c 6572 5f66 696c   = scheduler_fil
+0001e240: 650a 2020 2020 2020 2020 776f 726b 6572  e.        worker
+0001e250: 5f74 746c 203d 2077 6f72 6b65 725f 7474  _ttl = worker_tt
+0001e260: 6c20 6f72 2064 6173 6b2e 636f 6e66 6967  l or dask.config
+0001e270: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
+0001e280: 642e 7363 6865 6475 6c65 722e 776f 726b  d.scheduler.work
+0001e290: 6572 2d74 746c 2229 0a20 2020 2020 2020  er-ttl").       
+0001e2a0: 2073 656c 662e 776f 726b 6572 5f74 746c   self.worker_ttl
+0001e2b0: 203d 2070 6172 7365 5f74 696d 6564 656c   = parse_timedel
+0001e2c0: 7461 2877 6f72 6b65 725f 7474 6c29 2069  ta(worker_ttl) i
+0001e2d0: 6620 776f 726b 6572 5f74 746c 2065 6c73  f worker_ttl els
+0001e2e0: 6520 4e6f 6e65 0a20 2020 2020 2020 2069  e None.        i
+0001e2f0: 646c 655f 7469 6d65 6f75 7420 3d20 6964  dle_timeout = id
+0001e300: 6c65 5f74 696d 656f 7574 206f 7220 6461  le_timeout or da
+0001e310: 736b 2e63 6f6e 6669 672e 6765 7428 0a20  sk.config.get(. 
+0001e320: 2020 2020 2020 2020 2020 2022 6469 7374             "dist
+0001e330: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
+0001e340: 722e 6964 6c65 2d74 696d 656f 7574 220a  r.idle-timeout".
+0001e350: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0001e360: 2020 6966 2069 646c 655f 7469 6d65 6f75    if idle_timeou
+0001e370: 743a 0a20 2020 2020 2020 2020 2020 2073  t:.            s
+0001e380: 656c 662e 6964 6c65 5f74 696d 656f 7574  elf.idle_timeout
+0001e390: 203d 2070 6172 7365 5f74 696d 6564 656c   = parse_timedel
+0001e3a0: 7461 2869 646c 655f 7469 6d65 6f75 7429  ta(idle_timeout)
+0001e3b0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0001e3c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001e3d0: 6964 6c65 5f74 696d 656f 7574 203d 204e  idle_timeout = N
+0001e3e0: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
+0001e3f0: 2e69 646c 655f 7369 6e63 6520 3d20 7469  .idle_since = ti
+0001e400: 6d65 2829 0a20 2020 2020 2020 2073 656c  me().        sel
+0001e410: 662e 7469 6d65 5f73 7461 7274 6564 203d  f.time_started =
+0001e420: 2073 656c 662e 6964 6c65 5f73 696e 6365   self.idle_since
+0001e430: 2020 2320 636f 6d70 6174 6962 696c 6974    # compatibilit
+0001e440: 7920 666f 7220 6461 736b 2d67 6174 6577  y for dask-gatew
+0001e450: 6179 0a20 2020 2020 2020 2073 656c 662e  ay.        self.
+0001e460: 5f6c 6f63 6b20 3d20 6173 796e 6369 6f2e  _lock = asyncio.
+0001e470: 4c6f 636b 2829 0a20 2020 2020 2020 2073  Lock().        s
+0001e480: 656c 662e 6261 6e64 7769 6474 685f 776f  elf.bandwidth_wo
+0001e490: 726b 6572 7320 3d20 6465 6661 756c 7464  rkers = defaultd
+0001e4a0: 6963 7428 666c 6f61 7429 0a20 2020 2020  ict(float).     
+0001e4b0: 2020 2073 656c 662e 6261 6e64 7769 6474     self.bandwidt
+0001e4c0: 685f 7479 7065 7320 3d20 6465 6661 756c  h_types = defaul
+0001e4d0: 7464 6963 7428 666c 6f61 7429 0a0a 2020  tdict(float)..  
+0001e4e0: 2020 2020 2020 7365 6c66 2e63 756d 756c        self.cumul
+0001e4f0: 6174 6976 655f 776f 726b 6572 5f6d 6574  ative_worker_met
+0001e500: 7269 6373 203d 2064 6566 6175 6c74 6469  rics = defaultdi
+0001e510: 6374 2866 6c6f 6174 290a 0a20 2020 2020  ct(float)..     
+0001e520: 2020 2069 6620 6e6f 7420 7072 656c 6f61     if not preloa
+0001e530: 643a 0a20 2020 2020 2020 2020 2020 2070  d:.            p
+0001e540: 7265 6c6f 6164 203d 2064 6173 6b2e 636f  reload = dask.co
+0001e550: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
+0001e560: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
+0001e570: 7072 656c 6f61 6422 290a 2020 2020 2020  preload").      
+0001e580: 2020 6966 206e 6f74 2070 7265 6c6f 6164    if not preload
+0001e590: 5f61 7267 763a 0a20 2020 2020 2020 2020  _argv:.         
+0001e5a0: 2020 2070 7265 6c6f 6164 5f61 7267 7620     preload_argv 
+0001e5b0: 3d20 6461 736b 2e63 6f6e 6669 672e 6765  = dask.config.ge
+0001e5c0: 7428 2264 6973 7472 6962 7574 6564 2e73  t("distributed.s
+0001e5d0: 6368 6564 756c 6572 2e70 7265 6c6f 6164  cheduler.preload
+0001e5e0: 2d61 7267 7622 290a 2020 2020 2020 2020  -argv").        
+0001e5f0: 7365 6c66 2e70 7265 6c6f 6164 7320 3d20  self.preloads = 
+0001e600: 7072 656c 6f61 6469 6e67 2e70 726f 6365  preloading.proce
+0001e610: 7373 5f70 7265 6c6f 6164 7328 7365 6c66  ss_preloads(self
+0001e620: 2c20 7072 656c 6f61 642c 2070 7265 6c6f  , preload, prelo
+0001e630: 6164 5f61 7267 7629 0a0a 2020 2020 2020  ad_argv)..      
+0001e640: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0001e650: 7365 6375 7269 7479 2c20 6469 6374 293a  security, dict):
+0001e660: 0a20 2020 2020 2020 2020 2020 2073 6563  .            sec
+0001e670: 7572 6974 7920 3d20 5365 6375 7269 7479  urity = Security
+0001e680: 282a 2a73 6563 7572 6974 7929 0a20 2020  (**security).   
+0001e690: 2020 2020 2073 656c 662e 7365 6375 7269       self.securi
+0001e6a0: 7479 203d 2073 6563 7572 6974 7920 6f72  ty = security or
+0001e6b0: 2053 6563 7572 6974 7928 290a 2020 2020   Security().    
+0001e6c0: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+0001e6d0: 7461 6e63 6528 7365 6c66 2e73 6563 7572  tance(self.secur
+0001e6e0: 6974 792c 2053 6563 7572 6974 7929 0a20  ity, Security). 
+0001e6f0: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
+0001e700: 6563 7469 6f6e 5f61 7267 7320 3d20 7365  ection_args = se
+0001e710: 6c66 2e73 6563 7572 6974 792e 6765 745f  lf.security.get_
+0001e720: 636f 6e6e 6563 7469 6f6e 5f61 7267 7328  connection_args(
+0001e730: 2273 6368 6564 756c 6572 2229 0a20 2020  "scheduler").   
+0001e740: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+0001e750: 7469 6f6e 5f61 7267 735b 2268 616e 6473  tion_args["hands
+0001e760: 6861 6b65 5f6f 7665 7272 6964 6573 225d  hake_overrides"]
+0001e770: 203d 207b 2020 2320 636f 6d6d 6f6e 2064   = {  # common d
+0001e780: 656e 6f6d 696e 6174 6f72 0a20 2020 2020  enominator.     
+0001e790: 2020 2020 2020 2022 7069 636b 6c65 2d70         "pickle-p
+0001e7a0: 726f 746f 636f 6c22 3a20 340a 2020 2020  rotocol": 4.    
+0001e7b0: 2020 2020 7d0a 0a20 2020 2020 2020 2073      }..        s
+0001e7c0: 656c 662e 5f73 7461 7274 5f61 6464 7265  elf._start_addre
+0001e7d0: 7373 203d 2061 6464 7265 7373 6573 5f66  ss = addresses_f
+0001e7e0: 726f 6d5f 7573 6572 5f61 7267 7328 0a20  rom_user_args(. 
+0001e7f0: 2020 2020 2020 2020 2020 2068 6f73 743d             host=
+0001e800: 686f 7374 2c0a 2020 2020 2020 2020 2020  host,.          
+0001e810: 2020 706f 7274 3d70 6f72 742c 0a20 2020    port=port,.   
+0001e820: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
+0001e830: 6365 3d69 6e74 6572 6661 6365 2c0a 2020  ce=interface,.  
+0001e840: 2020 2020 2020 2020 2020 7072 6f74 6f63            protoc
+0001e850: 6f6c 3d70 726f 746f 636f 6c2c 0a20 2020  ol=protocol,.   
+0001e860: 2020 2020 2020 2020 2073 6563 7572 6974           securit
+0001e870: 793d 7365 6375 7269 7479 2c0a 2020 2020  y=security,.    
+0001e880: 2020 2020 2020 2020 6465 6661 756c 745f          default_
+0001e890: 706f 7274 3d73 656c 662e 6465 6661 756c  port=self.defaul
+0001e8a0: 745f 706f 7274 2c0a 2020 2020 2020 2020  t_port,.        
+0001e8b0: 290a 0a20 2020 2020 2020 2068 7474 705f  )..        http_
+0001e8c0: 7365 7276 6572 5f6d 6f64 756c 6573 203d  server_modules =
+0001e8d0: 2064 6173 6b2e 636f 6e66 6967 2e67 6574   dask.config.get
+0001e8e0: 2822 6469 7374 7269 6275 7465 642e 7363  ("distributed.sc
+0001e8f0: 6865 6475 6c65 722e 6874 7470 2e72 6f75  heduler.http.rou
+0001e900: 7465 7322 290a 2020 2020 2020 2020 7368  tes").        sh
+0001e910: 6f77 5f64 6173 6862 6f61 7264 203d 2064  ow_dashboard = d
+0001e920: 6173 6862 6f61 7264 206f 7220 2864 6173  ashboard or (das
+0001e930: 6862 6f61 7264 2069 7320 4e6f 6e65 2061  hboard is None a
+0001e940: 6e64 2064 6173 6862 6f61 7264 5f61 6464  nd dashboard_add
+0001e950: 7265 7373 290a 2020 2020 2020 2020 2320  ress).        # 
+0001e960: 696e 7374 616c 6c20 7661 6e69 6c6c 6120  install vanilla 
+0001e970: 726f 7574 6520 6966 2073 686f 775f 6461  route if show_da
+0001e980: 7368 626f 6172 6420 6275 7420 626f 6b65  shboard but boke
+0001e990: 6820 6973 206e 6f74 2069 6e73 7461 6c6c  h is not install
+0001e9a0: 6564 0a20 2020 2020 2020 2069 6620 7368  ed.        if sh
+0001e9b0: 6f77 5f64 6173 6862 6f61 7264 3a0a 2020  ow_dashboard:.  
+0001e9c0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+0001e9d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001e9e0: 6d70 6f72 7420 6469 7374 7269 6275 7465  mport distribute
+0001e9f0: 642e 6461 7368 626f 6172 642e 7363 6865  d.dashboard.sche
+0001ea00: 6475 6c65 720a 2020 2020 2020 2020 2020  duler.          
+0001ea10: 2020 6578 6365 7074 2049 6d70 6f72 7445    except ImportE
+0001ea20: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+0001ea30: 2020 2020 2020 7368 6f77 5f64 6173 6862        show_dashb
+0001ea40: 6f61 7264 203d 2046 616c 7365 0a20 2020  oard = False.   
+0001ea50: 2020 2020 2020 2020 2020 2020 2068 7474               htt
+0001ea60: 705f 7365 7276 6572 5f6d 6f64 756c 6573  p_server_modules
+0001ea70: 2e61 7070 656e 6428 2264 6973 7472 6962  .append("distrib
+0001ea80: 7574 6564 2e68 7474 702e 7363 6865 6475  uted.http.schedu
+0001ea90: 6c65 722e 6d69 7373 696e 675f 626f 6b65  ler.missing_boke
+0001eaa0: 6822 290a 2020 2020 2020 2020 726f 7574  h").        rout
+0001eab0: 6573 203d 2067 6574 5f68 616e 646c 6572  es = get_handler
+0001eac0: 7328 0a20 2020 2020 2020 2020 2020 2073  s(.            s
+0001ead0: 6572 7665 723d 7365 6c66 2c20 6d6f 6475  erver=self, modu
+0001eae0: 6c65 733d 6874 7470 5f73 6572 7665 725f  les=http_server_
+0001eaf0: 6d6f 6475 6c65 732c 2070 7265 6669 783d  modules, prefix=
+0001eb00: 6874 7470 5f70 7265 6669 780a 2020 2020  http_prefix.    
+0001eb10: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+0001eb20: 6c66 2e73 7461 7274 5f68 7474 705f 7365  lf.start_http_se
+0001eb30: 7276 6572 2872 6f75 7465 732c 2064 6173  rver(routes, das
+0001eb40: 6862 6f61 7264 5f61 6464 7265 7373 2c20  hboard_address, 
+0001eb50: 6465 6661 756c 745f 706f 7274 3d38 3738  default_port=878
+0001eb60: 3729 0a20 2020 2020 2020 2073 656c 662e  7).        self.
+0001eb70: 6a75 7079 7465 7220 3d20 6a75 7079 7465  jupyter = jupyte
+0001eb80: 720a 2020 2020 2020 2020 6966 2073 686f  r.        if sho
+0001eb90: 775f 6461 7368 626f 6172 643a 0a20 2020  w_dashboard:.   
+0001eba0: 2020 2020 2020 2020 2064 6973 7472 6962           distrib
+0001ebb0: 7574 6564 2e64 6173 6862 6f61 7264 2e73  uted.dashboard.s
+0001ebc0: 6368 6564 756c 6572 2e63 6f6e 6e65 6374  cheduler.connect
+0001ebd0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001ebe0: 2020 7365 6c66 2e68 7474 705f 6170 706c    self.http_appl
+0001ebf0: 6963 6174 696f 6e2c 2073 656c 662e 6874  ication, self.ht
+0001ec00: 7470 5f73 6572 7665 722c 2073 656c 662c  tp_server, self,
+0001ec10: 2070 7265 6669 783d 6874 7470 5f70 7265   prefix=http_pre
+0001ec20: 6669 780a 2020 2020 2020 2020 2020 2020  fix.            
+0001ec30: 290a 2020 2020 2020 2020 6966 2073 656c  ).        if sel
+0001ec40: 662e 6a75 7079 7465 723a 0a20 2020 2020  f.jupyter:.     
+0001ec50: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0001ec60: 2020 2020 2020 2020 2020 2020 6672 6f6d              from
+0001ec70: 206a 7570 7974 6572 5f73 6572 7665 722e   jupyter_server.
+0001ec80: 7365 7276 6572 6170 7020 696d 706f 7274  serverapp import
+0001ec90: 2053 6572 7665 7241 7070 0a20 2020 2020   ServerApp.     
+0001eca0: 2020 2020 2020 2065 7863 6570 7420 496d         except Im
+0001ecb0: 706f 7274 4572 726f 723a 0a20 2020 2020  portError:.     
+0001ecc0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0001ecd0: 2049 6d70 6f72 7445 7272 6f72 280a 2020   ImportError(.  
 0001ece0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ecf0: 2020 2020 2262 6173 655f 7572 6c22 3a20      "base_url": 
-0001ed00: 226a 7570 7974 6572 222c 0a20 2020 2020  "jupyter",.     
-0001ed10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ed20: 2020 2020 2020 2023 2053 4543 5552 4954         # SECURIT
-0001ed30: 593a 2057 6520 7573 7561 6c6c 7920 6578  Y: We usually ex
-0001ed40: 7065 6374 2074 6865 2064 6173 6862 6f61  pect the dashboa
-0001ed50: 7264 2074 6f20 6265 2061 2072 6561 642d  rd to be a read-
-0001ed60: 6f6e 6c79 2076 6965 7720 696e 746f 0a20  only view into. 
-0001ed70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ed80: 2020 2020 2020 2020 2020 2023 2074 6865             # the
-0001ed90: 2073 6368 6564 756c 6572 2061 6374 6976   scheduler activ
-0001eda0: 6974 792e 2048 6f77 6576 6572 2c20 6279  ity. However, by
-0001edb0: 2061 6464 696e 6720 616e 206f 7065 6e20   adding an open 
-0001edc0: 4a75 7079 7465 7220 6170 706c 6963 6174  Jupyter applicat
-0001edd0: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
+0001ecf0: 2020 2249 6e20 6f72 6465 7220 746f 2075    "In order to u
+0001ed00: 7365 2074 6865 2044 6173 6b20 6a75 7079  se the Dask jupy
+0001ed10: 7465 7220 6f70 7469 6f6e 2079 6f75 2022  ter option you "
+0001ed20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ed30: 2020 2020 2022 6e65 6564 2074 6f20 6861       "need to ha
+0001ed40: 7665 206a 7570 7974 6572 6c61 6220 696e  ve jupyterlab in
+0001ed50: 7374 616c 6c65 6422 0a20 2020 2020 2020  stalled".       
+0001ed60: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0001ed70: 2020 2020 2020 2066 726f 6d20 7472 6169         from trai
+0001ed80: 746c 6574 732e 636f 6e66 6967 2069 6d70  tlets.config imp
+0001ed90: 6f72 7420 436f 6e66 6967 0a0a 2020 2020  ort Config..    
+0001eda0: 2020 2020 2020 2020 6a20 3d20 5365 7276          j = Serv
+0001edb0: 6572 4170 702e 696e 7374 616e 6365 280a  erApp.instance(.
+0001edc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001edd0: 636f 6e66 6967 3d43 6f6e 6669 6728 0a20  config=Config(. 
 0001ede0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001edf0: 2320 7765 2061 7265 2061 6c6c 6f77 696e  # we are allowin
-0001ee00: 6720 6172 6269 7472 6172 7920 7265 6d6f  g arbitrary remo
-0001ee10: 7465 2063 6f64 6520 6578 6563 7574 696f  te code executio
-0001ee20: 6e20 6f6e 2074 6865 2073 6368 6564 756c  n on the schedul
-0001ee30: 6572 2076 6961 2074 6865 0a20 2020 2020  er via the.     
-0001ee40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ee50: 2020 2020 2020 2023 2064 6173 6862 6f61         # dashboa
-0001ee60: 7264 2073 6572 7665 722e 2054 6869 7320  rd server. This 
-0001ee70: 6f70 7469 6f6e 2073 686f 756c 6420 6f6e  option should on
-0001ee80: 6c79 2062 6520 7573 6564 2077 6865 6e20  ly be used when 
-0001ee90: 7468 6520 6461 7368 626f 6172 6420 6973  the dashboard is
-0001eea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001eeb0: 2020 2020 2020 2020 2020 2020 2023 2070               # p
-0001eec0: 726f 7465 6374 6564 2076 6961 206f 7468  rotected via oth
-0001eed0: 6572 206d 6561 6e73 2c20 6f72 2077 6865  er means, or whe
-0001eee0: 6e20 796f 7520 646f 6e27 7420 6361 7265  n you don't care
-0001eef0: 2061 626f 7574 2063 6c75 7374 6572 2073   about cluster s
-0001ef00: 6563 7572 6974 792e 0a20 2020 2020 2020  ecurity..       
-0001ef10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ef20: 2020 2020 2022 746f 6b65 6e22 3a20 2222       "token": ""
-0001ef30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001ef40: 2020 2020 2020 2020 2020 2020 2020 2261                "a
-0001ef50: 6c6c 6f77 5f72 656d 6f74 655f 6163 6365  llow_remote_acce
-0001ef60: 7373 223a 2054 7275 652c 0a20 2020 2020  ss": True,.     
-0001ef70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ef80: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-0001ef90: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0001efa0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0001efb0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0001efc0: 2020 2020 2020 206a 2e69 6e69 7469 616c         j.initial
-0001efd0: 697a 6528 0a20 2020 2020 2020 2020 2020  ize(.           
-0001efe0: 2020 2020 206e 6577 5f68 7474 7073 6572       new_httpser
-0001eff0: 7665 723d 4661 6c73 652c 0a20 2020 2020  ver=False,.     
-0001f000: 2020 2020 2020 2020 2020 2061 7267 763d             argv=
-0001f010: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-0001f020: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-0001f030: 6c66 2e5f 6a75 7079 7465 725f 7365 7276  lf._jupyter_serv
-0001f040: 6572 5f61 7070 6c69 6361 7469 6f6e 203d  er_application =
-0001f050: 206a 0a20 2020 2020 2020 2020 2020 2073   j.            s
-0001f060: 656c 662e 6874 7470 5f61 7070 6c69 6361  elf.http_applica
-0001f070: 7469 6f6e 2e61 6464 5f61 7070 6c69 6361  tion.add_applica
-0001f080: 7469 6f6e 286a 2e77 6562 5f61 7070 290a  tion(j.web_app).
-0001f090: 0a20 2020 2020 2020 2023 2043 6f6d 6d75  .        # Commu
-0001f0a0: 6e69 6361 7469 6f6e 2073 7461 7465 0a20  nication state. 
-0001f0b0: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-0001f0c0: 6e74 5f63 6f6d 6d73 203d 207b 7d0a 2020  nt_comms = {}.  
-0001f0d0: 2020 2020 2020 7365 6c66 2e73 7472 6561        self.strea
-0001f0e0: 6d5f 636f 6d6d 7320 3d20 7b7d 0a0a 2020  m_comms = {}..  
-0001f0f0: 2020 2020 2020 2320 5461 736b 2073 7461        # Task sta
-0001f100: 7465 0a20 2020 2020 2020 2074 6173 6b73  te.        tasks
-0001f110: 203d 207b 7d0a 0a20 2020 2020 2020 2073   = {}..        s
-0001f120: 656c 662e 6765 6e65 7261 7469 6f6e 203d  elf.generation =
-0001f130: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
-0001f140: 5f6c 6173 745f 636c 6965 6e74 203d 204e  _last_client = N
-0001f150: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
-0001f160: 2e5f 6c61 7374 5f74 696d 6520 3d20 300a  ._last_time = 0.
-0001f170: 2020 2020 2020 2020 756e 7275 6e6e 6162          unrunnab
-0001f180: 6c65 203d 2073 6574 2829 0a20 2020 2020  le = set().     
-0001f190: 2020 2071 7565 7565 643a 2048 6561 7053     queued: HeapS
-0001f1a0: 6574 5b54 6173 6b53 7461 7465 5d20 3d20  et[TaskState] = 
-0001f1b0: 4865 6170 5365 7428 6b65 793d 6f70 6572  HeapSet(key=oper
-0001f1c0: 6174 6f72 2e61 7474 7267 6574 7465 7228  ator.attrgetter(
-0001f1d0: 2270 7269 6f72 6974 7922 2929 0a0a 2020  "priority"))..  
-0001f1e0: 2020 2020 2020 7365 6c66 2e64 6174 6173        self.datas
-0001f1f0: 6574 7320 3d20 7b7d 0a0a 2020 2020 2020  ets = {}..      
-0001f200: 2020 2320 5072 6566 6978 2d6b 6579 6564    # Prefix-keyed
-0001f210: 2063 6f6e 7461 696e 6572 730a 0a20 2020   containers..   
-0001f220: 2020 2020 2023 2043 6c69 656e 7420 7374       # Client st
-0001f230: 6174 650a 2020 2020 2020 2020 636c 6965  ate.        clie
-0001f240: 6e74 7320 3d20 7b7d 0a0a 2020 2020 2020  nts = {}..      
-0001f250: 2020 2320 576f 726b 6572 2073 7461 7465    # Worker state
-0001f260: 0a20 2020 2020 2020 2077 6f72 6b65 7273  .        workers
-0001f270: 203d 2053 6f72 7465 6444 6963 7428 290a   = SortedDict().
-0001f280: 0a20 2020 2020 2020 2068 6f73 745f 696e  .        host_in
-0001f290: 666f 203d 207b 7d0a 2020 2020 2020 2020  fo = {}.        
-0001f2a0: 7265 736f 7572 6365 7320 3d20 7b7d 0a20  resources = {}. 
-0001f2b0: 2020 2020 2020 2061 6c69 6173 6573 203d         aliases =
-0001f2c0: 207b 7d0a 0a20 2020 2020 2020 2073 656c   {}..        sel
-0001f2d0: 662e 5f77 6f72 6b65 725f 636f 6c6c 6563  f._worker_collec
-0001f2e0: 7469 6f6e 7320 3d20 5b0a 2020 2020 2020  tions = [.      
-0001f2f0: 2020 2020 2020 776f 726b 6572 732c 0a20        workers,. 
-0001f300: 2020 2020 2020 2020 2020 2068 6f73 745f             host_
-0001f310: 696e 666f 2c0a 2020 2020 2020 2020 2020  info,.          
-0001f320: 2020 7265 736f 7572 6365 732c 0a20 2020    resources,.   
-0001f330: 2020 2020 2020 2020 2061 6c69 6173 6573           aliases
-0001f340: 2c0a 2020 2020 2020 2020 5d0a 0a20 2020  ,.        ]..   
-0001f350: 2020 2020 2073 656c 662e 6576 656e 7473       self.events
-0001f360: 203d 2064 6566 6175 6c74 6469 6374 280a   = defaultdict(.
-0001f370: 2020 2020 2020 2020 2020 2020 7061 7274              part
-0001f380: 6961 6c28 0a20 2020 2020 2020 2020 2020  ial(.           
-0001f390: 2020 2020 2064 6571 7565 2c20 6d61 786c       deque, maxl
-0001f3a0: 656e 3d64 6173 6b2e 636f 6e66 6967 2e67  en=dask.config.g
-0001f3b0: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
-0001f3c0: 7363 6865 6475 6c65 722e 6576 656e 7473  scheduler.events
-0001f3d0: 2d6c 6f67 2d6c 656e 6774 6822 290a 2020  -log-length").  
-0001f3e0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0001f3f0: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-0001f400: 6c66 2e65 7665 6e74 5f63 6f75 6e74 7320  lf.event_counts 
-0001f410: 3d20 6465 6661 756c 7464 6963 7428 696e  = defaultdict(in
-0001f420: 7429 0a20 2020 2020 2020 2073 656c 662e  t).        self.
-0001f430: 6576 656e 745f 7375 6273 6372 6962 6572  event_subscriber
-0001f440: 203d 2064 6566 6175 6c74 6469 6374 2873   = defaultdict(s
-0001f450: 6574 290a 2020 2020 2020 2020 7365 6c66  et).        self
-0001f460: 2e77 6f72 6b65 725f 706c 7567 696e 7320  .worker_plugins 
-0001f470: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
-0001f480: 662e 6e61 6e6e 795f 706c 7567 696e 7320  f.nanny_plugins 
-0001f490: 3d20 7b7d 0a0a 2020 2020 2020 2020 776f  = {}..        wo
-0001f4a0: 726b 6572 5f68 616e 646c 6572 7320 3d20  rker_handlers = 
-0001f4b0: 7b0a 2020 2020 2020 2020 2020 2020 2274  {.            "t
-0001f4c0: 6173 6b2d 6669 6e69 7368 6564 223a 2073  ask-finished": s
-0001f4d0: 656c 662e 6861 6e64 6c65 5f74 6173 6b5f  elf.handle_task_
-0001f4e0: 6669 6e69 7368 6564 2c0a 2020 2020 2020  finished,.      
-0001f4f0: 2020 2020 2020 2274 6173 6b2d 6572 7265        "task-erre
-0001f500: 6422 3a20 7365 6c66 2e68 616e 646c 655f  d": self.handle_
-0001f510: 7461 736b 5f65 7272 6564 2c0a 2020 2020  task_erred,.    
-0001f520: 2020 2020 2020 2020 2272 656c 6561 7365          "release
-0001f530: 2d77 6f72 6b65 722d 6461 7461 223a 2073  -worker-data": s
-0001f540: 656c 662e 7265 6c65 6173 655f 776f 726b  elf.release_work
-0001f550: 6572 5f64 6174 612c 0a20 2020 2020 2020  er_data,.       
-0001f560: 2020 2020 2022 6164 642d 6b65 7973 223a       "add-keys":
-0001f570: 2073 656c 662e 6164 645f 6b65 7973 2c0a   self.add_keys,.
-0001f580: 2020 2020 2020 2020 2020 2020 226c 6f6e              "lon
-0001f590: 672d 7275 6e6e 696e 6722 3a20 7365 6c66  g-running": self
-0001f5a0: 2e68 616e 646c 655f 6c6f 6e67 5f72 756e  .handle_long_run
-0001f5b0: 6e69 6e67 2c0a 2020 2020 2020 2020 2020  ning,.          
-0001f5c0: 2020 2272 6573 6368 6564 756c 6522 3a20    "reschedule": 
-0001f5d0: 7365 6c66 2e5f 7265 7363 6865 6475 6c65  self._reschedule
-0001f5e0: 2c0a 2020 2020 2020 2020 2020 2020 226b  ,.            "k
-0001f5f0: 6565 702d 616c 6976 6522 3a20 6c61 6d62  eep-alive": lamb
-0001f600: 6461 202a 6172 6773 2c20 2a2a 6b77 6172  da *args, **kwar
-0001f610: 6773 3a20 4e6f 6e65 2c0a 2020 2020 2020  gs: None,.      
-0001f620: 2020 2020 2020 226c 6f67 2d65 7665 6e74        "log-event
-0001f630: 223a 2073 656c 662e 6c6f 675f 776f 726b  ": self.log_work
-0001f640: 6572 5f65 7665 6e74 2c0a 2020 2020 2020  er_event,.      
-0001f650: 2020 2020 2020 2277 6f72 6b65 722d 7374        "worker-st
-0001f660: 6174 7573 2d63 6861 6e67 6522 3a20 7365  atus-change": se
-0001f670: 6c66 2e68 616e 646c 655f 776f 726b 6572  lf.handle_worker
-0001f680: 5f73 7461 7475 735f 6368 616e 6765 2c0a  _status_change,.
-0001f690: 2020 2020 2020 2020 2020 2020 2272 6571              "req
-0001f6a0: 7565 7374 2d72 6566 7265 7368 2d77 686f  uest-refresh-who
-0001f6b0: 2d68 6173 223a 2073 656c 662e 6861 6e64  -has": self.hand
-0001f6c0: 6c65 5f72 6571 7565 7374 5f72 6566 7265  le_request_refre
-0001f6d0: 7368 5f77 686f 5f68 6173 2c0a 2020 2020  sh_who_has,.    
-0001f6e0: 2020 2020 7d0a 0a20 2020 2020 2020 2063      }..        c
-0001f6f0: 6c69 656e 745f 6861 6e64 6c65 7273 203d  lient_handlers =
-0001f700: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
-0001f710: 7570 6461 7465 2d67 7261 7068 223a 2073  update-graph": s
-0001f720: 656c 662e 7570 6461 7465 5f67 7261 7068  elf.update_graph
-0001f730: 2c0a 2020 2020 2020 2020 2020 2020 2263  ,.            "c
-0001f740: 6c69 656e 742d 6465 7369 7265 732d 6b65  lient-desires-ke
-0001f750: 7973 223a 2073 656c 662e 636c 6965 6e74  ys": self.client
-0001f760: 5f64 6573 6972 6573 5f6b 6579 732c 0a20  _desires_keys,. 
-0001f770: 2020 2020 2020 2020 2020 2022 7570 6461             "upda
-0001f780: 7465 2d64 6174 6122 3a20 7365 6c66 2e75  te-data": self.u
-0001f790: 7064 6174 655f 6461 7461 2c0a 2020 2020  pdate_data,.    
-0001f7a0: 2020 2020 2020 2020 2272 6570 6f72 742d          "report-
-0001f7b0: 6b65 7922 3a20 7365 6c66 2e72 6570 6f72  key": self.repor
-0001f7c0: 745f 6f6e 5f6b 6579 2c0a 2020 2020 2020  t_on_key,.      
-0001f7d0: 2020 2020 2020 2263 6c69 656e 742d 7265        "client-re
-0001f7e0: 6c65 6173 6573 2d6b 6579 7322 3a20 7365  leases-keys": se
-0001f7f0: 6c66 2e63 6c69 656e 745f 7265 6c65 6173  lf.client_releas
-0001f800: 6573 5f6b 6579 732c 0a20 2020 2020 2020  es_keys,.       
-0001f810: 2020 2020 2022 6865 6172 7462 6561 742d       "heartbeat-
-0001f820: 636c 6965 6e74 223a 2073 656c 662e 636c  client": self.cl
-0001f830: 6965 6e74 5f68 6561 7274 6265 6174 2c0a  ient_heartbeat,.
-0001f840: 2020 2020 2020 2020 2020 2020 2263 6c6f              "clo
-0001f850: 7365 2d63 6c69 656e 7422 3a20 7365 6c66  se-client": self
-0001f860: 2e72 656d 6f76 655f 636c 6965 6e74 2c0a  .remove_client,.
-0001f870: 2020 2020 2020 2020 2020 2020 2273 7562              "sub
-0001f880: 7363 7269 6265 2d74 6f70 6963 223a 2073  scribe-topic": s
-0001f890: 656c 662e 7375 6273 6372 6962 655f 746f  elf.subscribe_to
-0001f8a0: 7069 632c 0a20 2020 2020 2020 2020 2020  pic,.           
-0001f8b0: 2022 756e 7375 6273 6372 6962 652d 746f   "unsubscribe-to
-0001f8c0: 7069 6322 3a20 7365 6c66 2e75 6e73 7562  pic": self.unsub
-0001f8d0: 7363 7269 6265 5f74 6f70 6963 2c0a 2020  scribe_topic,.  
-0001f8e0: 2020 2020 2020 2020 2020 2263 616e 6365            "cance
-0001f8f0: 6c2d 6b65 7973 223a 2073 656c 662e 7374  l-keys": self.st
-0001f900: 696d 756c 7573 5f63 616e 6365 6c2c 0a20  imulus_cancel,. 
-0001f910: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-0001f920: 2020 7365 6c66 2e68 616e 646c 6572 7320    self.handlers 
-0001f930: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-0001f940: 2272 6567 6973 7465 722d 636c 6965 6e74  "register-client
-0001f950: 223a 2073 656c 662e 6164 645f 636c 6965  ": self.add_clie
-0001f960: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
-0001f970: 2273 6361 7474 6572 223a 2073 656c 662e  "scatter": self.
-0001f980: 7363 6174 7465 722c 0a20 2020 2020 2020  scatter,.       
-0001f990: 2020 2020 2022 7265 6769 7374 6572 2d77       "register-w
-0001f9a0: 6f72 6b65 7222 3a20 7365 6c66 2e61 6464  orker": self.add
-0001f9b0: 5f77 6f72 6b65 722c 0a20 2020 2020 2020  _worker,.       
-0001f9c0: 2020 2020 2022 7265 6769 7374 6572 5f6e       "register_n
-0001f9d0: 616e 6e79 223a 2073 656c 662e 6164 645f  anny": self.add_
-0001f9e0: 6e61 6e6e 792c 0a20 2020 2020 2020 2020  nanny,.         
-0001f9f0: 2020 2022 756e 7265 6769 7374 6572 223a     "unregister":
-0001fa00: 2073 656c 662e 7265 6d6f 7665 5f77 6f72   self.remove_wor
-0001fa10: 6b65 722c 0a20 2020 2020 2020 2020 2020  ker,.           
-0001fa20: 2022 6761 7468 6572 223a 2073 656c 662e   "gather": self.
-0001fa30: 6761 7468 6572 2c0a 2020 2020 2020 2020  gather,.        
-0001fa40: 2020 2020 2272 6574 7279 223a 2073 656c      "retry": sel
-0001fa50: 662e 7374 696d 756c 7573 5f72 6574 7279  f.stimulus_retry
-0001fa60: 2c0a 2020 2020 2020 2020 2020 2020 2266  ,.            "f
-0001fa70: 6565 6422 3a20 7365 6c66 2e66 6565 642c  eed": self.feed,
-0001fa80: 0a20 2020 2020 2020 2020 2020 2022 7465  .            "te
-0001fa90: 726d 696e 6174 6522 3a20 7365 6c66 2e63  rminate": self.c
-0001faa0: 6c6f 7365 2c0a 2020 2020 2020 2020 2020  lose,.          
-0001fab0: 2020 2262 726f 6164 6361 7374 223a 2073    "broadcast": s
-0001fac0: 656c 662e 6272 6f61 6463 6173 742c 0a20  elf.broadcast,. 
-0001fad0: 2020 2020 2020 2020 2020 2022 7072 6f78             "prox
-0001fae0: 7922 3a20 7365 6c66 2e70 726f 7879 2c0a  y": self.proxy,.
-0001faf0: 2020 2020 2020 2020 2020 2020 226e 636f              "nco
-0001fb00: 7265 7322 3a20 7365 6c66 2e67 6574 5f6e  res": self.get_n
-0001fb10: 636f 7265 732c 0a20 2020 2020 2020 2020  cores,.         
-0001fb20: 2020 2022 6e63 6f72 6573 5f72 756e 6e69     "ncores_runni
-0001fb30: 6e67 223a 2073 656c 662e 6765 745f 6e63  ng": self.get_nc
-0001fb40: 6f72 6573 5f72 756e 6e69 6e67 2c0a 2020  ores_running,.  
-0001fb50: 2020 2020 2020 2020 2020 2268 6173 5f77            "has_w
-0001fb60: 6861 7422 3a20 7365 6c66 2e67 6574 5f68  hat": self.get_h
-0001fb70: 6173 5f77 6861 742c 0a20 2020 2020 2020  as_what,.       
-0001fb80: 2020 2020 2022 7768 6f5f 6861 7322 3a20       "who_has": 
-0001fb90: 7365 6c66 2e67 6574 5f77 686f 5f68 6173  self.get_who_has
-0001fba0: 2c0a 2020 2020 2020 2020 2020 2020 2270  ,.            "p
-0001fbb0: 726f 6365 7373 696e 6722 3a20 7365 6c66  rocessing": self
-0001fbc0: 2e67 6574 5f70 726f 6365 7373 696e 672c  .get_processing,
-0001fbd0: 0a20 2020 2020 2020 2020 2020 2022 6361  .            "ca
-0001fbe0: 6c6c 5f73 7461 636b 223a 2073 656c 662e  ll_stack": self.
-0001fbf0: 6765 745f 6361 6c6c 5f73 7461 636b 2c0a  get_call_stack,.
-0001fc00: 2020 2020 2020 2020 2020 2020 2270 726f              "pro
-0001fc10: 6669 6c65 223a 2073 656c 662e 6765 745f  file": self.get_
-0001fc20: 7072 6f66 696c 652c 0a20 2020 2020 2020  profile,.       
-0001fc30: 2020 2020 2022 7065 7266 6f72 6d61 6e63       "performanc
-0001fc40: 655f 7265 706f 7274 223a 2073 656c 662e  e_report": self.
-0001fc50: 7065 7266 6f72 6d61 6e63 655f 7265 706f  performance_repo
-0001fc60: 7274 2c0a 2020 2020 2020 2020 2020 2020  rt,.            
-0001fc70: 2267 6574 5f6c 6f67 7322 3a20 7365 6c66  "get_logs": self
-0001fc80: 2e67 6574 5f6c 6f67 732c 0a20 2020 2020  .get_logs,.     
-0001fc90: 2020 2020 2020 2022 6c6f 6773 223a 2073         "logs": s
-0001fca0: 656c 662e 6765 745f 6c6f 6773 2c0a 2020  elf.get_logs,.  
-0001fcb0: 2020 2020 2020 2020 2020 2277 6f72 6b65            "worke
-0001fcc0: 725f 6c6f 6773 223a 2073 656c 662e 6765  r_logs": self.ge
-0001fcd0: 745f 776f 726b 6572 5f6c 6f67 732c 0a20  t_worker_logs,. 
-0001fce0: 2020 2020 2020 2020 2020 2022 6c6f 675f             "log_
-0001fcf0: 6576 656e 7422 3a20 7365 6c66 2e6c 6f67  event": self.log
-0001fd00: 5f65 7665 6e74 2c0a 2020 2020 2020 2020  _event,.        
-0001fd10: 2020 2020 2265 7665 6e74 7322 3a20 7365      "events": se
-0001fd20: 6c66 2e67 6574 5f65 7665 6e74 732c 0a20  lf.get_events,. 
-0001fd30: 2020 2020 2020 2020 2020 2022 6e62 7974             "nbyt
-0001fd40: 6573 223a 2073 656c 662e 6765 745f 6e62  es": self.get_nb
-0001fd50: 7974 6573 2c0a 2020 2020 2020 2020 2020  ytes,.          
-0001fd60: 2020 2276 6572 7369 6f6e 7322 3a20 7365    "versions": se
-0001fd70: 6c66 2e76 6572 7369 6f6e 732c 0a20 2020  lf.versions,.   
-0001fd80: 2020 2020 2020 2020 2022 6164 645f 6b65           "add_ke
-0001fd90: 7973 223a 2073 656c 662e 6164 645f 6b65  ys": self.add_ke
-0001fda0: 7973 2c0a 2020 2020 2020 2020 2020 2020  ys,.            
-0001fdb0: 2272 6562 616c 616e 6365 223a 2073 656c  "rebalance": sel
-0001fdc0: 662e 7265 6261 6c61 6e63 652c 0a20 2020  f.rebalance,.   
-0001fdd0: 2020 2020 2020 2020 2022 7265 706c 6963           "replic
-0001fde0: 6174 6522 3a20 7365 6c66 2e72 6570 6c69  ate": self.repli
-0001fdf0: 6361 7465 2c0a 2020 2020 2020 2020 2020  cate,.          
-0001fe00: 2020 2272 756e 5f66 756e 6374 696f 6e22    "run_function"
-0001fe10: 3a20 7365 6c66 2e72 756e 5f66 756e 6374  : self.run_funct
-0001fe20: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
-0001fe30: 2022 7265 7374 6172 7422 3a20 7365 6c66   "restart": self
-0001fe40: 2e72 6573 7461 7274 2c0a 2020 2020 2020  .restart,.      
-0001fe50: 2020 2020 2020 2275 7064 6174 655f 6461        "update_da
-0001fe60: 7461 223a 2073 656c 662e 7570 6461 7465  ta": self.update
-0001fe70: 5f64 6174 612c 0a20 2020 2020 2020 2020  _data,.         
-0001fe80: 2020 2022 7365 745f 7265 736f 7572 6365     "set_resource
-0001fe90: 7322 3a20 7365 6c66 2e61 6464 5f72 6573  s": self.add_res
-0001fea0: 6f75 7263 6573 2c0a 2020 2020 2020 2020  ources,.        
-0001feb0: 2020 2020 2272 6574 6972 655f 776f 726b      "retire_work
-0001fec0: 6572 7322 3a20 7365 6c66 2e72 6574 6972  ers": self.retir
-0001fed0: 655f 776f 726b 6572 732c 0a20 2020 2020  e_workers,.     
-0001fee0: 2020 2020 2020 2022 6765 745f 6d65 7461         "get_meta
-0001fef0: 6461 7461 223a 2073 656c 662e 6765 745f  data": self.get_
-0001ff00: 6d65 7461 6461 7461 2c0a 2020 2020 2020  metadata,.      
-0001ff10: 2020 2020 2020 2273 6574 5f6d 6574 6164        "set_metad
-0001ff20: 6174 6122 3a20 7365 6c66 2e73 6574 5f6d  ata": self.set_m
-0001ff30: 6574 6164 6174 612c 0a20 2020 2020 2020  etadata,.       
-0001ff40: 2020 2020 2022 7365 745f 7265 7374 7269       "set_restri
-0001ff50: 6374 696f 6e73 223a 2073 656c 662e 7365  ctions": self.se
-0001ff60: 745f 7265 7374 7269 6374 696f 6e73 2c0a  t_restrictions,.
-0001ff70: 2020 2020 2020 2020 2020 2020 2268 6561              "hea
-0001ff80: 7274 6265 6174 5f77 6f72 6b65 7222 3a20  rtbeat_worker": 
-0001ff90: 7365 6c66 2e68 6561 7274 6265 6174 5f77  self.heartbeat_w
-0001ffa0: 6f72 6b65 722c 0a20 2020 2020 2020 2020  orker,.         
-0001ffb0: 2020 2022 6765 745f 7461 736b 5f73 7461     "get_task_sta
-0001ffc0: 7475 7322 3a20 7365 6c66 2e67 6574 5f74  tus": self.get_t
-0001ffd0: 6173 6b5f 7374 6174 7573 2c0a 2020 2020  ask_status,.    
-0001ffe0: 2020 2020 2020 2020 2267 6574 5f74 6173          "get_tas
-0001fff0: 6b5f 7374 7265 616d 223a 2073 656c 662e  k_stream": self.
-00020000: 6765 745f 7461 736b 5f73 7472 6561 6d2c  get_task_stream,
-00020010: 0a20 2020 2020 2020 2020 2020 2022 6765  .            "ge
-00020020: 745f 7461 736b 5f70 7265 6669 785f 7374  t_task_prefix_st
-00020030: 6174 6573 223a 2073 656c 662e 6765 745f  ates": self.get_
-00020040: 7461 736b 5f70 7265 6669 785f 7374 6174  task_prefix_stat
-00020050: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-00020060: 2272 6567 6973 7465 725f 7363 6865 6475  "register_schedu
-00020070: 6c65 725f 706c 7567 696e 223a 2073 656c  ler_plugin": sel
-00020080: 662e 7265 6769 7374 6572 5f73 6368 6564  f.register_sched
-00020090: 756c 6572 5f70 6c75 6769 6e2c 0a20 2020  uler_plugin,.   
-000200a0: 2020 2020 2020 2020 2022 7265 6769 7374           "regist
-000200b0: 6572 5f77 6f72 6b65 725f 706c 7567 696e  er_worker_plugin
-000200c0: 223a 2073 656c 662e 7265 6769 7374 6572  ": self.register
-000200d0: 5f77 6f72 6b65 725f 706c 7567 696e 2c0a  _worker_plugin,.
-000200e0: 2020 2020 2020 2020 2020 2020 2275 6e72              "unr
-000200f0: 6567 6973 7465 725f 776f 726b 6572 5f70  egister_worker_p
-00020100: 6c75 6769 6e22 3a20 7365 6c66 2e75 6e72  lugin": self.unr
-00020110: 6567 6973 7465 725f 776f 726b 6572 5f70  egister_worker_p
-00020120: 6c75 6769 6e2c 0a20 2020 2020 2020 2020  lugin,.         
-00020130: 2020 2022 7265 6769 7374 6572 5f6e 616e     "register_nan
-00020140: 6e79 5f70 6c75 6769 6e22 3a20 7365 6c66  ny_plugin": self
-00020150: 2e72 6567 6973 7465 725f 6e61 6e6e 795f  .register_nanny_
-00020160: 706c 7567 696e 2c0a 2020 2020 2020 2020  plugin,.        
-00020170: 2020 2020 2275 6e72 6567 6973 7465 725f      "unregister_
-00020180: 6e61 6e6e 795f 706c 7567 696e 223a 2073  nanny_plugin": s
-00020190: 656c 662e 756e 7265 6769 7374 6572 5f6e  elf.unregister_n
-000201a0: 616e 6e79 5f70 6c75 6769 6e2c 0a20 2020  anny_plugin,.   
-000201b0: 2020 2020 2020 2020 2022 6164 6170 7469           "adapti
-000201c0: 7665 5f74 6172 6765 7422 3a20 7365 6c66  ve_target": self
-000201d0: 2e61 6461 7074 6976 655f 7461 7267 6574  .adaptive_target
-000201e0: 2c0a 2020 2020 2020 2020 2020 2020 2277  ,.            "w
-000201f0: 6f72 6b65 7273 5f74 6f5f 636c 6f73 6522  orkers_to_close"
-00020200: 3a20 7365 6c66 2e77 6f72 6b65 7273 5f74  : self.workers_t
-00020210: 6f5f 636c 6f73 652c 0a20 2020 2020 2020  o_close,.       
-00020220: 2020 2020 2022 7375 6273 6372 6962 655f       "subscribe_
-00020230: 776f 726b 6572 5f73 7461 7475 7322 3a20  worker_status": 
-00020240: 7365 6c66 2e73 7562 7363 7269 6265 5f77  self.subscribe_w
-00020250: 6f72 6b65 725f 7374 6174 7573 2c0a 2020  orker_status,.  
-00020260: 2020 2020 2020 2020 2020 2273 7461 7274            "start
-00020270: 5f74 6173 6b5f 6d65 7461 6461 7461 223a  _task_metadata":
-00020280: 2073 656c 662e 7374 6172 745f 7461 736b   self.start_task
-00020290: 5f6d 6574 6164 6174 612c 0a20 2020 2020  _metadata,.     
-000202a0: 2020 2020 2020 2022 7374 6f70 5f74 6173         "stop_tas
-000202b0: 6b5f 6d65 7461 6461 7461 223a 2073 656c  k_metadata": sel
-000202c0: 662e 7374 6f70 5f74 6173 6b5f 6d65 7461  f.stop_task_meta
-000202d0: 6461 7461 2c0a 2020 2020 2020 2020 2020  data,.          
-000202e0: 2020 2267 6574 5f63 6c75 7374 6572 5f73    "get_cluster_s
-000202f0: 7461 7465 223a 2073 656c 662e 6765 745f  tate": self.get_
-00020300: 636c 7573 7465 725f 7374 6174 652c 0a20  cluster_state,. 
-00020310: 2020 2020 2020 2020 2020 2022 6475 6d70             "dump
-00020320: 5f63 6c75 7374 6572 5f73 7461 7465 5f74  _cluster_state_t
-00020330: 6f5f 7572 6c22 3a20 7365 6c66 2e64 756d  o_url": self.dum
-00020340: 705f 636c 7573 7465 725f 7374 6174 655f  p_cluster_state_
-00020350: 746f 5f75 726c 2c0a 2020 2020 2020 2020  to_url,.        
-00020360: 2020 2020 2262 656e 6368 6d61 726b 5f68      "benchmark_h
-00020370: 6172 6477 6172 6522 3a20 7365 6c66 2e62  ardware": self.b
-00020380: 656e 6368 6d61 726b 5f68 6172 6477 6172  enchmark_hardwar
-00020390: 652c 0a20 2020 2020 2020 2020 2020 2022  e,.            "
-000203a0: 6765 745f 7374 6f72 7922 3a20 7365 6c66  get_story": self
-000203b0: 2e67 6574 5f73 746f 7279 2c0a 2020 2020  .get_story,.    
-000203c0: 2020 2020 2020 2020 2263 6865 636b 5f69          "check_i
-000203d0: 646c 6522 3a20 7365 6c66 2e63 6865 636b  dle": self.check
-000203e0: 5f69 646c 652c 0a20 2020 2020 2020 207d  _idle,.        }
-000203f0: 0a0a 2020 2020 2020 2020 636f 6e6e 6563  ..        connec
-00020400: 7469 6f6e 5f6c 696d 6974 203d 2067 6574  tion_limit = get
-00020410: 5f66 696c 656e 6f5f 6c69 6d69 7428 2920  _fileno_limit() 
-00020420: 2f20 320a 0a20 2020 2020 2020 2053 6368  / 2..        Sch
-00020430: 6564 756c 6572 5374 6174 652e 5f5f 696e  edulerState.__in
-00020440: 6974 5f5f 280a 2020 2020 2020 2020 2020  it__(.          
-00020450: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-00020460: 2020 2020 616c 6961 7365 733d 616c 6961      aliases=alia
-00020470: 7365 732c 0a20 2020 2020 2020 2020 2020  ses,.           
-00020480: 2063 6c69 656e 7473 3d63 6c69 656e 7473   clients=clients
-00020490: 2c0a 2020 2020 2020 2020 2020 2020 776f  ,.            wo
-000204a0: 726b 6572 733d 776f 726b 6572 732c 0a20  rkers=workers,. 
-000204b0: 2020 2020 2020 2020 2020 2068 6f73 745f             host_
-000204c0: 696e 666f 3d68 6f73 745f 696e 666f 2c0a  info=host_info,.
-000204d0: 2020 2020 2020 2020 2020 2020 7265 736f              reso
-000204e0: 7572 6365 733d 7265 736f 7572 6365 732c  urces=resources,
-000204f0: 0a20 2020 2020 2020 2020 2020 2074 6173  .            tas
-00020500: 6b73 3d74 6173 6b73 2c0a 2020 2020 2020  ks=tasks,.      
-00020510: 2020 2020 2020 756e 7275 6e6e 6162 6c65        unrunnable
-00020520: 3d75 6e72 756e 6e61 626c 652c 0a20 2020  =unrunnable,.   
-00020530: 2020 2020 2020 2020 2071 7565 7565 643d           queued=
-00020540: 7175 6575 6564 2c0a 2020 2020 2020 2020  queued,.        
-00020550: 2020 2020 7661 6c69 6461 7465 3d76 616c      validate=val
-00020560: 6964 6174 652c 0a20 2020 2020 2020 2020  idate,.         
-00020570: 2020 2070 6c75 6769 6e73 3d70 6c75 6769     plugins=plugi
-00020580: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
-00020590: 7472 616e 7369 7469 6f6e 5f63 6f75 6e74  transition_count
-000205a0: 6572 5f6d 6178 3d74 7261 6e73 6974 696f  er_max=transitio
-000205b0: 6e5f 636f 756e 7465 725f 6d61 782c 0a20  n_counter_max,. 
-000205c0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000205d0: 2053 6572 7665 724e 6f64 652e 5f5f 696e   ServerNode.__in
-000205e0: 6974 5f5f 280a 2020 2020 2020 2020 2020  it__(.          
-000205f0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-00020600: 2020 2020 6861 6e64 6c65 7273 3d73 656c      handlers=sel
-00020610: 662e 6861 6e64 6c65 7273 2c0a 2020 2020  f.handlers,.    
-00020620: 2020 2020 2020 2020 7374 7265 616d 5f68          stream_h
-00020630: 616e 646c 6572 733d 6d65 7267 6528 776f  andlers=merge(wo
-00020640: 726b 6572 5f68 616e 646c 6572 732c 2063  rker_handlers, c
-00020650: 6c69 656e 745f 6861 6e64 6c65 7273 292c  lient_handlers),
-00020660: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00020670: 6e65 6374 696f 6e5f 6c69 6d69 743d 636f  nection_limit=co
-00020680: 6e6e 6563 7469 6f6e 5f6c 696d 6974 2c0a  nnection_limit,.
-00020690: 2020 2020 2020 2020 2020 2020 6465 7365              dese
-000206a0: 7269 616c 697a 653d 4661 6c73 652c 0a20  rialize=False,. 
-000206b0: 2020 2020 2020 2020 2020 2063 6f6e 6e65             conne
-000206c0: 6374 696f 6e5f 6172 6773 3d73 656c 662e  ction_args=self.
-000206d0: 636f 6e6e 6563 7469 6f6e 5f61 7267 732c  connection_args,
-000206e0: 0a20 2020 2020 2020 2020 2020 202a 2a6b  .            **k
-000206f0: 7761 7267 732c 0a20 2020 2020 2020 2029  wargs,.        )
-00020700: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00020710: 662e 776f 726b 6572 5f74 746c 3a0a 2020  f.worker_ttl:.  
-00020720: 2020 2020 2020 2020 2020 7063 203d 2050            pc = P
-00020730: 6572 696f 6469 6343 616c 6c62 6163 6b28  eriodicCallback(
-00020740: 7365 6c66 2e63 6865 636b 5f77 6f72 6b65  self.check_worke
-00020750: 725f 7474 6c2c 2073 656c 662e 776f 726b  r_ttl, self.work
-00020760: 6572 5f74 746c 202a 2031 3030 3029 0a20  er_ttl * 1000). 
-00020770: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00020780: 7065 7269 6f64 6963 5f63 616c 6c62 6163  periodic_callbac
-00020790: 6b73 5b22 776f 726b 6572 2d74 746c 225d  ks["worker-ttl"]
-000207a0: 203d 2070 630a 0a20 2020 2020 2020 2070   = pc..        p
-000207b0: 6320 3d20 5065 7269 6f64 6963 4361 6c6c  c = PeriodicCall
-000207c0: 6261 636b 2873 656c 662e 6368 6563 6b5f  back(self.check_
-000207d0: 6964 6c65 2c20 2873 656c 662e 6964 6c65  idle, (self.idle
-000207e0: 5f74 696d 656f 7574 206f 7220 3129 202a  _timeout or 1) *
-000207f0: 2031 3030 3020 2f20 3429 0a20 2020 2020   1000 / 4).     
-00020800: 2020 2073 656c 662e 7065 7269 6f64 6963     self.periodic
-00020810: 5f63 616c 6c62 6163 6b73 5b22 6964 6c65  _callbacks["idle
-00020820: 2d74 696d 656f 7574 225d 203d 2070 630a  -timeout"] = pc.
-00020830: 0a20 2020 2020 2020 2069 6620 6578 7465  .        if exte
-00020840: 6e73 696f 6e73 2069 7320 4e6f 6e65 3a0a  nsions is None:.
-00020850: 2020 2020 2020 2020 2020 2020 6578 7465              exte
-00020860: 6e73 696f 6e73 203d 2044 4546 4155 4c54  nsions = DEFAULT
-00020870: 5f45 5854 454e 5349 4f4e 532e 636f 7079  _EXTENSIONS.copy
-00020880: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
-00020890: 6620 6e6f 7420 6461 736b 2e63 6f6e 6669  f not dask.confi
-000208a0: 672e 6765 7428 2264 6973 7472 6962 7574  g.get("distribut
-000208b0: 6564 2e73 6368 6564 756c 6572 2e77 6f72  ed.scheduler.wor
-000208c0: 6b2d 7374 6561 6c69 6e67 2229 3a0a 2020  k-stealing"):.  
-000208d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000208e0: 2022 7374 6561 6c69 6e67 2220 696e 2065   "stealing" in e
-000208f0: 7874 656e 7369 6f6e 733a 0a20 2020 2020  xtensions:.     
-00020900: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00020910: 656c 2065 7874 656e 7369 6f6e 735b 2273  el extensions["s
-00020920: 7465 616c 696e 6722 5d0a 0a20 2020 2020  tealing"]..     
-00020930: 2020 2066 6f72 206e 616d 652c 2065 7874     for name, ext
-00020940: 656e 7369 6f6e 2069 6e20 6578 7465 6e73  ension in extens
-00020950: 696f 6e73 2e69 7465 6d73 2829 3a0a 2020  ions.items():.  
-00020960: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
-00020970: 7874 656e 7369 6f6e 735b 6e61 6d65 5d20  xtensions[name] 
-00020980: 3d20 6578 7465 6e73 696f 6e28 7365 6c66  = extension(self
-00020990: 290a 0a20 2020 2020 2020 2073 6574 7072  )..        setpr
-000209a0: 6f63 7469 746c 6528 2264 6173 6b20 7363  octitle("dask sc
-000209b0: 6865 6475 6c65 7220 5b6e 6f74 2073 7461  heduler [not sta
-000209c0: 7274 6564 5d22 290a 2020 2020 2020 2020  rted]").        
-000209d0: 5363 6865 6475 6c65 722e 5f69 6e73 7461  Scheduler._insta
-000209e0: 6e63 6573 2e61 6464 2873 656c 6629 0a20  nces.add(self). 
-000209f0: 2020 2020 2020 2073 656c 662e 7270 632e         self.rpc.
-00020a00: 616c 6c6f 775f 6f66 666c 6f61 6420 3d20  allow_offload = 
-00020a10: 4661 6c73 650a 0a20 2020 2023 2323 2323  False..    #####
-00020a20: 2323 2323 2323 2323 2323 2323 230a 2020  #############.  
-00020a30: 2020 2320 4164 6d69 6e69 7374 7261 7469    # Administrati
-00020a40: 6f6e 2023 0a20 2020 2023 2323 2323 2323  on #.    #######
-00020a50: 2323 2323 2323 2323 2323 230a 0a20 2020  ###########..   
-00020a60: 2064 6566 205f 5f72 6570 725f 5f28 7365   def __repr__(se
-00020a70: 6c66 293a 0a20 2020 2020 2020 2072 6574  lf):.        ret
-00020a80: 7572 6e20 280a 2020 2020 2020 2020 2020  urn (.          
-00020a90: 2020 6622 3c53 6368 6564 756c 6572 207b    f"<Scheduler {
-00020aa0: 7365 6c66 2e61 6464 7265 7373 5f73 6166  self.address_saf
-00020ab0: 6521 727d 2c20 220a 2020 2020 2020 2020  e!r}, ".        
-00020ac0: 2020 2020 6622 776f 726b 6572 733a 207b      f"workers: {
-00020ad0: 6c65 6e28 7365 6c66 2e77 6f72 6b65 7273  len(self.workers
-00020ae0: 297d 2c20 220a 2020 2020 2020 2020 2020  )}, ".          
-00020af0: 2020 6622 636f 7265 733a 207b 7365 6c66    f"cores: {self
-00020b00: 2e74 6f74 616c 5f6e 7468 7265 6164 737d  .total_nthreads}
-00020b10: 2c20 220a 2020 2020 2020 2020 2020 2020  , ".            
-00020b20: 6622 7461 736b 733a 207b 6c65 6e28 7365  f"tasks: {len(se
-00020b30: 6c66 2e74 6173 6b73 297d 3e22 0a20 2020  lf.tasks)}>".   
-00020b40: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
-00020b50: 5f72 6570 725f 6874 6d6c 5f28 7365 6c66  _repr_html_(self
-00020b60: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-00020b70: 6e20 6765 745f 7465 6d70 6c61 7465 2822  n get_template("
-00020b80: 7363 6865 6475 6c65 722e 6874 6d6c 2e6a  scheduler.html.j
-00020b90: 3222 292e 7265 6e64 6572 280a 2020 2020  2").render(.    
-00020ba0: 2020 2020 2020 2020 6164 6472 6573 733d          address=
-00020bb0: 7365 6c66 2e61 6464 7265 7373 2c0a 2020  self.address,.  
-00020bc0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-00020bd0: 733d 7365 6c66 2e77 6f72 6b65 7273 2c0a  s=self.workers,.
-00020be0: 2020 2020 2020 2020 2020 2020 7468 7265              thre
-00020bf0: 6164 733d 7365 6c66 2e74 6f74 616c 5f6e  ads=self.total_n
-00020c00: 7468 7265 6164 732c 0a20 2020 2020 2020  threads,.       
-00020c10: 2020 2020 2074 6173 6b73 3d73 656c 662e       tasks=self.
-00020c20: 7461 736b 732c 0a20 2020 2020 2020 2029  tasks,.        )
-00020c30: 0a0a 2020 2020 6465 6620 6964 656e 7469  ..    def identi
-00020c40: 7479 2873 656c 6629 3a0a 2020 2020 2020  ty(self):.      
-00020c50: 2020 2222 2242 6173 6963 2069 6e66 6f72    """Basic infor
-00020c60: 6d61 7469 6f6e 2061 626f 7574 206f 7572  mation about our
-00020c70: 7365 6c76 6573 2061 6e64 206f 7572 2063  selves and our c
-00020c80: 6c75 7374 6572 2222 220a 2020 2020 2020  luster""".      
-00020c90: 2020 6420 3d20 7b0a 2020 2020 2020 2020    d = {.        
-00020ca0: 2020 2020 2274 7970 6522 3a20 7479 7065      "type": type
-00020cb0: 2873 656c 6629 2e5f 5f6e 616d 655f 5f2c  (self).__name__,
-00020cc0: 0a20 2020 2020 2020 2020 2020 2022 6964  .            "id
-00020cd0: 223a 2073 7472 2873 656c 662e 6964 292c  ": str(self.id),
-00020ce0: 0a20 2020 2020 2020 2020 2020 2022 6164  .            "ad
-00020cf0: 6472 6573 7322 3a20 7365 6c66 2e61 6464  dress": self.add
-00020d00: 7265 7373 2c0a 2020 2020 2020 2020 2020  ress,.          
-00020d10: 2020 2273 6572 7669 6365 7322 3a20 7b6b    "services": {k
-00020d20: 6579 3a20 762e 706f 7274 2066 6f72 2028  ey: v.port for (
-00020d30: 6b65 792c 2076 2920 696e 2073 656c 662e  key, v) in self.
-00020d40: 7365 7276 6963 6573 2e69 7465 6d73 2829  services.items()
-00020d50: 7d2c 0a20 2020 2020 2020 2020 2020 2022  },.            "
-00020d60: 7374 6172 7465 6422 3a20 7365 6c66 2e74  started": self.t
-00020d70: 696d 655f 7374 6172 7465 642c 0a20 2020  ime_started,.   
-00020d80: 2020 2020 2020 2020 2022 776f 726b 6572           "worker
-00020d90: 7322 3a20 7b0a 2020 2020 2020 2020 2020  s": {.          
-00020da0: 2020 2020 2020 776f 726b 6572 2e61 6464        worker.add
-00020db0: 7265 7373 3a20 776f 726b 6572 2e69 6465  ress: worker.ide
-00020dc0: 6e74 6974 7928 2920 666f 7220 776f 726b  ntity() for work
-00020dd0: 6572 2069 6e20 7365 6c66 2e77 6f72 6b65  er in self.worke
-00020de0: 7273 2e76 616c 7565 7328 290a 2020 2020  rs.values().    
-00020df0: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-00020e00: 2020 207d 0a20 2020 2020 2020 2072 6574     }.        ret
-00020e10: 7572 6e20 640a 0a20 2020 2064 6566 205f  urn d..    def _
-00020e20: 746f 5f64 6963 7428 7365 6c66 2c20 2a2c  to_dict(self, *,
-00020e30: 2065 7863 6c75 6465 3a20 436f 6e74 6169   exclude: Contai
-00020e40: 6e65 725b 7374 725d 203d 2028 2929 202d  ner[str] = ()) -
-00020e50: 3e20 6469 6374 3a0a 2020 2020 2020 2020  > dict:.        
-00020e60: 2222 2244 6963 7469 6f6e 6172 7920 7265  """Dictionary re
-00020e70: 7072 6573 656e 7461 7469 6f6e 2066 6f72  presentation for
-00020e80: 2064 6562 7567 6769 6e67 2070 7572 706f   debugging purpo
-00020e90: 7365 732e 0a20 2020 2020 2020 204e 6f74  ses..        Not
-00020ea0: 2074 7970 6520 7374 6162 6c65 2061 6e64   type stable and
-00020eb0: 206e 6f74 2069 6e74 656e 6465 6420 666f   not intended fo
-00020ec0: 7220 726f 756e 6474 7269 7073 2e0a 0a20  r roundtrips... 
-00020ed0: 2020 2020 2020 2053 6565 2061 6c73 6f0a         See also.
-00020ee0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
-00020ef0: 0a20 2020 2020 2020 2053 6572 7665 722e  .        Server.
-00020f00: 6964 656e 7469 7479 0a20 2020 2020 2020  identity.       
-00020f10: 2043 6c69 656e 742e 6475 6d70 5f63 6c75   Client.dump_clu
-00020f20: 7374 6572 5f73 7461 7465 0a20 2020 2020  ster_state.     
-00020f30: 2020 2064 6973 7472 6962 7574 6564 2e75     distributed.u
-00020f40: 7469 6c73 2e72 6563 7572 7369 7665 5f74  tils.recursive_t
-00020f50: 6f5f 6469 6374 0a20 2020 2020 2020 2022  o_dict.        "
-00020f60: 2222 0a20 2020 2020 2020 2069 6e66 6f20  "".        info 
-00020f70: 3d20 7375 7065 7228 292e 5f74 6f5f 6469  = super()._to_di
-00020f80: 6374 2865 7863 6c75 6465 3d65 7863 6c75  ct(exclude=exclu
-00020f90: 6465 290a 2020 2020 2020 2020 6578 7472  de).        extr
-00020fa0: 6120 3d20 7b0a 2020 2020 2020 2020 2020  a = {.          
-00020fb0: 2020 2274 7261 6e73 6974 696f 6e5f 6c6f    "transition_lo
-00020fc0: 6722 3a20 7365 6c66 2e74 7261 6e73 6974  g": self.transit
-00020fd0: 696f 6e5f 6c6f 672c 0a20 2020 2020 2020  ion_log,.       
-00020fe0: 2020 2020 2022 7472 616e 7369 7469 6f6e       "transition
-00020ff0: 5f63 6f75 6e74 6572 223a 2073 656c 662e  _counter": self.
-00021000: 7472 616e 7369 7469 6f6e 5f63 6f75 6e74  transition_count
-00021010: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
-00021020: 2274 6173 6b73 223a 2073 656c 662e 7461  "tasks": self.ta
-00021030: 736b 732c 0a20 2020 2020 2020 2020 2020  sks,.           
-00021040: 2022 7461 736b 5f67 726f 7570 7322 3a20   "task_groups": 
-00021050: 7365 6c66 2e74 6173 6b5f 6772 6f75 7073  self.task_groups
-00021060: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00021070: 4f76 6572 7772 6974 6520 6469 6374 206f  Overwrite dict o
-00021080: 6620 576f 726b 6572 5374 6174 652e 6964  f WorkerState.id
-00021090: 656e 7469 7479 2066 726f 6d20 696e 666f  entity from info
-000210a0: 0a20 2020 2020 2020 2020 2020 2022 776f  .            "wo
-000210b0: 726b 6572 7322 3a20 7365 6c66 2e77 6f72  rkers": self.wor
-000210c0: 6b65 7273 2c0a 2020 2020 2020 2020 2020  kers,.          
-000210d0: 2020 2263 6c69 656e 7473 223a 2073 656c    "clients": sel
-000210e0: 662e 636c 6965 6e74 732c 0a20 2020 2020  f.clients,.     
-000210f0: 2020 2020 2020 2022 6d65 6d6f 7279 223a         "memory":
-00021100: 2073 656c 662e 6d65 6d6f 7279 2c0a 2020   self.memory,.  
-00021110: 2020 2020 2020 2020 2020 2265 7665 6e74            "event
-00021120: 7322 3a20 7365 6c66 2e65 7665 6e74 732c  s": self.events,
-00021130: 0a20 2020 2020 2020 2020 2020 2022 6578  .            "ex
-00021140: 7465 6e73 696f 6e73 223a 2073 656c 662e  tensions": self.
-00021150: 6578 7465 6e73 696f 6e73 2c0a 2020 2020  extensions,.    
-00021160: 2020 2020 7d0a 2020 2020 2020 2020 6578      }.        ex
-00021170: 7472 6120 3d20 7b6b 3a20 7620 666f 7220  tra = {k: v for 
-00021180: 6b2c 2076 2069 6e20 6578 7472 612e 6974  k, v in extra.it
-00021190: 656d 7328 2920 6966 206b 206e 6f74 2069  ems() if k not i
-000211a0: 6e20 6578 636c 7564 657d 0a20 2020 2020  n exclude}.     
-000211b0: 2020 2069 6e66 6f2e 7570 6461 7465 2872     info.update(r
-000211c0: 6563 7572 7369 7665 5f74 6f5f 6469 6374  ecursive_to_dict
-000211d0: 2865 7874 7261 2c20 6578 636c 7564 653d  (extra, exclude=
-000211e0: 6578 636c 7564 6529 290a 2020 2020 2020  exclude)).      
-000211f0: 2020 7265 7475 726e 2069 6e66 6f0a 0a20    return info.. 
-00021200: 2020 2061 7379 6e63 2064 6566 2067 6574     async def get
-00021210: 5f63 6c75 7374 6572 5f73 7461 7465 280a  _cluster_state(.
-00021220: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-00021230: 2020 2020 2020 6578 636c 7564 653a 2022        exclude: "
-00021240: 436f 6c6c 6563 7469 6f6e 5b73 7472 5d22  Collection[str]"
-00021250: 2c0a 2020 2020 2920 2d3e 2064 6963 743a  ,.    ) -> dict:
-00021260: 0a20 2020 2020 2020 2022 5072 6f64 7563  .        "Produc
-00021270: 6520 7468 6520 7374 6174 6520 6469 6374  e the state dict
-00021280: 2075 7365 6420 696e 2061 2063 6c75 7374   used in a clust
-00021290: 6572 2073 7461 7465 2064 756d 7022 0a20  er state dump". 
-000212a0: 2020 2020 2020 2023 204b 6963 6b20 6f66         # Kick of
-000212b0: 6620 7374 6174 652d 6475 6d70 696e 6720  f state-dumping 
-000212c0: 6f6e 2077 6f72 6b65 7273 2062 6566 6f72  on workers befor
-000212d0: 6520 7765 2062 6c6f 636b 2074 6865 2065  e we block the e
-000212e0: 7665 6e74 206c 6f6f 7020 696e 2060 7365  vent loop in `se
-000212f0: 6c66 2e5f 746f 5f64 6963 7460 2e0a 2020  lf._to_dict`..  
-00021300: 2020 2020 2020 776f 726b 6572 735f 6675        workers_fu
-00021310: 7475 7265 203d 2061 7379 6e63 696f 2e67  ture = asyncio.g
-00021320: 6174 6865 7228 0a20 2020 2020 2020 2020  ather(.         
-00021330: 2020 2073 656c 662e 6272 6f61 6463 6173     self.broadcas
-00021340: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-00021350: 2020 206d 7367 3d7b 226f 7022 3a20 2264     msg={"op": "d
-00021360: 756d 705f 7374 6174 6522 2c20 2265 7863  ump_state", "exc
-00021370: 6c75 6465 223a 2065 7863 6c75 6465 7d2c  lude": exclude},
-00021380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021390: 206f 6e5f 6572 726f 723d 2272 6574 7572   on_error="retur
-000213a0: 6e22 2c0a 2020 2020 2020 2020 2020 2020  n",.            
-000213b0: 292c 0a20 2020 2020 2020 2020 2020 2073  ),.            s
-000213c0: 656c 662e 6272 6f61 6463 6173 7428 0a20  elf.broadcast(. 
-000213d0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-000213e0: 7367 3d7b 226f 7022 3a20 2276 6572 7369  sg={"op": "versi
-000213f0: 6f6e 7322 7d2c 0a20 2020 2020 2020 2020  ons"},.         
-00021400: 2020 2020 2020 206f 6e5f 6572 726f 723d         on_error=
-00021410: 2269 676e 6f72 6522 2c0a 2020 2020 2020  "ignore",.      
-00021420: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
-00021430: 2029 0a20 2020 2020 2020 2074 7279 3a0a   ).        try:.
-00021440: 2020 2020 2020 2020 2020 2020 7363 6865              sche
-00021450: 6475 6c65 725f 7374 6174 6520 3d20 7365  duler_state = se
-00021460: 6c66 2e5f 746f 5f64 6963 7428 6578 636c  lf._to_dict(excl
-00021470: 7564 653d 6578 636c 7564 6529 0a0a 2020  ude=exclude)..  
-00021480: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-00021490: 5f73 7461 7465 732c 2077 6f72 6b65 725f  _states, worker_
-000214a0: 7665 7273 696f 6e73 203d 2061 7761 6974  versions = await
-000214b0: 2077 6f72 6b65 7273 5f66 7574 7572 650a   workers_future.
-000214c0: 2020 2020 2020 2020 6669 6e61 6c6c 793a          finally:
-000214d0: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
-000214e0: 6e73 7572 6520 7468 6520 7461 736b 7320  nsure the tasks 
-000214f0: 6172 656e 2774 206c 6566 7420 7275 6e6e  aren't left runn
-00021500: 696e 6720 6966 2061 6e79 7468 696e 6720  ing if anything 
-00021510: 6661 696c 732e 0a20 2020 2020 2020 2020  fails..         
-00021520: 2020 2023 2053 6f6d 6564 6179 2028 7079     # Someday (py
-00021530: 332e 3131 292c 2075 7365 2061 2074 7269  3.11), use a tri
-00021540: 6f2d 7374 796c 6520 5461 736b 4772 6f75  o-style TaskGrou
-00021550: 7020 666f 7220 7468 6973 2e0a 2020 2020  p for this..    
-00021560: 2020 2020 2020 2020 776f 726b 6572 735f          workers_
-00021570: 6675 7475 7265 2e63 616e 6365 6c28 290a  future.cancel().
-00021580: 0a20 2020 2020 2020 2023 2043 6f6e 7665  .        # Conve
-00021590: 7274 2061 6e79 2052 5043 2065 7272 6f72  rt any RPC error
-000215a0: 7320 746f 2073 7472 696e 6773 0a20 2020  s to strings.   
-000215b0: 2020 2020 2077 6f72 6b65 725f 7374 6174       worker_stat
-000215c0: 6573 203d 207b 0a20 2020 2020 2020 2020  es = {.         
-000215d0: 2020 206b 3a20 7265 7072 2876 2920 6966     k: repr(v) if
-000215e0: 2069 7369 6e73 7461 6e63 6528 762c 2045   isinstance(v, E
-000215f0: 7863 6570 7469 6f6e 2920 656c 7365 2076  xception) else v
-00021600: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00021610: 206b 2c20 7620 696e 2077 6f72 6b65 725f   k, v in worker_
-00021620: 7374 6174 6573 2e69 7465 6d73 2829 0a20  states.items(). 
-00021630: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00021640: 2020 7265 7475 726e 207b 0a20 2020 2020    return {.     
-00021650: 2020 2020 2020 2022 7363 6865 6475 6c65         "schedule
-00021660: 7222 3a20 7363 6865 6475 6c65 725f 7374  r": scheduler_st
-00021670: 6174 652c 0a20 2020 2020 2020 2020 2020  ate,.           
-00021680: 2022 776f 726b 6572 7322 3a20 776f 726b   "workers": work
-00021690: 6572 5f73 7461 7465 732c 0a20 2020 2020  er_states,.     
-000216a0: 2020 2020 2020 2022 7665 7273 696f 6e73         "versions
-000216b0: 223a 207b 2273 6368 6564 756c 6572 223a  ": {"scheduler":
-000216c0: 2073 656c 662e 7665 7273 696f 6e73 2829   self.versions()
-000216d0: 2c20 2277 6f72 6b65 7273 223a 2077 6f72  , "workers": wor
-000216e0: 6b65 725f 7665 7273 696f 6e73 7d2c 0a20  ker_versions},. 
-000216f0: 2020 2020 2020 207d 0a0a 2020 2020 6173         }..    as
-00021700: 796e 6320 6465 6620 6475 6d70 5f63 6c75  ync def dump_clu
-00021710: 7374 6572 5f73 7461 7465 5f74 6f5f 7572  ster_state_to_ur
-00021720: 6c28 0a20 2020 2020 2020 2073 656c 662c  l(.        self,
-00021730: 0a20 2020 2020 2020 2075 726c 3a20 7374  .        url: st
-00021740: 722c 0a20 2020 2020 2020 2065 7863 6c75  r,.        exclu
-00021750: 6465 3a20 2243 6f6c 6c65 6374 696f 6e5b  de: "Collection[
-00021760: 7374 725d 222c 0a20 2020 2020 2020 2066  str]",.        f
-00021770: 6f72 6d61 743a 204c 6974 6572 616c 5b22  ormat: Literal["
-00021780: 6d73 6770 6163 6b22 2c20 2279 616d 6c22  msgpack", "yaml"
-00021790: 5d2c 0a20 2020 2020 2020 202a 2a73 746f  ],.        **sto
-000217a0: 7261 6765 5f6f 7074 696f 6e73 3a20 6469  rage_options: di
-000217b0: 6374 5b73 7472 2c20 416e 795d 2c0a 2020  ct[str, Any],.  
-000217c0: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
-000217d0: 2020 2020 2022 5772 6974 6520 6120 636c       "Write a cl
-000217e0: 7573 7465 7220 7374 6174 6520 6475 6d70  uster state dump
-000217f0: 2074 6f20 616e 2066 7373 7065 632d 636f   to an fsspec-co
-00021800: 6d70 6174 6962 6c65 2055 524c 2e22 0a20  mpatible URL.". 
-00021810: 2020 2020 2020 2061 7761 6974 2063 6c75         await clu
-00021820: 7374 6572 5f64 756d 702e 7772 6974 655f  ster_dump.write_
-00021830: 7374 6174 6528 0a20 2020 2020 2020 2020  state(.         
-00021840: 2020 2070 6172 7469 616c 2873 656c 662e     partial(self.
-00021850: 6765 745f 636c 7573 7465 725f 7374 6174  get_cluster_stat
-00021860: 652c 2065 7863 6c75 6465 292c 2075 726c  e, exclude), url
-00021870: 2c20 666f 726d 6174 2c20 2a2a 7374 6f72  , format, **stor
-00021880: 6167 655f 6f70 7469 6f6e 730a 2020 2020  age_options.    
-00021890: 2020 2020 290a 0a20 2020 2064 6566 2067      )..    def g
-000218a0: 6574 5f77 6f72 6b65 725f 7365 7276 6963  et_worker_servic
-000218b0: 655f 6164 6472 280a 2020 2020 2020 2020  e_addr(.        
-000218c0: 7365 6c66 2c20 776f 726b 6572 3a20 7374  self, worker: st
-000218d0: 722c 2073 6572 7669 6365 5f6e 616d 653a  r, service_name:
-000218e0: 2073 7472 2c20 7072 6f74 6f63 6f6c 3a20   str, protocol: 
-000218f0: 626f 6f6c 203d 2046 616c 7365 0a20 2020  bool = False.   
-00021900: 2029 202d 3e20 7475 706c 655b 7374 722c   ) -> tuple[str,
-00021910: 2069 6e74 5d20 7c20 7374 7220 7c20 4e6f   int] | str | No
-00021920: 6e65 3a0a 2020 2020 2020 2020 2222 220a  ne:.        """.
-00021930: 2020 2020 2020 2020 4765 7420 7468 6520          Get the 
-00021940: 2868 6f73 742c 2070 6f72 7429 2061 6464  (host, port) add
-00021950: 7265 7373 206f 6620 7468 6520 6e61 6d65  ress of the name
-00021960: 6420 7365 7276 6963 6520 6f6e 2074 6865  d service on the
-00021970: 202a 776f 726b 6572 2a2e 0a20 2020 2020   *worker*..     
-00021980: 2020 2052 6574 7572 6e73 204e 6f6e 6520     Returns None 
-00021990: 6966 2074 6865 2073 6572 7669 6365 2064  if the service d
-000219a0: 6f65 736e 2774 2065 7869 7374 2e0a 0a20  oesn't exist... 
-000219b0: 2020 2020 2020 2050 6172 616d 6574 6572         Parameter
-000219c0: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
-000219d0: 2d2d 2d2d 0a20 2020 2020 2020 2077 6f72  ----.        wor
-000219e0: 6b65 7220 3a20 6164 6472 6573 730a 2020  ker : address.  
-000219f0: 2020 2020 2020 7365 7276 6963 655f 6e61        service_na
-00021a00: 6d65 203a 2073 7472 0a20 2020 2020 2020  me : str.       
-00021a10: 2020 2020 2043 6f6d 6d6f 6e20 7365 7276       Common serv
-00021a20: 6963 6573 2069 6e63 6c75 6465 2027 626f  ices include 'bo
-00021a30: 6b65 6827 2061 6e64 2027 6e61 6e6e 7927  keh' and 'nanny'
-00021a40: 0a20 2020 2020 2020 2070 726f 746f 636f  .        protoco
-00021a50: 6c20 3a20 626f 6f6c 6561 6e0a 2020 2020  l : boolean.    
-00021a60: 2020 2020 2020 2020 5768 6574 6865 7220          Whether 
-00021a70: 6f72 206e 6f74 2074 6f20 696e 636c 7564  or not to includ
-00021a80: 6520 6120 6675 6c6c 2061 6464 7265 7373  e a full address
-00021a90: 2077 6974 6820 7072 6f74 6f63 6f6c 2028   with protocol (
-00021aa0: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
-00021ab0: 2020 6f72 206a 7573 7420 6120 2868 6f73    or just a (hos
-00021ac0: 742c 2070 6f72 7429 2070 6169 720a 2020  t, port) pair.  
-00021ad0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00021ae0: 2020 7773 203d 2073 656c 662e 776f 726b    ws = self.work
-00021af0: 6572 735b 776f 726b 6572 5d0a 2020 2020  ers[worker].    
-00021b00: 2020 2020 706f 7274 203d 2077 732e 7365      port = ws.se
-00021b10: 7276 6963 6573 2e67 6574 2873 6572 7669  rvices.get(servi
-00021b20: 6365 5f6e 616d 6529 0a20 2020 2020 2020  ce_name).       
-00021b30: 2069 6620 706f 7274 2069 7320 4e6f 6e65   if port is None
-00021b40: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00021b50: 7475 726e 204e 6f6e 650a 2020 2020 2020  turn None.      
-00021b60: 2020 656c 6966 2070 726f 746f 636f 6c3a    elif protocol:
-00021b70: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00021b80: 7572 6e20 2225 2870 726f 746f 636f 6c29  urn "%(protocol)
-00021b90: 733a 2f2f 2528 686f 7374 2973 3a25 2870  s://%(host)s:%(p
-00021ba0: 6f72 7429 6422 2025 207b 0a20 2020 2020  ort)d" % {.     
-00021bb0: 2020 2020 2020 2020 2020 2022 7072 6f74             "prot
-00021bc0: 6f63 6f6c 223a 2077 732e 6164 6472 6573  ocol": ws.addres
-00021bd0: 732e 7370 6c69 7428 223a 2f2f 2229 5b30  s.split("://")[0
-00021be0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00021bf0: 2020 2022 686f 7374 223a 2077 732e 686f     "host": ws.ho
-00021c00: 7374 2c0a 2020 2020 2020 2020 2020 2020  st,.            
-00021c10: 2020 2020 2270 6f72 7422 3a20 706f 7274      "port": port
-00021c20: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
-00021c30: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00021c40: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00021c50: 2077 732e 686f 7374 2c20 706f 7274 0a0a   ws.host, port..
-00021c60: 2020 2020 6173 796e 6320 6465 6620 7374      async def st
-00021c70: 6172 745f 756e 7361 6665 2873 656c 6629  art_unsafe(self)
-00021c80: 3a0a 2020 2020 2020 2020 2222 2243 6c65  :.        """Cle
-00021c90: 6172 206f 7574 206f 6c64 2073 7461 7465  ar out old state
-00021ca0: 2061 6e64 2072 6573 7461 7274 2061 6c6c   and restart all
-00021cb0: 2072 756e 6e69 6e67 2063 6f72 6f75 7469   running corouti
-00021cc0: 6e65 7322 2222 0a20 2020 2020 2020 2061  nes""".        a
-00021cd0: 7761 6974 2073 7570 6572 2829 2e73 7461  wait super().sta
-00021ce0: 7274 5f75 6e73 6166 6528 290a 0a20 2020  rt_unsafe()..   
-00021cf0: 2020 2020 2065 6e61 626c 655f 6763 5f64       enable_gc_d
-00021d00: 6961 676e 6f73 6973 2829 0a0a 2020 2020  iagnosis()..    
-00021d10: 2020 2020 7365 6c66 2e5f 636c 6561 725f      self._clear_
-00021d20: 7461 736b 5f73 7461 7465 2829 0a0a 2020  task_state()..  
-00021d30: 2020 2020 2020 666f 7220 6164 6472 2069        for addr i
-00021d40: 6e20 7365 6c66 2e5f 7374 6172 745f 6164  n self._start_ad
-00021d50: 6472 6573 733a 0a20 2020 2020 2020 2020  dress:.         
-00021d60: 2020 2061 7761 6974 2073 656c 662e 6c69     await self.li
-00021d70: 7374 656e 280a 2020 2020 2020 2020 2020  sten(.          
-00021d80: 2020 2020 2020 6164 6472 2c0a 2020 2020        addr,.    
-00021d90: 2020 2020 2020 2020 2020 2020 616c 6c6f              allo
-00021da0: 775f 6f66 666c 6f61 643d 4661 6c73 652c  w_offload=False,
-00021db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021dc0: 2068 616e 6473 6861 6b65 5f6f 7665 7272   handshake_overr
-00021dd0: 6964 6573 3d7b 2270 6963 6b6c 652d 7072  ides={"pickle-pr
-00021de0: 6f74 6f63 6f6c 223a 2034 2c20 2263 6f6d  otocol": 4, "com
-00021df0: 7072 6573 7369 6f6e 223a 204e 6f6e 657d  pression": None}
-00021e00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00021e10: 2020 2a2a 7365 6c66 2e73 6563 7572 6974    **self.securit
-00021e20: 792e 6765 745f 6c69 7374 656e 5f61 7267  y.get_listen_arg
-00021e30: 7328 2273 6368 6564 756c 6572 2229 2c0a  s("scheduler"),.
-00021e40: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00021e50: 2020 2020 2020 2020 2020 7365 6c66 2e69            self.i
-00021e60: 7020 3d20 6765 745f 6164 6472 6573 735f  p = get_address_
-00021e70: 686f 7374 2873 656c 662e 6c69 7374 656e  host(self.listen
-00021e80: 5f61 6464 7265 7373 290a 2020 2020 2020  _address).      
-00021e90: 2020 2020 2020 6c69 7374 656e 5f69 7020        listen_ip 
-00021ea0: 3d20 7365 6c66 2e69 700a 0a20 2020 2020  = self.ip..     
-00021eb0: 2020 2020 2020 2069 6620 6c69 7374 656e         if listen
-00021ec0: 5f69 7020 3d3d 2022 302e 302e 302e 3022  _ip == "0.0.0.0"
-00021ed0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00021ee0: 2020 6c69 7374 656e 5f69 7020 3d20 2222    listen_ip = ""
-00021ef0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00021f00: 662e 6164 6472 6573 732e 7374 6172 7473  f.address.starts
-00021f10: 7769 7468 2822 696e 7072 6f63 3a2f 2f22  with("inproc://"
-00021f20: 293a 0a20 2020 2020 2020 2020 2020 206c  ):.            l
-00021f30: 6973 7465 6e5f 6970 203d 2022 6c6f 6361  isten_ip = "loca
-00021f40: 6c68 6f73 7422 0a0a 2020 2020 2020 2020  lhost"..        
-00021f50: 2320 5365 7276 6963 6573 206c 6973 7465  # Services liste
-00021f60: 6e20 6f6e 2061 6c6c 2061 6464 7265 7373  n on all address
-00021f70: 6573 0a20 2020 2020 2020 2073 656c 662e  es.        self.
-00021f80: 7374 6172 745f 7365 7276 6963 6573 286c  start_services(l
-00021f90: 6973 7465 6e5f 6970 290a 0a20 2020 2020  isten_ip)..     
-00021fa0: 2020 2066 6f72 206c 6973 7465 6e65 7220     for listener 
-00021fb0: 696e 2073 656c 662e 6c69 7374 656e 6572  in self.listener
-00021fc0: 733a 0a20 2020 2020 2020 2020 2020 206c  s:.            l
-00021fd0: 6f67 6765 722e 696e 666f 2822 2020 5363  ogger.info("  Sc
-00021fe0: 6865 6475 6c65 7220 6174 3a20 2532 3573  heduler at: %25s
-00021ff0: 222c 206c 6973 7465 6e65 722e 636f 6e74  ", listener.cont
-00022000: 6163 745f 6164 6472 6573 7329 0a20 2020  act_address).   
-00022010: 2020 2020 2066 6f72 206e 616d 652c 2073       for name, s
-00022020: 6572 7665 7220 696e 2073 656c 662e 7365  erver in self.se
-00022030: 7276 6963 6573 2e69 7465 6d73 2829 3a0a  rvices.items():.
-00022040: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00022050: 616d 6520 3d3d 2022 6461 7368 626f 6172  ame == "dashboar
-00022060: 6422 3a0a 2020 2020 2020 2020 2020 2020  d":.            
-00022070: 2020 2020 6164 6472 203d 2067 6574 5f61      addr = get_a
-00022080: 6464 7265 7373 5f68 6f73 7428 6c69 7374  ddress_host(list
-00022090: 656e 6572 2e63 6f6e 7461 6374 5f61 6464  ener.contact_add
-000220a0: 7265 7373 290a 2020 2020 2020 2020 2020  ress).          
-000220b0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-000220c0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-000220d0: 696e 6b20 3d20 666f 726d 6174 5f64 6173  ink = format_das
-000220e0: 6862 6f61 7264 5f6c 696e 6b28 6164 6472  hboard_link(addr
-000220f0: 2c20 7365 7276 6572 2e70 6f72 7429 0a20  , server.port). 
-00022100: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00022110: 2066 6f72 6d61 7474 696e 6720 6461 7368   formatting dash
-00022120: 626f 6172 6420 6c69 6e6b 2063 616e 2066  board link can f
-00022130: 6169 6c20 6966 2064 6973 7472 6962 7574  ail if distribut
-00022140: 6564 2e64 6173 6862 6f61 7264 2e6c 696e  ed.dashboard.lin
-00022150: 6b0a 2020 2020 2020 2020 2020 2020 2020  k.              
-00022160: 2020 2320 7265 6665 7273 2074 6f20 6e6f    # refers to no
-00022170: 6e2d 6578 6973 7461 6e74 2065 6e76 2076  n-existant env v
-00022180: 6172 732e 0a20 2020 2020 2020 2020 2020  ars..           
-00022190: 2020 2020 2065 7863 6570 7420 4b65 7945       except KeyE
-000221a0: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
-000221b0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-000221c0: 6f67 6765 722e 7761 726e 696e 6728 0a20  ogger.warning(. 
-000221d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000221e0: 2020 2020 2020 2066 2246 6169 6c65 6420         f"Failed 
-000221f0: 746f 2066 6f72 6d61 7420 6461 7368 626f  to format dashbo
-00022200: 6172 6420 6c69 6e6b 2c20 756e 6b6e 6f77  ard link, unknow
-00022210: 6e20 7661 6c75 653a 207b 657d 220a 2020  n value: {e}".  
-00022220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022230: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00022240: 2020 2020 2020 2020 6c69 6e6b 203d 2066          link = f
-00022250: 223a 7b73 6572 7665 722e 706f 7274 7d22  ":{server.port}"
-00022260: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00022270: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00022280: 2020 206c 696e 6b20 3d20 6622 7b6c 6973     link = f"{lis
-00022290: 7465 6e5f 6970 7d3a 7b73 6572 7665 722e  ten_ip}:{server.
-000222a0: 706f 7274 7d22 0a20 2020 2020 2020 2020  port}".         
-000222b0: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
-000222c0: 2531 3173 2061 743a 2020 2532 3573 222c  %11s at:  %25s",
-000222d0: 206e 616d 652c 206c 696e 6b29 0a0a 2020   name, link)..  
-000222e0: 2020 2020 2020 6966 2073 656c 662e 7363        if self.sc
-000222f0: 6865 6475 6c65 725f 6669 6c65 3a0a 2020  heduler_file:.  
-00022300: 2020 2020 2020 2020 2020 7769 7468 206f            with o
-00022310: 7065 6e28 7365 6c66 2e73 6368 6564 756c  pen(self.schedul
-00022320: 6572 5f66 696c 652c 2022 7722 2920 6173  er_file, "w") as
-00022330: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
-00022340: 2020 2020 6a73 6f6e 2e64 756d 7028 7365      json.dump(se
-00022350: 6c66 2e69 6465 6e74 6974 7928 292c 2066  lf.identity(), f
-00022360: 2c20 696e 6465 6e74 3d32 290a 0a20 2020  , indent=2)..   
-00022370: 2020 2020 2020 2020 2066 6e20 3d20 7365           fn = se
-00022380: 6c66 2e73 6368 6564 756c 6572 5f66 696c  lf.scheduler_fil
-00022390: 6520 2023 2072 656d 6f76 6520 6669 6c65  e  # remove file
-000223a0: 2077 6865 6e20 7765 2063 6c6f 7365 2074   when we close t
-000223b0: 6865 2070 726f 6365 7373 0a0a 2020 2020  he process..    
-000223c0: 2020 2020 2020 2020 6465 6620 6465 6c5f          def del_
-000223d0: 7363 6865 6475 6c65 725f 6669 6c65 2829  scheduler_file()
-000223e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000223f0: 2020 6966 206f 732e 7061 7468 2e65 7869    if os.path.exi
-00022400: 7374 7328 666e 293a 0a20 2020 2020 2020  sts(fn):.       
-00022410: 2020 2020 2020 2020 2020 2020 206f 732e               os.
-00022420: 7265 6d6f 7665 2866 6e29 0a0a 2020 2020  remove(fn)..    
-00022430: 2020 2020 2020 2020 7765 616b 7265 662e          weakref.
-00022440: 6669 6e61 6c69 7a65 2873 656c 662c 2064  finalize(self, d
-00022450: 656c 5f73 6368 6564 756c 6572 5f66 696c  el_scheduler_fil
-00022460: 6529 0a0a 2020 2020 2020 2020 666f 7220  e)..        for 
-00022470: 7072 656c 6f61 6420 696e 2073 656c 662e  preload in self.
-00022480: 7072 656c 6f61 6473 3a0a 2020 2020 2020  preloads:.      
-00022490: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-000224a0: 2020 2020 2020 2020 2020 2061 7761 6974             await
-000224b0: 2070 7265 6c6f 6164 2e73 7461 7274 2829   preload.start()
-000224c0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-000224d0: 6570 7420 4578 6365 7074 696f 6e3a 0a20  ept Exception:. 
-000224e0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-000224f0: 6f67 6765 722e 6578 6365 7074 696f 6e28  ogger.exception(
-00022500: 2246 6169 6c65 6420 746f 2073 7461 7274  "Failed to start
-00022510: 2070 7265 6c6f 6164 2229 0a0a 2020 2020   preload")..    
-00022520: 2020 2020 6966 2073 656c 662e 6a75 7079      if self.jupy
-00022530: 7465 723a 0a20 2020 2020 2020 2020 2020  ter:.           
-00022540: 2023 2041 6c6c 6f77 2069 6e73 6563 7572   # Allow insecur
-00022550: 6520 636f 6d6d 756e 6963 6174 696f 6e73  e communications
-00022560: 2066 726f 6d20 6c6f 6361 6c20 7573 6572   from local user
-00022570: 730a 2020 2020 2020 2020 2020 2020 6966  s.            if
-00022580: 2073 656c 662e 6164 6472 6573 732e 7374   self.address.st
-00022590: 6172 7473 7769 7468 2822 746c 733a 2f2f  artswith("tls://
-000225a0: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
-000225b0: 2020 2020 6177 6169 7420 7365 6c66 2e6c      await self.l
-000225c0: 6973 7465 6e28 2274 6370 3a2f 2f6c 6f63  isten("tcp://loc
-000225d0: 616c 686f 7374 3a30 2229 0a20 2020 2020  alhost:0").     
-000225e0: 2020 2020 2020 206f 732e 656e 7669 726f         os.enviro
-000225f0: 6e5b 2244 4153 4b5f 5343 4845 4455 4c45  n["DASK_SCHEDULE
-00022600: 525f 4144 4452 4553 5322 5d20 3d20 7365  R_ADDRESS"] = se
-00022610: 6c66 2e6c 6973 7465 6e65 7273 5b2d 315d  lf.listeners[-1]
-00022620: 2e63 6f6e 7461 6374 5f61 6464 7265 7373  .contact_address
-00022630: 0a0a 2020 2020 2020 2020 6177 6169 7420  ..        await 
-00022640: 6173 796e 6369 6f2e 6761 7468 6572 280a  asyncio.gather(.
-00022650: 2020 2020 2020 2020 2020 2020 2a5b 706c              *[pl
-00022660: 7567 696e 2e73 7461 7274 2873 656c 6629  ugin.start(self)
-00022670: 2066 6f72 2070 6c75 6769 6e20 696e 206c   for plugin in l
-00022680: 6973 7428 7365 6c66 2e70 6c75 6769 6e73  ist(self.plugins
-00022690: 2e76 616c 7565 7328 2929 5d0a 2020 2020  .values())].    
-000226a0: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
-000226b0: 656c 662e 7374 6172 745f 7065 7269 6f64  elf.start_period
-000226c0: 6963 5f63 616c 6c62 6163 6b73 2829 0a0a  ic_callbacks()..
-000226d0: 2020 2020 2020 2020 7365 7470 726f 6374          setproct
-000226e0: 6974 6c65 2866 2264 6173 6b20 7363 6865  itle(f"dask sche
-000226f0: 6475 6c65 7220 5b7b 7365 6c66 2e61 6464  duler [{self.add
-00022700: 7265 7373 7d5d 2229 0a20 2020 2020 2020  ress}]").       
-00022710: 2072 6574 7572 6e20 7365 6c66 0a0a 2020   return self..  
-00022720: 2020 6173 796e 6320 6465 6620 636c 6f73    async def clos
-00022730: 6528 7365 6c66 2c20 6661 7374 3d4e 6f6e  e(self, fast=Non
-00022740: 652c 2063 6c6f 7365 5f77 6f72 6b65 7273  e, close_workers
-00022750: 3d4e 6f6e 6529 3a0a 2020 2020 2020 2020  =None):.        
-00022760: 2222 2253 656e 6420 636c 6561 6e75 7020  """Send cleanup 
-00022770: 7369 676e 616c 2074 6f20 616c 6c20 636f  signal to all co
-00022780: 726f 7574 696e 6573 2074 6865 6e20 7761  routines then wa
-00022790: 6974 2075 6e74 696c 2066 696e 6973 6865  it until finishe
-000227a0: 640a 0a20 2020 2020 2020 2053 6565 2041  d..        See A
-000227b0: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
-000227c0: 2d2d 2d2d 0a20 2020 2020 2020 2053 6368  ----.        Sch
-000227d0: 6564 756c 6572 2e63 6c65 616e 7570 0a20  eduler.cleanup. 
-000227e0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-000227f0: 2020 2069 6620 6661 7374 2069 7320 6e6f     if fast is no
-00022800: 7420 4e6f 6e65 206f 7220 636c 6f73 655f  t None or close_
-00022810: 776f 726b 6572 7320 6973 206e 6f74 204e  workers is not N
-00022820: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00022830: 2077 6172 6e69 6e67 732e 7761 726e 280a   warnings.warn(.
-00022840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022850: 2254 6865 2027 6661 7374 2720 616e 6420  "The 'fast' and 
-00022860: 2763 6c6f 7365 5f77 6f72 6b65 7273 2720  'close_workers' 
-00022870: 7061 7261 6d65 7465 7273 2069 6e20 5363  parameters in Sc
-00022880: 6865 6475 6c65 722e 636c 6f73 6520 6861  heduler.close ha
-00022890: 7665 206e 6f20 6566 6665 6374 2061 6e64  ve no effect and
-000228a0: 2077 696c 6c20 6265 2072 656d 6f76 6564   will be removed
-000228b0: 2069 6e20 6120 6675 7475 7265 2076 6572   in a future ver
-000228c0: 7369 6f6e 206f 6620 6469 7374 7269 6275  sion of distribu
-000228d0: 7465 642e 222c 0a20 2020 2020 2020 2020  ted.",.         
-000228e0: 2020 2020 2020 2046 7574 7572 6557 6172         FutureWar
-000228f0: 6e69 6e67 2c0a 2020 2020 2020 2020 2020  ning,.          
-00022900: 2020 290a 2020 2020 2020 2020 6966 2073    ).        if s
-00022910: 656c 662e 7374 6174 7573 2069 6e20 2853  elf.status in (S
-00022920: 7461 7475 732e 636c 6f73 696e 672c 2053  tatus.closing, S
-00022930: 7461 7475 732e 636c 6f73 6564 293a 0a20  tatus.closed):. 
-00022940: 2020 2020 2020 2020 2020 2061 7761 6974             await
-00022950: 2073 656c 662e 6669 6e69 7368 6564 2829   self.finished()
-00022960: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00022970: 7572 6e0a 0a20 2020 2020 2020 2061 7379  urn..        asy
-00022980: 6e63 2064 6566 206c 6f67 5f65 7272 6f72  nc def log_error
-00022990: 7328 6675 6e63 293a 0a20 2020 2020 2020  s(func):.       
-000229a0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-000229b0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-000229c0: 6675 6e63 2829 0a20 2020 2020 2020 2020  func().         
-000229d0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-000229e0: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
-000229f0: 2020 2020 206c 6f67 6765 722e 6578 6365       logger.exce
-00022a00: 7074 696f 6e28 2250 6c75 6769 6e20 6361  ption("Plugin ca
-00022a10: 6c6c 2066 6169 6c65 6420 6475 7269 6e67  ll failed during
-00022a20: 2073 6368 6564 756c 6572 2e63 6c6f 7365   scheduler.close
-00022a30: 2229 0a0a 2020 2020 2020 2020 6177 6169  ")..        awai
-00022a40: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
-00022a50: 280a 2020 2020 2020 2020 2020 2020 2a5b  (.            *[
-00022a60: 6c6f 675f 6572 726f 7273 2870 6c75 6769  log_errors(plugi
-00022a70: 6e2e 6265 666f 7265 5f63 6c6f 7365 2920  n.before_close) 
-00022a80: 666f 7220 706c 7567 696e 2069 6e20 6c69  for plugin in li
-00022a90: 7374 2873 656c 662e 706c 7567 696e 732e  st(self.plugins.
-00022aa0: 7661 6c75 6573 2829 295d 0a20 2020 2020  values())].     
-00022ab0: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
-00022ac0: 6c66 2e73 7461 7475 7320 3d20 5374 6174  lf.status = Stat
-00022ad0: 7573 2e63 6c6f 7369 6e67 0a0a 2020 2020  us.closing..    
-00022ae0: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
-00022af0: 2253 6368 6564 756c 6572 2063 6c6f 7369  "Scheduler closi
-00022b00: 6e67 2e2e 2e22 290a 2020 2020 2020 2020  ng...").        
-00022b10: 7365 7470 726f 6374 6974 6c65 2822 6461  setproctitle("da
-00022b20: 736b 2073 6368 6564 756c 6572 205b 636c  sk scheduler [cl
-00022b30: 6f73 696e 675d 2229 0a0a 2020 2020 2020  osing]")..      
-00022b40: 2020 666f 7220 7072 656c 6f61 6420 696e    for preload in
-00022b50: 2073 656c 662e 7072 656c 6f61 6473 3a0a   self.preloads:.
-00022b60: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00022b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022b80: 2061 7761 6974 2070 7265 6c6f 6164 2e74   await preload.t
-00022b90: 6561 7264 6f77 6e28 290a 2020 2020 2020  eardown().      
-00022ba0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-00022bb0: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-00022bc0: 2020 2020 2020 2020 6c6f 6767 6572 2e65          logger.e
-00022bd0: 7863 6570 7469 6f6e 2822 4661 696c 6564  xception("Failed
-00022be0: 2074 6f20 7465 6172 2064 6f77 6e20 7072   to tear down pr
-00022bf0: 656c 6f61 6422 290a 0a20 2020 2020 2020  eload")..       
-00022c00: 2061 7761 6974 2061 7379 6e63 696f 2e67   await asyncio.g
-00022c10: 6174 6865 7228 0a20 2020 2020 2020 2020  ather(.         
-00022c20: 2020 202a 5b6c 6f67 5f65 7272 6f72 7328     *[log_errors(
-00022c30: 706c 7567 696e 2e63 6c6f 7365 2920 666f  plugin.close) fo
-00022c40: 7220 706c 7567 696e 2069 6e20 6c69 7374  r plugin in list
-00022c50: 2873 656c 662e 706c 7567 696e 732e 7661  (self.plugins.va
-00022c60: 6c75 6573 2829 295d 0a20 2020 2020 2020  lues())].       
-00022c70: 2029 0a0a 2020 2020 2020 2020 666f 7220   )..        for 
-00022c80: 7063 2069 6e20 7365 6c66 2e70 6572 696f  pc in self.perio
-00022c90: 6469 635f 6361 6c6c 6261 636b 732e 7661  dic_callbacks.va
-00022ca0: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
-00022cb0: 2020 2020 7063 2e73 746f 7028 290a 2020      pc.stop().  
-00022cc0: 2020 2020 2020 7365 6c66 2e70 6572 696f        self.perio
-00022cd0: 6469 635f 6361 6c6c 6261 636b 732e 636c  dic_callbacks.cl
-00022ce0: 6561 7228 290a 0a20 2020 2020 2020 2073  ear()..        s
-00022cf0: 656c 662e 7374 6f70 5f73 6572 7669 6365  elf.stop_service
-00022d00: 7328 290a 0a20 2020 2020 2020 2066 6f72  s()..        for
-00022d10: 2065 7874 2069 6e20 7365 6c66 2e65 7874   ext in self.ext
-00022d20: 656e 7369 6f6e 732e 7661 6c75 6573 2829  ensions.values()
-00022d30: 3a0a 2020 2020 2020 2020 2020 2020 7769  :.            wi
-00022d40: 7468 2073 7570 7072 6573 7328 4174 7472  th suppress(Attr
-00022d50: 6962 7574 6545 7272 6f72 293a 0a20 2020  ibuteError):.   
-00022d60: 2020 2020 2020 2020 2020 2020 2065 7874               ext
-00022d70: 2e74 6561 7264 6f77 6e28 290a 2020 2020  .teardown().    
-00022d80: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
-00022d90: 2253 6368 6564 756c 6572 2063 6c6f 7369  "Scheduler closi
-00022da0: 6e67 2061 6c6c 2063 6f6d 6d73 2229 0a0a  ng all comms")..
-00022db0: 2020 2020 2020 2020 6675 7475 7265 7320          futures 
-00022dc0: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
-00022dd0: 205f 2c20 636f 6d6d 2069 6e20 6c69 7374   _, comm in list
-00022de0: 2873 656c 662e 7374 7265 616d 5f63 6f6d  (self.stream_com
-00022df0: 6d73 2e69 7465 6d73 2829 293a 0a20 2020  ms.items()):.   
-00022e00: 2020 2020 2020 2020 2023 2046 4958 4d45           # FIXME
-00022e10: 2075 7365 2060 7365 6c66 2e72 656d 6f76   use `self.remov
-00022e20: 655f 776f 726b 6572 2829 6020 696e 7374  e_worker()` inst
-00022e30: 6561 6420 6166 7465 7220 6874 7470 733a  ead after https:
-00022e40: 2f2f 6769 7468 7562 2e63 6f6d 2f64 6173  //github.com/das
-00022e50: 6b2f 6469 7374 7269 6275 7465 642f 6973  k/distributed/is
-00022e60: 7375 6573 2f36 3339 300a 2020 2020 2020  sues/6390.      
-00022e70: 2020 2020 2020 6966 206e 6f74 2063 6f6d        if not com
-00022e80: 6d2e 636c 6f73 6564 2829 3a0a 2020 2020  m.closed():.    
-00022e90: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
-00022ea0: 6973 2063 6c6f 7365 7320 7468 6520 576f  is closes the Wo
-00022eb0: 726b 6572 2061 6e64 2065 6e73 7572 6573  rker and ensures
-00022ec0: 2074 6861 7420 6966 2061 204e 616e 6e79   that if a Nanny
-00022ed0: 2069 7320 6172 6f75 6e64 2c0a 2020 2020   is around,.    
-00022ee0: 2020 2020 2020 2020 2020 2020 2320 6974              # it
-00022ef0: 2069 7320 636c 6f73 6564 2061 7320 7765   is closed as we
-00022f00: 6c6c 0a20 2020 2020 2020 2020 2020 2020  ll.             
-00022f10: 2020 2063 6f6d 6d2e 7365 6e64 287b 226f     comm.send({"o
-00022f20: 7022 3a20 2263 6c6f 7365 222c 2022 7265  p": "close", "re
-00022f30: 6173 6f6e 223a 2022 7363 6865 6475 6c65  ason": "schedule
-00022f40: 722d 636c 6f73 6522 7d29 0a20 2020 2020  r-close"}).     
-00022f50: 2020 2020 2020 2020 2020 2063 6f6d 6d2e             comm.
-00022f60: 7365 6e64 287b 226f 7022 3a20 2263 6c6f  send({"op": "clo
-00022f70: 7365 2d73 7472 6561 6d22 7d29 0a20 2020  se-stream"}).   
-00022f80: 2020 2020 2020 2020 2020 2020 2023 205e               # ^
-00022f90: 2054 4f44 4f20 7265 6d6f 7665 3f20 6057   TODO remove? `W
-00022fa0: 6f72 6b65 722e 636c 6f73 6560 2077 696c  orker.close` wil
-00022fb0: 6c20 636c 6f73 6520 7468 6520 7374 7265  l close the stre
-00022fc0: 616d 2061 6e79 7761 792e 0a20 2020 2020  am anyway..     
-00022fd0: 2020 2020 2020 2077 6974 6820 7375 7070         with supp
-00022fe0: 7265 7373 2841 7474 7269 6275 7465 4572  ress(AttributeEr
-00022ff0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-00023000: 2020 2020 2020 6675 7475 7265 732e 6170        futures.ap
-00023010: 7065 6e64 2863 6f6d 6d2e 636c 6f73 6528  pend(comm.close(
-00023020: 2929 0a0a 2020 2020 2020 2020 6177 6169  ))..        awai
-00023030: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
-00023040: 282a 6675 7475 7265 7329 0a0a 2020 2020  (*futures)..    
-00023050: 2020 2020 6966 2073 656c 662e 6a75 7079      if self.jupy
-00023060: 7465 723a 0a20 2020 2020 2020 2020 2020  ter:.           
-00023070: 2061 7761 6974 2073 656c 662e 5f6a 7570   await self._jup
-00023080: 7974 6572 5f73 6572 7665 725f 6170 706c  yter_server_appl
-00023090: 6963 6174 696f 6e2e 5f63 6c65 616e 7570  ication._cleanup
-000230a0: 2829 0a0a 2020 2020 2020 2020 666f 7220  ()..        for 
-000230b0: 636f 6d6d 2069 6e20 7365 6c66 2e63 6c69  comm in self.cli
-000230c0: 656e 745f 636f 6d6d 732e 7661 6c75 6573  ent_comms.values
-000230d0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-000230e0: 636f 6d6d 2e61 626f 7274 2829 0a0a 2020  comm.abort()..  
-000230f0: 2020 2020 2020 6177 6169 7420 7365 6c66        await self
-00023100: 2e72 7063 2e63 6c6f 7365 2829 0a0a 2020  .rpc.close()..  
-00023110: 2020 2020 2020 7365 6c66 2e73 7461 7475        self.statu
-00023120: 7320 3d20 5374 6174 7573 2e63 6c6f 7365  s = Status.close
-00023130: 640a 2020 2020 2020 2020 7365 6c66 2e73  d.        self.s
-00023140: 746f 7028 290a 2020 2020 2020 2020 6177  top().        aw
-00023150: 6169 7420 7375 7065 7228 292e 636c 6f73  ait super().clos
-00023160: 6528 290a 0a20 2020 2020 2020 2073 6574  e()..        set
-00023170: 7072 6f63 7469 746c 6528 2264 6173 6b20  proctitle("dask 
-00023180: 7363 6865 6475 6c65 7220 5b63 6c6f 7365  scheduler [close
-00023190: 645d 2229 0a20 2020 2020 2020 2064 6973  d]").        dis
-000231a0: 6162 6c65 5f67 635f 6469 6167 6e6f 7369  able_gc_diagnosi
-000231b0: 7328 290a 0a20 2020 2023 2323 2323 2323  s()..    #######
-000231c0: 2323 2323 0a20 2020 2023 2053 7469 6d75  ####.    # Stimu
-000231d0: 6c69 2023 0a20 2020 2023 2323 2323 2323  li #.    #######
-000231e0: 2323 2323 0a0a 2020 2020 6465 6620 6865  ####..    def he
-000231f0: 6172 7462 6561 745f 776f 726b 6572 280a  artbeat_worker(.
-00023200: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-00023210: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
-00023220: 2061 6464 7265 7373 3a20 7374 722c 0a20   address: str,. 
-00023230: 2020 2020 2020 2072 6573 6f6c 7665 5f61         resolve_a
-00023240: 6464 7265 7373 3a20 626f 6f6c 203d 2054  ddress: bool = T
-00023250: 7275 652c 0a20 2020 2020 2020 206e 6f77  rue,.        now
-00023260: 3a20 666c 6f61 7420 7c20 4e6f 6e65 203d  : float | None =
-00023270: 204e 6f6e 652c 0a20 2020 2020 2020 2072   None,.        r
-00023280: 6573 6f75 7263 6573 3a20 6469 6374 5b73  esources: dict[s
-00023290: 7472 2c20 666c 6f61 745d 207c 204e 6f6e  tr, float] | Non
-000232a0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-000232b0: 2020 686f 7374 5f69 6e66 6f3a 2064 6963    host_info: dic
-000232c0: 7420 7c20 4e6f 6e65 203d 204e 6f6e 652c  t | None = None,
-000232d0: 0a20 2020 2020 2020 206d 6574 7269 6373  .        metrics
-000232e0: 3a20 6469 6374 2c0a 2020 2020 2020 2020  : dict,.        
-000232f0: 6578 6563 7574 696e 673a 2064 6963 745b  executing: dict[
-00023300: 7374 722c 2066 6c6f 6174 5d20 7c20 4e6f  str, float] | No
-00023310: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
-00023320: 2020 2065 7874 656e 7369 6f6e 733a 2064     extensions: d
-00023330: 6963 7420 7c20 4e6f 6e65 203d 204e 6f6e  ict | None = Non
-00023340: 652c 0a20 2020 2029 202d 3e20 6469 6374  e,.    ) -> dict
-00023350: 5b73 7472 2c20 416e 795d 3a0a 2020 2020  [str, Any]:.    
-00023360: 2020 2020 6164 6472 6573 7320 3d20 7365      address = se
-00023370: 6c66 2e63 6f65 7263 655f 6164 6472 6573  lf.coerce_addres
-00023380: 7328 6164 6472 6573 732c 2072 6573 6f6c  s(address, resol
-00023390: 7665 5f61 6464 7265 7373 290a 2020 2020  ve_address).    
-000233a0: 2020 2020 6164 6472 6573 7320 3d20 6e6f      address = no
-000233b0: 726d 616c 697a 655f 6164 6472 6573 7328  rmalize_address(
-000233c0: 6164 6472 6573 7329 0a20 2020 2020 2020  address).       
-000233d0: 2077 7320 3d20 7365 6c66 2e77 6f72 6b65   ws = self.worke
-000233e0: 7273 2e67 6574 2861 6464 7265 7373 290a  rs.get(address).
-000233f0: 2020 2020 2020 2020 6966 2077 7320 6973          if ws is
-00023400: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00023410: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
-00023420: 6728 6622 5265 6365 6976 6564 2068 6561  g(f"Received hea
-00023430: 7274 6265 6174 2066 726f 6d20 756e 7265  rtbeat from unre
-00023440: 6769 7374 6572 6564 2077 6f72 6b65 7220  gistered worker 
-00023450: 7b61 6464 7265 7373 2172 7d2e 2229 0a20  {address!r}."). 
-00023460: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00023470: 6e20 7b22 7374 6174 7573 223a 2022 6d69  n {"status": "mi
-00023480: 7373 696e 6722 7d0a 0a20 2020 2020 2020  ssing"}..       
-00023490: 2068 6f73 7420 3d20 6765 745f 6164 6472   host = get_addr
-000234a0: 6573 735f 686f 7374 2861 6464 7265 7373  ess_host(address
-000234b0: 290a 2020 2020 2020 2020 6c6f 6361 6c5f  ).        local_
-000234c0: 6e6f 7720 3d20 7469 6d65 2829 0a20 2020  now = time().   
-000234d0: 2020 2020 2068 6f73 745f 696e 666f 203d       host_info =
-000234e0: 2068 6f73 745f 696e 666f 206f 7220 7b7d   host_info or {}
-000234f0: 0a0a 2020 2020 2020 2020 6468 3a20 6469  ..        dh: di
-00023500: 6374 203d 2073 656c 662e 686f 7374 5f69  ct = self.host_i
-00023510: 6e66 6f2e 7365 7464 6566 6175 6c74 2868  nfo.setdefault(h
-00023520: 6f73 742c 207b 7d29 0a20 2020 2020 2020  ost, {}).       
-00023530: 2064 685b 226c 6173 742d 7365 656e 225d   dh["last-seen"]
-00023540: 203d 206c 6f63 616c 5f6e 6f77 0a0a 2020   = local_now..  
-00023550: 2020 2020 2020 6672 6163 203d 2031 202f        frac = 1 /
-00023560: 206c 656e 2873 656c 662e 776f 726b 6572   len(self.worker
-00023570: 7329 0a20 2020 2020 2020 2073 656c 662e  s).        self.
-00023580: 6261 6e64 7769 6474 6820 3d20 280a 2020  bandwidth = (.  
-00023590: 2020 2020 2020 2020 2020 7365 6c66 2e62            self.b
-000235a0: 616e 6477 6964 7468 202a 2028 3120 2d20  andwidth * (1 - 
-000235b0: 6672 6163 2920 2b20 6d65 7472 6963 735b  frac) + metrics[
-000235c0: 2262 616e 6477 6964 7468 225d 5b22 746f  "bandwidth"]["to
-000235d0: 7461 6c22 5d20 2a20 6672 6163 0a20 2020  tal"] * frac.   
-000235e0: 2020 2020 2029 0a20 2020 2020 2020 2066       ).        f
-000235f0: 6f72 206f 7468 6572 2c20 2862 772c 2063  or other, (bw, c
-00023600: 6f75 6e74 2920 696e 206d 6574 7269 6373  ount) in metrics
-00023610: 5b22 6261 6e64 7769 6474 6822 5d5b 2277  ["bandwidth"]["w
-00023620: 6f72 6b65 7273 225d 2e69 7465 6d73 2829  orkers"].items()
-00023630: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00023640: 2028 6164 6472 6573 732c 206f 7468 6572   (address, other
-00023650: 2920 6e6f 7420 696e 2073 656c 662e 6261  ) not in self.ba
-00023660: 6e64 7769 6474 685f 776f 726b 6572 733a  ndwidth_workers:
-00023670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023680: 2073 656c 662e 6261 6e64 7769 6474 685f   self.bandwidth_
-00023690: 776f 726b 6572 735b 6164 6472 6573 732c  workers[address,
-000236a0: 206f 7468 6572 5d20 3d20 6277 202f 2063   other] = bw / c
-000236b0: 6f75 6e74 0a20 2020 2020 2020 2020 2020  ount.           
-000236c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000236d0: 2020 2020 2020 2061 6c70 6861 203d 2028         alpha = (
-000236e0: 3120 2d20 6672 6163 2920 2a2a 2063 6f75  1 - frac) ** cou
-000236f0: 6e74 0a20 2020 2020 2020 2020 2020 2020  nt.             
-00023700: 2020 2073 656c 662e 6261 6e64 7769 6474     self.bandwidt
-00023710: 685f 776f 726b 6572 735b 6164 6472 6573  h_workers[addres
-00023720: 732c 206f 7468 6572 5d20 3d20 7365 6c66  s, other] = self
-00023730: 2e62 616e 6477 6964 7468 5f77 6f72 6b65  .bandwidth_worke
-00023740: 7273 5b0a 2020 2020 2020 2020 2020 2020  rs[.            
-00023750: 2020 2020 2020 2020 6164 6472 6573 732c          address,
-00023760: 206f 7468 6572 0a20 2020 2020 2020 2020   other.         
-00023770: 2020 2020 2020 205d 202a 2061 6c70 6861         ] * alpha
-00023780: 202b 2062 7720 2a20 2831 202d 2061 6c70   + bw * (1 - alp
-00023790: 6861 290a 2020 2020 2020 2020 666f 7220  ha).        for 
-000237a0: 7479 702c 2028 6277 2c20 636f 756e 7429  typ, (bw, count)
-000237b0: 2069 6e20 6d65 7472 6963 735b 2262 616e   in metrics["ban
-000237c0: 6477 6964 7468 225d 5b22 7479 7065 7322  dwidth"]["types"
-000237d0: 5d2e 6974 656d 7328 293a 0a20 2020 2020  ].items():.     
-000237e0: 2020 2020 2020 2069 6620 7479 7020 6e6f         if typ no
-000237f0: 7420 696e 2073 656c 662e 6261 6e64 7769  t in self.bandwi
-00023800: 6474 685f 7479 7065 733a 0a20 2020 2020  dth_types:.     
-00023810: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00023820: 6261 6e64 7769 6474 685f 7479 7065 735b  bandwidth_types[
-00023830: 7479 705d 203d 2062 7720 2f20 636f 756e  typ] = bw / coun
-00023840: 740a 2020 2020 2020 2020 2020 2020 656c  t.            el
-00023850: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00023860: 2020 2020 616c 7068 6120 3d20 2831 202d      alpha = (1 -
-00023870: 2066 7261 6329 202a 2a20 636f 756e 740a   frac) ** count.
-00023880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023890: 7365 6c66 2e62 616e 6477 6964 7468 5f74  self.bandwidth_t
-000238a0: 7970 6573 5b74 7970 5d20 3d20 7365 6c66  ypes[typ] = self
-000238b0: 2e62 616e 6477 6964 7468 5f74 7970 6573  .bandwidth_types
-000238c0: 5b74 7970 5d20 2a20 616c 7068 6120 2b20  [typ] * alpha + 
-000238d0: 6277 202a 2028 0a20 2020 2020 2020 2020  bw * (.         
-000238e0: 2020 2020 2020 2020 2020 2031 202d 2061             1 - a
-000238f0: 6c70 6861 0a20 2020 2020 2020 2020 2020  lpha.           
-00023900: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00023910: 7773 2e6c 6173 745f 7365 656e 203d 206c  ws.last_seen = l
-00023920: 6f63 616c 5f6e 6f77 0a20 2020 2020 2020  ocal_now.       
-00023930: 2069 6620 6578 6563 7574 696e 6720 6973   if executing is
-00023940: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00023950: 2020 2020 2020 2023 204e 4f54 453a 2074         # NOTE: t
-00023960: 6865 2065 7865 6375 7469 6e67 2064 6963  he executing dic
-00023970: 7420 6973 2075 6e75 7365 640a 2020 2020  t is unused.    
-00023980: 2020 2020 2020 2020 7773 2e65 7865 6375          ws.execu
-00023990: 7469 6e67 203d 207b 7d0a 2020 2020 2020  ting = {}.      
-000239a0: 2020 2020 2020 666f 7220 6b65 792c 2064        for key, d
-000239b0: 7572 6174 696f 6e20 696e 2065 7865 6375  uration in execu
-000239c0: 7469 6e67 2e69 7465 6d73 2829 3a0a 2020  ting.items():.  
-000239d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000239e0: 206b 6579 2069 6e20 7365 6c66 2e74 6173   key in self.tas
-000239f0: 6b73 3a0a 2020 2020 2020 2020 2020 2020  ks:.            
-00023a00: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-00023a10: 662e 7461 736b 735b 6b65 795d 0a20 2020  f.tasks[key].   
-00023a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023a30: 2077 732e 6578 6563 7574 696e 675b 7473   ws.executing[ts
-00023a40: 5d20 3d20 6475 7261 7469 6f6e 0a20 2020  ] = duration.   
-00023a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023a60: 2074 732e 7072 6566 6978 2e61 6464 5f65   ts.prefix.add_e
-00023a70: 7865 635f 7469 6d65 2864 7572 6174 696f  xec_time(duratio
-00023a80: 6e29 0a0a 2020 2020 2020 2020 666f 7220  n)..        for 
-00023a90: 6e61 6d65 2c20 7661 6c75 6520 696e 206d  name, value in m
-00023aa0: 6574 7269 6373 5b22 6469 6765 7374 735f  etrics["digests_
-00023ab0: 746f 7461 6c5f 7369 6e63 655f 6865 6172  total_since_hear
-00023ac0: 7462 6561 7422 5d2e 6974 656d 7328 293a  tbeat"].items():
-00023ad0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00023ae0: 662e 6375 6d75 6c61 7469 7665 5f77 6f72  f.cumulative_wor
-00023af0: 6b65 725f 6d65 7472 6963 735b 6e61 6d65  ker_metrics[name
-00023b00: 5d20 2b3d 2076 616c 7565 0a0a 2020 2020  ] += value..    
-00023b10: 2020 2020 7773 2e6d 6574 7269 6373 203d      ws.metrics =
-00023b20: 206d 6574 7269 6373 0a0a 2020 2020 2020   metrics..      
-00023b30: 2020 2320 4361 6c63 756c 6174 6520 5253    # Calculate RS
-00023b40: 5320 2d20 6461 736b 206b 6579 732c 2073  S - dask keys, s
-00023b50: 6570 6172 6174 696e 6720 226f 6c64 2220  eparating "old" 
-00023b60: 616e 6420 226e 6577 2220 7573 6167 650a  and "new" usage.
-00023b70: 2020 2020 2020 2020 2320 5365 6520 4d65          # See Me
-00023b80: 6d6f 7279 5374 6174 6520 666f 7220 6465  moryState for de
-00023b90: 7461 696c 730a 2020 2020 2020 2020 6d61  tails.        ma
-00023ba0: 785f 6d65 6d6f 7279 5f75 6e6d 616e 6167  x_memory_unmanag
-00023bb0: 6564 5f6f 6c64 5f68 6973 745f 6167 6520  ed_old_hist_age 
-00023bc0: 3d20 6c6f 6361 6c5f 6e6f 7720 2d20 7365  = local_now - se
-00023bd0: 6c66 2e4d 454d 4f52 595f 5245 4345 4e54  lf.MEMORY_RECENT
-00023be0: 5f54 4f5f 4f4c 445f 5449 4d45 0a20 2020  _TO_OLD_TIME.   
-00023bf0: 2020 2020 206d 656d 6f72 795f 756e 6d61       memory_unma
-00023c00: 6e61 6765 645f 6f6c 6420 3d20 7773 2e5f  naged_old = ws._
-00023c10: 6d65 6d6f 7279 5f75 6e6d 616e 6167 6564  memory_unmanaged
-00023c20: 5f6f 6c64 0a20 2020 2020 2020 2077 6869  _old.        whi
-00023c30: 6c65 2077 732e 5f6d 656d 6f72 795f 756e  le ws._memory_un
-00023c40: 6d61 6e61 6765 645f 6869 7374 6f72 793a  managed_history:
-00023c50: 0a20 2020 2020 2020 2020 2020 2074 696d  .            tim
-00023c60: 6573 7461 6d70 2c20 7369 7a65 203d 2077  estamp, size = w
-00023c70: 732e 5f6d 656d 6f72 795f 756e 6d61 6e61  s._memory_unmana
-00023c80: 6765 645f 6869 7374 6f72 795b 305d 0a20  ged_history[0]. 
-00023c90: 2020 2020 2020 2020 2020 2069 6620 7469             if ti
-00023ca0: 6d65 7374 616d 7020 3e3d 206d 6178 5f6d  mestamp >= max_m
-00023cb0: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
-00023cc0: 6f6c 645f 6869 7374 5f61 6765 3a0a 2020  old_hist_age:.  
-00023cd0: 2020 2020 2020 2020 2020 2020 2020 6272                br
-00023ce0: 6561 6b0a 2020 2020 2020 2020 2020 2020  eak.            
-00023cf0: 7773 2e5f 6d65 6d6f 7279 5f75 6e6d 616e  ws._memory_unman
-00023d00: 6167 6564 5f68 6973 746f 7279 2e70 6f70  aged_history.pop
-00023d10: 6c65 6674 2829 0a20 2020 2020 2020 2020  left().         
-00023d20: 2020 2069 6620 7369 7a65 203d 3d20 6d65     if size == me
-00023d30: 6d6f 7279 5f75 6e6d 616e 6167 6564 5f6f  mory_unmanaged_o
-00023d40: 6c64 3a0a 2020 2020 2020 2020 2020 2020  ld:.            
-00023d50: 2020 2020 6d65 6d6f 7279 5f75 6e6d 616e      memory_unman
-00023d60: 6167 6564 5f6f 6c64 203d 2030 2020 2320  aged_old = 0  # 
-00023d70: 7265 6361 6c63 756c 6174 6520 6d69 6e28  recalculate min(
-00023d80: 290a 0a20 2020 2020 2020 2023 2077 732e  )..        # ws.
-00023d90: 5f6e 6279 7465 7320 6973 2075 7064 6174  _nbytes is updat
-00023da0: 6564 2061 7420 6120 6469 6666 6572 656e  ed at a differen
-00023db0: 7420 7469 6d65 2061 6e64 2073 697a 656f  t time and sizeo
-00023dc0: 6628 2920 6d61 7920 6e6f 7420 6265 2061  f() may not be a
-00023dd0: 6363 7572 6174 652c 0a20 2020 2020 2020  ccurate,.       
-00023de0: 2023 2073 6f20 7369 7a65 206d 6179 2062   # so size may b
-00023df0: 6520 2874 656d 706f 7261 7269 6c79 2920  e (temporarily) 
-00023e00: 6e65 6761 7469 7665 3b20 666c 6f6f 7220  negative; floor 
-00023e10: 6974 2074 6f20 7a65 726f 2e0a 2020 2020  it to zero..    
-00023e20: 2020 2020 7369 7a65 203d 206d 6178 280a      size = max(.
-00023e30: 2020 2020 2020 2020 2020 2020 302c 206d              0, m
-00023e40: 6574 7269 6373 5b22 6d65 6d6f 7279 225d  etrics["memory"]
-00023e50: 202d 2077 732e 6e62 7974 6573 202b 206d   - ws.nbytes + m
-00023e60: 6574 7269 6373 5b22 7370 696c 6c65 645f  etrics["spilled_
-00023e70: 6279 7465 7322 5d5b 226d 656d 6f72 7922  bytes"]["memory"
-00023e80: 5d0a 2020 2020 2020 2020 290a 0a20 2020  ].        )..   
-00023e90: 2020 2020 2077 732e 5f6d 656d 6f72 795f       ws._memory_
-00023ea0: 756e 6d61 6e61 6765 645f 6869 7374 6f72  unmanaged_histor
-00023eb0: 792e 6170 7065 6e64 2828 6c6f 6361 6c5f  y.append((local_
-00023ec0: 6e6f 772c 2073 697a 6529 290a 2020 2020  now, size)).    
-00023ed0: 2020 2020 6966 206e 6f74 206d 656d 6f72      if not memor
-00023ee0: 795f 756e 6d61 6e61 6765 645f 6f6c 643a  y_unmanaged_old:
-00023ef0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00023f00: 6865 2077 6f72 6b65 7220 6861 7320 6a75  he worker has ju
-00023f10: 7374 2062 6565 6e20 7374 6172 7465 6420  st been started 
-00023f20: 6f72 2074 6865 2070 7265 7669 6f75 7320  or the previous 
-00023f30: 6d69 6e69 6d75 6d20 6861 7320 6265 656e  minimum has been
-00023f40: 2065 7870 756e 6765 640a 2020 2020 2020   expunged.      
-00023f50: 2020 2020 2020 2320 6265 6361 7573 6520        # because 
-00023f60: 746f 6f20 6f6c 642e 0a20 2020 2020 2020  too old..       
-00023f70: 2020 2020 2023 204e 6f74 653a 2074 6869       # Note: thi
-00023f80: 7320 616c 676f 7269 7468 6d20 6973 2063  s algorithm is c
-00023f90: 6170 7065 6420 746f 2032 3030 202a 204d  apped to 200 * M
-00023fa0: 454d 4f52 595f 5245 4345 4e54 5f54 4f5f  EMORY_RECENT_TO_
-00023fb0: 4f4c 445f 5449 4d45 2065 6c65 6d65 6e74  OLD_TIME element
-00023fc0: 730a 2020 2020 2020 2020 2020 2020 2320  s.            # 
-00023fd0: 636c 7573 7465 722d 7769 6465 2062 7920  cluster-wide by 
-00023fe0: 6865 6172 7462 6561 745f 696e 7465 7276  heartbeat_interv
-00023ff0: 616c 2829 2c20 7265 6761 7264 6c65 7373  al(), regardless
-00024000: 206f 6620 7468 6520 6e75 6d62 6572 206f   of the number o
-00024010: 6620 776f 726b 6572 730a 2020 2020 2020  f workers.      
-00024020: 2020 2020 2020 7773 2e5f 6d65 6d6f 7279        ws._memory
-00024030: 5f75 6e6d 616e 6167 6564 5f6f 6c64 203d  _unmanaged_old =
-00024040: 206d 696e 286d 6170 2873 6563 6f6e 642c   min(map(second,
-00024050: 2077 732e 5f6d 656d 6f72 795f 756e 6d61   ws._memory_unma
-00024060: 6e61 6765 645f 6869 7374 6f72 7929 290a  naged_history)).
-00024070: 2020 2020 2020 2020 656c 6966 2073 697a          elif siz
-00024080: 6520 3c20 6d65 6d6f 7279 5f75 6e6d 616e  e < memory_unman
-00024090: 6167 6564 5f6f 6c64 3a0a 2020 2020 2020  aged_old:.      
-000240a0: 2020 2020 2020 7773 2e5f 6d65 6d6f 7279        ws._memory
-000240b0: 5f75 6e6d 616e 6167 6564 5f6f 6c64 203d  _unmanaged_old =
-000240c0: 2073 697a 650a 0a20 2020 2020 2020 2069   size..        i
-000240d0: 6620 686f 7374 5f69 6e66 6f3a 0a20 2020  f host_info:.   
-000240e0: 2020 2020 2020 2020 2064 6820 3d20 7365           dh = se
-000240f0: 6c66 2e68 6f73 745f 696e 666f 2e73 6574  lf.host_info.set
-00024100: 6465 6661 756c 7428 686f 7374 2c20 7b7d  default(host, {}
-00024110: 290a 2020 2020 2020 2020 2020 2020 6468  ).            dh
-00024120: 2e75 7064 6174 6528 686f 7374 5f69 6e66  .update(host_inf
-00024130: 6f29 0a0a 2020 2020 2020 2020 6966 206e  o)..        if n
-00024140: 6f77 3a0a 2020 2020 2020 2020 2020 2020  ow:.            
-00024150: 7773 2e74 696d 655f 6465 6c61 7920 3d20  ws.time_delay = 
-00024160: 6c6f 6361 6c5f 6e6f 7720 2d20 6e6f 770a  local_now - now.
-00024170: 0a20 2020 2020 2020 2069 6620 7265 736f  .        if reso
-00024180: 7572 6365 733a 0a20 2020 2020 2020 2020  urces:.         
-00024190: 2020 2073 656c 662e 6164 645f 7265 736f     self.add_reso
-000241a0: 7572 6365 7328 776f 726b 6572 3d61 6464  urces(worker=add
-000241b0: 7265 7373 2c20 7265 736f 7572 6365 733d  ress, resources=
-000241c0: 7265 736f 7572 6365 7329 0a0a 2020 2020  resources)..    
-000241d0: 2020 2020 6966 2065 7874 656e 7369 6f6e      if extension
-000241e0: 733a 0a20 2020 2020 2020 2020 2020 2066  s:.            f
-000241f0: 6f72 206e 616d 652c 2064 6174 6120 696e  or name, data in
-00024200: 2065 7874 656e 7369 6f6e 732e 6974 656d   extensions.item
-00024210: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00024220: 2020 2020 2073 656c 662e 6578 7465 6e73       self.extens
-00024230: 696f 6e73 5b6e 616d 655d 2e68 6561 7274  ions[name].heart
-00024240: 6265 6174 2877 732c 2064 6174 6129 0a0a  beat(ws, data)..
-00024250: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-00024260: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
-00024270: 6174 7573 223a 2022 4f4b 222c 0a20 2020  atus": "OK",.   
-00024280: 2020 2020 2020 2020 2022 7469 6d65 223a           "time":
-00024290: 206c 6f63 616c 5f6e 6f77 2c0a 2020 2020   local_now,.    
-000242a0: 2020 2020 2020 2020 2268 6561 7274 6265          "heartbe
-000242b0: 6174 2d69 6e74 6572 7661 6c22 3a20 6865  at-interval": he
-000242c0: 6172 7462 6561 745f 696e 7465 7276 616c  artbeat_interval
-000242d0: 286c 656e 2873 656c 662e 776f 726b 6572  (len(self.worker
-000242e0: 7329 292c 0a20 2020 2020 2020 207d 0a0a  s)),.        }..
-000242f0: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
-00024300: 2020 2020 6173 796e 6320 6465 6620 6164      async def ad
-00024310: 645f 776f 726b 6572 280a 2020 2020 2020  d_worker(.      
-00024320: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-00024330: 636f 6d6d 3a20 436f 6d6d 2c0a 2020 2020  comm: Comm,.    
-00024340: 2020 2020 2a2c 0a20 2020 2020 2020 2061      *,.        a
-00024350: 6464 7265 7373 3a20 7374 722c 0a20 2020  ddress: str,.   
-00024360: 2020 2020 2073 7461 7475 733a 2073 7472       status: str
-00024370: 2c0a 2020 2020 2020 2020 7365 7276 6572  ,.        server
-00024380: 5f69 643a 2073 7472 2c0a 2020 2020 2020  _id: str,.      
-00024390: 2020 6e74 6872 6561 6473 3a20 696e 742c    nthreads: int,
-000243a0: 0a20 2020 2020 2020 206e 616d 653a 2073  .        name: s
-000243b0: 7472 2c0a 2020 2020 2020 2020 7265 736f  tr,.        reso
-000243c0: 6c76 655f 6164 6472 6573 733a 2062 6f6f  lve_address: boo
-000243d0: 6c20 3d20 5472 7565 2c0a 2020 2020 2020  l = True,.      
-000243e0: 2020 6e6f 773a 2066 6c6f 6174 2c0a 2020    now: float,.  
-000243f0: 2020 2020 2020 7265 736f 7572 6365 733a        resources:
-00024400: 2064 6963 745b 7374 722c 2066 6c6f 6174   dict[str, float
-00024410: 5d2c 0a20 2020 2020 2020 2023 2046 4958  ],.        # FIX
-00024420: 4d45 3a20 5468 6973 2069 7320 6e65 7665  ME: This is neve
-00024430: 7220 7375 626d 6974 7465 6420 6279 2074  r submitted by t
-00024440: 6865 2077 6f72 6b65 720a 2020 2020 2020  he worker.      
-00024450: 2020 686f 7374 5f69 6e66 6f3a 204e 6f6e    host_info: Non
-00024460: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-00024470: 2020 6d65 6d6f 7279 5f6c 696d 6974 3a20    memory_limit: 
-00024480: 696e 7420 7c20 4e6f 6e65 2c0a 2020 2020  int | None,.    
-00024490: 2020 2020 6d65 7472 6963 733a 2064 6963      metrics: dic
-000244a0: 745b 7374 722c 2041 6e79 5d2c 0a20 2020  t[str, Any],.   
-000244b0: 2020 2020 2070 6964 3a20 696e 7420 3d20       pid: int = 
-000244c0: 302c 0a20 2020 2020 2020 2073 6572 7669  0,.        servi
-000244d0: 6365 733a 2064 6963 745b 7374 722c 2069  ces: dict[str, i
-000244e0: 6e74 5d2c 0a20 2020 2020 2020 206c 6f63  nt],.        loc
-000244f0: 616c 5f64 6972 6563 746f 7279 3a20 7374  al_directory: st
-00024500: 722c 0a20 2020 2020 2020 2076 6572 7369  r,.        versi
-00024510: 6f6e 733a 2064 6963 745b 7374 722c 2041  ons: dict[str, A
-00024520: 6e79 5d2c 0a20 2020 2020 2020 206e 616e  ny],.        nan
-00024530: 6e79 3a20 7374 722c 0a20 2020 2020 2020  ny: str,.       
-00024540: 2065 7874 7261 3a20 6469 6374 2c0a 2020   extra: dict,.  
-00024550: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
-00024560: 643a 2073 7472 2c0a 2020 2020 2920 2d3e  d: str,.    ) ->
-00024570: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-00024580: 2222 4164 6420 6120 6e65 7720 776f 726b  ""Add a new work
-00024590: 6572 2074 6f20 7468 6520 636c 7573 7465  er to the cluste
-000245a0: 7222 2222 0a20 2020 2020 2020 2061 6464  r""".        add
-000245b0: 7265 7373 203d 2073 656c 662e 636f 6572  ress = self.coer
-000245c0: 6365 5f61 6464 7265 7373 2861 6464 7265  ce_address(addre
-000245d0: 7373 2c20 7265 736f 6c76 655f 6164 6472  ss, resolve_addr
-000245e0: 6573 7329 0a20 2020 2020 2020 2061 6464  ess).        add
-000245f0: 7265 7373 203d 206e 6f72 6d61 6c69 7a65  ress = normalize
-00024600: 5f61 6464 7265 7373 2861 6464 7265 7373  _address(address
-00024610: 290a 2020 2020 2020 2020 686f 7374 203d  ).        host =
-00024620: 2067 6574 5f61 6464 7265 7373 5f68 6f73   get_address_hos
-00024630: 7428 6164 6472 6573 7329 0a0a 2020 2020  t(address)..    
-00024640: 2020 2020 6966 2061 6464 7265 7373 2069      if address i
-00024650: 6e20 7365 6c66 2e77 6f72 6b65 7273 3a0a  n self.workers:.
-00024660: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00024670: 6520 5661 6c75 6545 7272 6f72 2822 576f  e ValueError("Wo
-00024680: 726b 6572 2061 6c72 6561 6479 2065 7869  rker already exi
-00024690: 7374 7320 2573 2220 2520 6164 6472 6573  sts %s" % addres
-000246a0: 7329 0a0a 2020 2020 2020 2020 6966 206e  s)..        if n
-000246b0: 616d 6520 696e 2073 656c 662e 616c 6961  ame in self.alia
-000246c0: 7365 733a 0a20 2020 2020 2020 2020 2020  ses:.           
-000246d0: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
-000246e0: 2257 6f72 6b65 7220 7472 6965 6420 746f  "Worker tried to
-000246f0: 2063 6f6e 6e65 6374 2077 6974 6820 6120   connect with a 
-00024700: 6475 706c 6963 6174 6520 6e61 6d65 3a20  duplicate name: 
-00024710: 2573 222c 206e 616d 6529 0a20 2020 2020  %s", name).     
-00024720: 2020 2020 2020 206d 7367 203d 207b 0a20         msg = {. 
-00024730: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00024740: 7374 6174 7573 223a 2022 6572 726f 7222  status": "error"
-00024750: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00024760: 2020 226d 6573 7361 6765 223a 2022 6e61    "message": "na
-00024770: 6d65 2074 616b 656e 2c20 2573 2220 2520  me taken, %s" % 
-00024780: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
-00024790: 2020 2020 2020 2274 696d 6522 3a20 7469        "time": ti
-000247a0: 6d65 2829 2c0a 2020 2020 2020 2020 2020  me(),.          
-000247b0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-000247c0: 6177 6169 7420 636f 6d6d 2e77 7269 7465  await comm.write
-000247d0: 286d 7367 290a 2020 2020 2020 2020 2020  (msg).          
-000247e0: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
-000247f0: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
-00024800: 2861 6464 7265 7373 2c20 7b22 6163 7469  (address, {"acti
-00024810: 6f6e 223a 2022 6164 642d 776f 726b 6572  on": "add-worker
-00024820: 227d 290a 2020 2020 2020 2020 7365 6c66  "}).        self
-00024830: 2e6c 6f67 5f65 7665 6e74 2822 616c 6c22  .log_event("all"
-00024840: 2c20 7b22 6163 7469 6f6e 223a 2022 6164  , {"action": "ad
-00024850: 642d 776f 726b 6572 222c 2022 776f 726b  d-worker", "work
-00024860: 6572 223a 2061 6464 7265 7373 7d29 0a0a  er": address})..
-00024870: 2020 2020 2020 2020 7365 6c66 2e77 6f72          self.wor
-00024880: 6b65 7273 5b61 6464 7265 7373 5d20 3d20  kers[address] = 
-00024890: 7773 203d 2057 6f72 6b65 7253 7461 7465  ws = WorkerState
-000248a0: 280a 2020 2020 2020 2020 2020 2020 6164  (.            ad
-000248b0: 6472 6573 733d 6164 6472 6573 732c 0a20  dress=address,. 
-000248c0: 2020 2020 2020 2020 2020 2073 7461 7475             statu
-000248d0: 733d 5374 6174 7573 2e6c 6f6f 6b75 705b  s=Status.lookup[
-000248e0: 7374 6174 7573 5d2c 2020 2320 7479 7065  status],  # type
-000248f0: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
-00024900: 2020 2020 2070 6964 3d70 6964 2c0a 2020       pid=pid,.  
-00024910: 2020 2020 2020 2020 2020 6e74 6872 6561            nthrea
-00024920: 6473 3d6e 7468 7265 6164 732c 0a20 2020  ds=nthreads,.   
-00024930: 2020 2020 2020 2020 206d 656d 6f72 795f           memory_
-00024940: 6c69 6d69 743d 6d65 6d6f 7279 5f6c 696d  limit=memory_lim
-00024950: 6974 206f 7220 302c 0a20 2020 2020 2020  it or 0,.       
-00024960: 2020 2020 206e 616d 653d 6e61 6d65 2c0a       name=name,.
-00024970: 2020 2020 2020 2020 2020 2020 6c6f 6361              loca
-00024980: 6c5f 6469 7265 6374 6f72 793d 6c6f 6361  l_directory=loca
-00024990: 6c5f 6469 7265 6374 6f72 792c 0a20 2020  l_directory,.   
-000249a0: 2020 2020 2020 2020 2073 6572 7669 6365           service
-000249b0: 733d 7365 7276 6963 6573 2c0a 2020 2020  s=services,.    
-000249c0: 2020 2020 2020 2020 7665 7273 696f 6e73          versions
-000249d0: 3d76 6572 7369 6f6e 732c 0a20 2020 2020  =versions,.     
-000249e0: 2020 2020 2020 206e 616e 6e79 3d6e 616e         nanny=nan
-000249f0: 6e79 2c0a 2020 2020 2020 2020 2020 2020  ny,.            
-00024a00: 6578 7472 613d 6578 7472 612c 0a20 2020  extra=extra,.   
-00024a10: 2020 2020 2020 2020 2073 6572 7665 725f           server_
-00024a20: 6964 3d73 6572 7665 725f 6964 2c0a 2020  id=server_id,.  
-00024a30: 2020 2020 2020 2020 2020 7363 6865 6475            schedu
-00024a40: 6c65 723d 7365 6c66 2c0a 2020 2020 2020  ler=self,.      
-00024a50: 2020 290a 2020 2020 2020 2020 6966 2077    ).        if w
-00024a60: 732e 7374 6174 7573 203d 3d20 5374 6174  s.status == Stat
-00024a70: 7573 2e72 756e 6e69 6e67 3a0a 2020 2020  us.running:.    
-00024a80: 2020 2020 2020 2020 7365 6c66 2e72 756e          self.run
-00024a90: 6e69 6e67 2e61 6464 2877 7329 0a0a 2020  ning.add(ws)..  
-00024aa0: 2020 2020 2020 6468 203d 2073 656c 662e        dh = self.
-00024ab0: 686f 7374 5f69 6e66 6f2e 6765 7428 686f  host_info.get(ho
-00024ac0: 7374 290a 2020 2020 2020 2020 6966 2064  st).        if d
-00024ad0: 6820 6973 204e 6f6e 653a 0a20 2020 2020  h is None:.     
-00024ae0: 2020 2020 2020 2073 656c 662e 686f 7374         self.host
-00024af0: 5f69 6e66 6f5b 686f 7374 5d20 3d20 6468  _info[host] = dh
-00024b00: 203d 207b 7d0a 0a20 2020 2020 2020 2064   = {}..        d
-00024b10: 685f 6164 6472 6573 7365 7320 3d20 6468  h_addresses = dh
-00024b20: 2e67 6574 2822 6164 6472 6573 7365 7322  .get("addresses"
-00024b30: 290a 2020 2020 2020 2020 6966 2064 685f  ).        if dh_
-00024b40: 6164 6472 6573 7365 7320 6973 204e 6f6e  addresses is Non
-00024b50: 653a 0a20 2020 2020 2020 2020 2020 2064  e:.            d
-00024b60: 685b 2261 6464 7265 7373 6573 225d 203d  h["addresses"] =
-00024b70: 2064 685f 6164 6472 6573 7365 7320 3d20   dh_addresses = 
-00024b80: 7365 7428 290a 2020 2020 2020 2020 2020  set().          
-00024b90: 2020 6468 5b22 6e74 6872 6561 6473 225d    dh["nthreads"]
-00024ba0: 203d 2030 0a0a 2020 2020 2020 2020 6468   = 0..        dh
-00024bb0: 5f61 6464 7265 7373 6573 2e61 6464 2861  _addresses.add(a
-00024bc0: 6464 7265 7373 290a 2020 2020 2020 2020  ddress).        
-00024bd0: 6468 5b22 6e74 6872 6561 6473 225d 202b  dh["nthreads"] +
-00024be0: 3d20 6e74 6872 6561 6473 0a0a 2020 2020  = nthreads..    
-00024bf0: 2020 2020 7365 6c66 2e74 6f74 616c 5f6e      self.total_n
-00024c00: 7468 7265 6164 7320 2b3d 206e 7468 7265  threads += nthre
-00024c10: 6164 730a 2020 2020 2020 2020 7365 6c66  ads.        self
-00024c20: 2e61 6c69 6173 6573 5b6e 616d 655d 203d  .aliases[name] =
-00024c30: 2061 6464 7265 7373 0a0a 2020 2020 2020   address..      
-00024c40: 2020 7365 6c66 2e68 6561 7274 6265 6174    self.heartbeat
-00024c50: 5f77 6f72 6b65 7228 0a20 2020 2020 2020  _worker(.       
-00024c60: 2020 2020 2061 6464 7265 7373 3d61 6464       address=add
-00024c70: 7265 7373 2c0a 2020 2020 2020 2020 2020  ress,.          
-00024c80: 2020 7265 736f 6c76 655f 6164 6472 6573    resolve_addres
-00024c90: 733d 7265 736f 6c76 655f 6164 6472 6573  s=resolve_addres
-00024ca0: 732c 0a20 2020 2020 2020 2020 2020 206e  s,.            n
-00024cb0: 6f77 3d6e 6f77 2c0a 2020 2020 2020 2020  ow=now,.        
-00024cc0: 2020 2020 7265 736f 7572 6365 733d 7265      resources=re
-00024cd0: 736f 7572 6365 732c 0a20 2020 2020 2020  sources,.       
-00024ce0: 2020 2020 2068 6f73 745f 696e 666f 3d68       host_info=h
-00024cf0: 6f73 745f 696e 666f 2c0a 2020 2020 2020  ost_info,.      
-00024d00: 2020 2020 2020 6d65 7472 6963 733d 6d65        metrics=me
-00024d10: 7472 6963 732c 0a20 2020 2020 2020 2029  trics,.        )
-00024d20: 0a0a 2020 2020 2020 2020 2320 446f 206e  ..        # Do n
-00024d30: 6f74 206e 6565 6420 746f 2061 646a 7573  ot need to adjus
-00024d40: 7420 7365 6c66 2e74 6f74 616c 5f6f 6363  t self.total_occ
-00024d50: 7570 616e 6379 2061 7320 7365 6c66 2e6f  upancy as self.o
-00024d60: 6363 7570 616e 6379 5b77 735d 2063 616e  ccupancy[ws] can
-00024d70: 6e6f 740a 2020 2020 2020 2020 2320 6578  not.        # ex
-00024d80: 6973 7420 6265 666f 7265 2074 6869 732e  ist before this.
-00024d90: 0a20 2020 2020 2020 2073 656c 662e 6368  .        self.ch
-00024da0: 6563 6b5f 6964 6c65 5f73 6174 7572 6174  eck_idle_saturat
-00024db0: 6564 2877 7329 0a0a 2020 2020 2020 2020  ed(ws)..        
-00024dc0: 7365 6c66 2e73 7472 6561 6d5f 636f 6d6d  self.stream_comm
-00024dd0: 735b 6164 6472 6573 735d 203d 2042 6174  s[address] = Bat
-00024de0: 6368 6564 5365 6e64 2869 6e74 6572 7661  chedSend(interva
-00024df0: 6c3d 2235 6d73 222c 206c 6f6f 703d 7365  l="5ms", loop=se
-00024e00: 6c66 2e6c 6f6f 7029 0a0a 2020 2020 2020  lf.loop)..      
-00024e10: 2020 6177 6169 7461 626c 6573 203d 205b    awaitables = [
-00024e20: 5d0a 2020 2020 2020 2020 666f 7220 706c  ].        for pl
-00024e30: 7567 696e 2069 6e20 6c69 7374 2873 656c  ugin in list(sel
-00024e40: 662e 706c 7567 696e 732e 7661 6c75 6573  f.plugins.values
-00024e50: 2829 293a 0a20 2020 2020 2020 2020 2020  ()):.           
-00024e60: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00024e70: 2020 2020 2020 7265 7375 6c74 203d 2070        result = p
-00024e80: 6c75 6769 6e2e 6164 645f 776f 726b 6572  lugin.add_worker
-00024e90: 2873 6368 6564 756c 6572 3d73 656c 662c  (scheduler=self,
-00024ea0: 2077 6f72 6b65 723d 6164 6472 6573 7329   worker=address)
-00024eb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024ec0: 2069 6620 7265 7375 6c74 2069 7320 6e6f   if result is no
-00024ed0: 7420 4e6f 6e65 2061 6e64 2069 6e73 7065  t None and inspe
-00024ee0: 6374 2e69 7361 7761 6974 6162 6c65 2872  ct.isawaitable(r
-00024ef0: 6573 756c 7429 3a0a 2020 2020 2020 2020  esult):.        
-00024f00: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00024f10: 7461 626c 6573 2e61 7070 656e 6428 7265  tables.append(re
-00024f20: 7375 6c74 290a 2020 2020 2020 2020 2020  sult).          
-00024f30: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-00024f40: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
-00024f50: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00024f60: 6578 6365 7074 696f 6e28 6529 0a0a 2020  exception(e)..  
-00024f70: 2020 2020 2020 706c 7567 696e 5f6d 7367        plugin_msg
-00024f80: 7320 3d20 6177 6169 7420 6173 796e 6369  s = await asynci
-00024f90: 6f2e 6761 7468 6572 282a 6177 6169 7461  o.gather(*awaita
-00024fa0: 626c 6573 2c20 7265 7475 726e 5f65 7863  bles, return_exc
-00024fb0: 6570 7469 6f6e 733d 5472 7565 290a 2020  eptions=True).  
-00024fc0: 2020 2020 2020 706c 7567 696e 735f 6578        plugins_ex
-00024fd0: 6365 7074 696f 6e73 203d 205b 6d73 6720  ceptions = [msg 
-00024fe0: 666f 7220 6d73 6720 696e 2070 6c75 6769  for msg in plugi
-00024ff0: 6e5f 6d73 6773 2069 6620 6973 696e 7374  n_msgs if isinst
-00025000: 616e 6365 286d 7367 2c20 4578 6365 7074  ance(msg, Except
-00025010: 696f 6e29 5d0a 2020 2020 2020 2020 666f  ion)].        fo
-00025020: 7220 6578 6320 696e 2070 6c75 6769 6e73  r exc in plugins
-00025030: 5f65 7863 6570 7469 6f6e 733a 0a20 2020  _exceptions:.   
-00025040: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00025050: 6578 6365 7074 696f 6e28 6578 632c 2065  exception(exc, e
-00025060: 7863 5f69 6e66 6f3d 6578 6329 0a0a 2020  xc_info=exc)..  
-00025070: 2020 2020 2020 6966 2077 732e 7374 6174        if ws.stat
-00025080: 7573 203d 3d20 5374 6174 7573 2e72 756e  us == Status.run
-00025090: 6e69 6e67 3a0a 2020 2020 2020 2020 2020  ning:.          
-000250a0: 2020 7365 6c66 2e74 7261 6e73 6974 696f    self.transitio
-000250b0: 6e73 280a 2020 2020 2020 2020 2020 2020  ns(.            
-000250c0: 2020 2020 7365 6c66 2e62 756c 6b5f 7363      self.bulk_sc
-000250d0: 6865 6475 6c65 5f75 6e72 756e 6e61 626c  hedule_unrunnabl
-000250e0: 655f 6166 7465 725f 6164 6469 6e67 5f77  e_after_adding_w
-000250f0: 6f72 6b65 7228 7773 292c 2073 7469 6d75  orker(ws), stimu
-00025100: 6c75 735f 6964 0a20 2020 2020 2020 2020  lus_id.         
-00025110: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00025120: 2073 656c 662e 7374 696d 756c 7573 5f71   self.stimulus_q
-00025130: 7565 7565 5f73 6c6f 7473 5f6d 6179 6265  ueue_slots_maybe
-00025140: 5f6f 7065 6e65 6428 7374 696d 756c 7573  _opened(stimulus
-00025150: 5f69 643d 7374 696d 756c 7573 5f69 6429  _id=stimulus_id)
-00025160: 0a0a 2020 2020 2020 2020 6c6f 6767 6572  ..        logger
-00025170: 2e69 6e66 6f28 2252 6567 6973 7465 7220  .info("Register 
-00025180: 776f 726b 6572 2025 7322 2c20 7773 290a  worker %s", ws).
-00025190: 0a20 2020 2020 2020 206d 7367 203d 207b  .        msg = {
-000251a0: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
-000251b0: 6174 7573 223a 2022 4f4b 222c 0a20 2020  atus": "OK",.   
-000251c0: 2020 2020 2020 2020 2022 7469 6d65 223a           "time":
-000251d0: 2074 696d 6528 292c 0a20 2020 2020 2020   time(),.       
-000251e0: 2020 2020 2022 6865 6172 7462 6561 742d       "heartbeat-
-000251f0: 696e 7465 7276 616c 223a 2068 6561 7274  interval": heart
-00025200: 6265 6174 5f69 6e74 6572 7661 6c28 6c65  beat_interval(le
-00025210: 6e28 7365 6c66 2e77 6f72 6b65 7273 2929  n(self.workers))
-00025220: 2c0a 2020 2020 2020 2020 2020 2020 2277  ,.            "w
-00025230: 6f72 6b65 722d 706c 7567 696e 7322 3a20  orker-plugins": 
-00025240: 7365 6c66 2e77 6f72 6b65 725f 706c 7567  self.worker_plug
-00025250: 696e 732c 0a20 2020 2020 2020 207d 0a0a  ins,.        }..
-00025260: 2020 2020 2020 2020 7665 7273 696f 6e5f          version_
-00025270: 7761 726e 696e 6720 3d20 7665 7273 696f  warning = versio
-00025280: 6e5f 6d6f 6475 6c65 2e65 7272 6f72 5f6d  n_module.error_m
-00025290: 6573 7361 6765 280a 2020 2020 2020 2020  essage(.        
-000252a0: 2020 2020 7665 7273 696f 6e5f 6d6f 6475      version_modu
-000252b0: 6c65 2e67 6574 5f76 6572 7369 6f6e 7328  le.get_versions(
-000252c0: 292c 0a20 2020 2020 2020 2020 2020 207b  ),.            {
-000252d0: 773a 2077 732e 7665 7273 696f 6e73 2066  w: ws.versions f
-000252e0: 6f72 2077 2c20 7773 2069 6e20 7365 6c66  or w, ws in self
-000252f0: 2e77 6f72 6b65 7273 2e69 7465 6d73 2829  .workers.items()
-00025300: 7d2c 0a20 2020 2020 2020 2020 2020 2076  },.            v
-00025310: 6572 7369 6f6e 732c 0a20 2020 2020 2020  ersions,.       
-00025320: 2020 2020 2073 6f75 7263 655f 6e61 6d65       source_name
-00025330: 3d73 7472 2877 732e 7365 7276 6572 5f69  =str(ws.server_i
-00025340: 6429 2c0a 2020 2020 2020 2020 290a 2020  d),.        ).  
-00025350: 2020 2020 2020 6d73 672e 7570 6461 7465        msg.update
-00025360: 2876 6572 7369 6f6e 5f77 6172 6e69 6e67  (version_warning
-00025370: 290a 0a20 2020 2020 2020 2061 7761 6974  )..        await
-00025380: 2063 6f6d 6d2e 7772 6974 6528 6d73 6729   comm.write(msg)
-00025390: 0a20 2020 2020 2020 2023 2054 6869 7320  .        # This 
-000253a0: 7769 6c6c 206b 6565 7020 7275 6e6e 696e  will keep runnin
-000253b0: 6720 756e 7469 6c20 7468 6520 776f 726b  g until the work
-000253c0: 6572 2069 7320 7265 6d6f 7665 640a 2020  er is removed.  
-000253d0: 2020 2020 2020 6177 6169 7420 7365 6c66        await self
-000253e0: 2e68 616e 646c 655f 776f 726b 6572 2863  .handle_worker(c
-000253f0: 6f6d 6d2c 2061 6464 7265 7373 290a 0a20  omm, address).. 
-00025400: 2020 2061 7379 6e63 2064 6566 2061 6464     async def add
-00025410: 5f6e 616e 6e79 2873 656c 6629 202d 3e20  _nanny(self) -> 
-00025420: 6469 6374 5b73 7472 2c20 416e 795d 3a0a  dict[str, Any]:.
-00025430: 2020 2020 2020 2020 6d73 6720 3d20 7b0a          msg = {.
-00025440: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
-00025450: 7475 7322 3a20 224f 4b22 2c0a 2020 2020  tus": "OK",.    
-00025460: 2020 2020 2020 2020 226e 616e 6e79 2d70          "nanny-p
-00025470: 6c75 6769 6e73 223a 2073 656c 662e 6e61  lugins": self.na
-00025480: 6e6e 795f 706c 7567 696e 732c 0a20 2020  nny_plugins,.   
-00025490: 2020 2020 207d 0a20 2020 2020 2020 2072       }.        r
-000254a0: 6574 7572 6e20 6d73 670a 0a20 2020 2064  eturn msg..    d
-000254b0: 6566 2075 7064 6174 655f 6772 6170 6828  ef update_graph(
-000254c0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-000254d0: 2020 2020 2020 2063 6c69 656e 743a 2073         client: s
-000254e0: 7472 2c0a 2020 2020 2020 2020 6772 6170  tr,.        grap
-000254f0: 685f 6865 6164 6572 3a20 6469 6374 2c0a  h_header: dict,.
-00025500: 2020 2020 2020 2020 6772 6170 685f 6672          graph_fr
-00025510: 616d 6573 3a20 6c69 7374 5b62 7974 6573  ames: list[bytes
-00025520: 5d2c 0a20 2020 2020 2020 206b 6579 733a  ],.        keys:
-00025530: 206c 6973 745b 7374 725d 2c0a 2020 2020   list[str],.    
-00025540: 2020 2020 696e 7465 726e 616c 5f70 7269      internal_pri
-00025550: 6f72 6974 793a 2064 6963 745b 7374 722c  ority: dict[str,
-00025560: 2069 6e74 5d20 7c20 4e6f 6e65 2c0a 2020   int] | None,.  
-00025570: 2020 2020 2020 7375 626d 6974 7469 6e67        submitting
-00025580: 5f74 6173 6b3a 2073 7472 207c 204e 6f6e  _task: str | Non
-00025590: 652c 0a20 2020 2020 2020 2075 7365 725f  e,.        user_
-000255a0: 7072 696f 7269 7479 3a20 696e 7420 7c20  priority: int | 
-000255b0: 6469 6374 5b73 7472 2c20 696e 745d 203d  dict[str, int] =
-000255c0: 2030 2c0a 2020 2020 2020 2020 6163 746f   0,.        acto
-000255d0: 7273 3a20 626f 6f6c 207c 206c 6973 745b  rs: bool | list[
-000255e0: 7374 725d 207c 204e 6f6e 6520 3d20 4e6f  str] | None = No
-000255f0: 6e65 2c0a 2020 2020 2020 2020 6669 666f  ne,.        fifo
-00025600: 5f74 696d 656f 7574 3a20 666c 6f61 7420  _timeout: float 
-00025610: 3d20 302e 302c 0a20 2020 2020 2020 2063  = 0.0,.        c
-00025620: 6f64 653a 2074 7570 6c65 5b73 7472 5d20  ode: tuple[str] 
-00025630: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-00025640: 2020 2020 2020 2061 6e6e 6f74 6174 696f         annotatio
-00025650: 6e73 3a20 6469 6374 207c 204e 6f6e 6520  ns: dict | None 
-00025660: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00025670: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
-00025680: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-00025690: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
-000256a0: 2020 2020 2020 2073 7461 7274 203d 2074         start = t
-000256b0: 696d 6528 290a 2020 2020 2020 2020 7472  ime().        tr
-000256c0: 793a 0a20 2020 2020 2020 2020 2020 2023  y:.            #
-000256d0: 2054 4f44 4f3a 2064 6573 6572 6961 6c69   TODO: deseriali
-000256e0: 7a61 7469 6f6e 202b 206d 6174 6572 6961  zation + materia
-000256f0: 6c69 7a61 7469 6f6e 2073 686f 756c 6420  lization should 
-00025700: 6265 206f 6666 6c6f 6164 6564 2074 6f20  be offloaded to 
-00025710: 610a 2020 2020 2020 2020 2020 2020 2320  a.            # 
-00025720: 7468 7265 6164 2073 696e 6365 2074 6869  thread since thi
-00025730: 7320 6973 206e 6f6e 2d74 7269 7669 616c  s is non-trivial
-00025740: 2063 6f6d 7075 7465 2074 696d 6520 7468   compute time th
-00025750: 6174 2062 6c6f 636b 7320 7468 650a 2020  at blocks the.  
-00025760: 2020 2020 2020 2020 2020 2320 6576 656e            # even
-00025770: 7420 6c6f 6f70 2e20 5468 6973 206c 696b  t loop. This lik
-00025780: 656c 7920 7265 7175 6972 6573 2075 7320  ely requires us 
-00025790: 746f 2075 7365 2061 206c 6f63 6b20 7369  to use a lock si
-000257a0: 6e63 6520 7765 206e 6565 6420 746f 0a20  nce we need to. 
-000257b0: 2020 2020 2020 2020 2020 2023 2067 7561             # gua
-000257c0: 7261 6e74 6565 206f 7264 6572 696e 6720  rantee ordering 
-000257d0: 6f66 2075 7064 6174 655f 6772 6170 6820  of update_graph 
-000257e0: 6361 6c6c 7320 2861 7320 6c6f 6e67 2061  calls (as long a
-000257f0: 7320 7468 6572 6520 6973 206a 7573 740a  s there is just.
-00025800: 2020 2020 2020 2020 2020 2020 2320 6120              # a 
-00025810: 7369 6e67 6c65 206f 6666 6c6f 6164 2074  single offload t
-00025820: 6872 6561 642c 2074 6869 7320 6973 206e  hread, this is n
-00025830: 6f74 2061 2070 726f 626c 656d 290a 2020  ot a problem).  
-00025840: 2020 2020 2020 2020 2020 6672 6f6d 2064            from d
-00025850: 6973 7472 6962 7574 6564 2e70 726f 746f  istributed.proto
-00025860: 636f 6c20 696d 706f 7274 2064 6573 6572  col import deser
-00025870: 6961 6c69 7a65 0a0a 2020 2020 2020 2020  ialize..        
-00025880: 2020 2020 6772 6170 6820 3d20 6465 7365      graph = dese
-00025890: 7269 616c 697a 6528 6772 6170 685f 6865  rialize(graph_he
-000258a0: 6164 6572 2c20 6772 6170 685f 6672 616d  ader, graph_fram
-000258b0: 6573 292e 6461 7461 0a20 2020 2020 2020  es).data.       
-000258c0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-000258d0: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
-000258e0: 2020 2020 6d73 6720 3d20 2222 225c 0a20      msg = """\. 
-000258f0: 2020 2020 2020 2020 2020 2020 2020 2045                 E
-00025900: 7272 6f72 2064 7572 696e 6720 6465 7365  rror during dese
-00025910: 7269 616c 697a 6174 696f 6e20 6f66 2074  rialization of t
-00025920: 6865 2074 6173 6b20 6772 6170 682e 2054  he task graph. T
-00025930: 6869 7320 6672 6571 7565 6e74 6c79 206f  his frequently o
-00025940: 6363 7572 7320 6966 2074 6865 2053 6368  ccurs if the Sch
-00025950: 6564 756c 6572 2061 6e64 2043 6c69 656e  eduler and Clien
-00025960: 7420 6861 7665 2064 6966 6665 7265 6e74  t have different
-00025970: 2065 6e76 6972 6f6e 6d65 6e74 732e 2046   environments. F
-00025980: 6f72 206d 6f72 6520 696e 666f 726d 6174  or more informat
-00025990: 696f 6e2c 2073 6565 2068 7474 7073 3a2f  ion, see https:/
-000259a0: 2f64 6f63 732e 6461 736b 2e6f 7267 2f65  /docs.dask.org/e
-000259b0: 6e2f 7374 6162 6c65 2f64 6570 6c6f 796d  n/stable/deploym
-000259c0: 656e 742d 636f 6e73 6964 6572 6174 696f  ent-consideratio
-000259d0: 6e73 2e68 746d 6c23 636f 6e73 6973 7465  ns.html#consiste
-000259e0: 6e74 2d73 6f66 7477 6172 652d 656e 7669  nt-software-envi
-000259f0: 726f 6e6d 656e 7473 0a20 2020 2020 2020  ronments.       
-00025a00: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00025a10: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00025a20: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00025a30: 5275 6e74 696d 6545 7272 6f72 2874 6578  RuntimeError(tex
-00025a40: 7477 7261 702e 6465 6465 6e74 286d 7367  twrap.dedent(msg
-00025a50: 2929 2066 726f 6d20 650a 2020 2020 2020  )) from e.      
-00025a60: 2020 2020 2020 6578 6365 7074 2052 756e        except Run
-00025a70: 7469 6d65 4572 726f 7220 6173 2065 3a0a  timeError as e:.
+0001edf0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0001ee00: 2020 2020 2020 2020 2020 2020 2022 5365               "Se
+0001ee10: 7276 6572 4170 7022 3a20 7b0a 2020 2020  rverApp": {.    
+0001ee20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ee30: 2020 2020 2020 2020 2262 6173 655f 7572          "base_ur
+0001ee40: 6c22 3a20 226a 7570 7974 6572 222c 0a20  l": "jupyter",. 
+0001ee50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ee60: 2020 2020 2020 2020 2020 2023 2053 4543             # SEC
+0001ee70: 5552 4954 593a 2057 6520 7573 7561 6c6c  URITY: We usuall
+0001ee80: 7920 6578 7065 6374 2074 6865 2064 6173  y expect the das
+0001ee90: 6862 6f61 7264 2074 6f20 6265 2061 2072  hboard to be a r
+0001eea0: 6561 642d 6f6e 6c79 2076 6965 7720 696e  ead-only view in
+0001eeb0: 746f 0a20 2020 2020 2020 2020 2020 2020  to.             
+0001eec0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001eed0: 2074 6865 2073 6368 6564 756c 6572 2061   the scheduler a
+0001eee0: 6374 6976 6974 792e 2048 6f77 6576 6572  ctivity. However
+0001eef0: 2c20 6279 2061 6464 696e 6720 616e 206f  , by adding an o
+0001ef00: 7065 6e20 4a75 7079 7465 7220 6170 706c  pen Jupyter appl
+0001ef10: 6963 6174 696f 6e0a 2020 2020 2020 2020  ication.        
+0001ef20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ef30: 2020 2020 2320 7765 2061 7265 2061 6c6c      # we are all
+0001ef40: 6f77 696e 6720 6172 6269 7472 6172 7920  owing arbitrary 
+0001ef50: 7265 6d6f 7465 2063 6f64 6520 6578 6563  remote code exec
+0001ef60: 7574 696f 6e20 6f6e 2074 6865 2073 6368  ution on the sch
+0001ef70: 6564 756c 6572 2076 6961 2074 6865 0a20  eduler via the. 
+0001ef80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ef90: 2020 2020 2020 2020 2020 2023 2064 6173             # das
+0001efa0: 6862 6f61 7264 2073 6572 7665 722e 2054  hboard server. T
+0001efb0: 6869 7320 6f70 7469 6f6e 2073 686f 756c  his option shoul
+0001efc0: 6420 6f6e 6c79 2062 6520 7573 6564 2077  d only be used w
+0001efd0: 6865 6e20 7468 6520 6461 7368 626f 6172  hen the dashboar
+0001efe0: 6420 6973 0a20 2020 2020 2020 2020 2020  d is.           
+0001eff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f000: 2023 2070 726f 7465 6374 6564 2076 6961   # protected via
+0001f010: 206f 7468 6572 206d 6561 6e73 2c20 6f72   other means, or
+0001f020: 2077 6865 6e20 796f 7520 646f 6e27 7420   when you don't 
+0001f030: 6361 7265 2061 626f 7574 2063 6c75 7374  care about clust
+0001f040: 6572 2073 6563 7572 6974 792e 0a20 2020  er security..   
+0001f050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f060: 2020 2020 2020 2020 2022 746f 6b65 6e22           "token"
+0001f070: 3a20 2222 2c0a 2020 2020 2020 2020 2020  : "",.          
+0001f080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f090: 2020 2261 6c6c 6f77 5f72 656d 6f74 655f    "allow_remote_
+0001f0a0: 6163 6365 7373 223a 2054 7275 652c 0a20  access": True,. 
+0001f0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f0c0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0001f0d0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+0001f0e0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0001f0f0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0001f100: 2020 2020 2020 2020 2020 206a 2e69 6e69             j.ini
+0001f110: 7469 616c 697a 6528 0a20 2020 2020 2020  tialize(.       
+0001f120: 2020 2020 2020 2020 206e 6577 5f68 7474           new_htt
+0001f130: 7073 6572 7665 723d 4661 6c73 652c 0a20  pserver=False,. 
+0001f140: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0001f150: 7267 763d 5b5d 2c0a 2020 2020 2020 2020  rgv=[],.        
+0001f160: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0001f170: 2020 7365 6c66 2e5f 6a75 7079 7465 725f    self._jupyter_
+0001f180: 7365 7276 6572 5f61 7070 6c69 6361 7469  server_applicati
+0001f190: 6f6e 203d 206a 0a20 2020 2020 2020 2020  on = j.         
+0001f1a0: 2020 2073 656c 662e 6874 7470 5f61 7070     self.http_app
+0001f1b0: 6c69 6361 7469 6f6e 2e61 6464 5f61 7070  lication.add_app
+0001f1c0: 6c69 6361 7469 6f6e 286a 2e77 6562 5f61  lication(j.web_a
+0001f1d0: 7070 290a 0a20 2020 2020 2020 2023 2043  pp)..        # C
+0001f1e0: 6f6d 6d75 6e69 6361 7469 6f6e 2073 7461  ommunication sta
+0001f1f0: 7465 0a20 2020 2020 2020 2073 656c 662e  te.        self.
+0001f200: 636c 6965 6e74 5f63 6f6d 6d73 203d 207b  client_comms = {
+0001f210: 7d0a 2020 2020 2020 2020 7365 6c66 2e73  }.        self.s
+0001f220: 7472 6561 6d5f 636f 6d6d 7320 3d20 7b7d  tream_comms = {}
+0001f230: 0a0a 2020 2020 2020 2020 2320 5461 736b  ..        # Task
+0001f240: 2073 7461 7465 0a20 2020 2020 2020 2074   state.        t
+0001f250: 6173 6b73 203d 207b 7d0a 0a20 2020 2020  asks = {}..     
+0001f260: 2020 2073 656c 662e 6765 6e65 7261 7469     self.generati
+0001f270: 6f6e 203d 2030 0a20 2020 2020 2020 2073  on = 0.        s
+0001f280: 656c 662e 5f6c 6173 745f 636c 6965 6e74  elf._last_client
+0001f290: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+0001f2a0: 7365 6c66 2e5f 6c61 7374 5f74 696d 6520  self._last_time 
+0001f2b0: 3d20 300a 2020 2020 2020 2020 756e 7275  = 0.        unru
+0001f2c0: 6e6e 6162 6c65 203d 2073 6574 2829 0a20  nnable = set(). 
+0001f2d0: 2020 2020 2020 2071 7565 7565 643a 2048         queued: H
+0001f2e0: 6561 7053 6574 5b54 6173 6b53 7461 7465  eapSet[TaskState
+0001f2f0: 5d20 3d20 4865 6170 5365 7428 6b65 793d  ] = HeapSet(key=
+0001f300: 6f70 6572 6174 6f72 2e61 7474 7267 6574  operator.attrget
+0001f310: 7465 7228 2270 7269 6f72 6974 7922 2929  ter("priority"))
+0001f320: 0a0a 2020 2020 2020 2020 7365 6c66 2e64  ..        self.d
+0001f330: 6174 6173 6574 7320 3d20 7b7d 0a0a 2020  atasets = {}..  
+0001f340: 2020 2020 2020 2320 5072 6566 6978 2d6b        # Prefix-k
+0001f350: 6579 6564 2063 6f6e 7461 696e 6572 730a  eyed containers.
+0001f360: 0a20 2020 2020 2020 2023 2043 6c69 656e  .        # Clien
+0001f370: 7420 7374 6174 650a 2020 2020 2020 2020  t state.        
+0001f380: 636c 6965 6e74 7320 3d20 7b7d 0a0a 2020  clients = {}..  
+0001f390: 2020 2020 2020 2320 576f 726b 6572 2073        # Worker s
+0001f3a0: 7461 7465 0a20 2020 2020 2020 2077 6f72  tate.        wor
+0001f3b0: 6b65 7273 203d 2053 6f72 7465 6444 6963  kers = SortedDic
+0001f3c0: 7428 290a 0a20 2020 2020 2020 2068 6f73  t()..        hos
+0001f3d0: 745f 696e 666f 203d 207b 7d0a 2020 2020  t_info = {}.    
+0001f3e0: 2020 2020 7265 736f 7572 6365 7320 3d20      resources = 
+0001f3f0: 7b7d 0a20 2020 2020 2020 2061 6c69 6173  {}.        alias
+0001f400: 6573 203d 207b 7d0a 0a20 2020 2020 2020  es = {}..       
+0001f410: 2073 656c 662e 5f77 6f72 6b65 725f 636f   self._worker_co
+0001f420: 6c6c 6563 7469 6f6e 7320 3d20 5b0a 2020  llections = [.  
+0001f430: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+0001f440: 732c 0a20 2020 2020 2020 2020 2020 2068  s,.            h
+0001f450: 6f73 745f 696e 666f 2c0a 2020 2020 2020  ost_info,.      
+0001f460: 2020 2020 2020 7265 736f 7572 6365 732c        resources,
+0001f470: 0a20 2020 2020 2020 2020 2020 2061 6c69  .            ali
+0001f480: 6173 6573 2c0a 2020 2020 2020 2020 5d0a  ases,.        ].
+0001f490: 0a20 2020 2020 2020 2073 656c 662e 6576  .        self.ev
+0001f4a0: 656e 7473 203d 2064 6566 6175 6c74 6469  ents = defaultdi
+0001f4b0: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
+0001f4c0: 7061 7274 6961 6c28 0a20 2020 2020 2020  partial(.       
+0001f4d0: 2020 2020 2020 2020 2064 6571 7565 2c20           deque, 
+0001f4e0: 6d61 786c 656e 3d64 6173 6b2e 636f 6e66  maxlen=dask.conf
+0001f4f0: 6967 2e67 6574 2822 6469 7374 7269 6275  ig.get("distribu
+0001f500: 7465 642e 7363 6865 6475 6c65 722e 6576  ted.scheduler.ev
+0001f510: 656e 7473 2d6c 6f67 2d6c 656e 6774 6822  ents-log-length"
+0001f520: 290a 2020 2020 2020 2020 2020 2020 290a  ).            ).
+0001f530: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0001f540: 2020 7365 6c66 2e65 7665 6e74 5f63 6f75    self.event_cou
+0001f550: 6e74 7320 3d20 6465 6661 756c 7464 6963  nts = defaultdic
+0001f560: 7428 696e 7429 0a20 2020 2020 2020 2073  t(int).        s
+0001f570: 656c 662e 6576 656e 745f 7375 6273 6372  elf.event_subscr
+0001f580: 6962 6572 203d 2064 6566 6175 6c74 6469  iber = defaultdi
+0001f590: 6374 2873 6574 290a 2020 2020 2020 2020  ct(set).        
+0001f5a0: 7365 6c66 2e77 6f72 6b65 725f 706c 7567  self.worker_plug
+0001f5b0: 696e 7320 3d20 7b7d 0a20 2020 2020 2020  ins = {}.       
+0001f5c0: 2073 656c 662e 6e61 6e6e 795f 706c 7567   self.nanny_plug
+0001f5d0: 696e 7320 3d20 7b7d 0a0a 2020 2020 2020  ins = {}..      
+0001f5e0: 2020 776f 726b 6572 5f68 616e 646c 6572    worker_handler
+0001f5f0: 7320 3d20 7b0a 2020 2020 2020 2020 2020  s = {.          
+0001f600: 2020 2274 6173 6b2d 6669 6e69 7368 6564    "task-finished
+0001f610: 223a 2073 656c 662e 6861 6e64 6c65 5f74  ": self.handle_t
+0001f620: 6173 6b5f 6669 6e69 7368 6564 2c0a 2020  ask_finished,.  
+0001f630: 2020 2020 2020 2020 2020 2274 6173 6b2d            "task-
+0001f640: 6572 7265 6422 3a20 7365 6c66 2e68 616e  erred": self.han
+0001f650: 646c 655f 7461 736b 5f65 7272 6564 2c0a  dle_task_erred,.
+0001f660: 2020 2020 2020 2020 2020 2020 2272 656c              "rel
+0001f670: 6561 7365 2d77 6f72 6b65 722d 6461 7461  ease-worker-data
+0001f680: 223a 2073 656c 662e 7265 6c65 6173 655f  ": self.release_
+0001f690: 776f 726b 6572 5f64 6174 612c 0a20 2020  worker_data,.   
+0001f6a0: 2020 2020 2020 2020 2022 6164 642d 6b65           "add-ke
+0001f6b0: 7973 223a 2073 656c 662e 6164 645f 6b65  ys": self.add_ke
+0001f6c0: 7973 2c0a 2020 2020 2020 2020 2020 2020  ys,.            
+0001f6d0: 226c 6f6e 672d 7275 6e6e 696e 6722 3a20  "long-running": 
+0001f6e0: 7365 6c66 2e68 616e 646c 655f 6c6f 6e67  self.handle_long
+0001f6f0: 5f72 756e 6e69 6e67 2c0a 2020 2020 2020  _running,.      
+0001f700: 2020 2020 2020 2272 6573 6368 6564 756c        "reschedul
+0001f710: 6522 3a20 7365 6c66 2e5f 7265 7363 6865  e": self._resche
+0001f720: 6475 6c65 2c0a 2020 2020 2020 2020 2020  dule,.          
+0001f730: 2020 226b 6565 702d 616c 6976 6522 3a20    "keep-alive": 
+0001f740: 6c61 6d62 6461 202a 6172 6773 2c20 2a2a  lambda *args, **
+0001f750: 6b77 6172 6773 3a20 4e6f 6e65 2c0a 2020  kwargs: None,.  
+0001f760: 2020 2020 2020 2020 2020 226c 6f67 2d65            "log-e
+0001f770: 7665 6e74 223a 2073 656c 662e 6c6f 675f  vent": self.log_
+0001f780: 776f 726b 6572 5f65 7665 6e74 2c0a 2020  worker_event,.  
+0001f790: 2020 2020 2020 2020 2020 2277 6f72 6b65            "worke
+0001f7a0: 722d 7374 6174 7573 2d63 6861 6e67 6522  r-status-change"
+0001f7b0: 3a20 7365 6c66 2e68 616e 646c 655f 776f  : self.handle_wo
+0001f7c0: 726b 6572 5f73 7461 7475 735f 6368 616e  rker_status_chan
+0001f7d0: 6765 2c0a 2020 2020 2020 2020 2020 2020  ge,.            
+0001f7e0: 2272 6571 7565 7374 2d72 6566 7265 7368  "request-refresh
+0001f7f0: 2d77 686f 2d68 6173 223a 2073 656c 662e  -who-has": self.
+0001f800: 6861 6e64 6c65 5f72 6571 7565 7374 5f72  handle_request_r
+0001f810: 6566 7265 7368 5f77 686f 5f68 6173 2c0a  efresh_who_has,.
+0001f820: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+0001f830: 2020 2063 6c69 656e 745f 6861 6e64 6c65     client_handle
+0001f840: 7273 203d 207b 0a20 2020 2020 2020 2020  rs = {.         
+0001f850: 2020 2022 7570 6461 7465 2d67 7261 7068     "update-graph
+0001f860: 223a 2073 656c 662e 7570 6461 7465 5f67  ": self.update_g
+0001f870: 7261 7068 2c0a 2020 2020 2020 2020 2020  raph,.          
+0001f880: 2020 2263 6c69 656e 742d 6465 7369 7265    "client-desire
+0001f890: 732d 6b65 7973 223a 2073 656c 662e 636c  s-keys": self.cl
+0001f8a0: 6965 6e74 5f64 6573 6972 6573 5f6b 6579  ient_desires_key
+0001f8b0: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
+0001f8c0: 7570 6461 7465 2d64 6174 6122 3a20 7365  update-data": se
+0001f8d0: 6c66 2e75 7064 6174 655f 6461 7461 2c0a  lf.update_data,.
+0001f8e0: 2020 2020 2020 2020 2020 2020 2272 6570              "rep
+0001f8f0: 6f72 742d 6b65 7922 3a20 7365 6c66 2e72  ort-key": self.r
+0001f900: 6570 6f72 745f 6f6e 5f6b 6579 2c0a 2020  eport_on_key,.  
+0001f910: 2020 2020 2020 2020 2020 2263 6c69 656e            "clien
+0001f920: 742d 7265 6c65 6173 6573 2d6b 6579 7322  t-releases-keys"
+0001f930: 3a20 7365 6c66 2e63 6c69 656e 745f 7265  : self.client_re
+0001f940: 6c65 6173 6573 5f6b 6579 732c 0a20 2020  leases_keys,.   
+0001f950: 2020 2020 2020 2020 2022 6865 6172 7462           "heartb
+0001f960: 6561 742d 636c 6965 6e74 223a 2073 656c  eat-client": sel
+0001f970: 662e 636c 6965 6e74 5f68 6561 7274 6265  f.client_heartbe
+0001f980: 6174 2c0a 2020 2020 2020 2020 2020 2020  at,.            
+0001f990: 2263 6c6f 7365 2d63 6c69 656e 7422 3a20  "close-client": 
+0001f9a0: 7365 6c66 2e72 656d 6f76 655f 636c 6965  self.remove_clie
+0001f9b0: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
+0001f9c0: 2273 7562 7363 7269 6265 2d74 6f70 6963  "subscribe-topic
+0001f9d0: 223a 2073 656c 662e 7375 6273 6372 6962  ": self.subscrib
+0001f9e0: 655f 746f 7069 632c 0a20 2020 2020 2020  e_topic,.       
+0001f9f0: 2020 2020 2022 756e 7375 6273 6372 6962       "unsubscrib
+0001fa00: 652d 746f 7069 6322 3a20 7365 6c66 2e75  e-topic": self.u
+0001fa10: 6e73 7562 7363 7269 6265 5f74 6f70 6963  nsubscribe_topic
+0001fa20: 2c0a 2020 2020 2020 2020 2020 2020 2263  ,.            "c
+0001fa30: 616e 6365 6c2d 6b65 7973 223a 2073 656c  ancel-keys": sel
+0001fa40: 662e 7374 696d 756c 7573 5f63 616e 6365  f.stimulus_cance
+0001fa50: 6c2c 0a20 2020 2020 2020 207d 0a0a 2020  l,.        }..  
+0001fa60: 2020 2020 2020 7365 6c66 2e68 616e 646c        self.handl
+0001fa70: 6572 7320 3d20 7b0a 2020 2020 2020 2020  ers = {.        
+0001fa80: 2020 2020 2272 6567 6973 7465 722d 636c      "register-cl
+0001fa90: 6965 6e74 223a 2073 656c 662e 6164 645f  ient": self.add_
+0001faa0: 636c 6965 6e74 2c0a 2020 2020 2020 2020  client,.        
+0001fab0: 2020 2020 2273 6361 7474 6572 223a 2073      "scatter": s
+0001fac0: 656c 662e 7363 6174 7465 722c 0a20 2020  elf.scatter,.   
+0001fad0: 2020 2020 2020 2020 2022 7265 6769 7374           "regist
+0001fae0: 6572 2d77 6f72 6b65 7222 3a20 7365 6c66  er-worker": self
+0001faf0: 2e61 6464 5f77 6f72 6b65 722c 0a20 2020  .add_worker,.   
+0001fb00: 2020 2020 2020 2020 2022 7265 6769 7374           "regist
+0001fb10: 6572 5f6e 616e 6e79 223a 2073 656c 662e  er_nanny": self.
+0001fb20: 6164 645f 6e61 6e6e 792c 0a20 2020 2020  add_nanny,.     
+0001fb30: 2020 2020 2020 2022 756e 7265 6769 7374         "unregist
+0001fb40: 6572 223a 2073 656c 662e 7265 6d6f 7665  er": self.remove
+0001fb50: 5f77 6f72 6b65 722c 0a20 2020 2020 2020  _worker,.       
+0001fb60: 2020 2020 2022 6761 7468 6572 223a 2073       "gather": s
+0001fb70: 656c 662e 6761 7468 6572 2c0a 2020 2020  elf.gather,.    
+0001fb80: 2020 2020 2020 2020 2272 6574 7279 223a          "retry":
+0001fb90: 2073 656c 662e 7374 696d 756c 7573 5f72   self.stimulus_r
+0001fba0: 6574 7279 2c0a 2020 2020 2020 2020 2020  etry,.          
+0001fbb0: 2020 2266 6565 6422 3a20 7365 6c66 2e66    "feed": self.f
+0001fbc0: 6565 642c 0a20 2020 2020 2020 2020 2020  eed,.           
+0001fbd0: 2022 7465 726d 696e 6174 6522 3a20 7365   "terminate": se
+0001fbe0: 6c66 2e63 6c6f 7365 2c0a 2020 2020 2020  lf.close,.      
+0001fbf0: 2020 2020 2020 2262 726f 6164 6361 7374        "broadcast
+0001fc00: 223a 2073 656c 662e 6272 6f61 6463 6173  ": self.broadcas
+0001fc10: 742c 0a20 2020 2020 2020 2020 2020 2022  t,.            "
+0001fc20: 7072 6f78 7922 3a20 7365 6c66 2e70 726f  proxy": self.pro
+0001fc30: 7879 2c0a 2020 2020 2020 2020 2020 2020  xy,.            
+0001fc40: 226e 636f 7265 7322 3a20 7365 6c66 2e67  "ncores": self.g
+0001fc50: 6574 5f6e 636f 7265 732c 0a20 2020 2020  et_ncores,.     
+0001fc60: 2020 2020 2020 2022 6e63 6f72 6573 5f72         "ncores_r
+0001fc70: 756e 6e69 6e67 223a 2073 656c 662e 6765  unning": self.ge
+0001fc80: 745f 6e63 6f72 6573 5f72 756e 6e69 6e67  t_ncores_running
+0001fc90: 2c0a 2020 2020 2020 2020 2020 2020 2268  ,.            "h
+0001fca0: 6173 5f77 6861 7422 3a20 7365 6c66 2e67  as_what": self.g
+0001fcb0: 6574 5f68 6173 5f77 6861 742c 0a20 2020  et_has_what,.   
+0001fcc0: 2020 2020 2020 2020 2022 7768 6f5f 6861           "who_ha
+0001fcd0: 7322 3a20 7365 6c66 2e67 6574 5f77 686f  s": self.get_who
+0001fce0: 5f68 6173 2c0a 2020 2020 2020 2020 2020  _has,.          
+0001fcf0: 2020 2270 726f 6365 7373 696e 6722 3a20    "processing": 
+0001fd00: 7365 6c66 2e67 6574 5f70 726f 6365 7373  self.get_process
+0001fd10: 696e 672c 0a20 2020 2020 2020 2020 2020  ing,.           
+0001fd20: 2022 6361 6c6c 5f73 7461 636b 223a 2073   "call_stack": s
+0001fd30: 656c 662e 6765 745f 6361 6c6c 5f73 7461  elf.get_call_sta
+0001fd40: 636b 2c0a 2020 2020 2020 2020 2020 2020  ck,.            
+0001fd50: 2270 726f 6669 6c65 223a 2073 656c 662e  "profile": self.
+0001fd60: 6765 745f 7072 6f66 696c 652c 0a20 2020  get_profile,.   
+0001fd70: 2020 2020 2020 2020 2022 7065 7266 6f72           "perfor
+0001fd80: 6d61 6e63 655f 7265 706f 7274 223a 2073  mance_report": s
+0001fd90: 656c 662e 7065 7266 6f72 6d61 6e63 655f  elf.performance_
+0001fda0: 7265 706f 7274 2c0a 2020 2020 2020 2020  report,.        
+0001fdb0: 2020 2020 2267 6574 5f6c 6f67 7322 3a20      "get_logs": 
+0001fdc0: 7365 6c66 2e67 6574 5f6c 6f67 732c 0a20  self.get_logs,. 
+0001fdd0: 2020 2020 2020 2020 2020 2022 6c6f 6773             "logs
+0001fde0: 223a 2073 656c 662e 6765 745f 6c6f 6773  ": self.get_logs
+0001fdf0: 2c0a 2020 2020 2020 2020 2020 2020 2277  ,.            "w
+0001fe00: 6f72 6b65 725f 6c6f 6773 223a 2073 656c  orker_logs": sel
+0001fe10: 662e 6765 745f 776f 726b 6572 5f6c 6f67  f.get_worker_log
+0001fe20: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
+0001fe30: 6c6f 675f 6576 656e 7422 3a20 7365 6c66  log_event": self
+0001fe40: 2e6c 6f67 5f65 7665 6e74 2c0a 2020 2020  .log_event,.    
+0001fe50: 2020 2020 2020 2020 2265 7665 6e74 7322          "events"
+0001fe60: 3a20 7365 6c66 2e67 6574 5f65 7665 6e74  : self.get_event
+0001fe70: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
+0001fe80: 6e62 7974 6573 223a 2073 656c 662e 6765  nbytes": self.ge
+0001fe90: 745f 6e62 7974 6573 2c0a 2020 2020 2020  t_nbytes,.      
+0001fea0: 2020 2020 2020 2276 6572 7369 6f6e 7322        "versions"
+0001feb0: 3a20 7365 6c66 2e76 6572 7369 6f6e 732c  : self.versions,
+0001fec0: 0a20 2020 2020 2020 2020 2020 2022 6164  .            "ad
+0001fed0: 645f 6b65 7973 223a 2073 656c 662e 6164  d_keys": self.ad
+0001fee0: 645f 6b65 7973 2c0a 2020 2020 2020 2020  d_keys,.        
+0001fef0: 2020 2020 2272 6562 616c 616e 6365 223a      "rebalance":
+0001ff00: 2073 656c 662e 7265 6261 6c61 6e63 652c   self.rebalance,
+0001ff10: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
+0001ff20: 706c 6963 6174 6522 3a20 7365 6c66 2e72  plicate": self.r
+0001ff30: 6570 6c69 6361 7465 2c0a 2020 2020 2020  eplicate,.      
+0001ff40: 2020 2020 2020 2272 756e 5f66 756e 6374        "run_funct
+0001ff50: 696f 6e22 3a20 7365 6c66 2e72 756e 5f66  ion": self.run_f
+0001ff60: 756e 6374 696f 6e2c 0a20 2020 2020 2020  unction,.       
+0001ff70: 2020 2020 2022 7265 7374 6172 7422 3a20       "restart": 
+0001ff80: 7365 6c66 2e72 6573 7461 7274 2c0a 2020  self.restart,.  
+0001ff90: 2020 2020 2020 2020 2020 2275 7064 6174            "updat
+0001ffa0: 655f 6461 7461 223a 2073 656c 662e 7570  e_data": self.up
+0001ffb0: 6461 7465 5f64 6174 612c 0a20 2020 2020  date_data,.     
+0001ffc0: 2020 2020 2020 2022 7365 745f 7265 736f         "set_reso
+0001ffd0: 7572 6365 7322 3a20 7365 6c66 2e61 6464  urces": self.add
+0001ffe0: 5f72 6573 6f75 7263 6573 2c0a 2020 2020  _resources,.    
+0001fff0: 2020 2020 2020 2020 2272 6574 6972 655f          "retire_
+00020000: 776f 726b 6572 7322 3a20 7365 6c66 2e72  workers": self.r
+00020010: 6574 6972 655f 776f 726b 6572 732c 0a20  etire_workers,. 
+00020020: 2020 2020 2020 2020 2020 2022 6765 745f             "get_
+00020030: 6d65 7461 6461 7461 223a 2073 656c 662e  metadata": self.
+00020040: 6765 745f 6d65 7461 6461 7461 2c0a 2020  get_metadata,.  
+00020050: 2020 2020 2020 2020 2020 2273 6574 5f6d            "set_m
+00020060: 6574 6164 6174 6122 3a20 7365 6c66 2e73  etadata": self.s
+00020070: 6574 5f6d 6574 6164 6174 612c 0a20 2020  et_metadata,.   
+00020080: 2020 2020 2020 2020 2022 7365 745f 7265           "set_re
+00020090: 7374 7269 6374 696f 6e73 223a 2073 656c  strictions": sel
+000200a0: 662e 7365 745f 7265 7374 7269 6374 696f  f.set_restrictio
+000200b0: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
+000200c0: 2268 6561 7274 6265 6174 5f77 6f72 6b65  "heartbeat_worke
+000200d0: 7222 3a20 7365 6c66 2e68 6561 7274 6265  r": self.heartbe
+000200e0: 6174 5f77 6f72 6b65 722c 0a20 2020 2020  at_worker,.     
+000200f0: 2020 2020 2020 2022 6765 745f 7461 736b         "get_task
+00020100: 5f73 7461 7475 7322 3a20 7365 6c66 2e67  _status": self.g
+00020110: 6574 5f74 6173 6b5f 7374 6174 7573 2c0a  et_task_status,.
+00020120: 2020 2020 2020 2020 2020 2020 2267 6574              "get
+00020130: 5f74 6173 6b5f 7374 7265 616d 223a 2073  _task_stream": s
+00020140: 656c 662e 6765 745f 7461 736b 5f73 7472  elf.get_task_str
+00020150: 6561 6d2c 0a20 2020 2020 2020 2020 2020  eam,.           
+00020160: 2022 6765 745f 7461 736b 5f70 7265 6669   "get_task_prefi
+00020170: 785f 7374 6174 6573 223a 2073 656c 662e  x_states": self.
+00020180: 6765 745f 7461 736b 5f70 7265 6669 785f  get_task_prefix_
+00020190: 7374 6174 6573 2c0a 2020 2020 2020 2020  states,.        
+000201a0: 2020 2020 2272 6567 6973 7465 725f 7363      "register_sc
+000201b0: 6865 6475 6c65 725f 706c 7567 696e 223a  heduler_plugin":
+000201c0: 2073 656c 662e 7265 6769 7374 6572 5f73   self.register_s
+000201d0: 6368 6564 756c 6572 5f70 6c75 6769 6e2c  cheduler_plugin,
+000201e0: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
+000201f0: 6769 7374 6572 5f77 6f72 6b65 725f 706c  gister_worker_pl
+00020200: 7567 696e 223a 2073 656c 662e 7265 6769  ugin": self.regi
+00020210: 7374 6572 5f77 6f72 6b65 725f 706c 7567  ster_worker_plug
+00020220: 696e 2c0a 2020 2020 2020 2020 2020 2020  in,.            
+00020230: 2275 6e72 6567 6973 7465 725f 776f 726b  "unregister_work
+00020240: 6572 5f70 6c75 6769 6e22 3a20 7365 6c66  er_plugin": self
+00020250: 2e75 6e72 6567 6973 7465 725f 776f 726b  .unregister_work
+00020260: 6572 5f70 6c75 6769 6e2c 0a20 2020 2020  er_plugin,.     
+00020270: 2020 2020 2020 2022 7265 6769 7374 6572         "register
+00020280: 5f6e 616e 6e79 5f70 6c75 6769 6e22 3a20  _nanny_plugin": 
+00020290: 7365 6c66 2e72 6567 6973 7465 725f 6e61  self.register_na
+000202a0: 6e6e 795f 706c 7567 696e 2c0a 2020 2020  nny_plugin,.    
+000202b0: 2020 2020 2020 2020 2275 6e72 6567 6973          "unregis
+000202c0: 7465 725f 6e61 6e6e 795f 706c 7567 696e  ter_nanny_plugin
+000202d0: 223a 2073 656c 662e 756e 7265 6769 7374  ": self.unregist
+000202e0: 6572 5f6e 616e 6e79 5f70 6c75 6769 6e2c  er_nanny_plugin,
+000202f0: 0a20 2020 2020 2020 2020 2020 2022 6164  .            "ad
+00020300: 6170 7469 7665 5f74 6172 6765 7422 3a20  aptive_target": 
+00020310: 7365 6c66 2e61 6461 7074 6976 655f 7461  self.adaptive_ta
+00020320: 7267 6574 2c0a 2020 2020 2020 2020 2020  rget,.          
+00020330: 2020 2277 6f72 6b65 7273 5f74 6f5f 636c    "workers_to_cl
+00020340: 6f73 6522 3a20 7365 6c66 2e77 6f72 6b65  ose": self.worke
+00020350: 7273 5f74 6f5f 636c 6f73 652c 0a20 2020  rs_to_close,.   
+00020360: 2020 2020 2020 2020 2022 7375 6273 6372           "subscr
+00020370: 6962 655f 776f 726b 6572 5f73 7461 7475  ibe_worker_statu
+00020380: 7322 3a20 7365 6c66 2e73 7562 7363 7269  s": self.subscri
+00020390: 6265 5f77 6f72 6b65 725f 7374 6174 7573  be_worker_status
+000203a0: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
+000203b0: 7461 7274 5f74 6173 6b5f 6d65 7461 6461  tart_task_metada
+000203c0: 7461 223a 2073 656c 662e 7374 6172 745f  ta": self.start_
+000203d0: 7461 736b 5f6d 6574 6164 6174 612c 0a20  task_metadata,. 
+000203e0: 2020 2020 2020 2020 2020 2022 7374 6f70             "stop
+000203f0: 5f74 6173 6b5f 6d65 7461 6461 7461 223a  _task_metadata":
+00020400: 2073 656c 662e 7374 6f70 5f74 6173 6b5f   self.stop_task_
+00020410: 6d65 7461 6461 7461 2c0a 2020 2020 2020  metadata,.      
+00020420: 2020 2020 2020 2267 6574 5f63 6c75 7374        "get_clust
+00020430: 6572 5f73 7461 7465 223a 2073 656c 662e  er_state": self.
+00020440: 6765 745f 636c 7573 7465 725f 7374 6174  get_cluster_stat
+00020450: 652c 0a20 2020 2020 2020 2020 2020 2022  e,.            "
+00020460: 6475 6d70 5f63 6c75 7374 6572 5f73 7461  dump_cluster_sta
+00020470: 7465 5f74 6f5f 7572 6c22 3a20 7365 6c66  te_to_url": self
+00020480: 2e64 756d 705f 636c 7573 7465 725f 7374  .dump_cluster_st
+00020490: 6174 655f 746f 5f75 726c 2c0a 2020 2020  ate_to_url,.    
+000204a0: 2020 2020 2020 2020 2262 656e 6368 6d61          "benchma
+000204b0: 726b 5f68 6172 6477 6172 6522 3a20 7365  rk_hardware": se
+000204c0: 6c66 2e62 656e 6368 6d61 726b 5f68 6172  lf.benchmark_har
+000204d0: 6477 6172 652c 0a20 2020 2020 2020 2020  dware,.         
+000204e0: 2020 2022 6765 745f 7374 6f72 7922 3a20     "get_story": 
+000204f0: 7365 6c66 2e67 6574 5f73 746f 7279 2c0a  self.get_story,.
+00020500: 2020 2020 2020 2020 2020 2020 2263 6865              "che
+00020510: 636b 5f69 646c 6522 3a20 7365 6c66 2e63  ck_idle": self.c
+00020520: 6865 636b 5f69 646c 652c 0a20 2020 2020  heck_idle,.     
+00020530: 2020 207d 0a0a 2020 2020 2020 2020 636f     }..        co
+00020540: 6e6e 6563 7469 6f6e 5f6c 696d 6974 203d  nnection_limit =
+00020550: 2067 6574 5f66 696c 656e 6f5f 6c69 6d69   get_fileno_limi
+00020560: 7428 2920 2f20 320a 0a20 2020 2020 2020  t() / 2..       
+00020570: 2053 6368 6564 756c 6572 5374 6174 652e   SchedulerState.
+00020580: 5f5f 696e 6974 5f5f 280a 2020 2020 2020  __init__(.      
+00020590: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+000205a0: 2020 2020 2020 2020 616c 6961 7365 733d          aliases=
+000205b0: 616c 6961 7365 732c 0a20 2020 2020 2020  aliases,.       
+000205c0: 2020 2020 2063 6c69 656e 7473 3d63 6c69       clients=cli
+000205d0: 656e 7473 2c0a 2020 2020 2020 2020 2020  ents,.          
+000205e0: 2020 776f 726b 6572 733d 776f 726b 6572    workers=worker
+000205f0: 732c 0a20 2020 2020 2020 2020 2020 2068  s,.            h
+00020600: 6f73 745f 696e 666f 3d68 6f73 745f 696e  ost_info=host_in
+00020610: 666f 2c0a 2020 2020 2020 2020 2020 2020  fo,.            
+00020620: 7265 736f 7572 6365 733d 7265 736f 7572  resources=resour
+00020630: 6365 732c 0a20 2020 2020 2020 2020 2020  ces,.           
+00020640: 2074 6173 6b73 3d74 6173 6b73 2c0a 2020   tasks=tasks,.  
+00020650: 2020 2020 2020 2020 2020 756e 7275 6e6e            unrunn
+00020660: 6162 6c65 3d75 6e72 756e 6e61 626c 652c  able=unrunnable,
+00020670: 0a20 2020 2020 2020 2020 2020 2071 7565  .            que
+00020680: 7565 643d 7175 6575 6564 2c0a 2020 2020  ued=queued,.    
+00020690: 2020 2020 2020 2020 7661 6c69 6461 7465          validate
+000206a0: 3d76 616c 6964 6174 652c 0a20 2020 2020  =validate,.     
+000206b0: 2020 2020 2020 2070 6c75 6769 6e73 3d70         plugins=p
+000206c0: 6c75 6769 6e73 2c0a 2020 2020 2020 2020  lugins,.        
+000206d0: 2020 2020 7472 616e 7369 7469 6f6e 5f63      transition_c
+000206e0: 6f75 6e74 6572 5f6d 6178 3d74 7261 6e73  ounter_max=trans
+000206f0: 6974 696f 6e5f 636f 756e 7465 725f 6d61  ition_counter_ma
+00020700: 782c 0a20 2020 2020 2020 2029 0a20 2020  x,.        ).   
+00020710: 2020 2020 2053 6572 7665 724e 6f64 652e       ServerNode.
+00020720: 5f5f 696e 6974 5f5f 280a 2020 2020 2020  __init__(.      
+00020730: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00020740: 2020 2020 2020 2020 6861 6e64 6c65 7273          handlers
+00020750: 3d73 656c 662e 6861 6e64 6c65 7273 2c0a  =self.handlers,.
+00020760: 2020 2020 2020 2020 2020 2020 7374 7265              stre
+00020770: 616d 5f68 616e 646c 6572 733d 6d65 7267  am_handlers=merg
+00020780: 6528 776f 726b 6572 5f68 616e 646c 6572  e(worker_handler
+00020790: 732c 2063 6c69 656e 745f 6861 6e64 6c65  s, client_handle
+000207a0: 7273 292c 0a20 2020 2020 2020 2020 2020  rs),.           
+000207b0: 2063 6f6e 6e65 6374 696f 6e5f 6c69 6d69   connection_limi
+000207c0: 743d 636f 6e6e 6563 7469 6f6e 5f6c 696d  t=connection_lim
+000207d0: 6974 2c0a 2020 2020 2020 2020 2020 2020  it,.            
+000207e0: 6465 7365 7269 616c 697a 653d 4661 6c73  deserialize=Fals
+000207f0: 652c 0a20 2020 2020 2020 2020 2020 2063  e,.            c
+00020800: 6f6e 6e65 6374 696f 6e5f 6172 6773 3d73  onnection_args=s
+00020810: 656c 662e 636f 6e6e 6563 7469 6f6e 5f61  elf.connection_a
+00020820: 7267 732c 0a20 2020 2020 2020 2020 2020  rgs,.           
+00020830: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
+00020840: 2020 2029 0a0a 2020 2020 2020 2020 6966     )..        if
+00020850: 2073 656c 662e 776f 726b 6572 5f74 746c   self.worker_ttl
+00020860: 3a0a 2020 2020 2020 2020 2020 2020 7063  :.            pc
+00020870: 203d 2050 6572 696f 6469 6343 616c 6c62   = PeriodicCallb
+00020880: 6163 6b28 7365 6c66 2e63 6865 636b 5f77  ack(self.check_w
+00020890: 6f72 6b65 725f 7474 6c2c 2073 656c 662e  orker_ttl, self.
+000208a0: 776f 726b 6572 5f74 746c 202a 2031 3030  worker_ttl * 100
+000208b0: 3029 0a20 2020 2020 2020 2020 2020 2073  0).            s
+000208c0: 656c 662e 7065 7269 6f64 6963 5f63 616c  elf.periodic_cal
+000208d0: 6c62 6163 6b73 5b22 776f 726b 6572 2d74  lbacks["worker-t
+000208e0: 746c 225d 203d 2070 630a 0a20 2020 2020  tl"] = pc..     
+000208f0: 2020 2070 6320 3d20 5065 7269 6f64 6963     pc = Periodic
+00020900: 4361 6c6c 6261 636b 2873 656c 662e 6368  Callback(self.ch
+00020910: 6563 6b5f 6964 6c65 2c20 2873 656c 662e  eck_idle, (self.
+00020920: 6964 6c65 5f74 696d 656f 7574 206f 7220  idle_timeout or 
+00020930: 3129 202a 2031 3030 3020 2f20 3429 0a20  1) * 1000 / 4). 
+00020940: 2020 2020 2020 2073 656c 662e 7065 7269         self.peri
+00020950: 6f64 6963 5f63 616c 6c62 6163 6b73 5b22  odic_callbacks["
+00020960: 6964 6c65 2d74 696d 656f 7574 225d 203d  idle-timeout"] =
+00020970: 2070 630a 0a20 2020 2020 2020 2069 6620   pc..        if 
+00020980: 6578 7465 6e73 696f 6e73 2069 7320 4e6f  extensions is No
+00020990: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000209a0: 6578 7465 6e73 696f 6e73 203d 2044 4546  extensions = DEF
+000209b0: 4155 4c54 5f45 5854 454e 5349 4f4e 532e  AULT_EXTENSIONS.
+000209c0: 636f 7079 2829 0a20 2020 2020 2020 2020  copy().         
+000209d0: 2020 2069 6620 6e6f 7420 6461 736b 2e63     if not dask.c
+000209e0: 6f6e 6669 672e 6765 7428 2264 6973 7472  onfig.get("distr
+000209f0: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
+00020a00: 2e77 6f72 6b2d 7374 6561 6c69 6e67 2229  .work-stealing")
+00020a10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00020a20: 2020 6966 2022 7374 6561 6c69 6e67 2220    if "stealing" 
+00020a30: 696e 2065 7874 656e 7369 6f6e 733a 0a20  in extensions:. 
+00020a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020a50: 2020 2064 656c 2065 7874 656e 7369 6f6e     del extension
+00020a60: 735b 2273 7465 616c 696e 6722 5d0a 0a20  s["stealing"].. 
+00020a70: 2020 2020 2020 2066 6f72 206e 616d 652c         for name,
+00020a80: 2065 7874 656e 7369 6f6e 2069 6e20 6578   extension in ex
+00020a90: 7465 6e73 696f 6e73 2e69 7465 6d73 2829  tensions.items()
+00020aa0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00020ab0: 6c66 2e65 7874 656e 7369 6f6e 735b 6e61  lf.extensions[na
+00020ac0: 6d65 5d20 3d20 6578 7465 6e73 696f 6e28  me] = extension(
+00020ad0: 7365 6c66 290a 0a20 2020 2020 2020 2073  self)..        s
+00020ae0: 6574 7072 6f63 7469 746c 6528 2264 6173  etproctitle("das
+00020af0: 6b20 7363 6865 6475 6c65 7220 5b6e 6f74  k scheduler [not
+00020b00: 2073 7461 7274 6564 5d22 290a 2020 2020   started]").    
+00020b10: 2020 2020 5363 6865 6475 6c65 722e 5f69      Scheduler._i
+00020b20: 6e73 7461 6e63 6573 2e61 6464 2873 656c  nstances.add(sel
+00020b30: 6629 0a20 2020 2020 2020 2073 656c 662e  f).        self.
+00020b40: 7270 632e 616c 6c6f 775f 6f66 666c 6f61  rpc.allow_offloa
+00020b50: 6420 3d20 4661 6c73 650a 0a20 2020 2023  d = False..    #
+00020b60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00020b70: 230a 2020 2020 2320 4164 6d69 6e69 7374  #.    # Administ
+00020b80: 7261 7469 6f6e 2023 0a20 2020 2023 2323  ration #.    ###
+00020b90: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+00020ba0: 0a20 2020 2064 6566 205f 5f72 6570 725f  .    def __repr_
+00020bb0: 5f28 7365 6c66 293a 0a20 2020 2020 2020  _(self):.       
+00020bc0: 2072 6574 7572 6e20 280a 2020 2020 2020   return (.      
+00020bd0: 2020 2020 2020 6622 3c53 6368 6564 756c        f"<Schedul
+00020be0: 6572 207b 7365 6c66 2e61 6464 7265 7373  er {self.address
+00020bf0: 5f73 6166 6521 727d 2c20 220a 2020 2020  _safe!r}, ".    
+00020c00: 2020 2020 2020 2020 6622 776f 726b 6572          f"worker
+00020c10: 733a 207b 6c65 6e28 7365 6c66 2e77 6f72  s: {len(self.wor
+00020c20: 6b65 7273 297d 2c20 220a 2020 2020 2020  kers)}, ".      
+00020c30: 2020 2020 2020 6622 636f 7265 733a 207b        f"cores: {
+00020c40: 7365 6c66 2e74 6f74 616c 5f6e 7468 7265  self.total_nthre
+00020c50: 6164 737d 2c20 220a 2020 2020 2020 2020  ads}, ".        
+00020c60: 2020 2020 6622 7461 736b 733a 207b 6c65      f"tasks: {le
+00020c70: 6e28 7365 6c66 2e74 6173 6b73 297d 3e22  n(self.tasks)}>"
+00020c80: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00020c90: 6465 6620 5f72 6570 725f 6874 6d6c 5f28  def _repr_html_(
+00020ca0: 7365 6c66 293a 0a20 2020 2020 2020 2072  self):.        r
+00020cb0: 6574 7572 6e20 6765 745f 7465 6d70 6c61  eturn get_templa
+00020cc0: 7465 2822 7363 6865 6475 6c65 722e 6874  te("scheduler.ht
+00020cd0: 6d6c 2e6a 3222 292e 7265 6e64 6572 280a  ml.j2").render(.
+00020ce0: 2020 2020 2020 2020 2020 2020 6164 6472              addr
+00020cf0: 6573 733d 7365 6c66 2e61 6464 7265 7373  ess=self.address
+00020d00: 2c0a 2020 2020 2020 2020 2020 2020 776f  ,.            wo
+00020d10: 726b 6572 733d 7365 6c66 2e77 6f72 6b65  rkers=self.worke
+00020d20: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
+00020d30: 7468 7265 6164 733d 7365 6c66 2e74 6f74  threads=self.tot
+00020d40: 616c 5f6e 7468 7265 6164 732c 0a20 2020  al_nthreads,.   
+00020d50: 2020 2020 2020 2020 2074 6173 6b73 3d73           tasks=s
+00020d60: 656c 662e 7461 736b 732c 0a20 2020 2020  elf.tasks,.     
+00020d70: 2020 2029 0a0a 2020 2020 6465 6620 6964     )..    def id
+00020d80: 656e 7469 7479 2873 656c 6629 3a0a 2020  entity(self):.  
+00020d90: 2020 2020 2020 2222 2242 6173 6963 2069        """Basic i
+00020da0: 6e66 6f72 6d61 7469 6f6e 2061 626f 7574  nformation about
+00020db0: 206f 7572 7365 6c76 6573 2061 6e64 206f   ourselves and o
+00020dc0: 7572 2063 6c75 7374 6572 2222 220a 2020  ur cluster""".  
+00020dd0: 2020 2020 2020 6420 3d20 7b0a 2020 2020        d = {.    
+00020de0: 2020 2020 2020 2020 2274 7970 6522 3a20          "type": 
+00020df0: 7479 7065 2873 656c 6629 2e5f 5f6e 616d  type(self).__nam
+00020e00: 655f 5f2c 0a20 2020 2020 2020 2020 2020  e__,.           
+00020e10: 2022 6964 223a 2073 7472 2873 656c 662e   "id": str(self.
+00020e20: 6964 292c 0a20 2020 2020 2020 2020 2020  id),.           
+00020e30: 2022 6164 6472 6573 7322 3a20 7365 6c66   "address": self
+00020e40: 2e61 6464 7265 7373 2c0a 2020 2020 2020  .address,.      
+00020e50: 2020 2020 2020 2273 6572 7669 6365 7322        "services"
+00020e60: 3a20 7b6b 6579 3a20 762e 706f 7274 2066  : {key: v.port f
+00020e70: 6f72 2028 6b65 792c 2076 2920 696e 2073  or (key, v) in s
+00020e80: 656c 662e 7365 7276 6963 6573 2e69 7465  elf.services.ite
+00020e90: 6d73 2829 7d2c 0a20 2020 2020 2020 2020  ms()},.         
+00020ea0: 2020 2022 7374 6172 7465 6422 3a20 7365     "started": se
+00020eb0: 6c66 2e74 696d 655f 7374 6172 7465 642c  lf.time_started,
+00020ec0: 0a20 2020 2020 2020 2020 2020 2022 776f  .            "wo
+00020ed0: 726b 6572 7322 3a20 7b0a 2020 2020 2020  rkers": {.      
+00020ee0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+00020ef0: 2e61 6464 7265 7373 3a20 776f 726b 6572  .address: worker
+00020f00: 2e69 6465 6e74 6974 7928 2920 666f 7220  .identity() for 
+00020f10: 776f 726b 6572 2069 6e20 7365 6c66 2e77  worker in self.w
+00020f20: 6f72 6b65 7273 2e76 616c 7565 7328 290a  orkers.values().
+00020f30: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
+00020f40: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00020f50: 2072 6574 7572 6e20 640a 0a20 2020 2064   return d..    d
+00020f60: 6566 205f 746f 5f64 6963 7428 7365 6c66  ef _to_dict(self
+00020f70: 2c20 2a2c 2065 7863 6c75 6465 3a20 436f  , *, exclude: Co
+00020f80: 6e74 6169 6e65 725b 7374 725d 203d 2028  ntainer[str] = (
+00020f90: 2929 202d 3e20 6469 6374 3a0a 2020 2020  )) -> dict:.    
+00020fa0: 2020 2020 2222 2244 6963 7469 6f6e 6172      """Dictionar
+00020fb0: 7920 7265 7072 6573 656e 7461 7469 6f6e  y representation
+00020fc0: 2066 6f72 2064 6562 7567 6769 6e67 2070   for debugging p
+00020fd0: 7572 706f 7365 732e 0a20 2020 2020 2020  urposes..       
+00020fe0: 204e 6f74 2074 7970 6520 7374 6162 6c65   Not type stable
+00020ff0: 2061 6e64 206e 6f74 2069 6e74 656e 6465   and not intende
+00021000: 6420 666f 7220 726f 756e 6474 7269 7073  d for roundtrips
+00021010: 2e0a 0a20 2020 2020 2020 2053 6565 2061  ...        See a
+00021020: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
+00021030: 2d2d 2d2d 0a20 2020 2020 2020 2053 6572  ----.        Ser
+00021040: 7665 722e 6964 656e 7469 7479 0a20 2020  ver.identity.   
+00021050: 2020 2020 2043 6c69 656e 742e 6475 6d70       Client.dump
+00021060: 5f63 6c75 7374 6572 5f73 7461 7465 0a20  _cluster_state. 
+00021070: 2020 2020 2020 2064 6973 7472 6962 7574         distribut
+00021080: 6564 2e75 7469 6c73 2e72 6563 7572 7369  ed.utils.recursi
+00021090: 7665 5f74 6f5f 6469 6374 0a20 2020 2020  ve_to_dict.     
+000210a0: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
+000210b0: 6e66 6f20 3d20 7375 7065 7228 292e 5f74  nfo = super()._t
+000210c0: 6f5f 6469 6374 2865 7863 6c75 6465 3d65  o_dict(exclude=e
+000210d0: 7863 6c75 6465 290a 2020 2020 2020 2020  xclude).        
+000210e0: 6578 7472 6120 3d20 7b0a 2020 2020 2020  extra = {.      
+000210f0: 2020 2020 2020 2274 7261 6e73 6974 696f        "transitio
+00021100: 6e5f 6c6f 6722 3a20 7365 6c66 2e74 7261  n_log": self.tra
+00021110: 6e73 6974 696f 6e5f 6c6f 672c 0a20 2020  nsition_log,.   
+00021120: 2020 2020 2020 2020 2022 7472 616e 7369           "transi
+00021130: 7469 6f6e 5f63 6f75 6e74 6572 223a 2073  tion_counter": s
+00021140: 656c 662e 7472 616e 7369 7469 6f6e 5f63  elf.transition_c
+00021150: 6f75 6e74 6572 2c0a 2020 2020 2020 2020  ounter,.        
+00021160: 2020 2020 2274 6173 6b73 223a 2073 656c      "tasks": sel
+00021170: 662e 7461 736b 732c 0a20 2020 2020 2020  f.tasks,.       
+00021180: 2020 2020 2022 7461 736b 5f67 726f 7570       "task_group
+00021190: 7322 3a20 7365 6c66 2e74 6173 6b5f 6772  s": self.task_gr
+000211a0: 6f75 7073 2c0a 2020 2020 2020 2020 2020  oups,.          
+000211b0: 2020 2320 4f76 6572 7772 6974 6520 6469    # Overwrite di
+000211c0: 6374 206f 6620 576f 726b 6572 5374 6174  ct of WorkerStat
+000211d0: 652e 6964 656e 7469 7479 2066 726f 6d20  e.identity from 
+000211e0: 696e 666f 0a20 2020 2020 2020 2020 2020  info.           
+000211f0: 2022 776f 726b 6572 7322 3a20 7365 6c66   "workers": self
+00021200: 2e77 6f72 6b65 7273 2c0a 2020 2020 2020  .workers,.      
+00021210: 2020 2020 2020 2263 6c69 656e 7473 223a        "clients":
+00021220: 2073 656c 662e 636c 6965 6e74 732c 0a20   self.clients,. 
+00021230: 2020 2020 2020 2020 2020 2022 6d65 6d6f             "memo
+00021240: 7279 223a 2073 656c 662e 6d65 6d6f 7279  ry": self.memory
+00021250: 2c0a 2020 2020 2020 2020 2020 2020 2265  ,.            "e
+00021260: 7665 6e74 7322 3a20 7365 6c66 2e65 7665  vents": self.eve
+00021270: 6e74 732c 0a20 2020 2020 2020 2020 2020  nts,.           
+00021280: 2022 6578 7465 6e73 696f 6e73 223a 2073   "extensions": s
+00021290: 656c 662e 6578 7465 6e73 696f 6e73 2c0a  elf.extensions,.
+000212a0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+000212b0: 2020 6578 7472 6120 3d20 7b6b 3a20 7620    extra = {k: v 
+000212c0: 666f 7220 6b2c 2076 2069 6e20 6578 7472  for k, v in extr
+000212d0: 612e 6974 656d 7328 2920 6966 206b 206e  a.items() if k n
+000212e0: 6f74 2069 6e20 6578 636c 7564 657d 0a20  ot in exclude}. 
+000212f0: 2020 2020 2020 2069 6e66 6f2e 7570 6461         info.upda
+00021300: 7465 2872 6563 7572 7369 7665 5f74 6f5f  te(recursive_to_
+00021310: 6469 6374 2865 7874 7261 2c20 6578 636c  dict(extra, excl
+00021320: 7564 653d 6578 636c 7564 6529 290a 2020  ude=exclude)).  
+00021330: 2020 2020 2020 7265 7475 726e 2069 6e66        return inf
+00021340: 6f0a 0a20 2020 2061 7379 6e63 2064 6566  o..    async def
+00021350: 2067 6574 5f63 6c75 7374 6572 5f73 7461   get_cluster_sta
+00021360: 7465 280a 2020 2020 2020 2020 7365 6c66  te(.        self
+00021370: 2c0a 2020 2020 2020 2020 6578 636c 7564  ,.        exclud
+00021380: 653a 2022 436f 6c6c 6563 7469 6f6e 5b73  e: "Collection[s
+00021390: 7472 5d22 2c0a 2020 2020 2920 2d3e 2064  tr]",.    ) -> d
+000213a0: 6963 743a 0a20 2020 2020 2020 2022 5072  ict:.        "Pr
+000213b0: 6f64 7563 6520 7468 6520 7374 6174 6520  oduce the state 
+000213c0: 6469 6374 2075 7365 6420 696e 2061 2063  dict used in a c
+000213d0: 6c75 7374 6572 2073 7461 7465 2064 756d  luster state dum
+000213e0: 7022 0a20 2020 2020 2020 2023 204b 6963  p".        # Kic
+000213f0: 6b20 6f66 6620 7374 6174 652d 6475 6d70  k off state-dump
+00021400: 696e 6720 6f6e 2077 6f72 6b65 7273 2062  ing on workers b
+00021410: 6566 6f72 6520 7765 2062 6c6f 636b 2074  efore we block t
+00021420: 6865 2065 7665 6e74 206c 6f6f 7020 696e  he event loop in
+00021430: 2060 7365 6c66 2e5f 746f 5f64 6963 7460   `self._to_dict`
+00021440: 2e0a 2020 2020 2020 2020 776f 726b 6572  ..        worker
+00021450: 735f 6675 7475 7265 203d 2061 7379 6e63  s_future = async
+00021460: 696f 2e67 6174 6865 7228 0a20 2020 2020  io.gather(.     
+00021470: 2020 2020 2020 2073 656c 662e 6272 6f61         self.broa
+00021480: 6463 6173 7428 0a20 2020 2020 2020 2020  dcast(.         
+00021490: 2020 2020 2020 206d 7367 3d7b 226f 7022         msg={"op"
+000214a0: 3a20 2264 756d 705f 7374 6174 6522 2c20  : "dump_state", 
+000214b0: 2265 7863 6c75 6465 223a 2065 7863 6c75  "exclude": exclu
+000214c0: 6465 7d2c 0a20 2020 2020 2020 2020 2020  de},.           
+000214d0: 2020 2020 206f 6e5f 6572 726f 723d 2272       on_error="r
+000214e0: 6574 7572 6e22 2c0a 2020 2020 2020 2020  eturn",.        
+000214f0: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
+00021500: 2020 2073 656c 662e 6272 6f61 6463 6173     self.broadcas
+00021510: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+00021520: 2020 206d 7367 3d7b 226f 7022 3a20 2276     msg={"op": "v
+00021530: 6572 7369 6f6e 7322 7d2c 0a20 2020 2020  ersions"},.     
+00021540: 2020 2020 2020 2020 2020 206f 6e5f 6572             on_er
+00021550: 726f 723d 2269 676e 6f72 6522 2c0a 2020  ror="ignore",.  
+00021560: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+00021570: 2020 2020 2029 0a20 2020 2020 2020 2074       ).        t
+00021580: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00021590: 7363 6865 6475 6c65 725f 7374 6174 6520  scheduler_state 
+000215a0: 3d20 7365 6c66 2e5f 746f 5f64 6963 7428  = self._to_dict(
+000215b0: 6578 636c 7564 653d 6578 636c 7564 6529  exclude=exclude)
+000215c0: 0a0a 2020 2020 2020 2020 2020 2020 776f  ..            wo
+000215d0: 726b 6572 5f73 7461 7465 732c 2077 6f72  rker_states, wor
+000215e0: 6b65 725f 7665 7273 696f 6e73 203d 2061  ker_versions = a
+000215f0: 7761 6974 2077 6f72 6b65 7273 5f66 7574  wait workers_fut
+00021600: 7572 650a 2020 2020 2020 2020 6669 6e61  ure.        fina
+00021610: 6c6c 793a 0a20 2020 2020 2020 2020 2020  lly:.           
+00021620: 2023 2045 6e73 7572 6520 7468 6520 7461   # Ensure the ta
+00021630: 736b 7320 6172 656e 2774 206c 6566 7420  sks aren't left 
+00021640: 7275 6e6e 696e 6720 6966 2061 6e79 7468  running if anyth
+00021650: 696e 6720 6661 696c 732e 0a20 2020 2020  ing fails..     
+00021660: 2020 2020 2020 2023 2053 6f6d 6564 6179         # Someday
+00021670: 2028 7079 332e 3131 292c 2075 7365 2061   (py3.11), use a
+00021680: 2074 7269 6f2d 7374 796c 6520 5461 736b   trio-style Task
+00021690: 4772 6f75 7020 666f 7220 7468 6973 2e0a  Group for this..
+000216a0: 2020 2020 2020 2020 2020 2020 776f 726b              work
+000216b0: 6572 735f 6675 7475 7265 2e63 616e 6365  ers_future.cance
+000216c0: 6c28 290a 0a20 2020 2020 2020 2023 2043  l()..        # C
+000216d0: 6f6e 7665 7274 2061 6e79 2052 5043 2065  onvert any RPC e
+000216e0: 7272 6f72 7320 746f 2073 7472 696e 6773  rrors to strings
+000216f0: 0a20 2020 2020 2020 2077 6f72 6b65 725f  .        worker_
+00021700: 7374 6174 6573 203d 207b 0a20 2020 2020  states = {.     
+00021710: 2020 2020 2020 206b 3a20 7265 7072 2876         k: repr(v
+00021720: 2920 6966 2069 7369 6e73 7461 6e63 6528  ) if isinstance(
+00021730: 762c 2045 7863 6570 7469 6f6e 2920 656c  v, Exception) el
+00021740: 7365 2076 0a20 2020 2020 2020 2020 2020  se v.           
+00021750: 2066 6f72 206b 2c20 7620 696e 2077 6f72   for k, v in wor
+00021760: 6b65 725f 7374 6174 6573 2e69 7465 6d73  ker_states.items
+00021770: 2829 0a20 2020 2020 2020 207d 0a0a 2020  ().        }..  
+00021780: 2020 2020 2020 7265 7475 726e 207b 0a20        return {. 
+00021790: 2020 2020 2020 2020 2020 2022 7363 6865             "sche
+000217a0: 6475 6c65 7222 3a20 7363 6865 6475 6c65  duler": schedule
+000217b0: 725f 7374 6174 652c 0a20 2020 2020 2020  r_state,.       
+000217c0: 2020 2020 2022 776f 726b 6572 7322 3a20       "workers": 
+000217d0: 776f 726b 6572 5f73 7461 7465 732c 0a20  worker_states,. 
+000217e0: 2020 2020 2020 2020 2020 2022 7665 7273             "vers
+000217f0: 696f 6e73 223a 207b 2273 6368 6564 756c  ions": {"schedul
+00021800: 6572 223a 2073 656c 662e 7665 7273 696f  er": self.versio
+00021810: 6e73 2829 2c20 2277 6f72 6b65 7273 223a  ns(), "workers":
+00021820: 2077 6f72 6b65 725f 7665 7273 696f 6e73   worker_versions
+00021830: 7d2c 0a20 2020 2020 2020 207d 0a0a 2020  },.        }..  
+00021840: 2020 6173 796e 6320 6465 6620 6475 6d70    async def dump
+00021850: 5f63 6c75 7374 6572 5f73 7461 7465 5f74  _cluster_state_t
+00021860: 6f5f 7572 6c28 0a20 2020 2020 2020 2073  o_url(.        s
+00021870: 656c 662c 0a20 2020 2020 2020 2075 726c  elf,.        url
+00021880: 3a20 7374 722c 0a20 2020 2020 2020 2065  : str,.        e
+00021890: 7863 6c75 6465 3a20 2243 6f6c 6c65 6374  xclude: "Collect
+000218a0: 696f 6e5b 7374 725d 222c 0a20 2020 2020  ion[str]",.     
+000218b0: 2020 2066 6f72 6d61 743a 204c 6974 6572     format: Liter
+000218c0: 616c 5b22 6d73 6770 6163 6b22 2c20 2279  al["msgpack", "y
+000218d0: 616d 6c22 5d2c 0a20 2020 2020 2020 202a  aml"],.        *
+000218e0: 2a73 746f 7261 6765 5f6f 7074 696f 6e73  *storage_options
+000218f0: 3a20 6469 6374 5b73 7472 2c20 416e 795d  : dict[str, Any]
+00021900: 2c0a 2020 2020 2920 2d3e 204e 6f6e 653a  ,.    ) -> None:
+00021910: 0a20 2020 2020 2020 2022 5772 6974 6520  .        "Write 
+00021920: 6120 636c 7573 7465 7220 7374 6174 6520  a cluster state 
+00021930: 6475 6d70 2074 6f20 616e 2066 7373 7065  dump to an fsspe
+00021940: 632d 636f 6d70 6174 6962 6c65 2055 524c  c-compatible URL
+00021950: 2e22 0a20 2020 2020 2020 2061 7761 6974  .".        await
+00021960: 2063 6c75 7374 6572 5f64 756d 702e 7772   cluster_dump.wr
+00021970: 6974 655f 7374 6174 6528 0a20 2020 2020  ite_state(.     
+00021980: 2020 2020 2020 2070 6172 7469 616c 2873         partial(s
+00021990: 656c 662e 6765 745f 636c 7573 7465 725f  elf.get_cluster_
+000219a0: 7374 6174 652c 2065 7863 6c75 6465 292c  state, exclude),
+000219b0: 2075 726c 2c20 666f 726d 6174 2c20 2a2a   url, format, **
+000219c0: 7374 6f72 6167 655f 6f70 7469 6f6e 730a  storage_options.
+000219d0: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
+000219e0: 6566 2067 6574 5f77 6f72 6b65 725f 7365  ef get_worker_se
+000219f0: 7276 6963 655f 6164 6472 280a 2020 2020  rvice_addr(.    
+00021a00: 2020 2020 7365 6c66 2c20 776f 726b 6572      self, worker
+00021a10: 3a20 7374 722c 2073 6572 7669 6365 5f6e  : str, service_n
+00021a20: 616d 653a 2073 7472 2c20 7072 6f74 6f63  ame: str, protoc
+00021a30: 6f6c 3a20 626f 6f6c 203d 2046 616c 7365  ol: bool = False
+00021a40: 0a20 2020 2029 202d 3e20 7475 706c 655b  .    ) -> tuple[
+00021a50: 7374 722c 2069 6e74 5d20 7c20 7374 7220  str, int] | str 
+00021a60: 7c20 4e6f 6e65 3a0a 2020 2020 2020 2020  | None:.        
+00021a70: 2222 220a 2020 2020 2020 2020 4765 7420  """.        Get 
+00021a80: 7468 6520 2868 6f73 742c 2070 6f72 7429  the (host, port)
+00021a90: 2061 6464 7265 7373 206f 6620 7468 6520   address of the 
+00021aa0: 6e61 6d65 6420 7365 7276 6963 6520 6f6e  named service on
+00021ab0: 2074 6865 202a 776f 726b 6572 2a2e 0a20   the *worker*.. 
+00021ac0: 2020 2020 2020 2052 6574 7572 6e73 204e         Returns N
+00021ad0: 6f6e 6520 6966 2074 6865 2073 6572 7669  one if the servi
+00021ae0: 6365 2064 6f65 736e 2774 2065 7869 7374  ce doesn't exist
+00021af0: 2e0a 0a20 2020 2020 2020 2050 6172 616d  ...        Param
+00021b00: 6574 6572 730a 2020 2020 2020 2020 2d2d  eters.        --
+00021b10: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
+00021b20: 2077 6f72 6b65 7220 3a20 6164 6472 6573   worker : addres
+00021b30: 730a 2020 2020 2020 2020 7365 7276 6963  s.        servic
+00021b40: 655f 6e61 6d65 203a 2073 7472 0a20 2020  e_name : str.   
+00021b50: 2020 2020 2020 2020 2043 6f6d 6d6f 6e20           Common 
+00021b60: 7365 7276 6963 6573 2069 6e63 6c75 6465  services include
+00021b70: 2027 626f 6b65 6827 2061 6e64 2027 6e61   'bokeh' and 'na
+00021b80: 6e6e 7927 0a20 2020 2020 2020 2070 726f  nny'.        pro
+00021b90: 746f 636f 6c20 3a20 626f 6f6c 6561 6e0a  tocol : boolean.
+00021ba0: 2020 2020 2020 2020 2020 2020 5768 6574              Whet
+00021bb0: 6865 7220 6f72 206e 6f74 2074 6f20 696e  her or not to in
+00021bc0: 636c 7564 6520 6120 6675 6c6c 2061 6464  clude a full add
+00021bd0: 7265 7373 2077 6974 6820 7072 6f74 6f63  ress with protoc
+00021be0: 6f6c 2028 5472 7565 290a 2020 2020 2020  ol (True).      
+00021bf0: 2020 2020 2020 6f72 206a 7573 7420 6120        or just a 
+00021c00: 2868 6f73 742c 2070 6f72 7429 2070 6169  (host, port) pai
+00021c10: 720a 2020 2020 2020 2020 2222 220a 2020  r.        """.  
+00021c20: 2020 2020 2020 7773 203d 2073 656c 662e        ws = self.
+00021c30: 776f 726b 6572 735b 776f 726b 6572 5d0a  workers[worker].
+00021c40: 2020 2020 2020 2020 706f 7274 203d 2077          port = w
+00021c50: 732e 7365 7276 6963 6573 2e67 6574 2873  s.services.get(s
+00021c60: 6572 7669 6365 5f6e 616d 6529 0a20 2020  ervice_name).   
+00021c70: 2020 2020 2069 6620 706f 7274 2069 7320       if port is 
+00021c80: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00021c90: 2020 7265 7475 726e 204e 6f6e 650a 2020    return None.  
+00021ca0: 2020 2020 2020 656c 6966 2070 726f 746f        elif proto
+00021cb0: 636f 6c3a 0a20 2020 2020 2020 2020 2020  col:.           
+00021cc0: 2072 6574 7572 6e20 2225 2870 726f 746f   return "%(proto
+00021cd0: 636f 6c29 733a 2f2f 2528 686f 7374 2973  col)s://%(host)s
+00021ce0: 3a25 2870 6f72 7429 6422 2025 207b 0a20  :%(port)d" % {. 
+00021cf0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00021d00: 7072 6f74 6f63 6f6c 223a 2077 732e 6164  protocol": ws.ad
+00021d10: 6472 6573 732e 7370 6c69 7428 223a 2f2f  dress.split("://
+00021d20: 2229 5b30 5d2c 0a20 2020 2020 2020 2020  ")[0],.         
+00021d30: 2020 2020 2020 2022 686f 7374 223a 2077         "host": w
+00021d40: 732e 686f 7374 2c0a 2020 2020 2020 2020  s.host,.        
+00021d50: 2020 2020 2020 2020 2270 6f72 7422 3a20          "port": 
+00021d60: 706f 7274 2c0a 2020 2020 2020 2020 2020  port,.          
+00021d70: 2020 7d0a 2020 2020 2020 2020 656c 7365    }.        else
+00021d80: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00021d90: 7475 726e 2077 732e 686f 7374 2c20 706f  turn ws.host, po
+00021da0: 7274 0a0a 2020 2020 6173 796e 6320 6465  rt..    async de
+00021db0: 6620 7374 6172 745f 756e 7361 6665 2873  f start_unsafe(s
+00021dc0: 656c 6629 3a0a 2020 2020 2020 2020 2222  elf):.        ""
+00021dd0: 2243 6c65 6172 206f 7574 206f 6c64 2073  "Clear out old s
+00021de0: 7461 7465 2061 6e64 2072 6573 7461 7274  tate and restart
+00021df0: 2061 6c6c 2072 756e 6e69 6e67 2063 6f72   all running cor
+00021e00: 6f75 7469 6e65 7322 2222 0a20 2020 2020  outines""".     
+00021e10: 2020 2061 7761 6974 2073 7570 6572 2829     await super()
+00021e20: 2e73 7461 7274 5f75 6e73 6166 6528 290a  .start_unsafe().
+00021e30: 0a20 2020 2020 2020 2065 6e61 626c 655f  .        enable_
+00021e40: 6763 5f64 6961 676e 6f73 6973 2829 0a0a  gc_diagnosis()..
+00021e50: 2020 2020 2020 2020 7365 6c66 2e5f 636c          self._cl
+00021e60: 6561 725f 7461 736b 5f73 7461 7465 2829  ear_task_state()
+00021e70: 0a0a 2020 2020 2020 2020 666f 7220 6164  ..        for ad
+00021e80: 6472 2069 6e20 7365 6c66 2e5f 7374 6172  dr in self._star
+00021e90: 745f 6164 6472 6573 733a 0a20 2020 2020  t_address:.     
+00021ea0: 2020 2020 2020 2061 7761 6974 2073 656c         await sel
+00021eb0: 662e 6c69 7374 656e 280a 2020 2020 2020  f.listen(.      
+00021ec0: 2020 2020 2020 2020 2020 6164 6472 2c0a            addr,.
+00021ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021ee0: 616c 6c6f 775f 6f66 666c 6f61 643d 4661  allow_offload=Fa
+00021ef0: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
+00021f00: 2020 2020 2068 616e 6473 6861 6b65 5f6f       handshake_o
+00021f10: 7665 7272 6964 6573 3d7b 2270 6963 6b6c  verrides={"pickl
+00021f20: 652d 7072 6f74 6f63 6f6c 223a 2034 2c20  e-protocol": 4, 
+00021f30: 2263 6f6d 7072 6573 7369 6f6e 223a 204e  "compression": N
+00021f40: 6f6e 657d 2c0a 2020 2020 2020 2020 2020  one},.          
+00021f50: 2020 2020 2020 2a2a 7365 6c66 2e73 6563        **self.sec
+00021f60: 7572 6974 792e 6765 745f 6c69 7374 656e  urity.get_listen
+00021f70: 5f61 7267 7328 2273 6368 6564 756c 6572  _args("scheduler
+00021f80: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+00021f90: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+00021fa0: 6c66 2e69 7020 3d20 6765 745f 6164 6472  lf.ip = get_addr
+00021fb0: 6573 735f 686f 7374 2873 656c 662e 6c69  ess_host(self.li
+00021fc0: 7374 656e 5f61 6464 7265 7373 290a 2020  sten_address).  
+00021fd0: 2020 2020 2020 2020 2020 6c69 7374 656e            listen
+00021fe0: 5f69 7020 3d20 7365 6c66 2e69 700a 0a20  _ip = self.ip.. 
+00021ff0: 2020 2020 2020 2020 2020 2069 6620 6c69             if li
+00022000: 7374 656e 5f69 7020 3d3d 2022 302e 302e  sten_ip == "0.0.
+00022010: 302e 3022 3a0a 2020 2020 2020 2020 2020  0.0":.          
+00022020: 2020 2020 2020 6c69 7374 656e 5f69 7020        listen_ip 
+00022030: 3d20 2222 0a0a 2020 2020 2020 2020 6966  = ""..        if
+00022040: 2073 656c 662e 6164 6472 6573 732e 7374   self.address.st
+00022050: 6172 7473 7769 7468 2822 696e 7072 6f63  artswith("inproc
+00022060: 3a2f 2f22 293a 0a20 2020 2020 2020 2020  ://"):.         
+00022070: 2020 206c 6973 7465 6e5f 6970 203d 2022     listen_ip = "
+00022080: 6c6f 6361 6c68 6f73 7422 0a0a 2020 2020  localhost"..    
+00022090: 2020 2020 2320 5365 7276 6963 6573 206c      # Services l
+000220a0: 6973 7465 6e20 6f6e 2061 6c6c 2061 6464  isten on all add
+000220b0: 7265 7373 6573 0a20 2020 2020 2020 2073  resses.        s
+000220c0: 656c 662e 7374 6172 745f 7365 7276 6963  elf.start_servic
+000220d0: 6573 286c 6973 7465 6e5f 6970 290a 0a20  es(listen_ip).. 
+000220e0: 2020 2020 2020 2066 6f72 206c 6973 7465         for liste
+000220f0: 6e65 7220 696e 2073 656c 662e 6c69 7374  ner in self.list
+00022100: 656e 6572 733a 0a20 2020 2020 2020 2020  eners:.         
+00022110: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
+00022120: 2020 5363 6865 6475 6c65 7220 6174 3a20    Scheduler at: 
+00022130: 2532 3573 222c 206c 6973 7465 6e65 722e  %25s", listener.
+00022140: 636f 6e74 6163 745f 6164 6472 6573 7329  contact_address)
+00022150: 0a20 2020 2020 2020 2066 6f72 206e 616d  .        for nam
+00022160: 652c 2073 6572 7665 7220 696e 2073 656c  e, server in sel
+00022170: 662e 7365 7276 6963 6573 2e69 7465 6d73  f.services.items
+00022180: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00022190: 6966 206e 616d 6520 3d3d 2022 6461 7368  if name == "dash
+000221a0: 626f 6172 6422 3a0a 2020 2020 2020 2020  board":.        
+000221b0: 2020 2020 2020 2020 6164 6472 203d 2067          addr = g
+000221c0: 6574 5f61 6464 7265 7373 5f68 6f73 7428  et_address_host(
+000221d0: 6c69 7374 656e 6572 2e63 6f6e 7461 6374  listener.contact
+000221e0: 5f61 6464 7265 7373 290a 2020 2020 2020  _address).      
+000221f0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00022200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022210: 2020 206c 696e 6b20 3d20 666f 726d 6174     link = format
+00022220: 5f64 6173 6862 6f61 7264 5f6c 696e 6b28  _dashboard_link(
+00022230: 6164 6472 2c20 7365 7276 6572 2e70 6f72  addr, server.por
+00022240: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
+00022250: 2020 2023 2066 6f72 6d61 7474 696e 6720     # formatting 
+00022260: 6461 7368 626f 6172 6420 6c69 6e6b 2063  dashboard link c
+00022270: 616e 2066 6169 6c20 6966 2064 6973 7472  an fail if distr
+00022280: 6962 7574 6564 2e64 6173 6862 6f61 7264  ibuted.dashboard
+00022290: 2e6c 696e 6b0a 2020 2020 2020 2020 2020  .link.          
+000222a0: 2020 2020 2020 2320 7265 6665 7273 2074        # refers t
+000222b0: 6f20 6e6f 6e2d 6578 6973 7461 6e74 2065  o non-existant e
+000222c0: 6e76 2076 6172 732e 0a20 2020 2020 2020  nv vars..       
+000222d0: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+000222e0: 4b65 7945 7272 6f72 2061 7320 653a 0a20  KeyError as e:. 
+000222f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022300: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
+00022310: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+00022320: 2020 2020 2020 2020 2020 2066 2246 6169             f"Fai
+00022330: 6c65 6420 746f 2066 6f72 6d61 7420 6461  led to format da
+00022340: 7368 626f 6172 6420 6c69 6e6b 2c20 756e  shboard link, un
+00022350: 6b6e 6f77 6e20 7661 6c75 653a 207b 657d  known value: {e}
+00022360: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00022370: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00022380: 2020 2020 2020 2020 2020 2020 6c69 6e6b              link
+00022390: 203d 2066 223a 7b73 6572 7665 722e 706f   = f":{server.po
+000223a0: 7274 7d22 0a20 2020 2020 2020 2020 2020  rt}".           
+000223b0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000223c0: 2020 2020 2020 206c 696e 6b20 3d20 6622         link = f"
+000223d0: 7b6c 6973 7465 6e5f 6970 7d3a 7b73 6572  {listen_ip}:{ser
+000223e0: 7665 722e 706f 7274 7d22 0a20 2020 2020  ver.port}".     
+000223f0: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
+00022400: 666f 2822 2531 3173 2061 743a 2020 2532  fo("%11s at:  %2
+00022410: 3573 222c 206e 616d 652c 206c 696e 6b29  5s", name, link)
+00022420: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00022430: 662e 7363 6865 6475 6c65 725f 6669 6c65  f.scheduler_file
+00022440: 3a0a 2020 2020 2020 2020 2020 2020 7769  :.            wi
+00022450: 7468 206f 7065 6e28 7365 6c66 2e73 6368  th open(self.sch
+00022460: 6564 756c 6572 5f66 696c 652c 2022 7722  eduler_file, "w"
+00022470: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
+00022480: 2020 2020 2020 2020 6a73 6f6e 2e64 756d          json.dum
+00022490: 7028 7365 6c66 2e69 6465 6e74 6974 7928  p(self.identity(
+000224a0: 292c 2066 2c20 696e 6465 6e74 3d32 290a  ), f, indent=2).
+000224b0: 0a20 2020 2020 2020 2020 2020 2066 6e20  .            fn 
+000224c0: 3d20 7365 6c66 2e73 6368 6564 756c 6572  = self.scheduler
+000224d0: 5f66 696c 6520 2023 2072 656d 6f76 6520  _file  # remove 
+000224e0: 6669 6c65 2077 6865 6e20 7765 2063 6c6f  file when we clo
+000224f0: 7365 2074 6865 2070 726f 6365 7373 0a0a  se the process..
+00022500: 2020 2020 2020 2020 2020 2020 6465 6620              def 
+00022510: 6465 6c5f 7363 6865 6475 6c65 725f 6669  del_scheduler_fi
+00022520: 6c65 2829 3a0a 2020 2020 2020 2020 2020  le():.          
+00022530: 2020 2020 2020 6966 206f 732e 7061 7468        if os.path
+00022540: 2e65 7869 7374 7328 666e 293a 0a20 2020  .exists(fn):.   
+00022550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022560: 206f 732e 7265 6d6f 7665 2866 6e29 0a0a   os.remove(fn)..
+00022570: 2020 2020 2020 2020 2020 2020 7765 616b              weak
+00022580: 7265 662e 6669 6e61 6c69 7a65 2873 656c  ref.finalize(sel
+00022590: 662c 2064 656c 5f73 6368 6564 756c 6572  f, del_scheduler
+000225a0: 5f66 696c 6529 0a0a 2020 2020 2020 2020  _file)..        
+000225b0: 666f 7220 7072 656c 6f61 6420 696e 2073  for preload in s
+000225c0: 656c 662e 7072 656c 6f61 6473 3a0a 2020  elf.preloads:.  
+000225d0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+000225e0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+000225f0: 7761 6974 2070 7265 6c6f 6164 2e73 7461  wait preload.sta
+00022600: 7274 2829 0a20 2020 2020 2020 2020 2020  rt().           
+00022610: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+00022620: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+00022630: 2020 206c 6f67 6765 722e 6578 6365 7074     logger.except
+00022640: 696f 6e28 2246 6169 6c65 6420 746f 2073  ion("Failed to s
+00022650: 7461 7274 2070 7265 6c6f 6164 2229 0a0a  tart preload")..
+00022660: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00022670: 6a75 7079 7465 723a 0a20 2020 2020 2020  jupyter:.       
+00022680: 2020 2020 2023 2041 6c6c 6f77 2069 6e73       # Allow ins
+00022690: 6563 7572 6520 636f 6d6d 756e 6963 6174  ecure communicat
+000226a0: 696f 6e73 2066 726f 6d20 6c6f 6361 6c20  ions from local 
+000226b0: 7573 6572 730a 2020 2020 2020 2020 2020  users.          
+000226c0: 2020 6966 2073 656c 662e 6164 6472 6573    if self.addres
+000226d0: 732e 7374 6172 7473 7769 7468 2822 746c  s.startswith("tl
+000226e0: 733a 2f2f 2229 3a0a 2020 2020 2020 2020  s://"):.        
+000226f0: 2020 2020 2020 2020 6177 6169 7420 7365          await se
+00022700: 6c66 2e6c 6973 7465 6e28 2274 6370 3a2f  lf.listen("tcp:/
+00022710: 2f6c 6f63 616c 686f 7374 3a30 2229 0a20  /localhost:0"). 
+00022720: 2020 2020 2020 2020 2020 206f 732e 656e             os.en
+00022730: 7669 726f 6e5b 2244 4153 4b5f 5343 4845  viron["DASK_SCHE
+00022740: 4455 4c45 525f 4144 4452 4553 5322 5d20  DULER_ADDRESS"] 
+00022750: 3d20 7365 6c66 2e6c 6973 7465 6e65 7273  = self.listeners
+00022760: 5b2d 315d 2e63 6f6e 7461 6374 5f61 6464  [-1].contact_add
+00022770: 7265 7373 0a0a 2020 2020 2020 2020 6177  ress..        aw
+00022780: 6169 7420 6173 796e 6369 6f2e 6761 7468  ait asyncio.gath
+00022790: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+000227a0: 2a5b 706c 7567 696e 2e73 7461 7274 2873  *[plugin.start(s
+000227b0: 656c 6629 2066 6f72 2070 6c75 6769 6e20  elf) for plugin 
+000227c0: 696e 206c 6973 7428 7365 6c66 2e70 6c75  in list(self.plu
+000227d0: 6769 6e73 2e76 616c 7565 7328 2929 5d0a  gins.values())].
+000227e0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+000227f0: 2020 2073 656c 662e 7374 6172 745f 7065     self.start_pe
+00022800: 7269 6f64 6963 5f63 616c 6c62 6163 6b73  riodic_callbacks
+00022810: 2829 0a0a 2020 2020 2020 2020 7365 7470  ()..        setp
+00022820: 726f 6374 6974 6c65 2866 2264 6173 6b20  roctitle(f"dask 
+00022830: 7363 6865 6475 6c65 7220 5b7b 7365 6c66  scheduler [{self
+00022840: 2e61 6464 7265 7373 7d5d 2229 0a20 2020  .address}]").   
+00022850: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00022860: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+00022870: 636c 6f73 6528 7365 6c66 2c20 6661 7374  close(self, fast
+00022880: 3d4e 6f6e 652c 2063 6c6f 7365 5f77 6f72  =None, close_wor
+00022890: 6b65 7273 3d4e 6f6e 6529 3a0a 2020 2020  kers=None):.    
+000228a0: 2020 2020 2222 2253 656e 6420 636c 6561      """Send clea
+000228b0: 6e75 7020 7369 676e 616c 2074 6f20 616c  nup signal to al
+000228c0: 6c20 636f 726f 7574 696e 6573 2074 6865  l coroutines the
+000228d0: 6e20 7761 6974 2075 6e74 696c 2066 696e  n wait until fin
+000228e0: 6973 6865 640a 0a20 2020 2020 2020 2053  ished..        S
+000228f0: 6565 2041 6c73 6f0a 2020 2020 2020 2020  ee Also.        
+00022900: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
+00022910: 2053 6368 6564 756c 6572 2e63 6c65 616e   Scheduler.clean
+00022920: 7570 0a20 2020 2020 2020 2022 2222 0a20  up.        """. 
+00022930: 2020 2020 2020 2069 6620 6661 7374 2069         if fast i
+00022940: 7320 6e6f 7420 4e6f 6e65 206f 7220 636c  s not None or cl
+00022950: 6f73 655f 776f 726b 6572 7320 6973 206e  ose_workers is n
+00022960: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00022970: 2020 2020 2077 6172 6e69 6e67 732e 7761       warnings.wa
+00022980: 726e 280a 2020 2020 2020 2020 2020 2020  rn(.            
+00022990: 2020 2020 2254 6865 2027 6661 7374 2720      "The 'fast' 
+000229a0: 616e 6420 2763 6c6f 7365 5f77 6f72 6b65  and 'close_worke
+000229b0: 7273 2720 7061 7261 6d65 7465 7273 2069  rs' parameters i
+000229c0: 6e20 5363 6865 6475 6c65 722e 636c 6f73  n Scheduler.clos
+000229d0: 6520 6861 7665 206e 6f20 6566 6665 6374  e have no effect
+000229e0: 2061 6e64 2077 696c 6c20 6265 2072 656d   and will be rem
+000229f0: 6f76 6564 2069 6e20 6120 6675 7475 7265  oved in a future
+00022a00: 2076 6572 7369 6f6e 206f 6620 6469 7374   version of dist
+00022a10: 7269 6275 7465 642e 222c 0a20 2020 2020  ributed.",.     
+00022a20: 2020 2020 2020 2020 2020 2046 7574 7572             Futur
+00022a30: 6557 6172 6e69 6e67 2c0a 2020 2020 2020  eWarning,.      
+00022a40: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00022a50: 6966 2073 656c 662e 7374 6174 7573 2069  if self.status i
+00022a60: 6e20 2853 7461 7475 732e 636c 6f73 696e  n (Status.closin
+00022a70: 672c 2053 7461 7475 732e 636c 6f73 6564  g, Status.closed
+00022a80: 293a 0a20 2020 2020 2020 2020 2020 2061  ):.            a
+00022a90: 7761 6974 2073 656c 662e 6669 6e69 7368  wait self.finish
+00022aa0: 6564 2829 0a20 2020 2020 2020 2020 2020  ed().           
+00022ab0: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
+00022ac0: 2061 7379 6e63 2064 6566 206c 6f67 5f65   async def log_e
+00022ad0: 7272 6f72 7328 6675 6e63 293a 0a20 2020  rrors(func):.   
+00022ae0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+00022af0: 2020 2020 2020 2020 2020 2020 2020 6177                aw
+00022b00: 6169 7420 6675 6e63 2829 0a20 2020 2020  ait func().     
+00022b10: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
+00022b20: 6365 7074 696f 6e3a 0a20 2020 2020 2020  ception:.       
+00022b30: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+00022b40: 6578 6365 7074 696f 6e28 2250 6c75 6769  exception("Plugi
+00022b50: 6e20 6361 6c6c 2066 6169 6c65 6420 6475  n call failed du
+00022b60: 7269 6e67 2073 6368 6564 756c 6572 2e63  ring scheduler.c
+00022b70: 6c6f 7365 2229 0a0a 2020 2020 2020 2020  lose")..        
+00022b80: 6177 6169 7420 6173 796e 6369 6f2e 6761  await asyncio.ga
+00022b90: 7468 6572 280a 2020 2020 2020 2020 2020  ther(.          
+00022ba0: 2020 2a5b 6c6f 675f 6572 726f 7273 2870    *[log_errors(p
+00022bb0: 6c75 6769 6e2e 6265 666f 7265 5f63 6c6f  lugin.before_clo
+00022bc0: 7365 2920 666f 7220 706c 7567 696e 2069  se) for plugin i
+00022bd0: 6e20 6c69 7374 2873 656c 662e 706c 7567  n list(self.plug
+00022be0: 696e 732e 7661 6c75 6573 2829 295d 0a20  ins.values())]. 
+00022bf0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00022c00: 2020 7365 6c66 2e73 7461 7475 7320 3d20    self.status = 
+00022c10: 5374 6174 7573 2e63 6c6f 7369 6e67 0a0a  Status.closing..
+00022c20: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+00022c30: 6e66 6f28 2253 6368 6564 756c 6572 2063  nfo("Scheduler c
+00022c40: 6c6f 7369 6e67 2e2e 2e22 290a 2020 2020  losing...").    
+00022c50: 2020 2020 7365 7470 726f 6374 6974 6c65      setproctitle
+00022c60: 2822 6461 736b 2073 6368 6564 756c 6572  ("dask scheduler
+00022c70: 205b 636c 6f73 696e 675d 2229 0a0a 2020   [closing]")..  
+00022c80: 2020 2020 2020 666f 7220 7072 656c 6f61        for preloa
+00022c90: 6420 696e 2073 656c 662e 7072 656c 6f61  d in self.preloa
+00022ca0: 6473 3a0a 2020 2020 2020 2020 2020 2020  ds:.            
+00022cb0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00022cc0: 2020 2020 2061 7761 6974 2070 7265 6c6f       await prelo
+00022cd0: 6164 2e74 6561 7264 6f77 6e28 290a 2020  ad.teardown().  
+00022ce0: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00022cf0: 2045 7863 6570 7469 6f6e 3a0a 2020 2020   Exception:.    
+00022d00: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00022d10: 6572 2e65 7863 6570 7469 6f6e 2822 4661  er.exception("Fa
+00022d20: 696c 6564 2074 6f20 7465 6172 2064 6f77  iled to tear dow
+00022d30: 6e20 7072 656c 6f61 6422 290a 0a20 2020  n preload")..   
+00022d40: 2020 2020 2061 7761 6974 2061 7379 6e63       await async
+00022d50: 696f 2e67 6174 6865 7228 0a20 2020 2020  io.gather(.     
+00022d60: 2020 2020 2020 202a 5b6c 6f67 5f65 7272         *[log_err
+00022d70: 6f72 7328 706c 7567 696e 2e63 6c6f 7365  ors(plugin.close
+00022d80: 2920 666f 7220 706c 7567 696e 2069 6e20  ) for plugin in 
+00022d90: 6c69 7374 2873 656c 662e 706c 7567 696e  list(self.plugin
+00022da0: 732e 7661 6c75 6573 2829 295d 0a20 2020  s.values())].   
+00022db0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00022dc0: 666f 7220 7063 2069 6e20 7365 6c66 2e70  for pc in self.p
+00022dd0: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
+00022de0: 732e 7661 6c75 6573 2829 3a0a 2020 2020  s.values():.    
+00022df0: 2020 2020 2020 2020 7063 2e73 746f 7028          pc.stop(
+00022e00: 290a 2020 2020 2020 2020 7365 6c66 2e70  ).        self.p
+00022e10: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
+00022e20: 732e 636c 6561 7228 290a 0a20 2020 2020  s.clear()..     
+00022e30: 2020 2073 656c 662e 7374 6f70 5f73 6572     self.stop_ser
+00022e40: 7669 6365 7328 290a 0a20 2020 2020 2020  vices()..       
+00022e50: 2066 6f72 2065 7874 2069 6e20 7365 6c66   for ext in self
+00022e60: 2e65 7874 656e 7369 6f6e 732e 7661 6c75  .extensions.valu
+00022e70: 6573 2829 3a0a 2020 2020 2020 2020 2020  es():.          
+00022e80: 2020 7769 7468 2073 7570 7072 6573 7328    with suppress(
+00022e90: 4174 7472 6962 7574 6545 7272 6f72 293a  AttributeError):
+00022ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022eb0: 2065 7874 2e74 6561 7264 6f77 6e28 290a   ext.teardown().
+00022ec0: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+00022ed0: 6e66 6f28 2253 6368 6564 756c 6572 2063  nfo("Scheduler c
+00022ee0: 6c6f 7369 6e67 2061 6c6c 2063 6f6d 6d73  losing all comms
+00022ef0: 2229 0a0a 2020 2020 2020 2020 6675 7475  ")..        futu
+00022f00: 7265 7320 3d20 5b5d 0a20 2020 2020 2020  res = [].       
+00022f10: 2066 6f72 205f 2c20 636f 6d6d 2069 6e20   for _, comm in 
+00022f20: 6c69 7374 2873 656c 662e 7374 7265 616d  list(self.stream
+00022f30: 5f63 6f6d 6d73 2e69 7465 6d73 2829 293a  _comms.items()):
+00022f40: 0a20 2020 2020 2020 2020 2020 2023 2046  .            # F
+00022f50: 4958 4d45 2075 7365 2060 7365 6c66 2e72  IXME use `self.r
+00022f60: 656d 6f76 655f 776f 726b 6572 2829 6020  emove_worker()` 
+00022f70: 696e 7374 6561 6420 6166 7465 7220 6874  instead after ht
+00022f80: 7470 733a 2f2f 6769 7468 7562 2e63 6f6d  tps://github.com
+00022f90: 2f64 6173 6b2f 6469 7374 7269 6275 7465  /dask/distribute
+00022fa0: 642f 6973 7375 6573 2f36 3339 300a 2020  d/issues/6390.  
+00022fb0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00022fc0: 2063 6f6d 6d2e 636c 6f73 6564 2829 3a0a   comm.closed():.
+00022fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022fe0: 2320 5468 6973 2063 6c6f 7365 7320 7468  # This closes th
+00022ff0: 6520 576f 726b 6572 2061 6e64 2065 6e73  e Worker and ens
+00023000: 7572 6573 2074 6861 7420 6966 2061 204e  ures that if a N
+00023010: 616e 6e79 2069 7320 6172 6f75 6e64 2c0a  anny is around,.
+00023020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023030: 2320 6974 2069 7320 636c 6f73 6564 2061  # it is closed a
+00023040: 7320 7765 6c6c 0a20 2020 2020 2020 2020  s well.         
+00023050: 2020 2020 2020 2063 6f6d 6d2e 7365 6e64         comm.send
+00023060: 287b 226f 7022 3a20 2263 6c6f 7365 222c  ({"op": "close",
+00023070: 2022 7265 6173 6f6e 223a 2022 7363 6865   "reason": "sche
+00023080: 6475 6c65 722d 636c 6f73 6522 7d29 0a20  duler-close"}). 
+00023090: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000230a0: 6f6d 6d2e 7365 6e64 287b 226f 7022 3a20  omm.send({"op": 
+000230b0: 2263 6c6f 7365 2d73 7472 6561 6d22 7d29  "close-stream"})
+000230c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000230d0: 2023 205e 2054 4f44 4f20 7265 6d6f 7665   # ^ TODO remove
+000230e0: 3f20 6057 6f72 6b65 722e 636c 6f73 6560  ? `Worker.close`
+000230f0: 2077 696c 6c20 636c 6f73 6520 7468 6520   will close the 
+00023100: 7374 7265 616d 2061 6e79 7761 792e 0a20  stream anyway.. 
+00023110: 2020 2020 2020 2020 2020 2077 6974 6820             with 
+00023120: 7375 7070 7265 7373 2841 7474 7269 6275  suppress(Attribu
+00023130: 7465 4572 726f 7229 3a0a 2020 2020 2020  teError):.      
+00023140: 2020 2020 2020 2020 2020 6675 7475 7265            future
+00023150: 732e 6170 7065 6e64 2863 6f6d 6d2e 636c  s.append(comm.cl
+00023160: 6f73 6528 2929 0a0a 2020 2020 2020 2020  ose())..        
+00023170: 6177 6169 7420 6173 796e 6369 6f2e 6761  await asyncio.ga
+00023180: 7468 6572 282a 6675 7475 7265 7329 0a0a  ther(*futures)..
+00023190: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000231a0: 6a75 7079 7465 723a 0a20 2020 2020 2020  jupyter:.       
+000231b0: 2020 2020 2061 7761 6974 2073 656c 662e       await self.
+000231c0: 5f6a 7570 7974 6572 5f73 6572 7665 725f  _jupyter_server_
+000231d0: 6170 706c 6963 6174 696f 6e2e 5f63 6c65  application._cle
+000231e0: 616e 7570 2829 0a0a 2020 2020 2020 2020  anup()..        
+000231f0: 666f 7220 636f 6d6d 2069 6e20 7365 6c66  for comm in self
+00023200: 2e63 6c69 656e 745f 636f 6d6d 732e 7661  .client_comms.va
+00023210: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
+00023220: 2020 2020 636f 6d6d 2e61 626f 7274 2829      comm.abort()
+00023230: 0a0a 2020 2020 2020 2020 6177 6169 7420  ..        await 
+00023240: 7365 6c66 2e72 7063 2e63 6c6f 7365 2829  self.rpc.close()
+00023250: 0a0a 2020 2020 2020 2020 7365 6c66 2e73  ..        self.s
+00023260: 7461 7475 7320 3d20 5374 6174 7573 2e63  tatus = Status.c
+00023270: 6c6f 7365 640a 2020 2020 2020 2020 7365  losed.        se
+00023280: 6c66 2e73 746f 7028 290a 2020 2020 2020  lf.stop().      
+00023290: 2020 6177 6169 7420 7375 7065 7228 292e    await super().
+000232a0: 636c 6f73 6528 290a 0a20 2020 2020 2020  close()..       
+000232b0: 2073 6574 7072 6f63 7469 746c 6528 2264   setproctitle("d
+000232c0: 6173 6b20 7363 6865 6475 6c65 7220 5b63  ask scheduler [c
+000232d0: 6c6f 7365 645d 2229 0a20 2020 2020 2020  losed]").       
+000232e0: 2064 6973 6162 6c65 5f67 635f 6469 6167   disable_gc_diag
+000232f0: 6e6f 7369 7328 290a 0a20 2020 2023 2323  nosis()..    ###
+00023300: 2323 2323 2323 2323 0a20 2020 2023 2053  ########.    # S
+00023310: 7469 6d75 6c69 2023 0a20 2020 2023 2323  timuli #.    ###
+00023320: 2323 2323 2323 2323 0a0a 2020 2020 6465  ########..    de
+00023330: 6620 6865 6172 7462 6561 745f 776f 726b  f heartbeat_work
+00023340: 6572 280a 2020 2020 2020 2020 7365 6c66  er(.        self
+00023350: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
+00023360: 2020 2020 2061 6464 7265 7373 3a20 7374       address: st
+00023370: 722c 0a20 2020 2020 2020 2072 6573 6f6c  r,.        resol
+00023380: 7665 5f61 6464 7265 7373 3a20 626f 6f6c  ve_address: bool
+00023390: 203d 2054 7275 652c 0a20 2020 2020 2020   = True,.       
+000233a0: 206e 6f77 3a20 666c 6f61 7420 7c20 4e6f   now: float | No
+000233b0: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
+000233c0: 2020 2072 6573 6f75 7263 6573 3a20 6469     resources: di
+000233d0: 6374 5b73 7472 2c20 666c 6f61 745d 207c  ct[str, float] |
+000233e0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+000233f0: 2020 2020 2020 686f 7374 5f69 6e66 6f3a        host_info:
+00023400: 2064 6963 7420 7c20 4e6f 6e65 203d 204e   dict | None = N
+00023410: 6f6e 652c 0a20 2020 2020 2020 206d 6574  one,.        met
+00023420: 7269 6373 3a20 6469 6374 2c0a 2020 2020  rics: dict,.    
+00023430: 2020 2020 6578 6563 7574 696e 673a 2064      executing: d
+00023440: 6963 745b 7374 722c 2066 6c6f 6174 5d20  ict[str, float] 
+00023450: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+00023460: 2020 2020 2020 2065 7874 656e 7369 6f6e         extension
+00023470: 733a 2064 6963 7420 7c20 4e6f 6e65 203d  s: dict | None =
+00023480: 204e 6f6e 652c 0a20 2020 2029 202d 3e20   None,.    ) -> 
+00023490: 6469 6374 5b73 7472 2c20 416e 795d 3a0a  dict[str, Any]:.
+000234a0: 2020 2020 2020 2020 6164 6472 6573 7320          address 
+000234b0: 3d20 7365 6c66 2e63 6f65 7263 655f 6164  = self.coerce_ad
+000234c0: 6472 6573 7328 6164 6472 6573 732c 2072  dress(address, r
+000234d0: 6573 6f6c 7665 5f61 6464 7265 7373 290a  esolve_address).
+000234e0: 2020 2020 2020 2020 6164 6472 6573 7320          address 
+000234f0: 3d20 6e6f 726d 616c 697a 655f 6164 6472  = normalize_addr
+00023500: 6573 7328 6164 6472 6573 7329 0a20 2020  ess(address).   
+00023510: 2020 2020 2077 7320 3d20 7365 6c66 2e77       ws = self.w
+00023520: 6f72 6b65 7273 2e67 6574 2861 6464 7265  orkers.get(addre
+00023530: 7373 290a 2020 2020 2020 2020 6966 2077  ss).        if w
+00023540: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+00023550: 2020 2020 2020 206c 6f67 6765 722e 7761         logger.wa
+00023560: 726e 696e 6728 6622 5265 6365 6976 6564  rning(f"Received
+00023570: 2068 6561 7274 6265 6174 2066 726f 6d20   heartbeat from 
+00023580: 756e 7265 6769 7374 6572 6564 2077 6f72  unregistered wor
+00023590: 6b65 7220 7b61 6464 7265 7373 2172 7d2e  ker {address!r}.
+000235a0: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
+000235b0: 6574 7572 6e20 7b22 7374 6174 7573 223a  eturn {"status":
+000235c0: 2022 6d69 7373 696e 6722 7d0a 0a20 2020   "missing"}..   
+000235d0: 2020 2020 2068 6f73 7420 3d20 6765 745f       host = get_
+000235e0: 6164 6472 6573 735f 686f 7374 2861 6464  address_host(add
+000235f0: 7265 7373 290a 2020 2020 2020 2020 6c6f  ress).        lo
+00023600: 6361 6c5f 6e6f 7720 3d20 7469 6d65 2829  cal_now = time()
+00023610: 0a20 2020 2020 2020 2068 6f73 745f 696e  .        host_in
+00023620: 666f 203d 2068 6f73 745f 696e 666f 206f  fo = host_info o
+00023630: 7220 7b7d 0a0a 2020 2020 2020 2020 6468  r {}..        dh
+00023640: 3a20 6469 6374 203d 2073 656c 662e 686f  : dict = self.ho
+00023650: 7374 5f69 6e66 6f2e 7365 7464 6566 6175  st_info.setdefau
+00023660: 6c74 2868 6f73 742c 207b 7d29 0a20 2020  lt(host, {}).   
+00023670: 2020 2020 2064 685b 226c 6173 742d 7365       dh["last-se
+00023680: 656e 225d 203d 206c 6f63 616c 5f6e 6f77  en"] = local_now
+00023690: 0a0a 2020 2020 2020 2020 6672 6163 203d  ..        frac =
+000236a0: 2031 202f 206c 656e 2873 656c 662e 776f   1 / len(self.wo
+000236b0: 726b 6572 7329 0a20 2020 2020 2020 2073  rkers).        s
+000236c0: 656c 662e 6261 6e64 7769 6474 6820 3d20  elf.bandwidth = 
+000236d0: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
+000236e0: 6c66 2e62 616e 6477 6964 7468 202a 2028  lf.bandwidth * (
+000236f0: 3120 2d20 6672 6163 2920 2b20 6d65 7472  1 - frac) + metr
+00023700: 6963 735b 2262 616e 6477 6964 7468 225d  ics["bandwidth"]
+00023710: 5b22 746f 7461 6c22 5d20 2a20 6672 6163  ["total"] * frac
+00023720: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00023730: 2020 2066 6f72 206f 7468 6572 2c20 2862     for other, (b
+00023740: 772c 2063 6f75 6e74 2920 696e 206d 6574  w, count) in met
+00023750: 7269 6373 5b22 6261 6e64 7769 6474 6822  rics["bandwidth"
+00023760: 5d5b 2277 6f72 6b65 7273 225d 2e69 7465  ]["workers"].ite
+00023770: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+00023780: 2020 6966 2028 6164 6472 6573 732c 206f    if (address, o
+00023790: 7468 6572 2920 6e6f 7420 696e 2073 656c  ther) not in sel
+000237a0: 662e 6261 6e64 7769 6474 685f 776f 726b  f.bandwidth_work
+000237b0: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+000237c0: 2020 2020 2073 656c 662e 6261 6e64 7769       self.bandwi
+000237d0: 6474 685f 776f 726b 6572 735b 6164 6472  dth_workers[addr
+000237e0: 6573 732c 206f 7468 6572 5d20 3d20 6277  ess, other] = bw
+000237f0: 202f 2063 6f75 6e74 0a20 2020 2020 2020   / count.       
+00023800: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00023810: 2020 2020 2020 2020 2020 2061 6c70 6861             alpha
+00023820: 203d 2028 3120 2d20 6672 6163 2920 2a2a   = (1 - frac) **
+00023830: 2063 6f75 6e74 0a20 2020 2020 2020 2020   count.         
+00023840: 2020 2020 2020 2073 656c 662e 6261 6e64         self.band
+00023850: 7769 6474 685f 776f 726b 6572 735b 6164  width_workers[ad
+00023860: 6472 6573 732c 206f 7468 6572 5d20 3d20  dress, other] = 
+00023870: 7365 6c66 2e62 616e 6477 6964 7468 5f77  self.bandwidth_w
+00023880: 6f72 6b65 7273 5b0a 2020 2020 2020 2020  orkers[.        
+00023890: 2020 2020 2020 2020 2020 2020 6164 6472              addr
+000238a0: 6573 732c 206f 7468 6572 0a20 2020 2020  ess, other.     
+000238b0: 2020 2020 2020 2020 2020 205d 202a 2061             ] * a
+000238c0: 6c70 6861 202b 2062 7720 2a20 2831 202d  lpha + bw * (1 -
+000238d0: 2061 6c70 6861 290a 2020 2020 2020 2020   alpha).        
+000238e0: 666f 7220 7479 702c 2028 6277 2c20 636f  for typ, (bw, co
+000238f0: 756e 7429 2069 6e20 6d65 7472 6963 735b  unt) in metrics[
+00023900: 2262 616e 6477 6964 7468 225d 5b22 7479  "bandwidth"]["ty
+00023910: 7065 7322 5d2e 6974 656d 7328 293a 0a20  pes"].items():. 
+00023920: 2020 2020 2020 2020 2020 2069 6620 7479             if ty
+00023930: 7020 6e6f 7420 696e 2073 656c 662e 6261  p not in self.ba
+00023940: 6e64 7769 6474 685f 7479 7065 733a 0a20  ndwidth_types:. 
+00023950: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00023960: 656c 662e 6261 6e64 7769 6474 685f 7479  elf.bandwidth_ty
+00023970: 7065 735b 7479 705d 203d 2062 7720 2f20  pes[typ] = bw / 
+00023980: 636f 756e 740a 2020 2020 2020 2020 2020  count.          
+00023990: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000239a0: 2020 2020 2020 2020 616c 7068 6120 3d20          alpha = 
+000239b0: 2831 202d 2066 7261 6329 202a 2a20 636f  (1 - frac) ** co
+000239c0: 756e 740a 2020 2020 2020 2020 2020 2020  unt.            
+000239d0: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
+000239e0: 7468 5f74 7970 6573 5b74 7970 5d20 3d20  th_types[typ] = 
+000239f0: 7365 6c66 2e62 616e 6477 6964 7468 5f74  self.bandwidth_t
+00023a00: 7970 6573 5b74 7970 5d20 2a20 616c 7068  ypes[typ] * alph
+00023a10: 6120 2b20 6277 202a 2028 0a20 2020 2020  a + bw * (.     
+00023a20: 2020 2020 2020 2020 2020 2020 2020 2031                 1
+00023a30: 202d 2061 6c70 6861 0a20 2020 2020 2020   - alpha.       
+00023a40: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00023a50: 2020 2020 7773 2e6c 6173 745f 7365 656e      ws.last_seen
+00023a60: 203d 206c 6f63 616c 5f6e 6f77 0a20 2020   = local_now.   
+00023a70: 2020 2020 2069 6620 6578 6563 7574 696e       if executin
+00023a80: 6720 6973 206e 6f74 204e 6f6e 653a 0a20  g is not None:. 
+00023a90: 2020 2020 2020 2020 2020 2023 204e 4f54             # NOT
+00023aa0: 453a 2074 6865 2065 7865 6375 7469 6e67  E: the executing
+00023ab0: 2064 6963 7420 6973 2075 6e75 7365 640a   dict is unused.
+00023ac0: 2020 2020 2020 2020 2020 2020 7773 2e65              ws.e
+00023ad0: 7865 6375 7469 6e67 203d 207b 7d0a 2020  xecuting = {}.  
+00023ae0: 2020 2020 2020 2020 2020 666f 7220 6b65            for ke
+00023af0: 792c 2064 7572 6174 696f 6e20 696e 2065  y, duration in e
+00023b00: 7865 6375 7469 6e67 2e69 7465 6d73 2829  xecuting.items()
+00023b10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00023b20: 2020 6966 206b 6579 2069 6e20 7365 6c66    if key in self
+00023b30: 2e74 6173 6b73 3a0a 2020 2020 2020 2020  .tasks:.        
+00023b40: 2020 2020 2020 2020 2020 2020 7473 203d              ts =
+00023b50: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
+00023b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023b70: 2020 2020 2077 732e 6578 6563 7574 696e       ws.executin
+00023b80: 675b 7473 5d20 3d20 6475 7261 7469 6f6e  g[ts] = duration
+00023b90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023ba0: 2020 2020 2074 732e 7072 6566 6978 2e61       ts.prefix.a
+00023bb0: 6464 5f65 7865 635f 7469 6d65 2864 7572  dd_exec_time(dur
+00023bc0: 6174 696f 6e29 0a0a 2020 2020 2020 2020  ation)..        
+00023bd0: 666f 7220 6e61 6d65 2c20 7661 6c75 6520  for name, value 
+00023be0: 696e 206d 6574 7269 6373 5b22 6469 6765  in metrics["dige
+00023bf0: 7374 735f 746f 7461 6c5f 7369 6e63 655f  sts_total_since_
+00023c00: 6865 6172 7462 6561 7422 5d2e 6974 656d  heartbeat"].item
+00023c10: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00023c20: 2073 656c 662e 6375 6d75 6c61 7469 7665   self.cumulative
+00023c30: 5f77 6f72 6b65 725f 6d65 7472 6963 735b  _worker_metrics[
+00023c40: 6e61 6d65 5d20 2b3d 2076 616c 7565 0a0a  name] += value..
+00023c50: 2020 2020 2020 2020 7773 2e6d 6574 7269          ws.metri
+00023c60: 6373 203d 206d 6574 7269 6373 0a0a 2020  cs = metrics..  
+00023c70: 2020 2020 2020 2320 4361 6c63 756c 6174        # Calculat
+00023c80: 6520 5253 5320 2d20 6461 736b 206b 6579  e RSS - dask key
+00023c90: 732c 2073 6570 6172 6174 696e 6720 226f  s, separating "o
+00023ca0: 6c64 2220 616e 6420 226e 6577 2220 7573  ld" and "new" us
+00023cb0: 6167 650a 2020 2020 2020 2020 2320 5365  age.        # Se
+00023cc0: 6520 4d65 6d6f 7279 5374 6174 6520 666f  e MemoryState fo
+00023cd0: 7220 6465 7461 696c 730a 2020 2020 2020  r details.      
+00023ce0: 2020 6d61 785f 6d65 6d6f 7279 5f75 6e6d    max_memory_unm
+00023cf0: 616e 6167 6564 5f6f 6c64 5f68 6973 745f  anaged_old_hist_
+00023d00: 6167 6520 3d20 6c6f 6361 6c5f 6e6f 7720  age = local_now 
+00023d10: 2d20 7365 6c66 2e4d 454d 4f52 595f 5245  - self.MEMORY_RE
+00023d20: 4345 4e54 5f54 4f5f 4f4c 445f 5449 4d45  CENT_TO_OLD_TIME
+00023d30: 0a20 2020 2020 2020 206d 656d 6f72 795f  .        memory_
+00023d40: 756e 6d61 6e61 6765 645f 6f6c 6420 3d20  unmanaged_old = 
+00023d50: 7773 2e5f 6d65 6d6f 7279 5f75 6e6d 616e  ws._memory_unman
+00023d60: 6167 6564 5f6f 6c64 0a20 2020 2020 2020  aged_old.       
+00023d70: 2077 6869 6c65 2077 732e 5f6d 656d 6f72   while ws._memor
+00023d80: 795f 756e 6d61 6e61 6765 645f 6869 7374  y_unmanaged_hist
+00023d90: 6f72 793a 0a20 2020 2020 2020 2020 2020  ory:.           
+00023da0: 2074 696d 6573 7461 6d70 2c20 7369 7a65   timestamp, size
+00023db0: 203d 2077 732e 5f6d 656d 6f72 795f 756e   = ws._memory_un
+00023dc0: 6d61 6e61 6765 645f 6869 7374 6f72 795b  managed_history[
+00023dd0: 305d 0a20 2020 2020 2020 2020 2020 2069  0].            i
+00023de0: 6620 7469 6d65 7374 616d 7020 3e3d 206d  f timestamp >= m
+00023df0: 6178 5f6d 656d 6f72 795f 756e 6d61 6e61  ax_memory_unmana
+00023e00: 6765 645f 6f6c 645f 6869 7374 5f61 6765  ged_old_hist_age
+00023e10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00023e20: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
+00023e30: 2020 2020 7773 2e5f 6d65 6d6f 7279 5f75      ws._memory_u
+00023e40: 6e6d 616e 6167 6564 5f68 6973 746f 7279  nmanaged_history
+00023e50: 2e70 6f70 6c65 6674 2829 0a20 2020 2020  .popleft().     
+00023e60: 2020 2020 2020 2069 6620 7369 7a65 203d         if size =
+00023e70: 3d20 6d65 6d6f 7279 5f75 6e6d 616e 6167  = memory_unmanag
+00023e80: 6564 5f6f 6c64 3a0a 2020 2020 2020 2020  ed_old:.        
+00023e90: 2020 2020 2020 2020 6d65 6d6f 7279 5f75          memory_u
+00023ea0: 6e6d 616e 6167 6564 5f6f 6c64 203d 2030  nmanaged_old = 0
+00023eb0: 2020 2320 7265 6361 6c63 756c 6174 6520    # recalculate 
+00023ec0: 6d69 6e28 290a 0a20 2020 2020 2020 2023  min()..        #
+00023ed0: 2077 732e 5f6e 6279 7465 7320 6973 2075   ws._nbytes is u
+00023ee0: 7064 6174 6564 2061 7420 6120 6469 6666  pdated at a diff
+00023ef0: 6572 656e 7420 7469 6d65 2061 6e64 2073  erent time and s
+00023f00: 697a 656f 6628 2920 6d61 7920 6e6f 7420  izeof() may not 
+00023f10: 6265 2061 6363 7572 6174 652c 0a20 2020  be accurate,.   
+00023f20: 2020 2020 2023 2073 6f20 7369 7a65 206d       # so size m
+00023f30: 6179 2062 6520 2874 656d 706f 7261 7269  ay be (temporari
+00023f40: 6c79 2920 6e65 6761 7469 7665 3b20 666c  ly) negative; fl
+00023f50: 6f6f 7220 6974 2074 6f20 7a65 726f 2e0a  oor it to zero..
+00023f60: 2020 2020 2020 2020 7369 7a65 203d 206d          size = m
+00023f70: 6178 280a 2020 2020 2020 2020 2020 2020  ax(.            
+00023f80: 302c 206d 6574 7269 6373 5b22 6d65 6d6f  0, metrics["memo
+00023f90: 7279 225d 202d 2077 732e 6e62 7974 6573  ry"] - ws.nbytes
+00023fa0: 202b 206d 6574 7269 6373 5b22 7370 696c   + metrics["spil
+00023fb0: 6c65 645f 6279 7465 7322 5d5b 226d 656d  led_bytes"]["mem
+00023fc0: 6f72 7922 5d0a 2020 2020 2020 2020 290a  ory"].        ).
+00023fd0: 0a20 2020 2020 2020 2077 732e 5f6d 656d  .        ws._mem
+00023fe0: 6f72 795f 756e 6d61 6e61 6765 645f 6869  ory_unmanaged_hi
+00023ff0: 7374 6f72 792e 6170 7065 6e64 2828 6c6f  story.append((lo
+00024000: 6361 6c5f 6e6f 772c 2073 697a 6529 290a  cal_now, size)).
+00024010: 2020 2020 2020 2020 6966 206e 6f74 206d          if not m
+00024020: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
+00024030: 6f6c 643a 0a20 2020 2020 2020 2020 2020  old:.           
+00024040: 2023 2054 6865 2077 6f72 6b65 7220 6861   # The worker ha
+00024050: 7320 6a75 7374 2062 6565 6e20 7374 6172  s just been star
+00024060: 7465 6420 6f72 2074 6865 2070 7265 7669  ted or the previ
+00024070: 6f75 7320 6d69 6e69 6d75 6d20 6861 7320  ous minimum has 
+00024080: 6265 656e 2065 7870 756e 6765 640a 2020  been expunged.  
+00024090: 2020 2020 2020 2020 2020 2320 6265 6361            # beca
+000240a0: 7573 6520 746f 6f20 6f6c 642e 0a20 2020  use too old..   
+000240b0: 2020 2020 2020 2020 2023 204e 6f74 653a           # Note:
+000240c0: 2074 6869 7320 616c 676f 7269 7468 6d20   this algorithm 
+000240d0: 6973 2063 6170 7065 6420 746f 2032 3030  is capped to 200
+000240e0: 202a 204d 454d 4f52 595f 5245 4345 4e54   * MEMORY_RECENT
+000240f0: 5f54 4f5f 4f4c 445f 5449 4d45 2065 6c65  _TO_OLD_TIME ele
+00024100: 6d65 6e74 730a 2020 2020 2020 2020 2020  ments.          
+00024110: 2020 2320 636c 7573 7465 722d 7769 6465    # cluster-wide
+00024120: 2062 7920 6865 6172 7462 6561 745f 696e   by heartbeat_in
+00024130: 7465 7276 616c 2829 2c20 7265 6761 7264  terval(), regard
+00024140: 6c65 7373 206f 6620 7468 6520 6e75 6d62  less of the numb
+00024150: 6572 206f 6620 776f 726b 6572 730a 2020  er of workers.  
+00024160: 2020 2020 2020 2020 2020 7773 2e5f 6d65            ws._me
+00024170: 6d6f 7279 5f75 6e6d 616e 6167 6564 5f6f  mory_unmanaged_o
+00024180: 6c64 203d 206d 696e 286d 6170 2873 6563  ld = min(map(sec
+00024190: 6f6e 642c 2077 732e 5f6d 656d 6f72 795f  ond, ws._memory_
+000241a0: 756e 6d61 6e61 6765 645f 6869 7374 6f72  unmanaged_histor
+000241b0: 7929 290a 2020 2020 2020 2020 656c 6966  y)).        elif
+000241c0: 2073 697a 6520 3c20 6d65 6d6f 7279 5f75   size < memory_u
+000241d0: 6e6d 616e 6167 6564 5f6f 6c64 3a0a 2020  nmanaged_old:.  
+000241e0: 2020 2020 2020 2020 2020 7773 2e5f 6d65            ws._me
+000241f0: 6d6f 7279 5f75 6e6d 616e 6167 6564 5f6f  mory_unmanaged_o
+00024200: 6c64 203d 2073 697a 650a 0a20 2020 2020  ld = size..     
+00024210: 2020 2069 6620 686f 7374 5f69 6e66 6f3a     if host_info:
+00024220: 0a20 2020 2020 2020 2020 2020 2064 6820  .            dh 
+00024230: 3d20 7365 6c66 2e68 6f73 745f 696e 666f  = self.host_info
+00024240: 2e73 6574 6465 6661 756c 7428 686f 7374  .setdefault(host
+00024250: 2c20 7b7d 290a 2020 2020 2020 2020 2020  , {}).          
+00024260: 2020 6468 2e75 7064 6174 6528 686f 7374    dh.update(host
+00024270: 5f69 6e66 6f29 0a0a 2020 2020 2020 2020  _info)..        
+00024280: 6966 206e 6f77 3a0a 2020 2020 2020 2020  if now:.        
+00024290: 2020 2020 7773 2e74 696d 655f 6465 6c61      ws.time_dela
+000242a0: 7920 3d20 6c6f 6361 6c5f 6e6f 7720 2d20  y = local_now - 
+000242b0: 6e6f 770a 0a20 2020 2020 2020 2069 6620  now..        if 
+000242c0: 7265 736f 7572 6365 733a 0a20 2020 2020  resources:.     
+000242d0: 2020 2020 2020 2073 656c 662e 6164 645f         self.add_
+000242e0: 7265 736f 7572 6365 7328 776f 726b 6572  resources(worker
+000242f0: 3d61 6464 7265 7373 2c20 7265 736f 7572  =address, resour
+00024300: 6365 733d 7265 736f 7572 6365 7329 0a0a  ces=resources)..
+00024310: 2020 2020 2020 2020 6966 2065 7874 656e          if exten
+00024320: 7369 6f6e 733a 0a20 2020 2020 2020 2020  sions:.         
+00024330: 2020 2066 6f72 206e 616d 652c 2064 6174     for name, dat
+00024340: 6120 696e 2065 7874 656e 7369 6f6e 732e  a in extensions.
+00024350: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+00024360: 2020 2020 2020 2020 2073 656c 662e 6578           self.ex
+00024370: 7465 6e73 696f 6e73 5b6e 616d 655d 2e68  tensions[name].h
+00024380: 6561 7274 6265 6174 2877 732c 2064 6174  eartbeat(ws, dat
+00024390: 6129 0a0a 2020 2020 2020 2020 7265 7475  a)..        retu
+000243a0: 726e 207b 0a20 2020 2020 2020 2020 2020  rn {.           
+000243b0: 2022 7374 6174 7573 223a 2022 4f4b 222c   "status": "OK",
+000243c0: 0a20 2020 2020 2020 2020 2020 2022 7469  .            "ti
+000243d0: 6d65 223a 206c 6f63 616c 5f6e 6f77 2c0a  me": local_now,.
+000243e0: 2020 2020 2020 2020 2020 2020 2268 6561              "hea
+000243f0: 7274 6265 6174 2d69 6e74 6572 7661 6c22  rtbeat-interval"
+00024400: 3a20 6865 6172 7462 6561 745f 696e 7465  : heartbeat_inte
+00024410: 7276 616c 286c 656e 2873 656c 662e 776f  rval(len(self.wo
+00024420: 726b 6572 7329 292c 0a20 2020 2020 2020  rkers)),.       
+00024430: 207d 0a0a 2020 2020 406c 6f67 5f65 7272   }..    @log_err
+00024440: 6f72 730a 2020 2020 6173 796e 6320 6465  ors.    async de
+00024450: 6620 6164 645f 776f 726b 6572 280a 2020  f add_worker(.  
+00024460: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00024470: 2020 2020 636f 6d6d 3a20 436f 6d6d 2c0a      comm: Comm,.
+00024480: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
+00024490: 2020 2061 6464 7265 7373 3a20 7374 722c     address: str,
+000244a0: 0a20 2020 2020 2020 2073 7461 7475 733a  .        status:
+000244b0: 2073 7472 2c0a 2020 2020 2020 2020 7365   str,.        se
+000244c0: 7276 6572 5f69 643a 2073 7472 2c0a 2020  rver_id: str,.  
+000244d0: 2020 2020 2020 6e74 6872 6561 6473 3a20        nthreads: 
+000244e0: 696e 742c 0a20 2020 2020 2020 206e 616d  int,.        nam
+000244f0: 653a 2073 7472 2c0a 2020 2020 2020 2020  e: str,.        
+00024500: 7265 736f 6c76 655f 6164 6472 6573 733a  resolve_address:
+00024510: 2062 6f6f 6c20 3d20 5472 7565 2c0a 2020   bool = True,.  
+00024520: 2020 2020 2020 6e6f 773a 2066 6c6f 6174        now: float
+00024530: 2c0a 2020 2020 2020 2020 7265 736f 7572  ,.        resour
+00024540: 6365 733a 2064 6963 745b 7374 722c 2066  ces: dict[str, f
+00024550: 6c6f 6174 5d2c 0a20 2020 2020 2020 2023  loat],.        #
+00024560: 2046 4958 4d45 3a20 5468 6973 2069 7320   FIXME: This is 
+00024570: 6e65 7665 7220 7375 626d 6974 7465 6420  never submitted 
+00024580: 6279 2074 6865 2077 6f72 6b65 720a 2020  by the worker.  
+00024590: 2020 2020 2020 686f 7374 5f69 6e66 6f3a        host_info:
+000245a0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+000245b0: 2020 2020 2020 6d65 6d6f 7279 5f6c 696d        memory_lim
+000245c0: 6974 3a20 696e 7420 7c20 4e6f 6e65 2c0a  it: int | None,.
+000245d0: 2020 2020 2020 2020 6d65 7472 6963 733a          metrics:
+000245e0: 2064 6963 745b 7374 722c 2041 6e79 5d2c   dict[str, Any],
+000245f0: 0a20 2020 2020 2020 2070 6964 3a20 696e  .        pid: in
+00024600: 7420 3d20 302c 0a20 2020 2020 2020 2073  t = 0,.        s
+00024610: 6572 7669 6365 733a 2064 6963 745b 7374  ervices: dict[st
+00024620: 722c 2069 6e74 5d2c 0a20 2020 2020 2020  r, int],.       
+00024630: 206c 6f63 616c 5f64 6972 6563 746f 7279   local_directory
+00024640: 3a20 7374 722c 0a20 2020 2020 2020 2076  : str,.        v
+00024650: 6572 7369 6f6e 733a 2064 6963 745b 7374  ersions: dict[st
+00024660: 722c 2041 6e79 5d2c 0a20 2020 2020 2020  r, Any],.       
+00024670: 206e 616e 6e79 3a20 7374 722c 0a20 2020   nanny: str,.   
+00024680: 2020 2020 2065 7874 7261 3a20 6469 6374       extra: dict
+00024690: 2c0a 2020 2020 2020 2020 7374 696d 756c  ,.        stimul
+000246a0: 7573 5f69 643a 2073 7472 2c0a 2020 2020  us_id: str,.    
+000246b0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+000246c0: 2020 2022 2222 4164 6420 6120 6e65 7720     """Add a new 
+000246d0: 776f 726b 6572 2074 6f20 7468 6520 636c  worker to the cl
+000246e0: 7573 7465 7222 2222 0a20 2020 2020 2020  uster""".       
+000246f0: 2061 6464 7265 7373 203d 2073 656c 662e   address = self.
+00024700: 636f 6572 6365 5f61 6464 7265 7373 2861  coerce_address(a
+00024710: 6464 7265 7373 2c20 7265 736f 6c76 655f  ddress, resolve_
+00024720: 6164 6472 6573 7329 0a20 2020 2020 2020  address).       
+00024730: 2061 6464 7265 7373 203d 206e 6f72 6d61   address = norma
+00024740: 6c69 7a65 5f61 6464 7265 7373 2861 6464  lize_address(add
+00024750: 7265 7373 290a 2020 2020 2020 2020 686f  ress).        ho
+00024760: 7374 203d 2067 6574 5f61 6464 7265 7373  st = get_address
+00024770: 5f68 6f73 7428 6164 6472 6573 7329 0a0a  _host(address)..
+00024780: 2020 2020 2020 2020 6966 2061 6464 7265          if addre
+00024790: 7373 2069 6e20 7365 6c66 2e77 6f72 6b65  ss in self.worke
+000247a0: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
+000247b0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+000247c0: 2822 576f 726b 6572 2061 6c72 6561 6479  ("Worker already
+000247d0: 2065 7869 7374 7320 2573 2220 2520 6164   exists %s" % ad
+000247e0: 6472 6573 7329 0a0a 2020 2020 2020 2020  dress)..        
+000247f0: 6966 206e 616d 6520 696e 2073 656c 662e  if name in self.
+00024800: 616c 6961 7365 733a 0a20 2020 2020 2020  aliases:.       
+00024810: 2020 2020 206c 6f67 6765 722e 7761 726e       logger.warn
+00024820: 696e 6728 2257 6f72 6b65 7220 7472 6965  ing("Worker trie
+00024830: 6420 746f 2063 6f6e 6e65 6374 2077 6974  d to connect wit
+00024840: 6820 6120 6475 706c 6963 6174 6520 6e61  h a duplicate na
+00024850: 6d65 3a20 2573 222c 206e 616d 6529 0a20  me: %s", name). 
+00024860: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
+00024870: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00024880: 2020 2022 7374 6174 7573 223a 2022 6572     "status": "er
+00024890: 726f 7222 2c0a 2020 2020 2020 2020 2020  ror",.          
+000248a0: 2020 2020 2020 226d 6573 7361 6765 223a        "message":
+000248b0: 2022 6e61 6d65 2074 616b 656e 2c20 2573   "name taken, %s
+000248c0: 2220 2520 6e61 6d65 2c0a 2020 2020 2020  " % name,.      
+000248d0: 2020 2020 2020 2020 2020 2274 696d 6522            "time"
+000248e0: 3a20 7469 6d65 2829 2c0a 2020 2020 2020  : time(),.      
+000248f0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00024900: 2020 2020 6177 6169 7420 636f 6d6d 2e77      await comm.w
+00024910: 7269 7465 286d 7367 290a 2020 2020 2020  rite(msg).      
+00024920: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+00024930: 2020 2020 2020 7365 6c66 2e6c 6f67 5f65        self.log_e
+00024940: 7665 6e74 2861 6464 7265 7373 2c20 7b22  vent(address, {"
+00024950: 6163 7469 6f6e 223a 2022 6164 642d 776f  action": "add-wo
+00024960: 726b 6572 227d 290a 2020 2020 2020 2020  rker"}).        
+00024970: 7365 6c66 2e6c 6f67 5f65 7665 6e74 2822  self.log_event("
+00024980: 616c 6c22 2c20 7b22 6163 7469 6f6e 223a  all", {"action":
+00024990: 2022 6164 642d 776f 726b 6572 222c 2022   "add-worker", "
+000249a0: 776f 726b 6572 223a 2061 6464 7265 7373  worker": address
+000249b0: 7d29 0a0a 2020 2020 2020 2020 7365 6c66  })..        self
+000249c0: 2e77 6f72 6b65 7273 5b61 6464 7265 7373  .workers[address
+000249d0: 5d20 3d20 7773 203d 2057 6f72 6b65 7253  ] = ws = WorkerS
+000249e0: 7461 7465 280a 2020 2020 2020 2020 2020  tate(.          
+000249f0: 2020 6164 6472 6573 733d 6164 6472 6573    address=addres
+00024a00: 732c 0a20 2020 2020 2020 2020 2020 2073  s,.            s
+00024a10: 7461 7475 733d 5374 6174 7573 2e6c 6f6f  tatus=Status.loo
+00024a20: 6b75 705b 7374 6174 7573 5d2c 2020 2320  kup[status],  # 
+00024a30: 7479 7065 3a20 6967 6e6f 7265 0a20 2020  type: ignore.   
+00024a40: 2020 2020 2020 2020 2070 6964 3d70 6964           pid=pid
+00024a50: 2c0a 2020 2020 2020 2020 2020 2020 6e74  ,.            nt
+00024a60: 6872 6561 6473 3d6e 7468 7265 6164 732c  hreads=nthreads,
+00024a70: 0a20 2020 2020 2020 2020 2020 206d 656d  .            mem
+00024a80: 6f72 795f 6c69 6d69 743d 6d65 6d6f 7279  ory_limit=memory
+00024a90: 5f6c 696d 6974 206f 7220 302c 0a20 2020  _limit or 0,.   
+00024aa0: 2020 2020 2020 2020 206e 616d 653d 6e61           name=na
+00024ab0: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+00024ac0: 6c6f 6361 6c5f 6469 7265 6374 6f72 793d  local_directory=
+00024ad0: 6c6f 6361 6c5f 6469 7265 6374 6f72 792c  local_directory,
+00024ae0: 0a20 2020 2020 2020 2020 2020 2073 6572  .            ser
+00024af0: 7669 6365 733d 7365 7276 6963 6573 2c0a  vices=services,.
+00024b00: 2020 2020 2020 2020 2020 2020 7665 7273              vers
+00024b10: 696f 6e73 3d76 6572 7369 6f6e 732c 0a20  ions=versions,. 
+00024b20: 2020 2020 2020 2020 2020 206e 616e 6e79             nanny
+00024b30: 3d6e 616e 6e79 2c0a 2020 2020 2020 2020  =nanny,.        
+00024b40: 2020 2020 6578 7472 613d 6578 7472 612c      extra=extra,
+00024b50: 0a20 2020 2020 2020 2020 2020 2073 6572  .            ser
+00024b60: 7665 725f 6964 3d73 6572 7665 725f 6964  ver_id=server_id
+00024b70: 2c0a 2020 2020 2020 2020 2020 2020 7363  ,.            sc
+00024b80: 6865 6475 6c65 723d 7365 6c66 2c0a 2020  heduler=self,.  
+00024b90: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00024ba0: 6966 2077 732e 7374 6174 7573 203d 3d20  if ws.status == 
+00024bb0: 5374 6174 7573 2e72 756e 6e69 6e67 3a0a  Status.running:.
+00024bc0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00024bd0: 2e72 756e 6e69 6e67 2e61 6464 2877 7329  .running.add(ws)
+00024be0: 0a0a 2020 2020 2020 2020 6468 203d 2073  ..        dh = s
+00024bf0: 656c 662e 686f 7374 5f69 6e66 6f2e 6765  elf.host_info.ge
+00024c00: 7428 686f 7374 290a 2020 2020 2020 2020  t(host).        
+00024c10: 6966 2064 6820 6973 204e 6f6e 653a 0a20  if dh is None:. 
+00024c20: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00024c30: 686f 7374 5f69 6e66 6f5b 686f 7374 5d20  host_info[host] 
+00024c40: 3d20 6468 203d 207b 7d0a 0a20 2020 2020  = dh = {}..     
+00024c50: 2020 2064 685f 6164 6472 6573 7365 7320     dh_addresses 
+00024c60: 3d20 6468 2e67 6574 2822 6164 6472 6573  = dh.get("addres
+00024c70: 7365 7322 290a 2020 2020 2020 2020 6966  ses").        if
+00024c80: 2064 685f 6164 6472 6573 7365 7320 6973   dh_addresses is
+00024c90: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00024ca0: 2020 2064 685b 2261 6464 7265 7373 6573     dh["addresses
+00024cb0: 225d 203d 2064 685f 6164 6472 6573 7365  "] = dh_addresse
+00024cc0: 7320 3d20 7365 7428 290a 2020 2020 2020  s = set().      
+00024cd0: 2020 2020 2020 6468 5b22 6e74 6872 6561        dh["nthrea
+00024ce0: 6473 225d 203d 2030 0a0a 2020 2020 2020  ds"] = 0..      
+00024cf0: 2020 6468 5f61 6464 7265 7373 6573 2e61    dh_addresses.a
+00024d00: 6464 2861 6464 7265 7373 290a 2020 2020  dd(address).    
+00024d10: 2020 2020 6468 5b22 6e74 6872 6561 6473      dh["nthreads
+00024d20: 225d 202b 3d20 6e74 6872 6561 6473 0a0a  "] += nthreads..
+00024d30: 2020 2020 2020 2020 7365 6c66 2e74 6f74          self.tot
+00024d40: 616c 5f6e 7468 7265 6164 7320 2b3d 206e  al_nthreads += n
+00024d50: 7468 7265 6164 730a 2020 2020 2020 2020  threads.        
+00024d60: 7365 6c66 2e74 6f74 616c 5f6e 7468 7265  self.total_nthre
+00024d70: 6164 735f 6869 7374 6f72 792e 6170 7065  ads_history.appe
+00024d80: 6e64 2828 7469 6d65 2829 2c20 7365 6c66  nd((time(), self
+00024d90: 2e74 6f74 616c 5f6e 7468 7265 6164 7329  .total_nthreads)
+00024da0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+00024db0: 6c69 6173 6573 5b6e 616d 655d 203d 2061  liases[name] = a
+00024dc0: 6464 7265 7373 0a0a 2020 2020 2020 2020  ddress..        
+00024dd0: 7365 6c66 2e68 6561 7274 6265 6174 5f77  self.heartbeat_w
+00024de0: 6f72 6b65 7228 0a20 2020 2020 2020 2020  orker(.         
+00024df0: 2020 2061 6464 7265 7373 3d61 6464 7265     address=addre
+00024e00: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
+00024e10: 7265 736f 6c76 655f 6164 6472 6573 733d  resolve_address=
+00024e20: 7265 736f 6c76 655f 6164 6472 6573 732c  resolve_address,
+00024e30: 0a20 2020 2020 2020 2020 2020 206e 6f77  .            now
+00024e40: 3d6e 6f77 2c0a 2020 2020 2020 2020 2020  =now,.          
+00024e50: 2020 7265 736f 7572 6365 733d 7265 736f    resources=reso
+00024e60: 7572 6365 732c 0a20 2020 2020 2020 2020  urces,.         
+00024e70: 2020 2068 6f73 745f 696e 666f 3d68 6f73     host_info=hos
+00024e80: 745f 696e 666f 2c0a 2020 2020 2020 2020  t_info,.        
+00024e90: 2020 2020 6d65 7472 6963 733d 6d65 7472      metrics=metr
+00024ea0: 6963 732c 0a20 2020 2020 2020 2029 0a0a  ics,.        )..
+00024eb0: 2020 2020 2020 2020 2320 446f 206e 6f74          # Do not
+00024ec0: 206e 6565 6420 746f 2061 646a 7573 7420   need to adjust 
+00024ed0: 7365 6c66 2e74 6f74 616c 5f6f 6363 7570  self.total_occup
+00024ee0: 616e 6379 2061 7320 7365 6c66 2e6f 6363  ancy as self.occ
+00024ef0: 7570 616e 6379 5b77 735d 2063 616e 6e6f  upancy[ws] canno
+00024f00: 740a 2020 2020 2020 2020 2320 6578 6973  t.        # exis
+00024f10: 7420 6265 666f 7265 2074 6869 732e 0a20  t before this.. 
+00024f20: 2020 2020 2020 2073 656c 662e 6368 6563         self.chec
+00024f30: 6b5f 6964 6c65 5f73 6174 7572 6174 6564  k_idle_saturated
+00024f40: 2877 7329 0a0a 2020 2020 2020 2020 7365  (ws)..        se
+00024f50: 6c66 2e73 7472 6561 6d5f 636f 6d6d 735b  lf.stream_comms[
+00024f60: 6164 6472 6573 735d 203d 2042 6174 6368  address] = Batch
+00024f70: 6564 5365 6e64 2869 6e74 6572 7661 6c3d  edSend(interval=
+00024f80: 2235 6d73 222c 206c 6f6f 703d 7365 6c66  "5ms", loop=self
+00024f90: 2e6c 6f6f 7029 0a0a 2020 2020 2020 2020  .loop)..        
+00024fa0: 6177 6169 7461 626c 6573 203d 205b 5d0a  awaitables = [].
+00024fb0: 2020 2020 2020 2020 666f 7220 706c 7567          for plug
+00024fc0: 696e 2069 6e20 6c69 7374 2873 656c 662e  in in list(self.
+00024fd0: 706c 7567 696e 732e 7661 6c75 6573 2829  plugins.values()
+00024fe0: 293a 0a20 2020 2020 2020 2020 2020 2074  ):.            t
+00024ff0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00025000: 2020 2020 7265 7375 6c74 203d 2070 6c75      result = plu
+00025010: 6769 6e2e 6164 645f 776f 726b 6572 2873  gin.add_worker(s
+00025020: 6368 6564 756c 6572 3d73 656c 662c 2077  cheduler=self, w
+00025030: 6f72 6b65 723d 6164 6472 6573 7329 0a20  orker=address). 
+00025040: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00025050: 6620 7265 7375 6c74 2069 7320 6e6f 7420  f result is not 
+00025060: 4e6f 6e65 2061 6e64 2069 6e73 7065 6374  None and inspect
+00025070: 2e69 7361 7761 6974 6162 6c65 2872 6573  .isawaitable(res
+00025080: 756c 7429 3a0a 2020 2020 2020 2020 2020  ult):.          
+00025090: 2020 2020 2020 2020 2020 6177 6169 7461            awaita
+000250a0: 626c 6573 2e61 7070 656e 6428 7265 7375  bles.append(resu
+000250b0: 6c74 290a 2020 2020 2020 2020 2020 2020  lt).            
+000250c0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+000250d0: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+000250e0: 2020 2020 2020 206c 6f67 6765 722e 6578         logger.ex
+000250f0: 6365 7074 696f 6e28 6529 0a0a 2020 2020  ception(e)..    
+00025100: 2020 2020 706c 7567 696e 5f6d 7367 7320      plugin_msgs 
+00025110: 3d20 6177 6169 7420 6173 796e 6369 6f2e  = await asyncio.
+00025120: 6761 7468 6572 282a 6177 6169 7461 626c  gather(*awaitabl
+00025130: 6573 2c20 7265 7475 726e 5f65 7863 6570  es, return_excep
+00025140: 7469 6f6e 733d 5472 7565 290a 2020 2020  tions=True).    
+00025150: 2020 2020 706c 7567 696e 735f 6578 6365      plugins_exce
+00025160: 7074 696f 6e73 203d 205b 6d73 6720 666f  ptions = [msg fo
+00025170: 7220 6d73 6720 696e 2070 6c75 6769 6e5f  r msg in plugin_
+00025180: 6d73 6773 2069 6620 6973 696e 7374 616e  msgs if isinstan
+00025190: 6365 286d 7367 2c20 4578 6365 7074 696f  ce(msg, Exceptio
+000251a0: 6e29 5d0a 2020 2020 2020 2020 666f 7220  n)].        for 
+000251b0: 6578 6320 696e 2070 6c75 6769 6e73 5f65  exc in plugins_e
+000251c0: 7863 6570 7469 6f6e 733a 0a20 2020 2020  xceptions:.     
+000251d0: 2020 2020 2020 206c 6f67 6765 722e 6578         logger.ex
+000251e0: 6365 7074 696f 6e28 6578 632c 2065 7863  ception(exc, exc
+000251f0: 5f69 6e66 6f3d 6578 6329 0a0a 2020 2020  _info=exc)..    
+00025200: 2020 2020 6966 2077 732e 7374 6174 7573      if ws.status
+00025210: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
+00025220: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
+00025230: 7365 6c66 2e74 7261 6e73 6974 696f 6e73  self.transitions
+00025240: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00025250: 2020 7365 6c66 2e62 756c 6b5f 7363 6865    self.bulk_sche
+00025260: 6475 6c65 5f75 6e72 756e 6e61 626c 655f  dule_unrunnable_
+00025270: 6166 7465 725f 6164 6469 6e67 5f77 6f72  after_adding_wor
+00025280: 6b65 7228 7773 292c 2073 7469 6d75 6c75  ker(ws), stimulu
+00025290: 735f 6964 0a20 2020 2020 2020 2020 2020  s_id.           
+000252a0: 2029 0a20 2020 2020 2020 2020 2020 2073   ).            s
+000252b0: 656c 662e 7374 696d 756c 7573 5f71 7565  elf.stimulus_que
+000252c0: 7565 5f73 6c6f 7473 5f6d 6179 6265 5f6f  ue_slots_maybe_o
+000252d0: 7065 6e65 6428 7374 696d 756c 7573 5f69  pened(stimulus_i
+000252e0: 643d 7374 696d 756c 7573 5f69 6429 0a0a  d=stimulus_id)..
+000252f0: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+00025300: 6e66 6f28 2252 6567 6973 7465 7220 776f  nfo("Register wo
+00025310: 726b 6572 2025 7322 2c20 7773 290a 0a20  rker %s", ws).. 
+00025320: 2020 2020 2020 206d 7367 203d 207b 0a20         msg = {. 
+00025330: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
+00025340: 7573 223a 2022 4f4b 222c 0a20 2020 2020  us": "OK",.     
+00025350: 2020 2020 2020 2022 7469 6d65 223a 2074         "time": t
+00025360: 696d 6528 292c 0a20 2020 2020 2020 2020  ime(),.         
+00025370: 2020 2022 6865 6172 7462 6561 742d 696e     "heartbeat-in
+00025380: 7465 7276 616c 223a 2068 6561 7274 6265  terval": heartbe
+00025390: 6174 5f69 6e74 6572 7661 6c28 6c65 6e28  at_interval(len(
+000253a0: 7365 6c66 2e77 6f72 6b65 7273 2929 2c0a  self.workers)),.
+000253b0: 2020 2020 2020 2020 2020 2020 2277 6f72              "wor
+000253c0: 6b65 722d 706c 7567 696e 7322 3a20 7365  ker-plugins": se
+000253d0: 6c66 2e77 6f72 6b65 725f 706c 7567 696e  lf.worker_plugin
+000253e0: 732c 0a20 2020 2020 2020 207d 0a0a 2020  s,.        }..  
+000253f0: 2020 2020 2020 7665 7273 696f 6e5f 7761        version_wa
+00025400: 726e 696e 6720 3d20 7665 7273 696f 6e5f  rning = version_
+00025410: 6d6f 6475 6c65 2e65 7272 6f72 5f6d 6573  module.error_mes
+00025420: 7361 6765 280a 2020 2020 2020 2020 2020  sage(.          
+00025430: 2020 7665 7273 696f 6e5f 6d6f 6475 6c65    version_module
+00025440: 2e67 6574 5f76 6572 7369 6f6e 7328 292c  .get_versions(),
+00025450: 0a20 2020 2020 2020 2020 2020 207b 773a  .            {w:
+00025460: 2077 732e 7665 7273 696f 6e73 2066 6f72   ws.versions for
+00025470: 2077 2c20 7773 2069 6e20 7365 6c66 2e77   w, ws in self.w
+00025480: 6f72 6b65 7273 2e69 7465 6d73 2829 7d2c  orkers.items()},
+00025490: 0a20 2020 2020 2020 2020 2020 2076 6572  .            ver
+000254a0: 7369 6f6e 732c 0a20 2020 2020 2020 2020  sions,.         
+000254b0: 2020 2073 6f75 7263 655f 6e61 6d65 3d73     source_name=s
+000254c0: 7472 2877 732e 7365 7276 6572 5f69 6429  tr(ws.server_id)
+000254d0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+000254e0: 2020 2020 6d73 672e 7570 6461 7465 2876      msg.update(v
+000254f0: 6572 7369 6f6e 5f77 6172 6e69 6e67 290a  ersion_warning).
+00025500: 0a20 2020 2020 2020 2061 7761 6974 2063  .        await c
+00025510: 6f6d 6d2e 7772 6974 6528 6d73 6729 0a20  omm.write(msg). 
+00025520: 2020 2020 2020 2023 2054 6869 7320 7769         # This wi
+00025530: 6c6c 206b 6565 7020 7275 6e6e 696e 6720  ll keep running 
+00025540: 756e 7469 6c20 7468 6520 776f 726b 6572  until the worker
+00025550: 2069 7320 7265 6d6f 7665 640a 2020 2020   is removed.    
+00025560: 2020 2020 6177 6169 7420 7365 6c66 2e68      await self.h
+00025570: 616e 646c 655f 776f 726b 6572 2863 6f6d  andle_worker(com
+00025580: 6d2c 2061 6464 7265 7373 290a 0a20 2020  m, address)..   
+00025590: 2061 7379 6e63 2064 6566 2061 6464 5f6e   async def add_n
+000255a0: 616e 6e79 2873 656c 6629 202d 3e20 6469  anny(self) -> di
+000255b0: 6374 5b73 7472 2c20 416e 795d 3a0a 2020  ct[str, Any]:.  
+000255c0: 2020 2020 2020 6d73 6720 3d20 7b0a 2020        msg = {.  
+000255d0: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
+000255e0: 7322 3a20 224f 4b22 2c0a 2020 2020 2020  s": "OK",.      
+000255f0: 2020 2020 2020 226e 616e 6e79 2d70 6c75        "nanny-plu
+00025600: 6769 6e73 223a 2073 656c 662e 6e61 6e6e  gins": self.nann
+00025610: 795f 706c 7567 696e 732c 0a20 2020 2020  y_plugins,.     
+00025620: 2020 207d 0a20 2020 2020 2020 2072 6574     }.        ret
+00025630: 7572 6e20 6d73 670a 0a20 2020 2064 6566  urn msg..    def
+00025640: 2075 7064 6174 655f 6772 6170 6828 0a20   update_graph(. 
+00025650: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+00025660: 2020 2020 2063 6c69 656e 743a 2073 7472       client: str
+00025670: 2c0a 2020 2020 2020 2020 6772 6170 685f  ,.        graph_
+00025680: 6865 6164 6572 3a20 6469 6374 2c0a 2020  header: dict,.  
+00025690: 2020 2020 2020 6772 6170 685f 6672 616d        graph_fram
+000256a0: 6573 3a20 6c69 7374 5b62 7974 6573 5d2c  es: list[bytes],
+000256b0: 0a20 2020 2020 2020 206b 6579 733a 206c  .        keys: l
+000256c0: 6973 745b 7374 725d 2c0a 2020 2020 2020  ist[str],.      
+000256d0: 2020 696e 7465 726e 616c 5f70 7269 6f72    internal_prior
+000256e0: 6974 793a 2064 6963 745b 7374 722c 2069  ity: dict[str, i
+000256f0: 6e74 5d20 7c20 4e6f 6e65 2c0a 2020 2020  nt] | None,.    
+00025700: 2020 2020 7375 626d 6974 7469 6e67 5f74      submitting_t
+00025710: 6173 6b3a 2073 7472 207c 204e 6f6e 652c  ask: str | None,
+00025720: 0a20 2020 2020 2020 2075 7365 725f 7072  .        user_pr
+00025730: 696f 7269 7479 3a20 696e 7420 7c20 6469  iority: int | di
+00025740: 6374 5b73 7472 2c20 696e 745d 203d 2030  ct[str, int] = 0
+00025750: 2c0a 2020 2020 2020 2020 6163 746f 7273  ,.        actors
+00025760: 3a20 626f 6f6c 207c 206c 6973 745b 7374  : bool | list[st
+00025770: 725d 207c 204e 6f6e 6520 3d20 4e6f 6e65  r] | None = None
+00025780: 2c0a 2020 2020 2020 2020 6669 666f 5f74  ,.        fifo_t
+00025790: 696d 656f 7574 3a20 666c 6f61 7420 3d20  imeout: float = 
+000257a0: 302e 302c 0a20 2020 2020 2020 2063 6f64  0.0,.        cod
+000257b0: 653a 2074 7570 6c65 5b53 6f75 7263 6543  e: tuple[SourceC
+000257c0: 6f64 652c 202e 2e2e 5d20 3d20 2829 2c0a  ode, ...] = (),.
+000257d0: 2020 2020 2020 2020 616e 6e6f 7461 7469          annotati
+000257e0: 6f6e 733a 2064 6963 7420 7c20 4e6f 6e65  ons: dict | None
+000257f0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00025800: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
+00025810: 7220 7c20 4e6f 6e65 203d 204e 6f6e 652c  r | None = None,
+00025820: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
+00025830: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
+00025840: 7469 6d65 2829 0a20 2020 2020 2020 2074  time().        t
+00025850: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00025860: 2320 544f 444f 3a20 6465 7365 7269 616c  # TODO: deserial
+00025870: 697a 6174 696f 6e20 2b20 6d61 7465 7269  ization + materi
+00025880: 616c 697a 6174 696f 6e20 7368 6f75 6c64  alization should
+00025890: 2062 6520 6f66 666c 6f61 6465 6420 746f   be offloaded to
+000258a0: 2061 0a20 2020 2020 2020 2020 2020 2023   a.            #
+000258b0: 2074 6872 6561 6420 7369 6e63 6520 7468   thread since th
+000258c0: 6973 2069 7320 6e6f 6e2d 7472 6976 6961  is is non-trivia
+000258d0: 6c20 636f 6d70 7574 6520 7469 6d65 2074  l compute time t
+000258e0: 6861 7420 626c 6f63 6b73 2074 6865 0a20  hat blocks the. 
+000258f0: 2020 2020 2020 2020 2020 2023 2065 7665             # eve
+00025900: 6e74 206c 6f6f 702e 2054 6869 7320 6c69  nt loop. This li
+00025910: 6b65 6c79 2072 6571 7569 7265 7320 7573  kely requires us
+00025920: 2074 6f20 7573 6520 6120 6c6f 636b 2073   to use a lock s
+00025930: 696e 6365 2077 6520 6e65 6564 2074 6f0a  ince we need to.
+00025940: 2020 2020 2020 2020 2020 2020 2320 6775              # gu
+00025950: 6172 616e 7465 6520 6f72 6465 7269 6e67  arantee ordering
+00025960: 206f 6620 7570 6461 7465 5f67 7261 7068   of update_graph
+00025970: 2063 616c 6c73 2028 6173 206c 6f6e 6720   calls (as long 
+00025980: 6173 2074 6865 7265 2069 7320 6a75 7374  as there is just
+00025990: 0a20 2020 2020 2020 2020 2020 2023 2061  .            # a
+000259a0: 2073 696e 676c 6520 6f66 666c 6f61 6420   single offload 
+000259b0: 7468 7265 6164 2c20 7468 6973 2069 7320  thread, this is 
+000259c0: 6e6f 7420 6120 7072 6f62 6c65 6d29 0a20  not a problem). 
+000259d0: 2020 2020 2020 2020 2020 2066 726f 6d20             from 
+000259e0: 6469 7374 7269 6275 7465 642e 7072 6f74  distributed.prot
+000259f0: 6f63 6f6c 2069 6d70 6f72 7420 6465 7365  ocol import dese
+00025a00: 7269 616c 697a 650a 0a20 2020 2020 2020  rialize..       
+00025a10: 2020 2020 2067 7261 7068 203d 2064 6573       graph = des
+00025a20: 6572 6961 6c69 7a65 2867 7261 7068 5f68  erialize(graph_h
+00025a30: 6561 6465 722c 2067 7261 7068 5f66 7261  eader, graph_fra
+00025a40: 6d65 7329 2e64 6174 610a 2020 2020 2020  mes).data.      
+00025a50: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+00025a60: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
+00025a70: 2020 2020 206d 7367 203d 2022 2222 5c0a       msg = """\.
 00025a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025a90: 6572 7220 3d20 6572 726f 725f 6d65 7373  err = error_mess
-00025aa0: 6167 6528 6529 0a20 2020 2020 2020 2020  age(e).         
-00025ab0: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
-00025ac0: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
-00025ad0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00025ae0: 2e72 6570 6f72 7428 0a20 2020 2020 2020  .report(.       
-00025af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025b00: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00025b10: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00025b20: 6f70 223a 2022 7461 736b 2d65 7272 6564  op": "task-erred
-00025b30: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00025b40: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00025b50: 6b65 7922 3a20 6b65 792c 0a20 2020 2020  key": key,.     
-00025b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025b70: 2020 2020 2020 2022 6578 6365 7074 696f         "exceptio
-00025b80: 6e22 3a20 6572 725b 2265 7863 6570 7469  n": err["excepti
-00025b90: 6f6e 225d 2c0a 2020 2020 2020 2020 2020  on"],.          
-00025ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025bb0: 2020 2274 7261 6365 6261 636b 223a 2065    "traceback": e
-00025bc0: 7272 5b22 7472 6163 6562 6163 6b22 5d2c  rr["traceback"],
-00025bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025be0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00025bf0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00025c00: 0a0a 2020 2020 2020 2020 2020 2020 7265  ..            re
-00025c10: 7475 726e 0a20 2020 2020 2020 2061 6e6e  turn.        ann
-00025c20: 6f74 6174 696f 6e73 203d 2061 6e6e 6f74  otations = annot
-00025c30: 6174 696f 6e73 206f 7220 7b7d 0a20 2020  ations or {}.   
-00025c40: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-00025c50: 6365 2861 6e6e 6f74 6174 696f 6e73 2c20  ce(annotations, 
-00025c60: 546f 5069 636b 6c65 293a 2020 2320 7479  ToPickle):  # ty
-00025c70: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
-00025c80: 2020 2020 2020 2023 2046 4958 4d45 3a20         # FIXME: 
-00025c90: 7768 6174 2074 6865 2068 6563 6b3f 0a20  what the heck?. 
-00025ca0: 2020 2020 2020 2020 2020 2061 6e6e 6f74             annot
-00025cb0: 6174 696f 6e73 203d 2061 6e6e 6f74 6174  ations = annotat
-00025cc0: 696f 6e73 2e64 6174 6120 2023 2074 7970  ions.data  # typ
-00025cd0: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
-00025ce0: 2020 7374 696d 756c 7573 5f69 6420 3d20    stimulus_id = 
-00025cf0: 7374 696d 756c 7573 5f69 6420 6f72 2066  stimulus_id or f
-00025d00: 2275 7064 6174 652d 6772 6170 682d 7b74  "update-graph-{t
-00025d10: 696d 6528 297d 220a 2020 2020 2020 2020  ime()}".        
-00025d20: 280a 2020 2020 2020 2020 2020 2020 6473  (.            ds
-00025d30: 6b2c 0a20 2020 2020 2020 2020 2020 2064  k,.            d
-00025d40: 6570 656e 6465 6e63 6965 732c 0a20 2020  ependencies,.   
-00025d50: 2020 2020 2020 2020 206c 6179 6572 5f61           layer_a
-00025d60: 6e6e 6f74 6174 696f 6e73 2c0a 2020 2020  nnotations,.    
-00025d70: 2020 2020 2020 2020 7072 655f 7374 7269          pre_stri
-00025d80: 6e67 6966 6965 645f 6b65 7973 2c0a 2020  ngified_keys,.  
-00025d90: 2020 2020 2020 2920 3d20 7365 6c66 2e6d        ) = self.m
-00025da0: 6174 6572 6961 6c69 7a65 5f67 7261 7068  aterialize_graph
-00025db0: 2867 7261 7068 290a 0a20 2020 2020 2020  (graph)..       
-00025dc0: 2072 6571 7565 7374 6564 5f6b 6579 7320   requested_keys 
-00025dd0: 3d20 7365 7428 6b65 7973 290a 2020 2020  = set(keys).    
-00025de0: 2020 2020 6465 6c20 6b65 7973 0a20 2020      del keys.   
-00025df0: 2020 2020 2069 6620 6c65 6e28 6473 6b29       if len(dsk)
-00025e00: 203e 2031 3a0a 2020 2020 2020 2020 2020   > 1:.          
-00025e10: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
-00025e20: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00025e30: 2020 5b22 616c 6c22 2c20 636c 6965 6e74    ["all", client
-00025e40: 5d2c 207b 2261 6374 696f 6e22 3a20 2275  ], {"action": "u
-00025e50: 7064 6174 655f 6772 6170 6822 2c20 2263  pdate_graph", "c
-00025e60: 6f75 6e74 223a 206c 656e 2864 736b 297d  ount": len(dsk)}
-00025e70: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00025e80: 2020 2020 2020 2073 656c 662e 5f70 6f70         self._pop
-00025e90: 5f6b 6e6f 776e 5f74 6173 6b73 2864 736b  _known_tasks(dsk
-00025ea0: 2c20 6465 7065 6e64 656e 6369 6573 290a  , dependencies).
-00025eb0: 0a20 2020 2020 2020 2069 6620 6c6f 7374  .        if lost
-00025ec0: 5f6b 6579 7320 3a3d 2073 656c 662e 5f70  _keys := self._p
-00025ed0: 6f70 5f6c 6f73 745f 7461 736b 7328 6473  op_lost_tasks(ds
-00025ee0: 6b2c 2064 6570 656e 6465 6e63 6965 732c  k, dependencies,
-00025ef0: 2072 6571 7565 7374 6564 5f6b 6579 7329   requested_keys)
-00025f00: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00025f10: 6c66 2e72 6570 6f72 7428 7b22 6f70 223a  lf.report({"op":
-00025f20: 2022 6361 6e63 656c 6c65 642d 6b65 7973   "cancelled-keys
-00025f30: 222c 2022 6b65 7973 223a 206c 6f73 745f  ", "keys": lost_
-00025f40: 6b65 7973 7d2c 2063 6c69 656e 743d 636c  keys}, client=cl
-00025f50: 6965 6e74 290a 2020 2020 2020 2020 2020  ient).          
-00025f60: 2020 7365 6c66 2e63 6c69 656e 745f 7265    self.client_re
-00025f70: 6c65 6173 6573 5f6b 6579 7328 0a20 2020  leases_keys(.   
-00025f80: 2020 2020 2020 2020 2020 2020 206b 6579               key
-00025f90: 733d 6c6f 7374 5f6b 6579 732c 2063 6c69  s=lost_keys, cli
-00025fa0: 656e 743d 636c 6965 6e74 2c20 7374 696d  ent=client, stim
-00025fb0: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
-00025fc0: 5f69 640a 2020 2020 2020 2020 2020 2020  _id.            
-00025fd0: 290a 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
-00025fe0: 7420 7365 6c66 2e69 735f 6964 6c65 2061  t self.is_idle a
-00025ff0: 6e64 2073 656c 662e 636f 6d70 7574 6174  nd self.computat
-00026000: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
-00026010: 2020 2320 5374 696c 6c20 776f 726b 696e    # Still workin
-00026020: 6720 6f6e 2073 6f6d 6574 6869 6e67 2e20  g on something. 
-00026030: 4173 7369 676e 206e 6577 2074 6173 6b73  Assign new tasks
-00026040: 2074 6f20 7361 6d65 2063 6f6d 7075 7461   to same computa
-00026050: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
-00026060: 2063 6f6d 7075 7461 7469 6f6e 203d 2073   computation = s
-00026070: 656c 662e 636f 6d70 7574 6174 696f 6e73  elf.computations
-00026080: 5b2d 315d 0a20 2020 2020 2020 2065 6c73  [-1].        els
-00026090: 653a 0a20 2020 2020 2020 2020 2020 2063  e:.            c
-000260a0: 6f6d 7075 7461 7469 6f6e 203d 2043 6f6d  omputation = Com
-000260b0: 7075 7461 7469 6f6e 2829 0a20 2020 2020  putation().     
-000260c0: 2020 2020 2020 2073 656c 662e 636f 6d70         self.comp
-000260d0: 7574 6174 696f 6e73 2e61 7070 656e 6428  utations.append(
-000260e0: 636f 6d70 7574 6174 696f 6e29 0a0a 2020  computation)..  
-000260f0: 2020 2020 2020 6966 2063 6f64 653a 2020        if code:  
-00026100: 2320 6164 6420 6e65 7720 636f 6465 2062  # add new code b
-00026110: 6c6f 636b 730a 2020 2020 2020 2020 2020  locks.          
-00026120: 2020 636f 6d70 7574 6174 696f 6e2e 636f    computation.co
-00026130: 6465 2e61 6464 2863 6f64 6529 0a20 2020  de.add(code).   
-00026140: 2020 2020 2069 6620 616e 6e6f 7461 7469       if annotati
-00026150: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
-00026160: 2063 6f6d 7075 7461 7469 6f6e 2e61 6e6e   computation.ann
-00026170: 6f74 6174 696f 6e73 2e75 7064 6174 6528  otations.update(
-00026180: 616e 6e6f 7461 7469 6f6e 7329 0a0a 2020  annotations)..  
-00026190: 2020 2020 2020 7275 6e6e 6162 6c65 2c20        runnable, 
-000261a0: 746f 7563 6865 645f 7461 736b 732c 206e  touched_tasks, n
-000261b0: 6577 5f74 6173 6b73 203d 2073 656c 662e  ew_tasks = self.
-000261c0: 5f67 656e 6572 6174 655f 7461 736b 7374  _generate_taskst
-000261d0: 6174 6573 280a 2020 2020 2020 2020 2020  ates(.          
-000261e0: 2020 6b65 7973 3d72 6571 7565 7374 6564    keys=requested
-000261f0: 5f6b 6579 732c 0a20 2020 2020 2020 2020  _keys,.         
-00026200: 2020 2064 736b 3d64 736b 2c0a 2020 2020     dsk=dsk,.    
-00026210: 2020 2020 2020 2020 6465 7065 6e64 656e          dependen
-00026220: 6369 6573 3d64 6570 656e 6465 6e63 6965  cies=dependencie
-00026230: 732c 0a20 2020 2020 2020 2020 2020 2063  s,.            c
-00026240: 6f6d 7075 7461 7469 6f6e 3d63 6f6d 7075  omputation=compu
-00026250: 7461 7469 6f6e 2c0a 2020 2020 2020 2020  tation,.        
-00026260: 290a 2020 2020 2020 2020 2320 4649 584d  ).        # FIXM
-00026270: 453a 2054 6865 7365 2022 7265 736f 6c76  E: These "resolv
-00026280: 6564 5f61 6e6e 6f74 6174 696f 6e73 2220  ed_annotations" 
-00026290: 6172 6520 6120 6269 6720 6475 706c 6963  are a big duplic
-000262a0: 6174 696f 6e20 616e 6420 6172 6520 6f6e  ation and are on
-000262b0: 6c79 0a20 2020 2020 2020 2023 2072 6571  ly.        # req
-000262c0: 7569 7265 6420 746f 2073 6174 6973 6679  uired to satisfy
-000262d0: 2074 6865 2063 7572 7265 6e74 2070 6c75   the current plu
-000262e0: 6769 6e20 4150 492e 2054 6869 7320 7368  gin API. This sh
-000262f0: 6f75 6c64 2062 650a 2020 2020 2020 2020  ould be.        
-00026300: 2320 7265 636f 6e73 6964 6572 6564 2e0a  # reconsidered..
-00026310: 2020 2020 2020 2020 7265 736f 6c76 6564          resolved
-00026320: 5f61 6e6e 6f74 6174 696f 6e73 203d 2073  _annotations = s
-00026330: 656c 662e 5f70 6172 7365 5f61 6e64 5f61  elf._parse_and_a
-00026340: 7070 6c79 5f61 6e6e 6f74 6174 696f 6e73  pply_annotations
-00026350: 280a 2020 2020 2020 2020 2020 2020 7461  (.            ta
-00026360: 736b 733d 6e65 775f 7461 736b 732c 0a20  sks=new_tasks,. 
-00026370: 2020 2020 2020 2020 2020 2061 6e6e 6f74             annot
-00026380: 6174 696f 6e73 3d61 6e6e 6f74 6174 696f  ations=annotatio
-00026390: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
-000263a0: 6c61 7965 725f 616e 6e6f 7461 7469 6f6e  layer_annotation
-000263b0: 733d 6c61 7965 725f 616e 6e6f 7461 7469  s=layer_annotati
-000263c0: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
-000263d0: 2070 7265 5f73 7472 696e 6769 6669 6564   pre_stringified
-000263e0: 5f6b 6579 733d 7072 655f 7374 7269 6e67  _keys=pre_string
-000263f0: 6966 6965 645f 6b65 7973 2c0a 2020 2020  ified_keys,.    
-00026400: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
-00026410: 656c 662e 5f73 6574 5f70 7269 6f72 6974  elf._set_priorit
-00026420: 6965 7328 0a20 2020 2020 2020 2020 2020  ies(.           
-00026430: 2069 6e74 6572 6e61 6c5f 7072 696f 7269   internal_priori
-00026440: 7479 3d69 6e74 6572 6e61 6c5f 7072 696f  ty=internal_prio
-00026450: 7269 7479 2c0a 2020 2020 2020 2020 2020  rity,.          
-00026460: 2020 7375 626d 6974 7469 6e67 5f74 6173    submitting_tas
-00026470: 6b3d 7375 626d 6974 7469 6e67 5f74 6173  k=submitting_tas
-00026480: 6b2c 0a20 2020 2020 2020 2020 2020 2075  k,.            u
-00026490: 7365 725f 7072 696f 7269 7479 3d75 7365  ser_priority=use
-000264a0: 725f 7072 696f 7269 7479 2c0a 2020 2020  r_priority,.    
-000264b0: 2020 2020 2020 2020 6669 666f 5f74 696d          fifo_tim
-000264c0: 656f 7574 3d66 6966 6f5f 7469 6d65 6f75  eout=fifo_timeou
-000264d0: 742c 0a20 2020 2020 2020 2020 2020 2073  t,.            s
-000264e0: 7461 7274 3d73 7461 7274 2c0a 2020 2020  tart=start,.    
-000264f0: 2020 2020 2020 2020 6473 6b3d 6473 6b2c          dsk=dsk,
-00026500: 0a20 2020 2020 2020 2020 2020 2074 6173  .            tas
-00026510: 6b73 3d72 756e 6e61 626c 652c 0a20 2020  ks=runnable,.   
-00026520: 2020 2020 2020 2020 2064 6570 656e 6465           depende
-00026530: 6e63 6965 733d 6465 7065 6e64 656e 6369  ncies=dependenci
-00026540: 6573 2c0a 2020 2020 2020 2020 290a 0a20  es,.        ).. 
-00026550: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-00026560: 6e74 5f64 6573 6972 6573 5f6b 6579 7328  nt_desires_keys(
-00026570: 6b65 7973 3d72 6571 7565 7374 6564 5f6b  keys=requested_k
-00026580: 6579 732c 2063 6c69 656e 743d 636c 6965  eys, client=clie
-00026590: 6e74 290a 0a20 2020 2020 2020 2023 2041  nt)..        # A
-000265a0: 6464 2061 6374 6f72 730a 2020 2020 2020  dd actors.      
-000265b0: 2020 6966 2061 6374 6f72 7320 6973 2054    if actors is T
-000265c0: 7275 653a 0a20 2020 2020 2020 2020 2020  rue:.           
-000265d0: 2061 6374 6f72 7320 3d20 6c69 7374 2872   actors = list(r
-000265e0: 6571 7565 7374 6564 5f6b 6579 7329 0a20  equested_keys). 
-000265f0: 2020 2020 2020 2066 6f72 2061 6374 6f72         for actor
-00026600: 2069 6e20 6163 746f 7273 206f 7220 5b5d   in actors or []
-00026610: 3a0a 2020 2020 2020 2020 2020 2020 7473  :.            ts
-00026620: 203d 2073 656c 662e 7461 736b 735b 6163   = self.tasks[ac
-00026630: 746f 725d 0a20 2020 2020 2020 2020 2020  tor].           
-00026640: 2074 732e 6163 746f 7220 3d20 5472 7565   ts.actor = True
-00026650: 0a0a 2020 2020 2020 2020 2320 436f 6d70  ..        # Comp
-00026660: 7574 6520 7265 636f 6d6d 656e 6461 7469  ute recommendati
-00026670: 6f6e 730a 2020 2020 2020 2020 7265 636f  ons.        reco
-00026680: 6d6d 656e 6461 7469 6f6e 733a 2052 6563  mmendations: Rec
-00026690: 7320 3d20 7b7d 0a20 2020 2020 2020 2070  s = {}.        p
-000266a0: 7269 6f72 6974 7920 3d20 6469 6374 2829  riority = dict()
-000266b0: 0a20 2020 2020 2020 2066 6f72 2074 7320  .        for ts 
-000266c0: 696e 2073 6f72 7465 6428 0a20 2020 2020  in sorted(.     
-000266d0: 2020 2020 2020 2072 756e 6e61 626c 652c         runnable,
-000266e0: 0a20 2020 2020 2020 2020 2020 206b 6579  .            key
-000266f0: 3d6f 7065 7261 746f 722e 6174 7472 6765  =operator.attrge
-00026700: 7474 6572 2822 7072 696f 7269 7479 2229  tter("priority")
-00026710: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
-00026720: 7665 7273 653d 5472 7565 2c0a 2020 2020  verse=True,.    
-00026730: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
-00026740: 2020 2061 7373 6572 7420 7473 2e70 7269     assert ts.pri
-00026750: 6f72 6974 7920 2023 206d 7970 790a 2020  ority  # mypy.  
-00026760: 2020 2020 2020 2020 2020 7072 696f 7269            priori
-00026770: 7479 5b74 732e 6b65 795d 203d 2074 732e  ty[ts.key] = ts.
-00026780: 7072 696f 7269 7479 0a20 2020 2020 2020  priority.       
-00026790: 2020 2020 2061 7373 6572 7420 7473 2e72       assert ts.r
-000267a0: 756e 5f73 7065 630a 2020 2020 2020 2020  un_spec.        
-000267b0: 2020 2020 6966 2074 732e 7374 6174 6520      if ts.state 
-000267c0: 3d3d 2022 7265 6c65 6173 6564 223a 0a20  == "released":. 
-000267d0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000267e0: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b74  ecommendations[t
-000267f0: 732e 6b65 795d 203d 2022 7761 6974 696e  s.key] = "waitin
-00026800: 6722 0a0a 2020 2020 2020 2020 666f 7220  g"..        for 
-00026810: 7473 2069 6e20 7275 6e6e 6162 6c65 3a0a  ts in runnable:.
-00026820: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00026830: 6474 7320 696e 2074 732e 6465 7065 6e64  dts in ts.depend
-00026840: 656e 6369 6573 3a0a 2020 2020 2020 2020  encies:.        
-00026850: 2020 2020 2020 2020 6966 2064 7473 2e65          if dts.e
-00026860: 7863 6570 7469 6f6e 5f62 6c61 6d65 3a0a  xception_blame:.
-00026870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026880: 2020 2020 7473 2e65 7863 6570 7469 6f6e      ts.exception
-00026890: 5f62 6c61 6d65 203d 2064 7473 2e65 7863  _blame = dts.exc
-000268a0: 6570 7469 6f6e 5f62 6c61 6d65 0a20 2020  eption_blame.   
-000268b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000268c0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-000268d0: 5b74 732e 6b65 795d 203d 2022 6572 7265  [ts.key] = "erre
-000268e0: 6422 0a20 2020 2020 2020 2020 2020 2020  d".             
-000268f0: 2020 2020 2020 2062 7265 616b 0a0a 2020         break..  
-00026900: 2020 2020 2020 7370 616e 735f 6578 743a        spans_ext:
-00026910: 2053 7061 6e73 5363 6865 6475 6c65 7245   SpansSchedulerE
-00026920: 7874 656e 7369 6f6e 207c 204e 6f6e 6520  xtension | None 
-00026930: 3d20 7365 6c66 2e65 7874 656e 7369 6f6e  = self.extension
-00026940: 732e 6765 7428 2273 7061 6e73 2229 0a20  s.get("spans"). 
-00026950: 2020 2020 2020 2069 6620 7370 616e 735f         if spans_
-00026960: 6578 743a 0a20 2020 2020 2020 2020 2020  ext:.           
-00026970: 2023 206e 6577 5f74 6173 6b73 2064 6f65   # new_tasks doe
-00026980: 7320 6e6f 7420 6e65 6365 7373 6172 696c  s not necessaril
-00026990: 7920 636f 6e74 6169 6e20 616c 6c20 7275  y contain all ru
-000269a0: 6e6e 6162 6c65 2074 6173 6b73 3b0a 2020  nnable tasks;.  
-000269b0: 2020 2020 2020 2020 2020 2320 5f67 656e            # _gen
-000269c0: 6572 6174 655f 7461 736b 7374 6174 6573  erate_taskstates
-000269d0: 2069 7320 6e6f 7420 7468 6520 6f6e 6c79   is not the only
-000269e0: 2074 6869 6e67 2074 6861 7420 6361 6c6c   thing that call
-000269f0: 7320 6e65 775f 7461 736b 2829 2e20 410a  s new_task(). A.
-00026a00: 2020 2020 2020 2020 2020 2020 2320 5461              # Ta
-00026a10: 736b 5374 6174 6520 6d61 7920 6861 7665  skState may have
-00026a20: 2061 6c73 6f20 6265 656e 2063 7265 6174   also been creat
-00026a30: 6564 2062 7920 636c 6965 6e74 5f64 6573  ed by client_des
-00026a40: 6972 6573 5f6b 6579 7320 6f72 2073 6361  ires_keys or sca
-00026a50: 7474 6572 2c0a 2020 2020 2020 2020 2020  tter,.          
-00026a60: 2020 2320 616e 6420 6f6e 6c79 206c 6174    # and only lat
-00026a70: 6572 2067 6169 6e65 6420 6120 7275 6e5f  er gained a run_
-00026a80: 7370 6563 2e0a 2020 2020 2020 2020 2020  spec..          
-00026a90: 2020 7370 616e 735f 6578 742e 6f62 7365    spans_ext.obse
-00026aa0: 7276 655f 7461 736b 7328 7275 6e6e 6162  rve_tasks(runnab
-00026ab0: 6c65 290a 2020 2020 2020 2020 2020 2020  le).            
-00026ac0: 2320 5461 736b 4772 6f75 702e 7370 616e  # TaskGroup.span
-00026ad0: 5f69 6420 636f 756c 6420 6265 2063 6f6d  _id could be com
-00026ae0: 706c 6574 656c 7920 6469 6666 6572 656e  pletely differen
-00026af0: 7420 6672 6f6d 2074 6865 206f 6e65 2069  t from the one i
-00026b00: 6e20 7468 650a 2020 2020 2020 2020 2020  n the.          
-00026b10: 2020 2320 6f72 6967 696e 616c 2061 6e6e    # original ann
-00026b20: 6f74 6174 696f 6e73 2c20 736f 2069 7420  otations, so it 
-00026b30: 6861 7320 6265 656e 2064 726f 7070 6564  has been dropped
-00026b40: 2e20 4472 6f70 2069 7420 6865 7265 2061  . Drop it here a
-00026b50: 7320 7765 6c6c 2069 6e0a 2020 2020 2020  s well in.      
-00026b60: 2020 2020 2020 2320 6f72 6465 7220 6e6f        # order no
-00026b70: 7420 746f 2063 6f6e 6675 7365 2053 6368  t to confuse Sch
-00026b80: 6564 756c 6572 506c 7567 696e 2061 7574  edulerPlugin aut
-00026b90: 686f 7273 2e0a 2020 2020 2020 2020 2020  hors..          
-00026ba0: 2020 7265 736f 6c76 6564 5f61 6e6e 6f74    resolved_annot
-00026bb0: 6174 696f 6e73 2e70 6f70 2822 7370 616e  ations.pop("span
-00026bc0: 222c 204e 6f6e 6529 0a0a 2020 2020 2020  ", None)..      
-00026bd0: 2020 666f 7220 706c 7567 696e 2069 6e20    for plugin in 
-00026be0: 6c69 7374 2873 656c 662e 706c 7567 696e  list(self.plugin
-00026bf0: 732e 7661 6c75 6573 2829 293a 0a20 2020  s.values()):.   
-00026c00: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00026c10: 2020 2020 2020 2020 2020 2020 2020 706c                pl
-00026c20: 7567 696e 2e75 7064 6174 655f 6772 6170  ugin.update_grap
-00026c30: 6828 0a20 2020 2020 2020 2020 2020 2020  h(.             
-00026c40: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-00026c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026c60: 2063 6c69 656e 743d 636c 6965 6e74 2c0a   client=client,.
-00026c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026c80: 2020 2020 7461 736b 733d 5b74 732e 6b65      tasks=[ts.ke
-00026c90: 7920 666f 7220 7473 2069 6e20 746f 7563  y for ts in touc
-00026ca0: 6865 645f 7461 736b 735d 2c0a 2020 2020  hed_tasks],.    
-00026cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026cc0: 6b65 7973 3d72 6571 7565 7374 6564 5f6b  keys=requested_k
-00026cd0: 6579 732c 0a20 2020 2020 2020 2020 2020  eys,.           
-00026ce0: 2020 2020 2020 2020 2064 6570 656e 6465           depende
-00026cf0: 6e63 6965 733d 6465 7065 6e64 656e 6369  ncies=dependenci
-00026d00: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-00026d10: 2020 2020 2020 2020 616e 6e6f 7461 7469          annotati
-00026d20: 6f6e 733d 7265 736f 6c76 6564 5f61 6e6e  ons=resolved_ann
-00026d30: 6f74 6174 696f 6e73 2c0a 2020 2020 2020  otations,.      
-00026d40: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00026d50: 696f 7269 7479 3d70 7269 6f72 6974 792c  iority=priority,
-00026d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00026d70: 2029 0a20 2020 2020 2020 2020 2020 2065   ).            e
-00026d80: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
-00026d90: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-00026da0: 2020 2020 2020 6c6f 6767 6572 2e65 7863        logger.exc
-00026db0: 6570 7469 6f6e 2865 290a 0a20 2020 2020  eption(e)..     
-00026dc0: 2020 2073 656c 662e 7472 616e 7369 7469     self.transiti
-00026dd0: 6f6e 7328 7265 636f 6d6d 656e 6461 7469  ons(recommendati
-00026de0: 6f6e 732c 2073 7469 6d75 6c75 735f 6964  ons, stimulus_id
-00026df0: 290a 0a20 2020 2020 2020 2066 6f72 2074  )..        for t
-00026e00: 7320 696e 2074 6f75 6368 6564 5f74 6173  s in touched_tas
-00026e10: 6b73 3a0a 2020 2020 2020 2020 2020 2020  ks:.            
-00026e20: 6966 2074 732e 7374 6174 6520 696e 2028  if ts.state in (
-00026e30: 226d 656d 6f72 7922 2c20 2265 7272 6564  "memory", "erred
-00026e40: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
-00026e50: 2020 2020 7365 6c66 2e72 6570 6f72 745f      self.report_
-00026e60: 6f6e 5f6b 6579 2874 733d 7473 2c20 636c  on_key(ts=ts, cl
-00026e70: 6965 6e74 3d63 6c69 656e 7429 0a0a 2020  ient=client)..  
-00026e80: 2020 2020 2020 656e 6420 3d20 7469 6d65        end = time
-00026e90: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-00026ea0: 6469 6765 7374 5f6d 6574 7269 6328 2275  digest_metric("u
-00026eb0: 7064 6174 652d 6772 6170 682d 6475 7261  pdate-graph-dura
-00026ec0: 7469 6f6e 222c 2065 6e64 202d 2073 7461  tion", end - sta
-00026ed0: 7274 290a 0a20 2020 2064 6566 205f 6765  rt)..    def _ge
-00026ee0: 6e65 7261 7465 5f74 6173 6b73 7461 7465  nerate_taskstate
-00026ef0: 7328 0a20 2020 2020 2020 2073 656c 662c  s(.        self,
-00026f00: 206b 6579 733a 2073 6574 5b73 7472 5d2c   keys: set[str],
-00026f10: 2064 736b 3a20 6469 6374 2c20 6465 7065   dsk: dict, depe
-00026f20: 6e64 656e 6369 6573 3a20 6469 6374 2c20  ndencies: dict, 
-00026f30: 636f 6d70 7574 6174 696f 6e3a 2043 6f6d  computation: Com
-00026f40: 7075 7461 7469 6f6e 0a20 2020 2029 202d  putation.    ) -
-00026f50: 3e20 7475 706c 653a 0a20 2020 2020 2020  > tuple:.       
-00026f60: 2023 2047 6574 206f 7220 6372 6561 7465   # Get or create
-00026f70: 2074 6173 6b20 7374 6174 6573 0a20 2020   task states.   
-00026f80: 2020 2020 2072 756e 6e61 626c 6520 3d20       runnable = 
-00026f90: 5b5d 0a20 2020 2020 2020 206e 6577 5f74  [].        new_t
-00026fa0: 6173 6b73 203d 205b 5d0a 2020 2020 2020  asks = [].      
-00026fb0: 2020 7374 6163 6b20 3d20 6c69 7374 286b    stack = list(k
-00026fc0: 6579 7329 0a20 2020 2020 2020 2074 6f75  eys).        tou
-00026fd0: 6368 6564 5f6b 6579 7320 3d20 7365 7428  ched_keys = set(
-00026fe0: 290a 2020 2020 2020 2020 746f 7563 6865  ).        touche
-00026ff0: 645f 7461 736b 7320 3d20 5b5d 0a20 2020  d_tasks = [].   
-00027000: 2020 2020 2077 6869 6c65 2073 7461 636b       while stack
-00027010: 3a0a 2020 2020 2020 2020 2020 2020 6b20  :.            k 
-00027020: 3d20 7374 6163 6b2e 706f 7028 290a 2020  = stack.pop().  
-00027030: 2020 2020 2020 2020 2020 6966 206b 2069            if k i
-00027040: 6e20 746f 7563 6865 645f 6b65 7973 3a0a  n touched_keys:.
-00027050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027060: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
-00027070: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
-00027080: 6173 6b73 2e67 6574 286b 290a 2020 2020  asks.get(k).    
-00027090: 2020 2020 2020 2020 6966 2074 7320 6973          if ts is
-000270a0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-000270b0: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-000270c0: 2e6e 6577 5f74 6173 6b28 6b2c 2064 736b  .new_task(k, dsk
-000270d0: 2e67 6574 286b 292c 2022 7265 6c65 6173  .get(k), "releas
-000270e0: 6564 222c 2063 6f6d 7075 7461 7469 6f6e  ed", computation
-000270f0: 3d63 6f6d 7075 7461 7469 6f6e 290a 2020  =computation).  
-00027100: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
-00027110: 775f 7461 736b 732e 6170 7065 6e64 2874  w_tasks.append(t
-00027120: 7329 0a20 2020 2020 2020 2020 2020 2065  s).            e
-00027130: 6c69 6620 6e6f 7420 7473 2e72 756e 5f73  lif not ts.run_s
-00027140: 7065 633a 0a20 2020 2020 2020 2020 2020  pec:.           
-00027150: 2020 2020 2074 732e 7275 6e5f 7370 6563       ts.run_spec
-00027160: 203d 2064 736b 2e67 6574 286b 290a 0a20   = dsk.get(k).. 
-00027170: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
-00027180: 2e72 756e 5f73 7065 633a 0a20 2020 2020  .run_spec:.     
-00027190: 2020 2020 2020 2020 2020 2072 756e 6e61             runna
-000271a0: 626c 652e 6170 7065 6e64 2874 7329 0a20  ble.append(ts). 
-000271b0: 2020 2020 2020 2020 2020 2074 6f75 6368             touch
-000271c0: 6564 5f6b 6579 732e 6164 6428 6b29 0a20  ed_keys.add(k). 
-000271d0: 2020 2020 2020 2020 2020 2074 6f75 6368             touch
-000271e0: 6564 5f74 6173 6b73 2e61 7070 656e 6428  ed_tasks.append(
-000271f0: 7473 290a 2020 2020 2020 2020 2020 2020  ts).            
-00027200: 7374 6163 6b2e 6578 7465 6e64 2864 6570  stack.extend(dep
-00027210: 656e 6465 6e63 6965 732e 6765 7428 6b2c  endencies.get(k,
-00027220: 2028 2929 290a 0a20 2020 2020 2020 2023   ()))..        #
-00027230: 2041 6464 2064 6570 656e 6465 6e63 6965   Add dependencie
-00027240: 730a 2020 2020 2020 2020 666f 7220 6b65  s.        for ke
-00027250: 792c 2064 6570 7320 696e 2064 6570 656e  y, deps in depen
-00027260: 6465 6e63 6965 732e 6974 656d 7328 293a  dencies.items():
-00027270: 0a20 2020 2020 2020 2020 2020 2074 7320  .            ts 
-00027280: 3d20 7365 6c66 2e74 6173 6b73 2e67 6574  = self.tasks.get
-00027290: 286b 6579 290a 2020 2020 2020 2020 2020  (key).          
-000272a0: 2020 6966 2074 7320 6973 204e 6f6e 6520    if ts is None 
-000272b0: 6f72 2074 732e 6465 7065 6e64 656e 6369  or ts.dependenci
-000272c0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-000272d0: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
-000272e0: 2020 2020 2020 2020 2066 6f72 2064 6570           for dep
-000272f0: 2069 6e20 6465 7073 3a0a 2020 2020 2020   in deps:.      
-00027300: 2020 2020 2020 2020 2020 6474 7320 3d20            dts = 
-00027310: 7365 6c66 2e74 6173 6b73 5b64 6570 5d0a  self.tasks[dep].
-00027320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027330: 7473 2e61 6464 5f64 6570 656e 6465 6e63  ts.add_dependenc
-00027340: 7928 6474 7329 0a0a 2020 2020 2020 2020  y(dts)..        
-00027350: 6966 206c 656e 2874 6f75 6368 6564 5f74  if len(touched_t
-00027360: 6173 6b73 2920 3c20 6c65 6e28 6b65 7973  asks) < len(keys
-00027370: 293a 0a20 2020 2020 2020 2020 2020 206c  ):.            l
-00027380: 6f67 6765 722e 696e 666f 280a 2020 2020  ogger.info(.    
-00027390: 2020 2020 2020 2020 2020 2020 2253 7562              "Sub
-000273a0: 6d69 7474 6564 2067 7261 7068 2077 6974  mitted graph wit
-000273b0: 6820 6c65 6e67 7468 2025 7320 6275 7420  h length %s but 
-000273c0: 7265 7175 6573 7465 6420 6772 6170 6820  requested graph 
-000273d0: 6f6e 6c79 2069 6e63 6c75 6465 7320 2573  only includes %s
-000273e0: 206b 6579 7322 2c0a 2020 2020 2020 2020   keys",.        
-000273f0: 2020 2020 2020 2020 6c65 6e28 746f 7563          len(touc
-00027400: 6865 645f 7461 736b 7329 2c0a 2020 2020  hed_tasks),.    
-00027410: 2020 2020 2020 2020 2020 2020 6c65 6e28              len(
-00027420: 6b65 7973 292c 0a20 2020 2020 2020 2020  keys),.         
-00027430: 2020 2029 0a20 2020 2020 2020 2072 6574     ).        ret
-00027440: 7572 6e20 7275 6e6e 6162 6c65 2c20 746f  urn runnable, to
-00027450: 7563 6865 645f 7461 736b 732c 206e 6577  uched_tasks, new
-00027460: 5f74 6173 6b73 0a0a 2020 2020 6465 6620  _tasks..    def 
-00027470: 5f70 6172 7365 5f61 6e64 5f61 7070 6c79  _parse_and_apply
-00027480: 5f61 6e6e 6f74 6174 696f 6e73 280a 2020  _annotations(.  
-00027490: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-000274a0: 2020 2020 7461 736b 733a 2049 7465 7261      tasks: Itera
-000274b0: 626c 655b 5461 736b 5374 6174 655d 2c0a  ble[TaskState],.
-000274c0: 2020 2020 2020 2020 616e 6e6f 7461 7469          annotati
-000274d0: 6f6e 733a 2064 6963 742c 0a20 2020 2020  ons: dict,.     
-000274e0: 2020 206c 6179 6572 5f61 6e6e 6f74 6174     layer_annotat
-000274f0: 696f 6e73 3a20 6469 6374 5b73 7472 2c20  ions: dict[str, 
-00027500: 6469 6374 5d2c 0a20 2020 2020 2020 2070  dict],.        p
-00027510: 7265 5f73 7472 696e 6769 6669 6564 5f6b  re_stringified_k
-00027520: 6579 733a 2064 6963 745b 4861 7368 6162  eys: dict[Hashab
-00027530: 6c65 2c20 7374 725d 2c0a 2020 2020 2920  le, str],.    ) 
-00027540: 2d3e 2064 6963 745b 7374 722c 2064 6963  -> dict[str, dic
-00027550: 745b 7374 722c 2041 6e79 5d5d 3a0a 2020  t[str, Any]]:.  
-00027560: 2020 2020 2020 2222 2241 7070 6c79 2074        """Apply t
-00027570: 6865 2070 726f 7669 6465 6420 616e 6e6f  he provided anno
-00027580: 7461 7469 6f6e 7320 746f 2074 6865 2070  tations to the p
-00027590: 726f 7669 6465 6420 6054 6173 6b53 7461  rovided `TaskSta
-000275a0: 7465 6020 6f62 6a65 6374 732e 0a0a 2020  te` objects...  
-000275b0: 2020 2020 2020 5468 6520 7261 7720 616e        The raw an
-000275c0: 6e6f 7461 7469 6f6e 7320 7769 6c6c 2062  notations will b
-000275d0: 6520 7374 6f72 6564 2069 6e20 7468 6520  e stored in the 
-000275e0: 6061 6e6e 6f74 6174 696f 6e73 6020 6174  `annotations` at
-000275f0: 7472 6962 7574 652e 0a0a 2020 2020 2020  tribute...      
-00027600: 2020 4c61 7965 7220 2f20 6b65 7920 7370    Layer / key sp
-00027610: 6563 6966 6963 2061 6e6e 6f74 6174 696f  ecific annotatio
-00027620: 6e73 2077 696c 6c20 7461 6b65 2070 7265  ns will take pre
-00027630: 6365 6465 6e63 6520 6f76 6572 2067 6c6f  cedence over glo
-00027640: 6261 6c20 2f20 6765 6e65 7269 6320 616e  bal / generic an
-00027650: 6e6f 7461 7469 6f6e 732e 0a0a 2020 2020  notations...    
-00027660: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-00027670: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d2d         ---------
-00027680: 2d0a 2020 2020 2020 2020 7461 736b 7320  -.        tasks 
-00027690: 3a20 4974 6572 6162 6c65 5b54 6173 6b53  : Iterable[TaskS
-000276a0: 7461 7465 5d0a 2020 2020 2020 2020 2020  tate].          
-000276b0: 2020 5f64 6573 6372 6970 7469 6f6e 5f0a    _description_.
-000276c0: 2020 2020 2020 2020 616e 6e6f 7461 7469          annotati
-000276d0: 6f6e 7320 3a20 6469 6374 0a20 2020 2020  ons : dict.     
-000276e0: 2020 2020 2020 205f 6465 7363 7269 7074         _descript
-000276f0: 696f 6e5f 0a20 2020 2020 2020 206c 6179  ion_.        lay
-00027700: 6572 5f61 6e6e 6f74 6174 696f 6e73 203a  er_annotations :
-00027710: 2064 6963 745b 7374 722c 2064 6963 745d   dict[str, dict]
-00027720: 0a20 2020 2020 2020 2020 2020 205f 6465  .            _de
-00027730: 7363 7269 7074 696f 6e5f 0a0a 2020 2020  scription_..    
-00027740: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-00027750: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-00027760: 2020 2020 7265 736f 6c76 6564 5f61 6e6e      resolved_ann
-00027770: 6f74 6174 696f 6e73 3a20 6469 6374 0a20  otations: dict. 
-00027780: 2020 2020 2020 2020 2020 2041 206d 6170             A map
-00027790: 7069 6e67 206f 6620 616c 6c20 7265 736f  ping of all reso
-000277a0: 6c76 6564 2061 6e6e 6f74 6174 696f 6e73  lved annotations
-000277b0: 2069 6e20 7468 6520 666f 726d 6174 3a3a   in the format::
-000277c0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000277d0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-000277e0: 2020 2020 2020 2020 2261 6e6e 6f74 6174          "annotat
-000277f0: 696f 6e22 3a20 7b0a 2020 2020 2020 2020  ion": {.        
-00027800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027810: 226b 6579 223a 2076 616c 7565 2c0a 2020  "key": value,.  
-00027820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027830: 2020 2020 2020 2e2e 2e0a 2020 2020 2020        ....      
-00027840: 2020 2020 2020 2020 2020 2020 2020 7d2c                },
-00027850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027860: 2020 2020 202e 2e2e 0a20 2020 2020 2020       ....       
-00027870: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00027880: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
-00027890: 6573 6f6c 7665 645f 616e 6e6f 7461 7469  esolved_annotati
-000278a0: 6f6e 733a 2064 6566 6175 6c74 6469 6374  ons: defaultdict
-000278b0: 5b73 7472 2c20 6469 6374 5b73 7472 2c20  [str, dict[str, 
-000278c0: 416e 795d 5d20 3d20 6465 6661 756c 7464  Any]] = defaultd
-000278d0: 6963 7428 6469 6374 290a 2020 2020 2020  ict(dict).      
-000278e0: 2020 666f 7220 7473 2069 6e20 7461 736b    for ts in task
-000278f0: 733a 0a20 2020 2020 2020 2020 2020 206b  s:.            k
-00027900: 6579 203d 2074 732e 6b65 790a 2020 2020  ey = ts.key.    
-00027910: 2020 2020 2020 2020 2320 5468 6973 2063          # This c
-00027920: 6f75 6c64 2062 6520 6120 7479 7065 6420  ould be a typed 
-00027930: 6469 6374 0a20 2020 2020 2020 2020 2020  dict.           
-00027940: 2069 6620 6e6f 7420 616e 6e6f 7461 7469   if not annotati
-00027950: 6f6e 7320 616e 6420 6b65 7920 6e6f 7420  ons and key not 
-00027960: 696e 206c 6179 6572 5f61 6e6e 6f74 6174  in layer_annotat
-00027970: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
-00027980: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
-00027990: 2020 2020 2020 2020 2020 206f 7574 203d             out =
-000279a0: 2061 6e6e 6f74 6174 696f 6e73 2e63 6f70   annotations.cop
-000279b0: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
-000279c0: 6f75 742e 7570 6461 7465 286c 6179 6572  out.update(layer
-000279d0: 5f61 6e6e 6f74 6174 696f 6e73 2e67 6574  _annotations.get
-000279e0: 286b 6579 2c20 7b7d 2929 0a20 2020 2020  (key, {})).     
-000279f0: 2020 2020 2020 2066 6f72 2061 6e6e 6f74         for annot
-00027a00: 2c20 7661 6c75 6520 696e 206f 7574 2e69  , value in out.i
-00027a10: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
-00027a20: 2020 2020 2020 2020 2320 506f 7020 7468          # Pop th
-00027a30: 6520 6b65 7920 7369 6e63 6520 6e61 6d65  e key since name
-00027a40: 7320 646f 6e27 7420 616c 7761 7973 206d  s don't always m
-00027a50: 6174 6368 2061 7474 7269 6275 7465 730a  atch attributes.
-00027a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027a70: 6966 2063 616c 6c61 626c 6528 7661 6c75  if callable(valu
-00027a80: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-00027a90: 2020 2020 2020 2020 7661 6c75 6520 3d20          value = 
-00027aa0: 7661 6c75 6528 7072 655f 7374 7269 6e67  value(pre_string
-00027ab0: 6966 6965 645f 6b65 7973 5b6b 6579 5d29  ified_keys[key])
-00027ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027ad0: 206f 7574 5b61 6e6e 6f74 5d20 3d20 7661   out[annot] = va
-00027ae0: 6c75 650a 2020 2020 2020 2020 2020 2020  lue.            
-00027af0: 2020 2020 7265 736f 6c76 6564 5f61 6e6e      resolved_ann
-00027b00: 6f74 6174 696f 6e73 5b61 6e6e 6f74 5d5b  otations[annot][
-00027b10: 6b65 795d 203d 2076 616c 7565 0a0a 2020  key] = value..  
-00027b20: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00027b30: 2061 6e6e 6f74 2069 6e20 2822 7265 7374   annot in ("rest
-00027b40: 7269 6374 696f 6e73 222c 2022 776f 726b  rictions", "work
-00027b50: 6572 7322 293a 0a20 2020 2020 2020 2020  ers"):.         
-00027b60: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00027b70: 7420 6973 696e 7374 616e 6365 2876 616c  t isinstance(val
-00027b80: 7565 2c20 286c 6973 742c 2074 7570 6c65  ue, (list, tuple
-00027b90: 2c20 7365 7429 293a 0a20 2020 2020 2020  , set)):.       
-00027ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027bb0: 2076 616c 7565 203d 205b 7661 6c75 655d   value = [value]
-00027bc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027bd0: 2020 2020 2068 6f73 745f 7265 7374 7269       host_restri
-00027be0: 6374 696f 6e73 203d 2073 6574 2829 0a20  ctions = set(). 
-00027bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027c00: 2020 2077 6f72 6b65 725f 7265 7374 7269     worker_restri
-00027c10: 6374 696f 6e73 203d 2073 6574 2829 0a20  ctions = set(). 
+00025a90: 4572 726f 7220 6475 7269 6e67 2064 6573  Error during des
+00025aa0: 6572 6961 6c69 7a61 7469 6f6e 206f 6620  erialization of 
+00025ab0: 7468 6520 7461 736b 2067 7261 7068 2e20  the task graph. 
+00025ac0: 5468 6973 2066 7265 7175 656e 746c 7920  This frequently 
+00025ad0: 6f63 6375 7273 2069 6620 7468 6520 5363  occurs if the Sc
+00025ae0: 6865 6475 6c65 7220 616e 6420 436c 6965  heduler and Clie
+00025af0: 6e74 2068 6176 6520 6469 6666 6572 656e  nt have differen
+00025b00: 7420 656e 7669 726f 6e6d 656e 7473 2e20  t environments. 
+00025b10: 466f 7220 6d6f 7265 2069 6e66 6f72 6d61  For more informa
+00025b20: 7469 6f6e 2c20 7365 6520 6874 7470 733a  tion, see https:
+00025b30: 2f2f 646f 6373 2e64 6173 6b2e 6f72 672f  //docs.dask.org/
+00025b40: 656e 2f73 7461 626c 652f 6465 706c 6f79  en/stable/deploy
+00025b50: 6d65 6e74 2d63 6f6e 7369 6465 7261 7469  ment-considerati
+00025b60: 6f6e 732e 6874 6d6c 2363 6f6e 7369 7374  ons.html#consist
+00025b70: 656e 742d 736f 6674 7761 7265 2d65 6e76  ent-software-env
+00025b80: 6972 6f6e 6d65 6e74 730a 2020 2020 2020  ironments.      
+00025b90: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00025ba0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00025bb0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00025bc0: 2052 756e 7469 6d65 4572 726f 7228 7465   RuntimeError(te
+00025bd0: 7874 7772 6170 2e64 6564 656e 7428 6d73  xtwrap.dedent(ms
+00025be0: 6729 2920 6672 6f6d 2065 0a20 2020 2020  g)) from e.     
+00025bf0: 2020 2020 2020 2065 7863 6570 7420 5275         except Ru
+00025c00: 6e74 696d 6545 7272 6f72 2061 7320 653a  ntimeError as e:
+00025c10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025c20: 2065 7272 203d 2065 7272 6f72 5f6d 6573   err = error_mes
+00025c30: 7361 6765 2865 290a 2020 2020 2020 2020  sage(e).        
+00025c40: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
+00025c50: 696e 206b 6579 733a 0a20 2020 2020 2020  in keys:.       
+00025c60: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00025c70: 662e 7265 706f 7274 280a 2020 2020 2020  f.report(.      
+00025c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025c90: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00025ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025cb0: 226f 7022 3a20 2274 6173 6b2d 6572 7265  "op": "task-erre
+00025cc0: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
+00025cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025ce0: 226b 6579 223a 206b 6579 2c0a 2020 2020  "key": key,.    
+00025cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025d00: 2020 2020 2020 2020 2265 7863 6570 7469          "excepti
+00025d10: 6f6e 223a 2065 7272 5b22 6578 6365 7074  on": err["except
+00025d20: 696f 6e22 5d2c 0a20 2020 2020 2020 2020  ion"],.         
+00025d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025d40: 2020 2022 7472 6163 6562 6163 6b22 3a20     "traceback": 
+00025d50: 6572 725b 2274 7261 6365 6261 636b 225d  err["traceback"]
+00025d60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00025d70: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00025d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025d90: 290a 0a20 2020 2020 2020 2020 2020 2072  )..            r
+00025da0: 6574 7572 6e0a 2020 2020 2020 2020 616e  eturn.        an
+00025db0: 6e6f 7461 7469 6f6e 7320 3d20 616e 6e6f  notations = anno
+00025dc0: 7461 7469 6f6e 7320 6f72 207b 7d0a 2020  tations or {}.  
+00025dd0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00025de0: 6e63 6528 616e 6e6f 7461 7469 6f6e 732c  nce(annotations,
+00025df0: 2054 6f50 6963 6b6c 6529 3a20 2023 2074   ToPickle):  # t
+00025e00: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
+00025e10: 2020 2020 2020 2020 2320 4649 584d 453a          # FIXME:
+00025e20: 2077 6861 7420 7468 6520 6865 636b 3f0a   what the heck?.
+00025e30: 2020 2020 2020 2020 2020 2020 616e 6e6f              anno
+00025e40: 7461 7469 6f6e 7320 3d20 616e 6e6f 7461  tations = annota
+00025e50: 7469 6f6e 732e 6461 7461 2020 2320 7479  tions.data  # ty
+00025e60: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
+00025e70: 2020 2073 7469 6d75 6c75 735f 6964 203d     stimulus_id =
+00025e80: 2073 7469 6d75 6c75 735f 6964 206f 7220   stimulus_id or 
+00025e90: 6622 7570 6461 7465 2d67 7261 7068 2d7b  f"update-graph-{
+00025ea0: 7469 6d65 2829 7d22 0a20 2020 2020 2020  time()}".       
+00025eb0: 2028 0a20 2020 2020 2020 2020 2020 2064   (.            d
+00025ec0: 736b 2c0a 2020 2020 2020 2020 2020 2020  sk,.            
+00025ed0: 6465 7065 6e64 656e 6369 6573 2c0a 2020  dependencies,.  
+00025ee0: 2020 2020 2020 2020 2020 6c61 7965 725f            layer_
+00025ef0: 616e 6e6f 7461 7469 6f6e 732c 0a20 2020  annotations,.   
+00025f00: 2020 2020 2020 2020 2070 7265 5f73 7472           pre_str
+00025f10: 696e 6769 6669 6564 5f6b 6579 732c 0a20  ingified_keys,. 
+00025f20: 2020 2020 2020 2029 203d 2073 656c 662e         ) = self.
+00025f30: 6d61 7465 7269 616c 697a 655f 6772 6170  materialize_grap
+00025f40: 6828 6772 6170 6829 0a0a 2020 2020 2020  h(graph)..      
+00025f50: 2020 7265 7175 6573 7465 645f 6b65 7973    requested_keys
+00025f60: 203d 2073 6574 286b 6579 7329 0a20 2020   = set(keys).   
+00025f70: 2020 2020 2064 656c 206b 6579 730a 2020       del keys.  
+00025f80: 2020 2020 2020 6966 206c 656e 2864 736b        if len(dsk
+00025f90: 2920 3e20 313a 0a20 2020 2020 2020 2020  ) > 1:.         
+00025fa0: 2020 2073 656c 662e 6c6f 675f 6576 656e     self.log_even
+00025fb0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+00025fc0: 2020 205b 2261 6c6c 222c 2063 6c69 656e     ["all", clien
+00025fd0: 745d 2c20 7b22 6163 7469 6f6e 223a 2022  t], {"action": "
+00025fe0: 7570 6461 7465 5f67 7261 7068 222c 2022  update_graph", "
+00025ff0: 636f 756e 7422 3a20 6c65 6e28 6473 6b29  count": len(dsk)
+00026000: 7d0a 2020 2020 2020 2020 2020 2020 290a  }.            ).
+00026010: 2020 2020 2020 2020 7365 6c66 2e5f 706f          self._po
+00026020: 705f 6b6e 6f77 6e5f 7461 736b 7328 6473  p_known_tasks(ds
+00026030: 6b2c 2064 6570 656e 6465 6e63 6965 7329  k, dependencies)
+00026040: 0a0a 2020 2020 2020 2020 6966 206c 6f73  ..        if los
+00026050: 745f 6b65 7973 203a 3d20 7365 6c66 2e5f  t_keys := self._
+00026060: 706f 705f 6c6f 7374 5f74 6173 6b73 2864  pop_lost_tasks(d
+00026070: 736b 2c20 6465 7065 6e64 656e 6369 6573  sk, dependencies
+00026080: 2c20 7265 7175 6573 7465 645f 6b65 7973  , requested_keys
+00026090: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+000260a0: 656c 662e 7265 706f 7274 287b 226f 7022  elf.report({"op"
+000260b0: 3a20 2263 616e 6365 6c6c 6564 2d6b 6579  : "cancelled-key
+000260c0: 7322 2c20 226b 6579 7322 3a20 6c6f 7374  s", "keys": lost
+000260d0: 5f6b 6579 737d 2c20 636c 6965 6e74 3d63  _keys}, client=c
+000260e0: 6c69 656e 7429 0a20 2020 2020 2020 2020  lient).         
+000260f0: 2020 2073 656c 662e 636c 6965 6e74 5f72     self.client_r
+00026100: 656c 6561 7365 735f 6b65 7973 280a 2020  eleases_keys(.  
+00026110: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
+00026120: 7973 3d6c 6f73 745f 6b65 7973 2c20 636c  ys=lost_keys, cl
+00026130: 6965 6e74 3d63 6c69 656e 742c 2073 7469  ient=client, sti
+00026140: 6d75 6c75 735f 6964 3d73 7469 6d75 6c75  mulus_id=stimulu
+00026150: 735f 6964 0a20 2020 2020 2020 2020 2020  s_id.           
+00026160: 2029 0a0a 2020 2020 2020 2020 6966 206e   )..        if n
+00026170: 6f74 2073 656c 662e 6973 5f69 646c 6520  ot self.is_idle 
+00026180: 616e 6420 7365 6c66 2e63 6f6d 7075 7461  and self.computa
+00026190: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
+000261a0: 2020 2023 2053 7469 6c6c 2077 6f72 6b69     # Still worki
+000261b0: 6e67 206f 6e20 736f 6d65 7468 696e 672e  ng on something.
+000261c0: 2041 7373 6967 6e20 6e65 7720 7461 736b   Assign new task
+000261d0: 7320 746f 2073 616d 6520 636f 6d70 7574  s to same comput
+000261e0: 6174 696f 6e0a 2020 2020 2020 2020 2020  ation.          
+000261f0: 2020 636f 6d70 7574 6174 696f 6e20 3d20    computation = 
+00026200: 7365 6c66 2e63 6f6d 7075 7461 7469 6f6e  self.computation
+00026210: 735b 2d31 5d0a 2020 2020 2020 2020 656c  s[-1].        el
+00026220: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00026230: 636f 6d70 7574 6174 696f 6e20 3d20 436f  computation = Co
+00026240: 6d70 7574 6174 696f 6e28 290a 2020 2020  mputation().    
+00026250: 2020 2020 2020 2020 7365 6c66 2e63 6f6d          self.com
+00026260: 7075 7461 7469 6f6e 732e 6170 7065 6e64  putations.append
+00026270: 2863 6f6d 7075 7461 7469 6f6e 290a 0a20  (computation).. 
+00026280: 2020 2020 2020 2069 6620 636f 6465 3a20         if code: 
+00026290: 2023 2061 6464 206e 6577 2063 6f64 6520   # add new code 
+000262a0: 626c 6f63 6b73 0a20 2020 2020 2020 2020  blocks.         
+000262b0: 2020 2063 6f6d 7075 7461 7469 6f6e 2e63     computation.c
+000262c0: 6f64 652e 6164 6428 636f 6465 290a 2020  ode.add(code).  
+000262d0: 2020 2020 2020 6966 2061 6e6e 6f74 6174        if annotat
+000262e0: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
+000262f0: 2020 636f 6d70 7574 6174 696f 6e2e 616e    computation.an
+00026300: 6e6f 7461 7469 6f6e 732e 7570 6461 7465  notations.update
+00026310: 2861 6e6e 6f74 6174 696f 6e73 290a 0a20  (annotations).. 
+00026320: 2020 2020 2020 2072 756e 6e61 626c 652c         runnable,
+00026330: 2074 6f75 6368 6564 5f74 6173 6b73 2c20   touched_tasks, 
+00026340: 6e65 775f 7461 736b 7320 3d20 7365 6c66  new_tasks = self
+00026350: 2e5f 6765 6e65 7261 7465 5f74 6173 6b73  ._generate_tasks
+00026360: 7461 7465 7328 0a20 2020 2020 2020 2020  tates(.         
+00026370: 2020 206b 6579 733d 7265 7175 6573 7465     keys=requeste
+00026380: 645f 6b65 7973 2c0a 2020 2020 2020 2020  d_keys,.        
+00026390: 2020 2020 6473 6b3d 6473 6b2c 0a20 2020      dsk=dsk,.   
+000263a0: 2020 2020 2020 2020 2064 6570 656e 6465           depende
+000263b0: 6e63 6965 733d 6465 7065 6e64 656e 6369  ncies=dependenci
+000263c0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+000263d0: 636f 6d70 7574 6174 696f 6e3d 636f 6d70  computation=comp
+000263e0: 7574 6174 696f 6e2c 0a20 2020 2020 2020  utation,.       
+000263f0: 2029 0a20 2020 2020 2020 2023 2046 4958   ).        # FIX
+00026400: 4d45 3a20 5468 6573 6520 2272 6573 6f6c  ME: These "resol
+00026410: 7665 645f 616e 6e6f 7461 7469 6f6e 7322  ved_annotations"
+00026420: 2061 7265 2061 2062 6967 2064 7570 6c69   are a big dupli
+00026430: 6361 7469 6f6e 2061 6e64 2061 7265 206f  cation and are o
+00026440: 6e6c 790a 2020 2020 2020 2020 2320 7265  nly.        # re
+00026450: 7175 6972 6564 2074 6f20 7361 7469 7366  quired to satisf
+00026460: 7920 7468 6520 6375 7272 656e 7420 706c  y the current pl
+00026470: 7567 696e 2041 5049 2e20 5468 6973 2073  ugin API. This s
+00026480: 686f 756c 6420 6265 0a20 2020 2020 2020  hould be.       
+00026490: 2023 2072 6563 6f6e 7369 6465 7265 642e   # reconsidered.
+000264a0: 0a20 2020 2020 2020 2072 6573 6f6c 7665  .        resolve
+000264b0: 645f 616e 6e6f 7461 7469 6f6e 7320 3d20  d_annotations = 
+000264c0: 7365 6c66 2e5f 7061 7273 655f 616e 645f  self._parse_and_
+000264d0: 6170 706c 795f 616e 6e6f 7461 7469 6f6e  apply_annotation
+000264e0: 7328 0a20 2020 2020 2020 2020 2020 2074  s(.            t
+000264f0: 6173 6b73 3d6e 6577 5f74 6173 6b73 2c0a  asks=new_tasks,.
+00026500: 2020 2020 2020 2020 2020 2020 616e 6e6f              anno
+00026510: 7461 7469 6f6e 733d 616e 6e6f 7461 7469  tations=annotati
+00026520: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+00026530: 206c 6179 6572 5f61 6e6e 6f74 6174 696f   layer_annotatio
+00026540: 6e73 3d6c 6179 6572 5f61 6e6e 6f74 6174  ns=layer_annotat
+00026550: 696f 6e73 2c0a 2020 2020 2020 2020 2020  ions,.          
+00026560: 2020 7072 655f 7374 7269 6e67 6966 6965    pre_stringifie
+00026570: 645f 6b65 7973 3d70 7265 5f73 7472 696e  d_keys=pre_strin
+00026580: 6769 6669 6564 5f6b 6579 732c 0a20 2020  gified_keys,.   
+00026590: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+000265a0: 7365 6c66 2e5f 7365 745f 7072 696f 7269  self._set_priori
+000265b0: 7469 6573 280a 2020 2020 2020 2020 2020  ties(.          
+000265c0: 2020 696e 7465 726e 616c 5f70 7269 6f72    internal_prior
+000265d0: 6974 793d 696e 7465 726e 616c 5f70 7269  ity=internal_pri
+000265e0: 6f72 6974 792c 0a20 2020 2020 2020 2020  ority,.         
+000265f0: 2020 2073 7562 6d69 7474 696e 675f 7461     submitting_ta
+00026600: 736b 3d73 7562 6d69 7474 696e 675f 7461  sk=submitting_ta
+00026610: 736b 2c0a 2020 2020 2020 2020 2020 2020  sk,.            
+00026620: 7573 6572 5f70 7269 6f72 6974 793d 7573  user_priority=us
+00026630: 6572 5f70 7269 6f72 6974 792c 0a20 2020  er_priority,.   
+00026640: 2020 2020 2020 2020 2066 6966 6f5f 7469           fifo_ti
+00026650: 6d65 6f75 743d 6669 666f 5f74 696d 656f  meout=fifo_timeo
+00026660: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
+00026670: 7374 6172 743d 7374 6172 742c 0a20 2020  start=start,.   
+00026680: 2020 2020 2020 2020 2064 736b 3d64 736b           dsk=dsk
+00026690: 2c0a 2020 2020 2020 2020 2020 2020 7461  ,.            ta
+000266a0: 736b 733d 7275 6e6e 6162 6c65 2c0a 2020  sks=runnable,.  
+000266b0: 2020 2020 2020 2020 2020 6465 7065 6e64            depend
+000266c0: 656e 6369 6573 3d64 6570 656e 6465 6e63  encies=dependenc
+000266d0: 6965 732c 0a20 2020 2020 2020 2029 0a0a  ies,.        )..
+000266e0: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
+000266f0: 656e 745f 6465 7369 7265 735f 6b65 7973  ent_desires_keys
+00026700: 286b 6579 733d 7265 7175 6573 7465 645f  (keys=requested_
+00026710: 6b65 7973 2c20 636c 6965 6e74 3d63 6c69  keys, client=cli
+00026720: 656e 7429 0a0a 2020 2020 2020 2020 2320  ent)..        # 
+00026730: 4164 6420 6163 746f 7273 0a20 2020 2020  Add actors.     
+00026740: 2020 2069 6620 6163 746f 7273 2069 7320     if actors is 
+00026750: 5472 7565 3a0a 2020 2020 2020 2020 2020  True:.          
+00026760: 2020 6163 746f 7273 203d 206c 6973 7428    actors = list(
+00026770: 7265 7175 6573 7465 645f 6b65 7973 290a  requested_keys).
+00026780: 2020 2020 2020 2020 666f 7220 6163 746f          for acto
+00026790: 7220 696e 2061 6374 6f72 7320 6f72 205b  r in actors or [
+000267a0: 5d3a 0a20 2020 2020 2020 2020 2020 2074  ]:.            t
+000267b0: 7320 3d20 7365 6c66 2e74 6173 6b73 5b61  s = self.tasks[a
+000267c0: 6374 6f72 5d0a 2020 2020 2020 2020 2020  ctor].          
+000267d0: 2020 7473 2e61 6374 6f72 203d 2054 7275    ts.actor = Tru
+000267e0: 650a 0a20 2020 2020 2020 2023 2043 6f6d  e..        # Com
+000267f0: 7075 7465 2072 6563 6f6d 6d65 6e64 6174  pute recommendat
+00026800: 696f 6e73 0a20 2020 2020 2020 2072 6563  ions.        rec
+00026810: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
+00026820: 6373 203d 207b 7d0a 2020 2020 2020 2020  cs = {}.        
+00026830: 7072 696f 7269 7479 203d 2064 6963 7428  priority = dict(
+00026840: 290a 2020 2020 2020 2020 666f 7220 7473  ).        for ts
+00026850: 2069 6e20 736f 7274 6564 280a 2020 2020   in sorted(.    
+00026860: 2020 2020 2020 2020 7275 6e6e 6162 6c65          runnable
+00026870: 2c0a 2020 2020 2020 2020 2020 2020 6b65  ,.            ke
+00026880: 793d 6f70 6572 6174 6f72 2e61 7474 7267  y=operator.attrg
+00026890: 6574 7465 7228 2270 7269 6f72 6974 7922  etter("priority"
+000268a0: 292c 0a20 2020 2020 2020 2020 2020 2072  ),.            r
+000268b0: 6576 6572 7365 3d54 7275 652c 0a20 2020  everse=True,.   
+000268c0: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
+000268d0: 2020 2020 6173 7365 7274 2074 732e 7072      assert ts.pr
+000268e0: 696f 7269 7479 2020 2320 6d79 7079 0a20  iority  # mypy. 
+000268f0: 2020 2020 2020 2020 2020 2070 7269 6f72             prior
+00026900: 6974 795b 7473 2e6b 6579 5d20 3d20 7473  ity[ts.key] = ts
+00026910: 2e70 7269 6f72 6974 790a 2020 2020 2020  .priority.      
+00026920: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
+00026930: 7275 6e5f 7370 6563 0a20 2020 2020 2020  run_spec.       
+00026940: 2020 2020 2069 6620 7473 2e73 7461 7465       if ts.state
+00026950: 203d 3d20 2272 656c 6561 7365 6422 3a0a   == "released":.
+00026960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026970: 7265 636f 6d6d 656e 6461 7469 6f6e 735b  recommendations[
+00026980: 7473 2e6b 6579 5d20 3d20 2277 6169 7469  ts.key] = "waiti
+00026990: 6e67 220a 0a20 2020 2020 2020 2066 6f72  ng"..        for
+000269a0: 2074 7320 696e 2072 756e 6e61 626c 653a   ts in runnable:
+000269b0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+000269c0: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
+000269d0: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
+000269e0: 2020 2020 2020 2020 2069 6620 6474 732e           if dts.
+000269f0: 6578 6365 7074 696f 6e5f 626c 616d 653a  exception_blame:
+00026a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00026a10: 2020 2020 2074 732e 6578 6365 7074 696f       ts.exceptio
+00026a20: 6e5f 626c 616d 6520 3d20 6474 732e 6578  n_blame = dts.ex
+00026a30: 6365 7074 696f 6e5f 626c 616d 650a 2020  ception_blame.  
+00026a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026a50: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+00026a60: 735b 7473 2e6b 6579 5d20 3d20 2265 7272  s[ts.key] = "err
+00026a70: 6564 220a 2020 2020 2020 2020 2020 2020  ed".            
+00026a80: 2020 2020 2020 2020 6272 6561 6b0a 0a20          break.. 
+00026a90: 2020 2020 2020 2073 7061 6e73 5f65 7874         spans_ext
+00026aa0: 3a20 5370 616e 7353 6368 6564 756c 6572  : SpansScheduler
+00026ab0: 4578 7465 6e73 696f 6e20 7c20 4e6f 6e65  Extension | None
+00026ac0: 203d 2073 656c 662e 6578 7465 6e73 696f   = self.extensio
+00026ad0: 6e73 2e67 6574 2822 7370 616e 7322 290a  ns.get("spans").
+00026ae0: 2020 2020 2020 2020 6966 2073 7061 6e73          if spans
+00026af0: 5f65 7874 3a0a 2020 2020 2020 2020 2020  _ext:.          
+00026b00: 2020 2320 6e65 775f 7461 736b 7320 646f    # new_tasks do
+00026b10: 6573 206e 6f74 206e 6563 6573 7361 7269  es not necessari
+00026b20: 6c79 2063 6f6e 7461 696e 2061 6c6c 2072  ly contain all r
+00026b30: 756e 6e61 626c 6520 7461 736b 733b 0a20  unnable tasks;. 
+00026b40: 2020 2020 2020 2020 2020 2023 205f 6765             # _ge
+00026b50: 6e65 7261 7465 5f74 6173 6b73 7461 7465  nerate_taskstate
+00026b60: 7320 6973 206e 6f74 2074 6865 206f 6e6c  s is not the onl
+00026b70: 7920 7468 696e 6720 7468 6174 2063 616c  y thing that cal
+00026b80: 6c73 206e 6577 5f74 6173 6b28 292e 2041  ls new_task(). A
+00026b90: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+00026ba0: 6173 6b53 7461 7465 206d 6179 2068 6176  askState may hav
+00026bb0: 6520 616c 736f 2062 6565 6e20 6372 6561  e also been crea
+00026bc0: 7465 6420 6279 2063 6c69 656e 745f 6465  ted by client_de
+00026bd0: 7369 7265 735f 6b65 7973 206f 7220 7363  sires_keys or sc
+00026be0: 6174 7465 722c 0a20 2020 2020 2020 2020  atter,.         
+00026bf0: 2020 2023 2061 6e64 206f 6e6c 7920 6c61     # and only la
+00026c00: 7465 7220 6761 696e 6564 2061 2072 756e  ter gained a run
+00026c10: 5f73 7065 632e 0a20 2020 2020 2020 2020  _spec..         
+00026c20: 2020 2073 7061 6e73 5f65 7874 2e6f 6273     spans_ext.obs
+00026c30: 6572 7665 5f74 6173 6b73 2872 756e 6e61  erve_tasks(runna
+00026c40: 626c 652c 2063 6f64 653d 636f 6465 290a  ble, code=code).
+00026c50: 2020 2020 2020 2020 2020 2020 2320 5461              # Ta
+00026c60: 736b 4772 6f75 702e 7370 616e 5f69 6420  skGroup.span_id 
+00026c70: 636f 756c 6420 6265 2063 6f6d 706c 6574  could be complet
+00026c80: 656c 7920 6469 6666 6572 656e 7420 6672  ely different fr
+00026c90: 6f6d 2074 6865 206f 6e65 2069 6e20 7468  om the one in th
+00026ca0: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
+00026cb0: 6f72 6967 696e 616c 2061 6e6e 6f74 6174  original annotat
+00026cc0: 696f 6e73 2c20 736f 2069 7420 6861 7320  ions, so it has 
+00026cd0: 6265 656e 2064 726f 7070 6564 2e20 4472  been dropped. Dr
+00026ce0: 6f70 2069 7420 6865 7265 2061 7320 7765  op it here as we
+00026cf0: 6c6c 2069 6e0a 2020 2020 2020 2020 2020  ll in.          
+00026d00: 2020 2320 6f72 6465 7220 6e6f 7420 746f    # order not to
+00026d10: 2063 6f6e 6675 7365 2053 6368 6564 756c   confuse Schedul
+00026d20: 6572 506c 7567 696e 2061 7574 686f 7273  erPlugin authors
+00026d30: 2e0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+00026d40: 736f 6c76 6564 5f61 6e6e 6f74 6174 696f  solved_annotatio
+00026d50: 6e73 2e70 6f70 2822 7370 616e 222c 204e  ns.pop("span", N
+00026d60: 6f6e 6529 0a0a 2020 2020 2020 2020 666f  one)..        fo
+00026d70: 7220 706c 7567 696e 2069 6e20 6c69 7374  r plugin in list
+00026d80: 2873 656c 662e 706c 7567 696e 732e 7661  (self.plugins.va
+00026d90: 6c75 6573 2829 293a 0a20 2020 2020 2020  lues()):.       
+00026da0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00026db0: 2020 2020 2020 2020 2020 706c 7567 696e            plugin
+00026dc0: 2e75 7064 6174 655f 6772 6170 6828 0a20  .update_graph(. 
+00026dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026de0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00026df0: 2020 2020 2020 2020 2020 2020 2063 6c69               cli
+00026e00: 656e 743d 636c 6965 6e74 2c0a 2020 2020  ent=client,.    
+00026e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026e20: 7461 736b 733d 5b74 732e 6b65 7920 666f  tasks=[ts.key fo
+00026e30: 7220 7473 2069 6e20 746f 7563 6865 645f  r ts in touched_
+00026e40: 7461 736b 735d 2c0a 2020 2020 2020 2020  tasks],.        
+00026e50: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
+00026e60: 3d72 6571 7565 7374 6564 5f6b 6579 732c  =requested_keys,
+00026e70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00026e80: 2020 2020 2064 6570 656e 6465 6e63 6965       dependencie
+00026e90: 733d 6465 7065 6e64 656e 6369 6573 2c0a  s=dependencies,.
+00026ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026eb0: 2020 2020 616e 6e6f 7461 7469 6f6e 733d      annotations=
+00026ec0: 7265 736f 6c76 6564 5f61 6e6e 6f74 6174  resolved_annotat
+00026ed0: 696f 6e73 2c0a 2020 2020 2020 2020 2020  ions,.          
+00026ee0: 2020 2020 2020 2020 2020 7072 696f 7269            priori
+00026ef0: 7479 3d70 7269 6f72 6974 792c 0a20 2020  ty=priority,.   
+00026f00: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00026f10: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00026f20: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+00026f30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00026f40: 2020 6c6f 6767 6572 2e65 7863 6570 7469    logger.excepti
+00026f50: 6f6e 2865 290a 0a20 2020 2020 2020 2073  on(e)..        s
+00026f60: 656c 662e 7472 616e 7369 7469 6f6e 7328  elf.transitions(
+00026f70: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
+00026f80: 2073 7469 6d75 6c75 735f 6964 290a 0a20   stimulus_id).. 
+00026f90: 2020 2020 2020 2066 6f72 2074 7320 696e         for ts in
+00026fa0: 2074 6f75 6368 6564 5f74 6173 6b73 3a0a   touched_tasks:.
+00026fb0: 2020 2020 2020 2020 2020 2020 6966 2074              if t
+00026fc0: 732e 7374 6174 6520 696e 2028 226d 656d  s.state in ("mem
+00026fd0: 6f72 7922 2c20 2265 7272 6564 2229 3a0a  ory", "erred"):.
+00026fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026ff0: 7365 6c66 2e72 6570 6f72 745f 6f6e 5f6b  self.report_on_k
+00027000: 6579 2874 733d 7473 2c20 636c 6965 6e74  ey(ts=ts, client
+00027010: 3d63 6c69 656e 7429 0a0a 2020 2020 2020  =client)..      
+00027020: 2020 656e 6420 3d20 7469 6d65 2829 0a20    end = time(). 
+00027030: 2020 2020 2020 2073 656c 662e 6469 6765         self.dige
+00027040: 7374 5f6d 6574 7269 6328 2275 7064 6174  st_metric("updat
+00027050: 652d 6772 6170 682d 6475 7261 7469 6f6e  e-graph-duration
+00027060: 222c 2065 6e64 202d 2073 7461 7274 290a  ", end - start).
+00027070: 0a20 2020 2064 6566 205f 6765 6e65 7261  .    def _genera
+00027080: 7465 5f74 6173 6b73 7461 7465 7328 0a20  te_taskstates(. 
+00027090: 2020 2020 2020 2073 656c 662c 206b 6579         self, key
+000270a0: 733a 2073 6574 5b73 7472 5d2c 2064 736b  s: set[str], dsk
+000270b0: 3a20 6469 6374 2c20 6465 7065 6e64 656e  : dict, dependen
+000270c0: 6369 6573 3a20 6469 6374 2c20 636f 6d70  cies: dict, comp
+000270d0: 7574 6174 696f 6e3a 2043 6f6d 7075 7461  utation: Computa
+000270e0: 7469 6f6e 0a20 2020 2029 202d 3e20 7475  tion.    ) -> tu
+000270f0: 706c 653a 0a20 2020 2020 2020 2023 2047  ple:.        # G
+00027100: 6574 206f 7220 6372 6561 7465 2074 6173  et or create tas
+00027110: 6b20 7374 6174 6573 0a20 2020 2020 2020  k states.       
+00027120: 2072 756e 6e61 626c 6520 3d20 5b5d 0a20   runnable = []. 
+00027130: 2020 2020 2020 206e 6577 5f74 6173 6b73         new_tasks
+00027140: 203d 205b 5d0a 2020 2020 2020 2020 7374   = [].        st
+00027150: 6163 6b20 3d20 6c69 7374 286b 6579 7329  ack = list(keys)
+00027160: 0a20 2020 2020 2020 2074 6f75 6368 6564  .        touched
+00027170: 5f6b 6579 7320 3d20 7365 7428 290a 2020  _keys = set().  
+00027180: 2020 2020 2020 746f 7563 6865 645f 7461        touched_ta
+00027190: 736b 7320 3d20 5b5d 0a20 2020 2020 2020  sks = [].       
+000271a0: 2077 6869 6c65 2073 7461 636b 3a0a 2020   while stack:.  
+000271b0: 2020 2020 2020 2020 2020 6b20 3d20 7374            k = st
+000271c0: 6163 6b2e 706f 7028 290a 2020 2020 2020  ack.pop().      
+000271d0: 2020 2020 2020 6966 206b 2069 6e20 746f        if k in to
+000271e0: 7563 6865 645f 6b65 7973 3a0a 2020 2020  uched_keys:.    
+000271f0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00027200: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
+00027210: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
+00027220: 2e67 6574 286b 290a 2020 2020 2020 2020  .get(k).        
+00027230: 2020 2020 6966 2074 7320 6973 204e 6f6e      if ts is Non
+00027240: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00027250: 2020 2074 7320 3d20 7365 6c66 2e6e 6577     ts = self.new
+00027260: 5f74 6173 6b28 6b2c 2064 736b 2e67 6574  _task(k, dsk.get
+00027270: 286b 292c 2022 7265 6c65 6173 6564 222c  (k), "released",
+00027280: 2063 6f6d 7075 7461 7469 6f6e 3d63 6f6d   computation=com
+00027290: 7075 7461 7469 6f6e 290a 2020 2020 2020  putation).      
+000272a0: 2020 2020 2020 2020 2020 6e65 775f 7461            new_ta
+000272b0: 736b 732e 6170 7065 6e64 2874 7329 0a20  sks.append(ts). 
+000272c0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+000272d0: 6e6f 7420 7473 2e72 756e 5f73 7065 633a  not ts.run_spec:
+000272e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000272f0: 2074 732e 7275 6e5f 7370 6563 203d 2064   ts.run_spec = d
+00027300: 736b 2e67 6574 286b 290a 0a20 2020 2020  sk.get(k)..     
+00027310: 2020 2020 2020 2069 6620 7473 2e72 756e         if ts.run
+00027320: 5f73 7065 633a 0a20 2020 2020 2020 2020  _spec:.         
+00027330: 2020 2020 2020 2072 756e 6e61 626c 652e         runnable.
+00027340: 6170 7065 6e64 2874 7329 0a20 2020 2020  append(ts).     
+00027350: 2020 2020 2020 2074 6f75 6368 6564 5f6b         touched_k
+00027360: 6579 732e 6164 6428 6b29 0a20 2020 2020  eys.add(k).     
+00027370: 2020 2020 2020 2074 6f75 6368 6564 5f74         touched_t
+00027380: 6173 6b73 2e61 7070 656e 6428 7473 290a  asks.append(ts).
+00027390: 2020 2020 2020 2020 2020 2020 7374 6163              stac
+000273a0: 6b2e 6578 7465 6e64 2864 6570 656e 6465  k.extend(depende
+000273b0: 6e63 6965 732e 6765 7428 6b2c 2028 2929  ncies.get(k, ())
+000273c0: 290a 0a20 2020 2020 2020 2023 2041 6464  )..        # Add
+000273d0: 2064 6570 656e 6465 6e63 6965 730a 2020   dependencies.  
+000273e0: 2020 2020 2020 666f 7220 6b65 792c 2064        for key, d
+000273f0: 6570 7320 696e 2064 6570 656e 6465 6e63  eps in dependenc
+00027400: 6965 732e 6974 656d 7328 293a 0a20 2020  ies.items():.   
+00027410: 2020 2020 2020 2020 2074 7320 3d20 7365           ts = se
+00027420: 6c66 2e74 6173 6b73 2e67 6574 286b 6579  lf.tasks.get(key
+00027430: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00027440: 2074 7320 6973 204e 6f6e 6520 6f72 2074   ts is None or t
+00027450: 732e 6465 7065 6e64 656e 6369 6573 3a0a  s.dependencies:.
+00027460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027470: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
+00027480: 2020 2020 2066 6f72 2064 6570 2069 6e20       for dep in 
+00027490: 6465 7073 3a0a 2020 2020 2020 2020 2020  deps:.          
+000274a0: 2020 2020 2020 6474 7320 3d20 7365 6c66        dts = self
+000274b0: 2e74 6173 6b73 5b64 6570 5d0a 2020 2020  .tasks[dep].    
+000274c0: 2020 2020 2020 2020 2020 2020 7473 2e61              ts.a
+000274d0: 6464 5f64 6570 656e 6465 6e63 7928 6474  dd_dependency(dt
+000274e0: 7329 0a0a 2020 2020 2020 2020 6966 206c  s)..        if l
+000274f0: 656e 2874 6f75 6368 6564 5f74 6173 6b73  en(touched_tasks
+00027500: 2920 3c20 6c65 6e28 6b65 7973 293a 0a20  ) < len(keys):. 
+00027510: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+00027520: 722e 696e 666f 280a 2020 2020 2020 2020  r.info(.        
+00027530: 2020 2020 2020 2020 2253 7562 6d69 7474          "Submitt
+00027540: 6564 2067 7261 7068 2077 6974 6820 6c65  ed graph with le
+00027550: 6e67 7468 2025 7320 6275 7420 7265 7175  ngth %s but requ
+00027560: 6573 7465 6420 6772 6170 6820 6f6e 6c79  ested graph only
+00027570: 2069 6e63 6c75 6465 7320 2573 206b 6579   includes %s key
+00027580: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
+00027590: 2020 2020 6c65 6e28 746f 7563 6865 645f      len(touched_
+000275a0: 7461 736b 7329 2c0a 2020 2020 2020 2020  tasks),.        
+000275b0: 2020 2020 2020 2020 6c65 6e28 6b65 7973          len(keys
+000275c0: 292c 0a20 2020 2020 2020 2020 2020 2029  ),.            )
+000275d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000275e0: 7275 6e6e 6162 6c65 2c20 746f 7563 6865  runnable, touche
+000275f0: 645f 7461 736b 732c 206e 6577 5f74 6173  d_tasks, new_tas
+00027600: 6b73 0a0a 2020 2020 6465 6620 5f70 6172  ks..    def _par
+00027610: 7365 5f61 6e64 5f61 7070 6c79 5f61 6e6e  se_and_apply_ann
+00027620: 6f74 6174 696f 6e73 280a 2020 2020 2020  otations(.      
+00027630: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00027640: 7461 736b 733a 2049 7465 7261 626c 655b  tasks: Iterable[
+00027650: 5461 736b 5374 6174 655d 2c0a 2020 2020  TaskState],.    
+00027660: 2020 2020 616e 6e6f 7461 7469 6f6e 733a      annotations:
+00027670: 2064 6963 742c 0a20 2020 2020 2020 206c   dict,.        l
+00027680: 6179 6572 5f61 6e6e 6f74 6174 696f 6e73  ayer_annotations
+00027690: 3a20 6469 6374 5b73 7472 2c20 6469 6374  : dict[str, dict
+000276a0: 5d2c 0a20 2020 2020 2020 2070 7265 5f73  ],.        pre_s
+000276b0: 7472 696e 6769 6669 6564 5f6b 6579 733a  tringified_keys:
+000276c0: 2064 6963 745b 4861 7368 6162 6c65 2c20   dict[Hashable, 
+000276d0: 7374 725d 2c0a 2020 2020 2920 2d3e 2064  str],.    ) -> d
+000276e0: 6963 745b 7374 722c 2064 6963 745b 7374  ict[str, dict[st
+000276f0: 722c 2041 6e79 5d5d 3a0a 2020 2020 2020  r, Any]]:.      
+00027700: 2020 2222 2241 7070 6c79 2074 6865 2070    """Apply the p
+00027710: 726f 7669 6465 6420 616e 6e6f 7461 7469  rovided annotati
+00027720: 6f6e 7320 746f 2074 6865 2070 726f 7669  ons to the provi
+00027730: 6465 6420 6054 6173 6b53 7461 7465 6020  ded `TaskState` 
+00027740: 6f62 6a65 6374 732e 0a0a 2020 2020 2020  objects...      
+00027750: 2020 5468 6520 7261 7720 616e 6e6f 7461    The raw annota
+00027760: 7469 6f6e 7320 7769 6c6c 2062 6520 7374  tions will be st
+00027770: 6f72 6564 2069 6e20 7468 6520 6061 6e6e  ored in the `ann
+00027780: 6f74 6174 696f 6e73 6020 6174 7472 6962  otations` attrib
+00027790: 7574 652e 0a0a 2020 2020 2020 2020 4c61  ute...        La
+000277a0: 7965 7220 2f20 6b65 7920 7370 6563 6966  yer / key specif
+000277b0: 6963 2061 6e6e 6f74 6174 696f 6e73 2077  ic annotations w
+000277c0: 696c 6c20 7461 6b65 2070 7265 6365 6465  ill take precede
+000277d0: 6e63 6520 6f76 6572 2067 6c6f 6261 6c20  nce over global 
+000277e0: 2f20 6765 6e65 7269 6320 616e 6e6f 7461  / generic annota
+000277f0: 7469 6f6e 732e 0a0a 2020 2020 2020 2020  tions...        
+00027800: 5061 7261 6d65 7465 7273 0a20 2020 2020  Parameters.     
+00027810: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
+00027820: 2020 2020 2020 7461 736b 7320 3a20 4974        tasks : It
+00027830: 6572 6162 6c65 5b54 6173 6b53 7461 7465  erable[TaskState
+00027840: 5d0a 2020 2020 2020 2020 2020 2020 5f64  ].            _d
+00027850: 6573 6372 6970 7469 6f6e 5f0a 2020 2020  escription_.    
+00027860: 2020 2020 616e 6e6f 7461 7469 6f6e 7320      annotations 
+00027870: 3a20 6469 6374 0a20 2020 2020 2020 2020  : dict.         
+00027880: 2020 205f 6465 7363 7269 7074 696f 6e5f     _description_
+00027890: 0a20 2020 2020 2020 206c 6179 6572 5f61  .        layer_a
+000278a0: 6e6e 6f74 6174 696f 6e73 203a 2064 6963  nnotations : dic
+000278b0: 745b 7374 722c 2064 6963 745d 0a20 2020  t[str, dict].   
+000278c0: 2020 2020 2020 2020 205f 6465 7363 7269           _descri
+000278d0: 7074 696f 6e5f 0a0a 2020 2020 2020 2020  ption_..        
+000278e0: 5265 7475 726e 730a 2020 2020 2020 2020  Returns.        
+000278f0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+00027900: 7265 736f 6c76 6564 5f61 6e6e 6f74 6174  resolved_annotat
+00027910: 696f 6e73 3a20 6469 6374 0a20 2020 2020  ions: dict.     
+00027920: 2020 2020 2020 2041 206d 6170 7069 6e67         A mapping
+00027930: 206f 6620 616c 6c20 7265 736f 6c76 6564   of all resolved
+00027940: 2061 6e6e 6f74 6174 696f 6e73 2069 6e20   annotations in 
+00027950: 7468 6520 666f 726d 6174 3a3a 0a0a 2020  the format::..  
+00027960: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
+00027970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027980: 2020 2020 2261 6e6e 6f74 6174 696f 6e22      "annotation"
+00027990: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+000279a0: 2020 2020 2020 2020 2020 2020 226b 6579              "key
+000279b0: 223a 2076 616c 7565 2c0a 2020 2020 2020  ": value,.      
+000279c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000279d0: 2020 2e2e 2e0a 2020 2020 2020 2020 2020    ....          
+000279e0: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
+000279f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027a00: 202e 2e2e 0a20 2020 2020 2020 2020 2020   ....           
+00027a10: 2020 2020 207d 0a20 2020 2020 2020 2022       }.        "
+00027a20: 2222 0a20 2020 2020 2020 2072 6573 6f6c  "".        resol
+00027a30: 7665 645f 616e 6e6f 7461 7469 6f6e 733a  ved_annotations:
+00027a40: 2064 6566 6175 6c74 6469 6374 5b73 7472   defaultdict[str
+00027a50: 2c20 6469 6374 5b73 7472 2c20 416e 795d  , dict[str, Any]
+00027a60: 5d20 3d20 6465 6661 756c 7464 6963 7428  ] = defaultdict(
+00027a70: 6469 6374 290a 2020 2020 2020 2020 666f  dict).        fo
+00027a80: 7220 7473 2069 6e20 7461 736b 733a 0a20  r ts in tasks:. 
+00027a90: 2020 2020 2020 2020 2020 206b 6579 203d             key =
+00027aa0: 2074 732e 6b65 790a 2020 2020 2020 2020   ts.key.        
+00027ab0: 2020 2020 2320 5468 6973 2063 6f75 6c64      # This could
+00027ac0: 2062 6520 6120 7479 7065 6420 6469 6374   be a typed dict
+00027ad0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00027ae0: 6e6f 7420 616e 6e6f 7461 7469 6f6e 7320  not annotations 
+00027af0: 616e 6420 6b65 7920 6e6f 7420 696e 206c  and key not in l
+00027b00: 6179 6572 5f61 6e6e 6f74 6174 696f 6e73  ayer_annotations
+00027b10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00027b20: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
+00027b30: 2020 2020 2020 206f 7574 203d 2061 6e6e         out = ann
+00027b40: 6f74 6174 696f 6e73 2e63 6f70 7928 290a  otations.copy().
+00027b50: 2020 2020 2020 2020 2020 2020 6f75 742e              out.
+00027b60: 7570 6461 7465 286c 6179 6572 5f61 6e6e  update(layer_ann
+00027b70: 6f74 6174 696f 6e73 2e67 6574 286b 6579  otations.get(key
+00027b80: 2c20 7b7d 2929 0a20 2020 2020 2020 2020  , {})).         
+00027b90: 2020 2066 6f72 2061 6e6e 6f74 2c20 7661     for annot, va
+00027ba0: 6c75 6520 696e 206f 7574 2e69 7465 6d73  lue in out.items
+00027bb0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00027bc0: 2020 2020 2320 506f 7020 7468 6520 6b65      # Pop the ke
+00027bd0: 7920 7369 6e63 6520 6e61 6d65 7320 646f  y since names do
+00027be0: 6e27 7420 616c 7761 7973 206d 6174 6368  n't always match
+00027bf0: 2061 7474 7269 6275 7465 730a 2020 2020   attributes.    
+00027c00: 2020 2020 2020 2020 2020 2020 6966 2063              if c
+00027c10: 616c 6c61 626c 6528 7661 6c75 6529 3a0a  allable(value):.
 00027c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027c30: 2020 2066 6f72 2077 2069 6e20 7661 6c75     for w in valu
-00027c40: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00027c50: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-00027c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027c70: 2020 2020 2020 2020 2020 2020 7720 3d20              w = 
-00027c80: 7365 6c66 2e63 6f65 7263 655f 6164 6472  self.coerce_addr
-00027c90: 6573 7328 7729 0a20 2020 2020 2020 2020  ess(w).         
-00027ca0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00027cb0: 7863 6570 7420 5661 6c75 6545 7272 6f72  xcept ValueError
-00027cc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00027cd0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00027ce0: 4e6f 7420 6120 7661 6c69 6420 6164 6472  Not a valid addr
-00027cf0: 6573 732c 2062 7574 2070 6572 6861 7073  ess, but perhaps
-00027d00: 2069 7427 7320 6120 686f 7374 6e61 6d65   it's a hostname
-00027d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027d20: 2020 2020 2020 2020 2020 2020 2068 6f73               hos
-00027d30: 745f 7265 7374 7269 6374 696f 6e73 2e61  t_restrictions.a
-00027d40: 6464 2877 290a 2020 2020 2020 2020 2020  dd(w).          
-00027d50: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00027d60: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00027d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027d80: 776f 726b 6572 5f72 6573 7472 6963 7469  worker_restricti
-00027d90: 6f6e 732e 6164 6428 7729 0a20 2020 2020  ons.add(w).     
-00027da0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00027db0: 6620 686f 7374 5f72 6573 7472 6963 7469  f host_restricti
-00027dc0: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
-00027dd0: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
-00027de0: 686f 7374 5f72 6573 7472 6963 7469 6f6e  host_restriction
-00027df0: 7320 3d20 686f 7374 5f72 6573 7472 6963  s = host_restric
-00027e00: 7469 6f6e 730a 2020 2020 2020 2020 2020  tions.          
-00027e10: 2020 2020 2020 2020 2020 6966 2077 6f72            if wor
-00027e20: 6b65 725f 7265 7374 7269 6374 696f 6e73  ker_restrictions
-00027e30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00027e40: 2020 2020 2020 2020 2020 7473 2e77 6f72            ts.wor
-00027e50: 6b65 725f 7265 7374 7269 6374 696f 6e73  ker_restrictions
-00027e60: 203d 2077 6f72 6b65 725f 7265 7374 7269   = worker_restri
-00027e70: 6374 696f 6e73 0a20 2020 2020 2020 2020  ctions.         
-00027e80: 2020 2020 2020 2065 6c69 6620 616e 6e6f         elif anno
-00027e90: 7420 696e 2028 226c 6f6f 7365 5f72 6573  t in ("loose_res
-00027ea0: 7472 6963 7469 6f6e 7322 2c20 2261 6c6c  trictions", "all
-00027eb0: 6f77 5f6f 7468 6572 5f77 6f72 6b65 7273  ow_other_workers
-00027ec0: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
-00027ed0: 2020 2020 2020 2020 7473 2e6c 6f6f 7365          ts.loose
-00027ee0: 5f72 6573 7472 6963 7469 6f6e 7320 3d20  _restrictions = 
-00027ef0: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
-00027f00: 2020 2020 2020 656c 6966 2061 6e6e 6f74        elif annot
-00027f10: 203d 3d20 2272 6573 6f75 7263 6573 223a   == "resources":
-00027f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027f30: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
-00027f40: 7374 616e 6365 2876 616c 7565 2c20 6469  stance(value, di
-00027f50: 6374 290a 2020 2020 2020 2020 2020 2020  ct).            
-00027f60: 2020 2020 2020 2020 7473 2e72 6573 6f75          ts.resou
-00027f70: 7263 655f 7265 7374 7269 6374 696f 6e73  rce_restrictions
-00027f80: 203d 2076 616c 7565 0a20 2020 2020 2020   = value.       
-00027f90: 2020 2020 2020 2020 2065 6c69 6620 616e           elif an
-00027fa0: 6e6f 7420 3d3d 2022 7072 696f 7269 7479  not == "priority
-00027fb0: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
-00027fc0: 2020 2020 2020 2023 2053 6565 2053 6368         # See Sch
-00027fd0: 6564 756c 6572 2e5f 7365 745f 7072 696f  eduler._set_prio
-00027fe0: 7269 7469 6573 0a20 2020 2020 2020 2020  rities.         
-00027ff0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-00028000: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
-00028010: 2020 2020 656c 6966 2061 6e6e 6f74 203d      elif annot =
-00028020: 3d20 2272 6574 7269 6573 223a 0a20 2020  = "retries":.   
-00028030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028040: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-00028050: 6365 2876 616c 7565 2c20 696e 7429 0a20  ce(value, int). 
+00027c30: 2020 2020 7661 6c75 6520 3d20 7661 6c75      value = valu
+00027c40: 6528 7072 655f 7374 7269 6e67 6966 6965  e(pre_stringifie
+00027c50: 645f 6b65 7973 5b6b 6579 5d29 0a20 2020  d_keys[key]).   
+00027c60: 2020 2020 2020 2020 2020 2020 206f 7574               out
+00027c70: 5b61 6e6e 6f74 5d20 3d20 7661 6c75 650a  [annot] = value.
+00027c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027c90: 7265 736f 6c76 6564 5f61 6e6e 6f74 6174  resolved_annotat
+00027ca0: 696f 6e73 5b61 6e6e 6f74 5d5b 6b65 795d  ions[annot][key]
+00027cb0: 203d 2076 616c 7565 0a0a 2020 2020 2020   = value..      
+00027cc0: 2020 2020 2020 2020 2020 6966 2061 6e6e            if ann
+00027cd0: 6f74 2069 6e20 2822 7265 7374 7269 6374  ot in ("restrict
+00027ce0: 696f 6e73 222c 2022 776f 726b 6572 7322  ions", "workers"
+00027cf0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00027d00: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
+00027d10: 696e 7374 616e 6365 2876 616c 7565 2c20  instance(value, 
+00027d20: 286c 6973 742c 2074 7570 6c65 2c20 7365  (list, tuple, se
+00027d30: 7429 293a 0a20 2020 2020 2020 2020 2020  t)):.           
+00027d40: 2020 2020 2020 2020 2020 2020 2076 616c               val
+00027d50: 7565 203d 205b 7661 6c75 655d 0a20 2020  ue = [value].   
+00027d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027d70: 2068 6f73 745f 7265 7374 7269 6374 696f   host_restrictio
+00027d80: 6e73 203d 2073 6574 2829 0a20 2020 2020  ns = set().     
+00027d90: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00027da0: 6f72 6b65 725f 7265 7374 7269 6374 696f  orker_restrictio
+00027db0: 6e73 203d 2073 6574 2829 0a20 2020 2020  ns = set().     
+00027dc0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00027dd0: 6f72 2077 2069 6e20 7661 6c75 653a 0a20  or w in value:. 
+00027de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027df0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00027e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027e10: 2020 2020 2020 2020 7720 3d20 7365 6c66          w = self
+00027e20: 2e63 6f65 7263 655f 6164 6472 6573 7328  .coerce_address(
+00027e30: 7729 0a20 2020 2020 2020 2020 2020 2020  w).             
+00027e40: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00027e50: 7420 5661 6c75 6545 7272 6f72 3a0a 2020  t ValueError:.  
+00027e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027e70: 2020 2020 2020 2020 2020 2320 4e6f 7420            # Not 
+00027e80: 6120 7661 6c69 6420 6164 6472 6573 732c  a valid address,
+00027e90: 2062 7574 2070 6572 6861 7073 2069 7427   but perhaps it'
+00027ea0: 7320 6120 686f 7374 6e61 6d65 0a20 2020  s a hostname.   
+00027eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027ec0: 2020 2020 2020 2020 2068 6f73 745f 7265           host_re
+00027ed0: 7374 7269 6374 696f 6e73 2e61 6464 2877  strictions.add(w
+00027ee0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00027ef0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00027f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027f10: 2020 2020 2020 2020 2020 2020 776f 726b              work
+00027f20: 6572 5f72 6573 7472 6963 7469 6f6e 732e  er_restrictions.
+00027f30: 6164 6428 7729 0a20 2020 2020 2020 2020  add(w).         
+00027f40: 2020 2020 2020 2020 2020 2069 6620 686f             if ho
+00027f50: 7374 5f72 6573 7472 6963 7469 6f6e 733a  st_restrictions:
+00027f60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027f70: 2020 2020 2020 2020 2074 732e 686f 7374           ts.host
+00027f80: 5f72 6573 7472 6963 7469 6f6e 7320 3d20  _restrictions = 
+00027f90: 686f 7374 5f72 6573 7472 6963 7469 6f6e  host_restriction
+00027fa0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00027fb0: 2020 2020 2020 6966 2077 6f72 6b65 725f        if worker_
+00027fc0: 7265 7374 7269 6374 696f 6e73 3a0a 2020  restrictions:.  
+00027fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027fe0: 2020 2020 2020 7473 2e77 6f72 6b65 725f        ts.worker_
+00027ff0: 7265 7374 7269 6374 696f 6e73 203d 2077  restrictions = w
+00028000: 6f72 6b65 725f 7265 7374 7269 6374 696f  orker_restrictio
+00028010: 6e73 0a20 2020 2020 2020 2020 2020 2020  ns.             
+00028020: 2020 2065 6c69 6620 616e 6e6f 7420 696e     elif annot in
+00028030: 2028 226c 6f6f 7365 5f72 6573 7472 6963   ("loose_restric
+00028040: 7469 6f6e 7322 2c20 2261 6c6c 6f77 5f6f  tions", "allow_o
+00028050: 7468 6572 5f77 6f72 6b65 7273 2229 3a0a  ther_workers"):.
 00028060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028070: 2020 2074 732e 7265 7472 6965 7320 3d20     ts.retries = 
-00028080: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
-00028090: 2020 7473 2e61 6e6e 6f74 6174 696f 6e73    ts.annotations
-000280a0: 203d 206f 7574 0a20 2020 2020 2020 2072   = out.        r
-000280b0: 6574 7572 6e20 6469 6374 2872 6573 6f6c  eturn dict(resol
-000280c0: 7665 645f 616e 6e6f 7461 7469 6f6e 7329  ved_annotations)
-000280d0: 0a0a 2020 2020 6465 6620 5f73 6574 5f70  ..    def _set_p
-000280e0: 7269 6f72 6974 6965 7328 0a20 2020 2020  riorities(.     
-000280f0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00028100: 2069 6e74 6572 6e61 6c5f 7072 696f 7269   internal_priori
-00028110: 7479 3a20 6469 6374 5b73 7472 2c20 696e  ty: dict[str, in
-00028120: 745d 207c 204e 6f6e 652c 0a20 2020 2020  t] | None,.     
-00028130: 2020 2073 7562 6d69 7474 696e 675f 7461     submitting_ta
-00028140: 736b 3a20 7374 7220 7c20 4e6f 6e65 2c0a  sk: str | None,.
-00028150: 2020 2020 2020 2020 7573 6572 5f70 7269          user_pri
-00028160: 6f72 6974 793a 2069 6e74 207c 2064 6963  ority: int | dic
-00028170: 745b 7374 722c 2069 6e74 5d2c 0a20 2020  t[str, int],.   
-00028180: 2020 2020 2066 6966 6f5f 7469 6d65 6f75       fifo_timeou
-00028190: 743a 2069 6e74 207c 2066 6c6f 6174 207c  t: int | float |
-000281a0: 2073 7472 2c0a 2020 2020 2020 2020 7374   str,.        st
-000281b0: 6172 743a 2066 6c6f 6174 2c0a 2020 2020  art: float,.    
-000281c0: 2020 2020 6473 6b3a 2064 6963 742c 0a20      dsk: dict,. 
-000281d0: 2020 2020 2020 2074 6173 6b73 3a20 6c69         tasks: li
-000281e0: 7374 5b54 6173 6b53 7461 7465 5d2c 0a20  st[TaskState],. 
-000281f0: 2020 2020 2020 2064 6570 656e 6465 6e63         dependenc
-00028200: 6965 733a 2064 6963 742c 0a20 2020 2029  ies: dict,.    )
-00028210: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00028220: 2020 6669 666f 5f74 696d 656f 7574 203d    fifo_timeout =
-00028230: 2070 6172 7365 5f74 696d 6564 656c 7461   parse_timedelta
-00028240: 2866 6966 6f5f 7469 6d65 6f75 7429 0a20  (fifo_timeout). 
-00028250: 2020 2020 2020 2069 6620 7375 626d 6974         if submit
-00028260: 7469 6e67 5f74 6173 6b3a 2020 2320 7375  ting_task:  # su
-00028270: 622d 7461 736b 7320 6765 7420 6265 7474  b-tasks get bett
-00028280: 6572 2070 7269 6f72 6974 7920 7468 616e  er priority than
-00028290: 2070 6172 656e 7420 7461 736b 730a 2020   parent tasks.  
-000282a0: 2020 2020 2020 2020 2020 7374 7320 3d20            sts = 
-000282b0: 7365 6c66 2e74 6173 6b73 2e67 6574 2873  self.tasks.get(s
-000282c0: 7562 6d69 7474 696e 675f 7461 736b 290a  ubmitting_task).
-000282d0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-000282e0: 7473 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ts is not None:.
-000282f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028300: 6173 7365 7274 2073 7473 2e70 7269 6f72  assert sts.prior
-00028310: 6974 790a 2020 2020 2020 2020 2020 2020  ity.            
-00028320: 2020 2020 6765 6e65 7261 7469 6f6e 203d      generation =
-00028330: 2073 7473 2e70 7269 6f72 6974 795b 305d   sts.priority[0]
-00028340: 202d 2030 2e30 310a 2020 2020 2020 2020   - 0.01.        
-00028350: 2020 2020 656c 7365 3a20 2023 2073 7570      else:  # sup
-00028360: 6572 2d74 6173 6b20 616c 7265 6164 7920  er-task already 
-00028370: 636c 6561 6e65 6420 7570 0a20 2020 2020  cleaned up.     
-00028380: 2020 2020 2020 2020 2020 2067 656e 6572             gener
-00028390: 6174 696f 6e20 3d20 7365 6c66 2e67 656e  ation = self.gen
-000283a0: 6572 6174 696f 6e0a 2020 2020 2020 2020  eration.        
-000283b0: 656c 6966 2073 656c 662e 5f6c 6173 745f  elif self._last_
-000283c0: 7469 6d65 202b 2066 6966 6f5f 7469 6d65  time + fifo_time
-000283d0: 6f75 7420 3c20 7374 6172 743a 0a20 2020  out < start:.   
-000283e0: 2020 2020 2020 2020 2073 656c 662e 6765           self.ge
-000283f0: 6e65 7261 7469 6f6e 202b 3d20 3120 2023  neration += 1  #
-00028400: 206f 6c64 6572 2067 7261 7068 2067 656e   older graph gen
-00028410: 6572 6174 696f 6e73 2074 616b 6520 7072  erations take pr
-00028420: 6563 6564 656e 6365 0a20 2020 2020 2020  ecedence.       
-00028430: 2020 2020 2067 656e 6572 6174 696f 6e20       generation 
-00028440: 3d20 7365 6c66 2e67 656e 6572 6174 696f  = self.generatio
-00028450: 6e0a 2020 2020 2020 2020 2020 2020 7365  n.            se
-00028460: 6c66 2e5f 6c61 7374 5f74 696d 6520 3d20  lf._last_time = 
-00028470: 7374 6172 740a 2020 2020 2020 2020 656c  start.        el
-00028480: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00028490: 6765 6e65 7261 7469 6f6e 203d 2073 656c  generation = sel
-000284a0: 662e 6765 6e65 7261 7469 6f6e 0a0a 2020  f.generation..  
-000284b0: 2020 2020 2020 6966 2069 6e74 6572 6e61        if interna
-000284c0: 6c5f 7072 696f 7269 7479 2069 7320 4e6f  l_priority is No
-000284d0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-000284e0: 2320 5265 6d6f 7669 6e67 2061 6c6c 206e  # Removing all n
-000284f0: 6f6e 2d6c 6f63 616c 206b 6579 7320 6265  on-local keys be
-00028500: 666f 7265 2063 616c 6c69 6e67 206f 7264  fore calling ord
-00028510: 6572 2829 0a20 2020 2020 2020 2020 2020  er().           
-00028520: 2064 736b 5f6b 6579 7320 3d20 7365 7428   dsk_keys = set(
-00028530: 6473 6b29 2020 2320 696e 7465 7273 6563  dsk)  # intersec
-00028540: 7469 6f6e 2829 206f 6620 7365 7473 2069  tion() of sets i
-00028550: 7320 6d75 6368 2066 6173 7465 7220 7468  s much faster th
-00028560: 616e 2064 6963 745f 6b65 7973 0a20 2020  an dict_keys.   
-00028570: 2020 2020 2020 2020 2073 7472 6970 7065           strippe
-00028580: 645f 6465 7073 203d 207b 0a20 2020 2020  d_deps = {.     
-00028590: 2020 2020 2020 2020 2020 206b 3a20 762e             k: v.
-000285a0: 696e 7465 7273 6563 7469 6f6e 2864 736b  intersection(dsk
-000285b0: 5f6b 6579 7329 0a20 2020 2020 2020 2020  _keys).         
-000285c0: 2020 2020 2020 2066 6f72 206b 2c20 7620         for k, v 
-000285d0: 696e 2064 6570 656e 6465 6e63 6965 732e  in dependencies.
-000285e0: 6974 656d 7328 290a 2020 2020 2020 2020  items().        
-000285f0: 2020 2020 2020 2020 6966 206b 2069 6e20          if k in 
-00028600: 6473 6b5f 6b65 7973 0a20 2020 2020 2020  dsk_keys.       
-00028610: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00028620: 2020 2069 6e74 6572 6e61 6c5f 7072 696f     internal_prio
-00028630: 7269 7479 203d 2064 6173 6b2e 6f72 6465  rity = dask.orde
-00028640: 722e 6f72 6465 7228 6473 6b2c 2064 6570  r.order(dsk, dep
-00028650: 656e 6465 6e63 6965 733d 7374 7269 7070  endencies=stripp
-00028660: 6564 5f64 6570 7329 0a0a 2020 2020 2020  ed_deps)..      
-00028670: 2020 666f 7220 7473 2069 6e20 7461 736b    for ts in task
-00028680: 733a 0a20 2020 2020 2020 2020 2020 2023  s:.            #
-00028690: 204e 6f74 653a 2055 6e64 6572 2077 6869   Note: Under whi
-000286a0: 6368 2063 6972 6375 6d73 7461 6e63 6573  ch circumstances
-000286b0: 2077 6f75 6c64 2061 2074 6173 6b20 6e6f   would a task no
-000286c0: 7420 6861 7665 2061 0a20 2020 2020 2020  t have a.       
-000286d0: 2020 2020 2023 2070 7269 6f72 6974 6979       # prioritiy
-000286e0: 2061 7373 6967 6e65 6420 6279 206e 6f77   assigned by now
-000286f0: 3f20 4172 6520 7468 6573 6520 7363 6174  ? Are these scat
-00028700: 7465 7265 6420 7461 736b 730a 2020 2020  tered tasks.    
-00028710: 2020 2020 2020 2020 2320 6578 636c 7573          # exclus
-00028720: 6976 656c 7920 6f72 2073 6f6d 6574 6869  ively or somethi
-00028730: 6e67 2065 6c73 653f 0a20 2020 2020 2020  ng else?.       
-00028740: 2020 2020 2074 6173 6b5f 7573 6572 5f70       task_user_p
-00028750: 7269 6f20 3d20 7573 6572 5f70 7269 6f72  rio = user_prior
-00028760: 6974 790a 2020 2020 2020 2020 2020 2020  ity.            
-00028770: 6966 2069 7369 6e73 7461 6e63 6528 7573  if isinstance(us
-00028780: 6572 5f70 7269 6f72 6974 792c 2064 6963  er_priority, dic
-00028790: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-000287a0: 2020 2020 7461 736b 5f75 7365 725f 7072      task_user_pr
-000287b0: 696f 203d 2075 7365 725f 7072 696f 7269  io = user_priori
-000287c0: 7479 2e67 6574 2874 732e 6b65 792c 2030  ty.get(ts.key, 0
-000287d0: 290a 2020 2020 2020 2020 2020 2020 616e  ).            an
-000287e0: 6e6f 7461 7465 645f 7072 696f 203d 2074  notated_prio = t
-000287f0: 732e 616e 6e6f 7461 7469 6f6e 732e 6765  s.annotations.ge
-00028800: 7428 2270 7269 6f72 6974 7922 2c20 7b7d  t("priority", {}
-00028810: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00028820: 206e 6f74 2061 6e6e 6f74 6174 6564 5f70   not annotated_p
-00028830: 7269 6f3a 0a20 2020 2020 2020 2020 2020  rio:.           
-00028840: 2020 2020 2061 6e6e 6f74 6174 6564 5f70       annotated_p
-00028850: 7269 6f20 3d20 7461 736b 5f75 7365 725f  rio = task_user_
-00028860: 7072 696f 0a0a 2020 2020 2020 2020 2020  prio..          
-00028870: 2020 6966 206e 6f74 2074 732e 7072 696f    if not ts.prio
-00028880: 7269 7479 2061 6e64 2074 732e 6b65 7920  rity and ts.key 
-00028890: 696e 2069 6e74 6572 6e61 6c5f 7072 696f  in internal_prio
-000288a0: 7269 7479 3a0a 2020 2020 2020 2020 2020  rity:.          
-000288b0: 2020 2020 2020 7473 2e70 7269 6f72 6974        ts.priorit
-000288c0: 7920 3d20 280a 2020 2020 2020 2020 2020  y = (.          
-000288d0: 2020 2020 2020 2020 2020 2d61 6e6e 6f74            -annot
-000288e0: 6174 6564 5f70 7269 6f2c 0a20 2020 2020  ated_prio,.     
-000288f0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00028900: 656e 6572 6174 696f 6e2c 0a20 2020 2020  eneration,.     
-00028910: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00028920: 6e74 6572 6e61 6c5f 7072 696f 7269 7479  nternal_priority
-00028930: 5b74 732e 6b65 795d 2c0a 2020 2020 2020  [ts.key],.      
-00028940: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00028950: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00028960: 2e76 616c 6964 6174 6520 616e 6420 7473  .validate and ts
-00028970: 2e72 756e 5f73 7065 633a 0a20 2020 2020  .run_spec:.     
-00028980: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00028990: 7420 6973 696e 7374 616e 6365 2874 732e  t isinstance(ts.
-000289a0: 7072 696f 7269 7479 2c20 7475 706c 6529  priority, tuple)
-000289b0: 2061 6e64 2061 6c6c 280a 2020 2020 2020   and all(.      
-000289c0: 2020 2020 2020 2020 2020 2020 2020 6973                is
-000289d0: 696e 7374 616e 6365 2865 6c2c 2028 696e  instance(el, (in
-000289e0: 742c 2066 6c6f 6174 2929 2066 6f72 2065  t, float)) for e
-000289f0: 6c20 696e 2074 732e 7072 696f 7269 7479  l in ts.priority
-00028a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028a10: 2029 0a0a 2020 2020 6465 6620 5f70 6f70   )..    def _pop
-00028a20: 5f6c 6f73 745f 7461 736b 7328 0a20 2020  _lost_tasks(.   
-00028a30: 2020 2020 2073 656c 662c 2064 736b 3a20       self, dsk: 
-00028a40: 6469 6374 2c20 6465 7065 6e64 656e 6369  dict, dependenci
-00028a50: 6573 3a20 6469 6374 2c20 6b65 7973 3a20  es: dict, keys: 
-00028a60: 7365 745b 7374 725d 0a20 2020 2029 202d  set[str].    ) -
-00028a70: 3e20 7365 745b 7374 725d 3a0a 2020 2020  > set[str]:.    
-00028a80: 2020 2020 6e20 3d20 300a 2020 2020 2020      n = 0.      
-00028a90: 2020 6f75 7420 3d20 7365 7428 290a 2020    out = set().  
-00028aa0: 2020 2020 2020 7768 696c 6520 6c65 6e28        while len(
-00028ab0: 6473 6b29 2021 3d20 6e3a 2020 2320 7761  dsk) != n:  # wa
-00028ac0: 6c6b 2074 6872 6f75 6768 206e 6577 2074  lk through new t
-00028ad0: 6173 6b73 2c20 6361 6e63 656c 2061 6e79  asks, cancel any
-00028ae0: 2062 6164 2064 6570 730a 2020 2020 2020   bad deps.      
-00028af0: 2020 2020 2020 6e20 3d20 6c65 6e28 6473        n = len(ds
-00028b00: 6b29 0a20 2020 2020 2020 2020 2020 2066  k).            f
-00028b10: 6f72 206b 2c20 6465 7073 2069 6e20 6c69  or k, deps in li
-00028b20: 7374 2864 6570 656e 6465 6e63 6965 732e  st(dependencies.
-00028b30: 6974 656d 7328 2929 3a0a 2020 2020 2020  items()):.      
-00028b40: 2020 2020 2020 2020 2020 6966 2061 6e79            if any
-00028b50: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00028b60: 2020 2020 2020 6465 7020 6e6f 7420 696e        dep not in
-00028b70: 2073 656c 662e 7461 736b 7320 616e 6420   self.tasks and 
-00028b80: 6465 7020 6e6f 7420 696e 2064 736b 2066  dep not in dsk f
-00028b90: 6f72 2064 6570 2069 6e20 6465 7073 0a20  or dep in deps. 
-00028ba0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00028bb0: 3a20 2023 2062 6164 206b 6579 0a20 2020  :  # bad key.   
-00028bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028bd0: 206f 7574 2e61 6464 286b 290a 2020 2020   out.add(k).    
-00028be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028bf0: 6c6f 6767 6572 2e69 6e66 6f28 2255 7365  logger.info("Use
-00028c00: 7220 6173 6b65 6420 666f 7220 636f 6d70  r asked for comp
-00028c10: 7574 6174 696f 6e20 6f6e 206c 6f73 7420  utation on lost 
-00028c20: 6461 7461 2c20 2573 222c 206b 290a 2020  data, %s", k).  
-00028c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028c40: 2020 6465 6c20 6473 6b5b 6b5d 0a20 2020    del dsk[k].   
-00028c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028c60: 2064 656c 2064 6570 656e 6465 6e63 6965   del dependencie
-00028c70: 735b 6b5d 0a20 2020 2020 2020 2020 2020  s[k].           
-00028c80: 2020 2020 2020 2020 2069 6620 6b20 696e           if k in
-00028c90: 206b 6579 733a 0a20 2020 2020 2020 2020   keys:.         
-00028ca0: 2020 2020 2020 2020 2020 2020 2020 206b                 k
-00028cb0: 6579 732e 7265 6d6f 7665 286b 290a 2020  eys.remove(k).  
-00028cc0: 2020 2020 2020 7265 7475 726e 206f 7574        return out
-00028cd0: 0a0a 2020 2020 6465 6620 5f70 6f70 5f6b  ..    def _pop_k
-00028ce0: 6e6f 776e 5f74 6173 6b73 2873 656c 662c  nown_tasks(self,
-00028cf0: 2064 736b 3a20 6469 6374 2c20 6465 7065   dsk: dict, depe
-00028d00: 6e64 656e 6369 6573 3a20 6469 6374 2920  ndencies: dict) 
-00028d10: 2d3e 2073 6574 5b73 7472 5d3a 0a20 2020  -> set[str]:.   
-00028d20: 2020 2020 2023 2041 766f 6964 2063 6f6d       # Avoid com
-00028d30: 7075 7461 7469 6f6e 2074 6861 7420 6973  putation that is
-00028d40: 2061 6c72 6561 6479 2066 696e 6973 6865   already finishe
-00028d50: 640a 2020 2020 2020 2020 616c 7265 6164  d.        alread
-00028d60: 795f 696e 5f6d 656d 6f72 7920 3d20 7365  y_in_memory = se
-00028d70: 7428 2920 2023 2074 6173 6b73 2074 6861  t()  # tasks tha
-00028d80: 7420 6172 6520 616c 7265 6164 7920 646f  t are already do
-00028d90: 6e65 0a20 2020 2020 2020 2066 6f72 206b  ne.        for k
-00028da0: 2c20 7620 696e 2064 6570 656e 6465 6e63  , v in dependenc
-00028db0: 6965 732e 6974 656d 7328 293a 0a20 2020  ies.items():.   
-00028dc0: 2020 2020 2020 2020 2069 6620 7620 616e           if v an
-00028dd0: 6420 6b20 696e 2073 656c 662e 7461 736b  d k in self.task
-00028de0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00028df0: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
-00028e00: 6b73 5b6b 5d0a 2020 2020 2020 2020 2020  ks[k].          
-00028e10: 2020 2020 2020 6966 2074 732e 7374 6174        if ts.stat
-00028e20: 6520 696e 2028 226d 656d 6f72 7922 2c20  e in ("memory", 
-00028e30: 2265 7272 6564 2229 3a0a 2020 2020 2020  "erred"):.      
-00028e40: 2020 2020 2020 2020 2020 2020 2020 616c                al
-00028e50: 7265 6164 795f 696e 5f6d 656d 6f72 792e  ready_in_memory.
-00028e60: 6164 6428 6b29 0a0a 2020 2020 2020 2020  add(k)..        
-00028e70: 646f 6e65 203d 2073 6574 2861 6c72 6561  done = set(alrea
-00028e80: 6479 5f69 6e5f 6d65 6d6f 7279 290a 2020  dy_in_memory).  
-00028e90: 2020 2020 2020 6966 2061 6c72 6561 6479        if already
-00028ea0: 5f69 6e5f 6d65 6d6f 7279 3a0a 2020 2020  _in_memory:.    
-00028eb0: 2020 2020 2020 2020 6465 7065 6e64 656e          dependen
-00028ec0: 7473 203d 2064 6173 6b2e 636f 7265 2e72  ts = dask.core.r
-00028ed0: 6576 6572 7365 5f64 6963 7428 6465 7065  everse_dict(depe
-00028ee0: 6e64 656e 6369 6573 290a 2020 2020 2020  ndencies).      
-00028ef0: 2020 2020 2020 7374 6163 6b20 3d20 6c69        stack = li
-00028f00: 7374 2861 6c72 6561 6479 5f69 6e5f 6d65  st(already_in_me
-00028f10: 6d6f 7279 290a 2020 2020 2020 2020 2020  mory).          
-00028f20: 2020 7768 696c 6520 7374 6163 6b3a 2020    while stack:  
-00028f30: 2320 7265 6d6f 7665 2075 6e6e 6563 6573  # remove unneces
-00028f40: 7361 7279 2064 6570 656e 6465 6e63 6965  sary dependencie
-00028f50: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00028f60: 2020 6b65 7920 3d20 7374 6163 6b2e 706f    key = stack.po
-00028f70: 7028 290a 2020 2020 2020 2020 2020 2020  p().            
-00028f80: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00028f90: 2020 2020 2020 2020 2020 2020 2064 6570               dep
-00028fa0: 7320 3d20 6465 7065 6e64 656e 6369 6573  s = dependencies
-00028fb0: 5b6b 6579 5d0a 2020 2020 2020 2020 2020  [key].          
-00028fc0: 2020 2020 2020 6578 6365 7074 204b 6579        except Key
-00028fd0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-00028fe0: 2020 2020 2020 2020 2020 2064 6570 7320             deps 
-00028ff0: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-00029000: 5d2e 6465 7065 6e64 656e 6369 6573 0a20  ].dependencies. 
-00029010: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00029020: 6f72 2064 6570 2069 6e20 6465 7073 3a0a  or dep in deps:.
-00029030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029040: 2020 2020 6966 2064 6570 2069 6e20 6465      if dep in de
-00029050: 7065 6e64 656e 7473 3a0a 2020 2020 2020  pendents:.      
-00029060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029070: 2020 6368 696c 645f 6465 7073 203d 2064    child_deps = d
-00029080: 6570 656e 6465 6e74 735b 6465 705d 0a20  ependents[dep]. 
-00029090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000290a0: 2020 2065 6c69 6620 6465 7020 696e 2073     elif dep in s
-000290b0: 656c 662e 7461 736b 733a 0a20 2020 2020  elf.tasks:.     
-000290c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000290d0: 2020 2063 6869 6c64 5f64 6570 7320 3d20     child_deps = 
-000290e0: 7365 6c66 2e74 6173 6b73 5b64 6570 5d2e  self.tasks[dep].
-000290f0: 6465 7065 6e64 656e 6369 6573 0a20 2020  dependencies.   
-00029100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029110: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00029120: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00029130: 6869 6c64 5f64 6570 7320 3d20 7365 7428  hild_deps = set(
-00029140: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00029150: 2020 2020 2020 6966 2061 6c6c 2864 2069        if all(d i
-00029160: 6e20 646f 6e65 2066 6f72 2064 2069 6e20  n done for d in 
-00029170: 6368 696c 645f 6465 7073 293a 0a20 2020  child_deps):.   
-00029180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029190: 2020 2020 2069 6620 6465 7020 696e 2073       if dep in s
-000291a0: 656c 662e 7461 736b 7320 616e 6420 6465  elf.tasks and de
-000291b0: 7020 6e6f 7420 696e 2064 6f6e 653a 0a20  p not in done:. 
-000291c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000291d0: 2020 2020 2020 2020 2020 2064 6f6e 652e             done.
-000291e0: 6164 6428 6465 7029 0a20 2020 2020 2020  add(dep).       
-000291f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029200: 2020 2020 2073 7461 636b 2e61 7070 656e       stack.appen
-00029210: 6428 6465 7029 0a20 2020 2020 2020 2066  d(dep).        f
-00029220: 6f72 2061 6e63 2069 6e20 646f 6e65 3a0a  or anc in done:.
-00029230: 2020 2020 2020 2020 2020 2020 6473 6b2e              dsk.
-00029240: 706f 7028 616e 632c 204e 6f6e 6529 0a20  pop(anc, None). 
-00029250: 2020 2020 2020 2020 2020 2064 6570 656e             depen
-00029260: 6465 6e63 6965 732e 706f 7028 616e 632c  dencies.pop(anc,
-00029270: 204e 6f6e 6529 0a20 2020 2020 2020 2072   None).        r
-00029280: 6574 7572 6e20 646f 6e65 0a0a 2020 2020  eturn done..    
-00029290: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
-000292a0: 2020 6465 6620 6d61 7465 7269 616c 697a    def materializ
-000292b0: 655f 6772 6170 6828 686c 673a 2048 6967  e_graph(hlg: Hig
-000292c0: 684c 6576 656c 4772 6170 6829 202d 3e20  hLevelGraph) -> 
-000292d0: 7475 706c 655b 6469 6374 2c20 6469 6374  tuple[dict, dict
-000292e0: 2c20 6469 6374 2c20 6469 6374 5d3a 0a20  , dict, dict]:. 
-000292f0: 2020 2020 2020 2066 726f 6d20 6469 7374         from dist
-00029300: 7269 6275 7465 642e 776f 726b 6572 2069  ributed.worker i
-00029310: 6d70 6f72 7420 6475 6d70 735f 7461 736b  mport dumps_task
-00029320: 0a0a 2020 2020 2020 2020 6b65 795f 616e  ..        key_an
-00029330: 6e6f 7461 7469 6f6e 7320 3d20 7b7d 0a20  notations = {}. 
-00029340: 2020 2020 2020 2064 736b 203d 2064 6173         dsk = das
-00029350: 6b2e 7574 696c 732e 656e 7375 7265 5f64  k.utils.ensure_d
-00029360: 6963 7428 686c 6729 0a0a 2020 2020 2020  ict(hlg)..      
-00029370: 2020 666f 7220 6c61 7965 7220 696e 2068    for layer in h
-00029380: 6c67 2e6c 6179 6572 732e 7661 6c75 6573  lg.layers.values
-00029390: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-000293a0: 6966 206c 6179 6572 2e61 6e6e 6f74 6174  if layer.annotat
-000293b0: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
-000293c0: 2020 2020 2020 616e 6e6f 7420 3d20 6c61        annot = la
-000293d0: 7965 722e 616e 6e6f 7461 7469 6f6e 730a  yer.annotations.
-000293e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000293f0: 6b65 795f 616e 6e6f 7461 7469 6f6e 732e  key_annotations.
-00029400: 7570 6461 7465 287b 7374 7269 6e67 6966  update({stringif
-00029410: 7928 6b29 3a20 616e 6e6f 7420 666f 7220  y(k): annot for 
-00029420: 6b20 696e 206c 6179 6572 7d29 0a0a 2020  k in layer})..  
-00029430: 2020 2020 2020 6465 7065 6e64 656e 6369        dependenci
-00029440: 6573 2c20 5f20 3d20 6765 745f 6465 7073  es, _ = get_deps
-00029450: 2864 736b 290a 0a20 2020 2020 2020 2023  (dsk)..        #
-00029460: 2052 656d 6f76 6520 6046 7574 7572 6560   Remove `Future`
-00029470: 206f 626a 6563 7473 2066 726f 6d20 6772   objects from gr
-00029480: 6170 6820 616e 6420 6e6f 7465 2061 6e79  aph and note any
-00029490: 2066 7574 7572 6520 6465 7065 6e64 656e   future dependen
-000294a0: 6369 6573 0a20 2020 2020 2020 2064 736b  cies.        dsk
-000294b0: 3220 3d20 7b7d 0a20 2020 2020 2020 2066  2 = {}.        f
-000294c0: 7574 5f64 6570 7320 3d20 7b7d 0a20 2020  ut_deps = {}.   
-000294d0: 2020 2020 2066 6f72 206b 2c20 7620 696e       for k, v in
-000294e0: 2064 736b 2e69 7465 6d73 2829 3a0a 2020   dsk.items():.  
-000294f0: 2020 2020 2020 2020 2020 6473 6b32 5b6b            dsk2[k
-00029500: 5d2c 2066 7574 7320 3d20 756e 7061 636b  ], futs = unpack
-00029510: 5f72 656d 6f74 6564 6174 6128 762c 2062  _remotedata(v, b
-00029520: 7974 655f 6b65 7973 3d54 7275 6529 0a20  yte_keys=True). 
-00029530: 2020 2020 2020 2020 2020 2069 6620 6675             if fu
-00029540: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-00029550: 2020 2020 6675 745f 6465 7073 5b6b 5d20      fut_deps[k] 
-00029560: 3d20 6675 7473 0a20 2020 2020 2020 2064  = futs.        d
-00029570: 736b 203d 2064 736b 320a 0a20 2020 2020  sk = dsk2..     
-00029580: 2020 2023 202d 2041 6464 2069 6e20 6465     # - Add in de
-00029590: 7073 2066 6f72 2061 6e79 2074 6173 6b73  ps for any tasks
-000295a0: 2074 6861 7420 6465 7065 6e64 206f 6e20   that depend on 
-000295b0: 6675 7475 7265 730a 2020 2020 2020 2020  futures.        
-000295c0: 666f 7220 6b2c 2066 7574 7572 6573 2069  for k, futures i
-000295d0: 6e20 6675 745f 6465 7073 2e69 7465 6d73  n fut_deps.items
-000295e0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-000295f0: 6465 7065 6e64 656e 6369 6573 5b6b 5d2e  dependencies[k].
-00029600: 7570 6461 7465 2866 2e6b 6579 2066 6f72  update(f.key for
-00029610: 2066 2069 6e20 6675 7475 7265 7329 0a20   f in futures). 
-00029620: 2020 2020 2020 206e 6577 5f64 736b 203d         new_dsk =
-00029630: 207b 7d0a 2020 2020 2020 2020 2320 416e   {}.        # An
-00029640: 6e6f 7461 7469 6f6e 2063 616c 6c61 626c  notation callabl
-00029650: 6573 2061 7265 2065 7661 6c75 6174 6564  es are evaluated
-00029660: 206f 6e20 7468 6520 6e6f 6e2d 7374 7269   on the non-stri
-00029670: 6e67 6966 6965 6420 7665 7273 696f 6e20  ngified version 
-00029680: 6f66 0a20 2020 2020 2020 2023 2074 6865  of.        # the
-00029690: 206b 6579 730a 2020 2020 2020 2020 7072   keys.        pr
-000296a0: 655f 7374 7269 6e67 6966 6965 645f 6b65  e_stringified_ke
-000296b0: 7973 203d 207b 7d0a 2020 2020 2020 2020  ys = {}.        
-000296c0: 6578 636c 7573 6976 6520 3d20 7365 7428  exclusive = set(
-000296d0: 686c 6729 0a20 2020 2020 2020 2066 6f72  hlg).        for
-000296e0: 206b 2c20 7620 696e 2064 736b 2e69 7465   k, v in dsk.ite
-000296f0: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-00029700: 2020 6e65 775f 6b20 3d20 7374 7269 6e67    new_k = string
-00029710: 6966 7928 6b29 0a20 2020 2020 2020 2020  ify(k).         
-00029720: 2020 2070 7265 5f73 7472 696e 6769 6669     pre_stringifi
-00029730: 6564 5f6b 6579 735b 6e65 775f 6b5d 203d  ed_keys[new_k] =
-00029740: 206b 0a20 2020 2020 2020 2020 2020 206e   k.            n
-00029750: 6577 5f64 736b 5b6e 6577 5f6b 5d20 3d20  ew_dsk[new_k] = 
-00029760: 7374 7269 6e67 6966 7928 762c 2065 7863  stringify(v, exc
-00029770: 6c75 7369 7665 3d65 7863 6c75 7369 7665  lusive=exclusive
-00029780: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-00029790: 206c 656e 286e 6577 5f64 736b 2920 3d3d   len(new_dsk) ==
-000297a0: 206c 656e 2870 7265 5f73 7472 696e 6769   len(pre_stringi
-000297b0: 6669 6564 5f6b 6579 7329 0a20 2020 2020  fied_keys).     
-000297c0: 2020 2064 736b 203d 206e 6577 5f64 736b     dsk = new_dsk
-000297d0: 0a20 2020 2020 2020 2064 6570 656e 6465  .        depende
-000297e0: 6e63 6965 7320 3d20 7b0a 2020 2020 2020  ncies = {.      
-000297f0: 2020 2020 2020 7374 7269 6e67 6966 7928        stringify(
-00029800: 6b29 3a20 7b73 7472 696e 6769 6679 2864  k): {stringify(d
-00029810: 6570 2920 666f 7220 6465 7020 696e 2064  ep) for dep in d
-00029820: 6570 737d 0a20 2020 2020 2020 2020 2020  eps}.           
-00029830: 2066 6f72 206b 2c20 6465 7073 2069 6e20   for k, deps in 
-00029840: 6465 7065 6e64 656e 6369 6573 2e69 7465  dependencies.ite
-00029850: 6d73 2829 0a20 2020 2020 2020 207d 0a0a  ms().        }..
-00029860: 2020 2020 2020 2020 2320 5265 6d6f 7665          # Remove
-00029870: 2061 6e79 2073 656c 662d 6465 7065 6e64   any self-depend
-00029880: 656e 6369 6573 2028 6861 7070 656e 7320  encies (happens 
-00029890: 6f6e 2074 6573 745f 7075 626c 6973 685f  on test_publish_
-000298a0: 6261 6728 2920 616e 6420 6f74 6865 7273  bag() and others
-000298b0: 290a 2020 2020 2020 2020 666f 7220 6b2c  ).        for k,
-000298c0: 2076 2069 6e20 6465 7065 6e64 656e 6369   v in dependenci
-000298d0: 6573 2e69 7465 6d73 2829 3a0a 2020 2020  es.items():.    
-000298e0: 2020 2020 2020 2020 6465 7073 203d 2073          deps = s
-000298f0: 6574 2876 290a 2020 2020 2020 2020 2020  et(v).          
-00029900: 2020 6966 206b 2069 6e20 6465 7073 3a0a    if k in deps:.
-00029910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029920: 6465 7073 2e72 656d 6f76 6528 6b29 0a20  deps.remove(k). 
-00029930: 2020 2020 2020 2020 2020 2064 6570 656e             depen
-00029940: 6465 6e63 6965 735b 6b5d 203d 2064 6570  dencies[k] = dep
-00029950: 730a 0a20 2020 2020 2020 2023 2052 656d  s..        # Rem
-00029960: 6f76 6520 616c 6961 7365 730a 2020 2020  ove aliases.    
-00029970: 2020 2020 666f 7220 6b20 696e 206c 6973      for k in lis
-00029980: 7428 6473 6b29 3a0a 2020 2020 2020 2020  t(dsk):.        
-00029990: 2020 2020 6966 2064 736b 5b6b 5d20 6973      if dsk[k] is
-000299a0: 206b 3a0a 2020 2020 2020 2020 2020 2020   k:.            
-000299b0: 2020 2020 6465 6c20 6473 6b5b 6b5d 0a20      del dsk[k]. 
-000299c0: 2020 2020 2020 2064 736b 203d 2076 616c         dsk = val
-000299d0: 6d61 7028 6475 6d70 735f 7461 736b 2c20  map(dumps_task, 
-000299e0: 6473 6b29 0a20 2020 2020 2020 2072 6574  dsk).        ret
-000299f0: 7572 6e20 6473 6b2c 2064 6570 656e 6465  urn dsk, depende
-00029a00: 6e63 6965 732c 206b 6579 5f61 6e6e 6f74  ncies, key_annot
-00029a10: 6174 696f 6e73 2c20 7072 655f 7374 7269  ations, pre_stri
-00029a20: 6e67 6966 6965 645f 6b65 7973 0a0a 2020  ngified_keys..  
-00029a30: 2020 6465 6620 7374 696d 756c 7573 5f71    def stimulus_q
-00029a40: 7565 7565 5f73 6c6f 7473 5f6d 6179 6265  ueue_slots_maybe
-00029a50: 5f6f 7065 6e65 6428 7365 6c66 2c20 2a2c  _opened(self, *,
-00029a60: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
-00029a70: 7229 202d 3e20 4e6f 6e65 3a0a 2020 2020  r) -> None:.    
-00029a80: 2020 2020 2222 2252 6573 706f 6e64 2074      """Respond t
-00029a90: 6f20 616e 2065 7665 6e74 2077 6869 6368  o an event which
-00029aa0: 206d 6179 2068 6176 6520 6f70 656e 6564   may have opened
-00029ab0: 2073 706f 7473 206f 6e20 776f 726b 6572   spots on worker
-00029ac0: 2074 6872 6561 6470 6f6f 6c73 0a0a 2020   threadpools..  
-00029ad0: 2020 2020 2020 5365 6c65 6374 7320 7468        Selects th
-00029ae0: 6520 6170 7072 6f70 7269 6174 6520 6e75  e appropriate nu
-00029af0: 6d62 6572 206f 6620 7461 736b 7320 6672  mber of tasks fr
-00029b00: 6f6d 2074 6865 2066 726f 6e74 206f 6620  om the front of 
-00029b10: 7468 6520 7175 6575 6520 6163 636f 7264  the queue accord
-00029b20: 696e 6720 746f 0a20 2020 2020 2020 2074  ing to.        t
-00029b30: 6865 2074 6f74 616c 206e 756d 6265 7220  he total number 
-00029b40: 6f66 2074 6173 6b20 736c 6f74 7320 6176  of task slots av
-00029b50: 6169 6c61 626c 6520 6f6e 2077 6f72 6b65  ailable on worke
-00029b60: 7273 2028 706f 7465 6e74 6961 6c6c 7920  rs (potentially 
-00029b70: 3029 2c20 616e 640a 2020 2020 2020 2020  0), and.        
-00029b80: 7472 616e 7369 7469 6f6e 7320 7468 656d  transitions them
-00029b90: 2074 6f20 6060 7072 6f63 6573 7369 6e67   to ``processing
-00029ba0: 6060 2e0a 0a20 2020 2020 2020 204e 6f74  ``...        Not
-00029bb0: 6573 0a20 2020 2020 2020 202d 2d2d 2d2d  es.        -----
-00029bc0: 0a20 2020 2020 2020 204f 7468 6572 2074  .        Other t
-00029bd0: 7261 6e73 6974 696f 6e73 2072 656c 6174  ransitions relat
-00029be0: 6564 2074 6f20 7468 6973 2073 7469 6d75  ed to this stimu
-00029bf0: 6c75 7320 7368 6f75 6c64 2062 6520 6675  lus should be fu
-00029c00: 6c6c 7920 7072 6f63 6573 7365 6420 6265  lly processed be
-00029c10: 666f 7265 6861 6e64 2c0a 2020 2020 2020  forehand,.      
-00029c20: 2020 736f 2061 6e79 2074 6173 6b73 2074    so any tasks t
-00029c30: 6861 7420 6265 6361 6d65 2072 756e 6e61  hat became runna
-00029c40: 626c 6520 6172 6520 616c 7265 6164 7920  ble are already 
-00029c50: 696e 2060 6070 726f 6365 7373 696e 6760  in ``processing`
-00029c60: 602e 204f 7468 6572 7769 7365 2c0a 2020  `. Otherwise,.  
-00029c70: 2020 2020 2020 6f76 6572 7072 6f64 7563        overproduc
-00029c80: 7469 6f6e 2063 616e 206f 6363 7572 2069  tion can occur i
-00029c90: 6620 7175 6575 6564 2074 6173 6b73 2067  f queued tasks g
-00029ca0: 6574 2073 6368 6564 756c 6564 2062 6566  et scheduled bef
-00029cb0: 6f72 6520 646f 776e 7374 7265 616d 2074  ore downstream t
-00029cc0: 6173 6b73 2e0a 0a20 2020 2020 2020 204d  asks...        M
-00029cd0: 7573 7420 6265 2063 616c 6c65 6420 6166  ust be called af
-00029ce0: 7465 7220 6063 6865 636b 5f69 646c 655f  ter `check_idle_
-00029cf0: 7361 7475 7261 7465 6460 3b20 692e 652e  saturated`; i.e.
-00029d00: 2060 6964 6c65 5f74 6173 6b5f 636f 756e   `idle_task_coun
-00029d10: 7460 206d 7573 7420 6265 2075 700a 2020  t` must be up.  
-00029d20: 2020 2020 2020 746f 2064 6174 652e 0a20        to date.. 
-00029d30: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00029d40: 2020 2069 6620 6e6f 7420 7365 6c66 2e71     if not self.q
-00029d50: 7565 7565 643a 0a20 2020 2020 2020 2020  ueued:.         
-00029d60: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-00029d70: 2020 736c 6f74 735f 6176 6169 6c61 626c    slots_availabl
-00029d80: 6520 3d20 7375 6d28 0a20 2020 2020 2020  e = sum(.       
-00029d90: 2020 2020 205f 7461 736b 5f73 6c6f 7473       _task_slots
-00029da0: 5f61 7661 696c 6162 6c65 2877 732c 2073  _available(ws, s
-00029db0: 656c 662e 574f 524b 4552 5f53 4154 5552  elf.WORKER_SATUR
-00029dc0: 4154 494f 4e29 0a20 2020 2020 2020 2020  ATION).         
-00029dd0: 2020 2066 6f72 2077 7320 696e 2073 656c     for ws in sel
-00029de0: 662e 6964 6c65 5f74 6173 6b5f 636f 756e  f.idle_task_coun
-00029df0: 740a 2020 2020 2020 2020 290a 2020 2020  t.        ).    
-00029e00: 2020 2020 6966 2073 6c6f 7473 5f61 7661      if slots_ava
-00029e10: 696c 6162 6c65 203d 3d20 303a 0a20 2020  ilable == 0:.   
-00029e20: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-00029e30: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
-00029e40: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
-00029e50: 207b 7d0a 2020 2020 2020 2020 666f 7220   {}.        for 
-00029e60: 7174 7320 696e 2073 656c 662e 7175 6575  qts in self.queu
-00029e70: 6564 2e70 6565 6b6e 2873 6c6f 7473 5f61  ed.peekn(slots_a
-00029e80: 7661 696c 6162 6c65 293a 0a20 2020 2020  vailable):.     
-00029e90: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
-00029ea0: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
-00029eb0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00029ec0: 7174 732e 7374 6174 6520 3d3d 2022 7175  qts.state == "qu
-00029ed0: 6575 6564 222c 2071 7473 2e73 7461 7465  eued", qts.state
-00029ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029ef0: 2061 7373 6572 7420 6e6f 7420 7174 732e   assert not qts.
-00029f00: 7072 6f63 6573 7369 6e67 5f6f 6e2c 2028  processing_on, (
-00029f10: 7174 732c 2071 7473 2e70 726f 6365 7373  qts, qts.process
-00029f20: 696e 675f 6f6e 290a 2020 2020 2020 2020  ing_on).        
-00029f30: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-00029f40: 6f74 2071 7473 2e77 6169 7469 6e67 5f6f  ot qts.waiting_o
-00029f50: 6e2c 2028 7174 732c 2071 7473 2e70 726f  n, (qts, qts.pro
-00029f60: 6365 7373 696e 675f 6f6e 290a 2020 2020  cessing_on).    
-00029f70: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00029f80: 7274 2071 7473 2e77 686f 5f77 616e 7473  rt qts.who_wants
-00029f90: 206f 7220 7174 732e 7761 6974 6572 732c   or qts.waiters,
-00029fa0: 2071 7473 0a20 2020 2020 2020 2020 2020   qts.           
-00029fb0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00029fc0: 5b71 7473 2e6b 6579 5d20 3d20 2270 726f  [qts.key] = "pro
-00029fd0: 6365 7373 696e 6722 0a0a 2020 2020 2020  cessing"..      
-00029fe0: 2020 7365 6c66 2e74 7261 6e73 6974 696f    self.transitio
-00029ff0: 6e73 2872 6563 6f6d 6d65 6e64 6174 696f  ns(recommendatio
-0002a000: 6e73 2c20 7374 696d 756c 7573 5f69 6429  ns, stimulus_id)
-0002a010: 0a0a 2020 2020 6465 6620 7374 696d 756c  ..    def stimul
-0002a020: 7573 5f74 6173 6b5f 6669 6e69 7368 6564  us_task_finished
-0002a030: 2873 656c 662c 206b 6579 2c20 776f 726b  (self, key, work
-0002a040: 6572 2c20 7374 696d 756c 7573 5f69 642c  er, stimulus_id,
-0002a050: 2072 756e 5f69 642c 202a 2a6b 7761 7267   run_id, **kwarg
-0002a060: 7329 3a0a 2020 2020 2020 2020 2222 224d  s):.        """M
-0002a070: 6172 6b20 7468 6174 2061 2074 6173 6b20  ark that a task 
-0002a080: 6861 7320 6669 6e69 7368 6564 2065 7865  has finished exe
-0002a090: 6375 7469 6f6e 206f 6e20 6120 7061 7274  cution on a part
-0002a0a0: 6963 756c 6172 2077 6f72 6b65 7222 2222  icular worker"""
-0002a0b0: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
-0002a0c0: 6465 6275 6728 2253 7469 6d75 6c75 7320  debug("Stimulus 
-0002a0d0: 7461 736b 2066 696e 6973 6865 6420 2573  task finished %s
-0002a0e0: 5b25 645d 2025 7322 2c20 6b65 792c 2072  [%d] %s", key, r
-0002a0f0: 756e 5f69 642c 2077 6f72 6b65 7229 0a0a  un_id, worker)..
-0002a100: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-0002a110: 6461 7469 6f6e 733a 2052 6563 7320 3d20  dations: Recs = 
-0002a120: 7b7d 0a20 2020 2020 2020 2063 6c69 656e  {}.        clien
-0002a130: 745f 6d73 6773 3a20 4d73 6773 203d 207b  t_msgs: Msgs = {
-0002a140: 7d0a 2020 2020 2020 2020 776f 726b 6572  }.        worker
-0002a150: 5f6d 7367 733a 204d 7367 7320 3d20 7b7d  _msgs: Msgs = {}
-0002a160: 0a0a 2020 2020 2020 2020 7773 3a20 576f  ..        ws: Wo
-0002a170: 726b 6572 5374 6174 6520 3d20 7365 6c66  rkerState = self
-0002a180: 2e77 6f72 6b65 7273 5b77 6f72 6b65 725d  .workers[worker]
-0002a190: 0a20 2020 2020 2020 2074 733a 2054 6173  .        ts: Tas
-0002a1a0: 6b53 7461 7465 203d 2073 656c 662e 7461  kState = self.ta
-0002a1b0: 736b 732e 6765 7428 6b65 7929 0a20 2020  sks.get(key).   
-0002a1c0: 2020 2020 2069 6620 7473 2069 7320 4e6f       if ts is No
-0002a1d0: 6e65 206f 7220 7473 2e73 7461 7465 2069  ne or ts.state i
-0002a1e0: 6e20 2822 7265 6c65 6173 6564 222c 2022  n ("released", "
-0002a1f0: 7175 6575 6564 2229 3a0a 2020 2020 2020  queued"):.      
-0002a200: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
-0002a210: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-0002a220: 2020 2020 2252 6563 6569 7665 6420 616c      "Received al
-0002a230: 7265 6164 7920 636f 6d70 7574 6564 2074  ready computed t
-0002a240: 6173 6b2c 2077 6f72 6b65 723a 2025 732c  ask, worker: %s,
-0002a250: 2073 7461 7465 3a20 2573 220a 2020 2020   state: %s".    
-0002a260: 2020 2020 2020 2020 2020 2020 222c 206b              ", k
-0002a270: 6579 3a20 2573 2c20 7768 6f5f 6861 733a  ey: %s, who_has:
-0002a280: 2025 7322 2c0a 2020 2020 2020 2020 2020   %s",.          
-0002a290: 2020 2020 2020 776f 726b 6572 2c0a 2020        worker,.  
-0002a2a0: 2020 2020 2020 2020 2020 2020 2020 7473                ts
-0002a2b0: 2e73 7461 7465 2069 6620 7473 2065 6c73  .state if ts els
-0002a2c0: 6520 2266 6f72 676f 7474 656e 222c 0a20  e "forgotten",. 
-0002a2d0: 2020 2020 2020 2020 2020 2020 2020 206b                 k
-0002a2e0: 6579 2c0a 2020 2020 2020 2020 2020 2020  ey,.            
-0002a2f0: 2020 2020 7473 2e77 686f 5f68 6173 2069      ts.who_has i
-0002a300: 6620 7473 2065 6c73 6520 7b7d 2c0a 2020  f ts else {},.  
-0002a310: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0002a320: 2020 2020 2020 2020 776f 726b 6572 5f6d          worker_m
-0002a330: 7367 735b 776f 726b 6572 5d20 3d20 5b0a  sgs[worker] = [.
-0002a340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a350: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0002a360: 2020 2020 2020 226f 7022 3a20 2266 7265        "op": "fre
-0002a370: 652d 6b65 7973 222c 0a20 2020 2020 2020  e-keys",.       
-0002a380: 2020 2020 2020 2020 2020 2020 2022 6b65               "ke
-0002a390: 7973 223a 205b 6b65 795d 2c0a 2020 2020  ys": [key],.    
-0002a3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a3b0: 2273 7469 6d75 6c75 735f 6964 223a 2073  "stimulus_id": s
-0002a3c0: 7469 6d75 6c75 735f 6964 2c0a 2020 2020  timulus_id,.    
-0002a3d0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0002a3e0: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
-0002a3f0: 2020 2020 656c 6966 2074 732e 7275 6e5f      elif ts.run_
-0002a400: 6964 2021 3d20 7275 6e5f 6964 3a0a 2020  id != run_id:.  
-0002a410: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-0002a420: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
-0002a430: 6e20 6f72 2074 732e 7072 6f63 6573 7369  n or ts.processi
-0002a440: 6e67 5f6f 6e2e 6164 6472 6573 7320 213d  ng_on.address !=
-0002a450: 2077 6f72 6b65 723a 0a20 2020 2020 2020   worker:.       
-0002a460: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-0002a470: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
-0002a480: 2020 2020 2020 2020 2020 2022 5265 6365             "Rece
-0002a490: 6976 6564 2073 7461 6c65 2074 6173 6b20  ived stale task 
-0002a4a0: 7275 6e2c 2077 6f72 6b65 723a 2025 732c  run, worker: %s,
-0002a4b0: 206b 6579 3a20 2573 2c20 7275 6e5f 6964   key: %s, run_id
-0002a4c0: 3a20 2564 2028 2564 2922 2c0a 2020 2020  : %d (%d)",.    
-0002a4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a4e0: 776f 726b 6572 2c0a 2020 2020 2020 2020  worker,.        
-0002a4f0: 2020 2020 2020 2020 2020 2020 6b65 792c              key,
-0002a500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a510: 2020 2020 2072 756e 5f69 642c 0a20 2020       run_id,.   
-0002a520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a530: 2074 732e 7275 6e5f 6964 2c0a 2020 2020   ts.run_id,.    
-0002a540: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0002a550: 2020 2020 2020 2020 2020 2020 2020 776f                wo
-0002a560: 726b 6572 5f6d 7367 735b 776f 726b 6572  rker_msgs[worker
-0002a570: 5d20 3d20 5b0a 2020 2020 2020 2020 2020  ] = [.          
-0002a580: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-0002a590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a5a0: 2020 2020 226f 7022 3a20 2266 7265 652d      "op": "free-
-0002a5b0: 6b65 7973 222c 0a20 2020 2020 2020 2020  keys",.         
-0002a5c0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0002a5d0: 6b65 7973 223a 205b 6b65 795d 2c0a 2020  keys": [key],.  
-0002a5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a5f0: 2020 2020 2020 2273 7469 6d75 6c75 735f        "stimulus_
-0002a600: 6964 223a 2073 7469 6d75 6c75 735f 6964  id": stimulus_id
-0002a610: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002a620: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0002a630: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-0002a640: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0002a650: 2020 2020 2020 2020 2020 2020 7265 636f              reco
-0002a660: 6d6d 656e 6461 7469 6f6e 735b 7473 2e6b  mmendations[ts.k
-0002a670: 6579 5d20 3d20 2272 656c 6561 7365 6422  ey] = "released"
-0002a680: 0a20 2020 2020 2020 2065 6c69 6620 7473  .        elif ts
-0002a690: 2e73 7461 7465 203d 3d20 226d 656d 6f72  .state == "memor
-0002a6a0: 7922 3a0a 2020 2020 2020 2020 2020 2020  y":.            
-0002a6b0: 7365 6c66 2e61 6464 5f6b 6579 7328 776f  self.add_keys(wo
-0002a6c0: 726b 6572 3d77 6f72 6b65 722c 206b 6579  rker=worker, key
-0002a6d0: 733d 5b6b 6579 5d29 0a20 2020 2020 2020  s=[key]).       
-0002a6e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0002a6f0: 2020 2074 732e 6d65 7461 6461 7461 2e75     ts.metadata.u
-0002a700: 7064 6174 6528 6b77 6172 6773 5b22 6d65  pdate(kwargs["me
-0002a710: 7461 6461 7461 225d 290a 2020 2020 2020  tadata"]).      
-0002a720: 2020 2020 2020 723a 2074 7570 6c65 203d        r: tuple =
-0002a730: 2073 656c 662e 5f74 7261 6e73 6974 696f   self._transitio
-0002a740: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-0002a750: 2020 206b 6579 2c20 226d 656d 6f72 7922     key, "memory"
-0002a760: 2c20 7374 696d 756c 7573 5f69 642c 2077  , stimulus_id, w
-0002a770: 6f72 6b65 723d 776f 726b 6572 2c20 2a2a  orker=worker, **
-0002a780: 6b77 6172 6773 0a20 2020 2020 2020 2020  kwargs.         
-0002a790: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0002a7a0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-0002a7b0: 2c20 636c 6965 6e74 5f6d 7367 732c 2077  , client_msgs, w
-0002a7c0: 6f72 6b65 725f 6d73 6773 203d 2072 0a0a  orker_msgs = r..
-0002a7d0: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-0002a7e0: 732e 7374 6174 6520 3d3d 2022 6d65 6d6f  s.state == "memo
-0002a7f0: 7279 223a 0a20 2020 2020 2020 2020 2020  ry":.           
-0002a800: 2020 2020 2061 7373 6572 7420 7773 2069       assert ws i
-0002a810: 6e20 7473 2e77 686f 5f68 6173 0a20 2020  n ts.who_has.   
-0002a820: 2020 2020 2072 6574 7572 6e20 7265 636f       return reco
-0002a830: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
-0002a840: 656e 745f 6d73 6773 2c20 776f 726b 6572  ent_msgs, worker
-0002a850: 5f6d 7367 730a 0a20 2020 2064 6566 2073  _msgs..    def s
-0002a860: 7469 6d75 6c75 735f 7461 736b 5f65 7272  timulus_task_err
-0002a870: 6564 280a 2020 2020 2020 2020 7365 6c66  ed(.        self
-0002a880: 2c0a 2020 2020 2020 2020 6b65 793d 4e6f  ,.        key=No
-0002a890: 6e65 2c0a 2020 2020 2020 2020 776f 726b  ne,.        work
-0002a8a0: 6572 3d4e 6f6e 652c 0a20 2020 2020 2020  er=None,.       
-0002a8b0: 2065 7863 6570 7469 6f6e 3d4e 6f6e 652c   exception=None,
-0002a8c0: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
-0002a8d0: 735f 6964 3d4e 6f6e 652c 0a20 2020 2020  s_id=None,.     
-0002a8e0: 2020 2074 7261 6365 6261 636b 3d4e 6f6e     traceback=Non
-0002a8f0: 652c 0a20 2020 2020 2020 202a 2a6b 7761  e,.        **kwa
-0002a900: 7267 732c 0a20 2020 2029 3a0a 2020 2020  rgs,.    ):.    
-0002a910: 2020 2020 2222 224d 6172 6b20 7468 6174      """Mark that
-0002a920: 2061 2074 6173 6b20 6861 7320 6572 7265   a task has erre
-0002a930: 6420 6f6e 2061 2070 6172 7469 6375 6c61  d on a particula
-0002a940: 7220 776f 726b 6572 2222 220a 2020 2020  r worker""".    
-0002a950: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
-0002a960: 2822 5374 696d 756c 7573 2074 6173 6b20  ("Stimulus task 
-0002a970: 6572 7265 6420 2573 2c20 2573 222c 206b  erred %s, %s", k
-0002a980: 6579 2c20 776f 726b 6572 290a 0a20 2020  ey, worker)..   
-0002a990: 2020 2020 2074 733a 2054 6173 6b53 7461       ts: TaskSta
-0002a9a0: 7465 203d 2073 656c 662e 7461 736b 732e  te = self.tasks.
-0002a9b0: 6765 7428 6b65 7929 0a20 2020 2020 2020  get(key).       
-0002a9c0: 2069 6620 7473 2069 7320 4e6f 6e65 206f   if ts is None o
-0002a9d0: 7220 7473 2e73 7461 7465 2021 3d20 2270  r ts.state != "p
-0002a9e0: 726f 6365 7373 696e 6722 3a0a 2020 2020  rocessing":.    
-0002a9f0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-0002aa00: 7d2c 207b 7d2c 207b 7d0a 0a20 2020 2020  }, {}, {}..     
-0002aa10: 2020 2069 6620 7473 2e72 6574 7269 6573     if ts.retries
-0002aa20: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
-0002aa30: 2020 7473 2e72 6574 7269 6573 202d 3d20    ts.retries -= 
-0002aa40: 310a 2020 2020 2020 2020 2020 2020 7265  1.            re
-0002aa50: 7475 726e 2073 656c 662e 5f74 7261 6e73  turn self._trans
-0002aa60: 6974 696f 6e28 6b65 792c 2022 7761 6974  ition(key, "wait
-0002aa70: 696e 6722 2c20 7374 696d 756c 7573 5f69  ing", stimulus_i
-0002aa80: 6429 0a20 2020 2020 2020 2065 6c73 653a  d).        else:
-0002aa90: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0002aaa0: 7572 6e20 7365 6c66 2e5f 7472 616e 7369  urn self._transi
-0002aab0: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
-0002aac0: 2020 2020 2020 6b65 792c 0a20 2020 2020        key,.     
-0002aad0: 2020 2020 2020 2020 2020 2022 6572 7265             "erre
-0002aae0: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
-0002aaf0: 2020 2020 7374 696d 756c 7573 5f69 642c      stimulus_id,
-0002ab00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ab10: 2063 6175 7365 3d6b 6579 2c0a 2020 2020   cause=key,.    
-0002ab20: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-0002ab30: 7074 696f 6e3d 6578 6365 7074 696f 6e2c  ption=exception,
-0002ab40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ab50: 2074 7261 6365 6261 636b 3d74 7261 6365   traceback=trace
-0002ab60: 6261 636b 2c0a 2020 2020 2020 2020 2020  back,.          
-0002ab70: 2020 2020 2020 776f 726b 6572 3d77 6f72        worker=wor
-0002ab80: 6b65 722c 0a20 2020 2020 2020 2020 2020  ker,.           
-0002ab90: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
-0002aba0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-0002abb0: 2020 6465 6620 7374 696d 756c 7573 5f72    def stimulus_r
-0002abc0: 6574 7279 2873 656c 662c 206b 6579 732c  etry(self, keys,
-0002abd0: 2063 6c69 656e 743d 4e6f 6e65 293a 0a20   client=None):. 
-0002abe0: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
-0002abf0: 666f 2822 436c 6965 6e74 2025 7320 7265  fo("Client %s re
-0002ac00: 7175 6573 7473 2074 6f20 7265 7472 7920  quests to retry 
-0002ac10: 2564 206b 6579 7322 2c20 636c 6965 6e74  %d keys", client
-0002ac20: 2c20 6c65 6e28 6b65 7973 2929 0a20 2020  , len(keys)).   
-0002ac30: 2020 2020 2069 6620 636c 6965 6e74 3a0a       if client:.
-0002ac40: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0002ac50: 2e6c 6f67 5f65 7665 6e74 2863 6c69 656e  .log_event(clien
-0002ac60: 742c 207b 2261 6374 696f 6e22 3a20 2272  t, {"action": "r
-0002ac70: 6574 7279 222c 2022 636f 756e 7422 3a20  etry", "count": 
-0002ac80: 6c65 6e28 6b65 7973 297d 290a 0a20 2020  len(keys)})..   
-0002ac90: 2020 2020 2073 7461 636b 203d 206c 6973       stack = lis
-0002aca0: 7428 6b65 7973 290a 2020 2020 2020 2020  t(keys).        
-0002acb0: 7365 656e 203d 2073 6574 2829 0a20 2020  seen = set().   
-0002acc0: 2020 2020 2072 6f6f 7473 203d 205b 5d0a       roots = [].
-0002acd0: 2020 2020 2020 2020 7768 696c 6520 7374          while st
-0002ace0: 6163 6b3a 0a20 2020 2020 2020 2020 2020  ack:.           
-0002acf0: 206b 6579 203d 2073 7461 636b 2e70 6f70   key = stack.pop
-0002ad00: 2829 0a20 2020 2020 2020 2020 2020 2073  ().            s
-0002ad10: 6565 6e2e 6164 6428 6b65 7929 0a20 2020  een.add(key).   
-0002ad20: 2020 2020 2020 2020 2074 7320 3d20 7365           ts = se
-0002ad30: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 2020  lf.tasks[key].  
-0002ad40: 2020 2020 2020 2020 2020 6572 7265 645f            erred_
-0002ad50: 6465 7073 203d 205b 6474 732e 6b65 7920  deps = [dts.key 
-0002ad60: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
-0002ad70: 7065 6e64 656e 6369 6573 2069 6620 6474  pendencies if dt
-0002ad80: 732e 7374 6174 6520 3d3d 2022 6572 7265  s.state == "erre
-0002ad90: 6422 5d0a 2020 2020 2020 2020 2020 2020  d"].            
-0002ada0: 6966 2065 7272 6564 5f64 6570 733a 0a20  if erred_deps:. 
-0002adb0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002adc0: 7461 636b 2e65 7874 656e 6428 6572 7265  tack.extend(erre
-0002add0: 645f 6465 7073 290a 2020 2020 2020 2020  d_deps).        
-0002ade0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0002adf0: 2020 2020 2020 2020 2020 726f 6f74 732e            roots.
-0002ae00: 6170 7065 6e64 286b 6579 290a 0a20 2020  append(key)..   
-0002ae10: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-0002ae20: 696f 6e73 3a20 5265 6373 203d 207b 6b65  ions: Recs = {ke
-0002ae30: 793a 2022 7761 6974 696e 6722 2066 6f72  y: "waiting" for
-0002ae40: 206b 6579 2069 6e20 726f 6f74 737d 0a20   key in roots}. 
-0002ae50: 2020 2020 2020 2073 656c 662e 7472 616e         self.tran
-0002ae60: 7369 7469 6f6e 7328 7265 636f 6d6d 656e  sitions(recommen
-0002ae70: 6461 7469 6f6e 732c 2066 2273 7469 6d75  dations, f"stimu
-0002ae80: 6c75 732d 7265 7472 792d 7b74 696d 6528  lus-retry-{time(
-0002ae90: 297d 2229 0a0a 2020 2020 2020 2020 6966  )}")..        if
-0002aea0: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
-0002aeb0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0002aec0: 6b65 7920 696e 2073 6565 6e3a 0a20 2020  key in seen:.   
-0002aed0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-0002aee0: 6572 7420 6e6f 7420 7365 6c66 2e74 6173  ert not self.tas
-0002aef0: 6b73 5b6b 6579 5d2e 6578 6365 7074 696f  ks[key].exceptio
-0002af00: 6e5f 626c 616d 650a 0a20 2020 2020 2020  n_blame..       
-0002af10: 2072 6574 7572 6e20 7475 706c 6528 7365   return tuple(se
-0002af20: 656e 290a 0a20 2020 2064 6566 2063 6c6f  en)..    def clo
-0002af30: 7365 5f77 6f72 6b65 7228 7365 6c66 2c20  se_worker(self, 
-0002af40: 776f 726b 6572 3a20 7374 7229 202d 3e20  worker: str) -> 
-0002af50: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
-0002af60: 2241 736b 2061 2077 6f72 6b65 7220 746f  "Ask a worker to
-0002af70: 2073 6875 7420 6974 7365 6c66 2064 6f77   shut itself dow
-0002af80: 6e2e 2044 6f20 6e6f 7420 7761 6974 2066  n. Do not wait f
-0002af90: 6f72 2069 7420 746f 2074 616b 6520 6566  or it to take ef
-0002afa0: 6665 6374 2e0a 2020 2020 2020 2020 4e6f  fect..        No
-0002afb0: 7465 2074 6861 7420 7468 6572 6520 6973  te that there is
-0002afc0: 206e 6f20 6775 6172 616e 7465 6520 7468   no guarantee th
-0002afd0: 6174 2074 6865 2077 6f72 6b65 7220 7769  at the worker wi
-0002afe0: 6c6c 2061 6374 7561 6c6c 7920 6163 6365  ll actually acce
-0002aff0: 7074 2074 6865 0a20 2020 2020 2020 2063  pt the.        c
-0002b000: 6f6d 6d61 6e64 2e0a 0a20 2020 2020 2020  ommand...       
-0002b010: 204e 6f74 6520 7468 6174 203a 6d65 7468   Note that :meth
-0002b020: 3a60 7265 6d6f 7665 5f77 6f72 6b65 7260  :`remove_worker`
-0002b030: 2073 656e 6473 2074 6865 2073 616d 6520   sends the same 
-0002b040: 636f 6d6d 616e 6420 696e 7465 726e 616c  command internal
-0002b050: 6c79 2069 6620 636c 6f73 653d 5472 7565  ly if close=True
-0002b060: 2e0a 0a20 2020 2020 2020 2053 6565 2061  ...        See a
-0002b070: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
-0002b080: 2d2d 2d2d 0a20 2020 2020 2020 2072 6574  ----.        ret
-0002b090: 6972 655f 776f 726b 6572 730a 2020 2020  ire_workers.    
-0002b0a0: 2020 2020 7265 6d6f 7665 5f77 6f72 6b65      remove_worke
-0002b0b0: 720a 2020 2020 2020 2020 2222 220a 2020  r.        """.  
-0002b0c0: 2020 2020 2020 6966 2077 6f72 6b65 7220        if worker 
-0002b0d0: 6e6f 7420 696e 2073 656c 662e 776f 726b  not in self.work
-0002b0e0: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
-0002b0f0: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
-0002b100: 206c 6f67 6765 722e 696e 666f 2822 436c   logger.info("Cl
-0002b110: 6f73 696e 6720 776f 726b 6572 2025 7322  osing worker %s"
-0002b120: 2c20 776f 726b 6572 290a 2020 2020 2020  , worker).      
-0002b130: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
-0002b140: 2877 6f72 6b65 722c 207b 2261 6374 696f  (worker, {"actio
-0002b150: 6e22 3a20 2263 6c6f 7365 2d77 6f72 6b65  n": "close-worke
-0002b160: 7222 7d29 0a20 2020 2020 2020 2073 656c  r"}).        sel
-0002b170: 662e 776f 726b 6572 5f73 656e 6428 776f  f.worker_send(wo
-0002b180: 726b 6572 2c20 7b22 6f70 223a 2022 636c  rker, {"op": "cl
-0002b190: 6f73 6522 2c20 2272 6561 736f 6e22 3a20  ose", "reason": 
-0002b1a0: 2273 6368 6564 756c 6572 2d63 6c6f 7365  "scheduler-close
-0002b1b0: 2d77 6f72 6b65 7222 7d29 0a0a 2020 2020  -worker"})..    
-0002b1c0: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
-0002b1d0: 6173 796e 6320 6465 6620 7265 6d6f 7665  async def remove
-0002b1e0: 5f77 6f72 6b65 7228 0a20 2020 2020 2020  _worker(.       
-0002b1f0: 2073 656c 662c 2061 6464 7265 7373 3a20   self, address: 
-0002b200: 7374 722c 202a 2c20 7374 696d 756c 7573  str, *, stimulus
-0002b210: 5f69 643a 2073 7472 2c20 7361 6665 3a20  _id: str, safe: 
-0002b220: 626f 6f6c 203d 2046 616c 7365 2c20 636c  bool = False, cl
-0002b230: 6f73 653a 2062 6f6f 6c20 3d20 5472 7565  ose: bool = True
-0002b240: 0a20 2020 2029 202d 3e20 4c69 7465 7261  .    ) -> Litera
-0002b250: 6c5b 224f 4b22 2c20 2261 6c72 6561 6479  l["OK", "already
-0002b260: 2d72 656d 6f76 6564 225d 3a0a 2020 2020  -removed"]:.    
-0002b270: 2020 2020 2222 2252 656d 6f76 6520 776f      """Remove wo
-0002b280: 726b 6572 2066 726f 6d20 636c 7573 7465  rker from cluste
-0002b290: 722e 0a0a 2020 2020 2020 2020 5765 2064  r...        We d
-0002b2a0: 6f20 7468 6973 2077 6865 6e20 6120 776f  o this when a wo
-0002b2b0: 726b 6572 2072 6570 6f72 7473 2074 6861  rker reports tha
-0002b2c0: 7420 6974 2070 6c61 6e73 2074 6f20 6c65  t it plans to le
-0002b2d0: 6176 6520 6f72 2077 6865 6e20 6974 2061  ave or when it a
-0002b2e0: 7070 6561 7273 2074 6f20 6265 0a20 2020  ppears to be.   
-0002b2f0: 2020 2020 2075 6e72 6573 706f 6e73 6976       unresponsiv
-0002b300: 652e 2054 6869 7320 6d61 7920 7365 6e64  e. This may send
-0002b310: 2069 7473 2074 6173 6b73 2062 6163 6b20   its tasks back 
-0002b320: 746f 2061 2072 656c 6561 7365 6420 7374  to a released st
-0002b330: 6174 652e 0a0a 2020 2020 2020 2020 5365  ate...        Se
-0002b340: 6520 616c 736f 0a20 2020 2020 2020 202d  e also.        -
-0002b350: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-0002b360: 7265 7469 7265 5f77 6f72 6b65 7273 0a20  retire_workers. 
-0002b370: 2020 2020 2020 2063 6c6f 7365 5f77 6f72         close_wor
-0002b380: 6b65 720a 2020 2020 2020 2020 2222 220a  ker.        """.
-0002b390: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0002b3a0: 7374 6174 7573 203d 3d20 5374 6174 7573  status == Status
-0002b3b0: 2e63 6c6f 7365 643a 0a20 2020 2020 2020  .closed:.       
-0002b3c0: 2020 2020 2072 6574 7572 6e20 2261 6c72       return "alr
-0002b3d0: 6561 6479 2d72 656d 6f76 6564 220a 0a20  eady-removed".. 
-0002b3e0: 2020 2020 2020 2061 6464 7265 7373 203d         address =
-0002b3f0: 2073 656c 662e 636f 6572 6365 5f61 6464   self.coerce_add
-0002b400: 7265 7373 2861 6464 7265 7373 290a 0a20  ress(address).. 
-0002b410: 2020 2020 2020 2069 6620 6164 6472 6573         if addres
-0002b420: 7320 6e6f 7420 696e 2073 656c 662e 776f  s not in self.wo
-0002b430: 726b 6572 733a 0a20 2020 2020 2020 2020  rkers:.         
-0002b440: 2020 2072 6574 7572 6e20 2261 6c72 6561     return "alrea
-0002b450: 6479 2d72 656d 6f76 6564 220a 0a20 2020  dy-removed"..   
-0002b460: 2020 2020 2068 6f73 7420 3d20 6765 745f       host = get_
-0002b470: 6164 6472 6573 735f 686f 7374 2861 6464  address_host(add
-0002b480: 7265 7373 290a 0a20 2020 2020 2020 2077  ress)..        w
-0002b490: 733a 2057 6f72 6b65 7253 7461 7465 203d  s: WorkerState =
-0002b4a0: 2073 656c 662e 776f 726b 6572 735b 6164   self.workers[ad
-0002b4b0: 6472 6573 735d 0a0a 2020 2020 2020 2020  dress]..        
-0002b4c0: 6576 656e 745f 6d73 6720 3d20 7b0a 2020  event_msg = {.  
-0002b4d0: 2020 2020 2020 2020 2020 2261 6374 696f            "actio
-0002b4e0: 6e22 3a20 2272 656d 6f76 652d 776f 726b  n": "remove-work
-0002b4f0: 6572 222c 0a20 2020 2020 2020 2020 2020  er",.           
-0002b500: 2022 7072 6f63 6573 7369 6e67 2d74 6173   "processing-tas
-0002b510: 6b73 223a 207b 7473 2e6b 6579 2066 6f72  ks": {ts.key for
-0002b520: 2074 7320 696e 2077 732e 7072 6f63 6573   ts in ws.proces
-0002b530: 7369 6e67 7d2c 0a20 2020 2020 2020 207d  sing},.        }
-0002b540: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
-0002b550: 675f 6576 656e 7428 6164 6472 6573 732c  g_event(address,
-0002b560: 2065 7665 6e74 5f6d 7367 2e63 6f70 7928   event_msg.copy(
-0002b570: 2929 0a20 2020 2020 2020 2065 7665 6e74  )).        event
-0002b580: 5f6d 7367 5b22 776f 726b 6572 225d 203d  _msg["worker"] =
-0002b590: 2061 6464 7265 7373 0a20 2020 2020 2020   address.       
-0002b5a0: 2073 656c 662e 6c6f 675f 6576 656e 7428   self.log_event(
-0002b5b0: 2261 6c6c 222c 2065 7665 6e74 5f6d 7367  "all", event_msg
-0002b5c0: 290a 0a20 2020 2020 2020 206c 6f67 6765  )..        logge
-0002b5d0: 722e 696e 666f 2822 5265 6d6f 7665 2077  r.info("Remove w
-0002b5e0: 6f72 6b65 7220 2573 222c 2077 7329 0a20  orker %s", ws). 
-0002b5f0: 2020 2020 2020 2069 6620 636c 6f73 653a         if close:
-0002b600: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
-0002b610: 6820 7375 7070 7265 7373 2841 7474 7269  h suppress(Attri
-0002b620: 6275 7465 4572 726f 722c 2043 6f6d 6d43  buteError, CommC
-0002b630: 6c6f 7365 6445 7272 6f72 293a 0a20 2020  losedError):.   
-0002b640: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0002b650: 662e 7374 7265 616d 5f63 6f6d 6d73 5b61  f.stream_comms[a
-0002b660: 6464 7265 7373 5d2e 7365 6e64 280a 2020  ddress].send(.  
-0002b670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b680: 2020 7b22 6f70 223a 2022 636c 6f73 6522    {"op": "close"
-0002b690: 2c20 2272 6561 736f 6e22 3a20 2273 6368  , "reason": "sch
-0002b6a0: 6564 756c 6572 2d72 656d 6f76 652d 776f  eduler-remove-wo
-0002b6b0: 726b 6572 227d 0a20 2020 2020 2020 2020  rker"}.         
-0002b6c0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0002b6d0: 2020 7365 6c66 2e72 656d 6f76 655f 7265    self.remove_re
-0002b6e0: 736f 7572 6365 7328 6164 6472 6573 7329  sources(address)
-0002b6f0: 0a0a 2020 2020 2020 2020 6468 3a20 6469  ..        dh: di
-0002b700: 6374 203d 2073 656c 662e 686f 7374 5f69  ct = self.host_i
-0002b710: 6e66 6f5b 686f 7374 5d0a 2020 2020 2020  nfo[host].      
-0002b720: 2020 6468 5f61 6464 7265 7373 6573 3a20    dh_addresses: 
-0002b730: 7365 7420 3d20 6468 5b22 6164 6472 6573  set = dh["addres
-0002b740: 7365 7322 5d0a 2020 2020 2020 2020 6468  ses"].        dh
-0002b750: 5f61 6464 7265 7373 6573 2e72 656d 6f76  _addresses.remov
-0002b760: 6528 6164 6472 6573 7329 0a20 2020 2020  e(address).     
-0002b770: 2020 2064 685b 226e 7468 7265 6164 7322     dh["nthreads"
-0002b780: 5d20 2d3d 2077 732e 6e74 6872 6561 6473  ] -= ws.nthreads
-0002b790: 0a20 2020 2020 2020 2073 656c 662e 746f  .        self.to
-0002b7a0: 7461 6c5f 6e74 6872 6561 6473 202d 3d20  tal_nthreads -= 
-0002b7b0: 7773 2e6e 7468 7265 6164 730a 2020 2020  ws.nthreads.    
-0002b7c0: 2020 2020 6966 206e 6f74 2064 685f 6164      if not dh_ad
-0002b7d0: 6472 6573 7365 733a 0a20 2020 2020 2020  dresses:.       
-0002b7e0: 2020 2020 2064 656c 2073 656c 662e 686f       del self.ho
-0002b7f0: 7374 5f69 6e66 6f5b 686f 7374 5d0a 0a20  st_info[host].. 
-0002b800: 2020 2020 2020 2073 656c 662e 7270 632e         self.rpc.
-0002b810: 7265 6d6f 7665 2861 6464 7265 7373 290a  remove(address).
-0002b820: 2020 2020 2020 2020 6465 6c20 7365 6c66          del self
-0002b830: 2e73 7472 6561 6d5f 636f 6d6d 735b 6164  .stream_comms[ad
-0002b840: 6472 6573 735d 0a20 2020 2020 2020 2064  dress].        d
-0002b850: 656c 2073 656c 662e 616c 6961 7365 735b  el self.aliases[
-0002b860: 7773 2e6e 616d 655d 0a20 2020 2020 2020  ws.name].       
-0002b870: 2073 656c 662e 6964 6c65 2e70 6f70 2877   self.idle.pop(w
-0002b880: 732e 6164 6472 6573 732c 204e 6f6e 6529  s.address, None)
-0002b890: 0a20 2020 2020 2020 2073 656c 662e 6964  .        self.id
-0002b8a0: 6c65 5f74 6173 6b5f 636f 756e 742e 6469  le_task_count.di
-0002b8b0: 7363 6172 6428 7773 290a 2020 2020 2020  scard(ws).      
-0002b8c0: 2020 7365 6c66 2e73 6174 7572 6174 6564    self.saturated
-0002b8d0: 2e64 6973 6361 7264 2877 7329 0a20 2020  .discard(ws).   
-0002b8e0: 2020 2020 2064 656c 2073 656c 662e 776f       del self.wo
-0002b8f0: 726b 6572 735b 6164 6472 6573 735d 0a20  rkers[address]. 
-0002b900: 2020 2020 2020 2077 732e 7374 6174 7573         ws.status
-0002b910: 203d 2053 7461 7475 732e 636c 6f73 6564   = Status.closed
-0002b920: 0a20 2020 2020 2020 2073 656c 662e 7275  .        self.ru
-0002b930: 6e6e 696e 672e 6469 7363 6172 6428 7773  nning.discard(ws
-0002b940: 290a 0a20 2020 2020 2020 2072 6563 6f6d  )..        recom
-0002b950: 6d65 6e64 6174 696f 6e73 3a20 5265 6373  mendations: Recs
-0002b960: 203d 207b 7d0a 0a20 2020 2020 2020 2074   = {}..        t
-0002b970: 733a 2054 6173 6b53 7461 7465 0a20 2020  s: TaskState.   
-0002b980: 2020 2020 2066 6f72 2074 7320 696e 206c       for ts in l
-0002b990: 6973 7428 7773 2e70 726f 6365 7373 696e  ist(ws.processin
-0002b9a0: 6729 3a0a 2020 2020 2020 2020 2020 2020  g):.            
-0002b9b0: 6b20 3d20 7473 2e6b 6579 0a20 2020 2020  k = ts.key.     
-0002b9c0: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
-0002b9d0: 6174 696f 6e73 5b6b 5d20 3d20 2272 656c  ations[k] = "rel
-0002b9e0: 6561 7365 6422 0a20 2020 2020 2020 2020  eased".         
-0002b9f0: 2020 2069 6620 6e6f 7420 7361 6665 3a0a     if not safe:.
-0002ba00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ba10: 7473 2e73 7573 7069 6369 6f75 7320 2b3d  ts.suspicious +=
-0002ba20: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
-0002ba30: 2020 2074 732e 7072 6566 6978 2e73 7573     ts.prefix.sus
-0002ba40: 7069 6369 6f75 7320 2b3d 2031 0a20 2020  picious += 1.   
-0002ba50: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0002ba60: 7473 2e73 7573 7069 6369 6f75 7320 3e20  ts.suspicious > 
-0002ba70: 7365 6c66 2e61 6c6c 6f77 6564 5f66 6169  self.allowed_fai
-0002ba80: 6c75 7265 733a 0a20 2020 2020 2020 2020  lures:.         
-0002ba90: 2020 2020 2020 2020 2020 2064 656c 2072             del r
-0002baa0: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b6b  ecommendations[k
-0002bab0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0002bac0: 2020 2020 2020 6520 3d20 7069 636b 6c65        e = pickle
-0002bad0: 2e64 756d 7073 280a 2020 2020 2020 2020  .dumps(.        
-0002bae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002baf0: 4b69 6c6c 6564 576f 726b 6572 280a 2020  KilledWorker(.  
-0002bb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bb10: 2020 2020 2020 2020 2020 7461 736b 3d6b            task=k
-0002bb20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002bb30: 2020 2020 2020 2020 2020 2020 2020 6c61                la
-0002bb40: 7374 5f77 6f72 6b65 723d 7773 2e63 6c65  st_worker=ws.cle
-0002bb50: 616e 2829 2c0a 2020 2020 2020 2020 2020  an(),.          
-0002bb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bb70: 2020 616c 6c6f 7765 645f 6661 696c 7572    allowed_failur
-0002bb80: 6573 3d73 656c 662e 616c 6c6f 7765 645f  es=self.allowed_
-0002bb90: 6661 696c 7572 6573 2c0a 2020 2020 2020  failures,.      
-0002bba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bbb0: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
-0002bbc0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0002bbd0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0002bbe0: 203d 2073 656c 662e 7472 616e 7369 7469   = self.transiti
-0002bbf0: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
-0002bc00: 2020 2020 2020 2020 2020 2020 6b2c 0a20              k,. 
-0002bc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bc20: 2020 2020 2020 2022 6572 7265 6422 2c0a         "erred",.
-0002bc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bc40: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
-0002bc50: 6e3d 652c 0a20 2020 2020 2020 2020 2020  n=e,.           
-0002bc60: 2020 2020 2020 2020 2020 2020 2063 6175               cau
-0002bc70: 7365 3d6b 2c0a 2020 2020 2020 2020 2020  se=k,.          
-0002bc80: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0002bc90: 696d 756c 7573 5f69 643d 7374 696d 756c  imulus_id=stimul
-0002bca0: 7573 5f69 642c 0a20 2020 2020 2020 2020  us_id,.         
-0002bcb0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0002bcc0: 6f72 6b65 723d 6164 6472 6573 732c 0a20  orker=address,. 
-0002bcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bce0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0002bcf0: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
-0002bd00: 6e64 6174 696f 6e73 2e75 7064 6174 6528  ndations.update(
-0002bd10: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-0002bd20: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
-0002bd30: 666f 280a 2020 2020 2020 2020 2020 2020  fo(.            
-0002bd40: 2020 2020 2020 2020 2020 2020 2254 6173              "Tas
-0002bd50: 6b20 2573 206d 6172 6b65 6420 6173 2066  k %s marked as f
-0002bd60: 6169 6c65 6420 6265 6361 7573 6520 2564  ailed because %d
-0002bd70: 2077 6f72 6b65 7273 2064 6965 6422 0a20   workers died". 
+00028070: 2020 2020 7473 2e6c 6f6f 7365 5f72 6573      ts.loose_res
+00028080: 7472 6963 7469 6f6e 7320 3d20 7661 6c75  trictions = valu
+00028090: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+000280a0: 2020 656c 6966 2061 6e6e 6f74 203d 3d20    elif annot == 
+000280b0: 2272 6573 6f75 7263 6573 223a 0a20 2020  "resources":.   
+000280c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000280d0: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
+000280e0: 6365 2876 616c 7565 2c20 6469 6374 290a  ce(value, dict).
+000280f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028100: 2020 2020 7473 2e72 6573 6f75 7263 655f      ts.resource_
+00028110: 7265 7374 7269 6374 696f 6e73 203d 2076  restrictions = v
+00028120: 616c 7565 0a20 2020 2020 2020 2020 2020  alue.           
+00028130: 2020 2020 2065 6c69 6620 616e 6e6f 7420       elif annot 
+00028140: 3d3d 2022 7072 696f 7269 7479 223a 0a20  == "priority":. 
+00028150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028160: 2020 2023 2053 6565 2053 6368 6564 756c     # See Schedul
+00028170: 6572 2e5f 7365 745f 7072 696f 7269 7469  er._set_prioriti
+00028180: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
+00028190: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+000281a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000281b0: 656c 6966 2061 6e6e 6f74 203d 3d20 2272  elif annot == "r
+000281c0: 6574 7269 6573 223a 0a20 2020 2020 2020  etries":.       
+000281d0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+000281e0: 6572 7420 6973 696e 7374 616e 6365 2876  ert isinstance(v
+000281f0: 616c 7565 2c20 696e 7429 0a20 2020 2020  alue, int).     
+00028200: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00028210: 732e 7265 7472 6965 7320 3d20 7661 6c75  s.retries = valu
+00028220: 650a 2020 2020 2020 2020 2020 2020 7473  e.            ts
+00028230: 2e61 6e6e 6f74 6174 696f 6e73 203d 206f  .annotations = o
+00028240: 7574 0a20 2020 2020 2020 2072 6574 7572  ut.        retur
+00028250: 6e20 6469 6374 2872 6573 6f6c 7665 645f  n dict(resolved_
+00028260: 616e 6e6f 7461 7469 6f6e 7329 0a0a 2020  annotations)..  
+00028270: 2020 6465 6620 5f73 6574 5f70 7269 6f72    def _set_prior
+00028280: 6974 6965 7328 0a20 2020 2020 2020 2073  ities(.        s
+00028290: 656c 662c 0a20 2020 2020 2020 2069 6e74  elf,.        int
+000282a0: 6572 6e61 6c5f 7072 696f 7269 7479 3a20  ernal_priority: 
+000282b0: 6469 6374 5b73 7472 2c20 696e 745d 207c  dict[str, int] |
+000282c0: 204e 6f6e 652c 0a20 2020 2020 2020 2073   None,.        s
+000282d0: 7562 6d69 7474 696e 675f 7461 736b 3a20  ubmitting_task: 
+000282e0: 7374 7220 7c20 4e6f 6e65 2c0a 2020 2020  str | None,.    
+000282f0: 2020 2020 7573 6572 5f70 7269 6f72 6974      user_priorit
+00028300: 793a 2069 6e74 207c 2064 6963 745b 7374  y: int | dict[st
+00028310: 722c 2069 6e74 5d2c 0a20 2020 2020 2020  r, int],.       
+00028320: 2066 6966 6f5f 7469 6d65 6f75 743a 2069   fifo_timeout: i
+00028330: 6e74 207c 2066 6c6f 6174 207c 2073 7472  nt | float | str
+00028340: 2c0a 2020 2020 2020 2020 7374 6172 743a  ,.        start:
+00028350: 2066 6c6f 6174 2c0a 2020 2020 2020 2020   float,.        
+00028360: 6473 6b3a 2064 6963 742c 0a20 2020 2020  dsk: dict,.     
+00028370: 2020 2074 6173 6b73 3a20 6c69 7374 5b54     tasks: list[T
+00028380: 6173 6b53 7461 7465 5d2c 0a20 2020 2020  askState],.     
+00028390: 2020 2064 6570 656e 6465 6e63 6965 733a     dependencies:
+000283a0: 2064 6963 742c 0a20 2020 2029 202d 3e20   dict,.    ) -> 
+000283b0: 4e6f 6e65 3a0a 2020 2020 2020 2020 6669  None:.        fi
+000283c0: 666f 5f74 696d 656f 7574 203d 2070 6172  fo_timeout = par
+000283d0: 7365 5f74 696d 6564 656c 7461 2866 6966  se_timedelta(fif
+000283e0: 6f5f 7469 6d65 6f75 7429 0a20 2020 2020  o_timeout).     
+000283f0: 2020 2069 6620 7375 626d 6974 7469 6e67     if submitting
+00028400: 5f74 6173 6b3a 2020 2320 7375 622d 7461  _task:  # sub-ta
+00028410: 736b 7320 6765 7420 6265 7474 6572 2070  sks get better p
+00028420: 7269 6f72 6974 7920 7468 616e 2070 6172  riority than par
+00028430: 656e 7420 7461 736b 730a 2020 2020 2020  ent tasks.      
+00028440: 2020 2020 2020 7374 7320 3d20 7365 6c66        sts = self
+00028450: 2e74 6173 6b73 2e67 6574 2873 7562 6d69  .tasks.get(submi
+00028460: 7474 696e 675f 7461 736b 290a 2020 2020  tting_task).    
+00028470: 2020 2020 2020 2020 6966 2073 7473 2069          if sts i
+00028480: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00028490: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000284a0: 7274 2073 7473 2e70 7269 6f72 6974 790a  rt sts.priority.
+000284b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000284c0: 6765 6e65 7261 7469 6f6e 203d 2073 7473  generation = sts
+000284d0: 2e70 7269 6f72 6974 795b 305d 202d 2030  .priority[0] - 0
+000284e0: 2e30 310a 2020 2020 2020 2020 2020 2020  .01.            
+000284f0: 656c 7365 3a20 2023 2073 7570 6572 2d74  else:  # super-t
+00028500: 6173 6b20 616c 7265 6164 7920 636c 6561  ask already clea
+00028510: 6e65 6420 7570 0a20 2020 2020 2020 2020  ned up.         
+00028520: 2020 2020 2020 2067 656e 6572 6174 696f         generatio
+00028530: 6e20 3d20 7365 6c66 2e67 656e 6572 6174  n = self.generat
+00028540: 696f 6e0a 2020 2020 2020 2020 656c 6966  ion.        elif
+00028550: 2073 656c 662e 5f6c 6173 745f 7469 6d65   self._last_time
+00028560: 202b 2066 6966 6f5f 7469 6d65 6f75 7420   + fifo_timeout 
+00028570: 3c20 7374 6172 743a 0a20 2020 2020 2020  < start:.       
+00028580: 2020 2020 2073 656c 662e 6765 6e65 7261       self.genera
+00028590: 7469 6f6e 202b 3d20 3120 2023 206f 6c64  tion += 1  # old
+000285a0: 6572 2067 7261 7068 2067 656e 6572 6174  er graph generat
+000285b0: 696f 6e73 2074 616b 6520 7072 6563 6564  ions take preced
+000285c0: 656e 6365 0a20 2020 2020 2020 2020 2020  ence.           
+000285d0: 2067 656e 6572 6174 696f 6e20 3d20 7365   generation = se
+000285e0: 6c66 2e67 656e 6572 6174 696f 6e0a 2020  lf.generation.  
+000285f0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00028600: 6c61 7374 5f74 696d 6520 3d20 7374 6172  last_time = star
+00028610: 740a 2020 2020 2020 2020 656c 7365 3a0a  t.        else:.
+00028620: 2020 2020 2020 2020 2020 2020 6765 6e65              gene
+00028630: 7261 7469 6f6e 203d 2073 656c 662e 6765  ration = self.ge
+00028640: 6e65 7261 7469 6f6e 0a0a 2020 2020 2020  neration..      
+00028650: 2020 6966 2069 6e74 6572 6e61 6c5f 7072    if internal_pr
+00028660: 696f 7269 7479 2069 7320 4e6f 6e65 3a0a  iority is None:.
+00028670: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
+00028680: 6d6f 7669 6e67 2061 6c6c 206e 6f6e 2d6c  moving all non-l
+00028690: 6f63 616c 206b 6579 7320 6265 666f 7265  ocal keys before
+000286a0: 2063 616c 6c69 6e67 206f 7264 6572 2829   calling order()
+000286b0: 0a20 2020 2020 2020 2020 2020 2064 736b  .            dsk
+000286c0: 5f6b 6579 7320 3d20 7365 7428 6473 6b29  _keys = set(dsk)
+000286d0: 2020 2320 696e 7465 7273 6563 7469 6f6e    # intersection
+000286e0: 2829 206f 6620 7365 7473 2069 7320 6d75  () of sets is mu
+000286f0: 6368 2066 6173 7465 7220 7468 616e 2064  ch faster than d
+00028700: 6963 745f 6b65 7973 0a20 2020 2020 2020  ict_keys.       
+00028710: 2020 2020 2073 7472 6970 7065 645f 6465       stripped_de
+00028720: 7073 203d 207b 0a20 2020 2020 2020 2020  ps = {.         
+00028730: 2020 2020 2020 206b 3a20 762e 696e 7465         k: v.inte
+00028740: 7273 6563 7469 6f6e 2864 736b 5f6b 6579  rsection(dsk_key
+00028750: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+00028760: 2020 2066 6f72 206b 2c20 7620 696e 2064     for k, v in d
+00028770: 6570 656e 6465 6e63 6965 732e 6974 656d  ependencies.item
+00028780: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
+00028790: 2020 2020 6966 206b 2069 6e20 6473 6b5f      if k in dsk_
+000287a0: 6b65 7973 0a20 2020 2020 2020 2020 2020  keys.           
+000287b0: 207d 0a20 2020 2020 2020 2020 2020 2069   }.            i
+000287c0: 6e74 6572 6e61 6c5f 7072 696f 7269 7479  nternal_priority
+000287d0: 203d 2064 6173 6b2e 6f72 6465 722e 6f72   = dask.order.or
+000287e0: 6465 7228 6473 6b2c 2064 6570 656e 6465  der(dsk, depende
+000287f0: 6e63 6965 733d 7374 7269 7070 6564 5f64  ncies=stripped_d
+00028800: 6570 7329 0a0a 2020 2020 2020 2020 666f  eps)..        fo
+00028810: 7220 7473 2069 6e20 7461 736b 733a 0a20  r ts in tasks:. 
+00028820: 2020 2020 2020 2020 2020 2023 204e 6f74             # Not
+00028830: 653a 2055 6e64 6572 2077 6869 6368 2063  e: Under which c
+00028840: 6972 6375 6d73 7461 6e63 6573 2077 6f75  ircumstances wou
+00028850: 6c64 2061 2074 6173 6b20 6e6f 7420 6861  ld a task not ha
+00028860: 7665 2061 0a20 2020 2020 2020 2020 2020  ve a.           
+00028870: 2023 2070 7269 6f72 6974 6979 2061 7373   # prioritiy ass
+00028880: 6967 6e65 6420 6279 206e 6f77 3f20 4172  igned by now? Ar
+00028890: 6520 7468 6573 6520 7363 6174 7465 7265  e these scattere
+000288a0: 6420 7461 736b 730a 2020 2020 2020 2020  d tasks.        
+000288b0: 2020 2020 2320 6578 636c 7573 6976 656c      # exclusivel
+000288c0: 7920 6f72 2073 6f6d 6574 6869 6e67 2065  y or something e
+000288d0: 6c73 653f 0a20 2020 2020 2020 2020 2020  lse?.           
+000288e0: 2074 6173 6b5f 7573 6572 5f70 7269 6f20   task_user_prio 
+000288f0: 3d20 7573 6572 5f70 7269 6f72 6974 790a  = user_priority.
+00028900: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+00028910: 7369 6e73 7461 6e63 6528 7573 6572 5f70  sinstance(user_p
+00028920: 7269 6f72 6974 792c 2064 6963 7429 3a0a  riority, dict):.
+00028930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028940: 7461 736b 5f75 7365 725f 7072 696f 203d  task_user_prio =
+00028950: 2075 7365 725f 7072 696f 7269 7479 2e67   user_priority.g
+00028960: 6574 2874 732e 6b65 792c 2030 290a 2020  et(ts.key, 0).  
+00028970: 2020 2020 2020 2020 2020 616e 6e6f 7461            annota
+00028980: 7465 645f 7072 696f 203d 2074 732e 616e  ted_prio = ts.an
+00028990: 6e6f 7461 7469 6f6e 732e 6765 7428 2270  notations.get("p
+000289a0: 7269 6f72 6974 7922 2c20 7b7d 290a 2020  riority", {}).  
+000289b0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+000289c0: 2061 6e6e 6f74 6174 6564 5f70 7269 6f3a   annotated_prio:
+000289d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000289e0: 2061 6e6e 6f74 6174 6564 5f70 7269 6f20   annotated_prio 
+000289f0: 3d20 7461 736b 5f75 7365 725f 7072 696f  = task_user_prio
+00028a00: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+00028a10: 206e 6f74 2074 732e 7072 696f 7269 7479   not ts.priority
+00028a20: 2061 6e64 2074 732e 6b65 7920 696e 2069   and ts.key in i
+00028a30: 6e74 6572 6e61 6c5f 7072 696f 7269 7479  nternal_priority
+00028a40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00028a50: 2020 7473 2e70 7269 6f72 6974 7920 3d20    ts.priority = 
+00028a60: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00028a70: 2020 2020 2020 2d61 6e6e 6f74 6174 6564        -annotated
+00028a80: 5f70 7269 6f2c 0a20 2020 2020 2020 2020  _prio,.         
+00028a90: 2020 2020 2020 2020 2020 2067 656e 6572             gener
+00028aa0: 6174 696f 6e2c 0a20 2020 2020 2020 2020  ation,.         
+00028ab0: 2020 2020 2020 2020 2020 2069 6e74 6572             inter
+00028ac0: 6e61 6c5f 7072 696f 7269 7479 5b74 732e  nal_priority[ts.
+00028ad0: 6b65 795d 2c0a 2020 2020 2020 2020 2020  key],.          
+00028ae0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00028af0: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
+00028b00: 6964 6174 6520 616e 6420 7473 2e72 756e  idate and ts.run
+00028b10: 5f73 7065 633a 0a20 2020 2020 2020 2020  _spec:.         
+00028b20: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
+00028b30: 696e 7374 616e 6365 2874 732e 7072 696f  instance(ts.prio
+00028b40: 7269 7479 2c20 7475 706c 6529 2061 6e64  rity, tuple) and
+00028b50: 2061 6c6c 280a 2020 2020 2020 2020 2020   all(.          
+00028b60: 2020 2020 2020 2020 2020 6973 696e 7374            isinst
+00028b70: 616e 6365 2865 6c2c 2028 696e 742c 2066  ance(el, (int, f
+00028b80: 6c6f 6174 2929 2066 6f72 2065 6c20 696e  loat)) for el in
+00028b90: 2074 732e 7072 696f 7269 7479 0a20 2020   ts.priority.   
+00028ba0: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
+00028bb0: 2020 2020 6465 6620 5f70 6f70 5f6c 6f73      def _pop_los
+00028bc0: 745f 7461 736b 7328 0a20 2020 2020 2020  t_tasks(.       
+00028bd0: 2073 656c 662c 2064 736b 3a20 6469 6374   self, dsk: dict
+00028be0: 2c20 6465 7065 6e64 656e 6369 6573 3a20  , dependencies: 
+00028bf0: 6469 6374 2c20 6b65 7973 3a20 7365 745b  dict, keys: set[
+00028c00: 7374 725d 0a20 2020 2029 202d 3e20 7365  str].    ) -> se
+00028c10: 745b 7374 725d 3a0a 2020 2020 2020 2020  t[str]:.        
+00028c20: 6e20 3d20 300a 2020 2020 2020 2020 6f75  n = 0.        ou
+00028c30: 7420 3d20 7365 7428 290a 2020 2020 2020  t = set().      
+00028c40: 2020 7768 696c 6520 6c65 6e28 6473 6b29    while len(dsk)
+00028c50: 2021 3d20 6e3a 2020 2320 7761 6c6b 2074   != n:  # walk t
+00028c60: 6872 6f75 6768 206e 6577 2074 6173 6b73  hrough new tasks
+00028c70: 2c20 6361 6e63 656c 2061 6e79 2062 6164  , cancel any bad
+00028c80: 2064 6570 730a 2020 2020 2020 2020 2020   deps.          
+00028c90: 2020 6e20 3d20 6c65 6e28 6473 6b29 0a20    n = len(dsk). 
+00028ca0: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
+00028cb0: 2c20 6465 7073 2069 6e20 6c69 7374 2864  , deps in list(d
+00028cc0: 6570 656e 6465 6e63 6965 732e 6974 656d  ependencies.item
+00028cd0: 7328 2929 3a0a 2020 2020 2020 2020 2020  s()):.          
+00028ce0: 2020 2020 2020 6966 2061 6e79 280a 2020        if any(.  
+00028cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028d00: 2020 6465 7020 6e6f 7420 696e 2073 656c    dep not in sel
+00028d10: 662e 7461 736b 7320 616e 6420 6465 7020  f.tasks and dep 
+00028d20: 6e6f 7420 696e 2064 736b 2066 6f72 2064  not in dsk for d
+00028d30: 6570 2069 6e20 6465 7073 0a20 2020 2020  ep in deps.     
+00028d40: 2020 2020 2020 2020 2020 2029 3a20 2023             ):  #
+00028d50: 2062 6164 206b 6579 0a20 2020 2020 2020   bad key.       
+00028d60: 2020 2020 2020 2020 2020 2020 206f 7574               out
+00028d70: 2e61 6464 286b 290a 2020 2020 2020 2020  .add(k).        
+00028d80: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00028d90: 6572 2e69 6e66 6f28 2255 7365 7220 6173  er.info("User as
+00028da0: 6b65 6420 666f 7220 636f 6d70 7574 6174  ked for computat
+00028db0: 696f 6e20 6f6e 206c 6f73 7420 6461 7461  ion on lost data
+00028dc0: 2c20 2573 222c 206b 290a 2020 2020 2020  , %s", k).      
+00028dd0: 2020 2020 2020 2020 2020 2020 2020 6465                de
+00028de0: 6c20 6473 6b5b 6b5d 0a20 2020 2020 2020  l dsk[k].       
+00028df0: 2020 2020 2020 2020 2020 2020 2064 656c               del
+00028e00: 2064 6570 656e 6465 6e63 6965 735b 6b5d   dependencies[k]
+00028e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028e20: 2020 2020 2069 6620 6b20 696e 206b 6579       if k in key
+00028e30: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00028e40: 2020 2020 2020 2020 2020 206b 6579 732e             keys.
+00028e50: 7265 6d6f 7665 286b 290a 2020 2020 2020  remove(k).      
+00028e60: 2020 7265 7475 726e 206f 7574 0a0a 2020    return out..  
+00028e70: 2020 6465 6620 5f70 6f70 5f6b 6e6f 776e    def _pop_known
+00028e80: 5f74 6173 6b73 2873 656c 662c 2064 736b  _tasks(self, dsk
+00028e90: 3a20 6469 6374 2c20 6465 7065 6e64 656e  : dict, dependen
+00028ea0: 6369 6573 3a20 6469 6374 2920 2d3e 2073  cies: dict) -> s
+00028eb0: 6574 5b73 7472 5d3a 0a20 2020 2020 2020  et[str]:.       
+00028ec0: 2023 2041 766f 6964 2063 6f6d 7075 7461   # Avoid computa
+00028ed0: 7469 6f6e 2074 6861 7420 6973 2061 6c72  tion that is alr
+00028ee0: 6561 6479 2066 696e 6973 6865 640a 2020  eady finished.  
+00028ef0: 2020 2020 2020 616c 7265 6164 795f 696e        already_in
+00028f00: 5f6d 656d 6f72 7920 3d20 7365 7428 2920  _memory = set() 
+00028f10: 2023 2074 6173 6b73 2074 6861 7420 6172   # tasks that ar
+00028f20: 6520 616c 7265 6164 7920 646f 6e65 0a20  e already done. 
+00028f30: 2020 2020 2020 2066 6f72 206b 2c20 7620         for k, v 
+00028f40: 696e 2064 6570 656e 6465 6e63 6965 732e  in dependencies.
+00028f50: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+00028f60: 2020 2020 2069 6620 7620 616e 6420 6b20       if v and k 
+00028f70: 696e 2073 656c 662e 7461 736b 733a 0a20  in self.tasks:. 
+00028f80: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00028f90: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
+00028fa0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00028fb0: 2020 6966 2074 732e 7374 6174 6520 696e    if ts.state in
+00028fc0: 2028 226d 656d 6f72 7922 2c20 2265 7272   ("memory", "err
+00028fd0: 6564 2229 3a0a 2020 2020 2020 2020 2020  ed"):.          
+00028fe0: 2020 2020 2020 2020 2020 616c 7265 6164            alread
+00028ff0: 795f 696e 5f6d 656d 6f72 792e 6164 6428  y_in_memory.add(
+00029000: 6b29 0a0a 2020 2020 2020 2020 646f 6e65  k)..        done
+00029010: 203d 2073 6574 2861 6c72 6561 6479 5f69   = set(already_i
+00029020: 6e5f 6d65 6d6f 7279 290a 2020 2020 2020  n_memory).      
+00029030: 2020 6966 2061 6c72 6561 6479 5f69 6e5f    if already_in_
+00029040: 6d65 6d6f 7279 3a0a 2020 2020 2020 2020  memory:.        
+00029050: 2020 2020 6465 7065 6e64 656e 7473 203d      dependents =
+00029060: 2064 6173 6b2e 636f 7265 2e72 6576 6572   dask.core.rever
+00029070: 7365 5f64 6963 7428 6465 7065 6e64 656e  se_dict(dependen
+00029080: 6369 6573 290a 2020 2020 2020 2020 2020  cies).          
+00029090: 2020 7374 6163 6b20 3d20 6c69 7374 2861    stack = list(a
+000290a0: 6c72 6561 6479 5f69 6e5f 6d65 6d6f 7279  lready_in_memory
+000290b0: 290a 2020 2020 2020 2020 2020 2020 7768  ).            wh
+000290c0: 696c 6520 7374 6163 6b3a 2020 2320 7265  ile stack:  # re
+000290d0: 6d6f 7665 2075 6e6e 6563 6573 7361 7279  move unnecessary
+000290e0: 2064 6570 656e 6465 6e63 6965 730a 2020   dependencies.  
+000290f0: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
+00029100: 7920 3d20 7374 6163 6b2e 706f 7028 290a  y = stack.pop().
+00029110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029120: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00029130: 2020 2020 2020 2020 2064 6570 7320 3d20           deps = 
+00029140: 6465 7065 6e64 656e 6369 6573 5b6b 6579  dependencies[key
+00029150: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00029160: 2020 6578 6365 7074 204b 6579 4572 726f    except KeyErro
+00029170: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+00029180: 2020 2020 2020 2064 6570 7320 3d20 7365         deps = se
+00029190: 6c66 2e74 6173 6b73 5b6b 6579 5d2e 6465  lf.tasks[key].de
+000291a0: 7065 6e64 656e 6369 6573 0a20 2020 2020  pendencies.     
+000291b0: 2020 2020 2020 2020 2020 2066 6f72 2064             for d
+000291c0: 6570 2069 6e20 6465 7073 3a0a 2020 2020  ep in deps:.    
+000291d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000291e0: 6966 2064 6570 2069 6e20 6465 7065 6e64  if dep in depend
+000291f0: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
+00029200: 2020 2020 2020 2020 2020 2020 2020 6368                ch
+00029210: 696c 645f 6465 7073 203d 2064 6570 656e  ild_deps = depen
+00029220: 6465 6e74 735b 6465 705d 0a20 2020 2020  dents[dep].     
+00029230: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00029240: 6c69 6620 6465 7020 696e 2073 656c 662e  lif dep in self.
+00029250: 7461 736b 733a 0a20 2020 2020 2020 2020  tasks:.         
+00029260: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00029270: 6869 6c64 5f64 6570 7320 3d20 7365 6c66  hild_deps = self
+00029280: 2e74 6173 6b73 5b64 6570 5d2e 6465 7065  .tasks[dep].depe
+00029290: 6e64 656e 6369 6573 0a20 2020 2020 2020  ndencies.       
+000292a0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+000292b0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000292c0: 2020 2020 2020 2020 2020 2063 6869 6c64             child
+000292d0: 5f64 6570 7320 3d20 7365 7428 290a 2020  _deps = set().  
+000292e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000292f0: 2020 6966 2061 6c6c 2864 2069 6e20 646f    if all(d in do
+00029300: 6e65 2066 6f72 2064 2069 6e20 6368 696c  ne for d in chil
+00029310: 645f 6465 7073 293a 0a20 2020 2020 2020  d_deps):.       
+00029320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029330: 2069 6620 6465 7020 696e 2073 656c 662e   if dep in self.
+00029340: 7461 736b 7320 616e 6420 6465 7020 6e6f  tasks and dep no
+00029350: 7420 696e 2064 6f6e 653a 0a20 2020 2020  t in done:.     
+00029360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029370: 2020 2020 2020 2064 6f6e 652e 6164 6428         done.add(
+00029380: 6465 7029 0a20 2020 2020 2020 2020 2020  dep).           
+00029390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000293a0: 2073 7461 636b 2e61 7070 656e 6428 6465   stack.append(de
+000293b0: 7029 0a20 2020 2020 2020 2066 6f72 2061  p).        for a
+000293c0: 6e63 2069 6e20 646f 6e65 3a0a 2020 2020  nc in done:.    
+000293d0: 2020 2020 2020 2020 6473 6b2e 706f 7028          dsk.pop(
+000293e0: 616e 632c 204e 6f6e 6529 0a20 2020 2020  anc, None).     
+000293f0: 2020 2020 2020 2064 6570 656e 6465 6e63         dependenc
+00029400: 6965 732e 706f 7028 616e 632c 204e 6f6e  ies.pop(anc, Non
+00029410: 6529 0a20 2020 2020 2020 2072 6574 7572  e).        retur
+00029420: 6e20 646f 6e65 0a0a 2020 2020 4073 7461  n done..    @sta
+00029430: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
+00029440: 6620 6d61 7465 7269 616c 697a 655f 6772  f materialize_gr
+00029450: 6170 6828 686c 673a 2048 6967 684c 6576  aph(hlg: HighLev
+00029460: 656c 4772 6170 6829 202d 3e20 7475 706c  elGraph) -> tupl
+00029470: 655b 6469 6374 2c20 6469 6374 2c20 6469  e[dict, dict, di
+00029480: 6374 2c20 6469 6374 5d3a 0a20 2020 2020  ct, dict]:.     
+00029490: 2020 2066 726f 6d20 6469 7374 7269 6275     from distribu
+000294a0: 7465 642e 776f 726b 6572 2069 6d70 6f72  ted.worker impor
+000294b0: 7420 6475 6d70 735f 7461 736b 0a0a 2020  t dumps_task..  
+000294c0: 2020 2020 2020 6b65 795f 616e 6e6f 7461        key_annota
+000294d0: 7469 6f6e 7320 3d20 7b7d 0a20 2020 2020  tions = {}.     
+000294e0: 2020 2064 736b 203d 2064 6173 6b2e 7574     dsk = dask.ut
+000294f0: 696c 732e 656e 7375 7265 5f64 6963 7428  ils.ensure_dict(
+00029500: 686c 6729 0a0a 2020 2020 2020 2020 666f  hlg)..        fo
+00029510: 7220 6c61 7965 7220 696e 2068 6c67 2e6c  r layer in hlg.l
+00029520: 6179 6572 732e 7661 6c75 6573 2829 3a0a  ayers.values():.
+00029530: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+00029540: 6179 6572 2e61 6e6e 6f74 6174 696f 6e73  ayer.annotations
+00029550: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00029560: 2020 616e 6e6f 7420 3d20 6c61 7965 722e    annot = layer.
+00029570: 616e 6e6f 7461 7469 6f6e 730a 2020 2020  annotations.    
+00029580: 2020 2020 2020 2020 2020 2020 6b65 795f              key_
+00029590: 616e 6e6f 7461 7469 6f6e 732e 7570 6461  annotations.upda
+000295a0: 7465 287b 7374 7269 6e67 6966 7928 6b29  te({stringify(k)
+000295b0: 3a20 616e 6e6f 7420 666f 7220 6b20 696e  : annot for k in
+000295c0: 206c 6179 6572 7d29 0a0a 2020 2020 2020   layer})..      
+000295d0: 2020 6465 7065 6e64 656e 6369 6573 2c20    dependencies, 
+000295e0: 5f20 3d20 6765 745f 6465 7073 2864 736b  _ = get_deps(dsk
+000295f0: 290a 0a20 2020 2020 2020 2023 2052 656d  )..        # Rem
+00029600: 6f76 6520 6046 7574 7572 6560 206f 626a  ove `Future` obj
+00029610: 6563 7473 2066 726f 6d20 6772 6170 6820  ects from graph 
+00029620: 616e 6420 6e6f 7465 2061 6e79 2066 7574  and note any fut
+00029630: 7572 6520 6465 7065 6e64 656e 6369 6573  ure dependencies
+00029640: 0a20 2020 2020 2020 2064 736b 3220 3d20  .        dsk2 = 
+00029650: 7b7d 0a20 2020 2020 2020 2066 7574 5f64  {}.        fut_d
+00029660: 6570 7320 3d20 7b7d 0a20 2020 2020 2020  eps = {}.       
+00029670: 2066 6f72 206b 2c20 7620 696e 2064 736b   for k, v in dsk
+00029680: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+00029690: 2020 2020 2020 6473 6b32 5b6b 5d2c 2066        dsk2[k], f
+000296a0: 7574 7320 3d20 756e 7061 636b 5f72 656d  uts = unpack_rem
+000296b0: 6f74 6564 6174 6128 762c 2062 7974 655f  otedata(v, byte_
+000296c0: 6b65 7973 3d54 7275 6529 0a20 2020 2020  keys=True).     
+000296d0: 2020 2020 2020 2069 6620 6675 7473 3a0a         if futs:.
+000296e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000296f0: 6675 745f 6465 7073 5b6b 5d20 3d20 6675  fut_deps[k] = fu
+00029700: 7473 0a20 2020 2020 2020 2064 736b 203d  ts.        dsk =
+00029710: 2064 736b 320a 0a20 2020 2020 2020 2023   dsk2..        #
+00029720: 202d 2041 6464 2069 6e20 6465 7073 2066   - Add in deps f
+00029730: 6f72 2061 6e79 2074 6173 6b73 2074 6861  or any tasks tha
+00029740: 7420 6465 7065 6e64 206f 6e20 6675 7475  t depend on futu
+00029750: 7265 730a 2020 2020 2020 2020 666f 7220  res.        for 
+00029760: 6b2c 2066 7574 7572 6573 2069 6e20 6675  k, futures in fu
+00029770: 745f 6465 7073 2e69 7465 6d73 2829 3a0a  t_deps.items():.
+00029780: 2020 2020 2020 2020 2020 2020 6465 7065              depe
+00029790: 6e64 656e 6369 6573 5b6b 5d2e 7570 6461  ndencies[k].upda
+000297a0: 7465 2866 2e6b 6579 2066 6f72 2066 2069  te(f.key for f i
+000297b0: 6e20 6675 7475 7265 7329 0a20 2020 2020  n futures).     
+000297c0: 2020 206e 6577 5f64 736b 203d 207b 7d0a     new_dsk = {}.
+000297d0: 2020 2020 2020 2020 2320 416e 6e6f 7461          # Annota
+000297e0: 7469 6f6e 2063 616c 6c61 626c 6573 2061  tion callables a
+000297f0: 7265 2065 7661 6c75 6174 6564 206f 6e20  re evaluated on 
+00029800: 7468 6520 6e6f 6e2d 7374 7269 6e67 6966  the non-stringif
+00029810: 6965 6420 7665 7273 696f 6e20 6f66 0a20  ied version of. 
+00029820: 2020 2020 2020 2023 2074 6865 206b 6579         # the key
+00029830: 730a 2020 2020 2020 2020 7072 655f 7374  s.        pre_st
+00029840: 7269 6e67 6966 6965 645f 6b65 7973 203d  ringified_keys =
+00029850: 207b 7d0a 2020 2020 2020 2020 6578 636c   {}.        excl
+00029860: 7573 6976 6520 3d20 7365 7428 686c 6729  usive = set(hlg)
+00029870: 0a20 2020 2020 2020 2066 6f72 206b 2c20  .        for k, 
+00029880: 7620 696e 2064 736b 2e69 7465 6d73 2829  v in dsk.items()
+00029890: 3a0a 2020 2020 2020 2020 2020 2020 6e65  :.            ne
+000298a0: 775f 6b20 3d20 7374 7269 6e67 6966 7928  w_k = stringify(
+000298b0: 6b29 0a20 2020 2020 2020 2020 2020 2070  k).            p
+000298c0: 7265 5f73 7472 696e 6769 6669 6564 5f6b  re_stringified_k
+000298d0: 6579 735b 6e65 775f 6b5d 203d 206b 0a20  eys[new_k] = k. 
+000298e0: 2020 2020 2020 2020 2020 206e 6577 5f64             new_d
+000298f0: 736b 5b6e 6577 5f6b 5d20 3d20 7374 7269  sk[new_k] = stri
+00029900: 6e67 6966 7928 762c 2065 7863 6c75 7369  ngify(v, exclusi
+00029910: 7665 3d65 7863 6c75 7369 7665 290a 2020  ve=exclusive).  
+00029920: 2020 2020 2020 6173 7365 7274 206c 656e        assert len
+00029930: 286e 6577 5f64 736b 2920 3d3d 206c 656e  (new_dsk) == len
+00029940: 2870 7265 5f73 7472 696e 6769 6669 6564  (pre_stringified
+00029950: 5f6b 6579 7329 0a20 2020 2020 2020 2064  _keys).        d
+00029960: 736b 203d 206e 6577 5f64 736b 0a20 2020  sk = new_dsk.   
+00029970: 2020 2020 2064 6570 656e 6465 6e63 6965       dependencie
+00029980: 7320 3d20 7b0a 2020 2020 2020 2020 2020  s = {.          
+00029990: 2020 7374 7269 6e67 6966 7928 6b29 3a20    stringify(k): 
+000299a0: 7b73 7472 696e 6769 6679 2864 6570 2920  {stringify(dep) 
+000299b0: 666f 7220 6465 7020 696e 2064 6570 737d  for dep in deps}
+000299c0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+000299d0: 206b 2c20 6465 7073 2069 6e20 6465 7065   k, deps in depe
+000299e0: 6e64 656e 6369 6573 2e69 7465 6d73 2829  ndencies.items()
+000299f0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+00029a00: 2020 2020 2320 5265 6d6f 7665 2061 6e79      # Remove any
+00029a10: 2073 656c 662d 6465 7065 6e64 656e 6369   self-dependenci
+00029a20: 6573 2028 6861 7070 656e 7320 6f6e 2074  es (happens on t
+00029a30: 6573 745f 7075 626c 6973 685f 6261 6728  est_publish_bag(
+00029a40: 2920 616e 6420 6f74 6865 7273 290a 2020  ) and others).  
+00029a50: 2020 2020 2020 666f 7220 6b2c 2076 2069        for k, v i
+00029a60: 6e20 6465 7065 6e64 656e 6369 6573 2e69  n dependencies.i
+00029a70: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
+00029a80: 2020 2020 6465 7073 203d 2073 6574 2876      deps = set(v
+00029a90: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00029aa0: 206b 2069 6e20 6465 7073 3a0a 2020 2020   k in deps:.    
+00029ab0: 2020 2020 2020 2020 2020 2020 6465 7073              deps
+00029ac0: 2e72 656d 6f76 6528 6b29 0a20 2020 2020  .remove(k).     
+00029ad0: 2020 2020 2020 2064 6570 656e 6465 6e63         dependenc
+00029ae0: 6965 735b 6b5d 203d 2064 6570 730a 0a20  ies[k] = deps.. 
+00029af0: 2020 2020 2020 2023 2052 656d 6f76 6520         # Remove 
+00029b00: 616c 6961 7365 730a 2020 2020 2020 2020  aliases.        
+00029b10: 666f 7220 6b20 696e 206c 6973 7428 6473  for k in list(ds
+00029b20: 6b29 3a0a 2020 2020 2020 2020 2020 2020  k):.            
+00029b30: 6966 2064 736b 5b6b 5d20 6973 206b 3a0a  if dsk[k] is k:.
+00029b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029b50: 6465 6c20 6473 6b5b 6b5d 0a20 2020 2020  del dsk[k].     
+00029b60: 2020 2064 736b 203d 2076 616c 6d61 7028     dsk = valmap(
+00029b70: 6475 6d70 735f 7461 736b 2c20 6473 6b29  dumps_task, dsk)
+00029b80: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00029b90: 6473 6b2c 2064 6570 656e 6465 6e63 6965  dsk, dependencie
+00029ba0: 732c 206b 6579 5f61 6e6e 6f74 6174 696f  s, key_annotatio
+00029bb0: 6e73 2c20 7072 655f 7374 7269 6e67 6966  ns, pre_stringif
+00029bc0: 6965 645f 6b65 7973 0a0a 2020 2020 6465  ied_keys..    de
+00029bd0: 6620 7374 696d 756c 7573 5f71 7565 7565  f stimulus_queue
+00029be0: 5f73 6c6f 7473 5f6d 6179 6265 5f6f 7065  _slots_maybe_ope
+00029bf0: 6e65 6428 7365 6c66 2c20 2a2c 2073 7469  ned(self, *, sti
+00029c00: 6d75 6c75 735f 6964 3a20 7374 7229 202d  mulus_id: str) -
+00029c10: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00029c20: 2222 2252 6573 706f 6e64 2074 6f20 616e  """Respond to an
+00029c30: 2065 7665 6e74 2077 6869 6368 206d 6179   event which may
+00029c40: 2068 6176 6520 6f70 656e 6564 2073 706f   have opened spo
+00029c50: 7473 206f 6e20 776f 726b 6572 2074 6872  ts on worker thr
+00029c60: 6561 6470 6f6f 6c73 0a0a 2020 2020 2020  eadpools..      
+00029c70: 2020 5365 6c65 6374 7320 7468 6520 6170    Selects the ap
+00029c80: 7072 6f70 7269 6174 6520 6e75 6d62 6572  propriate number
+00029c90: 206f 6620 7461 736b 7320 6672 6f6d 2074   of tasks from t
+00029ca0: 6865 2066 726f 6e74 206f 6620 7468 6520  he front of the 
+00029cb0: 7175 6575 6520 6163 636f 7264 696e 6720  queue according 
+00029cc0: 746f 0a20 2020 2020 2020 2074 6865 2074  to.        the t
+00029cd0: 6f74 616c 206e 756d 6265 7220 6f66 2074  otal number of t
+00029ce0: 6173 6b20 736c 6f74 7320 6176 6169 6c61  ask slots availa
+00029cf0: 626c 6520 6f6e 2077 6f72 6b65 7273 2028  ble on workers (
+00029d00: 706f 7465 6e74 6961 6c6c 7920 3029 2c20  potentially 0), 
+00029d10: 616e 640a 2020 2020 2020 2020 7472 616e  and.        tran
+00029d20: 7369 7469 6f6e 7320 7468 656d 2074 6f20  sitions them to 
+00029d30: 6060 7072 6f63 6573 7369 6e67 6060 2e0a  ``processing``..
+00029d40: 0a20 2020 2020 2020 204e 6f74 6573 0a20  .        Notes. 
+00029d50: 2020 2020 2020 202d 2d2d 2d2d 0a20 2020         -----.   
+00029d60: 2020 2020 204f 7468 6572 2074 7261 6e73       Other trans
+00029d70: 6974 696f 6e73 2072 656c 6174 6564 2074  itions related t
+00029d80: 6f20 7468 6973 2073 7469 6d75 6c75 7320  o this stimulus 
+00029d90: 7368 6f75 6c64 2062 6520 6675 6c6c 7920  should be fully 
+00029da0: 7072 6f63 6573 7365 6420 6265 666f 7265  processed before
+00029db0: 6861 6e64 2c0a 2020 2020 2020 2020 736f  hand,.        so
+00029dc0: 2061 6e79 2074 6173 6b73 2074 6861 7420   any tasks that 
+00029dd0: 6265 6361 6d65 2072 756e 6e61 626c 6520  became runnable 
+00029de0: 6172 6520 616c 7265 6164 7920 696e 2060  are already in `
+00029df0: 6070 726f 6365 7373 696e 6760 602e 204f  `processing``. O
+00029e00: 7468 6572 7769 7365 2c0a 2020 2020 2020  therwise,.      
+00029e10: 2020 6f76 6572 7072 6f64 7563 7469 6f6e    overproduction
+00029e20: 2063 616e 206f 6363 7572 2069 6620 7175   can occur if qu
+00029e30: 6575 6564 2074 6173 6b73 2067 6574 2073  eued tasks get s
+00029e40: 6368 6564 756c 6564 2062 6566 6f72 6520  cheduled before 
+00029e50: 646f 776e 7374 7265 616d 2074 6173 6b73  downstream tasks
+00029e60: 2e0a 0a20 2020 2020 2020 204d 7573 7420  ...        Must 
+00029e70: 6265 2063 616c 6c65 6420 6166 7465 7220  be called after 
+00029e80: 6063 6865 636b 5f69 646c 655f 7361 7475  `check_idle_satu
+00029e90: 7261 7465 6460 3b20 692e 652e 2060 6964  rated`; i.e. `id
+00029ea0: 6c65 5f74 6173 6b5f 636f 756e 7460 206d  le_task_count` m
+00029eb0: 7573 7420 6265 2075 700a 2020 2020 2020  ust be up.      
+00029ec0: 2020 746f 2064 6174 652e 0a20 2020 2020    to date..     
+00029ed0: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
+00029ee0: 6620 6e6f 7420 7365 6c66 2e71 7565 7565  f not self.queue
+00029ef0: 643a 0a20 2020 2020 2020 2020 2020 2072  d:.            r
+00029f00: 6574 7572 6e0a 2020 2020 2020 2020 736c  eturn.        sl
+00029f10: 6f74 735f 6176 6169 6c61 626c 6520 3d20  ots_available = 
+00029f20: 7375 6d28 0a20 2020 2020 2020 2020 2020  sum(.           
+00029f30: 205f 7461 736b 5f73 6c6f 7473 5f61 7661   _task_slots_ava
+00029f40: 696c 6162 6c65 2877 732c 2073 656c 662e  ilable(ws, self.
+00029f50: 574f 524b 4552 5f53 4154 5552 4154 494f  WORKER_SATURATIO
+00029f60: 4e29 0a20 2020 2020 2020 2020 2020 2066  N).            f
+00029f70: 6f72 2077 7320 696e 2073 656c 662e 6964  or ws in self.id
+00029f80: 6c65 5f74 6173 6b5f 636f 756e 740a 2020  le_task_count.  
+00029f90: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00029fa0: 6966 2073 6c6f 7473 5f61 7661 696c 6162  if slots_availab
+00029fb0: 6c65 203d 3d20 303a 0a20 2020 2020 2020  le == 0:.       
+00029fc0: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+00029fd0: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+00029fe0: 696f 6e73 3a20 5265 6373 203d 207b 7d0a  ions: Recs = {}.
+00029ff0: 2020 2020 2020 2020 666f 7220 7174 7320          for qts 
+0002a000: 696e 2073 656c 662e 7175 6575 6564 2e70  in self.queued.p
+0002a010: 6565 6b6e 2873 6c6f 7473 5f61 7661 696c  eekn(slots_avail
+0002a020: 6162 6c65 293a 0a20 2020 2020 2020 2020  able):.         
+0002a030: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
+0002a040: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
+0002a050: 2020 2020 2061 7373 6572 7420 7174 732e       assert qts.
+0002a060: 7374 6174 6520 3d3d 2022 7175 6575 6564  state == "queued
+0002a070: 222c 2071 7473 2e73 7461 7465 0a20 2020  ", qts.state.   
+0002a080: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+0002a090: 6572 7420 6e6f 7420 7174 732e 7072 6f63  ert not qts.proc
+0002a0a0: 6573 7369 6e67 5f6f 6e2c 2028 7174 732c  essing_on, (qts,
+0002a0b0: 2071 7473 2e70 726f 6365 7373 696e 675f   qts.processing_
+0002a0c0: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
+0002a0d0: 2020 2020 6173 7365 7274 206e 6f74 2071      assert not q
+0002a0e0: 7473 2e77 6169 7469 6e67 5f6f 6e2c 2028  ts.waiting_on, (
+0002a0f0: 7174 732c 2071 7473 2e70 726f 6365 7373  qts, qts.process
+0002a100: 696e 675f 6f6e 290a 2020 2020 2020 2020  ing_on).        
+0002a110: 2020 2020 2020 2020 6173 7365 7274 2071          assert q
+0002a120: 7473 2e77 686f 5f77 616e 7473 206f 7220  ts.who_wants or 
+0002a130: 7174 732e 7761 6974 6572 732c 2071 7473  qts.waiters, qts
+0002a140: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
+0002a150: 6f6d 6d65 6e64 6174 696f 6e73 5b71 7473  ommendations[qts
+0002a160: 2e6b 6579 5d20 3d20 2270 726f 6365 7373  .key] = "process
+0002a170: 696e 6722 0a0a 2020 2020 2020 2020 7365  ing"..        se
+0002a180: 6c66 2e74 7261 6e73 6974 696f 6e73 2872  lf.transitions(r
+0002a190: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
+0002a1a0: 7374 696d 756c 7573 5f69 6429 0a0a 2020  stimulus_id)..  
+0002a1b0: 2020 6465 6620 7374 696d 756c 7573 5f74    def stimulus_t
+0002a1c0: 6173 6b5f 6669 6e69 7368 6564 2873 656c  ask_finished(sel
+0002a1d0: 662c 206b 6579 2c20 776f 726b 6572 2c20  f, key, worker, 
+0002a1e0: 7374 696d 756c 7573 5f69 642c 2072 756e  stimulus_id, run
+0002a1f0: 5f69 642c 202a 2a6b 7761 7267 7329 3a0a  _id, **kwargs):.
+0002a200: 2020 2020 2020 2020 2222 224d 6172 6b20          """Mark 
+0002a210: 7468 6174 2061 2074 6173 6b20 6861 7320  that a task has 
+0002a220: 6669 6e69 7368 6564 2065 7865 6375 7469  finished executi
+0002a230: 6f6e 206f 6e20 6120 7061 7274 6963 756c  on on a particul
+0002a240: 6172 2077 6f72 6b65 7222 2222 0a20 2020  ar worker""".   
+0002a250: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
+0002a260: 6728 2253 7469 6d75 6c75 7320 7461 736b  g("Stimulus task
+0002a270: 2066 696e 6973 6865 6420 2573 5b25 645d   finished %s[%d]
+0002a280: 2025 7322 2c20 6b65 792c 2072 756e 5f69   %s", key, run_i
+0002a290: 642c 2077 6f72 6b65 7229 0a0a 2020 2020  d, worker)..    
+0002a2a0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+0002a2b0: 6f6e 733a 2052 6563 7320 3d20 7b7d 0a20  ons: Recs = {}. 
+0002a2c0: 2020 2020 2020 2063 6c69 656e 745f 6d73         client_ms
+0002a2d0: 6773 3a20 4d73 6773 203d 207b 7d0a 2020  gs: Msgs = {}.  
+0002a2e0: 2020 2020 2020 776f 726b 6572 5f6d 7367        worker_msg
+0002a2f0: 733a 204d 7367 7320 3d20 7b7d 0a0a 2020  s: Msgs = {}..  
+0002a300: 2020 2020 2020 7773 3a20 576f 726b 6572        ws: Worker
+0002a310: 5374 6174 6520 3d20 7365 6c66 2e77 6f72  State = self.wor
+0002a320: 6b65 7273 5b77 6f72 6b65 725d 0a20 2020  kers[worker].   
+0002a330: 2020 2020 2074 733a 2054 6173 6b53 7461       ts: TaskSta
+0002a340: 7465 203d 2073 656c 662e 7461 736b 732e  te = self.tasks.
+0002a350: 6765 7428 6b65 7929 0a20 2020 2020 2020  get(key).       
+0002a360: 2069 6620 7473 2069 7320 4e6f 6e65 206f   if ts is None o
+0002a370: 7220 7473 2e73 7461 7465 2069 6e20 2822  r ts.state in ("
+0002a380: 7265 6c65 6173 6564 222c 2022 7175 6575  released", "queu
+0002a390: 6564 2229 3a0a 2020 2020 2020 2020 2020  ed"):.          
+0002a3a0: 2020 6c6f 6767 6572 2e64 6562 7567 280a    logger.debug(.
+0002a3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a3c0: 2252 6563 6569 7665 6420 616c 7265 6164  "Received alread
+0002a3d0: 7920 636f 6d70 7574 6564 2074 6173 6b2c  y computed task,
+0002a3e0: 2077 6f72 6b65 723a 2025 732c 2073 7461   worker: %s, sta
+0002a3f0: 7465 3a20 2573 220a 2020 2020 2020 2020  te: %s".        
+0002a400: 2020 2020 2020 2020 222c 206b 6579 3a20          ", key: 
+0002a410: 2573 2c20 7768 6f5f 6861 733a 2025 7322  %s, who_has: %s"
+0002a420: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002a430: 2020 776f 726b 6572 2c0a 2020 2020 2020    worker,.      
+0002a440: 2020 2020 2020 2020 2020 7473 2e73 7461            ts.sta
+0002a450: 7465 2069 6620 7473 2065 6c73 6520 2266  te if ts else "f
+0002a460: 6f72 676f 7474 656e 222c 0a20 2020 2020  orgotten",.     
+0002a470: 2020 2020 2020 2020 2020 206b 6579 2c0a             key,.
+0002a480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a490: 7473 2e77 686f 5f68 6173 2069 6620 7473  ts.who_has if ts
+0002a4a0: 2065 6c73 6520 7b7d 2c0a 2020 2020 2020   else {},.      
+0002a4b0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0002a4c0: 2020 2020 776f 726b 6572 5f6d 7367 735b      worker_msgs[
+0002a4d0: 776f 726b 6572 5d20 3d20 5b0a 2020 2020  worker] = [.    
+0002a4e0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0002a4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a500: 2020 226f 7022 3a20 2266 7265 652d 6b65    "op": "free-ke
+0002a510: 7973 222c 0a20 2020 2020 2020 2020 2020  ys",.           
+0002a520: 2020 2020 2020 2020 2022 6b65 7973 223a           "keys":
+0002a530: 205b 6b65 795d 2c0a 2020 2020 2020 2020   [key],.        
+0002a540: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
+0002a550: 6d75 6c75 735f 6964 223a 2073 7469 6d75  mulus_id": stimu
+0002a560: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
+0002a570: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0002a580: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+0002a590: 656c 6966 2074 732e 7275 6e5f 6964 2021  elif ts.run_id !
+0002a5a0: 3d20 7275 6e5f 6964 3a0a 2020 2020 2020  = run_id:.      
+0002a5b0: 2020 2020 2020 6966 206e 6f74 2074 732e        if not ts.
+0002a5c0: 7072 6f63 6573 7369 6e67 5f6f 6e20 6f72  processing_on or
+0002a5d0: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
+0002a5e0: 6e2e 6164 6472 6573 7320 213d 2077 6f72  n.address != wor
+0002a5f0: 6b65 723a 0a20 2020 2020 2020 2020 2020  ker:.           
+0002a600: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
+0002a610: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+0002a620: 2020 2020 2020 2022 5265 6365 6976 6564         "Received
+0002a630: 2073 7461 6c65 2074 6173 6b20 7275 6e2c   stale task run,
+0002a640: 2077 6f72 6b65 723a 2025 732c 206b 6579   worker: %s, key
+0002a650: 3a20 2573 2c20 7275 6e5f 6964 3a20 2564  : %s, run_id: %d
+0002a660: 2028 2564 2922 2c0a 2020 2020 2020 2020   (%d)",.        
+0002a670: 2020 2020 2020 2020 2020 2020 776f 726b              work
+0002a680: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
+0002a690: 2020 2020 2020 2020 6b65 792c 0a20 2020          key,.   
+0002a6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a6b0: 2072 756e 5f69 642c 0a20 2020 2020 2020   run_id,.       
+0002a6c0: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
+0002a6d0: 7275 6e5f 6964 2c0a 2020 2020 2020 2020  run_id,.        
+0002a6e0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0002a6f0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+0002a700: 5f6d 7367 735b 776f 726b 6572 5d20 3d20  _msgs[worker] = 
+0002a710: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+0002a720: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0002a730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a740: 226f 7022 3a20 2266 7265 652d 6b65 7973  "op": "free-keys
+0002a750: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0002a760: 2020 2020 2020 2020 2020 2022 6b65 7973             "keys
+0002a770: 223a 205b 6b65 795d 2c0a 2020 2020 2020  ": [key],.      
+0002a780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a790: 2020 2273 7469 6d75 6c75 735f 6964 223a    "stimulus_id":
+0002a7a0: 2073 7469 6d75 6c75 735f 6964 2c0a 2020   stimulus_id,.  
+0002a7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a7c0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0002a7d0: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
+0002a7e0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0002a7f0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+0002a800: 6461 7469 6f6e 735b 7473 2e6b 6579 5d20  dations[ts.key] 
+0002a810: 3d20 2272 656c 6561 7365 6422 0a20 2020  = "released".   
+0002a820: 2020 2020 2065 6c69 6620 7473 2e73 7461       elif ts.sta
+0002a830: 7465 203d 3d20 226d 656d 6f72 7922 3a0a  te == "memory":.
+0002a840: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0002a850: 2e61 6464 5f6b 6579 7328 776f 726b 6572  .add_keys(worker
+0002a860: 3d77 6f72 6b65 722c 206b 6579 733d 5b6b  =worker, keys=[k
+0002a870: 6579 5d29 0a20 2020 2020 2020 2065 6c73  ey]).        els
+0002a880: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
+0002a890: 732e 6d65 7461 6461 7461 2e75 7064 6174  s.metadata.updat
+0002a8a0: 6528 6b77 6172 6773 5b22 6d65 7461 6461  e(kwargs["metada
+0002a8b0: 7461 225d 290a 2020 2020 2020 2020 2020  ta"]).          
+0002a8c0: 2020 723a 2074 7570 6c65 203d 2073 656c    r: tuple = sel
+0002a8d0: 662e 5f74 7261 6e73 6974 696f 6e28 0a20  f._transition(. 
+0002a8e0: 2020 2020 2020 2020 2020 2020 2020 206b                 k
+0002a8f0: 6579 2c20 226d 656d 6f72 7922 2c20 7374  ey, "memory", st
+0002a900: 696d 756c 7573 5f69 642c 2077 6f72 6b65  imulus_id, worke
+0002a910: 723d 776f 726b 6572 2c20 2a2a 6b77 6172  r=worker, **kwar
+0002a920: 6773 0a20 2020 2020 2020 2020 2020 2029  gs.            )
+0002a930: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
+0002a940: 6f6d 6d65 6e64 6174 696f 6e73 2c20 636c  ommendations, cl
+0002a950: 6965 6e74 5f6d 7367 732c 2077 6f72 6b65  ient_msgs, worke
+0002a960: 725f 6d73 6773 203d 2072 0a0a 2020 2020  r_msgs = r..    
+0002a970: 2020 2020 2020 2020 6966 2074 732e 7374          if ts.st
+0002a980: 6174 6520 3d3d 2022 6d65 6d6f 7279 223a  ate == "memory":
+0002a990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a9a0: 2061 7373 6572 7420 7773 2069 6e20 7473   assert ws in ts
+0002a9b0: 2e77 686f 5f68 6173 0a20 2020 2020 2020  .who_has.       
+0002a9c0: 2072 6574 7572 6e20 7265 636f 6d6d 656e   return recommen
+0002a9d0: 6461 7469 6f6e 732c 2063 6c69 656e 745f  dations, client_
+0002a9e0: 6d73 6773 2c20 776f 726b 6572 5f6d 7367  msgs, worker_msg
+0002a9f0: 730a 0a20 2020 2064 6566 2073 7469 6d75  s..    def stimu
+0002aa00: 6c75 735f 7461 736b 5f65 7272 6564 280a  lus_task_erred(.
+0002aa10: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+0002aa20: 2020 2020 2020 6b65 793d 4e6f 6e65 2c0a        key=None,.
+0002aa30: 2020 2020 2020 2020 776f 726b 6572 3d4e          worker=N
+0002aa40: 6f6e 652c 0a20 2020 2020 2020 2065 7863  one,.        exc
+0002aa50: 6570 7469 6f6e 3d4e 6f6e 652c 0a20 2020  eption=None,.   
+0002aa60: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
+0002aa70: 3d4e 6f6e 652c 0a20 2020 2020 2020 2074  =None,.        t
+0002aa80: 7261 6365 6261 636b 3d4e 6f6e 652c 0a20  raceback=None,. 
+0002aa90: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
+0002aaa0: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+0002aab0: 2222 224d 6172 6b20 7468 6174 2061 2074  """Mark that a t
+0002aac0: 6173 6b20 6861 7320 6572 7265 6420 6f6e  ask has erred on
+0002aad0: 2061 2070 6172 7469 6375 6c61 7220 776f   a particular wo
+0002aae0: 726b 6572 2222 220a 2020 2020 2020 2020  rker""".        
+0002aaf0: 6c6f 6767 6572 2e64 6562 7567 2822 5374  logger.debug("St
+0002ab00: 696d 756c 7573 2074 6173 6b20 6572 7265  imulus task erre
+0002ab10: 6420 2573 2c20 2573 222c 206b 6579 2c20  d %s, %s", key, 
+0002ab20: 776f 726b 6572 290a 0a20 2020 2020 2020  worker)..       
+0002ab30: 2074 733a 2054 6173 6b53 7461 7465 203d   ts: TaskState =
+0002ab40: 2073 656c 662e 7461 736b 732e 6765 7428   self.tasks.get(
+0002ab50: 6b65 7929 0a20 2020 2020 2020 2069 6620  key).        if 
+0002ab60: 7473 2069 7320 4e6f 6e65 206f 7220 7473  ts is None or ts
+0002ab70: 2e73 7461 7465 2021 3d20 2270 726f 6365  .state != "proce
+0002ab80: 7373 696e 6722 3a0a 2020 2020 2020 2020  ssing":.        
+0002ab90: 2020 2020 7265 7475 726e 207b 7d2c 207b      return {}, {
+0002aba0: 7d2c 207b 7d0a 0a20 2020 2020 2020 2069  }, {}..        i
+0002abb0: 6620 7473 2e72 6574 7269 6573 203e 2030  f ts.retries > 0
+0002abc0: 3a0a 2020 2020 2020 2020 2020 2020 7473  :.            ts
+0002abd0: 2e72 6574 7269 6573 202d 3d20 310a 2020  .retries -= 1.  
+0002abe0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0002abf0: 2073 656c 662e 5f74 7261 6e73 6974 696f   self._transitio
+0002ac00: 6e28 6b65 792c 2022 7761 6974 696e 6722  n(key, "waiting"
+0002ac10: 2c20 7374 696d 756c 7573 5f69 6429 0a20  , stimulus_id). 
+0002ac20: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0002ac30: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0002ac40: 7365 6c66 2e5f 7472 616e 7369 7469 6f6e  self._transition
+0002ac50: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002ac60: 2020 6b65 792c 0a20 2020 2020 2020 2020    key,.         
+0002ac70: 2020 2020 2020 2022 6572 7265 6422 2c0a         "erred",.
+0002ac80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ac90: 7374 696d 756c 7573 5f69 642c 0a20 2020  stimulus_id,.   
+0002aca0: 2020 2020 2020 2020 2020 2020 2063 6175               cau
+0002acb0: 7365 3d6b 6579 2c0a 2020 2020 2020 2020  se=key,.        
+0002acc0: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
+0002acd0: 6e3d 6578 6365 7074 696f 6e2c 0a20 2020  n=exception,.   
+0002ace0: 2020 2020 2020 2020 2020 2020 2074 7261               tra
+0002acf0: 6365 6261 636b 3d74 7261 6365 6261 636b  ceback=traceback
+0002ad00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002ad10: 2020 776f 726b 6572 3d77 6f72 6b65 722c    worker=worker,
+0002ad20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002ad30: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
+0002ad40: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
+0002ad50: 6620 7374 696d 756c 7573 5f72 6574 7279  f stimulus_retry
+0002ad60: 2873 656c 662c 206b 6579 732c 2063 6c69  (self, keys, cli
+0002ad70: 656e 743d 4e6f 6e65 293a 0a20 2020 2020  ent=None):.     
+0002ad80: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
+0002ad90: 436c 6965 6e74 2025 7320 7265 7175 6573  Client %s reques
+0002ada0: 7473 2074 6f20 7265 7472 7920 2564 206b  ts to retry %d k
+0002adb0: 6579 7322 2c20 636c 6965 6e74 2c20 6c65  eys", client, le
+0002adc0: 6e28 6b65 7973 2929 0a20 2020 2020 2020  n(keys)).       
+0002add0: 2069 6620 636c 6965 6e74 3a0a 2020 2020   if client:.    
+0002ade0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+0002adf0: 5f65 7665 6e74 2863 6c69 656e 742c 207b  _event(client, {
+0002ae00: 2261 6374 696f 6e22 3a20 2272 6574 7279  "action": "retry
+0002ae10: 222c 2022 636f 756e 7422 3a20 6c65 6e28  ", "count": len(
+0002ae20: 6b65 7973 297d 290a 0a20 2020 2020 2020  keys)})..       
+0002ae30: 2073 7461 636b 203d 206c 6973 7428 6b65   stack = list(ke
+0002ae40: 7973 290a 2020 2020 2020 2020 7365 656e  ys).        seen
+0002ae50: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
+0002ae60: 2072 6f6f 7473 203d 205b 5d0a 2020 2020   roots = [].    
+0002ae70: 2020 2020 7768 696c 6520 7374 6163 6b3a      while stack:
+0002ae80: 0a20 2020 2020 2020 2020 2020 206b 6579  .            key
+0002ae90: 203d 2073 7461 636b 2e70 6f70 2829 0a20   = stack.pop(). 
+0002aea0: 2020 2020 2020 2020 2020 2073 6565 6e2e             seen.
+0002aeb0: 6164 6428 6b65 7929 0a20 2020 2020 2020  add(key).       
+0002aec0: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
+0002aed0: 6173 6b73 5b6b 6579 5d0a 2020 2020 2020  asks[key].      
+0002aee0: 2020 2020 2020 6572 7265 645f 6465 7073        erred_deps
+0002aef0: 203d 205b 6474 732e 6b65 7920 666f 7220   = [dts.key for 
+0002af00: 6474 7320 696e 2074 732e 6465 7065 6e64  dts in ts.depend
+0002af10: 656e 6369 6573 2069 6620 6474 732e 7374  encies if dts.st
+0002af20: 6174 6520 3d3d 2022 6572 7265 6422 5d0a  ate == "erred"].
+0002af30: 2020 2020 2020 2020 2020 2020 6966 2065              if e
+0002af40: 7272 6564 5f64 6570 733a 0a20 2020 2020  rred_deps:.     
+0002af50: 2020 2020 2020 2020 2020 2073 7461 636b             stack
+0002af60: 2e65 7874 656e 6428 6572 7265 645f 6465  .extend(erred_de
+0002af70: 7073 290a 2020 2020 2020 2020 2020 2020  ps).            
+0002af80: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0002af90: 2020 2020 2020 726f 6f74 732e 6170 7065        roots.appe
+0002afa0: 6e64 286b 6579 290a 0a20 2020 2020 2020  nd(key)..       
+0002afb0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+0002afc0: 3a20 5265 6373 203d 207b 6b65 793a 2022  : Recs = {key: "
+0002afd0: 7761 6974 696e 6722 2066 6f72 206b 6579  waiting" for key
+0002afe0: 2069 6e20 726f 6f74 737d 0a20 2020 2020   in roots}.     
+0002aff0: 2020 2073 656c 662e 7472 616e 7369 7469     self.transiti
+0002b000: 6f6e 7328 7265 636f 6d6d 656e 6461 7469  ons(recommendati
+0002b010: 6f6e 732c 2066 2273 7469 6d75 6c75 732d  ons, f"stimulus-
+0002b020: 7265 7472 792d 7b74 696d 6528 297d 2229  retry-{time()}")
+0002b030: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+0002b040: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
+0002b050: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
+0002b060: 696e 2073 6565 6e3a 0a20 2020 2020 2020  in seen:.       
+0002b070: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0002b080: 6e6f 7420 7365 6c66 2e74 6173 6b73 5b6b  not self.tasks[k
+0002b090: 6579 5d2e 6578 6365 7074 696f 6e5f 626c  ey].exception_bl
+0002b0a0: 616d 650a 0a20 2020 2020 2020 2072 6574  ame..        ret
+0002b0b0: 7572 6e20 7475 706c 6528 7365 656e 290a  urn tuple(seen).
+0002b0c0: 0a20 2020 2064 6566 2063 6c6f 7365 5f77  .    def close_w
+0002b0d0: 6f72 6b65 7228 7365 6c66 2c20 776f 726b  orker(self, work
+0002b0e0: 6572 3a20 7374 7229 202d 3e20 4e6f 6e65  er: str) -> None
+0002b0f0: 3a0a 2020 2020 2020 2020 2222 2241 736b  :.        """Ask
+0002b100: 2061 2077 6f72 6b65 7220 746f 2073 6875   a worker to shu
+0002b110: 7420 6974 7365 6c66 2064 6f77 6e2e 2044  t itself down. D
+0002b120: 6f20 6e6f 7420 7761 6974 2066 6f72 2069  o not wait for i
+0002b130: 7420 746f 2074 616b 6520 6566 6665 6374  t to take effect
+0002b140: 2e0a 2020 2020 2020 2020 4e6f 7465 2074  ..        Note t
+0002b150: 6861 7420 7468 6572 6520 6973 206e 6f20  hat there is no 
+0002b160: 6775 6172 616e 7465 6520 7468 6174 2074  guarantee that t
+0002b170: 6865 2077 6f72 6b65 7220 7769 6c6c 2061  he worker will a
+0002b180: 6374 7561 6c6c 7920 6163 6365 7074 2074  ctually accept t
+0002b190: 6865 0a20 2020 2020 2020 2063 6f6d 6d61  he.        comma
+0002b1a0: 6e64 2e0a 0a20 2020 2020 2020 204e 6f74  nd...        Not
+0002b1b0: 6520 7468 6174 203a 6d65 7468 3a60 7265  e that :meth:`re
+0002b1c0: 6d6f 7665 5f77 6f72 6b65 7260 2073 656e  move_worker` sen
+0002b1d0: 6473 2074 6865 2073 616d 6520 636f 6d6d  ds the same comm
+0002b1e0: 616e 6420 696e 7465 726e 616c 6c79 2069  and internally i
+0002b1f0: 6620 636c 6f73 653d 5472 7565 2e0a 0a20  f close=True... 
+0002b200: 2020 2020 2020 2053 6565 2061 6c73 6f0a         See also.
+0002b210: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
+0002b220: 0a20 2020 2020 2020 2072 6574 6972 655f  .        retire_
+0002b230: 776f 726b 6572 730a 2020 2020 2020 2020  workers.        
+0002b240: 7265 6d6f 7665 5f77 6f72 6b65 720a 2020  remove_worker.  
+0002b250: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0002b260: 2020 6966 2077 6f72 6b65 7220 6e6f 7420    if worker not 
+0002b270: 696e 2073 656c 662e 776f 726b 6572 733a  in self.workers:
+0002b280: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0002b290: 7572 6e0a 0a20 2020 2020 2020 206c 6f67  urn..        log
+0002b2a0: 6765 722e 696e 666f 2822 436c 6f73 696e  ger.info("Closin
+0002b2b0: 6720 776f 726b 6572 2025 7322 2c20 776f  g worker %s", wo
+0002b2c0: 726b 6572 290a 2020 2020 2020 2020 7365  rker).        se
+0002b2d0: 6c66 2e6c 6f67 5f65 7665 6e74 2877 6f72  lf.log_event(wor
+0002b2e0: 6b65 722c 207b 2261 6374 696f 6e22 3a20  ker, {"action": 
+0002b2f0: 2263 6c6f 7365 2d77 6f72 6b65 7222 7d29  "close-worker"})
+0002b300: 0a20 2020 2020 2020 2073 656c 662e 776f  .        self.wo
+0002b310: 726b 6572 5f73 656e 6428 776f 726b 6572  rker_send(worker
+0002b320: 2c20 7b22 6f70 223a 2022 636c 6f73 6522  , {"op": "close"
+0002b330: 2c20 2272 6561 736f 6e22 3a20 2273 6368  , "reason": "sch
+0002b340: 6564 756c 6572 2d63 6c6f 7365 2d77 6f72  eduler-close-wor
+0002b350: 6b65 7222 7d29 0a0a 2020 2020 406c 6f67  ker"})..    @log
+0002b360: 5f65 7272 6f72 730a 2020 2020 6173 796e  _errors.    asyn
+0002b370: 6320 6465 6620 7265 6d6f 7665 5f77 6f72  c def remove_wor
+0002b380: 6b65 7228 0a20 2020 2020 2020 2073 656c  ker(.        sel
+0002b390: 662c 2061 6464 7265 7373 3a20 7374 722c  f, address: str,
+0002b3a0: 202a 2c20 7374 696d 756c 7573 5f69 643a   *, stimulus_id:
+0002b3b0: 2073 7472 2c20 7361 6665 3a20 626f 6f6c   str, safe: bool
+0002b3c0: 203d 2046 616c 7365 2c20 636c 6f73 653a   = False, close:
+0002b3d0: 2062 6f6f 6c20 3d20 5472 7565 0a20 2020   bool = True.   
+0002b3e0: 2029 202d 3e20 4c69 7465 7261 6c5b 224f   ) -> Literal["O
+0002b3f0: 4b22 2c20 2261 6c72 6561 6479 2d72 656d  K", "already-rem
+0002b400: 6f76 6564 225d 3a0a 2020 2020 2020 2020  oved"]:.        
+0002b410: 2222 2252 656d 6f76 6520 776f 726b 6572  """Remove worker
+0002b420: 2066 726f 6d20 636c 7573 7465 722e 0a0a   from cluster...
+0002b430: 2020 2020 2020 2020 5765 2064 6f20 7468          We do th
+0002b440: 6973 2077 6865 6e20 6120 776f 726b 6572  is when a worker
+0002b450: 2072 6570 6f72 7473 2074 6861 7420 6974   reports that it
+0002b460: 2070 6c61 6e73 2074 6f20 6c65 6176 6520   plans to leave 
+0002b470: 6f72 2077 6865 6e20 6974 2061 7070 6561  or when it appea
+0002b480: 7273 2074 6f20 6265 0a20 2020 2020 2020  rs to be.       
+0002b490: 2075 6e72 6573 706f 6e73 6976 652e 2054   unresponsive. T
+0002b4a0: 6869 7320 6d61 7920 7365 6e64 2069 7473  his may send its
+0002b4b0: 2074 6173 6b73 2062 6163 6b20 746f 2061   tasks back to a
+0002b4c0: 2072 656c 6561 7365 6420 7374 6174 652e   released state.
+0002b4d0: 0a0a 2020 2020 2020 2020 5365 6520 616c  ..        See al
+0002b4e0: 736f 0a20 2020 2020 2020 202d 2d2d 2d2d  so.        -----
+0002b4f0: 2d2d 2d0a 2020 2020 2020 2020 7265 7469  ---.        reti
+0002b500: 7265 5f77 6f72 6b65 7273 0a20 2020 2020  re_workers.     
+0002b510: 2020 2063 6c6f 7365 5f77 6f72 6b65 720a     close_worker.
+0002b520: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0002b530: 2020 2020 6966 2073 656c 662e 7374 6174      if self.stat
+0002b540: 7573 203d 3d20 5374 6174 7573 2e63 6c6f  us == Status.clo
+0002b550: 7365 643a 0a20 2020 2020 2020 2020 2020  sed:.           
+0002b560: 2072 6574 7572 6e20 2261 6c72 6561 6479   return "already
+0002b570: 2d72 656d 6f76 6564 220a 0a20 2020 2020  -removed"..     
+0002b580: 2020 2061 6464 7265 7373 203d 2073 656c     address = sel
+0002b590: 662e 636f 6572 6365 5f61 6464 7265 7373  f.coerce_address
+0002b5a0: 2861 6464 7265 7373 290a 0a20 2020 2020  (address)..     
+0002b5b0: 2020 2069 6620 6164 6472 6573 7320 6e6f     if address no
+0002b5c0: 7420 696e 2073 656c 662e 776f 726b 6572  t in self.worker
+0002b5d0: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
+0002b5e0: 6574 7572 6e20 2261 6c72 6561 6479 2d72  eturn "already-r
+0002b5f0: 656d 6f76 6564 220a 0a20 2020 2020 2020  emoved"..       
+0002b600: 2068 6f73 7420 3d20 6765 745f 6164 6472   host = get_addr
+0002b610: 6573 735f 686f 7374 2861 6464 7265 7373  ess_host(address
+0002b620: 290a 0a20 2020 2020 2020 2077 733a 2057  )..        ws: W
+0002b630: 6f72 6b65 7253 7461 7465 203d 2073 656c  orkerState = sel
+0002b640: 662e 776f 726b 6572 735b 6164 6472 6573  f.workers[addres
+0002b650: 735d 0a0a 2020 2020 2020 2020 6576 656e  s]..        even
+0002b660: 745f 6d73 6720 3d20 7b0a 2020 2020 2020  t_msg = {.      
+0002b670: 2020 2020 2020 2261 6374 696f 6e22 3a20        "action": 
+0002b680: 2272 656d 6f76 652d 776f 726b 6572 222c  "remove-worker",
+0002b690: 0a20 2020 2020 2020 2020 2020 2022 7072  .            "pr
+0002b6a0: 6f63 6573 7369 6e67 2d74 6173 6b73 223a  ocessing-tasks":
+0002b6b0: 207b 7473 2e6b 6579 2066 6f72 2074 7320   {ts.key for ts 
+0002b6c0: 696e 2077 732e 7072 6f63 6573 7369 6e67  in ws.processing
+0002b6d0: 7d2c 0a20 2020 2020 2020 207d 0a20 2020  },.        }.   
+0002b6e0: 2020 2020 2073 656c 662e 6c6f 675f 6576       self.log_ev
+0002b6f0: 656e 7428 6164 6472 6573 732c 2065 7665  ent(address, eve
+0002b700: 6e74 5f6d 7367 2e63 6f70 7928 2929 0a20  nt_msg.copy()). 
+0002b710: 2020 2020 2020 2065 7665 6e74 5f6d 7367         event_msg
+0002b720: 5b22 776f 726b 6572 225d 203d 2061 6464  ["worker"] = add
+0002b730: 7265 7373 0a20 2020 2020 2020 2073 656c  ress.        sel
+0002b740: 662e 6c6f 675f 6576 656e 7428 2261 6c6c  f.log_event("all
+0002b750: 222c 2065 7665 6e74 5f6d 7367 290a 0a20  ", event_msg).. 
+0002b760: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
+0002b770: 666f 2822 5265 6d6f 7665 2077 6f72 6b65  fo("Remove worke
+0002b780: 7220 2573 222c 2077 7329 0a20 2020 2020  r %s", ws).     
+0002b790: 2020 2069 6620 636c 6f73 653a 0a20 2020     if close:.   
+0002b7a0: 2020 2020 2020 2020 2077 6974 6820 7375           with su
+0002b7b0: 7070 7265 7373 2841 7474 7269 6275 7465  ppress(Attribute
+0002b7c0: 4572 726f 722c 2043 6f6d 6d43 6c6f 7365  Error, CommClose
+0002b7d0: 6445 7272 6f72 293a 0a20 2020 2020 2020  dError):.       
+0002b7e0: 2020 2020 2020 2020 2073 656c 662e 7374           self.st
+0002b7f0: 7265 616d 5f63 6f6d 6d73 5b61 6464 7265  ream_comms[addre
+0002b800: 7373 5d2e 7365 6e64 280a 2020 2020 2020  ss].send(.      
+0002b810: 2020 2020 2020 2020 2020 2020 2020 7b22                {"
+0002b820: 6f70 223a 2022 636c 6f73 6522 2c20 2272  op": "close", "r
+0002b830: 6561 736f 6e22 3a20 2273 6368 6564 756c  eason": "schedul
+0002b840: 6572 2d72 656d 6f76 652d 776f 726b 6572  er-remove-worker
+0002b850: 227d 0a20 2020 2020 2020 2020 2020 2020  "}.             
+0002b860: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
+0002b870: 6c66 2e72 656d 6f76 655f 7265 736f 7572  lf.remove_resour
+0002b880: 6365 7328 6164 6472 6573 7329 0a0a 2020  ces(address)..  
+0002b890: 2020 2020 2020 6468 3a20 6469 6374 203d        dh: dict =
+0002b8a0: 2073 656c 662e 686f 7374 5f69 6e66 6f5b   self.host_info[
+0002b8b0: 686f 7374 5d0a 2020 2020 2020 2020 6468  host].        dh
+0002b8c0: 5f61 6464 7265 7373 6573 3a20 7365 7420  _addresses: set 
+0002b8d0: 3d20 6468 5b22 6164 6472 6573 7365 7322  = dh["addresses"
+0002b8e0: 5d0a 2020 2020 2020 2020 6468 5f61 6464  ].        dh_add
+0002b8f0: 7265 7373 6573 2e72 656d 6f76 6528 6164  resses.remove(ad
+0002b900: 6472 6573 7329 0a20 2020 2020 2020 2064  dress).        d
+0002b910: 685b 226e 7468 7265 6164 7322 5d20 2d3d  h["nthreads"] -=
+0002b920: 2077 732e 6e74 6872 6561 6473 0a20 2020   ws.nthreads.   
+0002b930: 2020 2020 2073 656c 662e 746f 7461 6c5f       self.total_
+0002b940: 6e74 6872 6561 6473 202d 3d20 7773 2e6e  nthreads -= ws.n
+0002b950: 7468 7265 6164 730a 2020 2020 2020 2020  threads.        
+0002b960: 7365 6c66 2e74 6f74 616c 5f6e 7468 7265  self.total_nthre
+0002b970: 6164 735f 6869 7374 6f72 792e 6170 7065  ads_history.appe
+0002b980: 6e64 2828 7469 6d65 2829 2c20 7365 6c66  nd((time(), self
+0002b990: 2e74 6f74 616c 5f6e 7468 7265 6164 7329  .total_nthreads)
+0002b9a0: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+0002b9b0: 2064 685f 6164 6472 6573 7365 733a 0a20   dh_addresses:. 
+0002b9c0: 2020 2020 2020 2020 2020 2064 656c 2073             del s
+0002b9d0: 656c 662e 686f 7374 5f69 6e66 6f5b 686f  elf.host_info[ho
+0002b9e0: 7374 5d0a 0a20 2020 2020 2020 2073 656c  st]..        sel
+0002b9f0: 662e 7270 632e 7265 6d6f 7665 2861 6464  f.rpc.remove(add
+0002ba00: 7265 7373 290a 2020 2020 2020 2020 6465  ress).        de
+0002ba10: 6c20 7365 6c66 2e73 7472 6561 6d5f 636f  l self.stream_co
+0002ba20: 6d6d 735b 6164 6472 6573 735d 0a20 2020  mms[address].   
+0002ba30: 2020 2020 2064 656c 2073 656c 662e 616c       del self.al
+0002ba40: 6961 7365 735b 7773 2e6e 616d 655d 0a20  iases[ws.name]. 
+0002ba50: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
+0002ba60: 2e70 6f70 2877 732e 6164 6472 6573 732c  .pop(ws.address,
+0002ba70: 204e 6f6e 6529 0a20 2020 2020 2020 2073   None).        s
+0002ba80: 656c 662e 6964 6c65 5f74 6173 6b5f 636f  elf.idle_task_co
+0002ba90: 756e 742e 6469 7363 6172 6428 7773 290a  unt.discard(ws).
+0002baa0: 2020 2020 2020 2020 7365 6c66 2e73 6174          self.sat
+0002bab0: 7572 6174 6564 2e64 6973 6361 7264 2877  urated.discard(w
+0002bac0: 7329 0a20 2020 2020 2020 2064 656c 2073  s).        del s
+0002bad0: 656c 662e 776f 726b 6572 735b 6164 6472  elf.workers[addr
+0002bae0: 6573 735d 0a20 2020 2020 2020 2077 732e  ess].        ws.
+0002baf0: 7374 6174 7573 203d 2053 7461 7475 732e  status = Status.
+0002bb00: 636c 6f73 6564 0a20 2020 2020 2020 2073  closed.        s
+0002bb10: 656c 662e 7275 6e6e 696e 672e 6469 7363  elf.running.disc
+0002bb20: 6172 6428 7773 290a 0a20 2020 2020 2020  ard(ws)..       
+0002bb30: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+0002bb40: 3a20 5265 6373 203d 207b 7d0a 0a20 2020  : Recs = {}..   
+0002bb50: 2020 2020 2074 733a 2054 6173 6b53 7461       ts: TaskSta
+0002bb60: 7465 0a20 2020 2020 2020 2066 6f72 2074  te.        for t
+0002bb70: 7320 696e 206c 6973 7428 7773 2e70 726f  s in list(ws.pro
+0002bb80: 6365 7373 696e 6729 3a0a 2020 2020 2020  cessing):.      
+0002bb90: 2020 2020 2020 6b20 3d20 7473 2e6b 6579        k = ts.key
+0002bba0: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
+0002bbb0: 6f6d 6d65 6e64 6174 696f 6e73 5b6b 5d20  ommendations[k] 
+0002bbc0: 3d20 2272 656c 6561 7365 6422 0a20 2020  = "released".   
+0002bbd0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0002bbe0: 7361 6665 3a0a 2020 2020 2020 2020 2020  safe:.          
+0002bbf0: 2020 2020 2020 7473 2e73 7573 7069 6369        ts.suspici
+0002bc00: 6f75 7320 2b3d 2031 0a20 2020 2020 2020  ous += 1.       
+0002bc10: 2020 2020 2020 2020 2074 732e 7072 6566           ts.pref
+0002bc20: 6978 2e73 7573 7069 6369 6f75 7320 2b3d  ix.suspicious +=
+0002bc30: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
+0002bc40: 2020 2069 6620 7473 2e73 7573 7069 6369     if ts.suspici
+0002bc50: 6f75 7320 3e20 7365 6c66 2e61 6c6c 6f77  ous > self.allow
+0002bc60: 6564 5f66 6169 6c75 7265 733a 0a20 2020  ed_failures:.   
+0002bc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bc80: 2064 656c 2072 6563 6f6d 6d65 6e64 6174   del recommendat
+0002bc90: 696f 6e73 5b6b 5d0a 2020 2020 2020 2020  ions[k].        
+0002bca0: 2020 2020 2020 2020 2020 2020 6520 3d20              e = 
+0002bcb0: 7069 636b 6c65 2e64 756d 7073 280a 2020  pickle.dumps(.  
+0002bcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bcd0: 2020 2020 2020 4b69 6c6c 6564 576f 726b        KilledWork
+0002bce0: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+0002bcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bd00: 7461 736b 3d6b 2c0a 2020 2020 2020 2020  task=k,.        
+0002bd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bd20: 2020 2020 6c61 7374 5f77 6f72 6b65 723d      last_worker=
+0002bd30: 7773 2e63 6c65 616e 2829 2c0a 2020 2020  ws.clean(),.    
+0002bd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bd50: 2020 2020 2020 2020 616c 6c6f 7765 645f          allowed_
+0002bd60: 6661 696c 7572 6573 3d73 656c 662e 616c  failures=self.al
+0002bd70: 6c6f 7765 645f 6661 696c 7572 6573 2c0a  lowed_failures,.
 0002bd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bd90: 2020 2020 2020 2022 2077 6869 6c65 2074         " while t
-0002bda0: 7279 696e 6720 746f 2072 756e 2069 7422  rying to run it"
-0002bdb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002bdc0: 2020 2020 2020 2020 2020 7473 2e6b 6579            ts.key
-0002bdd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002bde0: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-0002bdf0: 6c6c 6f77 6564 5f66 6169 6c75 7265 732c  llowed_failures,
-0002be00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002be10: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0002be20: 666f 7220 7473 2069 6e20 6c69 7374 2877  for ts in list(w
-0002be30: 732e 6861 735f 7768 6174 293a 0a20 2020  s.has_what):.   
-0002be40: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
-0002be50: 6d6f 7665 5f72 6570 6c69 6361 2874 732c  move_replica(ts,
-0002be60: 2077 7329 0a20 2020 2020 2020 2020 2020   ws).           
-0002be70: 2069 6620 6e6f 7420 7473 2e77 686f 5f68   if not ts.who_h
-0002be80: 6173 3a0a 2020 2020 2020 2020 2020 2020  as:.            
-0002be90: 2020 2020 6966 2074 732e 7275 6e5f 7370      if ts.run_sp
-0002bea0: 6563 3a0a 2020 2020 2020 2020 2020 2020  ec:.            
-0002beb0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-0002bec0: 6461 7469 6f6e 735b 7473 2e6b 6579 5d20  dations[ts.key] 
-0002bed0: 3d20 2272 656c 6561 7365 6422 0a20 2020  = "released".   
-0002bee0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0002bef0: 653a 2020 2320 7075 7265 2064 6174 610a  e:  # pure data.
-0002bf00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bf10: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-0002bf20: 6f6e 735b 7473 2e6b 6579 5d20 3d20 2266  ons[ts.key] = "f
-0002bf30: 6f72 676f 7474 656e 220a 0a20 2020 2020  orgotten"..     
-0002bf40: 2020 2073 656c 662e 7472 616e 7369 7469     self.transiti
-0002bf50: 6f6e 7328 7265 636f 6d6d 656e 6461 7469  ons(recommendati
-0002bf60: 6f6e 732c 2073 7469 6d75 6c75 735f 6964  ons, stimulus_id
-0002bf70: 3d73 7469 6d75 6c75 735f 6964 290a 0a20  =stimulus_id).. 
-0002bf80: 2020 2020 2020 2061 7761 6974 6162 6c65         awaitable
-0002bf90: 7320 3d20 5b5d 0a20 2020 2020 2020 2066  s = [].        f
-0002bfa0: 6f72 2070 6c75 6769 6e20 696e 206c 6973  or plugin in lis
-0002bfb0: 7428 7365 6c66 2e70 6c75 6769 6e73 2e76  t(self.plugins.v
-0002bfc0: 616c 7565 7328 2929 3a0a 2020 2020 2020  alues()):.      
-0002bfd0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0002bfe0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
-0002bff0: 7420 3d20 706c 7567 696e 2e72 656d 6f76  t = plugin.remov
-0002c000: 655f 776f 726b 6572 2873 6368 6564 756c  e_worker(schedul
-0002c010: 6572 3d73 656c 662c 2077 6f72 6b65 723d  er=self, worker=
-0002c020: 6164 6472 6573 7329 0a20 2020 2020 2020  address).       
-0002c030: 2020 2020 2020 2020 2069 6620 696e 7370           if insp
-0002c040: 6563 742e 6973 6177 6169 7461 626c 6528  ect.isawaitable(
-0002c050: 7265 7375 6c74 293a 0a20 2020 2020 2020  result):.       
-0002c060: 2020 2020 2020 2020 2020 2020 2061 7761               awa
-0002c070: 6974 6162 6c65 732e 6170 7065 6e64 2872  itables.append(r
-0002c080: 6573 756c 7429 0a20 2020 2020 2020 2020  esult).         
-0002c090: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-0002c0a0: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
-0002c0b0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-0002c0c0: 2e65 7863 6570 7469 6f6e 2865 290a 0a20  .exception(e).. 
-0002c0d0: 2020 2020 2020 2070 6c75 6769 6e5f 6d73         plugin_ms
-0002c0e0: 6773 203d 2061 7761 6974 2061 7379 6e63  gs = await async
-0002c0f0: 696f 2e67 6174 6865 7228 2a61 7761 6974  io.gather(*await
-0002c100: 6162 6c65 732c 2072 6574 7572 6e5f 6578  ables, return_ex
-0002c110: 6365 7074 696f 6e73 3d54 7275 6529 0a20  ceptions=True). 
-0002c120: 2020 2020 2020 2070 6c75 6769 6e73 5f65         plugins_e
-0002c130: 7863 6570 7469 6f6e 7320 3d20 5b6d 7367  xceptions = [msg
-0002c140: 2066 6f72 206d 7367 2069 6e20 706c 7567   for msg in plug
-0002c150: 696e 5f6d 7367 7320 6966 2069 7369 6e73  in_msgs if isins
-0002c160: 7461 6e63 6528 6d73 672c 2045 7863 6570  tance(msg, Excep
-0002c170: 7469 6f6e 295d 0a20 2020 2020 2020 2066  tion)].        f
-0002c180: 6f72 2065 7863 2069 6e20 706c 7567 696e  or exc in plugin
-0002c190: 735f 6578 6365 7074 696f 6e73 3a0a 2020  s_exceptions:.  
-0002c1a0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-0002c1b0: 2e65 7863 6570 7469 6f6e 2865 7863 2c20  .exception(exc, 
-0002c1c0: 6578 635f 696e 666f 3d65 7863 290a 0a20  exc_info=exc).. 
-0002c1d0: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
-0002c1e0: 6c66 2e77 6f72 6b65 7273 3a0a 2020 2020  lf.workers:.    
-0002c1f0: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-0002c200: 6e66 6f28 224c 6f73 7420 616c 6c20 776f  nfo("Lost all wo
-0002c210: 726b 6572 7322 290a 0a20 2020 2020 2020  rkers")..       
-0002c220: 2066 6f72 2077 2069 6e20 7365 6c66 2e77   for w in self.w
-0002c230: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
-0002c240: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
-0002c250: 7468 5f77 6f72 6b65 7273 2e70 6f70 2828  th_workers.pop((
-0002c260: 6164 6472 6573 732c 2077 292c 204e 6f6e  address, w), Non
-0002c270: 6529 0a20 2020 2020 2020 2020 2020 2073  e).            s
-0002c280: 656c 662e 6261 6e64 7769 6474 685f 776f  elf.bandwidth_wo
-0002c290: 726b 6572 732e 706f 7028 2877 2c20 6164  rkers.pop((w, ad
-0002c2a0: 6472 6573 7329 2c20 4e6f 6e65 290a 0a20  dress), None).. 
-0002c2b0: 2020 2020 2020 2061 7379 6e63 2064 6566         async def
-0002c2c0: 2072 656d 6f76 655f 776f 726b 6572 5f66   remove_worker_f
-0002c2d0: 726f 6d5f 6576 656e 7473 2829 202d 3e20  rom_events() -> 
-0002c2e0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0002c2f0: 2020 2320 4966 2074 6865 2077 6f72 6b65    # If the worke
-0002c300: 7220 6973 6e27 7420 7265 6769 7374 6572  r isn't register
-0002c310: 6564 2061 6e79 6d6f 7265 2061 6674 6572  ed anymore after
-0002c320: 2074 6865 2064 656c 6179 2c20 7265 6d6f   the delay, remo
-0002c330: 7665 2066 726f 6d20 6576 656e 7473 0a20  ve from events. 
-0002c340: 2020 2020 2020 2020 2020 2069 6620 6164             if ad
-0002c350: 6472 6573 7320 6e6f 7420 696e 2073 656c  dress not in sel
-0002c360: 662e 776f 726b 6572 7320 616e 6420 6164  f.workers and ad
-0002c370: 6472 6573 7320 696e 2073 656c 662e 6576  dress in self.ev
-0002c380: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
-0002c390: 2020 2020 2020 6465 6c20 7365 6c66 2e65        del self.e
-0002c3a0: 7665 6e74 735b 6164 6472 6573 735d 0a0a  vents[address]..
-0002c3b0: 2020 2020 2020 2020 636c 6561 6e75 705f          cleanup_
-0002c3c0: 6465 6c61 7920 3d20 7061 7273 655f 7469  delay = parse_ti
-0002c3d0: 6d65 6465 6c74 6128 0a20 2020 2020 2020  medelta(.       
-0002c3e0: 2020 2020 2064 6173 6b2e 636f 6e66 6967       dask.config
-0002c3f0: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
-0002c400: 642e 7363 6865 6475 6c65 722e 6576 656e  d.scheduler.even
-0002c410: 7473 2d63 6c65 616e 7570 2d64 656c 6179  ts-cleanup-delay
-0002c420: 2229 0a20 2020 2020 2020 2029 0a0a 2020  ").        )..  
-0002c430: 2020 2020 2020 7365 6c66 2e5f 6f6e 676f        self._ongo
-0002c440: 696e 675f 6261 636b 6772 6f75 6e64 5f74  ing_background_t
-0002c450: 6173 6b73 2e63 616c 6c5f 6c61 7465 7228  asks.call_later(
-0002c460: 0a20 2020 2020 2020 2020 2020 2063 6c65  .            cle
-0002c470: 616e 7570 5f64 656c 6179 2c20 7265 6d6f  anup_delay, remo
-0002c480: 7665 5f77 6f72 6b65 725f 6672 6f6d 5f65  ve_worker_from_e
-0002c490: 7665 6e74 730a 2020 2020 2020 2020 290a  vents.        ).
-0002c4a0: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
-0002c4b0: 6562 7567 2822 5265 6d6f 7665 6420 776f  ebug("Removed wo
-0002c4c0: 726b 6572 2025 7322 2c20 7773 290a 0a20  rker %s", ws).. 
-0002c4d0: 2020 2020 2020 2066 6f72 2077 2069 6e20         for w in 
-0002c4e0: 7365 6c66 2e77 6f72 6b65 7273 3a0a 2020  self.workers:.  
-0002c4f0: 2020 2020 2020 2020 2020 7365 6c66 2e77            self.w
-0002c500: 6f72 6b65 725f 7365 6e64 280a 2020 2020  orker_send(.    
-0002c510: 2020 2020 2020 2020 2020 2020 772c 0a20              w,. 
-0002c520: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-0002c530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c540: 2020 2020 2022 6f70 223a 2022 7265 6d6f       "op": "remo
-0002c550: 7665 2d77 6f72 6b65 7222 2c0a 2020 2020  ve-worker",.    
-0002c560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c570: 2277 6f72 6b65 7222 3a20 6164 6472 6573  "worker": addres
-0002c580: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-0002c590: 2020 2020 2020 2022 7374 696d 756c 7573         "stimulus
-0002c5a0: 5f69 6422 3a20 7374 696d 756c 7573 5f69  _id": stimulus_i
-0002c5b0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-0002c5c0: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
-0002c5d0: 2020 290a 0a20 2020 2020 2020 2072 6574    )..        ret
-0002c5e0: 7572 6e20 224f 4b22 0a0a 2020 2020 6465  urn "OK"..    de
-0002c5f0: 6620 7374 696d 756c 7573 5f63 616e 6365  f stimulus_cance
-0002c600: 6c28 0a20 2020 2020 2020 2073 656c 662c  l(.        self,
-0002c610: 206b 6579 733a 2053 6571 7565 6e63 655b   keys: Sequence[
-0002c620: 7374 725d 2c20 636c 6965 6e74 3a20 7374  str], client: st
-0002c630: 722c 2066 6f72 6365 3a20 626f 6f6c 203d  r, force: bool =
-0002c640: 2046 616c 7365 0a20 2020 2029 202d 3e20   False.    ) -> 
-0002c650: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
-0002c660: 2253 746f 7020 6578 6563 7574 696f 6e20  "Stop execution 
-0002c670: 6f6e 2061 206c 6973 7420 6f66 206b 6579  on a list of key
-0002c680: 7322 2222 0a20 2020 2020 2020 206c 6f67  s""".        log
-0002c690: 6765 722e 696e 666f 2822 436c 6965 6e74  ger.info("Client
-0002c6a0: 2025 7320 7265 7175 6573 7473 2074 6f20   %s requests to 
-0002c6b0: 6361 6e63 656c 2025 6420 6b65 7973 222c  cancel %d keys",
-0002c6c0: 2063 6c69 656e 742c 206c 656e 286b 6579   client, len(key
-0002c6d0: 7329 290a 2020 2020 2020 2020 6966 2063  s)).        if c
-0002c6e0: 6c69 656e 743a 0a20 2020 2020 2020 2020  lient:.         
-0002c6f0: 2020 2073 656c 662e 6c6f 675f 6576 656e     self.log_even
-0002c700: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-0002c710: 2020 2063 6c69 656e 742c 207b 2261 6374     client, {"act
-0002c720: 696f 6e22 3a20 2263 616e 6365 6c22 2c20  ion": "cancel", 
-0002c730: 2263 6f75 6e74 223a 206c 656e 286b 6579  "count": len(key
-0002c740: 7329 2c20 2266 6f72 6365 223a 2066 6f72  s), "force": for
-0002c750: 6365 7d0a 2020 2020 2020 2020 2020 2020  ce}.            
-0002c760: 290a 2020 2020 2020 2020 6361 6e63 656c  ).        cancel
-0002c770: 6c65 645f 6b65 7973 203d 205b 5d0a 2020  led_keys = [].  
-0002c780: 2020 2020 2020 636c 6965 6e74 7320 3d20        clients = 
-0002c790: 5b5d 0a20 2020 2020 2020 2066 6f72 206b  [].        for k
-0002c7a0: 6579 2069 6e20 6b65 7973 3a0a 2020 2020  ey in keys:.    
-0002c7b0: 2020 2020 2020 2020 7473 3a20 5461 736b          ts: Task
-0002c7c0: 5374 6174 6520 7c20 4e6f 6e65 203d 2073  State | None = s
-0002c7d0: 656c 662e 7461 736b 732e 6765 7428 6b65  elf.tasks.get(ke
-0002c7e0: 7929 0a20 2020 2020 2020 2020 2020 2069  y).            i
-0002c7f0: 6620 6e6f 7420 7473 3a0a 2020 2020 2020  f not ts:.      
-0002c800: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-0002c810: 7565 0a20 2020 2020 2020 2020 2020 2074  ue.            t
-0002c820: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0002c830: 2020 2020 6373 3a20 436c 6965 6e74 5374      cs: ClientSt
-0002c840: 6174 6520 3d20 7365 6c66 2e63 6c69 656e  ate = self.clien
-0002c850: 7473 5b63 6c69 656e 745d 0a20 2020 2020  ts[client].     
-0002c860: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
-0002c870: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
-0002c880: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
-0002c890: 2020 2020 2020 2020 2020 2020 6966 2066              if f
-0002c8a0: 6f72 6365 206f 7220 7473 2e77 686f 5f77  orce or ts.who_w
-0002c8b0: 616e 7473 203d 3d20 7b63 737d 3a20 2023  ants == {cs}:  #
-0002c8c0: 206e 6f20 6f6e 6520 656c 7365 2077 616e   no one else wan
-0002c8d0: 7473 2074 6869 7320 6b65 790a 2020 2020  ts this key.    
-0002c8e0: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-0002c8f0: 732e 6465 7065 6e64 656e 7473 3a0a 2020  s.dependents:.  
-0002c900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c910: 2020 7365 6c66 2e73 7469 6d75 6c75 735f    self.stimulus_
-0002c920: 6361 6e63 656c 280a 2020 2020 2020 2020  cancel(.        
-0002c930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c940: 5b64 7473 2e6b 6579 2066 6f72 2064 7473  [dts.key for dts
-0002c950: 2069 6e20 7473 2e64 6570 656e 6465 6e74   in ts.dependent
-0002c960: 735d 2c20 636c 6965 6e74 2c20 666f 7263  s], client, forc
-0002c970: 653d 666f 7263 650a 2020 2020 2020 2020  e=force.        
-0002c980: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0002c990: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-0002c9a0: 6767 6572 2e69 6e66 6f28 2253 6368 6564  gger.info("Sched
-0002c9b0: 756c 6572 2063 616e 6365 6c73 206b 6579  uler cancels key
-0002c9c0: 2025 732e 2020 466f 7263 653d 2573 222c   %s.  Force=%s",
-0002c9d0: 206b 6579 2c20 666f 7263 6529 0a20 2020   key, force).   
-0002c9e0: 2020 2020 2020 2020 2020 2020 2063 616e               can
-0002c9f0: 6365 6c6c 6564 5f6b 6579 732e 6170 7065  celled_keys.appe
-0002ca00: 6e64 286b 6579 290a 2020 2020 2020 2020  nd(key).        
-0002ca10: 2020 2020 636c 6965 6e74 732e 6578 7465      clients.exte
-0002ca20: 6e64 286c 6973 7428 7473 2e77 686f 5f77  nd(list(ts.who_w
-0002ca30: 616e 7473 2920 6966 2066 6f72 6365 2065  ants) if force e
-0002ca40: 6c73 6520 5b63 735d 290a 2020 2020 2020  lse [cs]).      
-0002ca50: 2020 666f 7220 6373 2069 6e20 636c 6965    for cs in clie
-0002ca60: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
-0002ca70: 2073 656c 662e 636c 6965 6e74 5f72 656c   self.client_rel
-0002ca80: 6561 7365 735f 6b65 7973 280a 2020 2020  eases_keys(.    
-0002ca90: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
-0002caa0: 3d63 616e 6365 6c6c 6564 5f6b 6579 732c  =cancelled_keys,
-0002cab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002cac0: 2063 6c69 656e 743d 6373 2e63 6c69 656e   client=cs.clien
-0002cad0: 745f 6b65 792c 0a20 2020 2020 2020 2020  t_key,.         
-0002cae0: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
-0002caf0: 6964 3d66 2263 616e 6365 6c2d 6b65 792d  id=f"cancel-key-
-0002cb00: 7b74 696d 6528 297d 222c 0a20 2020 2020  {time()}",.     
-0002cb10: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0002cb20: 2073 656c 662e 7265 706f 7274 287b 226f   self.report({"o
-0002cb30: 7022 3a20 2263 616e 6365 6c6c 6564 2d6b  p": "cancelled-k
-0002cb40: 6579 7322 2c20 226b 6579 7322 3a20 6361  eys", "keys": ca
-0002cb50: 6e63 656c 6c65 645f 6b65 7973 7d29 0a0a  ncelled_keys})..
-0002cb60: 2020 2020 6465 6620 636c 6965 6e74 5f64      def client_d
-0002cb70: 6573 6972 6573 5f6b 6579 7328 7365 6c66  esires_keys(self
-0002cb80: 2c20 6b65 7973 3d4e 6f6e 652c 2063 6c69  , keys=None, cli
-0002cb90: 656e 743d 4e6f 6e65 293a 0a20 2020 2020  ent=None):.     
-0002cba0: 2020 2063 733a 2043 6c69 656e 7453 7461     cs: ClientSta
-0002cbb0: 7465 203d 2073 656c 662e 636c 6965 6e74  te = self.client
-0002cbc0: 732e 6765 7428 636c 6965 6e74 290a 2020  s.get(client).  
-0002cbd0: 2020 2020 2020 6966 2063 7320 6973 204e        if cs is N
-0002cbe0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0002cbf0: 2023 2046 6f72 2070 7562 6c69 7368 2c20   # For publish, 
-0002cc00: 7175 6575 6573 2065 7463 2e0a 2020 2020  queues etc..    
-0002cc10: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
-0002cc20: 656e 7473 5b63 6c69 656e 745d 203d 2063  ents[client] = c
-0002cc30: 7320 3d20 436c 6965 6e74 5374 6174 6528  s = ClientState(
-0002cc40: 636c 6965 6e74 290a 2020 2020 2020 2020  client).        
-0002cc50: 666f 7220 6b20 696e 206b 6579 733a 0a20  for k in keys:. 
-0002cc60: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
-0002cc70: 7365 6c66 2e74 6173 6b73 2e67 6574 286b  self.tasks.get(k
-0002cc80: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0002cc90: 2074 7320 6973 204e 6f6e 653a 0a20 2020   ts is None:.   
-0002cca0: 2020 2020 2020 2020 2020 2020 2023 2046               # F
-0002ccb0: 6f72 2070 7562 6c69 7368 2c20 7175 6575  or publish, queu
-0002ccc0: 6573 2065 7463 2e0a 2020 2020 2020 2020  es etc..        
-0002ccd0: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-0002cce0: 662e 6e65 775f 7461 736b 286b 2c20 4e6f  f.new_task(k, No
-0002ccf0: 6e65 2c20 2272 656c 6561 7365 6422 290a  ne, "released").
-0002cd00: 2020 2020 2020 2020 2020 2020 7473 2e77              ts.w
-0002cd10: 686f 5f77 616e 7473 2e61 6464 2863 7329  ho_wants.add(cs)
-0002cd20: 0a20 2020 2020 2020 2020 2020 2063 732e  .            cs.
-0002cd30: 7761 6e74 735f 7768 6174 2e61 6464 2874  wants_what.add(t
-0002cd40: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
-0002cd50: 6966 2074 732e 7374 6174 6520 696e 2028  if ts.state in (
-0002cd60: 226d 656d 6f72 7922 2c20 2265 7272 6564  "memory", "erred
-0002cd70: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
-0002cd80: 2020 2020 7365 6c66 2e72 6570 6f72 745f      self.report_
-0002cd90: 6f6e 5f6b 6579 2874 733d 7473 2c20 636c  on_key(ts=ts, cl
-0002cda0: 6965 6e74 3d63 6c69 656e 7429 0a0a 2020  ient=client)..  
-0002cdb0: 2020 6465 6620 636c 6965 6e74 5f72 656c    def client_rel
-0002cdc0: 6561 7365 735f 6b65 7973 2873 656c 662c  eases_keys(self,
-0002cdd0: 206b 6579 733d 4e6f 6e65 2c20 636c 6965   keys=None, clie
-0002cde0: 6e74 3d4e 6f6e 652c 2073 7469 6d75 6c75  nt=None, stimulu
-0002cdf0: 735f 6964 3d4e 6f6e 6529 3a0a 2020 2020  s_id=None):.    
-0002ce00: 2020 2020 2222 2252 656d 6f76 6520 6b65      """Remove ke
-0002ce10: 7973 2066 726f 6d20 636c 6965 6e74 2064  ys from client d
-0002ce20: 6573 6972 6564 206c 6973 7422 2222 0a20  esired list""". 
-0002ce30: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
-0002ce40: 6964 203d 2073 7469 6d75 6c75 735f 6964  id = stimulus_id
-0002ce50: 206f 7220 6622 636c 6965 6e74 2d72 656c   or f"client-rel
-0002ce60: 6561 7365 732d 6b65 7973 2d7b 7469 6d65  eases-keys-{time
-0002ce70: 2829 7d22 0a20 2020 2020 2020 2069 6620  ()}".        if 
-0002ce80: 6e6f 7420 6973 696e 7374 616e 6365 286b  not isinstance(k
-0002ce90: 6579 732c 206c 6973 7429 3a0a 2020 2020  eys, list):.    
-0002cea0: 2020 2020 2020 2020 6b65 7973 203d 206c          keys = l
-0002ceb0: 6973 7428 6b65 7973 290a 2020 2020 2020  ist(keys).      
-0002cec0: 2020 6373 203d 2073 656c 662e 636c 6965    cs = self.clie
-0002ced0: 6e74 735b 636c 6965 6e74 5d0a 2020 2020  nts[client].    
-0002cee0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-0002cef0: 6f6e 733a 2052 6563 7320 3d20 7b7d 0a0a  ons: Recs = {}..
-0002cf00: 2020 2020 2020 2020 7365 6c66 2e5f 636c          self._cl
-0002cf10: 6965 6e74 5f72 656c 6561 7365 735f 6b65  ient_releases_ke
-0002cf20: 7973 286b 6579 733d 6b65 7973 2c20 6373  ys(keys=keys, cs
-0002cf30: 3d63 732c 2072 6563 6f6d 6d65 6e64 6174  =cs, recommendat
-0002cf40: 696f 6e73 3d72 6563 6f6d 6d65 6e64 6174  ions=recommendat
-0002cf50: 696f 6e73 290a 2020 2020 2020 2020 7365  ions).        se
-0002cf60: 6c66 2e74 7261 6e73 6974 696f 6e73 2872  lf.transitions(r
-0002cf70: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
-0002cf80: 7374 696d 756c 7573 5f69 6429 0a0a 2020  stimulus_id)..  
-0002cf90: 2020 2020 2020 7365 6c66 2e73 7469 6d75        self.stimu
-0002cfa0: 6c75 735f 7175 6575 655f 736c 6f74 735f  lus_queue_slots_
-0002cfb0: 6d61 7962 655f 6f70 656e 6564 2873 7469  maybe_opened(sti
-0002cfc0: 6d75 6c75 735f 6964 3d73 7469 6d75 6c75  mulus_id=stimulu
-0002cfd0: 735f 6964 290a 0a20 2020 2064 6566 2063  s_id)..    def c
-0002cfe0: 6c69 656e 745f 6865 6172 7462 6561 7428  lient_heartbeat(
-0002cff0: 7365 6c66 2c20 636c 6965 6e74 3d4e 6f6e  self, client=Non
-0002d000: 6529 3a0a 2020 2020 2020 2020 2222 2248  e):.        """H
-0002d010: 616e 646c 6520 6865 6172 7462 6561 7473  andle heartbeats
-0002d020: 2066 726f 6d20 436c 6965 6e74 2222 220a   from Client""".
-0002d030: 2020 2020 2020 2020 6373 3a20 436c 6965          cs: Clie
-0002d040: 6e74 5374 6174 6520 3d20 7365 6c66 2e63  ntState = self.c
-0002d050: 6c69 656e 7473 5b63 6c69 656e 745d 0a20  lients[client]. 
-0002d060: 2020 2020 2020 2063 732e 6c61 7374 5f73         cs.last_s
-0002d070: 6565 6e20 3d20 7469 6d65 2829 0a0a 2020  een = time()..  
-0002d080: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
-0002d090: 2323 2323 230a 2020 2020 2320 5461 736b  #####.    # Task
-0002d0a0: 2056 616c 6964 6174 696f 6e20 230a 2020   Validation #.  
-0002d0b0: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
-0002d0c0: 2323 2323 230a 0a20 2020 2064 6566 2076  #####..    def v
-0002d0d0: 616c 6964 6174 655f 7265 6c65 6173 6564  alidate_released
-0002d0e0: 2873 656c 662c 206b 6579 3a20 7374 7229  (self, key: str)
-0002d0f0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0002d100: 2020 7473 3a20 5461 736b 5374 6174 6520    ts: TaskState 
-0002d110: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-0002d120: 5d0a 2020 2020 2020 2020 6173 7365 7274  ].        assert
-0002d130: 2074 732e 7374 6174 6520 3d3d 2022 7265   ts.state == "re
-0002d140: 6c65 6173 6564 220a 2020 2020 2020 2020  leased".        
-0002d150: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
-0002d160: 6974 6572 730a 2020 2020 2020 2020 6173  iters.        as
-0002d170: 7365 7274 206e 6f74 2074 732e 7761 6974  sert not ts.wait
-0002d180: 696e 675f 6f6e 0a20 2020 2020 2020 2061  ing_on.        a
-0002d190: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
-0002d1a0: 5f68 6173 0a20 2020 2020 2020 2061 7373  _has.        ass
-0002d1b0: 6572 7420 6e6f 7420 7473 2e70 726f 6365  ert not ts.proce
-0002d1c0: 7373 696e 675f 6f6e 0a20 2020 2020 2020  ssing_on.       
-0002d1d0: 2061 7373 6572 7420 6e6f 7420 616e 7928   assert not any(
-0002d1e0: 5b74 7320 696e 2064 7473 2e77 6169 7465  [ts in dts.waite
-0002d1f0: 7273 2066 6f72 2064 7473 2069 6e20 7473  rs for dts in ts
-0002d200: 2e64 6570 656e 6465 6e63 6965 735d 290a  .dependencies]).
-0002d210: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-0002d220: 7320 6e6f 7420 696e 2073 656c 662e 756e  s not in self.un
-0002d230: 7275 6e6e 6162 6c65 0a20 2020 2020 2020  runnable.       
-0002d240: 2061 7373 6572 7420 7473 206e 6f74 2069   assert ts not i
-0002d250: 6e20 7365 6c66 2e71 7565 7565 640a 0a20  n self.queued.. 
-0002d260: 2020 2064 6566 2076 616c 6964 6174 655f     def validate_
-0002d270: 7761 6974 696e 6728 7365 6c66 2c20 6b65  waiting(self, ke
-0002d280: 793a 2073 7472 2920 2d3e 204e 6f6e 653a  y: str) -> None:
-0002d290: 0a20 2020 2020 2020 2074 733a 2054 6173  .        ts: Tas
-0002d2a0: 6b53 7461 7465 203d 2073 656c 662e 7461  kState = self.ta
-0002d2b0: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
-0002d2c0: 2061 7373 6572 7420 7473 2e77 6169 7469   assert ts.waiti
-0002d2d0: 6e67 5f6f 6e0a 2020 2020 2020 2020 6173  ng_on.        as
-0002d2e0: 7365 7274 206e 6f74 2074 732e 7768 6f5f  sert not ts.who_
-0002d2f0: 6861 730a 2020 2020 2020 2020 6173 7365  has.        asse
-0002d300: 7274 206e 6f74 2074 732e 7072 6f63 6573  rt not ts.proces
-0002d310: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
-0002d320: 6173 7365 7274 2074 7320 6e6f 7420 696e  assert ts not in
-0002d330: 2073 656c 662e 756e 7275 6e6e 6162 6c65   self.unrunnable
-0002d340: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0002d350: 7473 206e 6f74 2069 6e20 7365 6c66 2e71  ts not in self.q
-0002d360: 7565 7565 640a 2020 2020 2020 2020 666f  ueued.        fo
-0002d370: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
-0002d380: 6e64 656e 6369 6573 3a0a 2020 2020 2020  ndencies:.      
-0002d390: 2020 2020 2020 2320 5765 2061 7265 2077        # We are w
-0002d3a0: 6169 7469 6e67 206f 6e20 6120 6465 7065  aiting on a depe
-0002d3b0: 6e64 656e 6379 2069 6666 2069 7427 7320  ndency iff it's 
-0002d3c0: 6e6f 7420 7374 6f72 6564 0a20 2020 2020  not stored.     
-0002d3d0: 2020 2020 2020 2061 7373 6572 7420 626f         assert bo
-0002d3e0: 6f6c 2864 7473 2e77 686f 5f68 6173 2920  ol(dts.who_has) 
-0002d3f0: 213d 2028 6474 7320 696e 2074 732e 7761  != (dts in ts.wa
-0002d400: 6974 696e 675f 6f6e 290a 2020 2020 2020  iting_on).      
-0002d410: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
-0002d420: 696e 2064 7473 2e77 6169 7465 7273 2020  in dts.waiters  
-0002d430: 2320 5858 5820 6576 656e 2069 6620 6474  # XXX even if dt
-0002d440: 732e 5f77 686f 5f68 6173 3f0a 0a20 2020  s._who_has?..   
-0002d450: 2064 6566 2076 616c 6964 6174 655f 7175   def validate_qu
-0002d460: 6575 6564 2873 656c 662c 206b 6579 3a20  eued(self, key: 
-0002d470: 7374 7229 202d 3e20 4e6f 6e65 3a0a 2020  str) -> None:.  
-0002d480: 2020 2020 2020 7473 3a20 5461 736b 5374        ts: TaskSt
-0002d490: 6174 6520 3d20 7365 6c66 2e74 6173 6b73  ate = self.tasks
-0002d4a0: 5b6b 6579 5d0a 2020 2020 2020 2020 6474  [key].        dt
-0002d4b0: 733a 2054 6173 6b53 7461 7465 0a20 2020  s: TaskState.   
-0002d4c0: 2020 2020 2061 7373 6572 7420 7473 2069       assert ts i
-0002d4d0: 6e20 7365 6c66 2e71 7565 7565 640a 2020  n self.queued.  
-0002d4e0: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-0002d4f0: 2074 732e 7761 6974 696e 675f 6f6e 0a20   ts.waiting_on. 
-0002d500: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-0002d510: 7420 7473 2e77 686f 5f68 6173 0a20 2020  t ts.who_has.   
-0002d520: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-0002d530: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-0002d540: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0002d550: 6e6f 7420 280a 2020 2020 2020 2020 2020  not (.          
-0002d560: 2020 7473 2e77 6f72 6b65 725f 7265 7374    ts.worker_rest
-0002d570: 7269 6374 696f 6e73 206f 7220 7473 2e68  rictions or ts.h
-0002d580: 6f73 745f 7265 7374 7269 6374 696f 6e73  ost_restrictions
-0002d590: 206f 7220 7473 2e72 6573 6f75 7263 655f   or ts.resource_
-0002d5a0: 7265 7374 7269 6374 696f 6e73 0a20 2020  restrictions.   
-0002d5b0: 2020 2020 2029 0a20 2020 2020 2020 2066       ).        f
-0002d5c0: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
-0002d5d0: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
-0002d5e0: 2020 2020 2020 2061 7373 6572 7420 6474         assert dt
-0002d5f0: 732e 7768 6f5f 6861 730a 2020 2020 2020  s.who_has.      
-0002d600: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
-0002d610: 696e 2064 7473 2e77 6169 7465 7273 0a0a  in dts.waiters..
-0002d620: 2020 2020 6465 6620 7661 6c69 6461 7465      def validate
-0002d630: 5f70 726f 6365 7373 696e 6728 7365 6c66  _processing(self
-0002d640: 2c20 6b65 793a 2073 7472 2920 2d3e 204e  , key: str) -> N
-0002d650: 6f6e 653a 0a20 2020 2020 2020 2074 733a  one:.        ts:
-0002d660: 2054 6173 6b53 7461 7465 203d 2073 656c   TaskState = sel
-0002d670: 662e 7461 736b 735b 6b65 795d 0a20 2020  f.tasks[key].   
-0002d680: 2020 2020 2064 7473 3a20 5461 736b 5374       dts: TaskSt
-0002d690: 6174 650a 2020 2020 2020 2020 6173 7365  ate.        asse
-0002d6a0: 7274 206e 6f74 2074 732e 7761 6974 696e  rt not ts.waitin
-0002d6b0: 675f 6f6e 0a20 2020 2020 2020 2077 7320  g_on.        ws 
-0002d6c0: 3d20 7473 2e70 726f 6365 7373 696e 675f  = ts.processing_
-0002d6d0: 6f6e 0a20 2020 2020 2020 2061 7373 6572  on.        asser
-0002d6e0: 7420 7773 0a20 2020 2020 2020 2061 7373  t ws.        ass
-0002d6f0: 6572 7420 7473 2069 6e20 7773 2e70 726f  ert ts in ws.pro
-0002d700: 6365 7373 696e 670a 2020 2020 2020 2020  cessing.        
-0002d710: 6173 7365 7274 206e 6f74 2074 732e 7768  assert not ts.wh
-0002d720: 6f5f 6861 730a 2020 2020 2020 2020 6173  o_has.        as
-0002d730: 7365 7274 2074 7320 6e6f 7420 696e 2073  sert ts not in s
-0002d740: 656c 662e 7175 6575 6564 0a20 2020 2020  elf.queued.     
-0002d750: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
-0002d760: 2e64 6570 656e 6465 6e63 6965 733a 0a20  .dependencies:. 
-0002d770: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0002d780: 7420 6474 732e 7768 6f5f 6861 730a 2020  t dts.who_has.  
-0002d790: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0002d7a0: 2074 7320 696e 2064 7473 2e77 6169 7465   ts in dts.waite
-0002d7b0: 7273 0a0a 2020 2020 6465 6620 7661 6c69  rs..    def vali
-0002d7c0: 6461 7465 5f6d 656d 6f72 7928 7365 6c66  date_memory(self
-0002d7d0: 2c20 6b65 793a 2073 7472 2920 2d3e 204e  , key: str) -> N
-0002d7e0: 6f6e 653a 0a20 2020 2020 2020 2074 733a  one:.        ts:
-0002d7f0: 2054 6173 6b53 7461 7465 203d 2073 656c   TaskState = sel
-0002d800: 662e 7461 736b 735b 6b65 795d 0a20 2020  f.tasks[key].   
-0002d810: 2020 2020 2064 7473 3a20 5461 736b 5374       dts: TaskSt
-0002d820: 6174 650a 2020 2020 2020 2020 6173 7365  ate.        asse
-0002d830: 7274 2074 732e 7768 6f5f 6861 730a 2020  rt ts.who_has.  
-0002d840: 2020 2020 2020 6173 7365 7274 2062 6f6f        assert boo
-0002d850: 6c28 7473 2069 6e20 7365 6c66 2e72 6570  l(ts in self.rep
-0002d860: 6c69 6361 7465 645f 7461 736b 7329 203d  licated_tasks) =
-0002d870: 3d20 286c 656e 2874 732e 7768 6f5f 6861  = (len(ts.who_ha
-0002d880: 7329 203e 2031 290a 2020 2020 2020 2020  s) > 1).        
-0002d890: 6173 7365 7274 206e 6f74 2074 732e 7072  assert not ts.pr
-0002d8a0: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
-0002d8b0: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
-0002d8c0: 732e 7761 6974 696e 675f 6f6e 0a20 2020  s.waiting_on.   
-0002d8d0: 2020 2020 2061 7373 6572 7420 7473 206e       assert ts n
-0002d8e0: 6f74 2069 6e20 7365 6c66 2e75 6e72 756e  ot in self.unrun
-0002d8f0: 6e61 626c 650a 2020 2020 2020 2020 6173  nable.        as
-0002d900: 7365 7274 2074 7320 6e6f 7420 696e 2073  sert ts not in s
-0002d910: 656c 662e 7175 6575 6564 0a20 2020 2020  elf.queued.     
-0002d920: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
-0002d930: 2e64 6570 656e 6465 6e74 733a 0a20 2020  .dependents:.   
-0002d940: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0002d950: 2864 7473 2069 6e20 7473 2e77 6169 7465  (dts in ts.waite
-0002d960: 7273 2920 3d3d 2028 0a20 2020 2020 2020  rs) == (.       
-0002d970: 2020 2020 2020 2020 2064 7473 2e73 7461           dts.sta
-0002d980: 7465 2069 6e20 2822 7761 6974 696e 6722  te in ("waiting"
-0002d990: 2c20 2271 7565 7565 6422 2c20 2270 726f  , "queued", "pro
-0002d9a0: 6365 7373 696e 6722 2c20 226e 6f2d 776f  cessing", "no-wo
-0002d9b0: 726b 6572 2229 0a20 2020 2020 2020 2020  rker").         
-0002d9c0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0002d9d0: 2061 7373 6572 7420 7473 206e 6f74 2069   assert ts not i
-0002d9e0: 6e20 6474 732e 7761 6974 696e 675f 6f6e  n dts.waiting_on
-0002d9f0: 0a0a 2020 2020 6465 6620 7661 6c69 6461  ..    def valida
-0002da00: 7465 5f6e 6f5f 776f 726b 6572 2873 656c  te_no_worker(sel
-0002da10: 662c 206b 6579 3a20 7374 7229 202d 3e20  f, key: str) -> 
-0002da20: 4e6f 6e65 3a0a 2020 2020 2020 2020 7473  None:.        ts
-0002da30: 3a20 5461 736b 5374 6174 6520 3d20 7365  : TaskState = se
-0002da40: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 2020  lf.tasks[key].  
-0002da50: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
-0002da60: 696e 2073 656c 662e 756e 7275 6e6e 6162  in self.unrunnab
-0002da70: 6c65 0a20 2020 2020 2020 2061 7373 6572  le.        asser
-0002da80: 7420 6e6f 7420 7473 2e77 6169 7469 6e67  t not ts.waiting
-0002da90: 5f6f 6e0a 2020 2020 2020 2020 6173 7365  _on.        asse
-0002daa0: 7274 2074 7320 696e 2073 656c 662e 756e  rt ts in self.un
-0002dab0: 7275 6e6e 6162 6c65 0a20 2020 2020 2020  runnable.       
-0002dac0: 2061 7373 6572 7420 6e6f 7420 7473 2e70   assert not ts.p
-0002dad0: 726f 6365 7373 696e 675f 6f6e 0a20 2020  rocessing_on.   
-0002dae0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-0002daf0: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
-0002db00: 2020 2061 7373 6572 7420 7473 206e 6f74     assert ts not
-0002db10: 2069 6e20 7365 6c66 2e71 7565 7565 640a   in self.queued.
-0002db20: 2020 2020 2020 2020 666f 7220 6474 7320          for dts 
-0002db30: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
-0002db40: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-0002db50: 6173 7365 7274 2064 7473 2e77 686f 5f68  assert dts.who_h
-0002db60: 6173 0a0a 2020 2020 6465 6620 7661 6c69  as..    def vali
-0002db70: 6461 7465 5f65 7272 6564 2873 656c 662c  date_erred(self,
-0002db80: 206b 6579 3a20 7374 7229 202d 3e20 4e6f   key: str) -> No
-0002db90: 6e65 3a0a 2020 2020 2020 2020 7473 3a20  ne:.        ts: 
-0002dba0: 5461 736b 5374 6174 6520 3d20 7365 6c66  TaskState = self
-0002dbb0: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
-0002dbc0: 2020 2020 6173 7365 7274 2074 732e 6578      assert ts.ex
-0002dbd0: 6365 7074 696f 6e5f 626c 616d 650a 2020  ception_blame.  
-0002dbe0: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-0002dbf0: 2074 732e 7768 6f5f 6861 730a 2020 2020   ts.who_has.    
-0002dc00: 2020 2020 6173 7365 7274 2074 7320 6e6f      assert ts no
-0002dc10: 7420 696e 2073 656c 662e 7175 6575 6564  t in self.queued
-0002dc20: 0a0a 2020 2020 6465 6620 7661 6c69 6461  ..    def valida
-0002dc30: 7465 5f6b 6579 2873 656c 662c 206b 6579  te_key(self, key
-0002dc40: 3a20 7374 722c 2074 733a 2054 6173 6b53  : str, ts: TaskS
-0002dc50: 7461 7465 207c 204e 6f6e 6520 3d20 4e6f  tate | None = No
-0002dc60: 6e65 2920 2d3e 204e 6f6e 653a 0a20 2020  ne) -> None:.   
-0002dc70: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0002dc80: 2020 2020 2020 6966 2074 7320 6973 204e        if ts is N
-0002dc90: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0002dca0: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
-0002dcb0: 6173 6b73 2e67 6574 286b 6579 290a 2020  asks.get(key).  
-0002dcc0: 2020 2020 2020 2020 2020 6966 2074 7320            if ts 
-0002dcd0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0002dce0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-0002dcf0: 6465 6275 6728 224b 6579 206c 6f73 743a  debug("Key lost:
-0002dd00: 2025 7322 2c20 6b65 7929 0a20 2020 2020   %s", key).     
-0002dd10: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0002dd20: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
-0002dd30: 7661 6c69 6461 7465 2829 0a20 2020 2020  validate().     
-0002dd40: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0002dd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dd60: 2020 2020 6675 6e63 203d 2067 6574 6174      func = getat
-0002dd70: 7472 2873 656c 662c 2022 7661 6c69 6461  tr(self, "valida
-0002dd80: 7465 5f22 202b 2074 732e 7374 6174 652e  te_" + ts.state.
-0002dd90: 7265 706c 6163 6528 222d 222c 2022 5f22  replace("-", "_"
-0002dda0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-0002ddb0: 2020 2065 7863 6570 7420 4174 7472 6962     except Attrib
-0002ddc0: 7574 6545 7272 6f72 3a0a 2020 2020 2020  uteError:.      
-0002ddd0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-0002dde0: 6767 6572 2e65 7272 6f72 280a 2020 2020  gger.error(.    
-0002ddf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002de00: 2020 2020 2273 656c 662e 7661 6c69 6461      "self.valida
-0002de10: 7465 5f25 7320 6e6f 7420 666f 756e 6422  te_%s not found"
-0002de20: 2c20 7473 2e73 7461 7465 2e72 6570 6c61  , ts.state.repla
-0002de30: 6365 2822 2d22 2c20 225f 2229 0a20 2020  ce("-", "_").   
-0002de40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002de50: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0002de60: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002de70: 2020 2020 2020 2020 2020 2020 2066 756e               fun
-0002de80: 6328 6b65 7929 0a20 2020 2020 2020 2065  c(key).        e
-0002de90: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
-0002dea0: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-0002deb0: 2020 6c6f 6767 6572 2e65 7863 6570 7469    logger.excepti
-0002dec0: 6f6e 2865 290a 2020 2020 2020 2020 2020  on(e).          
-0002ded0: 2020 6966 204c 4f47 5f50 4442 3a0a 2020    if LOG_PDB:.  
-0002dee0: 2020 2020 2020 2020 2020 2020 2020 696d                im
-0002def0: 706f 7274 2070 6462 0a0a 2020 2020 2020  port pdb..      
-0002df00: 2020 2020 2020 2020 2020 7064 622e 7365            pdb.se
-0002df10: 745f 7472 6163 6528 290a 2020 2020 2020  t_trace().      
-0002df20: 2020 2020 2020 7261 6973 650a 0a20 2020        raise..   
-0002df30: 2064 6566 2076 616c 6964 6174 655f 7374   def validate_st
-0002df40: 6174 6528 7365 6c66 2c20 616c 6c6f 775f  ate(self, allow_
-0002df50: 6f76 6572 6c61 703a 2062 6f6f 6c20 3d20  overlap: bool = 
-0002df60: 4661 6c73 6529 202d 3e20 4e6f 6e65 3a0a  False) -> None:.
-0002df70: 2020 2020 2020 2020 7661 6c69 6461 7465          validate
-0002df80: 5f73 7461 7465 2873 656c 662e 7461 736b  _state(self.task
-0002df90: 732c 2073 656c 662e 776f 726b 6572 732c  s, self.workers,
-0002dfa0: 2073 656c 662e 636c 6965 6e74 7329 0a0a   self.clients)..
-0002dfb0: 2020 2020 2020 2020 6966 206e 6f74 2028          if not (
-0002dfc0: 7365 7428 7365 6c66 2e77 6f72 6b65 7273  set(self.workers
-0002dfd0: 2920 3d3d 2073 6574 2873 656c 662e 7374  ) == set(self.st
-0002dfe0: 7265 616d 5f63 6f6d 6d73 2929 3a0a 2020  ream_comms)):.  
-0002dff0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0002e000: 5661 6c75 6545 7272 6f72 2822 576f 726b  ValueError("Work
-0002e010: 6572 7320 6e6f 7420 7468 6520 7361 6d65  ers not the same
-0002e020: 2069 6e20 616c 6c20 636f 6c6c 6563 7469   in all collecti
-0002e030: 6f6e 7322 290a 0a20 2020 2020 2020 2061  ons")..        a
-0002e040: 7373 6572 7420 7365 6c66 2e72 756e 6e69  ssert self.runni
-0002e050: 6e67 2e69 7373 7570 6572 7365 7428 7365  ng.issuperset(se
-0002e060: 6c66 2e69 646c 652e 7661 6c75 6573 2829  lf.idle.values()
-0002e070: 292c 2028 0a20 2020 2020 2020 2020 2020  ), (.           
-0002e080: 2073 656c 662e 7275 6e6e 696e 672e 636f   self.running.co
-0002e090: 7079 2829 2c0a 2020 2020 2020 2020 2020  py(),.          
-0002e0a0: 2020 7365 7428 7365 6c66 2e69 646c 652e    set(self.idle.
-0002e0b0: 7661 6c75 6573 2829 292c 0a20 2020 2020  values()),.     
-0002e0c0: 2020 2029 0a20 2020 2020 2020 2061 7373     ).        ass
-0002e0d0: 6572 7420 7365 6c66 2e72 756e 6e69 6e67  ert self.running
-0002e0e0: 2e69 7373 7570 6572 7365 7428 7365 6c66  .issuperset(self
-0002e0f0: 2e69 646c 655f 7461 736b 5f63 6f75 6e74  .idle_task_count
-0002e100: 292c 2028 0a20 2020 2020 2020 2020 2020  ), (.           
-0002e110: 2073 656c 662e 7275 6e6e 696e 672e 636f   self.running.co
-0002e120: 7079 2829 2c0a 2020 2020 2020 2020 2020  py(),.          
-0002e130: 2020 7365 6c66 2e69 646c 655f 7461 736b    self.idle_task
-0002e140: 5f63 6f75 6e74 2e63 6f70 7928 292c 0a20  _count.copy(),. 
-0002e150: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0002e160: 2061 7373 6572 7420 7365 6c66 2e72 756e   assert self.run
-0002e170: 6e69 6e67 2e69 7373 7570 6572 7365 7428  ning.issuperset(
-0002e180: 7365 6c66 2e73 6174 7572 6174 6564 292c  self.saturated),
-0002e190: 2028 0a20 2020 2020 2020 2020 2020 2073   (.            s
-0002e1a0: 656c 662e 7275 6e6e 696e 672e 636f 7079  elf.running.copy
-0002e1b0: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
-0002e1c0: 7365 6c66 2e73 6174 7572 6174 6564 2e63  self.saturated.c
-0002e1d0: 6f70 7928 292c 0a20 2020 2020 2020 2029  opy(),.        )
-0002e1e0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0002e1f0: 7365 6c66 2e73 6174 7572 6174 6564 2e69  self.saturated.i
-0002e200: 7364 6973 6a6f 696e 7428 7365 6c66 2e69  sdisjoint(self.i
-0002e210: 646c 652e 7661 6c75 6573 2829 292c 2028  dle.values()), (
-0002e220: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0002e230: 662e 7361 7475 7261 7465 642e 636f 7079  f.saturated.copy
-0002e240: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
-0002e250: 7365 7428 7365 6c66 2e69 646c 652e 7661  set(self.idle.va
-0002e260: 6c75 6573 2829 292c 0a20 2020 2020 2020  lues()),.       
-0002e270: 2029 0a0a 2020 2020 2020 2020 7461 736b   )..        task
-0002e280: 5f70 7265 6669 785f 636f 756e 7473 3a20  _prefix_counts: 
-0002e290: 6465 6661 756c 7464 6963 745b 7374 722c  defaultdict[str,
-0002e2a0: 2069 6e74 5d20 3d20 6465 6661 756c 7464   int] = defaultd
-0002e2b0: 6963 7428 696e 7429 0a20 2020 2020 2020  ict(int).       
-0002e2c0: 2066 6f72 2077 2c20 7773 2069 6e20 7365   for w, ws in se
-0002e2d0: 6c66 2e77 6f72 6b65 7273 2e69 7465 6d73  lf.workers.items
-0002e2e0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0002e2f0: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
-0002e300: 6528 772c 2073 7472 292c 2028 7479 7065  e(w, str), (type
-0002e310: 2877 292c 2077 290a 2020 2020 2020 2020  (w), w).        
-0002e320: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-0002e330: 7461 6e63 6528 7773 2c20 576f 726b 6572  tance(ws, Worker
-0002e340: 5374 6174 6529 2c20 2874 7970 6528 7773  State), (type(ws
-0002e350: 292c 2077 7329 0a20 2020 2020 2020 2020  ), ws).         
-0002e360: 2020 2061 7373 6572 7420 7773 2e61 6464     assert ws.add
-0002e370: 7265 7373 203d 3d20 770a 0a20 2020 2020  ress == w..     
-0002e380: 2020 2020 2020 2069 6620 7773 2e73 7461         if ws.sta
-0002e390: 7475 7320 3d3d 2053 7461 7475 732e 7275  tus == Status.ru
-0002e3a0: 6e6e 696e 673a 0a20 2020 2020 2020 2020  nning:.         
-0002e3b0: 2020 2020 2020 2061 7373 6572 7420 7773         assert ws
-0002e3c0: 2069 6e20 7365 6c66 2e72 756e 6e69 6e67   in self.running
-0002e3d0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0002e3e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0002e3f0: 2020 2061 7373 6572 7420 7773 206e 6f74     assert ws not
-0002e400: 2069 6e20 7365 6c66 2e72 756e 6e69 6e67   in self.running
-0002e410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e420: 2061 7373 6572 7420 7773 2e61 6464 7265   assert ws.addre
-0002e430: 7373 206e 6f74 2069 6e20 7365 6c66 2e69  ss not in self.i
-0002e440: 646c 650a 2020 2020 2020 2020 2020 2020  dle.            
-0002e450: 2020 2020 6173 7365 7274 2077 7320 6e6f      assert ws no
-0002e460: 7420 696e 2073 656c 662e 7361 7475 7261  t in self.satura
-0002e470: 7465 640a 0a20 2020 2020 2020 2020 2020  ted..           
-0002e480: 2061 7373 6572 7420 7773 2e6c 6f6e 675f   assert ws.long_
-0002e490: 7275 6e6e 696e 672e 6973 7375 6273 6574  running.issubset
-0002e4a0: 2877 732e 7072 6f63 6573 7369 6e67 290a  (ws.processing).
-0002e4b0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0002e4c0: 6f74 2077 732e 7072 6f63 6573 7369 6e67  ot ws.processing
-0002e4d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002e4e0: 2020 6173 7365 7274 206e 6f74 2077 732e    assert not ws.
-0002e4f0: 6f63 6375 7061 6e63 790a 2020 2020 2020  occupancy.      
-0002e500: 2020 2020 2020 2020 2020 6966 2077 732e            if ws.
-0002e510: 7374 6174 7573 203d 3d20 5374 6174 7573  status == Status
-0002e520: 2e72 756e 6e69 6e67 3a0a 2020 2020 2020  .running:.      
-0002e530: 2020 2020 2020 2020 2020 2020 2020 6173                as
-0002e540: 7365 7274 2077 732e 6164 6472 6573 7320  sert ws.address 
-0002e550: 696e 2073 656c 662e 6964 6c65 0a20 2020  in self.idle.   
-0002e560: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0002e570: 6e6f 7420 7773 2e6e 6565 6473 5f77 6861  not ws.needs_wha
-0002e580: 742e 6b65 7973 2829 2026 2077 732e 6861  t.keys() & ws.ha
-0002e590: 735f 7768 6174 0a20 2020 2020 2020 2020  s_what.         
-0002e5a0: 2020 2061 6374 7561 6c5f 6e65 6564 735f     actual_needs_
-0002e5b0: 7768 6174 3a20 6465 6661 756c 7464 6963  what: defaultdic
-0002e5c0: 745b 5461 736b 5374 6174 652c 2069 6e74  t[TaskState, int
-0002e5d0: 5d20 3d20 6465 6661 756c 7464 6963 7428  ] = defaultdict(
-0002e5e0: 696e 7429 0a20 2020 2020 2020 2020 2020  int).           
-0002e5f0: 2066 6f72 2074 7320 696e 2077 732e 7072   for ts in ws.pr
-0002e600: 6f63 6573 7369 6e67 3a0a 2020 2020 2020  ocessing:.      
-0002e610: 2020 2020 2020 2020 2020 666f 7220 7473            for ts
-0002e620: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-0002e630: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
-0002e640: 2020 2020 2020 2020 2020 6966 2074 7373            if tss
-0002e650: 206e 6f74 2069 6e20 7773 2e68 6173 5f77   not in ws.has_w
-0002e660: 6861 743a 0a20 2020 2020 2020 2020 2020  hat:.           
-0002e670: 2020 2020 2020 2020 2020 2020 2061 6374               act
-0002e680: 7561 6c5f 6e65 6564 735f 7768 6174 5b74  ual_needs_what[t
-0002e690: 7373 5d20 2b3d 2031 0a20 2020 2020 2020  ss] += 1.       
-0002e6a0: 2020 2020 2061 7373 6572 7420 6163 7475       assert actu
-0002e6b0: 616c 5f6e 6565 6473 5f77 6861 7420 3d3d  al_needs_what ==
-0002e6c0: 2077 732e 6e65 6564 735f 7768 6174 0a20   ws.needs_what. 
-0002e6d0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0002e6e0: 7420 2877 732e 7374 6174 7573 203d 3d20  t (ws.status == 
-0002e6f0: 5374 6174 7573 2e72 756e 6e69 6e67 2920  Status.running) 
-0002e700: 3d3d 2028 7773 2069 6e20 7365 6c66 2e72  == (ws in self.r
-0002e710: 756e 6e69 6e67 290a 2020 2020 2020 2020  unning).        
-0002e720: 2020 2020 666f 7220 6e61 6d65 2c20 636f      for name, co
-0002e730: 756e 7420 696e 2077 732e 7461 736b 5f70  unt in ws.task_p
-0002e740: 7265 6669 785f 636f 756e 742e 6974 656d  refix_count.item
-0002e750: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-0002e760: 2020 2020 2074 6173 6b5f 7072 6566 6978       task_prefix
-0002e770: 5f63 6f75 6e74 735b 6e61 6d65 5d20 2b3d  _counts[name] +=
-0002e780: 2063 6f75 6e74 0a0a 2020 2020 2020 2020   count..        
-0002e790: 6173 7365 7274 2074 6173 6b5f 7072 6566  assert task_pref
-0002e7a0: 6978 5f63 6f75 6e74 732e 6b65 7973 2829  ix_counts.keys()
-0002e7b0: 203d 3d20 7365 6c66 2e5f 7461 736b 5f70   == self._task_p
-0002e7c0: 7265 6669 785f 636f 756e 745f 676c 6f62  refix_count_glob
-0002e7d0: 616c 2e6b 6579 7328 290a 2020 2020 2020  al.keys().      
-0002e7e0: 2020 666f 7220 6e61 6d65 2c20 676c 6f62    for name, glob
-0002e7f0: 616c 5f63 6f75 6e74 2069 6e20 7365 6c66  al_count in self
-0002e800: 2e5f 7461 736b 5f70 7265 6669 785f 636f  ._task_prefix_co
-0002e810: 756e 745f 676c 6f62 616c 2e69 7465 6d73  unt_global.items
-0002e820: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0002e830: 6173 7365 7274 2028 0a20 2020 2020 2020  assert (.       
-0002e840: 2020 2020 2020 2020 2074 6173 6b5f 7072           task_pr
-0002e850: 6566 6978 5f63 6f75 6e74 735b 6e61 6d65  efix_counts[name
-0002e860: 5d20 3d3d 2067 6c6f 6261 6c5f 636f 756e  ] == global_coun
-0002e870: 740a 2020 2020 2020 2020 2020 2020 292c  t.            ),
-0002e880: 2066 227b 6e61 6d65 7d3a 207b 7461 736b   f"{name}: {task
-0002e890: 5f70 7265 6669 785f 636f 756e 7473 5b6e  _prefix_counts[n
-0002e8a0: 616d 655d 7d20 2877 7373 292c 207b 676c  ame]} (wss), {gl
-0002e8b0: 6f62 616c 5f63 6f75 6e74 7d20 2867 6c6f  obal_count} (glo
-0002e8c0: 6261 6c29 220a 0a20 2020 2020 2020 2066  bal)"..        f
-0002e8d0: 6f72 2077 7320 696e 2073 656c 662e 7275  or ws in self.ru
-0002e8e0: 6e6e 696e 673a 0a20 2020 2020 2020 2020  nning:.         
-0002e8f0: 2020 2061 7373 6572 7420 7773 2e73 7461     assert ws.sta
-0002e900: 7475 7320 3d3d 2053 7461 7475 732e 7275  tus == Status.ru
-0002e910: 6e6e 696e 670a 2020 2020 2020 2020 2020  nning.          
-0002e920: 2020 6173 7365 7274 2077 732e 6164 6472    assert ws.addr
-0002e930: 6573 7320 696e 2073 656c 662e 776f 726b  ess in self.work
-0002e940: 6572 730a 0a20 2020 2020 2020 2066 6f72  ers..        for
-0002e950: 206b 2c20 7473 2069 6e20 7365 6c66 2e74   k, ts in self.t
-0002e960: 6173 6b73 2e69 7465 6d73 2829 3a0a 2020  asks.items():.  
-0002e970: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0002e980: 2069 7369 6e73 7461 6e63 6528 7473 2c20   isinstance(ts, 
-0002e990: 5461 736b 5374 6174 6529 2c20 2874 7970  TaskState), (typ
-0002e9a0: 6528 7473 292c 2074 7329 0a20 2020 2020  e(ts), ts).     
-0002e9b0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-0002e9c0: 2e6b 6579 203d 3d20 6b0a 2020 2020 2020  .key == k.      
-0002e9d0: 2020 2020 2020 6173 7365 7274 2062 6f6f        assert boo
-0002e9e0: 6c28 7473 2069 6e20 7365 6c66 2e72 6570  l(ts in self.rep
-0002e9f0: 6c69 6361 7465 645f 7461 736b 7329 203d  licated_tasks) =
-0002ea00: 3d20 286c 656e 2874 732e 7768 6f5f 6861  = (len(ts.who_ha
-0002ea10: 7329 203e 2031 290a 2020 2020 2020 2020  s) > 1).        
-0002ea20: 2020 2020 7365 6c66 2e76 616c 6964 6174      self.validat
-0002ea30: 655f 6b65 7928 6b2c 2074 7329 0a0a 2020  e_key(k, ts)..  
-0002ea40: 2020 2020 2020 666f 7220 7473 2069 6e20        for ts in 
-0002ea50: 7365 6c66 2e72 6570 6c69 6361 7465 645f  self.replicated_
-0002ea60: 7461 736b 733a 0a20 2020 2020 2020 2020  tasks:.         
-0002ea70: 2020 2061 7373 6572 7420 7473 2e73 7461     assert ts.sta
-0002ea80: 7465 203d 3d20 226d 656d 6f72 7922 0a20  te == "memory". 
-0002ea90: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0002eaa0: 7420 7473 2e6b 6579 2069 6e20 7365 6c66  t ts.key in self
-0002eab0: 2e74 6173 6b73 0a0a 2020 2020 2020 2020  .tasks..        
-0002eac0: 666f 7220 632c 2063 7320 696e 2073 656c  for c, cs in sel
-0002ead0: 662e 636c 6965 6e74 732e 6974 656d 7328  f.clients.items(
-0002eae0: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
-0002eaf0: 2063 6c69 656e 743d 4e6f 6e65 2069 7320   client=None is 
-0002eb00: 6f66 7465 6e20 7573 6564 2069 6e20 7465  often used in te
-0002eb10: 7374 732e 2e2e 0a20 2020 2020 2020 2020  sts....         
-0002eb20: 2020 2061 7373 6572 7420 6320 6973 204e     assert c is N
-0002eb30: 6f6e 6520 6f72 2074 7970 6528 6329 203d  one or type(c) =
-0002eb40: 3d20 7374 722c 2028 7479 7065 2863 292c  = str, (type(c),
-0002eb50: 2063 290a 2020 2020 2020 2020 2020 2020   c).            
-0002eb60: 6173 7365 7274 2074 7970 6528 6373 2920  assert type(cs) 
-0002eb70: 3d3d 2043 6c69 656e 7453 7461 7465 2c20  == ClientState, 
-0002eb80: 2874 7970 6528 6373 292c 2063 7329 0a20  (type(cs), cs). 
-0002eb90: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0002eba0: 7420 6373 2e63 6c69 656e 745f 6b65 7920  t cs.client_key 
-0002ebb0: 3d3d 2063 0a0a 2020 2020 2020 2020 6120  == c..        a 
-0002ebc0: 3d20 7b77 3a20 7773 2e6e 6279 7465 7320  = {w: ws.nbytes 
-0002ebd0: 666f 7220 772c 2077 7320 696e 2073 656c  for w, ws in sel
-0002ebe0: 662e 776f 726b 6572 732e 6974 656d 7328  f.workers.items(
-0002ebf0: 297d 0a20 2020 2020 2020 2062 203d 207b  )}.        b = {
-0002ec00: 0a20 2020 2020 2020 2020 2020 2077 3a20  .            w: 
-0002ec10: 7375 6d28 7473 2e67 6574 5f6e 6279 7465  sum(ts.get_nbyte
-0002ec20: 7328 2920 666f 7220 7473 2069 6e20 7773  s() for ts in ws
-0002ec30: 2e68 6173 5f77 6861 7429 0a20 2020 2020  .has_what).     
-0002ec40: 2020 2020 2020 2066 6f72 2077 2c20 7773         for w, ws
-0002ec50: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
-0002ec60: 2e69 7465 6d73 2829 0a20 2020 2020 2020  .items().       
-0002ec70: 207d 0a20 2020 2020 2020 2061 7373 6572   }.        asser
-0002ec80: 7420 6120 3d3d 2062 2c20 2861 2c20 6229  t a == b, (a, b)
-0002ec90: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-0002eca0: 662e 7472 616e 7369 7469 6f6e 5f63 6f75  f.transition_cou
-0002ecb0: 6e74 6572 5f6d 6178 3a0a 2020 2020 2020  nter_max:.      
-0002ecc0: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
-0002ecd0: 662e 7472 616e 7369 7469 6f6e 5f63 6f75  f.transition_cou
-0002ece0: 6e74 6572 203c 2073 656c 662e 7472 616e  nter < self.tran
-0002ecf0: 7369 7469 6f6e 5f63 6f75 6e74 6572 5f6d  sition_counter_m
-0002ed00: 6178 0a0a 2020 2020 2323 2323 2323 2323  ax..    ########
-0002ed10: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
-0002ed20: 2320 4d61 6e61 6765 204d 6573 7361 6765  # Manage Message
-0002ed30: 7320 230a 2020 2020 2323 2323 2323 2323  s #.    ########
-0002ed40: 2323 2323 2323 2323 2323 230a 0a20 2020  ###########..   
-0002ed50: 2064 6566 2072 6570 6f72 7428 0a20 2020   def report(.   
-0002ed60: 2020 2020 2073 656c 662c 206d 7367 3a20       self, msg: 
-0002ed70: 6469 6374 2c20 7473 3a20 5461 736b 5374  dict, ts: TaskSt
-0002ed80: 6174 6520 7c20 4e6f 6e65 203d 204e 6f6e  ate | None = Non
-0002ed90: 652c 2063 6c69 656e 743a 2073 7472 207c  e, client: str |
-0002eda0: 204e 6f6e 6520 3d20 4e6f 6e65 0a20 2020   None = None.   
-0002edb0: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
-0002edc0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0002edd0: 5075 626c 6973 6820 7570 6461 7465 7320  Publish updates 
-0002ede0: 746f 2061 6c6c 206c 6973 7465 6e69 6e67  to all listening
-0002edf0: 2051 7565 7565 7320 616e 6420 436f 6d6d   Queues and Comm
-0002ee00: 730a 0a20 2020 2020 2020 2049 6620 7468  s..        If th
-0002ee10: 6520 6d65 7373 6167 6520 636f 6e74 6169  e message contai
-0002ee20: 6e73 2061 206b 6579 2074 6865 6e20 7765  ns a key then we
-0002ee30: 206f 6e6c 7920 7365 6e64 2074 6865 206d   only send the m
-0002ee40: 6573 7361 6765 2074 6f20 7468 6f73 650a  essage to those.
-0002ee50: 2020 2020 2020 2020 636f 6d6d 7320 7468          comms th
-0002ee60: 6174 2063 6172 6520 6162 6f75 7420 7468  at care about th
-0002ee70: 6520 6b65 792e 0a20 2020 2020 2020 2022  e key..        "
-0002ee80: 2222 0a20 2020 2020 2020 2069 6620 7473  "".        if ts
-0002ee90: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0002eea0: 2020 2020 2020 6d73 675f 6b65 7920 3d20        msg_key = 
-0002eeb0: 6d73 672e 6765 7428 226b 6579 2229 0a20  msg.get("key"). 
-0002eec0: 2020 2020 2020 2020 2020 2069 6620 6d73             if ms
-0002eed0: 675f 6b65 7920 6973 206e 6f74 204e 6f6e  g_key is not Non
-0002eee0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0002eef0: 2020 2074 6173 6b73 3a20 6469 6374 203d     tasks: dict =
-0002ef00: 2073 656c 662e 7461 736b 730a 2020 2020   self.tasks.    
-0002ef10: 2020 2020 2020 2020 2020 2020 7473 203d              ts =
-0002ef20: 2074 6173 6b73 2e67 6574 286d 7367 5f6b   tasks.get(msg_k
-0002ef30: 6579 290a 0a20 2020 2020 2020 2063 6c69  ey)..        cli
-0002ef40: 656e 745f 636f 6d6d 733a 2064 6963 7420  ent_comms: dict 
-0002ef50: 3d20 7365 6c66 2e63 6c69 656e 745f 636f  = self.client_co
-0002ef60: 6d6d 730a 2020 2020 2020 2020 6966 2074  mms.        if t
-0002ef70: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
-0002ef80: 2020 2020 2020 2023 204e 6f74 6966 7920         # Notify 
-0002ef90: 616c 6c20 636c 6965 6e74 730a 2020 2020  all clients.    
-0002efa0: 2020 2020 2020 2020 636c 6965 6e74 5f6b          client_k
-0002efb0: 6579 7320 3d20 6c69 7374 2863 6c69 656e  eys = list(clien
-0002efc0: 745f 636f 6d6d 7329 0a20 2020 2020 2020  t_comms).       
-0002efd0: 2065 6c69 6620 636c 6965 6e74 2069 7320   elif client is 
-0002efe0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0002eff0: 2020 2320 4e6f 7469 6679 2063 6c69 656e    # Notify clien
-0002f000: 7473 2069 6e74 6572 6573 7465 6420 696e  ts interested in
-0002f010: 206b 6579 0a20 2020 2020 2020 2020 2020   key.           
-0002f020: 2063 6c69 656e 745f 6b65 7973 203d 205b   client_keys = [
-0002f030: 6373 2e63 6c69 656e 745f 6b65 7920 666f  cs.client_key fo
-0002f040: 7220 6373 2069 6e20 7473 2e77 686f 5f77  r cs in ts.who_w
-0002f050: 616e 7473 5d0a 2020 2020 2020 2020 656c  ants].        el
-0002f060: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0002f070: 2320 4e6f 7469 6679 2063 6c69 656e 7473  # Notify clients
-0002f080: 2069 6e74 6572 6573 7465 6420 696e 206b   interested in k
-0002f090: 6579 2028 696e 636c 7564 696e 6720 6063  ey (including `c
-0002f0a0: 6c69 656e 7460 290a 2020 2020 2020 2020  lient`).        
-0002f0b0: 2020 2020 636c 6965 6e74 5f6b 6579 7320      client_keys 
-0002f0c0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-0002f0d0: 2020 2020 6373 2e63 6c69 656e 745f 6b65      cs.client_ke
-0002f0e0: 7920 666f 7220 6373 2069 6e20 7473 2e77  y for cs in ts.w
-0002f0f0: 686f 5f77 616e 7473 2069 6620 6373 2e63  ho_wants if cs.c
-0002f100: 6c69 656e 745f 6b65 7920 213d 2063 6c69  lient_key != cli
-0002f110: 656e 740a 2020 2020 2020 2020 2020 2020  ent.            
-0002f120: 5d0a 2020 2020 2020 2020 2020 2020 636c  ].            cl
-0002f130: 6965 6e74 5f6b 6579 732e 6170 7065 6e64  ient_keys.append
-0002f140: 2863 6c69 656e 7429 0a0a 2020 2020 2020  (client)..      
-0002f150: 2020 6b3a 2073 7472 0a20 2020 2020 2020    k: str.       
-0002f160: 2066 6f72 206b 2069 6e20 636c 6965 6e74   for k in client
-0002f170: 5f6b 6579 733a 0a20 2020 2020 2020 2020  _keys:.         
-0002f180: 2020 2063 203d 2063 6c69 656e 745f 636f     c = client_co
-0002f190: 6d6d 732e 6765 7428 6b29 0a20 2020 2020  mms.get(k).     
-0002f1a0: 2020 2020 2020 2069 6620 6320 6973 204e         if c is N
-0002f1b0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0002f1c0: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
-0002f1d0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-0002f1e0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0002f1f0: 2e73 656e 6428 6d73 6729 0a20 2020 2020  .send(msg).     
-0002f200: 2020 2020 2020 2020 2020 2023 206c 6f67             # log
-0002f210: 6765 722e 6465 6275 6728 2253 6368 6564  ger.debug("Sched
-0002f220: 756c 6572 2073 656e 6473 206d 6573 7361  uler sends messa
-0002f230: 6765 2074 6f20 636c 6965 6e74 2025 7322  ge to client %s"
-0002f240: 2c20 6d73 6729 0a20 2020 2020 2020 2020  , msg).         
-0002f250: 2020 2065 7863 6570 7420 436f 6d6d 436c     except CommCl
-0002f260: 6f73 6564 4572 726f 723a 0a20 2020 2020  osedError:.     
-0002f270: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-0002f280: 6c66 2e73 7461 7475 7320 3d3d 2053 7461  lf.status == Sta
-0002f290: 7475 732e 7275 6e6e 696e 673a 0a20 2020  tus.running:.   
-0002f2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f2b0: 206c 6f67 6765 722e 6372 6974 6963 616c   logger.critical
-0002f2c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0002f2d0: 2020 2020 2020 2020 2020 2243 6c6f 7365            "Close
-0002f2e0: 6420 636f 6d6d 2025 7220 7768 696c 6520  d comm %r while 
-0002f2f0: 7472 7969 6e67 2074 6f20 7772 6974 6520  trying to write 
-0002f300: 2573 222c 2063 2c20 6d73 672c 2065 7863  %s", c, msg, exc
-0002f310: 5f69 6e66 6f3d 5472 7565 0a20 2020 2020  _info=True.     
-0002f320: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0002f330: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-0002f340: 6164 645f 636c 6965 6e74 280a 2020 2020  add_client(.    
-0002f350: 2020 2020 7365 6c66 2c20 636f 6d6d 3a20      self, comm: 
-0002f360: 436f 6d6d 2c20 636c 6965 6e74 3a20 7374  Comm, client: st
-0002f370: 722c 2076 6572 7369 6f6e 733a 2064 6963  r, versions: dic
-0002f380: 745b 7374 722c 2041 6e79 5d0a 2020 2020  t[str, Any].    
-0002f390: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0002f3a0: 2020 2022 2222 4164 6420 636c 6965 6e74     """Add client
-0002f3b0: 2074 6f20 6e65 7477 6f72 6b0a 0a20 2020   to network..   
-0002f3c0: 2020 2020 2057 6520 6c69 7374 656e 2074       We listen t
-0002f3d0: 6f20 616c 6c20 6675 7475 7265 206d 6573  o all future mes
-0002f3e0: 7361 6765 7320 6672 6f6d 2074 6869 7320  sages from this 
-0002f3f0: 436f 6d6d 2e0a 2020 2020 2020 2020 2222  Comm..        ""
-0002f400: 220a 2020 2020 2020 2020 6173 7365 7274  ".        assert
-0002f410: 2063 6c69 656e 7420 6973 206e 6f74 204e   client is not N
-0002f420: 6f6e 650a 2020 2020 2020 2020 636f 6d6d  one.        comm
-0002f430: 2e6e 616d 6520 3d20 2253 6368 6564 756c  .name = "Schedul
-0002f440: 6572 2d3e 436c 6965 6e74 220a 2020 2020  er->Client".    
-0002f450: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
-0002f460: 2252 6563 6569 7665 2063 6c69 656e 7420  "Receive client 
-0002f470: 636f 6e6e 6563 7469 6f6e 3a20 2573 222c  connection: %s",
-0002f480: 2063 6c69 656e 7429 0a20 2020 2020 2020   client).       
-0002f490: 2073 656c 662e 6c6f 675f 6576 656e 7428   self.log_event(
-0002f4a0: 5b22 616c 6c22 2c20 636c 6965 6e74 5d2c  ["all", client],
-0002f4b0: 207b 2261 6374 696f 6e22 3a20 2261 6464   {"action": "add
-0002f4c0: 2d63 6c69 656e 7422 2c20 2263 6c69 656e  -client", "clien
-0002f4d0: 7422 3a20 636c 6965 6e74 7d29 0a20 2020  t": client}).   
-0002f4e0: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
-0002f4f0: 735b 636c 6965 6e74 5d20 3d20 436c 6965  s[client] = Clie
-0002f500: 6e74 5374 6174 6528 636c 6965 6e74 2c20  ntState(client, 
-0002f510: 7665 7273 696f 6e73 3d76 6572 7369 6f6e  versions=version
-0002f520: 7329 0a0a 2020 2020 2020 2020 666f 7220  s)..        for 
-0002f530: 706c 7567 696e 2069 6e20 6c69 7374 2873  plugin in list(s
-0002f540: 656c 662e 706c 7567 696e 732e 7661 6c75  elf.plugins.valu
-0002f550: 6573 2829 293a 0a20 2020 2020 2020 2020  es()):.         
-0002f560: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0002f570: 2020 2020 2020 2020 706c 7567 696e 2e61          plugin.a
-0002f580: 6464 5f63 6c69 656e 7428 7363 6865 6475  dd_client(schedu
-0002f590: 6c65 723d 7365 6c66 2c20 636c 6965 6e74  ler=self, client
-0002f5a0: 3d63 6c69 656e 7429 0a20 2020 2020 2020  =client).       
-0002f5b0: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
-0002f5c0: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
-0002f5d0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-0002f5e0: 6572 2e65 7863 6570 7469 6f6e 2865 290a  er.exception(e).
-0002f5f0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-0002f600: 2020 2020 2020 2020 2020 6263 6f6d 6d20            bcomm 
-0002f610: 3d20 4261 7463 6865 6453 656e 6428 696e  = BatchedSend(in
-0002f620: 7465 7276 616c 3d22 326d 7322 2c20 6c6f  terval="2ms", lo
-0002f630: 6f70 3d73 656c 662e 6c6f 6f70 290a 2020  op=self.loop).  
-0002f640: 2020 2020 2020 2020 2020 6263 6f6d 6d2e            bcomm.
-0002f650: 7374 6172 7428 636f 6d6d 290a 2020 2020  start(comm).    
-0002f660: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
-0002f670: 656e 745f 636f 6d6d 735b 636c 6965 6e74  ent_comms[client
-0002f680: 5d20 3d20 6263 6f6d 6d0a 2020 2020 2020  ] = bcomm.      
-0002f690: 2020 2020 2020 6d73 6720 3d20 7b22 6f70        msg = {"op
-0002f6a0: 223a 2022 7374 7265 616d 2d73 7461 7274  ": "stream-start
-0002f6b0: 227d 0a20 2020 2020 2020 2020 2020 2076  "}.            v
-0002f6c0: 6572 7369 6f6e 5f77 6172 6e69 6e67 203d  ersion_warning =
-0002f6d0: 2076 6572 7369 6f6e 5f6d 6f64 756c 652e   version_module.
-0002f6e0: 6572 726f 725f 6d65 7373 6167 6528 0a20  error_message(. 
-0002f6f0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-0002f700: 6572 7369 6f6e 5f6d 6f64 756c 652e 6765  ersion_module.ge
-0002f710: 745f 7665 7273 696f 6e73 2829 2c0a 2020  t_versions(),.  
-0002f720: 2020 2020 2020 2020 2020 2020 2020 7b77                {w
-0002f730: 3a20 7773 2e76 6572 7369 6f6e 7320 666f  : ws.versions fo
-0002f740: 7220 772c 2077 7320 696e 2073 656c 662e  r w, ws in self.
-0002f750: 776f 726b 6572 732e 6974 656d 7328 297d  workers.items()}
-0002f760: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002f770: 2020 7665 7273 696f 6e73 2c0a 2020 2020    versions,.    
-0002f780: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0002f790: 2020 2020 2020 6d73 672e 7570 6461 7465        msg.update
-0002f7a0: 2876 6572 7369 6f6e 5f77 6172 6e69 6e67  (version_warning
-0002f7b0: 290a 2020 2020 2020 2020 2020 2020 6263  ).            bc
-0002f7c0: 6f6d 6d2e 7365 6e64 286d 7367 290a 0a20  omm.send(msg).. 
-0002f7d0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0002f7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f7f0: 6177 6169 7420 7365 6c66 2e68 616e 646c  await self.handl
-0002f800: 655f 7374 7265 616d 2863 6f6d 6d3d 636f  e_stream(comm=co
-0002f810: 6d6d 2c20 6578 7472 613d 7b22 636c 6965  mm, extra={"clie
-0002f820: 6e74 223a 2063 6c69 656e 747d 290a 2020  nt": client}).  
-0002f830: 2020 2020 2020 2020 2020 6669 6e61 6c6c            finall
-0002f840: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-0002f850: 2020 2073 656c 662e 7265 6d6f 7665 5f63     self.remove_c
-0002f860: 6c69 656e 7428 636c 6965 6e74 3d63 6c69  lient(client=cli
-0002f870: 656e 742c 2073 7469 6d75 6c75 735f 6964  ent, stimulus_id
-0002f880: 3d66 2272 656d 6f76 652d 636c 6965 6e74  =f"remove-client
-0002f890: 2d7b 7469 6d65 2829 7d22 290a 2020 2020  -{time()}").    
-0002f8a0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-0002f8b0: 6572 2e64 6562 7567 2822 4669 6e69 7368  er.debug("Finish
-0002f8c0: 6564 2068 616e 646c 696e 6720 636c 6965  ed handling clie
-0002f8d0: 6e74 2025 7322 2c20 636c 6965 6e74 290a  nt %s", client).
-0002f8e0: 2020 2020 2020 2020 6669 6e61 6c6c 793a          finally:
-0002f8f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0002f900: 6e6f 7420 636f 6d6d 2e63 6c6f 7365 6428  not comm.closed(
-0002f910: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0002f920: 2020 2073 656c 662e 636c 6965 6e74 5f63     self.client_c
-0002f930: 6f6d 6d73 5b63 6c69 656e 745d 2e73 656e  omms[client].sen
-0002f940: 6428 7b22 6f70 223a 2022 7374 7265 616d  d({"op": "stream
-0002f950: 2d63 6c6f 7365 6422 7d29 0a20 2020 2020  -closed"}).     
-0002f960: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0002f970: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0002f980: 6f74 2073 7973 2e69 735f 6669 6e61 6c69  ot sys.is_finali
-0002f990: 7a69 6e67 2829 3a0a 2020 2020 2020 2020  zing():.        
-0002f9a0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-0002f9b0: 7420 7365 6c66 2e63 6c69 656e 745f 636f  t self.client_co
-0002f9c0: 6d6d 735b 636c 6965 6e74 5d2e 636c 6f73  mms[client].clos
-0002f9d0: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
-0002f9e0: 2020 2020 2020 2020 6465 6c20 7365 6c66          del self
-0002f9f0: 2e63 6c69 656e 745f 636f 6d6d 735b 636c  .client_comms[cl
-0002fa00: 6965 6e74 5d0a 2020 2020 2020 2020 2020  ient].          
-0002fa10: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-0002fa20: 662e 7374 6174 7573 203d 3d20 5374 6174  f.status == Stat
-0002fa30: 7573 2e72 756e 6e69 6e67 3a0a 2020 2020  us.running:.    
-0002fa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fa50: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
-0002fa60: 2243 6c6f 7365 2063 6c69 656e 7420 636f  "Close client co
-0002fa70: 6e6e 6563 7469 6f6e 3a20 2573 222c 2063  nnection: %s", c
-0002fa80: 6c69 656e 7429 0a20 2020 2020 2020 2020  lient).         
-0002fa90: 2020 2065 7863 6570 7420 5479 7065 4572     except TypeEr
-0002faa0: 726f 723a 2020 2320 636f 6d6d 2062 6563  ror:  # comm bec
-0002fab0: 6f6d 6573 204e 6f6e 6520 6475 7269 6e67  omes None during
-0002fac0: 2047 430a 2020 2020 2020 2020 2020 2020   GC.            
-0002fad0: 2020 2020 7061 7373 0a0a 2020 2020 6465      pass..    de
-0002fae0: 6620 7265 6d6f 7665 5f63 6c69 656e 7428  f remove_client(
-0002faf0: 7365 6c66 2c20 636c 6965 6e74 3a20 7374  self, client: st
-0002fb00: 722c 2073 7469 6d75 6c75 735f 6964 3a20  r, stimulus_id: 
-0002fb10: 7374 7220 7c20 4e6f 6e65 203d 204e 6f6e  str | None = Non
-0002fb20: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
-0002fb30: 2020 2020 2222 2252 656d 6f76 6520 636c      """Remove cl
-0002fb40: 6965 6e74 2066 726f 6d20 6e65 7477 6f72  ient from networ
-0002fb50: 6b22 2222 0a20 2020 2020 2020 2073 7469  k""".        sti
-0002fb60: 6d75 6c75 735f 6964 203d 2073 7469 6d75  mulus_id = stimu
-0002fb70: 6c75 735f 6964 206f 7220 6622 7265 6d6f  lus_id or f"remo
-0002fb80: 7665 2d63 6c69 656e 742d 7b74 696d 6528  ve-client-{time(
-0002fb90: 297d 220a 2020 2020 2020 2020 6966 2073  )}".        if s
-0002fba0: 656c 662e 7374 6174 7573 203d 3d20 5374  elf.status == St
-0002fbb0: 6174 7573 2e72 756e 6e69 6e67 3a0a 2020  atus.running:.  
-0002fbc0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-0002fbd0: 2e69 6e66 6f28 2252 656d 6f76 6520 636c  .info("Remove cl
-0002fbe0: 6965 6e74 2025 7322 2c20 636c 6965 6e74  ient %s", client
-0002fbf0: 290a 2020 2020 2020 2020 7365 6c66 2e6c  ).        self.l
-0002fc00: 6f67 5f65 7665 6e74 285b 2261 6c6c 222c  og_event(["all",
-0002fc10: 2063 6c69 656e 745d 2c20 7b22 6163 7469   client], {"acti
-0002fc20: 6f6e 223a 2022 7265 6d6f 7665 2d63 6c69  on": "remove-cli
-0002fc30: 656e 7422 2c20 2263 6c69 656e 7422 3a20  ent", "client": 
-0002fc40: 636c 6965 6e74 7d29 0a20 2020 2020 2020  client}).       
-0002fc50: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0002fc60: 2020 6373 3a20 436c 6965 6e74 5374 6174    cs: ClientStat
-0002fc70: 6520 3d20 7365 6c66 2e63 6c69 656e 7473  e = self.clients
-0002fc80: 5b63 6c69 656e 745d 0a20 2020 2020 2020  [client].       
-0002fc90: 2065 7863 6570 7420 4b65 7945 7272 6f72   except KeyError
-0002fca0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0002fcb0: 5858 5820 6973 2074 6869 7320 6120 6c65  XXX is this a le
-0002fcc0: 6769 7469 6d61 7465 2063 6f6e 6469 7469  gitimate conditi
-0002fcd0: 6f6e 3f0a 2020 2020 2020 2020 2020 2020  on?.            
-0002fce0: 7061 7373 0a20 2020 2020 2020 2065 6c73  pass.        els
-0002fcf0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-0002fd00: 656c 662e 636c 6965 6e74 5f72 656c 6561  elf.client_relea
-0002fd10: 7365 735f 6b65 7973 280a 2020 2020 2020  ses_keys(.      
-0002fd20: 2020 2020 2020 2020 2020 6b65 7973 3d5b            keys=[
-0002fd30: 7473 2e6b 6579 2066 6f72 2074 7320 696e  ts.key for ts in
-0002fd40: 2063 732e 7761 6e74 735f 7768 6174 5d2c   cs.wants_what],
-0002fd50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002fd60: 2063 6c69 656e 743d 6373 2e63 6c69 656e   client=cs.clien
-0002fd70: 745f 6b65 792c 0a20 2020 2020 2020 2020  t_key,.         
-0002fd80: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
-0002fd90: 6964 3d73 7469 6d75 6c75 735f 6964 2c0a  id=stimulus_id,.
-0002fda0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0002fdb0: 2020 2020 2020 2020 2020 6465 6c20 7365            del se
-0002fdc0: 6c66 2e63 6c69 656e 7473 5b63 6c69 656e  lf.clients[clien
-0002fdd0: 745d 0a0a 2020 2020 2020 2020 2020 2020  t]..            
-0002fde0: 666f 7220 706c 7567 696e 2069 6e20 6c69  for plugin in li
-0002fdf0: 7374 2873 656c 662e 706c 7567 696e 732e  st(self.plugins.
-0002fe00: 7661 6c75 6573 2829 293a 0a20 2020 2020  values()):.     
-0002fe10: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0002fe20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fe30: 2020 2020 706c 7567 696e 2e72 656d 6f76      plugin.remov
-0002fe40: 655f 636c 6965 6e74 2873 6368 6564 756c  e_client(schedul
-0002fe50: 6572 3d73 656c 662c 2063 6c69 656e 743d  er=self, client=
-0002fe60: 636c 6965 6e74 290a 2020 2020 2020 2020  client).        
-0002fe70: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-0002fe80: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
-0002fe90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fea0: 2020 206c 6f67 6765 722e 6578 6365 7074     logger.except
-0002feb0: 696f 6e28 6529 0a0a 2020 2020 2020 2020  ion(e)..        
-0002fec0: 6173 796e 6320 6465 6620 7265 6d6f 7665  async def remove
-0002fed0: 5f63 6c69 656e 745f 6672 6f6d 5f65 7665  _client_from_eve
-0002fee0: 6e74 7328 293a 0a20 2020 2020 2020 2020  nts():.         
-0002fef0: 2020 2023 2049 6620 7468 6520 636c 6965     # If the clie
-0002ff00: 6e74 2069 736e 2774 2072 6567 6973 7465  nt isn't registe
-0002ff10: 7265 6420 616e 796d 6f72 6520 6166 7465  red anymore afte
-0002ff20: 7220 7468 6520 6465 6c61 792c 2072 656d  r the delay, rem
-0002ff30: 6f76 6520 6672 6f6d 2065 7665 6e74 730a  ove from events.
-0002ff40: 2020 2020 2020 2020 2020 2020 6966 2063              if c
-0002ff50: 6c69 656e 7420 6e6f 7420 696e 2073 656c  lient not in sel
-0002ff60: 662e 636c 6965 6e74 7320 616e 6420 636c  f.clients and cl
-0002ff70: 6965 6e74 2069 6e20 7365 6c66 2e65 7665  ient in self.eve
-0002ff80: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
-0002ff90: 2020 2020 2064 656c 2073 656c 662e 6576       del self.ev
-0002ffa0: 656e 7473 5b63 6c69 656e 745d 0a0a 2020  ents[client]..  
-0002ffb0: 2020 2020 2020 636c 6561 6e75 705f 6465        cleanup_de
-0002ffc0: 6c61 7920 3d20 7061 7273 655f 7469 6d65  lay = parse_time
-0002ffd0: 6465 6c74 6128 0a20 2020 2020 2020 2020  delta(.         
-0002ffe0: 2020 2064 6173 6b2e 636f 6e66 6967 2e67     dask.config.g
-0002fff0: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
-00030000: 7363 6865 6475 6c65 722e 6576 656e 7473  scheduler.events
-00030010: 2d63 6c65 616e 7570 2d64 656c 6179 2229  -cleanup-delay")
-00030020: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00030030: 2020 2069 6620 6e6f 7420 7365 6c66 2e5f     if not self._
-00030040: 6f6e 676f 696e 675f 6261 636b 6772 6f75  ongoing_backgrou
-00030050: 6e64 5f74 6173 6b73 2e63 6c6f 7365 643a  nd_tasks.closed:
-00030060: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00030070: 662e 5f6f 6e67 6f69 6e67 5f62 6163 6b67  f._ongoing_backg
-00030080: 726f 756e 645f 7461 736b 732e 6361 6c6c  round_tasks.call
-00030090: 5f6c 6174 6572 280a 2020 2020 2020 2020  _later(.        
-000300a0: 2020 2020 2020 2020 636c 6561 6e75 705f          cleanup_
-000300b0: 6465 6c61 792c 2072 656d 6f76 655f 636c  delay, remove_cl
-000300c0: 6965 6e74 5f66 726f 6d5f 6576 656e 7473  ient_from_events
-000300d0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-000300e0: 2020 2020 6465 6620 7365 6e64 5f74 6173      def send_tas
-000300f0: 6b5f 746f 5f77 6f72 6b65 7228 0a20 2020  k_to_worker(.   
-00030100: 2020 2020 2073 656c 662c 2077 6f72 6b65       self, worke
-00030110: 723a 2073 7472 2c20 7473 3a20 5461 736b  r: str, ts: Task
-00030120: 5374 6174 652c 2064 7572 6174 696f 6e3a  State, duration:
-00030130: 2066 6c6f 6174 203d 202d 310a 2020 2020   float = -1.    
-00030140: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00030150: 2020 2022 2222 5365 6e64 2061 2073 696e     """Send a sin
-00030160: 676c 6520 636f 6d70 7574 6174 696f 6e61  gle computationa
-00030170: 6c20 7461 736b 2074 6f20 6120 776f 726b  l task to a work
-00030180: 6572 2222 220a 2020 2020 2020 2020 7472  er""".        tr
-00030190: 793a 0a20 2020 2020 2020 2020 2020 206d  y:.            m
-000301a0: 7367 3a20 6469 6374 203d 2073 656c 662e  sg: dict = self.
-000301b0: 5f74 6173 6b5f 746f 5f6d 7367 2874 732c  _task_to_msg(ts,
-000301c0: 2064 7572 6174 696f 6e29 0a20 2020 2020   duration).     
-000301d0: 2020 2020 2020 2073 656c 662e 776f 726b         self.work
-000301e0: 6572 5f73 656e 6428 776f 726b 6572 2c20  er_send(worker, 
-000301f0: 6d73 6729 0a20 2020 2020 2020 2065 7863  msg).        exc
-00030200: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
-00030210: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-00030220: 6c6f 6767 6572 2e65 7863 6570 7469 6f6e  logger.exception
-00030230: 2865 290a 2020 2020 2020 2020 2020 2020  (e).            
-00030240: 6966 204c 4f47 5f50 4442 3a0a 2020 2020  if LOG_PDB:.    
-00030250: 2020 2020 2020 2020 2020 2020 696d 706f              impo
-00030260: 7274 2070 6462 0a0a 2020 2020 2020 2020  rt pdb..        
-00030270: 2020 2020 2020 2020 7064 622e 7365 745f          pdb.set_
-00030280: 7472 6163 6528 290a 2020 2020 2020 2020  trace().        
-00030290: 2020 2020 7261 6973 650a 0a20 2020 2064      raise..    d
-000302a0: 6566 2068 616e 646c 655f 756e 6361 7567  ef handle_uncaug
-000302b0: 6874 5f65 7272 6f72 2873 656c 662c 202a  ht_error(self, *
-000302c0: 2a6d 7367 3a20 416e 7929 202d 3e20 4e6f  *msg: Any) -> No
-000302d0: 6e65 3a0a 2020 2020 2020 2020 6c6f 6767  ne:.        logg
-000302e0: 6572 2e65 7863 6570 7469 6f6e 2863 6c65  er.exception(cle
-000302f0: 616e 5f65 7863 6570 7469 6f6e 282a 2a6d  an_exception(**m
-00030300: 7367 295b 315d 290a 0a20 2020 2064 6566  sg)[1])..    def
-00030310: 2068 616e 646c 655f 7461 736b 5f66 696e   handle_task_fin
-00030320: 6973 6865 6428 0a20 2020 2020 2020 2073  ished(.        s
-00030330: 656c 662c 206b 6579 3a20 7374 722c 2077  elf, key: str, w
-00030340: 6f72 6b65 723a 2073 7472 2c20 7374 696d  orker: str, stim
-00030350: 756c 7573 5f69 643a 2073 7472 2c20 2a2a  ulus_id: str, **
-00030360: 6d73 673a 2041 6e79 0a20 2020 2029 202d  msg: Any.    ) -
-00030370: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00030380: 6966 2077 6f72 6b65 7220 6e6f 7420 696e  if worker not in
-00030390: 2073 656c 662e 776f 726b 6572 733a 0a20   self.workers:. 
-000303a0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000303b0: 6e0a 2020 2020 2020 2020 7661 6c69 6461  n.        valida
-000303c0: 7465 5f6b 6579 286b 6579 290a 0a20 2020  te_key(key)..   
-000303d0: 2020 2020 2072 3a20 7475 706c 6520 3d20       r: tuple = 
-000303e0: 7365 6c66 2e73 7469 6d75 6c75 735f 7461  self.stimulus_ta
-000303f0: 736b 5f66 696e 6973 6865 6428 0a20 2020  sk_finished(.   
-00030400: 2020 2020 2020 2020 206b 6579 3d6b 6579           key=key
-00030410: 2c20 776f 726b 6572 3d77 6f72 6b65 722c  , worker=worker,
-00030420: 2073 7469 6d75 6c75 735f 6964 3d73 7469   stimulus_id=sti
-00030430: 6d75 6c75 735f 6964 2c20 2a2a 6d73 670a  mulus_id, **msg.
-00030440: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00030450: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-00030460: 732c 2063 6c69 656e 745f 6d73 6773 2c20  s, client_msgs, 
-00030470: 776f 726b 6572 5f6d 7367 7320 3d20 720a  worker_msgs = r.
-00030480: 2020 2020 2020 2020 7365 6c66 2e5f 7472          self._tr
-00030490: 616e 7369 7469 6f6e 7328 7265 636f 6d6d  ansitions(recomm
-000304a0: 656e 6461 7469 6f6e 732c 2063 6c69 656e  endations, clien
-000304b0: 745f 6d73 6773 2c20 776f 726b 6572 5f6d  t_msgs, worker_m
-000304c0: 7367 732c 2073 7469 6d75 6c75 735f 6964  sgs, stimulus_id
-000304d0: 290a 2020 2020 2020 2020 7365 6c66 2e73  ).        self.s
-000304e0: 656e 645f 616c 6c28 636c 6965 6e74 5f6d  end_all(client_m
-000304f0: 7367 732c 2077 6f72 6b65 725f 6d73 6773  sgs, worker_msgs
-00030500: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00030510: 7374 696d 756c 7573 5f71 7565 7565 5f73  stimulus_queue_s
-00030520: 6c6f 7473 5f6d 6179 6265 5f6f 7065 6e65  lots_maybe_opene
-00030530: 6428 7374 696d 756c 7573 5f69 643d 7374  d(stimulus_id=st
-00030540: 696d 756c 7573 5f69 6429 0a0a 2020 2020  imulus_id)..    
-00030550: 6465 6620 6861 6e64 6c65 5f74 6173 6b5f  def handle_task_
-00030560: 6572 7265 6428 7365 6c66 2c20 6b65 793a  erred(self, key:
-00030570: 2073 7472 2c20 7374 696d 756c 7573 5f69   str, stimulus_i
-00030580: 643a 2073 7472 2c20 2a2a 6d73 673a 2041  d: str, **msg: A
-00030590: 6e79 2920 2d3e 204e 6f6e 653a 0a20 2020  ny) -> None:.   
-000305a0: 2020 2020 2072 3a20 7475 706c 6520 3d20       r: tuple = 
-000305b0: 7365 6c66 2e73 7469 6d75 6c75 735f 7461  self.stimulus_ta
-000305c0: 736b 5f65 7272 6564 286b 6579 3d6b 6579  sk_erred(key=key
-000305d0: 2c20 7374 696d 756c 7573 5f69 643d 7374  , stimulus_id=st
-000305e0: 696d 756c 7573 5f69 642c 202a 2a6d 7367  imulus_id, **msg
-000305f0: 290a 2020 2020 2020 2020 7265 636f 6d6d  ).        recomm
-00030600: 656e 6461 7469 6f6e 732c 2063 6c69 656e  endations, clien
-00030610: 745f 6d73 6773 2c20 776f 726b 6572 5f6d  t_msgs, worker_m
-00030620: 7367 7320 3d20 720a 2020 2020 2020 2020  sgs = r.        
-00030630: 7365 6c66 2e5f 7472 616e 7369 7469 6f6e  self._transition
-00030640: 7328 7265 636f 6d6d 656e 6461 7469 6f6e  s(recommendation
-00030650: 732c 2063 6c69 656e 745f 6d73 6773 2c20  s, client_msgs, 
-00030660: 776f 726b 6572 5f6d 7367 732c 2073 7469  worker_msgs, sti
-00030670: 6d75 6c75 735f 6964 290a 2020 2020 2020  mulus_id).      
-00030680: 2020 7365 6c66 2e73 656e 645f 616c 6c28    self.send_all(
-00030690: 636c 6965 6e74 5f6d 7367 732c 2077 6f72  client_msgs, wor
-000306a0: 6b65 725f 6d73 6773 290a 0a20 2020 2020  ker_msgs)..     
-000306b0: 2020 2073 656c 662e 7374 696d 756c 7573     self.stimulus
-000306c0: 5f71 7565 7565 5f73 6c6f 7473 5f6d 6179  _queue_slots_may
-000306d0: 6265 5f6f 7065 6e65 6428 7374 696d 756c  be_opened(stimul
-000306e0: 7573 5f69 643d 7374 696d 756c 7573 5f69  us_id=stimulus_i
-000306f0: 6429 0a0a 2020 2020 6465 6620 7265 6c65  d)..    def rele
-00030700: 6173 655f 776f 726b 6572 5f64 6174 6128  ase_worker_data(
-00030710: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
-00030720: 776f 726b 6572 3a20 7374 722c 2073 7469  worker: str, sti
-00030730: 6d75 6c75 735f 6964 3a20 7374 7229 202d  mulus_id: str) -
-00030740: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00030750: 7473 203d 2073 656c 662e 7461 736b 732e  ts = self.tasks.
-00030760: 6765 7428 6b65 7929 0a20 2020 2020 2020  get(key).       
-00030770: 2077 7320 3d20 7365 6c66 2e77 6f72 6b65   ws = self.worke
-00030780: 7273 2e67 6574 2877 6f72 6b65 7229 0a20  rs.get(worker). 
-00030790: 2020 2020 2020 2069 6620 6e6f 7420 7473         if not ts
-000307a0: 206f 7220 6e6f 7420 7773 206f 7220 7773   or not ws or ws
-000307b0: 206e 6f74 2069 6e20 7473 2e77 686f 5f68   not in ts.who_h
-000307c0: 6173 3a0a 2020 2020 2020 2020 2020 2020  as:.            
-000307d0: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
-000307e0: 7365 6c66 2e72 656d 6f76 655f 7265 706c  self.remove_repl
-000307f0: 6963 6128 7473 2c20 7773 290a 2020 2020  ica(ts, ws).    
-00030800: 2020 2020 6966 206e 6f74 2074 732e 7768      if not ts.wh
-00030810: 6f5f 6861 733a 0a20 2020 2020 2020 2020  o_has:.         
-00030820: 2020 2073 656c 662e 7472 616e 7369 7469     self.transiti
-00030830: 6f6e 7328 7b6b 6579 3a20 2272 656c 6561  ons({key: "relea
-00030840: 7365 6422 7d2c 2073 7469 6d75 6c75 735f  sed"}, stimulus_
-00030850: 6964 290a 0a20 2020 2064 6566 2068 616e  id)..    def han
-00030860: 646c 655f 6c6f 6e67 5f72 756e 6e69 6e67  dle_long_running
-00030870: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
-00030880: 6b65 793a 2073 7472 2c20 776f 726b 6572  key: str, worker
-00030890: 3a20 7374 722c 2063 6f6d 7075 7465 5f64  : str, compute_d
-000308a0: 7572 6174 696f 6e3a 2066 6c6f 6174 207c  uration: float |
-000308b0: 204e 6f6e 652c 2073 7469 6d75 6c75 735f   None, stimulus_
-000308c0: 6964 3a20 7374 720a 2020 2020 2920 2d3e  id: str.    ) ->
-000308d0: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-000308e0: 2222 4120 7461 736b 2068 6173 2073 6563  ""A task has sec
-000308f0: 6564 6564 2066 726f 6d20 7468 6520 7468  eded from the th
-00030900: 7265 6164 2070 6f6f 6c0a 0a20 2020 2020  read pool..     
-00030910: 2020 2057 6520 7374 6f70 2074 6865 2074     We stop the t
-00030920: 6173 6b20 6672 6f6d 2062 6569 6e67 2073  ask from being s
-00030930: 746f 6c65 6e20 696e 2074 6865 2066 7574  tolen in the fut
-00030940: 7572 652c 2061 6e64 2063 6861 6e67 6520  ure, and change 
-00030950: 7461 736b 0a20 2020 2020 2020 2064 7572  task.        dur
-00030960: 6174 696f 6e20 6163 636f 756e 7469 6e67  ation accounting
-00030970: 2061 7320 6966 2074 6865 2074 6173 6b20   as if the task 
-00030980: 6861 7320 7374 6f70 7065 642e 0a20 2020  has stopped..   
-00030990: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-000309a0: 2069 6620 6b65 7920 6e6f 7420 696e 2073   if key not in s
-000309b0: 656c 662e 7461 736b 733a 0a20 2020 2020  elf.tasks:.     
-000309c0: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
-000309d0: 6275 6728 2253 6b69 7070 696e 6720 6c6f  bug("Skipping lo
-000309e0: 6e67 5f72 756e 6e69 6e67 2073 696e 6365  ng_running since
-000309f0: 206b 6579 2025 7320 7761 7320 616c 7265   key %s was alre
-00030a00: 6164 7920 7265 6c65 6173 6564 222c 206b  ady released", k
-00030a10: 6579 290a 2020 2020 2020 2020 2020 2020  ey).            
-00030a20: 7265 7475 726e 0a20 2020 2020 2020 2074  return.        t
-00030a30: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
-00030a40: 6579 5d0a 2020 2020 2020 2020 7374 6561  ey].        stea
-00030a50: 6c20 3d20 7365 6c66 2e65 7874 656e 7369  l = self.extensi
-00030a60: 6f6e 732e 6765 7428 2273 7465 616c 696e  ons.get("stealin
-00030a70: 6722 290a 2020 2020 2020 2020 6966 2073  g").        if s
-00030a80: 7465 616c 2069 7320 6e6f 7420 4e6f 6e65  teal is not None
-00030a90: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
-00030aa0: 6561 6c2e 7265 6d6f 7665 5f6b 6579 5f66  eal.remove_key_f
-00030ab0: 726f 6d5f 7374 6561 6c61 626c 6528 7473  rom_stealable(ts
-00030ac0: 290a 0a20 2020 2020 2020 2077 7320 3d20  )..        ws = 
-00030ad0: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-00030ae0: 0a20 2020 2020 2020 2069 6620 7773 2069  .        if ws i
-00030af0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00030b00: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
-00030b10: 2822 5265 6365 6976 6564 206c 6f6e 672d  ("Received long-
-00030b20: 7275 6e6e 696e 6720 7369 676e 616c 2066  running signal f
-00030b30: 726f 6d20 6475 706c 6963 6174 6520 7461  rom duplicate ta
-00030b40: 736b 2e20 4967 6e6f 7269 6e67 2e22 290a  sk. Ignoring.").
-00030b50: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00030b60: 726e 0a0a 2020 2020 2020 2020 6966 2063  rn..        if c
-00030b70: 6f6d 7075 7465 5f64 7572 6174 696f 6e20  ompute_duration 
-00030b80: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00030b90: 2020 2020 2020 2020 206f 6c64 5f64 7572           old_dur
-00030ba0: 6174 696f 6e20 3d20 7473 2e70 7265 6669  ation = ts.prefi
-00030bb0: 782e 6475 7261 7469 6f6e 5f61 7665 7261  x.duration_avera
-00030bc0: 6765 0a20 2020 2020 2020 2020 2020 2069  ge.            i
-00030bd0: 6620 6f6c 645f 6475 7261 7469 6f6e 203c  f old_duration <
-00030be0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00030bf0: 2020 2020 7473 2e70 7265 6669 782e 6475      ts.prefix.du
-00030c00: 7261 7469 6f6e 5f61 7665 7261 6765 203d  ration_average =
-00030c10: 2063 6f6d 7075 7465 5f64 7572 6174 696f   compute_duratio
-00030c20: 6e0a 2020 2020 2020 2020 2020 2020 656c  n.            el
-00030c30: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00030c40: 2020 2020 7473 2e70 7265 6669 782e 6475      ts.prefix.du
-00030c50: 7261 7469 6f6e 5f61 7665 7261 6765 203d  ration_average =
-00030c60: 2028 6f6c 645f 6475 7261 7469 6f6e 202b   (old_duration +
-00030c70: 2063 6f6d 7075 7465 5f64 7572 6174 696f   compute_duratio
-00030c80: 6e29 202f 2032 0a0a 2020 2020 2020 2020  n) / 2..        
-00030c90: 7773 2e61 6464 5f74 6f5f 6c6f 6e67 5f72  ws.add_to_long_r
-00030ca0: 756e 6e69 6e67 2874 7329 0a20 2020 2020  unning(ts).     
-00030cb0: 2020 2073 656c 662e 6368 6563 6b5f 6964     self.check_id
-00030cc0: 6c65 5f73 6174 7572 6174 6564 2877 7329  le_saturated(ws)
-00030cd0: 0a0a 2020 2020 2020 2020 7365 6c66 2e73  ..        self.s
-00030ce0: 7469 6d75 6c75 735f 7175 6575 655f 736c  timulus_queue_sl
-00030cf0: 6f74 735f 6d61 7962 655f 6f70 656e 6564  ots_maybe_opened
-00030d00: 2873 7469 6d75 6c75 735f 6964 3d73 7469  (stimulus_id=sti
-00030d10: 6d75 6c75 735f 6964 290a 0a20 2020 2064  mulus_id)..    d
-00030d20: 6566 2068 616e 646c 655f 776f 726b 6572  ef handle_worker
-00030d30: 5f73 7461 7475 735f 6368 616e 6765 280a  _status_change(.
-00030d40: 2020 2020 2020 2020 7365 6c66 2c20 7374          self, st
-00030d50: 6174 7573 3a20 7374 7220 7c20 5374 6174  atus: str | Stat
-00030d60: 7573 2c20 776f 726b 6572 3a20 7374 7220  us, worker: str 
-00030d70: 7c20 576f 726b 6572 5374 6174 652c 2073  | WorkerState, s
-00030d80: 7469 6d75 6c75 735f 6964 3a20 7374 720a  timulus_id: str.
-00030d90: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
-00030da0: 2020 2020 2020 2077 7320 3d20 7365 6c66         ws = self
-00030db0: 2e77 6f72 6b65 7273 2e67 6574 2877 6f72  .workers.get(wor
-00030dc0: 6b65 7229 2069 6620 6973 696e 7374 616e  ker) if isinstan
-00030dd0: 6365 2877 6f72 6b65 722c 2073 7472 2920  ce(worker, str) 
-00030de0: 656c 7365 2077 6f72 6b65 720a 2020 2020  else worker.    
-00030df0: 2020 2020 6966 206e 6f74 2077 733a 0a20      if not ws:. 
-00030e00: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00030e10: 6e0a 2020 2020 2020 2020 7072 6576 5f73  n.        prev_s
-00030e20: 7461 7475 7320 3d20 7773 2e73 7461 7475  tatus = ws.statu
-00030e30: 730a 2020 2020 2020 2020 7773 2e73 7461  s.        ws.sta
-00030e40: 7475 7320 3d20 5374 6174 7573 5b73 7461  tus = Status[sta
-00030e50: 7475 735d 2069 6620 6973 696e 7374 616e  tus] if isinstan
-00030e60: 6365 2873 7461 7475 732c 2073 7472 2920  ce(status, str) 
-00030e70: 656c 7365 2073 7461 7475 730a 2020 2020  else status.    
-00030e80: 2020 2020 6966 2077 732e 7374 6174 7573      if ws.status
-00030e90: 203d 3d20 7072 6576 5f73 7461 7475 733a   == prev_status:
-00030ea0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00030eb0: 7572 6e0a 0a20 2020 2020 2020 2073 656c  urn..        sel
-00030ec0: 662e 6c6f 675f 6576 656e 7428 0a20 2020  f.log_event(.   
-00030ed0: 2020 2020 2020 2020 2077 732e 6164 6472           ws.addr
-00030ee0: 6573 732c 0a20 2020 2020 2020 2020 2020  ess,.           
-00030ef0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00030f00: 2020 2022 6163 7469 6f6e 223a 2022 776f     "action": "wo
-00030f10: 726b 6572 2d73 7461 7475 732d 6368 616e  rker-status-chan
-00030f20: 6765 222c 0a20 2020 2020 2020 2020 2020  ge",.           
-00030f30: 2020 2020 2022 7072 6576 2d73 7461 7475       "prev-statu
-00030f40: 7322 3a20 7072 6576 5f73 7461 7475 732e  s": prev_status.
-00030f50: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
-00030f60: 2020 2020 2020 2273 7461 7475 7322 3a20        "status": 
-00030f70: 7773 2e73 7461 7475 732e 6e61 6d65 2c0a  ws.status.name,.
-00030f80: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
-00030f90: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00030fa0: 206c 6f67 6765 722e 6465 6275 6728 6622   logger.debug(f"
-00030fb0: 576f 726b 6572 2073 7461 7475 7320 7b70  Worker status {p
-00030fc0: 7265 765f 7374 6174 7573 2e6e 616d 657d  rev_status.name}
-00030fd0: 202d 3e20 7b73 7461 7475 737d 202d 207b   -> {status} - {
-00030fe0: 7773 7d22 290a 0a20 2020 2020 2020 2069  ws}")..        i
-00030ff0: 6620 7773 2e73 7461 7475 7320 3d3d 2053  f ws.status == S
-00031000: 7461 7475 732e 7275 6e6e 696e 673a 0a20  tatus.running:. 
-00031010: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00031020: 7275 6e6e 696e 672e 6164 6428 7773 290a  running.add(ws).
-00031030: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00031040: 2e63 6865 636b 5f69 646c 655f 7361 7475  .check_idle_satu
-00031050: 7261 7465 6428 7773 290a 2020 2020 2020  rated(ws).      
-00031060: 2020 2020 2020 7365 6c66 2e74 7261 6e73        self.trans
-00031070: 6974 696f 6e73 280a 2020 2020 2020 2020  itions(.        
-00031080: 2020 2020 2020 2020 7365 6c66 2e62 756c          self.bul
-00031090: 6b5f 7363 6865 6475 6c65 5f75 6e72 756e  k_schedule_unrun
-000310a0: 6e61 626c 655f 6166 7465 725f 6164 6469  nable_after_addi
-000310b0: 6e67 5f77 6f72 6b65 7228 7773 292c 2073  ng_worker(ws), s
-000310c0: 7469 6d75 6c75 735f 6964 0a20 2020 2020  timulus_id.     
-000310d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000310e0: 2020 2020 2073 656c 662e 7374 696d 756c       self.stimul
-000310f0: 7573 5f71 7565 7565 5f73 6c6f 7473 5f6d  us_queue_slots_m
-00031100: 6179 6265 5f6f 7065 6e65 6428 7374 696d  aybe_opened(stim
-00031110: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
-00031120: 5f69 6429 0a20 2020 2020 2020 2065 6c73  _id).        els
-00031130: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-00031140: 656c 662e 7275 6e6e 696e 672e 6469 7363  elf.running.disc
-00031150: 6172 6428 7773 290a 2020 2020 2020 2020  ard(ws).        
-00031160: 2020 2020 7365 6c66 2e69 646c 652e 706f      self.idle.po
-00031170: 7028 7773 2e61 6464 7265 7373 2c20 4e6f  p(ws.address, No
-00031180: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
-00031190: 7365 6c66 2e69 646c 655f 7461 736b 5f63  self.idle_task_c
-000311a0: 6f75 6e74 2e64 6973 6361 7264 2877 7329  ount.discard(ws)
-000311b0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000311c0: 662e 7361 7475 7261 7465 642e 6469 7363  f.saturated.disc
-000311d0: 6172 6428 7773 290a 0a20 2020 2061 7379  ard(ws)..    asy
-000311e0: 6e63 2064 6566 2068 616e 646c 655f 7265  nc def handle_re
-000311f0: 7175 6573 745f 7265 6672 6573 685f 7768  quest_refresh_wh
-00031200: 6f5f 6861 7328 0a20 2020 2020 2020 2073  o_has(.        s
-00031210: 656c 662c 206b 6579 733a 2049 7465 7261  elf, keys: Itera
-00031220: 626c 655b 7374 725d 2c20 776f 726b 6572  ble[str], worker
-00031230: 3a20 7374 722c 2073 7469 6d75 6c75 735f  : str, stimulus_
-00031240: 6964 3a20 7374 720a 2020 2020 2920 2d3e  id: str.    ) ->
-00031250: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-00031260: 2222 4173 796e 6368 726f 6e6f 7573 2072  ""Asynchronous r
-00031270: 6571 7565 7374 2028 7468 726f 7567 6820  equest (through 
-00031280: 6275 6c6b 2063 6f6d 6d73 2920 6672 6f6d  bulk comms) from
-00031290: 2061 2057 6f72 6b65 7220 746f 2072 6566   a Worker to ref
-000312a0: 7265 7368 2074 6865 0a20 2020 2020 2020  resh the.       
-000312b0: 2077 686f 5f68 6173 2066 6f72 2073 6f6d   who_has for som
-000312c0: 6520 6b65 7973 2e20 4e6f 7420 746f 2062  e keys. Not to b
-000312d0: 6520 636f 6e66 7573 6564 2077 6974 6820  e confused with 
-000312e0: 7363 6865 6475 6c65 722e 7768 6f5f 6861  scheduler.who_ha
-000312f0: 732c 2077 6869 6368 2069 7320 610a 2020  s, which is a.  
-00031300: 2020 2020 2020 7379 6e63 6872 6f6e 6f75        synchronou
-00031310: 7320 5250 4320 7265 7175 6573 7420 6672  s RPC request fr
-00031320: 6f6d 2061 2043 6c69 656e 742e 0a20 2020  om a Client..   
-00031330: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00031340: 2077 686f 5f68 6173 203d 207b 7d0a 2020   who_has = {}.  
-00031350: 2020 2020 2020 6672 6565 5f6b 6579 7320        free_keys 
-00031360: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
-00031370: 206b 6579 2069 6e20 6b65 7973 3a0a 2020   key in keys:.  
-00031380: 2020 2020 2020 2020 2020 6966 206b 6579            if key
-00031390: 2069 6e20 7365 6c66 2e74 6173 6b73 3a0a   in self.tasks:.
-000313a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000313b0: 7768 6f5f 6861 735b 6b65 795d 203d 205b  who_has[key] = [
-000313c0: 7773 2e61 6464 7265 7373 2066 6f72 2077  ws.address for w
-000313d0: 7320 696e 2073 656c 662e 7461 736b 735b  s in self.tasks[
-000313e0: 6b65 795d 2e77 686f 5f68 6173 5d0a 2020  key].who_has].  
-000313f0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00031400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031410: 6672 6565 5f6b 6579 732e 6170 7065 6e64  free_keys.append
-00031420: 286b 6579 290a 0a20 2020 2020 2020 2069  (key)..        i
-00031430: 6620 7768 6f5f 6861 733a 0a20 2020 2020  f who_has:.     
-00031440: 2020 2020 2020 2073 656c 662e 7374 7265         self.stre
-00031450: 616d 5f63 6f6d 6d73 5b77 6f72 6b65 725d  am_comms[worker]
-00031460: 2e73 656e 6428 0a20 2020 2020 2020 2020  .send(.         
-00031470: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00031480: 2020 2020 2020 2020 2020 2020 2022 6f70               "op
-00031490: 223a 2022 7265 6672 6573 682d 7768 6f2d  ": "refresh-who-
-000314a0: 6861 7322 2c0a 2020 2020 2020 2020 2020  has",.          
-000314b0: 2020 2020 2020 2020 2020 2277 686f 5f68            "who_h
-000314c0: 6173 223a 2077 686f 5f68 6173 2c0a 2020  as": who_has,.  
-000314d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000314e0: 2020 2273 7469 6d75 6c75 735f 6964 223a    "stimulus_id":
-000314f0: 2073 7469 6d75 6c75 735f 6964 2c0a 2020   stimulus_id,.  
-00031500: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00031510: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00031520: 2020 2020 2020 6966 2066 7265 655f 6b65        if free_ke
-00031530: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
-00031540: 7365 6c66 2e73 7472 6561 6d5f 636f 6d6d  self.stream_comm
-00031550: 735b 776f 726b 6572 5d2e 7365 6e64 280a  s[worker].send(.
-00031560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031570: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00031580: 2020 2020 2020 226f 7022 3a20 2266 7265        "op": "fre
-00031590: 652d 6b65 7973 222c 0a20 2020 2020 2020  e-keys",.       
-000315a0: 2020 2020 2020 2020 2020 2020 2022 6b65               "ke
-000315b0: 7973 223a 2066 7265 655f 6b65 7973 2c0a  ys": free_keys,.
-000315c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000315d0: 2020 2020 2273 7469 6d75 6c75 735f 6964      "stimulus_id
-000315e0: 223a 2073 7469 6d75 6c75 735f 6964 2c0a  ": stimulus_id,.
-000315f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031600: 7d0a 2020 2020 2020 2020 2020 2020 290a  }.            ).
-00031610: 0a20 2020 2061 7379 6e63 2064 6566 2068  .    async def h
-00031620: 616e 646c 655f 776f 726b 6572 2873 656c  andle_worker(sel
-00031630: 662c 2063 6f6d 6d3a 2043 6f6d 6d2c 2077  f, comm: Comm, w
-00031640: 6f72 6b65 723a 2073 7472 2920 2d3e 204e  orker: str) -> N
-00031650: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-00031660: 0a20 2020 2020 2020 204c 6973 7465 6e20  .        Listen 
-00031670: 746f 2072 6573 706f 6e73 6573 2066 726f  to responses fro
-00031680: 6d20 6120 7369 6e67 6c65 2077 6f72 6b65  m a single worke
-00031690: 720a 0a20 2020 2020 2020 2054 6869 7320  r..        This 
-000316a0: 6973 2074 6865 206d 6169 6e20 6c6f 6f70  is the main loop
-000316b0: 2066 6f72 2073 6368 6564 756c 6572 2d77   for scheduler-w
-000316c0: 6f72 6b65 7220 696e 7465 7261 6374 696f  orker interactio
-000316d0: 6e0a 0a20 2020 2020 2020 2053 6565 2041  n..        See A
-000316e0: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
-000316f0: 2d2d 2d2d 0a20 2020 2020 2020 2053 6368  ----.        Sch
-00031700: 6564 756c 6572 2e68 616e 646c 655f 636c  eduler.handle_cl
-00031710: 6965 6e74 3a20 4571 7569 7661 6c65 6e74  ient: Equivalent
-00031720: 2063 6f72 6f75 7469 6e65 2066 6f72 2063   coroutine for c
-00031730: 6c69 656e 7473 0a20 2020 2020 2020 2022  lients.        "
-00031740: 2222 0a20 2020 2020 2020 2063 6f6d 6d2e  "".        comm.
-00031750: 6e61 6d65 203d 2022 5363 6865 6475 6c65  name = "Schedule
-00031760: 7220 636f 6e6e 6563 7469 6f6e 2074 6f20  r connection to 
-00031770: 776f 726b 6572 220a 2020 2020 2020 2020  worker".        
-00031780: 776f 726b 6572 5f63 6f6d 6d20 3d20 7365  worker_comm = se
-00031790: 6c66 2e73 7472 6561 6d5f 636f 6d6d 735b  lf.stream_comms[
-000317a0: 776f 726b 6572 5d0a 2020 2020 2020 2020  worker].        
-000317b0: 776f 726b 6572 5f63 6f6d 6d2e 7374 6172  worker_comm.star
-000317c0: 7428 636f 6d6d 290a 2020 2020 2020 2020  t(comm).        
-000317d0: 6c6f 6767 6572 2e69 6e66 6f28 2253 7461  logger.info("Sta
-000317e0: 7274 696e 6720 776f 726b 6572 2063 6f6d  rting worker com
-000317f0: 7075 7465 2073 7472 6561 6d2c 2025 7322  pute stream, %s"
-00031800: 2c20 776f 726b 6572 290a 2020 2020 2020  , worker).      
-00031810: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00031820: 2020 2061 7761 6974 2073 656c 662e 6861     await self.ha
-00031830: 6e64 6c65 5f73 7472 6561 6d28 636f 6d6d  ndle_stream(comm
-00031840: 3d63 6f6d 6d2c 2065 7874 7261 3d7b 2277  =comm, extra={"w
-00031850: 6f72 6b65 7222 3a20 776f 726b 6572 7d29  orker": worker})
-00031860: 0a20 2020 2020 2020 2066 696e 616c 6c79  .        finally
-00031870: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00031880: 2077 6f72 6b65 7220 696e 2073 656c 662e   worker in self.
-00031890: 7374 7265 616d 5f63 6f6d 6d73 3a0a 2020  stream_comms:.  
-000318a0: 2020 2020 2020 2020 2020 2020 2020 776f                wo
-000318b0: 726b 6572 5f63 6f6d 6d2e 6162 6f72 7428  rker_comm.abort(
-000318c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000318d0: 2020 6177 6169 7420 7365 6c66 2e72 656d    await self.rem
-000318e0: 6f76 655f 776f 726b 6572 280a 2020 2020  ove_worker(.    
-000318f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031900: 776f 726b 6572 2c20 7374 696d 756c 7573  worker, stimulus
-00031910: 5f69 643d 6622 6861 6e64 6c65 2d77 6f72  _id=f"handle-wor
-00031920: 6b65 722d 636c 6561 6e75 702d 7b74 696d  ker-cleanup-{tim
-00031930: 6528 297d 220a 2020 2020 2020 2020 2020  e()}".          
-00031940: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-00031950: 2061 6464 5f70 6c75 6769 6e28 0a20 2020   add_plugin(.   
-00031960: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00031970: 2020 2070 6c75 6769 6e3a 2053 6368 6564     plugin: Sched
-00031980: 756c 6572 506c 7567 696e 2c0a 2020 2020  ulerPlugin,.    
-00031990: 2020 2020 2a2c 0a20 2020 2020 2020 2069      *,.        i
-000319a0: 6465 6d70 6f74 656e 743a 2062 6f6f 6c20  dempotent: bool 
-000319b0: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
-000319c0: 206e 616d 653a 2073 7472 207c 204e 6f6e   name: str | Non
-000319d0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-000319e0: 2020 2a2a 6b77 6172 6773 3a20 416e 792c    **kwargs: Any,
-000319f0: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
-00031a00: 2020 2020 2020 2020 2222 2241 6464 2065          """Add e
-00031a10: 7874 6572 6e61 6c20 706c 7567 696e 2074  xternal plugin t
-00031a20: 6f20 7363 6865 6475 6c65 722e 0a0a 2020  o scheduler...  
-00031a30: 2020 2020 2020 5365 6520 6874 7470 733a        See https:
-00031a40: 2f2f 6469 7374 7269 6275 7465 642e 7265  //distributed.re
-00031a50: 6164 7468 6564 6f63 732e 696f 2f65 6e2f  adthedocs.io/en/
-00031a60: 6c61 7465 7374 2f70 6c75 6769 6e73 2e68  latest/plugins.h
-00031a70: 746d 6c0a 0a20 2020 2020 2020 2050 6172  tml..        Par
-00031a80: 616d 6574 6572 730a 2020 2020 2020 2020  ameters.        
-00031a90: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
-00031aa0: 2020 2070 6c75 6769 6e20 3a20 5363 6865     plugin : Sche
-00031ab0: 6475 6c65 7250 6c75 6769 6e0a 2020 2020  dulerPlugin.    
-00031ac0: 2020 2020 2020 2020 5363 6865 6475 6c65          Schedule
-00031ad0: 7250 6c75 6769 6e20 696e 7374 616e 6365  rPlugin instance
-00031ae0: 2074 6f20 6164 640a 2020 2020 2020 2020   to add.        
-00031af0: 6964 656d 706f 7465 6e74 203a 2062 6f6f  idempotent : boo
-00031b00: 6c0a 2020 2020 2020 2020 2020 2020 4966  l.            If
-00031b10: 2074 7275 652c 2074 6865 2070 6c75 6769   true, the plugi
-00031b20: 6e20 6973 2061 7373 756d 6564 2074 6f20  n is assumed to 
-00031b30: 616c 7265 6164 7920 6578 6973 7420 616e  already exist an
-00031b40: 6420 6e6f 0a20 2020 2020 2020 2020 2020  d no.           
-00031b50: 2061 6374 696f 6e20 6973 2074 616b 656e   action is taken
-00031b60: 2e0a 2020 2020 2020 2020 6e61 6d65 203a  ..        name :
-00031b70: 2073 7472 0a20 2020 2020 2020 2020 2020   str.           
-00031b80: 2041 206e 616d 6520 666f 7220 7468 6520   A name for the 
-00031b90: 706c 7567 696e 2c20 6966 204e 6f6e 652c  plugin, if None,
-00031ba0: 2074 6865 206e 616d 6520 6174 7472 6962   the name attrib
-00031bb0: 7574 6520 6973 0a20 2020 2020 2020 2020  ute is.         
-00031bc0: 2020 2063 6865 636b 6564 206f 6e20 7468     checked on th
-00031bd0: 6520 506c 7567 696e 2069 6e73 7461 6e63  e Plugin instanc
-00031be0: 6520 616e 6420 6765 6e65 7261 7465 6420  e and generated 
-00031bf0: 6966 206e 6f74 0a20 2020 2020 2020 2020  if not.         
-00031c00: 2020 2064 6973 636f 7665 7265 642e 0a20     discovered.. 
-00031c10: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00031c20: 2020 2069 6620 6e61 6d65 2069 7320 4e6f     if name is No
-00031c30: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00031c40: 6e61 6d65 203d 205f 6765 745f 706c 7567  name = _get_plug
-00031c50: 696e 5f6e 616d 6528 706c 7567 696e 290a  in_name(plugin).
-00031c60: 0a20 2020 2020 2020 2069 6620 6e61 6d65  .        if name
-00031c70: 2069 6e20 7365 6c66 2e70 6c75 6769 6e73   in self.plugins
-00031c80: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00031c90: 2069 6465 6d70 6f74 656e 743a 0a20 2020   idempotent:.   
-00031ca0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00031cb0: 7572 6e0a 2020 2020 2020 2020 2020 2020  urn.            
-00031cc0: 7761 726e 696e 6773 2e77 6172 6e28 0a20  warnings.warn(. 
-00031cd0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00031ce0: 2253 6368 6564 756c 6572 2061 6c72 6561  "Scheduler alrea
-00031cf0: 6479 2063 6f6e 7461 696e 7320 6120 706c  dy contains a pl
-00031d00: 7567 696e 2077 6974 6820 6e61 6d65 207b  ugin with name {
-00031d10: 6e61 6d65 7d3b 206f 7665 7277 7269 7469  name}; overwriti
-00031d20: 6e67 2e22 2c0a 2020 2020 2020 2020 2020  ng.",.          
-00031d30: 2020 2020 2020 6361 7465 676f 7279 3d55        category=U
-00031d40: 7365 7257 6172 6e69 6e67 2c0a 2020 2020  serWarning,.    
-00031d50: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00031d60: 2020 2073 656c 662e 706c 7567 696e 735b     self.plugins[
-00031d70: 6e61 6d65 5d20 3d20 706c 7567 696e 0a0a  name] = plugin..
-00031d80: 2020 2020 6465 6620 7265 6d6f 7665 5f70      def remove_p
-00031d90: 6c75 6769 6e28 0a20 2020 2020 2020 2073  lugin(.        s
-00031da0: 656c 662c 0a20 2020 2020 2020 206e 616d  elf,.        nam
-00031db0: 653a 2073 7472 207c 204e 6f6e 6520 3d20  e: str | None = 
-00031dc0: 4e6f 6e65 2c0a 2020 2020 2020 2020 706c  None,.        pl
-00031dd0: 7567 696e 3a20 5363 6865 6475 6c65 7250  ugin: SchedulerP
-00031de0: 6c75 6769 6e20 7c20 4e6f 6e65 203d 204e  lugin | None = N
-00031df0: 6f6e 652c 0a20 2020 2029 202d 3e20 4e6f  one,.    ) -> No
-00031e00: 6e65 3a0a 2020 2020 2020 2020 2222 2252  ne:.        """R
-00031e10: 656d 6f76 6520 6578 7465 726e 616c 2070  emove external p
-00031e20: 6c75 6769 6e20 6672 6f6d 2073 6368 6564  lugin from sched
-00031e30: 756c 6572 0a0a 2020 2020 2020 2020 5061  uler..        Pa
-00031e40: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
-00031e50: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-00031e60: 2020 2020 6e61 6d65 203a 2073 7472 0a20      name : str. 
-00031e70: 2020 2020 2020 2020 2020 204e 616d 6520             Name 
-00031e80: 6f66 2074 6865 2070 6c75 6769 6e20 746f  of the plugin to
-00031e90: 2072 656d 6f76 650a 2020 2020 2020 2020   remove.        
-00031ea0: 2222 220a 2020 2020 2020 2020 6173 7365  """.        asse
-00031eb0: 7274 206e 616d 6520 6973 206e 6f74 204e  rt name is not N
-00031ec0: 6f6e 650a 0a20 2020 2020 2020 2074 7279  one..        try
-00031ed0: 3a0a 2020 2020 2020 2020 2020 2020 6465  :.            de
-00031ee0: 6c20 7365 6c66 2e70 6c75 6769 6e73 5b6e  l self.plugins[n
-00031ef0: 616d 655d 0a20 2020 2020 2020 2065 7863  ame].        exc
-00031f00: 6570 7420 4b65 7945 7272 6f72 3a0a 2020  ept KeyError:.  
-00031f10: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00031f20: 5661 6c75 6545 7272 6f72 280a 2020 2020  ValueError(.    
-00031f30: 2020 2020 2020 2020 2020 2020 6622 436f              f"Co
-00031f40: 756c 6420 6e6f 7420 6669 6e64 2070 6c75  uld not find plu
-00031f50: 6769 6e20 7b6e 616d 6521 727d 2061 6d6f  gin {name!r} amo
-00031f60: 6e67 2074 6865 2063 7572 7265 6e74 2073  ng the current s
-00031f70: 6368 6564 756c 6572 2070 6c75 6769 6e73  cheduler plugins
-00031f80: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-00031f90: 0a20 2020 2061 7379 6e63 2064 6566 2072  .    async def r
-00031fa0: 6567 6973 7465 725f 7363 6865 6475 6c65  egister_schedule
-00031fb0: 725f 706c 7567 696e 280a 2020 2020 2020  r_plugin(.      
-00031fc0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-00031fd0: 706c 7567 696e 3a20 6279 7465 7320 7c20  plugin: bytes | 
-00031fe0: 5363 6865 6475 6c65 7250 6c75 6769 6e2c  SchedulerPlugin,
-00031ff0: 0a20 2020 2020 2020 206e 616d 653a 2073  .        name: s
-00032000: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
-00032010: 2c0a 2020 2020 2020 2020 6964 656d 706f  ,.        idempo
-00032020: 7465 6e74 3a20 626f 6f6c 203d 2046 616c  tent: bool = Fal
-00032030: 7365 2c0a 2020 2020 2920 2d3e 204e 6f6e  se,.    ) -> Non
-00032040: 653a 0a20 2020 2020 2020 2022 2222 5265  e:.        """Re
-00032050: 6769 7374 6572 2061 2070 6c75 6769 6e20  gister a plugin 
-00032060: 6f6e 2074 6865 2073 6368 6564 756c 6572  on the scheduler
-00032070: 2e22 2222 0a20 2020 2020 2020 2069 6620  .""".        if 
-00032080: 6e6f 7420 6461 736b 2e63 6f6e 6669 672e  not dask.config.
-00032090: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
-000320a0: 2e73 6368 6564 756c 6572 2e70 6963 6b6c  .scheduler.pickl
-000320b0: 6522 293a 0a20 2020 2020 2020 2020 2020  e"):.           
-000320c0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-000320d0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-000320e0: 2020 2022 4361 6e6e 6f74 2072 6567 6973     "Cannot regis
-000320f0: 7465 7220 6120 7363 6865 6475 6c65 7220  ter a scheduler 
-00032100: 706c 7567 696e 2061 7320 7468 6520 7363  plugin as the sc
-00032110: 6865 6475 6c65 7220 220a 2020 2020 2020  heduler ".      
-00032120: 2020 2020 2020 2020 2020 2268 6173 2062            "has b
-00032130: 6565 6e20 6578 706c 6963 6974 6c79 2064  een explicitly d
-00032140: 6973 616c 6c6f 7765 6420 6672 6f6d 2064  isallowed from d
-00032150: 6573 6572 6961 6c69 7a69 6e67 2022 0a20  eserializing ". 
-00032160: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00032170: 6172 6269 7472 6172 7920 6279 7465 7374  arbitrary bytest
-00032180: 7269 6e67 7320 7573 696e 6720 7069 636b  rings using pick
-00032190: 6c65 2076 6961 2074 6865 2022 0a20 2020  le via the ".   
-000321a0: 2020 2020 2020 2020 2020 2020 2022 2764               "'d
-000321b0: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
-000321c0: 756c 6572 2e70 6963 6b6c 6527 2063 6f6e  uler.pickle' con
-000321d0: 6669 6775 7261 7469 6f6e 2073 6574 7469  figuration setti
-000321e0: 6e67 2e22 0a20 2020 2020 2020 2020 2020  ng.".           
-000321f0: 2029 0a20 2020 2020 2020 2069 6620 6e6f   ).        if no
-00032200: 7420 6973 696e 7374 616e 6365 2870 6c75  t isinstance(plu
-00032210: 6769 6e2c 2053 6368 6564 756c 6572 506c  gin, SchedulerPl
-00032220: 7567 696e 293a 0a20 2020 2020 2020 2020  ugin):.         
-00032230: 2020 2070 6c75 6769 6e20 3d20 6c6f 6164     plugin = load
-00032240: 7328 706c 7567 696e 290a 2020 2020 2020  s(plugin).      
-00032250: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
-00032260: 6e73 7461 6e63 6528 706c 7567 696e 2c20  nstance(plugin, 
-00032270: 5363 6865 6475 6c65 7250 6c75 6769 6e29  SchedulerPlugin)
-00032280: 0a0a 2020 2020 2020 2020 6966 206e 616d  ..        if nam
-00032290: 6520 6973 204e 6f6e 653a 0a20 2020 2020  e is None:.     
-000322a0: 2020 2020 2020 206e 616d 6520 3d20 5f67         name = _g
-000322b0: 6574 5f70 6c75 6769 6e5f 6e61 6d65 2870  et_plugin_name(p
-000322c0: 6c75 6769 6e29 0a0a 2020 2020 2020 2020  lugin)..        
-000322d0: 6966 206e 616d 6520 696e 2073 656c 662e  if name in self.
-000322e0: 706c 7567 696e 7320 616e 6420 6964 656d  plugins and idem
-000322f0: 706f 7465 6e74 3a0a 2020 2020 2020 2020  potent:.        
-00032300: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-00032310: 2020 2020 6966 2068 6173 6174 7472 2870      if hasattr(p
-00032320: 6c75 6769 6e2c 2022 7374 6172 7422 293a  lugin, "start"):
-00032330: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-00032340: 756c 7420 3d20 706c 7567 696e 2e73 7461  ult = plugin.sta
-00032350: 7274 2873 656c 6629 0a20 2020 2020 2020  rt(self).       
-00032360: 2020 2020 2069 6620 696e 7370 6563 742e       if inspect.
-00032370: 6973 6177 6169 7461 626c 6528 7265 7375  isawaitable(resu
-00032380: 6c74 293a 0a20 2020 2020 2020 2020 2020  lt):.           
-00032390: 2020 2020 2061 7761 6974 2072 6573 756c       await resul
-000323a0: 740a 0a20 2020 2020 2020 2073 656c 662e  t..        self.
-000323b0: 6164 645f 706c 7567 696e 2870 6c75 6769  add_plugin(plugi
-000323c0: 6e2c 206e 616d 653d 6e61 6d65 2c20 6964  n, name=name, id
-000323d0: 656d 706f 7465 6e74 3d69 6465 6d70 6f74  empotent=idempot
-000323e0: 656e 7429 0a0a 2020 2020 6465 6620 776f  ent)..    def wo
-000323f0: 726b 6572 5f73 656e 6428 7365 6c66 2c20  rker_send(self, 
-00032400: 776f 726b 6572 3a20 7374 722c 206d 7367  worker: str, msg
-00032410: 3a20 6469 6374 5b73 7472 2c20 416e 795d  : dict[str, Any]
-00032420: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00032430: 2020 2022 2222 5365 6e64 206d 6573 7361     """Send messa
-00032440: 6765 2074 6f20 776f 726b 6572 0a0a 2020  ge to worker..  
-00032450: 2020 2020 2020 5468 6973 2061 6c73 6f20        This also 
-00032460: 6861 6e64 6c65 7320 636f 6e6e 6563 7469  handles connecti
-00032470: 6f6e 2066 6169 6c75 7265 7320 6279 2061  on failures by a
-00032480: 6464 696e 6720 6120 6361 6c6c 6261 636b  dding a callback
-00032490: 2074 6f20 7265 6d6f 7665 0a20 2020 2020   to remove.     
-000324a0: 2020 2074 6865 2077 6f72 6b65 7220 6f6e     the worker on
-000324b0: 2074 6865 206e 6578 7420 6379 636c 652e   the next cycle.
-000324c0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000324d0: 2020 2020 2073 7472 6561 6d5f 636f 6d6d       stream_comm
-000324e0: 733a 2064 6963 7420 3d20 7365 6c66 2e73  s: dict = self.s
-000324f0: 7472 6561 6d5f 636f 6d6d 730a 2020 2020  tream_comms.    
-00032500: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00032510: 2020 2020 2073 7472 6561 6d5f 636f 6d6d       stream_comm
-00032520: 735b 776f 726b 6572 5d2e 7365 6e64 286d  s[worker].send(m
-00032530: 7367 290a 2020 2020 2020 2020 6578 6365  sg).        exce
-00032540: 7074 2028 436f 6d6d 436c 6f73 6564 4572  pt (CommClosedEr
-00032550: 726f 722c 2041 7474 7269 6275 7465 4572  ror, AttributeEr
-00032560: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-00032570: 2020 7365 6c66 2e5f 6f6e 676f 696e 675f    self._ongoing_
-00032580: 6261 636b 6772 6f75 6e64 5f74 6173 6b73  background_tasks
-00032590: 2e63 616c 6c5f 736f 6f6e 280a 2020 2020  .call_soon(.    
-000325a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000325b0: 2e72 656d 6f76 655f 776f 726b 6572 2c0a  .remove_worker,.
-000325c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000325d0: 6164 6472 6573 733d 776f 726b 6572 2c0a  address=worker,.
-000325e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000325f0: 7374 696d 756c 7573 5f69 643d 6622 776f  stimulus_id=f"wo
-00032600: 726b 6572 2d73 656e 642d 636f 6d6d 2d66  rker-send-comm-f
-00032610: 6169 6c2d 7b74 696d 6528 297d 222c 0a20  ail-{time()}",. 
-00032620: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00032630: 2020 6465 6620 636c 6965 6e74 5f73 656e    def client_sen
-00032640: 6428 7365 6c66 2c20 636c 6965 6e74 2c20  d(self, client, 
-00032650: 6d73 6729 3a0a 2020 2020 2020 2020 2222  msg):.        ""
-00032660: 2253 656e 6420 6d65 7373 6167 6520 746f  "Send message to
-00032670: 2063 6c69 656e 7422 2222 0a20 2020 2020   client""".     
-00032680: 2020 2063 6c69 656e 745f 636f 6d6d 733a     client_comms:
-00032690: 2064 6963 7420 3d20 7365 6c66 2e63 6c69   dict = self.cli
-000326a0: 656e 745f 636f 6d6d 730a 2020 2020 2020  ent_comms.      
-000326b0: 2020 6320 3d20 636c 6965 6e74 5f63 6f6d    c = client_com
-000326c0: 6d73 2e67 6574 2863 6c69 656e 7429 0a20  ms.get(client). 
-000326d0: 2020 2020 2020 2069 6620 6320 6973 204e         if c is N
-000326e0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-000326f0: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-00032700: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00032710: 2063 2e73 656e 6428 6d73 6729 0a20 2020   c.send(msg).   
-00032720: 2020 2020 2065 7863 6570 7420 436f 6d6d       except Comm
-00032730: 436c 6f73 6564 4572 726f 723a 0a20 2020  ClosedError:.   
-00032740: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00032750: 2e73 7461 7475 7320 3d3d 2053 7461 7475  .status == Statu
-00032760: 732e 7275 6e6e 696e 673a 0a20 2020 2020  s.running:.     
-00032770: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-00032780: 722e 6372 6974 6963 616c 280a 2020 2020  r.critical(.    
-00032790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000327a0: 2243 6c6f 7365 6420 636f 6d6d 2025 7220  "Closed comm %r 
-000327b0: 7768 696c 6520 7472 7969 6e67 2074 6f20  while trying to 
-000327c0: 7772 6974 6520 2573 222c 2063 2c20 6d73  write %s", c, ms
-000327d0: 672c 2065 7863 5f69 6e66 6f3d 5472 7565  g, exc_info=True
-000327e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000327f0: 2029 0a0a 2020 2020 6465 6620 7365 6e64   )..    def send
-00032800: 5f61 6c6c 2873 656c 662c 2063 6c69 656e  _all(self, clien
-00032810: 745f 6d73 6773 3a20 4d73 6773 2c20 776f  t_msgs: Msgs, wo
-00032820: 726b 6572 5f6d 7367 733a 204d 7367 7329  rker_msgs: Msgs)
-00032830: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00032840: 2020 2222 2253 656e 6420 6d65 7373 6167    """Send messag
-00032850: 6573 2074 6f20 636c 6965 6e74 2061 6e64  es to client and
-00032860: 2077 6f72 6b65 7273 2222 220a 0a20 2020   workers"""..   
-00032870: 2020 2020 2066 6f72 2063 6c69 656e 742c       for client,
-00032880: 206d 7367 7320 696e 2063 6c69 656e 745f   msgs in client_
-00032890: 6d73 6773 2e69 7465 6d73 2829 3a0a 2020  msgs.items():.  
-000328a0: 2020 2020 2020 2020 2020 6320 3d20 7365            c = se
-000328b0: 6c66 2e63 6c69 656e 745f 636f 6d6d 732e  lf.client_comms.
-000328c0: 6765 7428 636c 6965 6e74 290a 2020 2020  get(client).    
-000328d0: 2020 2020 2020 2020 6966 2063 2069 7320          if c is 
-000328e0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-000328f0: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
-00032900: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-00032910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032920: 632e 7365 6e64 282a 6d73 6773 290a 2020  c.send(*msgs).  
-00032930: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00032940: 2043 6f6d 6d43 6c6f 7365 6445 7272 6f72   CommClosedError
-00032950: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00032960: 2020 6966 2073 656c 662e 7374 6174 7573    if self.status
-00032970: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
-00032980: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
-00032990: 2020 2020 2020 2020 6c6f 6767 6572 2e63          logger.c
-000329a0: 7269 7469 6361 6c28 0a20 2020 2020 2020  ritical(.       
-000329b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000329c0: 2022 436c 6f73 6564 2063 6f6d 6d20 2572   "Closed comm %r
-000329d0: 2077 6869 6c65 2074 7279 696e 6720 746f   while trying to
-000329e0: 2077 7269 7465 2025 7322 2c0a 2020 2020   write %s",.    
-000329f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032a00: 2020 2020 632c 0a20 2020 2020 2020 2020      c,.         
-00032a10: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00032a20: 7367 732c 0a20 2020 2020 2020 2020 2020  sgs,.           
-00032a30: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-00032a40: 5f69 6e66 6f3d 5472 7565 2c0a 2020 2020  _info=True,.    
-00032a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032a60: 290a 0a20 2020 2020 2020 2066 6f72 2077  )..        for w
-00032a70: 6f72 6b65 722c 206d 7367 7320 696e 2077  orker, msgs in w
-00032a80: 6f72 6b65 725f 6d73 6773 2e69 7465 6d73  orker_msgs.items
-00032a90: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00032aa0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00032ab0: 2020 2020 2077 203d 2073 656c 662e 7374       w = self.st
-00032ac0: 7265 616d 5f63 6f6d 6d73 5b77 6f72 6b65  ream_comms[worke
-00032ad0: 725d 0a20 2020 2020 2020 2020 2020 2020  r].             
-00032ae0: 2020 2077 2e73 656e 6428 2a6d 7367 7329     w.send(*msgs)
-00032af0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-00032b00: 6570 7420 4b65 7945 7272 6f72 3a0a 2020  ept KeyError:.  
-00032b10: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00032b20: 776f 726b 6572 2061 6c72 6561 6479 2067  worker already g
-00032b30: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-00032b40: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
-00032b50: 2020 2020 2065 7863 6570 7420 2843 6f6d       except (Com
-00032b60: 6d43 6c6f 7365 6445 7272 6f72 2c20 4174  mClosedError, At
-00032b70: 7472 6962 7574 6545 7272 6f72 293a 0a20  tributeError):. 
-00032b80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00032b90: 656c 662e 5f6f 6e67 6f69 6e67 5f62 6163  elf._ongoing_bac
-00032ba0: 6b67 726f 756e 645f 7461 736b 732e 6361  kground_tasks.ca
-00032bb0: 6c6c 5f73 6f6f 6e28 0a20 2020 2020 2020  ll_soon(.       
-00032bc0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00032bd0: 662e 7265 6d6f 7665 5f77 6f72 6b65 722c  f.remove_worker,
-00032be0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032bf0: 2020 2020 2061 6464 7265 7373 3d77 6f72       address=wor
-00032c00: 6b65 722c 0a20 2020 2020 2020 2020 2020  ker,.           
-00032c10: 2020 2020 2020 2020 2073 7469 6d75 6c75           stimulu
-00032c20: 735f 6964 3d66 2273 656e 642d 616c 6c2d  s_id=f"send-all-
-00032c30: 636f 6d6d 2d66 6169 6c2d 7b74 696d 6528  comm-fail-{time(
-00032c40: 297d 222c 0a20 2020 2020 2020 2020 2020  )}",.           
-00032c50: 2020 2020 2029 0a0a 2020 2020 2323 2323       )..    ####
-00032c60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00032c70: 2323 2323 2323 2323 0a20 2020 2023 204c  ########.    # L
-00032c80: 6573 7320 636f 6d6d 6f6e 2069 6e74 6572  ess common inter
-00032c90: 6163 7469 6f6e 7320 230a 2020 2020 2323  actions #.    ##
-00032ca0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00032cb0: 2323 2323 2323 2323 2323 0a0a 2020 2020  ##########..    
-00032cc0: 6173 796e 6320 6465 6620 7363 6174 7465  async def scatte
-00032cd0: 7228 0a20 2020 2020 2020 2073 656c 662c  r(.        self,
-00032ce0: 0a20 2020 2020 2020 2063 6f6d 6d3d 4e6f  .        comm=No
-00032cf0: 6e65 2c0a 2020 2020 2020 2020 6461 7461  ne,.        data
-00032d00: 3d4e 6f6e 652c 0a20 2020 2020 2020 2077  =None,.        w
-00032d10: 6f72 6b65 7273 3d4e 6f6e 652c 0a20 2020  orkers=None,.   
-00032d20: 2020 2020 2063 6c69 656e 743d 4e6f 6e65       client=None
-00032d30: 2c0a 2020 2020 2020 2020 6272 6f61 6463  ,.        broadc
-00032d40: 6173 743d 4661 6c73 652c 0a20 2020 2020  ast=False,.     
-00032d50: 2020 2074 696d 656f 7574 3d32 2c0a 2020     timeout=2,.  
-00032d60: 2020 293a 0a20 2020 2020 2020 2022 2222    ):.        """
-00032d70: 5365 6e64 2064 6174 6120 6f75 7420 746f  Send data out to
-00032d80: 2077 6f72 6b65 7273 0a0a 2020 2020 2020   workers..      
-00032d90: 2020 5365 6520 616c 736f 0a20 2020 2020    See also.     
-00032da0: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
-00032db0: 2020 2020 5363 6865 6475 6c65 722e 6272      Scheduler.br
-00032dc0: 6f61 6463 6173 743a 0a20 2020 2020 2020  oadcast:.       
-00032dd0: 2022 2222 0a20 2020 2020 2020 2073 7461   """.        sta
-00032de0: 7274 203d 2074 696d 6528 290a 2020 2020  rt = time().    
-00032df0: 2020 2020 7768 696c 6520 5472 7565 3a0a      while True:.
-00032e00: 2020 2020 2020 2020 2020 2020 6966 2077              if w
-00032e10: 6f72 6b65 7273 2069 7320 4e6f 6e65 3a0a  orkers is None:.
-00032e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032e30: 7773 7320 3d20 7365 6c66 2e72 756e 6e69  wss = self.runni
-00032e40: 6e67 0a20 2020 2020 2020 2020 2020 2065  ng.            e
-00032e50: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00032e60: 2020 2020 2077 6f72 6b65 7273 203d 205b       workers = [
-00032e70: 7365 6c66 2e63 6f65 7263 655f 6164 6472  self.coerce_addr
-00032e80: 6573 7328 7729 2066 6f72 2077 2069 6e20  ess(w) for w in 
-00032e90: 776f 726b 6572 735d 0a20 2020 2020 2020  workers].       
-00032ea0: 2020 2020 2020 2020 2077 7373 203d 207b           wss = {
-00032eb0: 7365 6c66 2e77 6f72 6b65 7273 5b77 5d20  self.workers[w] 
-00032ec0: 666f 7220 7720 696e 2077 6f72 6b65 7273  for w in workers
-00032ed0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-00032ee0: 2020 7773 7320 3d20 7b77 7320 666f 7220    wss = {ws for 
-00032ef0: 7773 2069 6e20 7773 7320 6966 2077 732e  ws in wss if ws.
-00032f00: 7374 6174 7573 203d 3d20 5374 6174 7573  status == Status
-00032f10: 2e72 756e 6e69 6e67 7d0a 0a20 2020 2020  .running}..     
-00032f20: 2020 2020 2020 2069 6620 7773 733a 0a20         if wss:. 
-00032f30: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-00032f40: 7265 616b 0a20 2020 2020 2020 2020 2020  reak.           
-00032f50: 2069 6620 7469 6d65 2829 203e 2073 7461   if time() > sta
-00032f60: 7274 202b 2074 696d 656f 7574 3a0a 2020  rt + timeout:.  
-00032f70: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00032f80: 6973 6520 5469 6d65 6f75 7445 7272 6f72  ise TimeoutError
-00032f90: 2822 4e6f 2076 616c 6964 2077 6f72 6b65  ("No valid worke
-00032fa0: 7273 2066 6f75 6e64 2229 0a20 2020 2020  rs found").     
-00032fb0: 2020 2020 2020 2061 7761 6974 2061 7379         await asy
-00032fc0: 6e63 696f 2e73 6c65 6570 2830 2e31 290a  ncio.sleep(0.1).
-00032fd0: 0a20 2020 2020 2020 206e 7468 7265 6164  .        nthread
-00032fe0: 7320 3d20 7b77 732e 6164 6472 6573 733a  s = {ws.address:
-00032ff0: 2077 732e 6e74 6872 6561 6473 2066 6f72   ws.nthreads for
-00033000: 2077 7320 696e 2077 7373 7d0a 0a20 2020   ws in wss}..   
-00033010: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
-00033020: 7374 616e 6365 2864 6174 612c 2064 6963  stance(data, dic
-00033030: 7429 0a0a 2020 2020 2020 2020 6b65 7973  t)..        keys
-00033040: 2c20 7768 6f5f 6861 732c 206e 6279 7465  , who_has, nbyte
-00033050: 7320 3d20 6177 6169 7420 7363 6174 7465  s = await scatte
-00033060: 725f 746f 5f77 6f72 6b65 7273 286e 7468  r_to_workers(nth
-00033070: 7265 6164 732c 2064 6174 612c 2072 7063  reads, data, rpc
-00033080: 3d73 656c 662e 7270 6329 0a0a 2020 2020  =self.rpc)..    
-00033090: 2020 2020 7365 6c66 2e75 7064 6174 655f      self.update_
-000330a0: 6461 7461 2877 686f 5f68 6173 3d77 686f  data(who_has=who
-000330b0: 5f68 6173 2c20 6e62 7974 6573 3d6e 6279  _has, nbytes=nby
-000330c0: 7465 732c 2063 6c69 656e 743d 636c 6965  tes, client=clie
-000330d0: 6e74 290a 0a20 2020 2020 2020 2069 6620  nt)..        if 
-000330e0: 6272 6f61 6463 6173 743a 0a20 2020 2020  broadcast:.     
-000330f0: 2020 2020 2020 206e 203d 206c 656e 286e         n = len(n
-00033100: 7468 7265 6164 7329 2069 6620 6272 6f61  threads) if broa
-00033110: 6463 6173 7420 6973 2054 7275 6520 656c  dcast is True el
-00033120: 7365 2062 726f 6164 6361 7374 0a20 2020  se broadcast.   
-00033130: 2020 2020 2020 2020 2061 7761 6974 2073           await s
-00033140: 656c 662e 7265 706c 6963 6174 6528 6b65  elf.replicate(ke
-00033150: 7973 3d6b 6579 732c 2077 6f72 6b65 7273  ys=keys, workers
-00033160: 3d77 6f72 6b65 7273 2c20 6e3d 6e29 0a0a  =workers, n=n)..
-00033170: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-00033180: 5f65 7665 6e74 280a 2020 2020 2020 2020  _event(.        
-00033190: 2020 2020 5b63 6c69 656e 742c 2022 616c      [client, "al
-000331a0: 6c22 5d2c 207b 2261 6374 696f 6e22 3a20  l"], {"action": 
-000331b0: 2273 6361 7474 6572 222c 2022 636c 6965  "scatter", "clie
-000331c0: 6e74 223a 2063 6c69 656e 742c 2022 636f  nt": client, "co
-000331d0: 756e 7422 3a20 6c65 6e28 6461 7461 297d  unt": len(data)}
-000331e0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-000331f0: 2020 2072 6574 7572 6e20 6b65 7973 0a0a     return keys..
-00033200: 2020 2020 6173 796e 6320 6465 6620 6761      async def ga
-00033210: 7468 6572 2873 656c 662c 206b 6579 732c  ther(self, keys,
-00033220: 2073 6572 6961 6c69 7a65 7273 3d4e 6f6e   serializers=Non
-00033230: 6529 3a0a 2020 2020 2020 2020 2222 2243  e):.        """C
-00033240: 6f6c 6c65 6374 2064 6174 6120 6672 6f6d  ollect data from
-00033250: 2077 6f72 6b65 7273 2074 6f20 7468 6520   workers to the 
-00033260: 7363 6865 6475 6c65 7222 2222 0a20 2020  scheduler""".   
-00033270: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
-00033280: 203d 2066 2267 6174 6865 722d 7b74 696d   = f"gather-{tim
-00033290: 6528 297d 220a 2020 2020 2020 2020 6b65  e()}".        ke
-000332a0: 7973 203d 206c 6973 7428 6b65 7973 290a  ys = list(keys).
-000332b0: 2020 2020 2020 2020 7768 6f5f 6861 7320          who_has 
-000332c0: 3d20 7b7d 0a20 2020 2020 2020 2066 6f72  = {}.        for
-000332d0: 206b 6579 2069 6e20 6b65 7973 3a0a 2020   key in keys:.  
-000332e0: 2020 2020 2020 2020 2020 7473 3a20 5461            ts: Ta
-000332f0: 736b 5374 6174 6520 3d20 7365 6c66 2e74  skState = self.t
-00033300: 6173 6b73 2e67 6574 286b 6579 290a 2020  asks.get(key).  
-00033310: 2020 2020 2020 2020 2020 6966 2074 7320            if ts 
-00033320: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00033330: 2020 2020 2020 2020 2020 2020 2077 686f               who
-00033340: 5f68 6173 5b6b 6579 5d20 3d20 5b77 732e  _has[key] = [ws.
-00033350: 6164 6472 6573 7320 666f 7220 7773 2069  address for ws i
-00033360: 6e20 7473 2e77 686f 5f68 6173 5d0a 2020  n ts.who_has].  
-00033370: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00033380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033390: 7768 6f5f 6861 735b 6b65 795d 203d 205b  who_has[key] = [
-000333a0: 5d0a 0a20 2020 2020 2020 2064 6174 612c  ]..        data,
-000333b0: 206d 6973 7369 6e67 5f6b 6579 732c 206d   missing_keys, m
-000333c0: 6973 7369 6e67 5f77 6f72 6b65 7273 203d  issing_workers =
-000333d0: 2061 7761 6974 2067 6174 6865 725f 6672   await gather_fr
-000333e0: 6f6d 5f77 6f72 6b65 7273 280a 2020 2020  om_workers(.    
-000333f0: 2020 2020 2020 2020 7768 6f5f 6861 732c          who_has,
-00033400: 2072 7063 3d73 656c 662e 7270 632c 2063   rpc=self.rpc, c
-00033410: 6c6f 7365 3d46 616c 7365 2c20 7365 7269  lose=False, seri
-00033420: 616c 697a 6572 733d 7365 7269 616c 697a  alizers=serializ
-00033430: 6572 730a 2020 2020 2020 2020 290a 2020  ers.        ).  
-00033440: 2020 2020 2020 6966 206e 6f74 206d 6973        if not mis
-00033450: 7369 6e67 5f6b 6579 733a 0a20 2020 2020  sing_keys:.     
-00033460: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-00033470: 7b22 7374 6174 7573 223a 2022 4f4b 222c  {"status": "OK",
-00033480: 2022 6461 7461 223a 2064 6174 617d 0a20   "data": data}. 
-00033490: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000334a0: 2020 2020 2020 2020 206d 6973 7369 6e67           missing
-000334b0: 5f73 7461 7465 7320 3d20 5b0a 2020 2020  _states = [.    
-000334c0: 2020 2020 2020 2020 2020 2020 2873 656c              (sel
-000334d0: 662e 7461 736b 735b 6b65 795d 2e73 7461  f.tasks[key].sta
-000334e0: 7465 2069 6620 6b65 7920 696e 2073 656c  te if key in sel
-000334f0: 662e 7461 736b 7320 656c 7365 204e 6f6e  f.tasks else Non
-00033500: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00033510: 2020 2066 6f72 206b 6579 2069 6e20 6d69     for key in mi
-00033520: 7373 696e 675f 6b65 7973 0a20 2020 2020  ssing_keys.     
-00033530: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
-00033540: 2020 2020 206c 6f67 6765 722e 6578 6365       logger.exce
-00033550: 7074 696f 6e28 0a20 2020 2020 2020 2020  ption(.         
-00033560: 2020 2020 2020 2022 436f 756c 646e 2774         "Couldn't
-00033570: 2067 6174 6865 7220 6b65 7973 2025 7320   gather keys %s 
-00033580: 7374 6174 653a 2025 7320 776f 726b 6572  state: %s worker
-00033590: 733a 2025 7322 2c0a 2020 2020 2020 2020  s: %s",.        
-000335a0: 2020 2020 2020 2020 6d69 7373 696e 675f          missing_
-000335b0: 6b65 7973 2c0a 2020 2020 2020 2020 2020  keys,.          
-000335c0: 2020 2020 2020 6d69 7373 696e 675f 7374        missing_st
-000335d0: 6174 6573 2c0a 2020 2020 2020 2020 2020  ates,.          
-000335e0: 2020 2020 2020 6d69 7373 696e 675f 776f        missing_wo
-000335f0: 726b 6572 732c 0a20 2020 2020 2020 2020  rkers,.         
-00033600: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00033610: 2072 6573 756c 7420 3d20 7b22 7374 6174   result = {"stat
-00033620: 7573 223a 2022 6572 726f 7222 2c20 226b  us": "error", "k
-00033630: 6579 7322 3a20 6d69 7373 696e 675f 6b65  eys": missing_ke
-00033640: 7973 7d0a 2020 2020 2020 2020 2020 2020  ys}.            
-00033650: 7769 7468 206c 6f67 5f65 7272 6f72 7328  with log_errors(
-00033660: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00033670: 2020 2023 2052 656d 6f76 6520 7375 7370     # Remove susp
-00033680: 6963 696f 7573 2077 6f72 6b65 7273 2066  icious workers f
-00033690: 726f 6d20 7468 6520 7363 6865 6475 6c65  rom the schedule
-000336a0: 7220 616e 6420 7368 7574 2074 6865 6d20  r and shut them 
-000336b0: 646f 776e 2e0a 2020 2020 2020 2020 2020  down..          
-000336c0: 2020 2020 2020 6177 6169 7420 6173 796e        await asyn
-000336d0: 6369 6f2e 6761 7468 6572 280a 2020 2020  cio.gather(.    
-000336e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000336f0: 2a28 0a20 2020 2020 2020 2020 2020 2020  *(.             
-00033700: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00033710: 7265 6d6f 7665 5f77 6f72 6b65 7228 0a20  remove_worker(. 
-00033720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033730: 2020 2020 2020 2020 2020 2061 6464 7265             addre
-00033740: 7373 3d77 6f72 6b65 722c 2063 6c6f 7365  ss=worker, close
-00033750: 3d54 7275 652c 2073 7469 6d75 6c75 735f  =True, stimulus_
-00033760: 6964 3d73 7469 6d75 6c75 735f 6964 0a20  id=stimulus_id. 
-00033770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033780: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00033790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000337a0: 2066 6f72 2077 6f72 6b65 7220 696e 206d   for worker in m
-000337b0: 6973 7369 6e67 5f77 6f72 6b65 7273 0a20  issing_workers. 
-000337c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000337d0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-000337e0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-000337f0: 2020 2020 2020 2066 6f72 206b 6579 2c20         for key, 
-00033800: 776f 726b 6572 7320 696e 206d 6973 7369  workers in missi
-00033810: 6e67 5f6b 6579 732e 6974 656d 7328 293a  ng_keys.items():
-00033820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00033830: 2020 2020 206c 6f67 6765 722e 6578 6365       logger.exce
-00033840: 7074 696f 6e28 0a20 2020 2020 2020 2020  ption(.         
-00033850: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00033860: 5368 7574 2064 6f77 6e20 776f 726b 6572  Shut down worker
-00033870: 7320 7468 6174 2064 6f6e 2774 2068 6176  s that don't hav
-00033880: 6520 7072 6f6d 6973 6564 206b 6579 3a20  e promised key: 
-00033890: 2573 2c20 2573 222c 0a20 2020 2020 2020  %s, %s",.       
-000338a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000338b0: 2073 7472 2877 6f72 6b65 7273 292c 0a20   str(workers),. 
-000338c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000338d0: 2020 2020 2020 2073 7472 286b 6579 292c         str(key),
-000338e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000338f0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00033900: 7365 6c66 2e6c 6f67 5f65 7665 6e74 2822  self.log_event("
-00033910: 616c 6c22 2c20 7b22 6163 7469 6f6e 223a  all", {"action":
-00033920: 2022 6761 7468 6572 222c 2022 636f 756e   "gather", "coun
-00033930: 7422 3a20 6c65 6e28 6b65 7973 297d 290a  t": len(keys)}).
-00033940: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-00033950: 6573 756c 740a 0a20 2020 2040 6c6f 675f  esult..    @log_
-00033960: 6572 726f 7273 0a20 2020 2061 7379 6e63  errors.    async
-00033970: 2064 6566 2072 6573 7461 7274 2873 656c   def restart(sel
-00033980: 662c 2063 6c69 656e 743d 4e6f 6e65 2c20  f, client=None, 
-00033990: 7469 6d65 6f75 743d 3330 2c20 7761 6974  timeout=30, wait
-000339a0: 5f66 6f72 5f77 6f72 6b65 7273 3d54 7275  _for_workers=Tru
-000339b0: 6529 3a0a 2020 2020 2020 2020 2222 220a  e):.        """.
-000339c0: 2020 2020 2020 2020 5265 7374 6172 7420          Restart 
-000339d0: 616c 6c20 776f 726b 6572 732e 2052 6573  all workers. Res
-000339e0: 6574 206c 6f63 616c 2073 7461 7465 2e20  et local state. 
-000339f0: 4f70 7469 6f6e 616c 6c79 2077 6169 7420  Optionally wait 
-00033a00: 666f 7220 776f 726b 6572 7320 746f 2072  for workers to r
-00033a10: 6574 7572 6e2e 0a0a 2020 2020 2020 2020  eturn...        
-00033a20: 576f 726b 6572 7320 7769 7468 6f75 7420  Workers without 
-00033a30: 6e61 6e6e 6965 7320 6172 6520 7368 7574  nannies are shut
-00033a40: 2064 6f77 6e2c 2068 6f70 696e 6720 616e   down, hoping an
-00033a50: 2065 7874 6572 6e61 6c20 6465 706c 6f79   external deploy
-00033a60: 6d65 6e74 2073 7973 7465 6d0a 2020 2020  ment system.    
-00033a70: 2020 2020 7769 6c6c 2072 6573 7461 7274      will restart
-00033a80: 2074 6865 6d2e 2054 6865 7265 666f 7265   them. Therefore
-00033a90: 2c20 6966 206e 6f74 2075 7369 6e67 206e  , if not using n
-00033aa0: 616e 6e69 6573 2061 6e64 2079 6f75 7220  annies and your 
-00033ab0: 6465 706c 6f79 6d65 6e74 2073 7973 7465  deployment syste
-00033ac0: 6d0a 2020 2020 2020 2020 646f 6573 206e  m.        does n
-00033ad0: 6f74 2061 7574 6f6d 6174 6963 616c 6c79  ot automatically
-00033ae0: 2072 6573 7461 7274 2077 6f72 6b65 7273   restart workers
-00033af0: 2c20 6060 7265 7374 6172 7460 6020 7769  , ``restart`` wi
-00033b00: 6c6c 206a 7573 7420 7368 7574 2064 6f77  ll just shut dow
-00033b10: 6e20 616c 6c0a 2020 2020 2020 2020 776f  n all.        wo
-00033b20: 726b 6572 732c 2074 6865 6e20 7469 6d65  rkers, then time
-00033b30: 206f 7574 210a 0a20 2020 2020 2020 2041   out!..        A
-00033b40: 6674 6572 2060 6072 6573 7461 7274 6060  fter ``restart``
-00033b50: 2c20 616c 6c20 636f 6e6e 6563 7465 6420  , all connected 
-00033b60: 776f 726b 6572 7320 6172 6520 6e65 772c  workers are new,
-00033b70: 2072 6567 6172 646c 6573 7320 6f66 2077   regardless of w
-00033b80: 6865 7468 6572 2060 6054 696d 656f 7574  hether ``Timeout
-00033b90: 4572 726f 7260 600a 2020 2020 2020 2020  Error``.        
-00033ba0: 7761 7320 7261 6973 6564 2e20 416e 7920  was raised. Any 
-00033bb0: 776f 726b 6572 7320 7468 6174 2066 6169  workers that fai
-00033bc0: 6c65 6420 746f 2073 6875 7420 646f 776e  led to shut down
-00033bd0: 2069 6e20 7469 6d65 2061 7265 2072 656d   in time are rem
-00033be0: 6f76 6564 2c20 616e 640a 2020 2020 2020  oved, and.      
-00033bf0: 2020 6d61 7920 6f72 206d 6179 206e 6f74    may or may not
-00033c00: 2073 6875 7420 646f 776e 206f 6e20 7468   shut down on th
-00033c10: 6569 7220 6f77 6e20 696e 2074 6865 2066  eir own in the f
-00033c20: 7574 7572 652e 0a0a 2020 2020 2020 2020  uture...        
-00033c30: 5061 7261 6d65 7465 7273 0a20 2020 2020  Parameters.     
-00033c40: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-00033c50: 2020 2020 2020 7469 6d65 6f75 743a 0a20        timeout:. 
-00033c60: 2020 2020 2020 2020 2020 2048 6f77 206c             How l
-00033c70: 6f6e 6720 746f 2077 6169 7420 666f 7220  ong to wait for 
-00033c80: 776f 726b 6572 7320 746f 2073 6875 7420  workers to shut 
-00033c90: 646f 776e 2061 6e64 2063 6f6d 6520 6261  down and come ba
-00033ca0: 636b 2c20 6966 2060 6077 6169 745f 666f  ck, if ``wait_fo
-00033cb0: 725f 776f 726b 6572 7360 600a 2020 2020  r_workers``.    
-00033cc0: 2020 2020 2020 2020 6973 2054 7275 652c          is True,
-00033cd0: 206f 7468 6572 7769 7365 206a 7573 7420   otherwise just 
-00033ce0: 686f 7720 6c6f 6e67 2074 6f20 7761 6974  how long to wait
-00033cf0: 2066 6f72 2077 6f72 6b65 7273 2074 6f20   for workers to 
-00033d00: 7368 7574 2064 6f77 6e2e 0a20 2020 2020  shut down..     
-00033d10: 2020 2020 2020 2052 6169 7365 7320 6060         Raises ``
-00033d20: 6173 796e 6369 6f2e 5469 6d65 6f75 7445  asyncio.TimeoutE
-00033d30: 7272 6f72 6060 2069 6620 7468 6973 2069  rror`` if this i
-00033d40: 7320 6578 6365 6564 6564 2e0a 2020 2020  s exceeded..    
-00033d50: 2020 2020 7761 6974 5f66 6f72 5f77 6f72      wait_for_wor
-00033d60: 6b65 7273 3a0a 2020 2020 2020 2020 2020  kers:.          
-00033d70: 2020 5768 6574 6865 7220 746f 2077 6169    Whether to wai
-00033d80: 7420 666f 7220 616c 6c20 776f 726b 6572  t for all worker
-00033d90: 7320 746f 2072 6563 6f6e 6e65 6374 2c20  s to reconnect, 
-00033da0: 6f72 206a 7573 7420 666f 7220 7468 656d  or just for them
-00033db0: 2074 6f20 7368 7574 2064 6f77 6e0a 2020   to shut down.  
-00033dc0: 2020 2020 2020 2020 2020 2864 6566 6175            (defau
-00033dd0: 6c74 2054 7275 6529 2e20 5573 6520 6060  lt True). Use ``
-00033de0: 7265 7374 6172 7428 7761 6974 5f66 6f72  restart(wait_for
-00033df0: 5f77 6f72 6b65 7273 3d46 616c 7365 2960  _workers=False)`
-00033e00: 6020 636f 6d62 696e 6564 2077 6974 680a  ` combined with.
-00033e10: 2020 2020 2020 2020 2020 2020 3a6d 6574              :met
-00033e20: 683a 6043 6c69 656e 742e 7761 6974 5f66  h:`Client.wait_f
-00033e30: 6f72 5f77 6f72 6b65 7273 6020 666f 7220  or_workers` for 
-00033e40: 6772 616e 756c 6172 2063 6f6e 7472 6f6c  granular control
-00033e50: 206f 7665 7220 686f 7720 6d61 6e79 2077   over how many w
-00033e60: 6f72 6b65 7273 2074 6f0a 2020 2020 2020  orkers to.      
-00033e70: 2020 2020 2020 7761 6974 2066 6f72 2e0a        wait for..
-00033e80: 0a20 2020 2020 2020 2053 6565 2061 6c73  .        See als
-00033e90: 6f0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  o.        ------
-00033ea0: 2d2d 0a20 2020 2020 2020 2043 6c69 656e  --.        Clien
-00033eb0: 742e 7265 7374 6172 740a 2020 2020 2020  t.restart.      
-00033ec0: 2020 436c 6965 6e74 2e72 6573 7461 7274    Client.restart
-00033ed0: 5f77 6f72 6b65 7273 0a20 2020 2020 2020  _workers.       
-00033ee0: 2022 2222 0a20 2020 2020 2020 2073 7469   """.        sti
-00033ef0: 6d75 6c75 735f 6964 203d 2066 2272 6573  mulus_id = f"res
-00033f00: 7461 7274 2d7b 7469 6d65 2829 7d22 0a0a  tart-{time()}"..
-00033f10: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-00033f20: 6e66 6f28 2252 6573 7461 7274 696e 6720  nfo("Restarting 
-00033f30: 776f 726b 6572 7320 616e 6420 7265 6c65  workers and rele
-00033f40: 6173 696e 6720 616c 6c20 6b65 7973 2e22  asing all keys."
-00033f50: 290a 2020 2020 2020 2020 666f 7220 6373  ).        for cs
-00033f60: 2069 6e20 7365 6c66 2e63 6c69 656e 7473   in self.clients
-00033f70: 2e76 616c 7565 7328 293a 0a20 2020 2020  .values():.     
-00033f80: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-00033f90: 6e74 5f72 656c 6561 7365 735f 6b65 7973  nt_releases_keys
-00033fa0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00033fb0: 2020 6b65 7973 3d5b 7473 2e6b 6579 2066    keys=[ts.key f
-00033fc0: 6f72 2074 7320 696e 2063 732e 7761 6e74  or ts in cs.want
-00033fd0: 735f 7768 6174 5d2c 0a20 2020 2020 2020  s_what],.       
-00033fe0: 2020 2020 2020 2020 2063 6c69 656e 743d           client=
-00033ff0: 6373 2e63 6c69 656e 745f 6b65 792c 0a20  cs.client_key,. 
-00034000: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00034010: 7469 6d75 6c75 735f 6964 3d73 7469 6d75  timulus_id=stimu
-00034020: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
-00034030: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
-00034040: 656c 662e 5f63 6c65 6172 5f74 6173 6b5f  elf._clear_task_
-00034050: 7374 6174 6528 290a 2020 2020 2020 2020  state().        
-00034060: 6173 7365 7274 206e 6f74 2073 656c 662e  assert not self.
-00034070: 7461 736b 730a 2020 2020 2020 2020 7365  tasks.        se
-00034080: 6c66 2e72 6570 6f72 7428 7b22 6f70 223a  lf.report({"op":
-00034090: 2022 7265 7374 6172 7422 7d29 0a0a 2020   "restart"})..  
-000340a0: 2020 2020 2020 666f 7220 706c 7567 696e        for plugin
-000340b0: 2069 6e20 6c69 7374 2873 656c 662e 706c   in list(self.pl
-000340c0: 7567 696e 732e 7661 6c75 6573 2829 293a  ugins.values()):
-000340d0: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
-000340e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000340f0: 2020 706c 7567 696e 2e72 6573 7461 7274    plugin.restart
-00034100: 2873 656c 6629 0a20 2020 2020 2020 2020  (self).         
-00034110: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-00034120: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
-00034130: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00034140: 2e65 7863 6570 7469 6f6e 2865 290a 0a20  .exception(e).. 
-00034150: 2020 2020 2020 206e 5f77 6f72 6b65 7273         n_workers
-00034160: 203d 206c 656e 2873 656c 662e 776f 726b   = len(self.work
-00034170: 6572 7329 0a20 2020 2020 2020 206e 616e  ers).        nan
-00034180: 6e79 5f77 6f72 6b65 7273 203d 207b 0a20  ny_workers = {. 
-00034190: 2020 2020 2020 2020 2020 2061 6464 723a             addr:
-000341a0: 2077 732e 6e61 6e6e 7920 666f 7220 6164   ws.nanny for ad
-000341b0: 6472 2c20 7773 2069 6e20 7365 6c66 2e77  dr, ws in self.w
-000341c0: 6f72 6b65 7273 2e69 7465 6d73 2829 2069  orkers.items() i
-000341d0: 6620 7773 2e6e 616e 6e79 0a20 2020 2020  f ws.nanny.     
-000341e0: 2020 207d 0a20 2020 2020 2020 2023 2043     }.        # C
-000341f0: 6c6f 7365 206e 6f6e 2d4e 616e 6e79 2077  lose non-Nanny w
-00034200: 6f72 6b65 7273 2e20 5765 2068 6176 6520  orkers. We have 
-00034210: 6e6f 2077 6179 2074 6f20 7265 7374 6172  no way to restar
-00034220: 7420 7468 656d 2c20 736f 2077 6520 6a75  t them, so we ju
-00034230: 7374 206c 6574 2074 6865 6d20 676f 2c0a  st let them go,.
-00034240: 2020 2020 2020 2020 2320 616e 6420 6173          # and as
-00034250: 7375 6d65 2061 2064 6570 6c6f 796d 656e  sume a deploymen
-00034260: 7420 7379 7374 656d 2069 7320 676f 696e  t system is goin
-00034270: 6720 746f 2072 6573 7461 7274 2074 6865  g to restart the
-00034280: 6d20 666f 7220 7573 2e0a 2020 2020 2020  m for us..      
-00034290: 2020 6177 6169 7420 6173 796e 6369 6f2e    await asyncio.
-000342a0: 6761 7468 6572 280a 2020 2020 2020 2020  gather(.        
-000342b0: 2020 2020 2a28 0a20 2020 2020 2020 2020      *(.         
-000342c0: 2020 2020 2020 2073 656c 662e 7265 6d6f         self.remo
-000342d0: 7665 5f77 6f72 6b65 7228 6164 6472 6573  ve_worker(addres
-000342e0: 733d 6164 6472 2c20 7374 696d 756c 7573  s=addr, stimulus
-000342f0: 5f69 643d 7374 696d 756c 7573 5f69 6429  _id=stimulus_id)
-00034300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00034310: 2066 6f72 2061 6464 7220 696e 2073 656c   for addr in sel
-00034320: 662e 776f 726b 6572 730a 2020 2020 2020  f.workers.      
-00034330: 2020 2020 2020 2020 2020 6966 2061 6464            if add
-00034340: 7220 6e6f 7420 696e 206e 616e 6e79 5f77  r not in nanny_w
-00034350: 6f72 6b65 7273 0a20 2020 2020 2020 2020  orkers.         
-00034360: 2020 2029 0a20 2020 2020 2020 2029 0a0a     ).        )..
-00034370: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
-00034380: 6562 7567 2822 5365 6e64 206b 696c 6c20  ebug("Send kill 
-00034390: 7369 676e 616c 2074 6f20 6e61 6e6e 6965  signal to nannie
-000343a0: 733a 2025 7322 2c20 6e61 6e6e 795f 776f  s: %s", nanny_wo
-000343b0: 726b 6572 7329 0a20 2020 2020 2020 2061  rkers).        a
-000343c0: 7379 6e63 2077 6974 6820 636f 6e74 6578  sync with contex
-000343d0: 746c 6962 2e41 7379 6e63 4578 6974 5374  tlib.AsyncExitSt
-000343e0: 6163 6b28 2920 6173 2073 7461 636b 3a0a  ack() as stack:.
-000343f0: 2020 2020 2020 2020 2020 2020 6e61 6e6e              nann
-00034400: 6965 7320 3d20 6177 6169 7420 6173 796e  ies = await asyn
-00034410: 6369 6f2e 6761 7468 6572 280a 2020 2020  cio.gather(.    
-00034420: 2020 2020 2020 2020 2020 2020 2a28 0a20              *(. 
-00034430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034440: 2020 2073 7461 636b 2e65 6e74 6572 5f61     stack.enter_a
-00034450: 7379 6e63 5f63 6f6e 7465 7874 280a 2020  sync_context(.  
-00034460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034470: 2020 2020 2020 7270 6328 6e61 6e6e 795f        rpc(nanny_
-00034480: 6164 6472 6573 732c 2063 6f6e 6e65 6374  address, connect
-00034490: 696f 6e5f 6172 6773 3d73 656c 662e 636f  ion_args=self.co
-000344a0: 6e6e 6563 7469 6f6e 5f61 7267 7329 0a20  nnection_args). 
-000344b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000344c0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-000344d0: 2020 2020 2020 2020 2066 6f72 206e 616e           for nan
-000344e0: 6e79 5f61 6464 7265 7373 2069 6e20 6e61  ny_address in na
-000344f0: 6e6e 795f 776f 726b 6572 732e 7661 6c75  nny_workers.valu
-00034500: 6573 2829 0a20 2020 2020 2020 2020 2020  es().           
-00034510: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00034520: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-00034530: 2020 7374 6172 7420 3d20 6d6f 6e6f 746f    start = monoto
-00034540: 6e69 6328 290a 2020 2020 2020 2020 2020  nic().          
-00034550: 2020 7265 7370 7320 3d20 6177 6169 7420    resps = await 
-00034560: 6173 796e 6369 6f2e 6761 7468 6572 280a  asyncio.gather(.
-00034570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034580: 2a28 0a20 2020 2020 2020 2020 2020 2020  *(.             
-00034590: 2020 2020 2020 2077 6169 745f 666f 7228         wait_for(
-000345a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000345b0: 2020 2020 2020 2020 2023 2046 4958 4d45           # FIXME
-000345c0: 2064 6f65 7320 6e6f 7420 7261 6973 6520   does not raise 
-000345d0: 6966 2074 6865 2070 726f 6365 7373 2066  if the process f
-000345e0: 6169 6c73 2074 6f20 7368 7574 2064 6f77  ails to shut dow
-000345f0: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
-00034600: 2020 2020 2020 2020 2020 2023 2073 6565             # see
-00034610: 2068 7474 7073 3a2f 2f67 6974 6875 622e   https://github.
-00034620: 636f 6d2f 6461 736b 2f64 6973 7472 6962  com/dask/distrib
-00034630: 7574 6564 2f70 756c 6c2f 3634 3237 2f66  uted/pull/6427/f
-00034640: 696c 6573 2372 3839 3439 3137 3432 340a  iles#r894917424.
-00034650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034660: 2020 2020 2020 2020 2320 4e4f 5445 3a20          # NOTE: 
-00034670: 4e61 6e6e 7920 7769 6c6c 2061 7574 6f6d  Nanny will autom
-00034680: 6174 6963 616c 6c79 2072 6573 7461 7274  atically restart
-00034690: 2077 6f72 6b65 7220 7072 6f63 6573 7320   worker process 
-000346a0: 7768 656e 2069 7427 7320 6b69 6c6c 6564  when it's killed
-000346b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000346c0: 2020 2020 2020 2020 206e 616e 6e79 2e6b           nanny.k
-000346d0: 696c 6c28 0a20 2020 2020 2020 2020 2020  ill(.           
-000346e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000346f0: 2072 6561 736f 6e3d 2273 6368 6564 756c   reason="schedul
-00034700: 6572 2d72 6573 7461 7274 222c 0a20 2020  er-restart",.   
-00034710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034720: 2020 2020 2020 2020 2074 696d 656f 7574           timeout
-00034730: 3d74 696d 656f 7574 2c0a 2020 2020 2020  =timeout,.      
-00034740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034750: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
-00034760: 2020 2020 2020 2020 2020 2020 2074 696d               tim
-00034770: 656f 7574 2c0a 2020 2020 2020 2020 2020  eout,.          
-00034780: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00034790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000347a0: 666f 7220 6e61 6e6e 7920 696e 206e 616e  for nanny in nan
-000347b0: 6e69 6573 0a20 2020 2020 2020 2020 2020  nies.           
-000347c0: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
-000347d0: 2020 2020 2020 2020 7265 7475 726e 5f65          return_e
-000347e0: 7863 6570 7469 6f6e 733d 5472 7565 2c0a  xceptions=True,.
-000347f0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00034800: 2020 2020 2020 2020 2020 2320 4e4f 5445            # NOTE
-00034810: 3a20 7468 6520 6057 6f72 6b65 7253 7461  : the `WorkerSta
-00034820: 7465 6020 656e 7472 6965 7320 666f 7220  te` entries for 
-00034830: 7468 6573 6520 776f 726b 6572 7320 7769  these workers wi
-00034840: 6c6c 2062 6520 7265 6d6f 7665 640a 2020  ll be removed.  
-00034850: 2020 2020 2020 2020 2020 2320 6e61 7475            # natu
-00034860: 7261 6c6c 7920 7768 656e 2074 6865 7920  rally when they 
-00034870: 6469 7363 6f6e 6e65 6374 2066 726f 6d20  disconnect from 
-00034880: 7468 6520 7363 6865 6475 6c65 722e 0a0a  the scheduler...
-00034890: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
-000348a0: 6d6f 7665 2061 6e79 2077 6f72 6b65 7273  move any workers
-000348b0: 2074 6861 7420 6661 696c 6564 2074 6f20   that failed to 
-000348c0: 7368 7574 2064 6f77 6e2c 2073 6f20 7765  shut down, so we
-000348d0: 2063 616e 2067 7561 7261 6e74 6565 0a20   can guarantee. 
-000348e0: 2020 2020 2020 2020 2020 2023 2074 6861             # tha
-000348f0: 7420 6166 7465 7220 6072 6573 7461 7274  t after `restart
-00034900: 602c 2074 6865 7265 2061 7265 206e 6f20  `, there are no 
-00034910: 6f6c 6420 776f 726b 6572 7320 6172 6f75  old workers arou
-00034920: 6e64 2e0a 2020 2020 2020 2020 2020 2020  nd..            
-00034930: 6261 645f 6e61 6e6e 6965 7320 3d20 5b0a  bad_nannies = [.
+0002bd90: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
+0002bda0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0002bdb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002bdc0: 2020 2020 2072 203d 2073 656c 662e 7472       r = self.tr
+0002bdd0: 616e 7369 7469 6f6e 280a 2020 2020 2020  ansition(.      
+0002bde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bdf0: 2020 6b2c 0a20 2020 2020 2020 2020 2020    k,.           
+0002be00: 2020 2020 2020 2020 2020 2020 2022 6572               "er
+0002be10: 7265 6422 2c0a 2020 2020 2020 2020 2020  red",.          
+0002be20: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+0002be30: 6365 7074 696f 6e3d 652c 0a20 2020 2020  ception=e,.     
+0002be40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002be50: 2020 2063 6175 7365 3d6b 2c0a 2020 2020     cause=k,.    
+0002be60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002be70: 2020 2020 7374 696d 756c 7573 5f69 643d      stimulus_id=
+0002be80: 7374 696d 756c 7573 5f69 642c 0a20 2020  stimulus_id,.   
+0002be90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bea0: 2020 2020 2077 6f72 6b65 723d 6164 6472       worker=addr
+0002beb0: 6573 732c 0a20 2020 2020 2020 2020 2020  ess,.           
+0002bec0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0002bed0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0002bee0: 6563 6f6d 6d65 6e64 6174 696f 6e73 2e75  ecommendations.u
+0002bef0: 7064 6174 6528 7229 0a20 2020 2020 2020  pdate(r).       
+0002bf00: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+0002bf10: 6765 722e 696e 666f 280a 2020 2020 2020  ger.info(.      
+0002bf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bf30: 2020 2254 6173 6b20 2573 206d 6172 6b65    "Task %s marke
+0002bf40: 6420 6173 2066 6169 6c65 6420 6265 6361  d as failed beca
+0002bf50: 7573 6520 2564 2077 6f72 6b65 7273 2064  use %d workers d
+0002bf60: 6965 6422 0a20 2020 2020 2020 2020 2020  ied".           
+0002bf70: 2020 2020 2020 2020 2020 2020 2022 2077               " w
+0002bf80: 6869 6c65 2074 7279 696e 6720 746f 2072  hile trying to r
+0002bf90: 756e 2069 7422 2c0a 2020 2020 2020 2020  un it",.        
+0002bfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bfb0: 7473 2e6b 6579 2c0a 2020 2020 2020 2020  ts.key,.        
+0002bfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bfd0: 7365 6c66 2e61 6c6c 6f77 6564 5f66 6169  self.allowed_fai
+0002bfe0: 6c75 7265 732c 0a20 2020 2020 2020 2020  lures,.         
+0002bff0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+0002c000: 2020 2020 2020 666f 7220 7473 2069 6e20        for ts in 
+0002c010: 6c69 7374 2877 732e 6861 735f 7768 6174  list(ws.has_what
+0002c020: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+0002c030: 656c 662e 7265 6d6f 7665 5f72 6570 6c69  elf.remove_repli
+0002c040: 6361 2874 732c 2077 7329 0a20 2020 2020  ca(ts, ws).     
+0002c050: 2020 2020 2020 2069 6620 6e6f 7420 7473         if not ts
+0002c060: 2e77 686f 5f68 6173 3a0a 2020 2020 2020  .who_has:.      
+0002c070: 2020 2020 2020 2020 2020 6966 2074 732e            if ts.
+0002c080: 7275 6e5f 7370 6563 3a0a 2020 2020 2020  run_spec:.      
+0002c090: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0002c0a0: 636f 6d6d 656e 6461 7469 6f6e 735b 7473  commendations[ts
+0002c0b0: 2e6b 6579 5d20 3d20 2272 656c 6561 7365  .key] = "release
+0002c0c0: 6422 0a20 2020 2020 2020 2020 2020 2020  d".             
+0002c0d0: 2020 2065 6c73 653a 2020 2320 7075 7265     else:  # pure
+0002c0e0: 2064 6174 610a 2020 2020 2020 2020 2020   data.          
+0002c0f0: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
+0002c100: 656e 6461 7469 6f6e 735b 7473 2e6b 6579  endations[ts.key
+0002c110: 5d20 3d20 2266 6f72 676f 7474 656e 220a  ] = "forgotten".
+0002c120: 0a20 2020 2020 2020 2073 656c 662e 7472  .        self.tr
+0002c130: 616e 7369 7469 6f6e 7328 7265 636f 6d6d  ansitions(recomm
+0002c140: 656e 6461 7469 6f6e 732c 2073 7469 6d75  endations, stimu
+0002c150: 6c75 735f 6964 3d73 7469 6d75 6c75 735f  lus_id=stimulus_
+0002c160: 6964 290a 0a20 2020 2020 2020 2061 7761  id)..        awa
+0002c170: 6974 6162 6c65 7320 3d20 5b5d 0a20 2020  itables = [].   
+0002c180: 2020 2020 2066 6f72 2070 6c75 6769 6e20       for plugin 
+0002c190: 696e 206c 6973 7428 7365 6c66 2e70 6c75  in list(self.plu
+0002c1a0: 6769 6e73 2e76 616c 7565 7328 2929 3a0a  gins.values()):.
+0002c1b0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+0002c1c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002c1d0: 2072 6573 756c 7420 3d20 706c 7567 696e   result = plugin
+0002c1e0: 2e72 656d 6f76 655f 776f 726b 6572 2873  .remove_worker(s
+0002c1f0: 6368 6564 756c 6572 3d73 656c 662c 2077  cheduler=self, w
+0002c200: 6f72 6b65 723d 6164 6472 6573 7329 0a20  orker=address). 
+0002c210: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0002c220: 6620 696e 7370 6563 742e 6973 6177 6169  f inspect.isawai
+0002c230: 7461 626c 6528 7265 7375 6c74 293a 0a20  table(result):. 
+0002c240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c250: 2020 2061 7761 6974 6162 6c65 732e 6170     awaitables.ap
+0002c260: 7065 6e64 2872 6573 756c 7429 0a20 2020  pend(result).   
+0002c270: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+0002c280: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
+0002c290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c2a0: 6c6f 6767 6572 2e65 7863 6570 7469 6f6e  logger.exception
+0002c2b0: 2865 290a 0a20 2020 2020 2020 2070 6c75  (e)..        plu
+0002c2c0: 6769 6e5f 6d73 6773 203d 2061 7761 6974  gin_msgs = await
+0002c2d0: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
+0002c2e0: 2a61 7761 6974 6162 6c65 732c 2072 6574  *awaitables, ret
+0002c2f0: 7572 6e5f 6578 6365 7074 696f 6e73 3d54  urn_exceptions=T
+0002c300: 7275 6529 0a20 2020 2020 2020 2070 6c75  rue).        plu
+0002c310: 6769 6e73 5f65 7863 6570 7469 6f6e 7320  gins_exceptions 
+0002c320: 3d20 5b6d 7367 2066 6f72 206d 7367 2069  = [msg for msg i
+0002c330: 6e20 706c 7567 696e 5f6d 7367 7320 6966  n plugin_msgs if
+0002c340: 2069 7369 6e73 7461 6e63 6528 6d73 672c   isinstance(msg,
+0002c350: 2045 7863 6570 7469 6f6e 295d 0a20 2020   Exception)].   
+0002c360: 2020 2020 2066 6f72 2065 7863 2069 6e20       for exc in 
+0002c370: 706c 7567 696e 735f 6578 6365 7074 696f  plugins_exceptio
+0002c380: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+0002c390: 6c6f 6767 6572 2e65 7863 6570 7469 6f6e  logger.exception
+0002c3a0: 2865 7863 2c20 6578 635f 696e 666f 3d65  (exc, exc_info=e
+0002c3b0: 7863 290a 0a20 2020 2020 2020 2069 6620  xc)..        if 
+0002c3c0: 6e6f 7420 7365 6c66 2e77 6f72 6b65 7273  not self.workers
+0002c3d0: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
+0002c3e0: 6767 6572 2e69 6e66 6f28 224c 6f73 7420  gger.info("Lost 
+0002c3f0: 616c 6c20 776f 726b 6572 7322 290a 0a20  all workers").. 
+0002c400: 2020 2020 2020 2066 6f72 2077 2069 6e20         for w in 
+0002c410: 7365 6c66 2e77 6f72 6b65 7273 3a0a 2020  self.workers:.  
+0002c420: 2020 2020 2020 2020 2020 7365 6c66 2e62            self.b
+0002c430: 616e 6477 6964 7468 5f77 6f72 6b65 7273  andwidth_workers
+0002c440: 2e70 6f70 2828 6164 6472 6573 732c 2077  .pop((address, w
+0002c450: 292c 204e 6f6e 6529 0a20 2020 2020 2020  ), None).       
+0002c460: 2020 2020 2073 656c 662e 6261 6e64 7769       self.bandwi
+0002c470: 6474 685f 776f 726b 6572 732e 706f 7028  dth_workers.pop(
+0002c480: 2877 2c20 6164 6472 6573 7329 2c20 4e6f  (w, address), No
+0002c490: 6e65 290a 0a20 2020 2020 2020 2061 7379  ne)..        asy
+0002c4a0: 6e63 2064 6566 2072 656d 6f76 655f 776f  nc def remove_wo
+0002c4b0: 726b 6572 5f66 726f 6d5f 6576 656e 7473  rker_from_events
+0002c4c0: 2829 202d 3e20 4e6f 6e65 3a0a 2020 2020  () -> None:.    
+0002c4d0: 2020 2020 2020 2020 2320 4966 2074 6865          # If the
+0002c4e0: 2077 6f72 6b65 7220 6973 6e27 7420 7265   worker isn't re
+0002c4f0: 6769 7374 6572 6564 2061 6e79 6d6f 7265  gistered anymore
+0002c500: 2061 6674 6572 2074 6865 2064 656c 6179   after the delay
+0002c510: 2c20 7265 6d6f 7665 2066 726f 6d20 6576  , remove from ev
+0002c520: 656e 7473 0a20 2020 2020 2020 2020 2020  ents.           
+0002c530: 2069 6620 6164 6472 6573 7320 6e6f 7420   if address not 
+0002c540: 696e 2073 656c 662e 776f 726b 6572 7320  in self.workers 
+0002c550: 616e 6420 6164 6472 6573 7320 696e 2073  and address in s
+0002c560: 656c 662e 6576 656e 7473 3a0a 2020 2020  elf.events:.    
+0002c570: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
+0002c580: 7365 6c66 2e65 7665 6e74 735b 6164 6472  self.events[addr
+0002c590: 6573 735d 0a0a 2020 2020 2020 2020 636c  ess]..        cl
+0002c5a0: 6561 6e75 705f 6465 6c61 7920 3d20 7061  eanup_delay = pa
+0002c5b0: 7273 655f 7469 6d65 6465 6c74 6128 0a20  rse_timedelta(. 
+0002c5c0: 2020 2020 2020 2020 2020 2064 6173 6b2e             dask.
+0002c5d0: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
+0002c5e0: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
+0002c5f0: 722e 6576 656e 7473 2d63 6c65 616e 7570  r.events-cleanup
+0002c600: 2d64 656c 6179 2229 0a20 2020 2020 2020  -delay").       
+0002c610: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
+0002c620: 2e5f 6f6e 676f 696e 675f 6261 636b 6772  ._ongoing_backgr
+0002c630: 6f75 6e64 5f74 6173 6b73 2e63 616c 6c5f  ound_tasks.call_
+0002c640: 6c61 7465 7228 0a20 2020 2020 2020 2020  later(.         
+0002c650: 2020 2063 6c65 616e 7570 5f64 656c 6179     cleanup_delay
+0002c660: 2c20 7265 6d6f 7665 5f77 6f72 6b65 725f  , remove_worker_
+0002c670: 6672 6f6d 5f65 7665 6e74 730a 2020 2020  from_events.    
+0002c680: 2020 2020 290a 2020 2020 2020 2020 6c6f      ).        lo
+0002c690: 6767 6572 2e64 6562 7567 2822 5265 6d6f  gger.debug("Remo
+0002c6a0: 7665 6420 776f 726b 6572 2025 7322 2c20  ved worker %s", 
+0002c6b0: 7773 290a 0a20 2020 2020 2020 2066 6f72  ws)..        for
+0002c6c0: 2077 2069 6e20 7365 6c66 2e77 6f72 6b65   w in self.worke
+0002c6d0: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
+0002c6e0: 7365 6c66 2e77 6f72 6b65 725f 7365 6e64  self.worker_send
+0002c6f0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002c700: 2020 772c 0a20 2020 2020 2020 2020 2020    w,.           
+0002c710: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0002c720: 2020 2020 2020 2020 2020 2022 6f70 223a             "op":
+0002c730: 2022 7265 6d6f 7665 2d77 6f72 6b65 7222   "remove-worker"
+0002c740: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002c750: 2020 2020 2020 2277 6f72 6b65 7222 3a20        "worker": 
+0002c760: 6164 6472 6573 732c 0a20 2020 2020 2020  address,.       
+0002c770: 2020 2020 2020 2020 2020 2020 2022 7374               "st
+0002c780: 696d 756c 7573 5f69 6422 3a20 7374 696d  imulus_id": stim
+0002c790: 756c 7573 5f69 642c 0a20 2020 2020 2020  ulus_id,.       
+0002c7a0: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
+0002c7b0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0002c7c0: 2020 2072 6574 7572 6e20 224f 4b22 0a0a     return "OK"..
+0002c7d0: 2020 2020 6465 6620 7374 696d 756c 7573      def stimulus
+0002c7e0: 5f63 616e 6365 6c28 0a20 2020 2020 2020  _cancel(.       
+0002c7f0: 2073 656c 662c 206b 6579 733a 2053 6571   self, keys: Seq
+0002c800: 7565 6e63 655b 7374 725d 2c20 636c 6965  uence[str], clie
+0002c810: 6e74 3a20 7374 722c 2066 6f72 6365 3a20  nt: str, force: 
+0002c820: 626f 6f6c 203d 2046 616c 7365 0a20 2020  bool = False.   
+0002c830: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
+0002c840: 2020 2020 2222 2253 746f 7020 6578 6563      """Stop exec
+0002c850: 7574 696f 6e20 6f6e 2061 206c 6973 7420  ution on a list 
+0002c860: 6f66 206b 6579 7322 2222 0a20 2020 2020  of keys""".     
+0002c870: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
+0002c880: 436c 6965 6e74 2025 7320 7265 7175 6573  Client %s reques
+0002c890: 7473 2074 6f20 6361 6e63 656c 2025 6420  ts to cancel %d 
+0002c8a0: 6b65 7973 222c 2063 6c69 656e 742c 206c  keys", client, l
+0002c8b0: 656e 286b 6579 7329 290a 2020 2020 2020  en(keys)).      
+0002c8c0: 2020 6966 2063 6c69 656e 743a 0a20 2020    if client:.   
+0002c8d0: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
+0002c8e0: 675f 6576 656e 7428 0a20 2020 2020 2020  g_event(.       
+0002c8f0: 2020 2020 2020 2020 2063 6c69 656e 742c           client,
+0002c900: 207b 2261 6374 696f 6e22 3a20 2263 616e   {"action": "can
+0002c910: 6365 6c22 2c20 2263 6f75 6e74 223a 206c  cel", "count": l
+0002c920: 656e 286b 6579 7329 2c20 2266 6f72 6365  en(keys), "force
+0002c930: 223a 2066 6f72 6365 7d0a 2020 2020 2020  ": force}.      
+0002c940: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0002c950: 6361 6e63 656c 6c65 645f 6b65 7973 203d  cancelled_keys =
+0002c960: 205b 5d0a 2020 2020 2020 2020 636c 6965   [].        clie
+0002c970: 6e74 7320 3d20 5b5d 0a20 2020 2020 2020  nts = [].       
+0002c980: 2066 6f72 206b 6579 2069 6e20 6b65 7973   for key in keys
+0002c990: 3a0a 2020 2020 2020 2020 2020 2020 7473  :.            ts
+0002c9a0: 3a20 5461 736b 5374 6174 6520 7c20 4e6f  : TaskState | No
+0002c9b0: 6e65 203d 2073 656c 662e 7461 736b 732e  ne = self.tasks.
+0002c9c0: 6765 7428 6b65 7929 0a20 2020 2020 2020  get(key).       
+0002c9d0: 2020 2020 2069 6620 6e6f 7420 7473 3a0a       if not ts:.
+0002c9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c9f0: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
+0002ca00: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0002ca10: 2020 2020 2020 2020 2020 6373 3a20 436c            cs: Cl
+0002ca20: 6965 6e74 5374 6174 6520 3d20 7365 6c66  ientState = self
+0002ca30: 2e63 6c69 656e 7473 5b63 6c69 656e 745d  .clients[client]
+0002ca40: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+0002ca50: 6570 7420 4b65 7945 7272 6f72 3a0a 2020  ept KeyError:.  
+0002ca60: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0002ca70: 7475 726e 0a0a 2020 2020 2020 2020 2020  turn..          
+0002ca80: 2020 6966 2066 6f72 6365 206f 7220 7473    if force or ts
+0002ca90: 2e77 686f 5f77 616e 7473 203d 3d20 7b63  .who_wants == {c
+0002caa0: 737d 3a20 2023 206e 6f20 6f6e 6520 656c  s}:  # no one el
+0002cab0: 7365 2077 616e 7473 2074 6869 7320 6b65  se wants this ke
+0002cac0: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
+0002cad0: 2020 6966 2074 732e 6465 7065 6e64 656e    if ts.dependen
+0002cae0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+0002caf0: 2020 2020 2020 2020 7365 6c66 2e73 7469          self.sti
+0002cb00: 6d75 6c75 735f 6361 6e63 656c 280a 2020  mulus_cancel(.  
+0002cb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cb20: 2020 2020 2020 5b64 7473 2e6b 6579 2066        [dts.key f
+0002cb30: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
+0002cb40: 656e 6465 6e74 735d 2c20 636c 6965 6e74  endents], client
+0002cb50: 2c20 666f 7263 653d 666f 7263 650a 2020  , force=force.  
+0002cb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cb70: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0002cb80: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+0002cb90: 2253 6368 6564 756c 6572 2063 616e 6365  "Scheduler cance
+0002cba0: 6c73 206b 6579 2025 732e 2020 466f 7263  ls key %s.  Forc
+0002cbb0: 653d 2573 222c 206b 6579 2c20 666f 7263  e=%s", key, forc
+0002cbc0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0002cbd0: 2020 2063 616e 6365 6c6c 6564 5f6b 6579     cancelled_key
+0002cbe0: 732e 6170 7065 6e64 286b 6579 290a 2020  s.append(key).  
+0002cbf0: 2020 2020 2020 2020 2020 636c 6965 6e74            client
+0002cc00: 732e 6578 7465 6e64 286c 6973 7428 7473  s.extend(list(ts
+0002cc10: 2e77 686f 5f77 616e 7473 2920 6966 2066  .who_wants) if f
+0002cc20: 6f72 6365 2065 6c73 6520 5b63 735d 290a  orce else [cs]).
+0002cc30: 2020 2020 2020 2020 666f 7220 6373 2069          for cs i
+0002cc40: 6e20 636c 6965 6e74 733a 0a20 2020 2020  n clients:.     
+0002cc50: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
+0002cc60: 6e74 5f72 656c 6561 7365 735f 6b65 7973  nt_releases_keys
+0002cc70: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002cc80: 2020 6b65 7973 3d63 616e 6365 6c6c 6564    keys=cancelled
+0002cc90: 5f6b 6579 732c 0a20 2020 2020 2020 2020  _keys,.         
+0002cca0: 2020 2020 2020 2063 6c69 656e 743d 6373         client=cs
+0002ccb0: 2e63 6c69 656e 745f 6b65 792c 0a20 2020  .client_key,.   
+0002ccc0: 2020 2020 2020 2020 2020 2020 2073 7469               sti
+0002ccd0: 6d75 6c75 735f 6964 3d66 2263 616e 6365  mulus_id=f"cance
+0002cce0: 6c2d 6b65 792d 7b74 696d 6528 297d 222c  l-key-{time()}",
+0002ccf0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0002cd00: 2020 2020 2020 2073 656c 662e 7265 706f         self.repo
+0002cd10: 7274 287b 226f 7022 3a20 2263 616e 6365  rt({"op": "cance
+0002cd20: 6c6c 6564 2d6b 6579 7322 2c20 226b 6579  lled-keys", "key
+0002cd30: 7322 3a20 6361 6e63 656c 6c65 645f 6b65  s": cancelled_ke
+0002cd40: 7973 7d29 0a0a 2020 2020 6465 6620 636c  ys})..    def cl
+0002cd50: 6965 6e74 5f64 6573 6972 6573 5f6b 6579  ient_desires_key
+0002cd60: 7328 7365 6c66 2c20 6b65 7973 3d4e 6f6e  s(self, keys=Non
+0002cd70: 652c 2063 6c69 656e 743d 4e6f 6e65 293a  e, client=None):
+0002cd80: 0a20 2020 2020 2020 2063 733a 2043 6c69  .        cs: Cli
+0002cd90: 656e 7453 7461 7465 203d 2073 656c 662e  entState = self.
+0002cda0: 636c 6965 6e74 732e 6765 7428 636c 6965  clients.get(clie
+0002cdb0: 6e74 290a 2020 2020 2020 2020 6966 2063  nt).        if c
+0002cdc0: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+0002cdd0: 2020 2020 2020 2023 2046 6f72 2070 7562         # For pub
+0002cde0: 6c69 7368 2c20 7175 6575 6573 2065 7463  lish, queues etc
+0002cdf0: 2e0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+0002ce00: 6c66 2e63 6c69 656e 7473 5b63 6c69 656e  lf.clients[clien
+0002ce10: 745d 203d 2063 7320 3d20 436c 6965 6e74  t] = cs = Client
+0002ce20: 5374 6174 6528 636c 6965 6e74 290a 2020  State(client).  
+0002ce30: 2020 2020 2020 666f 7220 6b20 696e 206b        for k in k
+0002ce40: 6579 733a 0a20 2020 2020 2020 2020 2020  eys:.           
+0002ce50: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
+0002ce60: 2e67 6574 286b 290a 2020 2020 2020 2020  .get(k).        
+0002ce70: 2020 2020 6966 2074 7320 6973 204e 6f6e      if ts is Non
+0002ce80: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0002ce90: 2020 2023 2046 6f72 2070 7562 6c69 7368     # For publish
+0002cea0: 2c20 7175 6575 6573 2065 7463 2e0a 2020  , queues etc..  
+0002ceb0: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+0002cec0: 203d 2073 656c 662e 6e65 775f 7461 736b   = self.new_task
+0002ced0: 286b 2c20 4e6f 6e65 2c20 2272 656c 6561  (k, None, "relea
+0002cee0: 7365 6422 290a 2020 2020 2020 2020 2020  sed").          
+0002cef0: 2020 7473 2e77 686f 5f77 616e 7473 2e61    ts.who_wants.a
+0002cf00: 6464 2863 7329 0a20 2020 2020 2020 2020  dd(cs).         
+0002cf10: 2020 2063 732e 7761 6e74 735f 7768 6174     cs.wants_what
+0002cf20: 2e61 6464 2874 7329 0a0a 2020 2020 2020  .add(ts)..      
+0002cf30: 2020 2020 2020 6966 2074 732e 7374 6174        if ts.stat
+0002cf40: 6520 696e 2028 226d 656d 6f72 7922 2c20  e in ("memory", 
+0002cf50: 2265 7272 6564 2229 3a0a 2020 2020 2020  "erred"):.      
+0002cf60: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
+0002cf70: 6570 6f72 745f 6f6e 5f6b 6579 2874 733d  eport_on_key(ts=
+0002cf80: 7473 2c20 636c 6965 6e74 3d63 6c69 656e  ts, client=clien
+0002cf90: 7429 0a0a 2020 2020 6465 6620 636c 6965  t)..    def clie
+0002cfa0: 6e74 5f72 656c 6561 7365 735f 6b65 7973  nt_releases_keys
+0002cfb0: 2873 656c 662c 206b 6579 733d 4e6f 6e65  (self, keys=None
+0002cfc0: 2c20 636c 6965 6e74 3d4e 6f6e 652c 2073  , client=None, s
+0002cfd0: 7469 6d75 6c75 735f 6964 3d4e 6f6e 6529  timulus_id=None)
+0002cfe0: 3a0a 2020 2020 2020 2020 2222 2252 656d  :.        """Rem
+0002cff0: 6f76 6520 6b65 7973 2066 726f 6d20 636c  ove keys from cl
+0002d000: 6965 6e74 2064 6573 6972 6564 206c 6973  ient desired lis
+0002d010: 7422 2222 0a20 2020 2020 2020 2073 7469  t""".        sti
+0002d020: 6d75 6c75 735f 6964 203d 2073 7469 6d75  mulus_id = stimu
+0002d030: 6c75 735f 6964 206f 7220 6622 636c 6965  lus_id or f"clie
+0002d040: 6e74 2d72 656c 6561 7365 732d 6b65 7973  nt-releases-keys
+0002d050: 2d7b 7469 6d65 2829 7d22 0a20 2020 2020  -{time()}".     
+0002d060: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
+0002d070: 616e 6365 286b 6579 732c 206c 6973 7429  ance(keys, list)
+0002d080: 3a0a 2020 2020 2020 2020 2020 2020 6b65  :.            ke
+0002d090: 7973 203d 206c 6973 7428 6b65 7973 290a  ys = list(keys).
+0002d0a0: 2020 2020 2020 2020 6373 203d 2073 656c          cs = sel
+0002d0b0: 662e 636c 6965 6e74 735b 636c 6965 6e74  f.clients[client
+0002d0c0: 5d0a 2020 2020 2020 2020 7265 636f 6d6d  ].        recomm
+0002d0d0: 656e 6461 7469 6f6e 733a 2052 6563 7320  endations: Recs 
+0002d0e0: 3d20 7b7d 0a0a 2020 2020 2020 2020 7365  = {}..        se
+0002d0f0: 6c66 2e5f 636c 6965 6e74 5f72 656c 6561  lf._client_relea
+0002d100: 7365 735f 6b65 7973 286b 6579 733d 6b65  ses_keys(keys=ke
+0002d110: 7973 2c20 6373 3d63 732c 2072 6563 6f6d  ys, cs=cs, recom
+0002d120: 6d65 6e64 6174 696f 6e73 3d72 6563 6f6d  mendations=recom
+0002d130: 6d65 6e64 6174 696f 6e73 290a 2020 2020  mendations).    
+0002d140: 2020 2020 7365 6c66 2e74 7261 6e73 6974      self.transit
+0002d150: 696f 6e73 2872 6563 6f6d 6d65 6e64 6174  ions(recommendat
+0002d160: 696f 6e73 2c20 7374 696d 756c 7573 5f69  ions, stimulus_i
+0002d170: 6429 0a0a 2020 2020 2020 2020 7365 6c66  d)..        self
+0002d180: 2e73 7469 6d75 6c75 735f 7175 6575 655f  .stimulus_queue_
+0002d190: 736c 6f74 735f 6d61 7962 655f 6f70 656e  slots_maybe_open
+0002d1a0: 6564 2873 7469 6d75 6c75 735f 6964 3d73  ed(stimulus_id=s
+0002d1b0: 7469 6d75 6c75 735f 6964 290a 0a20 2020  timulus_id)..   
+0002d1c0: 2064 6566 2063 6c69 656e 745f 6865 6172   def client_hear
+0002d1d0: 7462 6561 7428 7365 6c66 2c20 636c 6965  tbeat(self, clie
+0002d1e0: 6e74 3d4e 6f6e 6529 3a0a 2020 2020 2020  nt=None):.      
+0002d1f0: 2020 2222 2248 616e 646c 6520 6865 6172    """Handle hear
+0002d200: 7462 6561 7473 2066 726f 6d20 436c 6965  tbeats from Clie
+0002d210: 6e74 2222 220a 2020 2020 2020 2020 6373  nt""".        cs
+0002d220: 3a20 436c 6965 6e74 5374 6174 6520 3d20  : ClientState = 
+0002d230: 7365 6c66 2e63 6c69 656e 7473 5b63 6c69  self.clients[cli
+0002d240: 656e 745d 0a20 2020 2020 2020 2063 732e  ent].        cs.
+0002d250: 6c61 7374 5f73 6565 6e20 3d20 7469 6d65  last_seen = time
+0002d260: 2829 0a0a 2020 2020 2323 2323 2323 2323  ()..    ########
+0002d270: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
+0002d280: 2320 5461 736b 2056 616c 6964 6174 696f  # Task Validatio
+0002d290: 6e20 230a 2020 2020 2323 2323 2323 2323  n #.    ########
+0002d2a0: 2323 2323 2323 2323 2323 230a 0a20 2020  ###########..   
+0002d2b0: 2064 6566 2076 616c 6964 6174 655f 7265   def validate_re
+0002d2c0: 6c65 6173 6564 2873 656c 662c 206b 6579  leased(self, key
+0002d2d0: 3a20 7374 7229 202d 3e20 4e6f 6e65 3a0a  : str) -> None:.
+0002d2e0: 2020 2020 2020 2020 7473 3a20 5461 736b          ts: Task
+0002d2f0: 5374 6174 6520 3d20 7365 6c66 2e74 6173  State = self.tas
+0002d300: 6b73 5b6b 6579 5d0a 2020 2020 2020 2020  ks[key].        
+0002d310: 6173 7365 7274 2074 732e 7374 6174 6520  assert ts.state 
+0002d320: 3d3d 2022 7265 6c65 6173 6564 220a 2020  == "released".  
+0002d330: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+0002d340: 2074 732e 7761 6974 6572 730a 2020 2020   ts.waiters.    
+0002d350: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+0002d360: 732e 7761 6974 696e 675f 6f6e 0a20 2020  s.waiting_on.   
+0002d370: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+0002d380: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
+0002d390: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
+0002d3a0: 2e70 726f 6365 7373 696e 675f 6f6e 0a20  .processing_on. 
+0002d3b0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+0002d3c0: 7420 616e 7928 5b74 7320 696e 2064 7473  t any([ts in dts
+0002d3d0: 2e77 6169 7465 7273 2066 6f72 2064 7473  .waiters for dts
+0002d3e0: 2069 6e20 7473 2e64 6570 656e 6465 6e63   in ts.dependenc
+0002d3f0: 6965 735d 290a 2020 2020 2020 2020 6173  ies]).        as
+0002d400: 7365 7274 2074 7320 6e6f 7420 696e 2073  sert ts not in s
+0002d410: 656c 662e 756e 7275 6e6e 6162 6c65 0a20  elf.unrunnable. 
+0002d420: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+0002d430: 206e 6f74 2069 6e20 7365 6c66 2e71 7565   not in self.que
+0002d440: 7565 640a 0a20 2020 2064 6566 2076 616c  ued..    def val
+0002d450: 6964 6174 655f 7761 6974 696e 6728 7365  idate_waiting(se
+0002d460: 6c66 2c20 6b65 793a 2073 7472 2920 2d3e  lf, key: str) ->
+0002d470: 204e 6f6e 653a 0a20 2020 2020 2020 2074   None:.        t
+0002d480: 733a 2054 6173 6b53 7461 7465 203d 2073  s: TaskState = s
+0002d490: 656c 662e 7461 736b 735b 6b65 795d 0a20  elf.tasks[key]. 
+0002d4a0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+0002d4b0: 2e77 6169 7469 6e67 5f6f 6e0a 2020 2020  .waiting_on.    
+0002d4c0: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+0002d4d0: 732e 7768 6f5f 6861 730a 2020 2020 2020  s.who_has.      
+0002d4e0: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
+0002d4f0: 7072 6f63 6573 7369 6e67 5f6f 6e0a 2020  processing_on.  
+0002d500: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
+0002d510: 6e6f 7420 696e 2073 656c 662e 756e 7275  not in self.unru
+0002d520: 6e6e 6162 6c65 0a20 2020 2020 2020 2061  nnable.        a
+0002d530: 7373 6572 7420 7473 206e 6f74 2069 6e20  ssert ts not in 
+0002d540: 7365 6c66 2e71 7565 7565 640a 2020 2020  self.queued.    
+0002d550: 2020 2020 666f 7220 6474 7320 696e 2074      for dts in t
+0002d560: 732e 6465 7065 6e64 656e 6369 6573 3a0a  s.dependencies:.
+0002d570: 2020 2020 2020 2020 2020 2020 2320 5765              # We
+0002d580: 2061 7265 2077 6169 7469 6e67 206f 6e20   are waiting on 
+0002d590: 6120 6465 7065 6e64 656e 6379 2069 6666  a dependency iff
+0002d5a0: 2069 7427 7320 6e6f 7420 7374 6f72 6564   it's not stored
+0002d5b0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0002d5c0: 6572 7420 626f 6f6c 2864 7473 2e77 686f  ert bool(dts.who
+0002d5d0: 5f68 6173 2920 213d 2028 6474 7320 696e  _has) != (dts in
+0002d5e0: 2074 732e 7761 6974 696e 675f 6f6e 290a   ts.waiting_on).
+0002d5f0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0002d600: 7274 2074 7320 696e 2064 7473 2e77 6169  rt ts in dts.wai
+0002d610: 7465 7273 2020 2320 5858 5820 6576 656e  ters  # XXX even
+0002d620: 2069 6620 6474 732e 5f77 686f 5f68 6173   if dts._who_has
+0002d630: 3f0a 0a20 2020 2064 6566 2076 616c 6964  ?..    def valid
+0002d640: 6174 655f 7175 6575 6564 2873 656c 662c  ate_queued(self,
+0002d650: 206b 6579 3a20 7374 7229 202d 3e20 4e6f   key: str) -> No
+0002d660: 6e65 3a0a 2020 2020 2020 2020 7473 3a20  ne:.        ts: 
+0002d670: 5461 736b 5374 6174 6520 3d20 7365 6c66  TaskState = self
+0002d680: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
+0002d690: 2020 2020 6474 733a 2054 6173 6b53 7461      dts: TaskSta
+0002d6a0: 7465 0a20 2020 2020 2020 2061 7373 6572  te.        asser
+0002d6b0: 7420 7473 2069 6e20 7365 6c66 2e71 7565  t ts in self.que
+0002d6c0: 7565 640a 2020 2020 2020 2020 6173 7365  ued.        asse
+0002d6d0: 7274 206e 6f74 2074 732e 7761 6974 696e  rt not ts.waitin
+0002d6e0: 675f 6f6e 0a20 2020 2020 2020 2061 7373  g_on.        ass
+0002d6f0: 6572 7420 6e6f 7420 7473 2e77 686f 5f68  ert not ts.who_h
+0002d700: 6173 0a20 2020 2020 2020 2061 7373 6572  as.        asser
+0002d710: 7420 6e6f 7420 7473 2e70 726f 6365 7373  t not ts.process
+0002d720: 696e 675f 6f6e 0a20 2020 2020 2020 2061  ing_on.        a
+0002d730: 7373 6572 7420 6e6f 7420 280a 2020 2020  ssert not (.    
+0002d740: 2020 2020 2020 2020 7473 2e77 6f72 6b65          ts.worke
+0002d750: 725f 7265 7374 7269 6374 696f 6e73 206f  r_restrictions o
+0002d760: 7220 7473 2e68 6f73 745f 7265 7374 7269  r ts.host_restri
+0002d770: 6374 696f 6e73 206f 7220 7473 2e72 6573  ctions or ts.res
+0002d780: 6f75 7263 655f 7265 7374 7269 6374 696f  ource_restrictio
+0002d790: 6e73 0a20 2020 2020 2020 2029 0a20 2020  ns.        ).   
+0002d7a0: 2020 2020 2066 6f72 2064 7473 2069 6e20       for dts in 
+0002d7b0: 7473 2e64 6570 656e 6465 6e63 6965 733a  ts.dependencies:
+0002d7c0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0002d7d0: 6572 7420 6474 732e 7768 6f5f 6861 730a  ert dts.who_has.
+0002d7e0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0002d7f0: 7274 2074 7320 696e 2064 7473 2e77 6169  rt ts in dts.wai
+0002d800: 7465 7273 0a0a 2020 2020 6465 6620 7661  ters..    def va
+0002d810: 6c69 6461 7465 5f70 726f 6365 7373 696e  lidate_processin
+0002d820: 6728 7365 6c66 2c20 6b65 793a 2073 7472  g(self, key: str
+0002d830: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0002d840: 2020 2074 733a 2054 6173 6b53 7461 7465     ts: TaskState
+0002d850: 203d 2073 656c 662e 7461 736b 735b 6b65   = self.tasks[ke
+0002d860: 795d 0a20 2020 2020 2020 2064 7473 3a20  y].        dts: 
+0002d870: 5461 736b 5374 6174 650a 2020 2020 2020  TaskState.      
+0002d880: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
+0002d890: 7761 6974 696e 675f 6f6e 0a20 2020 2020  waiting_on.     
+0002d8a0: 2020 2077 7320 3d20 7473 2e70 726f 6365     ws = ts.proce
+0002d8b0: 7373 696e 675f 6f6e 0a20 2020 2020 2020  ssing_on.       
+0002d8c0: 2061 7373 6572 7420 7773 0a20 2020 2020   assert ws.     
+0002d8d0: 2020 2061 7373 6572 7420 7473 2069 6e20     assert ts in 
+0002d8e0: 7773 2e70 726f 6365 7373 696e 670a 2020  ws.processing.  
+0002d8f0: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+0002d900: 2074 732e 7768 6f5f 6861 730a 2020 2020   ts.who_has.    
+0002d910: 2020 2020 6173 7365 7274 2074 7320 6e6f      assert ts no
+0002d920: 7420 696e 2073 656c 662e 7175 6575 6564  t in self.queued
+0002d930: 0a20 2020 2020 2020 2066 6f72 2064 7473  .        for dts
+0002d940: 2069 6e20 7473 2e64 6570 656e 6465 6e63   in ts.dependenc
+0002d950: 6965 733a 0a20 2020 2020 2020 2020 2020  ies:.           
+0002d960: 2061 7373 6572 7420 6474 732e 7768 6f5f   assert dts.who_
+0002d970: 6861 730a 2020 2020 2020 2020 2020 2020  has.            
+0002d980: 6173 7365 7274 2074 7320 696e 2064 7473  assert ts in dts
+0002d990: 2e77 6169 7465 7273 0a0a 2020 2020 6465  .waiters..    de
+0002d9a0: 6620 7661 6c69 6461 7465 5f6d 656d 6f72  f validate_memor
+0002d9b0: 7928 7365 6c66 2c20 6b65 793a 2073 7472  y(self, key: str
+0002d9c0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0002d9d0: 2020 2074 733a 2054 6173 6b53 7461 7465     ts: TaskState
+0002d9e0: 203d 2073 656c 662e 7461 736b 735b 6b65   = self.tasks[ke
+0002d9f0: 795d 0a20 2020 2020 2020 2064 7473 3a20  y].        dts: 
+0002da00: 5461 736b 5374 6174 650a 2020 2020 2020  TaskState.      
+0002da10: 2020 6173 7365 7274 2074 732e 7768 6f5f    assert ts.who_
+0002da20: 6861 730a 2020 2020 2020 2020 6173 7365  has.        asse
+0002da30: 7274 2062 6f6f 6c28 7473 2069 6e20 7365  rt bool(ts in se
+0002da40: 6c66 2e72 6570 6c69 6361 7465 645f 7461  lf.replicated_ta
+0002da50: 736b 7329 203d 3d20 286c 656e 2874 732e  sks) == (len(ts.
+0002da60: 7768 6f5f 6861 7329 203e 2031 290a 2020  who_has) > 1).  
+0002da70: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+0002da80: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
+0002da90: 6e0a 2020 2020 2020 2020 6173 7365 7274  n.        assert
+0002daa0: 206e 6f74 2074 732e 7761 6974 696e 675f   not ts.waiting_
+0002dab0: 6f6e 0a20 2020 2020 2020 2061 7373 6572  on.        asser
+0002dac0: 7420 7473 206e 6f74 2069 6e20 7365 6c66  t ts not in self
+0002dad0: 2e75 6e72 756e 6e61 626c 650a 2020 2020  .unrunnable.    
+0002dae0: 2020 2020 6173 7365 7274 2074 7320 6e6f      assert ts no
+0002daf0: 7420 696e 2073 656c 662e 7175 6575 6564  t in self.queued
+0002db00: 0a20 2020 2020 2020 2066 6f72 2064 7473  .        for dts
+0002db10: 2069 6e20 7473 2e64 6570 656e 6465 6e74   in ts.dependent
+0002db20: 733a 0a20 2020 2020 2020 2020 2020 2061  s:.            a
+0002db30: 7373 6572 7420 2864 7473 2069 6e20 7473  ssert (dts in ts
+0002db40: 2e77 6169 7465 7273 2920 3d3d 2028 0a20  .waiters) == (. 
+0002db50: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0002db60: 7473 2e73 7461 7465 2069 6e20 2822 7761  ts.state in ("wa
+0002db70: 6974 696e 6722 2c20 2271 7565 7565 6422  iting", "queued"
+0002db80: 2c20 2270 726f 6365 7373 696e 6722 2c20  , "processing", 
+0002db90: 226e 6f2d 776f 726b 6572 2229 0a20 2020  "no-worker").   
+0002dba0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0002dbb0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+0002dbc0: 206e 6f74 2069 6e20 6474 732e 7761 6974   not in dts.wait
+0002dbd0: 696e 675f 6f6e 0a0a 2020 2020 6465 6620  ing_on..    def 
+0002dbe0: 7661 6c69 6461 7465 5f6e 6f5f 776f 726b  validate_no_work
+0002dbf0: 6572 2873 656c 662c 206b 6579 3a20 7374  er(self, key: st
+0002dc00: 7229 202d 3e20 4e6f 6e65 3a0a 2020 2020  r) -> None:.    
+0002dc10: 2020 2020 7473 3a20 5461 736b 5374 6174      ts: TaskStat
+0002dc20: 6520 3d20 7365 6c66 2e74 6173 6b73 5b6b  e = self.tasks[k
+0002dc30: 6579 5d0a 2020 2020 2020 2020 6173 7365  ey].        asse
+0002dc40: 7274 2074 7320 696e 2073 656c 662e 756e  rt ts in self.un
+0002dc50: 7275 6e6e 6162 6c65 0a20 2020 2020 2020  runnable.       
+0002dc60: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
+0002dc70: 6169 7469 6e67 5f6f 6e0a 2020 2020 2020  aiting_on.      
+0002dc80: 2020 6173 7365 7274 2074 7320 696e 2073    assert ts in s
+0002dc90: 656c 662e 756e 7275 6e6e 6162 6c65 0a20  elf.unrunnable. 
+0002dca0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+0002dcb0: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
+0002dcc0: 6f6e 0a20 2020 2020 2020 2061 7373 6572  on.        asser
+0002dcd0: 7420 6e6f 7420 7473 2e77 686f 5f68 6173  t not ts.who_has
+0002dce0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0002dcf0: 7473 206e 6f74 2069 6e20 7365 6c66 2e71  ts not in self.q
+0002dd00: 7565 7565 640a 2020 2020 2020 2020 666f  ueued.        fo
+0002dd10: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
+0002dd20: 6e64 656e 6369 6573 3a0a 2020 2020 2020  ndencies:.      
+0002dd30: 2020 2020 2020 6173 7365 7274 2064 7473        assert dts
+0002dd40: 2e77 686f 5f68 6173 0a0a 2020 2020 6465  .who_has..    de
+0002dd50: 6620 7661 6c69 6461 7465 5f65 7272 6564  f validate_erred
+0002dd60: 2873 656c 662c 206b 6579 3a20 7374 7229  (self, key: str)
+0002dd70: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0002dd80: 2020 7473 3a20 5461 736b 5374 6174 6520    ts: TaskState 
+0002dd90: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
+0002dda0: 5d0a 2020 2020 2020 2020 6173 7365 7274  ].        assert
+0002ddb0: 2074 732e 6578 6365 7074 696f 6e5f 626c   ts.exception_bl
+0002ddc0: 616d 650a 2020 2020 2020 2020 6173 7365  ame.        asse
+0002ddd0: 7274 206e 6f74 2074 732e 7768 6f5f 6861  rt not ts.who_ha
+0002dde0: 730a 2020 2020 2020 2020 6173 7365 7274  s.        assert
+0002ddf0: 2074 7320 6e6f 7420 696e 2073 656c 662e   ts not in self.
+0002de00: 7175 6575 6564 0a0a 2020 2020 6465 6620  queued..    def 
+0002de10: 7661 6c69 6461 7465 5f6b 6579 2873 656c  validate_key(sel
+0002de20: 662c 206b 6579 3a20 7374 722c 2074 733a  f, key: str, ts:
+0002de30: 2054 6173 6b53 7461 7465 207c 204e 6f6e   TaskState | Non
+0002de40: 6520 3d20 4e6f 6e65 2920 2d3e 204e 6f6e  e = None) -> Non
+0002de50: 653a 0a20 2020 2020 2020 2074 7279 3a0a  e:.        try:.
+0002de60: 2020 2020 2020 2020 2020 2020 6966 2074              if t
+0002de70: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+0002de80: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
+0002de90: 7365 6c66 2e74 6173 6b73 2e67 6574 286b  self.tasks.get(k
+0002dea0: 6579 290a 2020 2020 2020 2020 2020 2020  ey).            
+0002deb0: 6966 2074 7320 6973 204e 6f6e 653a 0a20  if ts is None:. 
+0002dec0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0002ded0: 6f67 6765 722e 6465 6275 6728 224b 6579  ogger.debug("Key
+0002dee0: 206c 6f73 743a 2025 7322 2c20 6b65 7929   lost: %s", key)
+0002def0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0002df00: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0002df10: 2020 2074 732e 7661 6c69 6461 7465 2829     ts.validate()
+0002df20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002df30: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0002df40: 2020 2020 2020 2020 2020 6675 6e63 203d            func =
+0002df50: 2067 6574 6174 7472 2873 656c 662c 2022   getattr(self, "
+0002df60: 7661 6c69 6461 7465 5f22 202b 2074 732e  validate_" + ts.
+0002df70: 7374 6174 652e 7265 706c 6163 6528 222d  state.replace("-
+0002df80: 222c 2022 5f22 2929 0a20 2020 2020 2020  ", "_")).       
+0002df90: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+0002dfa0: 4174 7472 6962 7574 6545 7272 6f72 3a0a  AttributeError:.
+0002dfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dfc0: 2020 2020 6c6f 6767 6572 2e65 7272 6f72      logger.error
+0002dfd0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002dfe0: 2020 2020 2020 2020 2020 2273 656c 662e            "self.
+0002dff0: 7661 6c69 6461 7465 5f25 7320 6e6f 7420  validate_%s not 
+0002e000: 666f 756e 6422 2c20 7473 2e73 7461 7465  found", ts.state
+0002e010: 2e72 6570 6c61 6365 2822 2d22 2c20 225f  .replace("-", "_
+0002e020: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+0002e030: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0002e040: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0002e050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e060: 2020 2066 756e 6328 6b65 7929 0a20 2020     func(key).   
+0002e070: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
+0002e080: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
+0002e090: 2020 2020 2020 2020 6c6f 6767 6572 2e65          logger.e
+0002e0a0: 7863 6570 7469 6f6e 2865 290a 2020 2020  xception(e).    
+0002e0b0: 2020 2020 2020 2020 6966 204c 4f47 5f50          if LOG_P
+0002e0c0: 4442 3a0a 2020 2020 2020 2020 2020 2020  DB:.            
+0002e0d0: 2020 2020 696d 706f 7274 2070 6462 0a0a      import pdb..
+0002e0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e0f0: 7064 622e 7365 745f 7472 6163 6528 290a  pdb.set_trace().
+0002e100: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0002e110: 650a 0a20 2020 2064 6566 2076 616c 6964  e..    def valid
+0002e120: 6174 655f 7374 6174 6528 7365 6c66 2c20  ate_state(self, 
+0002e130: 616c 6c6f 775f 6f76 6572 6c61 703a 2062  allow_overlap: b
+0002e140: 6f6f 6c20 3d20 4661 6c73 6529 202d 3e20  ool = False) -> 
+0002e150: 4e6f 6e65 3a0a 2020 2020 2020 2020 7661  None:.        va
+0002e160: 6c69 6461 7465 5f73 7461 7465 2873 656c  lidate_state(sel
+0002e170: 662e 7461 736b 732c 2073 656c 662e 776f  f.tasks, self.wo
+0002e180: 726b 6572 732c 2073 656c 662e 636c 6965  rkers, self.clie
+0002e190: 6e74 7329 0a0a 2020 2020 2020 2020 6966  nts)..        if
+0002e1a0: 206e 6f74 2028 7365 7428 7365 6c66 2e77   not (set(self.w
+0002e1b0: 6f72 6b65 7273 2920 3d3d 2073 6574 2873  orkers) == set(s
+0002e1c0: 656c 662e 7374 7265 616d 5f63 6f6d 6d73  elf.stream_comms
+0002e1d0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+0002e1e0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+0002e1f0: 2822 576f 726b 6572 7320 6e6f 7420 7468  ("Workers not th
+0002e200: 6520 7361 6d65 2069 6e20 616c 6c20 636f  e same in all co
+0002e210: 6c6c 6563 7469 6f6e 7322 290a 0a20 2020  llections")..   
+0002e220: 2020 2020 2061 7373 6572 7420 7365 6c66       assert self
+0002e230: 2e72 756e 6e69 6e67 2e69 7373 7570 6572  .running.issuper
+0002e240: 7365 7428 7365 6c66 2e69 646c 652e 7661  set(self.idle.va
+0002e250: 6c75 6573 2829 292c 2028 0a20 2020 2020  lues()), (.     
+0002e260: 2020 2020 2020 2073 656c 662e 7275 6e6e         self.runn
+0002e270: 696e 672e 636f 7079 2829 2c0a 2020 2020  ing.copy(),.    
+0002e280: 2020 2020 2020 2020 7365 7428 7365 6c66          set(self
+0002e290: 2e69 646c 652e 7661 6c75 6573 2829 292c  .idle.values()),
+0002e2a0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0002e2b0: 2020 2061 7373 6572 7420 7365 6c66 2e72     assert self.r
+0002e2c0: 756e 6e69 6e67 2e69 7373 7570 6572 7365  unning.issuperse
+0002e2d0: 7428 7365 6c66 2e69 646c 655f 7461 736b  t(self.idle_task
+0002e2e0: 5f63 6f75 6e74 292c 2028 0a20 2020 2020  _count), (.     
+0002e2f0: 2020 2020 2020 2073 656c 662e 7275 6e6e         self.runn
+0002e300: 696e 672e 636f 7079 2829 2c0a 2020 2020  ing.copy(),.    
+0002e310: 2020 2020 2020 2020 7365 6c66 2e69 646c          self.idl
+0002e320: 655f 7461 736b 5f63 6f75 6e74 2e63 6f70  e_task_count.cop
+0002e330: 7928 292c 0a20 2020 2020 2020 2029 0a20  y(),.        ). 
+0002e340: 2020 2020 2020 2061 7373 6572 7420 7365         assert se
+0002e350: 6c66 2e72 756e 6e69 6e67 2e69 7373 7570  lf.running.issup
+0002e360: 6572 7365 7428 7365 6c66 2e73 6174 7572  erset(self.satur
+0002e370: 6174 6564 292c 2028 0a20 2020 2020 2020  ated), (.       
+0002e380: 2020 2020 2073 656c 662e 7275 6e6e 696e       self.runnin
+0002e390: 672e 636f 7079 2829 2c0a 2020 2020 2020  g.copy(),.      
+0002e3a0: 2020 2020 2020 7365 6c66 2e73 6174 7572        self.satur
+0002e3b0: 6174 6564 2e63 6f70 7928 292c 0a20 2020  ated.copy(),.   
+0002e3c0: 2020 2020 2029 0a20 2020 2020 2020 2061       ).        a
+0002e3d0: 7373 6572 7420 7365 6c66 2e73 6174 7572  ssert self.satur
+0002e3e0: 6174 6564 2e69 7364 6973 6a6f 696e 7428  ated.isdisjoint(
+0002e3f0: 7365 6c66 2e69 646c 652e 7661 6c75 6573  self.idle.values
+0002e400: 2829 292c 2028 0a20 2020 2020 2020 2020  ()), (.         
+0002e410: 2020 2073 656c 662e 7361 7475 7261 7465     self.saturate
+0002e420: 642e 636f 7079 2829 2c0a 2020 2020 2020  d.copy(),.      
+0002e430: 2020 2020 2020 7365 7428 7365 6c66 2e69        set(self.i
+0002e440: 646c 652e 7661 6c75 6573 2829 292c 0a20  dle.values()),. 
+0002e450: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0002e460: 2020 7461 736b 5f70 7265 6669 785f 636f    task_prefix_co
+0002e470: 756e 7473 3a20 6465 6661 756c 7464 6963  unts: defaultdic
+0002e480: 745b 7374 722c 2069 6e74 5d20 3d20 6465  t[str, int] = de
+0002e490: 6661 756c 7464 6963 7428 696e 7429 0a20  faultdict(int). 
+0002e4a0: 2020 2020 2020 2066 6f72 2077 2c20 7773         for w, ws
+0002e4b0: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
+0002e4c0: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+0002e4d0: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
+0002e4e0: 6e73 7461 6e63 6528 772c 2073 7472 292c  nstance(w, str),
+0002e4f0: 2028 7479 7065 2877 292c 2077 290a 2020   (type(w), w).  
+0002e500: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0002e510: 2069 7369 6e73 7461 6e63 6528 7773 2c20   isinstance(ws, 
+0002e520: 576f 726b 6572 5374 6174 6529 2c20 2874  WorkerState), (t
+0002e530: 7970 6528 7773 292c 2077 7329 0a20 2020  ype(ws), ws).   
+0002e540: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0002e550: 7773 2e61 6464 7265 7373 203d 3d20 770a  ws.address == w.
+0002e560: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0002e570: 7773 2e73 7461 7475 7320 3d3d 2053 7461  ws.status == Sta
+0002e580: 7475 732e 7275 6e6e 696e 673a 0a20 2020  tus.running:.   
+0002e590: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+0002e5a0: 6572 7420 7773 2069 6e20 7365 6c66 2e72  ert ws in self.r
+0002e5b0: 756e 6e69 6e67 0a20 2020 2020 2020 2020  unning.         
+0002e5c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0002e5d0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0002e5e0: 7773 206e 6f74 2069 6e20 7365 6c66 2e72  ws not in self.r
+0002e5f0: 756e 6e69 6e67 0a20 2020 2020 2020 2020  unning.         
+0002e600: 2020 2020 2020 2061 7373 6572 7420 7773         assert ws
+0002e610: 2e61 6464 7265 7373 206e 6f74 2069 6e20  .address not in 
+0002e620: 7365 6c66 2e69 646c 650a 2020 2020 2020  self.idle.      
+0002e630: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0002e640: 2077 7320 6e6f 7420 696e 2073 656c 662e   ws not in self.
+0002e650: 7361 7475 7261 7465 640a 0a20 2020 2020  saturated..     
+0002e660: 2020 2020 2020 2061 7373 6572 7420 7773         assert ws
+0002e670: 2e6c 6f6e 675f 7275 6e6e 696e 672e 6973  .long_running.is
+0002e680: 7375 6273 6574 2877 732e 7072 6f63 6573  subset(ws.proces
+0002e690: 7369 6e67 290a 2020 2020 2020 2020 2020  sing).          
+0002e6a0: 2020 6966 206e 6f74 2077 732e 7072 6f63    if not ws.proc
+0002e6b0: 6573 7369 6e67 3a0a 2020 2020 2020 2020  essing:.        
+0002e6c0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+0002e6d0: 6f74 2077 732e 6f63 6375 7061 6e63 790a  ot ws.occupancy.
+0002e6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e6f0: 6966 2077 732e 7374 6174 7573 203d 3d20  if ws.status == 
+0002e700: 5374 6174 7573 2e72 756e 6e69 6e67 3a0a  Status.running:.
+0002e710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e720: 2020 2020 6173 7365 7274 2077 732e 6164      assert ws.ad
+0002e730: 6472 6573 7320 696e 2073 656c 662e 6964  dress in self.id
+0002e740: 6c65 0a20 2020 2020 2020 2020 2020 2061  le.            a
+0002e750: 7373 6572 7420 6e6f 7420 7773 2e6e 6565  ssert not ws.nee
+0002e760: 6473 5f77 6861 742e 6b65 7973 2829 2026  ds_what.keys() &
+0002e770: 2077 732e 6861 735f 7768 6174 0a20 2020   ws.has_what.   
+0002e780: 2020 2020 2020 2020 2061 6374 7561 6c5f           actual_
+0002e790: 6e65 6564 735f 7768 6174 3a20 6465 6661  needs_what: defa
+0002e7a0: 756c 7464 6963 745b 5461 736b 5374 6174  ultdict[TaskStat
+0002e7b0: 652c 2069 6e74 5d20 3d20 6465 6661 756c  e, int] = defaul
+0002e7c0: 7464 6963 7428 696e 7429 0a20 2020 2020  tdict(int).     
+0002e7d0: 2020 2020 2020 2066 6f72 2074 7320 696e         for ts in
+0002e7e0: 2077 732e 7072 6f63 6573 7369 6e67 3a0a   ws.processing:.
+0002e7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e800: 666f 7220 7473 7320 696e 2074 732e 6465  for tss in ts.de
+0002e810: 7065 6e64 656e 6369 6573 3a0a 2020 2020  pendencies:.    
+0002e820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e830: 6966 2074 7373 206e 6f74 2069 6e20 7773  if tss not in ws
+0002e840: 2e68 6173 5f77 6861 743a 0a20 2020 2020  .has_what:.     
+0002e850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e860: 2020 2061 6374 7561 6c5f 6e65 6564 735f     actual_needs_
+0002e870: 7768 6174 5b74 7373 5d20 2b3d 2031 0a20  what[tss] += 1. 
+0002e880: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0002e890: 7420 6163 7475 616c 5f6e 6565 6473 5f77  t actual_needs_w
+0002e8a0: 6861 7420 3d3d 2077 732e 6e65 6564 735f  hat == ws.needs_
+0002e8b0: 7768 6174 0a20 2020 2020 2020 2020 2020  what.           
+0002e8c0: 2061 7373 6572 7420 2877 732e 7374 6174   assert (ws.stat
+0002e8d0: 7573 203d 3d20 5374 6174 7573 2e72 756e  us == Status.run
+0002e8e0: 6e69 6e67 2920 3d3d 2028 7773 2069 6e20  ning) == (ws in 
+0002e8f0: 7365 6c66 2e72 756e 6e69 6e67 290a 2020  self.running).  
+0002e900: 2020 2020 2020 2020 2020 666f 7220 6e61            for na
+0002e910: 6d65 2c20 636f 756e 7420 696e 2077 732e  me, count in ws.
+0002e920: 7461 736b 5f70 7265 6669 785f 636f 756e  task_prefix_coun
+0002e930: 742e 6974 656d 7328 293a 0a20 2020 2020  t.items():.     
+0002e940: 2020 2020 2020 2020 2020 2074 6173 6b5f             task_
+0002e950: 7072 6566 6978 5f63 6f75 6e74 735b 6e61  prefix_counts[na
+0002e960: 6d65 5d20 2b3d 2063 6f75 6e74 0a0a 2020  me] += count..  
+0002e970: 2020 2020 2020 6173 7365 7274 2074 6173        assert tas
+0002e980: 6b5f 7072 6566 6978 5f63 6f75 6e74 732e  k_prefix_counts.
+0002e990: 6b65 7973 2829 203d 3d20 7365 6c66 2e5f  keys() == self._
+0002e9a0: 7461 736b 5f70 7265 6669 785f 636f 756e  task_prefix_coun
+0002e9b0: 745f 676c 6f62 616c 2e6b 6579 7328 290a  t_global.keys().
+0002e9c0: 2020 2020 2020 2020 666f 7220 6e61 6d65          for name
+0002e9d0: 2c20 676c 6f62 616c 5f63 6f75 6e74 2069  , global_count i
+0002e9e0: 6e20 7365 6c66 2e5f 7461 736b 5f70 7265  n self._task_pre
+0002e9f0: 6669 785f 636f 756e 745f 676c 6f62 616c  fix_count_global
+0002ea00: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+0002ea10: 2020 2020 2020 6173 7365 7274 2028 0a20        assert (. 
+0002ea20: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0002ea30: 6173 6b5f 7072 6566 6978 5f63 6f75 6e74  ask_prefix_count
+0002ea40: 735b 6e61 6d65 5d20 3d3d 2067 6c6f 6261  s[name] == globa
+0002ea50: 6c5f 636f 756e 740a 2020 2020 2020 2020  l_count.        
+0002ea60: 2020 2020 292c 2066 227b 6e61 6d65 7d3a      ), f"{name}:
+0002ea70: 207b 7461 736b 5f70 7265 6669 785f 636f   {task_prefix_co
+0002ea80: 756e 7473 5b6e 616d 655d 7d20 2877 7373  unts[name]} (wss
+0002ea90: 292c 207b 676c 6f62 616c 5f63 6f75 6e74  ), {global_count
+0002eaa0: 7d20 2867 6c6f 6261 6c29 220a 0a20 2020  } (global)"..   
+0002eab0: 2020 2020 2066 6f72 2077 7320 696e 2073       for ws in s
+0002eac0: 656c 662e 7275 6e6e 696e 673a 0a20 2020  elf.running:.   
+0002ead0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0002eae0: 7773 2e73 7461 7475 7320 3d3d 2053 7461  ws.status == Sta
+0002eaf0: 7475 732e 7275 6e6e 696e 670a 2020 2020  tus.running.    
+0002eb00: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
+0002eb10: 732e 6164 6472 6573 7320 696e 2073 656c  s.address in sel
+0002eb20: 662e 776f 726b 6572 730a 0a20 2020 2020  f.workers..     
+0002eb30: 2020 2066 6f72 206b 2c20 7473 2069 6e20     for k, ts in 
+0002eb40: 7365 6c66 2e74 6173 6b73 2e69 7465 6d73  self.tasks.items
+0002eb50: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+0002eb60: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+0002eb70: 6528 7473 2c20 5461 736b 5374 6174 6529  e(ts, TaskState)
+0002eb80: 2c20 2874 7970 6528 7473 292c 2074 7329  , (type(ts), ts)
+0002eb90: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0002eba0: 6572 7420 7473 2e6b 6579 203d 3d20 6b0a  ert ts.key == k.
+0002ebb0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0002ebc0: 7274 2062 6f6f 6c28 7473 2069 6e20 7365  rt bool(ts in se
+0002ebd0: 6c66 2e72 6570 6c69 6361 7465 645f 7461  lf.replicated_ta
+0002ebe0: 736b 7329 203d 3d20 286c 656e 2874 732e  sks) == (len(ts.
+0002ebf0: 7768 6f5f 6861 7329 203e 2031 290a 2020  who_has) > 1).  
+0002ec00: 2020 2020 2020 2020 2020 7365 6c66 2e76            self.v
+0002ec10: 616c 6964 6174 655f 6b65 7928 6b2c 2074  alidate_key(k, t
+0002ec20: 7329 0a0a 2020 2020 2020 2020 666f 7220  s)..        for 
+0002ec30: 7473 2069 6e20 7365 6c66 2e72 6570 6c69  ts in self.repli
+0002ec40: 6361 7465 645f 7461 736b 733a 0a20 2020  cated_tasks:.   
+0002ec50: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0002ec60: 7473 2e73 7461 7465 203d 3d20 226d 656d  ts.state == "mem
+0002ec70: 6f72 7922 0a20 2020 2020 2020 2020 2020  ory".           
+0002ec80: 2061 7373 6572 7420 7473 2e6b 6579 2069   assert ts.key i
+0002ec90: 6e20 7365 6c66 2e74 6173 6b73 0a0a 2020  n self.tasks..  
+0002eca0: 2020 2020 2020 666f 7220 632c 2063 7320        for c, cs 
+0002ecb0: 696e 2073 656c 662e 636c 6965 6e74 732e  in self.clients.
+0002ecc0: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+0002ecd0: 2020 2020 2023 2063 6c69 656e 743d 4e6f       # client=No
+0002ece0: 6e65 2069 7320 6f66 7465 6e20 7573 6564  ne is often used
+0002ecf0: 2069 6e20 7465 7374 732e 2e2e 0a20 2020   in tests....   
+0002ed00: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0002ed10: 6320 6973 204e 6f6e 6520 6f72 2074 7970  c is None or typ
+0002ed20: 6528 6329 203d 3d20 7374 722c 2028 7479  e(c) == str, (ty
+0002ed30: 7065 2863 292c 2063 290a 2020 2020 2020  pe(c), c).      
+0002ed40: 2020 2020 2020 6173 7365 7274 2074 7970        assert typ
+0002ed50: 6528 6373 2920 3d3d 2043 6c69 656e 7453  e(cs) == ClientS
+0002ed60: 7461 7465 2c20 2874 7970 6528 6373 292c  tate, (type(cs),
+0002ed70: 2063 7329 0a20 2020 2020 2020 2020 2020   cs).           
+0002ed80: 2061 7373 6572 7420 6373 2e63 6c69 656e   assert cs.clien
+0002ed90: 745f 6b65 7920 3d3d 2063 0a0a 2020 2020  t_key == c..    
+0002eda0: 2020 2020 6120 3d20 7b77 3a20 7773 2e6e      a = {w: ws.n
+0002edb0: 6279 7465 7320 666f 7220 772c 2077 7320  bytes for w, ws 
+0002edc0: 696e 2073 656c 662e 776f 726b 6572 732e  in self.workers.
+0002edd0: 6974 656d 7328 297d 0a20 2020 2020 2020  items()}.       
+0002ede0: 2062 203d 207b 0a20 2020 2020 2020 2020   b = {.         
+0002edf0: 2020 2077 3a20 7375 6d28 7473 2e67 6574     w: sum(ts.get
+0002ee00: 5f6e 6279 7465 7328 2920 666f 7220 7473  _nbytes() for ts
+0002ee10: 2069 6e20 7773 2e68 6173 5f77 6861 7429   in ws.has_what)
+0002ee20: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0002ee30: 2077 2c20 7773 2069 6e20 7365 6c66 2e77   w, ws in self.w
+0002ee40: 6f72 6b65 7273 2e69 7465 6d73 2829 0a20  orkers.items(). 
+0002ee50: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0002ee60: 2061 7373 6572 7420 6120 3d3d 2062 2c20   assert a == b, 
+0002ee70: 2861 2c20 6229 0a0a 2020 2020 2020 2020  (a, b)..        
+0002ee80: 6966 2073 656c 662e 7472 616e 7369 7469  if self.transiti
+0002ee90: 6f6e 5f63 6f75 6e74 6572 5f6d 6178 3a0a  on_counter_max:.
+0002eea0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0002eeb0: 7274 2073 656c 662e 7472 616e 7369 7469  rt self.transiti
+0002eec0: 6f6e 5f63 6f75 6e74 6572 203c 2073 656c  on_counter < sel
+0002eed0: 662e 7472 616e 7369 7469 6f6e 5f63 6f75  f.transition_cou
+0002eee0: 6e74 6572 5f6d 6178 0a0a 2020 2020 2323  nter_max..    ##
+0002eef0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0002ef00: 230a 2020 2020 2320 4d61 6e61 6765 204d  #.    # Manage M
+0002ef10: 6573 7361 6765 7320 230a 2020 2020 2323  essages #.    ##
+0002ef20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0002ef30: 230a 0a20 2020 2064 6566 2072 6570 6f72  #..    def repor
+0002ef40: 7428 0a20 2020 2020 2020 2073 656c 662c  t(.        self,
+0002ef50: 206d 7367 3a20 6469 6374 2c20 7473 3a20   msg: dict, ts: 
+0002ef60: 5461 736b 5374 6174 6520 7c20 4e6f 6e65  TaskState | None
+0002ef70: 203d 204e 6f6e 652c 2063 6c69 656e 743a   = None, client:
+0002ef80: 2073 7472 207c 204e 6f6e 6520 3d20 4e6f   str | None = No
+0002ef90: 6e65 0a20 2020 2029 202d 3e20 4e6f 6e65  ne.    ) -> None
+0002efa0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+0002efb0: 2020 2020 2020 5075 626c 6973 6820 7570        Publish up
+0002efc0: 6461 7465 7320 746f 2061 6c6c 206c 6973  dates to all lis
+0002efd0: 7465 6e69 6e67 2051 7565 7565 7320 616e  tening Queues an
+0002efe0: 6420 436f 6d6d 730a 0a20 2020 2020 2020  d Comms..       
+0002eff0: 2049 6620 7468 6520 6d65 7373 6167 6520   If the message 
+0002f000: 636f 6e74 6169 6e73 2061 206b 6579 2074  contains a key t
+0002f010: 6865 6e20 7765 206f 6e6c 7920 7365 6e64  hen we only send
+0002f020: 2074 6865 206d 6573 7361 6765 2074 6f20   the message to 
+0002f030: 7468 6f73 650a 2020 2020 2020 2020 636f  those.        co
+0002f040: 6d6d 7320 7468 6174 2063 6172 6520 6162  mms that care ab
+0002f050: 6f75 7420 7468 6520 6b65 792e 0a20 2020  out the key..   
+0002f060: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0002f070: 2069 6620 7473 2069 7320 4e6f 6e65 3a0a   if ts is None:.
+0002f080: 2020 2020 2020 2020 2020 2020 6d73 675f              msg_
+0002f090: 6b65 7920 3d20 6d73 672e 6765 7428 226b  key = msg.get("k
+0002f0a0: 6579 2229 0a20 2020 2020 2020 2020 2020  ey").           
+0002f0b0: 2069 6620 6d73 675f 6b65 7920 6973 206e   if msg_key is n
+0002f0c0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0002f0d0: 2020 2020 2020 2020 2074 6173 6b73 3a20           tasks: 
+0002f0e0: 6469 6374 203d 2073 656c 662e 7461 736b  dict = self.task
+0002f0f0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+0002f100: 2020 7473 203d 2074 6173 6b73 2e67 6574    ts = tasks.get
+0002f110: 286d 7367 5f6b 6579 290a 0a20 2020 2020  (msg_key)..     
+0002f120: 2020 2063 6c69 656e 745f 636f 6d6d 733a     client_comms:
+0002f130: 2064 6963 7420 3d20 7365 6c66 2e63 6c69   dict = self.cli
+0002f140: 656e 745f 636f 6d6d 730a 2020 2020 2020  ent_comms.      
+0002f150: 2020 6966 2074 7320 6973 204e 6f6e 653a    if ts is None:
+0002f160: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
+0002f170: 6f74 6966 7920 616c 6c20 636c 6965 6e74  otify all client
+0002f180: 730a 2020 2020 2020 2020 2020 2020 636c  s.            cl
+0002f190: 6965 6e74 5f6b 6579 7320 3d20 6c69 7374  ient_keys = list
+0002f1a0: 2863 6c69 656e 745f 636f 6d6d 7329 0a20  (client_comms). 
+0002f1b0: 2020 2020 2020 2065 6c69 6620 636c 6965         elif clie
+0002f1c0: 6e74 2069 7320 4e6f 6e65 3a0a 2020 2020  nt is None:.    
+0002f1d0: 2020 2020 2020 2020 2320 4e6f 7469 6679          # Notify
+0002f1e0: 2063 6c69 656e 7473 2069 6e74 6572 6573   clients interes
+0002f1f0: 7465 6420 696e 206b 6579 0a20 2020 2020  ted in key.     
+0002f200: 2020 2020 2020 2063 6c69 656e 745f 6b65         client_ke
+0002f210: 7973 203d 205b 6373 2e63 6c69 656e 745f  ys = [cs.client_
+0002f220: 6b65 7920 666f 7220 6373 2069 6e20 7473  key for cs in ts
+0002f230: 2e77 686f 5f77 616e 7473 5d0a 2020 2020  .who_wants].    
+0002f240: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0002f250: 2020 2020 2020 2320 4e6f 7469 6679 2063        # Notify c
+0002f260: 6c69 656e 7473 2069 6e74 6572 6573 7465  lients intereste
+0002f270: 6420 696e 206b 6579 2028 696e 636c 7564  d in key (includ
+0002f280: 696e 6720 6063 6c69 656e 7460 290a 2020  ing `client`).  
+0002f290: 2020 2020 2020 2020 2020 636c 6965 6e74            client
+0002f2a0: 5f6b 6579 7320 3d20 5b0a 2020 2020 2020  _keys = [.      
+0002f2b0: 2020 2020 2020 2020 2020 6373 2e63 6c69            cs.cli
+0002f2c0: 656e 745f 6b65 7920 666f 7220 6373 2069  ent_key for cs i
+0002f2d0: 6e20 7473 2e77 686f 5f77 616e 7473 2069  n ts.who_wants i
+0002f2e0: 6620 6373 2e63 6c69 656e 745f 6b65 7920  f cs.client_key 
+0002f2f0: 213d 2063 6c69 656e 740a 2020 2020 2020  != client.      
+0002f300: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+0002f310: 2020 2020 636c 6965 6e74 5f6b 6579 732e      client_keys.
+0002f320: 6170 7065 6e64 2863 6c69 656e 7429 0a0a  append(client)..
+0002f330: 2020 2020 2020 2020 6b3a 2073 7472 0a20          k: str. 
+0002f340: 2020 2020 2020 2066 6f72 206b 2069 6e20         for k in 
+0002f350: 636c 6965 6e74 5f6b 6579 733a 0a20 2020  client_keys:.   
+0002f360: 2020 2020 2020 2020 2063 203d 2063 6c69           c = cli
+0002f370: 656e 745f 636f 6d6d 732e 6765 7428 6b29  ent_comms.get(k)
+0002f380: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0002f390: 6320 6973 204e 6f6e 653a 0a20 2020 2020  c is None:.     
+0002f3a0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+0002f3b0: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
+0002f3c0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0002f3d0: 2020 2020 2063 2e73 656e 6428 6d73 6729       c.send(msg)
+0002f3e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f3f0: 2023 206c 6f67 6765 722e 6465 6275 6728   # logger.debug(
+0002f400: 2253 6368 6564 756c 6572 2073 656e 6473  "Scheduler sends
+0002f410: 206d 6573 7361 6765 2074 6f20 636c 6965   message to clie
+0002f420: 6e74 2025 7322 2c20 6d73 6729 0a20 2020  nt %s", msg).   
+0002f430: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+0002f440: 436f 6d6d 436c 6f73 6564 4572 726f 723a  CommClosedError:
+0002f450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f460: 2069 6620 7365 6c66 2e73 7461 7475 7320   if self.status 
+0002f470: 3d3d 2053 7461 7475 732e 7275 6e6e 696e  == Status.runnin
+0002f480: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
+0002f490: 2020 2020 2020 206c 6f67 6765 722e 6372         logger.cr
+0002f4a0: 6974 6963 616c 280a 2020 2020 2020 2020  itical(.        
+0002f4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f4c0: 2243 6c6f 7365 6420 636f 6d6d 2025 7220  "Closed comm %r 
+0002f4d0: 7768 696c 6520 7472 7969 6e67 2074 6f20  while trying to 
+0002f4e0: 7772 6974 6520 2573 222c 2063 2c20 6d73  write %s", c, ms
+0002f4f0: 672c 2065 7863 5f69 6e66 6f3d 5472 7565  g, exc_info=True
+0002f500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f510: 2020 2020 2029 0a0a 2020 2020 6173 796e       )..    asyn
+0002f520: 6320 6465 6620 6164 645f 636c 6965 6e74  c def add_client
+0002f530: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+0002f540: 636f 6d6d 3a20 436f 6d6d 2c20 636c 6965  comm: Comm, clie
+0002f550: 6e74 3a20 7374 722c 2076 6572 7369 6f6e  nt: str, version
+0002f560: 733a 2064 6963 745b 7374 722c 2041 6e79  s: dict[str, Any
+0002f570: 5d0a 2020 2020 2920 2d3e 204e 6f6e 653a  ].    ) -> None:
+0002f580: 0a20 2020 2020 2020 2022 2222 4164 6420  .        """Add 
+0002f590: 636c 6965 6e74 2074 6f20 6e65 7477 6f72  client to networ
+0002f5a0: 6b0a 0a20 2020 2020 2020 2057 6520 6c69  k..        We li
+0002f5b0: 7374 656e 2074 6f20 616c 6c20 6675 7475  sten to all futu
+0002f5c0: 7265 206d 6573 7361 6765 7320 6672 6f6d  re messages from
+0002f5d0: 2074 6869 7320 436f 6d6d 2e0a 2020 2020   this Comm..    
+0002f5e0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0002f5f0: 6173 7365 7274 2063 6c69 656e 7420 6973  assert client is
+0002f600: 206e 6f74 204e 6f6e 650a 2020 2020 2020   not None.      
+0002f610: 2020 636f 6d6d 2e6e 616d 6520 3d20 2253    comm.name = "S
+0002f620: 6368 6564 756c 6572 2d3e 436c 6965 6e74  cheduler->Client
+0002f630: 220a 2020 2020 2020 2020 6c6f 6767 6572  ".        logger
+0002f640: 2e69 6e66 6f28 2252 6563 6569 7665 2063  .info("Receive c
+0002f650: 6c69 656e 7420 636f 6e6e 6563 7469 6f6e  lient connection
+0002f660: 3a20 2573 222c 2063 6c69 656e 7429 0a20  : %s", client). 
+0002f670: 2020 2020 2020 2073 656c 662e 6c6f 675f         self.log_
+0002f680: 6576 656e 7428 5b22 616c 6c22 2c20 636c  event(["all", cl
+0002f690: 6965 6e74 5d2c 207b 2261 6374 696f 6e22  ient], {"action"
+0002f6a0: 3a20 2261 6464 2d63 6c69 656e 7422 2c20  : "add-client", 
+0002f6b0: 2263 6c69 656e 7422 3a20 636c 6965 6e74  "client": client
+0002f6c0: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
+0002f6d0: 636c 6965 6e74 735b 636c 6965 6e74 5d20  clients[client] 
+0002f6e0: 3d20 436c 6965 6e74 5374 6174 6528 636c  = ClientState(cl
+0002f6f0: 6965 6e74 2c20 7665 7273 696f 6e73 3d76  ient, versions=v
+0002f700: 6572 7369 6f6e 7329 0a0a 2020 2020 2020  ersions)..      
+0002f710: 2020 666f 7220 706c 7567 696e 2069 6e20    for plugin in 
+0002f720: 6c69 7374 2873 656c 662e 706c 7567 696e  list(self.plugin
+0002f730: 732e 7661 6c75 6573 2829 293a 0a20 2020  s.values()):.   
+0002f740: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+0002f750: 2020 2020 2020 2020 2020 2020 2020 706c                pl
+0002f760: 7567 696e 2e61 6464 5f63 6c69 656e 7428  ugin.add_client(
+0002f770: 7363 6865 6475 6c65 723d 7365 6c66 2c20  scheduler=self, 
+0002f780: 636c 6965 6e74 3d63 6c69 656e 7429 0a20  client=client). 
+0002f790: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0002f7a0: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+0002f7b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002f7c0: 2020 6c6f 6767 6572 2e65 7863 6570 7469    logger.excepti
+0002f7d0: 6f6e 2865 290a 0a20 2020 2020 2020 2074  on(e)..        t
+0002f7e0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0002f7f0: 6263 6f6d 6d20 3d20 4261 7463 6865 6453  bcomm = BatchedS
+0002f800: 656e 6428 696e 7465 7276 616c 3d22 326d  end(interval="2m
+0002f810: 7322 2c20 6c6f 6f70 3d73 656c 662e 6c6f  s", loop=self.lo
+0002f820: 6f70 290a 2020 2020 2020 2020 2020 2020  op).            
+0002f830: 6263 6f6d 6d2e 7374 6172 7428 636f 6d6d  bcomm.start(comm
+0002f840: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+0002f850: 6c66 2e63 6c69 656e 745f 636f 6d6d 735b  lf.client_comms[
+0002f860: 636c 6965 6e74 5d20 3d20 6263 6f6d 6d0a  client] = bcomm.
+0002f870: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
+0002f880: 3d20 7b22 6f70 223a 2022 7374 7265 616d  = {"op": "stream
+0002f890: 2d73 7461 7274 227d 0a20 2020 2020 2020  -start"}.       
+0002f8a0: 2020 2020 2076 6572 7369 6f6e 5f77 6172       version_war
+0002f8b0: 6e69 6e67 203d 2076 6572 7369 6f6e 5f6d  ning = version_m
+0002f8c0: 6f64 756c 652e 6572 726f 725f 6d65 7373  odule.error_mess
+0002f8d0: 6167 6528 0a20 2020 2020 2020 2020 2020  age(.           
+0002f8e0: 2020 2020 2076 6572 7369 6f6e 5f6d 6f64       version_mod
+0002f8f0: 756c 652e 6765 745f 7665 7273 696f 6e73  ule.get_versions
+0002f900: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
+0002f910: 2020 2020 7b77 3a20 7773 2e76 6572 7369      {w: ws.versi
+0002f920: 6f6e 7320 666f 7220 772c 2077 7320 696e  ons for w, ws in
+0002f930: 2073 656c 662e 776f 726b 6572 732e 6974   self.workers.it
+0002f940: 656d 7328 297d 2c0a 2020 2020 2020 2020  ems()},.        
+0002f950: 2020 2020 2020 2020 7665 7273 696f 6e73          versions
+0002f960: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+0002f970: 2020 2020 2020 2020 2020 2020 6d73 672e              msg.
+0002f980: 7570 6461 7465 2876 6572 7369 6f6e 5f77  update(version_w
+0002f990: 6172 6e69 6e67 290a 2020 2020 2020 2020  arning).        
+0002f9a0: 2020 2020 6263 6f6d 6d2e 7365 6e64 286d      bcomm.send(m
+0002f9b0: 7367 290a 0a20 2020 2020 2020 2020 2020  sg)..           
+0002f9c0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0002f9d0: 2020 2020 2020 6177 6169 7420 7365 6c66        await self
+0002f9e0: 2e68 616e 646c 655f 7374 7265 616d 2863  .handle_stream(c
+0002f9f0: 6f6d 6d3d 636f 6d6d 2c20 6578 7472 613d  omm=comm, extra=
+0002fa00: 7b22 636c 6965 6e74 223a 2063 6c69 656e  {"client": clien
+0002fa10: 747d 290a 2020 2020 2020 2020 2020 2020  t}).            
+0002fa20: 6669 6e61 6c6c 793a 0a20 2020 2020 2020  finally:.       
+0002fa30: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
+0002fa40: 6d6f 7665 5f63 6c69 656e 7428 636c 6965  move_client(clie
+0002fa50: 6e74 3d63 6c69 656e 742c 2073 7469 6d75  nt=client, stimu
+0002fa60: 6c75 735f 6964 3d66 2272 656d 6f76 652d  lus_id=f"remove-
+0002fa70: 636c 6965 6e74 2d7b 7469 6d65 2829 7d22  client-{time()}"
+0002fa80: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002fa90: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
+0002faa0: 4669 6e69 7368 6564 2068 616e 646c 696e  Finished handlin
+0002fab0: 6720 636c 6965 6e74 2025 7322 2c20 636c  g client %s", cl
+0002fac0: 6965 6e74 290a 2020 2020 2020 2020 6669  ient).        fi
+0002fad0: 6e61 6c6c 793a 0a20 2020 2020 2020 2020  nally:.         
+0002fae0: 2020 2069 6620 6e6f 7420 636f 6d6d 2e63     if not comm.c
+0002faf0: 6c6f 7365 6428 293a 0a20 2020 2020 2020  losed():.       
+0002fb00: 2020 2020 2020 2020 2073 656c 662e 636c           self.cl
+0002fb10: 6965 6e74 5f63 6f6d 6d73 5b63 6c69 656e  ient_comms[clien
+0002fb20: 745d 2e73 656e 6428 7b22 6f70 223a 2022  t].send({"op": "
+0002fb30: 7374 7265 616d 2d63 6c6f 7365 6422 7d29  stream-closed"})
+0002fb40: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
+0002fb50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002fb60: 2020 6966 206e 6f74 2073 7973 2e69 735f    if not sys.is_
+0002fb70: 6669 6e61 6c69 7a69 6e67 2829 3a0a 2020  finalizing():.  
+0002fb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fb90: 2020 6177 6169 7420 7365 6c66 2e63 6c69    await self.cli
+0002fba0: 656e 745f 636f 6d6d 735b 636c 6965 6e74  ent_comms[client
+0002fbb0: 5d2e 636c 6f73 6528 290a 2020 2020 2020  ].close().      
+0002fbc0: 2020 2020 2020 2020 2020 2020 2020 6465                de
+0002fbd0: 6c20 7365 6c66 2e63 6c69 656e 745f 636f  l self.client_co
+0002fbe0: 6d6d 735b 636c 6965 6e74 5d0a 2020 2020  mms[client].    
+0002fbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fc00: 6966 2073 656c 662e 7374 6174 7573 203d  if self.status =
+0002fc10: 3d20 5374 6174 7573 2e72 756e 6e69 6e67  = Status.running
+0002fc20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002fc30: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+0002fc40: 2e69 6e66 6f28 2243 6c6f 7365 2063 6c69  .info("Close cli
+0002fc50: 656e 7420 636f 6e6e 6563 7469 6f6e 3a20  ent connection: 
+0002fc60: 2573 222c 2063 6c69 656e 7429 0a20 2020  %s", client).   
+0002fc70: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+0002fc80: 5479 7065 4572 726f 723a 2020 2320 636f  TypeError:  # co
+0002fc90: 6d6d 2062 6563 6f6d 6573 204e 6f6e 6520  mm becomes None 
+0002fca0: 6475 7269 6e67 2047 430a 2020 2020 2020  during GC.      
+0002fcb0: 2020 2020 2020 2020 2020 7061 7373 0a0a            pass..
+0002fcc0: 2020 2020 6465 6620 7265 6d6f 7665 5f63      def remove_c
+0002fcd0: 6c69 656e 7428 7365 6c66 2c20 636c 6965  lient(self, clie
+0002fce0: 6e74 3a20 7374 722c 2073 7469 6d75 6c75  nt: str, stimulu
+0002fcf0: 735f 6964 3a20 7374 7220 7c20 4e6f 6e65  s_id: str | None
+0002fd00: 203d 204e 6f6e 6529 202d 3e20 4e6f 6e65   = None) -> None
+0002fd10: 3a0a 2020 2020 2020 2020 2222 2252 656d  :.        """Rem
+0002fd20: 6f76 6520 636c 6965 6e74 2066 726f 6d20  ove client from 
+0002fd30: 6e65 7477 6f72 6b22 2222 0a20 2020 2020  network""".     
+0002fd40: 2020 2073 7469 6d75 6c75 735f 6964 203d     stimulus_id =
+0002fd50: 2073 7469 6d75 6c75 735f 6964 206f 7220   stimulus_id or 
+0002fd60: 6622 7265 6d6f 7665 2d63 6c69 656e 742d  f"remove-client-
+0002fd70: 7b74 696d 6528 297d 220a 2020 2020 2020  {time()}".      
+0002fd80: 2020 6966 2073 656c 662e 7374 6174 7573    if self.status
+0002fd90: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
+0002fda0: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
+0002fdb0: 6c6f 6767 6572 2e69 6e66 6f28 2252 656d  logger.info("Rem
+0002fdc0: 6f76 6520 636c 6965 6e74 2025 7322 2c20  ove client %s", 
+0002fdd0: 636c 6965 6e74 290a 2020 2020 2020 2020  client).        
+0002fde0: 7365 6c66 2e6c 6f67 5f65 7665 6e74 285b  self.log_event([
+0002fdf0: 2261 6c6c 222c 2063 6c69 656e 745d 2c20  "all", client], 
+0002fe00: 7b22 6163 7469 6f6e 223a 2022 7265 6d6f  {"action": "remo
+0002fe10: 7665 2d63 6c69 656e 7422 2c20 2263 6c69  ve-client", "cli
+0002fe20: 656e 7422 3a20 636c 6965 6e74 7d29 0a20  ent": client}). 
+0002fe30: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0002fe40: 2020 2020 2020 2020 6373 3a20 436c 6965          cs: Clie
+0002fe50: 6e74 5374 6174 6520 3d20 7365 6c66 2e63  ntState = self.c
+0002fe60: 6c69 656e 7473 5b63 6c69 656e 745d 0a20  lients[client]. 
+0002fe70: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
+0002fe80: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
+0002fe90: 2020 2020 2320 5858 5820 6973 2074 6869      # XXX is thi
+0002fea0: 7320 6120 6c65 6769 7469 6d61 7465 2063  s a legitimate c
+0002feb0: 6f6e 6469 7469 6f6e 3f0a 2020 2020 2020  ondition?.      
+0002fec0: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
+0002fed0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0002fee0: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
+0002fef0: 5f72 656c 6561 7365 735f 6b65 7973 280a  _releases_keys(.
+0002ff00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ff10: 6b65 7973 3d5b 7473 2e6b 6579 2066 6f72  keys=[ts.key for
+0002ff20: 2074 7320 696e 2063 732e 7761 6e74 735f   ts in cs.wants_
+0002ff30: 7768 6174 5d2c 0a20 2020 2020 2020 2020  what],.         
+0002ff40: 2020 2020 2020 2063 6c69 656e 743d 6373         client=cs
+0002ff50: 2e63 6c69 656e 745f 6b65 792c 0a20 2020  .client_key,.   
+0002ff60: 2020 2020 2020 2020 2020 2020 2073 7469               sti
+0002ff70: 6d75 6c75 735f 6964 3d73 7469 6d75 6c75  mulus_id=stimulu
+0002ff80: 735f 6964 2c0a 2020 2020 2020 2020 2020  s_id,.          
+0002ff90: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0002ffa0: 6465 6c20 7365 6c66 2e63 6c69 656e 7473  del self.clients
+0002ffb0: 5b63 6c69 656e 745d 0a0a 2020 2020 2020  [client]..      
+0002ffc0: 2020 2020 2020 666f 7220 706c 7567 696e        for plugin
+0002ffd0: 2069 6e20 6c69 7374 2873 656c 662e 706c   in list(self.pl
+0002ffe0: 7567 696e 732e 7661 6c75 6573 2829 293a  ugins.values()):
+0002fff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030000: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00030010: 2020 2020 2020 2020 2020 706c 7567 696e            plugin
+00030020: 2e72 656d 6f76 655f 636c 6965 6e74 2873  .remove_client(s
+00030030: 6368 6564 756c 6572 3d73 656c 662c 2063  cheduler=self, c
+00030040: 6c69 656e 743d 636c 6965 6e74 290a 2020  lient=client).  
+00030050: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+00030060: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
+00030070: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+00030080: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+00030090: 6578 6365 7074 696f 6e28 6529 0a0a 2020  exception(e)..  
+000300a0: 2020 2020 2020 6173 796e 6320 6465 6620        async def 
+000300b0: 7265 6d6f 7665 5f63 6c69 656e 745f 6672  remove_client_fr
+000300c0: 6f6d 5f65 7665 6e74 7328 293a 0a20 2020  om_events():.   
+000300d0: 2020 2020 2020 2020 2023 2049 6620 7468           # If th
+000300e0: 6520 636c 6965 6e74 2069 736e 2774 2072  e client isn't r
+000300f0: 6567 6973 7465 7265 6420 616e 796d 6f72  egistered anymor
+00030100: 6520 6166 7465 7220 7468 6520 6465 6c61  e after the dela
+00030110: 792c 2072 656d 6f76 6520 6672 6f6d 2065  y, remove from e
+00030120: 7665 6e74 730a 2020 2020 2020 2020 2020  vents.          
+00030130: 2020 6966 2063 6c69 656e 7420 6e6f 7420    if client not 
+00030140: 696e 2073 656c 662e 636c 6965 6e74 7320  in self.clients 
+00030150: 616e 6420 636c 6965 6e74 2069 6e20 7365  and client in se
+00030160: 6c66 2e65 7665 6e74 733a 0a20 2020 2020  lf.events:.     
+00030170: 2020 2020 2020 2020 2020 2064 656c 2073             del s
+00030180: 656c 662e 6576 656e 7473 5b63 6c69 656e  elf.events[clien
+00030190: 745d 0a0a 2020 2020 2020 2020 636c 6561  t]..        clea
+000301a0: 6e75 705f 6465 6c61 7920 3d20 7061 7273  nup_delay = pars
+000301b0: 655f 7469 6d65 6465 6c74 6128 0a20 2020  e_timedelta(.   
+000301c0: 2020 2020 2020 2020 2064 6173 6b2e 636f           dask.co
+000301d0: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
+000301e0: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
+000301f0: 6576 656e 7473 2d63 6c65 616e 7570 2d64  events-cleanup-d
+00030200: 656c 6179 2229 0a20 2020 2020 2020 2029  elay").        )
+00030210: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00030220: 7365 6c66 2e5f 6f6e 676f 696e 675f 6261  self._ongoing_ba
+00030230: 636b 6772 6f75 6e64 5f74 6173 6b73 2e63  ckground_tasks.c
+00030240: 6c6f 7365 643a 0a20 2020 2020 2020 2020  losed:.         
+00030250: 2020 2073 656c 662e 5f6f 6e67 6f69 6e67     self._ongoing
+00030260: 5f62 6163 6b67 726f 756e 645f 7461 736b  _background_task
+00030270: 732e 6361 6c6c 5f6c 6174 6572 280a 2020  s.call_later(.  
+00030280: 2020 2020 2020 2020 2020 2020 2020 636c                cl
+00030290: 6561 6e75 705f 6465 6c61 792c 2072 656d  eanup_delay, rem
+000302a0: 6f76 655f 636c 6965 6e74 5f66 726f 6d5f  ove_client_from_
+000302b0: 6576 656e 7473 0a20 2020 2020 2020 2020  events.         
+000302c0: 2020 2029 0a0a 2020 2020 6465 6620 7365     )..    def se
+000302d0: 6e64 5f74 6173 6b5f 746f 5f77 6f72 6b65  nd_task_to_worke
+000302e0: 7228 0a20 2020 2020 2020 2073 656c 662c  r(.        self,
+000302f0: 2077 6f72 6b65 723a 2073 7472 2c20 7473   worker: str, ts
+00030300: 3a20 5461 736b 5374 6174 652c 2064 7572  : TaskState, dur
+00030310: 6174 696f 6e3a 2066 6c6f 6174 203d 202d  ation: float = -
+00030320: 310a 2020 2020 2920 2d3e 204e 6f6e 653a  1.    ) -> None:
+00030330: 0a20 2020 2020 2020 2022 2222 5365 6e64  .        """Send
+00030340: 2061 2073 696e 676c 6520 636f 6d70 7574   a single comput
+00030350: 6174 696f 6e61 6c20 7461 736b 2074 6f20  ational task to 
+00030360: 6120 776f 726b 6572 2222 220a 2020 2020  a worker""".    
+00030370: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00030380: 2020 2020 206d 7367 3a20 6469 6374 203d       msg: dict =
+00030390: 2073 656c 662e 5f74 6173 6b5f 746f 5f6d   self._task_to_m
+000303a0: 7367 2874 732c 2064 7572 6174 696f 6e29  sg(ts, duration)
+000303b0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000303c0: 662e 776f 726b 6572 5f73 656e 6428 776f  f.worker_send(wo
+000303d0: 726b 6572 2c20 6d73 6729 0a20 2020 2020  rker, msg).     
+000303e0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+000303f0: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
+00030400: 2020 2020 2020 6c6f 6767 6572 2e65 7863        logger.exc
+00030410: 6570 7469 6f6e 2865 290a 2020 2020 2020  eption(e).      
+00030420: 2020 2020 2020 6966 204c 4f47 5f50 4442        if LOG_PDB
+00030430: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00030440: 2020 696d 706f 7274 2070 6462 0a0a 2020    import pdb..  
+00030450: 2020 2020 2020 2020 2020 2020 2020 7064                pd
+00030460: 622e 7365 745f 7472 6163 6528 290a 2020  b.set_trace().  
+00030470: 2020 2020 2020 2020 2020 7261 6973 650a            raise.
+00030480: 0a20 2020 2064 6566 2068 616e 646c 655f  .    def handle_
+00030490: 756e 6361 7567 6874 5f65 7272 6f72 2873  uncaught_error(s
+000304a0: 656c 662c 202a 2a6d 7367 3a20 416e 7929  elf, **msg: Any)
+000304b0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+000304c0: 2020 6c6f 6767 6572 2e65 7863 6570 7469    logger.excepti
+000304d0: 6f6e 2863 6c65 616e 5f65 7863 6570 7469  on(clean_excepti
+000304e0: 6f6e 282a 2a6d 7367 295b 315d 290a 0a20  on(**msg)[1]).. 
+000304f0: 2020 2064 6566 2068 616e 646c 655f 7461     def handle_ta
+00030500: 736b 5f66 696e 6973 6865 6428 0a20 2020  sk_finished(.   
+00030510: 2020 2020 2073 656c 662c 206b 6579 3a20       self, key: 
+00030520: 7374 722c 2077 6f72 6b65 723a 2073 7472  str, worker: str
+00030530: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
+00030540: 7472 2c20 2a2a 6d73 673a 2041 6e79 0a20  tr, **msg: Any. 
+00030550: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
+00030560: 2020 2020 2020 6966 2077 6f72 6b65 7220        if worker 
+00030570: 6e6f 7420 696e 2073 656c 662e 776f 726b  not in self.work
+00030580: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+00030590: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
+000305a0: 7661 6c69 6461 7465 5f6b 6579 286b 6579  validate_key(key
+000305b0: 290a 0a20 2020 2020 2020 2072 3a20 7475  )..        r: tu
+000305c0: 706c 6520 3d20 7365 6c66 2e73 7469 6d75  ple = self.stimu
+000305d0: 6c75 735f 7461 736b 5f66 696e 6973 6865  lus_task_finishe
+000305e0: 6428 0a20 2020 2020 2020 2020 2020 206b  d(.            k
+000305f0: 6579 3d6b 6579 2c20 776f 726b 6572 3d77  ey=key, worker=w
+00030600: 6f72 6b65 722c 2073 7469 6d75 6c75 735f  orker, stimulus_
+00030610: 6964 3d73 7469 6d75 6c75 735f 6964 2c20  id=stimulus_id, 
+00030620: 2a2a 6d73 670a 2020 2020 2020 2020 290a  **msg.        ).
+00030630: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+00030640: 6461 7469 6f6e 732c 2063 6c69 656e 745f  dations, client_
+00030650: 6d73 6773 2c20 776f 726b 6572 5f6d 7367  msgs, worker_msg
+00030660: 7320 3d20 720a 2020 2020 2020 2020 7365  s = r.        se
+00030670: 6c66 2e5f 7472 616e 7369 7469 6f6e 7328  lf._transitions(
+00030680: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
+00030690: 2063 6c69 656e 745f 6d73 6773 2c20 776f   client_msgs, wo
+000306a0: 726b 6572 5f6d 7367 732c 2073 7469 6d75  rker_msgs, stimu
+000306b0: 6c75 735f 6964 290a 2020 2020 2020 2020  lus_id).        
+000306c0: 7365 6c66 2e73 656e 645f 616c 6c28 636c  self.send_all(cl
+000306d0: 6965 6e74 5f6d 7367 732c 2077 6f72 6b65  ient_msgs, worke
+000306e0: 725f 6d73 6773 290a 0a20 2020 2020 2020  r_msgs)..       
+000306f0: 2073 656c 662e 7374 696d 756c 7573 5f71   self.stimulus_q
+00030700: 7565 7565 5f73 6c6f 7473 5f6d 6179 6265  ueue_slots_maybe
+00030710: 5f6f 7065 6e65 6428 7374 696d 756c 7573  _opened(stimulus
+00030720: 5f69 643d 7374 696d 756c 7573 5f69 6429  _id=stimulus_id)
+00030730: 0a0a 2020 2020 6465 6620 6861 6e64 6c65  ..    def handle
+00030740: 5f74 6173 6b5f 6572 7265 6428 7365 6c66  _task_erred(self
+00030750: 2c20 6b65 793a 2073 7472 2c20 7374 696d  , key: str, stim
+00030760: 756c 7573 5f69 643a 2073 7472 2c20 2a2a  ulus_id: str, **
+00030770: 6d73 673a 2041 6e79 2920 2d3e 204e 6f6e  msg: Any) -> Non
+00030780: 653a 0a20 2020 2020 2020 2072 3a20 7475  e:.        r: tu
+00030790: 706c 6520 3d20 7365 6c66 2e73 7469 6d75  ple = self.stimu
+000307a0: 6c75 735f 7461 736b 5f65 7272 6564 286b  lus_task_erred(k
+000307b0: 6579 3d6b 6579 2c20 7374 696d 756c 7573  ey=key, stimulus
+000307c0: 5f69 643d 7374 696d 756c 7573 5f69 642c  _id=stimulus_id,
+000307d0: 202a 2a6d 7367 290a 2020 2020 2020 2020   **msg).        
+000307e0: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
+000307f0: 2063 6c69 656e 745f 6d73 6773 2c20 776f   client_msgs, wo
+00030800: 726b 6572 5f6d 7367 7320 3d20 720a 2020  rker_msgs = r.  
+00030810: 2020 2020 2020 7365 6c66 2e5f 7472 616e        self._tran
+00030820: 7369 7469 6f6e 7328 7265 636f 6d6d 656e  sitions(recommen
+00030830: 6461 7469 6f6e 732c 2063 6c69 656e 745f  dations, client_
+00030840: 6d73 6773 2c20 776f 726b 6572 5f6d 7367  msgs, worker_msg
+00030850: 732c 2073 7469 6d75 6c75 735f 6964 290a  s, stimulus_id).
+00030860: 2020 2020 2020 2020 7365 6c66 2e73 656e          self.sen
+00030870: 645f 616c 6c28 636c 6965 6e74 5f6d 7367  d_all(client_msg
+00030880: 732c 2077 6f72 6b65 725f 6d73 6773 290a  s, worker_msgs).
+00030890: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
+000308a0: 696d 756c 7573 5f71 7565 7565 5f73 6c6f  imulus_queue_slo
+000308b0: 7473 5f6d 6179 6265 5f6f 7065 6e65 6428  ts_maybe_opened(
+000308c0: 7374 696d 756c 7573 5f69 643d 7374 696d  stimulus_id=stim
+000308d0: 756c 7573 5f69 6429 0a0a 2020 2020 6465  ulus_id)..    de
+000308e0: 6620 7265 6c65 6173 655f 776f 726b 6572  f release_worker
+000308f0: 5f64 6174 6128 7365 6c66 2c20 6b65 793a  _data(self, key:
+00030900: 2073 7472 2c20 776f 726b 6572 3a20 7374   str, worker: st
+00030910: 722c 2073 7469 6d75 6c75 735f 6964 3a20  r, stimulus_id: 
+00030920: 7374 7229 202d 3e20 4e6f 6e65 3a0a 2020  str) -> None:.  
+00030930: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
+00030940: 7461 736b 732e 6765 7428 6b65 7929 0a20  tasks.get(key). 
+00030950: 2020 2020 2020 2077 7320 3d20 7365 6c66         ws = self
+00030960: 2e77 6f72 6b65 7273 2e67 6574 2877 6f72  .workers.get(wor
+00030970: 6b65 7229 0a20 2020 2020 2020 2069 6620  ker).        if 
+00030980: 6e6f 7420 7473 206f 7220 6e6f 7420 7773  not ts or not ws
+00030990: 206f 7220 7773 206e 6f74 2069 6e20 7473   or ws not in ts
+000309a0: 2e77 686f 5f68 6173 3a0a 2020 2020 2020  .who_has:.      
+000309b0: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+000309c0: 2020 2020 2020 7365 6c66 2e72 656d 6f76        self.remov
+000309d0: 655f 7265 706c 6963 6128 7473 2c20 7773  e_replica(ts, ws
+000309e0: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+000309f0: 2074 732e 7768 6f5f 6861 733a 0a20 2020   ts.who_has:.   
+00030a00: 2020 2020 2020 2020 2073 656c 662e 7472           self.tr
+00030a10: 616e 7369 7469 6f6e 7328 7b6b 6579 3a20  ansitions({key: 
+00030a20: 2272 656c 6561 7365 6422 7d2c 2073 7469  "released"}, sti
+00030a30: 6d75 6c75 735f 6964 290a 0a20 2020 2064  mulus_id)..    d
+00030a40: 6566 2068 616e 646c 655f 6c6f 6e67 5f72  ef handle_long_r
+00030a50: 756e 6e69 6e67 280a 2020 2020 2020 2020  unning(.        
+00030a60: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
+00030a70: 776f 726b 6572 3a20 7374 722c 2063 6f6d  worker: str, com
+00030a80: 7075 7465 5f64 7572 6174 696f 6e3a 2066  pute_duration: f
+00030a90: 6c6f 6174 207c 204e 6f6e 652c 2073 7469  loat | None, sti
+00030aa0: 6d75 6c75 735f 6964 3a20 7374 720a 2020  mulus_id: str.  
+00030ab0: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
+00030ac0: 2020 2020 2022 2222 4120 7461 736b 2068       """A task h
+00030ad0: 6173 2073 6563 6564 6564 2066 726f 6d20  as seceded from 
+00030ae0: 7468 6520 7468 7265 6164 2070 6f6f 6c0a  the thread pool.
+00030af0: 0a20 2020 2020 2020 2057 6520 7374 6f70  .        We stop
+00030b00: 2074 6865 2074 6173 6b20 6672 6f6d 2062   the task from b
+00030b10: 6569 6e67 2073 746f 6c65 6e20 696e 2074  eing stolen in t
+00030b20: 6865 2066 7574 7572 652c 2061 6e64 2063  he future, and c
+00030b30: 6861 6e67 6520 7461 736b 0a20 2020 2020  hange task.     
+00030b40: 2020 2064 7572 6174 696f 6e20 6163 636f     duration acco
+00030b50: 756e 7469 6e67 2061 7320 6966 2074 6865  unting as if the
+00030b60: 2074 6173 6b20 6861 7320 7374 6f70 7065   task has stoppe
+00030b70: 642e 0a20 2020 2020 2020 2022 2222 0a20  d..        """. 
+00030b80: 2020 2020 2020 2069 6620 6b65 7920 6e6f         if key no
+00030b90: 7420 696e 2073 656c 662e 7461 736b 733a  t in self.tasks:
+00030ba0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00030bb0: 6765 722e 6465 6275 6728 2253 6b69 7070  ger.debug("Skipp
+00030bc0: 696e 6720 6c6f 6e67 5f72 756e 6e69 6e67  ing long_running
+00030bd0: 2073 696e 6365 206b 6579 2025 7320 7761   since key %s wa
+00030be0: 7320 616c 7265 6164 7920 7265 6c65 6173  s already releas
+00030bf0: 6564 222c 206b 6579 290a 2020 2020 2020  ed", key).      
+00030c00: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+00030c10: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
+00030c20: 6173 6b73 5b6b 6579 5d0a 2020 2020 2020  asks[key].      
+00030c30: 2020 7374 6561 6c20 3d20 7365 6c66 2e65    steal = self.e
+00030c40: 7874 656e 7369 6f6e 732e 6765 7428 2273  xtensions.get("s
+00030c50: 7465 616c 696e 6722 290a 2020 2020 2020  tealing").      
+00030c60: 2020 6966 2073 7465 616c 2069 7320 6e6f    if steal is no
+00030c70: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00030c80: 2020 2020 7374 6561 6c2e 7265 6d6f 7665      steal.remove
+00030c90: 5f6b 6579 5f66 726f 6d5f 7374 6561 6c61  _key_from_steala
+00030ca0: 626c 6528 7473 290a 0a20 2020 2020 2020  ble(ts)..       
+00030cb0: 2077 7320 3d20 7473 2e70 726f 6365 7373   ws = ts.process
+00030cc0: 696e 675f 6f6e 0a20 2020 2020 2020 2069  ing_on.        i
+00030cd0: 6620 7773 2069 7320 4e6f 6e65 3a0a 2020  f ws is None:.  
+00030ce0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00030cf0: 2e64 6562 7567 2822 5265 6365 6976 6564  .debug("Received
+00030d00: 206c 6f6e 672d 7275 6e6e 696e 6720 7369   long-running si
+00030d10: 676e 616c 2066 726f 6d20 6475 706c 6963  gnal from duplic
+00030d20: 6174 6520 7461 736b 2e20 4967 6e6f 7269  ate task. Ignori
+00030d30: 6e67 2e22 290a 2020 2020 2020 2020 2020  ng.").          
+00030d40: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
+00030d50: 2020 6966 2063 6f6d 7075 7465 5f64 7572    if compute_dur
+00030d60: 6174 696f 6e20 6973 206e 6f74 204e 6f6e  ation is not Non
+00030d70: 653a 0a20 2020 2020 2020 2020 2020 206f  e:.            o
+00030d80: 6c64 5f64 7572 6174 696f 6e20 3d20 7473  ld_duration = ts
+00030d90: 2e70 7265 6669 782e 6475 7261 7469 6f6e  .prefix.duration
+00030da0: 5f61 7665 7261 6765 0a20 2020 2020 2020  _average.       
+00030db0: 2020 2020 2069 6620 6f6c 645f 6475 7261       if old_dura
+00030dc0: 7469 6f6e 203c 2030 3a0a 2020 2020 2020  tion < 0:.      
+00030dd0: 2020 2020 2020 2020 2020 7473 2e70 7265            ts.pre
+00030de0: 6669 782e 6475 7261 7469 6f6e 5f61 7665  fix.duration_ave
+00030df0: 7261 6765 203d 2063 6f6d 7075 7465 5f64  rage = compute_d
+00030e00: 7572 6174 696f 6e0a 2020 2020 2020 2020  uration.        
+00030e10: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00030e20: 2020 2020 2020 2020 2020 7473 2e70 7265            ts.pre
+00030e30: 6669 782e 6475 7261 7469 6f6e 5f61 7665  fix.duration_ave
+00030e40: 7261 6765 203d 2028 6f6c 645f 6475 7261  rage = (old_dura
+00030e50: 7469 6f6e 202b 2063 6f6d 7075 7465 5f64  tion + compute_d
+00030e60: 7572 6174 696f 6e29 202f 2032 0a0a 2020  uration) / 2..  
+00030e70: 2020 2020 2020 7773 2e61 6464 5f74 6f5f        ws.add_to_
+00030e80: 6c6f 6e67 5f72 756e 6e69 6e67 2874 7329  long_running(ts)
+00030e90: 0a20 2020 2020 2020 2073 656c 662e 6368  .        self.ch
+00030ea0: 6563 6b5f 6964 6c65 5f73 6174 7572 6174  eck_idle_saturat
+00030eb0: 6564 2877 7329 0a0a 2020 2020 2020 2020  ed(ws)..        
+00030ec0: 7365 6c66 2e73 7469 6d75 6c75 735f 7175  self.stimulus_qu
+00030ed0: 6575 655f 736c 6f74 735f 6d61 7962 655f  eue_slots_maybe_
+00030ee0: 6f70 656e 6564 2873 7469 6d75 6c75 735f  opened(stimulus_
+00030ef0: 6964 3d73 7469 6d75 6c75 735f 6964 290a  id=stimulus_id).
+00030f00: 0a20 2020 2064 6566 2068 616e 646c 655f  .    def handle_
+00030f10: 776f 726b 6572 5f73 7461 7475 735f 6368  worker_status_ch
+00030f20: 616e 6765 280a 2020 2020 2020 2020 7365  ange(.        se
+00030f30: 6c66 2c20 7374 6174 7573 3a20 7374 7220  lf, status: str 
+00030f40: 7c20 5374 6174 7573 2c20 776f 726b 6572  | Status, worker
+00030f50: 3a20 7374 7220 7c20 576f 726b 6572 5374  : str | WorkerSt
+00030f60: 6174 652c 2073 7469 6d75 6c75 735f 6964  ate, stimulus_id
+00030f70: 3a20 7374 720a 2020 2020 2920 2d3e 204e  : str.    ) -> N
+00030f80: 6f6e 653a 0a20 2020 2020 2020 2077 7320  one:.        ws 
+00030f90: 3d20 7365 6c66 2e77 6f72 6b65 7273 2e67  = self.workers.g
+00030fa0: 6574 2877 6f72 6b65 7229 2069 6620 6973  et(worker) if is
+00030fb0: 696e 7374 616e 6365 2877 6f72 6b65 722c  instance(worker,
+00030fc0: 2073 7472 2920 656c 7365 2077 6f72 6b65   str) else worke
+00030fd0: 720a 2020 2020 2020 2020 6966 206e 6f74  r.        if not
+00030fe0: 2077 733a 0a20 2020 2020 2020 2020 2020   ws:.           
+00030ff0: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
+00031000: 7072 6576 5f73 7461 7475 7320 3d20 7773  prev_status = ws
+00031010: 2e73 7461 7475 730a 2020 2020 2020 2020  .status.        
+00031020: 7773 2e73 7461 7475 7320 3d20 5374 6174  ws.status = Stat
+00031030: 7573 5b73 7461 7475 735d 2069 6620 6973  us[status] if is
+00031040: 696e 7374 616e 6365 2873 7461 7475 732c  instance(status,
+00031050: 2073 7472 2920 656c 7365 2073 7461 7475   str) else statu
+00031060: 730a 2020 2020 2020 2020 6966 2077 732e  s.        if ws.
+00031070: 7374 6174 7573 203d 3d20 7072 6576 5f73  status == prev_s
+00031080: 7461 7475 733a 0a20 2020 2020 2020 2020  tatus:.         
+00031090: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
+000310a0: 2020 2073 656c 662e 6c6f 675f 6576 656e     self.log_even
+000310b0: 7428 0a20 2020 2020 2020 2020 2020 2077  t(.            w
+000310c0: 732e 6164 6472 6573 732c 0a20 2020 2020  s.address,.     
+000310d0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+000310e0: 2020 2020 2020 2020 2022 6163 7469 6f6e           "action
+000310f0: 223a 2022 776f 726b 6572 2d73 7461 7475  ": "worker-statu
+00031100: 732d 6368 616e 6765 222c 0a20 2020 2020  s-change",.     
+00031110: 2020 2020 2020 2020 2020 2022 7072 6576             "prev
+00031120: 2d73 7461 7475 7322 3a20 7072 6576 5f73  -status": prev_s
+00031130: 7461 7475 732e 6e61 6d65 2c0a 2020 2020  tatus.name,.    
+00031140: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+00031150: 7475 7322 3a20 7773 2e73 7461 7475 732e  tus": ws.status.
+00031160: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
+00031170: 2020 7d2c 0a20 2020 2020 2020 2029 0a20    },.        ). 
+00031180: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
+00031190: 6275 6728 6622 576f 726b 6572 2073 7461  bug(f"Worker sta
+000311a0: 7475 7320 7b70 7265 765f 7374 6174 7573  tus {prev_status
+000311b0: 2e6e 616d 657d 202d 3e20 7b73 7461 7475  .name} -> {statu
+000311c0: 737d 202d 207b 7773 7d22 290a 0a20 2020  s} - {ws}")..   
+000311d0: 2020 2020 2069 6620 7773 2e73 7461 7475       if ws.statu
+000311e0: 7320 3d3d 2053 7461 7475 732e 7275 6e6e  s == Status.runn
+000311f0: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
+00031200: 2073 656c 662e 7275 6e6e 696e 672e 6164   self.running.ad
+00031210: 6428 7773 290a 2020 2020 2020 2020 2020  d(ws).          
+00031220: 2020 7365 6c66 2e63 6865 636b 5f69 646c    self.check_idl
+00031230: 655f 7361 7475 7261 7465 6428 7773 290a  e_saturated(ws).
+00031240: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00031250: 2e74 7261 6e73 6974 696f 6e73 280a 2020  .transitions(.  
+00031260: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00031270: 6c66 2e62 756c 6b5f 7363 6865 6475 6c65  lf.bulk_schedule
+00031280: 5f75 6e72 756e 6e61 626c 655f 6166 7465  _unrunnable_afte
+00031290: 725f 6164 6469 6e67 5f77 6f72 6b65 7228  r_adding_worker(
+000312a0: 7773 292c 2073 7469 6d75 6c75 735f 6964  ws), stimulus_id
+000312b0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+000312c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000312d0: 7374 696d 756c 7573 5f71 7565 7565 5f73  stimulus_queue_s
+000312e0: 6c6f 7473 5f6d 6179 6265 5f6f 7065 6e65  lots_maybe_opene
+000312f0: 6428 7374 696d 756c 7573 5f69 643d 7374  d(stimulus_id=st
+00031300: 696d 756c 7573 5f69 6429 0a20 2020 2020  imulus_id).     
+00031310: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00031320: 2020 2020 2073 656c 662e 7275 6e6e 696e       self.runnin
+00031330: 672e 6469 7363 6172 6428 7773 290a 2020  g.discard(ws).  
+00031340: 2020 2020 2020 2020 2020 7365 6c66 2e69            self.i
+00031350: 646c 652e 706f 7028 7773 2e61 6464 7265  dle.pop(ws.addre
+00031360: 7373 2c20 4e6f 6e65 290a 2020 2020 2020  ss, None).      
+00031370: 2020 2020 2020 7365 6c66 2e69 646c 655f        self.idle_
+00031380: 7461 736b 5f63 6f75 6e74 2e64 6973 6361  task_count.disca
+00031390: 7264 2877 7329 0a20 2020 2020 2020 2020  rd(ws).         
+000313a0: 2020 2073 656c 662e 7361 7475 7261 7465     self.saturate
+000313b0: 642e 6469 7363 6172 6428 7773 290a 0a20  d.discard(ws).. 
+000313c0: 2020 2061 7379 6e63 2064 6566 2068 616e     async def han
+000313d0: 646c 655f 7265 7175 6573 745f 7265 6672  dle_request_refr
+000313e0: 6573 685f 7768 6f5f 6861 7328 0a20 2020  esh_who_has(.   
+000313f0: 2020 2020 2073 656c 662c 206b 6579 733a       self, keys:
+00031400: 2049 7465 7261 626c 655b 7374 725d 2c20   Iterable[str], 
+00031410: 776f 726b 6572 3a20 7374 722c 2073 7469  worker: str, sti
+00031420: 6d75 6c75 735f 6964 3a20 7374 720a 2020  mulus_id: str.  
+00031430: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
+00031440: 2020 2020 2022 2222 4173 796e 6368 726f       """Asynchro
+00031450: 6e6f 7573 2072 6571 7565 7374 2028 7468  nous request (th
+00031460: 726f 7567 6820 6275 6c6b 2063 6f6d 6d73  rough bulk comms
+00031470: 2920 6672 6f6d 2061 2057 6f72 6b65 7220  ) from a Worker 
+00031480: 746f 2072 6566 7265 7368 2074 6865 0a20  to refresh the. 
+00031490: 2020 2020 2020 2077 686f 5f68 6173 2066         who_has f
+000314a0: 6f72 2073 6f6d 6520 6b65 7973 2e20 4e6f  or some keys. No
+000314b0: 7420 746f 2062 6520 636f 6e66 7573 6564  t to be confused
+000314c0: 2077 6974 6820 7363 6865 6475 6c65 722e   with scheduler.
+000314d0: 7768 6f5f 6861 732c 2077 6869 6368 2069  who_has, which i
+000314e0: 7320 610a 2020 2020 2020 2020 7379 6e63  s a.        sync
+000314f0: 6872 6f6e 6f75 7320 5250 4320 7265 7175  hronous RPC requ
+00031500: 6573 7420 6672 6f6d 2061 2043 6c69 656e  est from a Clien
+00031510: 742e 0a20 2020 2020 2020 2022 2222 0a20  t..        """. 
+00031520: 2020 2020 2020 2077 686f 5f68 6173 203d         who_has =
+00031530: 207b 7d0a 2020 2020 2020 2020 6672 6565   {}.        free
+00031540: 5f6b 6579 7320 3d20 5b5d 0a20 2020 2020  _keys = [].     
+00031550: 2020 2066 6f72 206b 6579 2069 6e20 6b65     for key in ke
+00031560: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
+00031570: 6966 206b 6579 2069 6e20 7365 6c66 2e74  if key in self.t
+00031580: 6173 6b73 3a0a 2020 2020 2020 2020 2020  asks:.          
+00031590: 2020 2020 2020 7768 6f5f 6861 735b 6b65        who_has[ke
+000315a0: 795d 203d 205b 7773 2e61 6464 7265 7373  y] = [ws.address
+000315b0: 2066 6f72 2077 7320 696e 2073 656c 662e   for ws in self.
+000315c0: 7461 736b 735b 6b65 795d 2e77 686f 5f68  tasks[key].who_h
+000315d0: 6173 5d0a 2020 2020 2020 2020 2020 2020  as].            
+000315e0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000315f0: 2020 2020 2020 6672 6565 5f6b 6579 732e        free_keys.
+00031600: 6170 7065 6e64 286b 6579 290a 0a20 2020  append(key)..   
+00031610: 2020 2020 2069 6620 7768 6f5f 6861 733a       if who_has:
+00031620: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00031630: 662e 7374 7265 616d 5f63 6f6d 6d73 5b77  f.stream_comms[w
+00031640: 6f72 6b65 725d 2e73 656e 6428 0a20 2020  orker].send(.   
+00031650: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
+00031660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031670: 2020 2022 6f70 223a 2022 7265 6672 6573     "op": "refres
+00031680: 682d 7768 6f2d 6861 7322 2c0a 2020 2020  h-who-has",.    
+00031690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000316a0: 2277 686f 5f68 6173 223a 2077 686f 5f68  "who_has": who_h
+000316b0: 6173 2c0a 2020 2020 2020 2020 2020 2020  as,.            
+000316c0: 2020 2020 2020 2020 2273 7469 6d75 6c75          "stimulu
+000316d0: 735f 6964 223a 2073 7469 6d75 6c75 735f  s_id": stimulus_
+000316e0: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+000316f0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00031700: 2020 290a 2020 2020 2020 2020 6966 2066    ).        if f
+00031710: 7265 655f 6b65 7973 3a0a 2020 2020 2020  ree_keys:.      
+00031720: 2020 2020 2020 7365 6c66 2e73 7472 6561        self.strea
+00031730: 6d5f 636f 6d6d 735b 776f 726b 6572 5d2e  m_comms[worker].
+00031740: 7365 6e64 280a 2020 2020 2020 2020 2020  send(.          
+00031750: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00031760: 2020 2020 2020 2020 2020 2020 226f 7022              "op"
+00031770: 3a20 2266 7265 652d 6b65 7973 222c 0a20  : "free-keys",. 
+00031780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031790: 2020 2022 6b65 7973 223a 2066 7265 655f     "keys": free_
+000317a0: 6b65 7973 2c0a 2020 2020 2020 2020 2020  keys,.          
+000317b0: 2020 2020 2020 2020 2020 2273 7469 6d75            "stimu
+000317c0: 6c75 735f 6964 223a 2073 7469 6d75 6c75  lus_id": stimulu
+000317d0: 735f 6964 2c0a 2020 2020 2020 2020 2020  s_id,.          
+000317e0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000317f0: 2020 2020 290a 0a20 2020 2061 7379 6e63      )..    async
+00031800: 2064 6566 2068 616e 646c 655f 776f 726b   def handle_work
+00031810: 6572 2873 656c 662c 2063 6f6d 6d3a 2043  er(self, comm: C
+00031820: 6f6d 6d2c 2077 6f72 6b65 723a 2073 7472  omm, worker: str
+00031830: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00031840: 2020 2022 2222 0a20 2020 2020 2020 204c     """.        L
+00031850: 6973 7465 6e20 746f 2072 6573 706f 6e73  isten to respons
+00031860: 6573 2066 726f 6d20 6120 7369 6e67 6c65  es from a single
+00031870: 2077 6f72 6b65 720a 0a20 2020 2020 2020   worker..       
+00031880: 2054 6869 7320 6973 2074 6865 206d 6169   This is the mai
+00031890: 6e20 6c6f 6f70 2066 6f72 2073 6368 6564  n loop for sched
+000318a0: 756c 6572 2d77 6f72 6b65 7220 696e 7465  uler-worker inte
+000318b0: 7261 6374 696f 6e0a 0a20 2020 2020 2020  raction..       
+000318c0: 2053 6565 2041 6c73 6f0a 2020 2020 2020   See Also.      
+000318d0: 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020    --------.     
+000318e0: 2020 2053 6368 6564 756c 6572 2e68 616e     Scheduler.han
+000318f0: 646c 655f 636c 6965 6e74 3a20 4571 7569  dle_client: Equi
+00031900: 7661 6c65 6e74 2063 6f72 6f75 7469 6e65  valent coroutine
+00031910: 2066 6f72 2063 6c69 656e 7473 0a20 2020   for clients.   
+00031920: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00031930: 2063 6f6d 6d2e 6e61 6d65 203d 2022 5363   comm.name = "Sc
+00031940: 6865 6475 6c65 7220 636f 6e6e 6563 7469  heduler connecti
+00031950: 6f6e 2074 6f20 776f 726b 6572 220a 2020  on to worker".  
+00031960: 2020 2020 2020 776f 726b 6572 5f63 6f6d        worker_com
+00031970: 6d20 3d20 7365 6c66 2e73 7472 6561 6d5f  m = self.stream_
+00031980: 636f 6d6d 735b 776f 726b 6572 5d0a 2020  comms[worker].  
+00031990: 2020 2020 2020 776f 726b 6572 5f63 6f6d        worker_com
+000319a0: 6d2e 7374 6172 7428 636f 6d6d 290a 2020  m.start(comm).  
+000319b0: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
+000319c0: 6f28 2253 7461 7274 696e 6720 776f 726b  o("Starting work
+000319d0: 6572 2063 6f6d 7075 7465 2073 7472 6561  er compute strea
+000319e0: 6d2c 2025 7322 2c20 776f 726b 6572 290a  m, %s", worker).
+000319f0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00031a00: 2020 2020 2020 2020 2061 7761 6974 2073           await s
+00031a10: 656c 662e 6861 6e64 6c65 5f73 7472 6561  elf.handle_strea
+00031a20: 6d28 636f 6d6d 3d63 6f6d 6d2c 2065 7874  m(comm=comm, ext
+00031a30: 7261 3d7b 2277 6f72 6b65 7222 3a20 776f  ra={"worker": wo
+00031a40: 726b 6572 7d29 0a20 2020 2020 2020 2066  rker}).        f
+00031a50: 696e 616c 6c79 3a0a 2020 2020 2020 2020  inally:.        
+00031a60: 2020 2020 6966 2077 6f72 6b65 7220 696e      if worker in
+00031a70: 2073 656c 662e 7374 7265 616d 5f63 6f6d   self.stream_com
+00031a80: 6d73 3a0a 2020 2020 2020 2020 2020 2020  ms:.            
+00031a90: 2020 2020 776f 726b 6572 5f63 6f6d 6d2e      worker_comm.
+00031aa0: 6162 6f72 7428 290a 2020 2020 2020 2020  abort().        
+00031ab0: 2020 2020 2020 2020 6177 6169 7420 7365          await se
+00031ac0: 6c66 2e72 656d 6f76 655f 776f 726b 6572  lf.remove_worker
+00031ad0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00031ae0: 2020 2020 2020 776f 726b 6572 2c20 7374        worker, st
+00031af0: 696d 756c 7573 5f69 643d 6622 6861 6e64  imulus_id=f"hand
+00031b00: 6c65 2d77 6f72 6b65 722d 636c 6561 6e75  le-worker-cleanu
+00031b10: 702d 7b74 696d 6528 297d 220a 2020 2020  p-{time()}".    
+00031b20: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00031b30: 2020 2064 6566 2061 6464 5f70 6c75 6769     def add_plugi
+00031b40: 6e28 0a20 2020 2020 2020 2073 656c 662c  n(.        self,
+00031b50: 0a20 2020 2020 2020 2070 6c75 6769 6e3a  .        plugin:
+00031b60: 2053 6368 6564 756c 6572 506c 7567 696e   SchedulerPlugin
+00031b70: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
+00031b80: 2020 2020 2069 6465 6d70 6f74 656e 743a       idempotent:
+00031b90: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
+00031ba0: 2020 2020 2020 206e 616d 653a 2073 7472         name: str
+00031bb0: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
+00031bc0: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+00031bd0: 3a20 416e 792c 0a20 2020 2029 202d 3e20  : Any,.    ) -> 
+00031be0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
+00031bf0: 2241 6464 2065 7874 6572 6e61 6c20 706c  "Add external pl
+00031c00: 7567 696e 2074 6f20 7363 6865 6475 6c65  ugin to schedule
+00031c10: 722e 0a0a 2020 2020 2020 2020 5365 6520  r...        See 
+00031c20: 6874 7470 733a 2f2f 6469 7374 7269 6275  https://distribu
+00031c30: 7465 642e 7265 6164 7468 6564 6f63 732e  ted.readthedocs.
+00031c40: 696f 2f65 6e2f 6c61 7465 7374 2f70 6c75  io/en/latest/plu
+00031c50: 6769 6e73 2e68 746d 6c0a 0a20 2020 2020  gins.html..     
+00031c60: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
+00031c70: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d        ----------
+00031c80: 0a20 2020 2020 2020 2070 6c75 6769 6e20  .        plugin 
+00031c90: 3a20 5363 6865 6475 6c65 7250 6c75 6769  : SchedulerPlugi
+00031ca0: 6e0a 2020 2020 2020 2020 2020 2020 5363  n.            Sc
+00031cb0: 6865 6475 6c65 7250 6c75 6769 6e20 696e  hedulerPlugin in
+00031cc0: 7374 616e 6365 2074 6f20 6164 640a 2020  stance to add.  
+00031cd0: 2020 2020 2020 6964 656d 706f 7465 6e74        idempotent
+00031ce0: 203a 2062 6f6f 6c0a 2020 2020 2020 2020   : bool.        
+00031cf0: 2020 2020 4966 2074 7275 652c 2074 6865      If true, the
+00031d00: 2070 6c75 6769 6e20 6973 2061 7373 756d   plugin is assum
+00031d10: 6564 2074 6f20 616c 7265 6164 7920 6578  ed to already ex
+00031d20: 6973 7420 616e 6420 6e6f 0a20 2020 2020  ist and no.     
+00031d30: 2020 2020 2020 2061 6374 696f 6e20 6973         action is
+00031d40: 2074 616b 656e 2e0a 2020 2020 2020 2020   taken..        
+00031d50: 6e61 6d65 203a 2073 7472 0a20 2020 2020  name : str.     
+00031d60: 2020 2020 2020 2041 206e 616d 6520 666f         A name fo
+00031d70: 7220 7468 6520 706c 7567 696e 2c20 6966  r the plugin, if
+00031d80: 204e 6f6e 652c 2074 6865 206e 616d 6520   None, the name 
+00031d90: 6174 7472 6962 7574 6520 6973 0a20 2020  attribute is.   
+00031da0: 2020 2020 2020 2020 2063 6865 636b 6564           checked
+00031db0: 206f 6e20 7468 6520 506c 7567 696e 2069   on the Plugin i
+00031dc0: 6e73 7461 6e63 6520 616e 6420 6765 6e65  nstance and gene
+00031dd0: 7261 7465 6420 6966 206e 6f74 0a20 2020  rated if not.   
+00031de0: 2020 2020 2020 2020 2064 6973 636f 7665           discove
+00031df0: 7265 642e 0a20 2020 2020 2020 2022 2222  red..        """
+00031e00: 0a20 2020 2020 2020 2069 6620 6e61 6d65  .        if name
+00031e10: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00031e20: 2020 2020 2020 6e61 6d65 203d 205f 6765        name = _ge
+00031e30: 745f 706c 7567 696e 5f6e 616d 6528 706c  t_plugin_name(pl
+00031e40: 7567 696e 290a 0a20 2020 2020 2020 2069  ugin)..        i
+00031e50: 6620 6e61 6d65 2069 6e20 7365 6c66 2e70  f name in self.p
+00031e60: 6c75 6769 6e73 3a0a 2020 2020 2020 2020  lugins:.        
+00031e70: 2020 2020 6966 2069 6465 6d70 6f74 656e      if idempoten
+00031e80: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00031e90: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
+00031ea0: 2020 2020 2020 7761 726e 696e 6773 2e77        warnings.w
+00031eb0: 6172 6e28 0a20 2020 2020 2020 2020 2020  arn(.           
+00031ec0: 2020 2020 2066 2253 6368 6564 756c 6572       f"Scheduler
+00031ed0: 2061 6c72 6561 6479 2063 6f6e 7461 696e   already contain
+00031ee0: 7320 6120 706c 7567 696e 2077 6974 6820  s a plugin with 
+00031ef0: 6e61 6d65 207b 6e61 6d65 7d3b 206f 7665  name {name}; ove
+00031f00: 7277 7269 7469 6e67 2e22 2c0a 2020 2020  rwriting.",.    
+00031f10: 2020 2020 2020 2020 2020 2020 6361 7465              cate
+00031f20: 676f 7279 3d55 7365 7257 6172 6e69 6e67  gory=UserWarning
+00031f30: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00031f40: 0a20 2020 2020 2020 2073 656c 662e 706c  .        self.pl
+00031f50: 7567 696e 735b 6e61 6d65 5d20 3d20 706c  ugins[name] = pl
+00031f60: 7567 696e 0a0a 2020 2020 6465 6620 7265  ugin..    def re
+00031f70: 6d6f 7665 5f70 6c75 6769 6e28 0a20 2020  move_plugin(.   
+00031f80: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00031f90: 2020 206e 616d 653a 2073 7472 207c 204e     name: str | N
+00031fa0: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+00031fb0: 2020 2020 706c 7567 696e 3a20 5363 6865      plugin: Sche
+00031fc0: 6475 6c65 7250 6c75 6769 6e20 7c20 4e6f  dulerPlugin | No
+00031fd0: 6e65 203d 204e 6f6e 652c 0a20 2020 2029  ne = None,.    )
+00031fe0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00031ff0: 2020 2222 2252 656d 6f76 6520 6578 7465    """Remove exte
+00032000: 726e 616c 2070 6c75 6769 6e20 6672 6f6d  rnal plugin from
+00032010: 2073 6368 6564 756c 6572 0a0a 2020 2020   scheduler..    
+00032020: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+00032030: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d2d         ---------
+00032040: 2d0a 2020 2020 2020 2020 6e61 6d65 203a  -.        name :
+00032050: 2073 7472 0a20 2020 2020 2020 2020 2020   str.           
+00032060: 204e 616d 6520 6f66 2074 6865 2070 6c75   Name of the plu
+00032070: 6769 6e20 746f 2072 656d 6f76 650a 2020  gin to remove.  
+00032080: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00032090: 2020 6173 7365 7274 206e 616d 6520 6973    assert name is
+000320a0: 206e 6f74 204e 6f6e 650a 0a20 2020 2020   not None..     
+000320b0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+000320c0: 2020 2020 6465 6c20 7365 6c66 2e70 6c75      del self.plu
+000320d0: 6769 6e73 5b6e 616d 655d 0a20 2020 2020  gins[name].     
+000320e0: 2020 2065 7863 6570 7420 4b65 7945 7272     except KeyErr
+000320f0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+00032100: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00032110: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00032120: 2020 6622 436f 756c 6420 6e6f 7420 6669    f"Could not fi
+00032130: 6e64 2070 6c75 6769 6e20 7b6e 616d 6521  nd plugin {name!
+00032140: 727d 2061 6d6f 6e67 2074 6865 2063 7572  r} among the cur
+00032150: 7265 6e74 2073 6368 6564 756c 6572 2070  rent scheduler p
+00032160: 6c75 6769 6e73 220a 2020 2020 2020 2020  lugins".        
+00032170: 2020 2020 290a 0a20 2020 2061 7379 6e63      )..    async
+00032180: 2064 6566 2072 6567 6973 7465 725f 7363   def register_sc
+00032190: 6865 6475 6c65 725f 706c 7567 696e 280a  heduler_plugin(.
+000321a0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+000321b0: 2020 2020 2020 706c 7567 696e 3a20 6279        plugin: by
+000321c0: 7465 7320 7c20 5363 6865 6475 6c65 7250  tes | SchedulerP
+000321d0: 6c75 6769 6e2c 0a20 2020 2020 2020 206e  lugin,.        n
+000321e0: 616d 653a 2073 7472 207c 204e 6f6e 6520  ame: str | None 
+000321f0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00032200: 6964 656d 706f 7465 6e74 3a20 626f 6f6c  idempotent: bool
+00032210: 203d 2046 616c 7365 2c0a 2020 2020 2920   = False,.    ) 
+00032220: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00032230: 2022 2222 5265 6769 7374 6572 2061 2070   """Register a p
+00032240: 6c75 6769 6e20 6f6e 2074 6865 2073 6368  lugin on the sch
+00032250: 6564 756c 6572 2e22 2222 0a20 2020 2020  eduler.""".     
+00032260: 2020 2069 6620 6e6f 7420 6461 736b 2e63     if not dask.c
+00032270: 6f6e 6669 672e 6765 7428 2264 6973 7472  onfig.get("distr
+00032280: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
+00032290: 2e70 6963 6b6c 6522 293a 0a20 2020 2020  .pickle"):.     
+000322a0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+000322b0: 7565 4572 726f 7228 0a20 2020 2020 2020  ueError(.       
+000322c0: 2020 2020 2020 2020 2022 4361 6e6e 6f74           "Cannot
+000322d0: 2072 6567 6973 7465 7220 6120 7363 6865   register a sche
+000322e0: 6475 6c65 7220 706c 7567 696e 2061 7320  duler plugin as 
+000322f0: 7468 6520 7363 6865 6475 6c65 7220 220a  the scheduler ".
+00032300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032310: 2268 6173 2062 6565 6e20 6578 706c 6963  "has been explic
+00032320: 6974 6c79 2064 6973 616c 6c6f 7765 6420  itly disallowed 
+00032330: 6672 6f6d 2064 6573 6572 6961 6c69 7a69  from deserializi
+00032340: 6e67 2022 0a20 2020 2020 2020 2020 2020  ng ".           
+00032350: 2020 2020 2022 6172 6269 7472 6172 7920       "arbitrary 
+00032360: 6279 7465 7374 7269 6e67 7320 7573 696e  bytestrings usin
+00032370: 6720 7069 636b 6c65 2076 6961 2074 6865  g pickle via the
+00032380: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00032390: 2020 2022 2764 6973 7472 6962 7574 6564     "'distributed
+000323a0: 2e73 6368 6564 756c 6572 2e70 6963 6b6c  .scheduler.pickl
+000323b0: 6527 2063 6f6e 6669 6775 7261 7469 6f6e  e' configuration
+000323c0: 2073 6574 7469 6e67 2e22 0a20 2020 2020   setting.".     
+000323d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000323e0: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
+000323f0: 6365 2870 6c75 6769 6e2c 2053 6368 6564  ce(plugin, Sched
+00032400: 756c 6572 506c 7567 696e 293a 0a20 2020  ulerPlugin):.   
+00032410: 2020 2020 2020 2020 2070 6c75 6769 6e20           plugin 
+00032420: 3d20 6c6f 6164 7328 706c 7567 696e 290a  = loads(plugin).
+00032430: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00032440: 7274 2069 7369 6e73 7461 6e63 6528 706c  rt isinstance(pl
+00032450: 7567 696e 2c20 5363 6865 6475 6c65 7250  ugin, SchedulerP
+00032460: 6c75 6769 6e29 0a0a 2020 2020 2020 2020  lugin)..        
+00032470: 6966 206e 616d 6520 6973 204e 6f6e 653a  if name is None:
+00032480: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+00032490: 6520 3d20 5f67 6574 5f70 6c75 6769 6e5f  e = _get_plugin_
+000324a0: 6e61 6d65 2870 6c75 6769 6e29 0a0a 2020  name(plugin)..  
+000324b0: 2020 2020 2020 6966 206e 616d 6520 696e        if name in
+000324c0: 2073 656c 662e 706c 7567 696e 7320 616e   self.plugins an
+000324d0: 6420 6964 656d 706f 7465 6e74 3a0a 2020  d idempotent:.  
+000324e0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000324f0: 0a0a 2020 2020 2020 2020 6966 2068 6173  ..        if has
+00032500: 6174 7472 2870 6c75 6769 6e2c 2022 7374  attr(plugin, "st
+00032510: 6172 7422 293a 0a20 2020 2020 2020 2020  art"):.         
+00032520: 2020 2072 6573 756c 7420 3d20 706c 7567     result = plug
+00032530: 696e 2e73 7461 7274 2873 656c 6629 0a20  in.start(self). 
+00032540: 2020 2020 2020 2020 2020 2069 6620 696e             if in
+00032550: 7370 6563 742e 6973 6177 6169 7461 626c  spect.isawaitabl
+00032560: 6528 7265 7375 6c74 293a 0a20 2020 2020  e(result):.     
+00032570: 2020 2020 2020 2020 2020 2061 7761 6974             await
+00032580: 2072 6573 756c 740a 0a20 2020 2020 2020   result..       
+00032590: 2073 656c 662e 6164 645f 706c 7567 696e   self.add_plugin
+000325a0: 2870 6c75 6769 6e2c 206e 616d 653d 6e61  (plugin, name=na
+000325b0: 6d65 2c20 6964 656d 706f 7465 6e74 3d69  me, idempotent=i
+000325c0: 6465 6d70 6f74 656e 7429 0a0a 2020 2020  dempotent)..    
+000325d0: 6465 6620 776f 726b 6572 5f73 656e 6428  def worker_send(
+000325e0: 7365 6c66 2c20 776f 726b 6572 3a20 7374  self, worker: st
+000325f0: 722c 206d 7367 3a20 6469 6374 5b73 7472  r, msg: dict[str
+00032600: 2c20 416e 795d 2920 2d3e 204e 6f6e 653a  , Any]) -> None:
+00032610: 0a20 2020 2020 2020 2022 2222 5365 6e64  .        """Send
+00032620: 206d 6573 7361 6765 2074 6f20 776f 726b   message to work
+00032630: 6572 0a0a 2020 2020 2020 2020 5468 6973  er..        This
+00032640: 2061 6c73 6f20 6861 6e64 6c65 7320 636f   also handles co
+00032650: 6e6e 6563 7469 6f6e 2066 6169 6c75 7265  nnection failure
+00032660: 7320 6279 2061 6464 696e 6720 6120 6361  s by adding a ca
+00032670: 6c6c 6261 636b 2074 6f20 7265 6d6f 7665  llback to remove
+00032680: 0a20 2020 2020 2020 2074 6865 2077 6f72  .        the wor
+00032690: 6b65 7220 6f6e 2074 6865 206e 6578 7420  ker on the next 
+000326a0: 6379 636c 652e 0a20 2020 2020 2020 2022  cycle..        "
+000326b0: 2222 0a20 2020 2020 2020 2073 7472 6561  "".        strea
+000326c0: 6d5f 636f 6d6d 733a 2064 6963 7420 3d20  m_comms: dict = 
+000326d0: 7365 6c66 2e73 7472 6561 6d5f 636f 6d6d  self.stream_comm
+000326e0: 730a 2020 2020 2020 2020 7472 793a 0a20  s.        try:. 
+000326f0: 2020 2020 2020 2020 2020 2073 7472 6561             strea
+00032700: 6d5f 636f 6d6d 735b 776f 726b 6572 5d2e  m_comms[worker].
+00032710: 7365 6e64 286d 7367 290a 2020 2020 2020  send(msg).      
+00032720: 2020 6578 6365 7074 2028 436f 6d6d 436c    except (CommCl
+00032730: 6f73 6564 4572 726f 722c 2041 7474 7269  osedError, Attri
+00032740: 6275 7465 4572 726f 7229 3a0a 2020 2020  buteError):.    
+00032750: 2020 2020 2020 2020 7365 6c66 2e5f 6f6e          self._on
+00032760: 676f 696e 675f 6261 636b 6772 6f75 6e64  going_background
+00032770: 5f74 6173 6b73 2e63 616c 6c5f 736f 6f6e  _tasks.call_soon
+00032780: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00032790: 2020 7365 6c66 2e72 656d 6f76 655f 776f    self.remove_wo
+000327a0: 726b 6572 2c0a 2020 2020 2020 2020 2020  rker,.          
+000327b0: 2020 2020 2020 6164 6472 6573 733d 776f        address=wo
+000327c0: 726b 6572 2c0a 2020 2020 2020 2020 2020  rker,.          
+000327d0: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
+000327e0: 643d 6622 776f 726b 6572 2d73 656e 642d  d=f"worker-send-
+000327f0: 636f 6d6d 2d66 6169 6c2d 7b74 696d 6528  comm-fail-{time(
+00032800: 297d 222c 0a20 2020 2020 2020 2020 2020  )}",.           
+00032810: 2029 0a0a 2020 2020 6465 6620 636c 6965   )..    def clie
+00032820: 6e74 5f73 656e 6428 7365 6c66 2c20 636c  nt_send(self, cl
+00032830: 6965 6e74 2c20 6d73 6729 3a0a 2020 2020  ient, msg):.    
+00032840: 2020 2020 2222 2253 656e 6420 6d65 7373      """Send mess
+00032850: 6167 6520 746f 2063 6c69 656e 7422 2222  age to client"""
+00032860: 0a20 2020 2020 2020 2063 6c69 656e 745f  .        client_
+00032870: 636f 6d6d 733a 2064 6963 7420 3d20 7365  comms: dict = se
+00032880: 6c66 2e63 6c69 656e 745f 636f 6d6d 730a  lf.client_comms.
+00032890: 2020 2020 2020 2020 6320 3d20 636c 6965          c = clie
+000328a0: 6e74 5f63 6f6d 6d73 2e67 6574 2863 6c69  nt_comms.get(cli
+000328b0: 656e 7429 0a20 2020 2020 2020 2069 6620  ent).        if 
+000328c0: 6320 6973 204e 6f6e 653a 0a20 2020 2020  c is None:.     
+000328d0: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
+000328e0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+000328f0: 2020 2020 2020 2063 2e73 656e 6428 6d73         c.send(ms
+00032900: 6729 0a20 2020 2020 2020 2065 7863 6570  g).        excep
+00032910: 7420 436f 6d6d 436c 6f73 6564 4572 726f  t CommClosedErro
+00032920: 723a 0a20 2020 2020 2020 2020 2020 2069  r:.            i
+00032930: 6620 7365 6c66 2e73 7461 7475 7320 3d3d  f self.status ==
+00032940: 2053 7461 7475 732e 7275 6e6e 696e 673a   Status.running:
+00032950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00032960: 206c 6f67 6765 722e 6372 6974 6963 616c   logger.critical
+00032970: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00032980: 2020 2020 2020 2243 6c6f 7365 6420 636f        "Closed co
+00032990: 6d6d 2025 7220 7768 696c 6520 7472 7969  mm %r while tryi
+000329a0: 6e67 2074 6f20 7772 6974 6520 2573 222c  ng to write %s",
+000329b0: 2063 2c20 6d73 672c 2065 7863 5f69 6e66   c, msg, exc_inf
+000329c0: 6f3d 5472 7565 0a20 2020 2020 2020 2020  o=True.         
+000329d0: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
+000329e0: 6620 7365 6e64 5f61 6c6c 2873 656c 662c  f send_all(self,
+000329f0: 2063 6c69 656e 745f 6d73 6773 3a20 4d73   client_msgs: Ms
+00032a00: 6773 2c20 776f 726b 6572 5f6d 7367 733a  gs, worker_msgs:
+00032a10: 204d 7367 7329 202d 3e20 4e6f 6e65 3a0a   Msgs) -> None:.
+00032a20: 2020 2020 2020 2020 2222 2253 656e 6420          """Send 
+00032a30: 6d65 7373 6167 6573 2074 6f20 636c 6965  messages to clie
+00032a40: 6e74 2061 6e64 2077 6f72 6b65 7273 2222  nt and workers""
+00032a50: 220a 0a20 2020 2020 2020 2066 6f72 2063  "..        for c
+00032a60: 6c69 656e 742c 206d 7367 7320 696e 2063  lient, msgs in c
+00032a70: 6c69 656e 745f 6d73 6773 2e69 7465 6d73  lient_msgs.items
+00032a80: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00032a90: 6320 3d20 7365 6c66 2e63 6c69 656e 745f  c = self.client_
+00032aa0: 636f 6d6d 732e 6765 7428 636c 6965 6e74  comms.get(client
+00032ab0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00032ac0: 2063 2069 7320 4e6f 6e65 3a0a 2020 2020   c is None:.    
+00032ad0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00032ae0: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
+00032af0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00032b00: 2020 2020 2020 632e 7365 6e64 282a 6d73        c.send(*ms
+00032b10: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
+00032b20: 6578 6365 7074 2043 6f6d 6d43 6c6f 7365  except CommClose
+00032b30: 6445 7272 6f72 3a0a 2020 2020 2020 2020  dError:.        
+00032b40: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00032b50: 7374 6174 7573 203d 3d20 5374 6174 7573  status == Status
+00032b60: 2e72 756e 6e69 6e67 3a0a 2020 2020 2020  .running:.      
+00032b70: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00032b80: 6767 6572 2e63 7269 7469 6361 6c28 0a20  gger.critical(. 
+00032b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032ba0: 2020 2020 2020 2022 436c 6f73 6564 2063         "Closed c
+00032bb0: 6f6d 6d20 2572 2077 6869 6c65 2074 7279  omm %r while try
+00032bc0: 696e 6720 746f 2077 7269 7465 2025 7322  ing to write %s"
+00032bd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00032be0: 2020 2020 2020 2020 2020 632c 0a20 2020            c,.   
+00032bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032c00: 2020 2020 206d 7367 732c 0a20 2020 2020       msgs,.     
+00032c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032c20: 2020 2065 7863 5f69 6e66 6f3d 5472 7565     exc_info=True
+00032c30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00032c40: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00032c50: 2066 6f72 2077 6f72 6b65 722c 206d 7367   for worker, msg
+00032c60: 7320 696e 2077 6f72 6b65 725f 6d73 6773  s in worker_msgs
+00032c70: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+00032c80: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00032c90: 2020 2020 2020 2020 2020 2077 203d 2073             w = s
+00032ca0: 656c 662e 7374 7265 616d 5f63 6f6d 6d73  elf.stream_comms
+00032cb0: 5b77 6f72 6b65 725d 0a20 2020 2020 2020  [worker].       
+00032cc0: 2020 2020 2020 2020 2077 2e73 656e 6428           w.send(
+00032cd0: 2a6d 7367 7329 0a20 2020 2020 2020 2020  *msgs).         
+00032ce0: 2020 2065 7863 6570 7420 4b65 7945 7272     except KeyErr
+00032cf0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+00032d00: 2020 2020 2320 776f 726b 6572 2061 6c72      # worker alr
+00032d10: 6561 6479 2067 6f6e 650a 2020 2020 2020  eady gone.      
+00032d20: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
+00032d30: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00032d40: 7420 2843 6f6d 6d43 6c6f 7365 6445 7272  t (CommClosedErr
+00032d50: 6f72 2c20 4174 7472 6962 7574 6545 7272  or, AttributeErr
+00032d60: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+00032d70: 2020 2020 2073 656c 662e 5f6f 6e67 6f69       self._ongoi
+00032d80: 6e67 5f62 6163 6b67 726f 756e 645f 7461  ng_background_ta
+00032d90: 736b 732e 6361 6c6c 5f73 6f6f 6e28 0a20  sks.call_soon(. 
+00032da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032db0: 2020 2073 656c 662e 7265 6d6f 7665 5f77     self.remove_w
+00032dc0: 6f72 6b65 722c 0a20 2020 2020 2020 2020  orker,.         
+00032dd0: 2020 2020 2020 2020 2020 2061 6464 7265             addre
+00032de0: 7373 3d77 6f72 6b65 722c 0a20 2020 2020  ss=worker,.     
+00032df0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00032e00: 7469 6d75 6c75 735f 6964 3d66 2273 656e  timulus_id=f"sen
+00032e10: 642d 616c 6c2d 636f 6d6d 2d66 6169 6c2d  d-all-comm-fail-
+00032e20: 7b74 696d 6528 297d 222c 0a20 2020 2020  {time()}",.     
+00032e30: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00032e40: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
+00032e50: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
+00032e60: 2020 2023 204c 6573 7320 636f 6d6d 6f6e     # Less common
+00032e70: 2069 6e74 6572 6163 7469 6f6e 7320 230a   interactions #.
+00032e80: 2020 2020 2323 2323 2323 2323 2323 2323      ############
+00032e90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00032ea0: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+00032eb0: 7363 6174 7465 7228 0a20 2020 2020 2020  scatter(.       
+00032ec0: 2073 656c 662c 0a20 2020 2020 2020 2063   self,.        c
+00032ed0: 6f6d 6d3d 4e6f 6e65 2c0a 2020 2020 2020  omm=None,.      
+00032ee0: 2020 6461 7461 3d4e 6f6e 652c 0a20 2020    data=None,.   
+00032ef0: 2020 2020 2077 6f72 6b65 7273 3d4e 6f6e       workers=Non
+00032f00: 652c 0a20 2020 2020 2020 2063 6c69 656e  e,.        clien
+00032f10: 743d 4e6f 6e65 2c0a 2020 2020 2020 2020  t=None,.        
+00032f20: 6272 6f61 6463 6173 743d 4661 6c73 652c  broadcast=False,
+00032f30: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+00032f40: 3d32 2c0a 2020 2020 293a 0a20 2020 2020  =2,.    ):.     
+00032f50: 2020 2022 2222 5365 6e64 2064 6174 6120     """Send data 
+00032f60: 6f75 7420 746f 2077 6f72 6b65 7273 0a0a  out to workers..
+00032f70: 2020 2020 2020 2020 5365 6520 616c 736f          See also
+00032f80: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+00032f90: 2d0a 2020 2020 2020 2020 5363 6865 6475  -.        Schedu
+00032fa0: 6c65 722e 6272 6f61 6463 6173 743a 0a20  ler.broadcast:. 
+00032fb0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00032fc0: 2020 2073 7461 7274 203d 2074 696d 6528     start = time(
+00032fd0: 290a 2020 2020 2020 2020 7768 696c 6520  ).        while 
+00032fe0: 5472 7565 3a0a 2020 2020 2020 2020 2020  True:.          
+00032ff0: 2020 6966 2077 6f72 6b65 7273 2069 7320    if workers is 
+00033000: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00033010: 2020 2020 2020 7773 7320 3d20 7365 6c66        wss = self
+00033020: 2e72 756e 6e69 6e67 0a20 2020 2020 2020  .running.       
+00033030: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00033040: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
+00033050: 7273 203d 205b 7365 6c66 2e63 6f65 7263  rs = [self.coerc
+00033060: 655f 6164 6472 6573 7328 7729 2066 6f72  e_address(w) for
+00033070: 2077 2069 6e20 776f 726b 6572 735d 0a20   w in workers]. 
+00033080: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00033090: 7373 203d 207b 7365 6c66 2e77 6f72 6b65  ss = {self.worke
+000330a0: 7273 5b77 5d20 666f 7220 7720 696e 2077  rs[w] for w in w
+000330b0: 6f72 6b65 7273 7d0a 2020 2020 2020 2020  orkers}.        
+000330c0: 2020 2020 2020 2020 7773 7320 3d20 7b77          wss = {w
+000330d0: 7320 666f 7220 7773 2069 6e20 7773 7320  s for ws in wss 
+000330e0: 6966 2077 732e 7374 6174 7573 203d 3d20  if ws.status == 
+000330f0: 5374 6174 7573 2e72 756e 6e69 6e67 7d0a  Status.running}.
+00033100: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00033110: 7773 733a 0a20 2020 2020 2020 2020 2020  wss:.           
+00033120: 2020 2020 2062 7265 616b 0a20 2020 2020       break.     
+00033130: 2020 2020 2020 2069 6620 7469 6d65 2829         if time()
+00033140: 203e 2073 7461 7274 202b 2074 696d 656f   > start + timeo
+00033150: 7574 3a0a 2020 2020 2020 2020 2020 2020  ut:.            
+00033160: 2020 2020 7261 6973 6520 5469 6d65 6f75      raise Timeou
+00033170: 7445 7272 6f72 2822 4e6f 2076 616c 6964  tError("No valid
+00033180: 2077 6f72 6b65 7273 2066 6f75 6e64 2229   workers found")
+00033190: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+000331a0: 6974 2061 7379 6e63 696f 2e73 6c65 6570  it asyncio.sleep
+000331b0: 2830 2e31 290a 0a20 2020 2020 2020 206e  (0.1)..        n
+000331c0: 7468 7265 6164 7320 3d20 7b77 732e 6164  threads = {ws.ad
+000331d0: 6472 6573 733a 2077 732e 6e74 6872 6561  dress: ws.nthrea
+000331e0: 6473 2066 6f72 2077 7320 696e 2077 7373  ds for ws in wss
+000331f0: 7d0a 0a20 2020 2020 2020 2061 7373 6572  }..        asser
+00033200: 7420 6973 696e 7374 616e 6365 2864 6174  t isinstance(dat
+00033210: 612c 2064 6963 7429 0a0a 2020 2020 2020  a, dict)..      
+00033220: 2020 6b65 7973 2c20 7768 6f5f 6861 732c    keys, who_has,
+00033230: 206e 6279 7465 7320 3d20 6177 6169 7420   nbytes = await 
+00033240: 7363 6174 7465 725f 746f 5f77 6f72 6b65  scatter_to_worke
+00033250: 7273 286e 7468 7265 6164 732c 2064 6174  rs(nthreads, dat
+00033260: 612c 2072 7063 3d73 656c 662e 7270 6329  a, rpc=self.rpc)
+00033270: 0a0a 2020 2020 2020 2020 7365 6c66 2e75  ..        self.u
+00033280: 7064 6174 655f 6461 7461 2877 686f 5f68  pdate_data(who_h
+00033290: 6173 3d77 686f 5f68 6173 2c20 6e62 7974  as=who_has, nbyt
+000332a0: 6573 3d6e 6279 7465 732c 2063 6c69 656e  es=nbytes, clien
+000332b0: 743d 636c 6965 6e74 290a 0a20 2020 2020  t=client)..     
+000332c0: 2020 2069 6620 6272 6f61 6463 6173 743a     if broadcast:
+000332d0: 0a20 2020 2020 2020 2020 2020 206e 203d  .            n =
+000332e0: 206c 656e 286e 7468 7265 6164 7329 2069   len(nthreads) i
+000332f0: 6620 6272 6f61 6463 6173 7420 6973 2054  f broadcast is T
+00033300: 7275 6520 656c 7365 2062 726f 6164 6361  rue else broadca
+00033310: 7374 0a20 2020 2020 2020 2020 2020 2061  st.            a
+00033320: 7761 6974 2073 656c 662e 7265 706c 6963  wait self.replic
+00033330: 6174 6528 6b65 7973 3d6b 6579 732c 2077  ate(keys=keys, w
+00033340: 6f72 6b65 7273 3d77 6f72 6b65 7273 2c20  orkers=workers, 
+00033350: 6e3d 6e29 0a0a 2020 2020 2020 2020 7365  n=n)..        se
+00033360: 6c66 2e6c 6f67 5f65 7665 6e74 280a 2020  lf.log_event(.  
+00033370: 2020 2020 2020 2020 2020 5b63 6c69 656e            [clien
+00033380: 742c 2022 616c 6c22 5d2c 207b 2261 6374  t, "all"], {"act
+00033390: 696f 6e22 3a20 2273 6361 7474 6572 222c  ion": "scatter",
+000333a0: 2022 636c 6965 6e74 223a 2063 6c69 656e   "client": clien
+000333b0: 742c 2022 636f 756e 7422 3a20 6c65 6e28  t, "count": len(
+000333c0: 6461 7461 297d 0a20 2020 2020 2020 2029  data)}.        )
+000333d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000333e0: 6b65 7973 0a0a 2020 2020 6173 796e 6320  keys..    async 
+000333f0: 6465 6620 6761 7468 6572 2873 656c 662c  def gather(self,
+00033400: 206b 6579 732c 2073 6572 6961 6c69 7a65   keys, serialize
+00033410: 7273 3d4e 6f6e 6529 3a0a 2020 2020 2020  rs=None):.      
+00033420: 2020 2222 2243 6f6c 6c65 6374 2064 6174    """Collect dat
+00033430: 6120 6672 6f6d 2077 6f72 6b65 7273 2074  a from workers t
+00033440: 6f20 7468 6520 7363 6865 6475 6c65 7222  o the scheduler"
+00033450: 2222 0a20 2020 2020 2020 2073 7469 6d75  "".        stimu
+00033460: 6c75 735f 6964 203d 2066 2267 6174 6865  lus_id = f"gathe
+00033470: 722d 7b74 696d 6528 297d 220a 2020 2020  r-{time()}".    
+00033480: 2020 2020 6b65 7973 203d 206c 6973 7428      keys = list(
+00033490: 6b65 7973 290a 2020 2020 2020 2020 7768  keys).        wh
+000334a0: 6f5f 6861 7320 3d20 7b7d 0a20 2020 2020  o_has = {}.     
+000334b0: 2020 2066 6f72 206b 6579 2069 6e20 6b65     for key in ke
+000334c0: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
+000334d0: 7473 3a20 5461 736b 5374 6174 6520 3d20  ts: TaskState = 
+000334e0: 7365 6c66 2e74 6173 6b73 2e67 6574 286b  self.tasks.get(k
+000334f0: 6579 290a 2020 2020 2020 2020 2020 2020  ey).            
+00033500: 6966 2074 7320 6973 206e 6f74 204e 6f6e  if ts is not Non
+00033510: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00033520: 2020 2077 686f 5f68 6173 5b6b 6579 5d20     who_has[key] 
+00033530: 3d20 5b77 732e 6164 6472 6573 7320 666f  = [ws.address fo
+00033540: 7220 7773 2069 6e20 7473 2e77 686f 5f68  r ws in ts.who_h
+00033550: 6173 5d0a 2020 2020 2020 2020 2020 2020  as].            
+00033560: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00033570: 2020 2020 2020 7768 6f5f 6861 735b 6b65        who_has[ke
+00033580: 795d 203d 205b 5d0a 0a20 2020 2020 2020  y] = []..       
+00033590: 2064 6174 612c 206d 6973 7369 6e67 5f6b   data, missing_k
+000335a0: 6579 732c 206d 6973 7369 6e67 5f77 6f72  eys, missing_wor
+000335b0: 6b65 7273 203d 2061 7761 6974 2067 6174  kers = await gat
+000335c0: 6865 725f 6672 6f6d 5f77 6f72 6b65 7273  her_from_workers
+000335d0: 280a 2020 2020 2020 2020 2020 2020 7768  (.            wh
+000335e0: 6f5f 6861 732c 2072 7063 3d73 656c 662e  o_has, rpc=self.
+000335f0: 7270 632c 2063 6c6f 7365 3d46 616c 7365  rpc, close=False
+00033600: 2c20 7365 7269 616c 697a 6572 733d 7365  , serializers=se
+00033610: 7269 616c 697a 6572 730a 2020 2020 2020  rializers.      
+00033620: 2020 290a 2020 2020 2020 2020 6966 206e    ).        if n
+00033630: 6f74 206d 6973 7369 6e67 5f6b 6579 733a  ot missing_keys:
+00033640: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+00033650: 756c 7420 3d20 7b22 7374 6174 7573 223a  ult = {"status":
+00033660: 2022 4f4b 222c 2022 6461 7461 223a 2064   "OK", "data": d
+00033670: 6174 617d 0a20 2020 2020 2020 2065 6c73  ata}.        els
+00033680: 653a 0a20 2020 2020 2020 2020 2020 206d  e:.            m
+00033690: 6973 7369 6e67 5f73 7461 7465 7320 3d20  issing_states = 
+000336a0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+000336b0: 2020 2873 656c 662e 7461 736b 735b 6b65    (self.tasks[ke
+000336c0: 795d 2e73 7461 7465 2069 6620 6b65 7920  y].state if key 
+000336d0: 696e 2073 656c 662e 7461 736b 7320 656c  in self.tasks el
+000336e0: 7365 204e 6f6e 6529 0a20 2020 2020 2020  se None).       
+000336f0: 2020 2020 2020 2020 2066 6f72 206b 6579           for key
+00033700: 2069 6e20 6d69 7373 696e 675f 6b65 7973   in missing_keys
+00033710: 0a20 2020 2020 2020 2020 2020 205d 0a20  .            ]. 
+00033720: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+00033730: 722e 6578 6365 7074 696f 6e28 0a20 2020  r.exception(.   
+00033740: 2020 2020 2020 2020 2020 2020 2022 436f               "Co
+00033750: 756c 646e 2774 2067 6174 6865 7220 6b65  uldn't gather ke
+00033760: 7973 2025 7320 7374 6174 653a 2025 7320  ys %s state: %s 
+00033770: 776f 726b 6572 733a 2025 7322 2c0a 2020  workers: %s",.  
+00033780: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
+00033790: 7373 696e 675f 6b65 7973 2c0a 2020 2020  ssing_keys,.    
+000337a0: 2020 2020 2020 2020 2020 2020 6d69 7373              miss
+000337b0: 696e 675f 7374 6174 6573 2c0a 2020 2020  ing_states,.    
+000337c0: 2020 2020 2020 2020 2020 2020 6d69 7373              miss
+000337d0: 696e 675f 776f 726b 6572 732c 0a20 2020  ing_workers,.   
+000337e0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000337f0: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+00033800: 7b22 7374 6174 7573 223a 2022 6572 726f  {"status": "erro
+00033810: 7222 2c20 226b 6579 7322 3a20 6d69 7373  r", "keys": miss
+00033820: 696e 675f 6b65 7973 7d0a 2020 2020 2020  ing_keys}.      
+00033830: 2020 2020 2020 7769 7468 206c 6f67 5f65        with log_e
+00033840: 7272 6f72 7328 293a 0a20 2020 2020 2020  rrors():.       
+00033850: 2020 2020 2020 2020 2023 2052 656d 6f76           # Remov
+00033860: 6520 7375 7370 6963 696f 7573 2077 6f72  e suspicious wor
+00033870: 6b65 7273 2066 726f 6d20 7468 6520 7363  kers from the sc
+00033880: 6865 6475 6c65 7220 616e 6420 7368 7574  heduler and shut
+00033890: 2074 6865 6d20 646f 776e 2e0a 2020 2020   them down..    
+000338a0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+000338b0: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
+000338c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000338d0: 2020 2020 2020 2a28 0a20 2020 2020 2020        *(.       
+000338e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000338f0: 2073 656c 662e 7265 6d6f 7665 5f77 6f72   self.remove_wor
+00033900: 6b65 7228 0a20 2020 2020 2020 2020 2020  ker(.           
+00033910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033920: 2061 6464 7265 7373 3d77 6f72 6b65 722c   address=worker,
+00033930: 2063 6c6f 7365 3d54 7275 652c 2073 7469   close=True, sti
+00033940: 6d75 6c75 735f 6964 3d73 7469 6d75 6c75  mulus_id=stimulu
+00033950: 735f 6964 0a20 2020 2020 2020 2020 2020  s_id.           
+00033960: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00033970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033980: 2020 2020 2020 2066 6f72 2077 6f72 6b65         for worke
+00033990: 7220 696e 206d 6973 7369 6e67 5f77 6f72  r in missing_wor
+000339a0: 6b65 7273 0a20 2020 2020 2020 2020 2020  kers.           
+000339b0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000339c0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+000339d0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+000339e0: 206b 6579 2c20 776f 726b 6572 7320 696e   key, workers in
+000339f0: 206d 6973 7369 6e67 5f6b 6579 732e 6974   missing_keys.it
+00033a00: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
+00033a10: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+00033a20: 722e 6578 6365 7074 696f 6e28 0a20 2020  r.exception(.   
+00033a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033a40: 2020 2020 2022 5368 7574 2064 6f77 6e20       "Shut down 
+00033a50: 776f 726b 6572 7320 7468 6174 2064 6f6e  workers that don
+00033a60: 2774 2068 6176 6520 7072 6f6d 6973 6564  't have promised
+00033a70: 206b 6579 3a20 2573 2c20 2573 222c 0a20   key: %s, %s",. 
+00033a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033a90: 2020 2020 2020 2073 7472 2877 6f72 6b65         str(worke
+00033aa0: 7273 292c 0a20 2020 2020 2020 2020 2020  rs),.           
+00033ab0: 2020 2020 2020 2020 2020 2020 2073 7472               str
+00033ac0: 286b 6579 292c 0a20 2020 2020 2020 2020  (key),.         
+00033ad0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00033ae0: 2020 2020 2020 7365 6c66 2e6c 6f67 5f65        self.log_e
+00033af0: 7665 6e74 2822 616c 6c22 2c20 7b22 6163  vent("all", {"ac
+00033b00: 7469 6f6e 223a 2022 6761 7468 6572 222c  tion": "gather",
+00033b10: 2022 636f 756e 7422 3a20 6c65 6e28 6b65   "count": len(ke
+00033b20: 7973 297d 290a 2020 2020 2020 2020 7265  ys)}).        re
+00033b30: 7475 726e 2072 6573 756c 740a 0a20 2020  turn result..   
+00033b40: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
+00033b50: 2061 7379 6e63 2064 6566 2072 6573 7461   async def resta
+00033b60: 7274 2873 656c 662c 2063 6c69 656e 743d  rt(self, client=
+00033b70: 4e6f 6e65 2c20 7469 6d65 6f75 743d 3330  None, timeout=30
+00033b80: 2c20 7761 6974 5f66 6f72 5f77 6f72 6b65  , wait_for_worke
+00033b90: 7273 3d54 7275 6529 3a0a 2020 2020 2020  rs=True):.      
+00033ba0: 2020 2222 220a 2020 2020 2020 2020 5265    """.        Re
+00033bb0: 7374 6172 7420 616c 6c20 776f 726b 6572  start all worker
+00033bc0: 732e 2052 6573 6574 206c 6f63 616c 2073  s. Reset local s
+00033bd0: 7461 7465 2e20 4f70 7469 6f6e 616c 6c79  tate. Optionally
+00033be0: 2077 6169 7420 666f 7220 776f 726b 6572   wait for worker
+00033bf0: 7320 746f 2072 6574 7572 6e2e 0a0a 2020  s to return...  
+00033c00: 2020 2020 2020 576f 726b 6572 7320 7769        Workers wi
+00033c10: 7468 6f75 7420 6e61 6e6e 6965 7320 6172  thout nannies ar
+00033c20: 6520 7368 7574 2064 6f77 6e2c 2068 6f70  e shut down, hop
+00033c30: 696e 6720 616e 2065 7874 6572 6e61 6c20  ing an external 
+00033c40: 6465 706c 6f79 6d65 6e74 2073 7973 7465  deployment syste
+00033c50: 6d0a 2020 2020 2020 2020 7769 6c6c 2072  m.        will r
+00033c60: 6573 7461 7274 2074 6865 6d2e 2054 6865  estart them. The
+00033c70: 7265 666f 7265 2c20 6966 206e 6f74 2075  refore, if not u
+00033c80: 7369 6e67 206e 616e 6e69 6573 2061 6e64  sing nannies and
+00033c90: 2079 6f75 7220 6465 706c 6f79 6d65 6e74   your deployment
+00033ca0: 2073 7973 7465 6d0a 2020 2020 2020 2020   system.        
+00033cb0: 646f 6573 206e 6f74 2061 7574 6f6d 6174  does not automat
+00033cc0: 6963 616c 6c79 2072 6573 7461 7274 2077  ically restart w
+00033cd0: 6f72 6b65 7273 2c20 6060 7265 7374 6172  orkers, ``restar
+00033ce0: 7460 6020 7769 6c6c 206a 7573 7420 7368  t`` will just sh
+00033cf0: 7574 2064 6f77 6e20 616c 6c0a 2020 2020  ut down all.    
+00033d00: 2020 2020 776f 726b 6572 732c 2074 6865      workers, the
+00033d10: 6e20 7469 6d65 206f 7574 210a 0a20 2020  n time out!..   
+00033d20: 2020 2020 2041 6674 6572 2060 6072 6573       After ``res
+00033d30: 7461 7274 6060 2c20 616c 6c20 636f 6e6e  tart``, all conn
+00033d40: 6563 7465 6420 776f 726b 6572 7320 6172  ected workers ar
+00033d50: 6520 6e65 772c 2072 6567 6172 646c 6573  e new, regardles
+00033d60: 7320 6f66 2077 6865 7468 6572 2060 6054  s of whether ``T
+00033d70: 696d 656f 7574 4572 726f 7260 600a 2020  imeoutError``.  
+00033d80: 2020 2020 2020 7761 7320 7261 6973 6564        was raised
+00033d90: 2e20 416e 7920 776f 726b 6572 7320 7468  . Any workers th
+00033da0: 6174 2066 6169 6c65 6420 746f 2073 6875  at failed to shu
+00033db0: 7420 646f 776e 2069 6e20 7469 6d65 2061  t down in time a
+00033dc0: 7265 2072 656d 6f76 6564 2c20 616e 640a  re removed, and.
+00033dd0: 2020 2020 2020 2020 6d61 7920 6f72 206d          may or m
+00033de0: 6179 206e 6f74 2073 6875 7420 646f 776e  ay not shut down
+00033df0: 206f 6e20 7468 6569 7220 6f77 6e20 696e   on their own in
+00033e00: 2074 6865 2066 7574 7572 652e 0a0a 2020   the future...  
+00033e10: 2020 2020 2020 5061 7261 6d65 7465 7273        Parameters
+00033e20: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+00033e30: 2d2d 2d0a 2020 2020 2020 2020 7469 6d65  ---.        time
+00033e40: 6f75 743a 0a20 2020 2020 2020 2020 2020  out:.           
+00033e50: 2048 6f77 206c 6f6e 6720 746f 2077 6169   How long to wai
+00033e60: 7420 666f 7220 776f 726b 6572 7320 746f  t for workers to
+00033e70: 2073 6875 7420 646f 776e 2061 6e64 2063   shut down and c
+00033e80: 6f6d 6520 6261 636b 2c20 6966 2060 6077  ome back, if ``w
+00033e90: 6169 745f 666f 725f 776f 726b 6572 7360  ait_for_workers`
+00033ea0: 600a 2020 2020 2020 2020 2020 2020 6973  `.            is
+00033eb0: 2054 7275 652c 206f 7468 6572 7769 7365   True, otherwise
+00033ec0: 206a 7573 7420 686f 7720 6c6f 6e67 2074   just how long t
+00033ed0: 6f20 7761 6974 2066 6f72 2077 6f72 6b65  o wait for worke
+00033ee0: 7273 2074 6f20 7368 7574 2064 6f77 6e2e  rs to shut down.
+00033ef0: 0a20 2020 2020 2020 2020 2020 2052 6169  .            Rai
+00033f00: 7365 7320 6060 6173 796e 6369 6f2e 5469  ses ``asyncio.Ti
+00033f10: 6d65 6f75 7445 7272 6f72 6060 2069 6620  meoutError`` if 
+00033f20: 7468 6973 2069 7320 6578 6365 6564 6564  this is exceeded
+00033f30: 2e0a 2020 2020 2020 2020 7761 6974 5f66  ..        wait_f
+00033f40: 6f72 5f77 6f72 6b65 7273 3a0a 2020 2020  or_workers:.    
+00033f50: 2020 2020 2020 2020 5768 6574 6865 7220          Whether 
+00033f60: 746f 2077 6169 7420 666f 7220 616c 6c20  to wait for all 
+00033f70: 776f 726b 6572 7320 746f 2072 6563 6f6e  workers to recon
+00033f80: 6e65 6374 2c20 6f72 206a 7573 7420 666f  nect, or just fo
+00033f90: 7220 7468 656d 2074 6f20 7368 7574 2064  r them to shut d
+00033fa0: 6f77 6e0a 2020 2020 2020 2020 2020 2020  own.            
+00033fb0: 2864 6566 6175 6c74 2054 7275 6529 2e20  (default True). 
+00033fc0: 5573 6520 6060 7265 7374 6172 7428 7761  Use ``restart(wa
+00033fd0: 6974 5f66 6f72 5f77 6f72 6b65 7273 3d46  it_for_workers=F
+00033fe0: 616c 7365 2960 6020 636f 6d62 696e 6564  alse)`` combined
+00033ff0: 2077 6974 680a 2020 2020 2020 2020 2020   with.          
+00034000: 2020 3a6d 6574 683a 6043 6c69 656e 742e    :meth:`Client.
+00034010: 7761 6974 5f66 6f72 5f77 6f72 6b65 7273  wait_for_workers
+00034020: 6020 666f 7220 6772 616e 756c 6172 2063  ` for granular c
+00034030: 6f6e 7472 6f6c 206f 7665 7220 686f 7720  ontrol over how 
+00034040: 6d61 6e79 2077 6f72 6b65 7273 2074 6f0a  many workers to.
+00034050: 2020 2020 2020 2020 2020 2020 7761 6974              wait
+00034060: 2066 6f72 2e0a 0a20 2020 2020 2020 2053   for...        S
+00034070: 6565 2061 6c73 6f0a 2020 2020 2020 2020  ee also.        
+00034080: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
+00034090: 2043 6c69 656e 742e 7265 7374 6172 740a   Client.restart.
+000340a0: 2020 2020 2020 2020 436c 6965 6e74 2e72          Client.r
+000340b0: 6573 7461 7274 5f77 6f72 6b65 7273 0a20  estart_workers. 
+000340c0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+000340d0: 2020 2073 7469 6d75 6c75 735f 6964 203d     stimulus_id =
+000340e0: 2066 2272 6573 7461 7274 2d7b 7469 6d65   f"restart-{time
+000340f0: 2829 7d22 0a0a 2020 2020 2020 2020 6c6f  ()}"..        lo
+00034100: 6767 6572 2e69 6e66 6f28 2252 6573 7461  gger.info("Resta
+00034110: 7274 696e 6720 776f 726b 6572 7320 616e  rting workers an
+00034120: 6420 7265 6c65 6173 696e 6720 616c 6c20  d releasing all 
+00034130: 6b65 7973 2e22 290a 2020 2020 2020 2020  keys.").        
+00034140: 666f 7220 6373 2069 6e20 7365 6c66 2e63  for cs in self.c
+00034150: 6c69 656e 7473 2e76 616c 7565 7328 293a  lients.values():
+00034160: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00034170: 662e 636c 6965 6e74 5f72 656c 6561 7365  f.client_release
+00034180: 735f 6b65 7973 280a 2020 2020 2020 2020  s_keys(.        
+00034190: 2020 2020 2020 2020 6b65 7973 3d5b 7473          keys=[ts
+000341a0: 2e6b 6579 2066 6f72 2074 7320 696e 2063  .key for ts in c
+000341b0: 732e 7761 6e74 735f 7768 6174 5d2c 0a20  s.wants_what],. 
+000341c0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000341d0: 6c69 656e 743d 6373 2e63 6c69 656e 745f  lient=cs.client_
+000341e0: 6b65 792c 0a20 2020 2020 2020 2020 2020  key,.           
+000341f0: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
+00034200: 3d73 7469 6d75 6c75 735f 6964 2c0a 2020  =stimulus_id,.  
+00034210: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00034220: 2020 2020 2073 656c 662e 5f63 6c65 6172       self._clear
+00034230: 5f74 6173 6b5f 7374 6174 6528 290a 2020  _task_state().  
+00034240: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+00034250: 2073 656c 662e 7461 736b 730a 2020 2020   self.tasks.    
+00034260: 2020 2020 7365 6c66 2e72 6570 6f72 7428      self.report(
+00034270: 7b22 6f70 223a 2022 7265 7374 6172 7422  {"op": "restart"
+00034280: 7d29 0a0a 2020 2020 2020 2020 666f 7220  })..        for 
+00034290: 706c 7567 696e 2069 6e20 6c69 7374 2873  plugin in list(s
+000342a0: 656c 662e 706c 7567 696e 732e 7661 6c75  elf.plugins.valu
+000342b0: 6573 2829 293a 0a20 2020 2020 2020 2020  es()):.         
+000342c0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+000342d0: 2020 2020 2020 2020 706c 7567 696e 2e72          plugin.r
+000342e0: 6573 7461 7274 2873 656c 6629 0a20 2020  estart(self).   
+000342f0: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+00034300: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
+00034310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034320: 6c6f 6767 6572 2e65 7863 6570 7469 6f6e  logger.exception
+00034330: 2865 290a 0a20 2020 2020 2020 206e 5f77  (e)..        n_w
+00034340: 6f72 6b65 7273 203d 206c 656e 2873 656c  orkers = len(sel
+00034350: 662e 776f 726b 6572 7329 0a20 2020 2020  f.workers).     
+00034360: 2020 206e 616e 6e79 5f77 6f72 6b65 7273     nanny_workers
+00034370: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+00034380: 2061 6464 723a 2077 732e 6e61 6e6e 7920   addr: ws.nanny 
+00034390: 666f 7220 6164 6472 2c20 7773 2069 6e20  for addr, ws in 
+000343a0: 7365 6c66 2e77 6f72 6b65 7273 2e69 7465  self.workers.ite
+000343b0: 6d73 2829 2069 6620 7773 2e6e 616e 6e79  ms() if ws.nanny
+000343c0: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
+000343d0: 2020 2023 2043 6c6f 7365 206e 6f6e 2d4e     # Close non-N
+000343e0: 616e 6e79 2077 6f72 6b65 7273 2e20 5765  anny workers. We
+000343f0: 2068 6176 6520 6e6f 2077 6179 2074 6f20   have no way to 
+00034400: 7265 7374 6172 7420 7468 656d 2c20 736f  restart them, so
+00034410: 2077 6520 6a75 7374 206c 6574 2074 6865   we just let the
+00034420: 6d20 676f 2c0a 2020 2020 2020 2020 2320  m go,.        # 
+00034430: 616e 6420 6173 7375 6d65 2061 2064 6570  and assume a dep
+00034440: 6c6f 796d 656e 7420 7379 7374 656d 2069  loyment system i
+00034450: 7320 676f 696e 6720 746f 2072 6573 7461  s going to resta
+00034460: 7274 2074 6865 6d20 666f 7220 7573 2e0a  rt them for us..
+00034470: 2020 2020 2020 2020 6177 6169 7420 6173          await as
+00034480: 796e 6369 6f2e 6761 7468 6572 280a 2020  yncio.gather(.  
+00034490: 2020 2020 2020 2020 2020 2a28 0a20 2020            *(.   
+000344a0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+000344b0: 662e 7265 6d6f 7665 5f77 6f72 6b65 7228  f.remove_worker(
+000344c0: 6164 6472 6573 733d 6164 6472 2c20 7374  address=addr, st
+000344d0: 696d 756c 7573 5f69 643d 7374 696d 756c  imulus_id=stimul
+000344e0: 7573 5f69 6429 0a20 2020 2020 2020 2020  us_id).         
+000344f0: 2020 2020 2020 2066 6f72 2061 6464 7220         for addr 
+00034500: 696e 2073 656c 662e 776f 726b 6572 730a  in self.workers.
+00034510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034520: 6966 2061 6464 7220 6e6f 7420 696e 206e  if addr not in n
+00034530: 616e 6e79 5f77 6f72 6b65 7273 0a20 2020  anny_workers.   
+00034540: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00034550: 2020 2029 0a0a 2020 2020 2020 2020 6c6f     )..        lo
+00034560: 6767 6572 2e64 6562 7567 2822 5365 6e64  gger.debug("Send
+00034570: 206b 696c 6c20 7369 676e 616c 2074 6f20   kill signal to 
+00034580: 6e61 6e6e 6965 733a 2025 7322 2c20 6e61  nannies: %s", na
+00034590: 6e6e 795f 776f 726b 6572 7329 0a20 2020  nny_workers).   
+000345a0: 2020 2020 2061 7379 6e63 2077 6974 6820       async with 
+000345b0: 636f 6e74 6578 746c 6962 2e41 7379 6e63  contextlib.Async
+000345c0: 4578 6974 5374 6163 6b28 2920 6173 2073  ExitStack() as s
+000345d0: 7461 636b 3a0a 2020 2020 2020 2020 2020  tack:.          
+000345e0: 2020 6e61 6e6e 6965 7320 3d20 6177 6169    nannies = awai
+000345f0: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
+00034600: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00034610: 2020 2a28 0a20 2020 2020 2020 2020 2020    *(.           
+00034620: 2020 2020 2020 2020 2073 7461 636b 2e65           stack.e
+00034630: 6e74 6572 5f61 7379 6e63 5f63 6f6e 7465  nter_async_conte
+00034640: 7874 280a 2020 2020 2020 2020 2020 2020  xt(.            
+00034650: 2020 2020 2020 2020 2020 2020 7270 6328              rpc(
+00034660: 6e61 6e6e 795f 6164 6472 6573 732c 2063  nanny_address, c
+00034670: 6f6e 6e65 6374 696f 6e5f 6172 6773 3d73  onnection_args=s
+00034680: 656c 662e 636f 6e6e 6563 7469 6f6e 5f61  elf.connection_a
+00034690: 7267 7329 0a20 2020 2020 2020 2020 2020  rgs).           
+000346a0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000346b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000346c0: 6f72 206e 616e 6e79 5f61 6464 7265 7373  or nanny_address
+000346d0: 2069 6e20 6e61 6e6e 795f 776f 726b 6572   in nanny_worker
+000346e0: 732e 7661 6c75 6573 2829 0a20 2020 2020  s.values().     
+000346f0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00034700: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00034710: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
+00034720: 6d6f 6e6f 746f 6e69 6328 290a 2020 2020  monotonic().    
+00034730: 2020 2020 2020 2020 7265 7370 7320 3d20          resps = 
+00034740: 6177 6169 7420 6173 796e 6369 6f2e 6761  await asyncio.ga
+00034750: 7468 6572 280a 2020 2020 2020 2020 2020  ther(.          
+00034760: 2020 2020 2020 2a28 0a20 2020 2020 2020        *(.       
+00034770: 2020 2020 2020 2020 2020 2020 2077 6169               wai
+00034780: 745f 666f 7228 0a20 2020 2020 2020 2020  t_for(.         
+00034790: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000347a0: 2046 4958 4d45 2064 6f65 7320 6e6f 7420   FIXME does not 
+000347b0: 7261 6973 6520 6966 2074 6865 2070 726f  raise if the pro
+000347c0: 6365 7373 2066 6169 6c73 2074 6f20 7368  cess fails to sh
+000347d0: 7574 2064 6f77 6e2c 0a20 2020 2020 2020  ut down,.       
+000347e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000347f0: 2023 2073 6565 2068 7474 7073 3a2f 2f67   # see https://g
+00034800: 6974 6875 622e 636f 6d2f 6461 736b 2f64  ithub.com/dask/d
+00034810: 6973 7472 6962 7574 6564 2f70 756c 6c2f  istributed/pull/
+00034820: 3634 3237 2f66 696c 6573 2372 3839 3439  6427/files#r8949
+00034830: 3137 3432 340a 2020 2020 2020 2020 2020  17424.          
+00034840: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00034850: 4e4f 5445 3a20 4e61 6e6e 7920 7769 6c6c  NOTE: Nanny will
+00034860: 2061 7574 6f6d 6174 6963 616c 6c79 2072   automatically r
+00034870: 6573 7461 7274 2077 6f72 6b65 7220 7072  estart worker pr
+00034880: 6f63 6573 7320 7768 656e 2069 7427 7320  ocess when it's 
+00034890: 6b69 6c6c 6564 0a20 2020 2020 2020 2020  killed.         
+000348a0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+000348b0: 616e 6e79 2e6b 696c 6c28 0a20 2020 2020  anny.kill(.     
+000348c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000348d0: 2020 2020 2020 2072 6561 736f 6e3d 2273         reason="s
+000348e0: 6368 6564 756c 6572 2d72 6573 7461 7274  cheduler-restart
+000348f0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00034900: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00034910: 696d 656f 7574 3d74 696d 656f 7574 2c0a  imeout=timeout,.
+00034920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034930: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
 00034940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034950: 6164 6472 2066 6f72 2061 6464 722c 2072  addr for addr, r
-00034960: 6573 7020 696e 207a 6970 286e 616e 6e79  esp in zip(nanny
-00034970: 5f77 6f72 6b65 7273 2c20 7265 7370 7329  _workers, resps)
-00034980: 2069 6620 7265 7370 2069 7320 6e6f 7420   if resp is not 
-00034990: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-000349a0: 205d 0a20 2020 2020 2020 2020 2020 2069   ].            i
-000349b0: 6620 6261 645f 6e61 6e6e 6965 733a 0a20  f bad_nannies:. 
-000349c0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-000349d0: 7761 6974 2061 7379 6e63 696f 2e67 6174  wait asyncio.gat
-000349e0: 6865 7228 0a20 2020 2020 2020 2020 2020  her(.           
-000349f0: 2020 2020 2020 2020 202a 280a 2020 2020           *(.    
-00034a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034a10: 2020 2020 7365 6c66 2e72 656d 6f76 655f      self.remove_
-00034a20: 776f 726b 6572 2861 6464 722c 2073 7469  worker(addr, sti
-00034a30: 6d75 6c75 735f 6964 3d73 7469 6d75 6c75  mulus_id=stimulu
-00034a40: 735f 6964 290a 2020 2020 2020 2020 2020  s_id).          
-00034a50: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00034a60: 7220 6164 6472 2069 6e20 6261 645f 6e61  r addr in bad_na
-00034a70: 6e6e 6965 730a 2020 2020 2020 2020 2020  nnies.          
-00034a80: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00034a90: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-00034aa0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00034ab0: 6169 7365 2054 696d 656f 7574 4572 726f  aise TimeoutErro
-00034ac0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-00034ad0: 2020 2020 2020 2066 227b 6c65 6e28 6261         f"{len(ba
-00034ae0: 645f 6e61 6e6e 6965 7329 7d2f 7b6c 656e  d_nannies)}/{len
-00034af0: 286e 616e 6e69 6573 297d 206e 616e 6e79  (nannies)} nanny
-00034b00: 2077 6f72 6b65 7228 7329 2064 6964 206e   worker(s) did n
-00034b10: 6f74 2073 6875 7420 646f 776e 2077 6974  ot shut down wit
-00034b20: 6869 6e20 7b74 696d 656f 7574 7d73 220a  hin {timeout}s".
-00034b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034b40: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00034b50: 6c6f 675f 6576 656e 7428 5b63 6c69 656e  log_event([clien
-00034b60: 742c 2022 616c 6c22 5d2c 207b 2261 6374  t, "all"], {"act
-00034b70: 696f 6e22 3a20 2272 6573 7461 7274 222c  ion": "restart",
-00034b80: 2022 636c 6965 6e74 223a 2063 6c69 656e   "client": clien
-00034b90: 747d 290a 0a20 2020 2020 2020 2069 6620  t})..        if 
-00034ba0: 7761 6974 5f66 6f72 5f77 6f72 6b65 7273  wait_for_workers
-00034bb0: 3a0a 2020 2020 2020 2020 2020 2020 7768  :.            wh
-00034bc0: 696c 6520 6c65 6e28 7365 6c66 2e77 6f72  ile len(self.wor
-00034bd0: 6b65 7273 2920 3c20 6e5f 776f 726b 6572  kers) < n_worker
-00034be0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00034bf0: 2020 2023 204e 4f54 453a 2069 6620 6e65     # NOTE: if ne
-00034c00: 7720 2875 6e72 656c 6174 6564 2920 776f  w (unrelated) wo
-00034c10: 726b 6572 7320 6a6f 696e 2077 6869 6c65  rkers join while
-00034c20: 2077 6527 7265 2077 6169 7469 6e67 2c20   we're waiting, 
-00034c30: 7765 206d 6179 2072 6574 7572 6e20 6265  we may return be
-00034c40: 666f 7265 0a20 2020 2020 2020 2020 2020  fore.           
-00034c50: 2020 2020 2023 206f 7572 2073 6875 742d       # our shut-
-00034c60: 646f 776e 2077 6f72 6b65 7273 2068 6176  down workers hav
-00034c70: 6520 636f 6d65 2062 6163 6b20 7570 2e20  e come back up. 
-00034c80: 5468 6174 2773 2066 696e 653b 2077 6f72  That's fine; wor
-00034c90: 6b65 7273 2061 7265 2069 6e74 6572 6368  kers are interch
-00034ca0: 616e 6765 6162 6c65 2e0a 2020 2020 2020  angeable..      
-00034cb0: 2020 2020 2020 2020 2020 6966 206d 6f6e            if mon
-00034cc0: 6f74 6f6e 6963 2829 203c 2073 7461 7274  otonic() < start
-00034cd0: 202b 2074 696d 656f 7574 3a0a 2020 2020   + timeout:.    
-00034ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034cf0: 6177 6169 7420 6173 796e 6369 6f2e 736c  await asyncio.sl
-00034d00: 6565 7028 302e 3229 0a20 2020 2020 2020  eep(0.2).       
-00034d10: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00034d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034d30: 2020 206d 7367 203d 2028 0a20 2020 2020     msg = (.     
-00034d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034d50: 2020 2066 2257 6169 7465 6420 666f 7220     f"Waited for 
-00034d60: 7b6e 5f77 6f72 6b65 7273 7d20 776f 726b  {n_workers} work
-00034d70: 6572 2873 2920 746f 2072 6563 6f6e 6e65  er(s) to reconne
-00034d80: 6374 2061 6674 6572 2072 6573 7461 7274  ct after restart
-00034d90: 696e 672c 2022 0a20 2020 2020 2020 2020  ing, ".         
-00034da0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00034db0: 2262 7574 2061 6674 6572 207b 7469 6d65  "but after {time
-00034dc0: 6f75 747d 732c 206f 6e6c 7920 7b6c 656e  out}s, only {len
-00034dd0: 2873 656c 662e 776f 726b 6572 7329 7d20  (self.workers)} 
-00034de0: 6861 7665 2072 6574 7572 6e65 642e 2022  have returned. "
-00034df0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00034e00: 2020 2020 2020 2020 2022 436f 6e73 6964           "Consid
-00034e10: 6572 2061 206c 6f6e 6765 7220 7469 6d65  er a longer time
-00034e20: 6f75 742c 206f 7220 6077 6169 745f 666f  out, or `wait_fo
-00034e30: 725f 776f 726b 6572 733d 4661 6c73 6560  r_workers=False`
-00034e40: 2e22 0a20 2020 2020 2020 2020 2020 2020  .".             
-00034e50: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00034e60: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00034e70: 2028 6e5f 6e61 6e6e 7920 3a3d 206c 656e   (n_nanny := len
-00034e80: 286e 616e 6e79 5f77 6f72 6b65 7273 2929  (nanny_workers))
-00034e90: 203c 206e 5f77 6f72 6b65 7273 3a0a 2020   < n_workers:.  
-00034ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034eb0: 2020 2020 2020 6d73 6720 2b3d 2028 0a20        msg += (. 
-00034ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034ed0: 2020 2020 2020 2020 2020 2066 2220 5468             f" Th
-00034ee0: 6520 7b6e 5f77 6f72 6b65 7273 202d 206e  e {n_workers - n
-00034ef0: 5f6e 616e 6e79 7d20 776f 726b 6572 2873  _nanny} worker(s
-00034f00: 2920 6e6f 7420 7573 696e 6720 4e61 6e6e  ) not using Nann
-00034f10: 6965 7320 7765 7265 206a 7573 7420 7368  ies were just sh
-00034f20: 7574 2022 0a20 2020 2020 2020 2020 2020  ut ".           
-00034f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034f40: 2022 646f 776e 2069 6e73 7465 6164 206f   "down instead o
-00034f50: 6620 7265 7374 6172 7465 6420 2872 6573  f restarted (res
-00034f60: 7461 7274 2069 7320 6f6e 6c79 2070 6f73  tart is only pos
-00034f70: 7369 626c 6520 7769 7468 204e 616e 6e69  sible with Nanni
-00034f80: 6573 292e 2049 6620 220a 2020 2020 2020  es). If ".      
-00034f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034fa0: 2020 2020 2020 2279 6f75 7220 6465 706c        "your depl
-00034fb0: 6f79 6d65 6e74 2073 7973 7465 6d20 646f  oyment system do
-00034fc0: 6573 206e 6f74 2061 7574 6f6d 6174 6963  es not automatic
-00034fd0: 616c 6c79 2072 652d 6c61 756e 6368 2074  ally re-launch t
-00034fe0: 6572 6d69 6e61 7465 6420 220a 2020 2020  erminated ".    
-00034ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035000: 2020 2020 2020 2020 2270 726f 6365 7373          "process
-00035010: 6573 2c20 7468 656e 2074 686f 7365 2077  es, then those w
-00035020: 6f72 6b65 7273 2077 696c 6c20 6e65 7665  orkers will neve
-00035030: 7220 636f 6d65 2062 6163 6b2c 2061 6e64  r come back, and
-00035040: 2060 436c 6965 6e74 2e72 6573 7461 7274   `Client.restart
-00035050: 6020 220a 2020 2020 2020 2020 2020 2020  ` ".            
-00035060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035070: 2277 696c 6c20 616c 7761 7973 2074 696d  "will always tim
-00035080: 6520 6f75 742e 2044 6f20 6e6f 7420 7573  e out. Do not us
-00035090: 6520 6043 6c69 656e 742e 7265 7374 6172  e `Client.restar
-000350a0: 7460 2069 6e20 7468 6174 2063 6173 652e  t` in that case.
-000350b0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-000350c0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000350d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000350e0: 7261 6973 6520 5469 6d65 6f75 7445 7272  raise TimeoutErr
-000350f0: 6f72 286d 7367 2920 6672 6f6d 204e 6f6e  or(msg) from Non
-00035100: 650a 2020 2020 2020 2020 6c6f 6767 6572  e.        logger
-00035110: 2e69 6e66 6f28 2252 6573 7461 7274 696e  .info("Restartin
-00035120: 6720 6669 6e69 7368 6564 2e22 290a 0a20  g finished.").. 
-00035130: 2020 2061 7379 6e63 2064 6566 2062 726f     async def bro
-00035140: 6164 6361 7374 280a 2020 2020 2020 2020  adcast(.        
-00035150: 7365 6c66 2c0a 2020 2020 2020 2020 2a2c  self,.        *,
-00035160: 0a20 2020 2020 2020 206d 7367 3a20 6469  .        msg: di
-00035170: 6374 2c0a 2020 2020 2020 2020 776f 726b  ct,.        work
-00035180: 6572 733a 206c 6973 745b 7374 725d 207c  ers: list[str] |
-00035190: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-000351a0: 2020 2020 2020 686f 7374 733a 206c 6973        hosts: lis
-000351b0: 745b 7374 725d 207c 204e 6f6e 6520 3d20  t[str] | None = 
-000351c0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6e61  None,.        na
-000351d0: 6e6e 793a 2062 6f6f 6c20 3d20 4661 6c73  nny: bool = Fals
-000351e0: 652c 0a20 2020 2020 2020 2073 6572 6961  e,.        seria
-000351f0: 6c69 7a65 7273 3a20 416e 7920 3d20 4e6f  lizers: Any = No
-00035200: 6e65 2c0a 2020 2020 2020 2020 6f6e 5f65  ne,.        on_e
-00035210: 7272 6f72 3a20 224c 6974 6572 616c 5b27  rror: "Literal['
-00035220: 7261 6973 6527 2c20 2772 6574 7572 6e27  raise', 'return'
-00035230: 2c20 2772 6574 7572 6e5f 7069 636b 6c65  , 'return_pickle
-00035240: 272c 2027 6967 6e6f 7265 275d 2220 3d20  ', 'ignore']" = 
-00035250: 2272 6169 7365 222c 0a20 2020 2029 202d  "raise",.    ) -
-00035260: 3e20 6469 6374 3a20 2023 2064 6963 745b  > dict:  # dict[
-00035270: 7374 722c 2041 6e79 5d0a 2020 2020 2020  str, Any].      
-00035280: 2020 2222 2242 726f 6164 6361 7374 206d    """Broadcast m
-00035290: 6573 7361 6765 2074 6f20 776f 726b 6572  essage to worker
-000352a0: 732c 2072 6574 7572 6e20 616c 6c20 7265  s, return all re
-000352b0: 7375 6c74 7322 2222 0a20 2020 2020 2020  sults""".       
-000352c0: 2069 6620 776f 726b 6572 7320 6973 204e   if workers is N
-000352d0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-000352e0: 2069 6620 686f 7374 7320 6973 204e 6f6e   if hosts is Non
-000352f0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00035300: 2020 2077 6f72 6b65 7273 203d 206c 6973     workers = lis
-00035310: 7428 7365 6c66 2e77 6f72 6b65 7273 290a  t(self.workers).
-00035320: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00035330: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00035340: 2020 776f 726b 6572 7320 3d20 5b5d 0a20    workers = []. 
-00035350: 2020 2020 2020 2069 6620 686f 7374 7320         if hosts 
-00035360: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00035370: 2020 2020 2020 2020 2066 6f72 2068 6f73           for hos
-00035380: 7420 696e 2068 6f73 7473 3a0a 2020 2020  t in hosts:.    
-00035390: 2020 2020 2020 2020 2020 2020 6468 3a20              dh: 
-000353a0: 6469 6374 203d 2073 656c 662e 686f 7374  dict = self.host
-000353b0: 5f69 6e66 6f2e 6765 7428 686f 7374 2920  _info.get(host) 
-000353c0: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
-000353d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000353e0: 6966 2064 6820 6973 206e 6f74 204e 6f6e  if dh is not Non
-000353f0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00035400: 2020 2020 2020 2077 6f72 6b65 7273 2e65         workers.e
-00035410: 7874 656e 6428 6468 5b22 6164 6472 6573  xtend(dh["addres
-00035420: 7365 7322 5d29 0a20 2020 2020 2020 2023  ses"]).        #
-00035430: 2054 4f44 4f20 7265 706c 6163 6520 7769   TODO replace wi
-00035440: 7468 2077 6f72 6b65 725f 6c69 7374 0a0a  th worker_list..
-00035450: 2020 2020 2020 2020 6966 206e 616e 6e79          if nanny
-00035460: 3a0a 2020 2020 2020 2020 2020 2020 6164  :.            ad
-00035470: 6472 6573 7365 7320 3d20 5b73 656c 662e  dresses = [self.
-00035480: 776f 726b 6572 735b 775d 2e6e 616e 6e79  workers[w].nanny
-00035490: 2066 6f72 2077 2069 6e20 776f 726b 6572   for w in worker
-000354a0: 735d 0a20 2020 2020 2020 2065 6c73 653a  s].        else:
-000354b0: 0a20 2020 2020 2020 2020 2020 2061 6464  .            add
-000354c0: 7265 7373 6573 203d 2077 6f72 6b65 7273  resses = workers
-000354d0: 0a0a 2020 2020 2020 2020 4552 524f 5220  ..        ERROR 
-000354e0: 3d20 6f62 6a65 6374 2829 0a0a 2020 2020  = object()..    
-000354f0: 2020 2020 6173 796e 6320 6465 6620 7365      async def se
-00035500: 6e64 5f6d 6573 7361 6765 2861 6464 7229  nd_message(addr)
-00035510: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
-00035520: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00035530: 2020 2063 6f6d 6d20 3d20 6177 6169 7420     comm = await 
-00035540: 7365 6c66 2e72 7063 2e63 6f6e 6e65 6374  self.rpc.connect
-00035550: 2861 6464 7229 0a20 2020 2020 2020 2020  (addr).         
-00035560: 2020 2020 2020 2063 6f6d 6d2e 6e61 6d65         comm.name
-00035570: 203d 2022 5363 6865 6475 6c65 7220 4272   = "Scheduler Br
-00035580: 6f61 6463 6173 7422 0a20 2020 2020 2020  oadcast".       
-00035590: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-000355a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000355b0: 2020 7265 7370 203d 2061 7761 6974 2073    resp = await s
-000355c0: 656e 645f 7265 6376 280a 2020 2020 2020  end_recv(.      
-000355d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000355e0: 2020 636f 6d6d 2c20 636c 6f73 653d 5472    comm, close=Tr
-000355f0: 7565 2c20 7365 7269 616c 697a 6572 733d  ue, serializers=
-00035600: 7365 7269 616c 697a 6572 732c 202a 2a6d  serializers, **m
-00035610: 7367 0a20 2020 2020 2020 2020 2020 2020  sg.             
-00035620: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00035630: 2020 2020 2020 2020 2066 696e 616c 6c79           finally
-00035640: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00035650: 2020 2020 2020 7365 6c66 2e72 7063 2e72        self.rpc.r
-00035660: 6575 7365 2861 6464 722c 2063 6f6d 6d29  euse(addr, comm)
-00035670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00035680: 2072 6574 7572 6e20 7265 7370 0a20 2020   return resp.   
-00035690: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-000356a0: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
-000356b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000356c0: 6c6f 6767 6572 2e65 7272 6f72 2866 2262  logger.error(f"b
-000356d0: 726f 6164 6361 7374 2074 6f20 7b61 6464  roadcast to {add
-000356e0: 727d 2066 6169 6c65 643a 207b 652e 5f5f  r} failed: {e.__
-000356f0: 636c 6173 735f 5f2e 5f5f 6e61 6d65 5f5f  class__.__name__
-00035700: 7d3a 207b 657d 2229 0a20 2020 2020 2020  }: {e}").       
-00035710: 2020 2020 2020 2020 2069 6620 6f6e 5f65           if on_e
-00035720: 7272 6f72 203d 3d20 2272 6169 7365 223a  rror == "raise":
-00035730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00035740: 2020 2020 2072 6169 7365 0a20 2020 2020       raise.     
-00035750: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-00035760: 6f6e 5f65 7272 6f72 203d 3d20 2272 6574  on_error == "ret
-00035770: 7572 6e22 3a0a 2020 2020 2020 2020 2020  urn":.          
-00035780: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00035790: 2065 0a20 2020 2020 2020 2020 2020 2020   e.             
-000357a0: 2020 2065 6c69 6620 6f6e 5f65 7272 6f72     elif on_error
-000357b0: 203d 3d20 2272 6574 7572 6e5f 7069 636b   == "return_pick
-000357c0: 6c65 223a 0a20 2020 2020 2020 2020 2020  le":.           
-000357d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000357e0: 6475 6d70 7328 6529 0a20 2020 2020 2020  dumps(e).       
-000357f0: 2020 2020 2020 2020 2065 6c69 6620 6f6e           elif on
-00035800: 5f65 7272 6f72 203d 3d20 2269 676e 6f72  _error == "ignor
-00035810: 6522 3a0a 2020 2020 2020 2020 2020 2020  e":.            
-00035820: 2020 2020 2020 2020 7265 7475 726e 2045          return E
-00035830: 5252 4f52 0a20 2020 2020 2020 2020 2020  RROR.           
-00035840: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00035850: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00035860: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00035870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00035880: 2020 2020 2020 2020 2022 6f6e 5f65 7272           "on_err
-00035890: 6f72 206d 7573 7420 6265 2027 7261 6973  or must be 'rais
-000358a0: 6527 2c20 2772 6574 7572 6e27 2c20 2772  e', 'return', 'r
-000358b0: 6574 7572 6e5f 7069 636b 6c65 272c 2022  eturn_pickle', "
-000358c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000358d0: 2020 2020 2020 2020 2066 226f 7220 2769           f"or 'i
-000358e0: 676e 6f72 6527 3b20 676f 7420 7b6f 6e5f  gnore'; got {on_
-000358f0: 6572 726f 7221 727d 220a 2020 2020 2020  error!r}".      
-00035900: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00035910: 0a20 2020 2020 2020 2072 6573 756c 7473  .        results
-00035920: 203d 2061 7761 6974 2041 6c6c 280a 2020   = await All(.  
-00035930: 2020 2020 2020 2020 2020 5b73 656e 645f            [send_
-00035940: 6d65 7373 6167 6528 6164 6472 6573 7329  message(address)
-00035950: 2066 6f72 2061 6464 7265 7373 2069 6e20   for address in 
-00035960: 6164 6472 6573 7365 7320 6966 2061 6464  addresses if add
-00035970: 7265 7373 2069 7320 6e6f 7420 4e6f 6e65  ress is not None
-00035980: 5d0a 2020 2020 2020 2020 290a 0a20 2020  ].        )..   
-00035990: 2020 2020 2072 6574 7572 6e20 7b6b 3a20       return {k: 
-000359a0: 7620 666f 7220 6b2c 2076 2069 6e20 7a69  v for k, v in zi
-000359b0: 7028 776f 726b 6572 732c 2072 6573 756c  p(workers, resul
-000359c0: 7473 2920 6966 2076 2069 7320 6e6f 7420  ts) if v is not 
-000359d0: 4552 524f 527d 0a0a 2020 2020 6173 796e  ERROR}..    asyn
-000359e0: 6320 6465 6620 7072 6f78 7928 0a20 2020  c def proxy(.   
-000359f0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00035a00: 2020 206d 7367 3a20 6469 6374 2c0a 2020     msg: dict,.  
-00035a10: 2020 2020 2020 776f 726b 6572 3a20 7374        worker: st
-00035a20: 722c 0a20 2020 2020 2020 2073 6572 6961  r,.        seria
-00035a30: 6c69 7a65 7273 3a20 416e 7920 3d20 4e6f  lizers: Any = No
-00035a40: 6e65 2c0a 2020 2020 2920 2d3e 2041 6e79  ne,.    ) -> Any
-00035a50: 3a0a 2020 2020 2020 2020 2222 2250 726f  :.        """Pro
-00035a60: 7879 2061 2063 6f6d 6d75 6e69 6361 7469  xy a communicati
-00035a70: 6f6e 2074 6872 6f75 6768 2074 6865 2073  on through the s
-00035a80: 6368 6564 756c 6572 2074 6f20 736f 6d65  cheduler to some
-00035a90: 206f 7468 6572 2077 6f72 6b65 7222 2222   other worker"""
-00035aa0: 0a20 2020 2020 2020 2064 203d 2061 7761  .        d = awa
-00035ab0: 6974 2073 656c 662e 6272 6f61 6463 6173  it self.broadcas
-00035ac0: 7428 6d73 673d 6d73 672c 2077 6f72 6b65  t(msg=msg, worke
-00035ad0: 7273 3d5b 776f 726b 6572 5d2c 2073 6572  rs=[worker], ser
-00035ae0: 6961 6c69 7a65 7273 3d73 6572 6961 6c69  ializers=seriali
-00035af0: 7a65 7273 290a 2020 2020 2020 2020 7265  zers).        re
-00035b00: 7475 726e 2064 5b77 6f72 6b65 725d 0a0a  turn d[worker]..
-00035b10: 2020 2020 6173 796e 6320 6465 6620 6761      async def ga
-00035b20: 7468 6572 5f6f 6e5f 776f 726b 6572 280a  ther_on_worker(.
-00035b30: 2020 2020 2020 2020 7365 6c66 2c20 776f          self, wo
-00035b40: 726b 6572 5f61 6464 7265 7373 3a20 7374  rker_address: st
-00035b50: 722c 2077 686f 5f68 6173 3a20 2264 6963  r, who_has: "dic
-00035b60: 745b 7374 722c 206c 6973 745b 7374 725d  t[str, list[str]
-00035b70: 5d22 0a20 2020 2029 202d 3e20 7365 743a  ]".    ) -> set:
-00035b80: 0a20 2020 2020 2020 2022 2222 5065 6572  .        """Peer
-00035b90: 2d74 6f2d 7065 6572 2063 6f70 7920 6f66  -to-peer copy of
-00035ba0: 206b 6579 7320 6672 6f6d 206d 756c 7469   keys from multi
-00035bb0: 706c 6520 776f 726b 6572 7320 746f 2061  ple workers to a
-00035bc0: 2073 696e 676c 6520 776f 726b 6572 0a0a   single worker..
-00035bd0: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
-00035be0: 7273 0a20 2020 2020 2020 202d 2d2d 2d2d  rs.        -----
-00035bf0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 776f  -----.        wo
-00035c00: 726b 6572 5f61 6464 7265 7373 3a20 7374  rker_address: st
-00035c10: 720a 2020 2020 2020 2020 2020 2020 5265  r.            Re
-00035c20: 6369 7069 656e 7420 776f 726b 6572 2061  cipient worker a
-00035c30: 6464 7265 7373 2074 6f20 636f 7079 206b  ddress to copy k
-00035c40: 6579 7320 746f 0a20 2020 2020 2020 2077  eys to.        w
-00035c50: 686f 5f68 6173 3a20 6469 6374 5b48 6173  ho_has: dict[Has
-00035c60: 6861 626c 652c 206c 6973 745b 7374 725d  hable, list[str]
-00035c70: 5d0a 2020 2020 2020 2020 2020 2020 7b6b  ].            {k
-00035c80: 6579 3a20 5b73 656e 6465 7220 6164 6472  ey: [sender addr
-00035c90: 6573 732c 2073 656e 6465 7220 6164 6472  ess, sender addr
-00035ca0: 6573 732c 202e 2e2e 5d2c 206b 6579 3a20  ess, ...], key: 
-00035cb0: 2e2e 2e7d 0a0a 2020 2020 2020 2020 5265  ...}..        Re
-00035cc0: 7475 726e 730a 2020 2020 2020 2020 2d2d  turns.        --
-00035cd0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 7265  -----.        re
-00035ce0: 7475 726e 733a 0a20 2020 2020 2020 2020  turns:.         
-00035cf0: 2020 2073 6574 206f 6620 6b65 7973 2074     set of keys t
-00035d00: 6861 7420 6661 696c 6564 2074 6f20 6265  hat failed to be
-00035d10: 2063 6f70 6965 640a 2020 2020 2020 2020   copied.        
-00035d20: 2222 220a 2020 2020 2020 2020 7472 793a  """.        try:
-00035d30: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-00035d40: 756c 7420 3d20 6177 6169 7420 7265 7472  ult = await retr
-00035d50: 795f 6f70 6572 6174 696f 6e28 0a20 2020  y_operation(.   
-00035d60: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00035d70: 662e 7270 6328 6164 6472 3d77 6f72 6b65  f.rpc(addr=worke
-00035d80: 725f 6164 6472 6573 7329 2e67 6174 6865  r_address).gathe
-00035d90: 722c 2077 686f 5f68 6173 3d77 686f 5f68  r, who_has=who_h
-00035da0: 6173 0a20 2020 2020 2020 2020 2020 2029  as.            )
-00035db0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00035dc0: 4f53 4572 726f 7220 6173 2065 3a0a 2020  OSError as e:.  
-00035dd0: 2020 2020 2020 2020 2020 2320 5468 6973            # This
-00035de0: 2063 616e 2068 6170 7065 6e20 652e 672e   can happen e.g.
-00035df0: 2069 6620 7468 6520 776f 726b 6572 2069   if the worker i
-00035e00: 7320 676f 696e 6720 7468 726f 7567 6820  s going through 
-00035e10: 636f 6e74 726f 6c6c 6564 2073 6875 7464  controlled shutd
-00035e20: 6f77 6e3b 0a20 2020 2020 2020 2020 2020  own;.           
-00035e30: 2023 2069 7420 646f 6573 6e27 7420 6e65   # it doesn't ne
-00035e40: 6365 7373 6172 696c 7920 6d65 616e 2074  cessarily mean t
-00035e50: 6861 7420 6974 2077 656e 7420 756e 6578  hat it went unex
-00035e60: 7065 6374 6564 6c79 206d 6973 7369 6e67  pectedly missing
-00035e70: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-00035e80: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
-00035e90: 2020 2020 2020 2020 2020 2020 2066 2243               f"C
-00035ea0: 6f6d 6d75 6e69 6361 7469 6f6e 2077 6974  ommunication wit
-00035eb0: 6820 776f 726b 6572 207b 776f 726b 6572  h worker {worker
-00035ec0: 5f61 6464 7265 7373 7d20 6661 696c 6564  _address} failed
-00035ed0: 2064 7572 696e 6720 220a 2020 2020 2020   during ".      
-00035ee0: 2020 2020 2020 2020 2020 6622 7265 706c            f"repl
-00035ef0: 6963 6174 696f 6e3a 207b 652e 5f5f 636c  ication: {e.__cl
-00035f00: 6173 735f 5f2e 5f5f 6e61 6d65 5f5f 7d3a  ass__.__name__}:
-00035f10: 207b 657d 220a 2020 2020 2020 2020 2020   {e}".          
-00035f20: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00035f30: 7265 7475 726e 2073 6574 2877 686f 5f68  return set(who_h
-00035f40: 6173 290a 0a20 2020 2020 2020 2077 7320  as)..        ws 
-00035f50: 3d20 7365 6c66 2e77 6f72 6b65 7273 2e67  = self.workers.g
-00035f60: 6574 2877 6f72 6b65 725f 6164 6472 6573  et(worker_addres
-00035f70: 7329 0a0a 2020 2020 2020 2020 6966 206e  s)..        if n
-00035f80: 6f74 2077 733a 0a20 2020 2020 2020 2020  ot ws:.         
-00035f90: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
-00035fa0: 6728 6622 576f 726b 6572 207b 776f 726b  g(f"Worker {work
-00035fb0: 6572 5f61 6464 7265 7373 7d20 6c6f 7374  er_address} lost
-00035fc0: 2064 7572 696e 6720 7265 706c 6963 6174   during replicat
-00035fd0: 696f 6e22 290a 2020 2020 2020 2020 2020  ion").          
-00035fe0: 2020 7265 7475 726e 2073 6574 2877 686f    return set(who
-00035ff0: 5f68 6173 290a 2020 2020 2020 2020 656c  _has).        el
-00036000: 6966 2072 6573 756c 745b 2273 7461 7475  if result["statu
-00036010: 7322 5d20 3d3d 2022 4f4b 223a 0a20 2020  s"] == "OK":.   
-00036020: 2020 2020 2020 2020 206b 6579 735f 6661           keys_fa
-00036030: 696c 6564 203d 2073 6574 2829 0a20 2020  iled = set().   
-00036040: 2020 2020 2020 2020 206b 6579 735f 6f6b           keys_ok
-00036050: 3a20 5365 7420 3d20 7768 6f5f 6861 732e  : Set = who_has.
-00036060: 6b65 7973 2829 0a20 2020 2020 2020 2065  keys().        e
-00036070: 6c69 6620 7265 7375 6c74 5b22 7374 6174  lif result["stat
-00036080: 7573 225d 203d 3d20 2270 6172 7469 616c  us"] == "partial
-00036090: 2d66 6169 6c22 3a0a 2020 2020 2020 2020  -fail":.        
-000360a0: 2020 2020 6b65 7973 5f66 6169 6c65 6420      keys_failed 
-000360b0: 3d20 7365 7428 7265 7375 6c74 5b22 6b65  = set(result["ke
-000360c0: 7973 225d 290a 2020 2020 2020 2020 2020  ys"]).          
-000360d0: 2020 6b65 7973 5f6f 6b20 3d20 7768 6f5f    keys_ok = who_
-000360e0: 6861 732e 6b65 7973 2829 202d 206b 6579  has.keys() - key
-000360f0: 735f 6661 696c 6564 0a20 2020 2020 2020  s_failed.       
-00036100: 2020 2020 206c 6f67 6765 722e 7761 726e       logger.warn
-00036110: 696e 6728 0a20 2020 2020 2020 2020 2020  ing(.           
-00036120: 2020 2020 2066 2257 6f72 6b65 7220 7b77       f"Worker {w
-00036130: 6f72 6b65 725f 6164 6472 6573 737d 2066  orker_address} f
-00036140: 6169 6c65 6420 746f 2061 6371 7569 7265  ailed to acquire
-00036150: 206b 6579 733a 207b 7265 7375 6c74 5b27   keys: {result['
-00036160: 6b65 7973 275d 7d22 0a20 2020 2020 2020  keys']}".       
-00036170: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
-00036180: 6c73 653a 2020 2320 7072 6167 6d61 3a20  lse:  # pragma: 
-00036190: 6e6f 636f 7665 720a 2020 2020 2020 2020  nocover.        
-000361a0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-000361b0: 7272 6f72 2866 2255 6e65 7870 6563 7465  rror(f"Unexpecte
-000361c0: 6420 6d65 7373 6167 6520 6672 6f6d 207b  d message from {
-000361d0: 776f 726b 6572 5f61 6464 7265 7373 7d3a  worker_address}:
-000361e0: 207b 7265 7375 6c74 7d22 290a 0a20 2020   {result}")..   
-000361f0: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
-00036200: 6b65 7973 5f6f 6b3a 0a20 2020 2020 2020  keys_ok:.       
-00036210: 2020 2020 2074 733a 2054 6173 6b53 7461       ts: TaskSta
-00036220: 7465 203d 2073 656c 662e 7461 736b 732e  te = self.tasks.
-00036230: 6765 7428 6b65 7929 2020 2320 7479 7065  get(key)  # type
-00036240: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
-00036250: 2020 2020 2069 6620 7473 2069 7320 4e6f       if ts is No
-00036260: 6e65 206f 7220 7473 2e73 7461 7465 2021  ne or ts.state !
-00036270: 3d20 226d 656d 6f72 7922 3a0a 2020 2020  = "memory":.    
-00036280: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-00036290: 6572 2e77 6172 6e69 6e67 2866 224b 6579  er.warning(f"Key
-000362a0: 206c 6f73 7420 6475 7269 6e67 2072 6570   lost during rep
-000362b0: 6c69 6361 7469 6f6e 3a20 7b6b 6579 7d22  lication: {key}"
-000362c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000362d0: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
-000362e0: 2020 2020 2020 2069 6620 7773 206e 6f74         if ws not
-000362f0: 2069 6e20 7473 2e77 686f 5f68 6173 3a0a   in ts.who_has:.
-00036300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036310: 7365 6c66 2e61 6464 5f72 6570 6c69 6361  self.add_replica
-00036320: 2874 732c 2077 7329 0a0a 2020 2020 2020  (ts, ws)..      
-00036330: 2020 7265 7475 726e 206b 6579 735f 6661    return keys_fa
-00036340: 696c 6564 0a0a 2020 2020 6173 796e 6320  iled..    async 
-00036350: 6465 6620 6465 6c65 7465 5f77 6f72 6b65  def delete_worke
-00036360: 725f 6461 7461 280a 2020 2020 2020 2020  r_data(.        
-00036370: 7365 6c66 2c20 776f 726b 6572 5f61 6464  self, worker_add
-00036380: 7265 7373 3a20 7374 722c 206b 6579 733a  ress: str, keys:
-00036390: 2022 436f 6c6c 6563 7469 6f6e 5b73 7472   "Collection[str
-000363a0: 5d22 2c20 7374 696d 756c 7573 5f69 643a  ]", stimulus_id:
-000363b0: 2073 7472 0a20 2020 2029 202d 3e20 4e6f   str.    ) -> No
-000363c0: 6e65 3a0a 2020 2020 2020 2020 2222 2244  ne:.        """D
-000363d0: 656c 6574 6520 6461 7461 2066 726f 6d20  elete data from 
-000363e0: 6120 776f 726b 6572 2061 6e64 2075 7064  a worker and upd
-000363f0: 6174 6520 7468 6520 636f 7272 6573 706f  ate the correspo
-00036400: 6e64 696e 6720 776f 726b 6572 2f74 6173  nding worker/tas
-00036410: 6b20 7374 6174 6573 0a0a 2020 2020 2020  k states..      
-00036420: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-00036430: 2020 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a       ----------.
-00036440: 2020 2020 2020 2020 776f 726b 6572 5f61          worker_a
-00036450: 6464 7265 7373 3a20 7374 720a 2020 2020  ddress: str.    
-00036460: 2020 2020 2020 2020 576f 726b 6572 2061          Worker a
-00036470: 6464 7265 7373 2074 6f20 6465 6c65 7465  ddress to delete
-00036480: 206b 6579 7320 6672 6f6d 0a20 2020 2020   keys from.     
-00036490: 2020 206b 6579 733a 206c 6973 745b 7374     keys: list[st
-000364a0: 725d 0a20 2020 2020 2020 2020 2020 204c  r].            L
-000364b0: 6973 7420 6f66 206b 6579 7320 746f 2064  ist of keys to d
-000364c0: 656c 6574 6520 6f6e 2074 6865 2073 7065  elete on the spe
-000364d0: 6369 6669 6564 2077 6f72 6b65 720a 2020  cified worker.  
-000364e0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-000364f0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00036500: 2020 2061 7761 6974 2072 6574 7279 5f6f     await retry_o
-00036510: 7065 7261 7469 6f6e 280a 2020 2020 2020  peration(.      
-00036520: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
-00036530: 7063 2861 6464 723d 776f 726b 6572 5f61  pc(addr=worker_a
-00036540: 6464 7265 7373 292e 6672 6565 5f6b 6579  ddress).free_key
-00036550: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00036560: 2020 206b 6579 733d 6c69 7374 286b 6579     keys=list(key
-00036570: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-00036580: 2020 2020 7374 696d 756c 7573 5f69 643d      stimulus_id=
-00036590: 6622 6465 6c65 7465 2d64 6174 612d 7b74  f"delete-data-{t
-000365a0: 696d 6528 297d 222c 0a20 2020 2020 2020  ime()}",.       
-000365b0: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
-000365c0: 7863 6570 7420 4f53 4572 726f 7220 6173  xcept OSError as
-000365d0: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-000365e0: 2320 5468 6973 2063 616e 2068 6170 7065  # This can happe
-000365f0: 6e20 652e 672e 2069 6620 7468 6520 776f  n e.g. if the wo
-00036600: 726b 6572 2069 7320 676f 696e 6720 7468  rker is going th
-00036610: 726f 7567 6820 636f 6e74 726f 6c6c 6564  rough controlled
-00036620: 2073 6875 7464 6f77 6e3b 0a20 2020 2020   shutdown;.     
-00036630: 2020 2020 2020 2023 2069 7420 646f 6573         # it does
-00036640: 6e27 7420 6e65 6365 7373 6172 696c 7920  n't necessarily 
-00036650: 6d65 616e 2074 6861 7420 6974 2077 656e  mean that it wen
-00036660: 7420 756e 6578 7065 6374 6564 6c79 206d  t unexpectedly m
-00036670: 6973 7369 6e67 0a20 2020 2020 2020 2020  issing.         
-00036680: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
-00036690: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-000366a0: 2020 2066 2243 6f6d 6d75 6e69 6361 7469     f"Communicati
-000366b0: 6f6e 2077 6974 6820 776f 726b 6572 207b  on with worker {
-000366c0: 776f 726b 6572 5f61 6464 7265 7373 7d20  worker_address} 
-000366d0: 6661 696c 6564 2064 7572 696e 6720 220a  failed during ".
-000366e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000366f0: 6622 7265 706c 6963 6174 696f 6e3a 207b  f"replication: {
-00036700: 652e 5f5f 636c 6173 735f 5f2e 5f5f 6e61  e.__class__.__na
-00036710: 6d65 5f5f 7d3a 207b 657d 220a 2020 2020  me__}: {e}".    
-00036720: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00036730: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
-00036740: 2020 2020 2020 7773 203d 2073 656c 662e        ws = self.
-00036750: 776f 726b 6572 732e 6765 7428 776f 726b  workers.get(work
-00036760: 6572 5f61 6464 7265 7373 290a 2020 2020  er_address).    
-00036770: 2020 2020 6966 206e 6f74 2077 733a 0a20      if not ws:. 
-00036780: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00036790: 6e0a 0a20 2020 2020 2020 2066 6f72 206b  n..        for k
-000367a0: 6579 2069 6e20 6b65 7973 3a0a 2020 2020  ey in keys:.    
-000367b0: 2020 2020 2020 2020 7473 3a20 5461 736b          ts: Task
-000367c0: 5374 6174 6520 3d20 7365 6c66 2e74 6173  State = self.tas
-000367d0: 6b73 2e67 6574 286b 6579 2920 2023 2074  ks.get(key)  # t
-000367e0: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
-000367f0: 2020 2020 2020 2020 6966 2074 7320 6973          if ts is
-00036800: 206e 6f74 204e 6f6e 6520 616e 6420 7773   not None and ws
-00036810: 2069 6e20 7473 2e77 686f 5f68 6173 3a0a   in ts.who_has:.
-00036820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036830: 6173 7365 7274 2074 732e 7374 6174 6520  assert ts.state 
-00036840: 3d3d 2022 6d65 6d6f 7279 220a 2020 2020  == "memory".    
-00036850: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00036860: 2e72 656d 6f76 655f 7265 706c 6963 6128  .remove_replica(
-00036870: 7473 2c20 7773 290a 2020 2020 2020 2020  ts, ws).        
-00036880: 2020 2020 2020 2020 6966 206e 6f74 2074          if not t
-00036890: 732e 7768 6f5f 6861 733a 0a20 2020 2020  s.who_has:.     
-000368a0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000368b0: 204c 6173 7420 636f 7079 2064 656c 6574   Last copy delet
-000368c0: 6564 0a20 2020 2020 2020 2020 2020 2020  ed.             
-000368d0: 2020 2020 2020 2073 656c 662e 7472 616e         self.tran
-000368e0: 7369 7469 6f6e 7328 7b6b 6579 3a20 2272  sitions({key: "r
-000368f0: 656c 6561 7365 6422 7d2c 2073 7469 6d75  eleased"}, stimu
-00036900: 6c75 735f 6964 290a 0a20 2020 2020 2020  lus_id)..       
-00036910: 2073 656c 662e 6c6f 675f 6576 656e 7428   self.log_event(
-00036920: 7773 2e61 6464 7265 7373 2c20 7b22 6163  ws.address, {"ac
-00036930: 7469 6f6e 223a 2022 7265 6d6f 7665 2d77  tion": "remove-w
-00036940: 6f72 6b65 722d 6461 7461 222c 2022 6b65  orker-data", "ke
-00036950: 7973 223a 206b 6579 737d 290a 0a20 2020  ys": keys})..   
-00036960: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
-00036970: 2061 7379 6e63 2064 6566 2072 6562 616c   async def rebal
-00036980: 616e 6365 280a 2020 2020 2020 2020 7365  ance(.        se
-00036990: 6c66 2c0a 2020 2020 2020 2020 6b65 7973  lf,.        keys
-000369a0: 3a20 4974 6572 6162 6c65 5b73 7472 5d20  : Iterable[str] 
-000369b0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-000369c0: 2020 2020 2020 2077 6f72 6b65 7273 3a20         workers: 
-000369d0: 4974 6572 6162 6c65 5b73 7472 5d20 7c20  Iterable[str] | 
-000369e0: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-000369f0: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
-00036a00: 3a20 7374 7220 7c20 4e6f 6e65 203d 204e  : str | None = N
-00036a10: 6f6e 652c 0a20 2020 2029 202d 3e20 6469  one,.    ) -> di
-00036a20: 6374 3a0a 2020 2020 2020 2020 2222 2252  ct:.        """R
-00036a30: 6562 616c 616e 6365 206b 6579 7320 736f  ebalance keys so
-00036a40: 2074 6861 7420 6561 6368 2077 6f72 6b65   that each worke
-00036a50: 7220 656e 6473 2075 7020 7769 7468 2072  r ends up with r
-00036a60: 6f75 6768 6c79 2074 6865 2073 616d 6520  oughly the same 
-00036a70: 7072 6f63 6573 730a 2020 2020 2020 2020  process.        
-00036a80: 6d65 6d6f 7279 2028 6d61 6e61 6765 642b  memory (managed+
-00036a90: 756e 6d61 6e61 6765 6429 2e0a 0a20 2020  unmanaged)...   
-00036aa0: 2020 2020 202e 2e20 7761 726e 696e 673a       .. warning:
-00036ab0: 3a0a 2020 2020 2020 2020 2020 2054 6869  :.           Thi
-00036ac0: 7320 6f70 6572 6174 696f 6e20 6973 2067  s operation is g
-00036ad0: 656e 6572 616c 6c79 206e 6f74 2077 656c  enerally not wel
-00036ae0: 6c20 7465 7374 6564 2061 6761 696e 7374  l tested against
-00036af0: 206e 6f72 6d61 6c20 6f70 6572 6174 696f   normal operatio
-00036b00: 6e20 6f66 2074 6865 0a20 2020 2020 2020  n of the.       
-00036b10: 2020 2020 7363 6865 6475 6c65 722e 2049      scheduler. I
-00036b20: 7420 6973 206e 6f74 2072 6563 6f6d 6d65  t is not recomme
-00036b30: 6e64 6564 2074 6f20 7573 6520 6974 2077  nded to use it w
-00036b40: 6869 6c65 2077 6169 7469 6e67 206f 6e20  hile waiting on 
-00036b50: 636f 6d70 7574 6174 696f 6e73 2e0a 0a20  computations... 
-00036b60: 2020 2020 2020 202a 2a41 6c67 6f72 6974         **Algorit
-00036b70: 686d 2a2a 0a0a 2020 2020 2020 2020 232e  hm**..        #.
-00036b80: 2046 696e 6420 7468 6520 6d65 616e 206f   Find the mean o
-00036b90: 6363 7570 616e 6379 206f 6620 7468 6520  ccupancy of the 
-00036ba0: 636c 7573 7465 722c 2064 6566 696e 6564  cluster, defined
-00036bb0: 2061 7320 6461 7461 206d 616e 6167 6564   as data managed
-00036bc0: 2062 7920 6461 736b 202b 0a20 2020 2020   by dask +.     
-00036bd0: 2020 2020 2020 756e 6d61 6e61 6765 6420        unmanaged 
-00036be0: 7072 6f63 6573 7320 6d65 6d6f 7279 2074  process memory t
-00036bf0: 6861 7420 6861 7320 6265 656e 2074 6865  hat has been the
-00036c00: 7265 2066 6f72 2061 7420 6c65 6173 7420  re for at least 
-00036c10: 3330 2073 6563 6f6e 6473 0a20 2020 2020  30 seconds.     
-00036c20: 2020 2020 2020 2860 6064 6973 7472 6962        (``distrib
-00036c30: 7574 6564 2e77 6f72 6b65 722e 6d65 6d6f  uted.worker.memo
-00036c40: 7279 2e72 6563 656e 742d 746f 2d6f 6c64  ry.recent-to-old
-00036c50: 2d74 696d 6560 6029 2e0a 2020 2020 2020  -time``)..      
-00036c60: 2020 2020 2054 6869 7320 6c65 7473 2075       This lets u
-00036c70: 7320 6967 6e6f 7265 2074 656d 706f 7261  s ignore tempora
-00036c80: 7279 2073 7069 6b65 7320 6361 7573 6564  ry spikes caused
-00036c90: 2062 7920 7461 736b 2068 6561 7020 7573   by task heap us
-00036ca0: 6167 652e 0a0a 2020 2020 2020 2020 2020  age...          
-00036cb0: 2041 6c74 6572 6e61 7469 7665 6c79 2c20   Alternatively, 
-00036cc0: 796f 7520 6d61 7920 6368 616e 6765 2068  you may change h
-00036cd0: 6f77 206d 656d 6f72 7920 6973 206d 6561  ow memory is mea
-00036ce0: 7375 7265 6420 626f 7468 2066 6f72 2074  sured both for t
-00036cf0: 6865 2069 6e64 6976 6964 7561 6c0a 2020  he individual.  
-00036d00: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
-00036d10: 2061 7320 7765 6c6c 2061 7320 746f 2063   as well as to c
-00036d20: 616c 6375 6c61 7465 2074 6865 206d 6561  alculate the mea
-00036d30: 6e20 7468 726f 7567 680a 2020 2020 2020  n through.      
-00036d40: 2020 2020 2060 6064 6973 7472 6962 7574       ``distribut
-00036d50: 6564 2e77 6f72 6b65 722e 6d65 6d6f 7279  ed.worker.memory
-00036d60: 2e72 6562 616c 616e 6365 2e6d 6561 7375  .rebalance.measu
-00036d70: 7265 6060 2e20 4e61 6d65 6c79 2c20 7468  re``. Namely, th
-00036d80: 6973 2063 616e 2062 6520 7573 6566 756c  is can be useful
-00036d90: 0a20 2020 2020 2020 2020 2020 746f 2064  .           to d
-00036da0: 6973 7265 6761 7264 2069 6e61 6363 7572  isregard inaccur
-00036db0: 6174 6520 4f53 206d 656d 6f72 7920 6d65  ate OS memory me
-00036dc0: 6173 7572 656d 656e 7473 2e0a 0a20 2020  asurements...   
-00036dd0: 2020 2020 2023 2e20 4469 7363 6172 6420       #. Discard 
-00036de0: 776f 726b 6572 7320 7768 6f73 6520 6f63  workers whose oc
-00036df0: 6375 7061 6e63 7920 6973 2077 6974 6869  cupancy is withi
-00036e00: 6e20 3525 206f 6620 7468 6520 6d65 616e  n 5% of the mean
-00036e10: 2063 6c75 7374 6572 206f 6363 7570 616e   cluster occupan
-00036e20: 6379 0a20 2020 2020 2020 2020 2020 2860  cy.           (`
-00036e30: 6064 6973 7472 6962 7574 6564 2e77 6f72  `distributed.wor
-00036e40: 6b65 722e 6d65 6d6f 7279 2e72 6562 616c  ker.memory.rebal
-00036e50: 616e 6365 2e73 656e 6465 722d 7265 6369  ance.sender-reci
-00036e60: 7069 656e 742d 6761 7060 6020 2f20 3229  pient-gap`` / 2)
-00036e70: 2e0a 2020 2020 2020 2020 2020 2054 6869  ..           Thi
-00036e80: 7320 6865 6c70 7320 6176 6f69 6420 6461  s helps avoid da
-00036e90: 7461 2066 726f 6d20 626f 756e 6369 6e67  ta from bouncing
-00036ea0: 2061 726f 756e 6420 7468 6520 636c 7573   around the clus
-00036eb0: 7465 7220 7265 7065 6174 6564 6c79 2e0a  ter repeatedly..
-00036ec0: 2020 2020 2020 2020 232e 2057 6f72 6b65          #. Worke
-00036ed0: 7273 2061 626f 7665 2074 6865 206d 6561  rs above the mea
-00036ee0: 6e20 6172 6520 7365 6e64 6572 733b 2074  n are senders; t
-00036ef0: 686f 7365 2062 656c 6f77 2061 7265 2072  hose below are r
-00036f00: 6563 6970 6965 6e74 732e 0a20 2020 2020  ecipients..     
-00036f10: 2020 2023 2e20 4469 7363 6172 6420 7365     #. Discard se
-00036f20: 6e64 6572 7320 7768 6f73 6520 6162 736f  nders whose abso
-00036f30: 6c75 7465 206f 6363 7570 616e 6379 2069  lute occupancy i
-00036f40: 7320 6265 6c6f 7720 3330 250a 2020 2020  s below 30%.    
-00036f50: 2020 2020 2020 2028 6060 6469 7374 7269         (``distri
-00036f60: 6275 7465 642e 776f 726b 6572 2e6d 656d  buted.worker.mem
-00036f70: 6f72 792e 7265 6261 6c61 6e63 652e 7365  ory.rebalance.se
-00036f80: 6e64 6572 2d6d 696e 6060 292e 2049 6e20  nder-min``). In 
-00036f90: 6f74 6865 7220 776f 7264 732c 206e 6f20  other words, no 
-00036fa0: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
-00036fb0: 6973 206d 6f76 6564 2072 6567 6172 646c  is moved regardl
-00036fc0: 6573 7320 6f66 2069 6d62 616c 616e 6369  ess of imbalanci
-00036fd0: 6e67 2061 7320 6c6f 6e67 2061 7320 616c  ng as long as al
-00036fe0: 6c20 776f 726b 6572 7320 6172 6520 6265  l workers are be
-00036ff0: 6c6f 7720 3330 252e 0a20 2020 2020 2020  low 30%..       
-00037000: 2023 2e20 4469 7363 6172 6420 7265 6369   #. Discard reci
-00037010: 7069 656e 7473 2077 686f 7365 2061 6273  pients whose abs
-00037020: 6f6c 7574 6520 6f63 6375 7061 6e63 7920  olute occupancy 
-00037030: 6973 2061 626f 7665 2036 3025 0a20 2020  is above 60%.   
-00037040: 2020 2020 2020 2020 2860 6064 6973 7472          (``distr
-00037050: 6962 7574 6564 2e77 6f72 6b65 722e 6d65  ibuted.worker.me
-00037060: 6d6f 7279 2e72 6562 616c 616e 6365 2e72  mory.rebalance.r
-00037070: 6563 6970 6965 6e74 2d6d 6178 6060 292e  ecipient-max``).
-00037080: 0a20 2020 2020 2020 2020 2020 4e6f 7465  .           Note
-00037090: 2074 6861 7420 7468 6973 2074 6872 6573   that this thres
-000370a0: 686f 6c64 2062 7920 6465 6661 756c 7420  hold by default 
-000370b0: 6973 2074 6865 2073 616d 6520 6173 0a20  is the same as. 
-000370c0: 2020 2020 2020 2020 2020 6060 6469 7374            ``dist
-000370d0: 7269 6275 7465 642e 776f 726b 6572 2e6d  ributed.worker.m
-000370e0: 656d 6f72 792e 7461 7267 6574 6060 2074  emory.target`` t
-000370f0: 6f20 7072 6576 656e 7420 776f 726b 6572  o prevent worker
-00037100: 7320 6672 6f6d 2061 6363 6570 7469 6e67  s from accepting
-00037110: 2064 6174 610a 2020 2020 2020 2020 2020   data.          
-00037120: 2061 6e64 2069 6d6d 6564 6961 7465 6c79   and immediately
-00037130: 2073 7069 6c6c 696e 6720 6974 206f 7574   spilling it out
-00037140: 2074 6f20 6469 736b 2e0a 2020 2020 2020   to disk..      
-00037150: 2020 232e 2049 7465 7261 7469 7665 6c79    #. Iteratively
-00037160: 2070 6963 6b20 7468 6520 7365 6e64 6572   pick the sender
-00037170: 2061 6e64 2072 6563 6970 6965 6e74 2074   and recipient t
-00037180: 6861 7420 6172 6520 6661 7274 6865 7374  hat are farthest
-00037190: 2066 726f 6d20 7468 6520 6d65 616e 2061   from the mean a
-000371a0: 6e64 0a20 2020 2020 2020 2020 2020 6d6f  nd.           mo
-000371b0: 7665 2074 6865 202a 6c65 6173 7420 7265  ve the *least re
-000371c0: 6365 6e74 6c79 2069 6e73 6572 7465 642a  cently inserted*
-000371d0: 206b 6579 2062 6574 7765 656e 2074 6865   key between the
-000371e0: 2074 776f 2c20 756e 7469 6c20 6569 7468   two, until eith
-000371f0: 6572 2061 6c6c 0a20 2020 2020 2020 2020  er all.         
-00037200: 2020 7365 6e64 6572 7320 6f72 2061 6c6c    senders or all
-00037210: 2072 6563 6970 6965 6e74 7320 6661 6c6c   recipients fall
-00037220: 2077 6974 6869 6e20 3525 206f 6620 7468   within 5% of th
-00037230: 6520 6d65 616e 2e0a 0a20 2020 2020 2020  e mean...       
-00037240: 2020 2020 4120 7265 6369 7069 656e 7420      A recipient 
-00037250: 7769 6c6c 2062 6520 736b 6970 7065 6420  will be skipped 
-00037260: 6966 2069 7420 616c 7265 6164 7920 6861  if it already ha
-00037270: 7320 6120 636f 7079 206f 6620 7468 6520  s a copy of the 
-00037280: 6461 7461 2e20 496e 206f 7468 6572 0a20  data. In other. 
-00037290: 2020 2020 2020 2020 2020 776f 7264 732c            words,
-000372a0: 2074 6869 7320 6d65 7468 6f64 2064 6f65   this method doe
-000372b0: 7320 6e6f 7420 6465 6772 6164 6520 7265  s not degrade re
-000372c0: 706c 6963 6174 696f 6e2e 0a20 2020 2020  plication..     
-000372d0: 2020 2020 2020 4120 6b65 7920 7769 6c6c        A key will
-000372e0: 2062 6520 736b 6970 7065 6420 6966 2074   be skipped if t
-000372f0: 6865 7265 2061 7265 206e 6f20 7265 6369  here are no reci
-00037300: 7069 656e 7473 2061 7661 696c 6162 6c65  pients available
-00037310: 2077 6974 6820 656e 6f75 6768 206d 656d   with enough mem
-00037320: 6f72 790a 2020 2020 2020 2020 2020 2074  ory.           t
-00037330: 6f20 6163 6365 7074 2074 6865 206b 6579  o accept the key
-00037340: 2061 6e64 2074 6861 7420 646f 6e27 7420   and that don't 
-00037350: 616c 7265 6164 7920 686f 6c64 2061 2063  already hold a c
-00037360: 6f70 792e 0a0a 2020 2020 2020 2020 5468  opy...        Th
-00037370: 6520 6c65 6173 7420 7265 6365 6e74 6c79  e least recently
-00037380: 2069 6e73 6572 7464 2028 4c52 4929 2070   insertd (LRI) p
-00037390: 6f6c 6963 7920 6973 2061 2067 7265 6564  olicy is a greed
-000373a0: 7920 6368 6f69 6365 2077 6974 6820 7468  y choice with th
-000373b0: 6520 6164 7661 6e74 6167 6520 6f66 0a20  e advantage of. 
-000373c0: 2020 2020 2020 2062 6569 6e67 204f 2831         being O(1
-000373d0: 292c 2074 7269 7669 616c 2074 6f20 696d  ), trivial to im
-000373e0: 706c 656d 656e 7420 2869 7420 7265 6c69  plement (it reli
-000373f0: 6573 206f 6e20 7079 7468 6f6e 2064 6963  es on python dic
-00037400: 7420 696e 7365 7274 696f 6e2d 736f 7274  t insertion-sort
-00037410: 696e 6729 0a20 2020 2020 2020 2061 6e64  ing).        and
-00037420: 2068 6f70 6566 756c 6c79 2067 6f6f 6420   hopefully good 
-00037430: 656e 6f75 6768 2069 6e20 6d6f 7374 2063  enough in most c
-00037440: 6173 6573 2e20 4469 7363 6172 6465 6420  ases. Discarded 
-00037450: 616c 7465 726e 6174 6976 6520 706f 6c69  alternative poli
-00037460: 6369 6573 2077 6572 653a 0a0a 2020 2020  cies were:..    
-00037470: 2020 2020 2d20 4c61 7267 6573 7420 6669      - Largest fi
-00037480: 7273 742e 204f 286e 2a6c 6f67 286e 2929  rst. O(n*log(n))
-00037490: 2073 6176 6520 666f 7220 6e6f 6e2d 7472   save for non-tr
-000374a0: 6976 6961 6c20 6164 6469 7469 6f6e 616c  ivial additional
-000374b0: 2064 6174 6120 7374 7275 6374 7572 6573   data structures
-000374c0: 2061 6e64 0a20 2020 2020 2020 2020 2072   and.          r
-000374d0: 6973 6b73 2063 6175 7369 6e67 2074 6865  isks causing the
-000374e0: 206c 6172 6765 7374 2063 6875 6e6b 7320   largest chunks 
-000374f0: 6f66 2064 6174 6120 746f 2072 6570 6561  of data to repea
-00037500: 7465 646c 7920 6d6f 7665 2061 726f 756e  tedly move aroun
-00037510: 6420 7468 650a 2020 2020 2020 2020 2020  d the.          
-00037520: 636c 7573 7465 7220 6c69 6b65 2070 696e  cluster like pin
-00037530: 6261 6c6c 732e 0a20 2020 2020 2020 202d  balls..        -
-00037540: 204c 6561 7374 2072 6563 656e 746c 7920   Least recently 
-00037550: 7573 6564 2028 4c52 5529 2e20 5468 6973  used (LRU). This
-00037560: 2069 6e66 6f72 6d61 7469 6f6e 2069 7320   information is 
-00037570: 6375 7272 656e 746c 7920 6176 6169 6c61  currently availa
-00037580: 626c 6520 6f6e 2074 6865 0a20 2020 2020  ble on the.     
-00037590: 2020 2020 2077 6f72 6b65 7273 206f 6e6c       workers onl
-000375a0: 7920 616e 6420 6e6f 7420 7472 6976 6961  y and not trivia
-000375b0: 6c20 746f 2072 6570 6c69 6361 7465 206f  l to replicate o
-000375c0: 6e20 7468 6520 7363 6865 6475 6c65 723b  n the scheduler;
-000375d0: 2074 7261 6e73 6d69 7474 696e 6720 6974   transmitting it
-000375e0: 0a20 2020 2020 2020 2020 206f 7665 7220  .          over 
-000375f0: 7468 6520 6e65 7477 6f72 6b20 776f 756c  the network woul
-00037600: 6420 6265 2076 6572 7920 6578 7065 6e73  d be very expens
-00037610: 6976 652e 2041 6c73 6f2c 206e 6f74 6520  ive. Also, note 
-00037620: 7468 6174 2064 6173 6b20 7769 6c6c 2067  that dask will g
-00037630: 6f20 6f75 7420 6f66 0a20 2020 2020 2020  o out of.       
-00037640: 2020 2069 7473 2077 6179 2074 6f20 6d69     its way to mi
-00037650: 6e69 6d69 7365 2074 6865 2061 6d6f 756e  nimise the amoun
-00037660: 7420 6f66 2074 696d 6520 696e 7465 726d  t of time interm
-00037670: 6564 6961 7465 206b 6579 7320 6172 6520  ediate keys are 
-00037680: 6865 6c64 2069 6e20 6d65 6d6f 7279 2c0a  held in memory,.
-00037690: 2020 2020 2020 2020 2020 736f 2069 6e20            so in 
-000376a0: 7375 6368 2061 2063 6173 6520 4c52 4920  such a case LRI 
-000376b0: 6973 2061 2063 6c6f 7365 2061 7070 726f  is a close appro
-000376c0: 7869 6d61 7469 6f6e 206f 6620 4c52 552e  ximation of LRU.
-000376d0: 0a0a 2020 2020 2020 2020 5061 7261 6d65  ..        Parame
-000376e0: 7465 7273 0a20 2020 2020 2020 202d 2d2d  ters.        ---
-000376f0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-00037700: 6b65 7973 3a20 6f70 7469 6f6e 616c 0a20  keys: optional. 
-00037710: 2020 2020 2020 2020 2020 2061 6c6c 6f77             allow
-00037720: 6c69 7374 206f 6620 6461 736b 206b 6579  list of dask key
-00037730: 7320 7468 6174 2073 686f 756c 6420 6265  s that should be
-00037740: 2063 6f6e 7369 6465 7265 6420 666f 7220   considered for 
-00037750: 6d6f 7669 6e67 2e20 416c 6c20 6f74 6865  moving. All othe
-00037760: 7220 6b65 7973 0a20 2020 2020 2020 2020  r keys.         
-00037770: 2020 2077 696c 6c20 6265 2069 676e 6f72     will be ignor
-00037780: 6564 2e20 4e6f 7465 2074 6861 7420 7468  ed. Note that th
-00037790: 6973 206f 6666 6572 7320 6e6f 2067 7561  is offers no gua
-000377a0: 7261 6e74 6565 2074 6861 7420 6120 6b65  rantee that a ke
-000377b0: 7920 7769 6c6c 2061 6374 7561 6c6c 790a  y will actually.
-000377c0: 2020 2020 2020 2020 2020 2020 6265 206d              be m
-000377d0: 6f76 6564 2028 652e 672e 2062 6563 6175  oved (e.g. becau
-000377e0: 7365 2069 7420 6973 2075 6e6e 6563 6573  se it is unneces
-000377f0: 7361 7279 206f 7220 6265 6361 7573 6520  sary or because 
-00037800: 7468 6572 6520 6172 6520 6e6f 2076 6961  there are no via
-00037810: 626c 650a 2020 2020 2020 2020 2020 2020  ble.            
-00037820: 7265 6369 7069 656e 7420 776f 726b 6572  recipient worker
-00037830: 7320 666f 7220 6974 292e 0a20 2020 2020  s for it)..     
-00037840: 2020 2077 6f72 6b65 7273 3a20 6f70 7469     workers: opti
-00037850: 6f6e 616c 0a20 2020 2020 2020 2020 2020  onal.           
-00037860: 2061 6c6c 6f77 6c69 7374 206f 6620 776f   allowlist of wo
-00037870: 726b 6572 7320 6164 6472 6573 7365 7320  rkers addresses 
-00037880: 746f 2062 6520 636f 6e73 6964 6572 6564  to be considered
-00037890: 2061 7320 7365 6e64 6572 7320 6f72 2072   as senders or r
-000378a0: 6563 6970 6965 6e74 732e 0a20 2020 2020  ecipients..     
-000378b0: 2020 2020 2020 2041 6c6c 206f 7468 6572         All other
-000378c0: 2077 6f72 6b65 7273 2077 696c 6c20 6265   workers will be
-000378d0: 2069 676e 6f72 6564 2e20 5468 6520 6d65   ignored. The me
-000378e0: 616e 2063 6c75 7374 6572 206f 6363 7570  an cluster occup
-000378f0: 616e 6379 2077 696c 6c20 6265 0a20 2020  ancy will be.   
-00037900: 2020 2020 2020 2020 2063 616c 6375 6c61           calcula
-00037910: 7465 6420 6f6e 6c79 2075 7369 6e67 2074  ted only using t
-00037920: 6865 2061 6c6c 6f77 6564 2077 6f72 6b65  he allowed worke
-00037930: 7273 2e0a 2020 2020 2020 2020 2222 220a  rs..        """.
-00037940: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
-00037950: 5f69 6420 3d20 7374 696d 756c 7573 5f69  _id = stimulus_i
-00037960: 6420 6f72 2066 2272 6562 616c 616e 6365  d or f"rebalance
-00037970: 2d7b 7469 6d65 2829 7d22 0a0a 2020 2020  -{time()}"..    
-00037980: 2020 2020 7773 733a 2043 6f6c 6c65 6374      wss: Collect
-00037990: 696f 6e5b 576f 726b 6572 5374 6174 655d  ion[WorkerState]
-000379a0: 0a20 2020 2020 2020 2069 6620 776f 726b  .        if work
-000379b0: 6572 7320 6973 206e 6f74 204e 6f6e 653a  ers is not None:
-000379c0: 0a20 2020 2020 2020 2020 2020 2077 7373  .            wss
-000379d0: 203d 205b 7365 6c66 2e77 6f72 6b65 7273   = [self.workers
-000379e0: 5b77 5d20 666f 7220 7720 696e 2077 6f72  [w] for w in wor
-000379f0: 6b65 7273 5d0a 2020 2020 2020 2020 656c  kers].        el
-00037a00: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00037a10: 7773 7320 3d20 7365 6c66 2e77 6f72 6b65  wss = self.worke
-00037a20: 7273 2e76 616c 7565 7328 290a 2020 2020  rs.values().    
-00037a30: 2020 2020 6966 206e 6f74 2077 7373 3a0a      if not wss:.
-00037a40: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00037a50: 726e 207b 2273 7461 7475 7322 3a20 224f  rn {"status": "O
-00037a60: 4b22 7d0a 0a20 2020 2020 2020 2069 6620  K"}..        if 
-00037a70: 6b65 7973 2069 7320 6e6f 7420 4e6f 6e65  keys is not None
-00037a80: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00037a90: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
-00037aa0: 6b65 7973 2c20 5365 7429 3a0a 2020 2020  keys, Set):.    
-00037ab0: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
-00037ac0: 203d 2073 6574 286b 6579 7329 2020 2320   = set(keys)  # 
-00037ad0: 756e 6c65 7373 2061 6c72 6561 6479 2061  unless already a
-00037ae0: 2073 6574 2d6c 696b 650a 2020 2020 2020   set-like.      
-00037af0: 2020 2020 2020 6966 206e 6f74 206b 6579        if not key
-00037b00: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00037b10: 2020 2072 6574 7572 6e20 7b22 7374 6174     return {"stat
-00037b20: 7573 223a 2022 4f4b 227d 0a20 2020 2020  us": "OK"}.     
-00037b30: 2020 2020 2020 206d 6973 7369 6e67 5f64         missing_d
-00037b40: 6174 6120 3d20 5b0a 2020 2020 2020 2020  ata = [.        
-00037b50: 2020 2020 2020 2020 6b20 666f 7220 6b20          k for k 
-00037b60: 696e 206b 6579 7320 6966 206b 206e 6f74  in keys if k not
-00037b70: 2069 6e20 7365 6c66 2e74 6173 6b73 206f   in self.tasks o
-00037b80: 7220 6e6f 7420 7365 6c66 2e74 6173 6b73  r not self.tasks
-00037b90: 5b6b 5d2e 7768 6f5f 6861 730a 2020 2020  [k].who_has.    
-00037ba0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-00037bb0: 2020 2020 2020 6966 206d 6973 7369 6e67        if missing
-00037bc0: 5f64 6174 613a 0a20 2020 2020 2020 2020  _data:.         
-00037bd0: 2020 2020 2020 2072 6574 7572 6e20 7b22         return {"
-00037be0: 7374 6174 7573 223a 2022 7061 7274 6961  status": "partia
-00037bf0: 6c2d 6661 696c 222c 2022 6b65 7973 223a  l-fail", "keys":
-00037c00: 206d 6973 7369 6e67 5f64 6174 617d 0a0a   missing_data}..
-00037c10: 2020 2020 2020 2020 6d73 6773 203d 2073          msgs = s
-00037c20: 656c 662e 5f72 6562 616c 616e 6365 5f66  elf._rebalance_f
-00037c30: 696e 645f 6d73 6773 286b 6579 732c 2077  ind_msgs(keys, w
-00037c40: 7373 290a 2020 2020 2020 2020 6966 206e  ss).        if n
-00037c50: 6f74 206d 7367 733a 0a20 2020 2020 2020  ot msgs:.       
-00037c60: 2020 2020 2072 6574 7572 6e20 7b22 7374       return {"st
-00037c70: 6174 7573 223a 2022 4f4b 227d 0a0a 2020  atus": "OK"}..  
-00037c80: 2020 2020 2020 6173 796e 6320 7769 7468        async with
-00037c90: 2073 656c 662e 5f6c 6f63 6b3a 0a20 2020   self._lock:.   
-00037ca0: 2020 2020 2020 2020 2072 6573 756c 7420           result 
-00037cb0: 3d20 6177 6169 7420 7365 6c66 2e5f 7265  = await self._re
-00037cc0: 6261 6c61 6e63 655f 6d6f 7665 5f64 6174  balance_move_dat
-00037cd0: 6128 6d73 6773 2c20 7374 696d 756c 7573  a(msgs, stimulus
-00037ce0: 5f69 6429 0a20 2020 2020 2020 2020 2020  _id).           
-00037cf0: 2069 6620 7265 7375 6c74 5b22 7374 6174   if result["stat
-00037d00: 7573 225d 203d 3d20 2270 6172 7469 616c  us"] == "partial
-00037d10: 2d66 6169 6c22 2061 6e64 206b 6579 7320  -fail" and keys 
-00037d20: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00037d30: 2020 2020 2020 2020 2023 204f 6e6c 7920           # Only 
-00037d40: 7265 7475 726e 2066 6169 6c65 6420 6b65  return failed ke
-00037d50: 7973 2069 6620 7468 6520 636c 6965 6e74  ys if the client
-00037d60: 2065 7870 6c69 6369 746c 7920 6173 6b65   explicitly aske
-00037d70: 6420 666f 7220 7468 656d 0a20 2020 2020  d for them.     
-00037d80: 2020 2020 2020 2020 2020 2072 6573 756c             resul
-00037d90: 7420 3d20 7b22 7374 6174 7573 223a 2022  t = {"status": "
-00037da0: 4f4b 227d 0a20 2020 2020 2020 2020 2020  OK"}.           
-00037db0: 2072 6574 7572 6e20 7265 7375 6c74 0a0a   return result..
-00037dc0: 2020 2020 6465 6620 5f72 6562 616c 616e      def _rebalan
-00037dd0: 6365 5f66 696e 645f 6d73 6773 280a 2020  ce_find_msgs(.  
-00037de0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-00037df0: 2020 2020 6b65 7973 3a20 5365 745b 4861      keys: Set[Ha
-00037e00: 7368 6162 6c65 5d20 7c20 4e6f 6e65 2c0a  shable] | None,.
-00037e10: 2020 2020 2020 2020 776f 726b 6572 733a          workers:
-00037e20: 2049 7465 7261 626c 655b 576f 726b 6572   Iterable[Worker
-00037e30: 5374 6174 655d 2c0a 2020 2020 2920 2d3e  State],.    ) ->
-00037e40: 206c 6973 745b 7475 706c 655b 576f 726b   list[tuple[Work
-00037e50: 6572 5374 6174 652c 2057 6f72 6b65 7253  erState, WorkerS
-00037e60: 7461 7465 2c20 5461 736b 5374 6174 655d  tate, TaskState]
-00037e70: 5d3a 0a20 2020 2020 2020 2022 2222 4964  ]:.        """Id
-00037e80: 656e 7469 6679 2077 6f72 6b65 7273 2074  entify workers t
-00037e90: 6861 7420 6e65 6564 2074 6f20 6c6f 7365  hat need to lose
-00037ea0: 206b 6579 7320 616e 6420 7468 6f73 6520   keys and those 
-00037eb0: 7468 6174 2063 616e 2072 6563 6569 7665  that can receive
-00037ec0: 2074 6865 6d2c 0a20 2020 2020 2020 2074   them,.        t
-00037ed0: 6f67 6574 6865 7220 7769 7468 2068 6f77  ogether with how
-00037ee0: 206d 616e 7920 6279 7465 7320 6561 6368   many bytes each
-00037ef0: 206e 6565 6473 2074 6f20 6c6f 7365 2f72   needs to lose/r
-00037f00: 6563 6569 7665 2e20 5468 656e 2c20 7061  eceive. Then, pa
-00037f10: 6972 2061 2073 656e 6465 720a 2020 2020  ir a sender.    
-00037f20: 2020 2020 776f 726b 6572 2077 6974 6820      worker with 
-00037f30: 6120 7265 6369 7069 656e 7420 776f 726b  a recipient work
-00037f40: 6572 2066 6f72 2065 6163 6820 6b65 792c  er for each key,
-00037f50: 2075 6e74 696c 2074 6865 2063 6c75 7374   until the clust
-00037f60: 6572 2069 7320 7265 6261 6c61 6e63 6564  er is rebalanced
-00037f70: 2e0a 0a20 2020 2020 2020 2054 6869 7320  ...        This 
-00037f80: 6d65 7468 6f64 206f 6e6c 7920 6465 6669  method only defi
-00037f90: 6e65 7320 7468 6520 776f 726b 2074 6f20  nes the work to 
-00037fa0: 6265 2070 6572 666f 726d 6564 3b20 6974  be performed; it
-00037fb0: 2064 6f65 7320 6e6f 7420 7374 6172 7420   does not start 
-00037fc0: 616e 7920 6e65 7477 6f72 6b0a 2020 2020  any network.    
-00037fd0: 2020 2020 7472 616e 7366 6572 7320 6974      transfers it
-00037fe0: 7365 6c66 2e0a 0a20 2020 2020 2020 2054  self...        T
-00037ff0: 6865 2062 6967 2d4f 2063 6f6d 706c 6578  he big-O complex
-00038000: 6974 7920 6973 204f 2877 7420 2b20 6b65  ity is O(wt + ke
-00038010: 2a6c 6f67 2877 6529 292c 2077 6865 7265  *log(we)), where
-00038020: 0a0a 2020 2020 2020 2020 2d20 7774 2069  ..        - wt i
-00038030: 7320 7468 6520 746f 7461 6c20 6e75 6d62  s the total numb
-00038040: 6572 206f 6620 776f 726b 6572 7320 6f6e  er of workers on
-00038050: 2074 6865 2063 6c75 7374 6572 2028 6f72   the cluster (or
-00038060: 2074 6865 206e 756d 6265 7220 6f66 2061   the number of a
-00038070: 6c6c 6f77 6564 0a20 2020 2020 2020 2020  llowed.         
-00038080: 2077 6f72 6b65 7273 2c20 6966 2065 7870   workers, if exp
-00038090: 6c69 6369 746c 7920 7374 6174 6564 2062  licitly stated b
-000380a0: 7920 7468 6520 7573 6572 290a 2020 2020  y the user).    
-000380b0: 2020 2020 2d20 7765 2069 7320 7468 6520      - we is the 
-000380c0: 6e75 6d62 6572 206f 6620 776f 726b 6572  number of worker
-000380d0: 7320 7468 6174 2061 7265 2065 6c69 6769  s that are eligi
-000380e0: 626c 6520 746f 2062 6520 7365 6e64 6572  ble to be sender
-000380f0: 7320 6f72 2072 6563 6970 6965 6e74 730a  s or recipients.
-00038100: 2020 2020 2020 2020 2d20 6b74 2069 7320          - kt is 
-00038110: 7468 6520 746f 7461 6c20 6e75 6d62 6572  the total number
-00038120: 206f 6620 6b65 7973 206f 6e20 7468 6520   of keys on the 
-00038130: 636c 7573 7465 7220 286f 7220 6f6e 2074  cluster (or on t
-00038140: 6865 2061 6c6c 6f77 6564 2077 6f72 6b65  he allowed worke
-00038150: 7273 290a 2020 2020 2020 2020 2d20 6b65  rs).        - ke
-00038160: 2069 7320 7468 6520 6e75 6d62 6572 206f   is the number o
-00038170: 6620 6b65 7973 2074 6861 7420 6e65 6564  f keys that need
-00038180: 2074 6f20 6265 206d 6f76 6564 2069 6e20   to be moved in 
-00038190: 6f72 6465 7220 746f 2061 6368 6965 7665  order to achieve
-000381a0: 2061 2062 616c 616e 6365 640a 2020 2020   a balanced.    
-000381b0: 2020 2020 2020 636c 7573 7465 720a 0a20        cluster.. 
-000381c0: 2020 2020 2020 2054 6865 7265 2069 7320         There is 
-000381d0: 6120 6465 6765 6e65 7261 7465 2065 6467  a degenerate edg
-000381e0: 6520 6361 7365 204f 2877 7420 2b20 6b74  e case O(wt + kt
-000381f0: 2a6c 6f67 2877 6529 2920 7768 656e 206b  *log(we)) when k
-00038200: 7420 6973 206d 7563 6820 6772 6561 7465  t is much greate
-00038210: 7220 7468 616e 0a20 2020 2020 2020 2074  r than.        t
-00038220: 6865 206e 756d 6265 7220 6f66 2061 6c6c  he number of all
-00038230: 6f77 6564 206b 6579 732c 206f 7220 7768  owed keys, or wh
-00038240: 656e 206d 6f73 7420 6b65 7973 2061 7265  en most keys are
-00038250: 2072 6570 6c69 6361 7465 6420 6f72 2063   replicated or c
-00038260: 616e 6e6f 7420 6265 0a20 2020 2020 2020  annot be.       
-00038270: 206d 6f76 6564 2066 6f72 2073 6f6d 6520   moved for some 
-00038280: 6f74 6865 7220 7265 6173 6f6e 2e0a 0a20  other reason... 
-00038290: 2020 2020 2020 2052 6574 7572 6e73 206c         Returns l
-000382a0: 6973 7420 6f66 2074 7570 6c65 7320 746f  ist of tuples to
-000382b0: 2066 6565 6420 696e 746f 205f 7265 6261   feed into _reba
-000382c0: 6c61 6e63 655f 6d6f 7665 5f64 6174 613a  lance_move_data:
-000382d0: 0a0a 2020 2020 2020 2020 2d20 7365 6e64  ..        - send
-000382e0: 6572 2077 6f72 6b65 720a 2020 2020 2020  er worker.      
-000382f0: 2020 2d20 7265 6369 7069 656e 7420 776f    - recipient wo
-00038300: 726b 6572 0a20 2020 2020 2020 202d 2074  rker.        - t
-00038310: 6173 6b20 746f 2062 6520 7472 616e 7366  ask to be transf
-00038320: 6572 7265 640a 2020 2020 2020 2020 2222  erred.        ""
-00038330: 220a 2020 2020 2020 2020 2320 4865 6170  ".        # Heap
-00038340: 7320 6f66 2077 6f72 6b65 7273 2c20 6d61  s of workers, ma
-00038350: 6e61 6765 6420 6279 2074 6865 2068 6561  naged by the hea
-00038360: 7071 206d 6f64 756c 652c 2074 6861 7420  pq module, that 
-00038370: 6e65 6564 2074 6f20 7365 6e64 2f72 6563  need to send/rec
-00038380: 6569 7665 2064 6174 612c 0a20 2020 2020  eive data,.     
-00038390: 2020 2023 2077 6974 6820 686f 7720 6d61     # with how ma
-000383a0: 6e79 2062 7974 6573 2065 6163 6820 6e65  ny bytes each ne
-000383b0: 6564 7320 746f 2073 656e 642f 7265 6365  eds to send/rece
-000383c0: 6976 652e 0a20 2020 2020 2020 2023 0a20  ive..        #. 
-000383d0: 2020 2020 2020 2023 2045 6163 6820 656c         # Each el
-000383e0: 656d 656e 7420 6f66 2074 6865 2068 6561  ement of the hea
-000383f0: 7020 6973 2061 2074 7570 6c65 2063 6f6e  p is a tuple con
-00038400: 7374 7275 6374 6564 2061 7320 666f 6c6c  structed as foll
-00038410: 6f77 733a 0a20 2020 2020 2020 2023 202d  ows:.        # -
-00038420: 2073 6e64 5f62 7974 6573 5f6d 6178 2f72   snd_bytes_max/r
-00038430: 6563 5f62 7974 6573 5f6d 6178 3a20 6d61  ec_bytes_max: ma
-00038440: 7869 6d75 6d20 6e75 6d62 6572 206f 6620  ximum number of 
-00038450: 6279 7465 7320 746f 2073 656e 6420 6f72  bytes to send or
-00038460: 2072 6563 6569 7665 2e0a 2020 2020 2020   receive..      
-00038470: 2020 2320 2020 5468 6973 206e 756d 6265    #   This numbe
-00038480: 7220 6973 206e 6567 6174 6976 652c 2073  r is negative, s
-00038490: 6f20 7468 6174 2074 6865 2077 6f72 6b65  o that the worke
-000384a0: 7273 2066 6172 7468 6573 7420 6672 6f6d  rs farthest from
-000384b0: 2074 6865 2063 6c75 7374 6572 206d 6561   the cluster mea
-000384c0: 6e0a 2020 2020 2020 2020 2320 2020 6172  n.        #   ar
-000384d0: 6520 6174 2074 6865 2074 6f70 206f 6620  e at the top of 
-000384e0: 7468 6520 736d 616c 6c65 7374 2d66 6972  the smallest-fir
-000384f0: 7374 2068 6561 7073 2e0a 2020 2020 2020  st heaps..      
-00038500: 2020 2320 2d20 736e 645f 6279 7465 735f    # - snd_bytes_
-00038510: 6d69 6e2f 7265 635f 6279 7465 735f 6d69  min/rec_bytes_mi
-00038520: 6e3a 206d 696e 696d 756d 206e 756d 6265  n: minimum numbe
-00038530: 7220 6f66 2062 7974 6573 2061 6674 6572  r of bytes after
-00038540: 2073 656e 6469 6e67 2f72 6563 6569 7669   sending/receivi
-00038550: 6e67 0a20 2020 2020 2020 2023 2020 2077  ng.        #   w
-00038560: 6869 6368 2074 6865 2077 6f72 6b65 7220  hich the worker 
-00038570: 7368 6f75 6c64 206e 6f74 2062 6520 636f  should not be co
-00038580: 6e73 6964 6572 6564 2061 6e79 6d6f 7265  nsidered anymore
-00038590: 2e20 5468 6973 2069 7320 616c 736f 206e  . This is also n
-000385a0: 6567 6174 6976 652e 0a20 2020 2020 2020  egative..       
-000385b0: 2023 202d 2061 7262 6974 7261 7279 2075   # - arbitrary u
-000385c0: 6e69 7175 6520 6e75 6d62 6572 2c20 7468  nique number, th
-000385d0: 6572 6520 6a75 7374 2074 6f20 746f 206d  ere just to to m
-000385e0: 616b 6520 7375 7265 2074 6861 7420 576f  ake sure that Wo
-000385f0: 726b 6572 5374 6174 6520 6f62 6a65 6374  rkerState object
-00038600: 730a 2020 2020 2020 2020 2320 2020 6172  s.        #   ar
-00038610: 6520 6e65 7665 7220 7573 6564 2066 6f72  e never used for
-00038620: 2073 6f72 7469 6e67 2069 6e20 7468 6520   sorting in the 
-00038630: 756e 6c69 6b65 6c79 2065 7665 6e74 2074  unlikely event t
-00038640: 6861 7420 7477 6f20 7072 6f63 6573 7365  hat two processe
-00038650: 7320 6861 7665 0a20 2020 2020 2020 2023  s have.        #
-00038660: 2020 2065 7861 6374 6c79 2074 6865 2073     exactly the s
-00038670: 616d 6520 6e75 6d62 6572 206f 6620 6279  ame number of by
-00038680: 7465 7320 616c 6c6f 6361 7465 642e 0a20  tes allocated.. 
-00038690: 2020 2020 2020 2023 202d 2057 6f72 6b65         # - Worke
-000386a0: 7253 7461 7465 0a20 2020 2020 2020 2023  rState.        #
-000386b0: 202d 2069 7465 7261 746f 7220 6f66 2061   - iterator of a
-000386c0: 6c6c 2074 6173 6b73 2069 6e20 6d65 6d6f  ll tasks in memo
-000386d0: 7279 206f 6e20 7468 6520 776f 726b 6572  ry on the worker
-000386e0: 2028 7365 6e64 6572 7320 6f6e 6c79 292c   (senders only),
-000386f0: 2069 6e73 6572 7469 6f6e 0a20 2020 2020   insertion.     
-00038700: 2020 2023 2020 2073 6f72 7465 6420 286c     #   sorted (l
-00038710: 6561 7374 2072 6563 656e 746c 7920 696e  east recently in
-00038720: 7365 7274 6564 2066 6972 7374 292e 0a20  serted first).. 
-00038730: 2020 2020 2020 2023 2020 204e 6f74 6520         #   Note 
-00038740: 7468 6174 2074 6869 7320 6974 6572 6174  that this iterat
-00038750: 6f72 2077 696c 6c20 7479 7069 6361 6c6c  or will typicall
-00038760: 7920 2a6e 6f74 2a20 6265 2065 7868 6175  y *not* be exhau
-00038770: 7374 6564 2e20 4974 2077 696c 6c20 6f6e  sted. It will on
-00038780: 6c79 2062 650a 2020 2020 2020 2020 2320  ly be.        # 
-00038790: 2020 6578 6861 7573 7465 6420 6966 2c20    exhausted if, 
-000387a0: 6166 7465 7220 6d6f 7669 6e67 2061 7761  after moving awa
-000387b0: 7920 6672 6f6d 2074 6865 2077 6f72 6b65  y from the worke
-000387c0: 7220 616c 6c20 6b65 7973 2074 6861 7420  r all keys that 
-000387d0: 6361 6e20 6265 206d 6f76 6564 2c0a 2020  can be moved,.  
-000387e0: 2020 2020 2020 2320 2020 6973 2069 6e73        #   is ins
-000387f0: 7566 6669 6369 656e 7420 746f 2064 726f  ufficient to dro
-00038800: 7020 736e 645f 6279 7465 735f 6d69 6e20  p snd_bytes_min 
-00038810: 6162 6f76 6520 302e 0a20 2020 2020 2020  above 0..       
-00038820: 2073 656e 6465 7273 3a20 6c69 7374 5b74   senders: list[t
-00038830: 7570 6c65 5b69 6e74 2c20 696e 742c 2069  uple[int, int, i
-00038840: 6e74 2c20 576f 726b 6572 5374 6174 652c  nt, WorkerState,
-00038850: 2049 7465 7261 746f 725b 5461 736b 5374   Iterator[TaskSt
-00038860: 6174 655d 5d5d 203d 205b 5d0a 2020 2020  ate]]] = [].    
-00038870: 2020 2020 7265 6369 7069 656e 7473 3a20      recipients: 
-00038880: 6c69 7374 5b74 7570 6c65 5b69 6e74 2c20  list[tuple[int, 
-00038890: 696e 742c 2069 6e74 2c20 576f 726b 6572  int, int, Worker
-000388a0: 5374 6174 655d 5d20 3d20 5b5d 0a0a 2020  State]] = []..  
-000388b0: 2020 2020 2020 2320 4f75 7470 7574 3a20        # Output: 
-000388c0: 5b28 7365 6e64 6572 2c20 7265 6369 7069  [(sender, recipi
-000388d0: 656e 742c 2074 6173 6b29 2c20 2e2e 2e5d  ent, task), ...]
-000388e0: 0a20 2020 2020 2020 206d 7367 733a 206c  .        msgs: l
-000388f0: 6973 745b 7475 706c 655b 576f 726b 6572  ist[tuple[Worker
-00038900: 5374 6174 652c 2057 6f72 6b65 7253 7461  State, WorkerSta
-00038910: 7465 2c20 5461 736b 5374 6174 655d 5d20  te, TaskState]] 
-00038920: 3d20 5b5d 0a0a 2020 2020 2020 2020 2320  = []..        # 
-00038930: 4279 2064 6566 6175 6c74 2c20 7468 6973  By default, this
-00038940: 2069 7320 7468 6520 6f70 7469 6d69 7374   is the optimist
-00038950: 6963 206d 656d 6f72 792c 206d 6561 6e69  ic memory, meani
-00038960: 6e67 2074 6f74 616c 2070 726f 6365 7373  ng total process
-00038970: 206d 656d 6f72 7920 6d69 6e75 730a 2020   memory minus.  
-00038980: 2020 2020 2020 2320 756e 6d61 6e61 6765        # unmanage
-00038990: 6420 6d65 6d6f 7279 2074 6861 7420 6170  d memory that ap
-000389a0: 7065 6172 6564 206f 7665 7220 7468 6520  peared over the 
-000389b0: 6c61 7374 2033 3020 7365 636f 6e64 730a  last 30 seconds.
-000389c0: 2020 2020 2020 2020 2320 2864 6973 7472          # (distr
-000389d0: 6962 7574 6564 2e77 6f72 6b65 722e 6d65  ibuted.worker.me
-000389e0: 6d6f 7279 2e72 6563 656e 742d 746f 2d6f  mory.recent-to-o
-000389f0: 6c64 2d74 696d 6529 2e0a 2020 2020 2020  ld-time)..      
-00038a00: 2020 2320 5468 6973 206c 6574 7320 7573    # This lets us
-00038a10: 2069 676e 6f72 6520 7465 6d70 6f72 6172   ignore temporar
-00038a20: 7920 7370 696b 6573 2063 6175 7365 6420  y spikes caused 
-00038a30: 6279 2074 6173 6b20 6865 6170 2075 7361  by task heap usa
-00038a40: 6765 2e0a 2020 2020 2020 2020 6d65 6d6f  ge..        memo
-00038a50: 7279 5f62 795f 776f 726b 6572 203d 205b  ry_by_worker = [
-00038a60: 0a20 2020 2020 2020 2020 2020 2028 7773  .            (ws
-00038a70: 2c20 6765 7461 7474 7228 7773 2e6d 656d  , getattr(ws.mem
-00038a80: 6f72 792c 2073 656c 662e 4d45 4d4f 5259  ory, self.MEMORY
-00038a90: 5f52 4542 414c 414e 4345 5f4d 4541 5355  _REBALANCE_MEASU
-00038aa0: 5245 2929 2066 6f72 2077 7320 696e 2077  RE)) for ws in w
-00038ab0: 6f72 6b65 7273 0a20 2020 2020 2020 205d  orkers.        ]
-00038ac0: 0a20 2020 2020 2020 206d 6561 6e5f 6d65  .        mean_me
-00038ad0: 6d6f 7279 203d 2073 756d 286d 2066 6f72  mory = sum(m for
-00038ae0: 205f 2c20 6d20 696e 206d 656d 6f72 795f   _, m in memory_
-00038af0: 6279 5f77 6f72 6b65 7229 202f 2f20 6c65  by_worker) // le
-00038b00: 6e28 6d65 6d6f 7279 5f62 795f 776f 726b  n(memory_by_work
-00038b10: 6572 290a 0a20 2020 2020 2020 2066 6f72  er)..        for
-00038b20: 2077 732c 2077 735f 6d65 6d6f 7279 2069   ws, ws_memory i
-00038b30: 6e20 6d65 6d6f 7279 5f62 795f 776f 726b  n memory_by_work
-00038b40: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
-00038b50: 6966 2077 732e 6d65 6d6f 7279 5f6c 696d  if ws.memory_lim
-00038b60: 6974 3a0a 2020 2020 2020 2020 2020 2020  it:.            
-00038b70: 2020 2020 6861 6c66 5f67 6170 203d 2069      half_gap = i
-00038b80: 6e74 2873 656c 662e 4d45 4d4f 5259 5f52  nt(self.MEMORY_R
-00038b90: 4542 414c 414e 4345 5f48 414c 465f 4741  EBALANCE_HALF_GA
-00038ba0: 5020 2a20 7773 2e6d 656d 6f72 795f 6c69  P * ws.memory_li
-00038bb0: 6d69 7429 0a20 2020 2020 2020 2020 2020  mit).           
-00038bc0: 2020 2020 2073 656e 6465 725f 6d69 6e20       sender_min 
-00038bd0: 3d20 7365 6c66 2e4d 454d 4f52 595f 5245  = self.MEMORY_RE
-00038be0: 4241 4c41 4e43 455f 5345 4e44 4552 5f4d  BALANCE_SENDER_M
-00038bf0: 494e 202a 2077 732e 6d65 6d6f 7279 5f6c  IN * ws.memory_l
-00038c00: 696d 6974 0a20 2020 2020 2020 2020 2020  imit.           
-00038c10: 2020 2020 2072 6563 6970 6965 6e74 5f6d       recipient_m
-00038c20: 6178 203d 2073 656c 662e 4d45 4d4f 5259  ax = self.MEMORY
-00038c30: 5f52 4542 414c 414e 4345 5f52 4543 4950  _REBALANCE_RECIP
-00038c40: 4945 4e54 5f4d 4158 202a 2077 732e 6d65  IENT_MAX * ws.me
-00038c50: 6d6f 7279 5f6c 696d 6974 0a20 2020 2020  mory_limit.     
-00038c60: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00038c70: 2020 2020 2020 2020 2020 2020 2068 616c               hal
-00038c80: 665f 6761 7020 3d20 300a 2020 2020 2020  f_gap = 0.      
-00038c90: 2020 2020 2020 2020 2020 7365 6e64 6572            sender
-00038ca0: 5f6d 696e 203d 2030 2e30 0a20 2020 2020  _min = 0.0.     
-00038cb0: 2020 2020 2020 2020 2020 2072 6563 6970             recip
-00038cc0: 6965 6e74 5f6d 6178 203d 206d 6174 682e  ient_max = math.
-00038cd0: 696e 660a 0a20 2020 2020 2020 2020 2020  inf..           
-00038ce0: 2069 6620 280a 2020 2020 2020 2020 2020   if (.          
-00038cf0: 2020 2020 2020 7773 2e5f 6861 735f 7768        ws._has_wh
-00038d00: 6174 0a20 2020 2020 2020 2020 2020 2020  at.             
-00038d10: 2020 2061 6e64 2077 735f 6d65 6d6f 7279     and ws_memory
-00038d20: 203e 3d20 6d65 616e 5f6d 656d 6f72 7920   >= mean_memory 
-00038d30: 2b20 6861 6c66 5f67 6170 0a20 2020 2020  + half_gap.     
-00038d40: 2020 2020 2020 2020 2020 2061 6e64 2077             and w
-00038d50: 735f 6d65 6d6f 7279 203e 3d20 7365 6e64  s_memory >= send
-00038d60: 6572 5f6d 696e 0a20 2020 2020 2020 2020  er_min.         
-00038d70: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
-00038d80: 2020 2020 2020 2320 5468 6973 206d 6179        # This may
-00038d90: 2073 656e 6420 7468 6520 776f 726b 6572   send the worker
-00038da0: 2062 656c 6f77 2073 656e 6465 725f 6d69   below sender_mi
-00038db0: 6e20 2862 7920 6465 7369 676e 290a 2020  n (by design).  
-00038dc0: 2020 2020 2020 2020 2020 2020 2020 736e                sn
-00038dd0: 645f 6279 7465 735f 6d61 7820 3d20 6d65  d_bytes_max = me
-00038de0: 616e 5f6d 656d 6f72 7920 2d20 7773 5f6d  an_memory - ws_m
-00038df0: 656d 6f72 7920 2023 206e 6567 6174 6976  emory  # negativ
-00038e00: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00038e10: 2020 736e 645f 6279 7465 735f 6d69 6e20    snd_bytes_min 
-00038e20: 3d20 736e 645f 6279 7465 735f 6d61 7820  = snd_bytes_max 
-00038e30: 2b20 6861 6c66 5f67 6170 2020 2320 6e65  + half_gap  # ne
-00038e40: 6761 7469 7665 0a20 2020 2020 2020 2020  gative.         
-00038e50: 2020 2020 2020 2023 2053 6565 2064 6566         # See def
-00038e60: 696e 6974 696f 6e20 6f66 2073 656e 6465  inition of sende
-00038e70: 7273 2061 626f 7665 0a20 2020 2020 2020  rs above.       
-00038e80: 2020 2020 2020 2020 2073 656e 6465 7273           senders
-00038e90: 2e61 7070 656e 6428 0a20 2020 2020 2020  .append(.       
-00038ea0: 2020 2020 2020 2020 2020 2020 2028 736e               (sn
-00038eb0: 645f 6279 7465 735f 6d61 782c 2073 6e64  d_bytes_max, snd
-00038ec0: 5f62 7974 6573 5f6d 696e 2c20 6964 2877  _bytes_min, id(w
-00038ed0: 7329 2c20 7773 2c20 6974 6572 2877 732e  s), ws, iter(ws.
-00038ee0: 5f68 6173 5f77 6861 7429 290a 2020 2020  _has_what)).    
-00038ef0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00038f00: 2020 2020 2020 2020 2020 656c 6966 2077            elif w
-00038f10: 735f 6d65 6d6f 7279 203c 206d 6561 6e5f  s_memory < mean_
-00038f20: 6d65 6d6f 7279 202d 2068 616c 665f 6761  memory - half_ga
-00038f30: 7020 616e 6420 7773 5f6d 656d 6f72 7920  p and ws_memory 
-00038f40: 3c20 7265 6369 7069 656e 745f 6d61 783a  < recipient_max:
-00038f50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00038f60: 2023 2054 6869 7320 6d61 7920 7365 6e64   # This may send
-00038f70: 2074 6865 2077 6f72 6b65 7220 6162 6f76   the worker abov
-00038f80: 6520 7265 6369 7069 656e 745f 6d61 7820  e recipient_max 
-00038f90: 2862 7920 6465 7369 676e 290a 2020 2020  (by design).    
-00038fa0: 2020 2020 2020 2020 2020 2020 7265 635f              rec_
-00038fb0: 6279 7465 735f 6d61 7820 3d20 7773 5f6d  bytes_max = ws_m
-00038fc0: 656d 6f72 7920 2d20 6d65 616e 5f6d 656d  emory - mean_mem
-00038fd0: 6f72 7920 2023 206e 6567 6174 6976 650a  ory  # negative.
-00038fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038ff0: 7265 635f 6279 7465 735f 6d69 6e20 3d20  rec_bytes_min = 
-00039000: 7265 635f 6279 7465 735f 6d61 7820 2b20  rec_bytes_max + 
-00039010: 6861 6c66 5f67 6170 2020 2320 6e65 6761  half_gap  # nega
-00039020: 7469 7665 0a20 2020 2020 2020 2020 2020  tive.           
-00039030: 2020 2020 2023 2053 6565 2064 6566 696e       # See defin
-00039040: 6974 696f 6e20 6f66 2072 6563 6970 6965  ition of recipie
-00039050: 6e74 7320 6162 6f76 650a 2020 2020 2020  nts above.      
-00039060: 2020 2020 2020 2020 2020 7265 6369 7069            recipi
-00039070: 656e 7473 2e61 7070 656e 6428 2872 6563  ents.append((rec
-00039080: 5f62 7974 6573 5f6d 6178 2c20 7265 635f  _bytes_max, rec_
-00039090: 6279 7465 735f 6d69 6e2c 2069 6428 7773  bytes_min, id(ws
-000390a0: 292c 2077 7329 290a 0a20 2020 2020 2020  ), ws))..       
-000390b0: 2023 2046 6173 7420 6578 6974 2069 6e20   # Fast exit in 
-000390c0: 6361 7365 206e 6f20 7472 616e 7366 6572  case no transfer
-000390d0: 7320 6172 6520 6e65 6365 7373 6172 7920  s are necessary 
-000390e0: 6f72 2070 6f73 7369 626c 650a 2020 2020  or possible.    
-000390f0: 2020 2020 6966 206e 6f74 2073 656e 6465      if not sende
-00039100: 7273 206f 7220 6e6f 7420 7265 6369 7069  rs or not recipi
-00039110: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
-00039120: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
-00039130: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00039140: 2020 2261 6c6c 222c 0a20 2020 2020 2020    "all",.       
-00039150: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00039160: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00039170: 6163 7469 6f6e 223a 2022 7265 6261 6c61  action": "rebala
-00039180: 6e63 6522 2c0a 2020 2020 2020 2020 2020  nce",.          
-00039190: 2020 2020 2020 2020 2020 2273 656e 6465            "sende
-000391a0: 7273 223a 206c 656e 2873 656e 6465 7273  rs": len(senders
-000391b0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-000391c0: 2020 2020 2020 2022 7265 6369 7069 656e         "recipien
-000391d0: 7473 223a 206c 656e 2872 6563 6970 6965  ts": len(recipie
-000391e0: 6e74 7329 2c0a 2020 2020 2020 2020 2020  nts),.          
-000391f0: 2020 2020 2020 2020 2020 226d 6f76 6564            "moved
-00039200: 5f6b 6579 7322 3a20 302c 0a20 2020 2020  _keys": 0,.     
-00039210: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
-00039220: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00039230: 2020 2020 2020 2020 7265 7475 726e 205b          return [
-00039240: 5d0a 0a20 2020 2020 2020 2068 6561 7071  ]..        heapq
-00039250: 2e68 6561 7069 6679 2873 656e 6465 7273  .heapify(senders
-00039260: 290a 2020 2020 2020 2020 6865 6170 712e  ).        heapq.
-00039270: 6865 6170 6966 7928 7265 6369 7069 656e  heapify(recipien
-00039280: 7473 290a 0a20 2020 2020 2020 2077 6869  ts)..        whi
-00039290: 6c65 2073 656e 6465 7273 2061 6e64 2072  le senders and r
-000392a0: 6563 6970 6965 6e74 733a 0a20 2020 2020  ecipients:.     
-000392b0: 2020 2020 2020 2073 6e64 5f62 7974 6573         snd_bytes
-000392c0: 5f6d 6178 2c20 736e 645f 6279 7465 735f  _max, snd_bytes_
-000392d0: 6d69 6e2c 205f 2c20 736e 645f 7773 2c20  min, _, snd_ws, 
-000392e0: 7473 5f69 7465 7220 3d20 7365 6e64 6572  ts_iter = sender
-000392f0: 735b 305d 0a0a 2020 2020 2020 2020 2020  s[0]..          
-00039300: 2020 2320 4974 6572 6174 6520 7468 726f    # Iterate thro
-00039310: 7567 6820 7461 736b 7320 696e 206d 656d  ugh tasks in mem
-00039320: 6f72 792c 206c 6561 7374 2072 6563 656e  ory, least recen
-00039330: 746c 7920 696e 7365 7274 6564 2066 6972  tly inserted fir
-00039340: 7374 0a20 2020 2020 2020 2020 2020 2066  st.            f
-00039350: 6f72 2074 7320 696e 2074 735f 6974 6572  or ts in ts_iter
-00039360: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00039370: 2020 6966 206b 6579 7320 6973 206e 6f74    if keys is not
-00039380: 204e 6f6e 6520 616e 6420 7473 2e6b 6579   None and ts.key
-00039390: 206e 6f74 2069 6e20 6b65 7973 3a0a 2020   not in keys:.  
-000393a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000393b0: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
-000393c0: 2020 2020 2020 2020 2020 206e 6279 7465             nbyte
-000393d0: 7320 3d20 7473 2e6e 6279 7465 730a 2020  s = ts.nbytes.  
-000393e0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000393f0: 206e 6279 7465 7320 2b20 736e 645f 6279   nbytes + snd_by
-00039400: 7465 735f 6d61 7820 3e20 303a 0a20 2020  tes_max > 0:.   
-00039410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039420: 2023 204d 6f76 696e 6720 7468 6973 2074   # Moving this t
-00039430: 6173 6b20 776f 756c 6420 6361 7573 6520  ask would cause 
-00039440: 7468 6520 7365 6e64 6572 2074 6f20 676f  the sender to go
-00039450: 2062 656c 6f77 206d 6561 6e20 616e 640a   below mean and.
-00039460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039470: 2020 2020 2320 706f 7465 6e74 6961 6c6c      # potentiall
-00039480: 7920 7269 736b 2062 6563 6f6d 696e 6720  y risk becoming 
-00039490: 6120 7265 6369 7069 656e 742c 2077 6869  a recipient, whi
-000394a0: 6368 2077 6f75 6c64 2063 6175 7365 2074  ch would cause t
-000394b0: 6173 6b73 2074 6f0a 2020 2020 2020 2020  asks to.        
-000394c0: 2020 2020 2020 2020 2020 2020 2320 626f              # bo
-000394d0: 756e 6365 2061 726f 756e 642e 204d 6f76  unce around. Mov
-000394e0: 6520 6f6e 2074 6f20 7468 6520 6e65 7874  e on to the next
-000394f0: 2074 6173 6b20 6f66 2074 6865 2073 616d   task of the sam
-00039500: 6520 7365 6e64 6572 2e0a 2020 2020 2020  e sender..      
-00039510: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00039520: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
-00039530: 2020 2020 2020 2020 2320 4669 6e64 2074          # Find t
-00039540: 6865 2072 6563 6970 6965 6e74 2c20 6661  he recipient, fa
-00039550: 7274 6865 7374 2066 726f 6d20 7468 6520  rthest from the 
-00039560: 6d65 616e 2c20 7768 6963 680a 2020 2020  mean, which.    
-00039570: 2020 2020 2020 2020 2020 2020 2320 312e              # 1.
-00039580: 2068 6173 2065 6e6f 7567 6820 6176 6169   has enough avai
-00039590: 6c61 626c 6520 5241 4d20 666f 7220 7468  lable RAM for th
-000395a0: 6973 2074 6173 6b2c 2061 6e64 0a20 2020  is task, and.   
-000395b0: 2020 2020 2020 2020 2020 2020 2023 2032               # 2
-000395c0: 2e20 646f 6573 6e27 7420 686f 6c64 2061  . doesn't hold a
-000395d0: 2063 6f70 7920 6f66 2074 6869 7320 7461   copy of this ta
-000395e0: 736b 2061 6c72 6561 6479 0a20 2020 2020  sk already.     
-000395f0: 2020 2020 2020 2020 2020 2023 2054 6865             # The
-00039600: 7265 206d 6179 206e 6f74 2062 6520 616e  re may not be an
-00039610: 7920 7468 6174 2073 6174 6973 6669 6573  y that satisfies
-00039620: 2074 6865 7365 2063 6f6e 6469 7469 6f6e   these condition
-00039630: 733b 2069 6e20 7468 6973 2063 6173 650a  s; in this case.
-00039640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039650: 2320 7468 6973 2074 6173 6b20 776f 6e27  # this task won'
-00039660: 7420 6265 206d 6f76 6564 2e0a 2020 2020  t be moved..    
-00039670: 2020 2020 2020 2020 2020 2020 736b 6970              skip
-00039680: 7065 645f 7265 6369 7069 656e 7473 203d  ped_recipients =
-00039690: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-000396a0: 2020 2020 7573 655f 7265 6369 7069 656e      use_recipien
-000396b0: 7420 3d20 4661 6c73 650a 2020 2020 2020  t = False.      
-000396c0: 2020 2020 2020 2020 2020 7768 696c 6520            while 
-000396d0: 7265 6369 7069 656e 7473 2061 6e64 206e  recipients and n
-000396e0: 6f74 2075 7365 5f72 6563 6970 6965 6e74  ot use_recipient
-000396f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00039700: 2020 2020 2020 7265 635f 6279 7465 735f        rec_bytes_
-00039710: 6d61 782c 2072 6563 5f62 7974 6573 5f6d  max, rec_bytes_m
-00039720: 696e 2c20 5f2c 2072 6563 5f77 7320 3d20  in, _, rec_ws = 
-00039730: 7265 6369 7069 656e 7473 5b30 5d0a 2020  recipients[0].  
-00039740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039750: 2020 6966 206e 6279 7465 7320 2b20 7265    if nbytes + re
-00039760: 635f 6279 7465 735f 6d61 7820 3e20 303a  c_bytes_max > 0:
-00039770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039780: 2020 2020 2020 2020 2023 2072 6563 6970           # recip
-00039790: 6965 6e74 7320 6172 6520 736f 7274 6564  ients are sorted
-000397a0: 2062 7920 7265 635f 6279 7465 735f 6d61   by rec_bytes_ma
-000397b0: 782e 0a20 2020 2020 2020 2020 2020 2020  x..             
-000397c0: 2020 2020 2020 2020 2020 2023 2054 6865             # The
-000397d0: 206e 6578 7420 6f6e 6573 2077 696c 6c20   next ones will 
-000397e0: 6265 2077 6f72 7365 3b20 6e6f 2072 6561  be worse; no rea
-000397f0: 736f 6e20 746f 2063 6f6e 7469 6e75 6520  son to continue 
-00039800: 6974 6572 6174 696e 670a 2020 2020 2020  iterating.      
-00039810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039820: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
-00039830: 2020 2020 2020 2020 2020 2020 7573 655f              use_
-00039840: 7265 6369 7069 656e 7420 3d20 7473 206e  recipient = ts n
-00039850: 6f74 2069 6e20 7265 635f 7773 2e5f 6861  ot in rec_ws._ha
-00039860: 735f 7768 6174 0a20 2020 2020 2020 2020  s_what.         
-00039870: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00039880: 7420 7573 655f 7265 6369 7069 656e 743a  t use_recipient:
-00039890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000398a0: 2020 2020 2020 2020 2073 6b69 7070 6564           skipped
-000398b0: 5f72 6563 6970 6965 6e74 732e 6170 7065  _recipients.appe
-000398c0: 6e64 2868 6561 7071 2e68 6561 7070 6f70  nd(heapq.heappop
-000398d0: 2872 6563 6970 6965 6e74 7329 290a 0a20  (recipients)).. 
-000398e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000398f0: 6f72 2072 6563 6970 6965 6e74 2069 6e20  or recipient in 
-00039900: 736b 6970 7065 645f 7265 6369 7069 656e  skipped_recipien
-00039910: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-00039920: 2020 2020 2020 2020 6865 6170 712e 6865          heapq.he
-00039930: 6170 7075 7368 2872 6563 6970 6965 6e74  appush(recipient
-00039940: 732c 2072 6563 6970 6965 6e74 290a 0a20  s, recipient).. 
-00039950: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00039960: 6620 6e6f 7420 7573 655f 7265 6369 7069  f not use_recipi
-00039970: 656e 743a 0a20 2020 2020 2020 2020 2020  ent:.           
-00039980: 2020 2020 2020 2020 2023 2054 6869 7320           # This 
-00039990: 7461 736b 2068 6173 206e 6f20 7265 6369  task has no reci
-000399a0: 7069 656e 7473 2061 7661 696c 6162 6c65  pients available
-000399b0: 2e20 4c65 6176 6520 6974 206f 6e20 7468  . Leave it on th
-000399c0: 6520 7365 6e64 6572 2061 6e64 0a20 2020  e sender and.   
-000399d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000399e0: 2023 206d 6f76 6520 6f6e 2074 6f20 7468   # move on to th
-000399f0: 6520 6e65 7874 2074 6173 6b20 6f66 2074  e next task of t
-00039a00: 6865 2073 616d 6520 7365 6e64 6572 2e0a  he same sender..
+00034950: 2020 2074 696d 656f 7574 2c0a 2020 2020     timeout,.    
+00034960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034970: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00034980: 2020 2020 2020 666f 7220 6e61 6e6e 7920        for nanny 
+00034990: 696e 206e 616e 6e69 6573 0a20 2020 2020  in nannies.     
+000349a0: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
+000349b0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000349c0: 7475 726e 5f65 7863 6570 7469 6f6e 733d  turn_exceptions=
+000349d0: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+000349e0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+000349f0: 2320 4e4f 5445 3a20 7468 6520 6057 6f72  # NOTE: the `Wor
+00034a00: 6b65 7253 7461 7465 6020 656e 7472 6965  kerState` entrie
+00034a10: 7320 666f 7220 7468 6573 6520 776f 726b  s for these work
+00034a20: 6572 7320 7769 6c6c 2062 6520 7265 6d6f  ers will be remo
+00034a30: 7665 640a 2020 2020 2020 2020 2020 2020  ved.            
+00034a40: 2320 6e61 7475 7261 6c6c 7920 7768 656e  # naturally when
+00034a50: 2074 6865 7920 6469 7363 6f6e 6e65 6374   they disconnect
+00034a60: 2066 726f 6d20 7468 6520 7363 6865 6475   from the schedu
+00034a70: 6c65 722e 0a0a 2020 2020 2020 2020 2020  ler...          
+00034a80: 2020 2320 5265 6d6f 7665 2061 6e79 2077    # Remove any w
+00034a90: 6f72 6b65 7273 2074 6861 7420 6661 696c  orkers that fail
+00034aa0: 6564 2074 6f20 7368 7574 2064 6f77 6e2c  ed to shut down,
+00034ab0: 2073 6f20 7765 2063 616e 2067 7561 7261   so we can guara
+00034ac0: 6e74 6565 0a20 2020 2020 2020 2020 2020  ntee.           
+00034ad0: 2023 2074 6861 7420 6166 7465 7220 6072   # that after `r
+00034ae0: 6573 7461 7274 602c 2074 6865 7265 2061  estart`, there a
+00034af0: 7265 206e 6f20 6f6c 6420 776f 726b 6572  re no old worker
+00034b00: 7320 6172 6f75 6e64 2e0a 2020 2020 2020  s around..      
+00034b10: 2020 2020 2020 6261 645f 6e61 6e6e 6965        bad_nannie
+00034b20: 7320 3d20 5b0a 2020 2020 2020 2020 2020  s = [.          
+00034b30: 2020 2020 2020 6164 6472 2066 6f72 2061        addr for a
+00034b40: 6464 722c 2072 6573 7020 696e 207a 6970  ddr, resp in zip
+00034b50: 286e 616e 6e79 5f77 6f72 6b65 7273 2c20  (nanny_workers, 
+00034b60: 7265 7370 7329 2069 6620 7265 7370 2069  resps) if resp i
+00034b70: 7320 6e6f 7420 4e6f 6e65 0a20 2020 2020  s not None.     
+00034b80: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+00034b90: 2020 2020 2069 6620 6261 645f 6e61 6e6e       if bad_nann
+00034ba0: 6965 733a 0a20 2020 2020 2020 2020 2020  ies:.           
+00034bb0: 2020 2020 2061 7761 6974 2061 7379 6e63       await async
+00034bc0: 696f 2e67 6174 6865 7228 0a20 2020 2020  io.gather(.     
+00034bd0: 2020 2020 2020 2020 2020 2020 2020 202a                 *
+00034be0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00034bf0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
+00034c00: 656d 6f76 655f 776f 726b 6572 2861 6464  emove_worker(add
+00034c10: 722c 2073 7469 6d75 6c75 735f 6964 3d73  r, stimulus_id=s
+00034c20: 7469 6d75 6c75 735f 6964 290a 2020 2020  timulus_id).    
+00034c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034c40: 2020 2020 666f 7220 6164 6472 2069 6e20      for addr in 
+00034c50: 6261 645f 6e61 6e6e 6965 730a 2020 2020  bad_nannies.    
+00034c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034c70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00034c80: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+00034c90: 2020 2020 2072 6169 7365 2054 696d 656f       raise Timeo
+00034ca0: 7574 4572 726f 7228 0a20 2020 2020 2020  utError(.       
+00034cb0: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
+00034cc0: 6c65 6e28 6261 645f 6e61 6e6e 6965 7329  len(bad_nannies)
+00034cd0: 7d2f 7b6c 656e 286e 616e 6e69 6573 297d  }/{len(nannies)}
+00034ce0: 206e 616e 6e79 2077 6f72 6b65 7228 7329   nanny worker(s)
+00034cf0: 2064 6964 206e 6f74 2073 6875 7420 646f   did not shut do
+00034d00: 776e 2077 6974 6869 6e20 7b74 696d 656f  wn within {timeo
+00034d10: 7574 7d73 220a 2020 2020 2020 2020 2020  ut}s".          
+00034d20: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00034d30: 2073 656c 662e 6c6f 675f 6576 656e 7428   self.log_event(
+00034d40: 5b63 6c69 656e 742c 2022 616c 6c22 5d2c  [client, "all"],
+00034d50: 207b 2261 6374 696f 6e22 3a20 2272 6573   {"action": "res
+00034d60: 7461 7274 222c 2022 636c 6965 6e74 223a  tart", "client":
+00034d70: 2063 6c69 656e 747d 290a 0a20 2020 2020   client})..     
+00034d80: 2020 2069 6620 7761 6974 5f66 6f72 5f77     if wait_for_w
+00034d90: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
+00034da0: 2020 2020 7768 696c 6520 6c65 6e28 7365      while len(se
+00034db0: 6c66 2e77 6f72 6b65 7273 2920 3c20 6e5f  lf.workers) < n_
+00034dc0: 776f 726b 6572 733a 0a20 2020 2020 2020  workers:.       
+00034dd0: 2020 2020 2020 2020 2023 204e 4f54 453a           # NOTE:
+00034de0: 2069 6620 6e65 7720 2875 6e72 656c 6174   if new (unrelat
+00034df0: 6564 2920 776f 726b 6572 7320 6a6f 696e  ed) workers join
+00034e00: 2077 6869 6c65 2077 6527 7265 2077 6169   while we're wai
+00034e10: 7469 6e67 2c20 7765 206d 6179 2072 6574  ting, we may ret
+00034e20: 7572 6e20 6265 666f 7265 0a20 2020 2020  urn before.     
+00034e30: 2020 2020 2020 2020 2020 2023 206f 7572             # our
+00034e40: 2073 6875 742d 646f 776e 2077 6f72 6b65   shut-down worke
+00034e50: 7273 2068 6176 6520 636f 6d65 2062 6163  rs have come bac
+00034e60: 6b20 7570 2e20 5468 6174 2773 2066 696e  k up. That's fin
+00034e70: 653b 2077 6f72 6b65 7273 2061 7265 2069  e; workers are i
+00034e80: 6e74 6572 6368 616e 6765 6162 6c65 2e0a  nterchangeable..
+00034e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034ea0: 6966 206d 6f6e 6f74 6f6e 6963 2829 203c  if monotonic() <
+00034eb0: 2073 7461 7274 202b 2074 696d 656f 7574   start + timeout
+00034ec0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00034ed0: 2020 2020 2020 6177 6169 7420 6173 796e        await asyn
+00034ee0: 6369 6f2e 736c 6565 7028 302e 3229 0a20  cio.sleep(0.2). 
+00034ef0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00034f00: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00034f10: 2020 2020 2020 2020 206d 7367 203d 2028           msg = (
+00034f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034f30: 2020 2020 2020 2020 2066 2257 6169 7465           f"Waite
+00034f40: 6420 666f 7220 7b6e 5f77 6f72 6b65 7273  d for {n_workers
+00034f50: 7d20 776f 726b 6572 2873 2920 746f 2072  } worker(s) to r
+00034f60: 6563 6f6e 6e65 6374 2061 6674 6572 2072  econnect after r
+00034f70: 6573 7461 7274 696e 672c 2022 0a20 2020  estarting, ".   
+00034f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034f90: 2020 2020 2066 2262 7574 2061 6674 6572       f"but after
+00034fa0: 207b 7469 6d65 6f75 747d 732c 206f 6e6c   {timeout}s, onl
+00034fb0: 7920 7b6c 656e 2873 656c 662e 776f 726b  y {len(self.work
+00034fc0: 6572 7329 7d20 6861 7665 2072 6574 7572  ers)} have retur
+00034fd0: 6e65 642e 2022 0a20 2020 2020 2020 2020  ned. ".         
+00034fe0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00034ff0: 436f 6e73 6964 6572 2061 206c 6f6e 6765  Consider a longe
+00035000: 7220 7469 6d65 6f75 742c 206f 7220 6077  r timeout, or `w
+00035010: 6169 745f 666f 725f 776f 726b 6572 733d  ait_for_workers=
+00035020: 4661 6c73 6560 2e22 0a20 2020 2020 2020  False`.".       
+00035030: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
+00035040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035050: 2020 2020 6966 2028 6e5f 6e61 6e6e 7920      if (n_nanny 
+00035060: 3a3d 206c 656e 286e 616e 6e79 5f77 6f72  := len(nanny_wor
+00035070: 6b65 7273 2929 203c 206e 5f77 6f72 6b65  kers)) < n_worke
+00035080: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
+00035090: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
+000350a0: 2b3d 2028 0a20 2020 2020 2020 2020 2020  += (.           
+000350b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000350c0: 2066 2220 5468 6520 7b6e 5f77 6f72 6b65   f" The {n_worke
+000350d0: 7273 202d 206e 5f6e 616e 6e79 7d20 776f  rs - n_nanny} wo
+000350e0: 726b 6572 2873 2920 6e6f 7420 7573 696e  rker(s) not usin
+000350f0: 6720 4e61 6e6e 6965 7320 7765 7265 206a  g Nannies were j
+00035100: 7573 7420 7368 7574 2022 0a20 2020 2020  ust shut ".     
+00035110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035120: 2020 2020 2020 2022 646f 776e 2069 6e73         "down ins
+00035130: 7465 6164 206f 6620 7265 7374 6172 7465  tead of restarte
+00035140: 6420 2872 6573 7461 7274 2069 7320 6f6e  d (restart is on
+00035150: 6c79 2070 6f73 7369 626c 6520 7769 7468  ly possible with
+00035160: 204e 616e 6e69 6573 292e 2049 6620 220a   Nannies). If ".
+00035170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035180: 2020 2020 2020 2020 2020 2020 2279 6f75              "you
+00035190: 7220 6465 706c 6f79 6d65 6e74 2073 7973  r deployment sys
+000351a0: 7465 6d20 646f 6573 206e 6f74 2061 7574  tem does not aut
+000351b0: 6f6d 6174 6963 616c 6c79 2072 652d 6c61  omatically re-la
+000351c0: 756e 6368 2074 6572 6d69 6e61 7465 6420  unch terminated 
+000351d0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+000351e0: 2020 2020 2020 2020 2020 2020 2020 2270                "p
+000351f0: 726f 6365 7373 6573 2c20 7468 656e 2074  rocesses, then t
+00035200: 686f 7365 2077 6f72 6b65 7273 2077 696c  hose workers wil
+00035210: 6c20 6e65 7665 7220 636f 6d65 2062 6163  l never come bac
+00035220: 6b2c 2061 6e64 2060 436c 6965 6e74 2e72  k, and `Client.r
+00035230: 6573 7461 7274 6020 220a 2020 2020 2020  estart` ".      
+00035240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035250: 2020 2020 2020 2277 696c 6c20 616c 7761        "will alwa
+00035260: 7973 2074 696d 6520 6f75 742e 2044 6f20  ys time out. Do 
+00035270: 6e6f 7420 7573 6520 6043 6c69 656e 742e  not use `Client.
+00035280: 7265 7374 6172 7460 2069 6e20 7468 6174  restart` in that
+00035290: 2063 6173 652e 220a 2020 2020 2020 2020   case.".        
+000352a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000352b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000352c0: 2020 2020 2020 7261 6973 6520 5469 6d65        raise Time
+000352d0: 6f75 7445 7272 6f72 286d 7367 2920 6672  outError(msg) fr
+000352e0: 6f6d 204e 6f6e 650a 2020 2020 2020 2020  om None.        
+000352f0: 6c6f 6767 6572 2e69 6e66 6f28 2252 6573  logger.info("Res
+00035300: 7461 7274 696e 6720 6669 6e69 7368 6564  tarting finished
+00035310: 2e22 290a 0a20 2020 2061 7379 6e63 2064  .")..    async d
+00035320: 6566 2062 726f 6164 6361 7374 280a 2020  ef broadcast(.  
+00035330: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00035340: 2020 2020 2a2c 0a20 2020 2020 2020 206d      *,.        m
+00035350: 7367 3a20 6469 6374 2c0a 2020 2020 2020  sg: dict,.      
+00035360: 2020 776f 726b 6572 733a 206c 6973 745b    workers: list[
+00035370: 7374 725d 207c 204e 6f6e 6520 3d20 4e6f  str] | None = No
+00035380: 6e65 2c0a 2020 2020 2020 2020 686f 7374  ne,.        host
+00035390: 733a 206c 6973 745b 7374 725d 207c 204e  s: list[str] | N
+000353a0: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+000353b0: 2020 2020 6e61 6e6e 793a 2062 6f6f 6c20      nanny: bool 
+000353c0: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
+000353d0: 2073 6572 6961 6c69 7a65 7273 3a20 416e   serializers: An
+000353e0: 7920 3d20 4e6f 6e65 2c0a 2020 2020 2020  y = None,.      
+000353f0: 2020 6f6e 5f65 7272 6f72 3a20 224c 6974    on_error: "Lit
+00035400: 6572 616c 5b27 7261 6973 6527 2c20 2772  eral['raise', 'r
+00035410: 6574 7572 6e27 2c20 2772 6574 7572 6e5f  eturn', 'return_
+00035420: 7069 636b 6c65 272c 2027 6967 6e6f 7265  pickle', 'ignore
+00035430: 275d 2220 3d20 2272 6169 7365 222c 0a20  ']" = "raise",. 
+00035440: 2020 2029 202d 3e20 6469 6374 3a20 2023     ) -> dict:  #
+00035450: 2064 6963 745b 7374 722c 2041 6e79 5d0a   dict[str, Any].
+00035460: 2020 2020 2020 2020 2222 2242 726f 6164          """Broad
+00035470: 6361 7374 206d 6573 7361 6765 2074 6f20  cast message to 
+00035480: 776f 726b 6572 732c 2072 6574 7572 6e20  workers, return 
+00035490: 616c 6c20 7265 7375 6c74 7322 2222 0a20  all results""". 
+000354a0: 2020 2020 2020 2069 6620 776f 726b 6572         if worker
+000354b0: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+000354c0: 2020 2020 2020 2069 6620 686f 7374 7320         if hosts 
+000354d0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+000354e0: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
+000354f0: 203d 206c 6973 7428 7365 6c66 2e77 6f72   = list(self.wor
+00035500: 6b65 7273 290a 2020 2020 2020 2020 2020  kers).          
+00035510: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00035520: 2020 2020 2020 2020 776f 726b 6572 7320          workers 
+00035530: 3d20 5b5d 0a20 2020 2020 2020 2069 6620  = [].        if 
+00035540: 686f 7374 7320 6973 206e 6f74 204e 6f6e  hosts is not Non
+00035550: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
+00035560: 6f72 2068 6f73 7420 696e 2068 6f73 7473  or host in hosts
+00035570: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00035580: 2020 6468 3a20 6469 6374 203d 2073 656c    dh: dict = sel
+00035590: 662e 686f 7374 5f69 6e66 6f2e 6765 7428  f.host_info.get(
+000355a0: 686f 7374 2920 2023 2074 7970 653a 2069  host)  # type: i
+000355b0: 676e 6f72 650a 2020 2020 2020 2020 2020  gnore.          
+000355c0: 2020 2020 2020 6966 2064 6820 6973 206e        if dh is n
+000355d0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+000355e0: 2020 2020 2020 2020 2020 2020 2077 6f72               wor
+000355f0: 6b65 7273 2e65 7874 656e 6428 6468 5b22  kers.extend(dh["
+00035600: 6164 6472 6573 7365 7322 5d29 0a20 2020  addresses"]).   
+00035610: 2020 2020 2023 2054 4f44 4f20 7265 706c       # TODO repl
+00035620: 6163 6520 7769 7468 2077 6f72 6b65 725f  ace with worker_
+00035630: 6c69 7374 0a0a 2020 2020 2020 2020 6966  list..        if
+00035640: 206e 616e 6e79 3a0a 2020 2020 2020 2020   nanny:.        
+00035650: 2020 2020 6164 6472 6573 7365 7320 3d20      addresses = 
+00035660: 5b73 656c 662e 776f 726b 6572 735b 775d  [self.workers[w]
+00035670: 2e6e 616e 6e79 2066 6f72 2077 2069 6e20  .nanny for w in 
+00035680: 776f 726b 6572 735d 0a20 2020 2020 2020  workers].       
+00035690: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000356a0: 2020 2061 6464 7265 7373 6573 203d 2077     addresses = w
+000356b0: 6f72 6b65 7273 0a0a 2020 2020 2020 2020  orkers..        
+000356c0: 4552 524f 5220 3d20 6f62 6a65 6374 2829  ERROR = object()
+000356d0: 0a0a 2020 2020 2020 2020 6173 796e 6320  ..        async 
+000356e0: 6465 6620 7365 6e64 5f6d 6573 7361 6765  def send_message
+000356f0: 2861 6464 7229 3a0a 2020 2020 2020 2020  (addr):.        
+00035700: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00035710: 2020 2020 2020 2020 2063 6f6d 6d20 3d20           comm = 
+00035720: 6177 6169 7420 7365 6c66 2e72 7063 2e63  await self.rpc.c
+00035730: 6f6e 6e65 6374 2861 6464 7229 0a20 2020  onnect(addr).   
+00035740: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
+00035750: 6d2e 6e61 6d65 203d 2022 5363 6865 6475  m.name = "Schedu
+00035760: 6c65 7220 4272 6f61 6463 6173 7422 0a20  ler Broadcast". 
+00035770: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00035780: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00035790: 2020 2020 2020 2020 7265 7370 203d 2061          resp = a
+000357a0: 7761 6974 2073 656e 645f 7265 6376 280a  wait send_recv(.
+000357b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000357c0: 2020 2020 2020 2020 636f 6d6d 2c20 636c          comm, cl
+000357d0: 6f73 653d 5472 7565 2c20 7365 7269 616c  ose=True, serial
+000357e0: 697a 6572 733d 7365 7269 616c 697a 6572  izers=serializer
+000357f0: 732c 202a 2a6d 7367 0a20 2020 2020 2020  s, **msg.       
+00035800: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00035810: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00035820: 696e 616c 6c79 3a0a 2020 2020 2020 2020  inally:.        
+00035830: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00035840: 2e72 7063 2e72 6575 7365 2861 6464 722c  .rpc.reuse(addr,
+00035850: 2063 6f6d 6d29 0a20 2020 2020 2020 2020   comm).         
+00035860: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+00035870: 7370 0a20 2020 2020 2020 2020 2020 2065  sp.            e
+00035880: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+00035890: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+000358a0: 2020 2020 2020 6c6f 6767 6572 2e65 7272        logger.err
+000358b0: 6f72 2866 2262 726f 6164 6361 7374 2074  or(f"broadcast t
+000358c0: 6f20 7b61 6464 727d 2066 6169 6c65 643a  o {addr} failed:
+000358d0: 207b 652e 5f5f 636c 6173 735f 5f2e 5f5f   {e.__class__.__
+000358e0: 6e61 6d65 5f5f 7d3a 207b 657d 2229 0a20  name__}: {e}"). 
+000358f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00035900: 6620 6f6e 5f65 7272 6f72 203d 3d20 2272  f on_error == "r
+00035910: 6169 7365 223a 0a20 2020 2020 2020 2020  aise":.         
+00035920: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00035930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00035940: 2065 6c69 6620 6f6e 5f65 7272 6f72 203d   elif on_error =
+00035950: 3d20 2272 6574 7572 6e22 3a0a 2020 2020  = "return":.    
+00035960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035970: 7265 7475 726e 2065 0a20 2020 2020 2020  return e.       
+00035980: 2020 2020 2020 2020 2065 6c69 6620 6f6e           elif on
+00035990: 5f65 7272 6f72 203d 3d20 2272 6574 7572  _error == "retur
+000359a0: 6e5f 7069 636b 6c65 223a 0a20 2020 2020  n_pickle":.     
+000359b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000359c0: 6574 7572 6e20 6475 6d70 7328 6529 0a20  eturn dumps(e). 
+000359d0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+000359e0: 6c69 6620 6f6e 5f65 7272 6f72 203d 3d20  lif on_error == 
+000359f0: 2269 676e 6f72 6522 3a0a 2020 2020 2020  "ignore":.      
+00035a00: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00035a10: 7475 726e 2045 5252 4f52 0a20 2020 2020  turn ERROR.     
+00035a20: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00035a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00035a40: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00035a50: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+00035a60: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00035a70: 6f6e 5f65 7272 6f72 206d 7573 7420 6265  on_error must be
+00035a80: 2027 7261 6973 6527 2c20 2772 6574 7572   'raise', 'retur
+00035a90: 6e27 2c20 2772 6574 7572 6e5f 7069 636b  n', 'return_pick
+00035aa0: 6c65 272c 2022 0a20 2020 2020 2020 2020  le', ".         
+00035ab0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00035ac0: 226f 7220 2769 676e 6f72 6527 3b20 676f  "or 'ignore'; go
+00035ad0: 7420 7b6f 6e5f 6572 726f 7221 727d 220a  t {on_error!r}".
+00035ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035af0: 2020 2020 290a 0a20 2020 2020 2020 2072      )..        r
+00035b00: 6573 756c 7473 203d 2061 7761 6974 2041  esults = await A
+00035b10: 6c6c 280a 2020 2020 2020 2020 2020 2020  ll(.            
+00035b20: 5b73 656e 645f 6d65 7373 6167 6528 6164  [send_message(ad
+00035b30: 6472 6573 7329 2066 6f72 2061 6464 7265  dress) for addre
+00035b40: 7373 2069 6e20 6164 6472 6573 7365 7320  ss in addresses 
+00035b50: 6966 2061 6464 7265 7373 2069 7320 6e6f  if address is no
+00035b60: 7420 4e6f 6e65 5d0a 2020 2020 2020 2020  t None].        
+00035b70: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00035b80: 6e20 7b6b 3a20 7620 666f 7220 6b2c 2076  n {k: v for k, v
+00035b90: 2069 6e20 7a69 7028 776f 726b 6572 732c   in zip(workers,
+00035ba0: 2072 6573 756c 7473 2920 6966 2076 2069   results) if v i
+00035bb0: 7320 6e6f 7420 4552 524f 527d 0a0a 2020  s not ERROR}..  
+00035bc0: 2020 6173 796e 6320 6465 6620 7072 6f78    async def prox
+00035bd0: 7928 0a20 2020 2020 2020 2073 656c 662c  y(.        self,
+00035be0: 0a20 2020 2020 2020 206d 7367 3a20 6469  .        msg: di
+00035bf0: 6374 2c0a 2020 2020 2020 2020 776f 726b  ct,.        work
+00035c00: 6572 3a20 7374 722c 0a20 2020 2020 2020  er: str,.       
+00035c10: 2073 6572 6961 6c69 7a65 7273 3a20 416e   serializers: An
+00035c20: 7920 3d20 4e6f 6e65 2c0a 2020 2020 2920  y = None,.    ) 
+00035c30: 2d3e 2041 6e79 3a0a 2020 2020 2020 2020  -> Any:.        
+00035c40: 2222 2250 726f 7879 2061 2063 6f6d 6d75  """Proxy a commu
+00035c50: 6e69 6361 7469 6f6e 2074 6872 6f75 6768  nication through
+00035c60: 2074 6865 2073 6368 6564 756c 6572 2074   the scheduler t
+00035c70: 6f20 736f 6d65 206f 7468 6572 2077 6f72  o some other wor
+00035c80: 6b65 7222 2222 0a20 2020 2020 2020 2064  ker""".        d
+00035c90: 203d 2061 7761 6974 2073 656c 662e 6272   = await self.br
+00035ca0: 6f61 6463 6173 7428 6d73 673d 6d73 672c  oadcast(msg=msg,
+00035cb0: 2077 6f72 6b65 7273 3d5b 776f 726b 6572   workers=[worker
+00035cc0: 5d2c 2073 6572 6961 6c69 7a65 7273 3d73  ], serializers=s
+00035cd0: 6572 6961 6c69 7a65 7273 290a 2020 2020  erializers).    
+00035ce0: 2020 2020 7265 7475 726e 2064 5b77 6f72      return d[wor
+00035cf0: 6b65 725d 0a0a 2020 2020 6173 796e 6320  ker]..    async 
+00035d00: 6465 6620 6761 7468 6572 5f6f 6e5f 776f  def gather_on_wo
+00035d10: 726b 6572 280a 2020 2020 2020 2020 7365  rker(.        se
+00035d20: 6c66 2c20 776f 726b 6572 5f61 6464 7265  lf, worker_addre
+00035d30: 7373 3a20 7374 722c 2077 686f 5f68 6173  ss: str, who_has
+00035d40: 3a20 2264 6963 745b 7374 722c 206c 6973  : "dict[str, lis
+00035d50: 745b 7374 725d 5d22 0a20 2020 2029 202d  t[str]]".    ) -
+00035d60: 3e20 7365 743a 0a20 2020 2020 2020 2022  > set:.        "
+00035d70: 2222 5065 6572 2d74 6f2d 7065 6572 2063  ""Peer-to-peer c
+00035d80: 6f70 7920 6f66 206b 6579 7320 6672 6f6d  opy of keys from
+00035d90: 206d 756c 7469 706c 6520 776f 726b 6572   multiple worker
+00035da0: 7320 746f 2061 2073 696e 676c 6520 776f  s to a single wo
+00035db0: 726b 6572 0a0a 2020 2020 2020 2020 5061  rker..        Pa
+00035dc0: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
+00035dd0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+00035de0: 2020 2020 776f 726b 6572 5f61 6464 7265      worker_addre
+00035df0: 7373 3a20 7374 720a 2020 2020 2020 2020  ss: str.        
+00035e00: 2020 2020 5265 6369 7069 656e 7420 776f      Recipient wo
+00035e10: 726b 6572 2061 6464 7265 7373 2074 6f20  rker address to 
+00035e20: 636f 7079 206b 6579 7320 746f 0a20 2020  copy keys to.   
+00035e30: 2020 2020 2077 686f 5f68 6173 3a20 6469       who_has: di
+00035e40: 6374 5b48 6173 6861 626c 652c 206c 6973  ct[Hashable, lis
+00035e50: 745b 7374 725d 5d0a 2020 2020 2020 2020  t[str]].        
+00035e60: 2020 2020 7b6b 6579 3a20 5b73 656e 6465      {key: [sende
+00035e70: 7220 6164 6472 6573 732c 2073 656e 6465  r address, sende
+00035e80: 7220 6164 6472 6573 732c 202e 2e2e 5d2c  r address, ...],
+00035e90: 206b 6579 3a20 2e2e 2e7d 0a0a 2020 2020   key: ...}..    
+00035ea0: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+00035eb0: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+00035ec0: 2020 2020 7265 7475 726e 733a 0a20 2020      returns:.   
+00035ed0: 2020 2020 2020 2020 2073 6574 206f 6620           set of 
+00035ee0: 6b65 7973 2074 6861 7420 6661 696c 6564  keys that failed
+00035ef0: 2074 6f20 6265 2063 6f70 6965 640a 2020   to be copied.  
+00035f00: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00035f10: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00035f20: 2020 2072 6573 756c 7420 3d20 6177 6169     result = awai
+00035f30: 7420 7265 7472 795f 6f70 6572 6174 696f  t retry_operatio
+00035f40: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+00035f50: 2020 2073 656c 662e 7270 6328 6164 6472     self.rpc(addr
+00035f60: 3d77 6f72 6b65 725f 6164 6472 6573 7329  =worker_address)
+00035f70: 2e67 6174 6865 722c 2077 686f 5f68 6173  .gather, who_has
+00035f80: 3d77 686f 5f68 6173 0a20 2020 2020 2020  =who_has.       
+00035f90: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
+00035fa0: 7863 6570 7420 4f53 4572 726f 7220 6173  xcept OSError as
+00035fb0: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
+00035fc0: 2320 5468 6973 2063 616e 2068 6170 7065  # This can happe
+00035fd0: 6e20 652e 672e 2069 6620 7468 6520 776f  n e.g. if the wo
+00035fe0: 726b 6572 2069 7320 676f 696e 6720 7468  rker is going th
+00035ff0: 726f 7567 6820 636f 6e74 726f 6c6c 6564  rough controlled
+00036000: 2073 6875 7464 6f77 6e3b 0a20 2020 2020   shutdown;.     
+00036010: 2020 2020 2020 2023 2069 7420 646f 6573         # it does
+00036020: 6e27 7420 6e65 6365 7373 6172 696c 7920  n't necessarily 
+00036030: 6d65 616e 2074 6861 7420 6974 2077 656e  mean that it wen
+00036040: 7420 756e 6578 7065 6374 6564 6c79 206d  t unexpectedly m
+00036050: 6973 7369 6e67 0a20 2020 2020 2020 2020  issing.         
+00036060: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
+00036070: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+00036080: 2020 2066 2243 6f6d 6d75 6e69 6361 7469     f"Communicati
+00036090: 6f6e 2077 6974 6820 776f 726b 6572 207b  on with worker {
+000360a0: 776f 726b 6572 5f61 6464 7265 7373 7d20  worker_address} 
+000360b0: 6661 696c 6564 2064 7572 696e 6720 220a  failed during ".
+000360c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000360d0: 6622 7265 706c 6963 6174 696f 6e3a 207b  f"replication: {
+000360e0: 652e 5f5f 636c 6173 735f 5f2e 5f5f 6e61  e.__class__.__na
+000360f0: 6d65 5f5f 7d3a 207b 657d 220a 2020 2020  me__}: {e}".    
+00036100: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00036110: 2020 2020 2020 7265 7475 726e 2073 6574        return set
+00036120: 2877 686f 5f68 6173 290a 0a20 2020 2020  (who_has)..     
+00036130: 2020 2077 7320 3d20 7365 6c66 2e77 6f72     ws = self.wor
+00036140: 6b65 7273 2e67 6574 2877 6f72 6b65 725f  kers.get(worker_
+00036150: 6164 6472 6573 7329 0a0a 2020 2020 2020  address)..      
+00036160: 2020 6966 206e 6f74 2077 733a 0a20 2020    if not ws:.   
+00036170: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+00036180: 7761 726e 696e 6728 6622 576f 726b 6572  warning(f"Worker
+00036190: 207b 776f 726b 6572 5f61 6464 7265 7373   {worker_address
+000361a0: 7d20 6c6f 7374 2064 7572 696e 6720 7265  } lost during re
+000361b0: 706c 6963 6174 696f 6e22 290a 2020 2020  plication").    
+000361c0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+000361d0: 6574 2877 686f 5f68 6173 290a 2020 2020  et(who_has).    
+000361e0: 2020 2020 656c 6966 2072 6573 756c 745b      elif result[
+000361f0: 2273 7461 7475 7322 5d20 3d3d 2022 4f4b  "status"] == "OK
+00036200: 223a 0a20 2020 2020 2020 2020 2020 206b  ":.            k
+00036210: 6579 735f 6661 696c 6564 203d 2073 6574  eys_failed = set
+00036220: 2829 0a20 2020 2020 2020 2020 2020 206b  ().            k
+00036230: 6579 735f 6f6b 3a20 5365 7420 3d20 7768  eys_ok: Set = wh
+00036240: 6f5f 6861 732e 6b65 7973 2829 0a20 2020  o_has.keys().   
+00036250: 2020 2020 2065 6c69 6620 7265 7375 6c74       elif result
+00036260: 5b22 7374 6174 7573 225d 203d 3d20 2270  ["status"] == "p
+00036270: 6172 7469 616c 2d66 6169 6c22 3a0a 2020  artial-fail":.  
+00036280: 2020 2020 2020 2020 2020 6b65 7973 5f66            keys_f
+00036290: 6169 6c65 6420 3d20 7365 7428 7265 7375  ailed = set(resu
+000362a0: 6c74 5b22 6b65 7973 225d 290a 2020 2020  lt["keys"]).    
+000362b0: 2020 2020 2020 2020 6b65 7973 5f6f 6b20          keys_ok 
+000362c0: 3d20 7768 6f5f 6861 732e 6b65 7973 2829  = who_has.keys()
+000362d0: 202d 206b 6579 735f 6661 696c 6564 0a20   - keys_failed. 
+000362e0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+000362f0: 722e 7761 726e 696e 6728 0a20 2020 2020  r.warning(.     
+00036300: 2020 2020 2020 2020 2020 2066 2257 6f72             f"Wor
+00036310: 6b65 7220 7b77 6f72 6b65 725f 6164 6472  ker {worker_addr
+00036320: 6573 737d 2066 6169 6c65 6420 746f 2061  ess} failed to a
+00036330: 6371 7569 7265 206b 6579 733a 207b 7265  cquire keys: {re
+00036340: 7375 6c74 5b27 6b65 7973 275d 7d22 0a20  sult['keys']}". 
+00036350: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00036360: 2020 2020 2065 6c73 653a 2020 2320 7072       else:  # pr
+00036370: 6167 6d61 3a20 6e6f 636f 7665 720a 2020  agma: nocover.  
+00036380: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00036390: 5661 6c75 6545 7272 6f72 2866 2255 6e65  ValueError(f"Une
+000363a0: 7870 6563 7465 6420 6d65 7373 6167 6520  xpected message 
+000363b0: 6672 6f6d 207b 776f 726b 6572 5f61 6464  from {worker_add
+000363c0: 7265 7373 7d3a 207b 7265 7375 6c74 7d22  ress}: {result}"
+000363d0: 290a 0a20 2020 2020 2020 2066 6f72 206b  )..        for k
+000363e0: 6579 2069 6e20 6b65 7973 5f6f 6b3a 0a20  ey in keys_ok:. 
+000363f0: 2020 2020 2020 2020 2020 2074 733a 2054             ts: T
+00036400: 6173 6b53 7461 7465 203d 2073 656c 662e  askState = self.
+00036410: 7461 736b 732e 6765 7428 6b65 7929 2020  tasks.get(key)  
+00036420: 2320 7479 7065 3a20 6967 6e6f 7265 0a20  # type: ignore. 
+00036430: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
+00036440: 2069 7320 4e6f 6e65 206f 7220 7473 2e73   is None or ts.s
+00036450: 7461 7465 2021 3d20 226d 656d 6f72 7922  tate != "memory"
+00036460: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00036470: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
+00036480: 2866 224b 6579 206c 6f73 7420 6475 7269  (f"Key lost duri
+00036490: 6e67 2072 6570 6c69 6361 7469 6f6e 3a20  ng replication: 
+000364a0: 7b6b 6579 7d22 290a 2020 2020 2020 2020  {key}").        
+000364b0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+000364c0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000364d0: 7773 206e 6f74 2069 6e20 7473 2e77 686f  ws not in ts.who
+000364e0: 5f68 6173 3a0a 2020 2020 2020 2020 2020  _has:.          
+000364f0: 2020 2020 2020 7365 6c66 2e61 6464 5f72        self.add_r
+00036500: 6570 6c69 6361 2874 732c 2077 7329 0a0a  eplica(ts, ws)..
+00036510: 2020 2020 2020 2020 7265 7475 726e 206b          return k
+00036520: 6579 735f 6661 696c 6564 0a0a 2020 2020  eys_failed..    
+00036530: 6173 796e 6320 6465 6620 6465 6c65 7465  async def delete
+00036540: 5f77 6f72 6b65 725f 6461 7461 280a 2020  _worker_data(.  
+00036550: 2020 2020 2020 7365 6c66 2c20 776f 726b        self, work
+00036560: 6572 5f61 6464 7265 7373 3a20 7374 722c  er_address: str,
+00036570: 206b 6579 733a 2022 436f 6c6c 6563 7469   keys: "Collecti
+00036580: 6f6e 5b73 7472 5d22 2c20 7374 696d 756c  on[str]", stimul
+00036590: 7573 5f69 643a 2073 7472 0a20 2020 2029  us_id: str.    )
+000365a0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+000365b0: 2020 2222 2244 656c 6574 6520 6461 7461    """Delete data
+000365c0: 2066 726f 6d20 6120 776f 726b 6572 2061   from a worker a
+000365d0: 6e64 2075 7064 6174 6520 7468 6520 636f  nd update the co
+000365e0: 7272 6573 706f 6e64 696e 6720 776f 726b  rresponding work
+000365f0: 6572 2f74 6173 6b20 7374 6174 6573 0a0a  er/task states..
+00036600: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
+00036610: 7273 0a20 2020 2020 2020 202d 2d2d 2d2d  rs.        -----
+00036620: 2d2d 2d2d 2d0a 2020 2020 2020 2020 776f  -----.        wo
+00036630: 726b 6572 5f61 6464 7265 7373 3a20 7374  rker_address: st
+00036640: 720a 2020 2020 2020 2020 2020 2020 576f  r.            Wo
+00036650: 726b 6572 2061 6464 7265 7373 2074 6f20  rker address to 
+00036660: 6465 6c65 7465 206b 6579 7320 6672 6f6d  delete keys from
+00036670: 0a20 2020 2020 2020 206b 6579 733a 206c  .        keys: l
+00036680: 6973 745b 7374 725d 0a20 2020 2020 2020  ist[str].       
+00036690: 2020 2020 204c 6973 7420 6f66 206b 6579       List of key
+000366a0: 7320 746f 2064 656c 6574 6520 6f6e 2074  s to delete on t
+000366b0: 6865 2073 7065 6369 6669 6564 2077 6f72  he specified wor
+000366c0: 6b65 720a 2020 2020 2020 2020 2222 220a  ker.        """.
+000366d0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+000366e0: 2020 2020 2020 2020 2061 7761 6974 2072           await r
+000366f0: 6574 7279 5f6f 7065 7261 7469 6f6e 280a  etry_operation(.
+00036700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036710: 7365 6c66 2e72 7063 2861 6464 723d 776f  self.rpc(addr=wo
+00036720: 726b 6572 5f61 6464 7265 7373 292e 6672  rker_address).fr
+00036730: 6565 5f6b 6579 732c 0a20 2020 2020 2020  ee_keys,.       
+00036740: 2020 2020 2020 2020 206b 6579 733d 6c69           keys=li
+00036750: 7374 286b 6579 7329 2c0a 2020 2020 2020  st(keys),.      
+00036760: 2020 2020 2020 2020 2020 7374 696d 756c            stimul
+00036770: 7573 5f69 643d 6622 6465 6c65 7465 2d64  us_id=f"delete-d
+00036780: 6174 612d 7b74 696d 6528 297d 222c 0a20  ata-{time()}",. 
+00036790: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+000367a0: 2020 2020 2065 7863 6570 7420 4f53 4572       except OSEr
+000367b0: 726f 7220 6173 2065 3a0a 2020 2020 2020  ror as e:.      
+000367c0: 2020 2020 2020 2320 5468 6973 2063 616e        # This can
+000367d0: 2068 6170 7065 6e20 652e 672e 2069 6620   happen e.g. if 
+000367e0: 7468 6520 776f 726b 6572 2069 7320 676f  the worker is go
+000367f0: 696e 6720 7468 726f 7567 6820 636f 6e74  ing through cont
+00036800: 726f 6c6c 6564 2073 6875 7464 6f77 6e3b  rolled shutdown;
+00036810: 0a20 2020 2020 2020 2020 2020 2023 2069  .            # i
+00036820: 7420 646f 6573 6e27 7420 6e65 6365 7373  t doesn't necess
+00036830: 6172 696c 7920 6d65 616e 2074 6861 7420  arily mean that 
+00036840: 6974 2077 656e 7420 756e 6578 7065 6374  it went unexpect
+00036850: 6564 6c79 206d 6973 7369 6e67 0a20 2020  edly missing.   
+00036860: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+00036870: 7761 726e 696e 6728 0a20 2020 2020 2020  warning(.       
+00036880: 2020 2020 2020 2020 2066 2243 6f6d 6d75           f"Commu
+00036890: 6e69 6361 7469 6f6e 2077 6974 6820 776f  nication with wo
+000368a0: 726b 6572 207b 776f 726b 6572 5f61 6464  rker {worker_add
+000368b0: 7265 7373 7d20 6661 696c 6564 2064 7572  ress} failed dur
+000368c0: 696e 6720 220a 2020 2020 2020 2020 2020  ing ".          
+000368d0: 2020 2020 2020 6622 7265 706c 6963 6174        f"replicat
+000368e0: 696f 6e3a 207b 652e 5f5f 636c 6173 735f  ion: {e.__class_
+000368f0: 5f2e 5f5f 6e61 6d65 5f5f 7d3a 207b 657d  _.__name__}: {e}
+00036900: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+00036910: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00036920: 726e 0a0a 2020 2020 2020 2020 7773 203d  rn..        ws =
+00036930: 2073 656c 662e 776f 726b 6572 732e 6765   self.workers.ge
+00036940: 7428 776f 726b 6572 5f61 6464 7265 7373  t(worker_address
+00036950: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+00036960: 2077 733a 0a20 2020 2020 2020 2020 2020   ws:.           
+00036970: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
+00036980: 2066 6f72 206b 6579 2069 6e20 6b65 7973   for key in keys
+00036990: 3a0a 2020 2020 2020 2020 2020 2020 7473  :.            ts
+000369a0: 3a20 5461 736b 5374 6174 6520 3d20 7365  : TaskState = se
+000369b0: 6c66 2e74 6173 6b73 2e67 6574 286b 6579  lf.tasks.get(key
+000369c0: 2920 2023 2074 7970 653a 2069 676e 6f72  )  # type: ignor
+000369d0: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
+000369e0: 2074 7320 6973 206e 6f74 204e 6f6e 6520   ts is not None 
+000369f0: 616e 6420 7773 2069 6e20 7473 2e77 686f  and ws in ts.who
+00036a00: 5f68 6173 3a0a 2020 2020 2020 2020 2020  _has:.          
+00036a10: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
+00036a20: 7374 6174 6520 3d3d 2022 6d65 6d6f 7279  state == "memory
+00036a30: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00036a40: 2020 7365 6c66 2e72 656d 6f76 655f 7265    self.remove_re
+00036a50: 706c 6963 6128 7473 2c20 7773 290a 2020  plica(ts, ws).  
+00036a60: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00036a70: 206e 6f74 2074 732e 7768 6f5f 6861 733a   not ts.who_has:
+00036a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00036a90: 2020 2020 2023 204c 6173 7420 636f 7079       # Last copy
+00036aa0: 2064 656c 6574 6564 0a20 2020 2020 2020   deleted.       
+00036ab0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00036ac0: 662e 7472 616e 7369 7469 6f6e 7328 7b6b  f.transitions({k
+00036ad0: 6579 3a20 2272 656c 6561 7365 6422 7d2c  ey: "released"},
+00036ae0: 2073 7469 6d75 6c75 735f 6964 290a 0a20   stimulus_id).. 
+00036af0: 2020 2020 2020 2073 656c 662e 6c6f 675f         self.log_
+00036b00: 6576 656e 7428 7773 2e61 6464 7265 7373  event(ws.address
+00036b10: 2c20 7b22 6163 7469 6f6e 223a 2022 7265  , {"action": "re
+00036b20: 6d6f 7665 2d77 6f72 6b65 722d 6461 7461  move-worker-data
+00036b30: 222c 2022 6b65 7973 223a 206b 6579 737d  ", "keys": keys}
+00036b40: 290a 0a20 2020 2040 6c6f 675f 6572 726f  )..    @log_erro
+00036b50: 7273 0a20 2020 2061 7379 6e63 2064 6566  rs.    async def
+00036b60: 2072 6562 616c 616e 6365 280a 2020 2020   rebalance(.    
+00036b70: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00036b80: 2020 6b65 7973 3a20 4974 6572 6162 6c65    keys: Iterable
+00036b90: 5b73 7472 5d20 7c20 4e6f 6e65 203d 204e  [str] | None = N
+00036ba0: 6f6e 652c 0a20 2020 2020 2020 2077 6f72  one,.        wor
+00036bb0: 6b65 7273 3a20 4974 6572 6162 6c65 5b73  kers: Iterable[s
+00036bc0: 7472 5d20 7c20 4e6f 6e65 203d 204e 6f6e  tr] | None = Non
+00036bd0: 652c 0a20 2020 2020 2020 2073 7469 6d75  e,.        stimu
+00036be0: 6c75 735f 6964 3a20 7374 7220 7c20 4e6f  lus_id: str | No
+00036bf0: 6e65 203d 204e 6f6e 652c 0a20 2020 2029  ne = None,.    )
+00036c00: 202d 3e20 6469 6374 3a0a 2020 2020 2020   -> dict:.      
+00036c10: 2020 2222 2252 6562 616c 616e 6365 206b    """Rebalance k
+00036c20: 6579 7320 736f 2074 6861 7420 6561 6368  eys so that each
+00036c30: 2077 6f72 6b65 7220 656e 6473 2075 7020   worker ends up 
+00036c40: 7769 7468 2072 6f75 6768 6c79 2074 6865  with roughly the
+00036c50: 2073 616d 6520 7072 6f63 6573 730a 2020   same process.  
+00036c60: 2020 2020 2020 6d65 6d6f 7279 2028 6d61        memory (ma
+00036c70: 6e61 6765 642b 756e 6d61 6e61 6765 6429  naged+unmanaged)
+00036c80: 2e0a 0a20 2020 2020 2020 202e 2e20 7761  ...        .. wa
+00036c90: 726e 696e 673a 3a0a 2020 2020 2020 2020  rning::.        
+00036ca0: 2020 2054 6869 7320 6f70 6572 6174 696f     This operatio
+00036cb0: 6e20 6973 2067 656e 6572 616c 6c79 206e  n is generally n
+00036cc0: 6f74 2077 656c 6c20 7465 7374 6564 2061  ot well tested a
+00036cd0: 6761 696e 7374 206e 6f72 6d61 6c20 6f70  gainst normal op
+00036ce0: 6572 6174 696f 6e20 6f66 2074 6865 0a20  eration of the. 
+00036cf0: 2020 2020 2020 2020 2020 7363 6865 6475            schedu
+00036d00: 6c65 722e 2049 7420 6973 206e 6f74 2072  ler. It is not r
+00036d10: 6563 6f6d 6d65 6e64 6564 2074 6f20 7573  ecommended to us
+00036d20: 6520 6974 2077 6869 6c65 2077 6169 7469  e it while waiti
+00036d30: 6e67 206f 6e20 636f 6d70 7574 6174 696f  ng on computatio
+00036d40: 6e73 2e0a 0a20 2020 2020 2020 202a 2a41  ns...        **A
+00036d50: 6c67 6f72 6974 686d 2a2a 0a0a 2020 2020  lgorithm**..    
+00036d60: 2020 2020 232e 2046 696e 6420 7468 6520      #. Find the 
+00036d70: 6d65 616e 206f 6363 7570 616e 6379 206f  mean occupancy o
+00036d80: 6620 7468 6520 636c 7573 7465 722c 2064  f the cluster, d
+00036d90: 6566 696e 6564 2061 7320 6461 7461 206d  efined as data m
+00036da0: 616e 6167 6564 2062 7920 6461 736b 202b  anaged by dask +
+00036db0: 0a20 2020 2020 2020 2020 2020 756e 6d61  .           unma
+00036dc0: 6e61 6765 6420 7072 6f63 6573 7320 6d65  naged process me
+00036dd0: 6d6f 7279 2074 6861 7420 6861 7320 6265  mory that has be
+00036de0: 656e 2074 6865 7265 2066 6f72 2061 7420  en there for at 
+00036df0: 6c65 6173 7420 3330 2073 6563 6f6e 6473  least 30 seconds
+00036e00: 0a20 2020 2020 2020 2020 2020 2860 6064  .           (``d
+00036e10: 6973 7472 6962 7574 6564 2e77 6f72 6b65  istributed.worke
+00036e20: 722e 6d65 6d6f 7279 2e72 6563 656e 742d  r.memory.recent-
+00036e30: 746f 2d6f 6c64 2d74 696d 6560 6029 2e0a  to-old-time``)..
+00036e40: 2020 2020 2020 2020 2020 2054 6869 7320             This 
+00036e50: 6c65 7473 2075 7320 6967 6e6f 7265 2074  lets us ignore t
+00036e60: 656d 706f 7261 7279 2073 7069 6b65 7320  emporary spikes 
+00036e70: 6361 7573 6564 2062 7920 7461 736b 2068  caused by task h
+00036e80: 6561 7020 7573 6167 652e 0a0a 2020 2020  eap usage...    
+00036e90: 2020 2020 2020 2041 6c74 6572 6e61 7469         Alternati
+00036ea0: 7665 6c79 2c20 796f 7520 6d61 7920 6368  vely, you may ch
+00036eb0: 616e 6765 2068 6f77 206d 656d 6f72 7920  ange how memory 
+00036ec0: 6973 206d 6561 7375 7265 6420 626f 7468  is measured both
+00036ed0: 2066 6f72 2074 6865 2069 6e64 6976 6964   for the individ
+00036ee0: 7561 6c0a 2020 2020 2020 2020 2020 2077  ual.           w
+00036ef0: 6f72 6b65 7273 2061 7320 7765 6c6c 2061  orkers as well a
+00036f00: 7320 746f 2063 616c 6375 6c61 7465 2074  s to calculate t
+00036f10: 6865 206d 6561 6e20 7468 726f 7567 680a  he mean through.
+00036f20: 2020 2020 2020 2020 2020 2060 6064 6973             ``dis
+00036f30: 7472 6962 7574 6564 2e77 6f72 6b65 722e  tributed.worker.
+00036f40: 6d65 6d6f 7279 2e72 6562 616c 616e 6365  memory.rebalance
+00036f50: 2e6d 6561 7375 7265 6060 2e20 4e61 6d65  .measure``. Name
+00036f60: 6c79 2c20 7468 6973 2063 616e 2062 6520  ly, this can be 
+00036f70: 7573 6566 756c 0a20 2020 2020 2020 2020  useful.         
+00036f80: 2020 746f 2064 6973 7265 6761 7264 2069    to disregard i
+00036f90: 6e61 6363 7572 6174 6520 4f53 206d 656d  naccurate OS mem
+00036fa0: 6f72 7920 6d65 6173 7572 656d 656e 7473  ory measurements
+00036fb0: 2e0a 0a20 2020 2020 2020 2023 2e20 4469  ...        #. Di
+00036fc0: 7363 6172 6420 776f 726b 6572 7320 7768  scard workers wh
+00036fd0: 6f73 6520 6f63 6375 7061 6e63 7920 6973  ose occupancy is
+00036fe0: 2077 6974 6869 6e20 3525 206f 6620 7468   within 5% of th
+00036ff0: 6520 6d65 616e 2063 6c75 7374 6572 206f  e mean cluster o
+00037000: 6363 7570 616e 6379 0a20 2020 2020 2020  ccupancy.       
+00037010: 2020 2020 2860 6064 6973 7472 6962 7574      (``distribut
+00037020: 6564 2e77 6f72 6b65 722e 6d65 6d6f 7279  ed.worker.memory
+00037030: 2e72 6562 616c 616e 6365 2e73 656e 6465  .rebalance.sende
+00037040: 722d 7265 6369 7069 656e 742d 6761 7060  r-recipient-gap`
+00037050: 6020 2f20 3229 2e0a 2020 2020 2020 2020  ` / 2)..        
+00037060: 2020 2054 6869 7320 6865 6c70 7320 6176     This helps av
+00037070: 6f69 6420 6461 7461 2066 726f 6d20 626f  oid data from bo
+00037080: 756e 6369 6e67 2061 726f 756e 6420 7468  uncing around th
+00037090: 6520 636c 7573 7465 7220 7265 7065 6174  e cluster repeat
+000370a0: 6564 6c79 2e0a 2020 2020 2020 2020 232e  edly..        #.
+000370b0: 2057 6f72 6b65 7273 2061 626f 7665 2074   Workers above t
+000370c0: 6865 206d 6561 6e20 6172 6520 7365 6e64  he mean are send
+000370d0: 6572 733b 2074 686f 7365 2062 656c 6f77  ers; those below
+000370e0: 2061 7265 2072 6563 6970 6965 6e74 732e   are recipients.
+000370f0: 0a20 2020 2020 2020 2023 2e20 4469 7363  .        #. Disc
+00037100: 6172 6420 7365 6e64 6572 7320 7768 6f73  ard senders whos
+00037110: 6520 6162 736f 6c75 7465 206f 6363 7570  e absolute occup
+00037120: 616e 6379 2069 7320 6265 6c6f 7720 3330  ancy is below 30
+00037130: 250a 2020 2020 2020 2020 2020 2028 6060  %.           (``
+00037140: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
+00037150: 6572 2e6d 656d 6f72 792e 7265 6261 6c61  er.memory.rebala
+00037160: 6e63 652e 7365 6e64 6572 2d6d 696e 6060  nce.sender-min``
+00037170: 292e 2049 6e20 6f74 6865 7220 776f 7264  ). In other word
+00037180: 732c 206e 6f20 6461 7461 0a20 2020 2020  s, no data.     
+00037190: 2020 2020 2020 6973 206d 6f76 6564 2072        is moved r
+000371a0: 6567 6172 646c 6573 7320 6f66 2069 6d62  egardless of imb
+000371b0: 616c 616e 6369 6e67 2061 7320 6c6f 6e67  alancing as long
+000371c0: 2061 7320 616c 6c20 776f 726b 6572 7320   as all workers 
+000371d0: 6172 6520 6265 6c6f 7720 3330 252e 0a20  are below 30%.. 
+000371e0: 2020 2020 2020 2023 2e20 4469 7363 6172         #. Discar
+000371f0: 6420 7265 6369 7069 656e 7473 2077 686f  d recipients who
+00037200: 7365 2061 6273 6f6c 7574 6520 6f63 6375  se absolute occu
+00037210: 7061 6e63 7920 6973 2061 626f 7665 2036  pancy is above 6
+00037220: 3025 0a20 2020 2020 2020 2020 2020 2860  0%.           (`
+00037230: 6064 6973 7472 6962 7574 6564 2e77 6f72  `distributed.wor
+00037240: 6b65 722e 6d65 6d6f 7279 2e72 6562 616c  ker.memory.rebal
+00037250: 616e 6365 2e72 6563 6970 6965 6e74 2d6d  ance.recipient-m
+00037260: 6178 6060 292e 0a20 2020 2020 2020 2020  ax``)..         
+00037270: 2020 4e6f 7465 2074 6861 7420 7468 6973    Note that this
+00037280: 2074 6872 6573 686f 6c64 2062 7920 6465   threshold by de
+00037290: 6661 756c 7420 6973 2074 6865 2073 616d  fault is the sam
+000372a0: 6520 6173 0a20 2020 2020 2020 2020 2020  e as.           
+000372b0: 6060 6469 7374 7269 6275 7465 642e 776f  ``distributed.wo
+000372c0: 726b 6572 2e6d 656d 6f72 792e 7461 7267  rker.memory.targ
+000372d0: 6574 6060 2074 6f20 7072 6576 656e 7420  et`` to prevent 
+000372e0: 776f 726b 6572 7320 6672 6f6d 2061 6363  workers from acc
+000372f0: 6570 7469 6e67 2064 6174 610a 2020 2020  epting data.    
+00037300: 2020 2020 2020 2061 6e64 2069 6d6d 6564         and immed
+00037310: 6961 7465 6c79 2073 7069 6c6c 696e 6720  iately spilling 
+00037320: 6974 206f 7574 2074 6f20 6469 736b 2e0a  it out to disk..
+00037330: 2020 2020 2020 2020 232e 2049 7465 7261          #. Itera
+00037340: 7469 7665 6c79 2070 6963 6b20 7468 6520  tively pick the 
+00037350: 7365 6e64 6572 2061 6e64 2072 6563 6970  sender and recip
+00037360: 6965 6e74 2074 6861 7420 6172 6520 6661  ient that are fa
+00037370: 7274 6865 7374 2066 726f 6d20 7468 6520  rthest from the 
+00037380: 6d65 616e 2061 6e64 0a20 2020 2020 2020  mean and.       
+00037390: 2020 2020 6d6f 7665 2074 6865 202a 6c65      move the *le
+000373a0: 6173 7420 7265 6365 6e74 6c79 2069 6e73  ast recently ins
+000373b0: 6572 7465 642a 206b 6579 2062 6574 7765  erted* key betwe
+000373c0: 656e 2074 6865 2074 776f 2c20 756e 7469  en the two, unti
+000373d0: 6c20 6569 7468 6572 2061 6c6c 0a20 2020  l either all.   
+000373e0: 2020 2020 2020 2020 7365 6e64 6572 7320          senders 
+000373f0: 6f72 2061 6c6c 2072 6563 6970 6965 6e74  or all recipient
+00037400: 7320 6661 6c6c 2077 6974 6869 6e20 3525  s fall within 5%
+00037410: 206f 6620 7468 6520 6d65 616e 2e0a 0a20   of the mean... 
+00037420: 2020 2020 2020 2020 2020 4120 7265 6369            A reci
+00037430: 7069 656e 7420 7769 6c6c 2062 6520 736b  pient will be sk
+00037440: 6970 7065 6420 6966 2069 7420 616c 7265  ipped if it alre
+00037450: 6164 7920 6861 7320 6120 636f 7079 206f  ady has a copy o
+00037460: 6620 7468 6520 6461 7461 2e20 496e 206f  f the data. In o
+00037470: 7468 6572 0a20 2020 2020 2020 2020 2020  ther.           
+00037480: 776f 7264 732c 2074 6869 7320 6d65 7468  words, this meth
+00037490: 6f64 2064 6f65 7320 6e6f 7420 6465 6772  od does not degr
+000374a0: 6164 6520 7265 706c 6963 6174 696f 6e2e  ade replication.
+000374b0: 0a20 2020 2020 2020 2020 2020 4120 6b65  .           A ke
+000374c0: 7920 7769 6c6c 2062 6520 736b 6970 7065  y will be skippe
+000374d0: 6420 6966 2074 6865 7265 2061 7265 206e  d if there are n
+000374e0: 6f20 7265 6369 7069 656e 7473 2061 7661  o recipients ava
+000374f0: 696c 6162 6c65 2077 6974 6820 656e 6f75  ilable with enou
+00037500: 6768 206d 656d 6f72 790a 2020 2020 2020  gh memory.      
+00037510: 2020 2020 2074 6f20 6163 6365 7074 2074       to accept t
+00037520: 6865 206b 6579 2061 6e64 2074 6861 7420  he key and that 
+00037530: 646f 6e27 7420 616c 7265 6164 7920 686f  don't already ho
+00037540: 6c64 2061 2063 6f70 792e 0a0a 2020 2020  ld a copy...    
+00037550: 2020 2020 5468 6520 6c65 6173 7420 7265      The least re
+00037560: 6365 6e74 6c79 2069 6e73 6572 7464 2028  cently insertd (
+00037570: 4c52 4929 2070 6f6c 6963 7920 6973 2061  LRI) policy is a
+00037580: 2067 7265 6564 7920 6368 6f69 6365 2077   greedy choice w
+00037590: 6974 6820 7468 6520 6164 7661 6e74 6167  ith the advantag
+000375a0: 6520 6f66 0a20 2020 2020 2020 2062 6569  e of.        bei
+000375b0: 6e67 204f 2831 292c 2074 7269 7669 616c  ng O(1), trivial
+000375c0: 2074 6f20 696d 706c 656d 656e 7420 2869   to implement (i
+000375d0: 7420 7265 6c69 6573 206f 6e20 7079 7468  t relies on pyth
+000375e0: 6f6e 2064 6963 7420 696e 7365 7274 696f  on dict insertio
+000375f0: 6e2d 736f 7274 696e 6729 0a20 2020 2020  n-sorting).     
+00037600: 2020 2061 6e64 2068 6f70 6566 756c 6c79     and hopefully
+00037610: 2067 6f6f 6420 656e 6f75 6768 2069 6e20   good enough in 
+00037620: 6d6f 7374 2063 6173 6573 2e20 4469 7363  most cases. Disc
+00037630: 6172 6465 6420 616c 7465 726e 6174 6976  arded alternativ
+00037640: 6520 706f 6c69 6369 6573 2077 6572 653a  e policies were:
+00037650: 0a0a 2020 2020 2020 2020 2d20 4c61 7267  ..        - Larg
+00037660: 6573 7420 6669 7273 742e 204f 286e 2a6c  est first. O(n*l
+00037670: 6f67 286e 2929 2073 6176 6520 666f 7220  og(n)) save for 
+00037680: 6e6f 6e2d 7472 6976 6961 6c20 6164 6469  non-trivial addi
+00037690: 7469 6f6e 616c 2064 6174 6120 7374 7275  tional data stru
+000376a0: 6374 7572 6573 2061 6e64 0a20 2020 2020  ctures and.     
+000376b0: 2020 2020 2072 6973 6b73 2063 6175 7369       risks causi
+000376c0: 6e67 2074 6865 206c 6172 6765 7374 2063  ng the largest c
+000376d0: 6875 6e6b 7320 6f66 2064 6174 6120 746f  hunks of data to
+000376e0: 2072 6570 6561 7465 646c 7920 6d6f 7665   repeatedly move
+000376f0: 2061 726f 756e 6420 7468 650a 2020 2020   around the.    
+00037700: 2020 2020 2020 636c 7573 7465 7220 6c69        cluster li
+00037710: 6b65 2070 696e 6261 6c6c 732e 0a20 2020  ke pinballs..   
+00037720: 2020 2020 202d 204c 6561 7374 2072 6563       - Least rec
+00037730: 656e 746c 7920 7573 6564 2028 4c52 5529  ently used (LRU)
+00037740: 2e20 5468 6973 2069 6e66 6f72 6d61 7469  . This informati
+00037750: 6f6e 2069 7320 6375 7272 656e 746c 7920  on is currently 
+00037760: 6176 6169 6c61 626c 6520 6f6e 2074 6865  available on the
+00037770: 0a20 2020 2020 2020 2020 2077 6f72 6b65  .          worke
+00037780: 7273 206f 6e6c 7920 616e 6420 6e6f 7420  rs only and not 
+00037790: 7472 6976 6961 6c20 746f 2072 6570 6c69  trivial to repli
+000377a0: 6361 7465 206f 6e20 7468 6520 7363 6865  cate on the sche
+000377b0: 6475 6c65 723b 2074 7261 6e73 6d69 7474  duler; transmitt
+000377c0: 696e 6720 6974 0a20 2020 2020 2020 2020  ing it.         
+000377d0: 206f 7665 7220 7468 6520 6e65 7477 6f72   over the networ
+000377e0: 6b20 776f 756c 6420 6265 2076 6572 7920  k would be very 
+000377f0: 6578 7065 6e73 6976 652e 2041 6c73 6f2c  expensive. Also,
+00037800: 206e 6f74 6520 7468 6174 2064 6173 6b20   note that dask 
+00037810: 7769 6c6c 2067 6f20 6f75 7420 6f66 0a20  will go out of. 
+00037820: 2020 2020 2020 2020 2069 7473 2077 6179           its way
+00037830: 2074 6f20 6d69 6e69 6d69 7365 2074 6865   to minimise the
+00037840: 2061 6d6f 756e 7420 6f66 2074 696d 6520   amount of time 
+00037850: 696e 7465 726d 6564 6961 7465 206b 6579  intermediate key
+00037860: 7320 6172 6520 6865 6c64 2069 6e20 6d65  s are held in me
+00037870: 6d6f 7279 2c0a 2020 2020 2020 2020 2020  mory,.          
+00037880: 736f 2069 6e20 7375 6368 2061 2063 6173  so in such a cas
+00037890: 6520 4c52 4920 6973 2061 2063 6c6f 7365  e LRI is a close
+000378a0: 2061 7070 726f 7869 6d61 7469 6f6e 206f   approximation o
+000378b0: 6620 4c52 552e 0a0a 2020 2020 2020 2020  f LRU...        
+000378c0: 5061 7261 6d65 7465 7273 0a20 2020 2020  Parameters.     
+000378d0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
+000378e0: 2020 2020 2020 6b65 7973 3a20 6f70 7469        keys: opti
+000378f0: 6f6e 616c 0a20 2020 2020 2020 2020 2020  onal.           
+00037900: 2061 6c6c 6f77 6c69 7374 206f 6620 6461   allowlist of da
+00037910: 736b 206b 6579 7320 7468 6174 2073 686f  sk keys that sho
+00037920: 756c 6420 6265 2063 6f6e 7369 6465 7265  uld be considere
+00037930: 6420 666f 7220 6d6f 7669 6e67 2e20 416c  d for moving. Al
+00037940: 6c20 6f74 6865 7220 6b65 7973 0a20 2020  l other keys.   
+00037950: 2020 2020 2020 2020 2077 696c 6c20 6265           will be
+00037960: 2069 676e 6f72 6564 2e20 4e6f 7465 2074   ignored. Note t
+00037970: 6861 7420 7468 6973 206f 6666 6572 7320  hat this offers 
+00037980: 6e6f 2067 7561 7261 6e74 6565 2074 6861  no guarantee tha
+00037990: 7420 6120 6b65 7920 7769 6c6c 2061 6374  t a key will act
+000379a0: 7561 6c6c 790a 2020 2020 2020 2020 2020  ually.          
+000379b0: 2020 6265 206d 6f76 6564 2028 652e 672e    be moved (e.g.
+000379c0: 2062 6563 6175 7365 2069 7420 6973 2075   because it is u
+000379d0: 6e6e 6563 6573 7361 7279 206f 7220 6265  nnecessary or be
+000379e0: 6361 7573 6520 7468 6572 6520 6172 6520  cause there are 
+000379f0: 6e6f 2076 6961 626c 650a 2020 2020 2020  no viable.      
+00037a00: 2020 2020 2020 7265 6369 7069 656e 7420        recipient 
+00037a10: 776f 726b 6572 7320 666f 7220 6974 292e  workers for it).
+00037a20: 0a20 2020 2020 2020 2077 6f72 6b65 7273  .        workers
+00037a30: 3a20 6f70 7469 6f6e 616c 0a20 2020 2020  : optional.     
+00037a40: 2020 2020 2020 2061 6c6c 6f77 6c69 7374         allowlist
+00037a50: 206f 6620 776f 726b 6572 7320 6164 6472   of workers addr
+00037a60: 6573 7365 7320 746f 2062 6520 636f 6e73  esses to be cons
+00037a70: 6964 6572 6564 2061 7320 7365 6e64 6572  idered as sender
+00037a80: 7320 6f72 2072 6563 6970 6965 6e74 732e  s or recipients.
+00037a90: 0a20 2020 2020 2020 2020 2020 2041 6c6c  .            All
+00037aa0: 206f 7468 6572 2077 6f72 6b65 7273 2077   other workers w
+00037ab0: 696c 6c20 6265 2069 676e 6f72 6564 2e20  ill be ignored. 
+00037ac0: 5468 6520 6d65 616e 2063 6c75 7374 6572  The mean cluster
+00037ad0: 206f 6363 7570 616e 6379 2077 696c 6c20   occupancy will 
+00037ae0: 6265 0a20 2020 2020 2020 2020 2020 2063  be.            c
+00037af0: 616c 6375 6c61 7465 6420 6f6e 6c79 2075  alculated only u
+00037b00: 7369 6e67 2074 6865 2061 6c6c 6f77 6564  sing the allowed
+00037b10: 2077 6f72 6b65 7273 2e0a 2020 2020 2020   workers..      
+00037b20: 2020 2222 220a 2020 2020 2020 2020 7374    """.        st
+00037b30: 696d 756c 7573 5f69 6420 3d20 7374 696d  imulus_id = stim
+00037b40: 756c 7573 5f69 6420 6f72 2066 2272 6562  ulus_id or f"reb
+00037b50: 616c 616e 6365 2d7b 7469 6d65 2829 7d22  alance-{time()}"
+00037b60: 0a0a 2020 2020 2020 2020 7773 733a 2043  ..        wss: C
+00037b70: 6f6c 6c65 6374 696f 6e5b 576f 726b 6572  ollection[Worker
+00037b80: 5374 6174 655d 0a20 2020 2020 2020 2069  State].        i
+00037b90: 6620 776f 726b 6572 7320 6973 206e 6f74  f workers is not
+00037ba0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00037bb0: 2020 2077 7373 203d 205b 7365 6c66 2e77     wss = [self.w
+00037bc0: 6f72 6b65 7273 5b77 5d20 666f 7220 7720  orkers[w] for w 
+00037bd0: 696e 2077 6f72 6b65 7273 5d0a 2020 2020  in workers].    
+00037be0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00037bf0: 2020 2020 2020 7773 7320 3d20 7365 6c66        wss = self
+00037c00: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
+00037c10: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+00037c20: 2077 7373 3a0a 2020 2020 2020 2020 2020   wss:.          
+00037c30: 2020 7265 7475 726e 207b 2273 7461 7475    return {"statu
+00037c40: 7322 3a20 224f 4b22 7d0a 0a20 2020 2020  s": "OK"}..     
+00037c50: 2020 2069 6620 6b65 7973 2069 7320 6e6f     if keys is no
+00037c60: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00037c70: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
+00037c80: 7461 6e63 6528 6b65 7973 2c20 5365 7429  tance(keys, Set)
+00037c90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00037ca0: 2020 6b65 7973 203d 2073 6574 286b 6579    keys = set(key
+00037cb0: 7329 2020 2320 756e 6c65 7373 2061 6c72  s)  # unless alr
+00037cc0: 6561 6479 2061 2073 6574 2d6c 696b 650a  eady a set-like.
+00037cd0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00037ce0: 6f74 206b 6579 733a 0a20 2020 2020 2020  ot keys:.       
+00037cf0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00037d00: 7b22 7374 6174 7573 223a 2022 4f4b 227d  {"status": "OK"}
+00037d10: 0a20 2020 2020 2020 2020 2020 206d 6973  .            mis
+00037d20: 7369 6e67 5f64 6174 6120 3d20 5b0a 2020  sing_data = [.  
+00037d30: 2020 2020 2020 2020 2020 2020 2020 6b20                k 
+00037d40: 666f 7220 6b20 696e 206b 6579 7320 6966  for k in keys if
+00037d50: 206b 206e 6f74 2069 6e20 7365 6c66 2e74   k not in self.t
+00037d60: 6173 6b73 206f 7220 6e6f 7420 7365 6c66  asks or not self
+00037d70: 2e74 6173 6b73 5b6b 5d2e 7768 6f5f 6861  .tasks[k].who_ha
+00037d80: 730a 2020 2020 2020 2020 2020 2020 5d0a  s.            ].
+00037d90: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+00037da0: 6973 7369 6e67 5f64 6174 613a 0a20 2020  issing_data:.   
+00037db0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00037dc0: 7572 6e20 7b22 7374 6174 7573 223a 2022  urn {"status": "
+00037dd0: 7061 7274 6961 6c2d 6661 696c 222c 2022  partial-fail", "
+00037de0: 6b65 7973 223a 206d 6973 7369 6e67 5f64  keys": missing_d
+00037df0: 6174 617d 0a0a 2020 2020 2020 2020 6d73  ata}..        ms
+00037e00: 6773 203d 2073 656c 662e 5f72 6562 616c  gs = self._rebal
+00037e10: 616e 6365 5f66 696e 645f 6d73 6773 286b  ance_find_msgs(k
+00037e20: 6579 732c 2077 7373 290a 2020 2020 2020  eys, wss).      
+00037e30: 2020 6966 206e 6f74 206d 7367 733a 0a20    if not msgs:. 
+00037e40: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00037e50: 6e20 7b22 7374 6174 7573 223a 2022 4f4b  n {"status": "OK
+00037e60: 227d 0a0a 2020 2020 2020 2020 6173 796e  "}..        asyn
+00037e70: 6320 7769 7468 2073 656c 662e 5f6c 6f63  c with self._loc
+00037e80: 6b3a 0a20 2020 2020 2020 2020 2020 2072  k:.            r
+00037e90: 6573 756c 7420 3d20 6177 6169 7420 7365  esult = await se
+00037ea0: 6c66 2e5f 7265 6261 6c61 6e63 655f 6d6f  lf._rebalance_mo
+00037eb0: 7665 5f64 6174 6128 6d73 6773 2c20 7374  ve_data(msgs, st
+00037ec0: 696d 756c 7573 5f69 6429 0a20 2020 2020  imulus_id).     
+00037ed0: 2020 2020 2020 2069 6620 7265 7375 6c74         if result
+00037ee0: 5b22 7374 6174 7573 225d 203d 3d20 2270  ["status"] == "p
+00037ef0: 6172 7469 616c 2d66 6169 6c22 2061 6e64  artial-fail" and
+00037f00: 206b 6579 7320 6973 204e 6f6e 653a 0a20   keys is None:. 
+00037f10: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00037f20: 204f 6e6c 7920 7265 7475 726e 2066 6169   Only return fai
+00037f30: 6c65 6420 6b65 7973 2069 6620 7468 6520  led keys if the 
+00037f40: 636c 6965 6e74 2065 7870 6c69 6369 746c  client explicitl
+00037f50: 7920 6173 6b65 6420 666f 7220 7468 656d  y asked for them
+00037f60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00037f70: 2072 6573 756c 7420 3d20 7b22 7374 6174   result = {"stat
+00037f80: 7573 223a 2022 4f4b 227d 0a20 2020 2020  us": "OK"}.     
+00037f90: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+00037fa0: 7375 6c74 0a0a 2020 2020 6465 6620 5f72  sult..    def _r
+00037fb0: 6562 616c 616e 6365 5f66 696e 645f 6d73  ebalance_find_ms
+00037fc0: 6773 280a 2020 2020 2020 2020 7365 6c66  gs(.        self
+00037fd0: 2c0a 2020 2020 2020 2020 6b65 7973 3a20  ,.        keys: 
+00037fe0: 5365 745b 4861 7368 6162 6c65 5d20 7c20  Set[Hashable] | 
+00037ff0: 4e6f 6e65 2c0a 2020 2020 2020 2020 776f  None,.        wo
+00038000: 726b 6572 733a 2049 7465 7261 626c 655b  rkers: Iterable[
+00038010: 576f 726b 6572 5374 6174 655d 2c0a 2020  WorkerState],.  
+00038020: 2020 2920 2d3e 206c 6973 745b 7475 706c    ) -> list[tupl
+00038030: 655b 576f 726b 6572 5374 6174 652c 2057  e[WorkerState, W
+00038040: 6f72 6b65 7253 7461 7465 2c20 5461 736b  orkerState, Task
+00038050: 5374 6174 655d 5d3a 0a20 2020 2020 2020  State]]:.       
+00038060: 2022 2222 4964 656e 7469 6679 2077 6f72   """Identify wor
+00038070: 6b65 7273 2074 6861 7420 6e65 6564 2074  kers that need t
+00038080: 6f20 6c6f 7365 206b 6579 7320 616e 6420  o lose keys and 
+00038090: 7468 6f73 6520 7468 6174 2063 616e 2072  those that can r
+000380a0: 6563 6569 7665 2074 6865 6d2c 0a20 2020  eceive them,.   
+000380b0: 2020 2020 2074 6f67 6574 6865 7220 7769       together wi
+000380c0: 7468 2068 6f77 206d 616e 7920 6279 7465  th how many byte
+000380d0: 7320 6561 6368 206e 6565 6473 2074 6f20  s each needs to 
+000380e0: 6c6f 7365 2f72 6563 6569 7665 2e20 5468  lose/receive. Th
+000380f0: 656e 2c20 7061 6972 2061 2073 656e 6465  en, pair a sende
+00038100: 720a 2020 2020 2020 2020 776f 726b 6572  r.        worker
+00038110: 2077 6974 6820 6120 7265 6369 7069 656e   with a recipien
+00038120: 7420 776f 726b 6572 2066 6f72 2065 6163  t worker for eac
+00038130: 6820 6b65 792c 2075 6e74 696c 2074 6865  h key, until the
+00038140: 2063 6c75 7374 6572 2069 7320 7265 6261   cluster is reba
+00038150: 6c61 6e63 6564 2e0a 0a20 2020 2020 2020  lanced...       
+00038160: 2054 6869 7320 6d65 7468 6f64 206f 6e6c   This method onl
+00038170: 7920 6465 6669 6e65 7320 7468 6520 776f  y defines the wo
+00038180: 726b 2074 6f20 6265 2070 6572 666f 726d  rk to be perform
+00038190: 6564 3b20 6974 2064 6f65 7320 6e6f 7420  ed; it does not 
+000381a0: 7374 6172 7420 616e 7920 6e65 7477 6f72  start any networ
+000381b0: 6b0a 2020 2020 2020 2020 7472 616e 7366  k.        transf
+000381c0: 6572 7320 6974 7365 6c66 2e0a 0a20 2020  ers itself...   
+000381d0: 2020 2020 2054 6865 2062 6967 2d4f 2063       The big-O c
+000381e0: 6f6d 706c 6578 6974 7920 6973 204f 2877  omplexity is O(w
+000381f0: 7420 2b20 6b65 2a6c 6f67 2877 6529 292c  t + ke*log(we)),
+00038200: 2077 6865 7265 0a0a 2020 2020 2020 2020   where..        
+00038210: 2d20 7774 2069 7320 7468 6520 746f 7461  - wt is the tota
+00038220: 6c20 6e75 6d62 6572 206f 6620 776f 726b  l number of work
+00038230: 6572 7320 6f6e 2074 6865 2063 6c75 7374  ers on the clust
+00038240: 6572 2028 6f72 2074 6865 206e 756d 6265  er (or the numbe
+00038250: 7220 6f66 2061 6c6c 6f77 6564 0a20 2020  r of allowed.   
+00038260: 2020 2020 2020 2077 6f72 6b65 7273 2c20         workers, 
+00038270: 6966 2065 7870 6c69 6369 746c 7920 7374  if explicitly st
+00038280: 6174 6564 2062 7920 7468 6520 7573 6572  ated by the user
+00038290: 290a 2020 2020 2020 2020 2d20 7765 2069  ).        - we i
+000382a0: 7320 7468 6520 6e75 6d62 6572 206f 6620  s the number of 
+000382b0: 776f 726b 6572 7320 7468 6174 2061 7265  workers that are
+000382c0: 2065 6c69 6769 626c 6520 746f 2062 6520   eligible to be 
+000382d0: 7365 6e64 6572 7320 6f72 2072 6563 6970  senders or recip
+000382e0: 6965 6e74 730a 2020 2020 2020 2020 2d20  ients.        - 
+000382f0: 6b74 2069 7320 7468 6520 746f 7461 6c20  kt is the total 
+00038300: 6e75 6d62 6572 206f 6620 6b65 7973 206f  number of keys o
+00038310: 6e20 7468 6520 636c 7573 7465 7220 286f  n the cluster (o
+00038320: 7220 6f6e 2074 6865 2061 6c6c 6f77 6564  r on the allowed
+00038330: 2077 6f72 6b65 7273 290a 2020 2020 2020   workers).      
+00038340: 2020 2d20 6b65 2069 7320 7468 6520 6e75    - ke is the nu
+00038350: 6d62 6572 206f 6620 6b65 7973 2074 6861  mber of keys tha
+00038360: 7420 6e65 6564 2074 6f20 6265 206d 6f76  t need to be mov
+00038370: 6564 2069 6e20 6f72 6465 7220 746f 2061  ed in order to a
+00038380: 6368 6965 7665 2061 2062 616c 616e 6365  chieve a balance
+00038390: 640a 2020 2020 2020 2020 2020 636c 7573  d.          clus
+000383a0: 7465 720a 0a20 2020 2020 2020 2054 6865  ter..        The
+000383b0: 7265 2069 7320 6120 6465 6765 6e65 7261  re is a degenera
+000383c0: 7465 2065 6467 6520 6361 7365 204f 2877  te edge case O(w
+000383d0: 7420 2b20 6b74 2a6c 6f67 2877 6529 2920  t + kt*log(we)) 
+000383e0: 7768 656e 206b 7420 6973 206d 7563 6820  when kt is much 
+000383f0: 6772 6561 7465 7220 7468 616e 0a20 2020  greater than.   
+00038400: 2020 2020 2074 6865 206e 756d 6265 7220       the number 
+00038410: 6f66 2061 6c6c 6f77 6564 206b 6579 732c  of allowed keys,
+00038420: 206f 7220 7768 656e 206d 6f73 7420 6b65   or when most ke
+00038430: 7973 2061 7265 2072 6570 6c69 6361 7465  ys are replicate
+00038440: 6420 6f72 2063 616e 6e6f 7420 6265 0a20  d or cannot be. 
+00038450: 2020 2020 2020 206d 6f76 6564 2066 6f72         moved for
+00038460: 2073 6f6d 6520 6f74 6865 7220 7265 6173   some other reas
+00038470: 6f6e 2e0a 0a20 2020 2020 2020 2052 6574  on...        Ret
+00038480: 7572 6e73 206c 6973 7420 6f66 2074 7570  urns list of tup
+00038490: 6c65 7320 746f 2066 6565 6420 696e 746f  les to feed into
+000384a0: 205f 7265 6261 6c61 6e63 655f 6d6f 7665   _rebalance_move
+000384b0: 5f64 6174 613a 0a0a 2020 2020 2020 2020  _data:..        
+000384c0: 2d20 7365 6e64 6572 2077 6f72 6b65 720a  - sender worker.
+000384d0: 2020 2020 2020 2020 2d20 7265 6369 7069          - recipi
+000384e0: 656e 7420 776f 726b 6572 0a20 2020 2020  ent worker.     
+000384f0: 2020 202d 2074 6173 6b20 746f 2062 6520     - task to be 
+00038500: 7472 616e 7366 6572 7265 640a 2020 2020  transferred.    
+00038510: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00038520: 2320 4865 6170 7320 6f66 2077 6f72 6b65  # Heaps of worke
+00038530: 7273 2c20 6d61 6e61 6765 6420 6279 2074  rs, managed by t
+00038540: 6865 2068 6561 7071 206d 6f64 756c 652c  he heapq module,
+00038550: 2074 6861 7420 6e65 6564 2074 6f20 7365   that need to se
+00038560: 6e64 2f72 6563 6569 7665 2064 6174 612c  nd/receive data,
+00038570: 0a20 2020 2020 2020 2023 2077 6974 6820  .        # with 
+00038580: 686f 7720 6d61 6e79 2062 7974 6573 2065  how many bytes e
+00038590: 6163 6820 6e65 6564 7320 746f 2073 656e  ach needs to sen
+000385a0: 642f 7265 6365 6976 652e 0a20 2020 2020  d/receive..     
+000385b0: 2020 2023 0a20 2020 2020 2020 2023 2045     #.        # E
+000385c0: 6163 6820 656c 656d 656e 7420 6f66 2074  ach element of t
+000385d0: 6865 2068 6561 7020 6973 2061 2074 7570  he heap is a tup
+000385e0: 6c65 2063 6f6e 7374 7275 6374 6564 2061  le constructed a
+000385f0: 7320 666f 6c6c 6f77 733a 0a20 2020 2020  s follows:.     
+00038600: 2020 2023 202d 2073 6e64 5f62 7974 6573     # - snd_bytes
+00038610: 5f6d 6178 2f72 6563 5f62 7974 6573 5f6d  _max/rec_bytes_m
+00038620: 6178 3a20 6d61 7869 6d75 6d20 6e75 6d62  ax: maximum numb
+00038630: 6572 206f 6620 6279 7465 7320 746f 2073  er of bytes to s
+00038640: 656e 6420 6f72 2072 6563 6569 7665 2e0a  end or receive..
+00038650: 2020 2020 2020 2020 2320 2020 5468 6973          #   This
+00038660: 206e 756d 6265 7220 6973 206e 6567 6174   number is negat
+00038670: 6976 652c 2073 6f20 7468 6174 2074 6865  ive, so that the
+00038680: 2077 6f72 6b65 7273 2066 6172 7468 6573   workers farthes
+00038690: 7420 6672 6f6d 2074 6865 2063 6c75 7374  t from the clust
+000386a0: 6572 206d 6561 6e0a 2020 2020 2020 2020  er mean.        
+000386b0: 2320 2020 6172 6520 6174 2074 6865 2074  #   are at the t
+000386c0: 6f70 206f 6620 7468 6520 736d 616c 6c65  op of the smalle
+000386d0: 7374 2d66 6972 7374 2068 6561 7073 2e0a  st-first heaps..
+000386e0: 2020 2020 2020 2020 2320 2d20 736e 645f          # - snd_
+000386f0: 6279 7465 735f 6d69 6e2f 7265 635f 6279  bytes_min/rec_by
+00038700: 7465 735f 6d69 6e3a 206d 696e 696d 756d  tes_min: minimum
+00038710: 206e 756d 6265 7220 6f66 2062 7974 6573   number of bytes
+00038720: 2061 6674 6572 2073 656e 6469 6e67 2f72   after sending/r
+00038730: 6563 6569 7669 6e67 0a20 2020 2020 2020  eceiving.       
+00038740: 2023 2020 2077 6869 6368 2074 6865 2077   #   which the w
+00038750: 6f72 6b65 7220 7368 6f75 6c64 206e 6f74  orker should not
+00038760: 2062 6520 636f 6e73 6964 6572 6564 2061   be considered a
+00038770: 6e79 6d6f 7265 2e20 5468 6973 2069 7320  nymore. This is 
+00038780: 616c 736f 206e 6567 6174 6976 652e 0a20  also negative.. 
+00038790: 2020 2020 2020 2023 202d 2061 7262 6974         # - arbit
+000387a0: 7261 7279 2075 6e69 7175 6520 6e75 6d62  rary unique numb
+000387b0: 6572 2c20 7468 6572 6520 6a75 7374 2074  er, there just t
+000387c0: 6f20 746f 206d 616b 6520 7375 7265 2074  o to make sure t
+000387d0: 6861 7420 576f 726b 6572 5374 6174 6520  hat WorkerState 
+000387e0: 6f62 6a65 6374 730a 2020 2020 2020 2020  objects.        
+000387f0: 2320 2020 6172 6520 6e65 7665 7220 7573  #   are never us
+00038800: 6564 2066 6f72 2073 6f72 7469 6e67 2069  ed for sorting i
+00038810: 6e20 7468 6520 756e 6c69 6b65 6c79 2065  n the unlikely e
+00038820: 7665 6e74 2074 6861 7420 7477 6f20 7072  vent that two pr
+00038830: 6f63 6573 7365 7320 6861 7665 0a20 2020  ocesses have.   
+00038840: 2020 2020 2023 2020 2065 7861 6374 6c79       #   exactly
+00038850: 2074 6865 2073 616d 6520 6e75 6d62 6572   the same number
+00038860: 206f 6620 6279 7465 7320 616c 6c6f 6361   of bytes alloca
+00038870: 7465 642e 0a20 2020 2020 2020 2023 202d  ted..        # -
+00038880: 2057 6f72 6b65 7253 7461 7465 0a20 2020   WorkerState.   
+00038890: 2020 2020 2023 202d 2069 7465 7261 746f       # - iterato
+000388a0: 7220 6f66 2061 6c6c 2074 6173 6b73 2069  r of all tasks i
+000388b0: 6e20 6d65 6d6f 7279 206f 6e20 7468 6520  n memory on the 
+000388c0: 776f 726b 6572 2028 7365 6e64 6572 7320  worker (senders 
+000388d0: 6f6e 6c79 292c 2069 6e73 6572 7469 6f6e  only), insertion
+000388e0: 0a20 2020 2020 2020 2023 2020 2073 6f72  .        #   sor
+000388f0: 7465 6420 286c 6561 7374 2072 6563 656e  ted (least recen
+00038900: 746c 7920 696e 7365 7274 6564 2066 6972  tly inserted fir
+00038910: 7374 292e 0a20 2020 2020 2020 2023 2020  st)..        #  
+00038920: 204e 6f74 6520 7468 6174 2074 6869 7320   Note that this 
+00038930: 6974 6572 6174 6f72 2077 696c 6c20 7479  iterator will ty
+00038940: 7069 6361 6c6c 7920 2a6e 6f74 2a20 6265  pically *not* be
+00038950: 2065 7868 6175 7374 6564 2e20 4974 2077   exhausted. It w
+00038960: 696c 6c20 6f6e 6c79 2062 650a 2020 2020  ill only be.    
+00038970: 2020 2020 2320 2020 6578 6861 7573 7465      #   exhauste
+00038980: 6420 6966 2c20 6166 7465 7220 6d6f 7669  d if, after movi
+00038990: 6e67 2061 7761 7920 6672 6f6d 2074 6865  ng away from the
+000389a0: 2077 6f72 6b65 7220 616c 6c20 6b65 7973   worker all keys
+000389b0: 2074 6861 7420 6361 6e20 6265 206d 6f76   that can be mov
+000389c0: 6564 2c0a 2020 2020 2020 2020 2320 2020  ed,.        #   
+000389d0: 6973 2069 6e73 7566 6669 6369 656e 7420  is insufficient 
+000389e0: 746f 2064 726f 7020 736e 645f 6279 7465  to drop snd_byte
+000389f0: 735f 6d69 6e20 6162 6f76 6520 302e 0a20  s_min above 0.. 
+00038a00: 2020 2020 2020 2073 656e 6465 7273 3a20         senders: 
+00038a10: 6c69 7374 5b74 7570 6c65 5b69 6e74 2c20  list[tuple[int, 
+00038a20: 696e 742c 2069 6e74 2c20 576f 726b 6572  int, int, Worker
+00038a30: 5374 6174 652c 2049 7465 7261 746f 725b  State, Iterator[
+00038a40: 5461 736b 5374 6174 655d 5d5d 203d 205b  TaskState]]] = [
+00038a50: 5d0a 2020 2020 2020 2020 7265 6369 7069  ].        recipi
+00038a60: 656e 7473 3a20 6c69 7374 5b74 7570 6c65  ents: list[tuple
+00038a70: 5b69 6e74 2c20 696e 742c 2069 6e74 2c20  [int, int, int, 
+00038a80: 576f 726b 6572 5374 6174 655d 5d20 3d20  WorkerState]] = 
+00038a90: 5b5d 0a0a 2020 2020 2020 2020 2320 4f75  []..        # Ou
+00038aa0: 7470 7574 3a20 5b28 7365 6e64 6572 2c20  tput: [(sender, 
+00038ab0: 7265 6369 7069 656e 742c 2074 6173 6b29  recipient, task)
+00038ac0: 2c20 2e2e 2e5d 0a20 2020 2020 2020 206d  , ...].        m
+00038ad0: 7367 733a 206c 6973 745b 7475 706c 655b  sgs: list[tuple[
+00038ae0: 576f 726b 6572 5374 6174 652c 2057 6f72  WorkerState, Wor
+00038af0: 6b65 7253 7461 7465 2c20 5461 736b 5374  kerState, TaskSt
+00038b00: 6174 655d 5d20 3d20 5b5d 0a0a 2020 2020  ate]] = []..    
+00038b10: 2020 2020 2320 4279 2064 6566 6175 6c74      # By default
+00038b20: 2c20 7468 6973 2069 7320 7468 6520 6f70  , this is the op
+00038b30: 7469 6d69 7374 6963 206d 656d 6f72 792c  timistic memory,
+00038b40: 206d 6561 6e69 6e67 2074 6f74 616c 2070   meaning total p
+00038b50: 726f 6365 7373 206d 656d 6f72 7920 6d69  rocess memory mi
+00038b60: 6e75 730a 2020 2020 2020 2020 2320 756e  nus.        # un
+00038b70: 6d61 6e61 6765 6420 6d65 6d6f 7279 2074  managed memory t
+00038b80: 6861 7420 6170 7065 6172 6564 206f 7665  hat appeared ove
+00038b90: 7220 7468 6520 6c61 7374 2033 3020 7365  r the last 30 se
+00038ba0: 636f 6e64 730a 2020 2020 2020 2020 2320  conds.        # 
+00038bb0: 2864 6973 7472 6962 7574 6564 2e77 6f72  (distributed.wor
+00038bc0: 6b65 722e 6d65 6d6f 7279 2e72 6563 656e  ker.memory.recen
+00038bd0: 742d 746f 2d6f 6c64 2d74 696d 6529 2e0a  t-to-old-time)..
+00038be0: 2020 2020 2020 2020 2320 5468 6973 206c          # This l
+00038bf0: 6574 7320 7573 2069 676e 6f72 6520 7465  ets us ignore te
+00038c00: 6d70 6f72 6172 7920 7370 696b 6573 2063  mporary spikes c
+00038c10: 6175 7365 6420 6279 2074 6173 6b20 6865  aused by task he
+00038c20: 6170 2075 7361 6765 2e0a 2020 2020 2020  ap usage..      
+00038c30: 2020 6d65 6d6f 7279 5f62 795f 776f 726b    memory_by_work
+00038c40: 6572 203d 205b 0a20 2020 2020 2020 2020  er = [.         
+00038c50: 2020 2028 7773 2c20 6765 7461 7474 7228     (ws, getattr(
+00038c60: 7773 2e6d 656d 6f72 792c 2073 656c 662e  ws.memory, self.
+00038c70: 4d45 4d4f 5259 5f52 4542 414c 414e 4345  MEMORY_REBALANCE
+00038c80: 5f4d 4541 5355 5245 2929 2066 6f72 2077  _MEASURE)) for w
+00038c90: 7320 696e 2077 6f72 6b65 7273 0a20 2020  s in workers.   
+00038ca0: 2020 2020 205d 0a20 2020 2020 2020 206d       ].        m
+00038cb0: 6561 6e5f 6d65 6d6f 7279 203d 2073 756d  ean_memory = sum
+00038cc0: 286d 2066 6f72 205f 2c20 6d20 696e 206d  (m for _, m in m
+00038cd0: 656d 6f72 795f 6279 5f77 6f72 6b65 7229  emory_by_worker)
+00038ce0: 202f 2f20 6c65 6e28 6d65 6d6f 7279 5f62   // len(memory_b
+00038cf0: 795f 776f 726b 6572 290a 0a20 2020 2020  y_worker)..     
+00038d00: 2020 2066 6f72 2077 732c 2077 735f 6d65     for ws, ws_me
+00038d10: 6d6f 7279 2069 6e20 6d65 6d6f 7279 5f62  mory in memory_b
+00038d20: 795f 776f 726b 6572 3a0a 2020 2020 2020  y_worker:.      
+00038d30: 2020 2020 2020 6966 2077 732e 6d65 6d6f        if ws.memo
+00038d40: 7279 5f6c 696d 6974 3a0a 2020 2020 2020  ry_limit:.      
+00038d50: 2020 2020 2020 2020 2020 6861 6c66 5f67            half_g
+00038d60: 6170 203d 2069 6e74 2873 656c 662e 4d45  ap = int(self.ME
+00038d70: 4d4f 5259 5f52 4542 414c 414e 4345 5f48  MORY_REBALANCE_H
+00038d80: 414c 465f 4741 5020 2a20 7773 2e6d 656d  ALF_GAP * ws.mem
+00038d90: 6f72 795f 6c69 6d69 7429 0a20 2020 2020  ory_limit).     
+00038da0: 2020 2020 2020 2020 2020 2073 656e 6465             sende
+00038db0: 725f 6d69 6e20 3d20 7365 6c66 2e4d 454d  r_min = self.MEM
+00038dc0: 4f52 595f 5245 4241 4c41 4e43 455f 5345  ORY_REBALANCE_SE
+00038dd0: 4e44 4552 5f4d 494e 202a 2077 732e 6d65  NDER_MIN * ws.me
+00038de0: 6d6f 7279 5f6c 696d 6974 0a20 2020 2020  mory_limit.     
+00038df0: 2020 2020 2020 2020 2020 2072 6563 6970             recip
+00038e00: 6965 6e74 5f6d 6178 203d 2073 656c 662e  ient_max = self.
+00038e10: 4d45 4d4f 5259 5f52 4542 414c 414e 4345  MEMORY_REBALANCE
+00038e20: 5f52 4543 4950 4945 4e54 5f4d 4158 202a  _RECIPIENT_MAX *
+00038e30: 2077 732e 6d65 6d6f 7279 5f6c 696d 6974   ws.memory_limit
+00038e40: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00038e50: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00038e60: 2020 2068 616c 665f 6761 7020 3d20 300a     half_gap = 0.
+00038e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038e80: 7365 6e64 6572 5f6d 696e 203d 2030 2e30  sender_min = 0.0
+00038e90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038ea0: 2072 6563 6970 6965 6e74 5f6d 6178 203d   recipient_max =
+00038eb0: 206d 6174 682e 696e 660a 0a20 2020 2020   math.inf..     
+00038ec0: 2020 2020 2020 2069 6620 280a 2020 2020         if (.    
+00038ed0: 2020 2020 2020 2020 2020 2020 7773 2e5f              ws._
+00038ee0: 6861 735f 7768 6174 0a20 2020 2020 2020  has_what.       
+00038ef0: 2020 2020 2020 2020 2061 6e64 2077 735f           and ws_
+00038f00: 6d65 6d6f 7279 203e 3d20 6d65 616e 5f6d  memory >= mean_m
+00038f10: 656d 6f72 7920 2b20 6861 6c66 5f67 6170  emory + half_gap
+00038f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038f30: 2061 6e64 2077 735f 6d65 6d6f 7279 203e   and ws_memory >
+00038f40: 3d20 7365 6e64 6572 5f6d 696e 0a20 2020  = sender_min.   
+00038f50: 2020 2020 2020 2020 2029 3a0a 2020 2020           ):.    
+00038f60: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
+00038f70: 6973 206d 6179 2073 656e 6420 7468 6520  is may send the 
+00038f80: 776f 726b 6572 2062 656c 6f77 2073 656e  worker below sen
+00038f90: 6465 725f 6d69 6e20 2862 7920 6465 7369  der_min (by desi
+00038fa0: 676e 290a 2020 2020 2020 2020 2020 2020  gn).            
+00038fb0: 2020 2020 736e 645f 6279 7465 735f 6d61      snd_bytes_ma
+00038fc0: 7820 3d20 6d65 616e 5f6d 656d 6f72 7920  x = mean_memory 
+00038fd0: 2d20 7773 5f6d 656d 6f72 7920 2023 206e  - ws_memory  # n
+00038fe0: 6567 6174 6976 650a 2020 2020 2020 2020  egative.        
+00038ff0: 2020 2020 2020 2020 736e 645f 6279 7465          snd_byte
+00039000: 735f 6d69 6e20 3d20 736e 645f 6279 7465  s_min = snd_byte
+00039010: 735f 6d61 7820 2b20 6861 6c66 5f67 6170  s_max + half_gap
+00039020: 2020 2320 6e65 6761 7469 7665 0a20 2020    # negative.   
+00039030: 2020 2020 2020 2020 2020 2020 2023 2053               # S
+00039040: 6565 2064 6566 696e 6974 696f 6e20 6f66  ee definition of
+00039050: 2073 656e 6465 7273 2061 626f 7665 0a20   senders above. 
+00039060: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00039070: 656e 6465 7273 2e61 7070 656e 6428 0a20  enders.append(. 
+00039080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039090: 2020 2028 736e 645f 6279 7465 735f 6d61     (snd_bytes_ma
+000390a0: 782c 2073 6e64 5f62 7974 6573 5f6d 696e  x, snd_bytes_min
+000390b0: 2c20 6964 2877 7329 2c20 7773 2c20 6974  , id(ws), ws, it
+000390c0: 6572 2877 732e 5f68 6173 5f77 6861 7429  er(ws._has_what)
+000390d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000390e0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+000390f0: 656c 6966 2077 735f 6d65 6d6f 7279 203c  elif ws_memory <
+00039100: 206d 6561 6e5f 6d65 6d6f 7279 202d 2068   mean_memory - h
+00039110: 616c 665f 6761 7020 616e 6420 7773 5f6d  alf_gap and ws_m
+00039120: 656d 6f72 7920 3c20 7265 6369 7069 656e  emory < recipien
+00039130: 745f 6d61 783a 0a20 2020 2020 2020 2020  t_max:.         
+00039140: 2020 2020 2020 2023 2054 6869 7320 6d61         # This ma
+00039150: 7920 7365 6e64 2074 6865 2077 6f72 6b65  y send the worke
+00039160: 7220 6162 6f76 6520 7265 6369 7069 656e  r above recipien
+00039170: 745f 6d61 7820 2862 7920 6465 7369 676e  t_max (by design
+00039180: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00039190: 2020 7265 635f 6279 7465 735f 6d61 7820    rec_bytes_max 
+000391a0: 3d20 7773 5f6d 656d 6f72 7920 2d20 6d65  = ws_memory - me
+000391b0: 616e 5f6d 656d 6f72 7920 2023 206e 6567  an_memory  # neg
+000391c0: 6174 6976 650a 2020 2020 2020 2020 2020  ative.          
+000391d0: 2020 2020 2020 7265 635f 6279 7465 735f        rec_bytes_
+000391e0: 6d69 6e20 3d20 7265 635f 6279 7465 735f  min = rec_bytes_
+000391f0: 6d61 7820 2b20 6861 6c66 5f67 6170 2020  max + half_gap  
+00039200: 2320 6e65 6761 7469 7665 0a20 2020 2020  # negative.     
+00039210: 2020 2020 2020 2020 2020 2023 2053 6565             # See
+00039220: 2064 6566 696e 6974 696f 6e20 6f66 2072   definition of r
+00039230: 6563 6970 6965 6e74 7320 6162 6f76 650a  ecipients above.
+00039240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039250: 7265 6369 7069 656e 7473 2e61 7070 656e  recipients.appen
+00039260: 6428 2872 6563 5f62 7974 6573 5f6d 6178  d((rec_bytes_max
+00039270: 2c20 7265 635f 6279 7465 735f 6d69 6e2c  , rec_bytes_min,
+00039280: 2069 6428 7773 292c 2077 7329 290a 0a20   id(ws), ws)).. 
+00039290: 2020 2020 2020 2023 2046 6173 7420 6578         # Fast ex
+000392a0: 6974 2069 6e20 6361 7365 206e 6f20 7472  it in case no tr
+000392b0: 616e 7366 6572 7320 6172 6520 6e65 6365  ansfers are nece
+000392c0: 7373 6172 7920 6f72 2070 6f73 7369 626c  ssary or possibl
+000392d0: 650a 2020 2020 2020 2020 6966 206e 6f74  e.        if not
+000392e0: 2073 656e 6465 7273 206f 7220 6e6f 7420   senders or not 
+000392f0: 7265 6369 7069 656e 7473 3a0a 2020 2020  recipients:.    
+00039300: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+00039310: 5f65 7665 6e74 280a 2020 2020 2020 2020  _event(.        
+00039320: 2020 2020 2020 2020 2261 6c6c 222c 0a20          "all",. 
+00039330: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+00039340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039350: 2020 2020 2022 6163 7469 6f6e 223a 2022       "action": "
+00039360: 7265 6261 6c61 6e63 6522 2c0a 2020 2020  rebalance",.    
+00039370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039380: 2273 656e 6465 7273 223a 206c 656e 2873  "senders": len(s
+00039390: 656e 6465 7273 292c 0a20 2020 2020 2020  enders),.       
+000393a0: 2020 2020 2020 2020 2020 2020 2022 7265               "re
+000393b0: 6369 7069 656e 7473 223a 206c 656e 2872  cipients": len(r
+000393c0: 6563 6970 6965 6e74 7329 2c0a 2020 2020  ecipients),.    
+000393d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000393e0: 226d 6f76 6564 5f6b 6579 7322 3a20 302c  "moved_keys": 0,
+000393f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039400: 207d 2c0a 2020 2020 2020 2020 2020 2020   },.            
+00039410: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00039420: 7475 726e 205b 5d0a 0a20 2020 2020 2020  turn []..       
+00039430: 2068 6561 7071 2e68 6561 7069 6679 2873   heapq.heapify(s
+00039440: 656e 6465 7273 290a 2020 2020 2020 2020  enders).        
+00039450: 6865 6170 712e 6865 6170 6966 7928 7265  heapq.heapify(re
+00039460: 6369 7069 656e 7473 290a 0a20 2020 2020  cipients)..     
+00039470: 2020 2077 6869 6c65 2073 656e 6465 7273     while senders
+00039480: 2061 6e64 2072 6563 6970 6965 6e74 733a   and recipients:
+00039490: 0a20 2020 2020 2020 2020 2020 2073 6e64  .            snd
+000394a0: 5f62 7974 6573 5f6d 6178 2c20 736e 645f  _bytes_max, snd_
+000394b0: 6279 7465 735f 6d69 6e2c 205f 2c20 736e  bytes_min, _, sn
+000394c0: 645f 7773 2c20 7473 5f69 7465 7220 3d20  d_ws, ts_iter = 
+000394d0: 7365 6e64 6572 735b 305d 0a0a 2020 2020  senders[0]..    
+000394e0: 2020 2020 2020 2020 2320 4974 6572 6174          # Iterat
+000394f0: 6520 7468 726f 7567 6820 7461 736b 7320  e through tasks 
+00039500: 696e 206d 656d 6f72 792c 206c 6561 7374  in memory, least
+00039510: 2072 6563 656e 746c 7920 696e 7365 7274   recently insert
+00039520: 6564 2066 6972 7374 0a20 2020 2020 2020  ed first.       
+00039530: 2020 2020 2066 6f72 2074 7320 696e 2074       for ts in t
+00039540: 735f 6974 6572 3a0a 2020 2020 2020 2020  s_iter:.        
+00039550: 2020 2020 2020 2020 6966 206b 6579 7320          if keys 
+00039560: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+00039570: 7473 2e6b 6579 206e 6f74 2069 6e20 6b65  ts.key not in ke
+00039580: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
+00039590: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+000395a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000395b0: 206e 6279 7465 7320 3d20 7473 2e6e 6279   nbytes = ts.nby
+000395c0: 7465 730a 2020 2020 2020 2020 2020 2020  tes.            
+000395d0: 2020 2020 6966 206e 6279 7465 7320 2b20      if nbytes + 
+000395e0: 736e 645f 6279 7465 735f 6d61 7820 3e20  snd_bytes_max > 
+000395f0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+00039600: 2020 2020 2020 2023 204d 6f76 696e 6720         # Moving 
+00039610: 7468 6973 2074 6173 6b20 776f 756c 6420  this task would 
+00039620: 6361 7573 6520 7468 6520 7365 6e64 6572  cause the sender
+00039630: 2074 6f20 676f 2062 656c 6f77 206d 6561   to go below mea
+00039640: 6e20 616e 640a 2020 2020 2020 2020 2020  n and.          
+00039650: 2020 2020 2020 2020 2020 2320 706f 7465            # pote
+00039660: 6e74 6961 6c6c 7920 7269 736b 2062 6563  ntially risk bec
+00039670: 6f6d 696e 6720 6120 7265 6369 7069 656e  oming a recipien
+00039680: 742c 2077 6869 6368 2077 6f75 6c64 2063  t, which would c
+00039690: 6175 7365 2074 6173 6b73 2074 6f0a 2020  ause tasks to.  
+000396a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000396b0: 2020 2320 626f 756e 6365 2061 726f 756e    # bounce aroun
+000396c0: 642e 204d 6f76 6520 6f6e 2074 6f20 7468  d. Move on to th
+000396d0: 6520 6e65 7874 2074 6173 6b20 6f66 2074  e next task of t
+000396e0: 6865 2073 616d 6520 7365 6e64 6572 2e0a  he same sender..
+000396f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039700: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
+00039710: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00039720: 4669 6e64 2074 6865 2072 6563 6970 6965  Find the recipie
+00039730: 6e74 2c20 6661 7274 6865 7374 2066 726f  nt, farthest fro
+00039740: 6d20 7468 6520 6d65 616e 2c20 7768 6963  m the mean, whic
+00039750: 680a 2020 2020 2020 2020 2020 2020 2020  h.              
+00039760: 2020 2320 312e 2068 6173 2065 6e6f 7567    # 1. has enoug
+00039770: 6820 6176 6169 6c61 626c 6520 5241 4d20  h available RAM 
+00039780: 666f 7220 7468 6973 2074 6173 6b2c 2061  for this task, a
+00039790: 6e64 0a20 2020 2020 2020 2020 2020 2020  nd.             
+000397a0: 2020 2023 2032 2e20 646f 6573 6e27 7420     # 2. doesn't 
+000397b0: 686f 6c64 2061 2063 6f70 7920 6f66 2074  hold a copy of t
+000397c0: 6869 7320 7461 736b 2061 6c72 6561 6479  his task already
+000397d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000397e0: 2023 2054 6865 7265 206d 6179 206e 6f74   # There may not
+000397f0: 2062 6520 616e 7920 7468 6174 2073 6174   be any that sat
+00039800: 6973 6669 6573 2074 6865 7365 2063 6f6e  isfies these con
+00039810: 6469 7469 6f6e 733b 2069 6e20 7468 6973  ditions; in this
+00039820: 2063 6173 650a 2020 2020 2020 2020 2020   case.          
+00039830: 2020 2020 2020 2320 7468 6973 2074 6173        # this tas
+00039840: 6b20 776f 6e27 7420 6265 206d 6f76 6564  k won't be moved
+00039850: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00039860: 2020 736b 6970 7065 645f 7265 6369 7069    skipped_recipi
+00039870: 656e 7473 203d 205b 5d0a 2020 2020 2020  ents = [].      
+00039880: 2020 2020 2020 2020 2020 7573 655f 7265            use_re
+00039890: 6369 7069 656e 7420 3d20 4661 6c73 650a  cipient = False.
+000398a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000398b0: 7768 696c 6520 7265 6369 7069 656e 7473  while recipients
+000398c0: 2061 6e64 206e 6f74 2075 7365 5f72 6563   and not use_rec
+000398d0: 6970 6965 6e74 3a0a 2020 2020 2020 2020  ipient:.        
+000398e0: 2020 2020 2020 2020 2020 2020 7265 635f              rec_
+000398f0: 6279 7465 735f 6d61 782c 2072 6563 5f62  bytes_max, rec_b
+00039900: 7974 6573 5f6d 696e 2c20 5f2c 2072 6563  ytes_min, _, rec
+00039910: 5f77 7320 3d20 7265 6369 7069 656e 7473  _ws = recipients
+00039920: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+00039930: 2020 2020 2020 2020 6966 206e 6279 7465          if nbyte
+00039940: 7320 2b20 7265 635f 6279 7465 735f 6d61  s + rec_bytes_ma
+00039950: 7820 3e20 303a 0a20 2020 2020 2020 2020  x > 0:.         
+00039960: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00039970: 2072 6563 6970 6965 6e74 7320 6172 6520   recipients are 
+00039980: 736f 7274 6564 2062 7920 7265 635f 6279  sorted by rec_by
+00039990: 7465 735f 6d61 782e 0a20 2020 2020 2020  tes_max..       
+000399a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000399b0: 2023 2054 6865 206e 6578 7420 6f6e 6573   # The next ones
+000399c0: 2077 696c 6c20 6265 2077 6f72 7365 3b20   will be worse; 
+000399d0: 6e6f 2072 6561 736f 6e20 746f 2063 6f6e  no reason to con
+000399e0: 7469 6e75 6520 6974 6572 6174 696e 670a  tinue iterating.
+000399f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039a00: 2020 2020 2020 2020 6272 6561 6b0a 2020          break.  
 00039a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039a20: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
-00039a30: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00039a40: 5363 6865 6475 6c65 2074 6173 6b20 666f  Schedule task fo
-00039a50: 7220 7472 616e 7366 6572 2066 726f 6d20  r transfer from 
-00039a60: 7365 6e64 6572 2074 6f20 7265 6369 7069  sender to recipi
-00039a70: 656e 740a 2020 2020 2020 2020 2020 2020  ent.            
-00039a80: 2020 2020 6d73 6773 2e61 7070 656e 6428      msgs.append(
-00039a90: 2873 6e64 5f77 732c 2072 6563 5f77 732c  (snd_ws, rec_ws,
-00039aa0: 2074 7329 290a 0a20 2020 2020 2020 2020   ts))..         
-00039ab0: 2020 2020 2020 2023 202a 5f62 7974 6573         # *_bytes
-00039ac0: 5f6d 6178 2f6d 696e 2061 7265 2061 6c6c  _max/min are all
-00039ad0: 206e 6567 6174 6976 6520 666f 7220 6865   negative for he
-00039ae0: 6170 2073 6f72 7469 6e67 0a20 2020 2020  ap sorting.     
-00039af0: 2020 2020 2020 2020 2020 2073 6e64 5f62             snd_b
-00039b00: 7974 6573 5f6d 6178 202b 3d20 6e62 7974  ytes_max += nbyt
-00039b10: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
-00039b20: 2020 2073 6e64 5f62 7974 6573 5f6d 696e     snd_bytes_min
-00039b30: 202b 3d20 6e62 7974 6573 0a20 2020 2020   += nbytes.     
-00039b40: 2020 2020 2020 2020 2020 2072 6563 5f62             rec_b
-00039b50: 7974 6573 5f6d 6178 202b 3d20 6e62 7974  ytes_max += nbyt
-00039b60: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
-00039b70: 2020 2072 6563 5f62 7974 6573 5f6d 696e     rec_bytes_min
-00039b80: 202b 3d20 6e62 7974 6573 0a0a 2020 2020   += nbytes..    
-00039b90: 2020 2020 2020 2020 2020 2020 2320 5374              # St
-00039ba0: 6f70 2069 7465 7261 7469 6e67 206f 6e20  op iterating on 
-00039bb0: 7468 6520 7461 736b 7320 6f66 2074 6869  the tasks of thi
-00039bc0: 7320 7365 6e64 6572 2066 6f72 206e 6f77  s sender for now
-00039bd0: 2061 6e64 2c20 6966 2069 7420 7374 696c   and, if it stil
-00039be0: 6c0a 2020 2020 2020 2020 2020 2020 2020  l.              
-00039bf0: 2020 2320 6861 7320 6279 7465 7320 746f    # has bytes to
-00039c00: 206c 6f73 652c 2070 7573 6820 6974 2062   lose, push it b
-00039c10: 6163 6b20 696e 746f 2074 6865 2073 656e  ack into the sen
-00039c20: 6465 7273 2068 6561 703b 2069 7420 6d61  ders heap; it ma
-00039c30: 7920 6f72 206d 6179 0a20 2020 2020 2020  y or may.       
-00039c40: 2020 2020 2020 2020 2023 206e 6f74 2063           # not c
-00039c50: 6f6d 6520 6261 636b 206f 6e20 746f 7020  ome back on top 
-00039c60: 6167 6169 6e2e 0a20 2020 2020 2020 2020  again..         
-00039c70: 2020 2020 2020 2069 6620 736e 645f 6279         if snd_by
-00039c80: 7465 735f 6d69 6e20 3c20 303a 0a20 2020  tes_min < 0:.   
-00039c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039ca0: 2023 2053 6565 2064 6566 696e 6974 696f   # See definitio
-00039cb0: 6e20 6f66 2073 656e 6465 7273 2061 626f  n of senders abo
-00039cc0: 7665 0a20 2020 2020 2020 2020 2020 2020  ve.             
-00039cd0: 2020 2020 2020 2068 6561 7071 2e68 6561         heapq.hea
-00039ce0: 7072 6570 6c61 6365 280a 2020 2020 2020  preplace(.      
-00039cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039d00: 2020 7365 6e64 6572 732c 0a20 2020 2020    senders,.     
-00039d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039d20: 2020 2028 736e 645f 6279 7465 735f 6d61     (snd_bytes_ma
-00039d30: 782c 2073 6e64 5f62 7974 6573 5f6d 696e  x, snd_bytes_min
-00039d40: 2c20 6964 2873 6e64 5f77 7329 2c20 736e  , id(snd_ws), sn
-00039d50: 645f 7773 2c20 7473 5f69 7465 7229 2c0a  d_ws, ts_iter),.
-00039d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039d70: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00039d80: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00039d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039da0: 6865 6170 712e 6865 6170 706f 7028 7365  heapq.heappop(se
-00039db0: 6e64 6572 7329 0a0a 2020 2020 2020 2020  nders)..        
-00039dc0: 2020 2020 2020 2020 2320 4966 2072 6563          # If rec
-00039dd0: 6970 6965 6e74 2073 7469 6c6c 2068 6173  ipient still has
-00039de0: 2062 7974 6573 2074 6f20 6761 696e 2c20   bytes to gain, 
-00039df0: 7075 7368 2069 7420 6261 636b 2069 6e74  push it back int
-00039e00: 6f20 7468 6520 7265 6369 7069 656e 7473  o the recipients
-00039e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039e20: 2023 2068 6561 703b 2069 7420 6d61 7920   # heap; it may 
-00039e30: 6f72 206d 6179 206e 6f74 2063 6f6d 6520  or may not come 
-00039e40: 6261 636b 206f 6e20 746f 7020 6167 6169  back on top agai
-00039e50: 6e2e 0a20 2020 2020 2020 2020 2020 2020  n..             
-00039e60: 2020 2069 6620 7265 635f 6279 7465 735f     if rec_bytes_
-00039e70: 6d69 6e20 3c20 303a 0a20 2020 2020 2020  min < 0:.       
-00039e80: 2020 2020 2020 2020 2020 2020 2023 2053               # S
-00039e90: 6565 2064 6566 696e 6974 696f 6e20 6f66  ee definition of
-00039ea0: 2072 6563 6970 6965 6e74 7320 6162 6f76   recipients abov
-00039eb0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00039ec0: 2020 2020 2020 6865 6170 712e 6865 6170        heapq.heap
-00039ed0: 7265 706c 6163 6528 0a20 2020 2020 2020  replace(.       
-00039ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039ef0: 2072 6563 6970 6965 6e74 732c 0a20 2020   recipients,.   
-00039f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039f10: 2020 2020 2028 7265 635f 6279 7465 735f       (rec_bytes_
-00039f20: 6d61 782c 2072 6563 5f62 7974 6573 5f6d  max, rec_bytes_m
-00039f30: 696e 2c20 6964 2872 6563 5f77 7329 2c20  in, id(rec_ws), 
-00039f40: 7265 635f 7773 292c 0a20 2020 2020 2020  rec_ws),.       
-00039f50: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00039f60: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00039f70: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00039f80: 2020 2020 2020 2020 2068 6561 7071 2e68           heapq.h
-00039f90: 6561 7070 6f70 2872 6563 6970 6965 6e74  eappop(recipient
-00039fa0: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
-00039fb0: 2020 2020 2320 4d6f 7665 2074 6f20 6e65      # Move to ne
-00039fc0: 7874 2073 656e 6465 7220 7769 7468 2074  xt sender with t
-00039fd0: 6865 206d 6f73 7420 6461 7461 2074 6f20  he most data to 
-00039fe0: 6c6f 7365 2e0a 2020 2020 2020 2020 2020  lose..          
-00039ff0: 2020 2020 2020 2320 4974 206d 6179 206f        # It may o
-0003a000: 7220 6d61 7920 6e6f 7420 6265 2074 6865  r may not be the
-0003a010: 2073 616d 6520 7365 6e64 6572 2061 6761   same sender aga
-0003a020: 696e 2e0a 2020 2020 2020 2020 2020 2020  in..            
-0003a030: 2020 2020 6272 6561 6b0a 0a20 2020 2020      break..     
-0003a040: 2020 2020 2020 2065 6c73 653a 2020 2320         else:  # 
-0003a050: 666f 7220 7473 2069 6e20 7473 5f69 7465  for ts in ts_ite
-0003a060: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-0003a070: 2020 2320 4578 6861 7573 7465 6420 7461    # Exhausted ta
-0003a080: 736b 7320 6f6e 2074 6869 7320 7365 6e64  sks on this send
-0003a090: 6572 0a20 2020 2020 2020 2020 2020 2020  er.             
-0003a0a0: 2020 2068 6561 7071 2e68 6561 7070 6f70     heapq.heappop
-0003a0b0: 2873 656e 6465 7273 290a 0a20 2020 2020  (senders)..     
-0003a0c0: 2020 2072 6574 7572 6e20 6d73 6773 0a0a     return msgs..
-0003a0d0: 2020 2020 6173 796e 6320 6465 6620 5f72      async def _r
-0003a0e0: 6562 616c 616e 6365 5f6d 6f76 655f 6461  ebalance_move_da
-0003a0f0: 7461 280a 2020 2020 2020 2020 7365 6c66  ta(.        self
-0003a100: 2c20 6d73 6773 3a20 226c 6973 745b 7475  , msgs: "list[tu
-0003a110: 706c 655b 576f 726b 6572 5374 6174 652c  ple[WorkerState,
-0003a120: 2057 6f72 6b65 7253 7461 7465 2c20 5461   WorkerState, Ta
-0003a130: 736b 5374 6174 655d 5d22 2c20 7374 696d  skState]]", stim
-0003a140: 756c 7573 5f69 643a 2073 7472 0a20 2020  ulus_id: str.   
-0003a150: 2029 202d 3e20 6469 6374 3a0a 2020 2020   ) -> dict:.    
-0003a160: 2020 2020 2222 2250 6572 666f 726d 2074      """Perform t
-0003a170: 6865 2061 6374 7561 6c20 7472 616e 7366  he actual transf
-0003a180: 6572 206f 6620 6461 7461 2061 6372 6f73  er of data acros
-0003a190: 7320 7468 6520 6e65 7477 6f72 6b20 696e  s the network in
-0003a1a0: 2072 6562 616c 616e 6365 2829 2e0a 2020   rebalance()..  
-0003a1b0: 2020 2020 2020 5461 6b65 7320 696e 2069        Takes in i
-0003a1c0: 6e70 7574 2074 6865 206f 7574 7075 7420  nput the output 
-0003a1d0: 6f66 205f 7265 6261 6c61 6e63 655f 6669  of _rebalance_fi
-0003a1e0: 6e64 5f6d 7367 7328 292c 2074 6861 7420  nd_msgs(), that 
-0003a1f0: 6973 2061 206c 6973 7420 6f66 2074 7570  is a list of tup
-0003a200: 6c65 733a 0a0a 2020 2020 2020 2020 2d20  les:..        - 
-0003a210: 7365 6e64 6572 2077 6f72 6b65 720a 2020  sender worker.  
-0003a220: 2020 2020 2020 2d20 7265 6369 7069 656e        - recipien
-0003a230: 7420 776f 726b 6572 0a20 2020 2020 2020  t worker.       
-0003a240: 202d 2074 6173 6b20 746f 2062 6520 7472   - task to be tr
-0003a250: 616e 7366 6572 7265 640a 0a20 2020 2020  ansferred..     
-0003a260: 2020 2046 4958 4d45 2074 6869 7320 6d65     FIXME this me
-0003a270: 7468 6f64 2069 7320 6e6f 7420 726f 6275  thod is not robu
-0003a280: 7374 2077 6865 6e20 7468 6520 636c 7573  st when the clus
-0003a290: 7465 7220 6973 206e 6f74 2069 646c 652e  ter is not idle.
-0003a2a0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0003a2b0: 2020 2020 2074 6f5f 7265 6369 7069 656e       to_recipien
-0003a2c0: 7473 3a20 6465 6661 756c 7464 6963 745b  ts: defaultdict[
-0003a2d0: 7374 722c 2064 6566 6175 6c74 6469 6374  str, defaultdict
-0003a2e0: 5b73 7472 2c20 6c69 7374 5b73 7472 5d5d  [str, list[str]]
-0003a2f0: 5d20 3d20 6465 6661 756c 7464 6963 7428  ] = defaultdict(
-0003a300: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
-0003a310: 6264 613a 2064 6566 6175 6c74 6469 6374  bda: defaultdict
-0003a320: 286c 6973 7429 0a20 2020 2020 2020 2029  (list).        )
-0003a330: 0a20 2020 2020 2020 2066 6f72 2073 6e64  .        for snd
-0003a340: 5f77 732c 2072 6563 5f77 732c 2074 7320  _ws, rec_ws, ts 
-0003a350: 696e 206d 7367 733a 0a20 2020 2020 2020  in msgs:.       
-0003a360: 2020 2020 2074 6f5f 7265 6369 7069 656e       to_recipien
-0003a370: 7473 5b72 6563 5f77 732e 6164 6472 6573  ts[rec_ws.addres
-0003a380: 735d 5b74 732e 6b65 795d 2e61 7070 656e  s][ts.key].appen
-0003a390: 6428 736e 645f 7773 2e61 6464 7265 7373  d(snd_ws.address
-0003a3a0: 290a 2020 2020 2020 2020 6661 696c 6564  ).        failed
-0003a3b0: 5f6b 6579 735f 6279 5f72 6563 6970 6965  _keys_by_recipie
-0003a3c0: 6e74 203d 2064 6963 7428 0a20 2020 2020  nt = dict(.     
-0003a3d0: 2020 2020 2020 207a 6970 280a 2020 2020         zip(.    
-0003a3e0: 2020 2020 2020 2020 2020 2020 746f 5f72              to_r
-0003a3f0: 6563 6970 6965 6e74 732c 0a20 2020 2020  ecipients,.     
-0003a400: 2020 2020 2020 2020 2020 2061 7761 6974             await
-0003a410: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
-0003a420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003a430: 2020 2020 202a 280a 2020 2020 2020 2020       *(.        
-0003a440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a450: 2320 4e6f 7465 3a20 7468 6973 206e 6576  # Note: this nev
-0003a460: 6572 2072 6169 7365 7320 6578 6365 7074  er raises except
-0003a470: 696f 6e73 0a20 2020 2020 2020 2020 2020  ions.           
-0003a480: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0003a490: 662e 6761 7468 6572 5f6f 6e5f 776f 726b  f.gather_on_work
-0003a4a0: 6572 2877 2c20 7768 6f5f 6861 7329 0a20  er(w, who_has). 
-0003a4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a4c0: 2020 2020 2020 2066 6f72 2077 2c20 7768         for w, wh
-0003a4d0: 6f5f 6861 7320 696e 2074 6f5f 7265 6369  o_has in to_reci
-0003a4e0: 7069 656e 7473 2e69 7465 6d73 2829 0a20  pients.items(). 
-0003a4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a500: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0003a510: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
-0003a520: 2020 2020 290a 2020 2020 2020 2020 290a      ).        ).
-0003a530: 0a20 2020 2020 2020 2074 6f5f 7365 6e64  .        to_send
-0003a540: 6572 7320 3d20 6465 6661 756c 7464 6963  ers = defaultdic
-0003a550: 7428 6c69 7374 290a 2020 2020 2020 2020  t(list).        
-0003a560: 666f 7220 736e 645f 7773 2c20 7265 635f  for snd_ws, rec_
-0003a570: 7773 2c20 7473 2069 6e20 6d73 6773 3a0a  ws, ts in msgs:.
-0003a580: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-0003a590: 732e 6b65 7920 6e6f 7420 696e 2066 6169  s.key not in fai
-0003a5a0: 6c65 645f 6b65 7973 5f62 795f 7265 6369  led_keys_by_reci
-0003a5b0: 7069 656e 745b 7265 635f 7773 2e61 6464  pient[rec_ws.add
-0003a5c0: 7265 7373 5d3a 0a20 2020 2020 2020 2020  ress]:.         
-0003a5d0: 2020 2020 2020 2074 6f5f 7365 6e64 6572         to_sender
-0003a5e0: 735b 736e 645f 7773 2e61 6464 7265 7373  s[snd_ws.address
-0003a5f0: 5d2e 6170 7065 6e64 2874 732e 6b65 7929  ].append(ts.key)
-0003a600: 0a0a 2020 2020 2020 2020 2320 4e6f 7465  ..        # Note
-0003a610: 3a20 7468 6973 206e 6576 6572 2072 6169  : this never rai
-0003a620: 7365 7320 6578 6365 7074 696f 6e73 0a20  ses exceptions. 
-0003a630: 2020 2020 2020 2061 7761 6974 2061 7379         await asy
-0003a640: 6e63 696f 2e67 6174 6865 7228 0a20 2020  ncio.gather(.   
-0003a650: 2020 2020 2020 2020 202a 2873 656c 662e           *(self.
-0003a660: 6465 6c65 7465 5f77 6f72 6b65 725f 6461  delete_worker_da
-0003a670: 7461 2872 2c20 762c 2073 7469 6d75 6c75  ta(r, v, stimulu
-0003a680: 735f 6964 2920 666f 7220 722c 2076 2069  s_id) for r, v i
-0003a690: 6e20 746f 5f73 656e 6465 7273 2e69 7465  n to_senders.ite
-0003a6a0: 6d73 2829 290a 2020 2020 2020 2020 290a  ms()).        ).
-0003a6b0: 0a20 2020 2020 2020 2066 6f72 2072 2c20  .        for r, 
-0003a6c0: 7620 696e 2074 6f5f 7265 6369 7069 656e  v in to_recipien
-0003a6d0: 7473 2e69 7465 6d73 2829 3a0a 2020 2020  ts.items():.    
-0003a6e0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-0003a6f0: 5f65 7665 6e74 2872 2c20 7b22 6163 7469  _event(r, {"acti
-0003a700: 6f6e 223a 2022 7265 6261 6c61 6e63 6522  on": "rebalance"
-0003a710: 2c20 2277 686f 5f68 6173 223a 2076 7d29  , "who_has": v})
-0003a720: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
-0003a730: 675f 6576 656e 7428 0a20 2020 2020 2020  g_event(.       
-0003a740: 2020 2020 2022 616c 6c22 2c0a 2020 2020       "all",.    
-0003a750: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0003a760: 2020 2020 2020 2020 2020 2261 6374 696f            "actio
-0003a770: 6e22 3a20 2272 6562 616c 616e 6365 222c  n": "rebalance",
-0003a780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003a790: 2022 7365 6e64 6572 7322 3a20 7661 6c6d   "senders": valm
-0003a7a0: 6170 286c 656e 2c20 746f 5f73 656e 6465  ap(len, to_sende
-0003a7b0: 7273 292c 0a20 2020 2020 2020 2020 2020  rs),.           
-0003a7c0: 2020 2020 2022 7265 6369 7069 656e 7473       "recipients
-0003a7d0: 223a 2076 616c 6d61 7028 6c65 6e2c 2074  ": valmap(len, t
-0003a7e0: 6f5f 7265 6369 7069 656e 7473 292c 0a20  o_recipients),. 
-0003a7f0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0003a800: 6d6f 7665 645f 6b65 7973 223a 206c 656e  moved_keys": len
-0003a810: 286d 7367 7329 2c0a 2020 2020 2020 2020  (msgs),.        
-0003a820: 2020 2020 7d2c 0a20 2020 2020 2020 2029      },.        )
-0003a830: 0a0a 2020 2020 2020 2020 6d69 7373 696e  ..        missin
-0003a840: 675f 6b65 7973 203d 207b 6b20 666f 7220  g_keys = {k for 
-0003a850: 7220 696e 2066 6169 6c65 645f 6b65 7973  r in failed_keys
-0003a860: 5f62 795f 7265 6369 7069 656e 742e 7661  _by_recipient.va
-0003a870: 6c75 6573 2829 2066 6f72 206b 2069 6e20  lues() for k in 
-0003a880: 727d 0a20 2020 2020 2020 2069 6620 6d69  r}.        if mi
-0003a890: 7373 696e 675f 6b65 7973 3a0a 2020 2020  ssing_keys:.    
-0003a8a0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-0003a8b0: 2273 7461 7475 7322 3a20 2270 6172 7469  "status": "parti
-0003a8c0: 616c 2d66 6169 6c22 2c20 226b 6579 7322  al-fail", "keys"
-0003a8d0: 3a20 6c69 7374 286d 6973 7369 6e67 5f6b  : list(missing_k
-0003a8e0: 6579 7329 7d0a 2020 2020 2020 2020 656c  eys)}.        el
-0003a8f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0003a900: 7265 7475 726e 207b 2273 7461 7475 7322  return {"status"
-0003a910: 3a20 224f 4b22 7d0a 0a20 2020 2061 7379  : "OK"}..    asy
-0003a920: 6e63 2064 6566 2072 6570 6c69 6361 7465  nc def replicate
-0003a930: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-0003a940: 2020 2020 2020 2020 636f 6d6d 3d4e 6f6e          comm=Non
-0003a950: 652c 0a20 2020 2020 2020 206b 6579 733d  e,.        keys=
-0003a960: 4e6f 6e65 2c0a 2020 2020 2020 2020 6e3d  None,.        n=
-0003a970: 4e6f 6e65 2c0a 2020 2020 2020 2020 776f  None,.        wo
-0003a980: 726b 6572 733d 4e6f 6e65 2c0a 2020 2020  rkers=None,.    
-0003a990: 2020 2020 6272 616e 6368 696e 675f 6661      branching_fa
-0003a9a0: 6374 6f72 3d32 2c0a 2020 2020 2020 2020  ctor=2,.        
-0003a9b0: 6465 6c65 7465 3d54 7275 652c 0a20 2020  delete=True,.   
-0003a9c0: 2020 2020 206c 6f63 6b3d 5472 7565 2c0a       lock=True,.
-0003a9d0: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
-0003a9e0: 5f69 643d 4e6f 6e65 2c0a 2020 2020 293a  _id=None,.    ):
-0003a9f0: 0a20 2020 2020 2020 2022 2222 5265 706c  .        """Repl
-0003aa00: 6963 6174 6520 6461 7461 2074 6872 6f75  icate data throu
-0003aa10: 6768 6f75 7420 636c 7573 7465 720a 0a20  ghout cluster.. 
-0003aa20: 2020 2020 2020 2054 6869 7320 7065 7266         This perf
-0003aa30: 6f72 6d73 2061 2074 7265 6520 636f 7079  orms a tree copy
-0003aa40: 206f 6620 7468 6520 6461 7461 2074 6872   of the data thr
-0003aa50: 6f75 6768 6f75 7420 7468 6520 6e65 7477  oughout the netw
-0003aa60: 6f72 6b0a 2020 2020 2020 2020 696e 6469  ork.        indi
-0003aa70: 7669 6475 616c 6c79 206f 6e20 6561 6368  vidually on each
-0003aa80: 2070 6965 6365 206f 6620 6461 7461 2e0a   piece of data..
-0003aa90: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
-0003aaa0: 6572 730a 2020 2020 2020 2020 2d2d 2d2d  ers.        ----
-0003aab0: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 206b  ------.        k
-0003aac0: 6579 733a 2049 7465 7261 626c 650a 2020  eys: Iterable.  
-0003aad0: 2020 2020 2020 2020 2020 6c69 7374 206f            list o
-0003aae0: 6620 6b65 7973 2074 6f20 7265 706c 6963  f keys to replic
-0003aaf0: 6174 650a 2020 2020 2020 2020 6e3a 2069  ate.        n: i
-0003ab00: 6e74 0a20 2020 2020 2020 2020 2020 204e  nt.            N
-0003ab10: 756d 6265 7220 6f66 2072 6570 6c69 6361  umber of replica
-0003ab20: 7469 6f6e 7320 7765 2065 7870 6563 7420  tions we expect 
-0003ab30: 746f 2073 6565 2077 6974 6869 6e20 7468  to see within th
-0003ab40: 6520 636c 7573 7465 720a 2020 2020 2020  e cluster.      
-0003ab50: 2020 6272 616e 6368 696e 675f 6661 6374    branching_fact
-0003ab60: 6f72 3a20 696e 742c 206f 7074 696f 6e61  or: int, optiona
-0003ab70: 6c0a 2020 2020 2020 2020 2020 2020 5468  l.            Th
-0003ab80: 6520 6e75 6d62 6572 206f 6620 776f 726b  e number of work
-0003ab90: 6572 7320 7468 6174 2063 616e 2063 6f70  ers that can cop
-0003aba0: 7920 6461 7461 2069 6e20 6561 6368 2067  y data in each g
-0003abb0: 656e 6572 6174 696f 6e2e 0a20 2020 2020  eneration..     
-0003abc0: 2020 2020 2020 2054 6865 206c 6172 6765         The large
-0003abd0: 7220 7468 6520 6272 616e 6368 696e 6720  r the branching 
-0003abe0: 6661 6374 6f72 2c20 7468 6520 6d6f 7265  factor, the more
-0003abf0: 2064 6174 6120 7765 2063 6f70 7920 696e   data we copy in
-0003ac00: 0a20 2020 2020 2020 2020 2020 2061 2073  .            a s
-0003ac10: 696e 676c 6520 7374 6570 2c20 6275 7420  ingle step, but 
-0003ac20: 7468 6520 6d6f 7265 2061 2067 6976 656e  the more a given
-0003ac30: 2077 6f72 6b65 7220 7269 736b 7320 6265   worker risks be
-0003ac40: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
-0003ac50: 7377 616d 7065 6420 6279 2064 6174 6120  swamped by data 
-0003ac60: 7265 7175 6573 7473 2e0a 0a20 2020 2020  requests...     
-0003ac70: 2020 2053 6565 2061 6c73 6f0a 2020 2020     See also.    
-0003ac80: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
-0003ac90: 2020 2020 2053 6368 6564 756c 6572 2e72       Scheduler.r
-0003aca0: 6562 616c 616e 6365 0a20 2020 2020 2020  ebalance.       
-0003acb0: 2022 2222 0a20 2020 2020 2020 2073 7469   """.        sti
-0003acc0: 6d75 6c75 735f 6964 203d 2073 7469 6d75  mulus_id = stimu
-0003acd0: 6c75 735f 6964 206f 7220 6622 7265 706c  lus_id or f"repl
-0003ace0: 6963 6174 652d 7b74 696d 6528 297d 220a  icate-{time()}".
-0003acf0: 2020 2020 2020 2020 6173 7365 7274 2062          assert b
-0003ad00: 7261 6e63 6869 6e67 5f66 6163 746f 7220  ranching_factor 
-0003ad10: 3e20 300a 2020 2020 2020 2020 6173 796e  > 0.        asyn
-0003ad20: 6320 7769 7468 2073 656c 662e 5f6c 6f63  c with self._loc
-0003ad30: 6b20 6966 206c 6f63 6b20 656c 7365 2065  k if lock else e
-0003ad40: 6d70 7479 5f63 6f6e 7465 7874 3a0a 2020  mpty_context:.  
-0003ad50: 2020 2020 2020 2020 2020 6966 2077 6f72            if wor
-0003ad60: 6b65 7273 2069 7320 6e6f 7420 4e6f 6e65  kers is not None
-0003ad70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003ad80: 2020 776f 726b 6572 7320 3d20 7b73 656c    workers = {sel
-0003ad90: 662e 776f 726b 6572 735b 775d 2066 6f72  f.workers[w] for
-0003ada0: 2077 2069 6e20 7365 6c66 2e77 6f72 6b65   w in self.worke
-0003adb0: 7273 5f6c 6973 7428 776f 726b 6572 7329  rs_list(workers)
-0003adc0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-0003add0: 2020 776f 726b 6572 7320 3d20 7b77 7320    workers = {ws 
-0003ade0: 666f 7220 7773 2069 6e20 776f 726b 6572  for ws in worker
-0003adf0: 7320 6966 2077 732e 7374 6174 7573 203d  s if ws.status =
-0003ae00: 3d20 5374 6174 7573 2e72 756e 6e69 6e67  = Status.running
-0003ae10: 7d0a 2020 2020 2020 2020 2020 2020 656c  }.            el
-0003ae20: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0003ae30: 2020 2020 776f 726b 6572 7320 3d20 7365      workers = se
-0003ae40: 6c66 2e72 756e 6e69 6e67 0a0a 2020 2020  lf.running..    
-0003ae50: 2020 2020 2020 2020 6966 206e 2069 7320          if n is 
-0003ae60: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0003ae70: 2020 2020 2020 6e20 3d20 6c65 6e28 776f        n = len(wo
-0003ae80: 726b 6572 7329 0a20 2020 2020 2020 2020  rkers).         
-0003ae90: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0003aea0: 2020 2020 2020 2020 206e 203d 206d 696e           n = min
-0003aeb0: 286e 2c20 6c65 6e28 776f 726b 6572 7329  (n, len(workers)
-0003aec0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0003aed0: 206e 203d 3d20 303a 0a20 2020 2020 2020   n == 0:.       
-0003aee0: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-0003aef0: 616c 7565 4572 726f 7228 2243 616e 206e  alueError("Can n
-0003af00: 6f74 2075 7365 2072 6570 6c69 6361 7465  ot use replicate
-0003af10: 2074 6f20 6465 6c65 7465 2064 6174 6122   to delete data"
-0003af20: 290a 0a20 2020 2020 2020 2020 2020 2074  )..            t
-0003af30: 6173 6b73 203d 207b 7365 6c66 2e74 6173  asks = {self.tas
-0003af40: 6b73 5b6b 5d20 666f 7220 6b20 696e 206b  ks[k] for k in k
-0003af50: 6579 737d 0a20 2020 2020 2020 2020 2020  eys}.           
-0003af60: 206d 6973 7369 6e67 5f64 6174 6120 3d20   missing_data = 
-0003af70: 5b74 732e 6b65 7920 666f 7220 7473 2069  [ts.key for ts i
-0003af80: 6e20 7461 736b 7320 6966 206e 6f74 2074  n tasks if not t
-0003af90: 732e 7768 6f5f 6861 735d 0a20 2020 2020  s.who_has].     
-0003afa0: 2020 2020 2020 2069 6620 6d69 7373 696e         if missin
-0003afb0: 675f 6461 7461 3a0a 2020 2020 2020 2020  g_data:.        
-0003afc0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-0003afd0: 2273 7461 7475 7322 3a20 2270 6172 7469  "status": "parti
-0003afe0: 616c 2d66 6169 6c22 2c20 226b 6579 7322  al-fail", "keys"
-0003aff0: 3a20 6d69 7373 696e 675f 6461 7461 7d0a  : missing_data}.
-0003b000: 0a20 2020 2020 2020 2020 2020 2023 2044  .            # D
-0003b010: 656c 6574 6520 6578 7472 616e 656f 7573  elete extraneous
-0003b020: 2064 6174 610a 2020 2020 2020 2020 2020   data.          
-0003b030: 2020 6966 2064 656c 6574 653a 0a20 2020    if delete:.   
-0003b040: 2020 2020 2020 2020 2020 2020 2064 656c               del
-0003b050: 5f77 6f72 6b65 725f 7461 736b 7320 3d20  _worker_tasks = 
-0003b060: 6465 6661 756c 7464 6963 7428 7365 7429  defaultdict(set)
-0003b070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003b080: 2066 6f72 2074 7320 696e 2074 6173 6b73   for ts in tasks
-0003b090: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003b0a0: 2020 2020 2020 6465 6c5f 6361 6e64 6964        del_candid
-0003b0b0: 6174 6573 203d 2074 7570 6c65 2874 732e  ates = tuple(ts.
-0003b0c0: 7768 6f5f 6861 7320 2620 776f 726b 6572  who_has & worker
-0003b0d0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-0003b0e0: 2020 2020 2020 2069 6620 6c65 6e28 6465         if len(de
-0003b0f0: 6c5f 6361 6e64 6964 6174 6573 2920 3e20  l_candidates) > 
-0003b100: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
-0003b110: 2020 2020 2020 2020 2020 2066 6f72 2077             for w
-0003b120: 7320 696e 2072 616e 646f 6d2e 7361 6d70  s in random.samp
-0003b130: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
-0003b140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b150: 6465 6c5f 6361 6e64 6964 6174 6573 2c20  del_candidates, 
-0003b160: 6c65 6e28 6465 6c5f 6361 6e64 6964 6174  len(del_candidat
-0003b170: 6573 2920 2d20 6e0a 2020 2020 2020 2020  es) - n.        
-0003b180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b190: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0003b1a0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0003b1b0: 656c 5f77 6f72 6b65 725f 7461 736b 735b  el_worker_tasks[
-0003b1c0: 7773 5d2e 6164 6428 7473 290a 0a20 2020  ws].add(ts)..   
-0003b1d0: 2020 2020 2020 2020 2020 2020 2023 204e               # N
-0003b1e0: 6f74 653a 2074 6869 7320 6e65 7665 7220  ote: this never 
-0003b1f0: 7261 6973 6573 2065 7863 6570 7469 6f6e  raises exception
-0003b200: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0003b210: 2020 6177 6169 7420 6173 796e 6369 6f2e    await asyncio.
-0003b220: 6761 7468 6572 280a 2020 2020 2020 2020  gather(.        
-0003b230: 2020 2020 2020 2020 2020 2020 2a5b 0a20              *[. 
-0003b240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b250: 2020 2020 2020 2073 656c 662e 6465 6c65         self.dele
-0003b260: 7465 5f77 6f72 6b65 725f 6461 7461 280a  te_worker_data(.
-0003b270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b280: 2020 2020 2020 2020 2020 2020 7773 2e61              ws.a
-0003b290: 6464 7265 7373 2c20 5b74 2e6b 6579 2066  ddress, [t.key f
-0003b2a0: 6f72 2074 2069 6e20 7461 736b 735d 2c20  or t in tasks], 
-0003b2b0: 7374 696d 756c 7573 5f69 640a 2020 2020  stimulus_id.    
-0003b2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b2d0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0003b2e0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0003b2f0: 7220 7773 2c20 7461 736b 7320 696e 2064  r ws, tasks in d
-0003b300: 656c 5f77 6f72 6b65 725f 7461 736b 732e  el_worker_tasks.
-0003b310: 6974 656d 7328 290a 2020 2020 2020 2020  items().        
-0003b320: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-0003b330: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0003b340: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
-0003b350: 6f70 7920 6e6f 742d 7965 742d 6669 6c6c  opy not-yet-fill
-0003b360: 6564 2064 6174 610a 2020 2020 2020 2020  ed data.        
-0003b370: 2020 2020 7768 696c 6520 7461 736b 733a      while tasks:
-0003b380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003b390: 2067 6174 6865 7273 203d 2064 6566 6175   gathers = defau
-0003b3a0: 6c74 6469 6374 2864 6963 7429 0a20 2020  ltdict(dict).   
-0003b3b0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0003b3c0: 2074 7320 696e 206c 6973 7428 7461 736b   ts in list(task
-0003b3d0: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-0003b3e0: 2020 2020 2020 2020 6966 2074 732e 7374          if ts.st
-0003b3f0: 6174 6520 3d3d 2022 666f 7267 6f74 7465  ate == "forgotte
-0003b400: 6e22 3a0a 2020 2020 2020 2020 2020 2020  n":.            
-0003b410: 2020 2020 2020 2020 2020 2020 2320 7461              # ta
-0003b420: 736b 2069 7320 6e6f 206c 6f6e 6765 7220  sk is no longer 
-0003b430: 6e65 6564 6564 2062 7920 616e 7920 636c  needed by any cl
-0003b440: 6965 6e74 206f 7220 6465 7065 6e64 656e  ient or dependen
-0003b450: 7420 7461 736b 0a20 2020 2020 2020 2020  t task.         
-0003b460: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0003b470: 6173 6b73 2e72 656d 6f76 6528 7473 290a  asks.remove(ts).
-0003b480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b490: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-0003b4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003b4b0: 2020 2020 206e 5f6d 6973 7369 6e67 203d       n_missing =
-0003b4c0: 206e 202d 206c 656e 2874 732e 7768 6f5f   n - len(ts.who_
-0003b4d0: 6861 7320 2620 776f 726b 6572 7329 0a20  has & workers). 
-0003b4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b4f0: 2020 2069 6620 6e5f 6d69 7373 696e 6720     if n_missing 
-0003b500: 3c3d 2030 3a0a 2020 2020 2020 2020 2020  <= 0:.          
-0003b510: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0003b520: 416c 7265 6164 7920 7265 706c 6963 6174  Already replicat
-0003b530: 6564 2065 6e6f 7567 680a 2020 2020 2020  ed enough.      
-0003b540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b550: 2020 7461 736b 732e 7265 6d6f 7665 2874    tasks.remove(t
-0003b560: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-0003b570: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-0003b580: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
-0003b590: 2020 2020 2020 2020 2063 6f75 6e74 203d           count =
-0003b5a0: 206d 696e 286e 5f6d 6973 7369 6e67 2c20   min(n_missing, 
-0003b5b0: 6272 616e 6368 696e 675f 6661 6374 6f72  branching_factor
-0003b5c0: 202a 206c 656e 2874 732e 7768 6f5f 6861   * len(ts.who_ha
-0003b5d0: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
-0003b5e0: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
-0003b5f0: 6f75 6e74 203e 2030 0a0a 2020 2020 2020  ount > 0..      
-0003b600: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0003b610: 7220 7773 2069 6e20 7261 6e64 6f6d 2e73  r ws in random.s
-0003b620: 616d 706c 6528 7475 706c 6528 776f 726b  ample(tuple(work
-0003b630: 6572 7320 2d20 7473 2e77 686f 5f68 6173  ers - ts.who_has
-0003b640: 292c 2063 6f75 6e74 293a 0a20 2020 2020  ), count):.     
-0003b650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b660: 2020 2067 6174 6865 7273 5b77 732e 6164     gathers[ws.ad
-0003b670: 6472 6573 735d 5b74 732e 6b65 795d 203d  dress][ts.key] =
-0003b680: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-0003b690: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0003b6a0: 7773 2e61 6464 7265 7373 2066 6f72 2077  ws.address for w
-0003b6b0: 7773 2069 6e20 7473 2e77 686f 5f68 6173  ws in ts.who_has
-0003b6c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003b6d0: 2020 2020 2020 2020 205d 0a0a 2020 2020           ]..    
-0003b6e0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-0003b6f0: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
-0003b700: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0003b710: 2020 2020 2020 2a28 0a20 2020 2020 2020        *(.       
+00039a20: 2020 7573 655f 7265 6369 7069 656e 7420    use_recipient 
+00039a30: 3d20 7473 206e 6f74 2069 6e20 7265 635f  = ts not in rec_
+00039a40: 7773 2e5f 6861 735f 7768 6174 0a20 2020  ws._has_what.   
+00039a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039a60: 2069 6620 6e6f 7420 7573 655f 7265 6369   if not use_reci
+00039a70: 7069 656e 743a 0a20 2020 2020 2020 2020  pient:.         
+00039a80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00039a90: 6b69 7070 6564 5f72 6563 6970 6965 6e74  kipped_recipient
+00039aa0: 732e 6170 7065 6e64 2868 6561 7071 2e68  s.append(heapq.h
+00039ab0: 6561 7070 6f70 2872 6563 6970 6965 6e74  eappop(recipient
+00039ac0: 7329 290a 0a20 2020 2020 2020 2020 2020  s))..           
+00039ad0: 2020 2020 2066 6f72 2072 6563 6970 6965       for recipie
+00039ae0: 6e74 2069 6e20 736b 6970 7065 645f 7265  nt in skipped_re
+00039af0: 6369 7069 656e 7473 3a0a 2020 2020 2020  cipients:.      
+00039b00: 2020 2020 2020 2020 2020 2020 2020 6865                he
+00039b10: 6170 712e 6865 6170 7075 7368 2872 6563  apq.heappush(rec
+00039b20: 6970 6965 6e74 732c 2072 6563 6970 6965  ipients, recipie
+00039b30: 6e74 290a 0a20 2020 2020 2020 2020 2020  nt)..           
+00039b40: 2020 2020 2069 6620 6e6f 7420 7573 655f       if not use_
+00039b50: 7265 6369 7069 656e 743a 0a20 2020 2020  recipient:.     
+00039b60: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00039b70: 2054 6869 7320 7461 736b 2068 6173 206e   This task has n
+00039b80: 6f20 7265 6369 7069 656e 7473 2061 7661  o recipients ava
+00039b90: 696c 6162 6c65 2e20 4c65 6176 6520 6974  ilable. Leave it
+00039ba0: 206f 6e20 7468 6520 7365 6e64 6572 2061   on the sender a
+00039bb0: 6e64 0a20 2020 2020 2020 2020 2020 2020  nd.             
+00039bc0: 2020 2020 2020 2023 206d 6f76 6520 6f6e         # move on
+00039bd0: 2074 6f20 7468 6520 6e65 7874 2074 6173   to the next tas
+00039be0: 6b20 6f66 2074 6865 2073 616d 6520 7365  k of the same se
+00039bf0: 6e64 6572 2e0a 2020 2020 2020 2020 2020  nder..          
+00039c00: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+00039c10: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
+00039c20: 2020 2020 2320 5363 6865 6475 6c65 2074      # Schedule t
+00039c30: 6173 6b20 666f 7220 7472 616e 7366 6572  ask for transfer
+00039c40: 2066 726f 6d20 7365 6e64 6572 2074 6f20   from sender to 
+00039c50: 7265 6369 7069 656e 740a 2020 2020 2020  recipient.      
+00039c60: 2020 2020 2020 2020 2020 6d73 6773 2e61            msgs.a
+00039c70: 7070 656e 6428 2873 6e64 5f77 732c 2072  ppend((snd_ws, r
+00039c80: 6563 5f77 732c 2074 7329 290a 0a20 2020  ec_ws, ts))..   
+00039c90: 2020 2020 2020 2020 2020 2020 2023 202a               # *
+00039ca0: 5f62 7974 6573 5f6d 6178 2f6d 696e 2061  _bytes_max/min a
+00039cb0: 7265 2061 6c6c 206e 6567 6174 6976 6520  re all negative 
+00039cc0: 666f 7220 6865 6170 2073 6f72 7469 6e67  for heap sorting
+00039cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039ce0: 2073 6e64 5f62 7974 6573 5f6d 6178 202b   snd_bytes_max +
+00039cf0: 3d20 6e62 7974 6573 0a20 2020 2020 2020  = nbytes.       
+00039d00: 2020 2020 2020 2020 2073 6e64 5f62 7974           snd_byt
+00039d10: 6573 5f6d 696e 202b 3d20 6e62 7974 6573  es_min += nbytes
+00039d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039d30: 2072 6563 5f62 7974 6573 5f6d 6178 202b   rec_bytes_max +
+00039d40: 3d20 6e62 7974 6573 0a20 2020 2020 2020  = nbytes.       
+00039d50: 2020 2020 2020 2020 2072 6563 5f62 7974           rec_byt
+00039d60: 6573 5f6d 696e 202b 3d20 6e62 7974 6573  es_min += nbytes
+00039d70: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00039d80: 2020 2320 5374 6f70 2069 7465 7261 7469    # Stop iterati
+00039d90: 6e67 206f 6e20 7468 6520 7461 736b 7320  ng on the tasks 
+00039da0: 6f66 2074 6869 7320 7365 6e64 6572 2066  of this sender f
+00039db0: 6f72 206e 6f77 2061 6e64 2c20 6966 2069  or now and, if i
+00039dc0: 7420 7374 696c 6c0a 2020 2020 2020 2020  t still.        
+00039dd0: 2020 2020 2020 2020 2320 6861 7320 6279          # has by
+00039de0: 7465 7320 746f 206c 6f73 652c 2070 7573  tes to lose, pus
+00039df0: 6820 6974 2062 6163 6b20 696e 746f 2074  h it back into t
+00039e00: 6865 2073 656e 6465 7273 2068 6561 703b  he senders heap;
+00039e10: 2069 7420 6d61 7920 6f72 206d 6179 0a20   it may or may. 
+00039e20: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00039e30: 206e 6f74 2063 6f6d 6520 6261 636b 206f   not come back o
+00039e40: 6e20 746f 7020 6167 6169 6e2e 0a20 2020  n top again..   
+00039e50: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00039e60: 736e 645f 6279 7465 735f 6d69 6e20 3c20  snd_bytes_min < 
+00039e70: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+00039e80: 2020 2020 2020 2023 2053 6565 2064 6566         # See def
+00039e90: 696e 6974 696f 6e20 6f66 2073 656e 6465  inition of sende
+00039ea0: 7273 2061 626f 7665 0a20 2020 2020 2020  rs above.       
+00039eb0: 2020 2020 2020 2020 2020 2020 2068 6561               hea
+00039ec0: 7071 2e68 6561 7072 6570 6c61 6365 280a  pq.heapreplace(.
+00039ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039ee0: 2020 2020 2020 2020 7365 6e64 6572 732c          senders,
+00039ef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039f00: 2020 2020 2020 2020 2028 736e 645f 6279           (snd_by
+00039f10: 7465 735f 6d61 782c 2073 6e64 5f62 7974  tes_max, snd_byt
+00039f20: 6573 5f6d 696e 2c20 6964 2873 6e64 5f77  es_min, id(snd_w
+00039f30: 7329 2c20 736e 645f 7773 2c20 7473 5f69  s), snd_ws, ts_i
+00039f40: 7465 7229 2c0a 2020 2020 2020 2020 2020  ter),.          
+00039f50: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00039f60: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00039f70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00039f80: 2020 2020 2020 6865 6170 712e 6865 6170        heapq.heap
+00039f90: 706f 7028 7365 6e64 6572 7329 0a0a 2020  pop(senders)..  
+00039fa0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00039fb0: 4966 2072 6563 6970 6965 6e74 2073 7469  If recipient sti
+00039fc0: 6c6c 2068 6173 2062 7974 6573 2074 6f20  ll has bytes to 
+00039fd0: 6761 696e 2c20 7075 7368 2069 7420 6261  gain, push it ba
+00039fe0: 636b 2069 6e74 6f20 7468 6520 7265 6369  ck into the reci
+00039ff0: 7069 656e 7473 0a20 2020 2020 2020 2020  pients.         
+0003a000: 2020 2020 2020 2023 2068 6561 703b 2069         # heap; i
+0003a010: 7420 6d61 7920 6f72 206d 6179 206e 6f74  t may or may not
+0003a020: 2063 6f6d 6520 6261 636b 206f 6e20 746f   come back on to
+0003a030: 7020 6167 6169 6e2e 0a20 2020 2020 2020  p again..       
+0003a040: 2020 2020 2020 2020 2069 6620 7265 635f           if rec_
+0003a050: 6279 7465 735f 6d69 6e20 3c20 303a 0a20  bytes_min < 0:. 
+0003a060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a070: 2020 2023 2053 6565 2064 6566 696e 6974     # See definit
+0003a080: 696f 6e20 6f66 2072 6563 6970 6965 6e74  ion of recipient
+0003a090: 7320 6162 6f76 650a 2020 2020 2020 2020  s above.        
+0003a0a0: 2020 2020 2020 2020 2020 2020 6865 6170              heap
+0003a0b0: 712e 6865 6170 7265 706c 6163 6528 0a20  q.heapreplace(. 
+0003a0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a0d0: 2020 2020 2020 2072 6563 6970 6965 6e74         recipient
+0003a0e0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+0003a0f0: 2020 2020 2020 2020 2020 2028 7265 635f             (rec_
+0003a100: 6279 7465 735f 6d61 782c 2072 6563 5f62  bytes_max, rec_b
+0003a110: 7974 6573 5f6d 696e 2c20 6964 2872 6563  ytes_min, id(rec
+0003a120: 5f77 7329 2c20 7265 635f 7773 292c 0a20  _ws), rec_ws),. 
+0003a130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a140: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0003a150: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0003a160: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+0003a170: 6561 7071 2e68 6561 7070 6f70 2872 6563  eapq.heappop(rec
+0003a180: 6970 6965 6e74 7329 0a0a 2020 2020 2020  ipients)..      
+0003a190: 2020 2020 2020 2020 2020 2320 4d6f 7665            # Move
+0003a1a0: 2074 6f20 6e65 7874 2073 656e 6465 7220   to next sender 
+0003a1b0: 7769 7468 2074 6865 206d 6f73 7420 6461  with the most da
+0003a1c0: 7461 2074 6f20 6c6f 7365 2e0a 2020 2020  ta to lose..    
+0003a1d0: 2020 2020 2020 2020 2020 2020 2320 4974              # It
+0003a1e0: 206d 6179 206f 7220 6d61 7920 6e6f 7420   may or may not 
+0003a1f0: 6265 2074 6865 2073 616d 6520 7365 6e64  be the same send
+0003a200: 6572 2061 6761 696e 2e0a 2020 2020 2020  er again..      
+0003a210: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
+0003a220: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0003a230: 653a 2020 2320 666f 7220 7473 2069 6e20  e:  # for ts in 
+0003a240: 7473 5f69 7465 720a 2020 2020 2020 2020  ts_iter.        
+0003a250: 2020 2020 2020 2020 2320 4578 6861 7573          # Exhaus
+0003a260: 7465 6420 7461 736b 7320 6f6e 2074 6869  ted tasks on thi
+0003a270: 7320 7365 6e64 6572 0a20 2020 2020 2020  s sender.       
+0003a280: 2020 2020 2020 2020 2068 6561 7071 2e68           heapq.h
+0003a290: 6561 7070 6f70 2873 656e 6465 7273 290a  eappop(senders).
+0003a2a0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0003a2b0: 6d73 6773 0a0a 2020 2020 6173 796e 6320  msgs..    async 
+0003a2c0: 6465 6620 5f72 6562 616c 616e 6365 5f6d  def _rebalance_m
+0003a2d0: 6f76 655f 6461 7461 280a 2020 2020 2020  ove_data(.      
+0003a2e0: 2020 7365 6c66 2c20 6d73 6773 3a20 226c    self, msgs: "l
+0003a2f0: 6973 745b 7475 706c 655b 576f 726b 6572  ist[tuple[Worker
+0003a300: 5374 6174 652c 2057 6f72 6b65 7253 7461  State, WorkerSta
+0003a310: 7465 2c20 5461 736b 5374 6174 655d 5d22  te, TaskState]]"
+0003a320: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
+0003a330: 7472 0a20 2020 2029 202d 3e20 6469 6374  tr.    ) -> dict
+0003a340: 3a0a 2020 2020 2020 2020 2222 2250 6572  :.        """Per
+0003a350: 666f 726d 2074 6865 2061 6374 7561 6c20  form the actual 
+0003a360: 7472 616e 7366 6572 206f 6620 6461 7461  transfer of data
+0003a370: 2061 6372 6f73 7320 7468 6520 6e65 7477   across the netw
+0003a380: 6f72 6b20 696e 2072 6562 616c 616e 6365  ork in rebalance
+0003a390: 2829 2e0a 2020 2020 2020 2020 5461 6b65  ()..        Take
+0003a3a0: 7320 696e 2069 6e70 7574 2074 6865 206f  s in input the o
+0003a3b0: 7574 7075 7420 6f66 205f 7265 6261 6c61  utput of _rebala
+0003a3c0: 6e63 655f 6669 6e64 5f6d 7367 7328 292c  nce_find_msgs(),
+0003a3d0: 2074 6861 7420 6973 2061 206c 6973 7420   that is a list 
+0003a3e0: 6f66 2074 7570 6c65 733a 0a0a 2020 2020  of tuples:..    
+0003a3f0: 2020 2020 2d20 7365 6e64 6572 2077 6f72      - sender wor
+0003a400: 6b65 720a 2020 2020 2020 2020 2d20 7265  ker.        - re
+0003a410: 6369 7069 656e 7420 776f 726b 6572 0a20  cipient worker. 
+0003a420: 2020 2020 2020 202d 2074 6173 6b20 746f         - task to
+0003a430: 2062 6520 7472 616e 7366 6572 7265 640a   be transferred.
+0003a440: 0a20 2020 2020 2020 2046 4958 4d45 2074  .        FIXME t
+0003a450: 6869 7320 6d65 7468 6f64 2069 7320 6e6f  his method is no
+0003a460: 7420 726f 6275 7374 2077 6865 6e20 7468  t robust when th
+0003a470: 6520 636c 7573 7465 7220 6973 206e 6f74  e cluster is not
+0003a480: 2069 646c 652e 0a20 2020 2020 2020 2022   idle..        "
+0003a490: 2222 0a20 2020 2020 2020 2074 6f5f 7265  "".        to_re
+0003a4a0: 6369 7069 656e 7473 3a20 6465 6661 756c  cipients: defaul
+0003a4b0: 7464 6963 745b 7374 722c 2064 6566 6175  tdict[str, defau
+0003a4c0: 6c74 6469 6374 5b73 7472 2c20 6c69 7374  ltdict[str, list
+0003a4d0: 5b73 7472 5d5d 5d20 3d20 6465 6661 756c  [str]]] = defaul
+0003a4e0: 7464 6963 7428 0a20 2020 2020 2020 2020  tdict(.         
+0003a4f0: 2020 206c 616d 6264 613a 2064 6566 6175     lambda: defau
+0003a500: 6c74 6469 6374 286c 6973 7429 0a20 2020  ltdict(list).   
+0003a510: 2020 2020 2029 0a20 2020 2020 2020 2066       ).        f
+0003a520: 6f72 2073 6e64 5f77 732c 2072 6563 5f77  or snd_ws, rec_w
+0003a530: 732c 2074 7320 696e 206d 7367 733a 0a20  s, ts in msgs:. 
+0003a540: 2020 2020 2020 2020 2020 2074 6f5f 7265             to_re
+0003a550: 6369 7069 656e 7473 5b72 6563 5f77 732e  cipients[rec_ws.
+0003a560: 6164 6472 6573 735d 5b74 732e 6b65 795d  address][ts.key]
+0003a570: 2e61 7070 656e 6428 736e 645f 7773 2e61  .append(snd_ws.a
+0003a580: 6464 7265 7373 290a 2020 2020 2020 2020  ddress).        
+0003a590: 6661 696c 6564 5f6b 6579 735f 6279 5f72  failed_keys_by_r
+0003a5a0: 6563 6970 6965 6e74 203d 2064 6963 7428  ecipient = dict(
+0003a5b0: 0a20 2020 2020 2020 2020 2020 207a 6970  .            zip
+0003a5c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0003a5d0: 2020 746f 5f72 6563 6970 6965 6e74 732c    to_recipients,
+0003a5e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a5f0: 2061 7761 6974 2061 7379 6e63 696f 2e67   await asyncio.g
+0003a600: 6174 6865 7228 0a20 2020 2020 2020 2020  ather(.         
+0003a610: 2020 2020 2020 2020 2020 202a 280a 2020             *(.  
+0003a620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a630: 2020 2020 2020 2320 4e6f 7465 3a20 7468        # Note: th
+0003a640: 6973 206e 6576 6572 2072 6169 7365 7320  is never raises 
+0003a650: 6578 6365 7074 696f 6e73 0a20 2020 2020  exceptions.     
+0003a660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a670: 2020 2073 656c 662e 6761 7468 6572 5f6f     self.gather_o
+0003a680: 6e5f 776f 726b 6572 2877 2c20 7768 6f5f  n_worker(w, who_
+0003a690: 6861 7329 0a20 2020 2020 2020 2020 2020  has).           
+0003a6a0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0003a6b0: 2077 2c20 7768 6f5f 6861 7320 696e 2074   w, who_has in t
+0003a6c0: 6f5f 7265 6369 7069 656e 7473 2e69 7465  o_recipients.ite
+0003a6d0: 6d73 2829 0a20 2020 2020 2020 2020 2020  ms().           
+0003a6e0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0003a6f0: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
+0003a700: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0003a710: 2020 2020 290a 0a20 2020 2020 2020 2074      )..        t
+0003a720: 6f5f 7365 6e64 6572 7320 3d20 6465 6661  o_senders = defa
+0003a730: 756c 7464 6963 7428 6c69 7374 290a 2020  ultdict(list).  
+0003a740: 2020 2020 2020 666f 7220 736e 645f 7773        for snd_ws
+0003a750: 2c20 7265 635f 7773 2c20 7473 2069 6e20  , rec_ws, ts in 
+0003a760: 6d73 6773 3a0a 2020 2020 2020 2020 2020  msgs:.          
+0003a770: 2020 6966 2074 732e 6b65 7920 6e6f 7420    if ts.key not 
+0003a780: 696e 2066 6169 6c65 645f 6b65 7973 5f62  in failed_keys_b
+0003a790: 795f 7265 6369 7069 656e 745b 7265 635f  y_recipient[rec_
+0003a7a0: 7773 2e61 6464 7265 7373 5d3a 0a20 2020  ws.address]:.   
+0003a7b0: 2020 2020 2020 2020 2020 2020 2074 6f5f               to_
+0003a7c0: 7365 6e64 6572 735b 736e 645f 7773 2e61  senders[snd_ws.a
+0003a7d0: 6464 7265 7373 5d2e 6170 7065 6e64 2874  ddress].append(t
+0003a7e0: 732e 6b65 7929 0a0a 2020 2020 2020 2020  s.key)..        
+0003a7f0: 2320 4e6f 7465 3a20 7468 6973 206e 6576  # Note: this nev
+0003a800: 6572 2072 6169 7365 7320 6578 6365 7074  er raises except
+0003a810: 696f 6e73 0a20 2020 2020 2020 2061 7761  ions.        awa
+0003a820: 6974 2061 7379 6e63 696f 2e67 6174 6865  it asyncio.gathe
+0003a830: 7228 0a20 2020 2020 2020 2020 2020 202a  r(.            *
+0003a840: 2873 656c 662e 6465 6c65 7465 5f77 6f72  (self.delete_wor
+0003a850: 6b65 725f 6461 7461 2872 2c20 762c 2073  ker_data(r, v, s
+0003a860: 7469 6d75 6c75 735f 6964 2920 666f 7220  timulus_id) for 
+0003a870: 722c 2076 2069 6e20 746f 5f73 656e 6465  r, v in to_sende
+0003a880: 7273 2e69 7465 6d73 2829 290a 2020 2020  rs.items()).    
+0003a890: 2020 2020 290a 0a20 2020 2020 2020 2066      )..        f
+0003a8a0: 6f72 2072 2c20 7620 696e 2074 6f5f 7265  or r, v in to_re
+0003a8b0: 6369 7069 656e 7473 2e69 7465 6d73 2829  cipients.items()
+0003a8c0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0003a8d0: 6c66 2e6c 6f67 5f65 7665 6e74 2872 2c20  lf.log_event(r, 
+0003a8e0: 7b22 6163 7469 6f6e 223a 2022 7265 6261  {"action": "reba
+0003a8f0: 6c61 6e63 6522 2c20 2277 686f 5f68 6173  lance", "who_has
+0003a900: 223a 2076 7d29 0a20 2020 2020 2020 2073  ": v}).        s
+0003a910: 656c 662e 6c6f 675f 6576 656e 7428 0a20  elf.log_event(. 
+0003a920: 2020 2020 2020 2020 2020 2022 616c 6c22             "all"
+0003a930: 2c0a 2020 2020 2020 2020 2020 2020 7b0a  ,.            {.
+0003a940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a950: 2261 6374 696f 6e22 3a20 2272 6562 616c  "action": "rebal
+0003a960: 616e 6365 222c 0a20 2020 2020 2020 2020  ance",.         
+0003a970: 2020 2020 2020 2022 7365 6e64 6572 7322         "senders"
+0003a980: 3a20 7661 6c6d 6170 286c 656e 2c20 746f  : valmap(len, to
+0003a990: 5f73 656e 6465 7273 292c 0a20 2020 2020  _senders),.     
+0003a9a0: 2020 2020 2020 2020 2020 2022 7265 6369             "reci
+0003a9b0: 7069 656e 7473 223a 2076 616c 6d61 7028  pients": valmap(
+0003a9c0: 6c65 6e2c 2074 6f5f 7265 6369 7069 656e  len, to_recipien
+0003a9d0: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
+0003a9e0: 2020 2020 2022 6d6f 7665 645f 6b65 7973       "moved_keys
+0003a9f0: 223a 206c 656e 286d 7367 7329 2c0a 2020  ": len(msgs),.  
+0003aa00: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
+0003aa10: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0003aa20: 6d69 7373 696e 675f 6b65 7973 203d 207b  missing_keys = {
+0003aa30: 6b20 666f 7220 7220 696e 2066 6169 6c65  k for r in faile
+0003aa40: 645f 6b65 7973 5f62 795f 7265 6369 7069  d_keys_by_recipi
+0003aa50: 656e 742e 7661 6c75 6573 2829 2066 6f72  ent.values() for
+0003aa60: 206b 2069 6e20 727d 0a20 2020 2020 2020   k in r}.       
+0003aa70: 2069 6620 6d69 7373 696e 675f 6b65 7973   if missing_keys
+0003aa80: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0003aa90: 7475 726e 207b 2273 7461 7475 7322 3a20  turn {"status": 
+0003aaa0: 2270 6172 7469 616c 2d66 6169 6c22 2c20  "partial-fail", 
+0003aab0: 226b 6579 7322 3a20 6c69 7374 286d 6973  "keys": list(mis
+0003aac0: 7369 6e67 5f6b 6579 7329 7d0a 2020 2020  sing_keys)}.    
+0003aad0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0003aae0: 2020 2020 2020 7265 7475 726e 207b 2273        return {"s
+0003aaf0: 7461 7475 7322 3a20 224f 4b22 7d0a 0a20  tatus": "OK"}.. 
+0003ab00: 2020 2061 7379 6e63 2064 6566 2072 6570     async def rep
+0003ab10: 6c69 6361 7465 280a 2020 2020 2020 2020  licate(.        
+0003ab20: 7365 6c66 2c0a 2020 2020 2020 2020 636f  self,.        co
+0003ab30: 6d6d 3d4e 6f6e 652c 0a20 2020 2020 2020  mm=None,.       
+0003ab40: 206b 6579 733d 4e6f 6e65 2c0a 2020 2020   keys=None,.    
+0003ab50: 2020 2020 6e3d 4e6f 6e65 2c0a 2020 2020      n=None,.    
+0003ab60: 2020 2020 776f 726b 6572 733d 4e6f 6e65      workers=None
+0003ab70: 2c0a 2020 2020 2020 2020 6272 616e 6368  ,.        branch
+0003ab80: 696e 675f 6661 6374 6f72 3d32 2c0a 2020  ing_factor=2,.  
+0003ab90: 2020 2020 2020 6465 6c65 7465 3d54 7275        delete=Tru
+0003aba0: 652c 0a20 2020 2020 2020 206c 6f63 6b3d  e,.        lock=
+0003abb0: 5472 7565 2c0a 2020 2020 2020 2020 7374  True,.        st
+0003abc0: 696d 756c 7573 5f69 643d 4e6f 6e65 2c0a  imulus_id=None,.
+0003abd0: 2020 2020 293a 0a20 2020 2020 2020 2022      ):.        "
+0003abe0: 2222 5265 706c 6963 6174 6520 6461 7461  ""Replicate data
+0003abf0: 2074 6872 6f75 6768 6f75 7420 636c 7573   throughout clus
+0003ac00: 7465 720a 0a20 2020 2020 2020 2054 6869  ter..        Thi
+0003ac10: 7320 7065 7266 6f72 6d73 2061 2074 7265  s performs a tre
+0003ac20: 6520 636f 7079 206f 6620 7468 6520 6461  e copy of the da
+0003ac30: 7461 2074 6872 6f75 6768 6f75 7420 7468  ta throughout th
+0003ac40: 6520 6e65 7477 6f72 6b0a 2020 2020 2020  e network.      
+0003ac50: 2020 696e 6469 7669 6475 616c 6c79 206f    individually o
+0003ac60: 6e20 6561 6368 2070 6965 6365 206f 6620  n each piece of 
+0003ac70: 6461 7461 2e0a 0a20 2020 2020 2020 2050  data...        P
+0003ac80: 6172 616d 6574 6572 730a 2020 2020 2020  arameters.      
+0003ac90: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
+0003aca0: 2020 2020 206b 6579 733a 2049 7465 7261       keys: Itera
+0003acb0: 626c 650a 2020 2020 2020 2020 2020 2020  ble.            
+0003acc0: 6c69 7374 206f 6620 6b65 7973 2074 6f20  list of keys to 
+0003acd0: 7265 706c 6963 6174 650a 2020 2020 2020  replicate.      
+0003ace0: 2020 6e3a 2069 6e74 0a20 2020 2020 2020    n: int.       
+0003acf0: 2020 2020 204e 756d 6265 7220 6f66 2072       Number of r
+0003ad00: 6570 6c69 6361 7469 6f6e 7320 7765 2065  eplications we e
+0003ad10: 7870 6563 7420 746f 2073 6565 2077 6974  xpect to see wit
+0003ad20: 6869 6e20 7468 6520 636c 7573 7465 720a  hin the cluster.
+0003ad30: 2020 2020 2020 2020 6272 616e 6368 696e          branchin
+0003ad40: 675f 6661 6374 6f72 3a20 696e 742c 206f  g_factor: int, o
+0003ad50: 7074 696f 6e61 6c0a 2020 2020 2020 2020  ptional.        
+0003ad60: 2020 2020 5468 6520 6e75 6d62 6572 206f      The number o
+0003ad70: 6620 776f 726b 6572 7320 7468 6174 2063  f workers that c
+0003ad80: 616e 2063 6f70 7920 6461 7461 2069 6e20  an copy data in 
+0003ad90: 6561 6368 2067 656e 6572 6174 696f 6e2e  each generation.
+0003ada0: 0a20 2020 2020 2020 2020 2020 2054 6865  .            The
+0003adb0: 206c 6172 6765 7220 7468 6520 6272 616e   larger the bran
+0003adc0: 6368 696e 6720 6661 6374 6f72 2c20 7468  ching factor, th
+0003add0: 6520 6d6f 7265 2064 6174 6120 7765 2063  e more data we c
+0003ade0: 6f70 7920 696e 0a20 2020 2020 2020 2020  opy in.         
+0003adf0: 2020 2061 2073 696e 676c 6520 7374 6570     a single step
+0003ae00: 2c20 6275 7420 7468 6520 6d6f 7265 2061  , but the more a
+0003ae10: 2067 6976 656e 2077 6f72 6b65 7220 7269   given worker ri
+0003ae20: 736b 7320 6265 696e 670a 2020 2020 2020  sks being.      
+0003ae30: 2020 2020 2020 7377 616d 7065 6420 6279        swamped by
+0003ae40: 2064 6174 6120 7265 7175 6573 7473 2e0a   data requests..
+0003ae50: 0a20 2020 2020 2020 2053 6565 2061 6c73  .        See als
+0003ae60: 6f0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  o.        ------
+0003ae70: 2d2d 0a20 2020 2020 2020 2053 6368 6564  --.        Sched
+0003ae80: 756c 6572 2e72 6562 616c 616e 6365 0a20  uler.rebalance. 
+0003ae90: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0003aea0: 2020 2073 7469 6d75 6c75 735f 6964 203d     stimulus_id =
+0003aeb0: 2073 7469 6d75 6c75 735f 6964 206f 7220   stimulus_id or 
+0003aec0: 6622 7265 706c 6963 6174 652d 7b74 696d  f"replicate-{tim
+0003aed0: 6528 297d 220a 2020 2020 2020 2020 6173  e()}".        as
+0003aee0: 7365 7274 2062 7261 6e63 6869 6e67 5f66  sert branching_f
+0003aef0: 6163 746f 7220 3e20 300a 2020 2020 2020  actor > 0.      
+0003af00: 2020 6173 796e 6320 7769 7468 2073 656c    async with sel
+0003af10: 662e 5f6c 6f63 6b20 6966 206c 6f63 6b20  f._lock if lock 
+0003af20: 656c 7365 2065 6d70 7479 5f63 6f6e 7465  else empty_conte
+0003af30: 7874 3a0a 2020 2020 2020 2020 2020 2020  xt:.            
+0003af40: 6966 2077 6f72 6b65 7273 2069 7320 6e6f  if workers is no
+0003af50: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0003af60: 2020 2020 2020 2020 776f 726b 6572 7320          workers 
+0003af70: 3d20 7b73 656c 662e 776f 726b 6572 735b  = {self.workers[
+0003af80: 775d 2066 6f72 2077 2069 6e20 7365 6c66  w] for w in self
+0003af90: 2e77 6f72 6b65 7273 5f6c 6973 7428 776f  .workers_list(wo
+0003afa0: 726b 6572 7329 7d0a 2020 2020 2020 2020  rkers)}.        
+0003afb0: 2020 2020 2020 2020 776f 726b 6572 7320          workers 
+0003afc0: 3d20 7b77 7320 666f 7220 7773 2069 6e20  = {ws for ws in 
+0003afd0: 776f 726b 6572 7320 6966 2077 732e 7374  workers if ws.st
+0003afe0: 6174 7573 203d 3d20 5374 6174 7573 2e72  atus == Status.r
+0003aff0: 756e 6e69 6e67 7d0a 2020 2020 2020 2020  unning}.        
+0003b000: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0003b010: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+0003b020: 7320 3d20 7365 6c66 2e72 756e 6e69 6e67  s = self.running
+0003b030: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+0003b040: 206e 2069 7320 4e6f 6e65 3a0a 2020 2020   n is None:.    
+0003b050: 2020 2020 2020 2020 2020 2020 6e20 3d20              n = 
+0003b060: 6c65 6e28 776f 726b 6572 7329 0a20 2020  len(workers).   
+0003b070: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0003b080: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0003b090: 203d 206d 696e 286e 2c20 6c65 6e28 776f   = min(n, len(wo
+0003b0a0: 726b 6572 7329 290a 2020 2020 2020 2020  rkers)).        
+0003b0b0: 2020 2020 6966 206e 203d 3d20 303a 0a20      if n == 0:. 
+0003b0c0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0003b0d0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+0003b0e0: 2243 616e 206e 6f74 2075 7365 2072 6570  "Can not use rep
+0003b0f0: 6c69 6361 7465 2074 6f20 6465 6c65 7465  licate to delete
+0003b100: 2064 6174 6122 290a 0a20 2020 2020 2020   data")..       
+0003b110: 2020 2020 2074 6173 6b73 203d 207b 7365       tasks = {se
+0003b120: 6c66 2e74 6173 6b73 5b6b 5d20 666f 7220  lf.tasks[k] for 
+0003b130: 6b20 696e 206b 6579 737d 0a20 2020 2020  k in keys}.     
+0003b140: 2020 2020 2020 206d 6973 7369 6e67 5f64         missing_d
+0003b150: 6174 6120 3d20 5b74 732e 6b65 7920 666f  ata = [ts.key fo
+0003b160: 7220 7473 2069 6e20 7461 736b 7320 6966  r ts in tasks if
+0003b170: 206e 6f74 2074 732e 7768 6f5f 6861 735d   not ts.who_has]
+0003b180: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0003b190: 6d69 7373 696e 675f 6461 7461 3a0a 2020  missing_data:.  
+0003b1a0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0003b1b0: 7475 726e 207b 2273 7461 7475 7322 3a20  turn {"status": 
+0003b1c0: 2270 6172 7469 616c 2d66 6169 6c22 2c20  "partial-fail", 
+0003b1d0: 226b 6579 7322 3a20 6d69 7373 696e 675f  "keys": missing_
+0003b1e0: 6461 7461 7d0a 0a20 2020 2020 2020 2020  data}..         
+0003b1f0: 2020 2023 2044 656c 6574 6520 6578 7472     # Delete extr
+0003b200: 616e 656f 7573 2064 6174 610a 2020 2020  aneous data.    
+0003b210: 2020 2020 2020 2020 6966 2064 656c 6574          if delet
+0003b220: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0003b230: 2020 2064 656c 5f77 6f72 6b65 725f 7461     del_worker_ta
+0003b240: 736b 7320 3d20 6465 6661 756c 7464 6963  sks = defaultdic
+0003b250: 7428 7365 7429 0a20 2020 2020 2020 2020  t(set).         
+0003b260: 2020 2020 2020 2066 6f72 2074 7320 696e         for ts in
+0003b270: 2074 6173 6b73 3a0a 2020 2020 2020 2020   tasks:.        
+0003b280: 2020 2020 2020 2020 2020 2020 6465 6c5f              del_
+0003b290: 6361 6e64 6964 6174 6573 203d 2074 7570  candidates = tup
+0003b2a0: 6c65 2874 732e 7768 6f5f 6861 7320 2620  le(ts.who_has & 
+0003b2b0: 776f 726b 6572 7329 0a20 2020 2020 2020  workers).       
+0003b2c0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0003b2d0: 6c65 6e28 6465 6c5f 6361 6e64 6964 6174  len(del_candidat
+0003b2e0: 6573 2920 3e20 6e3a 0a20 2020 2020 2020  es) > n:.       
+0003b2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b300: 2066 6f72 2077 7320 696e 2072 616e 646f   for ws in rando
+0003b310: 6d2e 7361 6d70 6c65 280a 2020 2020 2020  m.sample(.      
+0003b320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b330: 2020 2020 2020 6465 6c5f 6361 6e64 6964        del_candid
+0003b340: 6174 6573 2c20 6c65 6e28 6465 6c5f 6361  ates, len(del_ca
+0003b350: 6e64 6964 6174 6573 2920 2d20 6e0a 2020  ndidates) - n.  
+0003b360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b370: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
+0003b380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b390: 2020 2020 2064 656c 5f77 6f72 6b65 725f       del_worker_
+0003b3a0: 7461 736b 735b 7773 5d2e 6164 6428 7473  tasks[ws].add(ts
+0003b3b0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0003b3c0: 2020 2023 204e 6f74 653a 2074 6869 7320     # Note: this 
+0003b3d0: 6e65 7665 7220 7261 6973 6573 2065 7863  never raises exc
+0003b3e0: 6570 7469 6f6e 730a 2020 2020 2020 2020  eptions.        
+0003b3f0: 2020 2020 2020 2020 6177 6169 7420 6173          await as
+0003b400: 796e 6369 6f2e 6761 7468 6572 280a 2020  yncio.gather(.  
+0003b410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b420: 2020 2a5b 0a20 2020 2020 2020 2020 2020    *[.           
+0003b430: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0003b440: 662e 6465 6c65 7465 5f77 6f72 6b65 725f  f.delete_worker_
+0003b450: 6461 7461 280a 2020 2020 2020 2020 2020  data(.          
+0003b460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b470: 2020 7773 2e61 6464 7265 7373 2c20 5b74    ws.address, [t
+0003b480: 2e6b 6579 2066 6f72 2074 2069 6e20 7461  .key for t in ta
+0003b490: 736b 735d 2c20 7374 696d 756c 7573 5f69  sks], stimulus_i
+0003b4a0: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+0003b4b0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0003b4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b4d0: 2020 2020 666f 7220 7773 2c20 7461 736b      for ws, task
+0003b4e0: 7320 696e 2064 656c 5f77 6f72 6b65 725f  s in del_worker_
+0003b4f0: 7461 736b 732e 6974 656d 7328 290a 2020  tasks.items().  
+0003b500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b510: 2020 5d0a 2020 2020 2020 2020 2020 2020    ].            
+0003b520: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+0003b530: 2020 2023 2043 6f70 7920 6e6f 742d 7965     # Copy not-ye
+0003b540: 742d 6669 6c6c 6564 2064 6174 610a 2020  t-filled data.  
+0003b550: 2020 2020 2020 2020 2020 7768 696c 6520            while 
+0003b560: 7461 736b 733a 0a20 2020 2020 2020 2020  tasks:.         
+0003b570: 2020 2020 2020 2067 6174 6865 7273 203d         gathers =
+0003b580: 2064 6566 6175 6c74 6469 6374 2864 6963   defaultdict(dic
+0003b590: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
+0003b5a0: 2020 2066 6f72 2074 7320 696e 206c 6973     for ts in lis
+0003b5b0: 7428 7461 736b 7329 3a0a 2020 2020 2020  t(tasks):.      
+0003b5c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0003b5d0: 2074 732e 7374 6174 6520 3d3d 2022 666f   ts.state == "fo
+0003b5e0: 7267 6f74 7465 6e22 3a0a 2020 2020 2020  rgotten":.      
+0003b5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b600: 2020 2320 7461 736b 2069 7320 6e6f 206c    # task is no l
+0003b610: 6f6e 6765 7220 6e65 6564 6564 2062 7920  onger needed by 
+0003b620: 616e 7920 636c 6965 6e74 206f 7220 6465  any client or de
+0003b630: 7065 6e64 656e 7420 7461 736b 0a20 2020  pendent task.   
+0003b640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b650: 2020 2020 2074 6173 6b73 2e72 656d 6f76       tasks.remov
+0003b660: 6528 7473 290a 2020 2020 2020 2020 2020  e(ts).          
+0003b670: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0003b680: 6e74 696e 7565 0a20 2020 2020 2020 2020  ntinue.         
+0003b690: 2020 2020 2020 2020 2020 206e 5f6d 6973             n_mis
+0003b6a0: 7369 6e67 203d 206e 202d 206c 656e 2874  sing = n - len(t
+0003b6b0: 732e 7768 6f5f 6861 7320 2620 776f 726b  s.who_has & work
+0003b6c0: 6572 7329 0a20 2020 2020 2020 2020 2020  ers).           
+0003b6d0: 2020 2020 2020 2020 2069 6620 6e5f 6d69           if n_mi
+0003b6e0: 7373 696e 6720 3c3d 2030 3a0a 2020 2020  ssing <= 0:.    
+0003b6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b700: 2020 2020 2320 416c 7265 6164 7920 7265      # Already re
+0003b710: 706c 6963 6174 6564 2065 6e6f 7567 680a  plicated enough.
 0003b720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b730: 2023 204e 6f74 653a 2074 6869 7320 6e65   # Note: this ne
-0003b740: 7665 7220 7261 6973 6573 2065 7863 6570  ver raises excep
-0003b750: 7469 6f6e 730a 2020 2020 2020 2020 2020  tions.          
-0003b760: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0003b770: 6c66 2e67 6174 6865 725f 6f6e 5f77 6f72  lf.gather_on_wor
-0003b780: 6b65 7228 772c 2077 686f 5f68 6173 290a  ker(w, who_has).
-0003b790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b7a0: 2020 2020 2020 2020 666f 7220 772c 2077          for w, w
-0003b7b0: 686f 5f68 6173 2069 6e20 6761 7468 6572  ho_has in gather
-0003b7c0: 732e 6974 656d 7328 290a 2020 2020 2020  s.items().      
-0003b7d0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0003b730: 2020 2020 2020 2020 7461 736b 732e 7265          tasks.re
+0003b740: 6d6f 7665 2874 7329 0a20 2020 2020 2020  move(ts).       
+0003b750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b760: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
+0003b770: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0003b780: 6f75 6e74 203d 206d 696e 286e 5f6d 6973  ount = min(n_mis
+0003b790: 7369 6e67 2c20 6272 616e 6368 696e 675f  sing, branching_
+0003b7a0: 6661 6374 6f72 202a 206c 656e 2874 732e  factor * len(ts.
+0003b7b0: 7768 6f5f 6861 7329 290a 2020 2020 2020  who_has)).      
+0003b7c0: 2020 2020 2020 2020 2020 2020 2020 6173                as
+0003b7d0: 7365 7274 2063 6f75 6e74 203e 2030 0a0a  sert count > 0..
 0003b7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b7f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0003b800: 2020 666f 7220 722c 2076 2069 6e20 6761    for r, v in ga
-0003b810: 7468 6572 732e 6974 656d 7328 293a 0a20  thers.items():. 
-0003b820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b830: 2020 2073 656c 662e 6c6f 675f 6576 656e     self.log_even
-0003b840: 7428 722c 207b 2261 6374 696f 6e22 3a20  t(r, {"action": 
-0003b850: 2272 6570 6c69 6361 7465 2d61 6464 222c  "replicate-add",
-0003b860: 2022 7768 6f5f 6861 7322 3a20 767d 290a   "who_has": v}).
-0003b870: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0003b880: 662e 6c6f 675f 6576 656e 7428 0a20 2020  f.log_event(.   
-0003b890: 2020 2020 2020 2020 2020 2020 2022 616c               "al
-0003b8a0: 6c22 2c0a 2020 2020 2020 2020 2020 2020  l",.            
-0003b8b0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0003b8c0: 2020 2020 2020 2020 2020 2261 6374 696f            "actio
-0003b8d0: 6e22 3a20 2272 6570 6c69 6361 7465 222c  n": "replicate",
-0003b8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003b8f0: 2020 2020 2022 776f 726b 6572 7322 3a20       "workers": 
-0003b900: 6c69 7374 2877 6f72 6b65 7273 292c 0a20  list(workers),. 
-0003b910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b920: 2020 2022 6b65 792d 636f 756e 7422 3a20     "key-count": 
-0003b930: 6c65 6e28 6b65 7973 292c 0a20 2020 2020  len(keys),.     
-0003b940: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0003b950: 6272 616e 6368 696e 672d 6661 6374 6f72  branching-factor
-0003b960: 223a 2062 7261 6e63 6869 6e67 5f66 6163  ": branching_fac
-0003b970: 746f 722c 0a20 2020 2020 2020 2020 2020  tor,.           
-0003b980: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-0003b990: 2020 2020 290a 0a20 2020 2064 6566 2077      )..    def w
-0003b9a0: 6f72 6b65 7273 5f74 6f5f 636c 6f73 6528  orkers_to_close(
-0003b9b0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-0003b9c0: 2020 2020 2020 206d 656d 6f72 795f 7261         memory_ra
-0003b9d0: 7469 6f3a 2069 6e74 207c 2066 6c6f 6174  tio: int | float
-0003b9e0: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-0003b9f0: 2020 2020 2020 2020 6e3a 2069 6e74 207c          n: int |
-0003ba00: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-0003ba10: 2020 2020 2020 6b65 793a 2043 616c 6c61        key: Calla
-0003ba20: 626c 655b 5b57 6f72 6b65 7253 7461 7465  ble[[WorkerState
-0003ba30: 5d2c 2048 6173 6861 626c 655d 207c 2062  ], Hashable] | b
-0003ba40: 7974 6573 207c 204e 6f6e 6520 3d20 4e6f  ytes | None = No
-0003ba50: 6e65 2c0a 2020 2020 2020 2020 6d69 6e69  ne,.        mini
-0003ba60: 6d75 6d3a 2069 6e74 207c 204e 6f6e 6520  mum: int | None 
-0003ba70: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-0003ba80: 7461 7267 6574 3a20 696e 7420 7c20 4e6f  target: int | No
-0003ba90: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
-0003baa0: 2020 2061 7474 7269 6275 7465 3a20 7374     attribute: st
-0003bab0: 7220 3d20 2261 6464 7265 7373 222c 0a20  r = "address",. 
-0003bac0: 2020 2029 202d 3e20 6c69 7374 5b73 7472     ) -> list[str
-0003bad0: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
-0003bae0: 2020 2020 2020 2046 696e 6420 776f 726b         Find work
-0003baf0: 6572 7320 7468 6174 2077 6520 6361 6e20  ers that we can 
-0003bb00: 636c 6f73 6520 7769 7468 206c 6f77 2063  close with low c
-0003bb10: 6f73 740a 0a20 2020 2020 2020 2054 6869  ost..        Thi
-0003bb20: 7320 7265 7475 726e 7320 6120 6c69 7374  s returns a list
-0003bb30: 206f 6620 776f 726b 6572 7320 7468 6174   of workers that
-0003bb40: 2061 7265 2067 6f6f 6420 6361 6e64 6964   are good candid
-0003bb50: 6174 6573 2074 6f20 7265 7469 7265 2e0a  ates to retire..
-0003bb60: 2020 2020 2020 2020 5468 6573 6520 776f          These wo
-0003bb70: 726b 6572 7320 6172 6520 6e6f 7420 7275  rkers are not ru
-0003bb80: 6e6e 696e 6720 616e 7974 6869 6e67 2061  nning anything a
-0003bb90: 6e64 2061 7265 2073 746f 7269 6e67 0a20  nd are storing. 
-0003bba0: 2020 2020 2020 2072 656c 6174 6976 656c         relativel
-0003bbb0: 7920 6c69 7474 6c65 2064 6174 6120 7265  y little data re
-0003bbc0: 6c61 7469 7665 2074 6f20 7468 6569 7220  lative to their 
-0003bbd0: 7065 6572 732e 2020 4966 2061 6c6c 2077  peers.  If all w
-0003bbe0: 6f72 6b65 7273 2061 7265 0a20 2020 2020  orkers are.     
-0003bbf0: 2020 2069 646c 6520 7468 656e 2077 6520     idle then we 
-0003bc00: 7374 696c 6c20 6d61 696e 7461 696e 2065  still maintain e
-0003bc10: 6e6f 7567 6820 776f 726b 6572 7320 746f  nough workers to
-0003bc20: 2068 6176 6520 656e 6f75 6768 2052 414d   have enough RAM
-0003bc30: 2074 6f20 7374 6f72 650a 2020 2020 2020   to store.      
-0003bc40: 2020 6f75 7220 6461 7461 2c20 7769 7468    our data, with
-0003bc50: 2061 2063 6f6d 666f 7274 6162 6c65 2062   a comfortable b
-0003bc60: 7566 6665 722e 0a0a 2020 2020 2020 2020  uffer...        
-0003bc70: 5468 6973 2069 7320 666f 7220 7573 6520  This is for use 
-0003bc80: 7769 7468 2073 7973 7465 6d73 206c 696b  with systems lik
-0003bc90: 6520 6060 6469 7374 7269 6275 7465 642e  e ``distributed.
-0003bca0: 6465 706c 6f79 2e61 6461 7074 6976 6560  deploy.adaptive`
-0003bcb0: 602e 0a0a 2020 2020 2020 2020 5061 7261  `...        Para
-0003bcc0: 6d65 7465 7273 0a20 2020 2020 2020 202d  meters.        -
-0003bcd0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020  ---------.      
-0003bce0: 2020 6d65 6d6f 7279 5f72 6174 696f 203a    memory_ratio :
-0003bcf0: 204e 756d 6265 720a 2020 2020 2020 2020   Number.        
-0003bd00: 2020 2020 416d 6f75 6e74 206f 6620 6578      Amount of ex
-0003bd10: 7472 6120 7370 6163 6520 7765 2077 616e  tra space we wan
-0003bd20: 7420 746f 2068 6176 6520 666f 7220 6f75  t to have for ou
-0003bd30: 7220 7374 6f72 6564 2064 6174 612e 0a20  r stored data.. 
-0003bd40: 2020 2020 2020 2020 2020 2044 6566 6175             Defau
-0003bd50: 6c74 7320 746f 2032 2c20 6f72 2074 6861  lts to 2, or tha
-0003bd60: 7420 7765 2077 616e 7420 746f 2068 6176  t we want to hav
-0003bd70: 6520 7477 6963 6520 6173 206d 7563 6820  e twice as much 
-0003bd80: 6d65 6d6f 7279 2061 7320 7765 0a20 2020  memory as we.   
-0003bd90: 2020 2020 2020 2020 2063 7572 7265 6e74           current
-0003bda0: 6c79 2068 6176 6520 6461 7461 2e0a 2020  ly have data..  
-0003bdb0: 2020 2020 2020 6e20 3a20 696e 740a 2020        n : int.  
-0003bdc0: 2020 2020 2020 2020 2020 4e75 6d62 6572            Number
-0003bdd0: 206f 6620 776f 726b 6572 7320 746f 2063   of workers to c
-0003bde0: 6c6f 7365 0a20 2020 2020 2020 206d 696e  lose.        min
-0003bdf0: 696d 756d 203a 2069 6e74 0a20 2020 2020  imum : int.     
-0003be00: 2020 2020 2020 204d 696e 696d 756d 206e         Minimum n
-0003be10: 756d 6265 7220 6f66 2077 6f72 6b65 7273  umber of workers
-0003be20: 2074 6f20 6b65 6570 2061 726f 756e 640a   to keep around.
-0003be30: 2020 2020 2020 2020 6b65 7920 3a20 4361          key : Ca
-0003be40: 6c6c 6162 6c65 2857 6f72 6b65 7253 7461  llable(WorkerSta
-0003be50: 7465 290a 2020 2020 2020 2020 2020 2020  te).            
-0003be60: 416e 206f 7074 696f 6e61 6c20 6361 6c6c  An optional call
-0003be70: 6162 6c65 206d 6170 7069 6e67 2061 2057  able mapping a W
-0003be80: 6f72 6b65 7253 7461 7465 206f 626a 6563  orkerState objec
-0003be90: 7420 746f 2061 2067 726f 7570 0a20 2020  t to a group.   
-0003bea0: 2020 2020 2020 2020 2061 6666 696c 6961           affilia
-0003beb0: 7469 6f6e 2e20 4772 6f75 7073 2077 696c  tion. Groups wil
-0003bec0: 6c20 6265 2063 6c6f 7365 6420 746f 6765  l be closed toge
-0003bed0: 7468 6572 2e20 5468 6973 2069 7320 7573  ther. This is us
-0003bee0: 6566 756c 2077 6865 6e0a 2020 2020 2020  eful when.      
-0003bef0: 2020 2020 2020 636c 6f73 696e 6720 776f        closing wo
-0003bf00: 726b 6572 7320 6d75 7374 2062 6520 646f  rkers must be do
-0003bf10: 6e65 2063 6f6c 6c65 6374 6976 656c 792c  ne collectively,
-0003bf20: 2073 7563 6820 6173 2062 7920 686f 7374   such as by host
-0003bf30: 6e61 6d65 2e0a 2020 2020 2020 2020 7461  name..        ta
-0003bf40: 7267 6574 203a 2069 6e74 0a20 2020 2020  rget : int.     
-0003bf50: 2020 2020 2020 2054 6172 6765 7420 6e75         Target nu
-0003bf60: 6d62 6572 206f 6620 776f 726b 6572 7320  mber of workers 
-0003bf70: 746f 2068 6176 6520 6166 7465 7220 7765  to have after we
-0003bf80: 2063 6c6f 7365 0a20 2020 2020 2020 2061   close.        a
-0003bf90: 7474 7269 6275 7465 203a 2073 7472 0a20  ttribute : str. 
-0003bfa0: 2020 2020 2020 2020 2020 2054 6865 2061             The a
-0003bfb0: 7474 7269 6275 7465 206f 6620 7468 6520  ttribute of the 
-0003bfc0: 576f 726b 6572 5374 6174 6520 6f62 6a65  WorkerState obje
-0003bfd0: 6374 2074 6f20 7265 7475 726e 2c20 6c69  ct to return, li
-0003bfe0: 6b65 2022 6164 6472 6573 7322 0a20 2020  ke "address".   
-0003bff0: 2020 2020 2020 2020 206f 7220 226e 616d           or "nam
-0003c000: 6522 2e20 2044 6566 6175 6c74 7320 746f  e".  Defaults to
-0003c010: 2022 6164 6472 6573 7322 2e0a 0a20 2020   "address"...   
-0003c020: 2020 2020 2045 7861 6d70 6c65 730a 2020       Examples.  
-0003c030: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
-0003c040: 2020 2020 2020 203e 3e3e 2073 6368 6564         >>> sched
-0003c050: 756c 6572 2e77 6f72 6b65 7273 5f74 6f5f  uler.workers_to_
-0003c060: 636c 6f73 6528 290a 2020 2020 2020 2020  close().        
-0003c070: 5b27 7463 703a 2f2f 3139 322e 3136 382e  ['tcp://192.168.
-0003c080: 302e 313a 3132 3334 272c 2027 7463 703a  0.1:1234', 'tcp:
-0003c090: 2f2f 3139 322e 3136 382e 302e 323a 3132  //192.168.0.2:12
-0003c0a0: 3334 275d 0a0a 2020 2020 2020 2020 4772  34']..        Gr
-0003c0b0: 6f75 7020 776f 726b 6572 7320 6279 2068  oup workers by h
-0003c0c0: 6f73 746e 616d 6520 7072 696f 7220 746f  ostname prior to
-0003c0d0: 2063 6c6f 7369 6e67 0a0a 2020 2020 2020   closing..      
-0003c0e0: 2020 3e3e 3e20 7363 6865 6475 6c65 722e    >>> scheduler.
-0003c0f0: 776f 726b 6572 735f 746f 5f63 6c6f 7365  workers_to_close
-0003c100: 286b 6579 3d6c 616d 6264 6120 7773 3a20  (key=lambda ws: 
-0003c110: 7773 2e68 6f73 7429 0a20 2020 2020 2020  ws.host).       
-0003c120: 205b 2774 6370 3a2f 2f31 3932 2e31 3638   ['tcp://192.168
-0003c130: 2e30 2e31 3a31 3233 3427 2c20 2774 6370  .0.1:1234', 'tcp
-0003c140: 3a2f 2f31 3932 2e31 3638 2e30 2e31 3a34  ://192.168.0.1:4
-0003c150: 3536 3727 5d0a 0a20 2020 2020 2020 2052  567']..        R
-0003c160: 656d 6f76 6520 7477 6f20 776f 726b 6572  emove two worker
-0003c170: 730a 0a20 2020 2020 2020 203e 3e3e 2073  s..        >>> s
-0003c180: 6368 6564 756c 6572 2e77 6f72 6b65 7273  cheduler.workers
-0003c190: 5f74 6f5f 636c 6f73 6528 6e3d 3229 0a0a  _to_close(n=2)..
-0003c1a0: 2020 2020 2020 2020 4b65 6570 2065 6e6f          Keep eno
-0003c1b0: 7567 6820 776f 726b 6572 7320 746f 2068  ugh workers to h
-0003c1c0: 6176 6520 7477 6963 6520 6173 206d 7563  ave twice as muc
-0003c1d0: 6820 6d65 6d6f 7279 2061 7320 7765 2077  h memory as we w
-0003c1e0: 6520 6e65 6564 2e0a 0a20 2020 2020 2020  e need...       
-0003c1f0: 203e 3e3e 2073 6368 6564 756c 6572 2e77   >>> scheduler.w
-0003c200: 6f72 6b65 7273 5f74 6f5f 636c 6f73 6528  orkers_to_close(
-0003c210: 6d65 6d6f 7279 5f72 6174 696f 3d32 290a  memory_ratio=2).
-0003c220: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-0003c230: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-0003c240: 0a20 2020 2020 2020 2074 6f5f 636c 6f73  .        to_clos
-0003c250: 653a 206c 6973 7420 6f66 2077 6f72 6b65  e: list of worke
-0003c260: 7220 6164 6472 6573 7365 7320 7468 6174  r addresses that
-0003c270: 2061 7265 204f 4b20 746f 2063 6c6f 7365   are OK to close
-0003c280: 0a0a 2020 2020 2020 2020 5365 6520 416c  ..        See Al
-0003c290: 736f 0a20 2020 2020 2020 202d 2d2d 2d2d  so.        -----
-0003c2a0: 2d2d 2d0a 2020 2020 2020 2020 5363 6865  ---.        Sche
-0003c2b0: 6475 6c65 722e 7265 7469 7265 5f77 6f72  duler.retire_wor
-0003c2c0: 6b65 7273 0a20 2020 2020 2020 2022 2222  kers.        """
-0003c2d0: 0a20 2020 2020 2020 2069 6620 7461 7267  .        if targ
-0003c2e0: 6574 2069 7320 6e6f 7420 4e6f 6e65 2061  et is not None a
-0003c2f0: 6e64 206e 2069 7320 4e6f 6e65 3a0a 2020  nd n is None:.  
-0003c300: 2020 2020 2020 2020 2020 6e20 3d20 6c65            n = le
-0003c310: 6e28 7365 6c66 2e77 6f72 6b65 7273 2920  n(self.workers) 
-0003c320: 2d20 7461 7267 6574 0a20 2020 2020 2020  - target.       
-0003c330: 2069 6620 6e20 6973 206e 6f74 204e 6f6e   if n is not Non
-0003c340: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
-0003c350: 6620 6e20 3c20 303a 0a20 2020 2020 2020  f n < 0:.       
-0003c360: 2020 2020 2020 2020 206e 203d 2030 0a20           n = 0. 
-0003c370: 2020 2020 2020 2020 2020 2074 6172 6765             targe
-0003c380: 7420 3d20 6c65 6e28 7365 6c66 2e77 6f72  t = len(self.wor
-0003c390: 6b65 7273 2920 2d20 6e0a 0a20 2020 2020  kers) - n..     
-0003c3a0: 2020 2069 6620 6e20 6973 204e 6f6e 6520     if n is None 
-0003c3b0: 616e 6420 6d65 6d6f 7279 5f72 6174 696f  and memory_ratio
-0003c3c0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0003c3d0: 2020 2020 2020 6d65 6d6f 7279 5f72 6174        memory_rat
-0003c3e0: 696f 203d 2032 0a0a 2020 2020 2020 2020  io = 2..        
-0003c3f0: 7769 7468 206c 6f67 5f65 7272 6f72 7328  with log_errors(
-0003c400: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-0003c410: 6620 6e6f 7420 6e20 616e 6420 616c 6c28  f not n and all(
-0003c420: 5b77 732e 7072 6f63 6573 7369 6e67 2066  [ws.processing f
-0003c430: 6f72 2077 7320 696e 2073 656c 662e 776f  or ws in self.wo
-0003c440: 726b 6572 732e 7661 6c75 6573 2829 5d29  rkers.values()])
-0003c450: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003c460: 2020 7265 7475 726e 205b 5d0a 0a20 2020    return []..   
-0003c470: 2020 2020 2020 2020 2069 6620 6b65 7920           if key 
-0003c480: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0003c490: 2020 2020 2020 2020 206b 6579 203d 206f           key = o
-0003c4a0: 7065 7261 746f 722e 6174 7472 6765 7474  perator.attrgett
-0003c4b0: 6572 2822 6164 6472 6573 7322 290a 2020  er("address").  
-0003c4c0: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
-0003c4d0: 6e73 7461 6e63 6528 6b65 792c 2062 7974  nstance(key, byt
-0003c4e0: 6573 2920 616e 6420 6461 736b 2e63 6f6e  es) and dask.con
-0003c4f0: 6669 672e 6765 7428 0a20 2020 2020 2020  fig.get(.       
-0003c500: 2020 2020 2020 2020 2022 6469 7374 7269           "distri
-0003c510: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
-0003c520: 7069 636b 6c65 220a 2020 2020 2020 2020  pickle".        
-0003c530: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
-0003c540: 2020 2020 2020 206b 6579 203d 2070 6963         key = pic
-0003c550: 6b6c 652e 6c6f 6164 7328 6b65 7929 0a0a  kle.loads(key)..
-0003c560: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
-0003c570: 7073 203d 2067 726f 7570 6279 286b 6579  ps = groupby(key
-0003c580: 2c20 7365 6c66 2e77 6f72 6b65 7273 2e76  , self.workers.v
-0003c590: 616c 7565 7328 2929 0a0a 2020 2020 2020  alues())..      
-0003c5a0: 2020 2020 2020 6c69 6d69 745f 6279 7465        limit_byte
-0003c5b0: 7320 3d20 7b0a 2020 2020 2020 2020 2020  s = {.          
-0003c5c0: 2020 2020 2020 6b3a 2073 756d 2877 732e        k: sum(ws.
-0003c5d0: 6d65 6d6f 7279 5f6c 696d 6974 2066 6f72  memory_limit for
-0003c5e0: 2077 7320 696e 2076 2920 666f 7220 6b2c   ws in v) for k,
-0003c5f0: 2076 2069 6e20 6772 6f75 7073 2e69 7465   v in groups.ite
-0003c600: 6d73 2829 0a20 2020 2020 2020 2020 2020  ms().           
-0003c610: 207d 0a20 2020 2020 2020 2020 2020 2067   }.            g
-0003c620: 726f 7570 5f62 7974 6573 203d 207b 6b3a  roup_bytes = {k:
-0003c630: 2073 756d 2877 732e 6e62 7974 6573 2066   sum(ws.nbytes f
-0003c640: 6f72 2077 7320 696e 2076 2920 666f 7220  or ws in v) for 
-0003c650: 6b2c 2076 2069 6e20 6772 6f75 7073 2e69  k, v in groups.i
-0003c660: 7465 6d73 2829 7d0a 0a20 2020 2020 2020  tems()}..       
-0003c670: 2020 2020 206c 696d 6974 203d 2073 756d       limit = sum
-0003c680: 286c 696d 6974 5f62 7974 6573 2e76 616c  (limit_bytes.val
-0003c690: 7565 7328 2929 0a20 2020 2020 2020 2020  ues()).         
-0003c6a0: 2020 2074 6f74 616c 203d 2073 756d 2867     total = sum(g
-0003c6b0: 726f 7570 5f62 7974 6573 2e76 616c 7565  roup_bytes.value
-0003c6c0: 7328 2929 0a0a 2020 2020 2020 2020 2020  s())..          
-0003c6d0: 2020 6465 6620 5f6b 6579 2867 726f 7570    def _key(group
-0003c6e0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0003c6f0: 2020 2069 735f 6964 6c65 203d 206e 6f74     is_idle = not
-0003c700: 2061 6e79 285b 7777 732e 7072 6f63 6573   any([wws.proces
-0003c710: 7369 6e67 2066 6f72 2077 7773 2069 6e20  sing for wws in 
-0003c720: 6772 6f75 7073 5b67 726f 7570 5d5d 290a  groups[group]]).
-0003c730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c740: 6279 7465 7320 3d20 2d67 726f 7570 5f62  bytes = -group_b
-0003c750: 7974 6573 5b67 726f 7570 5d0a 2020 2020  ytes[group].    
-0003c760: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0003c770: 726e 2069 735f 6964 6c65 2c20 6279 7465  rn is_idle, byte
-0003c780: 730a 0a20 2020 2020 2020 2020 2020 2069  s..            i
-0003c790: 646c 6520 3d20 736f 7274 6564 2867 726f  dle = sorted(gro
-0003c7a0: 7570 732c 206b 6579 3d5f 6b65 7929 0a0a  ups, key=_key)..
-0003c7b0: 2020 2020 2020 2020 2020 2020 746f 5f63              to_c
-0003c7c0: 6c6f 7365 203d 205b 5d0a 2020 2020 2020  lose = [].      
-0003c7d0: 2020 2020 2020 6e5f 7265 6d61 696e 203d        n_remain =
-0003c7e0: 206c 656e 2873 656c 662e 776f 726b 6572   len(self.worker
-0003c7f0: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
-0003c800: 7768 696c 6520 6964 6c65 3a0a 2020 2020  while idle:.    
-0003c810: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
-0003c820: 7020 3d20 6964 6c65 2e70 6f70 2829 0a20  p = idle.pop(). 
-0003c830: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0003c840: 6620 6e20 6973 204e 6f6e 6520 616e 6420  f n is None and 
-0003c850: 616e 7928 5b77 732e 7072 6f63 6573 7369  any([ws.processi
-0003c860: 6e67 2066 6f72 2077 7320 696e 2067 726f  ng for ws in gro
-0003c870: 7570 735b 6772 6f75 705d 5d29 3a0a 2020  ups[group]]):.  
-0003c880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c890: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
-0003c8a0: 2020 2020 2020 2020 2069 6620 6d69 6e69           if mini
-0003c8b0: 6d75 6d20 616e 6420 6e5f 7265 6d61 696e  mum and n_remain
-0003c8c0: 202d 206c 656e 2867 726f 7570 735b 6772   - len(groups[gr
-0003c8d0: 6f75 705d 2920 3c20 6d69 6e69 6d75 6d3a  oup]) < minimum:
-0003c8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003c8f0: 2020 2020 2062 7265 616b 0a0a 2020 2020       break..    
-0003c900: 2020 2020 2020 2020 2020 2020 6c69 6d69              limi
-0003c910: 7420 2d3d 206c 696d 6974 5f62 7974 6573  t -= limit_bytes
-0003c920: 5b67 726f 7570 5d0a 0a20 2020 2020 2020  [group]..       
-0003c930: 2020 2020 2020 2020 2069 6620 280a 2020           if (.  
-0003c940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c950: 2020 6e20 6973 206e 6f74 204e 6f6e 6520    n is not None 
-0003c960: 616e 6420 6e5f 7265 6d61 696e 202d 206c  and n_remain - l
-0003c970: 656e 2867 726f 7570 735b 6772 6f75 705d  en(groups[group]
-0003c980: 2920 3e3d 2028 7461 7267 6574 206f 7220  ) >= (target or 
-0003c990: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
-0003c9a0: 2020 2029 206f 7220 286d 656d 6f72 795f     ) or (memory_
-0003c9b0: 7261 7469 6f20 6973 206e 6f74 204e 6f6e  ratio is not Non
-0003c9c0: 6520 616e 6420 6c69 6d69 7420 3e3d 206d  e and limit >= m
-0003c9d0: 656d 6f72 795f 7261 7469 6f20 2a20 746f  emory_ratio * to
-0003c9e0: 7461 6c29 3a0a 2020 2020 2020 2020 2020  tal):.          
-0003c9f0: 2020 2020 2020 2020 2020 746f 5f63 6c6f            to_clo
-0003ca00: 7365 2e61 7070 656e 6428 6772 6f75 7029  se.append(group)
-0003ca10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003ca20: 2020 2020 206e 5f72 656d 6169 6e20 2d3d       n_remain -=
-0003ca30: 206c 656e 2867 726f 7570 735b 6772 6f75   len(groups[grou
-0003ca40: 705d 290a 0a20 2020 2020 2020 2020 2020  p])..           
-0003ca50: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0003ca60: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0003ca70: 7265 616b 0a0a 2020 2020 2020 2020 2020  reak..          
-0003ca80: 2020 7265 7375 6c74 203d 205b 6765 7461    result = [geta
-0003ca90: 7474 7228 7773 2c20 6174 7472 6962 7574  ttr(ws, attribut
-0003caa0: 6529 2066 6f72 2067 2069 6e20 746f 5f63  e) for g in to_c
-0003cab0: 6c6f 7365 2066 6f72 2077 7320 696e 2067  lose for ws in g
-0003cac0: 726f 7570 735b 675d 5d0a 2020 2020 2020  roups[g]].      
-0003cad0: 2020 2020 2020 6966 2072 6573 756c 743a        if result:
-0003cae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003caf0: 206c 6f67 6765 722e 6465 6275 6728 2253   logger.debug("S
-0003cb00: 7567 6765 7374 2063 6c6f 7369 6e67 2077  uggest closing w
-0003cb10: 6f72 6b65 7273 3a20 2573 222c 2072 6573  orkers: %s", res
-0003cb20: 756c 7429 0a0a 2020 2020 2020 2020 2020  ult)..          
-0003cb30: 2020 7265 7475 726e 2072 6573 756c 740a    return result.
-0003cb40: 0a20 2020 2040 6c6f 675f 6572 726f 7273  .    @log_errors
-0003cb50: 0a20 2020 2061 7379 6e63 2064 6566 2072  .    async def r
-0003cb60: 6574 6972 655f 776f 726b 6572 7328 0a20  etire_workers(. 
-0003cb70: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-0003cb80: 2020 2020 2077 6f72 6b65 7273 3a20 6c69       workers: li
-0003cb90: 7374 5b73 7472 5d20 7c20 4e6f 6e65 203d  st[str] | None =
-0003cba0: 204e 6f6e 652c 0a20 2020 2020 2020 202a   None,.        *
-0003cbb0: 2c0a 2020 2020 2020 2020 6e61 6d65 733a  ,.        names:
-0003cbc0: 206c 6973 7420 7c20 4e6f 6e65 203d 204e   list | None = N
-0003cbd0: 6f6e 652c 0a20 2020 2020 2020 2063 6c6f  one,.        clo
-0003cbe0: 7365 5f77 6f72 6b65 7273 3a20 626f 6f6c  se_workers: bool
-0003cbf0: 203d 2046 616c 7365 2c0a 2020 2020 2020   = False,.      
-0003cc00: 2020 7265 6d6f 7665 3a20 626f 6f6c 203d    remove: bool =
-0003cc10: 2054 7275 652c 0a20 2020 2020 2020 2073   True,.        s
-0003cc20: 7469 6d75 6c75 735f 6964 3a20 7374 7220  timulus_id: str 
-0003cc30: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-0003cc40: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
-0003cc50: 2041 6e79 2c0a 2020 2020 2920 2d3e 2064   Any,.    ) -> d
-0003cc60: 6963 745b 7374 722c 2041 6e79 5d3a 0a20  ict[str, Any]:. 
-0003cc70: 2020 2020 2020 2022 2222 4772 6163 6566         """Gracef
-0003cc80: 756c 6c79 2072 6574 6972 6520 776f 726b  ully retire work
-0003cc90: 6572 7320 6672 6f6d 2063 6c75 7374 6572  ers from cluster
-0003cca0: 2e20 416e 7920 6b65 7920 7468 6174 2069  . Any key that i
-0003ccb0: 7320 696e 206d 656d 6f72 7920 6578 636c  s in memory excl
-0003ccc0: 7573 6976 656c 790a 2020 2020 2020 2020  usively.        
-0003ccd0: 6f6e 2074 6865 2072 6574 6972 6564 2077  on the retired w
-0003cce0: 6f72 6b65 7273 2069 7320 7265 706c 6963  orkers is replic
-0003ccf0: 6174 6564 2073 6f6d 6577 6865 7265 2065  ated somewhere e
-0003cd00: 6c73 652e 0a0a 2020 2020 2020 2020 5061  lse...        Pa
-0003cd10: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
-0003cd20: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-0003cd30: 2020 2020 776f 726b 6572 733a 206c 6973      workers: lis
-0003cd40: 745b 7374 725d 2028 6f70 7469 6f6e 616c  t[str] (optional
-0003cd50: 290a 2020 2020 2020 2020 2020 2020 4c69  ).            Li
-0003cd60: 7374 206f 6620 776f 726b 6572 2061 6464  st of worker add
-0003cd70: 7265 7373 6573 2074 6f20 7265 7469 7265  resses to retire
-0003cd80: 2e0a 2020 2020 2020 2020 6e61 6d65 733a  ..        names:
-0003cd90: 206c 6973 7420 286f 7074 696f 6e61 6c29   list (optional)
-0003cda0: 0a20 2020 2020 2020 2020 2020 204c 6973  .            Lis
-0003cdb0: 7420 6f66 2077 6f72 6b65 7220 6e61 6d65  t of worker name
-0003cdc0: 7320 746f 2072 6574 6972 652e 0a20 2020  s to retire..   
-0003cdd0: 2020 2020 2020 2020 204d 7574 7561 6c6c           Mutuall
-0003cde0: 7920 6578 636c 7573 6976 6520 7769 7468  y exclusive with
-0003cdf0: 2060 6077 6f72 6b65 7273 6060 2e0a 2020   ``workers``..  
-0003ce00: 2020 2020 2020 2020 2020 4966 206e 6569            If nei
-0003ce10: 7468 6572 2060 6077 6f72 6b65 7273 6060  ther ``workers``
-0003ce20: 206e 6f72 2060 606e 616d 6573 6060 2061   nor ``names`` a
-0003ce30: 7265 2070 726f 7669 6465 642c 2077 6520  re provided, we 
-0003ce40: 6361 6c6c 0a20 2020 2020 2020 2020 2020  call.           
-0003ce50: 2060 6077 6f72 6b65 7273 5f74 6f5f 636c   ``workers_to_cl
-0003ce60: 6f73 6560 6020 7768 6963 6820 6669 6e64  ose`` which find
-0003ce70: 7320 6120 676f 6f64 2073 6574 2e0a 2020  s a good set..  
-0003ce80: 2020 2020 2020 636c 6f73 655f 776f 726b        close_work
-0003ce90: 6572 733a 2062 6f6f 6c20 2864 6566 6175  ers: bool (defau
-0003cea0: 6c74 7320 746f 2046 616c 7365 290a 2020  lts to False).  
-0003ceb0: 2020 2020 2020 2020 2020 5768 6574 6865            Whethe
-0003cec0: 7220 6f72 206e 6f74 2074 6f20 6163 7475  r or not to actu
-0003ced0: 616c 6c79 2063 6c6f 7365 2074 6865 2077  ally close the w
-0003cee0: 6f72 6b65 7220 6578 706c 6963 6974 6c79  orker explicitly
-0003cef0: 2066 726f 6d20 6865 7265 2e0a 2020 2020   from here..    
-0003cf00: 2020 2020 2020 2020 4f74 6865 7277 6973          Otherwis
-0003cf10: 6520 7765 2065 7870 6563 7420 736f 6d65  e we expect some
-0003cf20: 2065 7874 6572 6e61 6c20 6a6f 6220 7363   external job sc
-0003cf30: 6865 6475 6c65 7220 746f 2066 696e 6973  heduler to finis
-0003cf40: 6820 6f66 6620 7468 650a 2020 2020 2020  h off the.      
-0003cf50: 2020 2020 2020 776f 726b 6572 2e0a 2020        worker..  
-0003cf60: 2020 2020 2020 7265 6d6f 7665 3a20 626f        remove: bo
-0003cf70: 6f6c 2028 6465 6661 756c 7473 2074 6f20  ol (defaults to 
-0003cf80: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
-0003cf90: 2020 5768 6574 6865 7220 6f72 206e 6f74    Whether or not
-0003cfa0: 2074 6f20 7265 6d6f 7665 2074 6865 2077   to remove the w
-0003cfb0: 6f72 6b65 7220 6d65 7461 6461 7461 2069  orker metadata i
-0003cfc0: 6d6d 6564 6961 7465 6c79 206f 7220 656c  mmediately or el
-0003cfd0: 7365 0a20 2020 2020 2020 2020 2020 2077  se.            w
-0003cfe0: 6169 7420 666f 7220 7468 6520 776f 726b  ait for the work
-0003cff0: 6572 2074 6f20 636f 6e74 6163 7420 7573  er to contact us
-0003d000: 2e0a 0a20 2020 2020 2020 2020 2020 2049  ...            I
-0003d010: 6620 636c 6f73 655f 776f 726b 6572 733d  f close_workers=
-0003d020: 4661 6c73 6520 616e 6420 7265 6d6f 7665  False and remove
-0003d030: 3d46 616c 7365 2c20 7468 6973 206d 6574  =False, this met
-0003d040: 686f 6420 6a75 7374 2066 6c75 7368 6573  hod just flushes
-0003d050: 2074 6865 2074 6173 6b73 0a20 2020 2020   the tasks.     
-0003d060: 2020 2020 2020 2069 6e20 6d65 6d6f 7279         in memory
-0003d070: 206f 7574 206f 6620 7468 6520 776f 726b   out of the work
-0003d080: 6572 7320 616e 6420 7468 656e 2072 6574  ers and then ret
-0003d090: 7572 6e73 2e0a 2020 2020 2020 2020 2020  urns..          
-0003d0a0: 2020 4966 2063 6c6f 7365 5f77 6f72 6b65    If close_worke
-0003d0b0: 7273 3d54 7275 6520 616e 6420 7265 6d6f  rs=True and remo
-0003d0c0: 7665 3d46 616c 7365 2c20 7468 6973 206d  ve=False, this m
-0003d0d0: 6574 686f 6420 7769 6c6c 2072 6574 7572  ethod will retur
-0003d0e0: 6e20 7768 696c 6520 7468 650a 2020 2020  n while the.    
-0003d0f0: 2020 2020 2020 2020 776f 726b 6572 7320          workers 
-0003d100: 6172 6520 7374 696c 6c20 696e 2074 6865  are still in the
-0003d110: 2063 6c75 7374 6572 2c20 616c 7468 6f75   cluster, althou
-0003d120: 6768 2074 6865 7920 776f 6e27 7420 6163  gh they won't ac
-0003d130: 6365 7074 206e 6577 2074 6173 6b73 2e0a  cept new tasks..
-0003d140: 2020 2020 2020 2020 2020 2020 4966 2063              If c
-0003d150: 6c6f 7365 5f77 6f72 6b65 7273 3d46 616c  lose_workers=Fal
-0003d160: 7365 206f 7220 666f 7220 7768 6174 6576  se or for whatev
-0003d170: 6572 2072 6561 736f 6e20 6120 776f 726b  er reason a work
-0003d180: 6572 2064 6f65 736e 2774 2061 6363 6570  er doesn't accep
-0003d190: 7420 7468 650a 2020 2020 2020 2020 2020  t the.          
-0003d1a0: 2020 636c 6f73 6520 636f 6d6d 616e 642c    close command,
-0003d1b0: 2069 7420 7769 6c6c 2062 6520 6c65 6674   it will be left
-0003d1c0: 2070 6572 6d61 6e65 6e74 6c79 2075 6e61   permanently una
-0003d1d0: 626c 6520 746f 2061 6363 6570 7420 6e65  ble to accept ne
-0003d1e0: 7720 7461 736b 7320 616e 640a 2020 2020  w tasks and.    
-0003d1f0: 2020 2020 2020 2020 6974 2069 7320 6578          it is ex
-0003d200: 7065 6374 6564 2074 6f20 6265 2063 6c6f  pected to be clo
-0003d210: 7365 6420 696e 2073 6f6d 6520 6f74 6865  sed in some othe
-0003d220: 7220 7761 792e 0a0a 2020 2020 2020 2020  r way...        
-0003d230: 2a2a 6b77 6172 6773 3a20 6469 6374 0a20  **kwargs: dict. 
-0003d240: 2020 2020 2020 2020 2020 2045 7874 7261             Extra
-0003d250: 206f 7074 696f 6e73 2074 6f20 7061 7373   options to pass
-0003d260: 2074 6f20 776f 726b 6572 735f 746f 5f63   to workers_to_c
-0003d270: 6c6f 7365 2074 6f20 6465 7465 726d 696e  lose to determin
-0003d280: 6520 7768 6963 680a 2020 2020 2020 2020  e which.        
-0003d290: 2020 2020 776f 726b 6572 7320 7765 2073      workers we s
-0003d2a0: 686f 756c 6420 6472 6f70 0a0a 2020 2020  hould drop..    
-0003d2b0: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-0003d2c0: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-0003d2d0: 2020 2020 4469 6374 696f 6e61 7279 206d      Dictionary m
-0003d2e0: 6170 7069 6e67 2077 6f72 6b65 7220 4944  apping worker ID
-0003d2f0: 2f61 6464 7265 7373 2074 6f20 6469 6374  /address to dict
-0003d300: 696f 6e61 7279 206f 6620 696e 666f 726d  ionary of inform
-0003d310: 6174 696f 6e20 6162 6f75 740a 2020 2020  ation about.    
-0003d320: 2020 2020 7468 6174 2077 6f72 6b65 7220      that worker 
-0003d330: 666f 7220 6561 6368 2072 6574 6972 6564  for each retired
-0003d340: 2077 6f72 6b65 722e 0a0a 2020 2020 2020   worker...      
-0003d350: 2020 4966 2074 6865 7265 2061 7265 206b    If there are k
-0003d360: 6579 7320 7468 6174 2065 7869 7374 2069  eys that exist i
-0003d370: 6e20 6d65 6d6f 7279 206f 6e6c 7920 6f6e  n memory only on
-0003d380: 2074 6865 2077 6f72 6b65 7273 2062 6569   the workers bei
-0003d390: 6e67 2072 6574 6972 6564 2061 6e64 2069  ng retired and i
-0003d3a0: 740a 2020 2020 2020 2020 7761 7320 696d  t.        was im
-0003d3b0: 706f 7373 6962 6c65 2074 6f20 7265 706c  possible to repl
-0003d3c0: 6963 6174 6520 7468 656d 2073 6f6d 6577  icate them somew
-0003d3d0: 6865 7265 2065 6c73 6520 2865 2e67 2e20  here else (e.g. 
-0003d3e0: 6265 6361 7573 6520 7468 6572 6520 6172  because there ar
-0003d3f0: 656e 2774 0a20 2020 2020 2020 2061 6e79  en't.        any
-0003d400: 206f 7468 6572 2072 756e 6e69 6e67 2077   other running w
-0003d410: 6f72 6b65 7273 292c 2074 6865 2077 6f72  orkers), the wor
-0003d420: 6b65 7273 2068 6f6c 6469 6e67 2073 7563  kers holding suc
-0003d430: 6820 6b65 7973 2077 6f6e 2774 2062 6520  h keys won't be 
-0003d440: 7265 7469 7265 6420 616e 640a 2020 2020  retired and.    
-0003d450: 2020 2020 776f 6e27 7420 6170 7065 6172      won't appear
-0003d460: 2069 6e20 7468 6520 7265 7475 726e 6564   in the returned
-0003d470: 2064 6963 742e 0a0a 2020 2020 2020 2020   dict...        
-0003d480: 5365 6520 416c 736f 0a20 2020 2020 2020  See Also.       
-0003d490: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020   --------.      
-0003d4a0: 2020 5363 6865 6475 6c65 722e 776f 726b    Scheduler.work
-0003d4b0: 6572 735f 746f 5f63 6c6f 7365 0a20 2020  ers_to_close.   
-0003d4c0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0003d4d0: 2073 7469 6d75 6c75 735f 6964 203d 2073   stimulus_id = s
-0003d4e0: 7469 6d75 6c75 735f 6964 206f 7220 6622  timulus_id or f"
-0003d4f0: 7265 7469 7265 2d77 6f72 6b65 7273 2d7b  retire-workers-{
-0003d500: 7469 6d65 2829 7d22 0a20 2020 2020 2020  time()}".       
-0003d510: 2023 2054 6869 7320 6c6f 636b 206d 616b   # This lock mak
-0003d520: 6573 2072 6574 6972 655f 776f 726b 6572  es retire_worker
-0003d530: 732c 2072 6562 616c 616e 6365 2c20 616e  s, rebalance, an
-0003d540: 6420 7265 706c 6963 6174 6520 6d75 7475  d replicate mutu
-0003d550: 616c 6c79 0a20 2020 2020 2020 2023 2065  ally.        # e
-0003d560: 7863 6c75 7369 7665 2061 6e64 2077 696c  xclusive and wil
-0003d570: 6c20 6e6f 206c 6f6e 6765 7220 6265 206e  l no longer be n
-0003d580: 6563 6573 7361 7279 206f 6e63 6520 7265  ecessary once re
-0003d590: 6261 6c61 6e63 6520 616e 6420 7265 706c  balance and repl
-0003d5a0: 6963 6174 6520 6172 650a 2020 2020 2020  icate are.      
-0003d5b0: 2020 2320 6d69 6772 6174 6564 2074 6f20    # migrated to 
-0003d5c0: 7468 6520 4163 7469 7665 204d 656d 6f72  the Active Memor
-0003d5d0: 7920 4d61 6e61 6765 722e 0a20 2020 2020  y Manager..     
-0003d5e0: 2020 2023 204e 6f74 6520 7468 6174 2c20     # Note that, 
-0003d5f0: 696e 6369 6465 6e74 616c 6c79 2c20 6974  incidentally, it
-0003d600: 2061 6c73 6f20 7072 6576 656e 7473 206d   also prevents m
-0003d610: 756c 7469 706c 6520 6361 6c6c 7320 746f  ultiple calls to
-0003d620: 2072 6574 6972 655f 776f 726b 6572 730a   retire_workers.
-0003d630: 2020 2020 2020 2020 2320 6672 6f6d 2072          # from r
-0003d640: 756e 6e69 6e67 2069 6e20 7061 7261 6c6c  unning in parall
-0003d650: 656c 202d 2074 6869 7320 6973 2075 6e6e  el - this is unn
-0003d660: 6563 6573 7361 7279 2e0a 2020 2020 2020  ecessary..      
-0003d670: 2020 6173 796e 6320 7769 7468 2073 656c    async with sel
-0003d680: 662e 5f6c 6f63 6b3a 0a20 2020 2020 2020  f._lock:.       
-0003d690: 2020 2020 2069 6620 6e61 6d65 7320 6973       if names is
-0003d6a0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0003d6b0: 2020 2020 2020 2020 2020 2069 6620 776f             if wo
-0003d6c0: 726b 6572 7320 6973 206e 6f74 204e 6f6e  rkers is not Non
-0003d6d0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0003d6e0: 2020 2020 2020 2072 6169 7365 2054 7970         raise Typ
-0003d6f0: 6545 7272 6f72 2822 6e61 6d65 7320 616e  eError("names an
-0003d700: 6420 776f 726b 6572 7320 6172 6520 6d75  d workers are mu
-0003d710: 7475 616c 6c79 2065 7863 6c75 7369 7665  tually exclusive
-0003d720: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-0003d730: 2020 2069 6620 6e61 6d65 733a 0a20 2020     if names:.   
-0003d740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d750: 206c 6f67 6765 722e 696e 666f 2822 5265   logger.info("Re
-0003d760: 7469 7265 2077 6f72 6b65 7220 6e61 6d65  tire worker name
-0003d770: 7320 2573 222c 206e 616d 6573 290a 2020  s %s", names).  
-0003d780: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0003d790: 5375 7070 6f72 7420 6361 7365 7320 7768  Support cases wh
-0003d7a0: 6572 6520 6e61 6d65 7320 6172 6520 7061  ere names are pa
-0003d7b0: 7373 6564 2074 6872 6f75 6768 2061 2043  ssed through a C
-0003d7c0: 4c49 2061 6e64 2062 6563 6f6d 650a 2020  LI and become.  
-0003d7d0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0003d7e0: 7374 7269 6e67 730a 2020 2020 2020 2020  strings.        
-0003d7f0: 2020 2020 2020 2020 6e61 6d65 735f 7365          names_se
-0003d800: 7420 3d20 7b73 7472 286e 616d 6529 2066  t = {str(name) f
-0003d810: 6f72 206e 616d 6520 696e 206e 616d 6573  or name in names
-0003d820: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-0003d830: 2020 7773 7320 3d20 7b77 7320 666f 7220    wss = {ws for 
-0003d840: 7773 2069 6e20 7365 6c66 2e77 6f72 6b65  ws in self.worke
-0003d850: 7273 2e76 616c 7565 7328 2920 6966 2073  rs.values() if s
-0003d860: 7472 2877 732e 6e61 6d65 2920 696e 206e  tr(ws.name) in n
-0003d870: 616d 6573 5f73 6574 7d0a 2020 2020 2020  ames_set}.      
-0003d880: 2020 2020 2020 656c 6966 2077 6f72 6b65        elif worke
-0003d890: 7273 2069 7320 6e6f 7420 4e6f 6e65 3a0a  rs is not None:.
-0003d8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d8b0: 7773 7320 3d20 7b0a 2020 2020 2020 2020  wss = {.        
-0003d8c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0003d8d0: 2e77 6f72 6b65 7273 5b61 6464 7265 7373  .workers[address
-0003d8e0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0003d8f0: 2020 2020 2020 666f 7220 6164 6472 6573        for addres
-0003d900: 7320 696e 2077 6f72 6b65 7273 0a20 2020  s in workers.   
-0003d910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d920: 2069 6620 6164 6472 6573 7320 696e 2073   if address in s
-0003d930: 656c 662e 776f 726b 6572 730a 2020 2020  elf.workers.    
-0003d940: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0003d950: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0003d960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d970: 7773 7320 3d20 7b0a 2020 2020 2020 2020  wss = {.        
-0003d980: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0003d990: 2e77 6f72 6b65 7273 5b61 6464 7265 7373  .workers[address
-0003d9a0: 5d20 666f 7220 6164 6472 6573 7320 696e  ] for address in
-0003d9b0: 2073 656c 662e 776f 726b 6572 735f 746f   self.workers_to
-0003d9c0: 5f63 6c6f 7365 282a 2a6b 7761 7267 7329  _close(**kwargs)
-0003d9d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003d9e0: 207d 0a20 2020 2020 2020 2020 2020 2069   }.            i
-0003d9f0: 6620 6e6f 7420 7773 733a 0a20 2020 2020  f not wss:.     
-0003da00: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0003da10: 6e20 7b7d 0a0a 2020 2020 2020 2020 2020  n {}..          
-0003da20: 2020 7374 6f70 5f61 6d6d 203d 2046 616c    stop_amm = Fal
-0003da30: 7365 0a20 2020 2020 2020 2020 2020 2061  se.            a
-0003da40: 6d6d 3a20 4163 7469 7665 4d65 6d6f 7279  mm: ActiveMemory
-0003da50: 4d61 6e61 6765 7245 7874 656e 7369 6f6e  ManagerExtension
-0003da60: 207c 204e 6f6e 6520 3d20 7365 6c66 2e65   | None = self.e
-0003da70: 7874 656e 7369 6f6e 732e 6765 7428 2261  xtensions.get("a
-0003da80: 6d6d 2229 0a20 2020 2020 2020 2020 2020  mm").           
-0003da90: 2069 6620 6e6f 7420 616d 6d20 6f72 206e   if not amm or n
-0003daa0: 6f74 2061 6d6d 2e72 756e 6e69 6e67 3a0a  ot amm.running:.
-0003dab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003dac0: 616d 6d20 3d20 4163 7469 7665 4d65 6d6f  amm = ActiveMemo
-0003dad0: 7279 4d61 6e61 6765 7245 7874 656e 7369  ryManagerExtensi
-0003dae0: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
-0003daf0: 2020 2020 2020 2020 7365 6c66 2c20 706f          self, po
-0003db00: 6c69 6369 6573 3d73 6574 2829 2c20 7265  licies=set(), re
-0003db10: 6769 7374 6572 3d46 616c 7365 2c20 7374  gister=False, st
-0003db20: 6172 743d 5472 7565 2c20 696e 7465 7276  art=True, interv
-0003db30: 616c 3d32 2e30 0a20 2020 2020 2020 2020  al=2.0.         
-0003db40: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0003db50: 2020 2020 2020 2020 2073 746f 705f 616d           stop_am
-0003db60: 6d20 3d20 5472 7565 0a0a 2020 2020 2020  m = True..      
-0003db70: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0003db80: 2020 2020 2020 2020 2020 2063 6f72 6f73             coros
-0003db90: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
-0003dba0: 2020 2020 2020 666f 7220 7773 2069 6e20        for ws in 
-0003dbb0: 7773 733a 0a20 2020 2020 2020 2020 2020  wss:.           
-0003dbc0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-0003dbd0: 696e 666f 2822 5265 7469 7269 6e67 2077  info("Retiring w
-0003dbe0: 6f72 6b65 7220 2573 222c 2077 732e 6164  orker %s", ws.ad
-0003dbf0: 6472 6573 7329 0a0a 2020 2020 2020 2020  dress)..        
-0003dc00: 2020 2020 2020 2020 2020 2020 706f 6c69              poli
-0003dc10: 6379 203d 2052 6574 6972 6557 6f72 6b65  cy = RetireWorke
-0003dc20: 7228 7773 2e61 6464 7265 7373 290a 2020  r(ws.address).  
-0003dc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003dc40: 2020 616d 6d2e 6164 645f 706f 6c69 6379    amm.add_policy
-0003dc50: 2870 6f6c 6963 7929 0a0a 2020 2020 2020  (policy)..      
-0003dc60: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0003dc70: 4368 616e 6765 2057 6f72 6b65 722e 7374  Change Worker.st
-0003dc80: 6174 7573 2074 6f20 636c 6f73 696e 675f  atus to closing_
-0003dc90: 6772 6163 6566 756c 6c79 2e20 496d 6d65  gracefully. Imme
-0003dca0: 6469 6174 656c 7920 7365 740a 2020 2020  diately set.    
-0003dcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003dcc0: 2320 7468 6520 7361 6d65 206f 6e20 7468  # the same on th
-0003dcd0: 6520 7363 6865 6475 6c65 7220 746f 2070  e scheduler to p
-0003dce0: 7265 7665 6e74 2072 6163 6520 636f 6e64  revent race cond
-0003dcf0: 6974 696f 6e73 2e0a 2020 2020 2020 2020  itions..        
-0003dd00: 2020 2020 2020 2020 2020 2020 7072 6576              prev
-0003dd10: 5f73 7461 7475 7320 3d20 7773 2e73 7461  _status = ws.sta
-0003dd20: 7475 730a 2020 2020 2020 2020 2020 2020  tus.            
-0003dd30: 2020 2020 2020 2020 7365 6c66 2e68 616e          self.han
-0003dd40: 646c 655f 776f 726b 6572 5f73 7461 7475  dle_worker_statu
-0003dd50: 735f 6368 616e 6765 280a 2020 2020 2020  s_change(.      
-0003dd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003dd70: 2020 5374 6174 7573 2e63 6c6f 7369 6e67    Status.closing
-0003dd80: 5f67 7261 6365 6675 6c6c 792c 2077 732c  _gracefully, ws,
-0003dd90: 2073 7469 6d75 6c75 735f 6964 0a20 2020   stimulus_id.   
-0003dda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ddb0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0003ddc0: 2020 2020 2020 2023 2046 4958 4d45 3a20         # FIXME: 
-0003ddd0: 5765 2073 686f 756c 6420 7365 6e64 2061  We should send a
-0003dde0: 206d 6573 7361 6765 2074 6f20 7468 6520   message to the 
-0003ddf0: 6e61 6e6e 7920 6669 7273 743b 0a20 2020  nanny first;.   
-0003de00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003de10: 2023 2065 7665 6e74 7561 6c6c 7920 776f   # eventually wo
-0003de20: 726b 6572 7320 776f 6e27 7420 6265 2061  rkers won't be a
-0003de30: 626c 6520 746f 2063 6c6f 7365 2074 6865  ble to close the
-0003de40: 6972 206f 776e 206e 616e 6e69 6573 2e0a  ir own nannies..
-0003de50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003de60: 2020 2020 7365 6c66 2e73 7472 6561 6d5f      self.stream_
-0003de70: 636f 6d6d 735b 7773 2e61 6464 7265 7373  comms[ws.address
-0003de80: 5d2e 7365 6e64 280a 2020 2020 2020 2020  ].send(.        
-0003de90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003dea0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0003deb0: 2020 2020 2020 2020 2020 2020 2020 226f                "o
-0003dec0: 7022 3a20 2277 6f72 6b65 722d 7374 6174  p": "worker-stat
-0003ded0: 7573 2d63 6861 6e67 6522 2c0a 2020 2020  us-change",.    
+0003b7f0: 2020 2020 666f 7220 7773 2069 6e20 7261      for ws in ra
+0003b800: 6e64 6f6d 2e73 616d 706c 6528 7475 706c  ndom.sample(tupl
+0003b810: 6528 776f 726b 6572 7320 2d20 7473 2e77  e(workers - ts.w
+0003b820: 686f 5f68 6173 292c 2063 6f75 6e74 293a  ho_has), count):
+0003b830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003b840: 2020 2020 2020 2020 2067 6174 6865 7273           gathers
+0003b850: 5b77 732e 6164 6472 6573 735d 5b74 732e  [ws.address][ts.
+0003b860: 6b65 795d 203d 205b 0a20 2020 2020 2020  key] = [.       
+0003b870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b880: 2020 2020 2077 7773 2e61 6464 7265 7373       wws.address
+0003b890: 2066 6f72 2077 7773 2069 6e20 7473 2e77   for wws in ts.w
+0003b8a0: 686f 5f68 6173 0a20 2020 2020 2020 2020  ho_has.         
+0003b8b0: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
+0003b8c0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0003b8d0: 2020 6177 6169 7420 6173 796e 6369 6f2e    await asyncio.
+0003b8e0: 6761 7468 6572 280a 2020 2020 2020 2020  gather(.        
+0003b8f0: 2020 2020 2020 2020 2020 2020 2a28 0a20              *(. 
+0003b900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b910: 2020 2020 2020 2023 204e 6f74 653a 2074         # Note: t
+0003b920: 6869 7320 6e65 7665 7220 7261 6973 6573  his never raises
+0003b930: 2065 7863 6570 7469 6f6e 730a 2020 2020   exceptions.    
+0003b940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b950: 2020 2020 7365 6c66 2e67 6174 6865 725f      self.gather_
+0003b960: 6f6e 5f77 6f72 6b65 7228 772c 2077 686f  on_worker(w, who
+0003b970: 5f68 6173 290a 2020 2020 2020 2020 2020  _has).          
+0003b980: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0003b990: 7220 772c 2077 686f 5f68 6173 2069 6e20  r w, who_has in 
+0003b9a0: 6761 7468 6572 732e 6974 656d 7328 290a  gathers.items().
+0003b9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b9c0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0003b9d0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0003b9e0: 2020 2020 2020 2020 666f 7220 722c 2076          for r, v
+0003b9f0: 2069 6e20 6761 7468 6572 732e 6974 656d   in gathers.item
+0003ba00: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+0003ba10: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
+0003ba20: 675f 6576 656e 7428 722c 207b 2261 6374  g_event(r, {"act
+0003ba30: 696f 6e22 3a20 2272 6570 6c69 6361 7465  ion": "replicate
+0003ba40: 2d61 6464 222c 2022 7768 6f5f 6861 7322  -add", "who_has"
+0003ba50: 3a20 767d 290a 0a20 2020 2020 2020 2020  : v})..         
+0003ba60: 2020 2073 656c 662e 6c6f 675f 6576 656e     self.log_even
+0003ba70: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+0003ba80: 2020 2022 616c 6c22 2c0a 2020 2020 2020     "all",.      
+0003ba90: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0003baa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bab0: 2261 6374 696f 6e22 3a20 2272 6570 6c69  "action": "repli
+0003bac0: 6361 7465 222c 0a20 2020 2020 2020 2020  cate",.         
+0003bad0: 2020 2020 2020 2020 2020 2022 776f 726b             "work
+0003bae0: 6572 7322 3a20 6c69 7374 2877 6f72 6b65  ers": list(worke
+0003baf0: 7273 292c 0a20 2020 2020 2020 2020 2020  rs),.           
+0003bb00: 2020 2020 2020 2020 2022 6b65 792d 636f           "key-co
+0003bb10: 756e 7422 3a20 6c65 6e28 6b65 7973 292c  unt": len(keys),
+0003bb20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003bb30: 2020 2020 2022 6272 616e 6368 696e 672d       "branching-
+0003bb40: 6661 6374 6f72 223a 2062 7261 6e63 6869  factor": branchi
+0003bb50: 6e67 5f66 6163 746f 722c 0a20 2020 2020  ng_factor,.     
+0003bb60: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
+0003bb70: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0003bb80: 2064 6566 2077 6f72 6b65 7273 5f74 6f5f   def workers_to_
+0003bb90: 636c 6f73 6528 0a20 2020 2020 2020 2073  close(.        s
+0003bba0: 656c 662c 0a20 2020 2020 2020 206d 656d  elf,.        mem
+0003bbb0: 6f72 795f 7261 7469 6f3a 2069 6e74 207c  ory_ratio: int |
+0003bbc0: 2066 6c6f 6174 207c 204e 6f6e 6520 3d20   float | None = 
+0003bbd0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6e3a  None,.        n:
+0003bbe0: 2069 6e74 207c 204e 6f6e 6520 3d20 4e6f   int | None = No
+0003bbf0: 6e65 2c0a 2020 2020 2020 2020 6b65 793a  ne,.        key:
+0003bc00: 2043 616c 6c61 626c 655b 5b57 6f72 6b65   Callable[[Worke
+0003bc10: 7253 7461 7465 5d2c 2048 6173 6861 626c  rState], Hashabl
+0003bc20: 655d 207c 2062 7974 6573 207c 204e 6f6e  e] | bytes | Non
+0003bc30: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+0003bc40: 2020 6d69 6e69 6d75 6d3a 2069 6e74 207c    minimum: int |
+0003bc50: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+0003bc60: 2020 2020 2020 7461 7267 6574 3a20 696e        target: in
+0003bc70: 7420 7c20 4e6f 6e65 203d 204e 6f6e 652c  t | None = None,
+0003bc80: 0a20 2020 2020 2020 2061 7474 7269 6275  .        attribu
+0003bc90: 7465 3a20 7374 7220 3d20 2261 6464 7265  te: str = "addre
+0003bca0: 7373 222c 0a20 2020 2029 202d 3e20 6c69  ss",.    ) -> li
+0003bcb0: 7374 5b73 7472 5d3a 0a20 2020 2020 2020  st[str]:.       
+0003bcc0: 2022 2222 0a20 2020 2020 2020 2046 696e   """.        Fin
+0003bcd0: 6420 776f 726b 6572 7320 7468 6174 2077  d workers that w
+0003bce0: 6520 6361 6e20 636c 6f73 6520 7769 7468  e can close with
+0003bcf0: 206c 6f77 2063 6f73 740a 0a20 2020 2020   low cost..     
+0003bd00: 2020 2054 6869 7320 7265 7475 726e 7320     This returns 
+0003bd10: 6120 6c69 7374 206f 6620 776f 726b 6572  a list of worker
+0003bd20: 7320 7468 6174 2061 7265 2067 6f6f 6420  s that are good 
+0003bd30: 6361 6e64 6964 6174 6573 2074 6f20 7265  candidates to re
+0003bd40: 7469 7265 2e0a 2020 2020 2020 2020 5468  tire..        Th
+0003bd50: 6573 6520 776f 726b 6572 7320 6172 6520  ese workers are 
+0003bd60: 6e6f 7420 7275 6e6e 696e 6720 616e 7974  not running anyt
+0003bd70: 6869 6e67 2061 6e64 2061 7265 2073 746f  hing and are sto
+0003bd80: 7269 6e67 0a20 2020 2020 2020 2072 656c  ring.        rel
+0003bd90: 6174 6976 656c 7920 6c69 7474 6c65 2064  atively little d
+0003bda0: 6174 6120 7265 6c61 7469 7665 2074 6f20  ata relative to 
+0003bdb0: 7468 6569 7220 7065 6572 732e 2020 4966  their peers.  If
+0003bdc0: 2061 6c6c 2077 6f72 6b65 7273 2061 7265   all workers are
+0003bdd0: 0a20 2020 2020 2020 2069 646c 6520 7468  .        idle th
+0003bde0: 656e 2077 6520 7374 696c 6c20 6d61 696e  en we still main
+0003bdf0: 7461 696e 2065 6e6f 7567 6820 776f 726b  tain enough work
+0003be00: 6572 7320 746f 2068 6176 6520 656e 6f75  ers to have enou
+0003be10: 6768 2052 414d 2074 6f20 7374 6f72 650a  gh RAM to store.
+0003be20: 2020 2020 2020 2020 6f75 7220 6461 7461          our data
+0003be30: 2c20 7769 7468 2061 2063 6f6d 666f 7274  , with a comfort
+0003be40: 6162 6c65 2062 7566 6665 722e 0a0a 2020  able buffer...  
+0003be50: 2020 2020 2020 5468 6973 2069 7320 666f        This is fo
+0003be60: 7220 7573 6520 7769 7468 2073 7973 7465  r use with syste
+0003be70: 6d73 206c 696b 6520 6060 6469 7374 7269  ms like ``distri
+0003be80: 6275 7465 642e 6465 706c 6f79 2e61 6461  buted.deploy.ada
+0003be90: 7074 6976 6560 602e 0a0a 2020 2020 2020  ptive``...      
+0003bea0: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+0003beb0: 2020 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a       ----------.
+0003bec0: 2020 2020 2020 2020 6d65 6d6f 7279 5f72          memory_r
+0003bed0: 6174 696f 203a 204e 756d 6265 720a 2020  atio : Number.  
+0003bee0: 2020 2020 2020 2020 2020 416d 6f75 6e74            Amount
+0003bef0: 206f 6620 6578 7472 6120 7370 6163 6520   of extra space 
+0003bf00: 7765 2077 616e 7420 746f 2068 6176 6520  we want to have 
+0003bf10: 666f 7220 6f75 7220 7374 6f72 6564 2064  for our stored d
+0003bf20: 6174 612e 0a20 2020 2020 2020 2020 2020  ata..           
+0003bf30: 2044 6566 6175 6c74 7320 746f 2032 2c20   Defaults to 2, 
+0003bf40: 6f72 2074 6861 7420 7765 2077 616e 7420  or that we want 
+0003bf50: 746f 2068 6176 6520 7477 6963 6520 6173  to have twice as
+0003bf60: 206d 7563 6820 6d65 6d6f 7279 2061 7320   much memory as 
+0003bf70: 7765 0a20 2020 2020 2020 2020 2020 2063  we.            c
+0003bf80: 7572 7265 6e74 6c79 2068 6176 6520 6461  urrently have da
+0003bf90: 7461 2e0a 2020 2020 2020 2020 6e20 3a20  ta..        n : 
+0003bfa0: 696e 740a 2020 2020 2020 2020 2020 2020  int.            
+0003bfb0: 4e75 6d62 6572 206f 6620 776f 726b 6572  Number of worker
+0003bfc0: 7320 746f 2063 6c6f 7365 0a20 2020 2020  s to close.     
+0003bfd0: 2020 206d 696e 696d 756d 203a 2069 6e74     minimum : int
+0003bfe0: 0a20 2020 2020 2020 2020 2020 204d 696e  .            Min
+0003bff0: 696d 756d 206e 756d 6265 7220 6f66 2077  imum number of w
+0003c000: 6f72 6b65 7273 2074 6f20 6b65 6570 2061  orkers to keep a
+0003c010: 726f 756e 640a 2020 2020 2020 2020 6b65  round.        ke
+0003c020: 7920 3a20 4361 6c6c 6162 6c65 2857 6f72  y : Callable(Wor
+0003c030: 6b65 7253 7461 7465 290a 2020 2020 2020  kerState).      
+0003c040: 2020 2020 2020 416e 206f 7074 696f 6e61        An optiona
+0003c050: 6c20 6361 6c6c 6162 6c65 206d 6170 7069  l callable mappi
+0003c060: 6e67 2061 2057 6f72 6b65 7253 7461 7465  ng a WorkerState
+0003c070: 206f 626a 6563 7420 746f 2061 2067 726f   object to a gro
+0003c080: 7570 0a20 2020 2020 2020 2020 2020 2061  up.            a
+0003c090: 6666 696c 6961 7469 6f6e 2e20 4772 6f75  ffiliation. Grou
+0003c0a0: 7073 2077 696c 6c20 6265 2063 6c6f 7365  ps will be close
+0003c0b0: 6420 746f 6765 7468 6572 2e20 5468 6973  d together. This
+0003c0c0: 2069 7320 7573 6566 756c 2077 6865 6e0a   is useful when.
+0003c0d0: 2020 2020 2020 2020 2020 2020 636c 6f73              clos
+0003c0e0: 696e 6720 776f 726b 6572 7320 6d75 7374  ing workers must
+0003c0f0: 2062 6520 646f 6e65 2063 6f6c 6c65 6374   be done collect
+0003c100: 6976 656c 792c 2073 7563 6820 6173 2062  ively, such as b
+0003c110: 7920 686f 7374 6e61 6d65 2e0a 2020 2020  y hostname..    
+0003c120: 2020 2020 7461 7267 6574 203a 2069 6e74      target : int
+0003c130: 0a20 2020 2020 2020 2020 2020 2054 6172  .            Tar
+0003c140: 6765 7420 6e75 6d62 6572 206f 6620 776f  get number of wo
+0003c150: 726b 6572 7320 746f 2068 6176 6520 6166  rkers to have af
+0003c160: 7465 7220 7765 2063 6c6f 7365 0a20 2020  ter we close.   
+0003c170: 2020 2020 2061 7474 7269 6275 7465 203a       attribute :
+0003c180: 2073 7472 0a20 2020 2020 2020 2020 2020   str.           
+0003c190: 2054 6865 2061 7474 7269 6275 7465 206f   The attribute o
+0003c1a0: 6620 7468 6520 576f 726b 6572 5374 6174  f the WorkerStat
+0003c1b0: 6520 6f62 6a65 6374 2074 6f20 7265 7475  e object to retu
+0003c1c0: 726e 2c20 6c69 6b65 2022 6164 6472 6573  rn, like "addres
+0003c1d0: 7322 0a20 2020 2020 2020 2020 2020 206f  s".            o
+0003c1e0: 7220 226e 616d 6522 2e20 2044 6566 6175  r "name".  Defau
+0003c1f0: 6c74 7320 746f 2022 6164 6472 6573 7322  lts to "address"
+0003c200: 2e0a 0a20 2020 2020 2020 2045 7861 6d70  ...        Examp
+0003c210: 6c65 730a 2020 2020 2020 2020 2d2d 2d2d  les.        ----
+0003c220: 2d2d 2d2d 0a20 2020 2020 2020 203e 3e3e  ----.        >>>
+0003c230: 2073 6368 6564 756c 6572 2e77 6f72 6b65   scheduler.worke
+0003c240: 7273 5f74 6f5f 636c 6f73 6528 290a 2020  rs_to_close().  
+0003c250: 2020 2020 2020 5b27 7463 703a 2f2f 3139        ['tcp://19
+0003c260: 322e 3136 382e 302e 313a 3132 3334 272c  2.168.0.1:1234',
+0003c270: 2027 7463 703a 2f2f 3139 322e 3136 382e   'tcp://192.168.
+0003c280: 302e 323a 3132 3334 275d 0a0a 2020 2020  0.2:1234']..    
+0003c290: 2020 2020 4772 6f75 7020 776f 726b 6572      Group worker
+0003c2a0: 7320 6279 2068 6f73 746e 616d 6520 7072  s by hostname pr
+0003c2b0: 696f 7220 746f 2063 6c6f 7369 6e67 0a0a  ior to closing..
+0003c2c0: 2020 2020 2020 2020 3e3e 3e20 7363 6865          >>> sche
+0003c2d0: 6475 6c65 722e 776f 726b 6572 735f 746f  duler.workers_to
+0003c2e0: 5f63 6c6f 7365 286b 6579 3d6c 616d 6264  _close(key=lambd
+0003c2f0: 6120 7773 3a20 7773 2e68 6f73 7429 0a20  a ws: ws.host). 
+0003c300: 2020 2020 2020 205b 2774 6370 3a2f 2f31         ['tcp://1
+0003c310: 3932 2e31 3638 2e30 2e31 3a31 3233 3427  92.168.0.1:1234'
+0003c320: 2c20 2774 6370 3a2f 2f31 3932 2e31 3638  , 'tcp://192.168
+0003c330: 2e30 2e31 3a34 3536 3727 5d0a 0a20 2020  .0.1:4567']..   
+0003c340: 2020 2020 2052 656d 6f76 6520 7477 6f20       Remove two 
+0003c350: 776f 726b 6572 730a 0a20 2020 2020 2020  workers..       
+0003c360: 203e 3e3e 2073 6368 6564 756c 6572 2e77   >>> scheduler.w
+0003c370: 6f72 6b65 7273 5f74 6f5f 636c 6f73 6528  orkers_to_close(
+0003c380: 6e3d 3229 0a0a 2020 2020 2020 2020 4b65  n=2)..        Ke
+0003c390: 6570 2065 6e6f 7567 6820 776f 726b 6572  ep enough worker
+0003c3a0: 7320 746f 2068 6176 6520 7477 6963 6520  s to have twice 
+0003c3b0: 6173 206d 7563 6820 6d65 6d6f 7279 2061  as much memory a
+0003c3c0: 7320 7765 2077 6520 6e65 6564 2e0a 0a20  s we we need... 
+0003c3d0: 2020 2020 2020 203e 3e3e 2073 6368 6564         >>> sched
+0003c3e0: 756c 6572 2e77 6f72 6b65 7273 5f74 6f5f  uler.workers_to_
+0003c3f0: 636c 6f73 6528 6d65 6d6f 7279 5f72 6174  close(memory_rat
+0003c400: 696f 3d32 290a 0a20 2020 2020 2020 2052  io=2)..        R
+0003c410: 6574 7572 6e73 0a20 2020 2020 2020 202d  eturns.        -
+0003c420: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2074  ------.        t
+0003c430: 6f5f 636c 6f73 653a 206c 6973 7420 6f66  o_close: list of
+0003c440: 2077 6f72 6b65 7220 6164 6472 6573 7365   worker addresse
+0003c450: 7320 7468 6174 2061 7265 204f 4b20 746f  s that are OK to
+0003c460: 2063 6c6f 7365 0a0a 2020 2020 2020 2020   close..        
+0003c470: 5365 6520 416c 736f 0a20 2020 2020 2020  See Also.       
+0003c480: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020   --------.      
+0003c490: 2020 5363 6865 6475 6c65 722e 7265 7469    Scheduler.reti
+0003c4a0: 7265 5f77 6f72 6b65 7273 0a20 2020 2020  re_workers.     
+0003c4b0: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
+0003c4c0: 6620 7461 7267 6574 2069 7320 6e6f 7420  f target is not 
+0003c4d0: 4e6f 6e65 2061 6e64 206e 2069 7320 4e6f  None and n is No
+0003c4e0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0003c4f0: 6e20 3d20 6c65 6e28 7365 6c66 2e77 6f72  n = len(self.wor
+0003c500: 6b65 7273 2920 2d20 7461 7267 6574 0a20  kers) - target. 
+0003c510: 2020 2020 2020 2069 6620 6e20 6973 206e         if n is n
+0003c520: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0003c530: 2020 2020 2069 6620 6e20 3c20 303a 0a20       if n < 0:. 
+0003c540: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0003c550: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
+0003c560: 2074 6172 6765 7420 3d20 6c65 6e28 7365   target = len(se
+0003c570: 6c66 2e77 6f72 6b65 7273 2920 2d20 6e0a  lf.workers) - n.
+0003c580: 0a20 2020 2020 2020 2069 6620 6e20 6973  .        if n is
+0003c590: 204e 6f6e 6520 616e 6420 6d65 6d6f 7279   None and memory
+0003c5a0: 5f72 6174 696f 2069 7320 4e6f 6e65 3a0a  _ratio is None:.
+0003c5b0: 2020 2020 2020 2020 2020 2020 6d65 6d6f              memo
+0003c5c0: 7279 5f72 6174 696f 203d 2032 0a0a 2020  ry_ratio = 2..  
+0003c5d0: 2020 2020 2020 7769 7468 206c 6f67 5f65        with log_e
+0003c5e0: 7272 6f72 7328 293a 0a20 2020 2020 2020  rrors():.       
+0003c5f0: 2020 2020 2069 6620 6e6f 7420 6e20 616e       if not n an
+0003c600: 6420 616c 6c28 5b77 732e 7072 6f63 6573  d all([ws.proces
+0003c610: 7369 6e67 2066 6f72 2077 7320 696e 2073  sing for ws in s
+0003c620: 656c 662e 776f 726b 6572 732e 7661 6c75  elf.workers.valu
+0003c630: 6573 2829 5d29 3a0a 2020 2020 2020 2020  es()]):.        
+0003c640: 2020 2020 2020 2020 7265 7475 726e 205b          return [
+0003c650: 5d0a 0a20 2020 2020 2020 2020 2020 2069  ]..            i
+0003c660: 6620 6b65 7920 6973 204e 6f6e 653a 0a20  f key is None:. 
+0003c670: 2020 2020 2020 2020 2020 2020 2020 206b                 k
+0003c680: 6579 203d 206f 7065 7261 746f 722e 6174  ey = operator.at
+0003c690: 7472 6765 7474 6572 2822 6164 6472 6573  trgetter("addres
+0003c6a0: 7322 290a 2020 2020 2020 2020 2020 2020  s").            
+0003c6b0: 6966 2069 7369 6e73 7461 6e63 6528 6b65  if isinstance(ke
+0003c6c0: 792c 2062 7974 6573 2920 616e 6420 6461  y, bytes) and da
+0003c6d0: 736b 2e63 6f6e 6669 672e 6765 7428 0a20  sk.config.get(. 
+0003c6e0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0003c6f0: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
+0003c700: 6475 6c65 722e 7069 636b 6c65 220a 2020  duler.pickle".  
+0003c710: 2020 2020 2020 2020 2020 293a 0a20 2020            ):.   
+0003c720: 2020 2020 2020 2020 2020 2020 206b 6579               key
+0003c730: 203d 2070 6963 6b6c 652e 6c6f 6164 7328   = pickle.loads(
+0003c740: 6b65 7929 0a0a 2020 2020 2020 2020 2020  key)..          
+0003c750: 2020 6772 6f75 7073 203d 2067 726f 7570    groups = group
+0003c760: 6279 286b 6579 2c20 7365 6c66 2e77 6f72  by(key, self.wor
+0003c770: 6b65 7273 2e76 616c 7565 7328 2929 0a0a  kers.values())..
+0003c780: 2020 2020 2020 2020 2020 2020 6c69 6d69              limi
+0003c790: 745f 6279 7465 7320 3d20 7b0a 2020 2020  t_bytes = {.    
+0003c7a0: 2020 2020 2020 2020 2020 2020 6b3a 2073              k: s
+0003c7b0: 756d 2877 732e 6d65 6d6f 7279 5f6c 696d  um(ws.memory_lim
+0003c7c0: 6974 2066 6f72 2077 7320 696e 2076 2920  it for ws in v) 
+0003c7d0: 666f 7220 6b2c 2076 2069 6e20 6772 6f75  for k, v in grou
+0003c7e0: 7073 2e69 7465 6d73 2829 0a20 2020 2020  ps.items().     
+0003c7f0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0003c800: 2020 2020 2067 726f 7570 5f62 7974 6573       group_bytes
+0003c810: 203d 207b 6b3a 2073 756d 2877 732e 6e62   = {k: sum(ws.nb
+0003c820: 7974 6573 2066 6f72 2077 7320 696e 2076  ytes for ws in v
+0003c830: 2920 666f 7220 6b2c 2076 2069 6e20 6772  ) for k, v in gr
+0003c840: 6f75 7073 2e69 7465 6d73 2829 7d0a 0a20  oups.items()}.. 
+0003c850: 2020 2020 2020 2020 2020 206c 696d 6974             limit
+0003c860: 203d 2073 756d 286c 696d 6974 5f62 7974   = sum(limit_byt
+0003c870: 6573 2e76 616c 7565 7328 2929 0a20 2020  es.values()).   
+0003c880: 2020 2020 2020 2020 2074 6f74 616c 203d           total =
+0003c890: 2073 756d 2867 726f 7570 5f62 7974 6573   sum(group_bytes
+0003c8a0: 2e76 616c 7565 7328 2929 0a0a 2020 2020  .values())..    
+0003c8b0: 2020 2020 2020 2020 6465 6620 5f6b 6579          def _key
+0003c8c0: 2867 726f 7570 293a 0a20 2020 2020 2020  (group):.       
+0003c8d0: 2020 2020 2020 2020 2069 735f 6964 6c65           is_idle
+0003c8e0: 203d 206e 6f74 2061 6e79 285b 7777 732e   = not any([wws.
+0003c8f0: 7072 6f63 6573 7369 6e67 2066 6f72 2077  processing for w
+0003c900: 7773 2069 6e20 6772 6f75 7073 5b67 726f  ws in groups[gro
+0003c910: 7570 5d5d 290a 2020 2020 2020 2020 2020  up]]).          
+0003c920: 2020 2020 2020 6279 7465 7320 3d20 2d67        bytes = -g
+0003c930: 726f 7570 5f62 7974 6573 5b67 726f 7570  roup_bytes[group
+0003c940: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0003c950: 2020 7265 7475 726e 2069 735f 6964 6c65    return is_idle
+0003c960: 2c20 6279 7465 730a 0a20 2020 2020 2020  , bytes..       
+0003c970: 2020 2020 2069 646c 6520 3d20 736f 7274       idle = sort
+0003c980: 6564 2867 726f 7570 732c 206b 6579 3d5f  ed(groups, key=_
+0003c990: 6b65 7929 0a0a 2020 2020 2020 2020 2020  key)..          
+0003c9a0: 2020 746f 5f63 6c6f 7365 203d 205b 5d0a    to_close = [].
+0003c9b0: 2020 2020 2020 2020 2020 2020 6e5f 7265              n_re
+0003c9c0: 6d61 696e 203d 206c 656e 2873 656c 662e  main = len(self.
+0003c9d0: 776f 726b 6572 7329 0a0a 2020 2020 2020  workers)..      
+0003c9e0: 2020 2020 2020 7768 696c 6520 6964 6c65        while idle
+0003c9f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003ca00: 2020 6772 6f75 7020 3d20 6964 6c65 2e70    group = idle.p
+0003ca10: 6f70 2829 0a20 2020 2020 2020 2020 2020  op().           
+0003ca20: 2020 2020 2069 6620 6e20 6973 204e 6f6e       if n is Non
+0003ca30: 6520 616e 6420 616e 7928 5b77 732e 7072  e and any([ws.pr
+0003ca40: 6f63 6573 7369 6e67 2066 6f72 2077 7320  ocessing for ws 
+0003ca50: 696e 2067 726f 7570 735b 6772 6f75 705d  in groups[group]
+0003ca60: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
+0003ca70: 2020 2020 2020 2020 6272 6561 6b0a 0a20          break.. 
+0003ca80: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0003ca90: 6620 6d69 6e69 6d75 6d20 616e 6420 6e5f  f minimum and n_
+0003caa0: 7265 6d61 696e 202d 206c 656e 2867 726f  remain - len(gro
+0003cab0: 7570 735b 6772 6f75 705d 2920 3c20 6d69  ups[group]) < mi
+0003cac0: 6e69 6d75 6d3a 0a20 2020 2020 2020 2020  nimum:.         
+0003cad0: 2020 2020 2020 2020 2020 2062 7265 616b             break
+0003cae0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0003caf0: 2020 6c69 6d69 7420 2d3d 206c 696d 6974    limit -= limit
+0003cb00: 5f62 7974 6573 5b67 726f 7570 5d0a 0a20  _bytes[group].. 
+0003cb10: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0003cb20: 6620 280a 2020 2020 2020 2020 2020 2020  f (.            
+0003cb30: 2020 2020 2020 2020 6e20 6973 206e 6f74          n is not
+0003cb40: 204e 6f6e 6520 616e 6420 6e5f 7265 6d61   None and n_rema
+0003cb50: 696e 202d 206c 656e 2867 726f 7570 735b  in - len(groups[
+0003cb60: 6772 6f75 705d 2920 3e3d 2028 7461 7267  group]) >= (targ
+0003cb70: 6574 206f 7220 3029 0a20 2020 2020 2020  et or 0).       
+0003cb80: 2020 2020 2020 2020 2029 206f 7220 286d           ) or (m
+0003cb90: 656d 6f72 795f 7261 7469 6f20 6973 206e  emory_ratio is n
+0003cba0: 6f74 204e 6f6e 6520 616e 6420 6c69 6d69  ot None and limi
+0003cbb0: 7420 3e3d 206d 656d 6f72 795f 7261 7469  t >= memory_rati
+0003cbc0: 6f20 2a20 746f 7461 6c29 3a0a 2020 2020  o * total):.    
+0003cbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003cbe0: 746f 5f63 6c6f 7365 2e61 7070 656e 6428  to_close.append(
+0003cbf0: 6772 6f75 7029 0a20 2020 2020 2020 2020  group).         
+0003cc00: 2020 2020 2020 2020 2020 206e 5f72 656d             n_rem
+0003cc10: 6169 6e20 2d3d 206c 656e 2867 726f 7570  ain -= len(group
+0003cc20: 735b 6772 6f75 705d 290a 0a20 2020 2020  s[group])..     
+0003cc30: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0003cc40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003cc50: 2020 2020 2062 7265 616b 0a0a 2020 2020       break..    
+0003cc60: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+0003cc70: 205b 6765 7461 7474 7228 7773 2c20 6174   [getattr(ws, at
+0003cc80: 7472 6962 7574 6529 2066 6f72 2067 2069  tribute) for g i
+0003cc90: 6e20 746f 5f63 6c6f 7365 2066 6f72 2077  n to_close for w
+0003cca0: 7320 696e 2067 726f 7570 735b 675d 5d0a  s in groups[g]].
+0003ccb0: 2020 2020 2020 2020 2020 2020 6966 2072              if r
+0003ccc0: 6573 756c 743a 0a20 2020 2020 2020 2020  esult:.         
+0003ccd0: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
+0003cce0: 6275 6728 2253 7567 6765 7374 2063 6c6f  bug("Suggest clo
+0003ccf0: 7369 6e67 2077 6f72 6b65 7273 3a20 2573  sing workers: %s
+0003cd00: 222c 2072 6573 756c 7429 0a0a 2020 2020  ", result)..    
+0003cd10: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+0003cd20: 6573 756c 740a 0a20 2020 2040 6c6f 675f  esult..    @log_
+0003cd30: 6572 726f 7273 0a20 2020 2061 7379 6e63  errors.    async
+0003cd40: 2064 6566 2072 6574 6972 655f 776f 726b   def retire_work
+0003cd50: 6572 7328 0a20 2020 2020 2020 2073 656c  ers(.        sel
+0003cd60: 662c 0a20 2020 2020 2020 2077 6f72 6b65  f,.        worke
+0003cd70: 7273 3a20 6c69 7374 5b73 7472 5d20 7c20  rs: list[str] | 
+0003cd80: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+0003cd90: 2020 2020 202a 2c0a 2020 2020 2020 2020       *,.        
+0003cda0: 6e61 6d65 733a 206c 6973 7420 7c20 4e6f  names: list | No
+0003cdb0: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
+0003cdc0: 2020 2063 6c6f 7365 5f77 6f72 6b65 7273     close_workers
+0003cdd0: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
+0003cde0: 2020 2020 2020 2020 7265 6d6f 7665 3a20          remove: 
+0003cdf0: 626f 6f6c 203d 2054 7275 652c 0a20 2020  bool = True,.   
+0003ce00: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
+0003ce10: 3a20 7374 7220 7c20 4e6f 6e65 203d 204e  : str | None = N
+0003ce20: 6f6e 652c 0a20 2020 2020 2020 202a 2a6b  one,.        **k
+0003ce30: 7761 7267 733a 2041 6e79 2c0a 2020 2020  wargs: Any,.    
+0003ce40: 2920 2d3e 2064 6963 745b 7374 722c 2041  ) -> dict[str, A
+0003ce50: 6e79 5d3a 0a20 2020 2020 2020 2022 2222  ny]:.        """
+0003ce60: 4772 6163 6566 756c 6c79 2072 6574 6972  Gracefully retir
+0003ce70: 6520 776f 726b 6572 7320 6672 6f6d 2063  e workers from c
+0003ce80: 6c75 7374 6572 2e20 416e 7920 6b65 7920  luster. Any key 
+0003ce90: 7468 6174 2069 7320 696e 206d 656d 6f72  that is in memor
+0003cea0: 7920 6578 636c 7573 6976 656c 790a 2020  y exclusively.  
+0003ceb0: 2020 2020 2020 6f6e 2074 6865 2072 6574        on the ret
+0003cec0: 6972 6564 2077 6f72 6b65 7273 2069 7320  ired workers is 
+0003ced0: 7265 706c 6963 6174 6564 2073 6f6d 6577  replicated somew
+0003cee0: 6865 7265 2065 6c73 652e 0a0a 2020 2020  here else...    
+0003cef0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+0003cf00: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d2d         ---------
+0003cf10: 2d0a 2020 2020 2020 2020 776f 726b 6572  -.        worker
+0003cf20: 733a 206c 6973 745b 7374 725d 2028 6f70  s: list[str] (op
+0003cf30: 7469 6f6e 616c 290a 2020 2020 2020 2020  tional).        
+0003cf40: 2020 2020 4c69 7374 206f 6620 776f 726b      List of work
+0003cf50: 6572 2061 6464 7265 7373 6573 2074 6f20  er addresses to 
+0003cf60: 7265 7469 7265 2e0a 2020 2020 2020 2020  retire..        
+0003cf70: 6e61 6d65 733a 206c 6973 7420 286f 7074  names: list (opt
+0003cf80: 696f 6e61 6c29 0a20 2020 2020 2020 2020  ional).         
+0003cf90: 2020 204c 6973 7420 6f66 2077 6f72 6b65     List of worke
+0003cfa0: 7220 6e61 6d65 7320 746f 2072 6574 6972  r names to retir
+0003cfb0: 652e 0a20 2020 2020 2020 2020 2020 204d  e..            M
+0003cfc0: 7574 7561 6c6c 7920 6578 636c 7573 6976  utually exclusiv
+0003cfd0: 6520 7769 7468 2060 6077 6f72 6b65 7273  e with ``workers
+0003cfe0: 6060 2e0a 2020 2020 2020 2020 2020 2020  ``..            
+0003cff0: 4966 206e 6569 7468 6572 2060 6077 6f72  If neither ``wor
+0003d000: 6b65 7273 6060 206e 6f72 2060 606e 616d  kers`` nor ``nam
+0003d010: 6573 6060 2061 7265 2070 726f 7669 6465  es`` are provide
+0003d020: 642c 2077 6520 6361 6c6c 0a20 2020 2020  d, we call.     
+0003d030: 2020 2020 2020 2060 6077 6f72 6b65 7273         ``workers
+0003d040: 5f74 6f5f 636c 6f73 6560 6020 7768 6963  _to_close`` whic
+0003d050: 6820 6669 6e64 7320 6120 676f 6f64 2073  h finds a good s
+0003d060: 6574 2e0a 2020 2020 2020 2020 636c 6f73  et..        clos
+0003d070: 655f 776f 726b 6572 733a 2062 6f6f 6c20  e_workers: bool 
+0003d080: 2864 6566 6175 6c74 7320 746f 2046 616c  (defaults to Fal
+0003d090: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
+0003d0a0: 5768 6574 6865 7220 6f72 206e 6f74 2074  Whether or not t
+0003d0b0: 6f20 6163 7475 616c 6c79 2063 6c6f 7365  o actually close
+0003d0c0: 2074 6865 2077 6f72 6b65 7220 6578 706c   the worker expl
+0003d0d0: 6963 6974 6c79 2066 726f 6d20 6865 7265  icitly from here
+0003d0e0: 2e0a 2020 2020 2020 2020 2020 2020 4f74  ..            Ot
+0003d0f0: 6865 7277 6973 6520 7765 2065 7870 6563  herwise we expec
+0003d100: 7420 736f 6d65 2065 7874 6572 6e61 6c20  t some external 
+0003d110: 6a6f 6220 7363 6865 6475 6c65 7220 746f  job scheduler to
+0003d120: 2066 696e 6973 6820 6f66 6620 7468 650a   finish off the.
+0003d130: 2020 2020 2020 2020 2020 2020 776f 726b              work
+0003d140: 6572 2e0a 2020 2020 2020 2020 7265 6d6f  er..        remo
+0003d150: 7665 3a20 626f 6f6c 2028 6465 6661 756c  ve: bool (defaul
+0003d160: 7473 2074 6f20 5472 7565 290a 2020 2020  ts to True).    
+0003d170: 2020 2020 2020 2020 5768 6574 6865 7220          Whether 
+0003d180: 6f72 206e 6f74 2074 6f20 7265 6d6f 7665  or not to remove
+0003d190: 2074 6865 2077 6f72 6b65 7220 6d65 7461   the worker meta
+0003d1a0: 6461 7461 2069 6d6d 6564 6961 7465 6c79  data immediately
+0003d1b0: 206f 7220 656c 7365 0a20 2020 2020 2020   or else.       
+0003d1c0: 2020 2020 2077 6169 7420 666f 7220 7468       wait for th
+0003d1d0: 6520 776f 726b 6572 2074 6f20 636f 6e74  e worker to cont
+0003d1e0: 6163 7420 7573 2e0a 0a20 2020 2020 2020  act us...       
+0003d1f0: 2020 2020 2049 6620 636c 6f73 655f 776f       If close_wo
+0003d200: 726b 6572 733d 4661 6c73 6520 616e 6420  rkers=False and 
+0003d210: 7265 6d6f 7665 3d46 616c 7365 2c20 7468  remove=False, th
+0003d220: 6973 206d 6574 686f 6420 6a75 7374 2066  is method just f
+0003d230: 6c75 7368 6573 2074 6865 2074 6173 6b73  lushes the tasks
+0003d240: 0a20 2020 2020 2020 2020 2020 2069 6e20  .            in 
+0003d250: 6d65 6d6f 7279 206f 7574 206f 6620 7468  memory out of th
+0003d260: 6520 776f 726b 6572 7320 616e 6420 7468  e workers and th
+0003d270: 656e 2072 6574 7572 6e73 2e0a 2020 2020  en returns..    
+0003d280: 2020 2020 2020 2020 4966 2063 6c6f 7365          If close
+0003d290: 5f77 6f72 6b65 7273 3d54 7275 6520 616e  _workers=True an
+0003d2a0: 6420 7265 6d6f 7665 3d46 616c 7365 2c20  d remove=False, 
+0003d2b0: 7468 6973 206d 6574 686f 6420 7769 6c6c  this method will
+0003d2c0: 2072 6574 7572 6e20 7768 696c 6520 7468   return while th
+0003d2d0: 650a 2020 2020 2020 2020 2020 2020 776f  e.            wo
+0003d2e0: 726b 6572 7320 6172 6520 7374 696c 6c20  rkers are still 
+0003d2f0: 696e 2074 6865 2063 6c75 7374 6572 2c20  in the cluster, 
+0003d300: 616c 7468 6f75 6768 2074 6865 7920 776f  although they wo
+0003d310: 6e27 7420 6163 6365 7074 206e 6577 2074  n't accept new t
+0003d320: 6173 6b73 2e0a 2020 2020 2020 2020 2020  asks..          
+0003d330: 2020 4966 2063 6c6f 7365 5f77 6f72 6b65    If close_worke
+0003d340: 7273 3d46 616c 7365 206f 7220 666f 7220  rs=False or for 
+0003d350: 7768 6174 6576 6572 2072 6561 736f 6e20  whatever reason 
+0003d360: 6120 776f 726b 6572 2064 6f65 736e 2774  a worker doesn't
+0003d370: 2061 6363 6570 7420 7468 650a 2020 2020   accept the.    
+0003d380: 2020 2020 2020 2020 636c 6f73 6520 636f          close co
+0003d390: 6d6d 616e 642c 2069 7420 7769 6c6c 2062  mmand, it will b
+0003d3a0: 6520 6c65 6674 2070 6572 6d61 6e65 6e74  e left permanent
+0003d3b0: 6c79 2075 6e61 626c 6520 746f 2061 6363  ly unable to acc
+0003d3c0: 6570 7420 6e65 7720 7461 736b 7320 616e  ept new tasks an
+0003d3d0: 640a 2020 2020 2020 2020 2020 2020 6974  d.            it
+0003d3e0: 2069 7320 6578 7065 6374 6564 2074 6f20   is expected to 
+0003d3f0: 6265 2063 6c6f 7365 6420 696e 2073 6f6d  be closed in som
+0003d400: 6520 6f74 6865 7220 7761 792e 0a0a 2020  e other way...  
+0003d410: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
+0003d420: 6469 6374 0a20 2020 2020 2020 2020 2020  dict.           
+0003d430: 2045 7874 7261 206f 7074 696f 6e73 2074   Extra options t
+0003d440: 6f20 7061 7373 2074 6f20 776f 726b 6572  o pass to worker
+0003d450: 735f 746f 5f63 6c6f 7365 2074 6f20 6465  s_to_close to de
+0003d460: 7465 726d 696e 6520 7768 6963 680a 2020  termine which.  
+0003d470: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+0003d480: 7320 7765 2073 686f 756c 6420 6472 6f70  s we should drop
+0003d490: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+0003d4a0: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
+0003d4b0: 2d0a 2020 2020 2020 2020 4469 6374 696f  -.        Dictio
+0003d4c0: 6e61 7279 206d 6170 7069 6e67 2077 6f72  nary mapping wor
+0003d4d0: 6b65 7220 4944 2f61 6464 7265 7373 2074  ker ID/address t
+0003d4e0: 6f20 6469 6374 696f 6e61 7279 206f 6620  o dictionary of 
+0003d4f0: 696e 666f 726d 6174 696f 6e20 6162 6f75  information abou
+0003d500: 740a 2020 2020 2020 2020 7468 6174 2077  t.        that w
+0003d510: 6f72 6b65 7220 666f 7220 6561 6368 2072  orker for each r
+0003d520: 6574 6972 6564 2077 6f72 6b65 722e 0a0a  etired worker...
+0003d530: 2020 2020 2020 2020 4966 2074 6865 7265          If there
+0003d540: 2061 7265 206b 6579 7320 7468 6174 2065   are keys that e
+0003d550: 7869 7374 2069 6e20 6d65 6d6f 7279 206f  xist in memory o
+0003d560: 6e6c 7920 6f6e 2074 6865 2077 6f72 6b65  nly on the worke
+0003d570: 7273 2062 6569 6e67 2072 6574 6972 6564  rs being retired
+0003d580: 2061 6e64 2069 740a 2020 2020 2020 2020   and it.        
+0003d590: 7761 7320 696d 706f 7373 6962 6c65 2074  was impossible t
+0003d5a0: 6f20 7265 706c 6963 6174 6520 7468 656d  o replicate them
+0003d5b0: 2073 6f6d 6577 6865 7265 2065 6c73 6520   somewhere else 
+0003d5c0: 2865 2e67 2e20 6265 6361 7573 6520 7468  (e.g. because th
+0003d5d0: 6572 6520 6172 656e 2774 0a20 2020 2020  ere aren't.     
+0003d5e0: 2020 2061 6e79 206f 7468 6572 2072 756e     any other run
+0003d5f0: 6e69 6e67 2077 6f72 6b65 7273 292c 2074  ning workers), t
+0003d600: 6865 2077 6f72 6b65 7273 2068 6f6c 6469  he workers holdi
+0003d610: 6e67 2073 7563 6820 6b65 7973 2077 6f6e  ng such keys won
+0003d620: 2774 2062 6520 7265 7469 7265 6420 616e  't be retired an
+0003d630: 640a 2020 2020 2020 2020 776f 6e27 7420  d.        won't 
+0003d640: 6170 7065 6172 2069 6e20 7468 6520 7265  appear in the re
+0003d650: 7475 726e 6564 2064 6963 742e 0a0a 2020  turned dict...  
+0003d660: 2020 2020 2020 5365 6520 416c 736f 0a20        See Also. 
+0003d670: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d0a         --------.
+0003d680: 2020 2020 2020 2020 5363 6865 6475 6c65          Schedule
+0003d690: 722e 776f 726b 6572 735f 746f 5f63 6c6f  r.workers_to_clo
+0003d6a0: 7365 0a20 2020 2020 2020 2022 2222 0a20  se.        """. 
+0003d6b0: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
+0003d6c0: 6964 203d 2073 7469 6d75 6c75 735f 6964  id = stimulus_id
+0003d6d0: 206f 7220 6622 7265 7469 7265 2d77 6f72   or f"retire-wor
+0003d6e0: 6b65 7273 2d7b 7469 6d65 2829 7d22 0a20  kers-{time()}". 
+0003d6f0: 2020 2020 2020 2023 2054 6869 7320 6c6f         # This lo
+0003d700: 636b 206d 616b 6573 2072 6574 6972 655f  ck makes retire_
+0003d710: 776f 726b 6572 732c 2072 6562 616c 616e  workers, rebalan
+0003d720: 6365 2c20 616e 6420 7265 706c 6963 6174  ce, and replicat
+0003d730: 6520 6d75 7475 616c 6c79 0a20 2020 2020  e mutually.     
+0003d740: 2020 2023 2065 7863 6c75 7369 7665 2061     # exclusive a
+0003d750: 6e64 2077 696c 6c20 6e6f 206c 6f6e 6765  nd will no longe
+0003d760: 7220 6265 206e 6563 6573 7361 7279 206f  r be necessary o
+0003d770: 6e63 6520 7265 6261 6c61 6e63 6520 616e  nce rebalance an
+0003d780: 6420 7265 706c 6963 6174 6520 6172 650a  d replicate are.
+0003d790: 2020 2020 2020 2020 2320 6d69 6772 6174          # migrat
+0003d7a0: 6564 2074 6f20 7468 6520 4163 7469 7665  ed to the Active
+0003d7b0: 204d 656d 6f72 7920 4d61 6e61 6765 722e   Memory Manager.
+0003d7c0: 0a20 2020 2020 2020 2023 204e 6f74 6520  .        # Note 
+0003d7d0: 7468 6174 2c20 696e 6369 6465 6e74 616c  that, incidental
+0003d7e0: 6c79 2c20 6974 2061 6c73 6f20 7072 6576  ly, it also prev
+0003d7f0: 656e 7473 206d 756c 7469 706c 6520 6361  ents multiple ca
+0003d800: 6c6c 7320 746f 2072 6574 6972 655f 776f  lls to retire_wo
+0003d810: 726b 6572 730a 2020 2020 2020 2020 2320  rkers.        # 
+0003d820: 6672 6f6d 2072 756e 6e69 6e67 2069 6e20  from running in 
+0003d830: 7061 7261 6c6c 656c 202d 2074 6869 7320  parallel - this 
+0003d840: 6973 2075 6e6e 6563 6573 7361 7279 2e0a  is unnecessary..
+0003d850: 2020 2020 2020 2020 6173 796e 6320 7769          async wi
+0003d860: 7468 2073 656c 662e 5f6c 6f63 6b3a 0a20  th self._lock:. 
+0003d870: 2020 2020 2020 2020 2020 2069 6620 6e61             if na
+0003d880: 6d65 7320 6973 206e 6f74 204e 6f6e 653a  mes is not None:
+0003d890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d8a0: 2069 6620 776f 726b 6572 7320 6973 206e   if workers is n
+0003d8b0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0003d8c0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0003d8d0: 7365 2054 7970 6545 7272 6f72 2822 6e61  se TypeError("na
+0003d8e0: 6d65 7320 616e 6420 776f 726b 6572 7320  mes and workers 
+0003d8f0: 6172 6520 6d75 7475 616c 6c79 2065 7863  are mutually exc
+0003d900: 6c75 7369 7665 2229 0a20 2020 2020 2020  lusive").       
+0003d910: 2020 2020 2020 2020 2069 6620 6e61 6d65           if name
+0003d920: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0003d930: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
+0003d940: 666f 2822 5265 7469 7265 2077 6f72 6b65  fo("Retire worke
+0003d950: 7220 6e61 6d65 7320 2573 222c 206e 616d  r names %s", nam
+0003d960: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
+0003d970: 2020 2020 2320 5375 7070 6f72 7420 6361      # Support ca
+0003d980: 7365 7320 7768 6572 6520 6e61 6d65 7320  ses where names 
+0003d990: 6172 6520 7061 7373 6564 2074 6872 6f75  are passed throu
+0003d9a0: 6768 2061 2043 4c49 2061 6e64 2062 6563  gh a CLI and bec
+0003d9b0: 6f6d 650a 2020 2020 2020 2020 2020 2020  ome.            
+0003d9c0: 2020 2020 2320 7374 7269 6e67 730a 2020      # strings.  
+0003d9d0: 2020 2020 2020 2020 2020 2020 2020 6e61                na
+0003d9e0: 6d65 735f 7365 7420 3d20 7b73 7472 286e  mes_set = {str(n
+0003d9f0: 616d 6529 2066 6f72 206e 616d 6520 696e  ame) for name in
+0003da00: 206e 616d 6573 7d0a 2020 2020 2020 2020   names}.        
+0003da10: 2020 2020 2020 2020 7773 7320 3d20 7b77          wss = {w
+0003da20: 7320 666f 7220 7773 2069 6e20 7365 6c66  s for ws in self
+0003da30: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
+0003da40: 2920 6966 2073 7472 2877 732e 6e61 6d65  ) if str(ws.name
+0003da50: 2920 696e 206e 616d 6573 5f73 6574 7d0a  ) in names_set}.
+0003da60: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+0003da70: 2077 6f72 6b65 7273 2069 7320 6e6f 7420   workers is not 
+0003da80: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0003da90: 2020 2020 2020 7773 7320 3d20 7b0a 2020        wss = {.  
+0003daa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dab0: 2020 7365 6c66 2e77 6f72 6b65 7273 5b61    self.workers[a
+0003dac0: 6464 7265 7373 5d0a 2020 2020 2020 2020  ddress].        
+0003dad0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0003dae0: 6164 6472 6573 7320 696e 2077 6f72 6b65  address in worke
+0003daf0: 7273 0a20 2020 2020 2020 2020 2020 2020  rs.             
+0003db00: 2020 2020 2020 2069 6620 6164 6472 6573         if addres
+0003db10: 7320 696e 2073 656c 662e 776f 726b 6572  s in self.worker
+0003db20: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+0003db30: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0003db40: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0003db50: 2020 2020 2020 7773 7320 3d20 7b0a 2020        wss = {.  
+0003db60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003db70: 2020 7365 6c66 2e77 6f72 6b65 7273 5b61    self.workers[a
+0003db80: 6464 7265 7373 5d20 666f 7220 6164 6472  ddress] for addr
+0003db90: 6573 7320 696e 2073 656c 662e 776f 726b  ess in self.work
+0003dba0: 6572 735f 746f 5f63 6c6f 7365 282a 2a6b  ers_to_close(**k
+0003dbb0: 7761 7267 7329 0a20 2020 2020 2020 2020  wargs).         
+0003dbc0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0003dbd0: 2020 2020 2069 6620 6e6f 7420 7773 733a       if not wss:
+0003dbe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003dbf0: 2072 6574 7572 6e20 7b7d 0a0a 2020 2020   return {}..    
+0003dc00: 2020 2020 2020 2020 7374 6f70 5f61 6d6d          stop_amm
+0003dc10: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+0003dc20: 2020 2020 2061 6d6d 3a20 4163 7469 7665       amm: Active
+0003dc30: 4d65 6d6f 7279 4d61 6e61 6765 7245 7874  MemoryManagerExt
+0003dc40: 656e 7369 6f6e 207c 204e 6f6e 6520 3d20  ension | None = 
+0003dc50: 7365 6c66 2e65 7874 656e 7369 6f6e 732e  self.extensions.
+0003dc60: 6765 7428 2261 6d6d 2229 0a20 2020 2020  get("amm").     
+0003dc70: 2020 2020 2020 2069 6620 6e6f 7420 616d         if not am
+0003dc80: 6d20 6f72 206e 6f74 2061 6d6d 2e72 756e  m or not amm.run
+0003dc90: 6e69 6e67 3a0a 2020 2020 2020 2020 2020  ning:.          
+0003dca0: 2020 2020 2020 616d 6d20 3d20 4163 7469        amm = Acti
+0003dcb0: 7665 4d65 6d6f 7279 4d61 6e61 6765 7245  veMemoryManagerE
+0003dcc0: 7874 656e 7369 6f6e 280a 2020 2020 2020  xtension(.      
+0003dcd0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0003dce0: 6c66 2c20 706f 6c69 6369 6573 3d73 6574  lf, policies=set
+0003dcf0: 2829 2c20 7265 6769 7374 6572 3d46 616c  (), register=Fal
+0003dd00: 7365 2c20 7374 6172 743d 5472 7565 2c20  se, start=True, 
+0003dd10: 696e 7465 7276 616c 3d32 2e30 0a20 2020  interval=2.0.   
+0003dd20: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+0003dd30: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0003dd40: 746f 705f 616d 6d20 3d20 5472 7565 0a0a  top_amm = True..
+0003dd50: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+0003dd60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003dd70: 2063 6f72 6f73 203d 205b 5d0a 2020 2020   coros = [].    
+0003dd80: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0003dd90: 7773 2069 6e20 7773 733a 0a20 2020 2020  ws in wss:.     
+0003dda0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0003ddb0: 6f67 6765 722e 696e 666f 2822 5265 7469  ogger.info("Reti
+0003ddc0: 7269 6e67 2077 6f72 6b65 7220 2573 222c  ring worker %s",
+0003ddd0: 2077 732e 6164 6472 6573 7329 0a0a 2020   ws.address)..  
+0003dde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ddf0: 2020 706f 6c69 6379 203d 2052 6574 6972    policy = Retir
+0003de00: 6557 6f72 6b65 7228 7773 2e61 6464 7265  eWorker(ws.addre
+0003de10: 7373 290a 2020 2020 2020 2020 2020 2020  ss).            
+0003de20: 2020 2020 2020 2020 616d 6d2e 6164 645f          amm.add_
+0003de30: 706f 6c69 6379 2870 6f6c 6963 7929 0a0a  policy(policy)..
+0003de40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003de50: 2020 2020 2320 4368 616e 6765 2057 6f72      # Change Wor
+0003de60: 6b65 722e 7374 6174 7573 2074 6f20 636c  ker.status to cl
+0003de70: 6f73 696e 675f 6772 6163 6566 756c 6c79  osing_gracefully
+0003de80: 2e20 496d 6d65 6469 6174 656c 7920 7365  . Immediately se
+0003de90: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+0003dea0: 2020 2020 2020 2320 7468 6520 7361 6d65        # the same
+0003deb0: 206f 6e20 7468 6520 7363 6865 6475 6c65   on the schedule
+0003dec0: 7220 746f 2070 7265 7665 6e74 2072 6163  r to prevent rac
+0003ded0: 6520 636f 6e64 6974 696f 6e73 2e0a 2020  e conditions..  
 0003dee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003def0: 2020 2020 2020 2020 2273 7461 7475 7322          "status"
-0003df00: 3a20 7773 2e73 7461 7475 732e 6e61 6d65  : ws.status.name
-0003df10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0003df20: 2020 2020 2020 2020 2020 2020 2020 2273                "s
-0003df30: 7469 6d75 6c75 735f 6964 223a 2073 7469  timulus_id": sti
-0003df40: 6d75 6c75 735f 6964 2c0a 2020 2020 2020  mulus_id,.      
-0003df50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003df60: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0003df70: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0003df80: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0003df90: 6f72 6f73 2e61 7070 656e 6428 0a20 2020  oros.append(.   
-0003dfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003dfb0: 2020 2020 2073 656c 662e 5f74 7261 636b       self._track
-0003dfc0: 5f72 6574 6972 655f 776f 726b 6572 280a  _retire_worker(.
-0003dfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003dfe0: 2020 2020 2020 2020 2020 2020 7773 2c0a              ws,.
-0003dff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e000: 2020 2020 2020 2020 2020 2020 706f 6c69              poli
-0003e010: 6379 2c0a 2020 2020 2020 2020 2020 2020  cy,.            
-0003e020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e030: 7072 6576 5f73 7461 7475 733d 7072 6576  prev_status=prev
-0003e040: 5f73 7461 7475 732c 0a20 2020 2020 2020  _status,.       
-0003e050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e060: 2020 2020 2063 6c6f 7365 3d63 6c6f 7365       close=close
-0003e070: 5f77 6f72 6b65 7273 2c0a 2020 2020 2020  _workers,.      
-0003e080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e090: 2020 2020 2020 7265 6d6f 7665 3d72 656d        remove=rem
-0003e0a0: 6f76 652c 0a20 2020 2020 2020 2020 2020  ove,.           
-0003e0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e0c0: 2073 7469 6d75 6c75 735f 6964 3d73 7469   stimulus_id=sti
-0003e0d0: 6d75 6c75 735f 6964 2c0a 2020 2020 2020  mulus_id,.      
-0003e0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e0f0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0003e100: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0003e110: 2020 2020 2020 2020 2020 2023 2047 6976             # Giv
-0003e120: 6520 7468 6520 414d 4d20 6120 6b69 636b  e the AMM a kick
-0003e130: 2c20 696e 2061 6464 6974 696f 6e20 746f  , in addition to
-0003e140: 2069 7473 2070 6572 696f 6469 6320 7275   its periodic ru
-0003e150: 6e6e 696e 672e 2054 6869 7320 6973 0a20  nning. This is. 
-0003e160: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0003e170: 2074 6f20 6176 6f69 6420 756e 6e65 6365   to avoid unnece
-0003e180: 7373 6172 696c 7920 7761 6974 696e 6720  ssarily waiting 
-0003e190: 666f 7220 6120 706f 7465 6e74 6961 6c6c  for a potentiall
-0003e1a0: 7920 6172 6269 7472 6172 696c 7920 6c6f  y arbitrarily lo
-0003e1b0: 6e67 0a20 2020 2020 2020 2020 2020 2020  ng.             
-0003e1c0: 2020 2023 2074 696d 6520 2864 6570 656e     # time (depen
-0003e1d0: 6469 6e67 206f 6e20 696e 7465 7276 616c  ding on interval
-0003e1e0: 2073 6574 7469 6e67 7329 0a20 2020 2020   settings).     
-0003e1f0: 2020 2020 2020 2020 2020 2061 6d6d 2e72             amm.r
-0003e200: 756e 5f6f 6e63 6528 290a 0a20 2020 2020  un_once()..     
-0003e210: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
-0003e220: 7273 5f69 6e66 6f20 3d20 6469 6374 2861  rs_info = dict(a
-0003e230: 7761 6974 2061 7379 6e63 696f 2e67 6174  wait asyncio.gat
-0003e240: 6865 7228 2a63 6f72 6f73 2929 0a20 2020  her(*coros)).   
-0003e250: 2020 2020 2020 2020 2020 2020 2077 6f72               wor
-0003e260: 6b65 7273 5f69 6e66 6f2e 706f 7028 4e6f  kers_info.pop(No
-0003e270: 6e65 2c20 4e6f 6e65 290a 2020 2020 2020  ne, None).      
-0003e280: 2020 2020 2020 6669 6e61 6c6c 793a 0a20        finally:. 
-0003e290: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0003e2a0: 6620 7374 6f70 5f61 6d6d 3a0a 2020 2020  f stop_amm:.    
-0003e2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e2c0: 616d 6d2e 7374 6f70 2829 0a0a 2020 2020  amm.stop()..    
-0003e2d0: 2020 2020 7365 6c66 2e6c 6f67 5f65 7665      self.log_eve
-0003e2e0: 6e74 2822 616c 6c22 2c20 7b22 6163 7469  nt("all", {"acti
-0003e2f0: 6f6e 223a 2022 7265 7469 7265 2d77 6f72  on": "retire-wor
-0003e300: 6b65 7273 222c 2022 776f 726b 6572 7322  kers", "workers"
-0003e310: 3a20 776f 726b 6572 735f 696e 666f 7d29  : workers_info})
-0003e320: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
-0003e330: 675f 6576 656e 7428 6c69 7374 2877 6f72  g_event(list(wor
-0003e340: 6b65 7273 5f69 6e66 6f29 2c20 7b22 6163  kers_info), {"ac
-0003e350: 7469 6f6e 223a 2022 7265 7469 7265 6422  tion": "retired"
-0003e360: 7d29 0a0a 2020 2020 2020 2020 7265 7475  })..        retu
-0003e370: 726e 2077 6f72 6b65 7273 5f69 6e66 6f0a  rn workers_info.
-0003e380: 0a20 2020 2061 7379 6e63 2064 6566 205f  .    async def _
-0003e390: 7472 6163 6b5f 7265 7469 7265 5f77 6f72  track_retire_wor
-0003e3a0: 6b65 7228 0a20 2020 2020 2020 2073 656c  ker(.        sel
-0003e3b0: 662c 0a20 2020 2020 2020 2077 733a 2057  f,.        ws: W
-0003e3c0: 6f72 6b65 7253 7461 7465 2c0a 2020 2020  orkerState,.    
-0003e3d0: 2020 2020 706f 6c69 6379 3a20 5265 7469      policy: Reti
-0003e3e0: 7265 576f 726b 6572 2c0a 2020 2020 2020  reWorker,.      
-0003e3f0: 2020 7072 6576 5f73 7461 7475 733a 2053    prev_status: S
-0003e400: 7461 7475 732c 0a20 2020 2020 2020 2063  tatus,.        c
-0003e410: 6c6f 7365 3a20 626f 6f6c 2c0a 2020 2020  lose: bool,.    
-0003e420: 2020 2020 7265 6d6f 7665 3a20 626f 6f6c      remove: bool
-0003e430: 2c0a 2020 2020 2020 2020 7374 696d 756c  ,.        stimul
-0003e440: 7573 5f69 643a 2073 7472 2c0a 2020 2020  us_id: str,.    
-0003e450: 2920 2d3e 2074 7570 6c65 3a20 2023 2074  ) -> tuple:  # t
-0003e460: 7570 6c65 5b73 7472 207c 204e 6f6e 652c  uple[str | None,
-0003e470: 2064 6963 745d 0a20 2020 2020 2020 2077   dict].        w
-0003e480: 6869 6c65 206e 6f74 2070 6f6c 6963 792e  hile not policy.
-0003e490: 646f 6e65 2829 3a0a 2020 2020 2020 2020  done():.        
-0003e4a0: 2020 2020 2320 536c 6565 7020 302e 3031      # Sleep 0.01
-0003e4b0: 7320 7768 656e 2074 6865 7265 2061 7265  s when there are
-0003e4c0: 2034 2074 6173 6b73 206f 7220 6c65 7373   4 tasks or less
-0003e4d0: 0a20 2020 2020 2020 2020 2020 2023 2053  .            # S
-0003e4e0: 6c65 6570 2030 2e35 7320 7768 656e 2074  leep 0.5s when t
-0003e4f0: 6865 7265 2061 7265 2032 3030 206f 7220  here are 200 or 
-0003e500: 6d6f 7265 0a20 2020 2020 2020 2020 2020  more.           
-0003e510: 2070 6f6c 6c5f 696e 7465 7276 616c 203d   poll_interval =
-0003e520: 206d 6178 2830 2e30 312c 206d 696e 2830   max(0.01, min(0
-0003e530: 2e35 2c20 6c65 6e28 7773 2e68 6173 5f77  .5, len(ws.has_w
-0003e540: 6861 7429 202f 2034 3030 2929 0a20 2020  hat) / 400)).   
-0003e550: 2020 2020 2020 2020 2061 7761 6974 2061           await a
-0003e560: 7379 6e63 696f 2e73 6c65 6570 2870 6f6c  syncio.sleep(pol
-0003e570: 6c5f 696e 7465 7276 616c 290a 0a20 2020  l_interval)..   
-0003e580: 2020 2020 2069 6620 706f 6c69 6379 2e6e       if policy.n
-0003e590: 6f5f 7265 6369 7069 656e 7473 3a0a 2020  o_recipients:.  
-0003e5a0: 2020 2020 2020 2020 2020 2320 4162 6f72            # Abor
-0003e5b0: 7420 7265 7469 7265 6d65 6e74 2e20 5468  t retirement. Th
-0003e5c0: 6973 2074 696d 6520 7765 2064 6f6e 2774  is time we don't
-0003e5d0: 206e 6565 6420 746f 2077 6f72 7279 2061   need to worry a
-0003e5e0: 626f 7574 2072 6163 650a 2020 2020 2020  bout race.      
-0003e5f0: 2020 2020 2020 2320 636f 6e64 6974 696f        # conditio
-0003e600: 6e73 2061 6e64 2077 6520 6361 6e20 7761  ns and we can wa
-0003e610: 6974 2066 6f72 2061 2073 6368 6564 756c  it for a schedul
-0003e620: 6572 2d3e 776f 726b 6572 2d3e 7363 6865  er->worker->sche
-0003e630: 6475 6c65 720a 2020 2020 2020 2020 2020  duler.          
-0003e640: 2020 2320 726f 756e 642d 7472 6970 2e0a    # round-trip..
-0003e650: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0003e660: 2e73 7472 6561 6d5f 636f 6d6d 735b 7773  .stream_comms[ws
-0003e670: 2e61 6464 7265 7373 5d2e 7365 6e64 280a  .address].send(.
-0003e680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e690: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0003e6a0: 2020 2020 2020 226f 7022 3a20 2277 6f72        "op": "wor
-0003e6b0: 6b65 722d 7374 6174 7573 2d63 6861 6e67  ker-status-chang
-0003e6c0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-0003e6d0: 2020 2020 2020 2020 2273 7461 7475 7322          "status"
-0003e6e0: 3a20 7072 6576 5f73 7461 7475 732e 6e61  : prev_status.na
-0003e6f0: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
-0003e700: 2020 2020 2020 2020 2273 7469 6d75 6c75          "stimulu
-0003e710: 735f 6964 223a 2073 7469 6d75 6c75 735f  s_id": stimulus_
-0003e720: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-0003e730: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-0003e740: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0003e750: 7265 7475 726e 204e 6f6e 652c 207b 7d0a  return None, {}.
-0003e760: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
-0003e770: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
-0003e780: 2020 2022 416c 6c20 756e 6971 7565 206b     "All unique k
-0003e790: 6579 7320 6f6e 2077 6f72 6b65 7220 2573  eys on worker %s
-0003e7a0: 2068 6176 6520 6265 656e 2072 6570 6c69   have been repli
-0003e7b0: 6361 7465 6420 656c 7365 7768 6572 6522  cated elsewhere"
-0003e7c0: 2c20 7773 2e61 6464 7265 7373 0a20 2020  , ws.address.   
-0003e7d0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0003e7e0: 6966 2072 656d 6f76 653a 0a20 2020 2020  if remove:.     
-0003e7f0: 2020 2020 2020 2061 7761 6974 2073 656c         await sel
-0003e800: 662e 7265 6d6f 7665 5f77 6f72 6b65 7228  f.remove_worker(
-0003e810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e820: 2077 732e 6164 6472 6573 732c 2073 6166   ws.address, saf
-0003e830: 653d 5472 7565 2c20 636c 6f73 653d 636c  e=True, close=cl
-0003e840: 6f73 652c 2073 7469 6d75 6c75 735f 6964  ose, stimulus_id
-0003e850: 3d73 7469 6d75 6c75 735f 6964 0a20 2020  =stimulus_id.   
-0003e860: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0003e870: 2020 2065 6c69 6620 636c 6f73 653a 0a20     elif close:. 
-0003e880: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0003e890: 636c 6f73 655f 776f 726b 6572 2877 732e  close_worker(ws.
-0003e8a0: 6164 6472 6573 7329 0a0a 2020 2020 2020  address)..      
-0003e8b0: 2020 6c6f 6767 6572 2e69 6e66 6f28 2252    logger.info("R
-0003e8c0: 6574 6972 6564 2077 6f72 6b65 7220 2573  etired worker %s
-0003e8d0: 222c 2077 732e 6164 6472 6573 7329 0a20  ", ws.address). 
-0003e8e0: 2020 2020 2020 2072 6574 7572 6e20 7773         return ws
-0003e8f0: 2e61 6464 7265 7373 2c20 7773 2e69 6465  .address, ws.ide
-0003e900: 6e74 6974 7928 290a 0a20 2020 2064 6566  ntity()..    def
-0003e910: 2061 6464 5f6b 6579 7328 0a20 2020 2020   add_keys(.     
-0003e920: 2020 2073 656c 662c 2077 6f72 6b65 723a     self, worker:
-0003e930: 2073 7472 2c20 6b65 7973 3a20 436f 6c6c   str, keys: Coll
-0003e940: 6563 7469 6f6e 5b73 7472 5d20 3d20 2829  ection[str] = ()
-0003e950: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
-0003e960: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
-0003e970: 0a20 2020 2029 202d 3e20 4c69 7465 7261  .    ) -> Litera
-0003e980: 6c5b 224f 4b22 2c20 226e 6f74 2066 6f75  l["OK", "not fou
-0003e990: 6e64 225d 3a0a 2020 2020 2020 2020 2222  nd"]:.        ""
-0003e9a0: 220a 2020 2020 2020 2020 4c65 6172 6e20  ".        Learn 
-0003e9b0: 7468 6174 2061 2077 6f72 6b65 7220 6861  that a worker ha
-0003e9c0: 7320 6365 7274 6169 6e20 6b65 7973 0a0a  s certain keys..
-0003e9d0: 2020 2020 2020 2020 5468 6973 2073 686f          This sho
-0003e9e0: 756c 6420 6e6f 7420 6265 2075 7365 6420  uld not be used 
-0003e9f0: 696e 2070 7261 6374 6963 6520 616e 6420  in practice and 
-0003ea00: 6973 206d 6f73 746c 7920 6865 7265 2066  is mostly here f
-0003ea10: 6f72 206c 6567 6163 790a 2020 2020 2020  or legacy.      
-0003ea20: 2020 7265 6173 6f6e 732e 2020 486f 7765    reasons.  Howe
-0003ea30: 7665 722c 2069 7420 6973 2073 656e 7420  ver, it is sent 
-0003ea40: 6279 2077 6f72 6b65 7273 2066 726f 6d20  by workers from 
-0003ea50: 7469 6d65 2074 6f20 7469 6d65 2e0a 2020  time to time..  
-0003ea60: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0003ea70: 2020 6966 2077 6f72 6b65 7220 6e6f 7420    if worker not 
-0003ea80: 696e 2073 656c 662e 776f 726b 6572 733a  in self.workers:
-0003ea90: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0003eaa0: 7572 6e20 226e 6f74 2066 6f75 6e64 220a  urn "not found".
-0003eab0: 2020 2020 2020 2020 7773 3a20 576f 726b          ws: Work
-0003eac0: 6572 5374 6174 6520 3d20 7365 6c66 2e77  erState = self.w
-0003ead0: 6f72 6b65 7273 5b77 6f72 6b65 725d 0a20  orkers[worker]. 
-0003eae0: 2020 2020 2020 2072 6564 756e 6461 6e74         redundant
-0003eaf0: 5f72 6570 6c69 6361 7320 3d20 5b5d 0a20  _replicas = []. 
-0003eb00: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
-0003eb10: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
-0003eb20: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-0003eb30: 736b 732e 6765 7428 6b65 7929 0a20 2020  sks.get(key).   
-0003eb40: 2020 2020 2020 2020 2069 6620 7473 2069           if ts i
-0003eb50: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2074  s not None and t
-0003eb60: 732e 7374 6174 6520 3d3d 2022 6d65 6d6f  s.state == "memo
-0003eb70: 7279 223a 0a20 2020 2020 2020 2020 2020  ry":.           
-0003eb80: 2020 2020 2069 6620 7773 206e 6f74 2069       if ws not i
-0003eb90: 6e20 7473 2e77 686f 5f68 6173 3a0a 2020  n ts.who_has:.  
-0003eba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ebb0: 2020 7365 6c66 2e61 6464 5f72 6570 6c69    self.add_repli
-0003ebc0: 6361 2874 732c 2077 7329 0a20 2020 2020  ca(ts, ws).     
-0003ebd0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0003ebe0: 2020 2020 2020 2020 2020 2020 2072 6564               red
-0003ebf0: 756e 6461 6e74 5f72 6570 6c69 6361 732e  undant_replicas.
-0003ec00: 6170 7065 6e64 286b 6579 290a 0a20 2020  append(key)..   
-0003ec10: 2020 2020 2069 6620 7265 6475 6e64 616e       if redundan
-0003ec20: 745f 7265 706c 6963 6173 3a0a 2020 2020  t_replicas:.    
-0003ec30: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-0003ec40: 7469 6d75 6c75 735f 6964 3a0a 2020 2020  timulus_id:.    
-0003ec50: 2020 2020 2020 2020 2020 2020 7374 696d              stim
-0003ec60: 756c 7573 5f69 6420 3d20 6622 7265 6475  ulus_id = f"redu
-0003ec70: 6e64 616e 742d 7265 706c 6963 6173 2d7b  ndant-replicas-{
-0003ec80: 7469 6d65 2829 7d22 0a20 2020 2020 2020  time()}".       
-0003ec90: 2020 2020 2073 656c 662e 776f 726b 6572       self.worker
-0003eca0: 5f73 656e 6428 0a20 2020 2020 2020 2020  _send(.         
-0003ecb0: 2020 2020 2020 2077 6f72 6b65 722c 0a20         worker,. 
-0003ecc0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-0003ecd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003ece0: 2020 2020 2022 6f70 223a 2022 7265 6d6f       "op": "remo
-0003ecf0: 7665 2d72 6570 6c69 6361 7322 2c0a 2020  ve-replicas",.  
-0003ed00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ed10: 2020 226b 6579 7322 3a20 7265 6475 6e64    "keys": redund
-0003ed20: 616e 745f 7265 706c 6963 6173 2c0a 2020  ant_replicas,.  
-0003ed30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ed40: 2020 2273 7469 6d75 6c75 735f 6964 223a    "stimulus_id":
-0003ed50: 2073 7469 6d75 6c75 735f 6964 2c0a 2020   stimulus_id,.  
-0003ed60: 2020 2020 2020 2020 2020 2020 2020 7d2c                },
-0003ed70: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-0003ed80: 2020 2020 2020 2020 7265 7475 726e 2022          return "
-0003ed90: 4f4b 220a 0a20 2020 2040 6c6f 675f 6572  OK"..    @log_er
-0003eda0: 726f 7273 0a20 2020 2064 6566 2075 7064  rors.    def upd
-0003edb0: 6174 655f 6461 7461 280a 2020 2020 2020  ate_data(.      
-0003edc0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-0003edd0: 2a2c 0a20 2020 2020 2020 2077 686f 5f68  *,.        who_h
-0003ede0: 6173 3a20 6469 6374 5b73 7472 2c20 6c69  as: dict[str, li
-0003edf0: 7374 5b73 7472 5d5d 2c0a 2020 2020 2020  st[str]],.      
-0003ee00: 2020 6e62 7974 6573 3a20 6469 6374 5b73    nbytes: dict[s
-0003ee10: 7472 2c20 696e 745d 2c0a 2020 2020 2020  tr, int],.      
-0003ee20: 2020 636c 6965 6e74 3a20 7374 7220 7c20    client: str | 
-0003ee30: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-0003ee40: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
-0003ee50: 2020 2020 2222 224c 6561 726e 2074 6861      """Learn tha
-0003ee60: 7420 6e65 7720 6461 7461 2068 6173 2065  t new data has e
-0003ee70: 6e74 6572 6564 2074 6865 206e 6574 776f  ntered the netwo
-0003ee80: 726b 2066 726f 6d20 616e 2065 7874 6572  rk from an exter
-0003ee90: 6e61 6c20 736f 7572 6365 2222 220a 2020  nal source""".  
-0003eea0: 2020 2020 2020 7768 6f5f 6861 7320 3d20        who_has = 
-0003eeb0: 7b6b 3a20 5b73 656c 662e 636f 6572 6365  {k: [self.coerce
-0003eec0: 5f61 6464 7265 7373 2876 7629 2066 6f72  _address(vv) for
-0003eed0: 2076 7620 696e 2076 5d20 666f 7220 6b2c   vv in v] for k,
-0003eee0: 2076 2069 6e20 7768 6f5f 6861 732e 6974   v in who_has.it
-0003eef0: 656d 7328 297d 0a20 2020 2020 2020 206c  ems()}.        l
-0003ef00: 6f67 6765 722e 6465 6275 6728 2255 7064  ogger.debug("Upd
-0003ef10: 6174 6520 6461 7461 2025 7322 2c20 7768  ate data %s", wh
-0003ef20: 6f5f 6861 7329 0a0a 2020 2020 2020 2020  o_has)..        
-0003ef30: 666f 7220 6b65 792c 2077 6f72 6b65 7273  for key, workers
-0003ef40: 2069 6e20 7768 6f5f 6861 732e 6974 656d   in who_has.item
-0003ef50: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-0003ef60: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
-0003ef70: 2e67 6574 286b 6579 290a 2020 2020 2020  .get(key).      
-0003ef80: 2020 2020 2020 6966 2074 7320 6973 204e        if ts is N
-0003ef90: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0003efa0: 2020 2020 2074 7320 3d20 7365 6c66 2e6e       ts = self.n
-0003efb0: 6577 5f74 6173 6b28 6b65 792c 204e 6f6e  ew_task(key, Non
-0003efc0: 652c 2022 6d65 6d6f 7279 2229 0a20 2020  e, "memory").   
-0003efd0: 2020 2020 2020 2020 2074 732e 7374 6174           ts.stat
-0003efe0: 6520 3d20 226d 656d 6f72 7922 0a20 2020  e = "memory".   
-0003eff0: 2020 2020 2020 2020 2074 735f 6e62 7974           ts_nbyt
-0003f000: 6573 203d 206e 6279 7465 732e 6765 7428  es = nbytes.get(
-0003f010: 6b65 792c 202d 3129 0a20 2020 2020 2020  key, -1).       
-0003f020: 2020 2020 2069 6620 7473 5f6e 6279 7465       if ts_nbyte
-0003f030: 7320 3e3d 2030 3a0a 2020 2020 2020 2020  s >= 0:.        
-0003f040: 2020 2020 2020 2020 7473 2e73 6574 5f6e          ts.set_n
-0003f050: 6279 7465 7328 7473 5f6e 6279 7465 7329  bytes(ts_nbytes)
-0003f060: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
-0003f070: 7220 7720 696e 2077 6f72 6b65 7273 3a0a  r w in workers:.
-0003f080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f090: 7773 203d 2073 656c 662e 776f 726b 6572  ws = self.worker
-0003f0a0: 735b 775d 0a20 2020 2020 2020 2020 2020  s[w].           
-0003f0b0: 2020 2020 2069 6620 7773 206e 6f74 2069       if ws not i
-0003f0c0: 6e20 7473 2e77 686f 5f68 6173 3a0a 2020  n ts.who_has:.  
-0003f0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f0e0: 2020 7365 6c66 2e61 6464 5f72 6570 6c69    self.add_repli
-0003f0f0: 6361 2874 732c 2077 7329 0a20 2020 2020  ca(ts, ws).     
-0003f100: 2020 2020 2020 2073 656c 662e 7265 706f         self.repo
-0003f110: 7274 287b 226f 7022 3a20 226b 6579 2d69  rt({"op": "key-i
-0003f120: 6e2d 6d65 6d6f 7279 222c 2022 6b65 7922  n-memory", "key"
-0003f130: 3a20 6b65 792c 2022 776f 726b 6572 7322  : key, "workers"
-0003f140: 3a20 6c69 7374 2877 6f72 6b65 7273 297d  : list(workers)}
-0003f150: 290a 0a20 2020 2020 2020 2069 6620 636c  )..        if cl
-0003f160: 6965 6e74 3a0a 2020 2020 2020 2020 2020  ient:.          
-0003f170: 2020 7365 6c66 2e63 6c69 656e 745f 6465    self.client_de
-0003f180: 7369 7265 735f 6b65 7973 286b 6579 733d  sires_keys(keys=
-0003f190: 6c69 7374 2877 686f 5f68 6173 292c 2063  list(who_has), c
-0003f1a0: 6c69 656e 743d 636c 6965 6e74 290a 0a20  lient=client).. 
-0003f1b0: 2020 2040 6f76 6572 6c6f 6164 0a20 2020     @overload.   
-0003f1c0: 2064 6566 2072 6570 6f72 745f 6f6e 5f6b   def report_on_k
-0003f1d0: 6579 2873 656c 662c 206b 6579 3a20 7374  ey(self, key: st
-0003f1e0: 722c 202a 2c20 636c 6965 6e74 3a20 7374  r, *, client: st
-0003f1f0: 7220 7c20 4e6f 6e65 203d 204e 6f6e 6529  r | None = None)
-0003f200: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0003f210: 2020 2e2e 2e0a 0a20 2020 2040 6f76 6572    .....    @over
-0003f220: 6c6f 6164 0a20 2020 2064 6566 2072 6570  load.    def rep
-0003f230: 6f72 745f 6f6e 5f6b 6579 2873 656c 662c  ort_on_key(self,
-0003f240: 202a 2c20 7473 3a20 5461 736b 5374 6174   *, ts: TaskStat
-0003f250: 652c 2063 6c69 656e 743a 2073 7472 207c  e, client: str |
-0003f260: 204e 6f6e 6520 3d20 4e6f 6e65 2920 2d3e   None = None) ->
-0003f270: 204e 6f6e 653a 0a20 2020 2020 2020 202e   None:.        .
-0003f280: 2e2e 0a0a 2020 2020 6465 6620 7265 706f  ....    def repo
-0003f290: 7274 5f6f 6e5f 6b65 7928 7365 6c66 2c20  rt_on_key(self, 
-0003f2a0: 6b65 793d 4e6f 6e65 2c20 2a2c 2074 733d  key=None, *, ts=
-0003f2b0: 4e6f 6e65 2c20 636c 6965 6e74 3d4e 6f6e  None, client=Non
-0003f2c0: 6529 3a0a 2020 2020 2020 2020 6966 2028  e):.        if (
-0003f2d0: 7473 2069 7320 4e6f 6e65 2920 3d3d 2028  ts is None) == (
-0003f2e0: 6b65 7920 6973 204e 6f6e 6529 3a0a 2020  key is None):.  
-0003f2f0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0003f300: 5661 6c75 6545 7272 6f72 2820 2023 2070  ValueError(  # p
-0003f310: 7261 676d 613a 206e 6f63 6f76 6572 0a20  ragma: nocover. 
-0003f320: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0003f330: 2274 7320 616e 6420 6b65 7920 6172 6520  "ts and key are 
-0003f340: 6d75 7475 616c 6c79 2065 7863 6c75 7369  mutually exclusi
-0003f350: 7665 3b20 7265 6365 6976 6564 207b 6b65  ve; received {ke
-0003f360: 793d 2172 7d2c 207b 7473 3d21 727d 220a  y=!r}, {ts=!r}".
-0003f370: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0003f380: 2020 2020 2020 6966 2074 7320 6973 204e        if ts is N
-0003f390: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0003f3a0: 2061 7373 6572 7420 6b65 7920 6973 206e   assert key is n
-0003f3b0: 6f74 204e 6f6e 650a 2020 2020 2020 2020  ot None.        
-0003f3c0: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-0003f3d0: 736b 732e 6765 7428 6b65 7929 0a20 2020  sks.get(key).   
-0003f3e0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0003f3f0: 2020 2020 2020 206b 6579 203d 2074 732e         key = ts.
-0003f400: 6b65 790a 0a20 2020 2020 2020 2069 6620  key..        if 
-0003f410: 7473 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ts is not None:.
-0003f420: 2020 2020 2020 2020 2020 2020 7265 706f              repo
-0003f430: 7274 5f6d 7367 203d 205f 7461 736b 5f74  rt_msg = _task_t
-0003f440: 6f5f 7265 706f 7274 5f6d 7367 2874 7329  o_report_msg(ts)
-0003f450: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0003f460: 2020 2020 2020 2020 2020 2072 6570 6f72             repor
-0003f470: 745f 6d73 6720 3d20 7b22 6f70 223a 2022  t_msg = {"op": "
-0003f480: 6361 6e63 656c 6c65 642d 6b65 7973 222c  cancelled-keys",
-0003f490: 2022 6b65 7973 223a 205b 6b65 795d 7d0a   "keys": [key]}.
-0003f4a0: 2020 2020 2020 2020 6966 2072 6570 6f72          if repor
-0003f4b0: 745f 6d73 6720 6973 206e 6f74 204e 6f6e  t_msg is not Non
-0003f4c0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-0003f4d0: 656c 662e 7265 706f 7274 2872 6570 6f72  elf.report(repor
-0003f4e0: 745f 6d73 672c 2074 733d 7473 2c20 636c  t_msg, ts=ts, cl
-0003f4f0: 6965 6e74 3d63 6c69 656e 7429 0a0a 2020  ient=client)..  
-0003f500: 2020 406c 6f67 5f65 7272 6f72 730a 2020    @log_errors.  
-0003f510: 2020 6173 796e 6320 6465 6620 6665 6564    async def feed
-0003f520: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-0003f530: 2020 2020 2020 2020 636f 6d6d 3a20 436f          comm: Co
-0003f540: 6d6d 2c0a 2020 2020 2020 2020 6675 6e63  mm,.        func
-0003f550: 7469 6f6e 3a20 6279 7465 7320 7c20 4e6f  tion: bytes | No
-0003f560: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
-0003f570: 2020 2073 6574 7570 3a20 6279 7465 7320     setup: bytes 
-0003f580: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-0003f590: 2020 2020 2020 2074 6561 7264 6f77 6e3a         teardown:
-0003f5a0: 2062 7974 6573 207c 204e 6f6e 6520 3d20   bytes | None = 
-0003f5b0: 4e6f 6e65 2c0a 2020 2020 2020 2020 696e  None,.        in
-0003f5c0: 7465 7276 616c 3a20 7374 7220 7c20 666c  terval: str | fl
-0003f5d0: 6f61 7420 3d20 2231 7322 2c0a 2020 2020  oat = "1s",.    
-0003f5e0: 2020 2020 2a2a 6b77 6172 6773 3a20 416e      **kwargs: An
-0003f5f0: 792c 0a20 2020 2029 202d 3e20 4e6f 6e65  y,.    ) -> None
-0003f600: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-0003f610: 2020 2020 2020 5072 6f76 6964 6573 2061        Provides a
-0003f620: 2064 6174 6120 436f 6d6d 2074 6f20 6578   data Comm to ex
-0003f630: 7465 726e 616c 2072 6571 7565 7374 6572  ternal requester
-0003f640: 0a0a 2020 2020 2020 2020 4361 7574 696f  ..        Cautio
-0003f650: 6e3a 2074 6869 7320 7275 6e73 2061 7262  n: this runs arb
-0003f660: 6974 7261 7279 2050 7974 686f 6e20 636f  itrary Python co
-0003f670: 6465 206f 6e20 7468 6520 7363 6865 6475  de on the schedu
-0003f680: 6c65 722e 2020 5468 6973 2073 686f 756c  ler.  This shoul
-0003f690: 640a 2020 2020 2020 2020 6576 656e 7475  d.        eventu
-0003f6a0: 616c 6c79 2062 6520 7068 6173 6564 206f  ally be phased o
-0003f6b0: 7574 2e20 2049 7420 6973 206d 6f73 746c  ut.  It is mostl
-0003f6c0: 7920 7573 6564 2062 7920 6469 6167 6e6f  y used by diagno
-0003f6d0: 7374 6963 732e 0a20 2020 2020 2020 2022  stics..        "
-0003f6e0: 2222 0a20 2020 2020 2020 2069 6620 6e6f  "".        if no
-0003f6f0: 7420 6461 736b 2e63 6f6e 6669 672e 6765  t dask.config.ge
-0003f700: 7428 2264 6973 7472 6962 7574 6564 2e73  t("distributed.s
-0003f710: 6368 6564 756c 6572 2e70 6963 6b6c 6522  cheduler.pickle"
-0003f720: 293a 0a20 2020 2020 2020 2020 2020 206c  ):.            l
-0003f730: 6f67 6765 722e 7761 726e 696e 6728 0a20  ogger.warning(. 
-0003f740: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0003f750: 5472 6965 6420 746f 2063 616c 6c20 2766  Tried to call 'f
-0003f760: 6565 6427 2072 6f75 7465 2077 6974 6820  eed' route with 
-0003f770: 6375 7374 6f6d 2066 756e 6374 696f 6e73  custom functions
-0003f780: 2c20 6275 7420 220a 2020 2020 2020 2020  , but ".        
-0003f790: 2020 2020 2020 2020 2270 6963 6b6c 6520          "pickle 
-0003f7a0: 6973 2064 6973 616c 6c6f 7765 642e 2020  is disallowed.  
-0003f7b0: 5365 7420 7468 6520 2764 6973 7472 6962  Set the 'distrib
-0003f7c0: 7574 6564 2e73 6368 6564 756c 6572 2e70  uted.scheduler.p
-0003f7d0: 6963 6b6c 6527 220a 2020 2020 2020 2020  ickle'".        
-0003f7e0: 2020 2020 2020 2020 2263 6f6e 6669 6720          "config 
-0003f7f0: 7661 6c75 6520 746f 2054 7275 6520 746f  value to True to
-0003f800: 2075 7365 2074 6865 2027 6665 6564 2720   use the 'feed' 
-0003f810: 726f 7574 6520 2874 6869 7320 6973 206d  route (this is m
-0003f820: 6f73 746c 7920 220a 2020 2020 2020 2020  ostly ".        
-0003f830: 2020 2020 2020 2020 2263 6f6d 6d6f 6e6c          "commonl
-0003f840: 7920 7573 6564 2077 6974 6820 7072 6f67  y used with prog
-0003f850: 7265 7373 2062 6172 7329 220a 2020 2020  ress bars)".    
-0003f860: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0003f870: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
-0003f880: 2020 2020 2020 696e 7465 7276 616c 203d        interval =
-0003f890: 2070 6172 7365 5f74 696d 6564 656c 7461   parse_timedelta
-0003f8a0: 2869 6e74 6572 7661 6c29 0a20 2020 2020  (interval).     
-0003f8b0: 2020 2069 6620 6675 6e63 7469 6f6e 3a0a     if function:.
-0003f8c0: 2020 2020 2020 2020 2020 2020 6675 6e63              func
-0003f8d0: 7469 6f6e 203d 2070 6963 6b6c 652e 6c6f  tion = pickle.lo
-0003f8e0: 6164 7328 6675 6e63 7469 6f6e 290a 2020  ads(function).  
-0003f8f0: 2020 2020 2020 6966 2073 6574 7570 3a0a        if setup:.
-0003f900: 2020 2020 2020 2020 2020 2020 7365 7475              setu
-0003f910: 7020 3d20 7069 636b 6c65 2e6c 6f61 6473  p = pickle.loads
-0003f920: 2873 6574 7570 290a 0a20 2020 2020 2020  (setup)..       
-0003f930: 2069 6620 7465 6172 646f 776e 3a0a 2020   if teardown:.  
-0003f940: 2020 2020 2020 2020 2020 7465 6172 646f            teardo
-0003f950: 776e 203d 2070 6963 6b6c 652e 6c6f 6164  wn = pickle.load
-0003f960: 7328 7465 6172 646f 776e 290a 2020 2020  s(teardown).    
-0003f970: 2020 2020 7374 6174 6520 3d20 7365 7475      state = setu
-0003f980: 7028 7365 6c66 2920 6966 2073 6574 7570  p(self) if setup
-0003f990: 2065 6c73 6520 4e6f 6e65 2020 2320 7479   else None  # ty
-0003f9a0: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
-0003f9b0: 2020 2069 6620 696e 7370 6563 742e 6973     if inspect.is
-0003f9c0: 6177 6169 7461 626c 6528 7374 6174 6529  awaitable(state)
-0003f9d0: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
-0003f9e0: 6174 6520 3d20 6177 6169 7420 7374 6174  ate = await stat
-0003f9f0: 650a 2020 2020 2020 2020 7472 793a 0a20  e.        try:. 
-0003fa00: 2020 2020 2020 2020 2020 2077 6869 6c65             while
-0003fa10: 2073 656c 662e 7374 6174 7573 203d 3d20   self.status == 
-0003fa20: 5374 6174 7573 2e72 756e 6e69 6e67 3a0a  Status.running:.
-0003fa30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fa40: 6966 2073 7461 7465 2069 7320 4e6f 6e65  if state is None
-0003fa50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003fa60: 2020 2020 2020 7265 7370 6f6e 7365 203d        response =
-0003fa70: 2066 756e 6374 696f 6e28 7365 6c66 2920   function(self) 
-0003fa80: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
-0003fa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003faa0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0003fab0: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
-0003fac0: 7365 203d 2066 756e 6374 696f 6e28 7365  se = function(se
-0003fad0: 6c66 2c20 7374 6174 6529 2020 2320 7479  lf, state)  # ty
-0003fae0: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
-0003faf0: 2020 2020 2020 2020 2020 2061 7761 6974             await
-0003fb00: 2063 6f6d 6d2e 7772 6974 6528 7265 7370   comm.write(resp
-0003fb10: 6f6e 7365 290a 2020 2020 2020 2020 2020  onse).          
-0003fb20: 2020 2020 2020 6177 6169 7420 6173 796e        await asyn
-0003fb30: 6369 6f2e 736c 6565 7028 696e 7465 7276  cio.sleep(interv
-0003fb40: 616c 290a 2020 2020 2020 2020 6578 6365  al).        exce
-0003fb50: 7074 204f 5345 7272 6f72 3a0a 2020 2020  pt OSError:.    
-0003fb60: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
-0003fb70: 2020 2020 2066 696e 616c 6c79 3a0a 2020       finally:.  
-0003fb80: 2020 2020 2020 2020 2020 6966 2074 6561            if tea
-0003fb90: 7264 6f77 6e3a 0a20 2020 2020 2020 2020  rdown:.         
-0003fba0: 2020 2020 2020 2074 6561 7264 6f77 6e28         teardown(
-0003fbb0: 7365 6c66 2c20 7374 6174 6529 2020 2320  self, state)  # 
-0003fbc0: 7479 7065 3a20 6967 6e6f 7265 0a0a 2020  type: ignore..  
-0003fbd0: 2020 6465 6620 6c6f 675f 776f 726b 6572    def log_worker
-0003fbe0: 5f65 7665 6e74 280a 2020 2020 2020 2020  _event(.        
-0003fbf0: 7365 6c66 2c20 776f 726b 6572 3a20 7374  self, worker: st
-0003fc00: 722c 2074 6f70 6963 3a20 7374 7220 7c20  r, topic: str | 
-0003fc10: 436f 6c6c 6563 7469 6f6e 5b73 7472 5d2c  Collection[str],
-0003fc20: 206d 7367 3a20 416e 790a 2020 2020 2920   msg: Any.    ) 
-0003fc30: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-0003fc40: 2069 6620 6973 696e 7374 616e 6365 286d   if isinstance(m
-0003fc50: 7367 2c20 6469 6374 293a 0a20 2020 2020  sg, dict):.     
-0003fc60: 2020 2020 2020 206d 7367 5b22 776f 726b         msg["work
-0003fc70: 6572 225d 203d 2077 6f72 6b65 720a 2020  er"] = worker.  
-0003fc80: 2020 2020 2020 7365 6c66 2e6c 6f67 5f65        self.log_e
-0003fc90: 7665 6e74 2874 6f70 6963 2c20 6d73 6729  vent(topic, msg)
-0003fca0: 0a0a 2020 2020 6465 6620 7375 6273 6372  ..    def subscr
-0003fcb0: 6962 655f 776f 726b 6572 5f73 7461 7475  ibe_worker_statu
-0003fcc0: 7328 7365 6c66 2c20 636f 6d6d 3a20 436f  s(self, comm: Co
-0003fcd0: 6d6d 2920 2d3e 2073 7472 3a0a 2020 2020  mm) -> str:.    
-0003fce0: 2020 2020 576f 726b 6572 5374 6174 7573      WorkerStatus
-0003fcf0: 506c 7567 696e 2873 656c 662c 2063 6f6d  Plugin(self, com
-0003fd00: 6d29 0a20 2020 2020 2020 2069 6465 6e74  m).        ident
-0003fd10: 203d 2073 656c 662e 6964 656e 7469 7479   = self.identity
-0003fd20: 2829 0a20 2020 2020 2020 2066 6f72 2076  ().        for v
-0003fd30: 2069 6e20 6964 656e 745b 2277 6f72 6b65   in ident["worke
-0003fd40: 7273 225d 2e76 616c 7565 7328 293a 0a20  rs"].values():. 
-0003fd50: 2020 2020 2020 2020 2020 2064 656c 2076             del v
-0003fd60: 5b22 6d65 7472 6963 7322 5d0a 2020 2020  ["metrics"].    
-0003fd70: 2020 2020 2020 2020 6465 6c20 765b 226c          del v["l
-0003fd80: 6173 745f 7365 656e 225d 0a20 2020 2020  ast_seen"].     
-0003fd90: 2020 2072 6574 7572 6e20 6964 656e 740a     return ident.
-0003fda0: 0a20 2020 2064 6566 2067 6574 5f70 726f  .    def get_pro
-0003fdb0: 6365 7373 696e 6728 0a20 2020 2020 2020  cessing(.       
-0003fdc0: 2073 656c 662c 2077 6f72 6b65 7273 3a20   self, workers: 
-0003fdd0: 4974 6572 6162 6c65 5b73 7472 5d20 7c20  Iterable[str] | 
-0003fde0: 4e6f 6e65 203d 204e 6f6e 650a 2020 2020  None = None.    
-0003fdf0: 2920 2d3e 2064 6963 745b 7374 722c 206c  ) -> dict[str, l
-0003fe00: 6973 745b 7374 725d 5d3a 0a20 2020 2020  ist[str]]:.     
-0003fe10: 2020 2069 6620 776f 726b 6572 7320 6973     if workers is
-0003fe20: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0003fe30: 2020 2020 2020 2077 6f72 6b65 7273 203d         workers =
-0003fe40: 2073 6574 286d 6170 2873 656c 662e 636f   set(map(self.co
-0003fe50: 6572 6365 5f61 6464 7265 7373 2c20 776f  erce_address, wo
-0003fe60: 726b 6572 7329 290a 2020 2020 2020 2020  rkers)).        
-0003fe70: 2020 2020 7265 7475 726e 207b 773a 205b      return {w: [
-0003fe80: 7473 2e6b 6579 2066 6f72 2074 7320 696e  ts.key for ts in
-0003fe90: 2073 656c 662e 776f 726b 6572 735b 775d   self.workers[w]
-0003fea0: 2e70 726f 6365 7373 696e 675d 2066 6f72  .processing] for
-0003feb0: 2077 2069 6e20 776f 726b 6572 737d 0a20   w in workers}. 
-0003fec0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0003fed0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0003fee0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0003fef0: 2020 773a 205b 7473 2e6b 6579 2066 6f72    w: [ts.key for
-0003ff00: 2074 7320 696e 2077 732e 7072 6f63 6573   ts in ws.proces
-0003ff10: 7369 6e67 5d20 666f 7220 772c 2077 7320  sing] for w, ws 
-0003ff20: 696e 2073 656c 662e 776f 726b 6572 732e  in self.workers.
-0003ff30: 6974 656d 7328 290a 2020 2020 2020 2020  items().        
-0003ff40: 2020 2020 7d0a 0a20 2020 2064 6566 2067      }..    def g
-0003ff50: 6574 5f77 686f 5f68 6173 2873 656c 662c  et_who_has(self,
-0003ff60: 206b 6579 733a 2049 7465 7261 626c 655b   keys: Iterable[
-0003ff70: 7374 725d 207c 204e 6f6e 6520 3d20 4e6f  str] | None = No
-0003ff80: 6e65 2920 2d3e 2064 6963 745b 7374 722c  ne) -> dict[str,
-0003ff90: 206c 6973 745b 7374 725d 5d3a 0a20 2020   list[str]]:.   
-0003ffa0: 2020 2020 2069 6620 6b65 7973 2069 7320       if keys is 
-0003ffb0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0003ffc0: 2020 2020 2020 7265 7475 726e 207b 0a20        return {. 
-0003ffd0: 2020 2020 2020 2020 2020 2020 2020 206b                 k
-0003ffe0: 6579 3a20 5b77 732e 6164 6472 6573 7320  ey: [ws.address 
-0003fff0: 666f 7220 7773 2069 6e20 7365 6c66 2e74  for ws in self.t
-00040000: 6173 6b73 5b6b 6579 5d2e 7768 6f5f 6861  asks[key].who_ha
-00040010: 735d 0a20 2020 2020 2020 2020 2020 2020  s].             
-00040020: 2020 2069 6620 6b65 7920 696e 2073 656c     if key in sel
-00040030: 662e 7461 736b 730a 2020 2020 2020 2020  f.tasks.        
-00040040: 2020 2020 2020 2020 656c 7365 205b 5d0a          else [].
-00040050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040060: 666f 7220 6b65 7920 696e 206b 6579 730a  for key in keys.
-00040070: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00040080: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00040090: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-000400a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000400b0: 206b 6579 3a20 5b77 732e 6164 6472 6573   key: [ws.addres
-000400c0: 7320 666f 7220 7773 2069 6e20 7473 2e77  s for ws in ts.w
-000400d0: 686f 5f68 6173 5d20 666f 7220 6b65 792c  ho_has] for key,
-000400e0: 2074 7320 696e 2073 656c 662e 7461 736b   ts in self.task
-000400f0: 732e 6974 656d 7328 290a 2020 2020 2020  s.items().      
-00040100: 2020 2020 2020 7d0a 0a20 2020 2064 6566        }..    def
-00040110: 2067 6574 5f68 6173 5f77 6861 7428 0a20   get_has_what(. 
-00040120: 2020 2020 2020 2073 656c 662c 2077 6f72         self, wor
-00040130: 6b65 7273 3a20 4974 6572 6162 6c65 5b73  kers: Iterable[s
-00040140: 7472 5d20 7c20 4e6f 6e65 203d 204e 6f6e  tr] | None = Non
-00040150: 650a 2020 2020 2920 2d3e 2064 6963 745b  e.    ) -> dict[
-00040160: 7374 722c 206c 6973 745b 7374 725d 5d3a  str, list[str]]:
-00040170: 0a20 2020 2020 2020 2069 6620 776f 726b  .        if work
-00040180: 6572 7320 6973 206e 6f74 204e 6f6e 653a  ers is not None:
-00040190: 0a20 2020 2020 2020 2020 2020 2077 6f72  .            wor
-000401a0: 6b65 7273 203d 206d 6170 2873 656c 662e  kers = map(self.
-000401b0: 636f 6572 6365 5f61 6464 7265 7373 2c20  coerce_address, 
-000401c0: 776f 726b 6572 7329 0a20 2020 2020 2020  workers).       
-000401d0: 2020 2020 2072 6574 7572 6e20 7b0a 2020       return {.  
-000401e0: 2020 2020 2020 2020 2020 2020 2020 773a                w:
-000401f0: 205b 7473 2e6b 6579 2066 6f72 2074 7320   [ts.key for ts 
-00040200: 696e 2073 656c 662e 776f 726b 6572 735b  in self.workers[
-00040210: 775d 2e68 6173 5f77 6861 745d 0a20 2020  w].has_what].   
-00040220: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00040230: 7720 696e 2073 656c 662e 776f 726b 6572  w in self.worker
-00040240: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00040250: 2020 656c 7365 205b 5d0a 2020 2020 2020    else [].      
-00040260: 2020 2020 2020 2020 2020 666f 7220 7720            for w 
-00040270: 696e 2077 6f72 6b65 7273 0a20 2020 2020  in workers.     
-00040280: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00040290: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000402a0: 2020 2072 6574 7572 6e20 7b77 3a20 5b74     return {w: [t
-000402b0: 732e 6b65 7920 666f 7220 7473 2069 6e20  s.key for ts in 
-000402c0: 7773 2e68 6173 5f77 6861 745d 2066 6f72  ws.has_what] for
-000402d0: 2077 2c20 7773 2069 6e20 7365 6c66 2e77   w, ws in self.w
-000402e0: 6f72 6b65 7273 2e69 7465 6d73 2829 7d0a  orkers.items()}.
-000402f0: 0a20 2020 2064 6566 2067 6574 5f6e 636f  .    def get_nco
-00040300: 7265 7328 7365 6c66 2c20 776f 726b 6572  res(self, worker
-00040310: 733a 2049 7465 7261 626c 655b 7374 725d  s: Iterable[str]
-00040320: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2920   | None = None) 
-00040330: 2d3e 2064 6963 745b 7374 722c 2069 6e74  -> dict[str, int
-00040340: 5d3a 0a20 2020 2020 2020 2069 6620 776f  ]:.        if wo
-00040350: 726b 6572 7320 6973 206e 6f74 204e 6f6e  rkers is not Non
-00040360: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
-00040370: 6f72 6b65 7273 203d 206d 6170 2873 656c  orkers = map(sel
-00040380: 662e 636f 6572 6365 5f61 6464 7265 7373  f.coerce_address
-00040390: 2c20 776f 726b 6572 7329 0a20 2020 2020  , workers).     
-000403a0: 2020 2020 2020 2072 6574 7572 6e20 7b77         return {w
-000403b0: 3a20 7365 6c66 2e77 6f72 6b65 7273 5b77  : self.workers[w
-000403c0: 5d2e 6e74 6872 6561 6473 2066 6f72 2077  ].nthreads for w
-000403d0: 2069 6e20 776f 726b 6572 7320 6966 2077   in workers if w
-000403e0: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
-000403f0: 7d0a 2020 2020 2020 2020 656c 7365 3a0a  }.        else:.
-00040400: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00040410: 726e 207b 773a 2077 732e 6e74 6872 6561  rn {w: ws.nthrea
-00040420: 6473 2066 6f72 2077 2c20 7773 2069 6e20  ds for w, ws in 
-00040430: 7365 6c66 2e77 6f72 6b65 7273 2e69 7465  self.workers.ite
-00040440: 6d73 2829 7d0a 0a20 2020 2064 6566 2067  ms()}..    def g
-00040450: 6574 5f6e 636f 7265 735f 7275 6e6e 696e  et_ncores_runnin
-00040460: 6728 0a20 2020 2020 2020 2073 656c 662c  g(.        self,
-00040470: 2077 6f72 6b65 7273 3a20 4974 6572 6162   workers: Iterab
-00040480: 6c65 5b73 7472 5d20 7c20 4e6f 6e65 203d  le[str] | None =
-00040490: 204e 6f6e 650a 2020 2020 2920 2d3e 2064   None.    ) -> d
-000404a0: 6963 745b 7374 722c 2069 6e74 5d3a 0a20  ict[str, int]:. 
-000404b0: 2020 2020 2020 206e 636f 7265 7320 3d20         ncores = 
-000404c0: 7365 6c66 2e67 6574 5f6e 636f 7265 7328  self.get_ncores(
-000404d0: 776f 726b 6572 733d 776f 726b 6572 7329  workers=workers)
-000404e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000404f0: 7b0a 2020 2020 2020 2020 2020 2020 773a  {.            w:
-00040500: 206e 2066 6f72 2077 2c20 6e20 696e 206e   n for w, n in n
-00040510: 636f 7265 732e 6974 656d 7328 2920 6966  cores.items() if
-00040520: 2073 656c 662e 776f 726b 6572 735b 775d   self.workers[w]
-00040530: 2e73 7461 7475 7320 3d3d 2053 7461 7475  .status == Statu
-00040540: 732e 7275 6e6e 696e 670a 2020 2020 2020  s.running.      
-00040550: 2020 7d0a 0a20 2020 2061 7379 6e63 2064    }..    async d
-00040560: 6566 2067 6574 5f63 616c 6c5f 7374 6163  ef get_call_stac
-00040570: 6b28 7365 6c66 2c20 6b65 7973 3a20 4974  k(self, keys: It
-00040580: 6572 6162 6c65 5b73 7472 5d20 7c20 4e6f  erable[str] | No
-00040590: 6e65 203d 204e 6f6e 6529 202d 3e20 6469  ne = None) -> di
-000405a0: 6374 3a0a 2020 2020 2020 2020 776f 726b  ct:.        work
-000405b0: 6572 733a 2064 6963 745b 7374 722c 206c  ers: dict[str, l
-000405c0: 6973 745b 7374 725d 207c 204e 6f6e 655d  ist[str] | None]
-000405d0: 0a20 2020 2020 2020 2069 6620 6b65 7973  .        if keys
-000405e0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-000405f0: 2020 2020 2020 2020 2020 7374 6163 6b20            stack 
-00040600: 3d20 6c69 7374 286b 6579 7329 0a20 2020  = list(keys).   
-00040610: 2020 2020 2020 2020 2070 726f 6365 7373           process
-00040620: 696e 6720 3d20 7365 7428 290a 2020 2020  ing = set().    
-00040630: 2020 2020 2020 2020 7768 696c 6520 7374          while st
-00040640: 6163 6b3a 0a20 2020 2020 2020 2020 2020  ack:.           
-00040650: 2020 2020 206b 6579 203d 2073 7461 636b       key = stack
-00040660: 2e70 6f70 2829 0a20 2020 2020 2020 2020  .pop().         
-00040670: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-00040680: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
-00040690: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-000406a0: 732e 7374 6174 6520 3d3d 2022 7761 6974  s.state == "wait
-000406b0: 696e 6722 3a0a 2020 2020 2020 2020 2020  ing":.          
-000406c0: 2020 2020 2020 2020 2020 7374 6163 6b2e            stack.
-000406d0: 6578 7465 6e64 285b 6474 732e 6b65 7920  extend([dts.key 
-000406e0: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
-000406f0: 7065 6e64 656e 6369 6573 5d29 0a20 2020  pendencies]).   
-00040700: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
-00040710: 6620 7473 2e73 7461 7465 203d 3d20 2270  f ts.state == "p
-00040720: 726f 6365 7373 696e 6722 3a0a 2020 2020  rocessing":.    
-00040730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040740: 7072 6f63 6573 7369 6e67 2e61 6464 2874  processing.add(t
-00040750: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
-00040760: 776f 726b 6572 7320 3d20 6465 6661 756c  workers = defaul
-00040770: 7464 6963 7428 6c69 7374 290a 2020 2020  tdict(list).    
-00040780: 2020 2020 2020 2020 666f 7220 7473 2069          for ts i
-00040790: 6e20 7072 6f63 6573 7369 6e67 3a0a 2020  n processing:.  
-000407a0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000407b0: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
-000407c0: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
-000407d0: 2020 2020 2020 2077 6b65 7973 203d 2077         wkeys = w
-000407e0: 6f72 6b65 7273 5b74 732e 7072 6f63 6573  orkers[ts.proces
-000407f0: 7369 6e67 5f6f 6e2e 6164 6472 6573 735d  sing_on.address]
-00040800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00040810: 2020 2020 2061 7373 6572 7420 776b 6579       assert wkey
-00040820: 7320 6973 206e 6f74 204e 6f6e 650a 2020  s is not None.  
-00040830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040840: 2020 776b 6579 732e 6170 7065 6e64 2874    wkeys.append(t
-00040850: 732e 6b65 7929 0a20 2020 2020 2020 2065  s.key).        e
-00040860: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00040870: 2077 6f72 6b65 7273 203d 207b 773a 204e   workers = {w: N
-00040880: 6f6e 6520 666f 7220 7720 696e 2073 656c  one for w in sel
-00040890: 662e 776f 726b 6572 737d 0a0a 2020 2020  f.workers}..    
-000408a0: 2020 2020 6966 206e 6f74 2077 6f72 6b65      if not worke
-000408b0: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-000408c0: 7265 7475 726e 207b 7d0a 0a20 2020 2020  return {}..     
-000408d0: 2020 2072 6573 756c 7473 203d 2061 7761     results = awa
-000408e0: 6974 2061 7379 6e63 696f 2e67 6174 6865  it asyncio.gathe
-000408f0: 7228 0a20 2020 2020 2020 2020 2020 202a  r(.            *
-00040900: 2873 656c 662e 7270 6328 7729 2e63 616c  (self.rpc(w).cal
-00040910: 6c5f 7374 6163 6b28 6b65 7973 3d76 2920  l_stack(keys=v) 
-00040920: 666f 7220 772c 2076 2069 6e20 776f 726b  for w, v in work
-00040930: 6572 732e 6974 656d 7328 2929 0a20 2020  ers.items()).   
-00040940: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
-00040950: 6573 706f 6e73 6520 3d20 7b77 3a20 7220  esponse = {w: r 
-00040960: 666f 7220 772c 2072 2069 6e20 7a69 7028  for w, r in zip(
-00040970: 776f 726b 6572 732c 2072 6573 756c 7473  workers, results
-00040980: 2920 6966 2072 7d0a 2020 2020 2020 2020  ) if r}.        
-00040990: 7265 7475 726e 2072 6573 706f 6e73 650a  return response.
-000409a0: 0a20 2020 2061 7379 6e63 2064 6566 2062  .    async def b
-000409b0: 656e 6368 6d61 726b 5f68 6172 6477 6172  enchmark_hardwar
-000409c0: 6528 7365 6c66 2920 2d3e 2022 6469 6374  e(self) -> "dict
-000409d0: 5b73 7472 2c20 6469 6374 5b73 7472 2c20  [str, dict[str, 
-000409e0: 666c 6f61 745d 5d22 3a0a 2020 2020 2020  float]]":.      
-000409f0: 2020 2222 220a 2020 2020 2020 2020 5275    """.        Ru
-00040a00: 6e20 6120 6265 6e63 686d 6172 6b20 6f6e  n a benchmark on
-00040a10: 2074 6865 2077 6f72 6b65 7273 2066 6f72   the workers for
-00040a20: 206d 656d 6f72 792c 2064 6973 6b2c 2061   memory, disk, a
-00040a30: 6e64 206e 6574 776f 726b 2062 616e 6477  nd network bandw
-00040a40: 6964 7468 730a 0a20 2020 2020 2020 2052  idths..        R
-00040a50: 6574 7572 6e73 0a20 2020 2020 2020 202d  eturns.        -
-00040a60: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2072  ------.        r
-00040a70: 6573 756c 743a 2064 6963 740a 2020 2020  esult: dict.    
-00040a80: 2020 2020 2020 2020 4120 6469 6374 696f          A dictio
-00040a90: 6e61 7279 206d 6170 7069 6e67 2074 6865  nary mapping the
-00040aa0: 206e 616d 6573 2022 6469 736b 222c 2022   names "disk", "
-00040ab0: 6d65 6d6f 7279 222c 2061 6e64 2022 6e65  memory", and "ne
-00040ac0: 7477 6f72 6b22 2074 6f0a 2020 2020 2020  twork" to.      
-00040ad0: 2020 2020 2020 6469 6374 696f 6e61 7269        dictionari
-00040ae0: 6573 206d 6170 7069 6e67 2073 697a 6573  es mapping sizes
-00040af0: 2074 6f20 6261 6e64 7769 6474 6873 2e20   to bandwidths. 
-00040b00: 2054 6865 7365 2062 616e 6477 6964 7468   These bandwidth
-00040b10: 7320 6172 650a 2020 2020 2020 2020 2020  s are.          
-00040b20: 2020 6176 6572 6167 6564 206f 7665 7220    averaged over 
-00040b30: 6d61 6e79 2077 6f72 6b65 7273 2072 756e  many workers run
-00040b40: 6e69 6e67 2063 6f6d 7075 7461 7469 6f6e  ning computation
-00040b50: 7320 6163 726f 7373 2074 6865 2063 6c75  s across the clu
-00040b60: 7374 6572 2e0a 2020 2020 2020 2020 2222  ster..        ""
-00040b70: 220a 2020 2020 2020 2020 6f75 743a 2064  ".        out: d
-00040b80: 6963 745b 7374 722c 2064 6566 6175 6c74  ict[str, default
-00040b90: 6469 6374 5b73 7472 2c20 6c69 7374 5b66  dict[str, list[f
-00040ba0: 6c6f 6174 5d5d 5d20 3d20 7b0a 2020 2020  loat]]] = {.    
-00040bb0: 2020 2020 2020 2020 6e61 6d65 3a20 6465          name: de
-00040bc0: 6661 756c 7464 6963 7428 6c69 7374 2920  faultdict(list) 
-00040bd0: 666f 7220 6e61 6d65 2069 6e20 5b22 6469  for name in ["di
-00040be0: 736b 222c 2022 6d65 6d6f 7279 222c 2022  sk", "memory", "
-00040bf0: 6e65 7477 6f72 6b22 5d0a 2020 2020 2020  network"].      
-00040c00: 2020 7d0a 0a20 2020 2020 2020 2023 2064    }..        # d
-00040c10: 6973 6b0a 2020 2020 2020 2020 7265 7375  isk.        resu
-00040c20: 6c74 203d 2061 7761 6974 2073 656c 662e  lt = await self.
-00040c30: 6272 6f61 6463 6173 7428 6d73 673d 7b22  broadcast(msg={"
-00040c40: 6f70 223a 2022 6265 6e63 686d 6172 6b5f  op": "benchmark_
-00040c50: 6469 736b 227d 290a 2020 2020 2020 2020  disk"}).        
-00040c60: 666f 7220 6420 696e 2072 6573 756c 742e  for d in result.
-00040c70: 7661 6c75 6573 2829 3a0a 2020 2020 2020  values():.      
-00040c80: 2020 2020 2020 666f 7220 7369 7a65 2c20        for size, 
-00040c90: 6475 7261 7469 6f6e 2069 6e20 642e 6974  duration in d.it
-00040ca0: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
-00040cb0: 2020 2020 2020 206f 7574 5b22 6469 736b         out["disk
-00040cc0: 225d 5b73 697a 655d 2e61 7070 656e 6428  "][size].append(
-00040cd0: 6475 7261 7469 6f6e 290a 0a20 2020 2020  duration)..     
-00040ce0: 2020 2023 206d 656d 6f72 790a 2020 2020     # memory.    
-00040cf0: 2020 2020 7265 7375 6c74 203d 2061 7761      result = awa
-00040d00: 6974 2073 656c 662e 6272 6f61 6463 6173  it self.broadcas
-00040d10: 7428 6d73 673d 7b22 6f70 223a 2022 6265  t(msg={"op": "be
-00040d20: 6e63 686d 6172 6b5f 6d65 6d6f 7279 227d  nchmark_memory"}
-00040d30: 290a 2020 2020 2020 2020 666f 7220 6420  ).        for d 
-00040d40: 696e 2072 6573 756c 742e 7661 6c75 6573  in result.values
-00040d50: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00040d60: 666f 7220 7369 7a65 2c20 6475 7261 7469  for size, durati
-00040d70: 6f6e 2069 6e20 642e 6974 656d 7328 293a  on in d.items():
-00040d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00040d90: 206f 7574 5b22 6d65 6d6f 7279 225d 5b73   out["memory"][s
-00040da0: 697a 655d 2e61 7070 656e 6428 6475 7261  ize].append(dura
-00040db0: 7469 6f6e 290a 0a20 2020 2020 2020 2023  tion)..        #
-00040dc0: 206e 6574 776f 726b 0a20 2020 2020 2020   network.       
-00040dd0: 2077 6f72 6b65 7273 203d 206c 6973 7428   workers = list(
-00040de0: 7365 6c66 2e77 6f72 6b65 7273 290a 2020  self.workers).  
-00040df0: 2020 2020 2020 2320 4f6e 2061 6e20 6164        # On an ad
-00040e00: 6170 7469 7665 2063 6c75 7374 6572 2c20  aptive cluster, 
-00040e10: 6966 206d 756c 7469 706c 6520 776f 726b  if multiple work
-00040e20: 6572 7320 6172 6520 7374 6172 7465 6420  ers are started 
-00040e30: 6f6e 2074 6865 2073 616d 6520 7068 7973  on the same phys
-00040e40: 6963 616c 2068 6f73 742c 0a20 2020 2020  ical host,.     
-00040e50: 2020 2023 2074 6865 7920 6172 6520 6d6f     # they are mo
-00040e60: 7265 206c 696b 656c 7920 746f 2063 6f6e  re likely to con
-00040e70: 6e65 6374 2074 6f20 7468 6520 5363 6865  nect to the Sche
-00040e80: 6475 6c65 7220 696e 2073 6571 7565 6e63  duler in sequenc
-00040e90: 652c 2065 6e64 696e 6720 7570 206e 6578  e, ending up nex
-00040ea0: 7420 746f 0a20 2020 2020 2020 2023 2065  t to.        # e
-00040eb0: 6163 6820 6f74 6865 7220 696e 2074 6869  ach other in thi
-00040ec0: 7320 6c69 7374 2e0a 2020 2020 2020 2020  s list..        
-00040ed0: 2320 5468 6520 7472 616e 7366 6572 2073  # The transfer s
-00040ee0: 7065 6564 2077 6974 6869 6e20 7375 6368  peed within such
-00040ef0: 2063 6c75 7374 6572 7320 6f66 2077 6f72   clusters of wor
-00040f00: 6b65 7273 2077 696c 6c20 6265 2065 6666  kers will be eff
-00040f10: 6563 7469 7665 6c79 2074 6861 7420 6f66  ectively that of
-00040f20: 0a20 2020 2020 2020 2023 206c 6f63 616c  .        # local
-00040f30: 686f 7374 2e20 5468 6973 2063 6f75 6c64  host. This could
-00040f40: 2068 6170 7065 6e20 6163 726f 7373 2064   happen across d
-00040f50: 6966 6665 7265 6e74 2056 4d73 2061 6e64  ifferent VMs and
-00040f60: 2f6f 7220 646f 636b 6572 2069 6d61 6765  /or docker image
-00040f70: 732c 2073 6f0a 2020 2020 2020 2020 2320  s, so.        # 
-00040f80: 696d 706c 656d 656e 7469 6e67 206c 6f67  implementing log
-00040f90: 6963 2062 6173 6564 206f 6e20 4950 2061  ic based on IP a
-00040fa0: 6464 7265 7373 6573 2077 6f75 6c64 206e  ddresses would n
-00040fb0: 6f74 206e 6563 6573 7361 7269 6c79 2068  ot necessarily h
-00040fc0: 656c 702e 0a20 2020 2020 2020 2023 2052  elp..        # R
-00040fd0: 616e 646f 6d69 7a65 2074 6865 2063 6f6e  andomize the con
-00040fe0: 6e65 6374 696f 6e73 2074 6f20 6576 656e  nections to even
-00040ff0: 206f 7574 2074 6865 206d 6561 6e20 6d65   out the mean me
-00041000: 6173 7572 6573 2e0a 2020 2020 2020 2020  asures..        
-00041010: 7261 6e64 6f6d 2e73 6875 6666 6c65 2877  random.shuffle(w
-00041020: 6f72 6b65 7273 290a 2020 2020 2020 2020  orkers).        
-00041030: 6675 7475 7265 7320 3d20 5b0a 2020 2020  futures = [.    
-00041040: 2020 2020 2020 2020 7365 6c66 2e72 7063          self.rpc
-00041050: 2861 292e 6265 6e63 686d 6172 6b5f 6e65  (a).benchmark_ne
-00041060: 7477 6f72 6b28 6164 6472 6573 733d 6229  twork(address=b)
-00041070: 2066 6f72 2061 2c20 6220 696e 2070 6172   for a, b in par
-00041080: 7469 7469 6f6e 2832 2c20 776f 726b 6572  tition(2, worker
-00041090: 7329 0a20 2020 2020 2020 205d 0a20 2020  s).        ].   
-000410a0: 2020 2020 2072 6573 706f 6e73 6573 203d       responses =
-000410b0: 2061 7761 6974 2061 7379 6e63 696f 2e67   await asyncio.g
-000410c0: 6174 6865 7228 2a66 7574 7572 6573 290a  ather(*futures).
-000410d0: 0a20 2020 2020 2020 2066 6f72 2064 2069  .        for d i
-000410e0: 6e20 7265 7370 6f6e 7365 733a 0a20 2020  n responses:.   
-000410f0: 2020 2020 2020 2020 2066 6f72 2073 697a           for siz
-00041100: 652c 2064 7572 6174 696f 6e20 696e 2064  e, duration in d
-00041110: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-00041120: 2020 2020 2020 2020 2020 6f75 745b 226e            out["n
-00041130: 6574 776f 726b 225d 5b73 697a 655d 2e61  etwork"][size].a
-00041140: 7070 656e 6428 6475 7261 7469 6f6e 290a  ppend(duration).
-00041150: 0a20 2020 2020 2020 2072 6573 756c 7420  .        result 
-00041160: 3d20 7b7d 0a20 2020 2020 2020 2066 6f72  = {}.        for
-00041170: 206d 6f64 6520 696e 206f 7574 3a0a 2020   mode in out:.  
-00041180: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-00041190: 5b6d 6f64 655d 203d 207b 0a20 2020 2020  [mode] = {.     
-000411a0: 2020 2020 2020 2020 2020 2073 697a 653a             size:
-000411b0: 2073 756d 2864 7572 6174 696f 6e73 2920   sum(durations) 
-000411c0: 2f20 6c65 6e28 6475 7261 7469 6f6e 7329  / len(durations)
-000411d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000411e0: 2066 6f72 2073 697a 652c 2064 7572 6174   for size, durat
-000411f0: 696f 6e73 2069 6e20 6f75 745b 6d6f 6465  ions in out[mode
-00041200: 5d2e 6974 656d 7328 290a 2020 2020 2020  ].items().      
-00041210: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00041220: 2072 6574 7572 6e20 7265 7375 6c74 0a0a   return result..
-00041230: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
-00041240: 2020 2020 6465 6620 6765 745f 6e62 7974      def get_nbyt
-00041250: 6573 280a 2020 2020 2020 2020 7365 6c66  es(.        self
-00041260: 2c20 6b65 7973 3a20 4974 6572 6162 6c65  , keys: Iterable
-00041270: 5b73 7472 5d20 7c20 4e6f 6e65 203d 204e  [str] | None = N
-00041280: 6f6e 652c 2073 756d 6d61 7279 3a20 626f  one, summary: bo
-00041290: 6f6c 203d 2054 7275 650a 2020 2020 2920  ol = True.    ) 
-000412a0: 2d3e 2064 6963 745b 7374 722c 2069 6e74  -> dict[str, int
-000412b0: 5d3a 0a20 2020 2020 2020 2069 6620 6b65  ]:.        if ke
-000412c0: 7973 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ys is not None:.
-000412d0: 2020 2020 2020 2020 2020 2020 7265 7375              resu
-000412e0: 6c74 203d 207b 6b3a 2073 656c 662e 7461  lt = {k: self.ta
-000412f0: 736b 735b 6b5d 2e6e 6279 7465 7320 666f  sks[k].nbytes fo
-00041300: 7220 6b20 696e 206b 6579 737d 0a20 2020  r k in keys}.   
-00041310: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00041320: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-00041330: 7b6b 3a20 7473 2e6e 6279 7465 7320 666f  {k: ts.nbytes fo
-00041340: 7220 6b2c 2074 7320 696e 2073 656c 662e  r k, ts in self.
-00041350: 7461 736b 732e 6974 656d 7328 2920 6966  tasks.items() if
-00041360: 2074 732e 6e62 7974 6573 203e 3d20 307d   ts.nbytes >= 0}
-00041370: 0a0a 2020 2020 2020 2020 6966 2073 756d  ..        if sum
-00041380: 6d61 7279 3a0a 2020 2020 2020 2020 2020  mary:.          
-00041390: 2020 6f75 743a 2064 6566 6175 6c74 6469    out: defaultdi
-000413a0: 6374 5b73 7472 2c20 696e 745d 203d 2064  ct[str, int] = d
-000413b0: 6566 6175 6c74 6469 6374 286c 616d 6264  efaultdict(lambd
-000413c0: 613a 2030 290a 2020 2020 2020 2020 2020  a: 0).          
-000413d0: 2020 666f 7220 6b2c 2076 2069 6e20 7265    for k, v in re
-000413e0: 7375 6c74 2e69 7465 6d73 2829 3a0a 2020  sult.items():.  
-000413f0: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
-00041400: 745b 6b65 795f 7370 6c69 7428 6b29 5d20  t[key_split(k)] 
-00041410: 2b3d 2076 0a20 2020 2020 2020 2020 2020  += v.           
-00041420: 2072 6573 756c 7420 3d20 6469 6374 286f   result = dict(o
-00041430: 7574 290a 0a20 2020 2020 2020 2072 6574  ut)..        ret
-00041440: 7572 6e20 7265 7375 6c74 0a0a 2020 2020  urn result..    
-00041450: 6465 6620 7275 6e5f 6675 6e63 7469 6f6e  def run_function
-00041460: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-00041470: 2020 2020 2020 2020 636f 6d6d 3a20 436f          comm: Co
-00041480: 6d6d 2c0a 2020 2020 2020 2020 6675 6e63  mm,.        func
-00041490: 7469 6f6e 3a20 4361 6c6c 6162 6c65 2c0a  tion: Callable,.
-000414a0: 2020 2020 2020 2020 6172 6773 3a20 7475          args: tu
-000414b0: 706c 6520 3d20 2829 2c0a 2020 2020 2020  ple = (),.      
-000414c0: 2020 6b77 6172 6773 3a20 6469 6374 207c    kwargs: dict |
-000414d0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-000414e0: 2020 2020 2020 7761 6974 3a20 626f 6f6c        wait: bool
-000414f0: 203d 2054 7275 652c 0a20 2020 2029 202d   = True,.    ) -
-00041500: 3e20 416e 793a 0a20 2020 2020 2020 2022  > Any:.        "
-00041510: 2222 5275 6e20 6120 6675 6e63 7469 6f6e  ""Run a function
-00041520: 2077 6974 6869 6e20 7468 6973 2070 726f   within this pro
-00041530: 6365 7373 0a0a 2020 2020 2020 2020 5365  cess..        Se
-00041540: 6520 416c 736f 0a20 2020 2020 2020 202d  e Also.        -
-00041550: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-00041560: 436c 6965 6e74 2e72 756e 5f6f 6e5f 7363  Client.run_on_sc
-00041570: 6865 6475 6c65 720a 2020 2020 2020 2020  heduler.        
-00041580: 2222 220a 2020 2020 2020 2020 6672 6f6d  """.        from
-00041590: 2064 6973 7472 6962 7574 6564 2e77 6f72   distributed.wor
-000415a0: 6b65 7220 696d 706f 7274 2072 756e 0a0a  ker import run..
-000415b0: 2020 2020 2020 2020 6966 206e 6f74 2064          if not d
-000415c0: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
-000415d0: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
-000415e0: 6475 6c65 722e 7069 636b 6c65 2229 3a0a  duler.pickle"):.
-000415f0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00041600: 6520 5661 6c75 6545 7272 6f72 280a 2020  e ValueError(.  
-00041610: 2020 2020 2020 2020 2020 2020 2020 2243                "C
-00041620: 616e 6e6f 7420 7275 6e20 6675 6e63 7469  annot run functi
-00041630: 6f6e 2061 7320 7468 6520 7363 6865 6475  on as the schedu
-00041640: 6c65 7220 6861 7320 6265 656e 2065 7870  ler has been exp
-00041650: 6c69 6369 746c 7920 6469 7361 6c6c 6f77  licitly disallow
-00041660: 6564 2066 726f 6d20 220a 2020 2020 2020  ed from ".      
-00041670: 2020 2020 2020 2020 2020 2264 6573 6572            "deser
-00041680: 6961 6c69 7a69 6e67 2061 7262 6974 7261  ializing arbitra
-00041690: 7279 2062 7974 6573 7472 696e 6773 2075  ry bytestrings u
-000416a0: 7369 6e67 2070 6963 6b6c 6520 7669 6120  sing pickle via 
-000416b0: 7468 6520 220a 2020 2020 2020 2020 2020  the ".          
-000416c0: 2020 2020 2020 2227 6469 7374 7269 6275        "'distribu
-000416d0: 7465 642e 7363 6865 6475 6c65 722e 7069  ted.scheduler.pi
-000416e0: 636b 6c65 2720 636f 6e66 6967 7572 6174  ckle' configurat
-000416f0: 696f 6e20 7365 7474 696e 672e 220a 2020  ion setting.".  
-00041700: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00041710: 2020 2020 6b77 6172 6773 203d 206b 7761      kwargs = kwa
-00041720: 7267 7320 6f72 207b 7d0a 2020 2020 2020  rgs or {}.      
-00041730: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
-00041740: 2822 616c 6c22 2c20 7b22 6163 7469 6f6e  ("all", {"action
-00041750: 223a 2022 7275 6e2d 6675 6e63 7469 6f6e  ": "run-function
-00041760: 222c 2022 6675 6e63 7469 6f6e 223a 2066  ", "function": f
-00041770: 756e 6374 696f 6e7d 290a 2020 2020 2020  unction}).      
-00041780: 2020 7265 7475 726e 2072 756e 2873 656c    return run(sel
-00041790: 662c 2063 6f6d 6d2c 2066 756e 6374 696f  f, comm, functio
-000417a0: 6e3d 6675 6e63 7469 6f6e 2c20 6172 6773  n=function, args
-000417b0: 3d61 7267 732c 206b 7761 7267 733d 6b77  =args, kwargs=kw
-000417c0: 6172 6773 2c20 7761 6974 3d77 6169 7429  args, wait=wait)
-000417d0: 0a0a 2020 2020 6465 6620 7365 745f 6d65  ..    def set_me
-000417e0: 7461 6461 7461 2873 656c 662c 206b 6579  tadata(self, key
-000417f0: 733a 206c 6973 745b 7374 725d 2c20 7661  s: list[str], va
-00041800: 6c75 653a 206f 626a 6563 7420 3d20 4e6f  lue: object = No
-00041810: 6e65 2920 2d3e 204e 6f6e 653a 0a20 2020  ne) -> None:.   
-00041820: 2020 2020 206d 6574 6164 6174 6120 3d20       metadata = 
-00041830: 7365 6c66 2e74 6173 6b5f 6d65 7461 6461  self.task_metada
-00041840: 7461 0a20 2020 2020 2020 2066 6f72 206b  ta.        for k
-00041850: 6579 2069 6e20 6b65 7973 5b3a 2d31 5d3a  ey in keys[:-1]:
-00041860: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00041870: 6b65 7920 6e6f 7420 696e 206d 6574 6164  key not in metad
-00041880: 6174 6120 6f72 206e 6f74 2069 7369 6e73  ata or not isins
-00041890: 7461 6e63 6528 6d65 7461 6461 7461 5b6b  tance(metadata[k
-000418a0: 6579 5d2c 2028 6469 6374 2c20 6c69 7374  ey], (dict, list
-000418b0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-000418c0: 2020 2020 6d65 7461 6461 7461 5b6b 6579      metadata[key
-000418d0: 5d20 3d20 7b7d 0a20 2020 2020 2020 2020  ] = {}.         
-000418e0: 2020 206d 6574 6164 6174 6120 3d20 6d65     metadata = me
-000418f0: 7461 6461 7461 5b6b 6579 5d0a 2020 2020  tadata[key].    
-00041900: 2020 2020 6d65 7461 6461 7461 5b6b 6579      metadata[key
-00041910: 735b 2d31 5d5d 203d 2076 616c 7565 0a0a  s[-1]] = value..
-00041920: 2020 2020 6465 6620 6765 745f 6d65 7461      def get_meta
-00041930: 6461 7461 2873 656c 662c 206b 6579 733a  data(self, keys:
-00041940: 206c 6973 745b 7374 725d 2c20 6465 6661   list[str], defa
-00041950: 756c 743a 2041 6e79 203d 206e 6f5f 6465  ult: Any = no_de
-00041960: 6661 756c 7429 202d 3e20 416e 793a 0a20  fault) -> Any:. 
-00041970: 2020 2020 2020 206d 6574 6164 6174 6120         metadata 
-00041980: 3d20 7365 6c66 2e74 6173 6b5f 6d65 7461  = self.task_meta
-00041990: 6461 7461 0a20 2020 2020 2020 2074 7279  data.        try
-000419a0: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-000419b0: 7220 6b65 7920 696e 206b 6579 733a 0a20  r key in keys:. 
-000419c0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-000419d0: 6574 6164 6174 6120 3d20 6d65 7461 6461  etadata = metada
-000419e0: 7461 5b6b 6579 5d0a 2020 2020 2020 2020  ta[key].        
-000419f0: 2020 2020 7265 7475 726e 206d 6574 6164      return metad
-00041a00: 6174 610a 2020 2020 2020 2020 6578 6365  ata.        exce
-00041a10: 7074 204b 6579 4572 726f 723a 0a20 2020  pt KeyError:.   
-00041a20: 2020 2020 2020 2020 2069 6620 6465 6661           if defa
-00041a30: 756c 7420 213d 206e 6f5f 6465 6661 756c  ult != no_defaul
-00041a40: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-00041a50: 2020 2072 6574 7572 6e20 6465 6661 756c     return defaul
-00041a60: 740a 2020 2020 2020 2020 2020 2020 656c  t.            el
-00041a70: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00041a80: 2020 2020 7261 6973 650a 0a20 2020 2064      raise..    d
-00041a90: 6566 2073 6574 5f72 6573 7472 6963 7469  ef set_restricti
-00041aa0: 6f6e 7328 7365 6c66 2c20 776f 726b 6572  ons(self, worker
-00041ab0: 3a20 6469 6374 5b73 7472 2c20 436f 6c6c  : dict[str, Coll
-00041ac0: 6563 7469 6f6e 5b73 7472 5d20 7c20 7374  ection[str] | st
-00041ad0: 725d 2920 2d3e 204e 6f6e 653a 0a20 2020  r]) -> None:.   
-00041ae0: 2020 2020 2066 6f72 206b 6579 2c20 7265       for key, re
-00041af0: 7374 7269 6374 696f 6e73 2069 6e20 776f  strictions in wo
-00041b00: 726b 6572 2e69 7465 6d73 2829 3a0a 2020  rker.items():.  
-00041b10: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
-00041b20: 656c 662e 7461 736b 735b 6b65 795d 0a20  elf.tasks[key]. 
-00041b30: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-00041b40: 696e 7374 616e 6365 2872 6573 7472 6963  instance(restric
-00041b50: 7469 6f6e 732c 2073 7472 293a 0a20 2020  tions, str):.   
-00041b60: 2020 2020 2020 2020 2020 2020 2072 6573               res
-00041b70: 7472 6963 7469 6f6e 7320 3d20 7b72 6573  trictions = {res
-00041b80: 7472 6963 7469 6f6e 737d 0a20 2020 2020  trictions}.     
-00041b90: 2020 2020 2020 2074 732e 776f 726b 6572         ts.worker
-00041ba0: 5f72 6573 7472 6963 7469 6f6e 7320 3d20  _restrictions = 
-00041bb0: 7365 7428 7265 7374 7269 6374 696f 6e73  set(restrictions
-00041bc0: 290a 0a20 2020 2040 6c6f 675f 6572 726f  )..    @log_erro
-00041bd0: 7273 0a20 2020 2064 6566 2067 6574 5f74  rs.    def get_t
-00041be0: 6173 6b5f 7072 6566 6978 5f73 7461 7465  ask_prefix_state
-00041bf0: 7328 7365 6c66 2920 2d3e 2064 6963 745b  s(self) -> dict[
-00041c00: 7374 722c 2064 6963 745b 7374 722c 2069  str, dict[str, i
-00041c10: 6e74 5d5d 3a0a 2020 2020 2020 2020 7374  nt]]:.        st
-00041c20: 6174 6520 3d20 7b7d 0a0a 2020 2020 2020  ate = {}..      
-00041c30: 2020 666f 7220 7470 2069 6e20 7365 6c66    for tp in self
-00041c40: 2e74 6173 6b5f 7072 6566 6978 6573 2e76  .task_prefixes.v
-00041c50: 616c 7565 7328 293a 0a20 2020 2020 2020  alues():.       
-00041c60: 2020 2020 2061 6374 6976 655f 7374 6174       active_stat
-00041c70: 6573 203d 2074 702e 6163 7469 7665 5f73  es = tp.active_s
-00041c80: 7461 7465 730a 2020 2020 2020 2020 2020  tates.          
-00041c90: 2020 6966 2061 6e79 280a 2020 2020 2020    if any(.      
-00041ca0: 2020 2020 2020 2020 2020 6163 7469 7665            active
-00041cb0: 5f73 7461 7465 732e 6765 7428 7329 0a20  _states.get(s). 
-00041cc0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00041cd0: 6f72 2073 2069 6e20 7b22 6d65 6d6f 7279  or s in {"memory
-00041ce0: 222c 2022 6572 7265 6422 2c20 2272 656c  ", "erred", "rel
-00041cf0: 6561 7365 6422 2c20 2270 726f 6365 7373  eased", "process
-00041d00: 696e 6722 2c20 2277 6169 7469 6e67 227d  ing", "waiting"}
-00041d10: 0a20 2020 2020 2020 2020 2020 2029 3a0a  .            ):.
-00041d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041d30: 7374 6174 655b 7470 2e6e 616d 655d 203d  state[tp.name] =
-00041d40: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00041d50: 2020 2020 2020 2022 6d65 6d6f 7279 223a         "memory":
-00041d60: 2061 6374 6976 655f 7374 6174 6573 5b22   active_states["
-00041d70: 6d65 6d6f 7279 225d 2c0a 2020 2020 2020  memory"],.      
-00041d80: 2020 2020 2020 2020 2020 2020 2020 2265                "e
-00041d90: 7272 6564 223a 2061 6374 6976 655f 7374  rred": active_st
-00041da0: 6174 6573 5b22 6572 7265 6422 5d2c 0a20  ates["erred"],. 
-00041db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041dc0: 2020 2022 7265 6c65 6173 6564 223a 2061     "released": a
-00041dd0: 6374 6976 655f 7374 6174 6573 5b22 7265  ctive_states["re
-00041de0: 6c65 6173 6564 225d 2c0a 2020 2020 2020  leased"],.      
-00041df0: 2020 2020 2020 2020 2020 2020 2020 2270                "p
-00041e00: 726f 6365 7373 696e 6722 3a20 6163 7469  rocessing": acti
-00041e10: 7665 5f73 7461 7465 735b 2270 726f 6365  ve_states["proce
-00041e20: 7373 696e 6722 5d2c 0a20 2020 2020 2020  ssing"],.       
-00041e30: 2020 2020 2020 2020 2020 2020 2022 7761               "wa
-00041e40: 6974 696e 6722 3a20 6163 7469 7665 5f73  iting": active_s
-00041e50: 7461 7465 735b 2277 6169 7469 6e67 225d  tates["waiting"]
-00041e60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00041e70: 2020 7d0a 0a20 2020 2020 2020 2072 6574    }..        ret
-00041e80: 7572 6e20 7374 6174 650a 0a20 2020 2064  urn state..    d
-00041e90: 6566 2067 6574 5f74 6173 6b5f 7374 6174  ef get_task_stat
-00041ea0: 7573 2873 656c 662c 206b 6579 733a 2049  us(self, keys: I
-00041eb0: 7465 7261 626c 655b 7374 725d 2920 2d3e  terable[str]) ->
-00041ec0: 2064 6963 745b 7374 722c 2054 6173 6b53   dict[str, TaskS
-00041ed0: 7461 7465 5374 6174 6520 7c20 4e6f 6e65  tateState | None
-00041ee0: 5d3a 0a20 2020 2020 2020 2072 6574 7572  ]:.        retur
-00041ef0: 6e20 7b0a 2020 2020 2020 2020 2020 2020  n {.            
-00041f00: 6b65 793a 2028 7365 6c66 2e74 6173 6b73  key: (self.tasks
-00041f10: 5b6b 6579 5d2e 7374 6174 6520 6966 206b  [key].state if k
-00041f20: 6579 2069 6e20 7365 6c66 2e74 6173 6b73  ey in self.tasks
-00041f30: 2065 6c73 6520 4e6f 6e65 2920 666f 7220   else None) for 
-00041f40: 6b65 7920 696e 206b 6579 730a 2020 2020  key in keys.    
-00041f50: 2020 2020 7d0a 0a20 2020 2064 6566 2067      }..    def g
-00041f60: 6574 5f74 6173 6b5f 7374 7265 616d 280a  et_task_stream(.
-00041f70: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-00041f80: 2020 2020 2020 7374 6172 743a 2073 7472        start: str
-00041f90: 207c 2066 6c6f 6174 207c 204e 6f6e 6520   | float | None 
-00041fa0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00041fb0: 7374 6f70 3a20 7374 7220 7c20 666c 6f61  stop: str | floa
-00041fc0: 7420 7c20 4e6f 6e65 203d 204e 6f6e 652c  t | None = None,
-00041fd0: 0a20 2020 2020 2020 2063 6f75 6e74 3a20  .        count: 
-00041fe0: 696e 7420 7c20 4e6f 6e65 203d 204e 6f6e  int | None = Non
-00041ff0: 652c 0a20 2020 2029 202d 3e20 6c69 7374  e,.    ) -> list
-00042000: 3a0a 2020 2020 2020 2020 6672 6f6d 2064  :.        from d
-00042010: 6973 7472 6962 7574 6564 2e64 6961 676e  istributed.diagn
-00042020: 6f73 7469 6373 2e74 6173 6b5f 7374 7265  ostics.task_stre
-00042030: 616d 2069 6d70 6f72 7420 5461 736b 5374  am import TaskSt
-00042040: 7265 616d 506c 7567 696e 0a0a 2020 2020  reamPlugin..    
-00042050: 2020 2020 6966 2054 6173 6b53 7472 6561      if TaskStrea
-00042060: 6d50 6c75 6769 6e2e 6e61 6d65 206e 6f74  mPlugin.name not
-00042070: 2069 6e20 7365 6c66 2e70 6c75 6769 6e73   in self.plugins
-00042080: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00042090: 6c66 2e61 6464 5f70 6c75 6769 6e28 5461  lf.add_plugin(Ta
-000420a0: 736b 5374 7265 616d 506c 7567 696e 2873  skStreamPlugin(s
-000420b0: 656c 6629 290a 0a20 2020 2020 2020 2070  elf))..        p
-000420c0: 6c75 6769 6e20 3d20 6361 7374 2854 6173  lugin = cast(Tas
-000420d0: 6b53 7472 6561 6d50 6c75 6769 6e2c 2073  kStreamPlugin, s
-000420e0: 656c 662e 706c 7567 696e 735b 5461 736b  elf.plugins[Task
-000420f0: 5374 7265 616d 506c 7567 696e 2e6e 616d  StreamPlugin.nam
-00042100: 655d 290a 0a20 2020 2020 2020 2072 6574  e])..        ret
-00042110: 7572 6e20 706c 7567 696e 2e63 6f6c 6c65  urn plugin.colle
-00042120: 6374 2873 7461 7274 3d73 7461 7274 2c20  ct(start=start, 
-00042130: 7374 6f70 3d73 746f 702c 2063 6f75 6e74  stop=stop, count
-00042140: 3d63 6f75 6e74 290a 0a20 2020 2064 6566  =count)..    def
-00042150: 2073 7461 7274 5f74 6173 6b5f 6d65 7461   start_task_meta
-00042160: 6461 7461 2873 656c 662c 206e 616d 653a  data(self, name:
-00042170: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
-00042180: 2020 2020 2020 2070 6c75 6769 6e20 3d20         plugin = 
-00042190: 436f 6c6c 6563 7454 6173 6b4d 6574 6144  CollectTaskMetaD
-000421a0: 6174 6150 6c75 6769 6e28 7363 6865 6475  ataPlugin(schedu
-000421b0: 6c65 723d 7365 6c66 2c20 6e61 6d65 3d6e  ler=self, name=n
-000421c0: 616d 6529 0a20 2020 2020 2020 2073 656c  ame).        sel
-000421d0: 662e 6164 645f 706c 7567 696e 2870 6c75  f.add_plugin(plu
-000421e0: 6769 6e29 0a0a 2020 2020 6465 6620 7374  gin)..    def st
-000421f0: 6f70 5f74 6173 6b5f 6d65 7461 6461 7461  op_task_metadata
-00042200: 2873 656c 662c 206e 616d 653a 2073 7472  (self, name: str
-00042210: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2920   | None = None) 
-00042220: 2d3e 2064 6963 743a 0a20 2020 2020 2020  -> dict:.       
-00042230: 2070 6c75 6769 6e73 203d 205b 0a20 2020   plugins = [.   
-00042240: 2020 2020 2020 2020 2070 0a20 2020 2020           p.     
-00042250: 2020 2020 2020 2066 6f72 2070 2069 6e20         for p in 
-00042260: 6c69 7374 2873 656c 662e 706c 7567 696e  list(self.plugin
-00042270: 732e 7661 6c75 6573 2829 290a 2020 2020  s.values()).    
-00042280: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00042290: 7461 6e63 6528 702c 2043 6f6c 6c65 6374  tance(p, Collect
-000422a0: 5461 736b 4d65 7461 4461 7461 506c 7567  TaskMetaDataPlug
-000422b0: 696e 2920 616e 6420 702e 6e61 6d65 203d  in) and p.name =
-000422c0: 3d20 6e61 6d65 0a20 2020 2020 2020 205d  = name.        ]
-000422d0: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-000422e0: 706c 7567 696e 7329 2021 3d20 313a 0a20  plugins) != 1:. 
-000422f0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00042300: 2056 616c 7565 4572 726f 7228 0a20 2020   ValueError(.   
-00042310: 2020 2020 2020 2020 2020 2020 2022 4578               "Ex
-00042320: 7065 6374 6564 2074 6f20 6669 6e64 2065  pected to find e
-00042330: 7861 6374 6c79 206f 6e65 2043 6f6c 6c65  xactly one Colle
-00042340: 6374 5461 736b 4d65 7461 4461 7461 506c  ctTaskMetaDataPl
-00042350: 7567 696e 2022 0a20 2020 2020 2020 2020  ugin ".         
-00042360: 2020 2020 2020 2066 2277 6974 6820 6e61         f"with na
-00042370: 6d65 207b 6e61 6d65 7d20 6275 7420 666f  me {name} but fo
-00042380: 756e 6420 7b6c 656e 2870 6c75 6769 6e73  und {len(plugins
-00042390: 297d 2e22 0a20 2020 2020 2020 2020 2020  )}.".           
-000423a0: 2029 0a0a 2020 2020 2020 2020 706c 7567   )..        plug
-000423b0: 696e 203d 2070 6c75 6769 6e73 5b30 5d0a  in = plugins[0].
-000423c0: 2020 2020 2020 2020 7365 6c66 2e72 656d          self.rem
-000423d0: 6f76 655f 706c 7567 696e 286e 616d 653d  ove_plugin(name=
-000423e0: 706c 7567 696e 2e6e 616d 6529 0a20 2020  plugin.name).   
-000423f0: 2020 2020 2072 6574 7572 6e20 7b22 6d65       return {"me
-00042400: 7461 6461 7461 223a 2070 6c75 6769 6e2e  tadata": plugin.
-00042410: 6d65 7461 6461 7461 2c20 2273 7461 7465  metadata, "state
-00042420: 223a 2070 6c75 6769 6e2e 7374 6174 657d  ": plugin.state}
-00042430: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-00042440: 7265 6769 7374 6572 5f77 6f72 6b65 725f  register_worker_
-00042450: 706c 7567 696e 2873 656c 662c 2063 6f6d  plugin(self, com
-00042460: 6d2c 2070 6c75 6769 6e2c 206e 616d 653d  m, plugin, name=
-00042470: 4e6f 6e65 293a 0a20 2020 2020 2020 2022  None):.        "
-00042480: 2222 5265 6769 7374 6572 7320 6120 776f  ""Registers a wo
-00042490: 726b 6572 2070 6c75 6769 6e20 6f6e 2061  rker plugin on a
-000424a0: 6c6c 2072 756e 6e69 6e67 2061 6e64 2066  ll running and f
-000424b0: 7574 7572 6520 776f 726b 6572 7322 2222  uture workers"""
-000424c0: 0a20 2020 2020 2020 2073 656c 662e 776f  .        self.wo
-000424d0: 726b 6572 5f70 6c75 6769 6e73 5b6e 616d  rker_plugins[nam
-000424e0: 655d 203d 2070 6c75 6769 6e0a 0a20 2020  e] = plugin..   
-000424f0: 2020 2020 2072 6573 706f 6e73 6573 203d       responses =
-00042500: 2061 7761 6974 2073 656c 662e 6272 6f61   await self.broa
-00042510: 6463 6173 7428 0a20 2020 2020 2020 2020  dcast(.         
-00042520: 2020 206d 7367 3d64 6963 7428 6f70 3d22     msg=dict(op="
-00042530: 706c 7567 696e 2d61 6464 222c 2070 6c75  plugin-add", plu
-00042540: 6769 6e3d 706c 7567 696e 2c20 6e61 6d65  gin=plugin, name
-00042550: 3d6e 616d 6529 0a20 2020 2020 2020 2029  =name).        )
-00042560: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00042570: 7265 7370 6f6e 7365 730a 0a20 2020 2061  responses..    a
-00042580: 7379 6e63 2064 6566 2075 6e72 6567 6973  sync def unregis
-00042590: 7465 725f 776f 726b 6572 5f70 6c75 6769  ter_worker_plugi
-000425a0: 6e28 7365 6c66 2c20 636f 6d6d 2c20 6e61  n(self, comm, na
-000425b0: 6d65 293a 0a20 2020 2020 2020 2022 2222  me):.        """
-000425c0: 556e 7265 6769 7374 6572 7320 6120 776f  Unregisters a wo
-000425d0: 726b 6572 2070 6c75 6769 6e22 2222 0a20  rker plugin""". 
-000425e0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-000425f0: 2020 2020 2020 2020 7365 6c66 2e77 6f72          self.wor
-00042600: 6b65 725f 706c 7567 696e 732e 706f 7028  ker_plugins.pop(
-00042610: 6e61 6d65 290a 2020 2020 2020 2020 6578  name).        ex
-00042620: 6365 7074 204b 6579 4572 726f 723a 0a20  cept KeyError:. 
-00042630: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00042640: 2056 616c 7565 4572 726f 7228 6622 5468   ValueError(f"Th
-00042650: 6520 776f 726b 6572 2070 6c75 6769 6e20  e worker plugin 
-00042660: 7b6e 616d 657d 2064 6f65 7320 6e6f 7420  {name} does not 
-00042670: 6578 6973 7422 290a 0a20 2020 2020 2020  exist")..       
-00042680: 2072 6573 706f 6e73 6573 203d 2061 7761   responses = awa
-00042690: 6974 2073 656c 662e 6272 6f61 6463 6173  it self.broadcas
-000426a0: 7428 6d73 673d 6469 6374 286f 703d 2270  t(msg=dict(op="p
-000426b0: 6c75 6769 6e2d 7265 6d6f 7665 222c 206e  lugin-remove", n
-000426c0: 616d 653d 6e61 6d65 2929 0a20 2020 2020  ame=name)).     
-000426d0: 2020 2072 6574 7572 6e20 7265 7370 6f6e     return respon
-000426e0: 7365 730a 0a20 2020 2061 7379 6e63 2064  ses..    async d
-000426f0: 6566 2072 6567 6973 7465 725f 6e61 6e6e  ef register_nann
-00042700: 795f 706c 7567 696e 2873 656c 662c 2063  y_plugin(self, c
-00042710: 6f6d 6d2c 2070 6c75 6769 6e2c 206e 616d  omm, plugin, nam
-00042720: 653d 4e6f 6e65 293a 0a20 2020 2020 2020  e=None):.       
-00042730: 2022 2222 5265 6769 7374 6572 7320 6120   """Registers a 
-00042740: 7365 7475 7020 6675 6e63 7469 6f6e 2c20  setup function, 
-00042750: 616e 6420 6361 6c6c 2069 7420 6f6e 2065  and call it on e
-00042760: 7665 7279 2077 6f72 6b65 7222 2222 0a20  very worker""". 
-00042770: 2020 2020 2020 2073 656c 662e 6e61 6e6e         self.nann
-00042780: 795f 706c 7567 696e 735b 6e61 6d65 5d20  y_plugins[name] 
-00042790: 3d20 706c 7567 696e 0a0a 2020 2020 2020  = plugin..      
-000427a0: 2020 7265 7370 6f6e 7365 7320 3d20 6177    responses = aw
-000427b0: 6169 7420 7365 6c66 2e62 726f 6164 6361  ait self.broadca
-000427c0: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
-000427d0: 6d73 673d 6469 6374 286f 703d 2270 6c75  msg=dict(op="plu
-000427e0: 6769 6e5f 6164 6422 2c20 706c 7567 696e  gin_add", plugin
-000427f0: 3d70 6c75 6769 6e2c 206e 616d 653d 6e61  =plugin, name=na
-00042800: 6d65 292c 0a20 2020 2020 2020 2020 2020  me),.           
-00042810: 206e 616e 6e79 3d54 7275 652c 0a20 2020   nanny=True,.   
-00042820: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
-00042830: 6574 7572 6e20 7265 7370 6f6e 7365 730a  eturn responses.
-00042840: 0a20 2020 2061 7379 6e63 2064 6566 2075  .    async def u
-00042850: 6e72 6567 6973 7465 725f 6e61 6e6e 795f  nregister_nanny_
-00042860: 706c 7567 696e 2873 656c 662c 2063 6f6d  plugin(self, com
-00042870: 6d2c 206e 616d 6529 3a0a 2020 2020 2020  m, name):.      
-00042880: 2020 2222 2255 6e72 6567 6973 7465 7273    """Unregisters
-00042890: 2061 2077 6f72 6b65 7220 706c 7567 696e   a worker plugin
-000428a0: 2222 220a 2020 2020 2020 2020 7472 793a  """.        try:
-000428b0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000428c0: 662e 6e61 6e6e 795f 706c 7567 696e 732e  f.nanny_plugins.
-000428d0: 706f 7028 6e61 6d65 290a 2020 2020 2020  pop(name).      
-000428e0: 2020 6578 6365 7074 204b 6579 4572 726f    except KeyErro
-000428f0: 723a 0a20 2020 2020 2020 2020 2020 2072  r:.            r
-00042900: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00042910: 6622 5468 6520 6e61 6e6e 7920 706c 7567  f"The nanny plug
-00042920: 696e 207b 6e61 6d65 7d20 646f 6573 206e  in {name} does n
-00042930: 6f74 2065 7869 7374 2229 0a0a 2020 2020  ot exist")..    
-00042940: 2020 2020 7265 7370 6f6e 7365 7320 3d20      responses = 
-00042950: 6177 6169 7420 7365 6c66 2e62 726f 6164  await self.broad
-00042960: 6361 7374 280a 2020 2020 2020 2020 2020  cast(.          
-00042970: 2020 6d73 673d 6469 6374 286f 703d 2270    msg=dict(op="p
-00042980: 6c75 6769 6e5f 7265 6d6f 7665 222c 206e  lugin_remove", n
-00042990: 616d 653d 6e61 6d65 292c 206e 616e 6e79  ame=name), nanny
-000429a0: 3d54 7275 650a 2020 2020 2020 2020 290a  =True.        ).
-000429b0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-000429c0: 6573 706f 6e73 6573 0a0a 2020 2020 6465  esponses..    de
-000429d0: 6620 7472 616e 7369 7469 6f6e 280a 2020  f transition(.  
-000429e0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-000429f0: 2020 2020 6b65 793a 2073 7472 2c0a 2020      key: str,.  
-00042a00: 2020 2020 2020 6669 6e69 7368 3a20 5461        finish: Ta
-00042a10: 736b 5374 6174 6553 7461 7465 2c0a 2020  skStateState,.  
-00042a20: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
-00042a30: 643a 2073 7472 2c0a 2020 2020 2020 2020  d: str,.        
-00042a40: 2a2a 6b77 6172 6773 3a20 416e 792c 0a20  **kwargs: Any,. 
-00042a50: 2020 2029 202d 3e20 5265 6373 3a0a 2020     ) -> Recs:.  
-00042a60: 2020 2020 2020 2222 2254 7261 6e73 6974        """Transit
-00042a70: 696f 6e20 6120 6b65 7920 6672 6f6d 2069  ion a key from i
-00042a80: 7473 2063 7572 7265 6e74 2073 7461 7465  ts current state
-00042a90: 2074 6f20 7468 6520 6669 6e69 7368 2073   to the finish s
-00042aa0: 7461 7465 0a0a 2020 2020 2020 2020 4578  tate..        Ex
-00042ab0: 616d 706c 6573 0a20 2020 2020 2020 202d  amples.        -
-00042ac0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-00042ad0: 3e3e 3e20 7365 6c66 2e74 7261 6e73 6974  >>> self.transit
-00042ae0: 696f 6e28 2778 272c 2027 7761 6974 696e  ion('x', 'waitin
-00042af0: 6727 290a 2020 2020 2020 2020 7b27 7827  g').        {'x'
-00042b00: 3a20 2770 726f 6365 7373 696e 6727 7d0a  : 'processing'}.
-00042b10: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-00042b20: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-00042b30: 0a20 2020 2020 2020 2044 6963 7469 6f6e  .        Diction
-00042b40: 6172 7920 6f66 2072 6563 6f6d 6d65 6e64  ary of recommend
-00042b50: 6174 696f 6e73 2066 6f72 2066 7574 7572  ations for futur
-00042b60: 6520 7472 616e 7369 7469 6f6e 730a 0a20  e transitions.. 
-00042b70: 2020 2020 2020 2053 6565 2041 6c73 6f0a         See Also.
-00042b80: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
-00042b90: 0a20 2020 2020 2020 2053 6368 6564 756c  .        Schedul
-00042ba0: 6572 2e74 7261 6e73 6974 696f 6e73 3a20  er.transitions: 
-00042bb0: 7472 616e 7369 7469 7665 2076 6572 7369  transitive versi
-00042bc0: 6f6e 206f 6620 7468 6973 2066 756e 6374  on of this funct
-00042bd0: 696f 6e0a 2020 2020 2020 2020 2222 220a  ion.        """.
-00042be0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-00042bf0: 6461 7469 6f6e 732c 2063 6c69 656e 745f  dations, client_
-00042c00: 6d73 6773 2c20 776f 726b 6572 5f6d 7367  msgs, worker_msg
-00042c10: 7320 3d20 7365 6c66 2e5f 7472 616e 7369  s = self._transi
-00042c20: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
-00042c30: 2020 6b65 792c 2066 696e 6973 682c 2073    key, finish, s
-00042c40: 7469 6d75 6c75 735f 6964 2c20 2a2a 6b77  timulus_id, **kw
-00042c50: 6172 6773 0a20 2020 2020 2020 2029 0a20  args.        ). 
-00042c60: 2020 2020 2020 2073 656c 662e 7365 6e64         self.send
-00042c70: 5f61 6c6c 2863 6c69 656e 745f 6d73 6773  _all(client_msgs
-00042c80: 2c20 776f 726b 6572 5f6d 7367 7329 0a20  , worker_msgs). 
-00042c90: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-00042ca0: 636f 6d6d 656e 6461 7469 6f6e 730a 0a20  commendations.. 
-00042cb0: 2020 2064 6566 2074 7261 6e73 6974 696f     def transitio
-00042cc0: 6e73 2873 656c 662c 2072 6563 6f6d 6d65  ns(self, recomme
-00042cd0: 6e64 6174 696f 6e73 3a20 5265 6373 2c20  ndations: Recs, 
-00042ce0: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
-00042cf0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00042d00: 2020 2022 2222 5072 6f63 6573 7320 7472     """Process tr
-00042d10: 616e 7369 7469 6f6e 7320 756e 7469 6c20  ansitions until 
-00042d20: 6e6f 6e65 2061 7265 206c 6566 740a 0a20  none are left.. 
-00042d30: 2020 2020 2020 2054 6869 7320 696e 636c         This incl
-00042d40: 7564 6573 2066 6565 6462 6163 6b20 6672  udes feedback fr
-00042d50: 6f6d 2070 7265 7669 6f75 7320 7472 616e  om previous tran
-00042d60: 7369 7469 6f6e 7320 616e 6420 636f 6e74  sitions and cont
-00042d70: 696e 7565 7320 756e 7469 6c20 7765 0a20  inues until we. 
-00042d80: 2020 2020 2020 2072 6561 6368 2061 2073         reach a s
-00042d90: 7465 6164 7920 7374 6174 650a 2020 2020  teady state.    
-00042da0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00042db0: 636c 6965 6e74 5f6d 7367 733a 204d 7367  client_msgs: Msg
-00042dc0: 7320 3d20 7b7d 0a20 2020 2020 2020 2077  s = {}.        w
-00042dd0: 6f72 6b65 725f 6d73 6773 3a20 4d73 6773  orker_msgs: Msgs
-00042de0: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
-00042df0: 6c66 2e5f 7472 616e 7369 7469 6f6e 7328  lf._transitions(
-00042e00: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
-00042e10: 2063 6c69 656e 745f 6d73 6773 2c20 776f   client_msgs, wo
-00042e20: 726b 6572 5f6d 7367 732c 2073 7469 6d75  rker_msgs, stimu
-00042e30: 6c75 735f 6964 290a 2020 2020 2020 2020  lus_id).        
-00042e40: 7365 6c66 2e73 656e 645f 616c 6c28 636c  self.send_all(cl
-00042e50: 6965 6e74 5f6d 7367 732c 2077 6f72 6b65  ient_msgs, worke
-00042e60: 725f 6d73 6773 290a 0a20 2020 2061 7379  r_msgs)..    asy
-00042e70: 6e63 2064 6566 2067 6574 5f73 746f 7279  nc def get_story
-00042e80: 2873 656c 662c 206b 6579 735f 6f72 5f73  (self, keys_or_s
-00042e90: 7469 6d75 6c69 3a20 4974 6572 6162 6c65  timuli: Iterable
-00042ea0: 5b73 7472 5d29 202d 3e20 6c69 7374 5b54  [str]) -> list[T
-00042eb0: 7261 6e73 6974 696f 6e5d 3a0a 2020 2020  ransition]:.    
-00042ec0: 2020 2020 2222 2252 5043 2068 6f6f 6b20      """RPC hook 
-00042ed0: 666f 7220 3a6d 6574 683a 6053 6368 6564  for :meth:`Sched
-00042ee0: 756c 6572 5374 6174 652e 7374 6f72 7960  ulerState.story`
-00042ef0: 2e0a 0a20 2020 2020 2020 204e 6f74 6520  ...        Note 
-00042f00: 7468 6174 2074 6865 206d 7367 7061 636b  that the msgpack
-00042f10: 2073 6572 6961 6c69 7a61 7469 6f6e 2f64   serialization/d
-00042f20: 6573 6572 6961 6c69 7a61 7469 6f6e 2072  eserialization r
-00042f30: 6f75 6e64 2d74 7269 7020 7769 6c6c 2074  ound-trip will t
-00042f40: 7261 6e73 666f 726d 0a20 2020 2020 2020  ransform.       
-00042f50: 2074 6865 203a 636c 6173 733a 6054 7261   the :class:`Tra
-00042f60: 6e73 6974 696f 6e60 206e 616d 6564 7475  nsition` namedtu
-00042f70: 706c 6573 2069 6e74 6f20 7265 6775 6c61  ples into regula
-00042f80: 7220 7475 706c 6573 2e0a 2020 2020 2020  r tuples..      
-00042f90: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
-00042fa0: 7475 726e 2073 656c 662e 7374 6f72 7928  turn self.story(
-00042fb0: 2a6b 6579 735f 6f72 5f73 7469 6d75 6c69  *keys_or_stimuli
-00042fc0: 290a 0a20 2020 2064 6566 205f 7265 7363  )..    def _resc
-00042fd0: 6865 6475 6c65 280a 2020 2020 2020 2020  hedule(.        
-00042fe0: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
-00042ff0: 776f 726b 6572 3a20 7374 7220 7c20 4e6f  worker: str | No
-00043000: 6e65 203d 204e 6f6e 652c 202a 2c20 7374  ne = None, *, st
-00043010: 696d 756c 7573 5f69 643a 2073 7472 0a20  imulus_id: str. 
-00043020: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
-00043030: 2020 2020 2020 2222 2252 6573 6368 6564        """Resched
-00043040: 756c 6520 6120 7461 736b 2e0a 0a20 2020  ule a task...   
-00043050: 2020 2020 2054 6869 7320 6675 6e63 7469       This functi
-00043060: 6f6e 2073 686f 756c 6420 6f6e 6c79 2062  on should only b
-00043070: 6520 7573 6564 2077 6865 6e20 7468 6520  e used when the 
-00043080: 7461 736b 2068 6173 2061 6c72 6561 6479  task has already
-00043090: 2062 6565 6e20 7265 6c65 6173 6564 2069   been released i
-000430a0: 6e0a 2020 2020 2020 2020 736f 6d65 2077  n.        some w
-000430b0: 6179 206f 6e20 7468 6520 776f 726b 6572  ay on the worker
-000430c0: 2069 7427 7320 6173 7369 676e 6564 2074   it's assigned t
-000430d0: 6f20 e280 9420 6569 7468 6572 2076 6961  o ... either via
-000430e0: 2063 616e 6365 6c6c 6174 696f 6e20 6f72   cancellation or
-000430f0: 2061 0a20 2020 2020 2020 2052 6573 6368   a.        Resch
-00043100: 6564 756c 6520 6578 6365 7074 696f 6e20  edule exception 
-00043110: e280 9420 616e 6420 796f 7520 6172 6520  ... and you are 
-00043120: 6365 7274 6169 6e20 7468 6520 776f 726b  certain the work
-00043130: 6572 2077 696c 6c20 6e6f 7420 7365 6e64  er will not send
-00043140: 2061 6e79 2066 7572 7468 6572 0a20 2020   any further.   
-00043150: 2020 2020 2075 7064 6174 6573 2061 626f       updates abo
-00043160: 7574 2074 6865 2074 6173 6b20 746f 2074  ut the task to t
-00043170: 6865 2073 6368 6564 756c 6572 2e0a 2020  he scheduler..  
-00043180: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00043190: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-000431a0: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
-000431b0: 6b73 5b6b 6579 5d0a 2020 2020 2020 2020  ks[key].        
-000431c0: 6578 6365 7074 204b 6579 4572 726f 723a  except KeyError:
-000431d0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-000431e0: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
-000431f0: 2020 2020 2020 2020 2020 2020 2066 2241               f"A
-00043200: 7474 656d 7074 696e 6720 746f 2072 6573  ttempting to res
-00043210: 6368 6564 756c 6520 7461 736b 207b 6b65  chedule task {ke
-00043220: 797d 2c20 7768 6963 6820 7761 7320 6e6f  y}, which was no
-00043230: 7420 220a 2020 2020 2020 2020 2020 2020  t ".            
-00043240: 2020 2020 2266 6f75 6e64 206f 6e20 7468      "found on th
-00043250: 6520 7363 6865 6475 6c65 722e 2041 626f  e scheduler. Abo
-00043260: 7274 696e 6720 7265 7363 6865 6475 6c65  rting reschedule
-00043270: 2e22 0a20 2020 2020 2020 2020 2020 2029  .".            )
-00043280: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00043290: 7572 6e0a 2020 2020 2020 2020 6966 2074  urn.        if t
-000432a0: 732e 7374 6174 6520 213d 2022 7072 6f63  s.state != "proc
-000432b0: 6573 7369 6e67 223a 0a20 2020 2020 2020  essing":.       
-000432c0: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
-000432d0: 2020 2020 6966 2077 6f72 6b65 7220 616e      if worker an
-000432e0: 6420 7473 2e70 726f 6365 7373 696e 675f  d ts.processing_
-000432f0: 6f6e 2061 6e64 2074 732e 7072 6f63 6573  on and ts.proces
-00043300: 7369 6e67 5f6f 6e2e 6164 6472 6573 7320  sing_on.address 
-00043310: 213d 2077 6f72 6b65 723a 0a20 2020 2020  != worker:.     
-00043320: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
-00043330: 2020 2020 2020 2320 7472 616e 7369 7469        # transiti
-00043340: 6f6e 5f70 726f 6365 7373 696e 675f 7265  on_processing_re
-00043350: 6c65 6173 6564 2077 696c 6c20 696d 6d65  leased will imme
-00043360: 6469 6174 656c 7920 7375 6767 6573 7420  diately suggest 
-00043370: 616e 2061 6464 6974 696f 6e61 6c0a 2020  an additional.  
-00043380: 2020 2020 2020 2320 7472 616e 7369 7469        # transiti
-00043390: 6f6e 2074 6f20 7761 6974 696e 6720 6966  on to waiting if
-000433a0: 2074 6865 2074 6173 6b20 6861 7320 616e   the task has an
-000433b0: 7920 7761 6974 6572 7320 6f72 2063 6c69  y waiters or cli
-000433c0: 656e 7473 2068 6f6c 6469 6e67 2061 2066  ents holding a f
-000433d0: 7574 7572 652e 0a20 2020 2020 2020 2073  uture..        s
-000433e0: 656c 662e 7472 616e 7369 7469 6f6e 7328  elf.transitions(
-000433f0: 7b6b 6579 3a20 2272 656c 6561 7365 6422  {key: "released"
-00043400: 7d2c 2073 7469 6d75 6c75 735f 6964 3d73  }, stimulus_id=s
-00043410: 7469 6d75 6c75 735f 6964 290a 0a20 2020  timulus_id)..   
-00043420: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
-00043430: 2323 2323 2323 0a20 2020 2023 2055 7469  ######.    # Uti
-00043440: 6c69 7479 2066 756e 6374 696f 6e73 2023  lity functions #
-00043450: 0a20 2020 2023 2323 2323 2323 2323 2323  .    ###########
-00043460: 2323 2323 2323 2323 2323 0a0a 2020 2020  ##########..    
-00043470: 6465 6620 6164 645f 7265 736f 7572 6365  def add_resource
-00043480: 7328 0a20 2020 2020 2020 2073 656c 662c  s(.        self,
-00043490: 2077 6f72 6b65 723a 2073 7472 2c20 7265   worker: str, re
-000434a0: 736f 7572 6365 733a 2064 6963 7420 7c20  sources: dict | 
-000434b0: 4e6f 6e65 203d 204e 6f6e 650a 2020 2020  None = None.    
-000434c0: 2920 2d3e 204c 6974 6572 616c 5b22 4f4b  ) -> Literal["OK
-000434d0: 225d 3a0a 2020 2020 2020 2020 7773 3a20  "]:.        ws: 
-000434e0: 576f 726b 6572 5374 6174 6520 3d20 7365  WorkerState = se
-000434f0: 6c66 2e77 6f72 6b65 7273 5b77 6f72 6b65  lf.workers[worke
-00043500: 725d 0a20 2020 2020 2020 2069 6620 7265  r].        if re
-00043510: 736f 7572 6365 733a 0a20 2020 2020 2020  sources:.       
-00043520: 2020 2020 2077 732e 7265 736f 7572 6365       ws.resource
-00043530: 732e 7570 6461 7465 2872 6573 6f75 7263  s.update(resourc
-00043540: 6573 290a 2020 2020 2020 2020 7773 2e75  es).        ws.u
-00043550: 7365 645f 7265 736f 7572 6365 7320 3d20  sed_resources = 
-00043560: 7b7d 0a20 2020 2020 2020 2066 6f72 2072  {}.        for r
-00043570: 6573 6f75 7263 652c 2071 7561 6e74 6974  esource, quantit
-00043580: 7920 696e 2077 732e 7265 736f 7572 6365  y in ws.resource
-00043590: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
-000435a0: 2020 2020 2020 2077 732e 7573 6564 5f72         ws.used_r
-000435b0: 6573 6f75 7263 6573 5b72 6573 6f75 7263  esources[resourc
-000435c0: 655d 203d 2030 0a20 2020 2020 2020 2020  e] = 0.         
-000435d0: 2020 2064 7220 3d20 7365 6c66 2e72 6573     dr = self.res
-000435e0: 6f75 7263 6573 2e67 6574 2872 6573 6f75  ources.get(resou
-000435f0: 7263 652c 204e 6f6e 6529 0a20 2020 2020  rce, None).     
-00043600: 2020 2020 2020 2069 6620 6472 2069 7320         if dr is 
-00043610: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00043620: 2020 2020 2020 7365 6c66 2e72 6573 6f75        self.resou
-00043630: 7263 6573 5b72 6573 6f75 7263 655d 203d  rces[resource] =
-00043640: 2064 7220 3d20 7b7d 0a20 2020 2020 2020   dr = {}.       
-00043650: 2020 2020 2064 725b 776f 726b 6572 5d20       dr[worker] 
-00043660: 3d20 7175 616e 7469 7479 0a20 2020 2020  = quantity.     
-00043670: 2020 2072 6574 7572 6e20 224f 4b22 0a0a     return "OK"..
-00043680: 2020 2020 6465 6620 7265 6d6f 7665 5f72      def remove_r
-00043690: 6573 6f75 7263 6573 2873 656c 662c 2077  esources(self, w
-000436a0: 6f72 6b65 723a 2073 7472 2920 2d3e 204e  orker: str) -> N
-000436b0: 6f6e 653a 0a20 2020 2020 2020 2077 733a  one:.        ws:
-000436c0: 2057 6f72 6b65 7253 7461 7465 203d 2073   WorkerState = s
-000436d0: 656c 662e 776f 726b 6572 735b 776f 726b  elf.workers[work
-000436e0: 6572 5d0a 2020 2020 2020 2020 666f 7220  er].        for 
-000436f0: 7265 736f 7572 6365 2069 6e20 7773 2e72  resource in ws.r
-00043700: 6573 6f75 7263 6573 3a0a 2020 2020 2020  esources:.      
-00043710: 2020 2020 2020 6472 203d 2073 656c 662e        dr = self.
-00043720: 7265 736f 7572 6365 732e 7365 7464 6566  resources.setdef
-00043730: 6175 6c74 2872 6573 6f75 7263 652c 207b  ault(resource, {
-00043740: 7d29 0a20 2020 2020 2020 2020 2020 2064  }).            d
-00043750: 656c 2064 725b 776f 726b 6572 5d0a 0a20  el dr[worker].. 
-00043760: 2020 2064 6566 2063 6f65 7263 655f 6164     def coerce_ad
-00043770: 6472 6573 7328 7365 6c66 2c20 6164 6472  dress(self, addr
-00043780: 3a20 7374 7220 7c20 7475 706c 652c 2072  : str | tuple, r
-00043790: 6573 6f6c 7665 3a20 626f 6f6c 203d 2054  esolve: bool = T
-000437a0: 7275 6529 202d 3e20 7374 723a 0a20 2020  rue) -> str:.   
-000437b0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-000437c0: 2043 6f65 7263 6520 706f 7373 6962 6c65   Coerce possible
-000437d0: 2069 6e70 7574 2061 6464 7265 7373 6573   input addresses
-000437e0: 2074 6f20 6361 6e6f 6e69 6361 6c20 666f   to canonical fo
-000437f0: 726d 2e0a 2020 2020 2020 2020 2a72 6573  rm..        *res
-00043800: 6f6c 7665 2a20 6361 6e20 6265 2064 6973  olve* can be dis
-00043810: 6162 6c65 6420 666f 7220 7465 7374 696e  abled for testin
-00043820: 6720 7769 7468 2066 616b 6520 686f 7374  g with fake host
-00043830: 6e61 6d65 732e 0a0a 2020 2020 2020 2020  names...        
-00043840: 4861 6e64 6c65 7320 7374 7269 6e67 732c  Handles strings,
-00043850: 2074 7570 6c65 732c 206f 7220 616c 6961   tuples, or alia
-00043860: 7365 732e 0a20 2020 2020 2020 2022 2222  ses..        """
-00043870: 0a20 2020 2020 2020 2023 2058 5858 2068  .        # XXX h
-00043880: 6f77 206d 616e 7920 6164 6472 6573 732d  ow many address-
-00043890: 7061 7273 696e 6720 726f 7574 696e 6573  parsing routines
-000438a0: 2064 6f20 7765 2068 6176 653f 0a20 2020   do we have?.   
-000438b0: 2020 2020 2069 6620 6164 6472 2069 6e20       if addr in 
-000438c0: 7365 6c66 2e61 6c69 6173 6573 3a0a 2020  self.aliases:.  
-000438d0: 2020 2020 2020 2020 2020 6164 6472 203d            addr =
-000438e0: 2073 656c 662e 616c 6961 7365 735b 6164   self.aliases[ad
-000438f0: 6472 5d0a 2020 2020 2020 2020 6966 2069  dr].        if i
-00043900: 7369 6e73 7461 6e63 6528 6164 6472 2c20  sinstance(addr, 
-00043910: 7475 706c 6529 3a0a 2020 2020 2020 2020  tuple):.        
-00043920: 2020 2020 6164 6472 203d 2075 6e70 6172      addr = unpar
-00043930: 7365 5f68 6f73 745f 706f 7274 282a 6164  se_host_port(*ad
-00043940: 6472 290a 2020 2020 2020 2020 6966 206e  dr).        if n
-00043950: 6f74 2069 7369 6e73 7461 6e63 6528 6164  ot isinstance(ad
-00043960: 6472 2c20 7374 7229 3a0a 2020 2020 2020  dr, str):.      
-00043970: 2020 2020 2020 7261 6973 6520 5479 7065        raise Type
-00043980: 4572 726f 7228 6622 6164 6472 6573 7365  Error(f"addresse
-00043990: 7320 7368 6f75 6c64 2062 6520 7374 7269  s should be stri
-000439a0: 6e67 7320 6f72 2074 7570 6c65 732c 2067  ngs or tuples, g
-000439b0: 6f74 207b 6164 6472 2172 7d22 290a 0a20  ot {addr!r}").. 
-000439c0: 2020 2020 2020 2069 6620 7265 736f 6c76         if resolv
-000439d0: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
-000439e0: 6464 7220 3d20 7265 736f 6c76 655f 6164  ddr = resolve_ad
-000439f0: 6472 6573 7328 6164 6472 290a 2020 2020  dress(addr).    
-00043a00: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00043a10: 2020 2020 2020 6164 6472 203d 206e 6f72        addr = nor
-00043a20: 6d61 6c69 7a65 5f61 6464 7265 7373 2861  malize_address(a
-00043a30: 6464 7229 0a0a 2020 2020 2020 2020 7265  ddr)..        re
-00043a40: 7475 726e 2061 6464 720a 0a20 2020 2064  turn addr..    d
-00043a50: 6566 2077 6f72 6b65 7273 5f6c 6973 7428  ef workers_list(
-00043a60: 7365 6c66 2c20 776f 726b 6572 733a 2049  self, workers: I
-00043a70: 7465 7261 626c 655b 7374 725d 207c 204e  terable[str] | N
-00043a80: 6f6e 6529 202d 3e20 6c69 7374 5b73 7472  one) -> list[str
-00043a90: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
-00043aa0: 2020 2020 2020 204c 6973 7420 6f66 2071         List of q
-00043ab0: 7561 6c69 6679 696e 6720 776f 726b 6572  ualifying worker
-00043ac0: 730a 0a20 2020 2020 2020 2054 616b 6573  s..        Takes
-00043ad0: 2061 206c 6973 7420 6f66 2077 6f72 6b65   a list of worke
-00043ae0: 7220 6164 6472 6573 7365 7320 6f72 2068  r addresses or h
-00043af0: 6f73 746e 616d 6573 2e0a 2020 2020 2020  ostnames..      
-00043b00: 2020 5265 7475 726e 7320 6120 6c69 7374    Returns a list
-00043b10: 206f 6620 616c 6c20 776f 726b 6572 2061   of all worker a
-00043b20: 6464 7265 7373 6573 2074 6861 7420 6d61  ddresses that ma
-00043b30: 7463 680a 2020 2020 2020 2020 2222 220a  tch.        """.
-00043b40: 2020 2020 2020 2020 6966 2077 6f72 6b65          if worke
-00043b50: 7273 2069 7320 4e6f 6e65 3a0a 2020 2020  rs is None:.    
-00043b60: 2020 2020 2020 2020 7265 7475 726e 206c          return l
-00043b70: 6973 7428 7365 6c66 2e77 6f72 6b65 7273  ist(self.workers
-00043b80: 290a 0a20 2020 2020 2020 206f 7574 203d  )..        out =
-00043b90: 2073 6574 2829 0a20 2020 2020 2020 2066   set().        f
-00043ba0: 6f72 2077 2069 6e20 776f 726b 6572 733a  or w in workers:
-00043bb0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00043bc0: 223a 2220 696e 2077 3a0a 2020 2020 2020  ":" in w:.      
-00043bd0: 2020 2020 2020 2020 2020 6f75 742e 6164            out.ad
-00043be0: 6428 7729 0a20 2020 2020 2020 2020 2020  d(w).           
-00043bf0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00043c00: 2020 2020 2020 206f 7574 2e75 7064 6174         out.updat
-00043c10: 6528 7b77 7720 666f 7220 7777 2069 6e20  e({ww for ww in 
-00043c20: 7365 6c66 2e77 6f72 6b65 7273 2069 6620  self.workers if 
-00043c30: 7720 696e 2077 777d 2920 2023 2054 4f44  w in ww})  # TOD
-00043c40: 4f3a 2071 7561 6472 6174 6963 0a20 2020  O: quadratic.   
-00043c50: 2020 2020 2072 6574 7572 6e20 6c69 7374       return list
-00043c60: 286f 7574 290a 0a20 2020 2061 7379 6e63  (out)..    async
-00043c70: 2064 6566 2067 6574 5f70 726f 6669 6c65   def get_profile
-00043c80: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-00043c90: 2020 2020 2020 2020 636f 6d6d 3d4e 6f6e          comm=Non
-00043ca0: 652c 0a20 2020 2020 2020 2077 6f72 6b65  e,.        worke
-00043cb0: 7273 3d4e 6f6e 652c 0a20 2020 2020 2020  rs=None,.       
-00043cc0: 2073 6368 6564 756c 6572 3d46 616c 7365   scheduler=False
-00043cd0: 2c0a 2020 2020 2020 2020 7365 7276 6572  ,.        server
-00043ce0: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-00043cf0: 6d65 7267 655f 776f 726b 6572 733d 5472  merge_workers=Tr
-00043d00: 7565 2c0a 2020 2020 2020 2020 7374 6172  ue,.        star
-00043d10: 743d 4e6f 6e65 2c0a 2020 2020 2020 2020  t=None,.        
-00043d20: 7374 6f70 3d4e 6f6e 652c 0a20 2020 2020  stop=None,.     
-00043d30: 2020 206b 6579 3d4e 6f6e 652c 0a20 2020     key=None,.   
-00043d40: 2029 3a0a 2020 2020 2020 2020 6966 2077   ):.        if w
-00043d50: 6f72 6b65 7273 2069 7320 4e6f 6e65 3a0a  orkers is None:.
-00043d60: 2020 2020 2020 2020 2020 2020 776f 726b              work
-00043d70: 6572 7320 3d20 7365 6c66 2e77 6f72 6b65  ers = self.worke
-00043d80: 7273 0a20 2020 2020 2020 2065 6c73 653a  rs.        else:
-00043d90: 0a20 2020 2020 2020 2020 2020 2077 6f72  .            wor
-00043da0: 6b65 7273 203d 2073 6574 2873 656c 662e  kers = set(self.
-00043db0: 776f 726b 6572 7329 2026 2073 6574 2877  workers) & set(w
-00043dc0: 6f72 6b65 7273 290a 0a20 2020 2020 2020  orkers)..       
-00043dd0: 2069 6620 7363 6865 6475 6c65 723a 0a20   if scheduler:. 
-00043de0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00043df0: 6e20 7072 6f66 696c 652e 6765 745f 7072  n profile.get_pr
-00043e00: 6f66 696c 6528 7365 6c66 2e69 6f5f 6c6f  ofile(self.io_lo
-00043e10: 6f70 2e70 726f 6669 6c65 2c20 7374 6172  op.profile, star
-00043e20: 743d 7374 6172 742c 2073 746f 703d 7374  t=start, stop=st
-00043e30: 6f70 290a 0a20 2020 2020 2020 2072 6573  op)..        res
-00043e40: 756c 7473 203d 2061 7761 6974 2061 7379  ults = await asy
-00043e50: 6e63 696f 2e67 6174 6865 7228 0a20 2020  ncio.gather(.   
-00043e60: 2020 2020 2020 2020 202a 280a 2020 2020           *(.    
-00043e70: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00043e80: 2e72 7063 2877 292e 7072 6f66 696c 6528  .rpc(w).profile(
-00043e90: 7374 6172 743d 7374 6172 742c 2073 746f  start=start, sto
-00043ea0: 703d 7374 6f70 2c20 6b65 793d 6b65 792c  p=stop, key=key,
-00043eb0: 2073 6572 7665 723d 7365 7276 6572 290a   server=server).
-00043ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043ed0: 666f 7220 7720 696e 2077 6f72 6b65 7273  for w in workers
-00043ee0: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
-00043ef0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00043f00: 726e 5f65 7863 6570 7469 6f6e 733d 5472  rn_exceptions=Tr
-00043f10: 7565 2c0a 2020 2020 2020 2020 290a 0a20  ue,.        ).. 
-00043f20: 2020 2020 2020 2072 6573 756c 7473 203d         results =
-00043f30: 205b 7220 666f 7220 7220 696e 2072 6573   [r for r in res
-00043f40: 756c 7473 2069 6620 6e6f 7420 6973 696e  ults if not isin
-00043f50: 7374 616e 6365 2872 2c20 4578 6365 7074  stance(r, Except
-00043f60: 696f 6e29 5d0a 0a20 2020 2020 2020 2069  ion)]..        i
-00043f70: 6620 6d65 7267 655f 776f 726b 6572 733a  f merge_workers:
-00043f80: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-00043f90: 706f 6e73 6520 3d20 7072 6f66 696c 652e  ponse = profile.
-00043fa0: 6d65 7267 6528 2a72 6573 756c 7473 290a  merge(*results).
-00043fb0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00043fc0: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
-00043fd0: 7365 203d 2064 6963 7428 7a69 7028 776f  se = dict(zip(wo
-00043fe0: 726b 6572 732c 2072 6573 756c 7473 2929  rkers, results))
-00043ff0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00044000: 7265 7370 6f6e 7365 0a0a 2020 2020 6173  response..    as
-00044010: 796e 6320 6465 6620 6765 745f 7072 6f66  ync def get_prof
-00044020: 696c 655f 6d65 7461 6461 7461 280a 2020  ile_metadata(.  
-00044030: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-00044040: 2020 2020 776f 726b 6572 733a 2022 4974      workers: "It
-00044050: 6572 6162 6c65 5b73 7472 5d20 7c20 4e6f  erable[str] | No
-00044060: 6e65 2220 3d20 4e6f 6e65 2c0a 2020 2020  ne" = None,.    
-00044070: 2020 2020 7374 6172 743a 2066 6c6f 6174      start: float
-00044080: 203d 2030 2c0a 2020 2020 2020 2020 7374   = 0,.        st
-00044090: 6f70 3a20 2266 6c6f 6174 207c 204e 6f6e  op: "float | Non
-000440a0: 6522 203d 204e 6f6e 652c 0a20 2020 2020  e" = None,.     
-000440b0: 2020 2070 726f 6669 6c65 5f63 7963 6c65     profile_cycle
-000440c0: 5f69 6e74 6572 7661 6c3a 2022 7374 7220  _interval: "str 
-000440d0: 7c20 666c 6f61 7420 7c20 4e6f 6e65 2220  | float | None" 
-000440e0: 3d20 4e6f 6e65 2c0a 2020 2020 2920 2d3e  = None,.    ) ->
-000440f0: 2064 6963 743a 0a20 2020 2020 2020 2064   dict:.        d
-00044100: 7420 3d20 7072 6f66 696c 655f 6379 636c  t = profile_cycl
-00044110: 655f 696e 7465 7276 616c 206f 7220 6461  e_interval or da
-00044120: 736b 2e63 6f6e 6669 672e 6765 7428 0a20  sk.config.get(. 
-00044130: 2020 2020 2020 2020 2020 2022 6469 7374             "dist
-00044140: 7269 6275 7465 642e 776f 726b 6572 2e70  ributed.worker.p
-00044150: 726f 6669 6c65 2e63 7963 6c65 220a 2020  rofile.cycle".  
-00044160: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00044170: 6474 203d 2070 6172 7365 5f74 696d 6564  dt = parse_timed
-00044180: 656c 7461 2864 742c 2064 6566 6175 6c74  elta(dt, default
-00044190: 3d22 6d73 2229 0a0a 2020 2020 2020 2020  ="ms")..        
-000441a0: 6966 2077 6f72 6b65 7273 2069 7320 4e6f  if workers is No
-000441b0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-000441c0: 776f 726b 6572 7320 3d20 7365 6c66 2e77  workers = self.w
-000441d0: 6f72 6b65 7273 0a20 2020 2020 2020 2065  orkers.        e
-000441e0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000441f0: 2077 6f72 6b65 7273 203d 2073 6574 2873   workers = set(s
-00044200: 656c 662e 776f 726b 6572 7329 2026 2073  elf.workers) & s
-00044210: 6574 2877 6f72 6b65 7273 290a 2020 2020  et(workers).    
-00044220: 2020 2020 7265 7375 6c74 7320 3d20 6177      results = aw
-00044230: 6169 7420 6173 796e 6369 6f2e 6761 7468  ait asyncio.gath
-00044240: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
-00044250: 2a28 7365 6c66 2e72 7063 2877 292e 7072  *(self.rpc(w).pr
-00044260: 6f66 696c 655f 6d65 7461 6461 7461 2873  ofile_metadata(s
-00044270: 7461 7274 3d73 7461 7274 2c20 7374 6f70  tart=start, stop
-00044280: 3d73 746f 7029 2066 6f72 2077 2069 6e20  =stop) for w in 
-00044290: 776f 726b 6572 7329 2c0a 2020 2020 2020  workers),.      
-000442a0: 2020 2020 2020 7265 7475 726e 5f65 7863        return_exc
-000442b0: 6570 7469 6f6e 733d 5472 7565 2c0a 2020  eptions=True,.  
-000442c0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-000442d0: 2072 6573 756c 7473 203d 205b 7220 666f   results = [r fo
-000442e0: 7220 7220 696e 2072 6573 756c 7473 2069  r r in results i
-000442f0: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
-00044300: 2872 2c20 4578 6365 7074 696f 6e29 5d0a  (r, Exception)].
-00044310: 2020 2020 2020 2020 636f 756e 7473 203d          counts =
-00044320: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
-00044330: 7469 6d65 2c20 7375 6d28 706c 7563 6b28  time, sum(pluck(
-00044340: 312c 2067 726f 7570 2929 290a 2020 2020  1, group))).    
-00044350: 2020 2020 2020 2020 666f 7220 7469 6d65          for time
-00044360: 2c20 6772 6f75 7020 696e 2069 7465 7274  , group in itert
-00044370: 6f6f 6c73 2e67 726f 7570 6279 280a 2020  ools.groupby(.  
-00044380: 2020 2020 2020 2020 2020 2020 2020 6d65                me
-00044390: 7267 655f 736f 7274 6564 280a 2020 2020  rge_sorted(.    
-000443a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000443b0: 2a28 765b 2263 6f75 6e74 7322 5d20 666f  *(v["counts"] fo
-000443c0: 7220 7620 696e 2072 6573 756c 7473 292c  r v in results),
-000443d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000443e0: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
-000443f0: 2020 2020 6c61 6d62 6461 2074 3a20 745b      lambda t: t[
-00044400: 305d 202f 2f20 6474 202a 2064 742c 0a20  0] // dt * dt,. 
-00044410: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00044420: 2020 2020 205d 0a0a 2020 2020 2020 2020       ]..        
-00044430: 6b65 7973 3a20 6469 6374 5b73 7472 2c20  keys: dict[str, 
-00044440: 6c69 7374 5b6c 6973 745d 5d20 3d20 7b0a  list[list]] = {.
-00044450: 2020 2020 2020 2020 2020 2020 6b3a 205b              k: [
-00044460: 5d20 666f 7220 7620 696e 2072 6573 756c  ] for v in resul
-00044470: 7473 2066 6f72 2074 2c20 6420 696e 2076  ts for t, d in v
-00044480: 5b22 6b65 7973 225d 2066 6f72 206b 2069  ["keys"] for k i
-00044490: 6e20 640a 2020 2020 2020 2020 7d0a 0a20  n d.        }.. 
-000444a0: 2020 2020 2020 2067 726f 7570 7331 203d         groups1 =
-000444b0: 205b 765b 226b 6579 7322 5d20 666f 7220   [v["keys"] for 
-000444c0: 7620 696e 2072 6573 756c 7473 5d0a 2020  v in results].  
-000444d0: 2020 2020 2020 6772 6f75 7073 3220 3d20        groups2 = 
-000444e0: 6c69 7374 286d 6572 6765 5f73 6f72 7465  list(merge_sorte
-000444f0: 6428 2a67 726f 7570 7331 2c20 6b65 793d  d(*groups1, key=
-00044500: 6669 7273 7429 290a 0a20 2020 2020 2020  first))..       
-00044510: 206c 6173 7420 3d20 300a 2020 2020 2020   last = 0.      
-00044520: 2020 666f 7220 742c 2064 2069 6e20 6772    for t, d in gr
-00044530: 6f75 7073 323a 0a20 2020 2020 2020 2020  oups2:.         
-00044540: 2020 2074 7420 3d20 7420 2f2f 2064 7420     tt = t // dt 
-00044550: 2a20 6474 0a20 2020 2020 2020 2020 2020  * dt.           
-00044560: 2069 6620 7474 203e 206c 6173 743a 0a20   if tt > last:. 
-00044570: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00044580: 6173 7420 3d20 7474 0a20 2020 2020 2020  ast = tt.       
-00044590: 2020 2020 2020 2020 2066 6f72 2076 2069           for v i
-000445a0: 6e20 6b65 7973 2e76 616c 7565 7328 293a  n keys.values():
-000445b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000445c0: 2020 2020 2076 2e61 7070 656e 6428 5b74       v.append([t
-000445d0: 742c 2030 5d29 0a20 2020 2020 2020 2020  t, 0]).         
-000445e0: 2020 2066 6f72 206b 2c20 7620 696e 2064     for k, v in d
-000445f0: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-00044600: 2020 2020 2020 2020 2020 6b65 7973 5b6b            keys[k
-00044610: 5d5b 2d31 5d5b 315d 202b 3d20 760a 0a20  ][-1][1] += v.. 
-00044620: 2020 2020 2020 2072 6574 7572 6e20 7b22         return {"
-00044630: 636f 756e 7473 223a 2063 6f75 6e74 732c  counts": counts,
-00044640: 2022 6b65 7973 223a 206b 6579 737d 0a0a   "keys": keys}..
-00044650: 2020 2020 6173 796e 6320 6465 6620 7065      async def pe
-00044660: 7266 6f72 6d61 6e63 655f 7265 706f 7274  rformance_report
-00044670: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
-00044680: 7374 6172 743a 2066 6c6f 6174 2c20 6c61  start: float, la
-00044690: 7374 5f63 6f75 6e74 3a20 696e 742c 2063  st_count: int, c
-000446a0: 6f64 653a 2073 7472 203d 2022 222c 206d  ode: str = "", m
-000446b0: 6f64 653a 2073 7472 207c 204e 6f6e 6520  ode: str | None 
-000446c0: 3d20 4e6f 6e65 0a20 2020 2029 202d 3e20  = None.    ) -> 
-000446d0: 7374 723a 0a20 2020 2020 2020 2073 746f  str:.        sto
-000446e0: 7020 3d20 7469 6d65 2829 0a20 2020 2020  p = time().     
-000446f0: 2020 2023 2050 726f 6669 6c65 730a 2020     # Profiles.  
-00044700: 2020 2020 2020 636f 6d70 7574 652c 2073        compute, s
-00044710: 6368 6564 756c 6572 2c20 776f 726b 6572  cheduler, worker
-00044720: 7320 3d20 6177 6169 7420 6173 796e 6369  s = await asynci
-00044730: 6f2e 6761 7468 6572 280a 2020 2020 2020  o.gather(.      
-00044740: 2020 2020 2020 2a5b 0a20 2020 2020 2020        *[.       
-00044750: 2020 2020 2020 2020 2073 656c 662e 6765           self.ge
-00044760: 745f 7072 6f66 696c 6528 7374 6172 743d  t_profile(start=
-00044770: 7374 6172 7429 2c0a 2020 2020 2020 2020  start),.        
-00044780: 2020 2020 2020 2020 7365 6c66 2e67 6574          self.get
-00044790: 5f70 726f 6669 6c65 2873 6368 6564 756c  _profile(schedul
-000447a0: 6572 3d54 7275 652c 2073 7461 7274 3d73  er=True, start=s
-000447b0: 7461 7274 292c 0a20 2020 2020 2020 2020  tart),.         
-000447c0: 2020 2020 2020 2073 656c 662e 6765 745f         self.get_
-000447d0: 7072 6f66 696c 6528 7365 7276 6572 3d54  profile(server=T
-000447e0: 7275 652c 2073 7461 7274 3d73 7461 7274  rue, start=start
-000447f0: 292c 0a20 2020 2020 2020 2020 2020 205d  ),.            ]
-00044800: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00044810: 2020 2066 726f 6d20 6469 7374 7269 6275     from distribu
-00044820: 7465 6420 696d 706f 7274 2070 726f 6669  ted import profi
-00044830: 6c65 0a0a 2020 2020 2020 2020 6465 6620  le..        def 
-00044840: 7072 6f66 696c 655f 746f 5f66 6967 7572  profile_to_figur
-00044850: 6528 7374 6174 6529 3a0a 2020 2020 2020  e(state):.      
-00044860: 2020 2020 2020 6461 7461 203d 2070 726f        data = pro
-00044870: 6669 6c65 2e70 6c6f 745f 6461 7461 2873  file.plot_data(s
-00044880: 7461 7465 290a 2020 2020 2020 2020 2020  tate).          
-00044890: 2020 6669 6775 7265 2c20 736f 7572 6365    figure, source
-000448a0: 203d 2070 726f 6669 6c65 2e70 6c6f 745f   = profile.plot_
-000448b0: 6669 6775 7265 2864 6174 612c 2073 697a  figure(data, siz
-000448c0: 696e 675f 6d6f 6465 3d22 7374 7265 7463  ing_mode="stretc
-000448d0: 685f 626f 7468 2229 0a20 2020 2020 2020  h_both").       
-000448e0: 2020 2020 2072 6574 7572 6e20 6669 6775       return figu
-000448f0: 7265 0a0a 2020 2020 2020 2020 636f 6d70  re..        comp
-00044900: 7574 652c 2073 6368 6564 756c 6572 2c20  ute, scheduler, 
-00044910: 776f 726b 6572 7320 3d20 6d61 7028 0a20  workers = map(. 
-00044920: 2020 2020 2020 2020 2020 2070 726f 6669             profi
-00044930: 6c65 5f74 6f5f 6669 6775 7265 2c20 2863  le_to_figure, (c
-00044940: 6f6d 7075 7465 2c20 7363 6865 6475 6c65  ompute, schedule
-00044950: 722c 2077 6f72 6b65 7273 290a 2020 2020  r, workers).    
-00044960: 2020 2020 290a 0a20 2020 2020 2020 2023      )..        #
-00044970: 2054 6173 6b20 7374 7265 616d 0a20 2020   Task stream.   
-00044980: 2020 2020 2074 6173 6b5f 7374 7265 616d       task_stream
-00044990: 203d 2073 656c 662e 6765 745f 7461 736b   = self.get_task
-000449a0: 5f73 7472 6561 6d28 7374 6172 743d 7374  _stream(start=st
-000449b0: 6172 7429 0a20 2020 2020 2020 2074 6f74  art).        tot
-000449c0: 616c 5f74 6173 6b73 203d 206c 656e 2874  al_tasks = len(t
-000449d0: 6173 6b5f 7374 7265 616d 290a 2020 2020  ask_stream).    
-000449e0: 2020 2020 7469 6d65 7370 656e 743a 2064      timespent: d
-000449f0: 6566 6175 6c74 6469 6374 5b73 7472 2c20  efaultdict[str, 
-00044a00: 666c 6f61 745d 203d 2064 6566 6175 6c74  float] = default
-00044a10: 6469 6374 2866 6c6f 6174 290a 2020 2020  dict(float).    
-00044a20: 2020 2020 666f 7220 6420 696e 2074 6173      for d in tas
-00044a30: 6b5f 7374 7265 616d 3a0a 2020 2020 2020  k_stream:.      
-00044a40: 2020 2020 2020 666f 7220 7820 696e 2064        for x in d
-00044a50: 5b22 7374 6172 7473 746f 7073 225d 3a0a  ["startstops"]:.
-00044a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044a70: 7469 6d65 7370 656e 745b 785b 2261 6374  timespent[x["act
-00044a80: 696f 6e22 5d5d 202b 3d20 785b 2273 746f  ion"]] += x["sto
-00044a90: 7022 5d20 2d20 785b 2273 7461 7274 225d  p"] - x["start"]
-00044aa0: 0a20 2020 2020 2020 2074 6173 6b73 5f74  .        tasks_t
-00044ab0: 696d 696e 6773 203d 2022 220a 2020 2020  imings = "".    
-00044ac0: 2020 2020 666f 7220 6b20 696e 2073 6f72      for k in sor
-00044ad0: 7465 6428 7469 6d65 7370 656e 742e 6b65  ted(timespent.ke
-00044ae0: 7973 2829 293a 0a20 2020 2020 2020 2020  ys()):.         
-00044af0: 2020 2074 6173 6b73 5f74 696d 696e 6773     tasks_timings
-00044b00: 202b 3d20 6622 5c6e 3c6c 693e 207b 6b7d   += f"\n<li> {k}
-00044b10: 2074 696d 653a 207b 666f 726d 6174 5f74   time: {format_t
-00044b20: 696d 6528 7469 6d65 7370 656e 745b 6b5d  ime(timespent[k]
-00044b30: 297d 203c 2f6c 693e 220a 0a20 2020 2020  )} </li>"..     
-00044b40: 2020 2066 726f 6d20 6469 7374 7269 6275     from distribu
-00044b50: 7465 642e 6461 7368 626f 6172 642e 636f  ted.dashboard.co
-00044b60: 6d70 6f6e 656e 7473 2e73 6368 6564 756c  mponents.schedul
-00044b70: 6572 2069 6d70 6f72 7420 7461 736b 5f73  er import task_s
-00044b80: 7472 6561 6d5f 6669 6775 7265 0a20 2020  tream_figure.   
-00044b90: 2020 2020 2066 726f 6d20 6469 7374 7269       from distri
-00044ba0: 6275 7465 642e 6469 6167 6e6f 7374 6963  buted.diagnostic
-00044bb0: 732e 7461 736b 5f73 7472 6561 6d20 696d  s.task_stream im
-00044bc0: 706f 7274 2072 6563 7461 6e67 6c65 730a  port rectangles.
-00044bd0: 0a20 2020 2020 2020 2072 6563 7473 203d  .        rects =
-00044be0: 2072 6563 7461 6e67 6c65 7328 7461 736b   rectangles(task
-00044bf0: 5f73 7472 6561 6d29 0a20 2020 2020 2020  _stream).       
-00044c00: 2073 6f75 7263 652c 2074 6173 6b5f 7374   source, task_st
-00044c10: 7265 616d 203d 2074 6173 6b5f 7374 7265  ream = task_stre
-00044c20: 616d 5f66 6967 7572 6528 7369 7a69 6e67  am_figure(sizing
-00044c30: 5f6d 6f64 653d 2273 7472 6574 6368 5f62  _mode="stretch_b
-00044c40: 6f74 6822 290a 2020 2020 2020 2020 736f  oth").        so
-00044c50: 7572 6365 2e64 6174 612e 7570 6461 7465  urce.data.update
-00044c60: 2872 6563 7473 290a 0a20 2020 2020 2020  (rects)..       
-00044c70: 2023 2042 616e 6477 6964 7468 0a20 2020   # Bandwidth.   
-00044c80: 2020 2020 2066 726f 6d20 6469 7374 7269       from distri
-00044c90: 6275 7465 642e 6461 7368 626f 6172 642e  buted.dashboard.
-00044ca0: 636f 6d70 6f6e 656e 7473 2e73 6368 6564  components.sched
-00044cb0: 756c 6572 2069 6d70 6f72 7420 280a 2020  uler import (.  
-00044cc0: 2020 2020 2020 2020 2020 4261 6e64 7769            Bandwi
-00044cd0: 6474 6854 7970 6573 2c0a 2020 2020 2020  dthTypes,.      
-00044ce0: 2020 2020 2020 4261 6e64 7769 6474 6857        BandwidthW
-00044cf0: 6f72 6b65 7273 2c0a 2020 2020 2020 2020  orkers,.        
-00044d00: 290a 0a20 2020 2020 2020 2062 616e 6477  )..        bandw
-00044d10: 6964 7468 5f77 6f72 6b65 7273 203d 2042  idth_workers = B
-00044d20: 616e 6477 6964 7468 576f 726b 6572 7328  andwidthWorkers(
-00044d30: 7365 6c66 2c20 7369 7a69 6e67 5f6d 6f64  self, sizing_mod
-00044d40: 653d 2273 7472 6574 6368 5f62 6f74 6822  e="stretch_both"
-00044d50: 290a 2020 2020 2020 2020 6261 6e64 7769  ).        bandwi
-00044d60: 6474 685f 776f 726b 6572 732e 7570 6461  dth_workers.upda
-00044d70: 7465 2829 0a20 2020 2020 2020 2062 616e  te().        ban
-00044d80: 6477 6964 7468 5f74 7970 6573 203d 2042  dwidth_types = B
-00044d90: 616e 6477 6964 7468 5479 7065 7328 7365  andwidthTypes(se
-00044da0: 6c66 2c20 7369 7a69 6e67 5f6d 6f64 653d  lf, sizing_mode=
-00044db0: 2273 7472 6574 6368 5f62 6f74 6822 290a  "stretch_both").
-00044dc0: 2020 2020 2020 2020 6261 6e64 7769 6474          bandwidt
-00044dd0: 685f 7479 7065 732e 7570 6461 7465 2829  h_types.update()
-00044de0: 0a0a 2020 2020 2020 2020 2320 5379 7374  ..        # Syst
-00044df0: 656d 206d 6f6e 6974 6f72 0a20 2020 2020  em monitor.     
-00044e00: 2020 2066 726f 6d20 6469 7374 7269 6275     from distribu
-00044e10: 7465 642e 6461 7368 626f 6172 642e 636f  ted.dashboard.co
-00044e20: 6d70 6f6e 656e 7473 2e73 6861 7265 6420  mponents.shared 
-00044e30: 696d 706f 7274 2053 7973 7465 6d4d 6f6e  import SystemMon
-00044e40: 6974 6f72 0a0a 2020 2020 2020 2020 7379  itor..        sy
-00044e50: 736d 6f6e 203d 2053 7973 7465 6d4d 6f6e  smon = SystemMon
-00044e60: 6974 6f72 2873 656c 662c 206c 6173 745f  itor(self, last_
-00044e70: 636f 756e 743d 6c61 7374 5f63 6f75 6e74  count=last_count
-00044e80: 2c20 7369 7a69 6e67 5f6d 6f64 653d 2273  , sizing_mode="s
-00044e90: 7472 6574 6368 5f62 6f74 6822 290a 2020  tretch_both").  
-00044ea0: 2020 2020 2020 7379 736d 6f6e 2e75 7064        sysmon.upd
-00044eb0: 6174 6528 290a 0a20 2020 2020 2020 2023  ate()..        #
-00044ec0: 2053 6368 6564 756c 6572 206c 6f67 730a   Scheduler logs.
-00044ed0: 2020 2020 2020 2020 6672 6f6d 2064 6973          from dis
-00044ee0: 7472 6962 7574 6564 2e64 6173 6862 6f61  tributed.dashboa
-00044ef0: 7264 2e63 6f6d 706f 6e65 6e74 732e 7363  rd.components.sc
-00044f00: 6865 6475 6c65 7220 696d 706f 7274 2028  heduler import (
-00044f10: 0a20 2020 2020 2020 2020 2020 205f 424f  .            _BO
-00044f20: 4b45 485f 5354 594c 4553 5f4b 5741 5247  KEH_STYLES_KWARG
-00044f30: 532c 0a20 2020 2020 2020 2020 2020 2053  S,.            S
-00044f40: 6368 6564 756c 6572 4c6f 6773 2c0a 2020  chedulerLogs,.  
-00044f50: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00044f60: 206c 6f67 7320 3d20 5363 6865 6475 6c65   logs = Schedule
-00044f70: 724c 6f67 7328 7365 6c66 2c20 7374 6172  rLogs(self, star
-00044f80: 743d 7374 6172 7429 0a0a 2020 2020 2020  t=start)..      
-00044f90: 2020 6672 6f6d 2062 6f6b 6568 2e6d 6f64    from bokeh.mod
-00044fa0: 656c 7320 696d 706f 7274 2044 6976 2c20  els import Div, 
-00044fb0: 5461 6273 0a0a 2020 2020 2020 2020 696d  Tabs..        im
-00044fc0: 706f 7274 2064 6973 7472 6962 7574 6564  port distributed
-00044fd0: 0a20 2020 2020 2020 2066 726f 6d20 6469  .        from di
-00044fe0: 7374 7269 6275 7465 642e 6461 7368 626f  stributed.dashbo
-00044ff0: 6172 642e 636f 7265 2069 6d70 6f72 7420  ard.core import 
-00045000: 5461 6250 616e 656c 0a0a 2020 2020 2020  TabPanel..      
-00045010: 2020 2320 4854 4d4c 0a20 2020 2020 2020    # HTML.       
-00045020: 2068 746d 6c20 3d20 2222 220a 2020 2020   html = """.    
-00045030: 2020 2020 3c68 313e 2044 6173 6b20 5065      <h1> Dask Pe
-00045040: 7266 6f72 6d61 6e63 6520 5265 706f 7274  rformance Report
-00045050: 203c 2f68 313e 0a0a 2020 2020 2020 2020   </h1>..        
-00045060: 3c69 3e20 5365 6c65 6374 2064 6966 6665  <i> Select diffe
-00045070: 7265 6e74 2074 6162 7320 6f6e 2074 6865  rent tabs on the
-00045080: 2074 6f70 2066 6f72 2061 6464 6974 696f   top for additio
-00045090: 6e61 6c20 696e 666f 726d 6174 696f 6e20  nal information 
-000450a0: 3c2f 693e 0a0a 2020 2020 2020 2020 3c68  </i>..        <h
-000450b0: 323e 2044 7572 6174 696f 6e3a 207b 7469  2> Duration: {ti
-000450c0: 6d65 7d20 3c2f 6832 3e0a 2020 2020 2020  me} </h2>.      
-000450d0: 2020 3c68 323e 2054 6173 6b73 2049 6e66    <h2> Tasks Inf
-000450e0: 6f72 6d61 7469 6f6e 203c 2f68 323e 0a20  ormation </h2>. 
-000450f0: 2020 2020 2020 203c 756c 3e0a 2020 2020         <ul>.    
-00045100: 2020 2020 203c 6c69 3e20 6e75 6d62 6572       <li> number
-00045110: 206f 6620 7461 736b 733a 207b 6e74 6173   of tasks: {ntas
-00045120: 6b73 7d20 3c2f 6c69 3e0a 2020 2020 2020  ks} </li>.      
-00045130: 2020 207b 7461 736b 735f 7469 6d69 6e67     {tasks_timing
-00045140: 737d 0a20 2020 2020 2020 203c 2f75 6c3e  s}.        </ul>
-00045150: 0a0a 2020 2020 2020 2020 3c68 323e 2053  ..        <h2> S
-00045160: 6368 6564 756c 6572 2049 6e66 6f72 6d61  cheduler Informa
-00045170: 7469 6f6e 203c 2f68 323e 0a20 2020 2020  tion </h2>.     
-00045180: 2020 203c 756c 3e0a 2020 2020 2020 2020     <ul>.        
-00045190: 2020 3c6c 693e 2041 6464 7265 7373 3a20    <li> Address: 
-000451a0: 7b61 6464 7265 7373 7d20 3c2f 6c69 3e0a  {address} </li>.
-000451b0: 2020 2020 2020 2020 2020 3c6c 693e 2057            <li> W
-000451c0: 6f72 6b65 7273 3a20 7b6e 776f 726b 6572  orkers: {nworker
-000451d0: 737d 203c 2f6c 693e 0a20 2020 2020 2020  s} </li>.       
-000451e0: 2020 203c 6c69 3e20 5468 7265 6164 733a     <li> Threads:
-000451f0: 207b 7468 7265 6164 737d 203c 2f6c 693e   {threads} </li>
-00045200: 0a20 2020 2020 2020 2020 203c 6c69 3e20  .          <li> 
-00045210: 4d65 6d6f 7279 3a20 7b6d 656d 6f72 797d  Memory: {memory}
-00045220: 203c 2f6c 693e 0a20 2020 2020 2020 2020   </li>.         
-00045230: 203c 6c69 3e20 4461 736b 2056 6572 7369   <li> Dask Versi
-00045240: 6f6e 3a20 7b64 6173 6b5f 7665 7273 696f  on: {dask_versio
-00045250: 6e7d 203c 2f6c 693e 0a20 2020 2020 2020  n} </li>.       
-00045260: 2020 203c 6c69 3e20 4461 736b 2e44 6973     <li> Dask.Dis
-00045270: 7472 6962 7574 6564 2056 6572 7369 6f6e  tributed Version
-00045280: 3a20 7b64 6973 7472 6962 7574 6564 5f76  : {distributed_v
-00045290: 6572 7369 6f6e 7d20 3c2f 6c69 3e0a 2020  ersion} </li>.  
-000452a0: 2020 2020 2020 3c2f 756c 3e0a 0a20 2020        </ul>..   
-000452b0: 2020 2020 203c 6832 3e20 4361 6c6c 696e       <h2> Callin
-000452c0: 6720 436f 6465 203c 2f68 323e 0a20 2020  g Code </h2>.   
-000452d0: 2020 2020 203c 7072 653e 0a7b 636f 6465       <pre>.{code
-000452e0: 7d0a 2020 2020 2020 2020 3c2f 7072 653e  }.        </pre>
-000452f0: 0a20 2020 2020 2020 2022 2222 2e66 6f72  .        """.for
-00045300: 6d61 7428 0a20 2020 2020 2020 2020 2020  mat(.           
-00045310: 2074 696d 653d 666f 726d 6174 5f74 696d   time=format_tim
-00045320: 6528 7374 6f70 202d 2073 7461 7274 292c  e(stop - start),
-00045330: 0a20 2020 2020 2020 2020 2020 206e 7461  .            nta
-00045340: 736b 733d 746f 7461 6c5f 7461 736b 732c  sks=total_tasks,
-00045350: 0a20 2020 2020 2020 2020 2020 2074 6173  .            tas
-00045360: 6b73 5f74 696d 696e 6773 3d74 6173 6b73  ks_timings=tasks
-00045370: 5f74 696d 696e 6773 2c0a 2020 2020 2020  _timings,.      
-00045380: 2020 2020 2020 6164 6472 6573 733d 7365        address=se
-00045390: 6c66 2e61 6464 7265 7373 2c0a 2020 2020  lf.address,.    
-000453a0: 2020 2020 2020 2020 6e77 6f72 6b65 7273          nworkers
-000453b0: 3d6c 656e 2873 656c 662e 776f 726b 6572  =len(self.worker
-000453c0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-000453d0: 7468 7265 6164 733d 7375 6d28 7773 2e6e  threads=sum(ws.n
-000453e0: 7468 7265 6164 7320 666f 7220 7773 2069  threads for ws i
-000453f0: 6e20 7365 6c66 2e77 6f72 6b65 7273 2e76  n self.workers.v
-00045400: 616c 7565 7328 2929 2c0a 2020 2020 2020  alues()),.      
-00045410: 2020 2020 2020 6d65 6d6f 7279 3d66 6f72        memory=for
-00045420: 6d61 745f 6279 7465 7328 7375 6d28 7773  mat_bytes(sum(ws
-00045430: 2e6d 656d 6f72 795f 6c69 6d69 7420 666f  .memory_limit fo
-00045440: 7220 7773 2069 6e20 7365 6c66 2e77 6f72  r ws in self.wor
-00045450: 6b65 7273 2e76 616c 7565 7328 2929 292c  kers.values())),
-00045460: 0a20 2020 2020 2020 2020 2020 2063 6f64  .            cod
-00045470: 653d 636f 6465 2c0a 2020 2020 2020 2020  e=code,.        
-00045480: 2020 2020 6461 736b 5f76 6572 7369 6f6e      dask_version
-00045490: 3d64 6173 6b2e 5f5f 7665 7273 696f 6e5f  =dask.__version_
-000454a0: 5f2c 0a20 2020 2020 2020 2020 2020 2064  _,.            d
-000454b0: 6973 7472 6962 7574 6564 5f76 6572 7369  istributed_versi
-000454c0: 6f6e 3d64 6973 7472 6962 7574 6564 2e5f  on=distributed._
-000454d0: 5f76 6572 7369 6f6e 5f5f 2c0a 2020 2020  _version__,.    
-000454e0: 2020 2020 290a 2020 2020 2020 2020 6874      ).        ht
-000454f0: 6d6c 203d 2044 6976 2874 6578 743d 6874  ml = Div(text=ht
-00045500: 6d6c 2c20 2a2a 5f42 4f4b 4548 5f53 5459  ml, **_BOKEH_STY
-00045510: 4c45 535f 4b57 4152 4753 290a 0a20 2020  LES_KWARGS)..   
-00045520: 2020 2020 2068 746d 6c20 3d20 5461 6250       html = TabP
-00045530: 616e 656c 2863 6869 6c64 3d68 746d 6c2c  anel(child=html,
-00045540: 2074 6974 6c65 3d22 5375 6d6d 6172 7922   title="Summary"
-00045550: 290a 2020 2020 2020 2020 636f 6d70 7574  ).        comput
-00045560: 6520 3d20 5461 6250 616e 656c 2863 6869  e = TabPanel(chi
-00045570: 6c64 3d63 6f6d 7075 7465 2c20 7469 746c  ld=compute, titl
-00045580: 653d 2257 6f72 6b65 7220 5072 6f66 696c  e="Worker Profil
-00045590: 6520 2863 6f6d 7075 7465 2922 290a 2020  e (compute)").  
-000455a0: 2020 2020 2020 776f 726b 6572 7320 3d20        workers = 
-000455b0: 5461 6250 616e 656c 2863 6869 6c64 3d77  TabPanel(child=w
-000455c0: 6f72 6b65 7273 2c20 7469 746c 653d 2257  orkers, title="W
-000455d0: 6f72 6b65 7220 5072 6f66 696c 6520 2861  orker Profile (a
-000455e0: 646d 696e 6973 7472 6174 6976 6529 2229  dministrative)")
-000455f0: 0a20 2020 2020 2020 2073 6368 6564 756c  .        schedul
-00045600: 6572 203d 2054 6162 5061 6e65 6c28 0a20  er = TabPanel(. 
-00045610: 2020 2020 2020 2020 2020 2063 6869 6c64             child
-00045620: 3d73 6368 6564 756c 6572 2c20 7469 746c  =scheduler, titl
-00045630: 653d 2253 6368 6564 756c 6572 2050 726f  e="Scheduler Pro
-00045640: 6669 6c65 2028 6164 6d69 6e69 7374 7261  file (administra
-00045650: 7469 7665 2922 0a20 2020 2020 2020 2029  tive)".        )
-00045660: 0a20 2020 2020 2020 2074 6173 6b5f 7374  .        task_st
-00045670: 7265 616d 203d 2054 6162 5061 6e65 6c28  ream = TabPanel(
-00045680: 6368 696c 643d 7461 736b 5f73 7472 6561  child=task_strea
-00045690: 6d2c 2074 6974 6c65 3d22 5461 736b 2053  m, title="Task S
-000456a0: 7472 6561 6d22 290a 2020 2020 2020 2020  tream").        
-000456b0: 6261 6e64 7769 6474 685f 776f 726b 6572  bandwidth_worker
-000456c0: 7320 3d20 5461 6250 616e 656c 280a 2020  s = TabPanel(.  
-000456d0: 2020 2020 2020 2020 2020 6368 696c 643d            child=
-000456e0: 6261 6e64 7769 6474 685f 776f 726b 6572  bandwidth_worker
-000456f0: 732e 726f 6f74 2c20 7469 746c 653d 2242  s.root, title="B
-00045700: 616e 6477 6964 7468 2028 576f 726b 6572  andwidth (Worker
-00045710: 7329 220a 2020 2020 2020 2020 290a 2020  s)".        ).  
-00045720: 2020 2020 2020 6261 6e64 7769 6474 685f        bandwidth_
-00045730: 7479 7065 7320 3d20 5461 6250 616e 656c  types = TabPanel
-00045740: 280a 2020 2020 2020 2020 2020 2020 6368  (.            ch
-00045750: 696c 643d 6261 6e64 7769 6474 685f 7479  ild=bandwidth_ty
-00045760: 7065 732e 726f 6f74 2c20 7469 746c 653d  pes.root, title=
-00045770: 2242 616e 6477 6964 7468 2028 5479 7065  "Bandwidth (Type
-00045780: 7329 220a 2020 2020 2020 2020 290a 2020  s)".        ).  
-00045790: 2020 2020 2020 7379 7374 656d 203d 2054        system = T
-000457a0: 6162 5061 6e65 6c28 6368 696c 643d 7379  abPanel(child=sy
-000457b0: 736d 6f6e 2e72 6f6f 742c 2074 6974 6c65  smon.root, title
-000457c0: 3d22 5379 7374 656d 2229 0a20 2020 2020  ="System").     
-000457d0: 2020 206c 6f67 7320 3d20 5461 6250 616e     logs = TabPan
-000457e0: 656c 2863 6869 6c64 3d6c 6f67 732e 726f  el(child=logs.ro
-000457f0: 6f74 2c20 7469 746c 653d 2253 6368 6564  ot, title="Sched
-00045800: 756c 6572 204c 6f67 7322 290a 0a20 2020  uler Logs")..   
-00045810: 2020 2020 2074 6162 7320 3d20 5461 6273       tabs = Tabs
-00045820: 280a 2020 2020 2020 2020 2020 2020 7461  (.            ta
-00045830: 6273 3d5b 0a20 2020 2020 2020 2020 2020  bs=[.           
-00045840: 2020 2020 2068 746d 6c2c 0a20 2020 2020       html,.     
-00045850: 2020 2020 2020 2020 2020 2074 6173 6b5f             task_
-00045860: 7374 7265 616d 2c0a 2020 2020 2020 2020  stream,.        
-00045870: 2020 2020 2020 2020 7379 7374 656d 2c0a          system,.
-00045880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045890: 6c6f 6773 2c0a 2020 2020 2020 2020 2020  logs,.          
-000458a0: 2020 2020 2020 636f 6d70 7574 652c 0a20        compute,. 
-000458b0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-000458c0: 6f72 6b65 7273 2c0a 2020 2020 2020 2020  orkers,.        
-000458d0: 2020 2020 2020 2020 7363 6865 6475 6c65          schedule
-000458e0: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-000458f0: 2020 2062 616e 6477 6964 7468 5f77 6f72     bandwidth_wor
-00045900: 6b65 7273 2c0a 2020 2020 2020 2020 2020  kers,.          
-00045910: 2020 2020 2020 6261 6e64 7769 6474 685f        bandwidth_
-00045920: 7479 7065 732c 0a20 2020 2020 2020 2020  types,.         
-00045930: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
-00045940: 2020 7369 7a69 6e67 5f6d 6f64 653d 2273    sizing_mode="s
-00045950: 7472 6574 6368 5f62 6f74 6822 2c0a 2020  tretch_both",.  
-00045960: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00045970: 2066 726f 6d20 626f 6b65 682e 636f 7265   from bokeh.core
-00045980: 2e74 656d 706c 6174 6573 2069 6d70 6f72  .templates impor
-00045990: 7420 6765 745f 656e 760a 2020 2020 2020  t get_env.      
-000459a0: 2020 6672 6f6d 2062 6f6b 6568 2e70 6c6f    from bokeh.plo
-000459b0: 7474 696e 6720 696d 706f 7274 206f 7574  tting import out
-000459c0: 7075 745f 6669 6c65 2c20 7361 7665 0a0a  put_file, save..
-000459d0: 2020 2020 2020 2020 7769 7468 2074 6d70          with tmp
-000459e0: 6669 6c65 2865 7874 656e 7369 6f6e 3d22  file(extension="
-000459f0: 2e68 746d 6c22 2920 6173 2066 6e3a 0a20  .html") as fn:. 
-00045a00: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
-00045a10: 745f 6669 6c65 2866 696c 656e 616d 653d  t_file(filename=
-00045a20: 666e 2c20 7469 746c 653d 2244 6173 6b20  fn, title="Dask 
-00045a30: 5065 7266 6f72 6d61 6e63 6520 5265 706f  Performance Repo
-00045a40: 7274 222c 206d 6f64 653d 6d6f 6465 290a  rt", mode=mode).
-00045a50: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
-00045a60: 6c61 7465 5f64 6972 6563 746f 7279 203d  late_directory =
-00045a70: 206f 732e 7061 7468 2e6a 6f69 6e28 0a20   os.path.join(. 
-00045a80: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00045a90: 732e 7061 7468 2e64 6972 6e61 6d65 286f  s.path.dirname(o
-00045aa0: 732e 7061 7468 2e61 6273 7061 7468 285f  s.path.abspath(_
-00045ab0: 5f66 696c 655f 5f29 292c 2022 6461 7368  _file__)), "dash
-00045ac0: 626f 6172 6422 2c20 2274 656d 706c 6174  board", "templat
-00045ad0: 6573 220a 2020 2020 2020 2020 2020 2020  es".            
-00045ae0: 290a 2020 2020 2020 2020 2020 2020 7465  ).            te
-00045af0: 6d70 6c61 7465 5f65 6e76 6972 6f6e 6d65  mplate_environme
-00045b00: 6e74 203d 2067 6574 5f65 6e76 2829 0a20  nt = get_env(). 
-00045b10: 2020 2020 2020 2020 2020 2074 656d 706c             templ
-00045b20: 6174 655f 656e 7669 726f 6e6d 656e 742e  ate_environment.
-00045b30: 6c6f 6164 6572 2e73 6561 7263 6870 6174  loader.searchpat
-00045b40: 682e 6170 7065 6e64 2874 656d 706c 6174  h.append(templat
-00045b50: 655f 6469 7265 6374 6f72 7929 0a20 2020  e_directory).   
-00045b60: 2020 2020 2020 2020 2074 656d 706c 6174           templat
-00045b70: 6520 3d20 7465 6d70 6c61 7465 5f65 6e76  e = template_env
-00045b80: 6972 6f6e 6d65 6e74 2e67 6574 5f74 656d  ironment.get_tem
-00045b90: 706c 6174 6528 2270 6572 666f 726d 616e  plate("performan
-00045ba0: 6365 5f72 6570 6f72 742e 6874 6d6c 2229  ce_report.html")
-00045bb0: 0a20 2020 2020 2020 2020 2020 2073 6176  .            sav
-00045bc0: 6528 7461 6273 2c20 6669 6c65 6e61 6d65  e(tabs, filename
-00045bd0: 3d66 6e2c 2074 656d 706c 6174 653d 7465  =fn, template=te
-00045be0: 6d70 6c61 7465 290a 0a20 2020 2020 2020  mplate)..       
-00045bf0: 2020 2020 2077 6974 6820 6f70 656e 2866       with open(f
-00045c00: 6e29 2061 7320 663a 0a20 2020 2020 2020  n) as f:.       
-00045c10: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
-00045c20: 662e 7265 6164 2829 0a0a 2020 2020 2020  f.read()..      
-00045c30: 2020 7265 7475 726e 2064 6174 610a 0a20    return data.. 
-00045c40: 2020 2061 7379 6e63 2064 6566 2067 6574     async def get
-00045c50: 5f77 6f72 6b65 725f 6c6f 6773 2873 656c  _worker_logs(sel
-00045c60: 662c 206e 3d4e 6f6e 652c 2077 6f72 6b65  f, n=None, worke
-00045c70: 7273 3d4e 6f6e 652c 206e 616e 6e79 3d46  rs=None, nanny=F
-00045c80: 616c 7365 293a 0a20 2020 2020 2020 2072  alse):.        r
-00045c90: 6573 756c 7473 203d 2061 7761 6974 2073  esults = await s
-00045ca0: 656c 662e 6272 6f61 6463 6173 7428 0a20  elf.broadcast(. 
-00045cb0: 2020 2020 2020 2020 2020 206d 7367 3d7b             msg={
-00045cc0: 226f 7022 3a20 2267 6574 5f6c 6f67 7322  "op": "get_logs"
-00045cd0: 2c20 226e 223a 206e 7d2c 2077 6f72 6b65  , "n": n}, worke
-00045ce0: 7273 3d77 6f72 6b65 7273 2c20 6e61 6e6e  rs=workers, nann
-00045cf0: 793d 6e61 6e6e 790a 2020 2020 2020 2020  y=nanny.        
-00045d00: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00045d10: 2072 6573 756c 7473 0a0a 2020 2020 6465   results..    de
-00045d20: 6620 6c6f 675f 6576 656e 7428 7365 6c66  f log_event(self
-00045d30: 2c20 746f 7069 633a 2073 7472 207c 2043  , topic: str | C
-00045d40: 6f6c 6c65 6374 696f 6e5b 7374 725d 2c20  ollection[str], 
-00045d50: 6d73 673a 2041 6e79 2920 2d3e 204e 6f6e  msg: Any) -> Non
-00045d60: 653a 0a20 2020 2020 2020 2022 2222 4c6f  e:.        """Lo
-00045d70: 6720 616e 2065 7665 6e74 2075 6e64 6572  g an event under
-00045d80: 2061 2067 6976 656e 2074 6f70 6963 0a0a   a given topic..
-00045d90: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
-00045da0: 7273 0a20 2020 2020 2020 202d 2d2d 2d2d  rs.        -----
-00045db0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 746f  -----.        to
-00045dc0: 7069 6320 3a20 7374 722c 206c 6973 745b  pic : str, list[
-00045dd0: 7374 725d 0a20 2020 2020 2020 2020 2020  str].           
-00045de0: 204e 616d 6520 6f66 2074 6865 2074 6f70   Name of the top
-00045df0: 6963 2075 6e64 6572 2077 6869 6368 2074  ic under which t
-00045e00: 6f20 6c6f 6720 616e 2065 7665 6e74 2e20  o log an event. 
-00045e10: 546f 206c 6f67 2074 6865 2073 616d 650a  To log the same.
-00045e20: 2020 2020 2020 2020 2020 2020 6576 656e              even
-00045e30: 7420 756e 6465 7220 6d75 6c74 6970 6c65  t under multiple
-00045e40: 2074 6f70 6963 732c 2070 6173 7320 6120   topics, pass a 
-00045e50: 6c69 7374 206f 6620 746f 7069 6320 6e61  list of topic na
-00045e60: 6d65 732e 0a20 2020 2020 2020 206d 7367  mes..        msg
-00045e70: 0a20 2020 2020 2020 2020 2020 2045 7665  .            Eve
-00045e80: 6e74 206d 6573 7361 6765 2074 6f20 6c6f  nt message to lo
-00045e90: 672e 204e 6f74 6520 7468 6973 206d 7573  g. Note this mus
-00045ea0: 7420 6265 206d 7367 7061 636b 2073 6572  t be msgpack ser
-00045eb0: 6961 6c69 7a61 626c 652e 0a0a 2020 2020  ializable...    
-00045ec0: 2020 2020 5365 6520 616c 736f 0a20 2020      See also.   
-00045ed0: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 2020       --------.  
-00045ee0: 2020 2020 2020 436c 6965 6e74 2e6c 6f67        Client.log
-00045ef0: 5f65 7665 6e74 0a20 2020 2020 2020 2022  _event.        "
-00045f00: 2222 0a20 2020 2020 2020 2065 7665 6e74  "".        event
-00045f10: 203d 2028 7469 6d65 2829 2c20 6d73 6729   = (time(), msg)
-00045f20: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00045f30: 6973 696e 7374 616e 6365 2874 6f70 6963  isinstance(topic
-00045f40: 2c20 7374 7229 3a0a 2020 2020 2020 2020  , str):.        
-00045f50: 2020 2020 666f 7220 7420 696e 2074 6f70      for t in top
-00045f60: 6963 3a0a 2020 2020 2020 2020 2020 2020  ic:.            
-00045f70: 2020 2020 7365 6c66 2e65 7665 6e74 735b      self.events[
-00045f80: 745d 2e61 7070 656e 6428 6576 656e 7429  t].append(event)
-00045f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00045fa0: 2073 656c 662e 6576 656e 745f 636f 756e   self.event_coun
-00045fb0: 7473 5b74 5d20 2b3d 2031 0a20 2020 2020  ts[t] += 1.     
-00045fc0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00045fd0: 5f72 6570 6f72 745f 6576 656e 7428 742c  _report_event(t,
-00045fe0: 2065 7665 6e74 290a 2020 2020 2020 2020   event).        
-00045ff0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00046000: 2020 7365 6c66 2e65 7665 6e74 735b 746f    self.events[to
-00046010: 7069 635d 2e61 7070 656e 6428 6576 656e  pic].append(even
-00046020: 7429 0a20 2020 2020 2020 2020 2020 2073  t).            s
-00046030: 656c 662e 6576 656e 745f 636f 756e 7473  elf.event_counts
-00046040: 5b74 6f70 6963 5d20 2b3d 2031 0a20 2020  [topic] += 1.   
-00046050: 2020 2020 2020 2020 2073 656c 662e 5f72           self._r
-00046060: 6570 6f72 745f 6576 656e 7428 746f 7069  eport_event(topi
-00046070: 632c 2065 7665 6e74 290a 0a20 2020 2020  c, event)..     
-00046080: 2020 2020 2020 2066 6f72 2070 6c75 6769         for plugi
-00046090: 6e20 696e 206c 6973 7428 7365 6c66 2e70  n in list(self.p
-000460a0: 6c75 6769 6e73 2e76 616c 7565 7328 2929  lugins.values())
-000460b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000460c0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-000460d0: 2020 2020 2020 2020 2020 2070 6c75 6769             plugi
-000460e0: 6e2e 6c6f 675f 6576 656e 7428 746f 7069  n.log_event(topi
-000460f0: 632c 206d 7367 290a 2020 2020 2020 2020  c, msg).        
-00046100: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-00046110: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
-00046120: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00046130: 6767 6572 2e69 6e66 6f28 2250 6c75 6769  gger.info("Plugi
-00046140: 6e20 6661 696c 6564 2077 6974 6820 6578  n failed with ex
-00046150: 6365 7074 696f 6e22 2c20 6578 635f 696e  ception", exc_in
-00046160: 666f 3d54 7275 6529 0a0a 2020 2020 6465  fo=True)..    de
-00046170: 6620 5f72 6570 6f72 745f 6576 656e 7428  f _report_event(
-00046180: 7365 6c66 2c20 6e61 6d65 2c20 6576 656e  self, name, even
-00046190: 7429 3a0a 2020 2020 2020 2020 6d73 6720  t):.        msg 
-000461a0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-000461b0: 226f 7022 3a20 2265 7665 6e74 222c 0a20  "op": "event",. 
-000461c0: 2020 2020 2020 2020 2020 2022 746f 7069             "topi
-000461d0: 6322 3a20 6e61 6d65 2c0a 2020 2020 2020  c": name,.      
-000461e0: 2020 2020 2020 2265 7665 6e74 223a 2065        "event": e
-000461f0: 7665 6e74 2c0a 2020 2020 2020 2020 7d0a  vent,.        }.
-00046200: 2020 2020 2020 2020 636c 6965 6e74 5f6d          client_m
-00046210: 7367 7320 3d20 7b63 6c69 656e 743a 205b  sgs = {client: [
-00046220: 6d73 675d 2066 6f72 2063 6c69 656e 7420  msg] for client 
-00046230: 696e 2073 656c 662e 6576 656e 745f 7375  in self.event_su
-00046240: 6273 6372 6962 6572 5b6e 616d 655d 7d0a  bscriber[name]}.
-00046250: 2020 2020 2020 2020 7365 6c66 2e73 656e          self.sen
-00046260: 645f 616c 6c28 636c 6965 6e74 5f6d 7367  d_all(client_msg
-00046270: 732c 2077 6f72 6b65 725f 6d73 6773 3d7b  s, worker_msgs={
-00046280: 7d29 0a0a 2020 2020 6465 6620 7375 6273  })..    def subs
-00046290: 6372 6962 655f 746f 7069 6328 7365 6c66  cribe_topic(self
-000462a0: 2c20 746f 7069 632c 2063 6c69 656e 7429  , topic, client)
-000462b0: 3a0a 2020 2020 2020 2020 7365 6c66 2e65  :.        self.e
-000462c0: 7665 6e74 5f73 7562 7363 7269 6265 725b  vent_subscriber[
-000462d0: 746f 7069 635d 2e61 6464 2863 6c69 656e  topic].add(clien
-000462e0: 7429 0a0a 2020 2020 6465 6620 756e 7375  t)..    def unsu
-000462f0: 6273 6372 6962 655f 746f 7069 6328 7365  bscribe_topic(se
-00046300: 6c66 2c20 746f 7069 632c 2063 6c69 656e  lf, topic, clien
-00046310: 7429 3a0a 2020 2020 2020 2020 7365 6c66  t):.        self
-00046320: 2e65 7665 6e74 5f73 7562 7363 7269 6265  .event_subscribe
-00046330: 725b 746f 7069 635d 2e64 6973 6361 7264  r[topic].discard
-00046340: 2863 6c69 656e 7429 0a0a 2020 2020 6465  (client)..    de
-00046350: 6620 6765 745f 6576 656e 7473 2873 656c  f get_events(sel
-00046360: 662c 2074 6f70 6963 3d4e 6f6e 6529 3a0a  f, topic=None):.
-00046370: 2020 2020 2020 2020 6966 2074 6f70 6963          if topic
-00046380: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00046390: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000463a0: 2074 7570 6c65 2873 656c 662e 6576 656e   tuple(self.even
-000463b0: 7473 5b74 6f70 6963 5d29 0a20 2020 2020  ts[topic]).     
-000463c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000463d0: 2020 2020 2072 6574 7572 6e20 7661 6c6d       return valm
-000463e0: 6170 2874 7570 6c65 2c20 7365 6c66 2e65  ap(tuple, self.e
-000463f0: 7665 6e74 7329 0a0a 2020 2020 6173 796e  vents)..    asyn
-00046400: 6320 6465 6620 6765 745f 776f 726b 6572  c def get_worker
-00046410: 5f6d 6f6e 6974 6f72 5f69 6e66 6f28 7365  _monitor_info(se
-00046420: 6c66 2c20 7265 6365 6e74 3d46 616c 7365  lf, recent=False
-00046430: 2c20 7374 6172 7473 3d4e 6f6e 6529 3a0a  , starts=None):.
-00046440: 2020 2020 2020 2020 6966 2073 7461 7274          if start
-00046450: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
-00046460: 2020 2020 2020 2073 7461 7274 7320 3d20         starts = 
-00046470: 7b7d 0a20 2020 2020 2020 2072 6573 756c  {}.        resul
-00046480: 7473 203d 2061 7761 6974 2061 7379 6e63  ts = await async
-00046490: 696f 2e67 6174 6865 7228 0a20 2020 2020  io.gather(.     
-000464a0: 2020 2020 2020 202a 280a 2020 2020 2020         *(.      
-000464b0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
-000464c0: 7063 2877 292e 6765 745f 6d6f 6e69 746f  pc(w).get_monito
-000464d0: 725f 696e 666f 2872 6563 656e 743d 7265  r_info(recent=re
-000464e0: 6365 6e74 2c20 7374 6172 743d 7374 6172  cent, start=star
-000464f0: 7473 2e67 6574 2877 2c20 3029 290a 2020  ts.get(w, 0)).  
-00046500: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00046510: 7220 7720 696e 2073 656c 662e 776f 726b  r w in self.work
-00046520: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
-00046530: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
-00046540: 2020 2020 7265 7475 726e 2064 6963 7428      return dict(
-00046550: 7a69 7028 7365 6c66 2e77 6f72 6b65 7273  zip(self.workers
-00046560: 2c20 7265 7375 6c74 7329 290a 0a20 2020  , results))..   
-00046570: 2023 2323 2323 2323 2323 2323 0a20 2020   ###########.   
-00046580: 2023 2043 6c65 616e 7570 2023 0a20 2020   # Cleanup #.   
-00046590: 2023 2323 2323 2323 2323 2323 0a0a 2020   ###########..  
-000465a0: 2020 6173 796e 6320 6465 6620 6368 6563    async def chec
-000465b0: 6b5f 776f 726b 6572 5f74 746c 2873 656c  k_worker_ttl(sel
-000465c0: 6629 3a0a 2020 2020 2020 2020 6e6f 7720  f):.        now 
-000465d0: 3d20 7469 6d65 2829 0a20 2020 2020 2020  = time().       
-000465e0: 2073 7469 6d75 6c75 735f 6964 203d 2066   stimulus_id = f
-000465f0: 2263 6865 636b 2d77 6f72 6b65 722d 7474  "check-worker-tt
-00046600: 6c2d 7b6e 6f77 7d22 0a20 2020 2020 2020  l-{now}".       
-00046610: 2066 6f72 2077 7320 696e 2073 656c 662e   for ws in self.
-00046620: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
-00046630: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00046640: 2028 7773 2e6c 6173 745f 7365 656e 203c   (ws.last_seen <
-00046650: 206e 6f77 202d 2073 656c 662e 776f 726b   now - self.work
-00046660: 6572 5f74 746c 2920 616e 6420 280a 2020  er_ttl) and (.  
-00046670: 2020 2020 2020 2020 2020 2020 2020 7773                ws
-00046680: 2e6c 6173 745f 7365 656e 203c 206e 6f77  .last_seen < now
-00046690: 202d 2031 3020 2a20 6865 6172 7462 6561   - 10 * heartbea
-000466a0: 745f 696e 7465 7276 616c 286c 656e 2873  t_interval(len(s
-000466b0: 656c 662e 776f 726b 6572 7329 290a 2020  elf.workers)).  
-000466c0: 2020 2020 2020 2020 2020 293a 0a20 2020            ):.   
-000466d0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-000466e0: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
-000466f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046700: 2022 576f 726b 6572 2066 6169 6c65 6420   "Worker failed 
-00046710: 746f 2068 6561 7274 6265 6174 2077 6974  to heartbeat wit
-00046720: 6869 6e20 2573 2073 6563 6f6e 6473 2e20  hin %s seconds. 
-00046730: 436c 6f73 696e 673a 2025 7322 2c0a 2020  Closing: %s",.  
-00046740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046750: 2020 7365 6c66 2e77 6f72 6b65 725f 7474    self.worker_tt
-00046760: 6c2c 0a20 2020 2020 2020 2020 2020 2020  l,.             
-00046770: 2020 2020 2020 2077 732c 0a20 2020 2020         ws,.     
-00046780: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00046790: 2020 2020 2020 2020 2020 2020 2061 7761               awa
-000467a0: 6974 2073 656c 662e 7265 6d6f 7665 5f77  it self.remove_w
-000467b0: 6f72 6b65 7228 6164 6472 6573 733d 7773  orker(address=ws
-000467c0: 2e61 6464 7265 7373 2c20 7374 696d 756c  .address, stimul
-000467d0: 7573 5f69 643d 7374 696d 756c 7573 5f69  us_id=stimulus_i
-000467e0: 6429 0a0a 2020 2020 6465 6620 6368 6563  d)..    def chec
-000467f0: 6b5f 6964 6c65 2873 656c 6629 202d 3e20  k_idle(self) -> 
-00046800: 666c 6f61 7420 7c20 4e6f 6e65 3a0a 2020  float | None:.  
-00046810: 2020 2020 2020 6966 2073 656c 662e 7374        if self.st
-00046820: 6174 7573 2069 6e20 2853 7461 7475 732e  atus in (Status.
-00046830: 636c 6f73 696e 672c 2053 7461 7475 732e  closing, Status.
-00046840: 636c 6f73 6564 293a 0a20 2020 2020 2020  closed):.       
-00046850: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
-00046860: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00046870: 662e 7472 616e 7369 7469 6f6e 5f63 6f75  f.transition_cou
-00046880: 6e74 6572 2021 3d20 7365 6c66 2e5f 6964  nter != self._id
-00046890: 6c65 5f74 7261 6e73 6974 696f 6e5f 636f  le_transition_co
-000468a0: 756e 7465 723a 0a20 2020 2020 2020 2020  unter:.         
-000468b0: 2020 2073 656c 662e 5f69 646c 655f 7472     self._idle_tr
-000468c0: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
-000468d0: 203d 2073 656c 662e 7472 616e 7369 7469   = self.transiti
-000468e0: 6f6e 5f63 6f75 6e74 6572 0a20 2020 2020  on_counter.     
-000468f0: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
-00046900: 5f73 696e 6365 203d 204e 6f6e 650a 2020  _since = None.  
-00046910: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00046920: 204e 6f6e 650a 0a20 2020 2020 2020 2069   None..        i
-00046930: 6620 280a 2020 2020 2020 2020 2020 2020  f (.            
-00046940: 7365 6c66 2e71 7565 7565 640a 2020 2020  self.queued.    
-00046950: 2020 2020 2020 2020 6f72 2073 656c 662e          or self.
-00046960: 756e 7275 6e6e 6162 6c65 0a20 2020 2020  unrunnable.     
-00046970: 2020 2020 2020 206f 7220 616e 7928 7773         or any(ws
-00046980: 2e70 726f 6365 7373 696e 6720 666f 7220  .processing for 
-00046990: 7773 2069 6e20 7365 6c66 2e77 6f72 6b65  ws in self.worke
-000469a0: 7273 2e76 616c 7565 7328 2929 0a20 2020  rs.values()).   
-000469b0: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
-000469c0: 2020 2020 7365 6c66 2e69 646c 655f 7369      self.idle_si
-000469d0: 6e63 6520 3d20 4e6f 6e65 0a20 2020 2020  nce = None.     
-000469e0: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
-000469f0: 6e65 0a0a 2020 2020 2020 2020 6966 206e  ne..        if n
-00046a00: 6f74 2073 656c 662e 6964 6c65 5f73 696e  ot self.idle_sin
-00046a10: 6365 3a0a 2020 2020 2020 2020 2020 2020  ce:.            
-00046a20: 7365 6c66 2e69 646c 655f 7369 6e63 6520  self.idle_since 
-00046a30: 3d20 7469 6d65 2829 0a20 2020 2020 2020  = time().       
-00046a40: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00046a50: 2e69 646c 655f 7369 6e63 650a 0a20 2020  .idle_since..   
-00046a60: 2020 2020 2069 6620 7365 6c66 2e6a 7570       if self.jup
-00046a70: 7974 6572 3a0a 2020 2020 2020 2020 2020  yter:.          
-00046a80: 2020 6c61 7374 5f61 6374 6976 6974 7920    last_activity 
-00046a90: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-00046aa0: 2020 2020 7365 6c66 2e5f 6a75 7079 7465      self._jupyte
-00046ab0: 725f 7365 7276 6572 5f61 7070 6c69 6361  r_server_applica
-00046ac0: 7469 6f6e 2e77 6562 5f61 7070 2e6c 6173  tion.web_app.las
-00046ad0: 745f 6163 7469 7669 7479 2829 2e74 696d  t_activity().tim
-00046ae0: 6573 7461 6d70 2829 0a20 2020 2020 2020  estamp().       
-00046af0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00046b00: 2020 2069 6620 6c61 7374 5f61 6374 6976     if last_activ
-00046b10: 6974 7920 3e20 7365 6c66 2e69 646c 655f  ity > self.idle_
-00046b20: 7369 6e63 653a 0a20 2020 2020 2020 2020  since:.         
-00046b30: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
-00046b40: 5f73 696e 6365 203d 206c 6173 745f 6163  _since = last_ac
-00046b50: 7469 7669 7479 0a20 2020 2020 2020 2020  tivity.         
-00046b60: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00046b70: 6c66 2e69 646c 655f 7369 6e63 650a 0a20  lf.idle_since.. 
-00046b80: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
-00046b90: 646c 655f 7469 6d65 6f75 743a 0a20 2020  dle_timeout:.   
-00046ba0: 2020 2020 2020 2020 2069 6620 7469 6d65           if time
-00046bb0: 2829 203e 2073 656c 662e 6964 6c65 5f73  () > self.idle_s
-00046bc0: 696e 6365 202b 2073 656c 662e 6964 6c65  ince + self.idle
-00046bd0: 5f74 696d 656f 7574 3a0a 2020 2020 2020  _timeout:.      
-00046be0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00046bf0: 2073 656c 662e 6964 6c65 5f73 696e 6365   self.idle_since
-00046c00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00046c10: 206c 6f67 6765 722e 696e 666f 280a 2020   logger.info(.  
-00046c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046c30: 2020 2253 6368 6564 756c 6572 2063 6c6f    "Scheduler clo
-00046c40: 7369 6e67 2061 6674 6572 2062 6569 6e67  sing after being
-00046c50: 2069 646c 6520 666f 7220 2573 222c 0a20   idle for %s",. 
-00046c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046c70: 2020 2066 6f72 6d61 745f 7469 6d65 2873     format_time(s
-00046c80: 656c 662e 6964 6c65 5f74 696d 656f 7574  elf.idle_timeout
-00046c90: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00046ca0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00046cb0: 2020 2020 2073 656c 662e 5f6f 6e67 6f69       self._ongoi
-00046cc0: 6e67 5f62 6163 6b67 726f 756e 645f 7461  ng_background_ta
-00046cd0: 736b 732e 6361 6c6c 5f73 6f6f 6e28 7365  sks.call_soon(se
-00046ce0: 6c66 2e63 6c6f 7365 290a 2020 2020 2020  lf.close).      
-00046cf0: 2020 7265 7475 726e 2073 656c 662e 6964    return self.id
-00046d00: 6c65 5f73 696e 6365 0a0a 2020 2020 6465  le_since..    de
-00046d10: 6620 6164 6170 7469 7665 5f74 6172 6765  f adaptive_targe
-00046d20: 7428 7365 6c66 2c20 7461 7267 6574 5f64  t(self, target_d
-00046d30: 7572 6174 696f 6e3d 4e6f 6e65 293a 0a20  uration=None):. 
-00046d40: 2020 2020 2020 2022 2222 4465 7369 7265         """Desire
-00046d50: 6420 6e75 6d62 6572 206f 6620 776f 726b  d number of work
-00046d60: 6572 7320 6261 7365 6420 6f6e 2074 6865  ers based on the
-00046d70: 2063 7572 7265 6e74 2077 6f72 6b6c 6f61   current workloa
-00046d80: 640a 0a20 2020 2020 2020 2054 6869 7320  d..        This 
-00046d90: 6c6f 6f6b 7320 6174 2074 6865 2063 7572  looks at the cur
-00046da0: 7265 6e74 2072 756e 6e69 6e67 2074 6173  rent running tas
-00046db0: 6b73 2061 6e64 206d 656d 6f72 7920 7573  ks and memory us
-00046dc0: 652c 2061 6e64 2072 6574 7572 6e73 2061  e, and returns a
-00046dd0: 0a20 2020 2020 2020 206e 756d 6265 7220  .        number 
-00046de0: 6f66 2064 6573 6972 6564 2077 6f72 6b65  of desired worke
-00046df0: 7273 2e20 2054 6869 7320 6973 206f 6674  rs.  This is oft
-00046e00: 656e 2075 7365 6420 6279 2061 6461 7074  en used by adapt
-00046e10: 6976 6520 7363 6865 6475 6c69 6e67 2e0a  ive scheduling..
-00046e20: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
-00046e30: 6572 730a 2020 2020 2020 2020 2d2d 2d2d  ers.        ----
-00046e40: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2074  ------.        t
-00046e50: 6172 6765 745f 6475 7261 7469 6f6e 203a  arget_duration :
-00046e60: 2073 7472 0a20 2020 2020 2020 2020 2020   str.           
-00046e70: 2041 2064 6573 6972 6564 2064 7572 6174   A desired durat
-00046e80: 696f 6e20 6f66 2074 696d 6520 666f 7220  ion of time for 
-00046e90: 636f 6d70 7574 6174 696f 6e73 2074 6f20  computations to 
-00046ea0: 7461 6b65 2e20 2054 6869 7320 6166 6665  take.  This affe
-00046eb0: 6374 730a 2020 2020 2020 2020 2020 2020  cts.            
-00046ec0: 686f 7720 7261 7069 646c 7920 7468 6520  how rapidly the 
-00046ed0: 7363 6865 6475 6c65 7220 7769 6c6c 2061  scheduler will a
-00046ee0: 736b 2074 6f20 7363 616c 652e 0a0a 2020  sk to scale...  
-00046ef0: 2020 2020 2020 5365 6520 416c 736f 0a20        See Also. 
-00046f00: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d0a         --------.
-00046f10: 2020 2020 2020 2020 6469 7374 7269 6275          distribu
-00046f20: 7465 642e 6465 706c 6f79 2e41 6461 7074  ted.deploy.Adapt
-00046f30: 6976 650a 2020 2020 2020 2020 2222 220a  ive.        """.
-00046f40: 2020 2020 2020 2020 6966 2074 6172 6765          if targe
-00046f50: 745f 6475 7261 7469 6f6e 2069 7320 4e6f  t_duration is No
-00046f60: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00046f70: 7461 7267 6574 5f64 7572 6174 696f 6e20  target_duration 
-00046f80: 3d20 6461 736b 2e63 6f6e 6669 672e 6765  = dask.config.ge
-00046f90: 7428 2264 6973 7472 6962 7574 6564 2e61  t("distributed.a
-00046fa0: 6461 7074 6976 652e 7461 7267 6574 2d64  daptive.target-d
-00046fb0: 7572 6174 696f 6e22 290a 2020 2020 2020  uration").      
-00046fc0: 2020 7461 7267 6574 5f64 7572 6174 696f    target_duratio
-00046fd0: 6e20 3d20 7061 7273 655f 7469 6d65 6465  n = parse_timede
-00046fe0: 6c74 6128 7461 7267 6574 5f64 7572 6174  lta(target_durat
-00046ff0: 696f 6e29 0a0a 2020 2020 2020 2020 2320  ion)..        # 
-00047000: 4350 550a 0a20 2020 2020 2020 2023 2054  CPU..        # T
-00047010: 4f44 4f20 636f 6e73 6964 6572 2061 6e79  ODO consider any
-00047020: 2075 7365 722d 7370 6563 6966 6965 6420   user-specified 
-00047030: 6465 6661 756c 7420 7461 736b 2064 7572  default task dur
-00047040: 6174 696f 6e73 2066 6f72 2071 7565 7565  ations for queue
-00047050: 6420 7461 736b 730a 2020 2020 2020 2020  d tasks.        
-00047060: 7175 6575 6564 5f6f 6363 7570 616e 6379  queued_occupancy
-00047070: 203d 206c 656e 2873 656c 662e 7175 6575   = len(self.queu
-00047080: 6564 2920 2a20 7365 6c66 2e55 4e4b 4e4f  ed) * self.UNKNO
-00047090: 574e 5f54 4153 4b5f 4455 5241 5449 4f4e  WN_TASK_DURATION
-000470a0: 0a20 2020 2020 2020 2063 7075 203d 206d  .        cpu = m
-000470b0: 6174 682e 6365 696c 280a 2020 2020 2020  ath.ceil(.      
-000470c0: 2020 2020 2020 2873 656c 662e 746f 7461        (self.tota
-000470d0: 6c5f 6f63 6375 7061 6e63 7920 2b20 7175  l_occupancy + qu
-000470e0: 6575 6564 5f6f 6363 7570 616e 6379 2920  eued_occupancy) 
-000470f0: 2f20 7461 7267 6574 5f64 7572 6174 696f  / target_duratio
-00047100: 6e0a 2020 2020 2020 2020 2920 2023 2054  n.        )  # T
-00047110: 4f44 4f3a 2074 6872 6561 6473 2070 6572  ODO: threads per
-00047120: 2077 6f72 6b65 720a 0a20 2020 2020 2020   worker..       
-00047130: 2023 2041 766f 6964 2061 2066 6577 206c   # Avoid a few l
-00047140: 6f6e 6720 7461 736b 7320 6672 6f6d 2061  ong tasks from a
-00047150: 736b 696e 6720 666f 7220 6d61 6e79 2063  sking for many c
-00047160: 6f72 6573 0a20 2020 2020 2020 2074 6173  ores.        tas
-00047170: 6b73 5f72 6561 6479 203d 206c 656e 2873  ks_ready = len(s
-00047180: 656c 662e 7175 6575 6564 290a 2020 2020  elf.queued).    
-00047190: 2020 2020 666f 7220 7773 2069 6e20 7365      for ws in se
-000471a0: 6c66 2e77 6f72 6b65 7273 2e76 616c 7565  lf.workers.value
-000471b0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-000471c0: 2074 6173 6b73 5f72 6561 6479 202b 3d20   tasks_ready += 
-000471d0: 6c65 6e28 7773 2e70 726f 6365 7373 696e  len(ws.processin
-000471e0: 6729 0a0a 2020 2020 2020 2020 2020 2020  g)..            
-000471f0: 6966 2074 6173 6b73 5f72 6561 6479 203e  if tasks_ready >
-00047200: 2063 7075 3a0a 2020 2020 2020 2020 2020   cpu:.          
-00047210: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
-00047220: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00047230: 2020 2020 2020 6370 7520 3d20 6d69 6e28        cpu = min(
-00047240: 7461 736b 735f 7265 6164 792c 2063 7075  tasks_ready, cpu
-00047250: 290a 0a20 2020 2020 2020 2069 6620 2873  )..        if (s
-00047260: 656c 662e 756e 7275 6e6e 6162 6c65 206f  elf.unrunnable o
-00047270: 7220 7365 6c66 2e71 7565 7565 6429 2061  r self.queued) a
-00047280: 6e64 206e 6f74 2073 656c 662e 776f 726b  nd not self.work
-00047290: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
-000472a0: 2063 7075 203d 206d 6178 2831 2c20 6370   cpu = max(1, cp
-000472b0: 7529 0a0a 2020 2020 2020 2020 2320 6164  u)..        # ad
-000472c0: 6420 6d6f 7265 2077 6f72 6b65 7273 2069  d more workers i
-000472d0: 6620 6d6f 7265 2074 6861 6e20 3630 2520  f more than 60% 
-000472e0: 6f66 206d 656d 6f72 7920 6973 2075 7365  of memory is use
-000472f0: 640a 2020 2020 2020 2020 6c69 6d69 7420  d.        limit 
-00047300: 3d20 7375 6d28 7773 2e6d 656d 6f72 795f  = sum(ws.memory_
-00047310: 6c69 6d69 7420 666f 7220 7773 2069 6e20  limit for ws in 
-00047320: 7365 6c66 2e77 6f72 6b65 7273 2e76 616c  self.workers.val
-00047330: 7565 7328 2929 0a20 2020 2020 2020 2075  ues()).        u
-00047340: 7365 6420 3d20 7375 6d28 7773 2e6e 6279  sed = sum(ws.nby
-00047350: 7465 7320 666f 7220 7773 2069 6e20 7365  tes for ws in se
-00047360: 6c66 2e77 6f72 6b65 7273 2e76 616c 7565  lf.workers.value
-00047370: 7328 2929 0a20 2020 2020 2020 206d 656d  s()).        mem
-00047380: 6f72 7920 3d20 300a 2020 2020 2020 2020  ory = 0.        
-00047390: 6966 2075 7365 6420 3e20 302e 3620 2a20  if used > 0.6 * 
-000473a0: 6c69 6d69 7420 616e 6420 6c69 6d69 7420  limit and limit 
-000473b0: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
-000473c0: 206d 656d 6f72 7920 3d20 3220 2a20 6c65   memory = 2 * le
-000473d0: 6e28 7365 6c66 2e77 6f72 6b65 7273 290a  n(self.workers).
-000473e0: 0a20 2020 2020 2020 2074 6172 6765 7420  .        target 
-000473f0: 3d20 6d61 7828 6d65 6d6f 7279 2c20 6370  = max(memory, cp
-00047400: 7529 0a20 2020 2020 2020 2069 6620 7461  u).        if ta
-00047410: 7267 6574 203e 3d20 6c65 6e28 7365 6c66  rget >= len(self
-00047420: 2e77 6f72 6b65 7273 293a 0a20 2020 2020  .workers):.     
-00047430: 2020 2020 2020 2072 6574 7572 6e20 7461         return ta
-00047440: 7267 6574 0a20 2020 2020 2020 2065 6c73  rget.        els
-00047450: 653a 2020 2320 5363 616c 6520 646f 776e  e:  # Scale down
-00047460: 3f0a 2020 2020 2020 2020 2020 2020 746f  ?.            to
-00047470: 5f63 6c6f 7365 203d 2073 656c 662e 776f  _close = self.wo
-00047480: 726b 6572 735f 746f 5f63 6c6f 7365 2829  rkers_to_close()
-00047490: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000474a0: 7572 6e20 6c65 6e28 7365 6c66 2e77 6f72  urn len(self.wor
-000474b0: 6b65 7273 2920 2d20 6c65 6e28 746f 5f63  kers) - len(to_c
-000474c0: 6c6f 7365 290a 0a20 2020 2064 6566 2072  lose)..    def r
-000474d0: 6571 7565 7374 5f61 6371 7569 7265 5f72  equest_acquire_r
-000474e0: 6570 6c69 6361 7328 0a20 2020 2020 2020  eplicas(.       
-000474f0: 2073 656c 662c 2061 6464 723a 2073 7472   self, addr: str
-00047500: 2c20 6b65 7973 3a20 4974 6572 6162 6c65  , keys: Iterable
-00047510: 5b73 7472 5d2c 202a 2c20 7374 696d 756c  [str], *, stimul
-00047520: 7573 5f69 643a 2073 7472 0a20 2020 2029  us_id: str.    )
-00047530: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00047540: 2020 2222 2241 7379 6e63 6872 6f6e 6f75    """Asynchronou
-00047550: 736c 7920 6173 6b20 6120 776f 726b 6572  sly ask a worker
-00047560: 2074 6f20 6163 7175 6972 6520 6120 7265   to acquire a re
-00047570: 706c 6963 6120 6f66 2074 6865 206c 6973  plica of the lis
-00047580: 7465 6420 6b65 7973 2066 726f 6d0a 2020  ted keys from.  
-00047590: 2020 2020 2020 6f74 6865 7220 776f 726b        other work
-000475a0: 6572 732e 2054 6869 7320 6973 2061 2066  ers. This is a f
-000475b0: 6972 652d 616e 642d 666f 7267 6574 206f  ire-and-forget o
-000475c0: 7065 7261 7469 6f6e 2077 6869 6368 206f  peration which o
-000475d0: 6666 6572 7320 6e6f 2066 6565 6462 6163  ffers no feedbac
-000475e0: 6b20 666f 720a 2020 2020 2020 2020 7375  k for.        su
-000475f0: 6363 6573 7320 6f72 2066 6169 6c75 7265  ccess or failure
-00047600: 2c20 616e 6420 6973 2069 6e74 656e 6465  , and is intende
-00047610: 6420 666f 7220 686f 7573 656b 6565 7069  d for housekeepi
-00047620: 6e67 2061 6e64 206e 6f74 2066 6f72 2063  ng and not for c
-00047630: 6f6d 7075 7461 7469 6f6e 2e0a 2020 2020  omputation..    
-00047640: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00047650: 7768 6f5f 6861 7320 3d20 7b7d 0a20 2020  who_has = {}.   
-00047660: 2020 2020 206e 6279 7465 7320 3d20 7b7d       nbytes = {}
-00047670: 0a20 2020 2020 2020 2066 6f72 206b 6579  .        for key
-00047680: 2069 6e20 6b65 7973 3a0a 2020 2020 2020   in keys:.      
-00047690: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
-000476a0: 7461 736b 735b 6b65 795d 0a20 2020 2020  tasks[key].     
-000476b0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-000476c0: 2e77 686f 5f68 6173 0a20 2020 2020 2020  .who_has.       
-000476d0: 2020 2020 2077 686f 5f68 6173 5b6b 6579       who_has[key
-000476e0: 5d20 3d20 5b77 732e 6164 6472 6573 7320  ] = [ws.address 
-000476f0: 666f 7220 7773 2069 6e20 7473 2e77 686f  for ws in ts.who
-00047700: 5f68 6173 5d0a 2020 2020 2020 2020 2020  _has].          
-00047710: 2020 6e62 7974 6573 5b6b 6579 5d20 3d20    nbytes[key] = 
-00047720: 7473 2e6e 6279 7465 730a 0a20 2020 2020  ts.nbytes..     
-00047730: 2020 2073 656c 662e 7374 7265 616d 5f63     self.stream_c
-00047740: 6f6d 6d73 5b61 6464 725d 2e73 656e 6428  omms[addr].send(
-00047750: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00047760: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00047770: 6f70 223a 2022 6163 7175 6972 652d 7265  op": "acquire-re
-00047780: 706c 6963 6173 222c 0a20 2020 2020 2020  plicas",.       
-00047790: 2020 2020 2020 2020 2022 7768 6f5f 6861           "who_ha
-000477a0: 7322 3a20 7768 6f5f 6861 732c 0a20 2020  s": who_has,.   
-000477b0: 2020 2020 2020 2020 2020 2020 2022 6e62               "nb
-000477c0: 7974 6573 223a 206e 6279 7465 732c 0a20  ytes": nbytes,. 
-000477d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000477e0: 7374 696d 756c 7573 5f69 6422 3a20 7374  stimulus_id": st
-000477f0: 696d 756c 7573 5f69 642c 0a20 2020 2020  imulus_id,.     
-00047800: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-00047810: 2020 290a 0a20 2020 2064 6566 2072 6571    )..    def req
-00047820: 7565 7374 5f72 656d 6f76 655f 7265 706c  uest_remove_repl
-00047830: 6963 6173 280a 2020 2020 2020 2020 7365  icas(.        se
-00047840: 6c66 2c20 6164 6472 3a20 7374 722c 206b  lf, addr: str, k
-00047850: 6579 733a 206c 6973 745b 7374 725d 2c20  eys: list[str], 
-00047860: 2a2c 2073 7469 6d75 6c75 735f 6964 3a20  *, stimulus_id: 
-00047870: 7374 720a 2020 2020 2920 2d3e 204e 6f6e  str.    ) -> Non
-00047880: 653a 0a20 2020 2020 2020 2022 2222 4173  e:.        """As
-00047890: 796e 6368 726f 6e6f 7573 6c79 2061 736b  ynchronously ask
-000478a0: 2061 2077 6f72 6b65 7220 746f 2064 6973   a worker to dis
-000478b0: 6361 7264 2069 7473 2072 6570 6c69 6361  card its replica
-000478c0: 206f 6620 7468 6520 6c69 7374 6564 206b   of the listed k
-000478d0: 6579 732e 0a20 2020 2020 2020 2054 6869  eys..        Thi
-000478e0: 7320 6d75 7374 206e 6576 6572 2062 6520  s must never be 
-000478f0: 7573 6564 2074 6f20 6465 7374 726f 7920  used to destroy 
-00047900: 7468 6520 6c61 7374 2072 6570 6c69 6361  the last replica
-00047910: 206f 6620 6120 6b65 792e 2054 6869 7320   of a key. This 
-00047920: 6973 2061 0a20 2020 2020 2020 2066 6972  is a.        fir
-00047930: 652d 616e 642d 666f 7267 6574 206f 7065  e-and-forget ope
-00047940: 7261 7469 6f6e 2c20 696e 7465 6e64 6564  ration, intended
-00047950: 2066 6f72 2068 6f75 7365 6b65 6570 696e   for housekeepin
-00047960: 6720 616e 6420 6e6f 7420 666f 7220 636f  g and not for co
-00047970: 6d70 7574 6174 696f 6e2e 0a0a 2020 2020  mputation...    
-00047980: 2020 2020 5468 6520 7265 706c 6963 6120      The replica 
-00047990: 6469 7361 7070 6561 7273 2069 6d6d 6564  disappears immed
-000479a0: 6961 7465 6c79 2066 726f 6d20 5461 736b  iately from Task
-000479b0: 5374 6174 652e 7768 6f5f 6861 7320 6f6e  State.who_has on
-000479c0: 2074 6865 2053 6368 6564 756c 6572 2073   the Scheduler s
-000479d0: 6964 653b 0a20 2020 2020 2020 2069 6620  ide;.        if 
-000479e0: 7468 6520 776f 726b 6572 2072 6566 7573  the worker refus
-000479f0: 6573 2074 6f20 6465 6c65 7465 2c20 652e  es to delete, e.
-00047a00: 672e 2062 6563 6175 7365 2074 6865 2074  g. because the t
-00047a10: 6173 6b20 6973 2061 2064 6570 656e 6465  ask is a depende
-00047a20: 6e63 7920 6f66 0a20 2020 2020 2020 2061  ncy of.        a
-00047a30: 6e6f 7468 6572 2074 6173 6b20 7275 6e6e  nother task runn
-00047a40: 696e 6720 6f6e 2069 742c 2069 7420 7769  ing on it, it wi
-00047a50: 6c6c 2028 616c 736f 2061 7379 6e63 6872  ll (also asynchr
-00047a60: 6f6e 6f75 736c 7929 2069 6e66 6f72 6d20  onously) inform 
-00047a70: 7468 6520 7363 6865 6475 6c65 720a 2020  the scheduler.  
-00047a80: 2020 2020 2020 746f 2072 652d 6164 6420        to re-add 
-00047a90: 6974 7365 6c66 2074 6f20 7768 6f5f 6861  itself to who_ha
-00047aa0: 732e 2049 6620 7468 6520 776f 726b 6572  s. If the worker
-00047ab0: 2061 6772 6565 7320 746f 2064 6973 6361   agrees to disca
-00047ac0: 7264 2074 6865 2074 6173 6b2c 2074 6865  rd the task, the
-00047ad0: 7265 2069 730a 2020 2020 2020 2020 6e6f  re is.        no
-00047ae0: 2066 6565 6462 6163 6b2e 0a20 2020 2020   feedback..     
-00047af0: 2020 2022 2222 0a20 2020 2020 2020 2077     """.        w
-00047b00: 7320 3d20 7365 6c66 2e77 6f72 6b65 7273  s = self.workers
-00047b10: 5b61 6464 725d 0a0a 2020 2020 2020 2020  [addr]..        
-00047b20: 2320 5468 6520 7363 6865 6475 6c65 7220  # The scheduler 
-00047b30: 696d 6d65 6469 6174 656c 7920 666f 7267  immediately forg
-00047b40: 6574 7320 6162 6f75 7420 7468 6520 7265  ets about the re
-00047b50: 706c 6963 6120 616e 6420 7375 6767 6573  plica and sugges
-00047b60: 7473 2074 6865 2077 6f72 6b65 7220 746f  ts the worker to
-00047b70: 0a20 2020 2020 2020 2023 2064 726f 7020  .        # drop 
-00047b80: 6974 2e20 5468 6520 776f 726b 6572 206d  it. The worker m
-00047b90: 6179 2072 6566 7573 652c 2061 7420 7768  ay refuse, at wh
-00047ba0: 6963 6820 706f 696e 7420 6974 2077 696c  ich point it wil
-00047bb0: 6c20 7365 6e64 2062 6163 6b20 616e 2061  l send back an a
-00047bc0: 6464 2d6b 6579 730a 2020 2020 2020 2020  dd-keys.        
-00047bd0: 2320 6d65 7373 6167 6520 746f 2072 6569  # message to rei
-00047be0: 6e73 7461 7465 2069 742e 0a20 2020 2020  nstate it..     
-00047bf0: 2020 2066 6f72 206b 6579 2069 6e20 6b65     for key in ke
-00047c00: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
-00047c10: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
-00047c20: 6b65 795d 0a20 2020 2020 2020 2020 2020  key].           
-00047c30: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
-00047c40: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00047c50: 2020 2023 2044 6f20 6e6f 7420 6465 7374     # Do not dest
-00047c60: 726f 7920 7468 6520 6c61 7374 2063 6f70  roy the last cop
-00047c70: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
-00047c80: 2020 6173 7365 7274 206c 656e 2874 732e    assert len(ts.
-00047c90: 7768 6f5f 6861 7329 203e 2031 0a20 2020  who_has) > 1.   
-00047ca0: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
-00047cb0: 6d6f 7665 5f72 6570 6c69 6361 2874 732c  move_replica(ts,
-00047cc0: 2077 7329 0a0a 2020 2020 2020 2020 7365   ws)..        se
-00047cd0: 6c66 2e73 7472 6561 6d5f 636f 6d6d 735b  lf.stream_comms[
-00047ce0: 6164 6472 5d2e 7365 6e64 280a 2020 2020  addr].send(.    
-00047cf0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00047d00: 2020 2020 2020 2020 2020 226f 7022 3a20            "op": 
-00047d10: 2272 656d 6f76 652d 7265 706c 6963 6173  "remove-replicas
-00047d20: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00047d30: 2020 2022 6b65 7973 223a 206b 6579 732c     "keys": keys,
-00047d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00047d50: 2022 7374 696d 756c 7573 5f69 6422 3a20   "stimulus_id": 
-00047d60: 7374 696d 756c 7573 5f69 642c 0a20 2020  stimulus_id,.   
-00047d70: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00047d80: 2020 2029 0a0a 0a64 6566 205f 7461 736b     )...def _task
-00047d90: 5f74 6f5f 7265 706f 7274 5f6d 7367 2874  _to_report_msg(t
-00047da0: 733a 2054 6173 6b53 7461 7465 2920 2d3e  s: TaskState) ->
-00047db0: 2064 6963 745b 7374 722c 2041 6e79 5d20   dict[str, Any] 
-00047dc0: 7c20 4e6f 6e65 3a0a 2020 2020 6966 2074  | None:.    if t
-00047dd0: 732e 7374 6174 6520 3d3d 2022 666f 7267  s.state == "forg
-00047de0: 6f74 7465 6e22 3a0a 2020 2020 2020 2020  otten":.        
-00047df0: 7265 7475 726e 207b 226f 7022 3a20 2263  return {"op": "c
-00047e00: 616e 6365 6c6c 6564 2d6b 6579 7322 2c20  ancelled-keys", 
-00047e10: 226b 6579 7322 3a20 5b74 732e 6b65 795d  "keys": [ts.key]
-00047e20: 7d0a 2020 2020 656c 6966 2074 732e 7374  }.    elif ts.st
-00047e30: 6174 6520 3d3d 2022 6d65 6d6f 7279 223a  ate == "memory":
-00047e40: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00047e50: 7b22 6f70 223a 2022 6b65 792d 696e 2d6d  {"op": "key-in-m
-00047e60: 656d 6f72 7922 2c20 226b 6579 223a 2074  emory", "key": t
-00047e70: 732e 6b65 797d 0a20 2020 2065 6c69 6620  s.key}.    elif 
-00047e80: 7473 2e73 7461 7465 203d 3d20 2265 7272  ts.state == "err
-00047e90: 6564 223a 0a20 2020 2020 2020 2066 6169  ed":.        fai
-00047ea0: 6c69 6e67 5f74 7320 3d20 7473 2e65 7863  ling_ts = ts.exc
-00047eb0: 6570 7469 6f6e 5f62 6c61 6d65 0a20 2020  eption_blame.   
-00047ec0: 2020 2020 2061 7373 6572 7420 6661 696c       assert fail
-00047ed0: 696e 675f 7473 0a20 2020 2020 2020 2072  ing_ts.        r
-00047ee0: 6574 7572 6e20 7b0a 2020 2020 2020 2020  eturn {.        
-00047ef0: 2020 2020 226f 7022 3a20 2274 6173 6b2d      "op": "task-
-00047f00: 6572 7265 6422 2c0a 2020 2020 2020 2020  erred",.        
-00047f10: 2020 2020 226b 6579 223a 2074 732e 6b65      "key": ts.ke
-00047f20: 792c 0a20 2020 2020 2020 2020 2020 2022  y,.            "
-00047f30: 6578 6365 7074 696f 6e22 3a20 6661 696c  exception": fail
-00047f40: 696e 675f 7473 2e65 7863 6570 7469 6f6e  ing_ts.exception
-00047f50: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
-00047f60: 7261 6365 6261 636b 223a 2066 6169 6c69  raceback": faili
-00047f70: 6e67 5f74 732e 7472 6163 6562 6163 6b2c  ng_ts.traceback,
-00047f80: 0a20 2020 2020 2020 207d 0a20 2020 2065  .        }.    e
-00047f90: 6c73 653a 0a20 2020 2020 2020 2072 6574  lse:.        ret
-00047fa0: 7572 6e20 4e6f 6e65 0a0a 0a64 6566 205f  urn None...def _
-00047fb0: 7461 736b 5f74 6f5f 636c 6965 6e74 5f6d  task_to_client_m
-00047fc0: 7367 7328 7473 3a20 5461 736b 5374 6174  sgs(ts: TaskStat
-00047fd0: 6529 202d 3e20 6469 6374 5b73 7472 2c20  e) -> dict[str, 
-00047fe0: 6c69 7374 5b64 6963 745b 7374 722c 2041  list[dict[str, A
-00047ff0: 6e79 5d5d 5d3a 0a20 2020 2069 6620 7473  ny]]]:.    if ts
-00048000: 2e77 686f 5f77 616e 7473 3a0a 2020 2020  .who_wants:.    
-00048010: 2020 2020 7265 706f 7274 5f6d 7367 203d      report_msg =
-00048020: 205f 7461 736b 5f74 6f5f 7265 706f 7274   _task_to_report
-00048030: 5f6d 7367 2874 7329 0a20 2020 2020 2020  _msg(ts).       
-00048040: 2069 6620 7265 706f 7274 5f6d 7367 2069   if report_msg i
-00048050: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00048060: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-00048070: 6373 2e63 6c69 656e 745f 6b65 793a 205b  cs.client_key: [
-00048080: 7265 706f 7274 5f6d 7367 5d20 666f 7220  report_msg] for 
-00048090: 6373 2069 6e20 7473 2e77 686f 5f77 616e  cs in ts.who_wan
-000480a0: 7473 7d0a 2020 2020 7265 7475 726e 207b  ts}.    return {
-000480b0: 7d0a 0a0a 6465 6620 6465 6369 6465 5f77  }...def decide_w
-000480c0: 6f72 6b65 7228 0a20 2020 2074 733a 2054  orker(.    ts: T
-000480d0: 6173 6b53 7461 7465 2c0a 2020 2020 616c  askState,.    al
-000480e0: 6c5f 776f 726b 6572 733a 2049 7465 7261  l_workers: Itera
-000480f0: 626c 655b 576f 726b 6572 5374 6174 655d  ble[WorkerState]
-00048100: 2c0a 2020 2020 7661 6c69 645f 776f 726b  ,.    valid_work
-00048110: 6572 733a 2073 6574 5b57 6f72 6b65 7253  ers: set[WorkerS
-00048120: 7461 7465 5d20 7c20 4e6f 6e65 2c0a 2020  tate] | None,.  
-00048130: 2020 6f62 6a65 6374 6976 653a 2043 616c    objective: Cal
-00048140: 6c61 626c 655b 5b57 6f72 6b65 7253 7461  lable[[WorkerSta
-00048150: 7465 5d2c 2041 6e79 5d2c 0a29 202d 3e20  te], Any],.) -> 
-00048160: 576f 726b 6572 5374 6174 6520 7c20 4e6f  WorkerState | No
-00048170: 6e65 3a0a 2020 2020 2222 220a 2020 2020  ne:.    """.    
-00048180: 4465 6369 6465 2077 6869 6368 2077 6f72  Decide which wor
-00048190: 6b65 7220 7368 6f75 6c64 2074 616b 6520  ker should take 
-000481a0: 7461 736b 202a 7473 2a2e 0a0a 2020 2020  task *ts*...    
-000481b0: 5765 2063 686f 6f73 6520 7468 6520 776f  We choose the wo
-000481c0: 726b 6572 2074 6861 7420 6861 7320 7468  rker that has th
-000481d0: 6520 6461 7461 206f 6e20 7768 6963 6820  e data on which 
-000481e0: 2a74 732a 2064 6570 656e 6473 2e0a 0a20  *ts* depends... 
-000481f0: 2020 2049 6620 7365 7665 7261 6c20 776f     If several wo
-00048200: 726b 6572 7320 6861 7665 2064 6570 656e  rkers have depen
-00048210: 6465 6e63 6965 7320 7468 656e 2077 6520  dencies then we 
-00048220: 6368 6f6f 7365 2074 6865 206c 6573 732d  choose the less-
-00048230: 6275 7379 2077 6f72 6b65 722e 0a0a 2020  busy worker...  
-00048240: 2020 4f70 7469 6f6e 616c 6c79 2070 726f    Optionally pro
-00048250: 7669 6465 202a 7661 6c69 645f 776f 726b  vide *valid_work
-00048260: 6572 732a 206f 6620 7768 6572 6520 6a6f  ers* of where jo
-00048270: 6273 2061 7265 2061 6c6c 6f77 6564 2074  bs are allowed t
-00048280: 6f20 6f63 6375 720a 2020 2020 2869 6620  o occur.    (if 
-00048290: 616c 6c20 776f 726b 6572 7320 6172 6520  all workers are 
-000482a0: 616c 6c6f 7765 6420 746f 2074 616b 6520  allowed to take 
-000482b0: 7468 6520 7461 736b 2c20 7061 7373 204e  the task, pass N
-000482c0: 6f6e 6520 696e 7374 6561 6429 2e0a 0a20  one instead)... 
-000482d0: 2020 2049 6620 7468 6520 7461 736b 2072     If the task r
-000482e0: 6571 7569 7265 7320 6461 7461 2063 6f6d  equires data com
-000482f0: 6d75 6e69 6361 7469 6f6e 2062 6563 6175  munication becau
-00048300: 7365 206e 6f20 656c 6967 6962 6c65 2077  se no eligible w
-00048310: 6f72 6b65 7220 6861 730a 2020 2020 616c  orker has.    al
-00048320: 6c20 7468 6520 6465 7065 6e64 656e 6369  l the dependenci
-00048330: 6573 2061 6c72 6561 6479 2c20 7468 656e  es already, then
-00048340: 2077 6520 6368 6f6f 7365 2074 6f20 6d69   we choose to mi
-00048350: 6e69 6d69 7a65 2074 6865 206e 756d 6265  nimize the numbe
-00048360: 720a 2020 2020 6f66 2062 7974 6573 2073  r.    of bytes s
-00048370: 656e 7420 6265 7477 6565 6e20 776f 726b  ent between work
-00048380: 6572 732e 2020 5468 6973 2069 7320 6465  ers.  This is de
-00048390: 7465 726d 696e 6564 2062 7920 6361 6c6c  termined by call
-000483a0: 696e 6720 7468 650a 2020 2020 2a6f 626a  ing the.    *obj
-000483b0: 6563 7469 7665 2a20 6675 6e63 7469 6f6e  ective* function
-000483c0: 2e0a 2020 2020 2222 220a 2020 2020 6173  ..    """.    as
-000483d0: 7365 7274 2061 6c6c 2864 7473 2e77 686f  sert all(dts.who
-000483e0: 5f68 6173 2066 6f72 2064 7473 2069 6e20  _has for dts in 
-000483f0: 7473 2e64 6570 656e 6465 6e63 6965 7329  ts.dependencies)
-00048400: 0a20 2020 2069 6620 7473 2e61 6374 6f72  .    if ts.actor
-00048410: 3a0a 2020 2020 2020 2020 6361 6e64 6964  :.        candid
-00048420: 6174 6573 203d 2073 6574 2861 6c6c 5f77  ates = set(all_w
-00048430: 6f72 6b65 7273 290a 2020 2020 656c 7365  orkers).    else
-00048440: 3a0a 2020 2020 2020 2020 6361 6e64 6964  :.        candid
-00048450: 6174 6573 203d 207b 7777 7320 666f 7220  ates = {wws for 
-00048460: 6474 7320 696e 2074 732e 6465 7065 6e64  dts in ts.depend
-00048470: 656e 6369 6573 2066 6f72 2077 7773 2069  encies for wws i
-00048480: 6e20 6474 732e 7768 6f5f 6861 737d 0a20  n dts.who_has}. 
-00048490: 2020 2069 6620 7661 6c69 645f 776f 726b     if valid_work
-000484a0: 6572 7320 6973 204e 6f6e 653a 0a20 2020  ers is None:.   
-000484b0: 2020 2020 2069 6620 6e6f 7420 6361 6e64       if not cand
-000484c0: 6964 6174 6573 3a0a 2020 2020 2020 2020  idates:.        
-000484d0: 2020 2020 6361 6e64 6964 6174 6573 203d      candidates =
-000484e0: 2073 6574 2861 6c6c 5f77 6f72 6b65 7273   set(all_workers
-000484f0: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
-00048500: 2020 2020 6361 6e64 6964 6174 6573 2026      candidates &
-00048510: 3d20 7661 6c69 645f 776f 726b 6572 730a  = valid_workers.
-00048520: 2020 2020 2020 2020 6966 206e 6f74 2063          if not c
-00048530: 616e 6469 6461 7465 733a 0a20 2020 2020  andidates:.     
-00048540: 2020 2020 2020 2063 616e 6469 6461 7465         candidate
-00048550: 7320 3d20 7661 6c69 645f 776f 726b 6572  s = valid_worker
-00048560: 730a 2020 2020 2020 2020 2020 2020 6966  s.            if
-00048570: 206e 6f74 2063 616e 6469 6461 7465 733a   not candidates:
-00048580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00048590: 2069 6620 7473 2e6c 6f6f 7365 5f72 6573   if ts.loose_res
-000485a0: 7472 6963 7469 6f6e 733a 0a20 2020 2020  trictions:.     
-000485b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000485c0: 6574 7572 6e20 6465 6369 6465 5f77 6f72  eturn decide_wor
-000485d0: 6b65 7228 7473 2c20 616c 6c5f 776f 726b  ker(ts, all_work
-000485e0: 6572 732c 204e 6f6e 652c 206f 626a 6563  ers, None, objec
-000485f0: 7469 7665 290a 0a20 2020 2069 6620 6e6f  tive)..    if no
-00048600: 7420 6361 6e64 6964 6174 6573 3a0a 2020  t candidates:.  
-00048610: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-00048620: 650a 2020 2020 656c 6966 206c 656e 2863  e.    elif len(c
-00048630: 616e 6469 6461 7465 7329 203d 3d20 313a  andidates) == 1:
-00048640: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00048650: 6e65 7874 2869 7465 7228 6361 6e64 6964  next(iter(candid
-00048660: 6174 6573 2929 0a20 2020 2065 6c73 653a  ates)).    else:
-00048670: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00048680: 6d69 6e28 6361 6e64 6964 6174 6573 2c20  min(candidates, 
-00048690: 6b65 793d 6f62 6a65 6374 6976 6529 0a0a  key=objective)..
-000486a0: 0a64 6566 2076 616c 6964 6174 655f 7461  .def validate_ta
-000486b0: 736b 5f73 7461 7465 2874 733a 2054 6173  sk_state(ts: Tas
-000486c0: 6b53 7461 7465 2920 2d3e 204e 6f6e 653a  kState) -> None:
-000486d0: 0a20 2020 2022 2222 5661 6c69 6461 7465  .    """Validate
-000486e0: 2074 6865 2067 6976 656e 2054 6173 6b53   the given TaskS
-000486f0: 7461 7465 2222 220a 2020 2020 6173 7365  tate""".    asse
-00048700: 7274 2074 732e 7374 6174 6520 696e 2041  rt ts.state in A
-00048710: 4c4c 5f54 4153 4b5f 5354 4154 4553 2c20  LL_TASK_STATES, 
-00048720: 7473 0a0a 2020 2020 6966 2074 732e 7761  ts..    if ts.wa
-00048730: 6974 696e 675f 6f6e 3a0a 2020 2020 2020  iting_on:.      
-00048740: 2020 6173 7365 7274 2074 732e 7761 6974    assert ts.wait
-00048750: 696e 675f 6f6e 2e69 7373 7562 7365 7428  ing_on.issubset(
-00048760: 7473 2e64 6570 656e 6465 6e63 6965 7329  ts.dependencies)
-00048770: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
-00048780: 2277 6169 7469 6e67 206e 6f74 2073 7562  "waiting not sub
-00048790: 7365 7420 6f66 2064 6570 656e 6465 6e63  set of dependenc
-000487a0: 6965 7322 2c0a 2020 2020 2020 2020 2020  ies",.          
-000487b0: 2020 7374 7228 7473 2e77 6169 7469 6e67    str(ts.waiting
-000487c0: 5f6f 6e29 2c0a 2020 2020 2020 2020 2020  _on),.          
-000487d0: 2020 7374 7228 7473 2e64 6570 656e 6465    str(ts.depende
-000487e0: 6e63 6965 7329 2c0a 2020 2020 2020 2020  ncies),.        
-000487f0: 290a 2020 2020 6966 2074 732e 7761 6974  ).    if ts.wait
-00048800: 6572 733a 0a20 2020 2020 2020 2061 7373  ers:.        ass
-00048810: 6572 7420 7473 2e77 6169 7465 7273 2e69  ert ts.waiters.i
-00048820: 7373 7562 7365 7428 7473 2e64 6570 656e  ssubset(ts.depen
-00048830: 6465 6e74 7329 2c20 280a 2020 2020 2020  dents), (.      
-00048840: 2020 2020 2020 2277 6169 7465 7273 206e        "waiters n
-00048850: 6f74 2073 7562 7365 7420 6f66 2064 6570  ot subset of dep
-00048860: 656e 6465 6e74 7322 2c0a 2020 2020 2020  endents",.      
-00048870: 2020 2020 2020 7374 7228 7473 2e77 6169        str(ts.wai
-00048880: 7465 7273 292c 0a20 2020 2020 2020 2020  ters),.         
-00048890: 2020 2073 7472 2874 732e 6465 7065 6e64     str(ts.depend
-000488a0: 656e 7473 292c 0a20 2020 2020 2020 2029  ents),.        )
-000488b0: 0a0a 2020 2020 666f 7220 6474 7320 696e  ..    for dts in
-000488c0: 2074 732e 7761 6974 696e 675f 6f6e 3a0a   ts.waiting_on:.
-000488d0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-000488e0: 6f74 2064 7473 2e77 686f 5f68 6173 2c20  ot dts.who_has, 
-000488f0: 2822 7761 6974 696e 6720 6f6e 2069 6e2d  ("waiting on in-
-00048900: 6d65 6d6f 7279 2064 6570 222c 2073 7472  memory dep", str
-00048910: 2874 7329 2c20 7374 7228 6474 7329 290a  (ts), str(dts)).
-00048920: 2020 2020 2020 2020 6173 7365 7274 2064          assert d
-00048930: 7473 2e73 7461 7465 2021 3d20 2272 656c  ts.state != "rel
-00048940: 6561 7365 6422 2c20 2822 7761 6974 696e  eased", ("waitin
-00048950: 6720 6f6e 2072 656c 6561 7365 6420 6465  g on released de
-00048960: 7022 2c20 7374 7228 7473 292c 2073 7472  p", str(ts), str
-00048970: 2864 7473 2929 0a20 2020 2066 6f72 2064  (dts)).    for d
-00048980: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
-00048990: 6e63 6965 733a 0a20 2020 2020 2020 2061  ncies:.        a
-000489a0: 7373 6572 7420 7473 2069 6e20 6474 732e  ssert ts in dts.
-000489b0: 6465 7065 6e64 656e 7473 2c20 280a 2020  dependents, (.  
-000489c0: 2020 2020 2020 2020 2020 226e 6f74 2069            "not i
-000489d0: 6e20 6465 7065 6e64 656e 6379 2773 2064  n dependency's d
-000489e0: 6570 656e 6465 6e74 7322 2c0a 2020 2020  ependents",.    
-000489f0: 2020 2020 2020 2020 7374 7228 7473 292c          str(ts),
-00048a00: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
-00048a10: 2864 7473 292c 0a20 2020 2020 2020 2020  (dts),.         
-00048a20: 2020 2073 7472 2864 7473 2e64 6570 656e     str(dts.depen
-00048a30: 6465 6e74 7329 2c0a 2020 2020 2020 2020  dents),.        
-00048a40: 290a 2020 2020 2020 2020 6966 2074 732e  ).        if ts.
-00048a50: 7374 6174 6520 696e 2028 2277 6169 7469  state in ("waiti
-00048a60: 6e67 222c 2022 7175 6575 6564 222c 2022  ng", "queued", "
-00048a70: 7072 6f63 6573 7369 6e67 222c 2022 6e6f  processing", "no
-00048a80: 2d77 6f72 6b65 7222 293a 0a20 2020 2020  -worker"):.     
-00048a90: 2020 2020 2020 2061 7373 6572 7420 6474         assert dt
-00048aa0: 7320 696e 2074 732e 7761 6974 696e 675f  s in ts.waiting_
-00048ab0: 6f6e 206f 7220 6474 732e 7768 6f5f 6861  on or dts.who_ha
-00048ac0: 732c 2028 0a20 2020 2020 2020 2020 2020  s, (.           
-00048ad0: 2020 2020 2022 6465 7020 6d69 7373 696e       "dep missin
-00048ae0: 6722 2c0a 2020 2020 2020 2020 2020 2020  g",.            
-00048af0: 2020 2020 7374 7228 7473 292c 0a20 2020      str(ts),.   
-00048b00: 2020 2020 2020 2020 2020 2020 2073 7472               str
-00048b10: 2864 7473 292c 0a20 2020 2020 2020 2020  (dts),.         
-00048b20: 2020 2029 0a20 2020 2020 2020 2061 7373     ).        ass
-00048b30: 6572 7420 6474 732e 7374 6174 6520 213d  ert dts.state !=
-00048b40: 2022 666f 7267 6f74 7465 6e22 0a0a 2020   "forgotten"..  
-00048b50: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
-00048b60: 7761 6974 6572 733a 0a20 2020 2020 2020  waiters:.       
-00048b70: 2061 7373 6572 7420 6474 732e 7374 6174   assert dts.stat
-00048b80: 6520 696e 2028 2277 6169 7469 6e67 222c  e in ("waiting",
-00048b90: 2022 7175 6575 6564 222c 2022 7072 6f63   "queued", "proc
-00048ba0: 6573 7369 6e67 222c 2022 6e6f 2d77 6f72  essing", "no-wor
-00048bb0: 6b65 7222 292c 2028 0a20 2020 2020 2020  ker"), (.       
-00048bc0: 2020 2020 2022 7761 6974 6572 206e 6f74       "waiter not
-00048bd0: 2069 6e20 706c 6179 222c 0a20 2020 2020   in play",.     
-00048be0: 2020 2020 2020 2073 7472 2874 7329 2c0a         str(ts),.
-00048bf0: 2020 2020 2020 2020 2020 2020 7374 7228              str(
-00048c00: 6474 7329 2c0a 2020 2020 2020 2020 290a  dts),.        ).
-00048c10: 2020 2020 666f 7220 6474 7320 696e 2074      for dts in t
-00048c20: 732e 6465 7065 6e64 656e 7473 3a0a 2020  s.dependents:.  
-00048c30: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
-00048c40: 696e 2064 7473 2e64 6570 656e 6465 6e63  in dts.dependenc
-00048c50: 6965 732c 2028 0a20 2020 2020 2020 2020  ies, (.         
-00048c60: 2020 2022 6e6f 7420 696e 2064 6570 656e     "not in depen
-00048c70: 6465 6e74 2773 2064 6570 656e 6465 6e63  dent's dependenc
-00048c80: 6965 7322 2c0a 2020 2020 2020 2020 2020  ies",.          
-00048c90: 2020 7374 7228 7473 292c 0a20 2020 2020    str(ts),.     
-00048ca0: 2020 2020 2020 2073 7472 2864 7473 292c         str(dts),
-00048cb0: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
-00048cc0: 2864 7473 2e64 6570 656e 6465 6e63 6965  (dts.dependencie
-00048cd0: 7329 2c0a 2020 2020 2020 2020 290a 2020  s),.        ).  
-00048ce0: 2020 2020 2020 6173 7365 7274 2064 7473        assert dts
-00048cf0: 2e73 7461 7465 2021 3d20 2266 6f72 676f  .state != "forgo
-00048d00: 7474 656e 220a 0a20 2020 2061 7373 6572  tten"..    asser
-00048d10: 7420 2874 732e 7072 6f63 6573 7369 6e67  t (ts.processing
-00048d20: 5f6f 6e20 6973 206e 6f74 204e 6f6e 6529  _on is not None)
-00048d30: 203d 3d20 2874 732e 7374 6174 6520 3d3d   == (ts.state ==
-00048d40: 2022 7072 6f63 6573 7369 6e67 2229 0a20   "processing"). 
-00048d50: 2020 2061 7373 6572 7420 626f 6f6c 2874     assert bool(t
-00048d60: 732e 7768 6f5f 6861 7329 203d 3d20 2874  s.who_has) == (t
-00048d70: 732e 7374 6174 6520 3d3d 2022 6d65 6d6f  s.state == "memo
-00048d80: 7279 2229 2c20 2874 732c 2074 732e 7768  ry"), (ts, ts.wh
-00048d90: 6f5f 6861 732c 2074 732e 7374 6174 6529  o_has, ts.state)
-00048da0: 0a0a 2020 2020 6966 2074 732e 7374 6174  ..    if ts.stat
-00048db0: 6520 3d3d 2022 7175 6575 6564 223a 0a20  e == "queued":. 
-00048dc0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-00048dd0: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
-00048de0: 6f6e 0a20 2020 2020 2020 2061 7373 6572  on.        asser
-00048df0: 7420 6e6f 7420 7473 2e77 686f 5f68 6173  t not ts.who_has
-00048e00: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00048e10: 616c 6c28 6474 732e 7768 6f5f 6861 7320  all(dts.who_has 
-00048e20: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
-00048e30: 7065 6e64 656e 6369 6573 292c 2028 0a20  pendencies), (. 
-00048e40: 2020 2020 2020 2020 2020 2022 7461 736b             "task
-00048e50: 2071 7565 7565 6420 7769 7468 6f75 7420   queued without 
-00048e60: 616c 6c20 6465 7073 222c 0a20 2020 2020  all deps",.     
-00048e70: 2020 2020 2020 2073 7472 2874 7329 2c0a         str(ts),.
-00048e80: 2020 2020 2020 2020 2020 2020 7374 7228              str(
-00048e90: 7473 2e64 6570 656e 6465 6e63 6965 7329  ts.dependencies)
-00048ea0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-00048eb0: 2069 6620 7473 2e73 7461 7465 203d 3d20   if ts.state == 
-00048ec0: 2270 726f 6365 7373 696e 6722 3a0a 2020  "processing":.  
-00048ed0: 2020 2020 2020 6173 7365 7274 2061 6c6c        assert all
-00048ee0: 2864 7473 2e77 686f 5f68 6173 2066 6f72  (dts.who_has for
-00048ef0: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
-00048f00: 6465 6e63 6965 7329 2c20 280a 2020 2020  dencies), (.    
-00048f10: 2020 2020 2020 2020 2274 6173 6b20 7072          "task pr
-00048f20: 6f63 6573 7369 6e67 2077 6974 686f 7574  ocessing without
-00048f30: 2061 6c6c 2064 6570 7322 2c0a 2020 2020   all deps",.    
-00048f40: 2020 2020 2020 2020 7374 7228 7473 292c          str(ts),
-00048f50: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
-00048f60: 2874 732e 6465 7065 6e64 656e 6369 6573  (ts.dependencies
-00048f70: 292c 0a20 2020 2020 2020 2029 0a20 2020  ),.        ).   
-00048f80: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-00048f90: 7473 2e77 6169 7469 6e67 5f6f 6e0a 0a20  ts.waiting_on.. 
-00048fa0: 2020 2069 6620 7473 2e77 686f 5f68 6173     if ts.who_has
-00048fb0: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
-00048fc0: 2074 732e 7761 6974 6572 7320 6f72 2074   ts.waiters or t
-00048fd0: 732e 7768 6f5f 7761 6e74 732c 2028 0a20  s.who_wants, (. 
-00048fe0: 2020 2020 2020 2020 2020 2022 756e 6e65             "unne
-00048ff0: 6564 6564 2074 6173 6b20 696e 206d 656d  eded task in mem
-00049000: 6f72 7922 2c0a 2020 2020 2020 2020 2020  ory",.          
-00049010: 2020 7374 7228 7473 292c 0a20 2020 2020    str(ts),.     
-00049020: 2020 2020 2020 2073 7472 2874 732e 7768         str(ts.wh
-00049030: 6f5f 6861 7329 2c0a 2020 2020 2020 2020  o_has),.        
-00049040: 290a 2020 2020 2020 2020 6966 2074 732e  ).        if ts.
-00049050: 7275 6e5f 7370 6563 3a20 2023 2077 6173  run_spec:  # was
-00049060: 2063 6f6d 7075 7465 640a 2020 2020 2020   computed.      
-00049070: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
-00049080: 7479 7065 0a20 2020 2020 2020 2020 2020  type.           
-00049090: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-000490a0: 6365 2874 732e 7479 7065 2c20 7374 7229  ce(ts.type, str)
-000490b0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-000490c0: 6e6f 7420 616e 7928 5b74 7320 696e 2064  not any([ts in d
-000490d0: 7473 2e77 6169 7469 6e67 5f6f 6e20 666f  ts.waiting_on fo
-000490e0: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
-000490f0: 6e64 656e 7473 5d29 0a20 2020 2020 2020  ndents]).       
-00049100: 2066 6f72 2077 7320 696e 2074 732e 7768   for ws in ts.wh
-00049110: 6f5f 6861 733a 0a20 2020 2020 2020 2020  o_has:.         
-00049120: 2020 2061 7373 6572 7420 7473 2069 6e20     assert ts in 
-00049130: 7773 2e68 6173 5f77 6861 742c 2028 0a20  ws.has_what, (. 
-00049140: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00049150: 6e6f 7420 696e 2077 686f 5f68 6173 2720  not in who_has' 
-00049160: 6861 735f 7768 6174 222c 0a20 2020 2020  has_what",.     
-00049170: 2020 2020 2020 2020 2020 2073 7472 2874             str(t
-00049180: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-00049190: 2020 2020 7374 7228 7773 292c 0a20 2020      str(ws),.   
-000491a0: 2020 2020 2020 2020 2020 2020 2073 7472               str
-000491b0: 2877 732e 6861 735f 7768 6174 292c 0a20  (ws.has_what),. 
-000491c0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-000491d0: 2020 666f 7220 6373 2069 6e20 7473 2e77    for cs in ts.w
-000491e0: 686f 5f77 616e 7473 3a0a 2020 2020 2020  ho_wants:.      
-000491f0: 2020 6173 7365 7274 2074 7320 696e 2063    assert ts in c
-00049200: 732e 7761 6e74 735f 7768 6174 2c20 280a  s.wants_what, (.
-00049210: 2020 2020 2020 2020 2020 2020 226e 6f74              "not
-00049220: 2069 6e20 7768 6f5f 7761 6e74 7327 2077   in who_wants' w
-00049230: 616e 7473 5f77 6861 7422 2c0a 2020 2020  ants_what",.    
-00049240: 2020 2020 2020 2020 7374 7228 7473 292c          str(ts),
-00049250: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
-00049260: 2863 7329 2c0a 2020 2020 2020 2020 2020  (cs),.          
-00049270: 2020 7374 7228 6373 2e77 616e 7473 5f77    str(cs.wants_w
-00049280: 6861 7429 2c0a 2020 2020 2020 2020 290a  hat),.        ).
-00049290: 0a20 2020 2069 6620 7473 2e61 6374 6f72  .    if ts.actor
-000492a0: 3a0a 2020 2020 2020 2020 6966 2074 732e  :.        if ts.
-000492b0: 7374 6174 6520 3d3d 2022 6d65 6d6f 7279  state == "memory
-000492c0: 223a 0a20 2020 2020 2020 2020 2020 2061  ":.            a
-000492d0: 7373 6572 7420 7375 6d28 7473 2069 6e20  ssert sum(ts in 
-000492e0: 7773 2e61 6374 6f72 7320 666f 7220 7773  ws.actors for ws
-000492f0: 2069 6e20 7473 2e77 686f 5f68 6173 2920   in ts.who_has) 
-00049300: 3d3d 2031 0a20 2020 2020 2020 2069 6620  == 1.        if 
-00049310: 7473 2e73 7461 7465 203d 3d20 2270 726f  ts.state == "pro
-00049320: 6365 7373 696e 6722 3a0a 2020 2020 2020  cessing":.      
-00049330: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
-00049340: 7072 6f63 6573 7369 6e67 5f6f 6e0a 2020  processing_on.  
-00049350: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00049360: 2074 7320 696e 2074 732e 7072 6f63 6573   ts in ts.proces
-00049370: 7369 6e67 5f6f 6e2e 6163 746f 7273 0a20  sing_on.actors. 
-00049380: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-00049390: 2e73 7461 7465 2021 3d20 2271 7565 7565  .state != "queue
-000493a0: 6422 0a0a 0a64 6566 2076 616c 6964 6174  d"...def validat
-000493b0: 655f 776f 726b 6572 5f73 7461 7465 2877  e_worker_state(w
-000493c0: 733a 2057 6f72 6b65 7253 7461 7465 2920  s: WorkerState) 
-000493d0: 2d3e 204e 6f6e 653a 0a20 2020 2066 6f72  -> None:.    for
-000493e0: 2074 7320 696e 2077 732e 6861 735f 7768   ts in ws.has_wh
-000493f0: 6174 3a0a 2020 2020 2020 2020 6173 7365  at:.        asse
-00049400: 7274 2077 7320 696e 2074 732e 7768 6f5f  rt ws in ts.who_
-00049410: 6861 732c 2028 0a20 2020 2020 2020 2020  has, (.         
-00049420: 2020 2022 6e6f 7420 696e 2068 6173 5f77     "not in has_w
-00049430: 6861 7427 2077 686f 5f68 6173 222c 0a20  hat' who_has",. 
-00049440: 2020 2020 2020 2020 2020 2073 7472 2877             str(w
-00049450: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-00049460: 7374 7228 7473 292c 0a20 2020 2020 2020  str(ts),.       
-00049470: 2020 2020 2073 7472 2874 732e 7768 6f5f       str(ts.who_
-00049480: 6861 7329 2c0a 2020 2020 2020 2020 290a  has),.        ).
-00049490: 0a20 2020 2066 6f72 2074 7320 696e 2077  .    for ts in w
-000494a0: 732e 6163 746f 7273 3a0a 2020 2020 2020  s.actors:.      
-000494b0: 2020 6173 7365 7274 2074 732e 7374 6174    assert ts.stat
-000494c0: 6520 696e 2028 226d 656d 6f72 7922 2c20  e in ("memory", 
-000494d0: 2270 726f 6365 7373 696e 6722 290a 0a0a  "processing")...
-000494e0: 6465 6620 7661 6c69 6461 7465 5f73 7461  def validate_sta
-000494f0: 7465 280a 2020 2020 7461 736b 733a 2064  te(.    tasks: d
-00049500: 6963 745b 7374 722c 2054 6173 6b53 7461  ict[str, TaskSta
-00049510: 7465 5d2c 0a20 2020 2077 6f72 6b65 7273  te],.    workers
-00049520: 3a20 6469 6374 5b73 7472 2c20 576f 726b  : dict[str, Work
-00049530: 6572 5374 6174 655d 2c0a 2020 2020 636c  erState],.    cl
-00049540: 6965 6e74 733a 2064 6963 745b 7374 722c  ients: dict[str,
-00049550: 2043 6c69 656e 7453 7461 7465 5d2c 0a29   ClientState],.)
-00049560: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2222   -> None:.    ""
-00049570: 2256 616c 6964 6174 6520 6120 6375 7272  "Validate a curr
-00049580: 656e 7420 7275 6e74 696d 6520 7374 6174  ent runtime stat
-00049590: 652e 0a0a 2020 2020 5468 6973 2070 6572  e...    This per
-000495a0: 666f 726d 7320 6120 7365 7175 656e 6365  forms a sequence
-000495b0: 206f 6620 6368 6563 6b73 206f 6e20 7468   of checks on th
-000495c0: 6520 656e 7469 7265 2067 7261 7068 2c20  e entire graph, 
-000495d0: 7275 6e6e 696e 6720 696e 2061 626f 7574  running in about
-000495e0: 206c 696e 6561 720a 2020 2020 7469 6d65   linear.    time
-000495f0: 2e20 5468 6973 2072 6169 7365 7320 6173  . This raises as
-00049600: 7365 7274 2065 7272 6f72 7320 6966 2061  sert errors if a
-00049610: 6e79 7468 696e 6720 646f 6573 6e27 7420  nything doesn't 
-00049620: 6368 6563 6b20 6f75 742e 0a20 2020 2022  check out..    "
-00049630: 2222 0a20 2020 2066 6f72 2074 7320 696e  "".    for ts in
-00049640: 2074 6173 6b73 2e76 616c 7565 7328 293a   tasks.values():
-00049650: 0a20 2020 2020 2020 2076 616c 6964 6174  .        validat
-00049660: 655f 7461 736b 5f73 7461 7465 2874 7329  e_task_state(ts)
-00049670: 0a0a 2020 2020 666f 7220 7773 2069 6e20  ..    for ws in 
-00049680: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
-00049690: 3a0a 2020 2020 2020 2020 7661 6c69 6461  :.        valida
-000496a0: 7465 5f77 6f72 6b65 725f 7374 6174 6528  te_worker_state(
-000496b0: 7773 290a 0a20 2020 2066 6f72 2063 7320  ws)..    for cs 
-000496c0: 696e 2063 6c69 656e 7473 2e76 616c 7565  in clients.value
-000496d0: 7328 293a 0a20 2020 2020 2020 2066 6f72  s():.        for
-000496e0: 2074 7320 696e 2063 732e 7761 6e74 735f   ts in cs.wants_
-000496f0: 7768 6174 3a0a 2020 2020 2020 2020 2020  what:.          
-00049700: 2020 6173 7365 7274 2063 7320 696e 2074    assert cs in t
-00049710: 732e 7768 6f5f 7761 6e74 732c 2028 0a20  s.who_wants, (. 
-00049720: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00049730: 6e6f 7420 696e 2077 616e 7473 5f77 6861  not in wants_wha
-00049740: 7427 2077 686f 5f77 616e 7473 222c 0a20  t' who_wants",. 
-00049750: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00049760: 7472 2863 7329 2c0a 2020 2020 2020 2020  tr(cs),.        
-00049770: 2020 2020 2020 2020 7374 7228 7473 292c          str(ts),
-00049780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00049790: 2073 7472 2874 732e 7768 6f5f 7761 6e74   str(ts.who_want
-000497a0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-000497b0: 290a 0a0a 6465 6620 6865 6172 7462 6561  )...def heartbea
-000497c0: 745f 696e 7465 7276 616c 286e 3a20 696e  t_interval(n: in
-000497d0: 7429 202d 3e20 666c 6f61 743a 0a20 2020  t) -> float:.   
-000497e0: 2022 2222 496e 7465 7276 616c 2069 6e20   """Interval in 
-000497f0: 7365 636f 6e64 7320 7468 6174 2077 6520  seconds that we 
-00049800: 6465 7369 7265 2068 6561 7274 6265 6174  desire heartbeat
-00049810: 7320 6261 7365 6420 6f6e 206e 756d 6265  s based on numbe
-00049820: 7220 6f66 2077 6f72 6b65 7273 2222 220a  r of workers""".
-00049830: 2020 2020 6966 206e 203c 3d20 3130 3a0a      if n <= 10:.
-00049840: 2020 2020 2020 2020 7265 7475 726e 2030          return 0
-00049850: 2e35 0a20 2020 2065 6c69 6620 6e20 3c20  .5.    elif n < 
-00049860: 3530 3a0a 2020 2020 2020 2020 7265 7475  50:.        retu
-00049870: 726e 2031 0a20 2020 2065 6c69 6620 6e20  rn 1.    elif n 
-00049880: 3c20 3230 303a 0a20 2020 2020 2020 2072  < 200:.        r
-00049890: 6574 7572 6e20 320a 2020 2020 656c 7365  eturn 2.    else
-000498a0: 3a0a 2020 2020 2020 2020 2320 4e6f 206d  :.        # No m
-000498b0: 6f72 6520 7468 616e 2032 3030 2068 6561  ore than 200 hea
-000498c0: 7274 6265 6174 7320 6120 7365 636f 6e64  rtbeats a second
-000498d0: 2073 6361 6c65 6420 6279 2077 6f72 6b65   scaled by worke
-000498e0: 7273 0a20 2020 2020 2020 2072 6574 7572  rs.        retur
-000498f0: 6e20 6e20 2f20 3230 3020 2b20 310a 0a0a  n n / 200 + 1...
-00049900: 6465 6620 5f74 6173 6b5f 736c 6f74 735f  def _task_slots_
-00049910: 6176 6169 6c61 626c 6528 7773 3a20 576f  available(ws: Wo
-00049920: 726b 6572 5374 6174 652c 2073 6174 7572  rkerState, satur
-00049930: 6174 696f 6e5f 6661 6374 6f72 3a20 666c  ation_factor: fl
-00049940: 6f61 7429 202d 3e20 696e 743a 0a20 2020  oat) -> int:.   
-00049950: 2022 2222 4e75 6d62 6572 206f 6620 7461   """Number of ta
-00049960: 736b 7320 7468 6174 2063 616e 2062 6520  sks that can be 
-00049970: 7365 6e74 2074 6f20 7468 6973 2077 6f72  sent to this wor
-00049980: 6b65 7220 7769 7468 6f75 7420 6f76 6572  ker without over
-00049990: 7361 7475 7261 7469 6e67 2069 7422 2222  saturating it"""
-000499a0: 0a20 2020 2061 7373 6572 7420 6e6f 7420  .    assert not 
-000499b0: 6d61 7468 2e69 7369 6e66 2873 6174 7572  math.isinf(satur
-000499c0: 6174 696f 6e5f 6661 6374 6f72 290a 2020  ation_factor).  
-000499d0: 2020 7265 7475 726e 206d 6178 286d 6174    return max(mat
-000499e0: 682e 6365 696c 2873 6174 7572 6174 696f  h.ceil(saturatio
-000499f0: 6e5f 6661 6374 6f72 202a 2077 732e 6e74  n_factor * ws.nt
-00049a00: 6872 6561 6473 292c 2031 2920 2d20 280a  hreads), 1) - (.
-00049a10: 2020 2020 2020 2020 6c65 6e28 7773 2e70          len(ws.p
-00049a20: 726f 6365 7373 696e 6729 202d 206c 656e  rocessing) - len
-00049a30: 2877 732e 6c6f 6e67 5f72 756e 6e69 6e67  (ws.long_running
-00049a40: 290a 2020 2020 290a 0a0a 6465 6620 5f77  ).    )...def _w
-00049a50: 6f72 6b65 725f 6675 6c6c 2877 733a 2057  orker_full(ws: W
-00049a60: 6f72 6b65 7253 7461 7465 2c20 7361 7475  orkerState, satu
-00049a70: 7261 7469 6f6e 5f66 6163 746f 723a 2066  ration_factor: f
-00049a80: 6c6f 6174 2920 2d3e 2062 6f6f 6c3a 0a20  loat) -> bool:. 
-00049a90: 2020 2069 6620 6d61 7468 2e69 7369 6e66     if math.isinf
-00049aa0: 2873 6174 7572 6174 696f 6e5f 6661 6374  (saturation_fact
-00049ab0: 6f72 293a 0a20 2020 2020 2020 2072 6574  or):.        ret
-00049ac0: 7572 6e20 4661 6c73 650a 2020 2020 7265  urn False.    re
-00049ad0: 7475 726e 205f 7461 736b 5f73 6c6f 7473  turn _task_slots
-00049ae0: 5f61 7661 696c 6162 6c65 2877 732c 2073  _available(ws, s
-00049af0: 6174 7572 6174 696f 6e5f 6661 6374 6f72  aturation_factor
-00049b00: 2920 3c3d 2030 0a0a 0a63 6c61 7373 204b  ) <= 0...class K
-00049b10: 696c 6c65 6457 6f72 6b65 7228 4578 6365  illedWorker(Exce
-00049b20: 7074 696f 6e29 3a0a 2020 2020 6465 6620  ption):.    def 
-00049b30: 5f5f 696e 6974 5f5f 2873 656c 662c 2074  __init__(self, t
-00049b40: 6173 6b3a 2073 7472 2c20 6c61 7374 5f77  ask: str, last_w
-00049b50: 6f72 6b65 723a 2057 6f72 6b65 7253 7461  orker: WorkerSta
-00049b60: 7465 2c20 616c 6c6f 7765 645f 6661 696c  te, allowed_fail
-00049b70: 7572 6573 3a20 696e 7429 3a0a 2020 2020  ures: int):.    
-00049b80: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
-00049b90: 6974 5f5f 2874 6173 6b2c 206c 6173 745f  it__(task, last_
-00049ba0: 776f 726b 6572 2c20 616c 6c6f 7765 645f  worker, allowed_
-00049bb0: 6661 696c 7572 6573 290a 0a20 2020 2040  failures)..    @
-00049bc0: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-00049bd0: 2074 6173 6b28 7365 6c66 2920 2d3e 2073   task(self) -> s
-00049be0: 7472 3a0a 2020 2020 2020 2020 7265 7475  tr:.        retu
-00049bf0: 726e 2073 656c 662e 6172 6773 5b30 5d0a  rn self.args[0].
-00049c00: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-00049c10: 2020 2064 6566 206c 6173 745f 776f 726b     def last_work
-00049c20: 6572 2873 656c 6629 202d 3e20 576f 726b  er(self) -> Work
-00049c30: 6572 5374 6174 653a 0a20 2020 2020 2020  erState:.       
-00049c40: 2072 6574 7572 6e20 7365 6c66 2e61 7267   return self.arg
-00049c50: 735b 315d 0a0a 2020 2020 4070 726f 7065  s[1]..    @prope
-00049c60: 7274 790a 2020 2020 6465 6620 616c 6c6f  rty.    def allo
-00049c70: 7765 645f 6661 696c 7572 6573 2873 656c  wed_failures(sel
-00049c80: 6629 202d 3e20 696e 743a 0a20 2020 2020  f) -> int:.     
-00049c90: 2020 2072 6574 7572 6e20 7365 6c66 2e61     return self.a
-00049ca0: 7267 735b 325d 0a0a 2020 2020 6465 6620  rgs[2]..    def 
-00049cb0: 5f5f 7374 725f 5f28 7365 6c66 2920 2d3e  __str__(self) ->
-00049cc0: 2073 7472 3a0a 2020 2020 2020 2020 7265   str:.        re
-00049cd0: 7475 726e 2028 0a20 2020 2020 2020 2020  turn (.         
-00049ce0: 2020 2066 2241 7474 656d 7074 6564 2074     f"Attempted t
-00049cf0: 6f20 7275 6e20 7461 736b 207b 7365 6c66  o run task {self
-00049d00: 2e74 6173 6b7d 206f 6e20 7b73 656c 662e  .task} on {self.
-00049d10: 616c 6c6f 7765 645f 6661 696c 7572 6573  allowed_failures
-00049d20: 7d20 6469 6666 6572 656e 7420 220a 2020  } different ".  
-00049d30: 2020 2020 2020 2020 2020 2277 6f72 6b65            "worke
-00049d40: 7273 2c20 6275 7420 616c 6c20 7468 6f73  rs, but all thos
-00049d50: 6520 776f 726b 6572 7320 6469 6564 2077  e workers died w
-00049d60: 6869 6c65 2072 756e 6e69 6e67 2069 742e  hile running it.
-00049d70: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
-00049d80: 2254 6865 206c 6173 7420 776f 726b 6572  "The last worker
-00049d90: 2074 6861 7420 6174 7465 6d70 7420 746f   that attempt to
-00049da0: 2072 756e 2074 6865 2074 6173 6b20 7761   run the task wa
-00049db0: 7320 7b73 656c 662e 6c61 7374 5f77 6f72  s {self.last_wor
-00049dc0: 6b65 722e 6164 6472 6573 737d 2e20 220a  ker.address}. ".
-00049dd0: 2020 2020 2020 2020 2020 2020 2249 6e73              "Ins
-00049de0: 7065 6374 696e 6720 776f 726b 6572 206c  pecting worker l
-00049df0: 6f67 7320 6973 206f 6674 656e 2061 2067  ogs is often a g
-00049e00: 6f6f 6420 6e65 7874 2073 7465 7020 746f  ood next step to
-00049e10: 2064 6961 676e 6f73 6520 7768 6174 2077   diagnose what w
-00049e20: 656e 7420 7772 6f6e 672e 2022 0a20 2020  ent wrong. ".   
-00049e30: 2020 2020 2020 2020 2022 466f 7220 6d6f           "For mo
-00049e40: 7265 2069 6e66 6f72 6d61 7469 6f6e 2073  re information s
-00049e50: 6565 2068 7474 7073 3a2f 2f64 6973 7472  ee https://distr
-00049e60: 6962 7574 6564 2e64 6173 6b2e 6f72 672f  ibuted.dask.org/
-00049e70: 656e 2f73 7461 626c 652f 6b69 6c6c 6564  en/stable/killed
-00049e80: 2e68 746d 6c2e 220a 2020 2020 2020 2020  .html.".        
-00049e90: 290a 0a0a 636c 6173 7320 576f 726b 6572  )...class Worker
-00049ea0: 5374 6174 7573 506c 7567 696e 2853 6368  StatusPlugin(Sch
-00049eb0: 6564 756c 6572 506c 7567 696e 293a 0a20  edulerPlugin):. 
-00049ec0: 2020 2022 2222 4120 706c 7567 696e 2074     """A plugin t
-00049ed0: 6f20 7368 6172 6520 776f 726b 6572 2073  o share worker s
-00049ee0: 7461 7475 7320 7769 7468 2061 2072 656d  tatus with a rem
-00049ef0: 6f74 6520 6f62 7365 7276 6572 0a0a 2020  ote observer..  
-00049f00: 2020 5468 6973 2069 7320 7573 6564 2069    This is used i
-00049f10: 6e20 636c 7573 7465 7220 6d61 6e61 6765  n cluster manage
-00049f20: 7273 2074 6f20 6b65 6570 2075 7064 6174  rs to keep updat
-00049f30: 6564 2061 626f 7574 2074 6865 2073 7461  ed about the sta
-00049f40: 7475 7320 6f66 2074 6865 2073 6368 6564  tus of the sched
-00049f50: 756c 6572 2e0a 2020 2020 2222 220a 0a20  uler..    """.. 
-00049f60: 2020 206e 616d 653a 2043 6c61 7373 5661     name: ClassVa
-00049f70: 725b 7374 725d 203d 2022 776f 726b 6572  r[str] = "worker
-00049f80: 2d73 7461 7475 7322 0a20 2020 2062 636f  -status".    bco
-00049f90: 6d6d 3a20 4261 7463 6865 6453 656e 640a  mm: BatchedSend.
-00049fa0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-00049fb0: 5f28 7365 6c66 2c20 7363 6865 6475 6c65  _(self, schedule
-00049fc0: 723a 2053 6368 6564 756c 6572 2c20 636f  r: Scheduler, co
-00049fd0: 6d6d 3a20 436f 6d6d 293a 0a20 2020 2020  mm: Comm):.     
-00049fe0: 2020 2073 656c 662e 6263 6f6d 6d20 3d20     self.bcomm = 
-00049ff0: 4261 7463 6865 6453 656e 6428 696e 7465  BatchedSend(inte
-0004a000: 7276 616c 3d22 356d 7322 290a 2020 2020  rval="5ms").    
-0004a010: 2020 2020 7365 6c66 2e62 636f 6d6d 2e73      self.bcomm.s
-0004a020: 7461 7274 2863 6f6d 6d29 0a20 2020 2020  tart(comm).     
-0004a030: 2020 2073 6368 6564 756c 6572 2e61 6464     scheduler.add
-0004a040: 5f70 6c75 6769 6e28 7365 6c66 290a 0a20  _plugin(self).. 
-0004a050: 2020 2064 6566 2061 6464 5f77 6f72 6b65     def add_worke
-0004a060: 7228 7365 6c66 2c20 7363 6865 6475 6c65  r(self, schedule
-0004a070: 723a 2053 6368 6564 756c 6572 2c20 776f  r: Scheduler, wo
-0004a080: 726b 6572 3a20 7374 7229 202d 3e20 4e6f  rker: str) -> No
-0004a090: 6e65 3a0a 2020 2020 2020 2020 6964 656e  ne:.        iden
-0004a0a0: 7420 3d20 7363 6865 6475 6c65 722e 776f  t = scheduler.wo
-0004a0b0: 726b 6572 735b 776f 726b 6572 5d2e 6964  rkers[worker].id
-0004a0c0: 656e 7469 7479 2829 0a20 2020 2020 2020  entity().       
-0004a0d0: 2064 656c 2069 6465 6e74 5b22 6d65 7472   del ident["metr
-0004a0e0: 6963 7322 5d0a 2020 2020 2020 2020 6465  ics"].        de
-0004a0f0: 6c20 6964 656e 745b 226c 6173 745f 7365  l ident["last_se
-0004a100: 656e 225d 0a20 2020 2020 2020 2074 7279  en"].        try
-0004a110: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0004a120: 6c66 2e62 636f 6d6d 2e73 656e 6428 5b22  lf.bcomm.send(["
-0004a130: 6164 6422 2c20 7b22 776f 726b 6572 7322  add", {"workers"
-0004a140: 3a20 7b77 6f72 6b65 723a 2069 6465 6e74  : {worker: ident
-0004a150: 7d7d 5d29 0a20 2020 2020 2020 2065 7863  }}]).        exc
-0004a160: 6570 7420 436f 6d6d 436c 6f73 6564 4572  ept CommClosedEr
-0004a170: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-0004a180: 2073 6368 6564 756c 6572 2e72 656d 6f76   scheduler.remov
-0004a190: 655f 706c 7567 696e 286e 616d 653d 7365  e_plugin(name=se
-0004a1a0: 6c66 2e6e 616d 6529 0a0a 2020 2020 6465  lf.name)..    de
-0004a1b0: 6620 7265 6d6f 7665 5f77 6f72 6b65 7228  f remove_worker(
-0004a1c0: 7365 6c66 2c20 7363 6865 6475 6c65 723a  self, scheduler:
-0004a1d0: 2053 6368 6564 756c 6572 2c20 776f 726b   Scheduler, work
-0004a1e0: 6572 3a20 7374 7229 202d 3e20 4e6f 6e65  er: str) -> None
-0004a1f0: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
-0004a200: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0004a210: 6263 6f6d 6d2e 7365 6e64 285b 2272 656d  bcomm.send(["rem
-0004a220: 6f76 6522 2c20 776f 726b 6572 5d29 0a20  ove", worker]). 
-0004a230: 2020 2020 2020 2065 7863 6570 7420 436f         except Co
-0004a240: 6d6d 436c 6f73 6564 4572 726f 723a 0a20  mmClosedError:. 
-0004a250: 2020 2020 2020 2020 2020 2073 6368 6564             sched
-0004a260: 756c 6572 2e72 656d 6f76 655f 706c 7567  uler.remove_plug
-0004a270: 696e 286e 616d 653d 7365 6c66 2e6e 616d  in(name=self.nam
-0004a280: 6529 0a0a 2020 2020 6465 6620 7465 6172  e)..    def tear
-0004a290: 646f 776e 2873 656c 6629 202d 3e20 4e6f  down(self) -> No
-0004a2a0: 6e65 3a0a 2020 2020 2020 2020 7365 6c66  ne:.        self
-0004a2b0: 2e62 636f 6d6d 2e63 6c6f 7365 2829 0a0a  .bcomm.close()..
-0004a2c0: 0a63 6c61 7373 2043 6f6c 6c65 6374 5461  .class CollectTa
-0004a2d0: 736b 4d65 7461 4461 7461 506c 7567 696e  skMetaDataPlugin
-0004a2e0: 2853 6368 6564 756c 6572 506c 7567 696e  (SchedulerPlugin
-0004a2f0: 293a 0a20 2020 2073 6368 6564 756c 6572  ):.    scheduler
-0004a300: 3a20 5363 6865 6475 6c65 720a 2020 2020  : Scheduler.    
-0004a310: 6e61 6d65 3a20 7374 720a 2020 2020 6b65  name: str.    ke
-0004a320: 7973 3a20 7365 745b 7374 725d 0a20 2020  ys: set[str].   
-0004a330: 206d 6574 6164 6174 613a 2064 6963 745b   metadata: dict[
-0004a340: 7374 722c 2041 6e79 5d0a 2020 2020 7374  str, Any].    st
-0004a350: 6174 653a 2064 6963 745b 7374 722c 2073  ate: dict[str, s
-0004a360: 7472 5d0a 0a20 2020 2064 6566 205f 5f69  tr]..    def __i
-0004a370: 6e69 745f 5f28 7365 6c66 2c20 7363 6865  nit__(self, sche
-0004a380: 6475 6c65 723a 2053 6368 6564 756c 6572  duler: Scheduler
-0004a390: 2c20 6e61 6d65 3a20 7374 7229 3a0a 2020  , name: str):.  
-0004a3a0: 2020 2020 2020 7365 6c66 2e73 6368 6564        self.sched
-0004a3b0: 756c 6572 203d 2073 6368 6564 756c 6572  uler = scheduler
-0004a3c0: 0a20 2020 2020 2020 2073 656c 662e 6e61  .        self.na
-0004a3d0: 6d65 203d 206e 616d 650a 2020 2020 2020  me = name.      
-0004a3e0: 2020 7365 6c66 2e6b 6579 7320 3d20 7365    self.keys = se
-0004a3f0: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
-0004a400: 2e6d 6574 6164 6174 6120 3d20 7b7d 0a20  .metadata = {}. 
-0004a410: 2020 2020 2020 2073 656c 662e 7374 6174         self.stat
-0004a420: 6520 3d20 7b7d 0a0a 2020 2020 6465 6620  e = {}..    def 
-0004a430: 7570 6461 7465 5f67 7261 7068 280a 2020  update_graph(.  
-0004a440: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-0004a450: 2020 2020 7363 6865 6475 6c65 723a 2053      scheduler: S
-0004a460: 6368 6564 756c 6572 2c0a 2020 2020 2020  cheduler,.      
-0004a470: 2020 2a2c 0a20 2020 2020 2020 206b 6579    *,.        key
-0004a480: 733a 2073 6574 5b73 7472 5d2c 0a20 2020  s: set[str],.   
-0004a490: 2020 2020 202a 2a6b 7761 7267 733a 2041       **kwargs: A
-0004a4a0: 6e79 2c0a 2020 2020 2920 2d3e 204e 6f6e  ny,.    ) -> Non
-0004a4b0: 653a 0a20 2020 2020 2020 2073 656c 662e  e:.        self.
-0004a4c0: 6b65 7973 2e75 7064 6174 6528 6b65 7973  keys.update(keys
-0004a4d0: 290a 0a20 2020 2064 6566 2074 7261 6e73  )..    def trans
-0004a4e0: 6974 696f 6e28 0a20 2020 2020 2020 2073  ition(.        s
-0004a4f0: 656c 662c 0a20 2020 2020 2020 206b 6579  elf,.        key
-0004a500: 3a20 7374 722c 0a20 2020 2020 2020 2073  : str,.        s
-0004a510: 7461 7274 3a20 5461 736b 5374 6174 6553  tart: TaskStateS
-0004a520: 7461 7465 2c0a 2020 2020 2020 2020 6669  tate,.        fi
-0004a530: 6e69 7368 3a20 5461 736b 5374 6174 6553  nish: TaskStateS
-0004a540: 7461 7465 2c0a 2020 2020 2020 2020 2a61  tate,.        *a
-0004a550: 7267 733a 2041 6e79 2c0a 2020 2020 2020  rgs: Any,.      
-0004a560: 2020 2a2a 6b77 6172 6773 3a20 416e 792c    **kwargs: Any,
-0004a570: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
-0004a580: 2020 2020 2020 2020 6966 2066 696e 6973          if finis
-0004a590: 6820 696e 2028 226d 656d 6f72 7922 2c20  h in ("memory", 
-0004a5a0: 2265 7272 6564 2229 3a0a 2020 2020 2020  "erred"):.      
-0004a5b0: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
-0004a5c0: 7363 6865 6475 6c65 722e 7461 736b 732e  scheduler.tasks.
-0004a5d0: 6765 7428 6b65 7929 0a20 2020 2020 2020  get(key).       
-0004a5e0: 2020 2020 2069 6620 7473 2069 7320 6e6f       if ts is no
-0004a5f0: 7420 4e6f 6e65 2061 6e64 2074 732e 6b65  t None and ts.ke
-0004a600: 7920 696e 2073 656c 662e 6b65 7973 3a0a  y in self.keys:.
-0004a610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a620: 7365 6c66 2e6d 6574 6164 6174 615b 6b65  self.metadata[ke
-0004a630: 795d 203d 2074 732e 6d65 7461 6461 7461  y] = ts.metadata
-0004a640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004a650: 2073 656c 662e 7374 6174 655b 6b65 795d   self.state[key]
-0004a660: 203d 2066 696e 6973 680a 2020 2020 2020   = finish.      
-0004a670: 2020 2020 2020 2020 2020 7365 6c66 2e6b            self.k
-0004a680: 6579 732e 6469 7363 6172 6428 6b65 7929  eys.discard(key)
-0004a690: 0a                                       .
+0003def0: 2020 7072 6576 5f73 7461 7475 7320 3d20    prev_status = 
+0003df00: 7773 2e73 7461 7475 730a 2020 2020 2020  ws.status.      
+0003df10: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0003df20: 6c66 2e68 616e 646c 655f 776f 726b 6572  lf.handle_worker
+0003df30: 5f73 7461 7475 735f 6368 616e 6765 280a  _status_change(.
+0003df40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003df50: 2020 2020 2020 2020 5374 6174 7573 2e63          Status.c
+0003df60: 6c6f 7369 6e67 5f67 7261 6365 6675 6c6c  losing_gracefull
+0003df70: 792c 2077 732c 2073 7469 6d75 6c75 735f  y, ws, stimulus_
+0003df80: 6964 0a20 2020 2020 2020 2020 2020 2020  id.             
+0003df90: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0003dfa0: 2020 2020 2020 2020 2020 2020 2023 2046               # F
+0003dfb0: 4958 4d45 3a20 5765 2073 686f 756c 6420  IXME: We should 
+0003dfc0: 7365 6e64 2061 206d 6573 7361 6765 2074  send a message t
+0003dfd0: 6f20 7468 6520 6e61 6e6e 7920 6669 7273  o the nanny firs
+0003dfe0: 743b 0a20 2020 2020 2020 2020 2020 2020  t;.             
+0003dff0: 2020 2020 2020 2023 2065 7665 6e74 7561         # eventua
+0003e000: 6c6c 7920 776f 726b 6572 7320 776f 6e27  lly workers won'
+0003e010: 7420 6265 2061 626c 6520 746f 2063 6c6f  t be able to clo
+0003e020: 7365 2074 6865 6972 206f 776e 206e 616e  se their own nan
+0003e030: 6e69 6573 2e0a 2020 2020 2020 2020 2020  nies..          
+0003e040: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
+0003e050: 7472 6561 6d5f 636f 6d6d 735b 7773 2e61  tream_comms[ws.a
+0003e060: 6464 7265 7373 5d2e 7365 6e64 280a 2020  ddress].send(.  
+0003e070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e080: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0003e090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e0a0: 2020 2020 226f 7022 3a20 2277 6f72 6b65      "op": "worke
+0003e0b0: 722d 7374 6174 7573 2d63 6861 6e67 6522  r-status-change"
+0003e0c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0003e0d0: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+0003e0e0: 7461 7475 7322 3a20 7773 2e73 7461 7475  tatus": ws.statu
+0003e0f0: 732e 6e61 6d65 2c0a 2020 2020 2020 2020  s.name,.        
+0003e100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e110: 2020 2020 2273 7469 6d75 6c75 735f 6964      "stimulus_id
+0003e120: 223a 2073 7469 6d75 6c75 735f 6964 2c0a  ": stimulus_id,.
+0003e130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e140: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0003e150: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0003e160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003e170: 2020 2020 2063 6f72 6f73 2e61 7070 656e       coros.appen
+0003e180: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
+0003e190: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0003e1a0: 5f74 7261 636b 5f72 6574 6972 655f 776f  _track_retire_wo
+0003e1b0: 726b 6572 280a 2020 2020 2020 2020 2020  rker(.          
+0003e1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e1d0: 2020 7773 2c0a 2020 2020 2020 2020 2020    ws,.          
+0003e1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e1f0: 2020 706f 6c69 6379 2c0a 2020 2020 2020    policy,.      
+0003e200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e210: 2020 2020 2020 7072 6576 5f73 7461 7475        prev_statu
+0003e220: 733d 7072 6576 5f73 7461 7475 732c 0a20  s=prev_status,. 
+0003e230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e240: 2020 2020 2020 2020 2020 2063 6c6f 7365             close
+0003e250: 3d63 6c6f 7365 5f77 6f72 6b65 7273 2c0a  =close_workers,.
+0003e260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e270: 2020 2020 2020 2020 2020 2020 7265 6d6f              remo
+0003e280: 7665 3d72 656d 6f76 652c 0a20 2020 2020  ve=remove,.     
+0003e290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e2a0: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
+0003e2b0: 6964 3d73 7469 6d75 6c75 735f 6964 2c0a  id=stimulus_id,.
+0003e2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e2d0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0003e2e0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0003e2f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003e300: 2023 2047 6976 6520 7468 6520 414d 4d20   # Give the AMM 
+0003e310: 6120 6b69 636b 2c20 696e 2061 6464 6974  a kick, in addit
+0003e320: 696f 6e20 746f 2069 7473 2070 6572 696f  ion to its perio
+0003e330: 6469 6320 7275 6e6e 696e 672e 2054 6869  dic running. Thi
+0003e340: 7320 6973 0a20 2020 2020 2020 2020 2020  s is.           
+0003e350: 2020 2020 2023 2074 6f20 6176 6f69 6420       # to avoid 
+0003e360: 756e 6e65 6365 7373 6172 696c 7920 7761  unnecessarily wa
+0003e370: 6974 696e 6720 666f 7220 6120 706f 7465  iting for a pote
+0003e380: 6e74 6961 6c6c 7920 6172 6269 7472 6172  ntially arbitrar
+0003e390: 696c 7920 6c6f 6e67 0a20 2020 2020 2020  ily long.       
+0003e3a0: 2020 2020 2020 2020 2023 2074 696d 6520           # time 
+0003e3b0: 2864 6570 656e 6469 6e67 206f 6e20 696e  (depending on in
+0003e3c0: 7465 7276 616c 2073 6574 7469 6e67 7329  terval settings)
+0003e3d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003e3e0: 2061 6d6d 2e72 756e 5f6f 6e63 6528 290a   amm.run_once().
+0003e3f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003e400: 2077 6f72 6b65 7273 5f69 6e66 6f20 3d20   workers_info = 
+0003e410: 6469 6374 2861 7761 6974 2061 7379 6e63  dict(await async
+0003e420: 696f 2e67 6174 6865 7228 2a63 6f72 6f73  io.gather(*coros
+0003e430: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+0003e440: 2020 2077 6f72 6b65 7273 5f69 6e66 6f2e     workers_info.
+0003e450: 706f 7028 4e6f 6e65 2c20 4e6f 6e65 290a  pop(None, None).
+0003e460: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
+0003e470: 6c6c 793a 0a20 2020 2020 2020 2020 2020  lly:.           
+0003e480: 2020 2020 2069 6620 7374 6f70 5f61 6d6d       if stop_amm
+0003e490: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003e4a0: 2020 2020 2020 616d 6d2e 7374 6f70 2829        amm.stop()
+0003e4b0: 0a0a 2020 2020 2020 2020 7365 6c66 2e6c  ..        self.l
+0003e4c0: 6f67 5f65 7665 6e74 2822 616c 6c22 2c20  og_event("all", 
+0003e4d0: 7b22 6163 7469 6f6e 223a 2022 7265 7469  {"action": "reti
+0003e4e0: 7265 2d77 6f72 6b65 7273 222c 2022 776f  re-workers", "wo
+0003e4f0: 726b 6572 7322 3a20 776f 726b 6572 735f  rkers": workers_
+0003e500: 696e 666f 7d29 0a20 2020 2020 2020 2073  info}).        s
+0003e510: 656c 662e 6c6f 675f 6576 656e 7428 6c69  elf.log_event(li
+0003e520: 7374 2877 6f72 6b65 7273 5f69 6e66 6f29  st(workers_info)
+0003e530: 2c20 7b22 6163 7469 6f6e 223a 2022 7265  , {"action": "re
+0003e540: 7469 7265 6422 7d29 0a0a 2020 2020 2020  tired"})..      
+0003e550: 2020 7265 7475 726e 2077 6f72 6b65 7273    return workers
+0003e560: 5f69 6e66 6f0a 0a20 2020 2061 7379 6e63  _info..    async
+0003e570: 2064 6566 205f 7472 6163 6b5f 7265 7469   def _track_reti
+0003e580: 7265 5f77 6f72 6b65 7228 0a20 2020 2020  re_worker(.     
+0003e590: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+0003e5a0: 2077 733a 2057 6f72 6b65 7253 7461 7465   ws: WorkerState
+0003e5b0: 2c0a 2020 2020 2020 2020 706f 6c69 6379  ,.        policy
+0003e5c0: 3a20 5265 7469 7265 576f 726b 6572 2c0a  : RetireWorker,.
+0003e5d0: 2020 2020 2020 2020 7072 6576 5f73 7461          prev_sta
+0003e5e0: 7475 733a 2053 7461 7475 732c 0a20 2020  tus: Status,.   
+0003e5f0: 2020 2020 2063 6c6f 7365 3a20 626f 6f6c       close: bool
+0003e600: 2c0a 2020 2020 2020 2020 7265 6d6f 7665  ,.        remove
+0003e610: 3a20 626f 6f6c 2c0a 2020 2020 2020 2020  : bool,.        
+0003e620: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
+0003e630: 2c0a 2020 2020 2920 2d3e 2074 7570 6c65  ,.    ) -> tuple
+0003e640: 3a20 2023 2074 7570 6c65 5b73 7472 207c  :  # tuple[str |
+0003e650: 204e 6f6e 652c 2064 6963 745d 0a20 2020   None, dict].   
+0003e660: 2020 2020 2077 6869 6c65 206e 6f74 2070       while not p
+0003e670: 6f6c 6963 792e 646f 6e65 2829 3a0a 2020  olicy.done():.  
+0003e680: 2020 2020 2020 2020 2020 2320 536c 6565            # Slee
+0003e690: 7020 302e 3031 7320 7768 656e 2074 6865  p 0.01s when the
+0003e6a0: 7265 2061 7265 2034 2074 6173 6b73 206f  re are 4 tasks o
+0003e6b0: 7220 6c65 7373 0a20 2020 2020 2020 2020  r less.         
+0003e6c0: 2020 2023 2053 6c65 6570 2030 2e35 7320     # Sleep 0.5s 
+0003e6d0: 7768 656e 2074 6865 7265 2061 7265 2032  when there are 2
+0003e6e0: 3030 206f 7220 6d6f 7265 0a20 2020 2020  00 or more.     
+0003e6f0: 2020 2020 2020 2070 6f6c 6c5f 696e 7465         poll_inte
+0003e700: 7276 616c 203d 206d 6178 2830 2e30 312c  rval = max(0.01,
+0003e710: 206d 696e 2830 2e35 2c20 6c65 6e28 7773   min(0.5, len(ws
+0003e720: 2e68 6173 5f77 6861 7429 202f 2034 3030  .has_what) / 400
+0003e730: 2929 0a20 2020 2020 2020 2020 2020 2061  )).            a
+0003e740: 7761 6974 2061 7379 6e63 696f 2e73 6c65  wait asyncio.sle
+0003e750: 6570 2870 6f6c 6c5f 696e 7465 7276 616c  ep(poll_interval
+0003e760: 290a 0a20 2020 2020 2020 2069 6620 706f  )..        if po
+0003e770: 6c69 6379 2e6e 6f5f 7265 6369 7069 656e  licy.no_recipien
+0003e780: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+0003e790: 2320 4162 6f72 7420 7265 7469 7265 6d65  # Abort retireme
+0003e7a0: 6e74 2e20 5468 6973 2074 696d 6520 7765  nt. This time we
+0003e7b0: 2064 6f6e 2774 206e 6565 6420 746f 2077   don't need to w
+0003e7c0: 6f72 7279 2061 626f 7574 2072 6163 650a  orry about race.
+0003e7d0: 2020 2020 2020 2020 2020 2020 2320 636f              # co
+0003e7e0: 6e64 6974 696f 6e73 2061 6e64 2077 6520  nditions and we 
+0003e7f0: 6361 6e20 7761 6974 2066 6f72 2061 2073  can wait for a s
+0003e800: 6368 6564 756c 6572 2d3e 776f 726b 6572  cheduler->worker
+0003e810: 2d3e 7363 6865 6475 6c65 720a 2020 2020  ->scheduler.    
+0003e820: 2020 2020 2020 2020 2320 726f 756e 642d          # round-
+0003e830: 7472 6970 2e0a 2020 2020 2020 2020 2020  trip..          
+0003e840: 2020 7365 6c66 2e73 7472 6561 6d5f 636f    self.stream_co
+0003e850: 6d6d 735b 7773 2e61 6464 7265 7373 5d2e  mms[ws.address].
+0003e860: 7365 6e64 280a 2020 2020 2020 2020 2020  send(.          
+0003e870: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0003e880: 2020 2020 2020 2020 2020 2020 226f 7022              "op"
+0003e890: 3a20 2277 6f72 6b65 722d 7374 6174 7573  : "worker-status
+0003e8a0: 2d63 6861 6e67 6522 2c0a 2020 2020 2020  -change",.      
+0003e8b0: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+0003e8c0: 7461 7475 7322 3a20 7072 6576 5f73 7461  tatus": prev_sta
+0003e8d0: 7475 732e 6e61 6d65 2c0a 2020 2020 2020  tus.name,.      
+0003e8e0: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+0003e8f0: 7469 6d75 6c75 735f 6964 223a 2073 7469  timulus_id": sti
+0003e900: 6d75 6c75 735f 6964 2c0a 2020 2020 2020  mulus_id,.      
+0003e910: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+0003e920: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0003e930: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+0003e940: 652c 207b 7d0a 0a20 2020 2020 2020 206c  e, {}..        l
+0003e950: 6f67 6765 722e 6465 6275 6728 0a20 2020  ogger.debug(.   
+0003e960: 2020 2020 2020 2020 2022 416c 6c20 756e           "All un
+0003e970: 6971 7565 206b 6579 7320 6f6e 2077 6f72  ique keys on wor
+0003e980: 6b65 7220 2573 2068 6176 6520 6265 656e  ker %s have been
+0003e990: 2072 6570 6c69 6361 7465 6420 656c 7365   replicated else
+0003e9a0: 7768 6572 6522 2c20 7773 2e61 6464 7265  where", ws.addre
+0003e9b0: 7373 0a20 2020 2020 2020 2029 0a0a 2020  ss.        )..  
+0003e9c0: 2020 2020 2020 6966 2072 656d 6f76 653a        if remove:
+0003e9d0: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+0003e9e0: 6974 2073 656c 662e 7265 6d6f 7665 5f77  it self.remove_w
+0003e9f0: 6f72 6b65 7228 0a20 2020 2020 2020 2020  orker(.         
+0003ea00: 2020 2020 2020 2077 732e 6164 6472 6573         ws.addres
+0003ea10: 732c 2073 6166 653d 5472 7565 2c20 636c  s, safe=True, cl
+0003ea20: 6f73 653d 636c 6f73 652c 2073 7469 6d75  ose=close, stimu
+0003ea30: 6c75 735f 6964 3d73 7469 6d75 6c75 735f  lus_id=stimulus_
+0003ea40: 6964 0a20 2020 2020 2020 2020 2020 2029  id.            )
+0003ea50: 0a20 2020 2020 2020 2065 6c69 6620 636c  .        elif cl
+0003ea60: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
+0003ea70: 2073 656c 662e 636c 6f73 655f 776f 726b   self.close_work
+0003ea80: 6572 2877 732e 6164 6472 6573 7329 0a0a  er(ws.address)..
+0003ea90: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+0003eaa0: 6e66 6f28 2252 6574 6972 6564 2077 6f72  nfo("Retired wor
+0003eab0: 6b65 7220 2573 222c 2077 732e 6164 6472  ker %s", ws.addr
+0003eac0: 6573 7329 0a20 2020 2020 2020 2072 6574  ess).        ret
+0003ead0: 7572 6e20 7773 2e61 6464 7265 7373 2c20  urn ws.address, 
+0003eae0: 7773 2e69 6465 6e74 6974 7928 290a 0a20  ws.identity().. 
+0003eaf0: 2020 2064 6566 2061 6464 5f6b 6579 7328     def add_keys(
+0003eb00: 0a20 2020 2020 2020 2073 656c 662c 2077  .        self, w
+0003eb10: 6f72 6b65 723a 2073 7472 2c20 6b65 7973  orker: str, keys
+0003eb20: 3a20 436f 6c6c 6563 7469 6f6e 5b73 7472  : Collection[str
+0003eb30: 5d20 3d20 2829 2c20 7374 696d 756c 7573  ] = (), stimulus
+0003eb40: 5f69 643a 2073 7472 207c 204e 6f6e 6520  _id: str | None 
+0003eb50: 3d20 4e6f 6e65 0a20 2020 2029 202d 3e20  = None.    ) -> 
+0003eb60: 4c69 7465 7261 6c5b 224f 4b22 2c20 226e  Literal["OK", "n
+0003eb70: 6f74 2066 6f75 6e64 225d 3a0a 2020 2020  ot found"]:.    
+0003eb80: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0003eb90: 4c65 6172 6e20 7468 6174 2061 2077 6f72  Learn that a wor
+0003eba0: 6b65 7220 6861 7320 6365 7274 6169 6e20  ker has certain 
+0003ebb0: 6b65 7973 0a0a 2020 2020 2020 2020 5468  keys..        Th
+0003ebc0: 6973 2073 686f 756c 6420 6e6f 7420 6265  is should not be
+0003ebd0: 2075 7365 6420 696e 2070 7261 6374 6963   used in practic
+0003ebe0: 6520 616e 6420 6973 206d 6f73 746c 7920  e and is mostly 
+0003ebf0: 6865 7265 2066 6f72 206c 6567 6163 790a  here for legacy.
+0003ec00: 2020 2020 2020 2020 7265 6173 6f6e 732e          reasons.
+0003ec10: 2020 486f 7765 7665 722c 2069 7420 6973    However, it is
+0003ec20: 2073 656e 7420 6279 2077 6f72 6b65 7273   sent by workers
+0003ec30: 2066 726f 6d20 7469 6d65 2074 6f20 7469   from time to ti
+0003ec40: 6d65 2e0a 2020 2020 2020 2020 2222 220a  me..        """.
+0003ec50: 2020 2020 2020 2020 6966 2077 6f72 6b65          if worke
+0003ec60: 7220 6e6f 7420 696e 2073 656c 662e 776f  r not in self.wo
+0003ec70: 726b 6572 733a 0a20 2020 2020 2020 2020  rkers:.         
+0003ec80: 2020 2072 6574 7572 6e20 226e 6f74 2066     return "not f
+0003ec90: 6f75 6e64 220a 2020 2020 2020 2020 7773  ound".        ws
+0003eca0: 3a20 576f 726b 6572 5374 6174 6520 3d20  : WorkerState = 
+0003ecb0: 7365 6c66 2e77 6f72 6b65 7273 5b77 6f72  self.workers[wor
+0003ecc0: 6b65 725d 0a20 2020 2020 2020 2072 6564  ker].        red
+0003ecd0: 756e 6461 6e74 5f72 6570 6c69 6361 7320  undant_replicas 
+0003ece0: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
+0003ecf0: 206b 6579 2069 6e20 6b65 7973 3a0a 2020   key in keys:.  
+0003ed00: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
+0003ed10: 656c 662e 7461 736b 732e 6765 7428 6b65  elf.tasks.get(ke
+0003ed20: 7929 0a20 2020 2020 2020 2020 2020 2069  y).            i
+0003ed30: 6620 7473 2069 7320 6e6f 7420 4e6f 6e65  f ts is not None
+0003ed40: 2061 6e64 2074 732e 7374 6174 6520 3d3d   and ts.state ==
+0003ed50: 2022 6d65 6d6f 7279 223a 0a20 2020 2020   "memory":.     
+0003ed60: 2020 2020 2020 2020 2020 2069 6620 7773             if ws
+0003ed70: 206e 6f74 2069 6e20 7473 2e77 686f 5f68   not in ts.who_h
+0003ed80: 6173 3a0a 2020 2020 2020 2020 2020 2020  as:.            
+0003ed90: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+0003eda0: 5f72 6570 6c69 6361 2874 732c 2077 7329  _replica(ts, ws)
+0003edb0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0003edc0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0003edd0: 2020 2072 6564 756e 6461 6e74 5f72 6570     redundant_rep
+0003ede0: 6c69 6361 732e 6170 7065 6e64 286b 6579  licas.append(key
+0003edf0: 290a 0a20 2020 2020 2020 2069 6620 7265  )..        if re
+0003ee00: 6475 6e64 616e 745f 7265 706c 6963 6173  dundant_replicas
+0003ee10: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0003ee20: 206e 6f74 2073 7469 6d75 6c75 735f 6964   not stimulus_id
+0003ee30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003ee40: 2020 7374 696d 756c 7573 5f69 6420 3d20    stimulus_id = 
+0003ee50: 6622 7265 6475 6e64 616e 742d 7265 706c  f"redundant-repl
+0003ee60: 6963 6173 2d7b 7469 6d65 2829 7d22 0a20  icas-{time()}". 
+0003ee70: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0003ee80: 776f 726b 6572 5f73 656e 6428 0a20 2020  worker_send(.   
+0003ee90: 2020 2020 2020 2020 2020 2020 2077 6f72               wor
+0003eea0: 6b65 722c 0a20 2020 2020 2020 2020 2020  ker,.           
+0003eeb0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0003eec0: 2020 2020 2020 2020 2020 2022 6f70 223a             "op":
+0003eed0: 2022 7265 6d6f 7665 2d72 6570 6c69 6361   "remove-replica
+0003eee0: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
+0003eef0: 2020 2020 2020 2020 226b 6579 7322 3a20          "keys": 
+0003ef00: 7265 6475 6e64 616e 745f 7265 706c 6963  redundant_replic
+0003ef10: 6173 2c0a 2020 2020 2020 2020 2020 2020  as,.            
+0003ef20: 2020 2020 2020 2020 2273 7469 6d75 6c75          "stimulu
+0003ef30: 735f 6964 223a 2073 7469 6d75 6c75 735f  s_id": stimulus_
+0003ef40: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+0003ef50: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
+0003ef60: 2020 2029 0a0a 2020 2020 2020 2020 7265     )..        re
+0003ef70: 7475 726e 2022 4f4b 220a 0a20 2020 2040  turn "OK"..    @
+0003ef80: 6c6f 675f 6572 726f 7273 0a20 2020 2064  log_errors.    d
+0003ef90: 6566 2075 7064 6174 655f 6461 7461 280a  ef update_data(.
+0003efa0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+0003efb0: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
+0003efc0: 2077 686f 5f68 6173 3a20 6469 6374 5b73   who_has: dict[s
+0003efd0: 7472 2c20 6c69 7374 5b73 7472 5d5d 2c0a  tr, list[str]],.
+0003efe0: 2020 2020 2020 2020 6e62 7974 6573 3a20          nbytes: 
+0003eff0: 6469 6374 5b73 7472 2c20 696e 745d 2c0a  dict[str, int],.
+0003f000: 2020 2020 2020 2020 636c 6965 6e74 3a20          client: 
+0003f010: 7374 7220 7c20 4e6f 6e65 203d 204e 6f6e  str | None = Non
+0003f020: 652c 0a20 2020 2029 202d 3e20 4e6f 6e65  e,.    ) -> None
+0003f030: 3a0a 2020 2020 2020 2020 2222 224c 6561  :.        """Lea
+0003f040: 726e 2074 6861 7420 6e65 7720 6461 7461  rn that new data
+0003f050: 2068 6173 2065 6e74 6572 6564 2074 6865   has entered the
+0003f060: 206e 6574 776f 726b 2066 726f 6d20 616e   network from an
+0003f070: 2065 7874 6572 6e61 6c20 736f 7572 6365   external source
+0003f080: 2222 220a 2020 2020 2020 2020 7768 6f5f  """.        who_
+0003f090: 6861 7320 3d20 7b6b 3a20 5b73 656c 662e  has = {k: [self.
+0003f0a0: 636f 6572 6365 5f61 6464 7265 7373 2876  coerce_address(v
+0003f0b0: 7629 2066 6f72 2076 7620 696e 2076 5d20  v) for vv in v] 
+0003f0c0: 666f 7220 6b2c 2076 2069 6e20 7768 6f5f  for k, v in who_
+0003f0d0: 6861 732e 6974 656d 7328 297d 0a20 2020  has.items()}.   
+0003f0e0: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
+0003f0f0: 6728 2255 7064 6174 6520 6461 7461 2025  g("Update data %
+0003f100: 7322 2c20 7768 6f5f 6861 7329 0a0a 2020  s", who_has)..  
+0003f110: 2020 2020 2020 666f 7220 6b65 792c 2077        for key, w
+0003f120: 6f72 6b65 7273 2069 6e20 7768 6f5f 6861  orkers in who_ha
+0003f130: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
+0003f140: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+0003f150: 2e74 6173 6b73 2e67 6574 286b 6579 290a  .tasks.get(key).
+0003f160: 2020 2020 2020 2020 2020 2020 6966 2074              if t
+0003f170: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+0003f180: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
+0003f190: 7365 6c66 2e6e 6577 5f74 6173 6b28 6b65  self.new_task(ke
+0003f1a0: 792c 204e 6f6e 652c 2022 6d65 6d6f 7279  y, None, "memory
+0003f1b0: 2229 0a20 2020 2020 2020 2020 2020 2074  ").            t
+0003f1c0: 732e 7374 6174 6520 3d20 226d 656d 6f72  s.state = "memor
+0003f1d0: 7922 0a20 2020 2020 2020 2020 2020 2074  y".            t
+0003f1e0: 735f 6e62 7974 6573 203d 206e 6279 7465  s_nbytes = nbyte
+0003f1f0: 732e 6765 7428 6b65 792c 202d 3129 0a20  s.get(key, -1). 
+0003f200: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
+0003f210: 5f6e 6279 7465 7320 3e3d 2030 3a0a 2020  _nbytes >= 0:.  
+0003f220: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+0003f230: 2e73 6574 5f6e 6279 7465 7328 7473 5f6e  .set_nbytes(ts_n
+0003f240: 6279 7465 7329 0a0a 2020 2020 2020 2020  bytes)..        
+0003f250: 2020 2020 666f 7220 7720 696e 2077 6f72      for w in wor
+0003f260: 6b65 7273 3a0a 2020 2020 2020 2020 2020  kers:.          
+0003f270: 2020 2020 2020 7773 203d 2073 656c 662e        ws = self.
+0003f280: 776f 726b 6572 735b 775d 0a20 2020 2020  workers[w].     
+0003f290: 2020 2020 2020 2020 2020 2069 6620 7773             if ws
+0003f2a0: 206e 6f74 2069 6e20 7473 2e77 686f 5f68   not in ts.who_h
+0003f2b0: 6173 3a0a 2020 2020 2020 2020 2020 2020  as:.            
+0003f2c0: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+0003f2d0: 5f72 6570 6c69 6361 2874 732c 2077 7329  _replica(ts, ws)
+0003f2e0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0003f2f0: 662e 7265 706f 7274 287b 226f 7022 3a20  f.report({"op": 
+0003f300: 226b 6579 2d69 6e2d 6d65 6d6f 7279 222c  "key-in-memory",
+0003f310: 2022 6b65 7922 3a20 6b65 792c 2022 776f   "key": key, "wo
+0003f320: 726b 6572 7322 3a20 6c69 7374 2877 6f72  rkers": list(wor
+0003f330: 6b65 7273 297d 290a 0a20 2020 2020 2020  kers)})..       
+0003f340: 2069 6620 636c 6965 6e74 3a0a 2020 2020   if client:.    
+0003f350: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
+0003f360: 656e 745f 6465 7369 7265 735f 6b65 7973  ent_desires_keys
+0003f370: 286b 6579 733d 6c69 7374 2877 686f 5f68  (keys=list(who_h
+0003f380: 6173 292c 2063 6c69 656e 743d 636c 6965  as), client=clie
+0003f390: 6e74 290a 0a20 2020 2040 6f76 6572 6c6f  nt)..    @overlo
+0003f3a0: 6164 0a20 2020 2064 6566 2072 6570 6f72  ad.    def repor
+0003f3b0: 745f 6f6e 5f6b 6579 2873 656c 662c 206b  t_on_key(self, k
+0003f3c0: 6579 3a20 7374 722c 202a 2c20 636c 6965  ey: str, *, clie
+0003f3d0: 6e74 3a20 7374 7220 7c20 4e6f 6e65 203d  nt: str | None =
+0003f3e0: 204e 6f6e 6529 202d 3e20 4e6f 6e65 3a0a   None) -> None:.
+0003f3f0: 2020 2020 2020 2020 2e2e 2e0a 0a20 2020          .....   
+0003f400: 2040 6f76 6572 6c6f 6164 0a20 2020 2064   @overload.    d
+0003f410: 6566 2072 6570 6f72 745f 6f6e 5f6b 6579  ef report_on_key
+0003f420: 2873 656c 662c 202a 2c20 7473 3a20 5461  (self, *, ts: Ta
+0003f430: 736b 5374 6174 652c 2063 6c69 656e 743a  skState, client:
+0003f440: 2073 7472 207c 204e 6f6e 6520 3d20 4e6f   str | None = No
+0003f450: 6e65 2920 2d3e 204e 6f6e 653a 0a20 2020  ne) -> None:.   
+0003f460: 2020 2020 202e 2e2e 0a0a 2020 2020 6465       .....    de
+0003f470: 6620 7265 706f 7274 5f6f 6e5f 6b65 7928  f report_on_key(
+0003f480: 7365 6c66 2c20 6b65 793d 4e6f 6e65 2c20  self, key=None, 
+0003f490: 2a2c 2074 733d 4e6f 6e65 2c20 636c 6965  *, ts=None, clie
+0003f4a0: 6e74 3d4e 6f6e 6529 3a0a 2020 2020 2020  nt=None):.      
+0003f4b0: 2020 6966 2028 7473 2069 7320 4e6f 6e65    if (ts is None
+0003f4c0: 2920 3d3d 2028 6b65 7920 6973 204e 6f6e  ) == (key is Non
+0003f4d0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+0003f4e0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+0003f4f0: 2820 2023 2070 7261 676d 613a 206e 6f63  (  # pragma: noc
+0003f500: 6f76 6572 0a20 2020 2020 2020 2020 2020  over.           
+0003f510: 2020 2020 2066 2274 7320 616e 6420 6b65       f"ts and ke
+0003f520: 7920 6172 6520 6d75 7475 616c 6c79 2065  y are mutually e
+0003f530: 7863 6c75 7369 7665 3b20 7265 6365 6976  xclusive; receiv
+0003f540: 6564 207b 6b65 793d 2172 7d2c 207b 7473  ed {key=!r}, {ts
+0003f550: 3d21 727d 220a 2020 2020 2020 2020 2020  =!r}".          
+0003f560: 2020 290a 2020 2020 2020 2020 6966 2074    ).        if t
+0003f570: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+0003f580: 2020 2020 2020 2061 7373 6572 7420 6b65         assert ke
+0003f590: 7920 6973 206e 6f74 204e 6f6e 650a 2020  y is not None.  
+0003f5a0: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
+0003f5b0: 656c 662e 7461 736b 732e 6765 7428 6b65  elf.tasks.get(ke
+0003f5c0: 7929 0a20 2020 2020 2020 2065 6c73 653a  y).        else:
+0003f5d0: 0a20 2020 2020 2020 2020 2020 206b 6579  .            key
+0003f5e0: 203d 2074 732e 6b65 790a 0a20 2020 2020   = ts.key..     
+0003f5f0: 2020 2069 6620 7473 2069 7320 6e6f 7420     if ts is not 
+0003f600: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0003f610: 2020 7265 706f 7274 5f6d 7367 203d 205f    report_msg = _
+0003f620: 7461 736b 5f74 6f5f 7265 706f 7274 5f6d  task_to_report_m
+0003f630: 7367 2874 7329 0a20 2020 2020 2020 2065  sg(ts).        e
+0003f640: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0003f650: 2072 6570 6f72 745f 6d73 6720 3d20 7b22   report_msg = {"
+0003f660: 6f70 223a 2022 6361 6e63 656c 6c65 642d  op": "cancelled-
+0003f670: 6b65 7973 222c 2022 6b65 7973 223a 205b  keys", "keys": [
+0003f680: 6b65 795d 7d0a 2020 2020 2020 2020 6966  key]}.        if
+0003f690: 2072 6570 6f72 745f 6d73 6720 6973 206e   report_msg is n
+0003f6a0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0003f6b0: 2020 2020 2073 656c 662e 7265 706f 7274       self.report
+0003f6c0: 2872 6570 6f72 745f 6d73 672c 2074 733d  (report_msg, ts=
+0003f6d0: 7473 2c20 636c 6965 6e74 3d63 6c69 656e  ts, client=clien
+0003f6e0: 7429 0a0a 2020 2020 406c 6f67 5f65 7272  t)..    @log_err
+0003f6f0: 6f72 730a 2020 2020 6173 796e 6320 6465  ors.    async de
+0003f700: 6620 6665 6564 280a 2020 2020 2020 2020  f feed(.        
+0003f710: 7365 6c66 2c0a 2020 2020 2020 2020 636f  self,.        co
+0003f720: 6d6d 3a20 436f 6d6d 2c0a 2020 2020 2020  mm: Comm,.      
+0003f730: 2020 6675 6e63 7469 6f6e 3a20 6279 7465    function: byte
+0003f740: 7320 7c20 4e6f 6e65 203d 204e 6f6e 652c  s | None = None,
+0003f750: 0a20 2020 2020 2020 2073 6574 7570 3a20  .        setup: 
+0003f760: 6279 7465 7320 7c20 4e6f 6e65 203d 204e  bytes | None = N
+0003f770: 6f6e 652c 0a20 2020 2020 2020 2074 6561  one,.        tea
+0003f780: 7264 6f77 6e3a 2062 7974 6573 207c 204e  rdown: bytes | N
+0003f790: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+0003f7a0: 2020 2020 696e 7465 7276 616c 3a20 7374      interval: st
+0003f7b0: 7220 7c20 666c 6f61 7420 3d20 2231 7322  r | float = "1s"
+0003f7c0: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
+0003f7d0: 6773 3a20 416e 792c 0a20 2020 2029 202d  gs: Any,.    ) -
+0003f7e0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+0003f7f0: 2222 220a 2020 2020 2020 2020 5072 6f76  """.        Prov
+0003f800: 6964 6573 2061 2064 6174 6120 436f 6d6d  ides a data Comm
+0003f810: 2074 6f20 6578 7465 726e 616c 2072 6571   to external req
+0003f820: 7565 7374 6572 0a0a 2020 2020 2020 2020  uester..        
+0003f830: 4361 7574 696f 6e3a 2074 6869 7320 7275  Caution: this ru
+0003f840: 6e73 2061 7262 6974 7261 7279 2050 7974  ns arbitrary Pyt
+0003f850: 686f 6e20 636f 6465 206f 6e20 7468 6520  hon code on the 
+0003f860: 7363 6865 6475 6c65 722e 2020 5468 6973  scheduler.  This
+0003f870: 2073 686f 756c 640a 2020 2020 2020 2020   should.        
+0003f880: 6576 656e 7475 616c 6c79 2062 6520 7068  eventually be ph
+0003f890: 6173 6564 206f 7574 2e20 2049 7420 6973  ased out.  It is
+0003f8a0: 206d 6f73 746c 7920 7573 6564 2062 7920   mostly used by 
+0003f8b0: 6469 6167 6e6f 7374 6963 732e 0a20 2020  diagnostics..   
+0003f8c0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0003f8d0: 2069 6620 6e6f 7420 6461 736b 2e63 6f6e   if not dask.con
+0003f8e0: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
+0003f8f0: 7574 6564 2e73 6368 6564 756c 6572 2e70  uted.scheduler.p
+0003f900: 6963 6b6c 6522 293a 0a20 2020 2020 2020  ickle"):.       
+0003f910: 2020 2020 206c 6f67 6765 722e 7761 726e       logger.warn
+0003f920: 696e 6728 0a20 2020 2020 2020 2020 2020  ing(.           
+0003f930: 2020 2020 2022 5472 6965 6420 746f 2063       "Tried to c
+0003f940: 616c 6c20 2766 6565 6427 2072 6f75 7465  all 'feed' route
+0003f950: 2077 6974 6820 6375 7374 6f6d 2066 756e   with custom fun
+0003f960: 6374 696f 6e73 2c20 6275 7420 220a 2020  ctions, but ".  
+0003f970: 2020 2020 2020 2020 2020 2020 2020 2270                "p
+0003f980: 6963 6b6c 6520 6973 2064 6973 616c 6c6f  ickle is disallo
+0003f990: 7765 642e 2020 5365 7420 7468 6520 2764  wed.  Set the 'd
+0003f9a0: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
+0003f9b0: 756c 6572 2e70 6963 6b6c 6527 220a 2020  uler.pickle'".  
+0003f9c0: 2020 2020 2020 2020 2020 2020 2020 2263                "c
+0003f9d0: 6f6e 6669 6720 7661 6c75 6520 746f 2054  onfig value to T
+0003f9e0: 7275 6520 746f 2075 7365 2074 6865 2027  rue to use the '
+0003f9f0: 6665 6564 2720 726f 7574 6520 2874 6869  feed' route (thi
+0003fa00: 7320 6973 206d 6f73 746c 7920 220a 2020  s is mostly ".  
+0003fa10: 2020 2020 2020 2020 2020 2020 2020 2263                "c
+0003fa20: 6f6d 6d6f 6e6c 7920 7573 6564 2077 6974  ommonly used wit
+0003fa30: 6820 7072 6f67 7265 7373 2062 6172 7329  h progress bars)
+0003fa40: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+0003fa50: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0003fa60: 726e 0a0a 2020 2020 2020 2020 696e 7465  rn..        inte
+0003fa70: 7276 616c 203d 2070 6172 7365 5f74 696d  rval = parse_tim
+0003fa80: 6564 656c 7461 2869 6e74 6572 7661 6c29  edelta(interval)
+0003fa90: 0a20 2020 2020 2020 2069 6620 6675 6e63  .        if func
+0003faa0: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
+0003fab0: 2020 6675 6e63 7469 6f6e 203d 2070 6963    function = pic
+0003fac0: 6b6c 652e 6c6f 6164 7328 6675 6e63 7469  kle.loads(functi
+0003fad0: 6f6e 290a 2020 2020 2020 2020 6966 2073  on).        if s
+0003fae0: 6574 7570 3a0a 2020 2020 2020 2020 2020  etup:.          
+0003faf0: 2020 7365 7475 7020 3d20 7069 636b 6c65    setup = pickle
+0003fb00: 2e6c 6f61 6473 2873 6574 7570 290a 0a20  .loads(setup).. 
+0003fb10: 2020 2020 2020 2069 6620 7465 6172 646f         if teardo
+0003fb20: 776e 3a0a 2020 2020 2020 2020 2020 2020  wn:.            
+0003fb30: 7465 6172 646f 776e 203d 2070 6963 6b6c  teardown = pickl
+0003fb40: 652e 6c6f 6164 7328 7465 6172 646f 776e  e.loads(teardown
+0003fb50: 290a 2020 2020 2020 2020 7374 6174 6520  ).        state 
+0003fb60: 3d20 7365 7475 7028 7365 6c66 2920 6966  = setup(self) if
+0003fb70: 2073 6574 7570 2065 6c73 6520 4e6f 6e65   setup else None
+0003fb80: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
+0003fb90: 0a20 2020 2020 2020 2069 6620 696e 7370  .        if insp
+0003fba0: 6563 742e 6973 6177 6169 7461 626c 6528  ect.isawaitable(
+0003fbb0: 7374 6174 6529 3a0a 2020 2020 2020 2020  state):.        
+0003fbc0: 2020 2020 7374 6174 6520 3d20 6177 6169      state = awai
+0003fbd0: 7420 7374 6174 650a 2020 2020 2020 2020  t state.        
+0003fbe0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0003fbf0: 2077 6869 6c65 2073 656c 662e 7374 6174   while self.stat
+0003fc00: 7573 203d 3d20 5374 6174 7573 2e72 756e  us == Status.run
+0003fc10: 6e69 6e67 3a0a 2020 2020 2020 2020 2020  ning:.          
+0003fc20: 2020 2020 2020 6966 2073 7461 7465 2069        if state i
+0003fc30: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0003fc40: 2020 2020 2020 2020 2020 2020 7265 7370              resp
+0003fc50: 6f6e 7365 203d 2066 756e 6374 696f 6e28  onse = function(
+0003fc60: 7365 6c66 2920 2023 2074 7970 653a 2069  self)  # type: i
+0003fc70: 676e 6f72 650a 2020 2020 2020 2020 2020  gnore.          
+0003fc80: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0003fc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fca0: 7265 7370 6f6e 7365 203d 2066 756e 6374  response = funct
+0003fcb0: 696f 6e28 7365 6c66 2c20 7374 6174 6529  ion(self, state)
+0003fcc0: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
+0003fcd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003fce0: 2061 7761 6974 2063 6f6d 6d2e 7772 6974   await comm.writ
+0003fcf0: 6528 7265 7370 6f6e 7365 290a 2020 2020  e(response).    
+0003fd00: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+0003fd10: 7420 6173 796e 6369 6f2e 736c 6565 7028  t asyncio.sleep(
+0003fd20: 696e 7465 7276 616c 290a 2020 2020 2020  interval).      
+0003fd30: 2020 6578 6365 7074 204f 5345 7272 6f72    except OSError
+0003fd40: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
+0003fd50: 7373 0a20 2020 2020 2020 2066 696e 616c  ss.        final
+0003fd60: 6c79 3a0a 2020 2020 2020 2020 2020 2020  ly:.            
+0003fd70: 6966 2074 6561 7264 6f77 6e3a 0a20 2020  if teardown:.   
+0003fd80: 2020 2020 2020 2020 2020 2020 2074 6561               tea
+0003fd90: 7264 6f77 6e28 7365 6c66 2c20 7374 6174  rdown(self, stat
+0003fda0: 6529 2020 2320 7479 7065 3a20 6967 6e6f  e)  # type: igno
+0003fdb0: 7265 0a0a 2020 2020 6465 6620 6c6f 675f  re..    def log_
+0003fdc0: 776f 726b 6572 5f65 7665 6e74 280a 2020  worker_event(.  
+0003fdd0: 2020 2020 2020 7365 6c66 2c20 776f 726b        self, work
+0003fde0: 6572 3a20 7374 722c 2074 6f70 6963 3a20  er: str, topic: 
+0003fdf0: 7374 7220 7c20 436f 6c6c 6563 7469 6f6e  str | Collection
+0003fe00: 5b73 7472 5d2c 206d 7367 3a20 416e 790a  [str], msg: Any.
+0003fe10: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
+0003fe20: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+0003fe30: 616e 6365 286d 7367 2c20 6469 6374 293a  ance(msg, dict):
+0003fe40: 0a20 2020 2020 2020 2020 2020 206d 7367  .            msg
+0003fe50: 5b22 776f 726b 6572 225d 203d 2077 6f72  ["worker"] = wor
+0003fe60: 6b65 720a 2020 2020 2020 2020 7365 6c66  ker.        self
+0003fe70: 2e6c 6f67 5f65 7665 6e74 2874 6f70 6963  .log_event(topic
+0003fe80: 2c20 6d73 6729 0a0a 2020 2020 6465 6620  , msg)..    def 
+0003fe90: 7375 6273 6372 6962 655f 776f 726b 6572  subscribe_worker
+0003fea0: 5f73 7461 7475 7328 7365 6c66 2c20 636f  _status(self, co
+0003feb0: 6d6d 3a20 436f 6d6d 2920 2d3e 2073 7472  mm: Comm) -> str
+0003fec0: 3a0a 2020 2020 2020 2020 576f 726b 6572  :.        Worker
+0003fed0: 5374 6174 7573 506c 7567 696e 2873 656c  StatusPlugin(sel
+0003fee0: 662c 2063 6f6d 6d29 0a20 2020 2020 2020  f, comm).       
+0003fef0: 2069 6465 6e74 203d 2073 656c 662e 6964   ident = self.id
+0003ff00: 656e 7469 7479 2829 0a20 2020 2020 2020  entity().       
+0003ff10: 2066 6f72 2076 2069 6e20 6964 656e 745b   for v in ident[
+0003ff20: 2277 6f72 6b65 7273 225d 2e76 616c 7565  "workers"].value
+0003ff30: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+0003ff40: 2064 656c 2076 5b22 6d65 7472 6963 7322   del v["metrics"
+0003ff50: 5d0a 2020 2020 2020 2020 2020 2020 6465  ].            de
+0003ff60: 6c20 765b 226c 6173 745f 7365 656e 225d  l v["last_seen"]
+0003ff70: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0003ff80: 6964 656e 740a 0a20 2020 2064 6566 2067  ident..    def g
+0003ff90: 6574 5f70 726f 6365 7373 696e 6728 0a20  et_processing(. 
+0003ffa0: 2020 2020 2020 2073 656c 662c 2077 6f72         self, wor
+0003ffb0: 6b65 7273 3a20 4974 6572 6162 6c65 5b73  kers: Iterable[s
+0003ffc0: 7472 5d20 7c20 4e6f 6e65 203d 204e 6f6e  tr] | None = Non
+0003ffd0: 650a 2020 2020 2920 2d3e 2064 6963 745b  e.    ) -> dict[
+0003ffe0: 7374 722c 206c 6973 745b 7374 725d 5d3a  str, list[str]]:
+0003fff0: 0a20 2020 2020 2020 2069 6620 776f 726b  .        if work
+00040000: 6572 7320 6973 206e 6f74 204e 6f6e 653a  ers is not None:
+00040010: 0a20 2020 2020 2020 2020 2020 2077 6f72  .            wor
+00040020: 6b65 7273 203d 2073 6574 286d 6170 2873  kers = set(map(s
+00040030: 656c 662e 636f 6572 6365 5f61 6464 7265  elf.coerce_addre
+00040040: 7373 2c20 776f 726b 6572 7329 290a 2020  ss, workers)).  
+00040050: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00040060: 207b 773a 205b 7473 2e6b 6579 2066 6f72   {w: [ts.key for
+00040070: 2074 7320 696e 2073 656c 662e 776f 726b   ts in self.work
+00040080: 6572 735b 775d 2e70 726f 6365 7373 696e  ers[w].processin
+00040090: 675d 2066 6f72 2077 2069 6e20 776f 726b  g] for w in work
+000400a0: 6572 737d 0a20 2020 2020 2020 2065 6c73  ers}.        els
+000400b0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+000400c0: 6574 7572 6e20 7b0a 2020 2020 2020 2020  eturn {.        
+000400d0: 2020 2020 2020 2020 773a 205b 7473 2e6b          w: [ts.k
+000400e0: 6579 2066 6f72 2074 7320 696e 2077 732e  ey for ts in ws.
+000400f0: 7072 6f63 6573 7369 6e67 5d20 666f 7220  processing] for 
+00040100: 772c 2077 7320 696e 2073 656c 662e 776f  w, ws in self.wo
+00040110: 726b 6572 732e 6974 656d 7328 290a 2020  rkers.items().  
+00040120: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
+00040130: 2064 6566 2067 6574 5f77 686f 5f68 6173   def get_who_has
+00040140: 2873 656c 662c 206b 6579 733a 2049 7465  (self, keys: Ite
+00040150: 7261 626c 655b 7374 725d 207c 204e 6f6e  rable[str] | Non
+00040160: 6520 3d20 4e6f 6e65 2920 2d3e 2064 6963  e = None) -> dic
+00040170: 745b 7374 722c 206c 6973 745b 7374 725d  t[str, list[str]
+00040180: 5d3a 0a20 2020 2020 2020 2069 6620 6b65  ]:.        if ke
+00040190: 7973 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ys is not None:.
+000401a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000401b0: 726e 207b 0a20 2020 2020 2020 2020 2020  rn {.           
+000401c0: 2020 2020 206b 6579 3a20 5b77 732e 6164       key: [ws.ad
+000401d0: 6472 6573 7320 666f 7220 7773 2069 6e20  dress for ws in 
+000401e0: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d2e  self.tasks[key].
+000401f0: 7768 6f5f 6861 735d 0a20 2020 2020 2020  who_has].       
+00040200: 2020 2020 2020 2020 2069 6620 6b65 7920           if key 
+00040210: 696e 2073 656c 662e 7461 736b 730a 2020  in self.tasks.  
+00040220: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00040230: 7365 205b 5d0a 2020 2020 2020 2020 2020  se [].          
+00040240: 2020 2020 2020 666f 7220 6b65 7920 696e        for key in
+00040250: 206b 6579 730a 2020 2020 2020 2020 2020   keys.          
+00040260: 2020 7d0a 2020 2020 2020 2020 656c 7365    }.        else
+00040270: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00040280: 7475 726e 207b 0a20 2020 2020 2020 2020  turn {.         
+00040290: 2020 2020 2020 206b 6579 3a20 5b77 732e         key: [ws.
+000402a0: 6164 6472 6573 7320 666f 7220 7773 2069  address for ws i
+000402b0: 6e20 7473 2e77 686f 5f68 6173 5d20 666f  n ts.who_has] fo
+000402c0: 7220 6b65 792c 2074 7320 696e 2073 656c  r key, ts in sel
+000402d0: 662e 7461 736b 732e 6974 656d 7328 290a  f.tasks.items().
+000402e0: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+000402f0: 2020 2064 6566 2067 6574 5f68 6173 5f77     def get_has_w
+00040300: 6861 7428 0a20 2020 2020 2020 2073 656c  hat(.        sel
+00040310: 662c 2077 6f72 6b65 7273 3a20 4974 6572  f, workers: Iter
+00040320: 6162 6c65 5b73 7472 5d20 7c20 4e6f 6e65  able[str] | None
+00040330: 203d 204e 6f6e 650a 2020 2020 2920 2d3e   = None.    ) ->
+00040340: 2064 6963 745b 7374 722c 206c 6973 745b   dict[str, list[
+00040350: 7374 725d 5d3a 0a20 2020 2020 2020 2069  str]]:.        i
+00040360: 6620 776f 726b 6572 7320 6973 206e 6f74  f workers is not
+00040370: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00040380: 2020 2077 6f72 6b65 7273 203d 206d 6170     workers = map
+00040390: 2873 656c 662e 636f 6572 6365 5f61 6464  (self.coerce_add
+000403a0: 7265 7373 2c20 776f 726b 6572 7329 0a20  ress, workers). 
+000403b0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000403c0: 6e20 7b0a 2020 2020 2020 2020 2020 2020  n {.            
+000403d0: 2020 2020 773a 205b 7473 2e6b 6579 2066      w: [ts.key f
+000403e0: 6f72 2074 7320 696e 2073 656c 662e 776f  or ts in self.wo
+000403f0: 726b 6572 735b 775d 2e68 6173 5f77 6861  rkers[w].has_wha
+00040400: 745d 0a20 2020 2020 2020 2020 2020 2020  t].             
+00040410: 2020 2069 6620 7720 696e 2073 656c 662e     if w in self.
+00040420: 776f 726b 6572 730a 2020 2020 2020 2020  workers.        
+00040430: 2020 2020 2020 2020 656c 7365 205b 5d0a          else [].
+00040440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040450: 666f 7220 7720 696e 2077 6f72 6b65 7273  for w in workers
+00040460: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+00040470: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00040480: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00040490: 7b77 3a20 5b74 732e 6b65 7920 666f 7220  {w: [ts.key for 
+000404a0: 7473 2069 6e20 7773 2e68 6173 5f77 6861  ts in ws.has_wha
+000404b0: 745d 2066 6f72 2077 2c20 7773 2069 6e20  t] for w, ws in 
+000404c0: 7365 6c66 2e77 6f72 6b65 7273 2e69 7465  self.workers.ite
+000404d0: 6d73 2829 7d0a 0a20 2020 2064 6566 2067  ms()}..    def g
+000404e0: 6574 5f6e 636f 7265 7328 7365 6c66 2c20  et_ncores(self, 
+000404f0: 776f 726b 6572 733a 2049 7465 7261 626c  workers: Iterabl
+00040500: 655b 7374 725d 207c 204e 6f6e 6520 3d20  e[str] | None = 
+00040510: 4e6f 6e65 2920 2d3e 2064 6963 745b 7374  None) -> dict[st
+00040520: 722c 2069 6e74 5d3a 0a20 2020 2020 2020  r, int]:.       
+00040530: 2069 6620 776f 726b 6572 7320 6973 206e   if workers is n
+00040540: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00040550: 2020 2020 2077 6f72 6b65 7273 203d 206d       workers = m
+00040560: 6170 2873 656c 662e 636f 6572 6365 5f61  ap(self.coerce_a
+00040570: 6464 7265 7373 2c20 776f 726b 6572 7329  ddress, workers)
+00040580: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00040590: 7572 6e20 7b77 3a20 7365 6c66 2e77 6f72  urn {w: self.wor
+000405a0: 6b65 7273 5b77 5d2e 6e74 6872 6561 6473  kers[w].nthreads
+000405b0: 2066 6f72 2077 2069 6e20 776f 726b 6572   for w in worker
+000405c0: 7320 6966 2077 2069 6e20 7365 6c66 2e77  s if w in self.w
+000405d0: 6f72 6b65 7273 7d0a 2020 2020 2020 2020  orkers}.        
+000405e0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000405f0: 2020 7265 7475 726e 207b 773a 2077 732e    return {w: ws.
+00040600: 6e74 6872 6561 6473 2066 6f72 2077 2c20  nthreads for w, 
+00040610: 7773 2069 6e20 7365 6c66 2e77 6f72 6b65  ws in self.worke
+00040620: 7273 2e69 7465 6d73 2829 7d0a 0a20 2020  rs.items()}..   
+00040630: 2064 6566 2067 6574 5f6e 636f 7265 735f   def get_ncores_
+00040640: 7275 6e6e 696e 6728 0a20 2020 2020 2020  running(.       
+00040650: 2073 656c 662c 2077 6f72 6b65 7273 3a20   self, workers: 
+00040660: 4974 6572 6162 6c65 5b73 7472 5d20 7c20  Iterable[str] | 
+00040670: 4e6f 6e65 203d 204e 6f6e 650a 2020 2020  None = None.    
+00040680: 2920 2d3e 2064 6963 745b 7374 722c 2069  ) -> dict[str, i
+00040690: 6e74 5d3a 0a20 2020 2020 2020 206e 636f  nt]:.        nco
+000406a0: 7265 7320 3d20 7365 6c66 2e67 6574 5f6e  res = self.get_n
+000406b0: 636f 7265 7328 776f 726b 6572 733d 776f  cores(workers=wo
+000406c0: 726b 6572 7329 0a20 2020 2020 2020 2072  rkers).        r
+000406d0: 6574 7572 6e20 7b0a 2020 2020 2020 2020  eturn {.        
+000406e0: 2020 2020 773a 206e 2066 6f72 2077 2c20      w: n for w, 
+000406f0: 6e20 696e 206e 636f 7265 732e 6974 656d  n in ncores.item
+00040700: 7328 2920 6966 2073 656c 662e 776f 726b  s() if self.work
+00040710: 6572 735b 775d 2e73 7461 7475 7320 3d3d  ers[w].status ==
+00040720: 2053 7461 7475 732e 7275 6e6e 696e 670a   Status.running.
+00040730: 2020 2020 2020 2020 7d0a 0a20 2020 2061          }..    a
+00040740: 7379 6e63 2064 6566 2067 6574 5f63 616c  sync def get_cal
+00040750: 6c5f 7374 6163 6b28 7365 6c66 2c20 6b65  l_stack(self, ke
+00040760: 7973 3a20 4974 6572 6162 6c65 5b73 7472  ys: Iterable[str
+00040770: 5d20 7c20 4e6f 6e65 203d 204e 6f6e 6529  ] | None = None)
+00040780: 202d 3e20 6469 6374 3a0a 2020 2020 2020   -> dict:.      
+00040790: 2020 776f 726b 6572 733a 2064 6963 745b    workers: dict[
+000407a0: 7374 722c 206c 6973 745b 7374 725d 207c  str, list[str] |
+000407b0: 204e 6f6e 655d 0a20 2020 2020 2020 2069   None].        i
+000407c0: 6620 6b65 7973 2069 7320 6e6f 7420 4e6f  f keys is not No
+000407d0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000407e0: 7374 6163 6b20 3d20 6c69 7374 286b 6579  stack = list(key
+000407f0: 7329 0a20 2020 2020 2020 2020 2020 2070  s).            p
+00040800: 726f 6365 7373 696e 6720 3d20 7365 7428  rocessing = set(
+00040810: 290a 2020 2020 2020 2020 2020 2020 7768  ).            wh
+00040820: 696c 6520 7374 6163 6b3a 0a20 2020 2020  ile stack:.     
+00040830: 2020 2020 2020 2020 2020 206b 6579 203d             key =
+00040840: 2073 7461 636b 2e70 6f70 2829 0a20 2020   stack.pop().   
+00040850: 2020 2020 2020 2020 2020 2020 2074 7320               ts 
+00040860: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
+00040870: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00040880: 2020 6966 2074 732e 7374 6174 6520 3d3d    if ts.state ==
+00040890: 2022 7761 6974 696e 6722 3a0a 2020 2020   "waiting":.    
+000408a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000408b0: 7374 6163 6b2e 6578 7465 6e64 285b 6474  stack.extend([dt
+000408c0: 732e 6b65 7920 666f 7220 6474 7320 696e  s.key for dts in
+000408d0: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
+000408e0: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+000408f0: 2020 2065 6c69 6620 7473 2e73 7461 7465     elif ts.state
+00040900: 203d 3d20 2270 726f 6365 7373 696e 6722   == "processing"
+00040910: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00040920: 2020 2020 2020 7072 6f63 6573 7369 6e67        processing
+00040930: 2e61 6464 2874 7329 0a0a 2020 2020 2020  .add(ts)..      
+00040940: 2020 2020 2020 776f 726b 6572 7320 3d20        workers = 
+00040950: 6465 6661 756c 7464 6963 7428 6c69 7374  defaultdict(list
+00040960: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+00040970: 7220 7473 2069 6e20 7072 6f63 6573 7369  r ts in processi
+00040980: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
+00040990: 2020 2020 6966 2074 732e 7072 6f63 6573      if ts.proces
+000409a0: 7369 6e67 5f6f 6e3a 0a20 2020 2020 2020  sing_on:.       
+000409b0: 2020 2020 2020 2020 2020 2020 2077 6b65               wke
+000409c0: 7973 203d 2077 6f72 6b65 7273 5b74 732e  ys = workers[ts.
+000409d0: 7072 6f63 6573 7369 6e67 5f6f 6e2e 6164  processing_on.ad
+000409e0: 6472 6573 735d 0a20 2020 2020 2020 2020  dress].         
+000409f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00040a00: 7420 776b 6579 7320 6973 206e 6f74 204e  t wkeys is not N
+00040a10: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+00040a20: 2020 2020 2020 2020 776b 6579 732e 6170          wkeys.ap
+00040a30: 7065 6e64 2874 732e 6b65 7929 0a20 2020  pend(ts.key).   
+00040a40: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00040a50: 2020 2020 2020 2077 6f72 6b65 7273 203d         workers =
+00040a60: 207b 773a 204e 6f6e 6520 666f 7220 7720   {w: None for w 
+00040a70: 696e 2073 656c 662e 776f 726b 6572 737d  in self.workers}
+00040a80: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+00040a90: 2077 6f72 6b65 7273 3a0a 2020 2020 2020   workers:.      
+00040aa0: 2020 2020 2020 7265 7475 726e 207b 7d0a        return {}.
+00040ab0: 0a20 2020 2020 2020 2072 6573 756c 7473  .        results
+00040ac0: 203d 2061 7761 6974 2061 7379 6e63 696f   = await asyncio
+00040ad0: 2e67 6174 6865 7228 0a20 2020 2020 2020  .gather(.       
+00040ae0: 2020 2020 202a 2873 656c 662e 7270 6328       *(self.rpc(
+00040af0: 7729 2e63 616c 6c5f 7374 6163 6b28 6b65  w).call_stack(ke
+00040b00: 7973 3d76 2920 666f 7220 772c 2076 2069  ys=v) for w, v i
+00040b10: 6e20 776f 726b 6572 732e 6974 656d 7328  n workers.items(
+00040b20: 2929 0a20 2020 2020 2020 2029 0a20 2020  )).        ).   
+00040b30: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
+00040b40: 7b77 3a20 7220 666f 7220 772c 2072 2069  {w: r for w, r i
+00040b50: 6e20 7a69 7028 776f 726b 6572 732c 2072  n zip(workers, r
+00040b60: 6573 756c 7473 2920 6966 2072 7d0a 2020  esults) if r}.  
+00040b70: 2020 2020 2020 7265 7475 726e 2072 6573        return res
+00040b80: 706f 6e73 650a 0a20 2020 2061 7379 6e63  ponse..    async
+00040b90: 2064 6566 2062 656e 6368 6d61 726b 5f68   def benchmark_h
+00040ba0: 6172 6477 6172 6528 7365 6c66 2920 2d3e  ardware(self) ->
+00040bb0: 2022 6469 6374 5b73 7472 2c20 6469 6374   "dict[str, dict
+00040bc0: 5b73 7472 2c20 666c 6f61 745d 5d22 3a0a  [str, float]]":.
+00040bd0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00040be0: 2020 2020 5275 6e20 6120 6265 6e63 686d      Run a benchm
+00040bf0: 6172 6b20 6f6e 2074 6865 2077 6f72 6b65  ark on the worke
+00040c00: 7273 2066 6f72 206d 656d 6f72 792c 2064  rs for memory, d
+00040c10: 6973 6b2c 2061 6e64 206e 6574 776f 726b  isk, and network
+00040c20: 2062 616e 6477 6964 7468 730a 0a20 2020   bandwidths..   
+00040c30: 2020 2020 2052 6574 7572 6e73 0a20 2020       Returns.   
+00040c40: 2020 2020 202d 2d2d 2d2d 2d2d 0a20 2020       -------.   
+00040c50: 2020 2020 2072 6573 756c 743a 2064 6963       result: dic
+00040c60: 740a 2020 2020 2020 2020 2020 2020 4120  t.            A 
+00040c70: 6469 6374 696f 6e61 7279 206d 6170 7069  dictionary mappi
+00040c80: 6e67 2074 6865 206e 616d 6573 2022 6469  ng the names "di
+00040c90: 736b 222c 2022 6d65 6d6f 7279 222c 2061  sk", "memory", a
+00040ca0: 6e64 2022 6e65 7477 6f72 6b22 2074 6f0a  nd "network" to.
+00040cb0: 2020 2020 2020 2020 2020 2020 6469 6374              dict
+00040cc0: 696f 6e61 7269 6573 206d 6170 7069 6e67  ionaries mapping
+00040cd0: 2073 697a 6573 2074 6f20 6261 6e64 7769   sizes to bandwi
+00040ce0: 6474 6873 2e20 2054 6865 7365 2062 616e  dths.  These ban
+00040cf0: 6477 6964 7468 7320 6172 650a 2020 2020  dwidths are.    
+00040d00: 2020 2020 2020 2020 6176 6572 6167 6564          averaged
+00040d10: 206f 7665 7220 6d61 6e79 2077 6f72 6b65   over many worke
+00040d20: 7273 2072 756e 6e69 6e67 2063 6f6d 7075  rs running compu
+00040d30: 7461 7469 6f6e 7320 6163 726f 7373 2074  tations across t
+00040d40: 6865 2063 6c75 7374 6572 2e0a 2020 2020  he cluster..    
+00040d50: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00040d60: 6f75 743a 2064 6963 745b 7374 722c 2064  out: dict[str, d
+00040d70: 6566 6175 6c74 6469 6374 5b73 7472 2c20  efaultdict[str, 
+00040d80: 6c69 7374 5b66 6c6f 6174 5d5d 5d20 3d20  list[float]]] = 
+00040d90: 7b0a 2020 2020 2020 2020 2020 2020 6e61  {.            na
+00040da0: 6d65 3a20 6465 6661 756c 7464 6963 7428  me: defaultdict(
+00040db0: 6c69 7374 2920 666f 7220 6e61 6d65 2069  list) for name i
+00040dc0: 6e20 5b22 6469 736b 222c 2022 6d65 6d6f  n ["disk", "memo
+00040dd0: 7279 222c 2022 6e65 7477 6f72 6b22 5d0a  ry", "network"].
+00040de0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00040df0: 2020 2023 2064 6973 6b0a 2020 2020 2020     # disk.      
+00040e00: 2020 7265 7375 6c74 203d 2061 7761 6974    result = await
+00040e10: 2073 656c 662e 6272 6f61 6463 6173 7428   self.broadcast(
+00040e20: 6d73 673d 7b22 6f70 223a 2022 6265 6e63  msg={"op": "benc
+00040e30: 686d 6172 6b5f 6469 736b 227d 290a 2020  hmark_disk"}).  
+00040e40: 2020 2020 2020 666f 7220 6420 696e 2072        for d in r
+00040e50: 6573 756c 742e 7661 6c75 6573 2829 3a0a  esult.values():.
+00040e60: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00040e70: 7369 7a65 2c20 6475 7261 7469 6f6e 2069  size, duration i
+00040e80: 6e20 642e 6974 656d 7328 293a 0a20 2020  n d.items():.   
+00040e90: 2020 2020 2020 2020 2020 2020 206f 7574               out
+00040ea0: 5b22 6469 736b 225d 5b73 697a 655d 2e61  ["disk"][size].a
+00040eb0: 7070 656e 6428 6475 7261 7469 6f6e 290a  ppend(duration).
+00040ec0: 0a20 2020 2020 2020 2023 206d 656d 6f72  .        # memor
+00040ed0: 790a 2020 2020 2020 2020 7265 7375 6c74  y.        result
+00040ee0: 203d 2061 7761 6974 2073 656c 662e 6272   = await self.br
+00040ef0: 6f61 6463 6173 7428 6d73 673d 7b22 6f70  oadcast(msg={"op
+00040f00: 223a 2022 6265 6e63 686d 6172 6b5f 6d65  ": "benchmark_me
+00040f10: 6d6f 7279 227d 290a 2020 2020 2020 2020  mory"}).        
+00040f20: 666f 7220 6420 696e 2072 6573 756c 742e  for d in result.
+00040f30: 7661 6c75 6573 2829 3a0a 2020 2020 2020  values():.      
+00040f40: 2020 2020 2020 666f 7220 7369 7a65 2c20        for size, 
+00040f50: 6475 7261 7469 6f6e 2069 6e20 642e 6974  duration in d.it
+00040f60: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
+00040f70: 2020 2020 2020 206f 7574 5b22 6d65 6d6f         out["memo
+00040f80: 7279 225d 5b73 697a 655d 2e61 7070 656e  ry"][size].appen
+00040f90: 6428 6475 7261 7469 6f6e 290a 0a20 2020  d(duration)..   
+00040fa0: 2020 2020 2023 206e 6574 776f 726b 0a20       # network. 
+00040fb0: 2020 2020 2020 2077 6f72 6b65 7273 203d         workers =
+00040fc0: 206c 6973 7428 7365 6c66 2e77 6f72 6b65   list(self.worke
+00040fd0: 7273 290a 2020 2020 2020 2020 2320 4f6e  rs).        # On
+00040fe0: 2061 6e20 6164 6170 7469 7665 2063 6c75   an adaptive clu
+00040ff0: 7374 6572 2c20 6966 206d 756c 7469 706c  ster, if multipl
+00041000: 6520 776f 726b 6572 7320 6172 6520 7374  e workers are st
+00041010: 6172 7465 6420 6f6e 2074 6865 2073 616d  arted on the sam
+00041020: 6520 7068 7973 6963 616c 2068 6f73 742c  e physical host,
+00041030: 0a20 2020 2020 2020 2023 2074 6865 7920  .        # they 
+00041040: 6172 6520 6d6f 7265 206c 696b 656c 7920  are more likely 
+00041050: 746f 2063 6f6e 6e65 6374 2074 6f20 7468  to connect to th
+00041060: 6520 5363 6865 6475 6c65 7220 696e 2073  e Scheduler in s
+00041070: 6571 7565 6e63 652c 2065 6e64 696e 6720  equence, ending 
+00041080: 7570 206e 6578 7420 746f 0a20 2020 2020  up next to.     
+00041090: 2020 2023 2065 6163 6820 6f74 6865 7220     # each other 
+000410a0: 696e 2074 6869 7320 6c69 7374 2e0a 2020  in this list..  
+000410b0: 2020 2020 2020 2320 5468 6520 7472 616e        # The tran
+000410c0: 7366 6572 2073 7065 6564 2077 6974 6869  sfer speed withi
+000410d0: 6e20 7375 6368 2063 6c75 7374 6572 7320  n such clusters 
+000410e0: 6f66 2077 6f72 6b65 7273 2077 696c 6c20  of workers will 
+000410f0: 6265 2065 6666 6563 7469 7665 6c79 2074  be effectively t
+00041100: 6861 7420 6f66 0a20 2020 2020 2020 2023  hat of.        #
+00041110: 206c 6f63 616c 686f 7374 2e20 5468 6973   localhost. This
+00041120: 2063 6f75 6c64 2068 6170 7065 6e20 6163   could happen ac
+00041130: 726f 7373 2064 6966 6665 7265 6e74 2056  ross different V
+00041140: 4d73 2061 6e64 2f6f 7220 646f 636b 6572  Ms and/or docker
+00041150: 2069 6d61 6765 732c 2073 6f0a 2020 2020   images, so.    
+00041160: 2020 2020 2320 696d 706c 656d 656e 7469      # implementi
+00041170: 6e67 206c 6f67 6963 2062 6173 6564 206f  ng logic based o
+00041180: 6e20 4950 2061 6464 7265 7373 6573 2077  n IP addresses w
+00041190: 6f75 6c64 206e 6f74 206e 6563 6573 7361  ould not necessa
+000411a0: 7269 6c79 2068 656c 702e 0a20 2020 2020  rily help..     
+000411b0: 2020 2023 2052 616e 646f 6d69 7a65 2074     # Randomize t
+000411c0: 6865 2063 6f6e 6e65 6374 696f 6e73 2074  he connections t
+000411d0: 6f20 6576 656e 206f 7574 2074 6865 206d  o even out the m
+000411e0: 6561 6e20 6d65 6173 7572 6573 2e0a 2020  ean measures..  
+000411f0: 2020 2020 2020 7261 6e64 6f6d 2e73 6875        random.shu
+00041200: 6666 6c65 2877 6f72 6b65 7273 290a 2020  ffle(workers).  
+00041210: 2020 2020 2020 6675 7475 7265 7320 3d20        futures = 
+00041220: 5b0a 2020 2020 2020 2020 2020 2020 7365  [.            se
+00041230: 6c66 2e72 7063 2861 292e 6265 6e63 686d  lf.rpc(a).benchm
+00041240: 6172 6b5f 6e65 7477 6f72 6b28 6164 6472  ark_network(addr
+00041250: 6573 733d 6229 2066 6f72 2061 2c20 6220  ess=b) for a, b 
+00041260: 696e 2070 6172 7469 7469 6f6e 2832 2c20  in partition(2, 
+00041270: 776f 726b 6572 7329 0a20 2020 2020 2020  workers).       
+00041280: 205d 0a20 2020 2020 2020 2072 6573 706f   ].        respo
+00041290: 6e73 6573 203d 2061 7761 6974 2061 7379  nses = await asy
+000412a0: 6e63 696f 2e67 6174 6865 7228 2a66 7574  ncio.gather(*fut
+000412b0: 7572 6573 290a 0a20 2020 2020 2020 2066  ures)..        f
+000412c0: 6f72 2064 2069 6e20 7265 7370 6f6e 7365  or d in response
+000412d0: 733a 0a20 2020 2020 2020 2020 2020 2066  s:.            f
+000412e0: 6f72 2073 697a 652c 2064 7572 6174 696f  or size, duratio
+000412f0: 6e20 696e 2064 2e69 7465 6d73 2829 3a0a  n in d.items():.
+00041300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041310: 6f75 745b 226e 6574 776f 726b 225d 5b73  out["network"][s
+00041320: 697a 655d 2e61 7070 656e 6428 6475 7261  ize].append(dura
+00041330: 7469 6f6e 290a 0a20 2020 2020 2020 2072  tion)..        r
+00041340: 6573 756c 7420 3d20 7b7d 0a20 2020 2020  esult = {}.     
+00041350: 2020 2066 6f72 206d 6f64 6520 696e 206f     for mode in o
+00041360: 7574 3a0a 2020 2020 2020 2020 2020 2020  ut:.            
+00041370: 7265 7375 6c74 5b6d 6f64 655d 203d 207b  result[mode] = {
+00041380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00041390: 2073 697a 653a 2073 756d 2864 7572 6174   size: sum(durat
+000413a0: 696f 6e73 2920 2f20 6c65 6e28 6475 7261  ions) / len(dura
+000413b0: 7469 6f6e 7329 0a20 2020 2020 2020 2020  tions).         
+000413c0: 2020 2020 2020 2066 6f72 2073 697a 652c         for size,
+000413d0: 2064 7572 6174 696f 6e73 2069 6e20 6f75   durations in ou
+000413e0: 745b 6d6f 6465 5d2e 6974 656d 7328 290a  t[mode].items().
+000413f0: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+00041400: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+00041410: 7375 6c74 0a0a 2020 2020 406c 6f67 5f65  sult..    @log_e
+00041420: 7272 6f72 730a 2020 2020 6465 6620 6765  rrors.    def ge
+00041430: 745f 6e62 7974 6573 280a 2020 2020 2020  t_nbytes(.      
+00041440: 2020 7365 6c66 2c20 6b65 7973 3a20 4974    self, keys: It
+00041450: 6572 6162 6c65 5b73 7472 5d20 7c20 4e6f  erable[str] | No
+00041460: 6e65 203d 204e 6f6e 652c 2073 756d 6d61  ne = None, summa
+00041470: 7279 3a20 626f 6f6c 203d 2054 7275 650a  ry: bool = True.
+00041480: 2020 2020 2920 2d3e 2064 6963 745b 7374      ) -> dict[st
+00041490: 722c 2069 6e74 5d3a 0a20 2020 2020 2020  r, int]:.       
+000414a0: 2069 6620 6b65 7973 2069 7320 6e6f 7420   if keys is not 
+000414b0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+000414c0: 2020 7265 7375 6c74 203d 207b 6b3a 2073    result = {k: s
+000414d0: 656c 662e 7461 736b 735b 6b5d 2e6e 6279  elf.tasks[k].nby
+000414e0: 7465 7320 666f 7220 6b20 696e 206b 6579  tes for k in key
+000414f0: 737d 0a20 2020 2020 2020 2065 6c73 653a  s}.        else:
+00041500: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+00041510: 756c 7420 3d20 7b6b 3a20 7473 2e6e 6279  ult = {k: ts.nby
+00041520: 7465 7320 666f 7220 6b2c 2074 7320 696e  tes for k, ts in
+00041530: 2073 656c 662e 7461 736b 732e 6974 656d   self.tasks.item
+00041540: 7328 2920 6966 2074 732e 6e62 7974 6573  s() if ts.nbytes
+00041550: 203e 3d20 307d 0a0a 2020 2020 2020 2020   >= 0}..        
+00041560: 6966 2073 756d 6d61 7279 3a0a 2020 2020  if summary:.    
+00041570: 2020 2020 2020 2020 6f75 743a 2064 6566          out: def
+00041580: 6175 6c74 6469 6374 5b73 7472 2c20 696e  aultdict[str, in
+00041590: 745d 203d 2064 6566 6175 6c74 6469 6374  t] = defaultdict
+000415a0: 286c 616d 6264 613a 2030 290a 2020 2020  (lambda: 0).    
+000415b0: 2020 2020 2020 2020 666f 7220 6b2c 2076          for k, v
+000415c0: 2069 6e20 7265 7375 6c74 2e69 7465 6d73   in result.items
+000415d0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+000415e0: 2020 2020 6f75 745b 6b65 795f 7370 6c69      out[key_spli
+000415f0: 7428 6b29 5d20 2b3d 2076 0a20 2020 2020  t(k)] += v.     
+00041600: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+00041610: 6469 6374 286f 7574 290a 0a20 2020 2020  dict(out)..     
+00041620: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+00041630: 0a0a 2020 2020 6465 6620 7275 6e5f 6675  ..    def run_fu
+00041640: 6e63 7469 6f6e 280a 2020 2020 2020 2020  nction(.        
+00041650: 7365 6c66 2c0a 2020 2020 2020 2020 636f  self,.        co
+00041660: 6d6d 3a20 436f 6d6d 2c0a 2020 2020 2020  mm: Comm,.      
+00041670: 2020 6675 6e63 7469 6f6e 3a20 4361 6c6c    function: Call
+00041680: 6162 6c65 2c0a 2020 2020 2020 2020 6172  able,.        ar
+00041690: 6773 3a20 7475 706c 6520 3d20 2829 2c0a  gs: tuple = (),.
+000416a0: 2020 2020 2020 2020 6b77 6172 6773 3a20          kwargs: 
+000416b0: 6469 6374 207c 204e 6f6e 6520 3d20 4e6f  dict | None = No
+000416c0: 6e65 2c0a 2020 2020 2020 2020 7761 6974  ne,.        wait
+000416d0: 3a20 626f 6f6c 203d 2054 7275 652c 0a20  : bool = True,. 
+000416e0: 2020 2029 202d 3e20 416e 793a 0a20 2020     ) -> Any:.   
+000416f0: 2020 2020 2022 2222 5275 6e20 6120 6675       """Run a fu
+00041700: 6e63 7469 6f6e 2077 6974 6869 6e20 7468  nction within th
+00041710: 6973 2070 726f 6365 7373 0a0a 2020 2020  is process..    
+00041720: 2020 2020 5365 6520 416c 736f 0a20 2020      See Also.   
+00041730: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 2020       --------.  
+00041740: 2020 2020 2020 436c 6965 6e74 2e72 756e        Client.run
+00041750: 5f6f 6e5f 7363 6865 6475 6c65 720a 2020  _on_scheduler.  
+00041760: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00041770: 2020 6672 6f6d 2064 6973 7472 6962 7574    from distribut
+00041780: 6564 2e77 6f72 6b65 7220 696d 706f 7274  ed.worker import
+00041790: 2072 756e 0a0a 2020 2020 2020 2020 6966   run..        if
+000417a0: 206e 6f74 2064 6173 6b2e 636f 6e66 6967   not dask.config
+000417b0: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
+000417c0: 642e 7363 6865 6475 6c65 722e 7069 636b  d.scheduler.pick
+000417d0: 6c65 2229 3a0a 2020 2020 2020 2020 2020  le"):.          
+000417e0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+000417f0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00041800: 2020 2020 2243 616e 6e6f 7420 7275 6e20      "Cannot run 
+00041810: 6675 6e63 7469 6f6e 2061 7320 7468 6520  function as the 
+00041820: 7363 6865 6475 6c65 7220 6861 7320 6265  scheduler has be
+00041830: 656e 2065 7870 6c69 6369 746c 7920 6469  en explicitly di
+00041840: 7361 6c6c 6f77 6564 2066 726f 6d20 220a  sallowed from ".
+00041850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041860: 2264 6573 6572 6961 6c69 7a69 6e67 2061  "deserializing a
+00041870: 7262 6974 7261 7279 2062 7974 6573 7472  rbitrary bytestr
+00041880: 696e 6773 2075 7369 6e67 2070 6963 6b6c  ings using pickl
+00041890: 6520 7669 6120 7468 6520 220a 2020 2020  e via the ".    
+000418a0: 2020 2020 2020 2020 2020 2020 2227 6469              "'di
+000418b0: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
+000418c0: 6c65 722e 7069 636b 6c65 2720 636f 6e66  ler.pickle' conf
+000418d0: 6967 7572 6174 696f 6e20 7365 7474 696e  iguration settin
+000418e0: 672e 220a 2020 2020 2020 2020 2020 2020  g.".            
+000418f0: 290a 2020 2020 2020 2020 6b77 6172 6773  ).        kwargs
+00041900: 203d 206b 7761 7267 7320 6f72 207b 7d0a   = kwargs or {}.
+00041910: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+00041920: 5f65 7665 6e74 2822 616c 6c22 2c20 7b22  _event("all", {"
+00041930: 6163 7469 6f6e 223a 2022 7275 6e2d 6675  action": "run-fu
+00041940: 6e63 7469 6f6e 222c 2022 6675 6e63 7469  nction", "functi
+00041950: 6f6e 223a 2066 756e 6374 696f 6e7d 290a  on": function}).
+00041960: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+00041970: 756e 2873 656c 662c 2063 6f6d 6d2c 2066  un(self, comm, f
+00041980: 756e 6374 696f 6e3d 6675 6e63 7469 6f6e  unction=function
+00041990: 2c20 6172 6773 3d61 7267 732c 206b 7761  , args=args, kwa
+000419a0: 7267 733d 6b77 6172 6773 2c20 7761 6974  rgs=kwargs, wait
+000419b0: 3d77 6169 7429 0a0a 2020 2020 6465 6620  =wait)..    def 
+000419c0: 7365 745f 6d65 7461 6461 7461 2873 656c  set_metadata(sel
+000419d0: 662c 206b 6579 733a 206c 6973 745b 7374  f, keys: list[st
+000419e0: 725d 2c20 7661 6c75 653a 206f 626a 6563  r], value: objec
+000419f0: 7420 3d20 4e6f 6e65 2920 2d3e 204e 6f6e  t = None) -> Non
+00041a00: 653a 0a20 2020 2020 2020 206d 6574 6164  e:.        metad
+00041a10: 6174 6120 3d20 7365 6c66 2e74 6173 6b5f  ata = self.task_
+00041a20: 6d65 7461 6461 7461 0a20 2020 2020 2020  metadata.       
+00041a30: 2066 6f72 206b 6579 2069 6e20 6b65 7973   for key in keys
+00041a40: 5b3a 2d31 5d3a 0a20 2020 2020 2020 2020  [:-1]:.         
+00041a50: 2020 2069 6620 6b65 7920 6e6f 7420 696e     if key not in
+00041a60: 206d 6574 6164 6174 6120 6f72 206e 6f74   metadata or not
+00041a70: 2069 7369 6e73 7461 6e63 6528 6d65 7461   isinstance(meta
+00041a80: 6461 7461 5b6b 6579 5d2c 2028 6469 6374  data[key], (dict
+00041a90: 2c20 6c69 7374 2929 3a0a 2020 2020 2020  , list)):.      
+00041aa0: 2020 2020 2020 2020 2020 6d65 7461 6461            metada
+00041ab0: 7461 5b6b 6579 5d20 3d20 7b7d 0a20 2020  ta[key] = {}.   
+00041ac0: 2020 2020 2020 2020 206d 6574 6164 6174           metadat
+00041ad0: 6120 3d20 6d65 7461 6461 7461 5b6b 6579  a = metadata[key
+00041ae0: 5d0a 2020 2020 2020 2020 6d65 7461 6461  ].        metada
+00041af0: 7461 5b6b 6579 735b 2d31 5d5d 203d 2076  ta[keys[-1]] = v
+00041b00: 616c 7565 0a0a 2020 2020 6465 6620 6765  alue..    def ge
+00041b10: 745f 6d65 7461 6461 7461 2873 656c 662c  t_metadata(self,
+00041b20: 206b 6579 733a 206c 6973 745b 7374 725d   keys: list[str]
+00041b30: 2c20 6465 6661 756c 743a 2041 6e79 203d  , default: Any =
+00041b40: 206e 6f5f 6465 6661 756c 7429 202d 3e20   no_default) -> 
+00041b50: 416e 793a 0a20 2020 2020 2020 206d 6574  Any:.        met
+00041b60: 6164 6174 6120 3d20 7365 6c66 2e74 6173  adata = self.tas
+00041b70: 6b5f 6d65 7461 6461 7461 0a20 2020 2020  k_metadata.     
+00041b80: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00041b90: 2020 2020 666f 7220 6b65 7920 696e 206b      for key in k
+00041ba0: 6579 733a 0a20 2020 2020 2020 2020 2020  eys:.           
+00041bb0: 2020 2020 206d 6574 6164 6174 6120 3d20       metadata = 
+00041bc0: 6d65 7461 6461 7461 5b6b 6579 5d0a 2020  metadata[key].  
+00041bd0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00041be0: 206d 6574 6164 6174 610a 2020 2020 2020   metadata.      
+00041bf0: 2020 6578 6365 7074 204b 6579 4572 726f    except KeyErro
+00041c00: 723a 0a20 2020 2020 2020 2020 2020 2069  r:.            i
+00041c10: 6620 6465 6661 756c 7420 213d 206e 6f5f  f default != no_
+00041c20: 6465 6661 756c 743a 0a20 2020 2020 2020  default:.       
+00041c30: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00041c40: 6465 6661 756c 740a 2020 2020 2020 2020  default.        
+00041c50: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00041c60: 2020 2020 2020 2020 2020 7261 6973 650a            raise.
+00041c70: 0a20 2020 2064 6566 2073 6574 5f72 6573  .    def set_res
+00041c80: 7472 6963 7469 6f6e 7328 7365 6c66 2c20  trictions(self, 
+00041c90: 776f 726b 6572 3a20 6469 6374 5b73 7472  worker: dict[str
+00041ca0: 2c20 436f 6c6c 6563 7469 6f6e 5b73 7472  , Collection[str
+00041cb0: 5d20 7c20 7374 725d 2920 2d3e 204e 6f6e  ] | str]) -> Non
+00041cc0: 653a 0a20 2020 2020 2020 2066 6f72 206b  e:.        for k
+00041cd0: 6579 2c20 7265 7374 7269 6374 696f 6e73  ey, restrictions
+00041ce0: 2069 6e20 776f 726b 6572 2e69 7465 6d73   in worker.items
+00041cf0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00041d00: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
+00041d10: 6b65 795d 0a20 2020 2020 2020 2020 2020  key].           
+00041d20: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
+00041d30: 6573 7472 6963 7469 6f6e 732c 2073 7472  estrictions, str
+00041d40: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00041d50: 2020 2072 6573 7472 6963 7469 6f6e 7320     restrictions 
+00041d60: 3d20 7b72 6573 7472 6963 7469 6f6e 737d  = {restrictions}
+00041d70: 0a20 2020 2020 2020 2020 2020 2074 732e  .            ts.
+00041d80: 776f 726b 6572 5f72 6573 7472 6963 7469  worker_restricti
+00041d90: 6f6e 7320 3d20 7365 7428 7265 7374 7269  ons = set(restri
+00041da0: 6374 696f 6e73 290a 0a20 2020 2040 6c6f  ctions)..    @lo
+00041db0: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
+00041dc0: 2067 6574 5f74 6173 6b5f 7072 6566 6978   get_task_prefix
+00041dd0: 5f73 7461 7465 7328 7365 6c66 2920 2d3e  _states(self) ->
+00041de0: 2064 6963 745b 7374 722c 2064 6963 745b   dict[str, dict[
+00041df0: 7374 722c 2069 6e74 5d5d 3a0a 2020 2020  str, int]]:.    
+00041e00: 2020 2020 7374 6174 6520 3d20 7b7d 0a0a      state = {}..
+00041e10: 2020 2020 2020 2020 666f 7220 7470 2069          for tp i
+00041e20: 6e20 7365 6c66 2e74 6173 6b5f 7072 6566  n self.task_pref
+00041e30: 6978 6573 2e76 616c 7565 7328 293a 0a20  ixes.values():. 
+00041e40: 2020 2020 2020 2020 2020 2061 6374 6976             activ
+00041e50: 655f 7374 6174 6573 203d 2074 702e 6163  e_states = tp.ac
+00041e60: 7469 7665 5f73 7461 7465 730a 2020 2020  tive_states.    
+00041e70: 2020 2020 2020 2020 6966 2061 6e79 280a          if any(.
+00041e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041e90: 6163 7469 7665 5f73 7461 7465 732e 6765  active_states.ge
+00041ea0: 7428 7329 0a20 2020 2020 2020 2020 2020  t(s).           
+00041eb0: 2020 2020 2066 6f72 2073 2069 6e20 7b22       for s in {"
+00041ec0: 6d65 6d6f 7279 222c 2022 6572 7265 6422  memory", "erred"
+00041ed0: 2c20 2272 656c 6561 7365 6422 2c20 2270  , "released", "p
+00041ee0: 726f 6365 7373 696e 6722 2c20 2277 6169  rocessing", "wai
+00041ef0: 7469 6e67 227d 0a20 2020 2020 2020 2020  ting"}.         
+00041f00: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
+00041f10: 2020 2020 2020 7374 6174 655b 7470 2e6e        state[tp.n
+00041f20: 616d 655d 203d 207b 0a20 2020 2020 2020  ame] = {.       
+00041f30: 2020 2020 2020 2020 2020 2020 2022 6d65               "me
+00041f40: 6d6f 7279 223a 2061 6374 6976 655f 7374  mory": active_st
+00041f50: 6174 6573 5b22 6d65 6d6f 7279 225d 2c0a  ates["memory"],.
+00041f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041f70: 2020 2020 2265 7272 6564 223a 2061 6374      "erred": act
+00041f80: 6976 655f 7374 6174 6573 5b22 6572 7265  ive_states["erre
+00041f90: 6422 5d2c 0a20 2020 2020 2020 2020 2020  d"],.           
+00041fa0: 2020 2020 2020 2020 2022 7265 6c65 6173           "releas
+00041fb0: 6564 223a 2061 6374 6976 655f 7374 6174  ed": active_stat
+00041fc0: 6573 5b22 7265 6c65 6173 6564 225d 2c0a  es["released"],.
+00041fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041fe0: 2020 2020 2270 726f 6365 7373 696e 6722      "processing"
+00041ff0: 3a20 6163 7469 7665 5f73 7461 7465 735b  : active_states[
+00042000: 2270 726f 6365 7373 696e 6722 5d2c 0a20  "processing"],. 
+00042010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042020: 2020 2022 7761 6974 696e 6722 3a20 6163     "waiting": ac
+00042030: 7469 7665 5f73 7461 7465 735b 2277 6169  tive_states["wai
+00042040: 7469 6e67 225d 2c0a 2020 2020 2020 2020  ting"],.        
+00042050: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00042060: 2020 2072 6574 7572 6e20 7374 6174 650a     return state.
+00042070: 0a20 2020 2064 6566 2067 6574 5f74 6173  .    def get_tas
+00042080: 6b5f 7374 6174 7573 2873 656c 662c 206b  k_status(self, k
+00042090: 6579 733a 2049 7465 7261 626c 655b 7374  eys: Iterable[st
+000420a0: 725d 2920 2d3e 2064 6963 745b 7374 722c  r]) -> dict[str,
+000420b0: 2054 6173 6b53 7461 7465 5374 6174 6520   TaskStateState 
+000420c0: 7c20 4e6f 6e65 5d3a 0a20 2020 2020 2020  | None]:.       
+000420d0: 2072 6574 7572 6e20 7b0a 2020 2020 2020   return {.      
+000420e0: 2020 2020 2020 6b65 793a 2028 7365 6c66        key: (self
+000420f0: 2e74 6173 6b73 5b6b 6579 5d2e 7374 6174  .tasks[key].stat
+00042100: 6520 6966 206b 6579 2069 6e20 7365 6c66  e if key in self
+00042110: 2e74 6173 6b73 2065 6c73 6520 4e6f 6e65  .tasks else None
+00042120: 2920 666f 7220 6b65 7920 696e 206b 6579  ) for key in key
+00042130: 730a 2020 2020 2020 2020 7d0a 0a20 2020  s.        }..   
+00042140: 2064 6566 2067 6574 5f74 6173 6b5f 7374   def get_task_st
+00042150: 7265 616d 280a 2020 2020 2020 2020 7365  ream(.        se
+00042160: 6c66 2c0a 2020 2020 2020 2020 7374 6172  lf,.        star
+00042170: 743a 2073 7472 207c 2066 6c6f 6174 207c  t: str | float |
+00042180: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+00042190: 2020 2020 2020 7374 6f70 3a20 7374 7220        stop: str 
+000421a0: 7c20 666c 6f61 7420 7c20 4e6f 6e65 203d  | float | None =
+000421b0: 204e 6f6e 652c 0a20 2020 2020 2020 2063   None,.        c
+000421c0: 6f75 6e74 3a20 696e 7420 7c20 4e6f 6e65  ount: int | None
+000421d0: 203d 204e 6f6e 652c 0a20 2020 2029 202d   = None,.    ) -
+000421e0: 3e20 6c69 7374 3a0a 2020 2020 2020 2020  > list:.        
+000421f0: 6672 6f6d 2064 6973 7472 6962 7574 6564  from distributed
+00042200: 2e64 6961 676e 6f73 7469 6373 2e74 6173  .diagnostics.tas
+00042210: 6b5f 7374 7265 616d 2069 6d70 6f72 7420  k_stream import 
+00042220: 5461 736b 5374 7265 616d 506c 7567 696e  TaskStreamPlugin
+00042230: 0a0a 2020 2020 2020 2020 6966 2054 6173  ..        if Tas
+00042240: 6b53 7472 6561 6d50 6c75 6769 6e2e 6e61  kStreamPlugin.na
+00042250: 6d65 206e 6f74 2069 6e20 7365 6c66 2e70  me not in self.p
+00042260: 6c75 6769 6e73 3a0a 2020 2020 2020 2020  lugins:.        
+00042270: 2020 2020 7365 6c66 2e61 6464 5f70 6c75      self.add_plu
+00042280: 6769 6e28 5461 736b 5374 7265 616d 506c  gin(TaskStreamPl
+00042290: 7567 696e 2873 656c 6629 290a 0a20 2020  ugin(self))..   
+000422a0: 2020 2020 2070 6c75 6769 6e20 3d20 6361       plugin = ca
+000422b0: 7374 2854 6173 6b53 7472 6561 6d50 6c75  st(TaskStreamPlu
+000422c0: 6769 6e2c 2073 656c 662e 706c 7567 696e  gin, self.plugin
+000422d0: 735b 5461 736b 5374 7265 616d 506c 7567  s[TaskStreamPlug
+000422e0: 696e 2e6e 616d 655d 290a 0a20 2020 2020  in.name])..     
+000422f0: 2020 2072 6574 7572 6e20 706c 7567 696e     return plugin
+00042300: 2e63 6f6c 6c65 6374 2873 7461 7274 3d73  .collect(start=s
+00042310: 7461 7274 2c20 7374 6f70 3d73 746f 702c  tart, stop=stop,
+00042320: 2063 6f75 6e74 3d63 6f75 6e74 290a 0a20   count=count).. 
+00042330: 2020 2064 6566 2073 7461 7274 5f74 6173     def start_tas
+00042340: 6b5f 6d65 7461 6461 7461 2873 656c 662c  k_metadata(self,
+00042350: 206e 616d 653a 2073 7472 2920 2d3e 204e   name: str) -> N
+00042360: 6f6e 653a 0a20 2020 2020 2020 2070 6c75  one:.        plu
+00042370: 6769 6e20 3d20 436f 6c6c 6563 7454 6173  gin = CollectTas
+00042380: 6b4d 6574 6144 6174 6150 6c75 6769 6e28  kMetaDataPlugin(
+00042390: 7363 6865 6475 6c65 723d 7365 6c66 2c20  scheduler=self, 
+000423a0: 6e61 6d65 3d6e 616d 6529 0a20 2020 2020  name=name).     
+000423b0: 2020 2073 656c 662e 6164 645f 706c 7567     self.add_plug
+000423c0: 696e 2870 6c75 6769 6e29 0a0a 2020 2020  in(plugin)..    
+000423d0: 6465 6620 7374 6f70 5f74 6173 6b5f 6d65  def stop_task_me
+000423e0: 7461 6461 7461 2873 656c 662c 206e 616d  tadata(self, nam
+000423f0: 653a 2073 7472 207c 204e 6f6e 6520 3d20  e: str | None = 
+00042400: 4e6f 6e65 2920 2d3e 2064 6963 743a 0a20  None) -> dict:. 
+00042410: 2020 2020 2020 2070 6c75 6769 6e73 203d         plugins =
+00042420: 205b 0a20 2020 2020 2020 2020 2020 2070   [.            p
+00042430: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00042440: 2070 2069 6e20 6c69 7374 2873 656c 662e   p in list(self.
+00042450: 706c 7567 696e 732e 7661 6c75 6573 2829  plugins.values()
+00042460: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00042470: 2069 7369 6e73 7461 6e63 6528 702c 2043   isinstance(p, C
+00042480: 6f6c 6c65 6374 5461 736b 4d65 7461 4461  ollectTaskMetaDa
+00042490: 7461 506c 7567 696e 2920 616e 6420 702e  taPlugin) and p.
+000424a0: 6e61 6d65 203d 3d20 6e61 6d65 0a20 2020  name == name.   
+000424b0: 2020 2020 205d 0a20 2020 2020 2020 2069       ].        i
+000424c0: 6620 6c65 6e28 706c 7567 696e 7329 2021  f len(plugins) !
+000424d0: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
+000424e0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+000424f0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00042500: 2020 2022 4578 7065 6374 6564 2074 6f20     "Expected to 
+00042510: 6669 6e64 2065 7861 6374 6c79 206f 6e65  find exactly one
+00042520: 2043 6f6c 6c65 6374 5461 736b 4d65 7461   CollectTaskMeta
+00042530: 4461 7461 506c 7567 696e 2022 0a20 2020  DataPlugin ".   
+00042540: 2020 2020 2020 2020 2020 2020 2066 2277               f"w
+00042550: 6974 6820 6e61 6d65 207b 6e61 6d65 7d20  ith name {name} 
+00042560: 6275 7420 666f 756e 6420 7b6c 656e 2870  but found {len(p
+00042570: 6c75 6769 6e73 297d 2e22 0a20 2020 2020  lugins)}.".     
+00042580: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00042590: 2020 706c 7567 696e 203d 2070 6c75 6769    plugin = plugi
+000425a0: 6e73 5b30 5d0a 2020 2020 2020 2020 7365  ns[0].        se
+000425b0: 6c66 2e72 656d 6f76 655f 706c 7567 696e  lf.remove_plugin
+000425c0: 286e 616d 653d 706c 7567 696e 2e6e 616d  (name=plugin.nam
+000425d0: 6529 0a20 2020 2020 2020 2072 6574 7572  e).        retur
+000425e0: 6e20 7b22 6d65 7461 6461 7461 223a 2070  n {"metadata": p
+000425f0: 6c75 6769 6e2e 6d65 7461 6461 7461 2c20  lugin.metadata, 
+00042600: 2273 7461 7465 223a 2070 6c75 6769 6e2e  "state": plugin.
+00042610: 7374 6174 657d 0a0a 2020 2020 6173 796e  state}..    asyn
+00042620: 6320 6465 6620 7265 6769 7374 6572 5f77  c def register_w
+00042630: 6f72 6b65 725f 706c 7567 696e 2873 656c  orker_plugin(sel
+00042640: 662c 2063 6f6d 6d2c 2070 6c75 6769 6e2c  f, comm, plugin,
+00042650: 206e 616d 653d 4e6f 6e65 293a 0a20 2020   name=None):.   
+00042660: 2020 2020 2022 2222 5265 6769 7374 6572       """Register
+00042670: 7320 6120 776f 726b 6572 2070 6c75 6769  s a worker plugi
+00042680: 6e20 6f6e 2061 6c6c 2072 756e 6e69 6e67  n on all running
+00042690: 2061 6e64 2066 7574 7572 6520 776f 726b   and future work
+000426a0: 6572 7322 2222 0a20 2020 2020 2020 2073  ers""".        s
+000426b0: 656c 662e 776f 726b 6572 5f70 6c75 6769  elf.worker_plugi
+000426c0: 6e73 5b6e 616d 655d 203d 2070 6c75 6769  ns[name] = plugi
+000426d0: 6e0a 0a20 2020 2020 2020 2072 6573 706f  n..        respo
+000426e0: 6e73 6573 203d 2061 7761 6974 2073 656c  nses = await sel
+000426f0: 662e 6272 6f61 6463 6173 7428 0a20 2020  f.broadcast(.   
+00042700: 2020 2020 2020 2020 206d 7367 3d64 6963           msg=dic
+00042710: 7428 6f70 3d22 706c 7567 696e 2d61 6464  t(op="plugin-add
+00042720: 222c 2070 6c75 6769 6e3d 706c 7567 696e  ", plugin=plugin
+00042730: 2c20 6e61 6d65 3d6e 616d 6529 0a20 2020  , name=name).   
+00042740: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+00042750: 6574 7572 6e20 7265 7370 6f6e 7365 730a  eturn responses.
+00042760: 0a20 2020 2061 7379 6e63 2064 6566 2075  .    async def u
+00042770: 6e72 6567 6973 7465 725f 776f 726b 6572  nregister_worker
+00042780: 5f70 6c75 6769 6e28 7365 6c66 2c20 636f  _plugin(self, co
+00042790: 6d6d 2c20 6e61 6d65 293a 0a20 2020 2020  mm, name):.     
+000427a0: 2020 2022 2222 556e 7265 6769 7374 6572     """Unregister
+000427b0: 7320 6120 776f 726b 6572 2070 6c75 6769  s a worker plugi
+000427c0: 6e22 2222 0a20 2020 2020 2020 2074 7279  n""".        try
+000427d0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+000427e0: 6c66 2e77 6f72 6b65 725f 706c 7567 696e  lf.worker_plugin
+000427f0: 732e 706f 7028 6e61 6d65 290a 2020 2020  s.pop(name).    
+00042800: 2020 2020 6578 6365 7074 204b 6579 4572      except KeyEr
+00042810: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+00042820: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00042830: 7228 6622 5468 6520 776f 726b 6572 2070  r(f"The worker p
+00042840: 6c75 6769 6e20 7b6e 616d 657d 2064 6f65  lugin {name} doe
+00042850: 7320 6e6f 7420 6578 6973 7422 290a 0a20  s not exist").. 
+00042860: 2020 2020 2020 2072 6573 706f 6e73 6573         responses
+00042870: 203d 2061 7761 6974 2073 656c 662e 6272   = await self.br
+00042880: 6f61 6463 6173 7428 6d73 673d 6469 6374  oadcast(msg=dict
+00042890: 286f 703d 2270 6c75 6769 6e2d 7265 6d6f  (op="plugin-remo
+000428a0: 7665 222c 206e 616d 653d 6e61 6d65 2929  ve", name=name))
+000428b0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000428c0: 7265 7370 6f6e 7365 730a 0a20 2020 2061  responses..    a
+000428d0: 7379 6e63 2064 6566 2072 6567 6973 7465  sync def registe
+000428e0: 725f 6e61 6e6e 795f 706c 7567 696e 2873  r_nanny_plugin(s
+000428f0: 656c 662c 2063 6f6d 6d2c 2070 6c75 6769  elf, comm, plugi
+00042900: 6e2c 206e 616d 653d 4e6f 6e65 293a 0a20  n, name=None):. 
+00042910: 2020 2020 2020 2022 2222 5265 6769 7374         """Regist
+00042920: 6572 7320 6120 7365 7475 7020 6675 6e63  ers a setup func
+00042930: 7469 6f6e 2c20 616e 6420 6361 6c6c 2069  tion, and call i
+00042940: 7420 6f6e 2065 7665 7279 2077 6f72 6b65  t on every worke
+00042950: 7222 2222 0a20 2020 2020 2020 2073 656c  r""".        sel
+00042960: 662e 6e61 6e6e 795f 706c 7567 696e 735b  f.nanny_plugins[
+00042970: 6e61 6d65 5d20 3d20 706c 7567 696e 0a0a  name] = plugin..
+00042980: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+00042990: 7320 3d20 6177 6169 7420 7365 6c66 2e62  s = await self.b
+000429a0: 726f 6164 6361 7374 280a 2020 2020 2020  roadcast(.      
+000429b0: 2020 2020 2020 6d73 673d 6469 6374 286f        msg=dict(o
+000429c0: 703d 2270 6c75 6769 6e5f 6164 6422 2c20  p="plugin_add", 
+000429d0: 706c 7567 696e 3d70 6c75 6769 6e2c 206e  plugin=plugin, n
+000429e0: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
+000429f0: 2020 2020 2020 206e 616e 6e79 3d54 7275         nanny=Tru
+00042a00: 652c 0a20 2020 2020 2020 2029 0a20 2020  e,.        ).   
+00042a10: 2020 2020 2072 6574 7572 6e20 7265 7370       return resp
+00042a20: 6f6e 7365 730a 0a20 2020 2061 7379 6e63  onses..    async
+00042a30: 2064 6566 2075 6e72 6567 6973 7465 725f   def unregister_
+00042a40: 6e61 6e6e 795f 706c 7567 696e 2873 656c  nanny_plugin(sel
+00042a50: 662c 2063 6f6d 6d2c 206e 616d 6529 3a0a  f, comm, name):.
+00042a60: 2020 2020 2020 2020 2222 2255 6e72 6567          """Unreg
+00042a70: 6973 7465 7273 2061 2077 6f72 6b65 7220  isters a worker 
+00042a80: 706c 7567 696e 2222 220a 2020 2020 2020  plugin""".      
+00042a90: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00042aa0: 2020 2073 656c 662e 6e61 6e6e 795f 706c     self.nanny_pl
+00042ab0: 7567 696e 732e 706f 7028 6e61 6d65 290a  ugins.pop(name).
+00042ac0: 2020 2020 2020 2020 6578 6365 7074 204b          except K
+00042ad0: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
+00042ae0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00042af0: 4572 726f 7228 6622 5468 6520 6e61 6e6e  Error(f"The nann
+00042b00: 7920 706c 7567 696e 207b 6e61 6d65 7d20  y plugin {name} 
+00042b10: 646f 6573 206e 6f74 2065 7869 7374 2229  does not exist")
+00042b20: 0a0a 2020 2020 2020 2020 7265 7370 6f6e  ..        respon
+00042b30: 7365 7320 3d20 6177 6169 7420 7365 6c66  ses = await self
+00042b40: 2e62 726f 6164 6361 7374 280a 2020 2020  .broadcast(.    
+00042b50: 2020 2020 2020 2020 6d73 673d 6469 6374          msg=dict
+00042b60: 286f 703d 2270 6c75 6769 6e5f 7265 6d6f  (op="plugin_remo
+00042b70: 7665 222c 206e 616d 653d 6e61 6d65 292c  ve", name=name),
+00042b80: 206e 616e 6e79 3d54 7275 650a 2020 2020   nanny=True.    
+00042b90: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
+00042ba0: 7475 726e 2072 6573 706f 6e73 6573 0a0a  turn responses..
+00042bb0: 2020 2020 6465 6620 7472 616e 7369 7469      def transiti
+00042bc0: 6f6e 280a 2020 2020 2020 2020 7365 6c66  on(.        self
+00042bd0: 2c0a 2020 2020 2020 2020 6b65 793a 2073  ,.        key: s
+00042be0: 7472 2c0a 2020 2020 2020 2020 6669 6e69  tr,.        fini
+00042bf0: 7368 3a20 5461 736b 5374 6174 6553 7461  sh: TaskStateSta
+00042c00: 7465 2c0a 2020 2020 2020 2020 7374 696d  te,.        stim
+00042c10: 756c 7573 5f69 643a 2073 7472 2c0a 2020  ulus_id: str,.  
+00042c20: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
+00042c30: 416e 792c 0a20 2020 2029 202d 3e20 5265  Any,.    ) -> Re
+00042c40: 6373 3a0a 2020 2020 2020 2020 2222 2254  cs:.        """T
+00042c50: 7261 6e73 6974 696f 6e20 6120 6b65 7920  ransition a key 
+00042c60: 6672 6f6d 2069 7473 2063 7572 7265 6e74  from its current
+00042c70: 2073 7461 7465 2074 6f20 7468 6520 6669   state to the fi
+00042c80: 6e69 7368 2073 7461 7465 0a0a 2020 2020  nish state..    
+00042c90: 2020 2020 4578 616d 706c 6573 0a20 2020      Examples.   
+00042ca0: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 2020       --------.  
+00042cb0: 2020 2020 2020 3e3e 3e20 7365 6c66 2e74        >>> self.t
+00042cc0: 7261 6e73 6974 696f 6e28 2778 272c 2027  ransition('x', '
+00042cd0: 7761 6974 696e 6727 290a 2020 2020 2020  waiting').      
+00042ce0: 2020 7b27 7827 3a20 2770 726f 6365 7373    {'x': 'process
+00042cf0: 696e 6727 7d0a 0a20 2020 2020 2020 2052  ing'}..        R
+00042d00: 6574 7572 6e73 0a20 2020 2020 2020 202d  eturns.        -
+00042d10: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2044  ------.        D
+00042d20: 6963 7469 6f6e 6172 7920 6f66 2072 6563  ictionary of rec
+00042d30: 6f6d 6d65 6e64 6174 696f 6e73 2066 6f72  ommendations for
+00042d40: 2066 7574 7572 6520 7472 616e 7369 7469   future transiti
+00042d50: 6f6e 730a 0a20 2020 2020 2020 2053 6565  ons..        See
+00042d60: 2041 6c73 6f0a 2020 2020 2020 2020 2d2d   Also.        --
+00042d70: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2053  ------.        S
+00042d80: 6368 6564 756c 6572 2e74 7261 6e73 6974  cheduler.transit
+00042d90: 696f 6e73 3a20 7472 616e 7369 7469 7665  ions: transitive
+00042da0: 2076 6572 7369 6f6e 206f 6620 7468 6973   version of this
+00042db0: 2066 756e 6374 696f 6e0a 2020 2020 2020   function.      
+00042dc0: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
+00042dd0: 636f 6d6d 656e 6461 7469 6f6e 732c 2063  commendations, c
+00042de0: 6c69 656e 745f 6d73 6773 2c20 776f 726b  lient_msgs, work
+00042df0: 6572 5f6d 7367 7320 3d20 7365 6c66 2e5f  er_msgs = self._
+00042e00: 7472 616e 7369 7469 6f6e 280a 2020 2020  transition(.    
+00042e10: 2020 2020 2020 2020 6b65 792c 2066 696e          key, fin
+00042e20: 6973 682c 2073 7469 6d75 6c75 735f 6964  ish, stimulus_id
+00042e30: 2c20 2a2a 6b77 6172 6773 0a20 2020 2020  , **kwargs.     
+00042e40: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
+00042e50: 662e 7365 6e64 5f61 6c6c 2863 6c69 656e  f.send_all(clien
+00042e60: 745f 6d73 6773 2c20 776f 726b 6572 5f6d  t_msgs, worker_m
+00042e70: 7367 7329 0a20 2020 2020 2020 2072 6574  sgs).        ret
+00042e80: 7572 6e20 7265 636f 6d6d 656e 6461 7469  urn recommendati
+00042e90: 6f6e 730a 0a20 2020 2064 6566 2074 7261  ons..    def tra
+00042ea0: 6e73 6974 696f 6e73 2873 656c 662c 2072  nsitions(self, r
+00042eb0: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
+00042ec0: 5265 6373 2c20 7374 696d 756c 7573 5f69  Recs, stimulus_i
+00042ed0: 643a 2073 7472 2920 2d3e 204e 6f6e 653a  d: str) -> None:
+00042ee0: 0a20 2020 2020 2020 2022 2222 5072 6f63  .        """Proc
+00042ef0: 6573 7320 7472 616e 7369 7469 6f6e 7320  ess transitions 
+00042f00: 756e 7469 6c20 6e6f 6e65 2061 7265 206c  until none are l
+00042f10: 6566 740a 0a20 2020 2020 2020 2054 6869  eft..        Thi
+00042f20: 7320 696e 636c 7564 6573 2066 6565 6462  s includes feedb
+00042f30: 6163 6b20 6672 6f6d 2070 7265 7669 6f75  ack from previou
+00042f40: 7320 7472 616e 7369 7469 6f6e 7320 616e  s transitions an
+00042f50: 6420 636f 6e74 696e 7565 7320 756e 7469  d continues unti
+00042f60: 6c20 7765 0a20 2020 2020 2020 2072 6561  l we.        rea
+00042f70: 6368 2061 2073 7465 6164 7920 7374 6174  ch a steady stat
+00042f80: 650a 2020 2020 2020 2020 2222 220a 2020  e.        """.  
+00042f90: 2020 2020 2020 636c 6965 6e74 5f6d 7367        client_msg
+00042fa0: 733a 204d 7367 7320 3d20 7b7d 0a20 2020  s: Msgs = {}.   
+00042fb0: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
+00042fc0: 3a20 4d73 6773 203d 207b 7d0a 2020 2020  : Msgs = {}.    
+00042fd0: 2020 2020 7365 6c66 2e5f 7472 616e 7369      self._transi
+00042fe0: 7469 6f6e 7328 7265 636f 6d6d 656e 6461  tions(recommenda
+00042ff0: 7469 6f6e 732c 2063 6c69 656e 745f 6d73  tions, client_ms
+00043000: 6773 2c20 776f 726b 6572 5f6d 7367 732c  gs, worker_msgs,
+00043010: 2073 7469 6d75 6c75 735f 6964 290a 2020   stimulus_id).  
+00043020: 2020 2020 2020 7365 6c66 2e73 656e 645f        self.send_
+00043030: 616c 6c28 636c 6965 6e74 5f6d 7367 732c  all(client_msgs,
+00043040: 2077 6f72 6b65 725f 6d73 6773 290a 0a20   worker_msgs).. 
+00043050: 2020 2061 7379 6e63 2064 6566 2067 6574     async def get
+00043060: 5f73 746f 7279 2873 656c 662c 206b 6579  _story(self, key
+00043070: 735f 6f72 5f73 7469 6d75 6c69 3a20 4974  s_or_stimuli: It
+00043080: 6572 6162 6c65 5b73 7472 5d29 202d 3e20  erable[str]) -> 
+00043090: 6c69 7374 5b54 7261 6e73 6974 696f 6e5d  list[Transition]
+000430a0: 3a0a 2020 2020 2020 2020 2222 2252 5043  :.        """RPC
+000430b0: 2068 6f6f 6b20 666f 7220 3a6d 6574 683a   hook for :meth:
+000430c0: 6053 6368 6564 756c 6572 5374 6174 652e  `SchedulerState.
+000430d0: 7374 6f72 7960 2e0a 0a20 2020 2020 2020  story`...       
+000430e0: 204e 6f74 6520 7468 6174 2074 6865 206d   Note that the m
+000430f0: 7367 7061 636b 2073 6572 6961 6c69 7a61  sgpack serializa
+00043100: 7469 6f6e 2f64 6573 6572 6961 6c69 7a61  tion/deserializa
+00043110: 7469 6f6e 2072 6f75 6e64 2d74 7269 7020  tion round-trip 
+00043120: 7769 6c6c 2074 7261 6e73 666f 726d 0a20  will transform. 
+00043130: 2020 2020 2020 2074 6865 203a 636c 6173         the :clas
+00043140: 733a 6054 7261 6e73 6974 696f 6e60 206e  s:`Transition` n
+00043150: 616d 6564 7475 706c 6573 2069 6e74 6f20  amedtuples into 
+00043160: 7265 6775 6c61 7220 7475 706c 6573 2e0a  regular tuples..
+00043170: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00043180: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00043190: 7374 6f72 7928 2a6b 6579 735f 6f72 5f73  story(*keys_or_s
+000431a0: 7469 6d75 6c69 290a 0a20 2020 2064 6566  timuli)..    def
+000431b0: 205f 7265 7363 6865 6475 6c65 280a 2020   _reschedule(.  
+000431c0: 2020 2020 2020 7365 6c66 2c20 6b65 793a        self, key:
+000431d0: 2073 7472 2c20 776f 726b 6572 3a20 7374   str, worker: st
+000431e0: 7220 7c20 4e6f 6e65 203d 204e 6f6e 652c  r | None = None,
+000431f0: 202a 2c20 7374 696d 756c 7573 5f69 643a   *, stimulus_id:
+00043200: 2073 7472 0a20 2020 2029 202d 3e20 4e6f   str.    ) -> No
+00043210: 6e65 3a0a 2020 2020 2020 2020 2222 2252  ne:.        """R
+00043220: 6573 6368 6564 756c 6520 6120 7461 736b  eschedule a task
+00043230: 2e0a 0a20 2020 2020 2020 2054 6869 7320  ...        This 
+00043240: 6675 6e63 7469 6f6e 2073 686f 756c 6420  function should 
+00043250: 6f6e 6c79 2062 6520 7573 6564 2077 6865  only be used whe
+00043260: 6e20 7468 6520 7461 736b 2068 6173 2061  n the task has a
+00043270: 6c72 6561 6479 2062 6565 6e20 7265 6c65  lready been rele
+00043280: 6173 6564 2069 6e0a 2020 2020 2020 2020  ased in.        
+00043290: 736f 6d65 2077 6179 206f 6e20 7468 6520  some way on the 
+000432a0: 776f 726b 6572 2069 7427 7320 6173 7369  worker it's assi
+000432b0: 676e 6564 2074 6f20 e280 9420 6569 7468  gned to ... eith
+000432c0: 6572 2076 6961 2063 616e 6365 6c6c 6174  er via cancellat
+000432d0: 696f 6e20 6f72 2061 0a20 2020 2020 2020  ion or a.       
+000432e0: 2052 6573 6368 6564 756c 6520 6578 6365   Reschedule exce
+000432f0: 7074 696f 6e20 e280 9420 616e 6420 796f  ption ... and yo
+00043300: 7520 6172 6520 6365 7274 6169 6e20 7468  u are certain th
+00043310: 6520 776f 726b 6572 2077 696c 6c20 6e6f  e worker will no
+00043320: 7420 7365 6e64 2061 6e79 2066 7572 7468  t send any furth
+00043330: 6572 0a20 2020 2020 2020 2075 7064 6174  er.        updat
+00043340: 6573 2061 626f 7574 2074 6865 2074 6173  es about the tas
+00043350: 6b20 746f 2074 6865 2073 6368 6564 756c  k to the schedul
+00043360: 6572 2e0a 2020 2020 2020 2020 2222 220a  er..        """.
+00043370: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00043380: 2020 2020 2020 2020 2074 7320 3d20 7365           ts = se
+00043390: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 2020  lf.tasks[key].  
+000433a0: 2020 2020 2020 6578 6365 7074 204b 6579        except Key
+000433b0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+000433c0: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
+000433d0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+000433e0: 2020 2066 2241 7474 656d 7074 696e 6720     f"Attempting 
+000433f0: 746f 2072 6573 6368 6564 756c 6520 7461  to reschedule ta
+00043400: 736b 207b 6b65 797d 2c20 7768 6963 6820  sk {key}, which 
+00043410: 7761 7320 6e6f 7420 220a 2020 2020 2020  was not ".      
+00043420: 2020 2020 2020 2020 2020 2266 6f75 6e64            "found
+00043430: 206f 6e20 7468 6520 7363 6865 6475 6c65   on the schedule
+00043440: 722e 2041 626f 7274 696e 6720 7265 7363  r. Aborting resc
+00043450: 6865 6475 6c65 2e22 0a20 2020 2020 2020  hedule.".       
+00043460: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00043470: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
+00043480: 2020 6966 2074 732e 7374 6174 6520 213d    if ts.state !=
+00043490: 2022 7072 6f63 6573 7369 6e67 223a 0a20   "processing":. 
+000434a0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000434b0: 6e0a 2020 2020 2020 2020 6966 2077 6f72  n.        if wor
+000434c0: 6b65 7220 616e 6420 7473 2e70 726f 6365  ker and ts.proce
+000434d0: 7373 696e 675f 6f6e 2061 6e64 2074 732e  ssing_on and ts.
+000434e0: 7072 6f63 6573 7369 6e67 5f6f 6e2e 6164  processing_on.ad
+000434f0: 6472 6573 7320 213d 2077 6f72 6b65 723a  dress != worker:
+00043500: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00043510: 7572 6e0a 2020 2020 2020 2020 2320 7472  urn.        # tr
+00043520: 616e 7369 7469 6f6e 5f70 726f 6365 7373  ansition_process
+00043530: 696e 675f 7265 6c65 6173 6564 2077 696c  ing_released wil
+00043540: 6c20 696d 6d65 6469 6174 656c 7920 7375  l immediately su
+00043550: 6767 6573 7420 616e 2061 6464 6974 696f  ggest an additio
+00043560: 6e61 6c0a 2020 2020 2020 2020 2320 7472  nal.        # tr
+00043570: 616e 7369 7469 6f6e 2074 6f20 7761 6974  ansition to wait
+00043580: 696e 6720 6966 2074 6865 2074 6173 6b20  ing if the task 
+00043590: 6861 7320 616e 7920 7761 6974 6572 7320  has any waiters 
+000435a0: 6f72 2063 6c69 656e 7473 2068 6f6c 6469  or clients holdi
+000435b0: 6e67 2061 2066 7574 7572 652e 0a20 2020  ng a future..   
+000435c0: 2020 2020 2073 656c 662e 7472 616e 7369       self.transi
+000435d0: 7469 6f6e 7328 7b6b 6579 3a20 2272 656c  tions({key: "rel
+000435e0: 6561 7365 6422 7d2c 2073 7469 6d75 6c75  eased"}, stimulu
+000435f0: 735f 6964 3d73 7469 6d75 6c75 735f 6964  s_id=stimulus_id
+00043600: 290a 0a20 2020 2023 2323 2323 2323 2323  )..    #########
+00043610: 2323 2323 2323 2323 2323 2323 0a20 2020  ############.   
+00043620: 2023 2055 7469 6c69 7479 2066 756e 6374   # Utility funct
+00043630: 696f 6e73 2023 0a20 2020 2023 2323 2323  ions #.    #####
+00043640: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00043650: 0a0a 2020 2020 6465 6620 6164 645f 7265  ..    def add_re
+00043660: 736f 7572 6365 7328 0a20 2020 2020 2020  sources(.       
+00043670: 2073 656c 662c 2077 6f72 6b65 723a 2073   self, worker: s
+00043680: 7472 2c20 7265 736f 7572 6365 733a 2064  tr, resources: d
+00043690: 6963 7420 7c20 4e6f 6e65 203d 204e 6f6e  ict | None = Non
+000436a0: 650a 2020 2020 2920 2d3e 204c 6974 6572  e.    ) -> Liter
+000436b0: 616c 5b22 4f4b 225d 3a0a 2020 2020 2020  al["OK"]:.      
+000436c0: 2020 7773 3a20 576f 726b 6572 5374 6174    ws: WorkerStat
+000436d0: 6520 3d20 7365 6c66 2e77 6f72 6b65 7273  e = self.workers
+000436e0: 5b77 6f72 6b65 725d 0a20 2020 2020 2020  [worker].       
+000436f0: 2069 6620 7265 736f 7572 6365 733a 0a20   if resources:. 
+00043700: 2020 2020 2020 2020 2020 2077 732e 7265             ws.re
+00043710: 736f 7572 6365 732e 7570 6461 7465 2872  sources.update(r
+00043720: 6573 6f75 7263 6573 290a 2020 2020 2020  esources).      
+00043730: 2020 7773 2e75 7365 645f 7265 736f 7572    ws.used_resour
+00043740: 6365 7320 3d20 7b7d 0a20 2020 2020 2020  ces = {}.       
+00043750: 2066 6f72 2072 6573 6f75 7263 652c 2071   for resource, q
+00043760: 7561 6e74 6974 7920 696e 2077 732e 7265  uantity in ws.re
+00043770: 736f 7572 6365 732e 6974 656d 7328 293a  sources.items():
+00043780: 0a20 2020 2020 2020 2020 2020 2077 732e  .            ws.
+00043790: 7573 6564 5f72 6573 6f75 7263 6573 5b72  used_resources[r
+000437a0: 6573 6f75 7263 655d 203d 2030 0a20 2020  esource] = 0.   
+000437b0: 2020 2020 2020 2020 2064 7220 3d20 7365           dr = se
+000437c0: 6c66 2e72 6573 6f75 7263 6573 2e67 6574  lf.resources.get
+000437d0: 2872 6573 6f75 7263 652c 204e 6f6e 6529  (resource, None)
+000437e0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000437f0: 6472 2069 7320 4e6f 6e65 3a0a 2020 2020  dr is None:.    
+00043800: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00043810: 2e72 6573 6f75 7263 6573 5b72 6573 6f75  .resources[resou
+00043820: 7263 655d 203d 2064 7220 3d20 7b7d 0a20  rce] = dr = {}. 
+00043830: 2020 2020 2020 2020 2020 2064 725b 776f             dr[wo
+00043840: 726b 6572 5d20 3d20 7175 616e 7469 7479  rker] = quantity
+00043850: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00043860: 224f 4b22 0a0a 2020 2020 6465 6620 7265  "OK"..    def re
+00043870: 6d6f 7665 5f72 6573 6f75 7263 6573 2873  move_resources(s
+00043880: 656c 662c 2077 6f72 6b65 723a 2073 7472  elf, worker: str
+00043890: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+000438a0: 2020 2077 733a 2057 6f72 6b65 7253 7461     ws: WorkerSta
+000438b0: 7465 203d 2073 656c 662e 776f 726b 6572  te = self.worker
+000438c0: 735b 776f 726b 6572 5d0a 2020 2020 2020  s[worker].      
+000438d0: 2020 666f 7220 7265 736f 7572 6365 2069    for resource i
+000438e0: 6e20 7773 2e72 6573 6f75 7263 6573 3a0a  n ws.resources:.
+000438f0: 2020 2020 2020 2020 2020 2020 6472 203d              dr =
+00043900: 2073 656c 662e 7265 736f 7572 6365 732e   self.resources.
+00043910: 7365 7464 6566 6175 6c74 2872 6573 6f75  setdefault(resou
+00043920: 7263 652c 207b 7d29 0a20 2020 2020 2020  rce, {}).       
+00043930: 2020 2020 2064 656c 2064 725b 776f 726b       del dr[work
+00043940: 6572 5d0a 0a20 2020 2064 6566 2063 6f65  er]..    def coe
+00043950: 7263 655f 6164 6472 6573 7328 7365 6c66  rce_address(self
+00043960: 2c20 6164 6472 3a20 7374 7220 7c20 7475  , addr: str | tu
+00043970: 706c 652c 2072 6573 6f6c 7665 3a20 626f  ple, resolve: bo
+00043980: 6f6c 203d 2054 7275 6529 202d 3e20 7374  ol = True) -> st
+00043990: 723a 0a20 2020 2020 2020 2022 2222 0a20  r:.        """. 
+000439a0: 2020 2020 2020 2043 6f65 7263 6520 706f         Coerce po
+000439b0: 7373 6962 6c65 2069 6e70 7574 2061 6464  ssible input add
+000439c0: 7265 7373 6573 2074 6f20 6361 6e6f 6e69  resses to canoni
+000439d0: 6361 6c20 666f 726d 2e0a 2020 2020 2020  cal form..      
+000439e0: 2020 2a72 6573 6f6c 7665 2a20 6361 6e20    *resolve* can 
+000439f0: 6265 2064 6973 6162 6c65 6420 666f 7220  be disabled for 
+00043a00: 7465 7374 696e 6720 7769 7468 2066 616b  testing with fak
+00043a10: 6520 686f 7374 6e61 6d65 732e 0a0a 2020  e hostnames...  
+00043a20: 2020 2020 2020 4861 6e64 6c65 7320 7374        Handles st
+00043a30: 7269 6e67 732c 2074 7570 6c65 732c 206f  rings, tuples, o
+00043a40: 7220 616c 6961 7365 732e 0a20 2020 2020  r aliases..     
+00043a50: 2020 2022 2222 0a20 2020 2020 2020 2023     """.        #
+00043a60: 2058 5858 2068 6f77 206d 616e 7920 6164   XXX how many ad
+00043a70: 6472 6573 732d 7061 7273 696e 6720 726f  dress-parsing ro
+00043a80: 7574 696e 6573 2064 6f20 7765 2068 6176  utines do we hav
+00043a90: 653f 0a20 2020 2020 2020 2069 6620 6164  e?.        if ad
+00043aa0: 6472 2069 6e20 7365 6c66 2e61 6c69 6173  dr in self.alias
+00043ab0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00043ac0: 6164 6472 203d 2073 656c 662e 616c 6961  addr = self.alia
+00043ad0: 7365 735b 6164 6472 5d0a 2020 2020 2020  ses[addr].      
+00043ae0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00043af0: 6164 6472 2c20 7475 706c 6529 3a0a 2020  addr, tuple):.  
+00043b00: 2020 2020 2020 2020 2020 6164 6472 203d            addr =
+00043b10: 2075 6e70 6172 7365 5f68 6f73 745f 706f   unparse_host_po
+00043b20: 7274 282a 6164 6472 290a 2020 2020 2020  rt(*addr).      
+00043b30: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
+00043b40: 6e63 6528 6164 6472 2c20 7374 7229 3a0a  nce(addr, str):.
+00043b50: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00043b60: 6520 5479 7065 4572 726f 7228 6622 6164  e TypeError(f"ad
+00043b70: 6472 6573 7365 7320 7368 6f75 6c64 2062  dresses should b
+00043b80: 6520 7374 7269 6e67 7320 6f72 2074 7570  e strings or tup
+00043b90: 6c65 732c 2067 6f74 207b 6164 6472 2172  les, got {addr!r
+00043ba0: 7d22 290a 0a20 2020 2020 2020 2069 6620  }")..        if 
+00043bb0: 7265 736f 6c76 653a 0a20 2020 2020 2020  resolve:.       
+00043bc0: 2020 2020 2061 6464 7220 3d20 7265 736f       addr = reso
+00043bd0: 6c76 655f 6164 6472 6573 7328 6164 6472  lve_address(addr
+00043be0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00043bf0: 2020 2020 2020 2020 2020 2020 6164 6472              addr
+00043c00: 203d 206e 6f72 6d61 6c69 7a65 5f61 6464   = normalize_add
+00043c10: 7265 7373 2861 6464 7229 0a0a 2020 2020  ress(addr)..    
+00043c20: 2020 2020 7265 7475 726e 2061 6464 720a      return addr.
+00043c30: 0a20 2020 2064 6566 2077 6f72 6b65 7273  .    def workers
+00043c40: 5f6c 6973 7428 7365 6c66 2c20 776f 726b  _list(self, work
+00043c50: 6572 733a 2049 7465 7261 626c 655b 7374  ers: Iterable[st
+00043c60: 725d 207c 204e 6f6e 6529 202d 3e20 6c69  r] | None) -> li
+00043c70: 7374 5b73 7472 5d3a 0a20 2020 2020 2020  st[str]:.       
+00043c80: 2022 2222 0a20 2020 2020 2020 204c 6973   """.        Lis
+00043c90: 7420 6f66 2071 7561 6c69 6679 696e 6720  t of qualifying 
+00043ca0: 776f 726b 6572 730a 0a20 2020 2020 2020  workers..       
+00043cb0: 2054 616b 6573 2061 206c 6973 7420 6f66   Takes a list of
+00043cc0: 2077 6f72 6b65 7220 6164 6472 6573 7365   worker addresse
+00043cd0: 7320 6f72 2068 6f73 746e 616d 6573 2e0a  s or hostnames..
+00043ce0: 2020 2020 2020 2020 5265 7475 726e 7320          Returns 
+00043cf0: 6120 6c69 7374 206f 6620 616c 6c20 776f  a list of all wo
+00043d00: 726b 6572 2061 6464 7265 7373 6573 2074  rker addresses t
+00043d10: 6861 7420 6d61 7463 680a 2020 2020 2020  hat match.      
+00043d20: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
+00043d30: 2077 6f72 6b65 7273 2069 7320 4e6f 6e65   workers is None
+00043d40: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00043d50: 7475 726e 206c 6973 7428 7365 6c66 2e77  turn list(self.w
+00043d60: 6f72 6b65 7273 290a 0a20 2020 2020 2020  orkers)..       
+00043d70: 206f 7574 203d 2073 6574 2829 0a20 2020   out = set().   
+00043d80: 2020 2020 2066 6f72 2077 2069 6e20 776f       for w in wo
+00043d90: 726b 6572 733a 0a20 2020 2020 2020 2020  rkers:.         
+00043da0: 2020 2069 6620 223a 2220 696e 2077 3a0a     if ":" in w:.
+00043db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043dc0: 6f75 742e 6164 6428 7729 0a20 2020 2020  out.add(w).     
+00043dd0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00043de0: 2020 2020 2020 2020 2020 2020 206f 7574               out
+00043df0: 2e75 7064 6174 6528 7b77 7720 666f 7220  .update({ww for 
+00043e00: 7777 2069 6e20 7365 6c66 2e77 6f72 6b65  ww in self.worke
+00043e10: 7273 2069 6620 7720 696e 2077 777d 2920  rs if w in ww}) 
+00043e20: 2023 2054 4f44 4f3a 2071 7561 6472 6174   # TODO: quadrat
+00043e30: 6963 0a20 2020 2020 2020 2072 6574 7572  ic.        retur
+00043e40: 6e20 6c69 7374 286f 7574 290a 0a20 2020  n list(out)..   
+00043e50: 2061 7379 6e63 2064 6566 2067 6574 5f70   async def get_p
+00043e60: 726f 6669 6c65 280a 2020 2020 2020 2020  rofile(.        
+00043e70: 7365 6c66 2c0a 2020 2020 2020 2020 636f  self,.        co
+00043e80: 6d6d 3d4e 6f6e 652c 0a20 2020 2020 2020  mm=None,.       
+00043e90: 2077 6f72 6b65 7273 3d4e 6f6e 652c 0a20   workers=None,. 
+00043ea0: 2020 2020 2020 2073 6368 6564 756c 6572         scheduler
+00043eb0: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+00043ec0: 7365 7276 6572 3d46 616c 7365 2c0a 2020  server=False,.  
+00043ed0: 2020 2020 2020 6d65 7267 655f 776f 726b        merge_work
+00043ee0: 6572 733d 5472 7565 2c0a 2020 2020 2020  ers=True,.      
+00043ef0: 2020 7374 6172 743d 4e6f 6e65 2c0a 2020    start=None,.  
+00043f00: 2020 2020 2020 7374 6f70 3d4e 6f6e 652c        stop=None,
+00043f10: 0a20 2020 2020 2020 206b 6579 3d4e 6f6e  .        key=Non
+00043f20: 652c 0a20 2020 2029 3a0a 2020 2020 2020  e,.    ):.      
+00043f30: 2020 6966 2077 6f72 6b65 7273 2069 7320    if workers is 
+00043f40: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00043f50: 2020 776f 726b 6572 7320 3d20 7365 6c66    workers = self
+00043f60: 2e77 6f72 6b65 7273 0a20 2020 2020 2020  .workers.       
+00043f70: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00043f80: 2020 2077 6f72 6b65 7273 203d 2073 6574     workers = set
+00043f90: 2873 656c 662e 776f 726b 6572 7329 2026  (self.workers) &
+00043fa0: 2073 6574 2877 6f72 6b65 7273 290a 0a20   set(workers).. 
+00043fb0: 2020 2020 2020 2069 6620 7363 6865 6475         if schedu
+00043fc0: 6c65 723a 0a20 2020 2020 2020 2020 2020  ler:.           
+00043fd0: 2072 6574 7572 6e20 7072 6f66 696c 652e   return profile.
+00043fe0: 6765 745f 7072 6f66 696c 6528 7365 6c66  get_profile(self
+00043ff0: 2e69 6f5f 6c6f 6f70 2e70 726f 6669 6c65  .io_loop.profile
+00044000: 2c20 7374 6172 743d 7374 6172 742c 2073  , start=start, s
+00044010: 746f 703d 7374 6f70 290a 0a20 2020 2020  top=stop)..     
+00044020: 2020 2072 6573 756c 7473 203d 2061 7761     results = awa
+00044030: 6974 2061 7379 6e63 696f 2e67 6174 6865  it asyncio.gathe
+00044040: 7228 0a20 2020 2020 2020 2020 2020 202a  r(.            *
+00044050: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00044060: 2020 7365 6c66 2e72 7063 2877 292e 7072    self.rpc(w).pr
+00044070: 6f66 696c 6528 7374 6172 743d 7374 6172  ofile(start=star
+00044080: 742c 2073 746f 703d 7374 6f70 2c20 6b65  t, stop=stop, ke
+00044090: 793d 6b65 792c 2073 6572 7665 723d 7365  y=key, server=se
+000440a0: 7276 6572 290a 2020 2020 2020 2020 2020  rver).          
+000440b0: 2020 2020 2020 666f 7220 7720 696e 2077        for w in w
+000440c0: 6f72 6b65 7273 0a20 2020 2020 2020 2020  orkers.         
+000440d0: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
+000440e0: 2020 7265 7475 726e 5f65 7863 6570 7469    return_excepti
+000440f0: 6f6e 733d 5472 7565 2c0a 2020 2020 2020  ons=True,.      
+00044100: 2020 290a 0a20 2020 2020 2020 2072 6573    )..        res
+00044110: 756c 7473 203d 205b 7220 666f 7220 7220  ults = [r for r 
+00044120: 696e 2072 6573 756c 7473 2069 6620 6e6f  in results if no
+00044130: 7420 6973 696e 7374 616e 6365 2872 2c20  t isinstance(r, 
+00044140: 4578 6365 7074 696f 6e29 5d0a 0a20 2020  Exception)]..   
+00044150: 2020 2020 2069 6620 6d65 7267 655f 776f       if merge_wo
+00044160: 726b 6572 733a 0a20 2020 2020 2020 2020  rkers:.         
+00044170: 2020 2072 6573 706f 6e73 6520 3d20 7072     response = pr
+00044180: 6f66 696c 652e 6d65 7267 6528 2a72 6573  ofile.merge(*res
+00044190: 756c 7473 290a 2020 2020 2020 2020 656c  ults).        el
+000441a0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000441b0: 7265 7370 6f6e 7365 203d 2064 6963 7428  response = dict(
+000441c0: 7a69 7028 776f 726b 6572 732c 2072 6573  zip(workers, res
+000441d0: 756c 7473 2929 0a20 2020 2020 2020 2072  ults)).        r
+000441e0: 6574 7572 6e20 7265 7370 6f6e 7365 0a0a  eturn response..
+000441f0: 2020 2020 6173 796e 6320 6465 6620 6765      async def ge
+00044200: 745f 7072 6f66 696c 655f 6d65 7461 6461  t_profile_metada
+00044210: 7461 280a 2020 2020 2020 2020 7365 6c66  ta(.        self
+00044220: 2c0a 2020 2020 2020 2020 776f 726b 6572  ,.        worker
+00044230: 733a 2022 4974 6572 6162 6c65 5b73 7472  s: "Iterable[str
+00044240: 5d20 7c20 4e6f 6e65 2220 3d20 4e6f 6e65  ] | None" = None
+00044250: 2c0a 2020 2020 2020 2020 7374 6172 743a  ,.        start:
+00044260: 2066 6c6f 6174 203d 2030 2c0a 2020 2020   float = 0,.    
+00044270: 2020 2020 7374 6f70 3a20 2266 6c6f 6174      stop: "float
+00044280: 207c 204e 6f6e 6522 203d 204e 6f6e 652c   | None" = None,
+00044290: 0a20 2020 2020 2020 2070 726f 6669 6c65  .        profile
+000442a0: 5f63 7963 6c65 5f69 6e74 6572 7661 6c3a  _cycle_interval:
+000442b0: 2022 7374 7220 7c20 666c 6f61 7420 7c20   "str | float | 
+000442c0: 4e6f 6e65 2220 3d20 4e6f 6e65 2c0a 2020  None" = None,.  
+000442d0: 2020 2920 2d3e 2064 6963 743a 0a20 2020    ) -> dict:.   
+000442e0: 2020 2020 2064 7420 3d20 7072 6f66 696c       dt = profil
+000442f0: 655f 6379 636c 655f 696e 7465 7276 616c  e_cycle_interval
+00044300: 206f 7220 6461 736b 2e63 6f6e 6669 672e   or dask.config.
+00044310: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
+00044320: 2022 6469 7374 7269 6275 7465 642e 776f   "distributed.wo
+00044330: 726b 6572 2e70 726f 6669 6c65 2e63 7963  rker.profile.cyc
+00044340: 6c65 220a 2020 2020 2020 2020 290a 2020  le".        ).  
+00044350: 2020 2020 2020 6474 203d 2070 6172 7365        dt = parse
+00044360: 5f74 696d 6564 656c 7461 2864 742c 2064  _timedelta(dt, d
+00044370: 6566 6175 6c74 3d22 6d73 2229 0a0a 2020  efault="ms")..  
+00044380: 2020 2020 2020 6966 2077 6f72 6b65 7273        if workers
+00044390: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+000443a0: 2020 2020 2020 776f 726b 6572 7320 3d20        workers = 
+000443b0: 7365 6c66 2e77 6f72 6b65 7273 0a20 2020  self.workers.   
+000443c0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000443d0: 2020 2020 2020 2077 6f72 6b65 7273 203d         workers =
+000443e0: 2073 6574 2873 656c 662e 776f 726b 6572   set(self.worker
+000443f0: 7329 2026 2073 6574 2877 6f72 6b65 7273  s) & set(workers
+00044400: 290a 2020 2020 2020 2020 7265 7375 6c74  ).        result
+00044410: 7320 3d20 6177 6169 7420 6173 796e 6369  s = await asynci
+00044420: 6f2e 6761 7468 6572 280a 2020 2020 2020  o.gather(.      
+00044430: 2020 2020 2020 2a28 7365 6c66 2e72 7063        *(self.rpc
+00044440: 2877 292e 7072 6f66 696c 655f 6d65 7461  (w).profile_meta
+00044450: 6461 7461 2873 7461 7274 3d73 7461 7274  data(start=start
+00044460: 2c20 7374 6f70 3d73 746f 7029 2066 6f72  , stop=stop) for
+00044470: 2077 2069 6e20 776f 726b 6572 7329 2c0a   w in workers),.
+00044480: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00044490: 726e 5f65 7863 6570 7469 6f6e 733d 5472  rn_exceptions=Tr
+000444a0: 7565 2c0a 2020 2020 2020 2020 290a 0a20  ue,.        ).. 
+000444b0: 2020 2020 2020 2072 6573 756c 7473 203d         results =
+000444c0: 205b 7220 666f 7220 7220 696e 2072 6573   [r for r in res
+000444d0: 756c 7473 2069 6620 6e6f 7420 6973 696e  ults if not isin
+000444e0: 7374 616e 6365 2872 2c20 4578 6365 7074  stance(r, Except
+000444f0: 696f 6e29 5d0a 2020 2020 2020 2020 636f  ion)].        co
+00044500: 756e 7473 203d 205b 0a20 2020 2020 2020  unts = [.       
+00044510: 2020 2020 2028 7469 6d65 2c20 7375 6d28       (time, sum(
+00044520: 706c 7563 6b28 312c 2067 726f 7570 2929  pluck(1, group))
+00044530: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+00044540: 7220 7469 6d65 2c20 6772 6f75 7020 696e  r time, group in
+00044550: 2069 7465 7274 6f6f 6c73 2e67 726f 7570   itertools.group
+00044560: 6279 280a 2020 2020 2020 2020 2020 2020  by(.            
+00044570: 2020 2020 6d65 7267 655f 736f 7274 6564      merge_sorted
+00044580: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00044590: 2020 2020 2020 2a28 765b 2263 6f75 6e74        *(v["count
+000445a0: 7322 5d20 666f 7220 7620 696e 2072 6573  s"] for v in res
+000445b0: 756c 7473 292c 0a20 2020 2020 2020 2020  ults),.         
+000445c0: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
+000445d0: 2020 2020 2020 2020 2020 6c61 6d62 6461            lambda
+000445e0: 2074 3a20 745b 305d 202f 2f20 6474 202a   t: t[0] // dt *
+000445f0: 2064 742c 0a20 2020 2020 2020 2020 2020   dt,.           
+00044600: 2029 0a20 2020 2020 2020 205d 0a0a 2020   ).        ]..  
+00044610: 2020 2020 2020 6b65 7973 3a20 6469 6374        keys: dict
+00044620: 5b73 7472 2c20 6c69 7374 5b6c 6973 745d  [str, list[list]
+00044630: 5d20 3d20 7b0a 2020 2020 2020 2020 2020  ] = {.          
+00044640: 2020 6b3a 205b 5d20 666f 7220 7620 696e    k: [] for v in
+00044650: 2072 6573 756c 7473 2066 6f72 2074 2c20   results for t, 
+00044660: 6420 696e 2076 5b22 6b65 7973 225d 2066  d in v["keys"] f
+00044670: 6f72 206b 2069 6e20 640a 2020 2020 2020  or k in d.      
+00044680: 2020 7d0a 0a20 2020 2020 2020 2067 726f    }..        gro
+00044690: 7570 7331 203d 205b 765b 226b 6579 7322  ups1 = [v["keys"
+000446a0: 5d20 666f 7220 7620 696e 2072 6573 756c  ] for v in resul
+000446b0: 7473 5d0a 2020 2020 2020 2020 6772 6f75  ts].        grou
+000446c0: 7073 3220 3d20 6c69 7374 286d 6572 6765  ps2 = list(merge
+000446d0: 5f73 6f72 7465 6428 2a67 726f 7570 7331  _sorted(*groups1
+000446e0: 2c20 6b65 793d 6669 7273 7429 290a 0a20  , key=first)).. 
+000446f0: 2020 2020 2020 206c 6173 7420 3d20 300a         last = 0.
+00044700: 2020 2020 2020 2020 666f 7220 742c 2064          for t, d
+00044710: 2069 6e20 6772 6f75 7073 323a 0a20 2020   in groups2:.   
+00044720: 2020 2020 2020 2020 2074 7420 3d20 7420           tt = t 
+00044730: 2f2f 2064 7420 2a20 6474 0a20 2020 2020  // dt * dt.     
+00044740: 2020 2020 2020 2069 6620 7474 203e 206c         if tt > l
+00044750: 6173 743a 0a20 2020 2020 2020 2020 2020  ast:.           
+00044760: 2020 2020 206c 6173 7420 3d20 7474 0a20       last = tt. 
+00044770: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00044780: 6f72 2076 2069 6e20 6b65 7973 2e76 616c  or v in keys.val
+00044790: 7565 7328 293a 0a20 2020 2020 2020 2020  ues():.         
+000447a0: 2020 2020 2020 2020 2020 2076 2e61 7070             v.app
+000447b0: 656e 6428 5b74 742c 2030 5d29 0a20 2020  end([tt, 0]).   
+000447c0: 2020 2020 2020 2020 2066 6f72 206b 2c20           for k, 
+000447d0: 7620 696e 2064 2e69 7465 6d73 2829 3a0a  v in d.items():.
+000447e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000447f0: 6b65 7973 5b6b 5d5b 2d31 5d5b 315d 202b  keys[k][-1][1] +
+00044800: 3d20 760a 0a20 2020 2020 2020 2072 6574  = v..        ret
+00044810: 7572 6e20 7b22 636f 756e 7473 223a 2063  urn {"counts": c
+00044820: 6f75 6e74 732c 2022 6b65 7973 223a 206b  ounts, "keys": k
+00044830: 6579 737d 0a0a 2020 2020 6173 796e 6320  eys}..    async 
+00044840: 6465 6620 7065 7266 6f72 6d61 6e63 655f  def performance_
+00044850: 7265 706f 7274 280a 2020 2020 2020 2020  report(.        
+00044860: 7365 6c66 2c20 7374 6172 743a 2066 6c6f  self, start: flo
+00044870: 6174 2c20 6c61 7374 5f63 6f75 6e74 3a20  at, last_count: 
+00044880: 696e 742c 2063 6f64 653a 2073 7472 203d  int, code: str =
+00044890: 2022 222c 206d 6f64 653a 2073 7472 207c   "", mode: str |
+000448a0: 204e 6f6e 6520 3d20 4e6f 6e65 0a20 2020   None = None.   
+000448b0: 2029 202d 3e20 7374 723a 0a20 2020 2020   ) -> str:.     
+000448c0: 2020 2073 746f 7020 3d20 7469 6d65 2829     stop = time()
+000448d0: 0a20 2020 2020 2020 2023 2050 726f 6669  .        # Profi
+000448e0: 6c65 730a 2020 2020 2020 2020 636f 6d70  les.        comp
+000448f0: 7574 652c 2073 6368 6564 756c 6572 2c20  ute, scheduler, 
+00044900: 776f 726b 6572 7320 3d20 6177 6169 7420  workers = await 
+00044910: 6173 796e 6369 6f2e 6761 7468 6572 280a  asyncio.gather(.
+00044920: 2020 2020 2020 2020 2020 2020 2a5b 0a20              *[. 
+00044930: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00044940: 656c 662e 6765 745f 7072 6f66 696c 6528  elf.get_profile(
+00044950: 7374 6172 743d 7374 6172 7429 2c0a 2020  start=start),.  
+00044960: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00044970: 6c66 2e67 6574 5f70 726f 6669 6c65 2873  lf.get_profile(s
+00044980: 6368 6564 756c 6572 3d54 7275 652c 2073  cheduler=True, s
+00044990: 7461 7274 3d73 7461 7274 292c 0a20 2020  tart=start),.   
+000449a0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+000449b0: 662e 6765 745f 7072 6f66 696c 6528 7365  f.get_profile(se
+000449c0: 7276 6572 3d54 7275 652c 2073 7461 7274  rver=True, start
+000449d0: 3d73 7461 7274 292c 0a20 2020 2020 2020  =start),.       
+000449e0: 2020 2020 205d 0a20 2020 2020 2020 2029       ].        )
+000449f0: 0a20 2020 2020 2020 2066 726f 6d20 6469  .        from di
+00044a00: 7374 7269 6275 7465 6420 696d 706f 7274  stributed import
+00044a10: 2070 726f 6669 6c65 0a0a 2020 2020 2020   profile..      
+00044a20: 2020 6465 6620 7072 6f66 696c 655f 746f    def profile_to
+00044a30: 5f66 6967 7572 6528 7374 6174 6529 3a0a  _figure(state):.
+00044a40: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00044a50: 203d 2070 726f 6669 6c65 2e70 6c6f 745f   = profile.plot_
+00044a60: 6461 7461 2873 7461 7465 290a 2020 2020  data(state).    
+00044a70: 2020 2020 2020 2020 6669 6775 7265 2c20          figure, 
+00044a80: 736f 7572 6365 203d 2070 726f 6669 6c65  source = profile
+00044a90: 2e70 6c6f 745f 6669 6775 7265 2864 6174  .plot_figure(dat
+00044aa0: 612c 2073 697a 696e 675f 6d6f 6465 3d22  a, sizing_mode="
+00044ab0: 7374 7265 7463 685f 626f 7468 2229 0a20  stretch_both"). 
+00044ac0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00044ad0: 6e20 6669 6775 7265 0a0a 2020 2020 2020  n figure..      
+00044ae0: 2020 636f 6d70 7574 652c 2073 6368 6564    compute, sched
+00044af0: 756c 6572 2c20 776f 726b 6572 7320 3d20  uler, workers = 
+00044b00: 6d61 7028 0a20 2020 2020 2020 2020 2020  map(.           
+00044b10: 2070 726f 6669 6c65 5f74 6f5f 6669 6775   profile_to_figu
+00044b20: 7265 2c20 2863 6f6d 7075 7465 2c20 7363  re, (compute, sc
+00044b30: 6865 6475 6c65 722c 2077 6f72 6b65 7273  heduler, workers
+00044b40: 290a 2020 2020 2020 2020 290a 0a20 2020  ).        )..   
+00044b50: 2020 2020 2023 2054 6173 6b20 7374 7265       # Task stre
+00044b60: 616d 0a20 2020 2020 2020 2074 6173 6b5f  am.        task_
+00044b70: 7374 7265 616d 203d 2073 656c 662e 6765  stream = self.ge
+00044b80: 745f 7461 736b 5f73 7472 6561 6d28 7374  t_task_stream(st
+00044b90: 6172 743d 7374 6172 7429 0a20 2020 2020  art=start).     
+00044ba0: 2020 2074 6f74 616c 5f74 6173 6b73 203d     total_tasks =
+00044bb0: 206c 656e 2874 6173 6b5f 7374 7265 616d   len(task_stream
+00044bc0: 290a 2020 2020 2020 2020 7469 6d65 7370  ).        timesp
+00044bd0: 656e 743a 2064 6566 6175 6c74 6469 6374  ent: defaultdict
+00044be0: 5b73 7472 2c20 666c 6f61 745d 203d 2064  [str, float] = d
+00044bf0: 6566 6175 6c74 6469 6374 2866 6c6f 6174  efaultdict(float
+00044c00: 290a 2020 2020 2020 2020 666f 7220 6420  ).        for d 
+00044c10: 696e 2074 6173 6b5f 7374 7265 616d 3a0a  in task_stream:.
+00044c20: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00044c30: 7820 696e 2064 5b22 7374 6172 7473 746f  x in d["startsto
+00044c40: 7073 225d 3a0a 2020 2020 2020 2020 2020  ps"]:.          
+00044c50: 2020 2020 2020 7469 6d65 7370 656e 745b        timespent[
+00044c60: 785b 2261 6374 696f 6e22 5d5d 202b 3d20  x["action"]] += 
+00044c70: 785b 2273 746f 7022 5d20 2d20 785b 2273  x["stop"] - x["s
+00044c80: 7461 7274 225d 0a20 2020 2020 2020 2074  tart"].        t
+00044c90: 6173 6b73 5f74 696d 696e 6773 203d 2022  asks_timings = "
+00044ca0: 220a 2020 2020 2020 2020 666f 7220 6b20  ".        for k 
+00044cb0: 696e 2073 6f72 7465 6428 7469 6d65 7370  in sorted(timesp
+00044cc0: 656e 742e 6b65 7973 2829 293a 0a20 2020  ent.keys()):.   
+00044cd0: 2020 2020 2020 2020 2074 6173 6b73 5f74           tasks_t
+00044ce0: 696d 696e 6773 202b 3d20 6622 5c6e 3c6c  imings += f"\n<l
+00044cf0: 693e 207b 6b7d 2074 696d 653a 207b 666f  i> {k} time: {fo
+00044d00: 726d 6174 5f74 696d 6528 7469 6d65 7370  rmat_time(timesp
+00044d10: 656e 745b 6b5d 297d 203c 2f6c 693e 220a  ent[k])} </li>".
+00044d20: 0a20 2020 2020 2020 2066 726f 6d20 6469  .        from di
+00044d30: 7374 7269 6275 7465 642e 6461 7368 626f  stributed.dashbo
+00044d40: 6172 642e 636f 6d70 6f6e 656e 7473 2e73  ard.components.s
+00044d50: 6368 6564 756c 6572 2069 6d70 6f72 7420  cheduler import 
+00044d60: 7461 736b 5f73 7472 6561 6d5f 6669 6775  task_stream_figu
+00044d70: 7265 0a20 2020 2020 2020 2066 726f 6d20  re.        from 
+00044d80: 6469 7374 7269 6275 7465 642e 6469 6167  distributed.diag
+00044d90: 6e6f 7374 6963 732e 7461 736b 5f73 7472  nostics.task_str
+00044da0: 6561 6d20 696d 706f 7274 2072 6563 7461  eam import recta
+00044db0: 6e67 6c65 730a 0a20 2020 2020 2020 2072  ngles..        r
+00044dc0: 6563 7473 203d 2072 6563 7461 6e67 6c65  ects = rectangle
+00044dd0: 7328 7461 736b 5f73 7472 6561 6d29 0a20  s(task_stream). 
+00044de0: 2020 2020 2020 2073 6f75 7263 652c 2074         source, t
+00044df0: 6173 6b5f 7374 7265 616d 203d 2074 6173  ask_stream = tas
+00044e00: 6b5f 7374 7265 616d 5f66 6967 7572 6528  k_stream_figure(
+00044e10: 7369 7a69 6e67 5f6d 6f64 653d 2273 7472  sizing_mode="str
+00044e20: 6574 6368 5f62 6f74 6822 290a 2020 2020  etch_both").    
+00044e30: 2020 2020 736f 7572 6365 2e64 6174 612e      source.data.
+00044e40: 7570 6461 7465 2872 6563 7473 290a 0a20  update(rects).. 
+00044e50: 2020 2020 2020 2023 2042 616e 6477 6964         # Bandwid
+00044e60: 7468 0a20 2020 2020 2020 2066 726f 6d20  th.        from 
+00044e70: 6469 7374 7269 6275 7465 642e 6461 7368  distributed.dash
+00044e80: 626f 6172 642e 636f 6d70 6f6e 656e 7473  board.components
+00044e90: 2e73 6368 6564 756c 6572 2069 6d70 6f72  .scheduler impor
+00044ea0: 7420 280a 2020 2020 2020 2020 2020 2020  t (.            
+00044eb0: 4261 6e64 7769 6474 6854 7970 6573 2c0a  BandwidthTypes,.
+00044ec0: 2020 2020 2020 2020 2020 2020 4261 6e64              Band
+00044ed0: 7769 6474 6857 6f72 6b65 7273 2c0a 2020  widthWorkers,.  
+00044ee0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00044ef0: 2062 616e 6477 6964 7468 5f77 6f72 6b65   bandwidth_worke
+00044f00: 7273 203d 2042 616e 6477 6964 7468 576f  rs = BandwidthWo
+00044f10: 726b 6572 7328 7365 6c66 2c20 7369 7a69  rkers(self, sizi
+00044f20: 6e67 5f6d 6f64 653d 2273 7472 6574 6368  ng_mode="stretch
+00044f30: 5f62 6f74 6822 290a 2020 2020 2020 2020  _both").        
+00044f40: 6261 6e64 7769 6474 685f 776f 726b 6572  bandwidth_worker
+00044f50: 732e 7570 6461 7465 2829 0a20 2020 2020  s.update().     
+00044f60: 2020 2062 616e 6477 6964 7468 5f74 7970     bandwidth_typ
+00044f70: 6573 203d 2042 616e 6477 6964 7468 5479  es = BandwidthTy
+00044f80: 7065 7328 7365 6c66 2c20 7369 7a69 6e67  pes(self, sizing
+00044f90: 5f6d 6f64 653d 2273 7472 6574 6368 5f62  _mode="stretch_b
+00044fa0: 6f74 6822 290a 2020 2020 2020 2020 6261  oth").        ba
+00044fb0: 6e64 7769 6474 685f 7479 7065 732e 7570  ndwidth_types.up
+00044fc0: 6461 7465 2829 0a0a 2020 2020 2020 2020  date()..        
+00044fd0: 2320 5379 7374 656d 206d 6f6e 6974 6f72  # System monitor
+00044fe0: 0a20 2020 2020 2020 2066 726f 6d20 6469  .        from di
+00044ff0: 7374 7269 6275 7465 642e 6461 7368 626f  stributed.dashbo
+00045000: 6172 642e 636f 6d70 6f6e 656e 7473 2e73  ard.components.s
+00045010: 6861 7265 6420 696d 706f 7274 2053 7973  hared import Sys
+00045020: 7465 6d4d 6f6e 6974 6f72 0a0a 2020 2020  temMonitor..    
+00045030: 2020 2020 7379 736d 6f6e 203d 2053 7973      sysmon = Sys
+00045040: 7465 6d4d 6f6e 6974 6f72 2873 656c 662c  temMonitor(self,
+00045050: 206c 6173 745f 636f 756e 743d 6c61 7374   last_count=last
+00045060: 5f63 6f75 6e74 2c20 7369 7a69 6e67 5f6d  _count, sizing_m
+00045070: 6f64 653d 2273 7472 6574 6368 5f62 6f74  ode="stretch_bot
+00045080: 6822 290a 2020 2020 2020 2020 7379 736d  h").        sysm
+00045090: 6f6e 2e75 7064 6174 6528 290a 0a20 2020  on.update()..   
+000450a0: 2020 2020 2023 2053 6368 6564 756c 6572       # Scheduler
+000450b0: 206c 6f67 730a 2020 2020 2020 2020 6672   logs.        fr
+000450c0: 6f6d 2064 6973 7472 6962 7574 6564 2e64  om distributed.d
+000450d0: 6173 6862 6f61 7264 2e63 6f6d 706f 6e65  ashboard.compone
+000450e0: 6e74 732e 7363 6865 6475 6c65 7220 696d  nts.scheduler im
+000450f0: 706f 7274 2028 0a20 2020 2020 2020 2020  port (.         
+00045100: 2020 205f 424f 4b45 485f 5354 594c 4553     _BOKEH_STYLES
+00045110: 5f4b 5741 5247 532c 0a20 2020 2020 2020  _KWARGS,.       
+00045120: 2020 2020 2053 6368 6564 756c 6572 4c6f       SchedulerLo
+00045130: 6773 2c0a 2020 2020 2020 2020 290a 0a20  gs,.        ).. 
+00045140: 2020 2020 2020 206c 6f67 7320 3d20 5363         logs = Sc
+00045150: 6865 6475 6c65 724c 6f67 7328 7365 6c66  hedulerLogs(self
+00045160: 2c20 7374 6172 743d 7374 6172 7429 0a0a  , start=start)..
+00045170: 2020 2020 2020 2020 6672 6f6d 2062 6f6b          from bok
+00045180: 6568 2e6d 6f64 656c 7320 696d 706f 7274  eh.models import
+00045190: 2044 6976 2c20 5461 6273 0a0a 2020 2020   Div, Tabs..    
+000451a0: 2020 2020 696d 706f 7274 2064 6973 7472      import distr
+000451b0: 6962 7574 6564 0a20 2020 2020 2020 2066  ibuted.        f
+000451c0: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
+000451d0: 6461 7368 626f 6172 642e 636f 7265 2069  dashboard.core i
+000451e0: 6d70 6f72 7420 5461 6250 616e 656c 0a0a  mport TabPanel..
+000451f0: 2020 2020 2020 2020 2320 4854 4d4c 0a20          # HTML. 
+00045200: 2020 2020 2020 2068 746d 6c20 3d20 2222         html = ""
+00045210: 220a 2020 2020 2020 2020 3c68 313e 2044  ".        <h1> D
+00045220: 6173 6b20 5065 7266 6f72 6d61 6e63 6520  ask Performance 
+00045230: 5265 706f 7274 203c 2f68 313e 0a0a 2020  Report </h1>..  
+00045240: 2020 2020 2020 3c69 3e20 5365 6c65 6374        <i> Select
+00045250: 2064 6966 6665 7265 6e74 2074 6162 7320   different tabs 
+00045260: 6f6e 2074 6865 2074 6f70 2066 6f72 2061  on the top for a
+00045270: 6464 6974 696f 6e61 6c20 696e 666f 726d  dditional inform
+00045280: 6174 696f 6e20 3c2f 693e 0a0a 2020 2020  ation </i>..    
+00045290: 2020 2020 3c68 323e 2044 7572 6174 696f      <h2> Duratio
+000452a0: 6e3a 207b 7469 6d65 7d20 3c2f 6832 3e0a  n: {time} </h2>.
+000452b0: 2020 2020 2020 2020 3c68 323e 2054 6173          <h2> Tas
+000452c0: 6b73 2049 6e66 6f72 6d61 7469 6f6e 203c  ks Information <
+000452d0: 2f68 323e 0a20 2020 2020 2020 203c 756c  /h2>.        <ul
+000452e0: 3e0a 2020 2020 2020 2020 203c 6c69 3e20  >.         <li> 
+000452f0: 6e75 6d62 6572 206f 6620 7461 736b 733a  number of tasks:
+00045300: 207b 6e74 6173 6b73 7d20 3c2f 6c69 3e0a   {ntasks} </li>.
+00045310: 2020 2020 2020 2020 207b 7461 736b 735f           {tasks_
+00045320: 7469 6d69 6e67 737d 0a20 2020 2020 2020  timings}.       
+00045330: 203c 2f75 6c3e 0a0a 2020 2020 2020 2020   </ul>..        
+00045340: 3c68 323e 2053 6368 6564 756c 6572 2049  <h2> Scheduler I
+00045350: 6e66 6f72 6d61 7469 6f6e 203c 2f68 323e  nformation </h2>
+00045360: 0a20 2020 2020 2020 203c 756c 3e0a 2020  .        <ul>.  
+00045370: 2020 2020 2020 2020 3c6c 693e 2041 6464          <li> Add
+00045380: 7265 7373 3a20 7b61 6464 7265 7373 7d20  ress: {address} 
+00045390: 3c2f 6c69 3e0a 2020 2020 2020 2020 2020  </li>.          
+000453a0: 3c6c 693e 2057 6f72 6b65 7273 3a20 7b6e  <li> Workers: {n
+000453b0: 776f 726b 6572 737d 203c 2f6c 693e 0a20  workers} </li>. 
+000453c0: 2020 2020 2020 2020 203c 6c69 3e20 5468           <li> Th
+000453d0: 7265 6164 733a 207b 7468 7265 6164 737d  reads: {threads}
+000453e0: 203c 2f6c 693e 0a20 2020 2020 2020 2020   </li>.         
+000453f0: 203c 6c69 3e20 4d65 6d6f 7279 3a20 7b6d   <li> Memory: {m
+00045400: 656d 6f72 797d 203c 2f6c 693e 0a20 2020  emory} </li>.   
+00045410: 2020 2020 2020 203c 6c69 3e20 4461 736b         <li> Dask
+00045420: 2056 6572 7369 6f6e 3a20 7b64 6173 6b5f   Version: {dask_
+00045430: 7665 7273 696f 6e7d 203c 2f6c 693e 0a20  version} </li>. 
+00045440: 2020 2020 2020 2020 203c 6c69 3e20 4461           <li> Da
+00045450: 736b 2e44 6973 7472 6962 7574 6564 2056  sk.Distributed V
+00045460: 6572 7369 6f6e 3a20 7b64 6973 7472 6962  ersion: {distrib
+00045470: 7574 6564 5f76 6572 7369 6f6e 7d20 3c2f  uted_version} </
+00045480: 6c69 3e0a 2020 2020 2020 2020 3c2f 756c  li>.        </ul
+00045490: 3e0a 0a20 2020 2020 2020 203c 6832 3e20  >..        <h2> 
+000454a0: 4361 6c6c 696e 6720 436f 6465 203c 2f68  Calling Code </h
+000454b0: 323e 0a20 2020 2020 2020 203c 7072 653e  2>.        <pre>
+000454c0: 0a7b 636f 6465 7d0a 2020 2020 2020 2020  .{code}.        
+000454d0: 3c2f 7072 653e 0a20 2020 2020 2020 2022  </pre>.        "
+000454e0: 2222 2e66 6f72 6d61 7428 0a20 2020 2020  "".format(.     
+000454f0: 2020 2020 2020 2074 696d 653d 666f 726d         time=form
+00045500: 6174 5f74 696d 6528 7374 6f70 202d 2073  at_time(stop - s
+00045510: 7461 7274 292c 0a20 2020 2020 2020 2020  tart),.         
+00045520: 2020 206e 7461 736b 733d 746f 7461 6c5f     ntasks=total_
+00045530: 7461 736b 732c 0a20 2020 2020 2020 2020  tasks,.         
+00045540: 2020 2074 6173 6b73 5f74 696d 696e 6773     tasks_timings
+00045550: 3d74 6173 6b73 5f74 696d 696e 6773 2c0a  =tasks_timings,.
+00045560: 2020 2020 2020 2020 2020 2020 6164 6472              addr
+00045570: 6573 733d 7365 6c66 2e61 6464 7265 7373  ess=self.address
+00045580: 2c0a 2020 2020 2020 2020 2020 2020 6e77  ,.            nw
+00045590: 6f72 6b65 7273 3d6c 656e 2873 656c 662e  orkers=len(self.
+000455a0: 776f 726b 6572 7329 2c0a 2020 2020 2020  workers),.      
+000455b0: 2020 2020 2020 7468 7265 6164 733d 7375        threads=su
+000455c0: 6d28 7773 2e6e 7468 7265 6164 7320 666f  m(ws.nthreads fo
+000455d0: 7220 7773 2069 6e20 7365 6c66 2e77 6f72  r ws in self.wor
+000455e0: 6b65 7273 2e76 616c 7565 7328 2929 2c0a  kers.values()),.
+000455f0: 2020 2020 2020 2020 2020 2020 6d65 6d6f              memo
+00045600: 7279 3d66 6f72 6d61 745f 6279 7465 7328  ry=format_bytes(
+00045610: 7375 6d28 7773 2e6d 656d 6f72 795f 6c69  sum(ws.memory_li
+00045620: 6d69 7420 666f 7220 7773 2069 6e20 7365  mit for ws in se
+00045630: 6c66 2e77 6f72 6b65 7273 2e76 616c 7565  lf.workers.value
+00045640: 7328 2929 292c 0a20 2020 2020 2020 2020  s())),.         
+00045650: 2020 2063 6f64 653d 636f 6465 2c0a 2020     code=code,.  
+00045660: 2020 2020 2020 2020 2020 6461 736b 5f76            dask_v
+00045670: 6572 7369 6f6e 3d64 6173 6b2e 5f5f 7665  ersion=dask.__ve
+00045680: 7273 696f 6e5f 5f2c 0a20 2020 2020 2020  rsion__,.       
+00045690: 2020 2020 2064 6973 7472 6962 7574 6564       distributed
+000456a0: 5f76 6572 7369 6f6e 3d64 6973 7472 6962  _version=distrib
+000456b0: 7574 6564 2e5f 5f76 6572 7369 6f6e 5f5f  uted.__version__
+000456c0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+000456d0: 2020 2020 6874 6d6c 203d 2044 6976 2874      html = Div(t
+000456e0: 6578 743d 6874 6d6c 2c20 2a2a 5f42 4f4b  ext=html, **_BOK
+000456f0: 4548 5f53 5459 4c45 535f 4b57 4152 4753  EH_STYLES_KWARGS
+00045700: 290a 0a20 2020 2020 2020 2068 746d 6c20  )..        html 
+00045710: 3d20 5461 6250 616e 656c 2863 6869 6c64  = TabPanel(child
+00045720: 3d68 746d 6c2c 2074 6974 6c65 3d22 5375  =html, title="Su
+00045730: 6d6d 6172 7922 290a 2020 2020 2020 2020  mmary").        
+00045740: 636f 6d70 7574 6520 3d20 5461 6250 616e  compute = TabPan
+00045750: 656c 2863 6869 6c64 3d63 6f6d 7075 7465  el(child=compute
+00045760: 2c20 7469 746c 653d 2257 6f72 6b65 7220  , title="Worker 
+00045770: 5072 6f66 696c 6520 2863 6f6d 7075 7465  Profile (compute
+00045780: 2922 290a 2020 2020 2020 2020 776f 726b  )").        work
+00045790: 6572 7320 3d20 5461 6250 616e 656c 2863  ers = TabPanel(c
+000457a0: 6869 6c64 3d77 6f72 6b65 7273 2c20 7469  hild=workers, ti
+000457b0: 746c 653d 2257 6f72 6b65 7220 5072 6f66  tle="Worker Prof
+000457c0: 696c 6520 2861 646d 696e 6973 7472 6174  ile (administrat
+000457d0: 6976 6529 2229 0a20 2020 2020 2020 2073  ive)").        s
+000457e0: 6368 6564 756c 6572 203d 2054 6162 5061  cheduler = TabPa
+000457f0: 6e65 6c28 0a20 2020 2020 2020 2020 2020  nel(.           
+00045800: 2063 6869 6c64 3d73 6368 6564 756c 6572   child=scheduler
+00045810: 2c20 7469 746c 653d 2253 6368 6564 756c  , title="Schedul
+00045820: 6572 2050 726f 6669 6c65 2028 6164 6d69  er Profile (admi
+00045830: 6e69 7374 7261 7469 7665 2922 0a20 2020  nistrative)".   
+00045840: 2020 2020 2029 0a20 2020 2020 2020 2074       ).        t
+00045850: 6173 6b5f 7374 7265 616d 203d 2054 6162  ask_stream = Tab
+00045860: 5061 6e65 6c28 6368 696c 643d 7461 736b  Panel(child=task
+00045870: 5f73 7472 6561 6d2c 2074 6974 6c65 3d22  _stream, title="
+00045880: 5461 736b 2053 7472 6561 6d22 290a 2020  Task Stream").  
+00045890: 2020 2020 2020 6261 6e64 7769 6474 685f        bandwidth_
+000458a0: 776f 726b 6572 7320 3d20 5461 6250 616e  workers = TabPan
+000458b0: 656c 280a 2020 2020 2020 2020 2020 2020  el(.            
+000458c0: 6368 696c 643d 6261 6e64 7769 6474 685f  child=bandwidth_
+000458d0: 776f 726b 6572 732e 726f 6f74 2c20 7469  workers.root, ti
+000458e0: 746c 653d 2242 616e 6477 6964 7468 2028  tle="Bandwidth (
+000458f0: 576f 726b 6572 7329 220a 2020 2020 2020  Workers)".      
+00045900: 2020 290a 2020 2020 2020 2020 6261 6e64    ).        band
+00045910: 7769 6474 685f 7479 7065 7320 3d20 5461  width_types = Ta
+00045920: 6250 616e 656c 280a 2020 2020 2020 2020  bPanel(.        
+00045930: 2020 2020 6368 696c 643d 6261 6e64 7769      child=bandwi
+00045940: 6474 685f 7479 7065 732e 726f 6f74 2c20  dth_types.root, 
+00045950: 7469 746c 653d 2242 616e 6477 6964 7468  title="Bandwidth
+00045960: 2028 5479 7065 7329 220a 2020 2020 2020   (Types)".      
+00045970: 2020 290a 2020 2020 2020 2020 7379 7374    ).        syst
+00045980: 656d 203d 2054 6162 5061 6e65 6c28 6368  em = TabPanel(ch
+00045990: 696c 643d 7379 736d 6f6e 2e72 6f6f 742c  ild=sysmon.root,
+000459a0: 2074 6974 6c65 3d22 5379 7374 656d 2229   title="System")
+000459b0: 0a20 2020 2020 2020 206c 6f67 7320 3d20  .        logs = 
+000459c0: 5461 6250 616e 656c 2863 6869 6c64 3d6c  TabPanel(child=l
+000459d0: 6f67 732e 726f 6f74 2c20 7469 746c 653d  ogs.root, title=
+000459e0: 2253 6368 6564 756c 6572 204c 6f67 7322  "Scheduler Logs"
+000459f0: 290a 0a20 2020 2020 2020 2074 6162 7320  )..        tabs 
+00045a00: 3d20 5461 6273 280a 2020 2020 2020 2020  = Tabs(.        
+00045a10: 2020 2020 7461 6273 3d5b 0a20 2020 2020      tabs=[.     
+00045a20: 2020 2020 2020 2020 2020 2068 746d 6c2c             html,
+00045a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00045a40: 2074 6173 6b5f 7374 7265 616d 2c0a 2020   task_stream,.  
+00045a50: 2020 2020 2020 2020 2020 2020 2020 7379                sy
+00045a60: 7374 656d 2c0a 2020 2020 2020 2020 2020  stem,.          
+00045a70: 2020 2020 2020 6c6f 6773 2c0a 2020 2020        logs,.    
+00045a80: 2020 2020 2020 2020 2020 2020 636f 6d70              comp
+00045a90: 7574 652c 0a20 2020 2020 2020 2020 2020  ute,.           
+00045aa0: 2020 2020 2077 6f72 6b65 7273 2c0a 2020       workers,.  
+00045ab0: 2020 2020 2020 2020 2020 2020 2020 7363                sc
+00045ac0: 6865 6475 6c65 722c 0a20 2020 2020 2020  heduler,.       
+00045ad0: 2020 2020 2020 2020 2062 616e 6477 6964           bandwid
+00045ae0: 7468 5f77 6f72 6b65 7273 2c0a 2020 2020  th_workers,.    
+00045af0: 2020 2020 2020 2020 2020 2020 6261 6e64              band
+00045b00: 7769 6474 685f 7479 7065 732c 0a20 2020  width_types,.   
+00045b10: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
+00045b20: 2020 2020 2020 2020 7369 7a69 6e67 5f6d          sizing_m
+00045b30: 6f64 653d 2273 7472 6574 6368 5f62 6f74  ode="stretch_bot
+00045b40: 6822 2c0a 2020 2020 2020 2020 290a 0a20  h",.        ).. 
+00045b50: 2020 2020 2020 2066 726f 6d20 626f 6b65         from boke
+00045b60: 682e 636f 7265 2e74 656d 706c 6174 6573  h.core.templates
+00045b70: 2069 6d70 6f72 7420 6765 745f 656e 760a   import get_env.
+00045b80: 2020 2020 2020 2020 6672 6f6d 2062 6f6b          from bok
+00045b90: 6568 2e70 6c6f 7474 696e 6720 696d 706f  eh.plotting impo
+00045ba0: 7274 206f 7574 7075 745f 6669 6c65 2c20  rt output_file, 
+00045bb0: 7361 7665 0a0a 2020 2020 2020 2020 7769  save..        wi
+00045bc0: 7468 2074 6d70 6669 6c65 2865 7874 656e  th tmpfile(exten
+00045bd0: 7369 6f6e 3d22 2e68 746d 6c22 2920 6173  sion=".html") as
+00045be0: 2066 6e3a 0a20 2020 2020 2020 2020 2020   fn:.           
+00045bf0: 206f 7574 7075 745f 6669 6c65 2866 696c   output_file(fil
+00045c00: 656e 616d 653d 666e 2c20 7469 746c 653d  ename=fn, title=
+00045c10: 2244 6173 6b20 5065 7266 6f72 6d61 6e63  "Dask Performanc
+00045c20: 6520 5265 706f 7274 222c 206d 6f64 653d  e Report", mode=
+00045c30: 6d6f 6465 290a 2020 2020 2020 2020 2020  mode).          
+00045c40: 2020 7465 6d70 6c61 7465 5f64 6972 6563    template_direc
+00045c50: 746f 7279 203d 206f 732e 7061 7468 2e6a  tory = os.path.j
+00045c60: 6f69 6e28 0a20 2020 2020 2020 2020 2020  oin(.           
+00045c70: 2020 2020 206f 732e 7061 7468 2e64 6972       os.path.dir
+00045c80: 6e61 6d65 286f 732e 7061 7468 2e61 6273  name(os.path.abs
+00045c90: 7061 7468 285f 5f66 696c 655f 5f29 292c  path(__file__)),
+00045ca0: 2022 6461 7368 626f 6172 6422 2c20 2274   "dashboard", "t
+00045cb0: 656d 706c 6174 6573 220a 2020 2020 2020  emplates".      
+00045cc0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00045cd0: 2020 2020 7465 6d70 6c61 7465 5f65 6e76      template_env
+00045ce0: 6972 6f6e 6d65 6e74 203d 2067 6574 5f65  ironment = get_e
+00045cf0: 6e76 2829 0a20 2020 2020 2020 2020 2020  nv().           
+00045d00: 2074 656d 706c 6174 655f 656e 7669 726f   template_enviro
+00045d10: 6e6d 656e 742e 6c6f 6164 6572 2e73 6561  nment.loader.sea
+00045d20: 7263 6870 6174 682e 6170 7065 6e64 2874  rchpath.append(t
+00045d30: 656d 706c 6174 655f 6469 7265 6374 6f72  emplate_director
+00045d40: 7929 0a20 2020 2020 2020 2020 2020 2074  y).            t
+00045d50: 656d 706c 6174 6520 3d20 7465 6d70 6c61  emplate = templa
+00045d60: 7465 5f65 6e76 6972 6f6e 6d65 6e74 2e67  te_environment.g
+00045d70: 6574 5f74 656d 706c 6174 6528 2270 6572  et_template("per
+00045d80: 666f 726d 616e 6365 5f72 6570 6f72 742e  formance_report.
+00045d90: 6874 6d6c 2229 0a20 2020 2020 2020 2020  html").         
+00045da0: 2020 2073 6176 6528 7461 6273 2c20 6669     save(tabs, fi
+00045db0: 6c65 6e61 6d65 3d66 6e2c 2074 656d 706c  lename=fn, templ
+00045dc0: 6174 653d 7465 6d70 6c61 7465 290a 0a20  ate=template).. 
+00045dd0: 2020 2020 2020 2020 2020 2077 6974 6820             with 
+00045de0: 6f70 656e 2866 6e29 2061 7320 663a 0a20  open(fn) as f:. 
+00045df0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00045e00: 6174 6120 3d20 662e 7265 6164 2829 0a0a  ata = f.read()..
+00045e10: 2020 2020 2020 2020 7265 7475 726e 2064          return d
+00045e20: 6174 610a 0a20 2020 2061 7379 6e63 2064  ata..    async d
+00045e30: 6566 2067 6574 5f77 6f72 6b65 725f 6c6f  ef get_worker_lo
+00045e40: 6773 2873 656c 662c 206e 3d4e 6f6e 652c  gs(self, n=None,
+00045e50: 2077 6f72 6b65 7273 3d4e 6f6e 652c 206e   workers=None, n
+00045e60: 616e 6e79 3d46 616c 7365 293a 0a20 2020  anny=False):.   
+00045e70: 2020 2020 2072 6573 756c 7473 203d 2061       results = a
+00045e80: 7761 6974 2073 656c 662e 6272 6f61 6463  wait self.broadc
+00045e90: 6173 7428 0a20 2020 2020 2020 2020 2020  ast(.           
+00045ea0: 206d 7367 3d7b 226f 7022 3a20 2267 6574   msg={"op": "get
+00045eb0: 5f6c 6f67 7322 2c20 226e 223a 206e 7d2c  _logs", "n": n},
+00045ec0: 2077 6f72 6b65 7273 3d77 6f72 6b65 7273   workers=workers
+00045ed0: 2c20 6e61 6e6e 793d 6e61 6e6e 790a 2020  , nanny=nanny.  
+00045ee0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00045ef0: 7265 7475 726e 2072 6573 756c 7473 0a0a  return results..
+00045f00: 2020 2020 6465 6620 6c6f 675f 6576 656e      def log_even
+00045f10: 7428 7365 6c66 2c20 746f 7069 633a 2073  t(self, topic: s
+00045f20: 7472 207c 2043 6f6c 6c65 6374 696f 6e5b  tr | Collection[
+00045f30: 7374 725d 2c20 6d73 673a 2041 6e79 2920  str], msg: Any) 
+00045f40: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00045f50: 2022 2222 4c6f 6720 616e 2065 7665 6e74   """Log an event
+00045f60: 2075 6e64 6572 2061 2067 6976 656e 2074   under a given t
+00045f70: 6f70 6963 0a0a 2020 2020 2020 2020 5061  opic..        Pa
+00045f80: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
+00045f90: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+00045fa0: 2020 2020 746f 7069 6320 3a20 7374 722c      topic : str,
+00045fb0: 206c 6973 745b 7374 725d 0a20 2020 2020   list[str].     
+00045fc0: 2020 2020 2020 204e 616d 6520 6f66 2074         Name of t
+00045fd0: 6865 2074 6f70 6963 2075 6e64 6572 2077  he topic under w
+00045fe0: 6869 6368 2074 6f20 6c6f 6720 616e 2065  hich to log an e
+00045ff0: 7665 6e74 2e20 546f 206c 6f67 2074 6865  vent. To log the
+00046000: 2073 616d 650a 2020 2020 2020 2020 2020   same.          
+00046010: 2020 6576 656e 7420 756e 6465 7220 6d75    event under mu
+00046020: 6c74 6970 6c65 2074 6f70 6963 732c 2070  ltiple topics, p
+00046030: 6173 7320 6120 6c69 7374 206f 6620 746f  ass a list of to
+00046040: 7069 6320 6e61 6d65 732e 0a20 2020 2020  pic names..     
+00046050: 2020 206d 7367 0a20 2020 2020 2020 2020     msg.         
+00046060: 2020 2045 7665 6e74 206d 6573 7361 6765     Event message
+00046070: 2074 6f20 6c6f 672e 204e 6f74 6520 7468   to log. Note th
+00046080: 6973 206d 7573 7420 6265 206d 7367 7061  is must be msgpa
+00046090: 636b 2073 6572 6961 6c69 7a61 626c 652e  ck serializable.
+000460a0: 0a0a 2020 2020 2020 2020 5365 6520 616c  ..        See al
+000460b0: 736f 0a20 2020 2020 2020 202d 2d2d 2d2d  so.        -----
+000460c0: 2d2d 2d0a 2020 2020 2020 2020 436c 6965  ---.        Clie
+000460d0: 6e74 2e6c 6f67 5f65 7665 6e74 0a20 2020  nt.log_event.   
+000460e0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000460f0: 2065 7665 6e74 203d 2028 7469 6d65 2829   event = (time()
+00046100: 2c20 6d73 6729 0a20 2020 2020 2020 2069  , msg).        i
+00046110: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
+00046120: 2874 6f70 6963 2c20 7374 7229 3a0a 2020  (topic, str):.  
+00046130: 2020 2020 2020 2020 2020 666f 7220 7420            for t 
+00046140: 696e 2074 6f70 6963 3a0a 2020 2020 2020  in topic:.      
+00046150: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
+00046160: 7665 6e74 735b 745d 2e61 7070 656e 6428  vents[t].append(
+00046170: 6576 656e 7429 0a20 2020 2020 2020 2020  event).         
+00046180: 2020 2020 2020 2073 656c 662e 6576 656e         self.even
+00046190: 745f 636f 756e 7473 5b74 5d20 2b3d 2031  t_counts[t] += 1
+000461a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000461b0: 2073 656c 662e 5f72 6570 6f72 745f 6576   self._report_ev
+000461c0: 656e 7428 742c 2065 7665 6e74 290a 2020  ent(t, event).  
+000461d0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000461e0: 2020 2020 2020 2020 7365 6c66 2e65 7665          self.eve
+000461f0: 6e74 735b 746f 7069 635d 2e61 7070 656e  nts[topic].appen
+00046200: 6428 6576 656e 7429 0a20 2020 2020 2020  d(event).       
+00046210: 2020 2020 2073 656c 662e 6576 656e 745f       self.event_
+00046220: 636f 756e 7473 5b74 6f70 6963 5d20 2b3d  counts[topic] +=
+00046230: 2031 0a20 2020 2020 2020 2020 2020 2073   1.            s
+00046240: 656c 662e 5f72 6570 6f72 745f 6576 656e  elf._report_even
+00046250: 7428 746f 7069 632c 2065 7665 6e74 290a  t(topic, event).
+00046260: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00046270: 2070 6c75 6769 6e20 696e 206c 6973 7428   plugin in list(
+00046280: 7365 6c66 2e70 6c75 6769 6e73 2e76 616c  self.plugins.val
+00046290: 7565 7328 2929 3a0a 2020 2020 2020 2020  ues()):.        
+000462a0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+000462b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000462c0: 2070 6c75 6769 6e2e 6c6f 675f 6576 656e   plugin.log_even
+000462d0: 7428 746f 7069 632c 206d 7367 290a 2020  t(topic, msg).  
+000462e0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+000462f0: 6365 7074 2045 7863 6570 7469 6f6e 3a0a  cept Exception:.
+00046300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046310: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+00046320: 2250 6c75 6769 6e20 6661 696c 6564 2077  "Plugin failed w
+00046330: 6974 6820 6578 6365 7074 696f 6e22 2c20  ith exception", 
+00046340: 6578 635f 696e 666f 3d54 7275 6529 0a0a  exc_info=True)..
+00046350: 2020 2020 6465 6620 5f72 6570 6f72 745f      def _report_
+00046360: 6576 656e 7428 7365 6c66 2c20 6e61 6d65  event(self, name
+00046370: 2c20 6576 656e 7429 3a0a 2020 2020 2020  , event):.      
+00046380: 2020 6d73 6720 3d20 7b0a 2020 2020 2020    msg = {.      
+00046390: 2020 2020 2020 226f 7022 3a20 2265 7665        "op": "eve
+000463a0: 6e74 222c 0a20 2020 2020 2020 2020 2020  nt",.           
+000463b0: 2022 746f 7069 6322 3a20 6e61 6d65 2c0a   "topic": name,.
+000463c0: 2020 2020 2020 2020 2020 2020 2265 7665              "eve
+000463d0: 6e74 223a 2065 7665 6e74 2c0a 2020 2020  nt": event,.    
+000463e0: 2020 2020 7d0a 2020 2020 2020 2020 636c      }.        cl
+000463f0: 6965 6e74 5f6d 7367 7320 3d20 7b63 6c69  ient_msgs = {cli
+00046400: 656e 743a 205b 6d73 675d 2066 6f72 2063  ent: [msg] for c
+00046410: 6c69 656e 7420 696e 2073 656c 662e 6576  lient in self.ev
+00046420: 656e 745f 7375 6273 6372 6962 6572 5b6e  ent_subscriber[n
+00046430: 616d 655d 7d0a 2020 2020 2020 2020 7365  ame]}.        se
+00046440: 6c66 2e73 656e 645f 616c 6c28 636c 6965  lf.send_all(clie
+00046450: 6e74 5f6d 7367 732c 2077 6f72 6b65 725f  nt_msgs, worker_
+00046460: 6d73 6773 3d7b 7d29 0a0a 2020 2020 6465  msgs={})..    de
+00046470: 6620 7375 6273 6372 6962 655f 746f 7069  f subscribe_topi
+00046480: 6328 7365 6c66 2c20 746f 7069 632c 2063  c(self, topic, c
+00046490: 6c69 656e 7429 3a0a 2020 2020 2020 2020  lient):.        
+000464a0: 7365 6c66 2e65 7665 6e74 5f73 7562 7363  self.event_subsc
+000464b0: 7269 6265 725b 746f 7069 635d 2e61 6464  riber[topic].add
+000464c0: 2863 6c69 656e 7429 0a0a 2020 2020 6465  (client)..    de
+000464d0: 6620 756e 7375 6273 6372 6962 655f 746f  f unsubscribe_to
+000464e0: 7069 6328 7365 6c66 2c20 746f 7069 632c  pic(self, topic,
+000464f0: 2063 6c69 656e 7429 3a0a 2020 2020 2020   client):.      
+00046500: 2020 7365 6c66 2e65 7665 6e74 5f73 7562    self.event_sub
+00046510: 7363 7269 6265 725b 746f 7069 635d 2e64  scriber[topic].d
+00046520: 6973 6361 7264 2863 6c69 656e 7429 0a0a  iscard(client)..
+00046530: 2020 2020 6465 6620 6765 745f 6576 656e      def get_even
+00046540: 7473 2873 656c 662c 2074 6f70 6963 3d4e  ts(self, topic=N
+00046550: 6f6e 6529 3a0a 2020 2020 2020 2020 6966  one):.        if
+00046560: 2074 6f70 6963 2069 7320 6e6f 7420 4e6f   topic is not No
+00046570: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00046580: 7265 7475 726e 2074 7570 6c65 2873 656c  return tuple(sel
+00046590: 662e 6576 656e 7473 5b74 6f70 6963 5d29  f.events[topic])
+000465a0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+000465b0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000465c0: 6e20 7661 6c6d 6170 2874 7570 6c65 2c20  n valmap(tuple, 
+000465d0: 7365 6c66 2e65 7665 6e74 7329 0a0a 2020  self.events)..  
+000465e0: 2020 6173 796e 6320 6465 6620 6765 745f    async def get_
+000465f0: 776f 726b 6572 5f6d 6f6e 6974 6f72 5f69  worker_monitor_i
+00046600: 6e66 6f28 7365 6c66 2c20 7265 6365 6e74  nfo(self, recent
+00046610: 3d46 616c 7365 2c20 7374 6172 7473 3d4e  =False, starts=N
+00046620: 6f6e 6529 3a0a 2020 2020 2020 2020 6966  one):.        if
+00046630: 2073 7461 7274 7320 6973 204e 6f6e 653a   starts is None:
+00046640: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
+00046650: 7274 7320 3d20 7b7d 0a20 2020 2020 2020  rts = {}.       
+00046660: 2072 6573 756c 7473 203d 2061 7761 6974   results = await
+00046670: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
+00046680: 0a20 2020 2020 2020 2020 2020 202a 280a  .            *(.
+00046690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000466a0: 7365 6c66 2e72 7063 2877 292e 6765 745f  self.rpc(w).get_
+000466b0: 6d6f 6e69 746f 725f 696e 666f 2872 6563  monitor_info(rec
+000466c0: 656e 743d 7265 6365 6e74 2c20 7374 6172  ent=recent, star
+000466d0: 743d 7374 6172 7473 2e67 6574 2877 2c20  t=starts.get(w, 
+000466e0: 3029 290a 2020 2020 2020 2020 2020 2020  0)).            
+000466f0: 2020 2020 666f 7220 7720 696e 2073 656c      for w in sel
+00046700: 662e 776f 726b 6572 730a 2020 2020 2020  f.workers.      
+00046710: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00046720: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00046730: 2064 6963 7428 7a69 7028 7365 6c66 2e77   dict(zip(self.w
+00046740: 6f72 6b65 7273 2c20 7265 7375 6c74 7329  orkers, results)
+00046750: 290a 0a20 2020 2023 2323 2323 2323 2323  )..    #########
+00046760: 2323 0a20 2020 2023 2043 6c65 616e 7570  ##.    # Cleanup
+00046770: 2023 0a20 2020 2023 2323 2323 2323 2323   #.    #########
+00046780: 2323 0a0a 2020 2020 6173 796e 6320 6465  ##..    async de
+00046790: 6620 6368 6563 6b5f 776f 726b 6572 5f74  f check_worker_t
+000467a0: 746c 2873 656c 6629 3a0a 2020 2020 2020  tl(self):.      
+000467b0: 2020 6e6f 7720 3d20 7469 6d65 2829 0a20    now = time(). 
+000467c0: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
+000467d0: 6964 203d 2066 2263 6865 636b 2d77 6f72  id = f"check-wor
+000467e0: 6b65 722d 7474 6c2d 7b6e 6f77 7d22 0a20  ker-ttl-{now}". 
+000467f0: 2020 2020 2020 2066 6f72 2077 7320 696e         for ws in
+00046800: 2073 656c 662e 776f 726b 6572 732e 7661   self.workers.va
+00046810: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
+00046820: 2020 2020 6966 2028 7773 2e6c 6173 745f      if (ws.last_
+00046830: 7365 656e 203c 206e 6f77 202d 2073 656c  seen < now - sel
+00046840: 662e 776f 726b 6572 5f74 746c 2920 616e  f.worker_ttl) an
+00046850: 6420 280a 2020 2020 2020 2020 2020 2020  d (.            
+00046860: 2020 2020 7773 2e6c 6173 745f 7365 656e      ws.last_seen
+00046870: 203c 206e 6f77 202d 2031 3020 2a20 6865   < now - 10 * he
+00046880: 6172 7462 6561 745f 696e 7465 7276 616c  artbeat_interval
+00046890: 286c 656e 2873 656c 662e 776f 726b 6572  (len(self.worker
+000468a0: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
+000468b0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000468c0: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
+000468d0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+000468e0: 2020 2020 2020 2022 576f 726b 6572 2066         "Worker f
+000468f0: 6169 6c65 6420 746f 2068 6561 7274 6265  ailed to heartbe
+00046900: 6174 2077 6974 6869 6e20 2573 2073 6563  at within %s sec
+00046910: 6f6e 6473 2e20 436c 6f73 696e 673a 2025  onds. Closing: %
+00046920: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
+00046930: 2020 2020 2020 2020 7365 6c66 2e77 6f72          self.wor
+00046940: 6b65 725f 7474 6c2c 0a20 2020 2020 2020  ker_ttl,.       
+00046950: 2020 2020 2020 2020 2020 2020 2077 732c               ws,
+00046960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00046970: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00046980: 2020 2061 7761 6974 2073 656c 662e 7265     await self.re
+00046990: 6d6f 7665 5f77 6f72 6b65 7228 6164 6472  move_worker(addr
+000469a0: 6573 733d 7773 2e61 6464 7265 7373 2c20  ess=ws.address, 
+000469b0: 7374 696d 756c 7573 5f69 643d 7374 696d  stimulus_id=stim
+000469c0: 756c 7573 5f69 6429 0a0a 2020 2020 6465  ulus_id)..    de
+000469d0: 6620 6368 6563 6b5f 6964 6c65 2873 656c  f check_idle(sel
+000469e0: 6629 202d 3e20 666c 6f61 7420 7c20 4e6f  f) -> float | No
+000469f0: 6e65 3a0a 2020 2020 2020 2020 6966 2073  ne:.        if s
+00046a00: 656c 662e 7374 6174 7573 2069 6e20 2853  elf.status in (S
+00046a10: 7461 7475 732e 636c 6f73 696e 672c 2053  tatus.closing, S
+00046a20: 7461 7475 732e 636c 6f73 6564 293a 0a20  tatus.closed):. 
+00046a30: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00046a40: 6e20 4e6f 6e65 0a0a 2020 2020 2020 2020  n None..        
+00046a50: 6966 2073 656c 662e 7472 616e 7369 7469  if self.transiti
+00046a60: 6f6e 5f63 6f75 6e74 6572 2021 3d20 7365  on_counter != se
+00046a70: 6c66 2e5f 6964 6c65 5f74 7261 6e73 6974  lf._idle_transit
+00046a80: 696f 6e5f 636f 756e 7465 723a 0a20 2020  ion_counter:.   
+00046a90: 2020 2020 2020 2020 2073 656c 662e 5f69           self._i
+00046aa0: 646c 655f 7472 616e 7369 7469 6f6e 5f63  dle_transition_c
+00046ab0: 6f75 6e74 6572 203d 2073 656c 662e 7472  ounter = self.tr
+00046ac0: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
+00046ad0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00046ae0: 662e 6964 6c65 5f73 696e 6365 203d 204e  f.idle_since = N
+00046af0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+00046b00: 7265 7475 726e 204e 6f6e 650a 0a20 2020  return None..   
+00046b10: 2020 2020 2069 6620 280a 2020 2020 2020       if (.      
+00046b20: 2020 2020 2020 7365 6c66 2e71 7565 7565        self.queue
+00046b30: 640a 2020 2020 2020 2020 2020 2020 6f72  d.            or
+00046b40: 2073 656c 662e 756e 7275 6e6e 6162 6c65   self.unrunnable
+00046b50: 0a20 2020 2020 2020 2020 2020 206f 7220  .            or 
+00046b60: 616e 7928 7773 2e70 726f 6365 7373 696e  any(ws.processin
+00046b70: 6720 666f 7220 7773 2069 6e20 7365 6c66  g for ws in self
+00046b80: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
+00046b90: 2929 0a20 2020 2020 2020 2029 3a0a 2020  )).        ):.  
+00046ba0: 2020 2020 2020 2020 2020 7365 6c66 2e69            self.i
+00046bb0: 646c 655f 7369 6e63 6520 3d20 4e6f 6e65  dle_since = None
+00046bc0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00046bd0: 7572 6e20 4e6f 6e65 0a0a 2020 2020 2020  urn None..      
+00046be0: 2020 6966 206e 6f74 2073 656c 662e 6964    if not self.id
+00046bf0: 6c65 5f73 696e 6365 3a0a 2020 2020 2020  le_since:.      
+00046c00: 2020 2020 2020 7365 6c66 2e69 646c 655f        self.idle_
+00046c10: 7369 6e63 6520 3d20 7469 6d65 2829 0a20  since = time(). 
+00046c20: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00046c30: 6e20 7365 6c66 2e69 646c 655f 7369 6e63  n self.idle_sinc
+00046c40: 650a 0a20 2020 2020 2020 2069 6620 7365  e..        if se
+00046c50: 6c66 2e6a 7570 7974 6572 3a0a 2020 2020  lf.jupyter:.    
+00046c60: 2020 2020 2020 2020 6c61 7374 5f61 6374          last_act
+00046c70: 6976 6974 7920 3d20 280a 2020 2020 2020  ivity = (.      
+00046c80: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00046c90: 6a75 7079 7465 725f 7365 7276 6572 5f61  jupyter_server_a
+00046ca0: 7070 6c69 6361 7469 6f6e 2e77 6562 5f61  pplication.web_a
+00046cb0: 7070 2e6c 6173 745f 6163 7469 7669 7479  pp.last_activity
+00046cc0: 2829 2e74 696d 6573 7461 6d70 2829 0a20  ().timestamp(). 
+00046cd0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00046ce0: 2020 2020 2020 2020 2069 6620 6c61 7374           if last
+00046cf0: 5f61 6374 6976 6974 7920 3e20 7365 6c66  _activity > self
+00046d00: 2e69 646c 655f 7369 6e63 653a 0a20 2020  .idle_since:.   
+00046d10: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00046d20: 662e 6964 6c65 5f73 696e 6365 203d 206c  f.idle_since = l
+00046d30: 6173 745f 6163 7469 7669 7479 0a20 2020  ast_activity.   
+00046d40: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00046d50: 7572 6e20 7365 6c66 2e69 646c 655f 7369  urn self.idle_si
+00046d60: 6e63 650a 0a20 2020 2020 2020 2069 6620  nce..        if 
+00046d70: 7365 6c66 2e69 646c 655f 7469 6d65 6f75  self.idle_timeou
+00046d80: 743a 0a20 2020 2020 2020 2020 2020 2069  t:.            i
+00046d90: 6620 7469 6d65 2829 203e 2073 656c 662e  f time() > self.
+00046da0: 6964 6c65 5f73 696e 6365 202b 2073 656c  idle_since + sel
+00046db0: 662e 6964 6c65 5f74 696d 656f 7574 3a0a  f.idle_timeout:.
+00046dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046dd0: 6173 7365 7274 2073 656c 662e 6964 6c65  assert self.idle
+00046de0: 5f73 696e 6365 0a20 2020 2020 2020 2020  _since.         
+00046df0: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
+00046e00: 666f 280a 2020 2020 2020 2020 2020 2020  fo(.            
+00046e10: 2020 2020 2020 2020 2253 6368 6564 756c          "Schedul
+00046e20: 6572 2063 6c6f 7369 6e67 2061 6674 6572  er closing after
+00046e30: 2062 6569 6e67 2069 646c 6520 666f 7220   being idle for 
+00046e40: 2573 222c 0a20 2020 2020 2020 2020 2020  %s",.           
+00046e50: 2020 2020 2020 2020 2066 6f72 6d61 745f           format_
+00046e60: 7469 6d65 2873 656c 662e 6964 6c65 5f74  time(self.idle_t
+00046e70: 696d 656f 7574 292c 0a20 2020 2020 2020  imeout),.       
+00046e80: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00046e90: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00046ea0: 5f6f 6e67 6f69 6e67 5f62 6163 6b67 726f  _ongoing_backgro
+00046eb0: 756e 645f 7461 736b 732e 6361 6c6c 5f73  und_tasks.call_s
+00046ec0: 6f6f 6e28 7365 6c66 2e63 6c6f 7365 290a  oon(self.close).
+00046ed0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00046ee0: 656c 662e 6964 6c65 5f73 696e 6365 0a0a  elf.idle_since..
+00046ef0: 2020 2020 6465 6620 6164 6170 7469 7665      def adaptive
+00046f00: 5f74 6172 6765 7428 7365 6c66 2c20 7461  _target(self, ta
+00046f10: 7267 6574 5f64 7572 6174 696f 6e3d 4e6f  rget_duration=No
+00046f20: 6e65 293a 0a20 2020 2020 2020 2022 2222  ne):.        """
+00046f30: 4465 7369 7265 6420 6e75 6d62 6572 206f  Desired number o
+00046f40: 6620 776f 726b 6572 7320 6261 7365 6420  f workers based 
+00046f50: 6f6e 2074 6865 2063 7572 7265 6e74 2077  on the current w
+00046f60: 6f72 6b6c 6f61 640a 0a20 2020 2020 2020  orkload..       
+00046f70: 2054 6869 7320 6c6f 6f6b 7320 6174 2074   This looks at t
+00046f80: 6865 2063 7572 7265 6e74 2072 756e 6e69  he current runni
+00046f90: 6e67 2074 6173 6b73 2061 6e64 206d 656d  ng tasks and mem
+00046fa0: 6f72 7920 7573 652c 2061 6e64 2072 6574  ory use, and ret
+00046fb0: 7572 6e73 2061 0a20 2020 2020 2020 206e  urns a.        n
+00046fc0: 756d 6265 7220 6f66 2064 6573 6972 6564  umber of desired
+00046fd0: 2077 6f72 6b65 7273 2e20 2054 6869 7320   workers.  This 
+00046fe0: 6973 206f 6674 656e 2075 7365 6420 6279  is often used by
+00046ff0: 2061 6461 7074 6976 6520 7363 6865 6475   adaptive schedu
+00047000: 6c69 6e67 2e0a 0a20 2020 2020 2020 2050  ling...        P
+00047010: 6172 616d 6574 6572 730a 2020 2020 2020  arameters.      
+00047020: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
+00047030: 2020 2020 2074 6172 6765 745f 6475 7261       target_dura
+00047040: 7469 6f6e 203a 2073 7472 0a20 2020 2020  tion : str.     
+00047050: 2020 2020 2020 2041 2064 6573 6972 6564         A desired
+00047060: 2064 7572 6174 696f 6e20 6f66 2074 696d   duration of tim
+00047070: 6520 666f 7220 636f 6d70 7574 6174 696f  e for computatio
+00047080: 6e73 2074 6f20 7461 6b65 2e20 2054 6869  ns to take.  Thi
+00047090: 7320 6166 6665 6374 730a 2020 2020 2020  s affects.      
+000470a0: 2020 2020 2020 686f 7720 7261 7069 646c        how rapidl
+000470b0: 7920 7468 6520 7363 6865 6475 6c65 7220  y the scheduler 
+000470c0: 7769 6c6c 2061 736b 2074 6f20 7363 616c  will ask to scal
+000470d0: 652e 0a0a 2020 2020 2020 2020 5365 6520  e...        See 
+000470e0: 416c 736f 0a20 2020 2020 2020 202d 2d2d  Also.        ---
+000470f0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 6469  -----.        di
+00047100: 7374 7269 6275 7465 642e 6465 706c 6f79  stributed.deploy
+00047110: 2e41 6461 7074 6976 650a 2020 2020 2020  .Adaptive.      
+00047120: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
+00047130: 2074 6172 6765 745f 6475 7261 7469 6f6e   target_duration
+00047140: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00047150: 2020 2020 2020 7461 7267 6574 5f64 7572        target_dur
+00047160: 6174 696f 6e20 3d20 6461 736b 2e63 6f6e  ation = dask.con
+00047170: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
+00047180: 7574 6564 2e61 6461 7074 6976 652e 7461  uted.adaptive.ta
+00047190: 7267 6574 2d64 7572 6174 696f 6e22 290a  rget-duration").
+000471a0: 2020 2020 2020 2020 7461 7267 6574 5f64          target_d
+000471b0: 7572 6174 696f 6e20 3d20 7061 7273 655f  uration = parse_
+000471c0: 7469 6d65 6465 6c74 6128 7461 7267 6574  timedelta(target
+000471d0: 5f64 7572 6174 696f 6e29 0a0a 2020 2020  _duration)..    
+000471e0: 2020 2020 2320 4350 550a 0a20 2020 2020      # CPU..     
+000471f0: 2020 2023 2054 4f44 4f20 636f 6e73 6964     # TODO consid
+00047200: 6572 2061 6e79 2075 7365 722d 7370 6563  er any user-spec
+00047210: 6966 6965 6420 6465 6661 756c 7420 7461  ified default ta
+00047220: 736b 2064 7572 6174 696f 6e73 2066 6f72  sk durations for
+00047230: 2071 7565 7565 6420 7461 736b 730a 2020   queued tasks.  
+00047240: 2020 2020 2020 7175 6575 6564 5f6f 6363        queued_occ
+00047250: 7570 616e 6379 203d 206c 656e 2873 656c  upancy = len(sel
+00047260: 662e 7175 6575 6564 2920 2a20 7365 6c66  f.queued) * self
+00047270: 2e55 4e4b 4e4f 574e 5f54 4153 4b5f 4455  .UNKNOWN_TASK_DU
+00047280: 5241 5449 4f4e 0a20 2020 2020 2020 2063  RATION.        c
+00047290: 7075 203d 206d 6174 682e 6365 696c 280a  pu = math.ceil(.
+000472a0: 2020 2020 2020 2020 2020 2020 2873 656c              (sel
+000472b0: 662e 746f 7461 6c5f 6f63 6375 7061 6e63  f.total_occupanc
+000472c0: 7920 2b20 7175 6575 6564 5f6f 6363 7570  y + queued_occup
+000472d0: 616e 6379 2920 2f20 7461 7267 6574 5f64  ancy) / target_d
+000472e0: 7572 6174 696f 6e0a 2020 2020 2020 2020  uration.        
+000472f0: 2920 2023 2054 4f44 4f3a 2074 6872 6561  )  # TODO: threa
+00047300: 6473 2070 6572 2077 6f72 6b65 720a 0a20  ds per worker.. 
+00047310: 2020 2020 2020 2023 2041 766f 6964 2061         # Avoid a
+00047320: 2066 6577 206c 6f6e 6720 7461 736b 7320   few long tasks 
+00047330: 6672 6f6d 2061 736b 696e 6720 666f 7220  from asking for 
+00047340: 6d61 6e79 2063 6f72 6573 0a20 2020 2020  many cores.     
+00047350: 2020 2074 6173 6b73 5f72 6561 6479 203d     tasks_ready =
+00047360: 206c 656e 2873 656c 662e 7175 6575 6564   len(self.queued
+00047370: 290a 2020 2020 2020 2020 666f 7220 7773  ).        for ws
+00047380: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
+00047390: 2e76 616c 7565 7328 293a 0a20 2020 2020  .values():.     
+000473a0: 2020 2020 2020 2074 6173 6b73 5f72 6561         tasks_rea
+000473b0: 6479 202b 3d20 6c65 6e28 7773 2e70 726f  dy += len(ws.pro
+000473c0: 6365 7373 696e 6729 0a0a 2020 2020 2020  cessing)..      
+000473d0: 2020 2020 2020 6966 2074 6173 6b73 5f72        if tasks_r
+000473e0: 6561 6479 203e 2063 7075 3a0a 2020 2020  eady > cpu:.    
+000473f0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+00047400: 6b0a 2020 2020 2020 2020 656c 7365 3a0a  k.        else:.
+00047410: 2020 2020 2020 2020 2020 2020 6370 7520              cpu 
+00047420: 3d20 6d69 6e28 7461 736b 735f 7265 6164  = min(tasks_read
+00047430: 792c 2063 7075 290a 0a20 2020 2020 2020  y, cpu)..       
+00047440: 2069 6620 2873 656c 662e 756e 7275 6e6e   if (self.unrunn
+00047450: 6162 6c65 206f 7220 7365 6c66 2e71 7565  able or self.que
+00047460: 7565 6429 2061 6e64 206e 6f74 2073 656c  ued) and not sel
+00047470: 662e 776f 726b 6572 733a 0a20 2020 2020  f.workers:.     
+00047480: 2020 2020 2020 2063 7075 203d 206d 6178         cpu = max
+00047490: 2831 2c20 6370 7529 0a0a 2020 2020 2020  (1, cpu)..      
+000474a0: 2020 2320 6164 6420 6d6f 7265 2077 6f72    # add more wor
+000474b0: 6b65 7273 2069 6620 6d6f 7265 2074 6861  kers if more tha
+000474c0: 6e20 3630 2520 6f66 206d 656d 6f72 7920  n 60% of memory 
+000474d0: 6973 2075 7365 640a 2020 2020 2020 2020  is used.        
+000474e0: 6c69 6d69 7420 3d20 7375 6d28 7773 2e6d  limit = sum(ws.m
+000474f0: 656d 6f72 795f 6c69 6d69 7420 666f 7220  emory_limit for 
+00047500: 7773 2069 6e20 7365 6c66 2e77 6f72 6b65  ws in self.worke
+00047510: 7273 2e76 616c 7565 7328 2929 0a20 2020  rs.values()).   
+00047520: 2020 2020 2075 7365 6420 3d20 7375 6d28       used = sum(
+00047530: 7773 2e6e 6279 7465 7320 666f 7220 7773  ws.nbytes for ws
+00047540: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
+00047550: 2e76 616c 7565 7328 2929 0a20 2020 2020  .values()).     
+00047560: 2020 206d 656d 6f72 7920 3d20 300a 2020     memory = 0.  
+00047570: 2020 2020 2020 6966 2075 7365 6420 3e20        if used > 
+00047580: 302e 3620 2a20 6c69 6d69 7420 616e 6420  0.6 * limit and 
+00047590: 6c69 6d69 7420 3e20 303a 0a20 2020 2020  limit > 0:.     
+000475a0: 2020 2020 2020 206d 656d 6f72 7920 3d20         memory = 
+000475b0: 3220 2a20 6c65 6e28 7365 6c66 2e77 6f72  2 * len(self.wor
+000475c0: 6b65 7273 290a 0a20 2020 2020 2020 2074  kers)..        t
+000475d0: 6172 6765 7420 3d20 6d61 7828 6d65 6d6f  arget = max(memo
+000475e0: 7279 2c20 6370 7529 0a20 2020 2020 2020  ry, cpu).       
+000475f0: 2069 6620 7461 7267 6574 203e 3d20 6c65   if target >= le
+00047600: 6e28 7365 6c66 2e77 6f72 6b65 7273 293a  n(self.workers):
+00047610: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00047620: 7572 6e20 7461 7267 6574 0a20 2020 2020  urn target.     
+00047630: 2020 2065 6c73 653a 2020 2320 5363 616c     else:  # Scal
+00047640: 6520 646f 776e 3f0a 2020 2020 2020 2020  e down?.        
+00047650: 2020 2020 746f 5f63 6c6f 7365 203d 2073      to_close = s
+00047660: 656c 662e 776f 726b 6572 735f 746f 5f63  elf.workers_to_c
+00047670: 6c6f 7365 2829 0a20 2020 2020 2020 2020  lose().         
+00047680: 2020 2072 6574 7572 6e20 6c65 6e28 7365     return len(se
+00047690: 6c66 2e77 6f72 6b65 7273 2920 2d20 6c65  lf.workers) - le
+000476a0: 6e28 746f 5f63 6c6f 7365 290a 0a20 2020  n(to_close)..   
+000476b0: 2064 6566 2072 6571 7565 7374 5f61 6371   def request_acq
+000476c0: 7569 7265 5f72 6570 6c69 6361 7328 0a20  uire_replicas(. 
+000476d0: 2020 2020 2020 2073 656c 662c 2061 6464         self, add
+000476e0: 723a 2073 7472 2c20 6b65 7973 3a20 4974  r: str, keys: It
+000476f0: 6572 6162 6c65 5b73 7472 5d2c 202a 2c20  erable[str], *, 
+00047700: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
+00047710: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
+00047720: 2020 2020 2020 2020 2222 2241 7379 6e63          """Async
+00047730: 6872 6f6e 6f75 736c 7920 6173 6b20 6120  hronously ask a 
+00047740: 776f 726b 6572 2074 6f20 6163 7175 6972  worker to acquir
+00047750: 6520 6120 7265 706c 6963 6120 6f66 2074  e a replica of t
+00047760: 6865 206c 6973 7465 6420 6b65 7973 2066  he listed keys f
+00047770: 726f 6d0a 2020 2020 2020 2020 6f74 6865  rom.        othe
+00047780: 7220 776f 726b 6572 732e 2054 6869 7320  r workers. This 
+00047790: 6973 2061 2066 6972 652d 616e 642d 666f  is a fire-and-fo
+000477a0: 7267 6574 206f 7065 7261 7469 6f6e 2077  rget operation w
+000477b0: 6869 6368 206f 6666 6572 7320 6e6f 2066  hich offers no f
+000477c0: 6565 6462 6163 6b20 666f 720a 2020 2020  eedback for.    
+000477d0: 2020 2020 7375 6363 6573 7320 6f72 2066      success or f
+000477e0: 6169 6c75 7265 2c20 616e 6420 6973 2069  ailure, and is i
+000477f0: 6e74 656e 6465 6420 666f 7220 686f 7573  ntended for hous
+00047800: 656b 6565 7069 6e67 2061 6e64 206e 6f74  ekeeping and not
+00047810: 2066 6f72 2063 6f6d 7075 7461 7469 6f6e   for computation
+00047820: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00047830: 2020 2020 2020 7768 6f5f 6861 7320 3d20        who_has = 
+00047840: 7b7d 0a20 2020 2020 2020 206e 6279 7465  {}.        nbyte
+00047850: 7320 3d20 7b7d 0a20 2020 2020 2020 2066  s = {}.        f
+00047860: 6f72 206b 6579 2069 6e20 6b65 7973 3a0a  or key in keys:.
+00047870: 2020 2020 2020 2020 2020 2020 7473 203d              ts =
+00047880: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
+00047890: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+000478a0: 6572 7420 7473 2e77 686f 5f68 6173 0a20  ert ts.who_has. 
+000478b0: 2020 2020 2020 2020 2020 2077 686f 5f68             who_h
+000478c0: 6173 5b6b 6579 5d20 3d20 5b77 732e 6164  as[key] = [ws.ad
+000478d0: 6472 6573 7320 666f 7220 7773 2069 6e20  dress for ws in 
+000478e0: 7473 2e77 686f 5f68 6173 5d0a 2020 2020  ts.who_has].    
+000478f0: 2020 2020 2020 2020 6e62 7974 6573 5b6b          nbytes[k
+00047900: 6579 5d20 3d20 7473 2e6e 6279 7465 730a  ey] = ts.nbytes.
+00047910: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
+00047920: 7265 616d 5f63 6f6d 6d73 5b61 6464 725d  ream_comms[addr]
+00047930: 2e73 656e 6428 0a20 2020 2020 2020 2020  .send(.         
+00047940: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00047950: 2020 2020 2022 6f70 223a 2022 6163 7175       "op": "acqu
+00047960: 6972 652d 7265 706c 6963 6173 222c 0a20  ire-replicas",. 
+00047970: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00047980: 7768 6f5f 6861 7322 3a20 7768 6f5f 6861  who_has": who_ha
+00047990: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+000479a0: 2020 2022 6e62 7974 6573 223a 206e 6279     "nbytes": nby
+000479b0: 7465 732c 0a20 2020 2020 2020 2020 2020  tes,.           
+000479c0: 2020 2020 2022 7374 696d 756c 7573 5f69       "stimulus_i
+000479d0: 6422 3a20 7374 696d 756c 7573 5f69 642c  d": stimulus_id,
+000479e0: 0a20 2020 2020 2020 2020 2020 207d 2c0a  .            },.
+000479f0: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
+00047a00: 6566 2072 6571 7565 7374 5f72 656d 6f76  ef request_remov
+00047a10: 655f 7265 706c 6963 6173 280a 2020 2020  e_replicas(.    
+00047a20: 2020 2020 7365 6c66 2c20 6164 6472 3a20      self, addr: 
+00047a30: 7374 722c 206b 6579 733a 206c 6973 745b  str, keys: list[
+00047a40: 7374 725d 2c20 2a2c 2073 7469 6d75 6c75  str], *, stimulu
+00047a50: 735f 6964 3a20 7374 720a 2020 2020 2920  s_id: str.    ) 
+00047a60: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00047a70: 2022 2222 4173 796e 6368 726f 6e6f 7573   """Asynchronous
+00047a80: 6c79 2061 736b 2061 2077 6f72 6b65 7220  ly ask a worker 
+00047a90: 746f 2064 6973 6361 7264 2069 7473 2072  to discard its r
+00047aa0: 6570 6c69 6361 206f 6620 7468 6520 6c69  eplica of the li
+00047ab0: 7374 6564 206b 6579 732e 0a20 2020 2020  sted keys..     
+00047ac0: 2020 2054 6869 7320 6d75 7374 206e 6576     This must nev
+00047ad0: 6572 2062 6520 7573 6564 2074 6f20 6465  er be used to de
+00047ae0: 7374 726f 7920 7468 6520 6c61 7374 2072  stroy the last r
+00047af0: 6570 6c69 6361 206f 6620 6120 6b65 792e  eplica of a key.
+00047b00: 2054 6869 7320 6973 2061 0a20 2020 2020   This is a.     
+00047b10: 2020 2066 6972 652d 616e 642d 666f 7267     fire-and-forg
+00047b20: 6574 206f 7065 7261 7469 6f6e 2c20 696e  et operation, in
+00047b30: 7465 6e64 6564 2066 6f72 2068 6f75 7365  tended for house
+00047b40: 6b65 6570 696e 6720 616e 6420 6e6f 7420  keeping and not 
+00047b50: 666f 7220 636f 6d70 7574 6174 696f 6e2e  for computation.
+00047b60: 0a0a 2020 2020 2020 2020 5468 6520 7265  ..        The re
+00047b70: 706c 6963 6120 6469 7361 7070 6561 7273  plica disappears
+00047b80: 2069 6d6d 6564 6961 7465 6c79 2066 726f   immediately fro
+00047b90: 6d20 5461 736b 5374 6174 652e 7768 6f5f  m TaskState.who_
+00047ba0: 6861 7320 6f6e 2074 6865 2053 6368 6564  has on the Sched
+00047bb0: 756c 6572 2073 6964 653b 0a20 2020 2020  uler side;.     
+00047bc0: 2020 2069 6620 7468 6520 776f 726b 6572     if the worker
+00047bd0: 2072 6566 7573 6573 2074 6f20 6465 6c65   refuses to dele
+00047be0: 7465 2c20 652e 672e 2062 6563 6175 7365  te, e.g. because
+00047bf0: 2074 6865 2074 6173 6b20 6973 2061 2064   the task is a d
+00047c00: 6570 656e 6465 6e63 7920 6f66 0a20 2020  ependency of.   
+00047c10: 2020 2020 2061 6e6f 7468 6572 2074 6173       another tas
+00047c20: 6b20 7275 6e6e 696e 6720 6f6e 2069 742c  k running on it,
+00047c30: 2069 7420 7769 6c6c 2028 616c 736f 2061   it will (also a
+00047c40: 7379 6e63 6872 6f6e 6f75 736c 7929 2069  synchronously) i
+00047c50: 6e66 6f72 6d20 7468 6520 7363 6865 6475  nform the schedu
+00047c60: 6c65 720a 2020 2020 2020 2020 746f 2072  ler.        to r
+00047c70: 652d 6164 6420 6974 7365 6c66 2074 6f20  e-add itself to 
+00047c80: 7768 6f5f 6861 732e 2049 6620 7468 6520  who_has. If the 
+00047c90: 776f 726b 6572 2061 6772 6565 7320 746f  worker agrees to
+00047ca0: 2064 6973 6361 7264 2074 6865 2074 6173   discard the tas
+00047cb0: 6b2c 2074 6865 7265 2069 730a 2020 2020  k, there is.    
+00047cc0: 2020 2020 6e6f 2066 6565 6462 6163 6b2e      no feedback.
+00047cd0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00047ce0: 2020 2020 2077 7320 3d20 7365 6c66 2e77       ws = self.w
+00047cf0: 6f72 6b65 7273 5b61 6464 725d 0a0a 2020  orkers[addr]..  
+00047d00: 2020 2020 2020 2320 5468 6520 7363 6865        # The sche
+00047d10: 6475 6c65 7220 696d 6d65 6469 6174 656c  duler immediatel
+00047d20: 7920 666f 7267 6574 7320 6162 6f75 7420  y forgets about 
+00047d30: 7468 6520 7265 706c 6963 6120 616e 6420  the replica and 
+00047d40: 7375 6767 6573 7473 2074 6865 2077 6f72  suggests the wor
+00047d50: 6b65 7220 746f 0a20 2020 2020 2020 2023  ker to.        #
+00047d60: 2064 726f 7020 6974 2e20 5468 6520 776f   drop it. The wo
+00047d70: 726b 6572 206d 6179 2072 6566 7573 652c  rker may refuse,
+00047d80: 2061 7420 7768 6963 6820 706f 696e 7420   at which point 
+00047d90: 6974 2077 696c 6c20 7365 6e64 2062 6163  it will send bac
+00047da0: 6b20 616e 2061 6464 2d6b 6579 730a 2020  k an add-keys.  
+00047db0: 2020 2020 2020 2320 6d65 7373 6167 6520        # message 
+00047dc0: 746f 2072 6569 6e73 7461 7465 2069 742e  to reinstate it.
+00047dd0: 0a20 2020 2020 2020 2066 6f72 206b 6579  .        for key
+00047de0: 2069 6e20 6b65 7973 3a0a 2020 2020 2020   in keys:.      
+00047df0: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
+00047e00: 7461 736b 735b 6b65 795d 0a20 2020 2020  tasks[key].     
+00047e10: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
+00047e20: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
+00047e30: 2020 2020 2020 2020 2023 2044 6f20 6e6f           # Do no
+00047e40: 7420 6465 7374 726f 7920 7468 6520 6c61  t destroy the la
+00047e50: 7374 2063 6f70 790a 2020 2020 2020 2020  st copy.        
+00047e60: 2020 2020 2020 2020 6173 7365 7274 206c          assert l
+00047e70: 656e 2874 732e 7768 6f5f 6861 7329 203e  en(ts.who_has) >
+00047e80: 2031 0a20 2020 2020 2020 2020 2020 2073   1.            s
+00047e90: 656c 662e 7265 6d6f 7665 5f72 6570 6c69  elf.remove_repli
+00047ea0: 6361 2874 732c 2077 7329 0a0a 2020 2020  ca(ts, ws)..    
+00047eb0: 2020 2020 7365 6c66 2e73 7472 6561 6d5f      self.stream_
+00047ec0: 636f 6d6d 735b 6164 6472 5d2e 7365 6e64  comms[addr].send
+00047ed0: 280a 2020 2020 2020 2020 2020 2020 7b0a  (.            {.
+00047ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047ef0: 226f 7022 3a20 2272 656d 6f76 652d 7265  "op": "remove-re
+00047f00: 706c 6963 6173 222c 0a20 2020 2020 2020  plicas",.       
+00047f10: 2020 2020 2020 2020 2022 6b65 7973 223a           "keys":
+00047f20: 206b 6579 732c 0a20 2020 2020 2020 2020   keys,.         
+00047f30: 2020 2020 2020 2022 7374 696d 756c 7573         "stimulus
+00047f40: 5f69 6422 3a20 7374 696d 756c 7573 5f69  _id": stimulus_i
+00047f50: 642c 0a20 2020 2020 2020 2020 2020 207d  d,.            }
+00047f60: 0a20 2020 2020 2020 2029 0a0a 0a64 6566  .        )...def
+00047f70: 205f 7461 736b 5f74 6f5f 7265 706f 7274   _task_to_report
+00047f80: 5f6d 7367 2874 733a 2054 6173 6b53 7461  _msg(ts: TaskSta
+00047f90: 7465 2920 2d3e 2064 6963 745b 7374 722c  te) -> dict[str,
+00047fa0: 2041 6e79 5d20 7c20 4e6f 6e65 3a0a 2020   Any] | None:.  
+00047fb0: 2020 6966 2074 732e 7374 6174 6520 3d3d    if ts.state ==
+00047fc0: 2022 666f 7267 6f74 7465 6e22 3a0a 2020   "forgotten":.  
+00047fd0: 2020 2020 2020 7265 7475 726e 207b 226f        return {"o
+00047fe0: 7022 3a20 2263 616e 6365 6c6c 6564 2d6b  p": "cancelled-k
+00047ff0: 6579 7322 2c20 226b 6579 7322 3a20 5b74  eys", "keys": [t
+00048000: 732e 6b65 795d 7d0a 2020 2020 656c 6966  s.key]}.    elif
+00048010: 2074 732e 7374 6174 6520 3d3d 2022 6d65   ts.state == "me
+00048020: 6d6f 7279 223a 0a20 2020 2020 2020 2072  mory":.        r
+00048030: 6574 7572 6e20 7b22 6f70 223a 2022 6b65  eturn {"op": "ke
+00048040: 792d 696e 2d6d 656d 6f72 7922 2c20 226b  y-in-memory", "k
+00048050: 6579 223a 2074 732e 6b65 797d 0a20 2020  ey": ts.key}.   
+00048060: 2065 6c69 6620 7473 2e73 7461 7465 203d   elif ts.state =
+00048070: 3d20 2265 7272 6564 223a 0a20 2020 2020  = "erred":.     
+00048080: 2020 2066 6169 6c69 6e67 5f74 7320 3d20     failing_ts = 
+00048090: 7473 2e65 7863 6570 7469 6f6e 5f62 6c61  ts.exception_bla
+000480a0: 6d65 0a20 2020 2020 2020 2061 7373 6572  me.        asser
+000480b0: 7420 6661 696c 696e 675f 7473 0a20 2020  t failing_ts.   
+000480c0: 2020 2020 2072 6574 7572 6e20 7b0a 2020       return {.  
+000480d0: 2020 2020 2020 2020 2020 226f 7022 3a20            "op": 
+000480e0: 2274 6173 6b2d 6572 7265 6422 2c0a 2020  "task-erred",.  
+000480f0: 2020 2020 2020 2020 2020 226b 6579 223a            "key":
+00048100: 2074 732e 6b65 792c 0a20 2020 2020 2020   ts.key,.       
+00048110: 2020 2020 2022 6578 6365 7074 696f 6e22       "exception"
+00048120: 3a20 6661 696c 696e 675f 7473 2e65 7863  : failing_ts.exc
+00048130: 6570 7469 6f6e 2c0a 2020 2020 2020 2020  eption,.        
+00048140: 2020 2020 2274 7261 6365 6261 636b 223a      "traceback":
+00048150: 2066 6169 6c69 6e67 5f74 732e 7472 6163   failing_ts.trac
+00048160: 6562 6163 6b2c 0a20 2020 2020 2020 207d  eback,.        }
+00048170: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+00048180: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
+00048190: 0a64 6566 205f 7461 736b 5f74 6f5f 636c  .def _task_to_cl
+000481a0: 6965 6e74 5f6d 7367 7328 7473 3a20 5461  ient_msgs(ts: Ta
+000481b0: 736b 5374 6174 6529 202d 3e20 6469 6374  skState) -> dict
+000481c0: 5b73 7472 2c20 6c69 7374 5b64 6963 745b  [str, list[dict[
+000481d0: 7374 722c 2041 6e79 5d5d 5d3a 0a20 2020  str, Any]]]:.   
+000481e0: 2069 6620 7473 2e77 686f 5f77 616e 7473   if ts.who_wants
+000481f0: 3a0a 2020 2020 2020 2020 7265 706f 7274  :.        report
+00048200: 5f6d 7367 203d 205f 7461 736b 5f74 6f5f  _msg = _task_to_
+00048210: 7265 706f 7274 5f6d 7367 2874 7329 0a20  report_msg(ts). 
+00048220: 2020 2020 2020 2069 6620 7265 706f 7274         if report
+00048230: 5f6d 7367 2069 7320 6e6f 7420 4e6f 6e65  _msg is not None
+00048240: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00048250: 7475 726e 207b 6373 2e63 6c69 656e 745f  turn {cs.client_
+00048260: 6b65 793a 205b 7265 706f 7274 5f6d 7367  key: [report_msg
+00048270: 5d20 666f 7220 6373 2069 6e20 7473 2e77  ] for cs in ts.w
+00048280: 686f 5f77 616e 7473 7d0a 2020 2020 7265  ho_wants}.    re
+00048290: 7475 726e 207b 7d0a 0a0a 6465 6620 6465  turn {}...def de
+000482a0: 6369 6465 5f77 6f72 6b65 7228 0a20 2020  cide_worker(.   
+000482b0: 2074 733a 2054 6173 6b53 7461 7465 2c0a   ts: TaskState,.
+000482c0: 2020 2020 616c 6c5f 776f 726b 6572 733a      all_workers:
+000482d0: 2049 7465 7261 626c 655b 576f 726b 6572   Iterable[Worker
+000482e0: 5374 6174 655d 2c0a 2020 2020 7661 6c69  State],.    vali
+000482f0: 645f 776f 726b 6572 733a 2073 6574 5b57  d_workers: set[W
+00048300: 6f72 6b65 7253 7461 7465 5d20 7c20 4e6f  orkerState] | No
+00048310: 6e65 2c0a 2020 2020 6f62 6a65 6374 6976  ne,.    objectiv
+00048320: 653a 2043 616c 6c61 626c 655b 5b57 6f72  e: Callable[[Wor
+00048330: 6b65 7253 7461 7465 5d2c 2041 6e79 5d2c  kerState], Any],
+00048340: 0a29 202d 3e20 576f 726b 6572 5374 6174  .) -> WorkerStat
+00048350: 6520 7c20 4e6f 6e65 3a0a 2020 2020 2222  e | None:.    ""
+00048360: 220a 2020 2020 4465 6369 6465 2077 6869  ".    Decide whi
+00048370: 6368 2077 6f72 6b65 7220 7368 6f75 6c64  ch worker should
+00048380: 2074 616b 6520 7461 736b 202a 7473 2a2e   take task *ts*.
+00048390: 0a0a 2020 2020 5765 2063 686f 6f73 6520  ..    We choose 
+000483a0: 7468 6520 776f 726b 6572 2074 6861 7420  the worker that 
+000483b0: 6861 7320 7468 6520 6461 7461 206f 6e20  has the data on 
+000483c0: 7768 6963 6820 2a74 732a 2064 6570 656e  which *ts* depen
+000483d0: 6473 2e0a 0a20 2020 2049 6620 7365 7665  ds...    If seve
+000483e0: 7261 6c20 776f 726b 6572 7320 6861 7665  ral workers have
+000483f0: 2064 6570 656e 6465 6e63 6965 7320 7468   dependencies th
+00048400: 656e 2077 6520 6368 6f6f 7365 2074 6865  en we choose the
+00048410: 206c 6573 732d 6275 7379 2077 6f72 6b65   less-busy worke
+00048420: 722e 0a0a 2020 2020 4f70 7469 6f6e 616c  r...    Optional
+00048430: 6c79 2070 726f 7669 6465 202a 7661 6c69  ly provide *vali
+00048440: 645f 776f 726b 6572 732a 206f 6620 7768  d_workers* of wh
+00048450: 6572 6520 6a6f 6273 2061 7265 2061 6c6c  ere jobs are all
+00048460: 6f77 6564 2074 6f20 6f63 6375 720a 2020  owed to occur.  
+00048470: 2020 2869 6620 616c 6c20 776f 726b 6572    (if all worker
+00048480: 7320 6172 6520 616c 6c6f 7765 6420 746f  s are allowed to
+00048490: 2074 616b 6520 7468 6520 7461 736b 2c20   take the task, 
+000484a0: 7061 7373 204e 6f6e 6520 696e 7374 6561  pass None instea
+000484b0: 6429 2e0a 0a20 2020 2049 6620 7468 6520  d)...    If the 
+000484c0: 7461 736b 2072 6571 7569 7265 7320 6461  task requires da
+000484d0: 7461 2063 6f6d 6d75 6e69 6361 7469 6f6e  ta communication
+000484e0: 2062 6563 6175 7365 206e 6f20 656c 6967   because no elig
+000484f0: 6962 6c65 2077 6f72 6b65 7220 6861 730a  ible worker has.
+00048500: 2020 2020 616c 6c20 7468 6520 6465 7065      all the depe
+00048510: 6e64 656e 6369 6573 2061 6c72 6561 6479  ndencies already
+00048520: 2c20 7468 656e 2077 6520 6368 6f6f 7365  , then we choose
+00048530: 2074 6f20 6d69 6e69 6d69 7a65 2074 6865   to minimize the
+00048540: 206e 756d 6265 720a 2020 2020 6f66 2062   number.    of b
+00048550: 7974 6573 2073 656e 7420 6265 7477 6565  ytes sent betwee
+00048560: 6e20 776f 726b 6572 732e 2020 5468 6973  n workers.  This
+00048570: 2069 7320 6465 7465 726d 696e 6564 2062   is determined b
+00048580: 7920 6361 6c6c 696e 6720 7468 650a 2020  y calling the.  
+00048590: 2020 2a6f 626a 6563 7469 7665 2a20 6675    *objective* fu
+000485a0: 6e63 7469 6f6e 2e0a 2020 2020 2222 220a  nction..    """.
+000485b0: 2020 2020 6173 7365 7274 2061 6c6c 2864      assert all(d
+000485c0: 7473 2e77 686f 5f68 6173 2066 6f72 2064  ts.who_has for d
+000485d0: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
+000485e0: 6e63 6965 7329 0a20 2020 2069 6620 7473  ncies).    if ts
+000485f0: 2e61 6374 6f72 3a0a 2020 2020 2020 2020  .actor:.        
+00048600: 6361 6e64 6964 6174 6573 203d 2073 6574  candidates = set
+00048610: 2861 6c6c 5f77 6f72 6b65 7273 290a 2020  (all_workers).  
+00048620: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00048630: 6361 6e64 6964 6174 6573 203d 207b 7777  candidates = {ww
+00048640: 7320 666f 7220 6474 7320 696e 2074 732e  s for dts in ts.
+00048650: 6465 7065 6e64 656e 6369 6573 2066 6f72  dependencies for
+00048660: 2077 7773 2069 6e20 6474 732e 7768 6f5f   wws in dts.who_
+00048670: 6861 737d 0a20 2020 2069 6620 7661 6c69  has}.    if vali
+00048680: 645f 776f 726b 6572 7320 6973 204e 6f6e  d_workers is Non
+00048690: 653a 0a20 2020 2020 2020 2069 6620 6e6f  e:.        if no
+000486a0: 7420 6361 6e64 6964 6174 6573 3a0a 2020  t candidates:.  
+000486b0: 2020 2020 2020 2020 2020 6361 6e64 6964            candid
+000486c0: 6174 6573 203d 2073 6574 2861 6c6c 5f77  ates = set(all_w
+000486d0: 6f72 6b65 7273 290a 2020 2020 656c 7365  orkers).    else
+000486e0: 3a0a 2020 2020 2020 2020 6361 6e64 6964  :.        candid
+000486f0: 6174 6573 2026 3d20 7661 6c69 645f 776f  ates &= valid_wo
+00048700: 726b 6572 730a 2020 2020 2020 2020 6966  rkers.        if
+00048710: 206e 6f74 2063 616e 6469 6461 7465 733a   not candidates:
+00048720: 0a20 2020 2020 2020 2020 2020 2063 616e  .            can
+00048730: 6469 6461 7465 7320 3d20 7661 6c69 645f  didates = valid_
+00048740: 776f 726b 6572 730a 2020 2020 2020 2020  workers.        
+00048750: 2020 2020 6966 206e 6f74 2063 616e 6469      if not candi
+00048760: 6461 7465 733a 0a20 2020 2020 2020 2020  dates:.         
+00048770: 2020 2020 2020 2069 6620 7473 2e6c 6f6f         if ts.loo
+00048780: 7365 5f72 6573 7472 6963 7469 6f6e 733a  se_restrictions:
+00048790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000487a0: 2020 2020 2072 6574 7572 6e20 6465 6369       return deci
+000487b0: 6465 5f77 6f72 6b65 7228 7473 2c20 616c  de_worker(ts, al
+000487c0: 6c5f 776f 726b 6572 732c 204e 6f6e 652c  l_workers, None,
+000487d0: 206f 626a 6563 7469 7665 290a 0a20 2020   objective)..   
+000487e0: 2069 6620 6e6f 7420 6361 6e64 6964 6174   if not candidat
+000487f0: 6573 3a0a 2020 2020 2020 2020 7265 7475  es:.        retu
+00048800: 726e 204e 6f6e 650a 2020 2020 656c 6966  rn None.    elif
+00048810: 206c 656e 2863 616e 6469 6461 7465 7329   len(candidates)
+00048820: 203d 3d20 313a 0a20 2020 2020 2020 2072   == 1:.        r
+00048830: 6574 7572 6e20 6e65 7874 2869 7465 7228  eturn next(iter(
+00048840: 6361 6e64 6964 6174 6573 2929 0a20 2020  candidates)).   
+00048850: 2065 6c73 653a 0a20 2020 2020 2020 2072   else:.        r
+00048860: 6574 7572 6e20 6d69 6e28 6361 6e64 6964  eturn min(candid
+00048870: 6174 6573 2c20 6b65 793d 6f62 6a65 6374  ates, key=object
+00048880: 6976 6529 0a0a 0a64 6566 2076 616c 6964  ive)...def valid
+00048890: 6174 655f 7461 736b 5f73 7461 7465 2874  ate_task_state(t
+000488a0: 733a 2054 6173 6b53 7461 7465 2920 2d3e  s: TaskState) ->
+000488b0: 204e 6f6e 653a 0a20 2020 2022 2222 5661   None:.    """Va
+000488c0: 6c69 6461 7465 2074 6865 2067 6976 656e  lidate the given
+000488d0: 2054 6173 6b53 7461 7465 2222 220a 2020   TaskState""".  
+000488e0: 2020 6173 7365 7274 2074 732e 7374 6174    assert ts.stat
+000488f0: 6520 696e 2041 4c4c 5f54 4153 4b5f 5354  e in ALL_TASK_ST
+00048900: 4154 4553 2c20 7473 0a0a 2020 2020 6966  ATES, ts..    if
+00048910: 2074 732e 7761 6974 696e 675f 6f6e 3a0a   ts.waiting_on:.
+00048920: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+00048930: 732e 7761 6974 696e 675f 6f6e 2e69 7373  s.waiting_on.iss
+00048940: 7562 7365 7428 7473 2e64 6570 656e 6465  ubset(ts.depende
+00048950: 6e63 6965 7329 2c20 280a 2020 2020 2020  ncies), (.      
+00048960: 2020 2020 2020 2277 6169 7469 6e67 206e        "waiting n
+00048970: 6f74 2073 7562 7365 7420 6f66 2064 6570  ot subset of dep
+00048980: 656e 6465 6e63 6965 7322 2c0a 2020 2020  endencies",.    
+00048990: 2020 2020 2020 2020 7374 7228 7473 2e77          str(ts.w
+000489a0: 6169 7469 6e67 5f6f 6e29 2c0a 2020 2020  aiting_on),.    
+000489b0: 2020 2020 2020 2020 7374 7228 7473 2e64          str(ts.d
+000489c0: 6570 656e 6465 6e63 6965 7329 2c0a 2020  ependencies),.  
+000489d0: 2020 2020 2020 290a 2020 2020 6966 2074        ).    if t
+000489e0: 732e 7761 6974 6572 733a 0a20 2020 2020  s.waiters:.     
+000489f0: 2020 2061 7373 6572 7420 7473 2e77 6169     assert ts.wai
+00048a00: 7465 7273 2e69 7373 7562 7365 7428 7473  ters.issubset(ts
+00048a10: 2e64 6570 656e 6465 6e74 7329 2c20 280a  .dependents), (.
+00048a20: 2020 2020 2020 2020 2020 2020 2277 6169              "wai
+00048a30: 7465 7273 206e 6f74 2073 7562 7365 7420  ters not subset 
+00048a40: 6f66 2064 6570 656e 6465 6e74 7322 2c0a  of dependents",.
+00048a50: 2020 2020 2020 2020 2020 2020 7374 7228              str(
+00048a60: 7473 2e77 6169 7465 7273 292c 0a20 2020  ts.waiters),.   
+00048a70: 2020 2020 2020 2020 2073 7472 2874 732e           str(ts.
+00048a80: 6465 7065 6e64 656e 7473 292c 0a20 2020  dependents),.   
+00048a90: 2020 2020 2029 0a0a 2020 2020 666f 7220       )..    for 
+00048aa0: 6474 7320 696e 2074 732e 7761 6974 696e  dts in ts.waitin
+00048ab0: 675f 6f6e 3a0a 2020 2020 2020 2020 6173  g_on:.        as
+00048ac0: 7365 7274 206e 6f74 2064 7473 2e77 686f  sert not dts.who
+00048ad0: 5f68 6173 2c20 2822 7761 6974 696e 6720  _has, ("waiting 
+00048ae0: 6f6e 2069 6e2d 6d65 6d6f 7279 2064 6570  on in-memory dep
+00048af0: 222c 2073 7472 2874 7329 2c20 7374 7228  ", str(ts), str(
+00048b00: 6474 7329 290a 2020 2020 2020 2020 6173  dts)).        as
+00048b10: 7365 7274 2064 7473 2e73 7461 7465 2021  sert dts.state !
+00048b20: 3d20 2272 656c 6561 7365 6422 2c20 2822  = "released", ("
+00048b30: 7761 6974 696e 6720 6f6e 2072 656c 6561  waiting on relea
+00048b40: 7365 6420 6465 7022 2c20 7374 7228 7473  sed dep", str(ts
+00048b50: 292c 2073 7472 2864 7473 2929 0a20 2020  ), str(dts)).   
+00048b60: 2066 6f72 2064 7473 2069 6e20 7473 2e64   for dts in ts.d
+00048b70: 6570 656e 6465 6e63 6965 733a 0a20 2020  ependencies:.   
+00048b80: 2020 2020 2061 7373 6572 7420 7473 2069       assert ts i
+00048b90: 6e20 6474 732e 6465 7065 6e64 656e 7473  n dts.dependents
+00048ba0: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
+00048bb0: 226e 6f74 2069 6e20 6465 7065 6e64 656e  "not in dependen
+00048bc0: 6379 2773 2064 6570 656e 6465 6e74 7322  cy's dependents"
+00048bd0: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
+00048be0: 7228 7473 292c 0a20 2020 2020 2020 2020  r(ts),.         
+00048bf0: 2020 2073 7472 2864 7473 292c 0a20 2020     str(dts),.   
+00048c00: 2020 2020 2020 2020 2073 7472 2864 7473           str(dts
+00048c10: 2e64 6570 656e 6465 6e74 7329 2c0a 2020  .dependents),.  
+00048c20: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00048c30: 6966 2074 732e 7374 6174 6520 696e 2028  if ts.state in (
+00048c40: 2277 6169 7469 6e67 222c 2022 7175 6575  "waiting", "queu
+00048c50: 6564 222c 2022 7072 6f63 6573 7369 6e67  ed", "processing
+00048c60: 222c 2022 6e6f 2d77 6f72 6b65 7222 293a  ", "no-worker"):
+00048c70: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00048c80: 6572 7420 6474 7320 696e 2074 732e 7761  ert dts in ts.wa
+00048c90: 6974 696e 675f 6f6e 206f 7220 6474 732e  iting_on or dts.
+00048ca0: 7768 6f5f 6861 732c 2028 0a20 2020 2020  who_has, (.     
+00048cb0: 2020 2020 2020 2020 2020 2022 6465 7020             "dep 
+00048cc0: 6d69 7373 696e 6722 2c0a 2020 2020 2020  missing",.      
+00048cd0: 2020 2020 2020 2020 2020 7374 7228 7473            str(ts
+00048ce0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00048cf0: 2020 2073 7472 2864 7473 292c 0a20 2020     str(dts),.   
+00048d00: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00048d10: 2020 2061 7373 6572 7420 6474 732e 7374     assert dts.st
+00048d20: 6174 6520 213d 2022 666f 7267 6f74 7465  ate != "forgotte
+00048d30: 6e22 0a0a 2020 2020 666f 7220 6474 7320  n"..    for dts 
+00048d40: 696e 2074 732e 7761 6974 6572 733a 0a20  in ts.waiters:. 
+00048d50: 2020 2020 2020 2061 7373 6572 7420 6474         assert dt
+00048d60: 732e 7374 6174 6520 696e 2028 2277 6169  s.state in ("wai
+00048d70: 7469 6e67 222c 2022 7175 6575 6564 222c  ting", "queued",
+00048d80: 2022 7072 6f63 6573 7369 6e67 222c 2022   "processing", "
+00048d90: 6e6f 2d77 6f72 6b65 7222 292c 2028 0a20  no-worker"), (. 
+00048da0: 2020 2020 2020 2020 2020 2022 7761 6974             "wait
+00048db0: 6572 206e 6f74 2069 6e20 706c 6179 222c  er not in play",
+00048dc0: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
+00048dd0: 2874 7329 2c0a 2020 2020 2020 2020 2020  (ts),.          
+00048de0: 2020 7374 7228 6474 7329 2c0a 2020 2020    str(dts),.    
+00048df0: 2020 2020 290a 2020 2020 666f 7220 6474      ).    for dt
+00048e00: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+00048e10: 7473 3a0a 2020 2020 2020 2020 6173 7365  ts:.        asse
+00048e20: 7274 2074 7320 696e 2064 7473 2e64 6570  rt ts in dts.dep
+00048e30: 656e 6465 6e63 6965 732c 2028 0a20 2020  endencies, (.   
+00048e40: 2020 2020 2020 2020 2022 6e6f 7420 696e           "not in
+00048e50: 2064 6570 656e 6465 6e74 2773 2064 6570   dependent's dep
+00048e60: 656e 6465 6e63 6965 7322 2c0a 2020 2020  endencies",.    
+00048e70: 2020 2020 2020 2020 7374 7228 7473 292c          str(ts),
+00048e80: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
+00048e90: 2864 7473 292c 0a20 2020 2020 2020 2020  (dts),.         
+00048ea0: 2020 2073 7472 2864 7473 2e64 6570 656e     str(dts.depen
+00048eb0: 6465 6e63 6965 7329 2c0a 2020 2020 2020  dencies),.      
+00048ec0: 2020 290a 2020 2020 2020 2020 6173 7365    ).        asse
+00048ed0: 7274 2064 7473 2e73 7461 7465 2021 3d20  rt dts.state != 
+00048ee0: 2266 6f72 676f 7474 656e 220a 0a20 2020  "forgotten"..   
+00048ef0: 2061 7373 6572 7420 2874 732e 7072 6f63   assert (ts.proc
+00048f00: 6573 7369 6e67 5f6f 6e20 6973 206e 6f74  essing_on is not
+00048f10: 204e 6f6e 6529 203d 3d20 2874 732e 7374   None) == (ts.st
+00048f20: 6174 6520 3d3d 2022 7072 6f63 6573 7369  ate == "processi
+00048f30: 6e67 2229 0a20 2020 2061 7373 6572 7420  ng").    assert 
+00048f40: 626f 6f6c 2874 732e 7768 6f5f 6861 7329  bool(ts.who_has)
+00048f50: 203d 3d20 2874 732e 7374 6174 6520 3d3d   == (ts.state ==
+00048f60: 2022 6d65 6d6f 7279 2229 2c20 2874 732c   "memory"), (ts,
+00048f70: 2074 732e 7768 6f5f 6861 732c 2074 732e   ts.who_has, ts.
+00048f80: 7374 6174 6529 0a0a 2020 2020 6966 2074  state)..    if t
+00048f90: 732e 7374 6174 6520 3d3d 2022 7175 6575  s.state == "queu
+00048fa0: 6564 223a 0a20 2020 2020 2020 2061 7373  ed":.        ass
+00048fb0: 6572 7420 6e6f 7420 7473 2e70 726f 6365  ert not ts.proce
+00048fc0: 7373 696e 675f 6f6e 0a20 2020 2020 2020  ssing_on.       
+00048fd0: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
+00048fe0: 686f 5f68 6173 0a20 2020 2020 2020 2061  ho_has.        a
+00048ff0: 7373 6572 7420 616c 6c28 6474 732e 7768  ssert all(dts.wh
+00049000: 6f5f 6861 7320 666f 7220 6474 7320 696e  o_has for dts in
+00049010: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
+00049020: 292c 2028 0a20 2020 2020 2020 2020 2020  ), (.           
+00049030: 2022 7461 736b 2071 7565 7565 6420 7769   "task queued wi
+00049040: 7468 6f75 7420 616c 6c20 6465 7073 222c  thout all deps",
+00049050: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
+00049060: 2874 7329 2c0a 2020 2020 2020 2020 2020  (ts),.          
+00049070: 2020 7374 7228 7473 2e64 6570 656e 6465    str(ts.depende
+00049080: 6e63 6965 7329 2c0a 2020 2020 2020 2020  ncies),.        
+00049090: 290a 0a20 2020 2069 6620 7473 2e73 7461  )..    if ts.sta
+000490a0: 7465 203d 3d20 2270 726f 6365 7373 696e  te == "processin
+000490b0: 6722 3a0a 2020 2020 2020 2020 6173 7365  g":.        asse
+000490c0: 7274 2061 6c6c 2864 7473 2e77 686f 5f68  rt all(dts.who_h
+000490d0: 6173 2066 6f72 2064 7473 2069 6e20 7473  as for dts in ts
+000490e0: 2e64 6570 656e 6465 6e63 6965 7329 2c20  .dependencies), 
+000490f0: 280a 2020 2020 2020 2020 2020 2020 2274  (.            "t
+00049100: 6173 6b20 7072 6f63 6573 7369 6e67 2077  ask processing w
+00049110: 6974 686f 7574 2061 6c6c 2064 6570 7322  ithout all deps"
+00049120: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
+00049130: 7228 7473 292c 0a20 2020 2020 2020 2020  r(ts),.         
+00049140: 2020 2073 7472 2874 732e 6465 7065 6e64     str(ts.depend
+00049150: 656e 6369 6573 292c 0a20 2020 2020 2020  encies),.       
+00049160: 2029 0a20 2020 2020 2020 2061 7373 6572   ).        asser
+00049170: 7420 6e6f 7420 7473 2e77 6169 7469 6e67  t not ts.waiting
+00049180: 5f6f 6e0a 0a20 2020 2069 6620 7473 2e77  _on..    if ts.w
+00049190: 686f 5f68 6173 3a0a 2020 2020 2020 2020  ho_has:.        
+000491a0: 6173 7365 7274 2074 732e 7761 6974 6572  assert ts.waiter
+000491b0: 7320 6f72 2074 732e 7768 6f5f 7761 6e74  s or ts.who_want
+000491c0: 732c 2028 0a20 2020 2020 2020 2020 2020  s, (.           
+000491d0: 2022 756e 6e65 6564 6564 2074 6173 6b20   "unneeded task 
+000491e0: 696e 206d 656d 6f72 7922 2c0a 2020 2020  in memory",.    
+000491f0: 2020 2020 2020 2020 7374 7228 7473 292c          str(ts),
+00049200: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
+00049210: 2874 732e 7768 6f5f 6861 7329 2c0a 2020  (ts.who_has),.  
+00049220: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00049230: 6966 2074 732e 7275 6e5f 7370 6563 3a20  if ts.run_spec: 
+00049240: 2023 2077 6173 2063 6f6d 7075 7465 640a   # was computed.
+00049250: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00049260: 7274 2074 732e 7479 7065 0a20 2020 2020  rt ts.type.     
+00049270: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
+00049280: 696e 7374 616e 6365 2874 732e 7479 7065  instance(ts.type
+00049290: 2c20 7374 7229 0a20 2020 2020 2020 2061  , str).        a
+000492a0: 7373 6572 7420 6e6f 7420 616e 7928 5b74  ssert not any([t
+000492b0: 7320 696e 2064 7473 2e77 6169 7469 6e67  s in dts.waiting
+000492c0: 5f6f 6e20 666f 7220 6474 7320 696e 2074  _on for dts in t
+000492d0: 732e 6465 7065 6e64 656e 7473 5d29 0a20  s.dependents]). 
+000492e0: 2020 2020 2020 2066 6f72 2077 7320 696e         for ws in
+000492f0: 2074 732e 7768 6f5f 6861 733a 0a20 2020   ts.who_has:.   
+00049300: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00049310: 7473 2069 6e20 7773 2e68 6173 5f77 6861  ts in ws.has_wha
+00049320: 742c 2028 0a20 2020 2020 2020 2020 2020  t, (.           
+00049330: 2020 2020 2022 6e6f 7420 696e 2077 686f       "not in who
+00049340: 5f68 6173 2720 6861 735f 7768 6174 222c  _has' has_what",
+00049350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00049360: 2073 7472 2874 7329 2c0a 2020 2020 2020   str(ts),.      
+00049370: 2020 2020 2020 2020 2020 7374 7228 7773            str(ws
+00049380: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00049390: 2020 2073 7472 2877 732e 6861 735f 7768     str(ws.has_wh
+000493a0: 6174 292c 0a20 2020 2020 2020 2020 2020  at),.           
+000493b0: 2029 0a0a 2020 2020 666f 7220 6373 2069   )..    for cs i
+000493c0: 6e20 7473 2e77 686f 5f77 616e 7473 3a0a  n ts.who_wants:.
+000493d0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+000493e0: 7320 696e 2063 732e 7761 6e74 735f 7768  s in cs.wants_wh
+000493f0: 6174 2c20 280a 2020 2020 2020 2020 2020  at, (.          
+00049400: 2020 226e 6f74 2069 6e20 7768 6f5f 7761    "not in who_wa
+00049410: 6e74 7327 2077 616e 7473 5f77 6861 7422  nts' wants_what"
+00049420: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
+00049430: 7228 7473 292c 0a20 2020 2020 2020 2020  r(ts),.         
+00049440: 2020 2073 7472 2863 7329 2c0a 2020 2020     str(cs),.    
+00049450: 2020 2020 2020 2020 7374 7228 6373 2e77          str(cs.w
+00049460: 616e 7473 5f77 6861 7429 2c0a 2020 2020  ants_what),.    
+00049470: 2020 2020 290a 0a20 2020 2069 6620 7473      )..    if ts
+00049480: 2e61 6374 6f72 3a0a 2020 2020 2020 2020  .actor:.        
+00049490: 6966 2074 732e 7374 6174 6520 3d3d 2022  if ts.state == "
+000494a0: 6d65 6d6f 7279 223a 0a20 2020 2020 2020  memory":.       
+000494b0: 2020 2020 2061 7373 6572 7420 7375 6d28       assert sum(
+000494c0: 7473 2069 6e20 7773 2e61 6374 6f72 7320  ts in ws.actors 
+000494d0: 666f 7220 7773 2069 6e20 7473 2e77 686f  for ws in ts.who
+000494e0: 5f68 6173 2920 3d3d 2031 0a20 2020 2020  _has) == 1.     
+000494f0: 2020 2069 6620 7473 2e73 7461 7465 203d     if ts.state =
+00049500: 3d20 2270 726f 6365 7373 696e 6722 3a0a  = "processing":.
+00049510: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00049520: 7274 2074 732e 7072 6f63 6573 7369 6e67  rt ts.processing
+00049530: 5f6f 6e0a 2020 2020 2020 2020 2020 2020  _on.            
+00049540: 6173 7365 7274 2074 7320 696e 2074 732e  assert ts in ts.
+00049550: 7072 6f63 6573 7369 6e67 5f6f 6e2e 6163  processing_on.ac
+00049560: 746f 7273 0a20 2020 2020 2020 2061 7373  tors.        ass
+00049570: 6572 7420 7473 2e73 7461 7465 2021 3d20  ert ts.state != 
+00049580: 2271 7565 7565 6422 0a0a 0a64 6566 2076  "queued"...def v
+00049590: 616c 6964 6174 655f 776f 726b 6572 5f73  alidate_worker_s
+000495a0: 7461 7465 2877 733a 2057 6f72 6b65 7253  tate(ws: WorkerS
+000495b0: 7461 7465 2920 2d3e 204e 6f6e 653a 0a20  tate) -> None:. 
+000495c0: 2020 2066 6f72 2074 7320 696e 2077 732e     for ts in ws.
+000495d0: 6861 735f 7768 6174 3a0a 2020 2020 2020  has_what:.      
+000495e0: 2020 6173 7365 7274 2077 7320 696e 2074    assert ws in t
+000495f0: 732e 7768 6f5f 6861 732c 2028 0a20 2020  s.who_has, (.   
+00049600: 2020 2020 2020 2020 2022 6e6f 7420 696e           "not in
+00049610: 2068 6173 5f77 6861 7427 2077 686f 5f68   has_what' who_h
+00049620: 6173 222c 0a20 2020 2020 2020 2020 2020  as",.           
+00049630: 2073 7472 2877 7329 2c0a 2020 2020 2020   str(ws),.      
+00049640: 2020 2020 2020 7374 7228 7473 292c 0a20        str(ts),. 
+00049650: 2020 2020 2020 2020 2020 2073 7472 2874             str(t
+00049660: 732e 7768 6f5f 6861 7329 2c0a 2020 2020  s.who_has),.    
+00049670: 2020 2020 290a 0a20 2020 2066 6f72 2074      )..    for t
+00049680: 7320 696e 2077 732e 6163 746f 7273 3a0a  s in ws.actors:.
+00049690: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+000496a0: 732e 7374 6174 6520 696e 2028 226d 656d  s.state in ("mem
+000496b0: 6f72 7922 2c20 2270 726f 6365 7373 696e  ory", "processin
+000496c0: 6722 290a 0a0a 6465 6620 7661 6c69 6461  g")...def valida
+000496d0: 7465 5f73 7461 7465 280a 2020 2020 7461  te_state(.    ta
+000496e0: 736b 733a 2064 6963 745b 7374 722c 2054  sks: dict[str, T
+000496f0: 6173 6b53 7461 7465 5d2c 0a20 2020 2077  askState],.    w
+00049700: 6f72 6b65 7273 3a20 6469 6374 5b73 7472  orkers: dict[str
+00049710: 2c20 576f 726b 6572 5374 6174 655d 2c0a  , WorkerState],.
+00049720: 2020 2020 636c 6965 6e74 733a 2064 6963      clients: dic
+00049730: 745b 7374 722c 2043 6c69 656e 7453 7461  t[str, ClientSta
+00049740: 7465 5d2c 0a29 202d 3e20 4e6f 6e65 3a0a  te],.) -> None:.
+00049750: 2020 2020 2222 2256 616c 6964 6174 6520      """Validate 
+00049760: 6120 6375 7272 656e 7420 7275 6e74 696d  a current runtim
+00049770: 6520 7374 6174 652e 0a0a 2020 2020 5468  e state...    Th
+00049780: 6973 2070 6572 666f 726d 7320 6120 7365  is performs a se
+00049790: 7175 656e 6365 206f 6620 6368 6563 6b73  quence of checks
+000497a0: 206f 6e20 7468 6520 656e 7469 7265 2067   on the entire g
+000497b0: 7261 7068 2c20 7275 6e6e 696e 6720 696e  raph, running in
+000497c0: 2061 626f 7574 206c 696e 6561 720a 2020   about linear.  
+000497d0: 2020 7469 6d65 2e20 5468 6973 2072 6169    time. This rai
+000497e0: 7365 7320 6173 7365 7274 2065 7272 6f72  ses assert error
+000497f0: 7320 6966 2061 6e79 7468 696e 6720 646f  s if anything do
+00049800: 6573 6e27 7420 6368 6563 6b20 6f75 742e  esn't check out.
+00049810: 0a20 2020 2022 2222 0a20 2020 2066 6f72  .    """.    for
+00049820: 2074 7320 696e 2074 6173 6b73 2e76 616c   ts in tasks.val
+00049830: 7565 7328 293a 0a20 2020 2020 2020 2076  ues():.        v
+00049840: 616c 6964 6174 655f 7461 736b 5f73 7461  alidate_task_sta
+00049850: 7465 2874 7329 0a0a 2020 2020 666f 7220  te(ts)..    for 
+00049860: 7773 2069 6e20 776f 726b 6572 732e 7661  ws in workers.va
+00049870: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
+00049880: 7661 6c69 6461 7465 5f77 6f72 6b65 725f  validate_worker_
+00049890: 7374 6174 6528 7773 290a 0a20 2020 2066  state(ws)..    f
+000498a0: 6f72 2063 7320 696e 2063 6c69 656e 7473  or cs in clients
+000498b0: 2e76 616c 7565 7328 293a 0a20 2020 2020  .values():.     
+000498c0: 2020 2066 6f72 2074 7320 696e 2063 732e     for ts in cs.
+000498d0: 7761 6e74 735f 7768 6174 3a0a 2020 2020  wants_what:.    
+000498e0: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
+000498f0: 7320 696e 2074 732e 7768 6f5f 7761 6e74  s in ts.who_want
+00049900: 732c 2028 0a20 2020 2020 2020 2020 2020  s, (.           
+00049910: 2020 2020 2022 6e6f 7420 696e 2077 616e       "not in wan
+00049920: 7473 5f77 6861 7427 2077 686f 5f77 616e  ts_what' who_wan
+00049930: 7473 222c 0a20 2020 2020 2020 2020 2020  ts",.           
+00049940: 2020 2020 2073 7472 2863 7329 2c0a 2020       str(cs),.  
+00049950: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00049960: 7228 7473 292c 0a20 2020 2020 2020 2020  r(ts),.         
+00049970: 2020 2020 2020 2073 7472 2874 732e 7768         str(ts.wh
+00049980: 6f5f 7761 6e74 7329 2c0a 2020 2020 2020  o_wants),.      
+00049990: 2020 2020 2020 290a 0a0a 6465 6620 6865        )...def he
+000499a0: 6172 7462 6561 745f 696e 7465 7276 616c  artbeat_interval
+000499b0: 286e 3a20 696e 7429 202d 3e20 666c 6f61  (n: int) -> floa
+000499c0: 743a 0a20 2020 2022 2222 496e 7465 7276  t:.    """Interv
+000499d0: 616c 2069 6e20 7365 636f 6e64 7320 7468  al in seconds th
+000499e0: 6174 2077 6520 6465 7369 7265 2068 6561  at we desire hea
+000499f0: 7274 6265 6174 7320 6261 7365 6420 6f6e  rtbeats based on
+00049a00: 206e 756d 6265 7220 6f66 2077 6f72 6b65   number of worke
+00049a10: 7273 2222 220a 2020 2020 6966 206e 203c  rs""".    if n <
+00049a20: 3d20 3130 3a0a 2020 2020 2020 2020 7265  = 10:.        re
+00049a30: 7475 726e 2030 2e35 0a20 2020 2065 6c69  turn 0.5.    eli
+00049a40: 6620 6e20 3c20 3530 3a0a 2020 2020 2020  f n < 50:.      
+00049a50: 2020 7265 7475 726e 2031 0a20 2020 2065    return 1.    e
+00049a60: 6c69 6620 6e20 3c20 3230 303a 0a20 2020  lif n < 200:.   
+00049a70: 2020 2020 2072 6574 7572 6e20 320a 2020       return 2.  
+00049a80: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00049a90: 2320 4e6f 206d 6f72 6520 7468 616e 2032  # No more than 2
+00049aa0: 3030 2068 6561 7274 6265 6174 7320 6120  00 heartbeats a 
+00049ab0: 7365 636f 6e64 2073 6361 6c65 6420 6279  second scaled by
+00049ac0: 2077 6f72 6b65 7273 0a20 2020 2020 2020   workers.       
+00049ad0: 2072 6574 7572 6e20 6e20 2f20 3230 3020   return n / 200 
+00049ae0: 2b20 310a 0a0a 6465 6620 5f74 6173 6b5f  + 1...def _task_
+00049af0: 736c 6f74 735f 6176 6169 6c61 626c 6528  slots_available(
+00049b00: 7773 3a20 576f 726b 6572 5374 6174 652c  ws: WorkerState,
+00049b10: 2073 6174 7572 6174 696f 6e5f 6661 6374   saturation_fact
+00049b20: 6f72 3a20 666c 6f61 7429 202d 3e20 696e  or: float) -> in
+00049b30: 743a 0a20 2020 2022 2222 4e75 6d62 6572  t:.    """Number
+00049b40: 206f 6620 7461 736b 7320 7468 6174 2063   of tasks that c
+00049b50: 616e 2062 6520 7365 6e74 2074 6f20 7468  an be sent to th
+00049b60: 6973 2077 6f72 6b65 7220 7769 7468 6f75  is worker withou
+00049b70: 7420 6f76 6572 7361 7475 7261 7469 6e67  t oversaturating
+00049b80: 2069 7422 2222 0a20 2020 2061 7373 6572   it""".    asser
+00049b90: 7420 6e6f 7420 6d61 7468 2e69 7369 6e66  t not math.isinf
+00049ba0: 2873 6174 7572 6174 696f 6e5f 6661 6374  (saturation_fact
+00049bb0: 6f72 290a 2020 2020 7265 7475 726e 206d  or).    return m
+00049bc0: 6178 286d 6174 682e 6365 696c 2873 6174  ax(math.ceil(sat
+00049bd0: 7572 6174 696f 6e5f 6661 6374 6f72 202a  uration_factor *
+00049be0: 2077 732e 6e74 6872 6561 6473 292c 2031   ws.nthreads), 1
+00049bf0: 2920 2d20 280a 2020 2020 2020 2020 6c65  ) - (.        le
+00049c00: 6e28 7773 2e70 726f 6365 7373 696e 6729  n(ws.processing)
+00049c10: 202d 206c 656e 2877 732e 6c6f 6e67 5f72   - len(ws.long_r
+00049c20: 756e 6e69 6e67 290a 2020 2020 290a 0a0a  unning).    )...
+00049c30: 6465 6620 5f77 6f72 6b65 725f 6675 6c6c  def _worker_full
+00049c40: 2877 733a 2057 6f72 6b65 7253 7461 7465  (ws: WorkerState
+00049c50: 2c20 7361 7475 7261 7469 6f6e 5f66 6163  , saturation_fac
+00049c60: 746f 723a 2066 6c6f 6174 2920 2d3e 2062  tor: float) -> b
+00049c70: 6f6f 6c3a 0a20 2020 2069 6620 6d61 7468  ool:.    if math
+00049c80: 2e69 7369 6e66 2873 6174 7572 6174 696f  .isinf(saturatio
+00049c90: 6e5f 6661 6374 6f72 293a 0a20 2020 2020  n_factor):.     
+00049ca0: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+00049cb0: 2020 2020 7265 7475 726e 205f 7461 736b      return _task
+00049cc0: 5f73 6c6f 7473 5f61 7661 696c 6162 6c65  _slots_available
+00049cd0: 2877 732c 2073 6174 7572 6174 696f 6e5f  (ws, saturation_
+00049ce0: 6661 6374 6f72 2920 3c3d 2030 0a0a 0a63  factor) <= 0...c
+00049cf0: 6c61 7373 204b 696c 6c65 6457 6f72 6b65  lass KilledWorke
+00049d00: 7228 4578 6365 7074 696f 6e29 3a0a 2020  r(Exception):.  
+00049d10: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+00049d20: 656c 662c 2074 6173 6b3a 2073 7472 2c20  elf, task: str, 
+00049d30: 6c61 7374 5f77 6f72 6b65 723a 2057 6f72  last_worker: Wor
+00049d40: 6b65 7253 7461 7465 2c20 616c 6c6f 7765  kerState, allowe
+00049d50: 645f 6661 696c 7572 6573 3a20 696e 7429  d_failures: int)
+00049d60: 3a0a 2020 2020 2020 2020 7375 7065 7228  :.        super(
+00049d70: 292e 5f5f 696e 6974 5f5f 2874 6173 6b2c  ).__init__(task,
+00049d80: 206c 6173 745f 776f 726b 6572 2c20 616c   last_worker, al
+00049d90: 6c6f 7765 645f 6661 696c 7572 6573 290a  lowed_failures).
+00049da0: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
+00049db0: 2020 2064 6566 2074 6173 6b28 7365 6c66     def task(self
+00049dc0: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
+00049dd0: 2020 7265 7475 726e 2073 656c 662e 6172    return self.ar
+00049de0: 6773 5b30 5d0a 0a20 2020 2040 7072 6f70  gs[0]..    @prop
+00049df0: 6572 7479 0a20 2020 2064 6566 206c 6173  erty.    def las
+00049e00: 745f 776f 726b 6572 2873 656c 6629 202d  t_worker(self) -
+00049e10: 3e20 576f 726b 6572 5374 6174 653a 0a20  > WorkerState:. 
+00049e20: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00049e30: 6c66 2e61 7267 735b 315d 0a0a 2020 2020  lf.args[1]..    
+00049e40: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
+00049e50: 6620 616c 6c6f 7765 645f 6661 696c 7572  f allowed_failur
+00049e60: 6573 2873 656c 6629 202d 3e20 696e 743a  es(self) -> int:
+00049e70: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00049e80: 7365 6c66 2e61 7267 735b 325d 0a0a 2020  self.args[2]..  
+00049e90: 2020 6465 6620 5f5f 7374 725f 5f28 7365    def __str__(se
+00049ea0: 6c66 2920 2d3e 2073 7472 3a0a 2020 2020  lf) -> str:.    
+00049eb0: 2020 2020 7265 7475 726e 2028 0a20 2020      return (.   
+00049ec0: 2020 2020 2020 2020 2066 2241 7474 656d           f"Attem
+00049ed0: 7074 6564 2074 6f20 7275 6e20 7461 736b  pted to run task
+00049ee0: 207b 7365 6c66 2e74 6173 6b7d 206f 6e20   {self.task} on 
+00049ef0: 7b73 656c 662e 616c 6c6f 7765 645f 6661  {self.allowed_fa
+00049f00: 696c 7572 6573 7d20 6469 6666 6572 656e  ilures} differen
+00049f10: 7420 220a 2020 2020 2020 2020 2020 2020  t ".            
+00049f20: 2277 6f72 6b65 7273 2c20 6275 7420 616c  "workers, but al
+00049f30: 6c20 7468 6f73 6520 776f 726b 6572 7320  l those workers 
+00049f40: 6469 6564 2077 6869 6c65 2072 756e 6e69  died while runni
+00049f50: 6e67 2069 742e 2022 0a20 2020 2020 2020  ng it. ".       
+00049f60: 2020 2020 2066 2254 6865 206c 6173 7420       f"The last 
+00049f70: 776f 726b 6572 2074 6861 7420 6174 7465  worker that atte
+00049f80: 6d70 7420 746f 2072 756e 2074 6865 2074  mpt to run the t
+00049f90: 6173 6b20 7761 7320 7b73 656c 662e 6c61  ask was {self.la
+00049fa0: 7374 5f77 6f72 6b65 722e 6164 6472 6573  st_worker.addres
+00049fb0: 737d 2e20 220a 2020 2020 2020 2020 2020  s}. ".          
+00049fc0: 2020 2249 6e73 7065 6374 696e 6720 776f    "Inspecting wo
+00049fd0: 726b 6572 206c 6f67 7320 6973 206f 6674  rker logs is oft
+00049fe0: 656e 2061 2067 6f6f 6420 6e65 7874 2073  en a good next s
+00049ff0: 7465 7020 746f 2064 6961 676e 6f73 6520  tep to diagnose 
+0004a000: 7768 6174 2077 656e 7420 7772 6f6e 672e  what went wrong.
+0004a010: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
+0004a020: 466f 7220 6d6f 7265 2069 6e66 6f72 6d61  For more informa
+0004a030: 7469 6f6e 2073 6565 2068 7474 7073 3a2f  tion see https:/
+0004a040: 2f64 6973 7472 6962 7574 6564 2e64 6173  /distributed.das
+0004a050: 6b2e 6f72 672f 656e 2f73 7461 626c 652f  k.org/en/stable/
+0004a060: 6b69 6c6c 6564 2e68 746d 6c2e 220a 2020  killed.html.".  
+0004a070: 2020 2020 2020 290a 0a0a 636c 6173 7320        )...class 
+0004a080: 576f 726b 6572 5374 6174 7573 506c 7567  WorkerStatusPlug
+0004a090: 696e 2853 6368 6564 756c 6572 506c 7567  in(SchedulerPlug
+0004a0a0: 696e 293a 0a20 2020 2022 2222 4120 706c  in):.    """A pl
+0004a0b0: 7567 696e 2074 6f20 7368 6172 6520 776f  ugin to share wo
+0004a0c0: 726b 6572 2073 7461 7475 7320 7769 7468  rker status with
+0004a0d0: 2061 2072 656d 6f74 6520 6f62 7365 7276   a remote observ
+0004a0e0: 6572 0a0a 2020 2020 5468 6973 2069 7320  er..    This is 
+0004a0f0: 7573 6564 2069 6e20 636c 7573 7465 7220  used in cluster 
+0004a100: 6d61 6e61 6765 7273 2074 6f20 6b65 6570  managers to keep
+0004a110: 2075 7064 6174 6564 2061 626f 7574 2074   updated about t
+0004a120: 6865 2073 7461 7475 7320 6f66 2074 6865  he status of the
+0004a130: 2073 6368 6564 756c 6572 2e0a 2020 2020   scheduler..    
+0004a140: 2222 220a 0a20 2020 206e 616d 653a 2043  """..    name: C
+0004a150: 6c61 7373 5661 725b 7374 725d 203d 2022  lassVar[str] = "
+0004a160: 776f 726b 6572 2d73 7461 7475 7322 0a20  worker-status". 
+0004a170: 2020 2062 636f 6d6d 3a20 4261 7463 6865     bcomm: Batche
+0004a180: 6453 656e 640a 0a20 2020 2064 6566 205f  dSend..    def _
+0004a190: 5f69 6e69 745f 5f28 7365 6c66 2c20 7363  _init__(self, sc
+0004a1a0: 6865 6475 6c65 723a 2053 6368 6564 756c  heduler: Schedul
+0004a1b0: 6572 2c20 636f 6d6d 3a20 436f 6d6d 293a  er, comm: Comm):
+0004a1c0: 0a20 2020 2020 2020 2073 656c 662e 6263  .        self.bc
+0004a1d0: 6f6d 6d20 3d20 4261 7463 6865 6453 656e  omm = BatchedSen
+0004a1e0: 6428 696e 7465 7276 616c 3d22 356d 7322  d(interval="5ms"
+0004a1f0: 290a 2020 2020 2020 2020 7365 6c66 2e62  ).        self.b
+0004a200: 636f 6d6d 2e73 7461 7274 2863 6f6d 6d29  comm.start(comm)
+0004a210: 0a20 2020 2020 2020 2073 6368 6564 756c  .        schedul
+0004a220: 6572 2e61 6464 5f70 6c75 6769 6e28 7365  er.add_plugin(se
+0004a230: 6c66 290a 0a20 2020 2064 6566 2061 6464  lf)..    def add
+0004a240: 5f77 6f72 6b65 7228 7365 6c66 2c20 7363  _worker(self, sc
+0004a250: 6865 6475 6c65 723a 2053 6368 6564 756c  heduler: Schedul
+0004a260: 6572 2c20 776f 726b 6572 3a20 7374 7229  er, worker: str)
+0004a270: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0004a280: 2020 6964 656e 7420 3d20 7363 6865 6475    ident = schedu
+0004a290: 6c65 722e 776f 726b 6572 735b 776f 726b  ler.workers[work
+0004a2a0: 6572 5d2e 6964 656e 7469 7479 2829 0a20  er].identity(). 
+0004a2b0: 2020 2020 2020 2064 656c 2069 6465 6e74         del ident
+0004a2c0: 5b22 6d65 7472 6963 7322 5d0a 2020 2020  ["metrics"].    
+0004a2d0: 2020 2020 6465 6c20 6964 656e 745b 226c      del ident["l
+0004a2e0: 6173 745f 7365 656e 225d 0a20 2020 2020  ast_seen"].     
+0004a2f0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0004a300: 2020 2020 7365 6c66 2e62 636f 6d6d 2e73      self.bcomm.s
+0004a310: 656e 6428 5b22 6164 6422 2c20 7b22 776f  end(["add", {"wo
+0004a320: 726b 6572 7322 3a20 7b77 6f72 6b65 723a  rkers": {worker:
+0004a330: 2069 6465 6e74 7d7d 5d29 0a20 2020 2020   ident}}]).     
+0004a340: 2020 2065 7863 6570 7420 436f 6d6d 436c     except CommCl
+0004a350: 6f73 6564 4572 726f 723a 0a20 2020 2020  osedError:.     
+0004a360: 2020 2020 2020 2073 6368 6564 756c 6572         scheduler
+0004a370: 2e72 656d 6f76 655f 706c 7567 696e 286e  .remove_plugin(n
+0004a380: 616d 653d 7365 6c66 2e6e 616d 6529 0a0a  ame=self.name)..
+0004a390: 2020 2020 6465 6620 7265 6d6f 7665 5f77      def remove_w
+0004a3a0: 6f72 6b65 7228 7365 6c66 2c20 7363 6865  orker(self, sche
+0004a3b0: 6475 6c65 723a 2053 6368 6564 756c 6572  duler: Scheduler
+0004a3c0: 2c20 776f 726b 6572 3a20 7374 7229 202d  , worker: str) -
+0004a3d0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+0004a3e0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0004a3f0: 2073 656c 662e 6263 6f6d 6d2e 7365 6e64   self.bcomm.send
+0004a400: 285b 2272 656d 6f76 6522 2c20 776f 726b  (["remove", work
+0004a410: 6572 5d29 0a20 2020 2020 2020 2065 7863  er]).        exc
+0004a420: 6570 7420 436f 6d6d 436c 6f73 6564 4572  ept CommClosedEr
+0004a430: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+0004a440: 2073 6368 6564 756c 6572 2e72 656d 6f76   scheduler.remov
+0004a450: 655f 706c 7567 696e 286e 616d 653d 7365  e_plugin(name=se
+0004a460: 6c66 2e6e 616d 6529 0a0a 2020 2020 6465  lf.name)..    de
+0004a470: 6620 7465 6172 646f 776e 2873 656c 6629  f teardown(self)
+0004a480: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0004a490: 2020 7365 6c66 2e62 636f 6d6d 2e63 6c6f    self.bcomm.clo
+0004a4a0: 7365 2829 0a0a 0a63 6c61 7373 2043 6f6c  se()...class Col
+0004a4b0: 6c65 6374 5461 736b 4d65 7461 4461 7461  lectTaskMetaData
+0004a4c0: 506c 7567 696e 2853 6368 6564 756c 6572  Plugin(Scheduler
+0004a4d0: 506c 7567 696e 293a 0a20 2020 2073 6368  Plugin):.    sch
+0004a4e0: 6564 756c 6572 3a20 5363 6865 6475 6c65  eduler: Schedule
+0004a4f0: 720a 2020 2020 6e61 6d65 3a20 7374 720a  r.    name: str.
+0004a500: 2020 2020 6b65 7973 3a20 7365 745b 7374      keys: set[st
+0004a510: 725d 0a20 2020 206d 6574 6164 6174 613a  r].    metadata:
+0004a520: 2064 6963 745b 7374 722c 2041 6e79 5d0a   dict[str, Any].
+0004a530: 2020 2020 7374 6174 653a 2064 6963 745b      state: dict[
+0004a540: 7374 722c 2073 7472 5d0a 0a20 2020 2064  str, str]..    d
+0004a550: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+0004a560: 2c20 7363 6865 6475 6c65 723a 2053 6368  , scheduler: Sch
+0004a570: 6564 756c 6572 2c20 6e61 6d65 3a20 7374  eduler, name: st
+0004a580: 7229 3a0a 2020 2020 2020 2020 7365 6c66  r):.        self
+0004a590: 2e73 6368 6564 756c 6572 203d 2073 6368  .scheduler = sch
+0004a5a0: 6564 756c 6572 0a20 2020 2020 2020 2073  eduler.        s
+0004a5b0: 656c 662e 6e61 6d65 203d 206e 616d 650a  elf.name = name.
+0004a5c0: 2020 2020 2020 2020 7365 6c66 2e6b 6579          self.key
+0004a5d0: 7320 3d20 7365 7428 290a 2020 2020 2020  s = set().      
+0004a5e0: 2020 7365 6c66 2e6d 6574 6164 6174 6120    self.metadata 
+0004a5f0: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
+0004a600: 662e 7374 6174 6520 3d20 7b7d 0a0a 2020  f.state = {}..  
+0004a610: 2020 6465 6620 7570 6461 7465 5f67 7261    def update_gra
+0004a620: 7068 280a 2020 2020 2020 2020 7365 6c66  ph(.        self
+0004a630: 2c0a 2020 2020 2020 2020 7363 6865 6475  ,.        schedu
+0004a640: 6c65 723a 2053 6368 6564 756c 6572 2c0a  ler: Scheduler,.
+0004a650: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
+0004a660: 2020 206b 6579 733a 2073 6574 5b73 7472     keys: set[str
+0004a670: 5d2c 0a20 2020 2020 2020 202a 2a6b 7761  ],.        **kwa
+0004a680: 7267 733a 2041 6e79 2c0a 2020 2020 2920  rgs: Any,.    ) 
+0004a690: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+0004a6a0: 2073 656c 662e 6b65 7973 2e75 7064 6174   self.keys.updat
+0004a6b0: 6528 6b65 7973 290a 0a20 2020 2064 6566  e(keys)..    def
+0004a6c0: 2074 7261 6e73 6974 696f 6e28 0a20 2020   transition(.   
+0004a6d0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+0004a6e0: 2020 206b 6579 3a20 7374 722c 0a20 2020     key: str,.   
+0004a6f0: 2020 2020 2073 7461 7274 3a20 5461 736b       start: Task
+0004a700: 5374 6174 6553 7461 7465 2c0a 2020 2020  StateState,.    
+0004a710: 2020 2020 6669 6e69 7368 3a20 5461 736b      finish: Task
+0004a720: 5374 6174 6553 7461 7465 2c0a 2020 2020  StateState,.    
+0004a730: 2020 2020 2a61 7267 733a 2041 6e79 2c0a      *args: Any,.
+0004a740: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+0004a750: 3a20 416e 792c 0a20 2020 2029 202d 3e20  : Any,.    ) -> 
+0004a760: 4e6f 6e65 3a0a 2020 2020 2020 2020 6966  None:.        if
+0004a770: 2066 696e 6973 6820 696e 2028 226d 656d   finish in ("mem
+0004a780: 6f72 7922 2c20 2265 7272 6564 2229 3a0a  ory", "erred"):.
+0004a790: 2020 2020 2020 2020 2020 2020 7473 203d              ts =
+0004a7a0: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
+0004a7b0: 7461 736b 732e 6765 7428 6b65 7929 0a20  tasks.get(key). 
+0004a7c0: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
+0004a7d0: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
+0004a7e0: 2074 732e 6b65 7920 696e 2073 656c 662e   ts.key in self.
+0004a7f0: 6b65 7973 3a0a 2020 2020 2020 2020 2020  keys:.          
+0004a800: 2020 2020 2020 7365 6c66 2e6d 6574 6164        self.metad
+0004a810: 6174 615b 6b65 795d 203d 2074 732e 6d65  ata[key] = ts.me
+0004a820: 7461 6461 7461 0a20 2020 2020 2020 2020  tadata.         
+0004a830: 2020 2020 2020 2073 656c 662e 7374 6174         self.stat
+0004a840: 655b 6b65 795d 203d 2066 696e 6973 680a  e[key] = finish.
+0004a850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a860: 7365 6c66 2e6b 6579 732e 6469 7363 6172  self.keys.discar
+0004a870: 6428 6b65 7929 0a                        d(key).
```

### Comparing `distributed-2023.6.0/distributed/security.py` & `distributed-2023.6.1/distributed/security.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/semaphore.py` & `distributed-2023.6.1/distributed/semaphore.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/shuffle/__init__.py` & `distributed-2023.6.1/distributed/shuffle/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/shuffle/_arrow.py` & `distributed-2023.6.1/distributed/shuffle/_arrow.py`

 * *Files 14% similar despite different names*

```diff
@@ -42,25 +42,38 @@
     if parse(pa.__version__) < parse(minversion):
         raise RuntimeError(
             f"P2P shuffling requires pyarrow>={minversion} but only found {pa.__version__}"
         )
 
 
 def convert_partition(data: bytes, meta: pd.DataFrame) -> pd.DataFrame:
+    import pandas as pd
     import pyarrow as pa
 
     file = BytesIO(data)
     end = len(data)
     shards = []
     while file.tell() < end:
         sr = pa.RecordBatchStreamReader(file)
         shards.append(sr.read_all())
-    table = pa.concat_tables(shards)
+    table = pa.concat_tables(shards, promote=True)
     df = table.to_pandas(self_destruct=True)
-    return df.astype(meta.dtypes)
+
+    def default_types_mapper(pyarrow_dtype: pa.DataType) -> object:
+        # Avoid converting strings from `string[pyarrow]` to `string[python]`
+        # if we have *some* `string[pyarrow]`
+        if (
+            pyarrow_dtype in {pa.large_string(), pa.string()}
+            and pd.StringDtype("pyarrow") in meta.dtypes.values
+        ):
+            return pd.StringDtype("pyarrow")
+        return None
+
+    df = table.to_pandas(self_destruct=True, types_mapper=default_types_mapper)
+    return df.astype(meta.dtypes, copy=False)
 
 
 def list_of_buffers_to_table(data: list[bytes]) -> pa.Table:
     """Convert a list of arrow buffers and a schema to an Arrow Table"""
     import pyarrow as pa
 
     return pa.concat_tables(deserialize_table(buffer) for buffer in data)
```

### Comparing `distributed-2023.6.0/distributed/shuffle/_buffer.py` & `distributed-2023.6.1/distributed/shuffle/_buffer.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/shuffle/_comms.py` & `distributed-2023.6.1/distributed/shuffle/_comms.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/shuffle/_disk.py` & `distributed-2023.6.1/distributed/shuffle/_disk.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/shuffle/_limiter.py` & `distributed-2023.6.1/distributed/shuffle/_limiter.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/shuffle/_merge.py` & `distributed-2023.6.1/distributed/shuffle/_merge.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/shuffle/_rechunk.py` & `distributed-2023.6.1/distributed/shuffle/_rechunk.py`

 * *Files 12% similar despite different names*

```diff
@@ -1,12 +1,9 @@
 from __future__ import annotations
 
-import math
-from collections import defaultdict
-from itertools import compress, product
 from typing import TYPE_CHECKING, NamedTuple
 
 import dask
 from dask.base import tokenize
 from dask.highlevelgraph import HighLevelGraph, MaterializedLayer
 
 from distributed.exceptions import Reschedule
@@ -23,40 +20,40 @@
     from typing_extensions import TypeAlias
 
     import dask.array as da
 
 
 ChunkedAxis: TypeAlias = tuple[float, ...]  # chunks must either be an int or NaN
 ChunkedAxes: TypeAlias = tuple[ChunkedAxis, ...]
-NIndex: TypeAlias = tuple[int, ...]
-NSlice: TypeAlias = tuple[slice, ...]
+NDIndex: TypeAlias = tuple[int, ...]
+NDSlice: TypeAlias = tuple[slice, ...]
 
 
 def rechunk_transfer(
     input: np.ndarray,
     id: ShuffleId,
-    input_chunk: NIndex,
+    input_chunk: NDIndex,
     new: ChunkedAxes,
     old: ChunkedAxes,
 ) -> int:
     try:
         return _get_worker_extension().add_partition(
             input,
-            input_partition=input_chunk,
+            partition_id=input_chunk,
             shuffle_id=id,
             type=ShuffleType.ARRAY_RECHUNK,
             new=new,
             old=old,
         )
     except Exception as e:
         raise RuntimeError(f"rechunk_transfer failed during shuffle {id}") from e
 
 
 def rechunk_unpack(
-    id: ShuffleId, output_chunk: NIndex, barrier_run_id: int
+    id: ShuffleId, output_chunk: NDIndex, barrier_run_id: int
 ) -> np.ndarray:
     try:
         return _get_worker_extension().get_output_partition(
             id, barrier_run_id, output_chunk
         )
     except Reschedule as e:
         raise e
@@ -69,42 +66,14 @@
 
     import dask.array as da
 
     if x.size == 0:
         # Special case for empty array, as the algorithm below does not behave correctly
         return da.empty(x.shape, chunks=chunks, dtype=x.dtype)
 
-    old_chunks = x.chunks
-    new_chunks = chunks
-
-    def is_unknown(dim: ChunkedAxis) -> bool:
-        return any(math.isnan(chunk) for chunk in dim)
-
-    old_is_unknown = [is_unknown(dim) for dim in old_chunks]
-    new_is_unknown = [is_unknown(dim) for dim in new_chunks]
-
-    if old_is_unknown != new_is_unknown or any(
-        new != old for new, old in compress(zip(old_chunks, new_chunks), old_is_unknown)
-    ):
-        raise ValueError(
-            "Chunks must be unchanging along dimensions with missing values.\n\n"
-            "A possible solution:\n  x.compute_chunk_sizes()"
-        )
-
-    old_known = [dim for dim, unknown in zip(old_chunks, old_is_unknown) if not unknown]
-    new_known = [dim for dim, unknown in zip(new_chunks, new_is_unknown) if not unknown]
-
-    old_sizes = [sum(o) for o in old_known]
-    new_sizes = [sum(n) for n in new_known]
-
-    if old_sizes != new_sizes:
-        raise ValueError(
-            f"Cannot change dimensions from {old_sizes!r} to {new_sizes!r}"
-        )
-
     dsk: dict = {}
     token = tokenize(x, chunks)
     _barrier_key = barrier_key(ShuffleId(token))
     name = f"rechunk-transfer-{token}"
     transfer_keys = []
     for index in np.ndindex(tuple(len(dim) for dim in x.chunks)):
         transfer_keys.append((name,) + index)
@@ -146,42 +115,69 @@
         # The second chunk of the old array belongs to the first
         # chunk of the new array at the second sub-index
         (1,): [(ShardID((0,), (1,)), (slice(0, 2, None),))],
     }
     """
 
     #: Index of the new output chunk to which the shard belongs
-    chunk_index: NIndex
-    #: Index of the shard within the multi-dimensional array of shards that will be
+    chunk_index: NDIndex
+    #: Index of the shard within the n-dimensional array of shards that will be
     # concatenated into the new chunk
-    shard_index: NIndex
+    shard_index: NDIndex
 
 
-def rechunk_slicing(
-    old: ChunkedAxes, new: ChunkedAxes
-) -> dict[NIndex, list[tuple[ShardID, NSlice]]]:
-    """Calculate how to slice the old chunks to create the new chunks
+class Split(NamedTuple):
+    """Slice of a chunk that is concatenated with other splits to create a new chunk
 
-    Returns
-    -------
-        Mapping of each old chunk to a list of tuples defining where each slice
-        of the old chunk belongs. Each tuple consists of the index
-        of the new chunk, the index of the slice within the composition of slices
-        creating the new chunk, and the slice to be applied to the old chunk.
+    Splits define how to slice an input chunk on a single axis into small pieces
+    that can be concatenated together with splits from other input chunks to create
+    output chunks of a rechunk operation.
     """
-    from dask.array.rechunk import intersect_chunks
 
-    ndim = len(old)
-    intersections = intersect_chunks(old, new)
-    new_indices = product(*(range(len(c)) for c in new))
+    #: Index of the new output chunk to which this split belongs.
+    chunk_index: int
+
+    #: Index of the split within the list of splits that are concatenated
+    #: to create the new chunk.
+    split_index: int
+
+    #: Slice of the input chunk.
+    slice: slice
+
+
+SplitChunk: TypeAlias = list[Split]
+SplitAxis: TypeAlias = list[SplitChunk]
+SplitAxes: TypeAlias = list[SplitAxis]
 
-    slicing = defaultdict(list)
 
-    for new_index, new_chunk in zip(new_indices, intersections):
-        sub_shape = [len({slice[dim][0] for slice in new_chunk}) for dim in range(ndim)]
+def split_axes(old: ChunkedAxes, new: ChunkedAxes) -> SplitAxes:
+    """Calculate how to split the old chunks on each axis to create the new chunks
+
+    Parameters
+    ----------
+    old : ChunkedAxes
+        Chunks along each axis of the old array
+    new : ChunkedAxes
+        Chunks along each axis of the new array
+
+    Returns
+    -------
+    SplitAxes
+        Splits along each axis that determine how to slice the input chunks to create
+        the new chunks by concatenating the resulting shards.
+    """
+    from dask.array.rechunk import old_to_new
 
-        shard_indices = product(*(range(dim) for dim in sub_shape))
+    _old_to_new = old_to_new(old, new)
 
-        for shard_index, sliced_chunk in zip(shard_indices, new_chunk):
-            old_index, nslice = zip(*sliced_chunk)
-            slicing[old_index].append((ShardID(new_index, shard_index), nslice))
-    return slicing
+    axes = []
+    for axis_index, new_axis in enumerate(_old_to_new):
+        old_axis: SplitAxis = [[] for _ in old[axis_index]]
+        for new_chunk_index, new_chunk in enumerate(new_axis):
+            for split_index, (old_chunk_index, slice) in enumerate(new_chunk):
+                old_axis[old_chunk_index].append(
+                    Split(new_chunk_index, split_index, slice)
+                )
+        for old_chunk in old_axis:
+            old_chunk.sort(key=lambda split: split.slice.start)
+        axes.append(old_axis)
+    return axes
```

### Comparing `distributed-2023.6.0/distributed/shuffle/_scheduler_extension.py` & `distributed-2023.6.1/distributed/shuffle/_scheduler_extension.py`

 * *Files 1% similar despite different names*

```diff
@@ -8,15 +8,15 @@
 from collections.abc import Callable, Iterable, Sequence
 from dataclasses import dataclass
 from functools import partial
 from itertools import product
 from typing import TYPE_CHECKING, Any, ClassVar
 
 from distributed.diagnostics.plugin import SchedulerPlugin
-from distributed.shuffle._rechunk import ChunkedAxes, NIndex
+from distributed.shuffle._rechunk import ChunkedAxes, NDIndex
 from distributed.shuffle._shuffle import (
     ShuffleId,
     ShuffleType,
     barrier_key,
     id_from_key,
 )
 
@@ -30,15 +30,15 @@
     )
 
 logger = logging.getLogger(__name__)
 
 
 @dataclass
 class ShuffleState(abc.ABC):
-    _run_id_iterator: ClassVar[itertools.count] = itertools.count()
+    _run_id_iterator: ClassVar[itertools.count] = itertools.count(1)
 
     id: ShuffleId
     run_id: int
     output_workers: set[str]
     participating_workers: set[str]
 
     @abc.abstractmethod
@@ -62,15 +62,15 @@
             "output_workers": self.output_workers,
         }
 
 
 @dataclass
 class ArrayRechunkState(ShuffleState):
     type: ClassVar[ShuffleType] = ShuffleType.ARRAY_RECHUNK
-    worker_for: dict[NIndex, str]
+    worker_for: dict[NDIndex, str]
     old: ChunkedAxes
     new: ChunkedAxes
 
     def to_msg(self) -> dict[str, Any]:
         return {
             "status": "OK",
             "type": ArrayRechunkState.type,
@@ -290,34 +290,37 @@
         self.scheduler.set_restrictions({ts.key: original_restrictions})
 
     def remove_worker(self, scheduler: Scheduler, worker: str) -> None:
         from time import time
 
         stimulus_id = f"shuffle-failed-worker-left-{time()}"
 
+        recs: Recs = {}
         for shuffle_id, shuffle in self.states.items():
             if worker not in shuffle.participating_workers:
                 continue
             exception = RuntimeError(
                 f"Worker {worker} left during active shuffle {shuffle_id}"
             )
             self.erred_shuffles[shuffle_id] = exception
             self._fail_on_workers(shuffle, str(exception))
 
             barrier_task = self.scheduler.tasks[barrier_key(shuffle_id)]
-            recs: Recs = {}
             if barrier_task.state == "memory":
                 for dt in barrier_task.dependents:
                     if worker not in dt.worker_restrictions:
                         continue
                     self._unset_restriction(dt)
                     recs.update({dt.key: "waiting"})
                 # TODO: Do we need to handle other states?
 
-            self.scheduler.transitions(recs, stimulus_id=stimulus_id)
+        # If processing the transactions causes a task to get released, this
+        # removes the shuffle from self.states. Therefore, we must process them
+        # outside of the loop.
+        self.scheduler.transitions(recs, stimulus_id=stimulus_id)
 
     def transition(
         self,
         key: str,
         start: TaskStateState,
         finish: TaskStateState,
         *args: Any,
@@ -370,12 +373,12 @@
 ) -> str:
     """Get address of target worker for this output partition using range sharding"""
     i = len(workers) * output_partition // npartitions
     return workers[i]
 
 
 def get_worker_for_hash_sharding(
-    output_partition: NIndex, workers: Sequence[str]
+    output_partition: NDIndex, workers: Sequence[str]
 ) -> str:
     """Get address of target worker for this output partition using hash sharding"""
     i = hash(output_partition) % len(workers)
     return workers[i]
```

### Comparing `distributed-2023.6.0/distributed/shuffle/_shuffle.py` & `distributed-2023.6.1/distributed/shuffle/_shuffle.py`

 * *Files 0% similar despite different names*

```diff
@@ -60,15 +60,15 @@
     parts_out: set[int],
 ) -> int:
     try:
         return _get_worker_extension().add_partition(
             input,
             shuffle_id=id,
             type=ShuffleType.DATAFRAME,
-            input_partition=input_partition,
+            partition_id=input_partition,
             npartitions=npartitions,
             column=column,
             parts_out=parts_out,
         )
     except Exception as e:
         raise RuntimeError(f"shuffle_transfer failed during shuffle {id}") from e
```

### Comparing `distributed-2023.6.0/distributed/shuffle/_worker_extension.py` & `distributed-2023.6.1/distributed/shuffle/_worker_extension.py`

 * *Files 2% similar despite different names*

```diff
@@ -25,17 +25,17 @@
     convert_partition,
     list_of_buffers_to_table,
     serialize_table,
 )
 from distributed.shuffle._comms import CommShardsBuffer
 from distributed.shuffle._disk import DiskShardsBuffer
 from distributed.shuffle._limiter import ResourceLimiter
-from distributed.shuffle._rechunk import ChunkedAxes, NIndex
+from distributed.shuffle._rechunk import ChunkedAxes, NDIndex
 from distributed.shuffle._rechunk import ShardID as ArrayRechunkShardID
-from distributed.shuffle._rechunk import rechunk_slicing
+from distributed.shuffle._rechunk import split_axes
 from distributed.shuffle._shuffle import ShuffleId, ShuffleType
 from distributed.sizeof import sizeof
 from distributed.utils import log_errors, sync
 
 if TYPE_CHECKING:
     # TODO import from typing (requires Python >=3.10)
     import numpy as np
@@ -148,15 +148,15 @@
 
     async def _write_to_comm(
         self, data: dict[str, list[tuple[T_transfer_shard_id, bytes]]]
     ) -> None:
         self.raise_if_closed()
         await self._comm_buffer.write(data)
 
-    async def _write_to_disk(self, data: dict[NIndex, list[bytes]]) -> None:
+    async def _write_to_disk(self, data: dict[NDIndex, list[bytes]]) -> None:
         self.raise_if_closed()
         await self._disk_buffer.write(
             {"_".join(str(i) for i in k): v for k, v in data.items()}
         )
 
     def raise_if_closed(self) -> None:
         if self.closed:
@@ -194,15 +194,15 @@
         await self._disk_buffer.close()
         self._closed_event.set()
 
     def fail(self, exception: Exception) -> None:
         if not self.closed:
             self._exception = exception
 
-    def _read_from_disk(self, id: NIndex) -> bytes:
+    def _read_from_disk(self, id: NDIndex) -> bytes:
         self.raise_if_closed()
         data: bytes = self._disk_buffer.read("_".join(str(i) for i in id))
         return data
 
     async def receive(self, data: list[tuple[T_transfer_shard_id, bytes]]) -> None:
         await self._receive(data)
 
@@ -224,26 +224,26 @@
 
     @abc.abstractmethod
     async def _receive(self, data: list[tuple[T_transfer_shard_id, bytes]]) -> None:
         """Receive shards belonging to output partitions of this shuffle run"""
 
     @abc.abstractmethod
     async def add_partition(
-        self, data: T_partition_type, input_partition: T_partition_id
+        self, data: T_partition_type, partition_id: T_partition_id
     ) -> int:
         """Add an input partition to the shuffle run"""
 
     @abc.abstractmethod
     async def get_output_partition(
-        self, i: T_partition_id, key: str, meta: pd.DataFrame | None = None
+        self, partition_id: T_partition_id, key: str, meta: pd.DataFrame | None = None
     ) -> T_partition_type:
         """Get an output partition to the shuffle run"""
 
 
-class ArrayRechunkRun(ShuffleRun[ArrayRechunkShardID, NIndex, "np.ndarray"]):
+class ArrayRechunkRun(ShuffleRun[ArrayRechunkShardID, NDIndex, "np.ndarray"]):
     """State for a single active rechunk execution
 
     This object is responsible for splitting, sending, receiving and combining
     data shards.
 
     It is entirely agnostic to the distributed system and can perform a shuffle
     with other `Shuffle` instances using `rpc` and `broadcast`.
@@ -282,59 +282,48 @@
     memory_limiter_comm:
         A ``ResourceLimiter`` limiting the total amount of memory used in either
         buffer.
     """
 
     def __init__(
         self,
-        worker_for: dict[NIndex, str],
+        worker_for: dict[NDIndex, str],
         output_workers: set,
         old: ChunkedAxes,
         new: ChunkedAxes,
         id: ShuffleId,
         run_id: int,
         local_address: str,
         directory: str,
         executor: ThreadPoolExecutor,
         rpc: Callable[[str], PooledRPCCall],
         scheduler: PooledRPCCall,
         memory_limiter_disk: ResourceLimiter,
         memory_limiter_comms: ResourceLimiter,
     ):
-        from dask.array.rechunk import old_to_new
-
         super().__init__(
             id=id,
             run_id=run_id,
             output_workers=output_workers,
             local_address=local_address,
             directory=directory,
             executor=executor,
             rpc=rpc,
             scheduler=scheduler,
             memory_limiter_comms=memory_limiter_comms,
             memory_limiter_disk=memory_limiter_disk,
         )
-        from dask.array.core import normalize_chunks
-
-        # We rely on a canonical `np.nan` in `dask.array.rechunk.old_to_new`
-        # that passes an implicit identity check when testing for list equality.
-        # This does not work with (de)serialization, so we have to normalize the chunks
-        # here again to canonicalize `nan`s.
-        old = normalize_chunks(old)
-        new = normalize_chunks(new)
         self.old = old
         self.new = new
         partitions_of = defaultdict(list)
         for part, addr in worker_for.items():
             partitions_of[addr].append(part)
         self.partitions_of = dict(partitions_of)
         self.worker_for = worker_for
-        self._slicing = rechunk_slicing(old, new)
-        self._old_to_new = old_to_new(old, new)
+        self.split_axes = split_axes(old, new)
 
     async def _receive(self, data: list[tuple[ArrayRechunkShardID, bytes]]) -> None:
         self.raise_if_closed()
 
         buffers = defaultdict(list)
         for d in data:
             id, payload = d
@@ -350,15 +339,15 @@
             return
         try:
             await self._write_to_disk(buffers)
         except Exception as e:
             self._exception = e
             raise
 
-    async def add_partition(self, data: np.ndarray, input_partition: NIndex) -> int:
+    async def add_partition(self, data: np.ndarray, partition_id: NDIndex) -> int:
         self.raise_if_closed()
         if self.transferred:
             raise RuntimeError(f"Cannot add more partitions to shuffle {self}")
 
         def _() -> dict[str, list[tuple[ArrayRechunkShardID, bytes]]]:
             """Return a mapping of worker addresses to a list of tuples of shard IDs
             and shard data.
@@ -366,45 +355,52 @@
             As shard data, we serialize the payload together with the sub-index of the
             slice within the new chunk. To assemble the new chunk from its shards, it
             needs the sub-index to know where each shard belongs within the chunk.
             Adding the sub-index into the serialized payload on the sender allows us to
             write the serialized payload directly to disk on the receiver.
             """
             out: dict[str, list[tuple[ArrayRechunkShardID, bytes]]] = defaultdict(list)
-            for id, nslice in self._slicing[input_partition]:
-                out[self.worker_for[id.chunk_index]].append(
-                    (id, pickle.dumps((id.shard_index, data[nslice])))
+            from itertools import product
+
+            ndsplits = product(
+                *(axis[i] for axis, i in zip(self.split_axes, partition_id))
+            )
+
+            for ndsplit in ndsplits:
+                chunk_index, shard_index, ndslice = zip(*ndsplit)
+                id = ArrayRechunkShardID(chunk_index, shard_index)
+                out[self.worker_for[chunk_index]].append(
+                    (id, pickle.dumps((shard_index, data[ndslice])))
                 )
             return out
 
         out = await self.offload(_)
         await self._write_to_comm(out)
         return self.run_id
 
     async def get_output_partition(
-        self, i: NIndex, key: str, meta: pd.DataFrame | None = None
+        self, partition_id: NDIndex, key: str, meta: pd.DataFrame | None = None
     ) -> np.ndarray:
         self.raise_if_closed()
         assert meta is None
         assert self.transferred, "`get_output_partition` called before barrier task"
 
-        await self._ensure_output_worker(i, key)
+        await self._ensure_output_worker(partition_id, key)
 
         await self.flush_receive()
 
-        data = self._read_from_disk(i)
+        data = self._read_from_disk(partition_id)
 
         def _() -> np.ndarray:
-            subdims = tuple(len(self._old_to_new[dim][ix]) for dim, ix in enumerate(i))
-            return convert_chunk(data, subdims)
+            return convert_chunk(data)
 
         return await self.offload(_)
 
-    def _get_assigned_worker(self, i: NIndex) -> str:
-        return self.worker_for[i]
+    def _get_assigned_worker(self, id: NDIndex) -> str:
+        return self.worker_for[id]
 
 
 class DataFrameShuffleRun(ShuffleRun[int, int, "pd.DataFrame"]):
     """State for a single active shuffle execution
 
     This object is responsible for splitting, sending, receiving and combining
     data shards.
@@ -501,62 +497,62 @@
             groups = await self.offload(self._repartition_buffers, filtered)
             del filtered
             await self._write_to_disk(groups)
         except Exception as e:
             self._exception = e
             raise
 
-    def _repartition_buffers(self, data: list[bytes]) -> dict[NIndex, list[bytes]]:
+    def _repartition_buffers(self, data: list[bytes]) -> dict[NDIndex, list[bytes]]:
         table = list_of_buffers_to_table(data)
         groups = split_by_partition(table, self.column)
         assert len(table) == sum(map(len, groups.values()))
         del data
         return {(k,): [serialize_table(v)] for k, v in groups.items()}
 
-    async def add_partition(self, data: pd.DataFrame, input_partition: int) -> int:
+    async def add_partition(self, data: pd.DataFrame, partition_id: int) -> int:
         self.raise_if_closed()
         if self.transferred:
             raise RuntimeError(f"Cannot add more partitions to shuffle {self}")
 
         def _() -> dict[str, list[tuple[int, bytes]]]:
             out = split_by_worker(
                 data,
                 self.column,
                 self.worker_for,
             )
-            out = {k: [(input_partition, serialize_table(t))] for k, t in out.items()}
+            out = {k: [(partition_id, serialize_table(t))] for k, t in out.items()}
             return out
 
         out = await self.offload(_)
         await self._write_to_comm(out)
         return self.run_id
 
     async def get_output_partition(
-        self, i: int, key: str, meta: pd.DataFrame | None = None
+        self, partition_id: int, key: str, meta: pd.DataFrame | None = None
     ) -> pd.DataFrame:
         self.raise_if_closed()
         assert meta is not None
         assert self.transferred, "`get_output_partition` called before barrier task"
 
-        await self._ensure_output_worker(i, key)
+        await self._ensure_output_worker(partition_id, key)
 
         await self.flush_receive()
         try:
-            data = self._read_from_disk((i,))
+            data = self._read_from_disk((partition_id,))
 
             def _() -> pd.DataFrame:
                 return convert_partition(data, meta)  # type: ignore
 
             out = await self.offload(_)
         except KeyError:
             out = meta.copy()
         return out
 
-    def _get_assigned_worker(self, i: int) -> str:
-        return self.worker_for[i]
+    def _get_assigned_worker(self, id: int) -> str:
+        return self.worker_for[id]
 
 
 class ShuffleWorkerExtension:
     """Interface between a Worker and a Shuffle.
 
     This extension is responsible for
 
@@ -640,25 +636,25 @@
             extension._runs.remove(shuffle)
 
         self.worker._ongoing_background_tasks.call_soon(_, self, shuffle)
 
     def add_partition(
         self,
         data: Any,
-        input_partition: int | tuple[int, ...],
+        partition_id: int | tuple[int, ...],
         shuffle_id: ShuffleId,
         type: ShuffleType,
         **kwargs: Any,
     ) -> int:
         shuffle = self.get_or_create_shuffle(shuffle_id, type=type, **kwargs)
         return sync(
             self.worker.loop,
             shuffle.add_partition,
             data=data,
-            input_partition=input_partition,
+            partition_id=partition_id,
         )
 
     async def _barrier(self, shuffle_id: ShuffleId, run_ids: list[int]) -> int:
         """
         Task: Note that the barrier task has been reached (`add_partition` called for all input partitions)
 
         Using an unknown ``shuffle_id`` is an error. Calling this before all partitions have been
@@ -903,29 +899,29 @@
             **kwargs,
         )
 
     def get_output_partition(
         self,
         shuffle_id: ShuffleId,
         run_id: int,
-        output_partition: int | NIndex,
+        partition_id: int | NDIndex,
         meta: pd.DataFrame | None = None,
     ) -> Any:
         """
         Task: Retrieve a shuffled output partition from the ShuffleExtension.
 
         Calling this for a ``shuffle_id`` which is unknown or incomplete is an error.
         """
         shuffle = self.get_shuffle_run(shuffle_id, run_id)
         key = thread_state.key
         return sync(
             self.worker.loop,
             shuffle.get_output_partition,
-            output_partition,
-            key,
+            partition_id=partition_id,
+            key=key,
             meta=meta,
         )
 
 
 def split_by_worker(
     df: pd.DataFrame,
     column: str,
@@ -992,21 +988,29 @@
     ]
     shards.append(t.slice(offset=splits[-1], length=None))
     assert len(t) == sum(map(len, shards))
     assert len(partitions) == len(shards)
     return dict(zip(partitions, shards))
 
 
-def convert_chunk(data: bytes, subdims: tuple[int, ...]) -> np.ndarray:
+def convert_chunk(data: bytes) -> np.ndarray:
     import numpy as np
 
     from dask.array.core import concatenate3
 
     file = BytesIO(data)
-    rec_cat_arg = np.empty(subdims, dtype="O")
+    shards: dict[NDIndex, np.ndarray] = {}
+
     while file.tell() < len(data):
-        subindex, subarray = pickle.load(file)
-        rec_cat_arg[tuple(subindex)] = subarray
+        index, shard = pickle.load(file)
+        shards[index] = shard
+
+    subshape = [max(dim) + 1 for dim in zip(*shards.keys())]
+    assert len(shards) == np.prod(subshape)
+
+    rec_cat_arg = np.empty(subshape, dtype="O")
+    for index, shard in shards.items():
+        rec_cat_arg[tuple(index)] = shard
     del data
     del file
     arrs = rec_cat_arg.tolist()
     return concatenate3(arrs)
```

### Comparing `distributed-2023.6.0/distributed/sizeof.py` & `distributed-2023.6.1/distributed/sizeof.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/spans.py` & `distributed-2023.6.1/distributed/spans.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,22 +1,26 @@
 from __future__ import annotations
 
 import uuid
 import weakref
 from collections import defaultdict
-from collections.abc import Iterable, Iterator
+from collections.abc import Hashable, Iterable, Iterator
 from contextlib import contextmanager
+from itertools import islice
 from typing import TYPE_CHECKING, Any
 
 import dask.config
 
+from distributed.collections import sum_mappings
+from distributed.itertools import ffill
 from distributed.metrics import time
 
 if TYPE_CHECKING:
     from distributed import Scheduler, Worker
+    from distributed.client import SourceCode
     from distributed.scheduler import TaskGroup, TaskState, TaskStateState, WorkerState
 
 
 @contextmanager
 def span(*tags: str) -> Iterator[str]:
     """Tag group of tasks to be part of a certain group, called a span.
 
@@ -69,19 +73,20 @@
     -----
     Spans are based on annotations, and just like annotations they can be lost during
     optimization. Set config ``optimization.fuse.active: false`` to prevent this issue.
     """
     if not tags:
         raise ValueError("Must specify at least one span tag")
 
-    prev_tags = dask.config.get("annotations.span.name", ())
+    annotation = dask.get_annotations().get("span")
+    prev_tags = annotation["name"] if annotation else ()
     # You must specify the full history of IDs, not just the parent, because
     # otherwise you would not be able to uniquely identify grandparents when
     # they have no tasks of their own.
-    prev_ids = dask.config.get("annotations.span.ids", ())
+    prev_ids = annotation["ids"] if annotation else ()
     ids = tuple(str(uuid.uuid4()) for _ in tags)
     with dask.annotate(span={"name": prev_tags + tags, "ids": prev_ids + ids}):
         yield ids[-1]
 
 
 class Span:
     #: (<tag>, <tag>, ...)
@@ -120,29 +125,48 @@
     #:
     #: See also
     #: --------
     #: start
     #: stop
     enqueued: float
 
-    _cumulative_worker_metrics: defaultdict[tuple[str, ...], float]
+    #: Source code snippets, if it was sent by the client.
+    #: We're using a dict without values as an insertion-sorted set.
+    _code: dict[tuple[SourceCode, ...], None]
+
+    _cumulative_worker_metrics: defaultdict[tuple[Hashable, ...], float]
+
+    #: reference to SchedulerState.total_nthreads_history
+    _total_nthreads_history: list[tuple[float, int]]
+    #: Length of total_nthreads_history when this span was enqueued
+    _total_nthreads_offset: int
 
     # Support for weakrefs to a class with __slots__
     __weakref__: Any
 
     __slots__ = tuple(__annotations__)
 
-    def __init__(self, name: tuple[str, ...], id_: str, parent: Span | None):
+    def __init__(
+        self,
+        name: tuple[str, ...],
+        id_: str,
+        parent: Span | None,
+        total_nthreads_history: list[tuple[float, int]],
+    ):
         self.name = name
         self.id = id_
         self._parent = weakref.ref(parent) if parent is not None else None
         self.enqueued = time()
         self.children = []
         self.groups = set()
+        self._code = {}
         self._cumulative_worker_metrics = defaultdict(float)
+        assert len(total_nthreads_history) > 0
+        self._total_nthreads_history = total_nthreads_history
+        self._total_nthreads_offset = len(total_nthreads_history) - 1
 
     def __repr__(self) -> str:
         return f"Span<name={self.name}, id={self.id}>"
 
     @property
     def parent(self) -> Span | None:
         if self._parent:
@@ -176,46 +200,56 @@
 
         See also
         --------
         enqueued
         stop
         distributed.scheduler.TaskGroup.start
         """
-        return min(
+        out = min(
             (tg.start for tg in self.traverse_groups() if tg.start != 0.0),
             default=0.0,
         )
+        if out:
+            # absorb small errors in worker delay calculation
+            out = max(out, self.enqueued)
+        return out
 
     @property
     def stop(self) -> float:
-        """Latest time when a task belonging to this span tree finished computing;
-        0 if no task has finished computing yet.
+        """When this span tree finished computing, or current timestamp if it didn't
+        finish yet.
+
+        Notes
+        -----
+        This differs from ``TaskGroup.stop`` when there aren't unfinished tasks; is also
+        will never be zero.
 
         See also
         --------
         enqueued
         start
+        done
         distributed.scheduler.TaskGroup.stop
         """
-        return max(tg.stop for tg in self.traverse_groups())
+        if not self.done:
+            return time()
+        out = max(tg.stop for tg in self.traverse_groups())
+        # absorb small errors in worker delay calculation
+        return max(self.enqueued, out)
 
     @property
-    def states(self) -> defaultdict[TaskStateState, int]:
+    def states(self) -> dict[TaskStateState, int]:
         """The number of tasks currently in each state in this span tree;
         e.g. ``{"memory": 10, "processing": 3, "released": 4, ...}``.
 
         See also
         --------
         distributed.scheduler.TaskGroup.states
         """
-        out: defaultdict[TaskStateState, int] = defaultdict(int)
-        for tg in self.traverse_groups():
-            for state, count in tg.states.items():
-                out[state] += count
-        return out
+        return sum_mappings(tg.states for tg in self.traverse_groups())
 
     @property
     def done(self) -> bool:
         """Return True if all tasks in this span tree are completed; False otherwise.
 
         Notes
         -----
@@ -226,27 +260,23 @@
         See also
         --------
         distributed.scheduler.TaskGroup.done
         """
         return all(tg.done for tg in self.traverse_groups())
 
     @property
-    def all_durations(self) -> defaultdict[str, float]:
+    def all_durations(self) -> dict[str, float]:
         """Cumulative duration of all completed actions in this span tree, by action
 
         See also
         --------
         duration
         distributed.scheduler.TaskGroup.all_durations
         """
-        out: defaultdict[str, float] = defaultdict(float)
-        for tg in self.traverse_groups():
-            for action, nsec in tg.all_durations.items():
-                out[action] += nsec
-        return out
+        return sum_mappings(tg.all_durations for tg in self.traverse_groups())
 
     @property
     def duration(self) -> float:
         """The total amount of time spent on all tasks in this span tree
 
         See also
         --------
@@ -262,83 +292,224 @@
         See also
         --------
         distributed.scheduler.TaskGroup.nbytes_total
         """
         return sum(tg.nbytes_total for tg in self.traverse_groups())
 
     @property
-    def cumulative_worker_metrics(self) -> defaultdict[tuple[str, ...], float]:
+    def code(self) -> list[tuple[SourceCode, ...]]:
+        """Code snippets, sent by the client on compute(), persist(), and submit().
+
+        Only populated if ``distributed.diagnostics.computations.nframes`` is non-zero.
+        """
+        # Deduplicate, but preserve order
+        return list(
+            dict.fromkeys(sc for child in self.traverse_spans() for sc in child._code)
+        )
+
+    @property
+    def cumulative_worker_metrics(self) -> dict[tuple[Hashable, ...], float]:
         """Replica of Worker.digests_total and Scheduler.cumulative_worker_metrics, but
         only for the metrics that can be attributed to the current span tree.
         The span_id has been removed from the key.
 
         At the moment of writing, all keys are
         ``("execute", <task prefix>, <activity>, <unit>)``
         but more may be added in the future with a different format; please test for
         ``k[0] == "execute"``.
         """
-        out: defaultdict[tuple[str, ...], float] = defaultdict(float)
-        for child in self.traverse_spans():
-            for k, v in child._cumulative_worker_metrics.items():
-                out[k] += v
+        out = sum_mappings(
+            child._cumulative_worker_metrics for child in self.traverse_spans()
+        )
+        known_seconds = sum(
+            v for k, v in out.items() if k[0] == "execute" and k[-1] == "seconds"
+        )
+        # Besides rounding errors, you may get negative unknown seconds if a user
+        # manually invokes `context_meter.digest_metric`.
+        unknown_seconds = max(0.0, self.active_cpu_seconds - known_seconds)
+
+        out["execute", "N/A", "idle or other spans", "seconds"] = unknown_seconds
+        return out
+
+    @staticmethod
+    def merge(*items: Span) -> Span:
+        """Merge multiple spans into a synthetic one.
+        The input spans must not be related with each other.
+        """
+        if not items:
+            raise ValueError("Nothing to merge")
+        out = Span(
+            name=("(merged)",),
+            id_="(merged)",
+            parent=None,
+            total_nthreads_history=items[0]._total_nthreads_history,
+        )
+        out._total_nthreads_offset = min(
+            child._total_nthreads_offset for child in items
+        )
+        out.children.extend(items)
+        out.enqueued = min(child.enqueued for child in items)
         return out
 
+    def _nthreads_timeseries(self) -> Iterator[tuple[float, int]]:
+        """Yield (timestamp, number of threads across the cluster), forward-fill"""
+        stop = self.stop if self.done else 0
+        for t, n in islice(
+            self._total_nthreads_history, self._total_nthreads_offset, None
+        ):
+            if stop and t >= stop:
+                break
+            yield max(self.enqueued, t), n
+
+    def _active_timeseries(self) -> Iterator[tuple[float, bool]]:
+        """If this span is the output of :meth:`merge`, yield
+        (timestamp, True if at least one input span is active), forward-fill.
+        """
+        now = time()
+        if self.id != "(merged)":
+            yield self.enqueued, True
+            yield self.stop if self.done else now, False
+            return
+
+        events = []
+        for child in self.children:
+            events.append((child.enqueued, 1))
+            events.append((child.stop if child.done else now, -1))
+        events.sort()
+
+        n_active = 0
+        for t, delta in events:
+            if not n_active:
+                assert delta > 0
+                yield t, True
+            n_active += delta
+            if n_active == 0:
+                yield t, False
+
+    @property
+    def nthreads_intervals(self) -> list[tuple[float, float, int]]:
+        """
+        Returns
+        ------
+        List of tuples:
+
+        - begin timestamp
+        - end timestamp
+        - Scheduler.total_nthreads during this interval
+
+        When the Span is the output of :meth:`merge`, the intervals may not be
+        contiguous.
+
+        See Also
+        --------
+        enqueued
+        stop
+        active_cpu_seconds
+        distributed.scheduler.SchedulerState.total_nthreads
+        """
+        nthreads_t, nthreads_count = zip(*self._nthreads_timeseries())
+        is_active_t, is_active_flag = zip(*self._active_timeseries())
+        t_interp = sorted({*nthreads_t, *is_active_t})
+        nthreads_count_interp = ffill(t_interp, nthreads_t, nthreads_count, left=0)
+        is_active_flag_interp = ffill(t_interp, is_active_t, is_active_flag, left=False)
+        return [
+            (t0, t1, n)
+            for t0, t1, n, active in zip(
+                t_interp, t_interp[1:], nthreads_count_interp, is_active_flag_interp
+            )
+            if active
+        ]
+
+    @property
+    def active_cpu_seconds(self) -> float:
+        """Return number of CPU seconds that were made available on the cluster while
+        this Span was running; in other words
+        ``(Span.stop - Span.enqueued) * Scheduler.total_nthreads``.
+
+        This accounts for workers joining and leaving the cluster while this Span was
+        active. If this Span is the output of :meth:`merge`, do not count gaps between
+        input spans.
+
+        See Also
+        --------
+        enqueued
+        stop
+        nthreads_intervals
+        distributed.scheduler.SchedulerState.total_nthreads
+        """
+        return sum((t1 - t0) * nthreads for t0, t1, nthreads in self.nthreads_intervals)
+
 
 class SpansSchedulerExtension:
     """Scheduler extension for spans support"""
 
+    scheduler: Scheduler
+
     #: All Span objects by id
     spans: dict[str, Span]
 
     #: Only the spans that don't have any parents, sorted by creation time.
     #: This is a convenience helper structure to speed up searches.
     root_spans: list[Span]
 
     #: All spans, keyed by their full name and sorted by creation time.
     #: This is a convenience helper structure to speed up searches.
     spans_search_by_name: defaultdict[tuple[str, ...], list[Span]]
 
     #: All spans, keyed by the individual tags that make up their name and sorted by
     #: creation time.
     #: This is a convenience helper structure to speed up searches.
+    #:
+    #: See Also
+    #: --------
+    #: find_by_tags
+    #: merge_by_tags
     spans_search_by_tag: defaultdict[str, list[Span]]
 
     def __init__(self, scheduler: Scheduler):
+        self.scheduler = scheduler
         self.spans = {}
         self.root_spans = []
         self.spans_search_by_name = defaultdict(list)
         self.spans_search_by_tag = defaultdict(list)
 
-    def observe_tasks(self, tss: Iterable[TaskState]) -> None:
+    def observe_tasks(
+        self, tss: Iterable[TaskState], code: tuple[SourceCode, ...]
+    ) -> None:
         """Acknowledge the existence of runnable tasks on the scheduler. These may
         either be new tasks, tasks that were previously unrunnable, or tasks that were
         already fed into this method already.
 
         Attach newly observed tasks to either the desired span or to ("default", ).
         Update TaskGroup.span_id and wipe TaskState.annotations["span"].
         """
         default_span = None
 
         for ts in tss:
             # You may have different tasks belonging to the same TaskGroup but to
             # different spans. If that happens, arbitrarily force everything onto the
             # span of the earliest encountered TaskGroup.
             tg = ts.group
-            if not tg.span_id:
+            if tg.span_id:
+                span = self.spans[tg.span_id]
+            else:
                 ann = ts.annotations.get("span")
                 if ann:
                     span = self._ensure_span(ann["name"], ann["ids"])
                 else:
                     if not default_span:
                         default_span = self._ensure_default_span()
                     span = default_span
 
                 tg.span_id = span.id
                 span.groups.add(tg)
 
+            if code:
+                span._code[code] = None
+
             # The span may be completely different from the one referenced by the
             # annotation, due to the TaskGroup collision issue explained above.
             # Remove the annotation to avoid confusion, and instead rely on
             # distributed.scheduler.TaskState.group.span_id and
             # distributed.worker_state_machine.TaskState.span_id.
             ts.annotations.pop("span", None)
 
@@ -363,64 +534,110 @@
         assert len(name) == len(ids)
         assert len(name) > 0
 
         parent = None
         for i in range(1, len(name)):
             parent = self._ensure_span(name[:i], ids[:i])
 
-        span = Span(name=name, id_=ids[-1], parent=parent)
+        span = Span(
+            name=name,
+            id_=ids[-1],
+            parent=parent,
+            total_nthreads_history=self.scheduler.total_nthreads_history,
+        )
         self.spans[span.id] = span
         self.spans_search_by_name[name].append(span)
         for tag in name:
             self.spans_search_by_tag[tag].append(span)
         if parent:
             parent.children.append(span)
         else:
             self.root_spans.append(span)
 
         return span
 
+    def find_by_tags(self, *tags: str) -> Iterator[Span]:
+        """Yield all spans that contain any of the given tags.
+        When a tag is shared both by a span and its (grand)children, only return the
+        parent.
+        """
+        by_level = defaultdict(list)
+        for tag in tags:
+            for sp in self.spans_search_by_tag[tag]:
+                by_level[len(sp.name)].append(sp)
+
+        seen = set()
+        for _, level in sorted(by_level.items()):
+            seen.update(level)
+            for sp in level:
+                if sp.parent not in seen:
+                    yield sp
+
+    def merge_all(self) -> Span:
+        """Return a synthetic Span which is the sum of all spans"""
+        return Span.merge(*self.root_spans)
+
+    def merge_by_tags(self, *tags: str) -> Span:
+        """Return a synthetic Span which is the sum of all spans containing the given
+        tags
+        """
+        return Span.merge(*self.find_by_tags(*tags))
+
     def heartbeat(
-        self, ws: WorkerState, data: dict[str, dict[tuple[str, ...], float]]
+        self, ws: WorkerState, data: dict[tuple[Hashable, ...], float]
     ) -> None:
         """Triggered by SpansWorkerExtension.heartbeat().
 
         Populate :meth:`Span.cumulative_worker_metrics` with data from the worker.
 
         See also
         --------
         SpansWorkerExtension.heartbeat
         Span.cumulative_worker_metrics
         """
-        for span_id, metrics in data.items():
+        for (context, span_id, *other), v in data.items():
+            assert isinstance(span_id, str)
             span = self.spans[span_id]
-            for k, v in metrics.items():
-                span._cumulative_worker_metrics[k] += v
+            span._cumulative_worker_metrics[(context, *other)] += v
 
 
 class SpansWorkerExtension:
     """Worker extension for spans support"""
 
     worker: Worker
+    digests_total_since_heartbeat: dict[tuple[Hashable, ...], float]
 
     def __init__(self, worker: Worker):
         self.worker = worker
+        self.digests_total_since_heartbeat = {}
+
+    def collect_digests(self) -> None:
+        """Make a local copy of Worker.digests_total_since_heartbeat. We can't just
+        parse it directly in heartbeat() as the event loop may be yielded between its
+        call and `self.worker.digests_total_since_heartbeat.clear()`, causing the
+        scheduler to become misaligned with the workers.
+        """
+        # Note: this method may be called spuriously by Worker._register_with_scheduler,
+        # but when it does it's guaranteed not to find any metrics
+        assert not self.digests_total_since_heartbeat
+        self.digests_total_since_heartbeat = {
+            k: v
+            for k, v in self.worker.digests_total_since_heartbeat.items()
+            if isinstance(k, tuple) and k[0] == "execute"
+        }
 
-    def heartbeat(self) -> dict[str, dict[tuple[str, ...], float]]:
+    def heartbeat(self) -> dict[tuple[Hashable, ...], float]:
         """Apportion the metrics that do have a span to the Spans on the scheduler
 
         Returns
         -------
-        ``{span_id: {("execute", prefix, activity, unit): value}}``
+        ``{(context, span_id, prefix, activity, unit): value}}``
 
         See also
         --------
         SpansSchedulerExtension.heartbeat
         Span.cumulative_worker_metrics
+        distributed.worker.Worker.get_metrics
         """
-        out: defaultdict[str, dict[tuple[str, ...], float]] = defaultdict(dict)
-        for k, v in self.worker.digests_total_since_heartbeat.items():
-            if isinstance(k, tuple) and k[0] == "execute":
-                _, span_id, prefix, activity, unit = k
-                assert span_id is not None
-                out[span_id]["execute", prefix, activity, unit] = v
-        return dict(out)
+        out = self.digests_total_since_heartbeat
+        self.digests_total_since_heartbeat = {}
+        return out
```

### Comparing `distributed-2023.6.0/distributed/spill.py` & `distributed-2023.6.1/distributed/spill.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/stealing.py` & `distributed-2023.6.1/distributed/stealing.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/system.py` & `distributed-2023.6.1/distributed/system.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/system_monitor.py` & `distributed-2023.6.1/distributed/system_monitor.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/threadpoolexecutor.py` & `distributed-2023.6.1/distributed/threadpoolexecutor.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/utils.py` & `distributed-2023.6.1/distributed/utils.py`

 * *Files 8% similar despite different names*

```diff
@@ -330,15 +330,20 @@
     `tornado.IOLoop`, and may also add a `_asynchronous` attribute indicating
     whether the class should default to asynchronous behavior.
     """
 
     @property
     def asynchronous(self):
         """Are we running in the event loop?"""
-        return in_async_call(self.loop, default=getattr(self, "_asynchronous", False))
+        try:
+            return in_async_call(
+                self.loop, default=getattr(self, "_asynchronous", False)
+            )
+        except RuntimeError:
+            return False
 
     def sync(self, func, *args, asynchronous=None, callback_timeout=None, **kwargs):
         """Call `func` with `args` synchronously or asynchronously depending on
         the calling context"""
         callback_timeout = _parse_timedelta(callback_timeout)
         if asynchronous is None:
             asynchronous = self.asynchronous
@@ -416,14 +421,71 @@
     if error:
         typ, exc, tb = error
         raise exc.with_traceback(tb)
     else:
         return result
 
 
+if sys.version_info >= (3, 10):
+    from asyncio import Event as LateLoopEvent
+else:
+    # In python 3.10 asyncio.Lock and other primitives no longer support
+    # passing a loop kwarg to bind to a loop running in another thread
+    # e.g. calling from Client(asynchronous=False). Instead the loop is bound
+    # as late as possible: when calling any methods that wait on or wake
+    # Future instances. See: https://bugs.python.org/issue42392
+    class LateLoopEvent:
+        _event: asyncio.Event | None
+
+        def __init__(self) -> None:
+            self._event = None
+
+        def set(self) -> None:
+            if self._event is None:
+                self._event = asyncio.Event()
+
+            self._event.set()
+
+        def is_set(self) -> bool:
+            return self._event is not None and self._event.is_set()
+
+        async def wait(self) -> bool:
+            if self._event is None:
+                self._event = asyncio.Event()
+
+            return await self._event.wait()
+
+
+class _CollectErrorThread:
+    def __init__(self, target: Callable[[], None], daemon: bool, name: str):
+        self._exception: BaseException | None = None
+
+        def wrapper() -> None:
+            try:
+                target()
+            except BaseException as e:
+                self._exception = e
+
+        self._thread = thread = threading.Thread(
+            target=wrapper, daemon=daemon, name=name
+        )
+        thread.start()
+
+    def join(self, timeout: float | None = None) -> None:
+        thread = self._thread
+        thread.join(timeout=timeout)
+        if thread.is_alive():
+            raise TimeoutError("join timed out")
+        if self._exception is not None:
+            try:
+                raise self._exception
+            finally:  # remove a reference cycle
+                del self._exception
+
+
 class LoopRunner:
     """
     A helper to start and stop an IO loop in a controlled way.
     Several loop runners can associate safely to the same IO loop.
 
     Parameters
     ----------
@@ -438,111 +500,96 @@
     """
 
     # All loops currently associated to loop runners
     _all_loops: ClassVar[
         weakref.WeakKeyDictionary[IOLoop, tuple[int, LoopRunner | None]]
     ] = weakref.WeakKeyDictionary()
     _lock = threading.Lock()
+    _loop_thread: _CollectErrorThread | None
 
-    def __init__(self, loop=None, asynchronous=False):
+    def __init__(self, loop: IOLoop | None = None, asynchronous: bool = False):
         if loop is None:
             if asynchronous:
+                # raises RuntimeError if there's no running loop
                 try:
                     asyncio.get_running_loop()
-                except RuntimeError:
-                    warnings.warn(
-                        "Constructing a LoopRunner(asynchronous=True) without a running loop is deprecated",
-                        DeprecationWarning,
-                        stacklevel=2,
-                    )
-                self._loop = IOLoop.current()
-            else:
-                # We're expecting the loop to run in another thread,
-                # avoid re-using this thread's assigned loop
-                self._loop = IOLoop()
-        else:
-            if not loop.asyncio_loop.is_running():
-                warnings.warn(
-                    "Constructing LoopRunner(loop=loop) without a running loop is deprecated",
-                    DeprecationWarning,
-                    stacklevel=2,
-                )
-            self._loop = loop
+                except RuntimeError as e:
+                    raise RuntimeError(
+                        "Constructing LoopRunner(asynchronous=True) without a running loop is not supported"
+                    ) from e
+                loop = IOLoop.current()
+        elif not loop.asyncio_loop.is_running():  # type: ignore[attr-defined]
+            # LoopRunner is not responsible for starting a foreign IOLoop
+            raise RuntimeError(
+                "Constructing LoopRunner(loop=loop) without a running loop is not supported"
+            )
+
+        self._loop = loop
         self._asynchronous = asynchronous
         self._loop_thread = None
         self._started = False
-        with self._lock:
-            self._all_loops.setdefault(self._loop, (0, None))
+        self._stop_event = LateLoopEvent()
 
     def start(self):
         """
         Start the IO loop if required.  The loop is run in a dedicated
         thread.
 
         If the loop is already running, this method does nothing.
         """
         with self._lock:
             self._start_unlocked()
 
-    def _start_unlocked(self):
+    def _start_unlocked(self) -> None:
         assert not self._started
 
-        count, real_runner = self._all_loops[self._loop]
-        if self._asynchronous or real_runner is not None or count > 0:
+        if self._loop is not None:
+            try:
+                count, real_runner = self._all_loops[self._loop]
+            except KeyError:
+                assert self._loop.asyncio_loop.is_running()  # type: ignore[attr-defined]
+                self._started = True
+                return
+
             self._all_loops[self._loop] = count + 1, real_runner
             self._started = True
             return
 
         assert self._loop_thread is None
-        assert count == 0
-
-        loop_evt = threading.Event()
-        done_evt = threading.Event()
-        in_thread = [None]
-        start_exc = [None]
-
-        def loop_cb():
-            in_thread[0] = threading.current_thread()
-            loop_evt.set()
-
-        def run_loop(loop=self._loop):
-            loop.add_callback(loop_cb)
-            # run loop forever if it's not running already
-            try:
-                if not loop.asyncio_loop.is_running():
-                    loop.start()
-            except Exception as e:
-                start_exc[0] = e
-            finally:
-                done_evt.set()
 
-        thread = threading.Thread(target=run_loop, name="IO loop")
-        thread.daemon = True
-        thread.start()
+        start_evt = threading.Event()
+        start_exc = None
+        loop = None
+
+        async def amain() -> None:
+            nonlocal loop
+            loop = IOLoop.current()
+            start_evt.set()
+            await self._stop_event.wait()
 
-        loop_evt.wait(timeout=10)
+        def run_loop() -> None:
+            nonlocal start_exc
+            try:
+                asyncio.run(amain())
+            except BaseException as e:
+                if start_evt.is_set():
+                    raise
+                start_exc = e
+                start_evt.set()
+
+        self._loop_thread = _CollectErrorThread(
+            target=run_loop, daemon=True, name="IO loop"
+        )
+        start_evt.wait(timeout=10)
+        if start_exc is not None:
+            raise start_exc
+        assert loop is not None
+        self._loop = loop
         self._started = True
-
-        actual_thread = in_thread[0]
-        if actual_thread is not thread:
-            # Loop already running in other thread (user-launched)
-            done_evt.wait(5)
-            if start_exc[0] is not None and not isinstance(start_exc[0], RuntimeError):
-                if not isinstance(
-                    start_exc[0], Exception
-                ):  # track down infrequent error
-                    raise TypeError(
-                        f"not an exception: {start_exc[0]!r}",
-                    )
-                raise start_exc[0]
-            self._all_loops[self._loop] = count + 1, None
-        else:
-            assert start_exc[0] is None, start_exc
-            self._loop_thread = thread
-            self._all_loops[self._loop] = count + 1, self
+        self._all_loops[loop] = (1, self)
 
     def stop(self, timeout=10):
         """
         Stop and close the loop if it was created by us.
         Otherwise, just mark this object "stopped".
         """
         with self._lock:
@@ -550,33 +597,34 @@
 
     def _stop_unlocked(self, timeout):
         if not self._started:
             return
 
         self._started = False
 
-        count, real_runner = self._all_loops[self._loop]
+        try:
+            count, real_runner = self._all_loops[self._loop]
+        except KeyError:
+            return
+
         if count > 1:
             self._all_loops[self._loop] = count - 1, real_runner
-        else:
-            assert count == 1
-            del self._all_loops[self._loop]
-            if real_runner is not None:
-                real_runner._real_stop(timeout)
+            return
+
+        assert count == 1
+        del self._all_loops[self._loop]
+        real_runner._real_stop(timeout)
 
     def _real_stop(self, timeout):
         assert self._loop_thread is not None
-        if self._loop_thread is not None:
-            try:
-                self._loop.add_callback(self._loop.stop)
-                self._loop_thread.join(timeout=timeout)
-                with contextlib.suppress(KeyError):  # IOLoop can be missing
-                    self._loop.close()
-            finally:
-                self._loop_thread = None
+        try:
+            self._loop.add_callback(self._stop_event.set)
+            self._loop_thread.join(timeout=timeout)
+        finally:
+            self._loop_thread = None
 
     def is_started(self):
         """
         Return True between start() and stop() calls, False otherwise.
         """
         return self._started
 
@@ -593,19 +641,17 @@
                 return sync(self.loop, func, *args, **kwargs)
             finally:
                 self.stop()
 
     @property
     def loop(self):
         loop = self._loop
-        if not loop.asyncio_loop.is_running():
-            warnings.warn(
-                "Accessing the loop property while the loop is not running is deprecated",
-                DeprecationWarning,
-                stacklevel=2,
+        if loop is None or not loop.asyncio_loop.is_running():
+            raise RuntimeError(
+                "Accessing the loop property while the loop is not running is not supported"
             )
         return self._loop
 
 
 @contextlib.contextmanager
 def set_thread_state(**kwargs):
     old = {}
```

### Comparing `distributed-2023.6.0/distributed/utils_comm.py` & `distributed-2023.6.1/distributed/utils_comm.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/utils_perf.py` & `distributed-2023.6.1/distributed/utils_perf.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/utils_test.py` & `distributed-2023.6.1/distributed/utils_test.py`

 * *Files 1% similar despite different names*

```diff
@@ -2,15 +2,14 @@
 
 import asyncio
 import concurrent.futures
 import contextlib
 import copy
 import errno
 import functools
-import gc
 import inspect
 import io
 import logging
 import logging.config
 import multiprocessing
 import os
 import re
@@ -1061,30 +1060,26 @@
                     try:
                         c = default_client()
                     except ValueError:
                         pass
                     else:
                         await c._close(fast=True)
 
-                    def get_unclosed():
-                        return [c for c in Comm._instances if not c.closed()] + [
+                    try:
+                        unclosed = [c for c in Comm._instances if not c.closed()] + [
                             c for c in _global_clients.values() if c.status != "closed"
                         ]
-
-                    try:
-                        while deadline.remaining:
-                            gc.collect()
-                            if not get_unclosed():
-                                break
-                            await asyncio.sleep(0.05)
-                        else:
-                            if allow_unclosed:
-                                print(f"Unclosed Comms: {get_unclosed()}")
-                            else:
-                                raise RuntimeError("Unclosed Comms", get_unclosed())
+                        try:
+                            if unclosed:
+                                if allow_unclosed:
+                                    print(f"Unclosed Comms: {unclosed}")
+                                else:
+                                    raise RuntimeError("Unclosed Comms", unclosed)
+                        finally:
+                            del unclosed
                     finally:
                         Comm._instances.clear()
                         _global_clients.clear()
 
                         for w in workers:
                             if getattr(w, "data", None):
                                 try:
```

### Comparing `distributed-2023.6.0/distributed/variable.py` & `distributed-2023.6.1/distributed/variable.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/versions.py` & `distributed-2023.6.1/distributed/versions.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/widgets/templates/client.html.j2` & `distributed-2023.6.1/distributed/widgets/templates/client.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/widgets/templates/cluster.html.j2` & `distributed-2023.6.1/distributed/widgets/templates/cluster.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/widgets/templates/computation.html.j2` & `distributed-2023.6.1/distributed/widgets/templates/computation.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/widgets/templates/future.html.j2` & `distributed-2023.6.1/distributed/widgets/templates/future.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/widgets/templates/has_what.html.j2` & `distributed-2023.6.1/distributed/widgets/templates/has_what.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/widgets/templates/log.html.j2` & `distributed-2023.6.1/distributed/widgets/templates/log.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/widgets/templates/process_interface.html.j2` & `distributed-2023.6.1/distributed/widgets/templates/process_interface.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/widgets/templates/scheduler_info.html.j2` & `distributed-2023.6.1/distributed/widgets/templates/scheduler_info.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/worker.py` & `distributed-2023.6.1/distributed/worker.py`

 * *Files 1% similar despite different names*

```diff
@@ -1030,22 +1030,40 @@
     async def get_metrics(self) -> dict:
         try:
             spilled_memory, spilled_disk = self.data.spilled_total  # type: ignore
         except AttributeError:
             # spilling is disabled
             spilled_memory, spilled_disk = 0, 0
 
+        # Send Fine Performance Metrics
+        # Make sure we do not yield the event loop between the moment we parse
+        # self.digests_total_since_heartbeat to send it to the scheduler and the moment
+        # we clear it!
+        spans_ext: SpansWorkerExtension | None = self.extensions.get("spans")
+        if spans_ext:
+            # Send metrics with disaggregated span_id
+            spans_ext.collect_digests()
+
+        # Send metrics with squashed span_id
+        digests: defaultdict[Hashable, float] = defaultdict(float)
+        for k, v in self.digests_total_since_heartbeat.items():
+            if isinstance(k, tuple) and k[0] == "execute":
+                k = k[:1] + k[2:]
+            digests[k] += v
+
+        self.digests_total_since_heartbeat.clear()
+
         out = dict(
             task_counts=self.state.task_counter.current_count(by_prefix=False),
             bandwidth={
                 "total": self.bandwidth,
                 "workers": dict(self.bandwidth_workers),
                 "types": keymap(typename, self.bandwidth_types),
             },
-            digests_total_since_heartbeat=dict(self.digests_total_since_heartbeat),
+            digests_total_since_heartbeat=dict(digests),
             managed_bytes=self.state.nbytes,
             spilled_bytes={
                 "memory": spilled_memory,
                 "disk": spilled_disk,
             },
             transfer={
                 "incoming_bytes": self.state.transfer_incoming_bytes,
@@ -1202,14 +1220,15 @@
                 break
             except OSError:
                 logger.info("Waiting to connect to: %26s", self.scheduler.address)
                 await asyncio.sleep(0.1)
             except TimeoutError:  # pragma: no cover
                 logger.info("Timed out when connecting to scheduler")
         if response["status"] != "OK":
+            await comm.close()
             msg = response["message"] if "message" in response else repr(response)
             logger.error(f"Unable to connect to scheduler: {msg}")
             raise ValueError(f"Unexpected response from register: {response!r}")
 
         self.batched_stream.start(comm)
         self.status = Status.running
 
@@ -1247,15 +1266,14 @@
                 },
                 extensions={
                     name: extension.heartbeat()
                     for name, extension in self.extensions.items()
                     if hasattr(extension, "heartbeat")
                 },
             )
-            self.digests_total_since_heartbeat.clear()
 
             end = time()
             middle = (start + end) / 2
 
             self._update_latency(end - start)
 
             if response["status"] == "missing":
```

### Comparing `distributed-2023.6.0/distributed/worker_client.py` & `distributed-2023.6.1/distributed/worker_client.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/worker_memory.py` & `distributed-2023.6.1/distributed/worker_memory.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/distributed/worker_state_machine.py` & `distributed-2023.6.1/distributed/worker_state_machine.py`

 * *Files 0% similar despite different names*

```diff
@@ -2791,16 +2791,19 @@
             # If the task is still in executing or long-running, the scheduler
             # should never have asked the worker to drop this key.
             # We cannot simply forget it because there is a time window between
             # setting the state to executing/long-running and
             # preparing/collecting the data for the task.
             # If a dependency was released during this time, this would pop up
             # as a KeyError during execute which is hard to understand
-            if any(dep.state in ("executing", "long-running") for dep in ts.dependents):
-                raise RuntimeError("Encountered invalid state")  # pragma: no cover
+            for dep in ts.dependents:
+                if dep.state in ("executing", "long-running"):
+                    raise RuntimeError(
+                        f"Cannot remove replica of {ts.key!r} while {dep.key!r} in state {dep.state!r}."
+                    )  # pragma: no cover
             self.log.append((ts.key, "remove-replica", ev.stimulus_id, time()))
             recommendations[ts] = "released"
 
         return recommendations, instructions
 
     @_handle_event.register
     def _handle_acquire_replicas(self, ev: AcquireReplicasEvent) -> RecsInstrs:
```

### Comparing `distributed-2023.6.0/distributed.egg-info/PKG-INFO` & `distributed-2023.6.1/distributed.egg-info/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: distributed
-Version: 2023.6.0
+Version: 2023.6.1
 Summary: Distributed scheduler for Dask
 Maintainer-email: Matthew Rocklin <mrocklin@gmail.com>
 License: BSD
 Project-URL: Homepage, https://distributed.dask.org
 Project-URL: Source, https://github.com/dask/distributed
 Classifier: Development Status :: 5 - Production/Stable
 Classifier: Intended Audience :: Developers
```

### Comparing `distributed-2023.6.0/distributed.egg-info/SOURCES.txt` & `distributed-2023.6.1/distributed.egg-info/SOURCES.txt`

 * *Files 0% similar despite different names*

```diff
@@ -23,14 +23,15 @@
 distributed/core.py
 distributed/counter.py
 distributed/diskutils.py
 distributed/distributed-schema.yaml
 distributed/distributed.yaml
 distributed/event.py
 distributed/exceptions.py
+distributed/itertools.py
 distributed/lock.py
 distributed/metrics.py
 distributed/multi_lock.py
 distributed/nanny.py
 distributed/node.py
 distributed/objects.py
 distributed/preloading.py
```

### Comparing `distributed-2023.6.0/docs/source/active_memory_manager.rst` & `distributed-2023.6.1/docs/source/active_memory_manager.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/actors.rst` & `distributed-2023.6.1/docs/source/actors.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/api.rst` & `distributed-2023.6.1/docs/source/api.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/asynchronous.rst` & `distributed-2023.6.1/docs/source/asynchronous.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/changelog.rst` & `distributed-2023.6.1/docs/source/changelog.rst`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,57 @@
 Changelog
 =========
 
+.. _v2023.6.1:
+
+2023.6.1
+--------
+
+Released on June 26, 2023
+
+Enhancements
+^^^^^^^^^^^^
+- Add idle time to fine performance metrics (:pr:`7938`) `crusaderky`_
+- Spans: capture code snippets (:pr:`7930`) `crusaderky`_
+- Improve memory footprint of P2P rechunking (:pr:`7897`) `Hendrik Makait`_
+- Improve error message on invalid state in ``_handle_remove_replicas`` (:pr:`7920`) `Hendrik Makait`_
+- Make ``ShuffleSchedulerExtension.remove_worker`` more robust (:pr:`7921`) `Hendrik Makait`_
+- Provide more information if occupancy drops below zero (:pr:`7924`) `Hendrik Makait`_
+- Improved conversion between ``pyarrow`` and ``pandas`` in P2P shuffling (:pr:`7896`) `Hendrik Makait`_
+
+Bug Fixes
+^^^^^^^^^
+- Add ``Cluster.called_from_running_loop`` and fix ``Cluster.asynchronous`` (:pr:`7941`) `Jacob Tomlinson`_
+- Fix annotations and spans leaking between threads (:pr:`7935`) `Irina Truong`_
+- Handle null partitions in P2P shuffling (:pr:`7922`) `Jonathan De Troye`_
+- Fix race condition in Fine Performance Metrics sync (:pr:`7927`) `crusaderky`_
+- Avoid (:pr:`7923`) by starting ``run_id`` at 1 (:pr:`7925`) `Hendrik Makait`_
+- Fix glitches in Fine Performance Metrics stacked graph (:pr:`7919`) `crusaderky`_
+
+Maintenance
+^^^^^^^^^^^
+- Wipe the cache after (:pr:`7935`) (:pr:`7946`) `crusaderky`_
+- Remove grace period for unclosed comms in ``gen_cluster`` (:pr:`7937`) `Thomas Grainger`_
+- ``raise pytest.skip`` is redundant (:pr:`7939`) `crusaderky`_
+- Fix ``test_rechunk_with_{fully|partially}_unknown_dimension`` on CI (:pr:`7934`) `Hendrik Makait`_
+- Fix compatibility with ``numpy`` 1.25 (:pr:`7932`) `crusaderky`_
+- Spans: refactor sums of mappings (:pr:`7918`) `crusaderky`_
+- Fix flaky ``test_send_metrics_to_scheduler`` (:pr:`7931`) `crusaderky`_
+- Avoid calls to ``make_current()`` and ``make_clear()`` by using ``asyncio.run`` in ``LoopRunner`` (:pr:`7467`) `Thomas Grainger`_
+- Add ``needs triage`` label to re/opened PRs and issues (:pr:`7916`) `Miles`_
+- Remove ``span_id`` from global metrics on scheduler (:pr:`7917`) `crusaderky`_
+- Add spans to Fine Performance Metrics bokeh dashboard (:pr:`7911`) `crusaderky`_
+- FinePerformanceMetrics dashboard overhaul (:pr:`7910`) `crusaderky`_
+- Check for ``skip-caching`` label (:pr:`7907`) `Miles`_
+- Fix CI changes from (:pr:`7902`) (:pr:`7905`) `Hendrik Makait`_
+- Rename ``get_default_shuffle_algorithm`` to ``get_default_shuffle_method`` (:pr:`7902`) `Hendrik Makait`_
+- Bump actions/checkout from 3.5.2 to 3.5.3 (:pr:`7904`)
+- Refactor P2P rechunk validation (:pr:`7890`) `Hendrik Makait`_
+
+
 .. _v2023.6.0:
 
 2023.6.0
 --------
 
 Released on June 9, 2023
```

### Comparing `distributed-2023.6.0/docs/source/client.rst` & `distributed-2023.6.1/docs/source/client.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/communications.rst` & `distributed-2023.6.1/docs/source/communications.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/develop.rst` & `distributed-2023.6.1/docs/source/develop.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/diagnosing-performance.rst` & `distributed-2023.6.1/docs/source/diagnosing-performance.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/efficiency.rst` & `distributed-2023.6.1/docs/source/efficiency.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/examples/word-count.rst` & `distributed-2023.6.1/docs/source/examples/word-count.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/faq.rst` & `distributed-2023.6.1/docs/source/faq.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/foundations.rst` & `distributed-2023.6.1/docs/source/foundations.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/http_services.rst` & `distributed-2023.6.1/docs/source/http_services.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/index.rst` & `distributed-2023.6.1/docs/source/index.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/install.rst` & `distributed-2023.6.1/docs/source/install.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/journey.rst` & `distributed-2023.6.1/docs/source/journey.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/killed.rst` & `distributed-2023.6.1/docs/source/killed.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/limitations.rst` & `distributed-2023.6.1/docs/source/limitations.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/locality.rst` & `distributed-2023.6.1/docs/source/locality.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/logging.rst` & `distributed-2023.6.1/docs/source/logging.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/manage-computation.rst` & `distributed-2023.6.1/docs/source/manage-computation.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/memory.rst` & `distributed-2023.6.1/docs/source/memory.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/plugins.rst` & `distributed-2023.6.1/docs/source/plugins.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/priority.rst` & `distributed-2023.6.1/docs/source/priority.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/prometheus.rst` & `distributed-2023.6.1/docs/source/prometheus.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/protocol.rst` & `distributed-2023.6.1/docs/source/protocol.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/publish.rst` & `distributed-2023.6.1/docs/source/publish.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/quickstart.rst` & `distributed-2023.6.1/docs/source/quickstart.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/related-work.rst` & `distributed-2023.6.1/docs/source/related-work.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/resilience.rst` & `distributed-2023.6.1/docs/source/resilience.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/resources.rst` & `distributed-2023.6.1/docs/source/resources.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/scheduling-policies.rst` & `distributed-2023.6.1/docs/source/scheduling-policies.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/scheduling-state.rst` & `distributed-2023.6.1/docs/source/scheduling-state.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/serialization.rst` & `distributed-2023.6.1/docs/source/serialization.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/task-launch.rst` & `distributed-2023.6.1/docs/source/task-launch.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/tls.rst` & `distributed-2023.6.1/docs/source/tls.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/work-stealing.rst` & `distributed-2023.6.1/docs/source/work-stealing.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/worker-memory.rst` & `distributed-2023.6.1/docs/source/worker-memory.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/worker-state.rst` & `distributed-2023.6.1/docs/source/worker-state.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/docs/source/worker.rst` & `distributed-2023.6.1/docs/source/worker.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.6.0/pyproject.toml` & `distributed-2023.6.1/pyproject.toml`

 * *Files 0% similar despite different names*

```diff
@@ -23,15 +23,15 @@
     "Topic :: System :: Distributed Computing",
 ]
 readme = "README.rst"
 requires-python = ">=3.9"
 dependencies = [
     "click >= 8.0",
     "cloudpickle >= 1.5.0",
-    "dask == 2023.6.0",
+    "dask == 2023.6.1",
     "jinja2 >= 2.10.3",
     "locket >= 1.0.0",
     "msgpack >= 1.0.0",
     "packaging >= 20.0",
     "psutil >= 5.7.2",
     "pyyaml >= 5.3.1",
     "sortedcontainers >= 2.0.5",
```

