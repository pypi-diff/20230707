# Comparing `tmp/megfile-2.1.1.post2-py3-none-any.whl.zip` & `tmp/megfile-2.1.2-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,47 +1,47 @@
-Zip file size: 108313 bytes, number of entries: 45
+Zip file size: 108133 bytes, number of entries: 45
 -rw-rw-r--  2.0 unx     5434 b- defN 23-May-25 06:42 megfile/__init__.py
--rw-rw-r--  2.0 unx    10265 b- defN 23-Jun-30 08:29 megfile/cli.py
+-rw-rw-r--  2.0 unx    10396 b- defN 23-Jul-07 05:32 megfile/cli.py
 -rw-rw-r--  2.0 unx    11349 b- defN 23-Jun-16 11:38 megfile/errors.py
--rw-rw-r--  2.0 unx    11621 b- defN 23-Jul-07 01:45 megfile/fs.py
--rw-rw-r--  2.0 unx    38552 b- defN 23-Jun-16 02:18 megfile/fs_path.py
--rw-rw-r--  2.0 unx     2113 b- defN 23-Jul-07 02:15 megfile/http.py
--rw-rw-r--  2.0 unx     4805 b- defN 23-Jul-07 02:15 megfile/http_path.py
--rw-rw-r--  2.0 unx     6219 b- defN 23-May-25 06:42 megfile/interfaces.py
--rw-rw-r--  2.0 unx    29307 b- defN 23-Jun-13 05:49 megfile/pathlike.py
--rw-rw-r--  2.0 unx    12437 b- defN 23-Jul-07 02:15 megfile/s3.py
--rw-rw-r--  2.0 unx    84883 b- defN 23-Jul-07 02:15 megfile/s3_path.py
--rw-rw-r--  2.0 unx    11943 b- defN 23-Jul-07 01:45 megfile/sftp.py
--rw-rw-r--  2.0 unx    46328 b- defN 23-Jul-07 01:16 megfile/sftp_path.py
--rw-rw-r--  2.0 unx    31952 b- defN 23-Jul-06 03:43 megfile/smart.py
+-rw-rw-r--  2.0 unx    11621 b- defN 23-Jul-07 06:30 megfile/fs.py
+-rw-rw-r--  2.0 unx    38532 b- defN 23-Jul-07 05:32 megfile/fs_path.py
+-rw-rw-r--  2.0 unx     2113 b- defN 23-Jul-07 06:30 megfile/http.py
+-rw-rw-r--  2.0 unx     4785 b- defN 23-Jul-07 05:32 megfile/http_path.py
+-rw-rw-r--  2.0 unx     6219 b- defN 23-Jul-07 04:07 megfile/interfaces.py
+-rw-rw-r--  2.0 unx    29307 b- defN 23-Jul-07 04:07 megfile/pathlike.py
+-rw-rw-r--  2.0 unx    12437 b- defN 23-Jul-07 06:30 megfile/s3.py
+-rw-rw-r--  2.0 unx    84754 b- defN 23-Jul-07 05:32 megfile/s3_path.py
+-rw-rw-r--  2.0 unx    11943 b- defN 23-Jul-07 06:30 megfile/sftp.py
+-rw-rw-r--  2.0 unx    46668 b- defN 23-Jul-07 06:30 megfile/sftp_path.py
+-rw-rw-r--  2.0 unx    31892 b- defN 23-Jul-07 05:32 megfile/smart.py
 -rw-rw-r--  2.0 unx     6708 b- defN 23-Jun-16 02:18 megfile/smart_path.py
--rw-rw-r--  2.0 unx      559 b- defN 23-Jul-07 01:45 megfile/stdio.py
+-rw-rw-r--  2.0 unx      559 b- defN 23-Jul-07 06:30 megfile/stdio.py
 -rw-rw-r--  2.0 unx     2682 b- defN 23-Jun-16 02:18 megfile/stdio_path.py
--rw-rw-r--  2.0 unx       25 b- defN 23-Jul-07 02:33 megfile/version.py
+-rw-rw-r--  2.0 unx       19 b- defN 23-Jul-07 06:31 megfile/version.py
 -rw-rw-r--  2.0 unx        0 b- defN 23-May-25 06:42 megfile/lib/__init__.py
--rw-rw-r--  2.0 unx     4580 b- defN 23-Jul-07 01:45 megfile/lib/combine_reader.py
+-rw-rw-r--  2.0 unx     4546 b- defN 23-Jul-07 06:30 megfile/lib/combine_reader.py
 -rw-rw-r--  2.0 unx     2233 b- defN 23-Jun-13 05:49 megfile/lib/compare.py
--rw-rw-r--  2.0 unx     3073 b- defN 23-Jun-20 02:11 megfile/lib/compat.py
+-rw-rw-r--  2.0 unx     3013 b- defN 23-Jul-07 05:32 megfile/lib/compat.py
 -rw-rw-r--  2.0 unx     4054 b- defN 23-May-25 06:42 megfile/lib/fnmatch.py
--rw-rw-r--  2.0 unx     9752 b- defN 23-Jun-20 02:11 megfile/lib/glob.py
+-rw-rw-r--  2.0 unx     9732 b- defN 23-Jul-07 05:32 megfile/lib/glob.py
 -rw-rw-r--  2.0 unx      929 b- defN 23-May-25 06:42 megfile/lib/joinpath.py
 -rw-rw-r--  2.0 unx     1915 b- defN 23-May-25 06:42 megfile/lib/lazy_handler.py
 -rw-rw-r--  2.0 unx     6934 b- defN 23-May-25 06:42 megfile/lib/s3_buffered_writer.py
 -rw-rw-r--  2.0 unx     1322 b- defN 23-May-25 06:42 megfile/lib/s3_cached_handler.py
--rw-rw-r--  2.0 unx     6057 b- defN 23-May-25 06:42 megfile/lib/s3_limited_seekable_writer.py
+-rw-rw-r--  2.0 unx     6037 b- defN 23-Jul-07 05:32 megfile/lib/s3_limited_seekable_writer.py
 -rw-rw-r--  2.0 unx     3725 b- defN 23-May-25 06:42 megfile/lib/s3_memory_handler.py
--rw-rw-r--  2.0 unx     3404 b- defN 23-May-25 06:42 megfile/lib/s3_pipe_handler.py
--rw-rw-r--  2.0 unx    15053 b- defN 23-May-25 06:42 megfile/lib/s3_prefetch_reader.py
--rw-rw-r--  2.0 unx     3791 b- defN 23-Jul-07 01:45 megfile/lib/s3_share_cache_reader.py
+-rw-rw-r--  2.0 unx     3384 b- defN 23-Jul-07 05:32 megfile/lib/s3_pipe_handler.py
+-rw-rw-r--  2.0 unx    15033 b- defN 23-Jul-07 05:32 megfile/lib/s3_prefetch_reader.py
+-rw-rw-r--  2.0 unx     3771 b- defN 23-Jul-07 06:30 megfile/lib/s3_share_cache_reader.py
 -rw-rw-r--  2.0 unx     2683 b- defN 23-May-25 06:42 megfile/lib/shadow_handler.py
 -rw-rw-r--  2.0 unx     2044 b- defN 23-May-25 06:42 megfile/lib/stdio_handler.py
 -rw-rw-r--  2.0 unx      103 b- defN 23-Jun-16 02:18 megfile/lib/url.py
--rw-rw-r--  2.0 unx     9025 b- defN 23-May-25 06:42 megfile/utils/__init__.py
--rw-rw-r--  2.0 unx     2461 b- defN 23-May-25 06:42 megfile/utils/mutex.py
--rw-rw-r--  2.0 unx    11357 b- defN 23-Jul-07 02:34 megfile-2.1.1.post2.dist-info/LICENSE
--rw-rw-r--  2.0 unx     1080 b- defN 23-Jul-07 02:34 megfile-2.1.1.post2.dist-info/LICENSE.pyre
--rw-rw-r--  2.0 unx    10160 b- defN 23-Jul-07 02:34 megfile-2.1.1.post2.dist-info/METADATA
--rw-rw-r--  2.0 unx       92 b- defN 23-Jul-07 02:34 megfile-2.1.1.post2.dist-info/WHEEL
--rw-rw-r--  2.0 unx       49 b- defN 23-Jul-07 02:34 megfile-2.1.1.post2.dist-info/entry_points.txt
--rw-rw-r--  2.0 unx        8 b- defN 23-Jul-07 02:34 megfile-2.1.1.post2.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     3645 b- defN 23-Jul-07 02:34 megfile-2.1.1.post2.dist-info/RECORD
-45 files, 426711 bytes uncompressed, 102599 bytes compressed:  76.0%
+-rw-rw-r--  2.0 unx     9005 b- defN 23-Jul-07 05:32 megfile/utils/__init__.py
+-rw-rw-r--  2.0 unx     2461 b- defN 23-Jul-07 04:07 megfile/utils/mutex.py
+-rw-rw-r--  2.0 unx    11357 b- defN 23-Jul-07 06:31 megfile-2.1.2.dist-info/LICENSE
+-rw-rw-r--  2.0 unx     1080 b- defN 23-Jul-07 06:31 megfile-2.1.2.dist-info/LICENSE.pyre
+-rw-rw-r--  2.0 unx    10154 b- defN 23-Jul-07 06:31 megfile-2.1.2.dist-info/METADATA
+-rw-rw-r--  2.0 unx       92 b- defN 23-Jul-07 06:31 megfile-2.1.2.dist-info/WHEEL
+-rw-rw-r--  2.0 unx       49 b- defN 23-Jul-07 06:31 megfile-2.1.2.dist-info/entry_points.txt
+-rw-rw-r--  2.0 unx        8 b- defN 23-Jul-07 06:31 megfile-2.1.2.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     3603 b- defN 23-Jul-07 06:31 megfile-2.1.2.dist-info/RECORD
+45 files, 426685 bytes uncompressed, 102503 bytes compressed:  76.0%
```

## zipnote {}

```diff
@@ -108,29 +108,29 @@
 
 Filename: megfile/utils/__init__.py
 Comment: 
 
 Filename: megfile/utils/mutex.py
 Comment: 
 
-Filename: megfile-2.1.1.post2.dist-info/LICENSE
+Filename: megfile-2.1.2.dist-info/LICENSE
 Comment: 
 
-Filename: megfile-2.1.1.post2.dist-info/LICENSE.pyre
+Filename: megfile-2.1.2.dist-info/LICENSE.pyre
 Comment: 
 
-Filename: megfile-2.1.1.post2.dist-info/METADATA
+Filename: megfile-2.1.2.dist-info/METADATA
 Comment: 
 
-Filename: megfile-2.1.1.post2.dist-info/WHEEL
+Filename: megfile-2.1.2.dist-info/WHEEL
 Comment: 
 
-Filename: megfile-2.1.1.post2.dist-info/entry_points.txt
+Filename: megfile-2.1.2.dist-info/entry_points.txt
 Comment: 
 
-Filename: megfile-2.1.1.post2.dist-info/top_level.txt
+Filename: megfile-2.1.2.dist-info/top_level.txt
 Comment: 
 
-Filename: megfile-2.1.1.post2.dist-info/RECORD
+Filename: megfile-2.1.2.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## megfile/cli.py

```diff
@@ -231,16 +231,22 @@
 
 
 @cli.command(
     short_help='Make source and dest identical, modifying destination only.')
 @click.argument('src_path')
 @click.argument('dst_path')
 @click.option('-g', '--progress-bar', is_flag=True, help='Show progress bar.')
-def sync(src_path: str, dst_path: str, progress_bar: bool):
-    with ThreadPoolExecutor(max_workers=(os.cpu_count() or 1) * 2) as executor:
+@click.option(
+    '-w',
+    '--worker',
+    type=click.INT,
+    default=8,
+    help='Number of concurrent workers.')
+def sync(src_path: str, dst_path: str, progress_bar: bool, worker):
+    with ThreadPoolExecutor(max_workers=worker) as executor:
         if has_magic(src_path):
             root_dir = get_non_glob_dir(src_path)
             path_stats = []
             for dir_or_file in smart_glob(src_path, recursive=True,
                                           missing_ok=True):
                 path_stats.extend(list(smart_scan_stat(dir_or_file)))
 
@@ -261,24 +267,25 @@
                     callback_after_copy_file=callback_after_copy_file,
                     src_file_stats=path_stats,
                     map_func=executor.map,
                 )
 
                 tbar.close()
                 sbar.close()
-            else:  # pragma: no cover
+            else:
                 smart_sync(
                     root_dir,
                     dst_path,
                     src_file_stats=path_stats,
                     map_func=executor.map,
                 )
         else:
             if progress_bar:
-                smart_sync_with_progress(src_path, dst_path, followlinks=True)
+                smart_sync_with_progress(
+                    src_path, dst_path, followlinks=True, map_func=executor.map)
             else:
                 smart_sync(
                     src_path, dst_path, followlinks=True, map_func=executor.map)
 
 
 @cli.command(short_help="Make the path if it doesn't already exist.")
 @click.argument('path')
```

## megfile/fs_path.py

```diff
@@ -759,15 +759,15 @@
             # Prevent the dst_path directory from being created when src_path does not exist
             if dst_path == error.filename:
                 FSPath(os.path.dirname(dst_path)).mkdir(
                     parents=True, exist_ok=True)
                 self._copyfile(
                     dst_path, callback=callback, followlinks=followlinks)
             else:
-                raise  # pragma: no cover
+                raise
 
     def sync(self, dst_path: PathLike, followlinks: bool = False):
         '''Force write of everything to disk.
 
         :param dst_path: Target file path
         '''
         if self.is_dir(followlinks=followlinks):
```

## megfile/http_path.py

```diff
@@ -30,15 +30,15 @@
 
     def after_callback(response, *args, **kwargs):
         if response.status_code in status_forcelist:
             response.raise_for_status()
         return response
 
     def before_callback(method, url, **kwargs):
-        _logger.debug(  # pragma: no cover
+        _logger.debug(
             'send http request: %s %r, with parameters: %s', method, url,
             kwargs)
 
     session.request = patch_method(
         partial(session.request, timeout=timeout),
         max_retries=max_retries,
         should_retry=http_should_retry,
```

## megfile/s3_path.py

```diff
@@ -346,4961 +346,4953 @@
 00001590: 6669 6727 2c20 636f 6e66 6967 5f65 6e64  fig', config_end
 000015a0: 706f 696e 745f 7572 6c29 0a20 2020 2020  point_url).     
 000015b0: 2020 2020 2020 2072 6574 7572 6e20 636f         return co
 000015c0: 6e66 6967 5f65 6e64 706f 696e 745f 7572  nfig_endpoint_ur
 000015d0: 6c0a 2020 2020 6578 6365 7074 2062 6f74  l.    except bot
 000015e0: 6f63 6f72 652e 6578 6365 7074 696f 6e73  ocore.exceptions
 000015f0: 2e50 726f 6669 6c65 4e6f 7446 6f75 6e64  .ProfileNotFound
-00001600: 3a20 2023 2070 7261 676d 613a 206e 6f20  :  # pragma: no 
-00001610: 636f 7665 720a 2020 2020 2020 2020 7061  cover.        pa
-00001620: 7373 0a20 2020 2072 6574 7572 6e20 656e  ss.    return en
-00001630: 6470 6f69 6e74 5f75 726c 0a0a 0a64 6566  dpoint_url...def
-00001640: 2067 6574 5f73 335f 7365 7373 696f 6e28   get_s3_session(
-00001650: 7072 6f66 696c 655f 6e61 6d65 3d4e 6f6e  profile_name=Non
-00001660: 6529 3a0a 2020 2020 2727 2747 6574 2053  e):.    '''Get S
-00001670: 3320 7365 7373 696f 6e0a 0a20 2020 203a  3 session..    :
-00001680: 7265 7475 726e 733a 2053 3320 7365 7373  returns: S3 sess
-00001690: 696f 6e0a 2020 2020 2727 270a 2020 2020  ion.    '''.    
-000016a0: 7265 7475 726e 2074 6872 6561 645f 6c6f  return thread_lo
-000016b0: 6361 6c28 0a20 2020 2020 2020 2066 2773  cal(.        f's
-000016c0: 335f 7365 7373 696f 6e3a 7b70 726f 6669  3_session:{profi
-000016d0: 6c65 5f6e 616d 657d 272c 2062 6f74 6f33  le_name}', boto3
-000016e0: 2e53 6573 7369 6f6e 2c20 7072 6f66 696c  .Session, profil
-000016f0: 655f 6e61 6d65 3d70 726f 6669 6c65 5f6e  e_name=profile_n
-00001700: 616d 6529 0a0a 0a64 6566 2067 6574 5f61  ame)...def get_a
-00001710: 6363 6573 735f 746f 6b65 6e28 7072 6f66  ccess_token(prof
-00001720: 696c 655f 6e61 6d65 3d4e 6f6e 6529 3a0a  ile_name=None):.
-00001730: 2020 2020 6163 6365 7373 5f6b 6579 5f65      access_key_e
-00001740: 6e76 5f6e 616d 6520 3d20 6622 7b70 726f  nv_name = f"{pro
-00001750: 6669 6c65 5f6e 616d 657d 5f5f 4157 535f  file_name}__AWS_
-00001760: 4143 4345 5353 5f4b 4559 5f49 4422 2e75  ACCESS_KEY_ID".u
-00001770: 7070 6572 280a 2020 2020 2920 6966 2070  pper(.    ) if p
-00001780: 726f 6669 6c65 5f6e 616d 6520 656c 7365  rofile_name else
-00001790: 2022 4157 535f 4143 4345 5353 5f4b 4559   "AWS_ACCESS_KEY
-000017a0: 5f49 4422 0a20 2020 2073 6563 7265 745f  _ID".    secret_
-000017b0: 6b65 795f 656e 765f 6e61 6d65 203d 2066  key_env_name = f
-000017c0: 227b 7072 6f66 696c 655f 6e61 6d65 7d5f  "{profile_name}_
-000017d0: 5f41 5753 5f53 4543 5245 545f 4143 4345  _AWS_SECRET_ACCE
-000017e0: 5353 5f4b 4559 222e 7570 7065 7228 0a20  SS_KEY".upper(. 
-000017f0: 2020 2029 2069 6620 7072 6f66 696c 655f     ) if profile_
-00001800: 6e61 6d65 2065 6c73 6520 2241 5753 5f53  name else "AWS_S
-00001810: 4543 5245 545f 4143 4345 5353 5f4b 4559  ECRET_ACCESS_KEY
-00001820: 220a 2020 2020 6163 6365 7373 5f6b 6579  ".    access_key
-00001830: 203d 206f 732e 6765 7465 6e76 2861 6363   = os.getenv(acc
-00001840: 6573 735f 6b65 795f 656e 765f 6e61 6d65  ess_key_env_name
-00001850: 290a 2020 2020 7365 6372 6574 5f6b 6579  ).    secret_key
-00001860: 203d 206f 732e 6765 7465 6e76 2873 6563   = os.getenv(sec
-00001870: 7265 745f 6b65 795f 656e 765f 6e61 6d65  ret_key_env_name
-00001880: 290a 2020 2020 6966 2061 6363 6573 735f  ).    if access_
-00001890: 6b65 7920 616e 6420 7365 6372 6574 5f6b  key and secret_k
-000018a0: 6579 3a0a 2020 2020 2020 2020 7265 7475  ey:.        retu
-000018b0: 726e 2061 6363 6573 735f 6b65 792c 2073  rn access_key, s
-000018c0: 6563 7265 745f 6b65 790a 0a20 2020 2063  ecret_key..    c
-000018d0: 7265 6465 6e74 6961 6c73 203d 2067 6574  redentials = get
-000018e0: 5f73 335f 7365 7373 696f 6e28 7072 6f66  _s3_session(prof
-000018f0: 696c 655f 6e61 6d65 3d70 726f 6669 6c65  ile_name=profile
-00001900: 5f6e 616d 6529 2e67 6574 5f63 7265 6465  _name).get_crede
-00001910: 6e74 6961 6c73 2829 0a20 2020 2069 6620  ntials().    if 
-00001920: 6372 6564 656e 7469 616c 733a 0a20 2020  credentials:.   
-00001930: 2020 2020 2069 6620 6e6f 7420 6163 6365       if not acce
-00001940: 7373 5f6b 6579 3a0a 2020 2020 2020 2020  ss_key:.        
-00001950: 2020 2020 6163 6365 7373 5f6b 6579 203d      access_key =
-00001960: 2063 7265 6465 6e74 6961 6c73 2e61 6363   credentials.acc
-00001970: 6573 735f 6b65 790a 2020 2020 2020 2020  ess_key.        
-00001980: 6966 206e 6f74 2073 6563 7265 745f 6b65  if not secret_ke
-00001990: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
-000019a0: 6563 7265 745f 6b65 7920 3d20 6372 6564  ecret_key = cred
-000019b0: 656e 7469 616c 732e 7365 6372 6574 5f6b  entials.secret_k
-000019c0: 6579 0a20 2020 2072 6574 7572 6e20 6163  ey.    return ac
-000019d0: 6365 7373 5f6b 6579 2c20 7365 6372 6574  cess_key, secret
-000019e0: 5f6b 6579 0a0a 0a64 6566 2067 6574 5f73  _key...def get_s
-000019f0: 335f 636c 6965 6e74 280a 2020 2020 2020  3_client(.      
-00001a00: 2020 636f 6e66 6967 3a20 4f70 7469 6f6e    config: Option
-00001a10: 616c 5b62 6f74 6f63 6f72 652e 636f 6e66  al[botocore.conf
-00001a20: 6967 2e43 6f6e 6669 675d 203d 204e 6f6e  ig.Config] = Non
-00001a30: 652c 0a20 2020 2020 2020 2063 6163 6865  e,.        cache
-00001a40: 5f6b 6579 3a20 4f70 7469 6f6e 616c 5b73  _key: Optional[s
-00001a50: 7472 5d20 3d20 4e6f 6e65 2c0a 2020 2020  tr] = None,.    
-00001a60: 2020 2020 7072 6f66 696c 655f 6e61 6d65      profile_name
-00001a70: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
-00001a80: 3d20 4e6f 6e65 293a 0a20 2020 2027 2727  = None):.    '''
-00001a90: 4765 7420 5333 2063 6c69 656e 740a 0a20  Get S3 client.. 
-00001aa0: 2020 203a 7265 7475 726e 733a 2053 3320     :returns: S3 
-00001ab0: 636c 6965 6e74 0a20 2020 2027 2727 0a20  client.    '''. 
-00001ac0: 2020 2069 6620 6361 6368 655f 6b65 7920     if cache_key 
-00001ad0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00001ae0: 2020 2020 2072 6574 7572 6e20 7468 7265       return thre
-00001af0: 6164 5f6c 6f63 616c 280a 2020 2020 2020  ad_local(.      
-00001b00: 2020 2020 2020 6361 6368 655f 6b65 792c        cache_key,
-00001b10: 2067 6574 5f73 335f 636c 6965 6e74 2c20   get_s3_client, 
-00001b20: 636f 6e66 6967 3d63 6f6e 6669 672c 2070  config=config, p
-00001b30: 726f 6669 6c65 5f6e 616d 653d 7072 6f66  rofile_name=prof
-00001b40: 696c 655f 6e61 6d65 290a 0a20 2020 2061  ile_name)..    a
-00001b50: 6363 6573 735f 6b65 792c 2073 6563 7265  ccess_key, secre
-00001b60: 745f 6b65 7920 3d20 6765 745f 6163 6365  t_key = get_acce
-00001b70: 7373 5f74 6f6b 656e 2870 726f 6669 6c65  ss_token(profile
-00001b80: 5f6e 616d 6529 0a20 2020 2063 6c69 656e  _name).    clien
-00001b90: 7420 3d20 6765 745f 7333 5f73 6573 7369  t = get_s3_sessi
-00001ba0: 6f6e 2829 2e63 6c69 656e 7428 0a20 2020  on().client(.   
-00001bb0: 2020 2020 2027 7333 272c 0a20 2020 2020       's3',.     
-00001bc0: 2020 2065 6e64 706f 696e 745f 7572 6c3d     endpoint_url=
-00001bd0: 6765 745f 656e 6470 6f69 6e74 5f75 726c  get_endpoint_url
-00001be0: 2870 726f 6669 6c65 5f6e 616d 653d 7072  (profile_name=pr
-00001bf0: 6f66 696c 655f 6e61 6d65 292c 0a20 2020  ofile_name),.   
-00001c00: 2020 2020 2063 6f6e 6669 673d 636f 6e66       config=conf
-00001c10: 6967 2c0a 2020 2020 2020 2020 6177 735f  ig,.        aws_
-00001c20: 6163 6365 7373 5f6b 6579 5f69 643d 6163  access_key_id=ac
-00001c30: 6365 7373 5f6b 6579 2c0a 2020 2020 2020  cess_key,.      
-00001c40: 2020 6177 735f 7365 6372 6574 5f61 6363    aws_secret_acc
-00001c50: 6573 735f 6b65 793d 7365 6372 6574 5f6b  ess_key=secret_k
-00001c60: 6579 2c0a 2020 2020 290a 2020 2020 636c  ey,.    ).    cl
-00001c70: 6965 6e74 203d 205f 7061 7463 685f 6d61  ient = _patch_ma
-00001c80: 6b65 5f72 6571 7565 7374 2863 6c69 656e  ke_request(clien
-00001c90: 7429 0a20 2020 2072 6574 7572 6e20 636c  t).    return cl
-00001ca0: 6965 6e74 0a0a 0a64 6566 2073 335f 7061  ient...def s3_pa
-00001cb0: 7468 5f6a 6f69 6e28 7061 7468 3a20 5061  th_join(path: Pa
-00001cc0: 7468 4c69 6b65 2c20 2a6f 7468 6572 5f70  thLike, *other_p
-00001cd0: 6174 6873 3a20 5061 7468 4c69 6b65 2920  aths: PathLike) 
-00001ce0: 2d3e 2073 7472 3a0a 2020 2020 2727 270a  -> str:.    '''.
-00001cf0: 2020 2020 436f 6e63 6174 2032 206f 7220      Concat 2 or 
-00001d00: 6d6f 7265 2070 6174 6820 746f 2061 2063  more path to a c
-00001d10: 6f6d 706c 6574 6520 7061 7468 0a0a 2020  omplete path..  
-00001d20: 2020 3a70 6172 616d 2070 6174 683a 2047    :param path: G
-00001d30: 6976 656e 2070 6174 680a 2020 2020 3a70  iven path.    :p
-00001d40: 6172 616d 206f 7468 6572 5f70 6174 6873  aram other_paths
-00001d50: 3a20 5061 7468 7320 746f 2062 6520 636f  : Paths to be co
-00001d60: 6e63 6174 656e 6174 6564 0a20 2020 203a  ncatenated.    :
-00001d70: 7265 7475 726e 733a 2043 6f6e 6361 7465  returns: Concate
-00001d80: 6e61 7465 6420 636f 6d70 6c65 7465 2070  nated complete p
-00001d90: 6174 680a 0a20 2020 202e 2e20 6e6f 7465  ath..    .. note
-00001da0: 203a 3a0a 0a20 2020 2020 2020 2054 6865   ::..        The
-00001db0: 2064 6966 6665 7265 6e63 6520 6265 7477   difference betw
-00001dc0: 6565 6e20 7468 6973 2066 756e 6374 696f  een this functio
-00001dd0: 6e20 616e 6420 6060 6f73 2e70 6174 682e  n and ``os.path.
-00001de0: 6a6f 696e 6060 2069 7320 7468 6174 2074  join`` is that t
-00001df0: 6869 7320 6675 6e63 7469 6f6e 2069 676e  his function ign
-00001e00: 6f72 6573 206c 6566 7420 7369 6465 2073  ores left side s
-00001e10: 6c61 7368 2028 7768 6963 6820 696e 6469  lash (which indi
-00001e20: 6361 7465 7320 6162 736f 6c75 7465 2070  cates absolute p
-00001e30: 6174 6829 2069 6e20 6060 6f74 6865 725f  ath) in ``other_
-00001e40: 7061 7468 7360 6020 616e 6420 7769 6c6c  paths`` and will
-00001e50: 2064 6972 6563 746c 7920 636f 6e63 6174   directly concat
-00001e60: 2e0a 2020 2020 2020 2020 652e 672e 206f  ..        e.g. o
-00001e70: 732e 7061 7468 2e6a 6f69 6e28 272f 7061  s.path.join('/pa
-00001e80: 7468 272c 2027 746f 272c 2027 2f66 696c  th', 'to', '/fil
-00001e90: 6527 2920 3d3e 2027 2f66 696c 6527 2c20  e') => '/file', 
-00001ea0: 6275 7420 7333 5f70 6174 685f 6a6f 696e  but s3_path_join
-00001eb0: 2827 2f70 6174 6827 2c20 2774 6f27 2c20  ('/path', 'to', 
-00001ec0: 272f 6669 6c65 2729 203d 3e20 272f 7061  '/file') => '/pa
-00001ed0: 7468 2f74 6f2f 6669 6c65 270a 2020 2020  th/to/file'.    
-00001ee0: 2727 270a 2020 2020 7265 7475 726e 2075  '''.    return u
-00001ef0: 7269 5f6a 6f69 6e28 6673 7061 7468 2870  ri_join(fspath(p
-00001f00: 6174 6829 2c20 2a6d 6170 2866 7370 6174  ath), *map(fspat
-00001f10: 682c 206f 7468 6572 5f70 6174 6873 2929  h, other_paths))
-00001f20: 0a0a 0a64 6566 205f 6c69 7374 5f61 6c6c  ...def _list_all
-00001f30: 5f62 7563 6b65 7473 2870 726f 6669 6c65  _buckets(profile
-00001f40: 5f6e 616d 653a 204f 7074 696f 6e61 6c5b  _name: Optional[
-00001f50: 7374 725d 203d 204e 6f6e 6529 202d 3e20  str] = None) -> 
-00001f60: 4c69 7374 5b73 7472 5d3a 0a20 2020 2063  List[str]:.    c
-00001f70: 6c69 656e 7420 3d20 6765 745f 7333 5f63  lient = get_s3_c
-00001f80: 6c69 656e 7428 7072 6f66 696c 655f 6e61  lient(profile_na
-00001f90: 6d65 3d70 726f 6669 6c65 5f6e 616d 6529  me=profile_name)
-00001fa0: 0a20 2020 2072 6573 706f 6e73 6520 3d20  .    response = 
-00001fb0: 636c 6965 6e74 2e6c 6973 745f 6275 636b  client.list_buck
-00001fc0: 6574 7328 290a 2020 2020 7265 7475 726e  ets().    return
-00001fd0: 205b 636f 6e74 656e 745b 274e 616d 6527   [content['Name'
-00001fe0: 5d20 666f 7220 636f 6e74 656e 7420 696e  ] for content in
-00001ff0: 2072 6573 706f 6e73 655b 2742 7563 6b65   response['Bucke
-00002000: 7473 275d 5d0a 0a0a 6465 6620 5f70 6172  ts']]...def _par
-00002010: 7365 5f73 335f 7572 6c5f 6967 6e6f 7265  se_s3_url_ignore
-00002020: 5f62 7261 6365 2873 335f 7572 6c3a 2073  _brace(s3_url: s
-00002030: 7472 2920 2d3e 2054 7570 6c65 5b73 7472  tr) -> Tuple[str
-00002040: 2c20 7374 725d 3a0a 2020 2020 7333 5f75  , str]:.    s3_u
-00002050: 726c 203d 2066 7370 6174 6828 7333 5f75  rl = fspath(s3_u
-00002060: 726c 290a 2020 2020 7333 5f73 6368 656d  rl).    s3_schem
-00002070: 652c 2072 6967 6874 7061 7274 203d 2073  e, rightpart = s
-00002080: 335f 7572 6c5b 3a35 5d2c 2073 335f 7572  3_url[:5], s3_ur
-00002090: 6c5b 353a 5d0a 2020 2020 6966 2073 335f  l[5:].    if s3_
-000020a0: 7363 6865 6d65 2021 3d20 2773 333a 2f2f  scheme != 's3://
-000020b0: 273a 0a20 2020 2020 2020 2072 6169 7365  ':.        raise
-000020c0: 2056 616c 7565 4572 726f 7228 274e 6f74   ValueError('Not
-000020d0: 2061 2073 3320 7572 6c3a 2025 7227 2025   a s3 url: %r' %
-000020e0: 2073 335f 7572 6c29 0a20 2020 206c 6566   s3_url).    lef
-000020f0: 745f 6272 6163 6520 3d20 4661 6c73 650a  t_brace = False.
-00002100: 2020 2020 666f 7220 6375 7272 656e 745f      for current_
-00002110: 696e 6465 782c 2063 7572 7265 6e74 5f63  index, current_c
-00002120: 6861 7261 6374 6572 2069 6e20 656e 756d  haracter in enum
-00002130: 6572 6174 6528 7269 6768 7470 6172 7429  erate(rightpart)
-00002140: 3a0a 2020 2020 2020 2020 6966 2063 7572  :.        if cur
-00002150: 7265 6e74 5f63 6861 7261 6374 6572 203d  rent_character =
-00002160: 3d20 222f 2220 616e 6420 6c65 6674 5f62  = "/" and left_b
-00002170: 7261 6365 2069 7320 4661 6c73 653a 0a20  race is False:. 
-00002180: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00002190: 6e20 7269 6768 7470 6172 745b 3a63 7572  n rightpart[:cur
-000021a0: 7265 6e74 5f69 6e64 6578 5d2c 2072 6967  rent_index], rig
-000021b0: 6874 7061 7274 5b63 7572 7265 6e74 5f69  htpart[current_i
-000021c0: 6e64 6578 202b 2031 3a5d 0a20 2020 2020  ndex + 1:].     
-000021d0: 2020 2065 6c69 6620 6375 7272 656e 745f     elif current_
-000021e0: 6368 6172 6163 7465 7220 3d3d 2022 7b22  character == "{"
-000021f0: 3a0a 2020 2020 2020 2020 2020 2020 6c65  :.            le
-00002200: 6674 5f62 7261 6365 203d 2054 7275 650a  ft_brace = True.
-00002210: 2020 2020 2020 2020 656c 6966 2063 7572          elif cur
-00002220: 7265 6e74 5f63 6861 7261 6374 6572 203d  rent_character =
-00002230: 3d20 227d 223a 0a20 2020 2020 2020 2020  = "}":.         
-00002240: 2020 206c 6566 745f 6272 6163 6520 3d20     left_brace = 
-00002250: 4661 6c73 650a 2020 2020 7265 7475 726e  False.    return
-00002260: 2072 6967 6874 7061 7274 2c20 2222 0a0a   rightpart, ""..
-00002270: 0a64 6566 205f 6772 6f75 705f 7333 7061  .def _group_s3pa
-00002280: 7468 5f62 795f 6275 636b 6574 280a 2020  th_by_bucket(.  
-00002290: 2020 2020 2020 7333 5f70 6174 686e 616d        s3_pathnam
-000022a0: 653a 2073 7472 2c20 7072 6f66 696c 655f  e: str, profile_
-000022b0: 6e61 6d65 3a20 4f70 7469 6f6e 616c 5b73  name: Optional[s
-000022c0: 7472 5d20 3d20 4e6f 6e65 2920 2d3e 204c  tr] = None) -> L
-000022d0: 6973 745b 7374 725d 3a0a 2020 2020 6275  ist[str]:.    bu
-000022e0: 636b 6574 2c20 6b65 7920 3d20 5f70 6172  cket, key = _par
-000022f0: 7365 5f73 335f 7572 6c5f 6967 6e6f 7265  se_s3_url_ignore
-00002300: 5f62 7261 6365 2873 335f 7061 7468 6e61  _brace(s3_pathna
-00002310: 6d65 290a 2020 2020 6966 206e 6f74 2062  me).    if not b
-00002320: 7563 6b65 743a 0a20 2020 2020 2020 2069  ucket:.        i
-00002330: 6620 6e6f 7420 6b65 793a 0a20 2020 2020  f not key:.     
-00002340: 2020 2020 2020 2072 6169 7365 2055 6e73         raise Uns
-00002350: 7570 706f 7274 6564 4572 726f 7228 2747  upportedError('G
-00002360: 6c6f 6220 7768 6f6c 6520 7333 272c 2073  lob whole s3', s
-00002370: 335f 7061 7468 6e61 6d65 290a 2020 2020  3_pathname).    
-00002380: 2020 2020 7261 6973 6520 5333 4275 636b      raise S3Buck
-00002390: 6574 4e6f 7446 6f75 6e64 4572 726f 7228  etNotFoundError(
-000023a0: 2745 6d70 7479 2062 7563 6b65 7420 6e61  'Empty bucket na
-000023b0: 6d65 3a20 2572 2720 2520 7333 5f70 6174  me: %r' % s3_pat
-000023c0: 686e 616d 6529 0a0a 2020 2020 6772 6f75  hname)..    grou
-000023d0: 7065 645f 7061 7468 203d 205b 5d0a 0a20  ped_path = [].. 
-000023e0: 2020 2064 6566 2067 656e 6572 6174 655f     def generate_
-000023f0: 7333 5f70 6174 6828 6275 636b 6574 3a20  s3_path(bucket: 
-00002400: 7374 722c 206b 6579 3a20 7374 7229 202d  str, key: str) -
-00002410: 3e20 7374 723a 0a20 2020 2020 2020 2069  > str:.        i
-00002420: 6620 6b65 793a 0a20 2020 2020 2020 2020  f key:.         
-00002430: 2020 2072 6574 7572 6e20 2273 333a 2f2f     return "s3://
-00002440: 2573 2f25 7322 2025 2028 6275 636b 6574  %s/%s" % (bucket
-00002450: 2c20 6b65 7929 0a20 2020 2020 2020 2072  , key).        r
-00002460: 6574 7572 6e20 2273 333a 2f2f 2573 2573  eturn "s3://%s%s
-00002470: 2220 2520 2862 7563 6b65 742c 2022 2f22  " % (bucket, "/"
-00002480: 2069 6620 7333 5f70 6174 686e 616d 652e   if s3_pathname.
-00002490: 656e 6473 7769 7468 2822 2f22 2920 656c  endswith("/") el
-000024a0: 7365 2022 2229 0a0a 2020 2020 616c 6c5f  se "")..    all_
-000024b0: 6275 636b 6574 203d 206c 7275 5f63 6163  bucket = lru_cac
-000024c0: 6865 286d 6178 7369 7a65 3d31 2928 5f6c  he(maxsize=1)(_l
-000024d0: 6973 745f 616c 6c5f 6275 636b 6574 7329  ist_all_buckets)
-000024e0: 0a20 2020 2066 6f72 2062 7563 6b65 746e  .    for bucketn
-000024f0: 616d 6520 696e 2075 6e67 6c6f 626c 697a  ame in unglobliz
-00002500: 6528 6275 636b 6574 293a 0a20 2020 2020  e(bucket):.     
-00002510: 2020 2069 6620 6861 735f 6d61 6769 6328     if has_magic(
-00002520: 6275 636b 6574 6e61 6d65 293a 0a20 2020  bucketname):.   
-00002530: 2020 2020 2020 2020 2073 706c 6974 5f62           split_b
-00002540: 7563 6b65 746e 616d 6520 3d20 6275 636b  ucketname = buck
-00002550: 6574 6e61 6d65 2e73 706c 6974 2822 2f22  etname.split("/"
-00002560: 2c20 3129 0a20 2020 2020 2020 2020 2020  , 1).           
-00002570: 2070 6174 685f 7061 7274 203d 204e 6f6e   path_part = Non
-00002580: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
-00002590: 206c 656e 2873 706c 6974 5f62 7563 6b65   len(split_bucke
-000025a0: 746e 616d 6529 203d 3d20 323a 0a20 2020  tname) == 2:.   
-000025b0: 2020 2020 2020 2020 2020 2020 2062 7563               buc
-000025c0: 6b65 746e 616d 652c 2070 6174 685f 7061  ketname, path_pa
-000025d0: 7274 203d 2073 706c 6974 5f62 7563 6b65  rt = split_bucke
-000025e0: 746e 616d 650a 2020 2020 2020 2020 2020  tname.          
-000025f0: 2020 7061 7474 6572 6e20 3d20 7265 2e63    pattern = re.c
-00002600: 6f6d 7069 6c65 2874 7261 6e73 6c61 7465  ompile(translate
-00002610: 2872 652e 7375 6228 7227 5c2a 7b32 2c7d  (re.sub(r'\*{2,}
-00002620: 272c 2027 2a27 2c20 6275 636b 6574 6e61  ', '*', bucketna
-00002630: 6d65 2929 290a 0a20 2020 2020 2020 2020  me)))..         
-00002640: 2020 2066 6f72 2062 7563 6b65 7420 696e     for bucket in
-00002650: 2061 6c6c 5f62 7563 6b65 7428 7072 6f66   all_bucket(prof
-00002660: 696c 655f 6e61 6d65 293a 0a20 2020 2020  ile_name):.     
-00002670: 2020 2020 2020 2020 2020 2069 6620 7061             if pa
-00002680: 7474 6572 6e2e 6675 6c6c 6d61 7463 6828  ttern.fullmatch(
-00002690: 6275 636b 6574 2920 6973 206e 6f74 204e  bucket) is not N
-000026a0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-000026b0: 2020 2020 2020 2020 2069 6620 7061 7468           if path
-000026c0: 5f70 6172 7420 6973 206e 6f74 204e 6f6e  _part is not Non
-000026d0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000026e0: 2020 2020 2020 2020 2020 2062 7563 6b65             bucke
-000026f0: 7420 3d20 2225 732f 2573 2220 2520 280a  t = "%s/%s" % (.
+00001600: 3a0a 2020 2020 2020 2020 7061 7373 0a20  :.        pass. 
+00001610: 2020 2072 6574 7572 6e20 656e 6470 6f69     return endpoi
+00001620: 6e74 5f75 726c 0a0a 0a64 6566 2067 6574  nt_url...def get
+00001630: 5f73 335f 7365 7373 696f 6e28 7072 6f66  _s3_session(prof
+00001640: 696c 655f 6e61 6d65 3d4e 6f6e 6529 3a0a  ile_name=None):.
+00001650: 2020 2020 2727 2747 6574 2053 3320 7365      '''Get S3 se
+00001660: 7373 696f 6e0a 0a20 2020 203a 7265 7475  ssion..    :retu
+00001670: 726e 733a 2053 3320 7365 7373 696f 6e0a  rns: S3 session.
+00001680: 2020 2020 2727 270a 2020 2020 7265 7475      '''.    retu
+00001690: 726e 2074 6872 6561 645f 6c6f 6361 6c28  rn thread_local(
+000016a0: 0a20 2020 2020 2020 2066 2773 335f 7365  .        f's3_se
+000016b0: 7373 696f 6e3a 7b70 726f 6669 6c65 5f6e  ssion:{profile_n
+000016c0: 616d 657d 272c 2062 6f74 6f33 2e53 6573  ame}', boto3.Ses
+000016d0: 7369 6f6e 2c20 7072 6f66 696c 655f 6e61  sion, profile_na
+000016e0: 6d65 3d70 726f 6669 6c65 5f6e 616d 6529  me=profile_name)
+000016f0: 0a0a 0a64 6566 2067 6574 5f61 6363 6573  ...def get_acces
+00001700: 735f 746f 6b65 6e28 7072 6f66 696c 655f  s_token(profile_
+00001710: 6e61 6d65 3d4e 6f6e 6529 3a0a 2020 2020  name=None):.    
+00001720: 6163 6365 7373 5f6b 6579 5f65 6e76 5f6e  access_key_env_n
+00001730: 616d 6520 3d20 6622 7b70 726f 6669 6c65  ame = f"{profile
+00001740: 5f6e 616d 657d 5f5f 4157 535f 4143 4345  _name}__AWS_ACCE
+00001750: 5353 5f4b 4559 5f49 4422 2e75 7070 6572  SS_KEY_ID".upper
+00001760: 280a 2020 2020 2920 6966 2070 726f 6669  (.    ) if profi
+00001770: 6c65 5f6e 616d 6520 656c 7365 2022 4157  le_name else "AW
+00001780: 535f 4143 4345 5353 5f4b 4559 5f49 4422  S_ACCESS_KEY_ID"
+00001790: 0a20 2020 2073 6563 7265 745f 6b65 795f  .    secret_key_
+000017a0: 656e 765f 6e61 6d65 203d 2066 227b 7072  env_name = f"{pr
+000017b0: 6f66 696c 655f 6e61 6d65 7d5f 5f41 5753  ofile_name}__AWS
+000017c0: 5f53 4543 5245 545f 4143 4345 5353 5f4b  _SECRET_ACCESS_K
+000017d0: 4559 222e 7570 7065 7228 0a20 2020 2029  EY".upper(.    )
+000017e0: 2069 6620 7072 6f66 696c 655f 6e61 6d65   if profile_name
+000017f0: 2065 6c73 6520 2241 5753 5f53 4543 5245   else "AWS_SECRE
+00001800: 545f 4143 4345 5353 5f4b 4559 220a 2020  T_ACCESS_KEY".  
+00001810: 2020 6163 6365 7373 5f6b 6579 203d 206f    access_key = o
+00001820: 732e 6765 7465 6e76 2861 6363 6573 735f  s.getenv(access_
+00001830: 6b65 795f 656e 765f 6e61 6d65 290a 2020  key_env_name).  
+00001840: 2020 7365 6372 6574 5f6b 6579 203d 206f    secret_key = o
+00001850: 732e 6765 7465 6e76 2873 6563 7265 745f  s.getenv(secret_
+00001860: 6b65 795f 656e 765f 6e61 6d65 290a 2020  key_env_name).  
+00001870: 2020 6966 2061 6363 6573 735f 6b65 7920    if access_key 
+00001880: 616e 6420 7365 6372 6574 5f6b 6579 3a0a  and secret_key:.
+00001890: 2020 2020 2020 2020 7265 7475 726e 2061          return a
+000018a0: 6363 6573 735f 6b65 792c 2073 6563 7265  ccess_key, secre
+000018b0: 745f 6b65 790a 0a20 2020 2063 7265 6465  t_key..    crede
+000018c0: 6e74 6961 6c73 203d 2067 6574 5f73 335f  ntials = get_s3_
+000018d0: 7365 7373 696f 6e28 7072 6f66 696c 655f  session(profile_
+000018e0: 6e61 6d65 3d70 726f 6669 6c65 5f6e 616d  name=profile_nam
+000018f0: 6529 2e67 6574 5f63 7265 6465 6e74 6961  e).get_credentia
+00001900: 6c73 2829 0a20 2020 2069 6620 6372 6564  ls().    if cred
+00001910: 656e 7469 616c 733a 0a20 2020 2020 2020  entials:.       
+00001920: 2069 6620 6e6f 7420 6163 6365 7373 5f6b   if not access_k
+00001930: 6579 3a0a 2020 2020 2020 2020 2020 2020  ey:.            
+00001940: 6163 6365 7373 5f6b 6579 203d 2063 7265  access_key = cre
+00001950: 6465 6e74 6961 6c73 2e61 6363 6573 735f  dentials.access_
+00001960: 6b65 790a 2020 2020 2020 2020 6966 206e  key.        if n
+00001970: 6f74 2073 6563 7265 745f 6b65 793a 0a20  ot secret_key:. 
+00001980: 2020 2020 2020 2020 2020 2073 6563 7265             secre
+00001990: 745f 6b65 7920 3d20 6372 6564 656e 7469  t_key = credenti
+000019a0: 616c 732e 7365 6372 6574 5f6b 6579 0a20  als.secret_key. 
+000019b0: 2020 2072 6574 7572 6e20 6163 6365 7373     return access
+000019c0: 5f6b 6579 2c20 7365 6372 6574 5f6b 6579  _key, secret_key
+000019d0: 0a0a 0a64 6566 2067 6574 5f73 335f 636c  ...def get_s3_cl
+000019e0: 6965 6e74 280a 2020 2020 2020 2020 636f  ient(.        co
+000019f0: 6e66 6967 3a20 4f70 7469 6f6e 616c 5b62  nfig: Optional[b
+00001a00: 6f74 6f63 6f72 652e 636f 6e66 6967 2e43  otocore.config.C
+00001a10: 6f6e 6669 675d 203d 204e 6f6e 652c 0a20  onfig] = None,. 
+00001a20: 2020 2020 2020 2063 6163 6865 5f6b 6579         cache_key
+00001a30: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
+00001a40: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00001a50: 7072 6f66 696c 655f 6e61 6d65 3a20 4f70  profile_name: Op
+00001a60: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
+00001a70: 6e65 293a 0a20 2020 2027 2727 4765 7420  ne):.    '''Get 
+00001a80: 5333 2063 6c69 656e 740a 0a20 2020 203a  S3 client..    :
+00001a90: 7265 7475 726e 733a 2053 3320 636c 6965  returns: S3 clie
+00001aa0: 6e74 0a20 2020 2027 2727 0a20 2020 2069  nt.    '''.    i
+00001ab0: 6620 6361 6368 655f 6b65 7920 6973 206e  f cache_key is n
+00001ac0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00001ad0: 2072 6574 7572 6e20 7468 7265 6164 5f6c   return thread_l
+00001ae0: 6f63 616c 280a 2020 2020 2020 2020 2020  ocal(.          
+00001af0: 2020 6361 6368 655f 6b65 792c 2067 6574    cache_key, get
+00001b00: 5f73 335f 636c 6965 6e74 2c20 636f 6e66  _s3_client, conf
+00001b10: 6967 3d63 6f6e 6669 672c 2070 726f 6669  ig=config, profi
+00001b20: 6c65 5f6e 616d 653d 7072 6f66 696c 655f  le_name=profile_
+00001b30: 6e61 6d65 290a 0a20 2020 2061 6363 6573  name)..    acces
+00001b40: 735f 6b65 792c 2073 6563 7265 745f 6b65  s_key, secret_ke
+00001b50: 7920 3d20 6765 745f 6163 6365 7373 5f74  y = get_access_t
+00001b60: 6f6b 656e 2870 726f 6669 6c65 5f6e 616d  oken(profile_nam
+00001b70: 6529 0a20 2020 2063 6c69 656e 7420 3d20  e).    client = 
+00001b80: 6765 745f 7333 5f73 6573 7369 6f6e 2829  get_s3_session()
+00001b90: 2e63 6c69 656e 7428 0a20 2020 2020 2020  .client(.       
+00001ba0: 2027 7333 272c 0a20 2020 2020 2020 2065   's3',.        e
+00001bb0: 6e64 706f 696e 745f 7572 6c3d 6765 745f  ndpoint_url=get_
+00001bc0: 656e 6470 6f69 6e74 5f75 726c 2870 726f  endpoint_url(pro
+00001bd0: 6669 6c65 5f6e 616d 653d 7072 6f66 696c  file_name=profil
+00001be0: 655f 6e61 6d65 292c 0a20 2020 2020 2020  e_name),.       
+00001bf0: 2063 6f6e 6669 673d 636f 6e66 6967 2c0a   config=config,.
+00001c00: 2020 2020 2020 2020 6177 735f 6163 6365          aws_acce
+00001c10: 7373 5f6b 6579 5f69 643d 6163 6365 7373  ss_key_id=access
+00001c20: 5f6b 6579 2c0a 2020 2020 2020 2020 6177  _key,.        aw
+00001c30: 735f 7365 6372 6574 5f61 6363 6573 735f  s_secret_access_
+00001c40: 6b65 793d 7365 6372 6574 5f6b 6579 2c0a  key=secret_key,.
+00001c50: 2020 2020 290a 2020 2020 636c 6965 6e74      ).    client
+00001c60: 203d 205f 7061 7463 685f 6d61 6b65 5f72   = _patch_make_r
+00001c70: 6571 7565 7374 2863 6c69 656e 7429 0a20  equest(client). 
+00001c80: 2020 2072 6574 7572 6e20 636c 6965 6e74     return client
+00001c90: 0a0a 0a64 6566 2073 335f 7061 7468 5f6a  ...def s3_path_j
+00001ca0: 6f69 6e28 7061 7468 3a20 5061 7468 4c69  oin(path: PathLi
+00001cb0: 6b65 2c20 2a6f 7468 6572 5f70 6174 6873  ke, *other_paths
+00001cc0: 3a20 5061 7468 4c69 6b65 2920 2d3e 2073  : PathLike) -> s
+00001cd0: 7472 3a0a 2020 2020 2727 270a 2020 2020  tr:.    '''.    
+00001ce0: 436f 6e63 6174 2032 206f 7220 6d6f 7265  Concat 2 or more
+00001cf0: 2070 6174 6820 746f 2061 2063 6f6d 706c   path to a compl
+00001d00: 6574 6520 7061 7468 0a0a 2020 2020 3a70  ete path..    :p
+00001d10: 6172 616d 2070 6174 683a 2047 6976 656e  aram path: Given
+00001d20: 2070 6174 680a 2020 2020 3a70 6172 616d   path.    :param
+00001d30: 206f 7468 6572 5f70 6174 6873 3a20 5061   other_paths: Pa
+00001d40: 7468 7320 746f 2062 6520 636f 6e63 6174  ths to be concat
+00001d50: 656e 6174 6564 0a20 2020 203a 7265 7475  enated.    :retu
+00001d60: 726e 733a 2043 6f6e 6361 7465 6e61 7465  rns: Concatenate
+00001d70: 6420 636f 6d70 6c65 7465 2070 6174 680a  d complete path.
+00001d80: 0a20 2020 202e 2e20 6e6f 7465 203a 3a0a  .    .. note ::.
+00001d90: 0a20 2020 2020 2020 2054 6865 2064 6966  .        The dif
+00001da0: 6665 7265 6e63 6520 6265 7477 6565 6e20  ference between 
+00001db0: 7468 6973 2066 756e 6374 696f 6e20 616e  this function an
+00001dc0: 6420 6060 6f73 2e70 6174 682e 6a6f 696e  d ``os.path.join
+00001dd0: 6060 2069 7320 7468 6174 2074 6869 7320  `` is that this 
+00001de0: 6675 6e63 7469 6f6e 2069 676e 6f72 6573  function ignores
+00001df0: 206c 6566 7420 7369 6465 2073 6c61 7368   left side slash
+00001e00: 2028 7768 6963 6820 696e 6469 6361 7465   (which indicate
+00001e10: 7320 6162 736f 6c75 7465 2070 6174 6829  s absolute path)
+00001e20: 2069 6e20 6060 6f74 6865 725f 7061 7468   in ``other_path
+00001e30: 7360 6020 616e 6420 7769 6c6c 2064 6972  s`` and will dir
+00001e40: 6563 746c 7920 636f 6e63 6174 2e0a 2020  ectly concat..  
+00001e50: 2020 2020 2020 652e 672e 206f 732e 7061        e.g. os.pa
+00001e60: 7468 2e6a 6f69 6e28 272f 7061 7468 272c  th.join('/path',
+00001e70: 2027 746f 272c 2027 2f66 696c 6527 2920   'to', '/file') 
+00001e80: 3d3e 2027 2f66 696c 6527 2c20 6275 7420  => '/file', but 
+00001e90: 7333 5f70 6174 685f 6a6f 696e 2827 2f70  s3_path_join('/p
+00001ea0: 6174 6827 2c20 2774 6f27 2c20 272f 6669  ath', 'to', '/fi
+00001eb0: 6c65 2729 203d 3e20 272f 7061 7468 2f74  le') => '/path/t
+00001ec0: 6f2f 6669 6c65 270a 2020 2020 2727 270a  o/file'.    '''.
+00001ed0: 2020 2020 7265 7475 726e 2075 7269 5f6a      return uri_j
+00001ee0: 6f69 6e28 6673 7061 7468 2870 6174 6829  oin(fspath(path)
+00001ef0: 2c20 2a6d 6170 2866 7370 6174 682c 206f  , *map(fspath, o
+00001f00: 7468 6572 5f70 6174 6873 2929 0a0a 0a64  ther_paths))...d
+00001f10: 6566 205f 6c69 7374 5f61 6c6c 5f62 7563  ef _list_all_buc
+00001f20: 6b65 7473 2870 726f 6669 6c65 5f6e 616d  kets(profile_nam
+00001f30: 653a 204f 7074 696f 6e61 6c5b 7374 725d  e: Optional[str]
+00001f40: 203d 204e 6f6e 6529 202d 3e20 4c69 7374   = None) -> List
+00001f50: 5b73 7472 5d3a 0a20 2020 2063 6c69 656e  [str]:.    clien
+00001f60: 7420 3d20 6765 745f 7333 5f63 6c69 656e  t = get_s3_clien
+00001f70: 7428 7072 6f66 696c 655f 6e61 6d65 3d70  t(profile_name=p
+00001f80: 726f 6669 6c65 5f6e 616d 6529 0a20 2020  rofile_name).   
+00001f90: 2072 6573 706f 6e73 6520 3d20 636c 6965   response = clie
+00001fa0: 6e74 2e6c 6973 745f 6275 636b 6574 7328  nt.list_buckets(
+00001fb0: 290a 2020 2020 7265 7475 726e 205b 636f  ).    return [co
+00001fc0: 6e74 656e 745b 274e 616d 6527 5d20 666f  ntent['Name'] fo
+00001fd0: 7220 636f 6e74 656e 7420 696e 2072 6573  r content in res
+00001fe0: 706f 6e73 655b 2742 7563 6b65 7473 275d  ponse['Buckets']
+00001ff0: 5d0a 0a0a 6465 6620 5f70 6172 7365 5f73  ]...def _parse_s
+00002000: 335f 7572 6c5f 6967 6e6f 7265 5f62 7261  3_url_ignore_bra
+00002010: 6365 2873 335f 7572 6c3a 2073 7472 2920  ce(s3_url: str) 
+00002020: 2d3e 2054 7570 6c65 5b73 7472 2c20 7374  -> Tuple[str, st
+00002030: 725d 3a0a 2020 2020 7333 5f75 726c 203d  r]:.    s3_url =
+00002040: 2066 7370 6174 6828 7333 5f75 726c 290a   fspath(s3_url).
+00002050: 2020 2020 7333 5f73 6368 656d 652c 2072      s3_scheme, r
+00002060: 6967 6874 7061 7274 203d 2073 335f 7572  ightpart = s3_ur
+00002070: 6c5b 3a35 5d2c 2073 335f 7572 6c5b 353a  l[:5], s3_url[5:
+00002080: 5d0a 2020 2020 6966 2073 335f 7363 6865  ].    if s3_sche
+00002090: 6d65 2021 3d20 2773 333a 2f2f 273a 0a20  me != 's3://':. 
+000020a0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+000020b0: 7565 4572 726f 7228 274e 6f74 2061 2073  ueError('Not a s
+000020c0: 3320 7572 6c3a 2025 7227 2025 2073 335f  3 url: %r' % s3_
+000020d0: 7572 6c29 0a20 2020 206c 6566 745f 6272  url).    left_br
+000020e0: 6163 6520 3d20 4661 6c73 650a 2020 2020  ace = False.    
+000020f0: 666f 7220 6375 7272 656e 745f 696e 6465  for current_inde
+00002100: 782c 2063 7572 7265 6e74 5f63 6861 7261  x, current_chara
+00002110: 6374 6572 2069 6e20 656e 756d 6572 6174  cter in enumerat
+00002120: 6528 7269 6768 7470 6172 7429 3a0a 2020  e(rightpart):.  
+00002130: 2020 2020 2020 6966 2063 7572 7265 6e74        if current
+00002140: 5f63 6861 7261 6374 6572 203d 3d20 222f  _character == "/
+00002150: 2220 616e 6420 6c65 6674 5f62 7261 6365  " and left_brace
+00002160: 2069 7320 4661 6c73 653a 0a20 2020 2020   is False:.     
+00002170: 2020 2020 2020 2072 6574 7572 6e20 7269         return ri
+00002180: 6768 7470 6172 745b 3a63 7572 7265 6e74  ghtpart[:current
+00002190: 5f69 6e64 6578 5d2c 2072 6967 6874 7061  _index], rightpa
+000021a0: 7274 5b63 7572 7265 6e74 5f69 6e64 6578  rt[current_index
+000021b0: 202b 2031 3a5d 0a20 2020 2020 2020 2065   + 1:].        e
+000021c0: 6c69 6620 6375 7272 656e 745f 6368 6172  lif current_char
+000021d0: 6163 7465 7220 3d3d 2022 7b22 3a0a 2020  acter == "{":.  
+000021e0: 2020 2020 2020 2020 2020 6c65 6674 5f62            left_b
+000021f0: 7261 6365 203d 2054 7275 650a 2020 2020  race = True.    
+00002200: 2020 2020 656c 6966 2063 7572 7265 6e74      elif current
+00002210: 5f63 6861 7261 6374 6572 203d 3d20 227d  _character == "}
+00002220: 223a 0a20 2020 2020 2020 2020 2020 206c  ":.            l
+00002230: 6566 745f 6272 6163 6520 3d20 4661 6c73  eft_brace = Fals
+00002240: 650a 2020 2020 7265 7475 726e 2072 6967  e.    return rig
+00002250: 6874 7061 7274 2c20 2222 0a0a 0a64 6566  htpart, ""...def
+00002260: 205f 6772 6f75 705f 7333 7061 7468 5f62   _group_s3path_b
+00002270: 795f 6275 636b 6574 280a 2020 2020 2020  y_bucket(.      
+00002280: 2020 7333 5f70 6174 686e 616d 653a 2073    s3_pathname: s
+00002290: 7472 2c20 7072 6f66 696c 655f 6e61 6d65  tr, profile_name
+000022a0: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
+000022b0: 3d20 4e6f 6e65 2920 2d3e 204c 6973 745b  = None) -> List[
+000022c0: 7374 725d 3a0a 2020 2020 6275 636b 6574  str]:.    bucket
+000022d0: 2c20 6b65 7920 3d20 5f70 6172 7365 5f73  , key = _parse_s
+000022e0: 335f 7572 6c5f 6967 6e6f 7265 5f62 7261  3_url_ignore_bra
+000022f0: 6365 2873 335f 7061 7468 6e61 6d65 290a  ce(s3_pathname).
+00002300: 2020 2020 6966 206e 6f74 2062 7563 6b65      if not bucke
+00002310: 743a 0a20 2020 2020 2020 2069 6620 6e6f  t:.        if no
+00002320: 7420 6b65 793a 0a20 2020 2020 2020 2020  t key:.         
+00002330: 2020 2072 6169 7365 2055 6e73 7570 706f     raise Unsuppo
+00002340: 7274 6564 4572 726f 7228 2747 6c6f 6220  rtedError('Glob 
+00002350: 7768 6f6c 6520 7333 272c 2073 335f 7061  whole s3', s3_pa
+00002360: 7468 6e61 6d65 290a 2020 2020 2020 2020  thname).        
+00002370: 7261 6973 6520 5333 4275 636b 6574 4e6f  raise S3BucketNo
+00002380: 7446 6f75 6e64 4572 726f 7228 2745 6d70  tFoundError('Emp
+00002390: 7479 2062 7563 6b65 7420 6e61 6d65 3a20  ty bucket name: 
+000023a0: 2572 2720 2520 7333 5f70 6174 686e 616d  %r' % s3_pathnam
+000023b0: 6529 0a0a 2020 2020 6772 6f75 7065 645f  e)..    grouped_
+000023c0: 7061 7468 203d 205b 5d0a 0a20 2020 2064  path = []..    d
+000023d0: 6566 2067 656e 6572 6174 655f 7333 5f70  ef generate_s3_p
+000023e0: 6174 6828 6275 636b 6574 3a20 7374 722c  ath(bucket: str,
+000023f0: 206b 6579 3a20 7374 7229 202d 3e20 7374   key: str) -> st
+00002400: 723a 0a20 2020 2020 2020 2069 6620 6b65  r:.        if ke
+00002410: 793a 0a20 2020 2020 2020 2020 2020 2072  y:.            r
+00002420: 6574 7572 6e20 2273 333a 2f2f 2573 2f25  eturn "s3://%s/%
+00002430: 7322 2025 2028 6275 636b 6574 2c20 6b65  s" % (bucket, ke
+00002440: 7929 0a20 2020 2020 2020 2072 6574 7572  y).        retur
+00002450: 6e20 2273 333a 2f2f 2573 2573 2220 2520  n "s3://%s%s" % 
+00002460: 2862 7563 6b65 742c 2022 2f22 2069 6620  (bucket, "/" if 
+00002470: 7333 5f70 6174 686e 616d 652e 656e 6473  s3_pathname.ends
+00002480: 7769 7468 2822 2f22 2920 656c 7365 2022  with("/") else "
+00002490: 2229 0a0a 2020 2020 616c 6c5f 6275 636b  ")..    all_buck
+000024a0: 6574 203d 206c 7275 5f63 6163 6865 286d  et = lru_cache(m
+000024b0: 6178 7369 7a65 3d31 2928 5f6c 6973 745f  axsize=1)(_list_
+000024c0: 616c 6c5f 6275 636b 6574 7329 0a20 2020  all_buckets).   
+000024d0: 2066 6f72 2062 7563 6b65 746e 616d 6520   for bucketname 
+000024e0: 696e 2075 6e67 6c6f 626c 697a 6528 6275  in ungloblize(bu
+000024f0: 636b 6574 293a 0a20 2020 2020 2020 2069  cket):.        i
+00002500: 6620 6861 735f 6d61 6769 6328 6275 636b  f has_magic(buck
+00002510: 6574 6e61 6d65 293a 0a20 2020 2020 2020  etname):.       
+00002520: 2020 2020 2073 706c 6974 5f62 7563 6b65       split_bucke
+00002530: 746e 616d 6520 3d20 6275 636b 6574 6e61  tname = bucketna
+00002540: 6d65 2e73 706c 6974 2822 2f22 2c20 3129  me.split("/", 1)
+00002550: 0a20 2020 2020 2020 2020 2020 2070 6174  .            pat
+00002560: 685f 7061 7274 203d 204e 6f6e 650a 2020  h_part = None.  
+00002570: 2020 2020 2020 2020 2020 6966 206c 656e            if len
+00002580: 2873 706c 6974 5f62 7563 6b65 746e 616d  (split_bucketnam
+00002590: 6529 203d 3d20 323a 0a20 2020 2020 2020  e) == 2:.       
+000025a0: 2020 2020 2020 2020 2062 7563 6b65 746e           bucketn
+000025b0: 616d 652c 2070 6174 685f 7061 7274 203d  ame, path_part =
+000025c0: 2073 706c 6974 5f62 7563 6b65 746e 616d   split_bucketnam
+000025d0: 650a 2020 2020 2020 2020 2020 2020 7061  e.            pa
+000025e0: 7474 6572 6e20 3d20 7265 2e63 6f6d 7069  ttern = re.compi
+000025f0: 6c65 2874 7261 6e73 6c61 7465 2872 652e  le(translate(re.
+00002600: 7375 6228 7227 5c2a 7b32 2c7d 272c 2027  sub(r'\*{2,}', '
+00002610: 2a27 2c20 6275 636b 6574 6e61 6d65 2929  *', bucketname))
+00002620: 290a 0a20 2020 2020 2020 2020 2020 2066  )..            f
+00002630: 6f72 2062 7563 6b65 7420 696e 2061 6c6c  or bucket in all
+00002640: 5f62 7563 6b65 7428 7072 6f66 696c 655f  _bucket(profile_
+00002650: 6e61 6d65 293a 0a20 2020 2020 2020 2020  name):.         
+00002660: 2020 2020 2020 2069 6620 7061 7474 6572         if patter
+00002670: 6e2e 6675 6c6c 6d61 7463 6828 6275 636b  n.fullmatch(buck
+00002680: 6574 2920 6973 206e 6f74 204e 6f6e 653a  et) is not None:
+00002690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000026a0: 2020 2020 2069 6620 7061 7468 5f70 6172       if path_par
+000026b0: 7420 6973 206e 6f74 204e 6f6e 653a 0a20  t is not None:. 
+000026c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000026d0: 2020 2020 2020 2062 7563 6b65 7420 3d20         bucket = 
+000026e0: 2225 732f 2573 2220 2520 2862 7563 6b65  "%s/%s" % (bucke
+000026f0: 742c 2070 6174 685f 7061 7274 290a 2020  t, path_part).  
 00002700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002710: 2020 2020 2020 2020 2020 2020 6275 636b              buck
-00002720: 6574 2c20 7061 7468 5f70 6172 7429 2020  et, path_part)  
-00002730: 2320 7072 6167 6d61 3a20 6e6f 2063 6f76  # pragma: no cov
-00002740: 6572 0a20 2020 2020 2020 2020 2020 2020  er.             
-00002750: 2020 2020 2020 2067 726f 7570 6564 5f70         grouped_p
-00002760: 6174 682e 6170 7065 6e64 2867 656e 6572  ath.append(gener
-00002770: 6174 655f 7333 5f70 6174 6828 6275 636b  ate_s3_path(buck
-00002780: 6574 2c20 6b65 7929 290a 2020 2020 2020  et, key)).      
-00002790: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000027a0: 2020 2020 6772 6f75 7065 645f 7061 7468      grouped_path
-000027b0: 2e61 7070 656e 6428 6765 6e65 7261 7465  .append(generate
-000027c0: 5f73 335f 7061 7468 2862 7563 6b65 746e  _s3_path(bucketn
-000027d0: 616d 652c 206b 6579 2929 0a0a 2020 2020  ame, key))..    
-000027e0: 7265 7475 726e 2067 726f 7570 6564 5f70  return grouped_p
-000027f0: 6174 680a 0a0a 6465 6620 5f73 335f 7370  ath...def _s3_sp
-00002800: 6c69 745f 6d61 6769 635f 6967 6e6f 7265  lit_magic_ignore
-00002810: 5f62 7261 6365 2873 335f 7061 7468 6e61  _brace(s3_pathna
-00002820: 6d65 3a20 7374 7229 202d 3e20 5475 706c  me: str) -> Tupl
-00002830: 655b 7374 722c 2073 7472 5d3a 0a20 2020  e[str, str]:.   
-00002840: 2069 6620 6e6f 7420 7333 5f70 6174 686e   if not s3_pathn
-00002850: 616d 653a 0a20 2020 2020 2020 2072 6169  ame:.        rai
-00002860: 7365 2056 616c 7565 4572 726f 7228 2273  se ValueError("s
-00002870: 335f 7061 7468 6e61 6d65 3a20 2573 222c  3_pathname: %s",
-00002880: 2073 335f 7061 7468 6e61 6d65 290a 0a20   s3_pathname).. 
+00002710: 2020 6772 6f75 7065 645f 7061 7468 2e61    grouped_path.a
+00002720: 7070 656e 6428 6765 6e65 7261 7465 5f73  ppend(generate_s
+00002730: 335f 7061 7468 2862 7563 6b65 742c 206b  3_path(bucket, k
+00002740: 6579 2929 0a20 2020 2020 2020 2065 6c73  ey)).        els
+00002750: 653a 0a20 2020 2020 2020 2020 2020 2067  e:.            g
+00002760: 726f 7570 6564 5f70 6174 682e 6170 7065  rouped_path.appe
+00002770: 6e64 2867 656e 6572 6174 655f 7333 5f70  nd(generate_s3_p
+00002780: 6174 6828 6275 636b 6574 6e61 6d65 2c20  ath(bucketname, 
+00002790: 6b65 7929 290a 0a20 2020 2072 6574 7572  key))..    retur
+000027a0: 6e20 6772 6f75 7065 645f 7061 7468 0a0a  n grouped_path..
+000027b0: 0a64 6566 205f 7333 5f73 706c 6974 5f6d  .def _s3_split_m
+000027c0: 6167 6963 5f69 676e 6f72 655f 6272 6163  agic_ignore_brac
+000027d0: 6528 7333 5f70 6174 686e 616d 653a 2073  e(s3_pathname: s
+000027e0: 7472 2920 2d3e 2054 7570 6c65 5b73 7472  tr) -> Tuple[str
+000027f0: 2c20 7374 725d 3a0a 2020 2020 6966 206e  , str]:.    if n
+00002800: 6f74 2073 335f 7061 7468 6e61 6d65 3a0a  ot s3_pathname:.
+00002810: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+00002820: 6c75 6545 7272 6f72 2822 7333 5f70 6174  lueError("s3_pat
+00002830: 686e 616d 653a 2025 7322 2c20 7333 5f70  hname: %s", s3_p
+00002840: 6174 686e 616d 6529 0a0a 2020 2020 6861  athname)..    ha
+00002850: 735f 7072 6f74 6f63 6f6c 203d 2046 616c  s_protocol = Fal
+00002860: 7365 0a20 2020 2069 6620 7333 5f70 6174  se.    if s3_pat
+00002870: 686e 616d 652e 7374 6172 7473 7769 7468  hname.startswith
+00002880: 2822 7333 3a2f 2f22 293a 0a20 2020 2020  ("s3://"):.     
 00002890: 2020 2068 6173 5f70 726f 746f 636f 6c20     has_protocol 
-000028a0: 3d20 4661 6c73 650a 2020 2020 6966 2073  = False.    if s
-000028b0: 335f 7061 7468 6e61 6d65 2e73 7461 7274  3_pathname.start
-000028c0: 7377 6974 6828 2273 333a 2f2f 2229 3a0a  swith("s3://"):.
-000028d0: 2020 2020 2020 2020 6861 735f 7072 6f74          has_prot
-000028e0: 6f63 6f6c 203d 2054 7275 650a 2020 2020  ocol = True.    
-000028f0: 2020 2020 7333 5f70 6174 686e 616d 6520      s3_pathname 
-00002900: 3d20 7333 5f70 6174 686e 616d 655b 353a  = s3_pathname[5:
-00002910: 5d0a 0a20 2020 2068 6173 5f64 656c 696d  ]..    has_delim
-00002920: 6974 6572 203d 2046 616c 7365 0a20 2020  iter = False.   
-00002930: 2069 6620 7333 5f70 6174 686e 616d 652e   if s3_pathname.
-00002940: 656e 6473 7769 7468 2822 2f22 293a 0a20  endswith("/"):. 
-00002950: 2020 2020 2020 2068 6173 5f64 656c 696d         has_delim
-00002960: 6974 6572 203d 2054 7275 650a 2020 2020  iter = True.    
-00002970: 2020 2020 7333 5f70 6174 686e 616d 6520      s3_pathname 
-00002980: 3d20 7333 5f70 6174 686e 616d 655b 3a2d  = s3_pathname[:-
-00002990: 315d 0a0a 2020 2020 6e6f 726d 616c 5f70  1]..    normal_p
-000029a0: 6172 7473 203d 205b 5d0a 2020 2020 6d61  arts = [].    ma
-000029b0: 6769 635f 7061 7274 7320 3d20 5b5d 0a20  gic_parts = []. 
-000029c0: 2020 206c 6566 745f 6272 6163 6520 3d20     left_brace = 
-000029d0: 4661 6c73 650a 2020 2020 6c65 6674 5f69  False.    left_i
-000029e0: 6e64 6578 203d 2030 0a20 2020 2066 6f72  ndex = 0.    for
-000029f0: 2063 7572 7265 6e74 5f69 6e64 6578 2c20   current_index, 
-00002a00: 6375 7272 656e 745f 6368 6172 6163 7465  current_characte
-00002a10: 7220 696e 2065 6e75 6d65 7261 7465 2873  r in enumerate(s
-00002a20: 335f 7061 7468 6e61 6d65 293a 0a20 2020  3_pathname):.   
-00002a30: 2020 2020 2069 6620 6375 7272 656e 745f       if current_
-00002a40: 6368 6172 6163 7465 7220 3d3d 2022 2f22  character == "/"
-00002a50: 2061 6e64 206c 6566 745f 6272 6163 6520   and left_brace 
-00002a60: 6973 2046 616c 7365 3a0a 2020 2020 2020  is False:.      
-00002a70: 2020 2020 2020 6966 2068 6173 5f6d 6167        if has_mag
-00002a80: 6963 5f69 676e 6f72 655f 6272 6163 6528  ic_ignore_brace(
-00002a90: 7333 5f70 6174 686e 616d 655b 6c65 6674  s3_pathname[left
-00002aa0: 5f69 6e64 6578 3a63 7572 7265 6e74 5f69  _index:current_i
-00002ab0: 6e64 6578 5d29 3a0a 2020 2020 2020 2020  ndex]):.        
-00002ac0: 2020 2020 2020 2020 6d61 6769 635f 7061          magic_pa
-00002ad0: 7274 732e 6170 7065 6e64 2873 335f 7061  rts.append(s3_pa
-00002ae0: 7468 6e61 6d65 5b6c 6566 745f 696e 6465  thname[left_inde
-00002af0: 783a 6375 7272 656e 745f 696e 6465 785d  x:current_index]
-00002b00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00002b10: 2020 6966 2073 335f 7061 7468 6e61 6d65    if s3_pathname
-00002b20: 5b63 7572 7265 6e74 5f69 6e64 6578 202b  [current_index +
-00002b30: 2031 3a5d 3a0a 2020 2020 2020 2020 2020   1:]:.          
-00002b40: 2020 2020 2020 2020 2020 6d61 6769 635f            magic_
-00002b50: 7061 7274 732e 6170 7065 6e64 2873 335f  parts.append(s3_
-00002b60: 7061 7468 6e61 6d65 5b63 7572 7265 6e74  pathname[current
-00002b70: 5f69 6e64 6578 202b 2031 3a5d 290a 2020  _index + 1:]).  
-00002b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002b90: 2020 6c65 6674 5f69 6e64 6578 203d 206c    left_index = l
-00002ba0: 656e 2873 335f 7061 7468 6e61 6d65 290a  en(s3_pathname).
-00002bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002bc0: 6272 6561 6b0a 2020 2020 2020 2020 2020  break.          
-00002bd0: 2020 6e6f 726d 616c 5f70 6172 7473 2e61    normal_parts.a
-00002be0: 7070 656e 6428 7333 5f70 6174 686e 616d  ppend(s3_pathnam
-00002bf0: 655b 6c65 6674 5f69 6e64 6578 3a63 7572  e[left_index:cur
-00002c00: 7265 6e74 5f69 6e64 6578 5d29 0a20 2020  rent_index]).   
-00002c10: 2020 2020 2020 2020 206c 6566 745f 696e           left_in
-00002c20: 6465 7820 3d20 6375 7272 656e 745f 696e  dex = current_in
-00002c30: 6465 7820 2b20 310a 2020 2020 2020 2020  dex + 1.        
+000028a0: 3d20 5472 7565 0a20 2020 2020 2020 2073  = True.        s
+000028b0: 335f 7061 7468 6e61 6d65 203d 2073 335f  3_pathname = s3_
+000028c0: 7061 7468 6e61 6d65 5b35 3a5d 0a0a 2020  pathname[5:]..  
+000028d0: 2020 6861 735f 6465 6c69 6d69 7465 7220    has_delimiter 
+000028e0: 3d20 4661 6c73 650a 2020 2020 6966 2073  = False.    if s
+000028f0: 335f 7061 7468 6e61 6d65 2e65 6e64 7377  3_pathname.endsw
+00002900: 6974 6828 222f 2229 3a0a 2020 2020 2020  ith("/"):.      
+00002910: 2020 6861 735f 6465 6c69 6d69 7465 7220    has_delimiter 
+00002920: 3d20 5472 7565 0a20 2020 2020 2020 2073  = True.        s
+00002930: 335f 7061 7468 6e61 6d65 203d 2073 335f  3_pathname = s3_
+00002940: 7061 7468 6e61 6d65 5b3a 2d31 5d0a 0a20  pathname[:-1].. 
+00002950: 2020 206e 6f72 6d61 6c5f 7061 7274 7320     normal_parts 
+00002960: 3d20 5b5d 0a20 2020 206d 6167 6963 5f70  = [].    magic_p
+00002970: 6172 7473 203d 205b 5d0a 2020 2020 6c65  arts = [].    le
+00002980: 6674 5f62 7261 6365 203d 2046 616c 7365  ft_brace = False
+00002990: 0a20 2020 206c 6566 745f 696e 6465 7820  .    left_index 
+000029a0: 3d20 300a 2020 2020 666f 7220 6375 7272  = 0.    for curr
+000029b0: 656e 745f 696e 6465 782c 2063 7572 7265  ent_index, curre
+000029c0: 6e74 5f63 6861 7261 6374 6572 2069 6e20  nt_character in 
+000029d0: 656e 756d 6572 6174 6528 7333 5f70 6174  enumerate(s3_pat
+000029e0: 686e 616d 6529 3a0a 2020 2020 2020 2020  hname):.        
+000029f0: 6966 2063 7572 7265 6e74 5f63 6861 7261  if current_chara
+00002a00: 6374 6572 203d 3d20 222f 2220 616e 6420  cter == "/" and 
+00002a10: 6c65 6674 5f62 7261 6365 2069 7320 4661  left_brace is Fa
+00002a20: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00002a30: 2069 6620 6861 735f 6d61 6769 635f 6967   if has_magic_ig
+00002a40: 6e6f 7265 5f62 7261 6365 2873 335f 7061  nore_brace(s3_pa
+00002a50: 7468 6e61 6d65 5b6c 6566 745f 696e 6465  thname[left_inde
+00002a60: 783a 6375 7272 656e 745f 696e 6465 785d  x:current_index]
+00002a70: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00002a80: 2020 206d 6167 6963 5f70 6172 7473 2e61     magic_parts.a
+00002a90: 7070 656e 6428 7333 5f70 6174 686e 616d  ppend(s3_pathnam
+00002aa0: 655b 6c65 6674 5f69 6e64 6578 3a63 7572  e[left_index:cur
+00002ab0: 7265 6e74 5f69 6e64 6578 5d29 0a20 2020  rent_index]).   
+00002ac0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00002ad0: 7333 5f70 6174 686e 616d 655b 6375 7272  s3_pathname[curr
+00002ae0: 656e 745f 696e 6465 7820 2b20 313a 5d3a  ent_index + 1:]:
+00002af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002b00: 2020 2020 206d 6167 6963 5f70 6172 7473       magic_parts
+00002b10: 2e61 7070 656e 6428 7333 5f70 6174 686e  .append(s3_pathn
+00002b20: 616d 655b 6375 7272 656e 745f 696e 6465  ame[current_inde
+00002b30: 7820 2b20 313a 5d29 0a20 2020 2020 2020  x + 1:]).       
+00002b40: 2020 2020 2020 2020 2020 2020 206c 6566               lef
+00002b50: 745f 696e 6465 7820 3d20 6c65 6e28 7333  t_index = len(s3
+00002b60: 5f70 6174 686e 616d 6529 0a20 2020 2020  _pathname).     
+00002b70: 2020 2020 2020 2020 2020 2062 7265 616b             break
+00002b80: 0a20 2020 2020 2020 2020 2020 206e 6f72  .            nor
+00002b90: 6d61 6c5f 7061 7274 732e 6170 7065 6e64  mal_parts.append
+00002ba0: 2873 335f 7061 7468 6e61 6d65 5b6c 6566  (s3_pathname[lef
+00002bb0: 745f 696e 6465 783a 6375 7272 656e 745f  t_index:current_
+00002bc0: 696e 6465 785d 290a 2020 2020 2020 2020  index]).        
+00002bd0: 2020 2020 6c65 6674 5f69 6e64 6578 203d      left_index =
+00002be0: 2063 7572 7265 6e74 5f69 6e64 6578 202b   current_index +
+00002bf0: 2031 0a20 2020 2020 2020 2065 6c69 6620   1.        elif 
+00002c00: 6375 7272 656e 745f 6368 6172 6163 7465  current_characte
+00002c10: 7220 3d3d 2022 7b22 3a0a 2020 2020 2020  r == "{":.      
+00002c20: 2020 2020 2020 6c65 6674 5f62 7261 6365        left_brace
+00002c30: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
 00002c40: 656c 6966 2063 7572 7265 6e74 5f63 6861  elif current_cha
-00002c50: 7261 6374 6572 203d 3d20 227b 223a 0a20  racter == "{":. 
+00002c50: 7261 6374 6572 203d 3d20 227d 223a 0a20  racter == "}":. 
 00002c60: 2020 2020 2020 2020 2020 206c 6566 745f             left_
-00002c70: 6272 6163 6520 3d20 5472 7565 0a20 2020  brace = True.   
-00002c80: 2020 2020 2065 6c69 6620 6375 7272 656e       elif curren
-00002c90: 745f 6368 6172 6163 7465 7220 3d3d 2022  t_character == "
-00002ca0: 7d22 3a0a 2020 2020 2020 2020 2020 2020  }":.            
-00002cb0: 6c65 6674 5f62 7261 6365 203d 2046 616c  left_brace = Fal
-00002cc0: 7365 0a20 2020 2069 6620 7333 5f70 6174  se.    if s3_pat
-00002cd0: 686e 616d 655b 6c65 6674 5f69 6e64 6578  hname[left_index
-00002ce0: 3a5d 3a0a 2020 2020 2020 2020 6966 2068  :]:.        if h
-00002cf0: 6173 5f6d 6167 6963 5f69 676e 6f72 655f  as_magic_ignore_
-00002d00: 6272 6163 6528 7333 5f70 6174 686e 616d  brace(s3_pathnam
-00002d10: 655b 6c65 6674 5f69 6e64 6578 3a5d 293a  e[left_index:]):
-00002d20: 0a20 2020 2020 2020 2020 2020 206d 6167  .            mag
-00002d30: 6963 5f70 6172 7473 2e61 7070 656e 6428  ic_parts.append(
-00002d40: 7333 5f70 6174 686e 616d 655b 6c65 6674  s3_pathname[left
-00002d50: 5f69 6e64 6578 3a5d 290a 2020 2020 2020  _index:]).      
-00002d60: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00002d70: 2020 2020 6e6f 726d 616c 5f70 6172 7473      normal_parts
-00002d80: 2e61 7070 656e 6428 7333 5f70 6174 686e  .append(s3_pathn
-00002d90: 616d 655b 6c65 6674 5f69 6e64 6578 3a5d  ame[left_index:]
-00002da0: 290a 0a20 2020 2069 6620 6861 735f 7072  )..    if has_pr
-00002db0: 6f74 6f63 6f6c 2061 6e64 206e 6f72 6d61  otocol and norma
-00002dc0: 6c5f 7061 7274 733a 0a20 2020 2020 2020  l_parts:.       
-00002dd0: 206e 6f72 6d61 6c5f 7061 7274 732e 696e   normal_parts.in
-00002de0: 7365 7274 2830 2c20 2273 333a 2f22 290a  sert(0, "s3:/").
-00002df0: 2020 2020 656c 6966 2068 6173 5f70 726f      elif has_pro
-00002e00: 746f 636f 6c3a 0a20 2020 2020 2020 206d  tocol:.        m
-00002e10: 6167 6963 5f70 6172 7473 2e69 6e73 6572  agic_parts.inser
-00002e20: 7428 302c 2022 7333 3a2f 2229 0a0a 2020  t(0, "s3:/")..  
-00002e30: 2020 6966 2068 6173 5f64 656c 696d 6974    if has_delimit
-00002e40: 6572 2061 6e64 206d 6167 6963 5f70 6172  er and magic_par
-00002e50: 7473 3a0a 2020 2020 2020 2020 6d61 6769  ts:.        magi
-00002e60: 635f 7061 7274 732e 6170 7065 6e64 2822  c_parts.append("
-00002e70: 2229 0a20 2020 2065 6c69 6620 6861 735f  ").    elif has_
-00002e80: 6465 6c69 6d69 7465 723a 0a20 2020 2020  delimiter:.     
-00002e90: 2020 206e 6f72 6d61 6c5f 7061 7274 732e     normal_parts.
-00002ea0: 6170 7065 6e64 2822 2229 0a0a 2020 2020  append("")..    
-00002eb0: 7265 7475 726e 2022 2f22 2e6a 6f69 6e28  return "/".join(
-00002ec0: 6e6f 726d 616c 5f70 6172 7473 292c 2022  normal_parts), "
-00002ed0: 2f22 2e6a 6f69 6e28 6d61 6769 635f 7061  /".join(magic_pa
-00002ee0: 7274 7329 0a0a 0a64 6566 205f 6772 6f75  rts)...def _grou
-00002ef0: 705f 7333 7061 7468 5f62 795f 7072 6566  p_s3path_by_pref
-00002f00: 6978 2873 335f 7061 7468 6e61 6d65 3a20  ix(s3_pathname: 
-00002f10: 7374 7229 202d 3e20 4c69 7374 5b73 7472  str) -> List[str
-00002f20: 5d3a 0a0a 2020 2020 5f2c 206b 6579 203d  ]:..    _, key =
-00002f30: 2070 6172 7365 5f73 335f 7572 6c28 7333   parse_s3_url(s3
-00002f40: 5f70 6174 686e 616d 6529 0a20 2020 2069  _pathname).    i
-00002f50: 6620 6e6f 7420 6b65 793a 0a20 2020 2020  f not key:.     
-00002f60: 2020 2072 6574 7572 6e20 756e 676c 6f62     return unglob
-00002f70: 6c69 7a65 2873 335f 7061 7468 6e61 6d65  lize(s3_pathname
-00002f80: 290a 0a20 2020 2074 6f70 5f64 6972 2c20  )..    top_dir, 
-00002f90: 6d61 6769 635f 7061 7274 203d 205f 7333  magic_part = _s3
-00002fa0: 5f73 706c 6974 5f6d 6167 6963 5f69 676e  _split_magic_ign
-00002fb0: 6f72 655f 6272 6163 6528 7333 5f70 6174  ore_brace(s3_pat
-00002fc0: 686e 616d 6529 0a20 2020 2069 6620 6e6f  hname).    if no
-00002fd0: 7420 746f 705f 6469 723a 0a20 2020 2020  t top_dir:.     
-00002fe0: 2020 2072 6574 7572 6e20 5b6d 6167 6963     return [magic
-00002ff0: 5f70 6172 745d 0a20 2020 2067 726f 7570  _part].    group
-00003000: 6564 5f70 6174 6820 3d20 5b5d 0a20 2020  ed_path = [].   
-00003010: 2066 6f72 2070 6174 686e 616d 6520 696e   for pathname in
-00003020: 2075 6e67 6c6f 626c 697a 6528 746f 705f   ungloblize(top_
-00003030: 6469 7229 3a0a 2020 2020 2020 2020 6966  dir):.        if
-00003040: 206d 6167 6963 5f70 6172 743a 0a20 2020   magic_part:.   
-00003050: 2020 2020 2020 2020 2070 6174 686e 616d           pathnam
-00003060: 6520 3d20 222f 222e 6a6f 696e 285b 7061  e = "/".join([pa
-00003070: 7468 6e61 6d65 2c20 6d61 6769 635f 7061  thname, magic_pa
-00003080: 7274 5d29 0a20 2020 2020 2020 2067 726f  rt]).        gro
-00003090: 7570 6564 5f70 6174 682e 6170 7065 6e64  uped_path.append
-000030a0: 2870 6174 686e 616d 6529 0a20 2020 2072  (pathname).    r
-000030b0: 6574 7572 6e20 6772 6f75 7065 645f 7061  eturn grouped_pa
-000030c0: 7468 0a0a 0a64 6566 205f 6265 636f 6d65  th...def _become
-000030d0: 5f70 7265 6669 7828 7072 6566 6978 3a20  _prefix(prefix: 
-000030e0: 7374 7229 202d 3e20 7374 723a 0a20 2020  str) -> str:.   
-000030f0: 2069 6620 7072 6566 6978 2021 3d20 2727   if prefix != ''
-00003100: 2061 6e64 206e 6f74 2070 7265 6669 782e   and not prefix.
-00003110: 656e 6473 7769 7468 2827 2f27 293a 0a20  endswith('/'):. 
-00003120: 2020 2020 2020 2070 7265 6669 7820 2b3d         prefix +=
-00003130: 2027 2f27 0a20 2020 2072 6574 7572 6e20   '/'.    return 
-00003140: 7072 6566 6978 0a0a 0a64 6566 205f 7333  prefix...def _s3
-00003150: 5f73 706c 6974 5f6d 6167 6963 2873 335f  _split_magic(s3_
-00003160: 7061 7468 6e61 6d65 3a20 7374 7229 202d  pathname: str) -
-00003170: 3e20 5475 706c 655b 7374 722c 2073 7472  > Tuple[str, str
-00003180: 5d3a 0a20 2020 2069 6620 6e6f 7420 6861  ]:.    if not ha
-00003190: 735f 6d61 6769 6328 7333 5f70 6174 686e  s_magic(s3_pathn
-000031a0: 616d 6529 3a0a 2020 2020 2020 2020 7265  ame):.        re
-000031b0: 7475 726e 2073 335f 7061 7468 6e61 6d65  turn s3_pathname
-000031c0: 2c20 2727 0a20 2020 2064 656c 696d 6974  , ''.    delimit
-000031d0: 6572 203d 2027 2f27 0a20 2020 206e 6f72  er = '/'.    nor
-000031e0: 6d61 6c5f 7061 7274 7320 3d20 5b5d 0a20  mal_parts = []. 
-000031f0: 2020 206d 6167 6963 5f70 6172 7473 203d     magic_parts =
-00003200: 205b 5d0a 2020 2020 616c 6c5f 7061 7274   [].    all_part
-00003210: 7320 3d20 7333 5f70 6174 686e 616d 652e  s = s3_pathname.
-00003220: 7370 6c69 7428 6465 6c69 6d69 7465 7229  split(delimiter)
-00003230: 0a20 2020 2066 6f72 2069 2c20 7061 7274  .    for i, part
-00003240: 2069 6e20 656e 756d 6572 6174 6528 616c   in enumerate(al
-00003250: 6c5f 7061 7274 7329 3a0a 2020 2020 2020  l_parts):.      
-00003260: 2020 6966 206e 6f74 2068 6173 5f6d 6167    if not has_mag
-00003270: 6963 2870 6172 7429 3a0a 2020 2020 2020  ic(part):.      
-00003280: 2020 2020 2020 6e6f 726d 616c 5f70 6172        normal_par
-00003290: 7473 2e61 7070 656e 6428 7061 7274 290a  ts.append(part).
-000032a0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000032b0: 2020 2020 2020 2020 2020 6d61 6769 635f            magic_
-000032c0: 7061 7274 7320 3d20 616c 6c5f 7061 7274  parts = all_part
-000032d0: 735b 693a 5d0a 2020 2020 2020 2020 2020  s[i:].          
-000032e0: 2020 6272 6561 6b0a 2020 2020 7265 7475    break.    retu
-000032f0: 726e 2064 656c 696d 6974 6572 2e6a 6f69  rn delimiter.joi
-00003300: 6e28 6e6f 726d 616c 5f70 6172 7473 292c  n(normal_parts),
-00003310: 2064 656c 696d 6974 6572 2e6a 6f69 6e28   delimiter.join(
-00003320: 6d61 6769 635f 7061 7274 7329 0a0a 0a64  magic_parts)...d
-00003330: 6566 205f 6c69 7374 5f6f 626a 6563 7473  ef _list_objects
-00003340: 5f72 6563 7572 7369 7665 280a 2020 2020  _recursive(.    
-00003350: 2020 2020 7333 5f63 6c69 656e 742c 2062      s3_client, b
-00003360: 7563 6b65 743a 2073 7472 2c20 7072 6566  ucket: str, pref
-00003370: 6978 3a20 7374 722c 2064 656c 696d 6974  ix: str, delimit
-00003380: 6572 3a20 7374 7220 3d20 2727 293a 0a0a  er: str = ''):..
-00003390: 2020 2020 7265 7370 203d 2073 335f 636c      resp = s3_cl
-000033a0: 6965 6e74 2e6c 6973 745f 6f62 6a65 6374  ient.list_object
-000033b0: 735f 7632 280a 2020 2020 2020 2020 4275  s_v2(.        Bu
-000033c0: 636b 6574 3d62 7563 6b65 742c 2050 7265  cket=bucket, Pre
-000033d0: 6669 783d 7072 6566 6978 2c20 4465 6c69  fix=prefix, Deli
-000033e0: 6d69 7465 723d 6465 6c69 6d69 7465 722c  miter=delimiter,
-000033f0: 204d 6178 4b65 7973 3d6d 6178 5f6b 6579   MaxKeys=max_key
-00003400: 7329 0a0a 2020 2020 7768 696c 6520 5472  s)..    while Tr
-00003410: 7565 3a0a 2020 2020 2020 2020 7969 656c  ue:.        yiel
-00003420: 6420 7265 7370 0a0a 2020 2020 2020 2020  d resp..        
-00003430: 6966 206e 6f74 2072 6573 705b 2749 7354  if not resp['IsT
-00003440: 7275 6e63 6174 6564 275d 3a0a 2020 2020  runcated']:.    
-00003450: 2020 2020 2020 2020 6272 6561 6b0a 0a20          break.. 
-00003460: 2020 2020 2020 2072 6573 7020 3d20 7333         resp = s3
-00003470: 5f63 6c69 656e 742e 6c69 7374 5f6f 626a  _client.list_obj
-00003480: 6563 7473 5f76 3228 0a20 2020 2020 2020  ects_v2(.       
-00003490: 2020 2020 2042 7563 6b65 743d 6275 636b       Bucket=buck
-000034a0: 6574 2c0a 2020 2020 2020 2020 2020 2020  et,.            
-000034b0: 5072 6566 6978 3d70 7265 6669 782c 0a20  Prefix=prefix,. 
-000034c0: 2020 2020 2020 2020 2020 2044 656c 696d             Delim
-000034d0: 6974 6572 3d64 656c 696d 6974 6572 2c0a  iter=delimiter,.
-000034e0: 2020 2020 2020 2020 2020 2020 436f 6e74              Cont
-000034f0: 696e 7561 7469 6f6e 546f 6b65 6e3d 7265  inuationToken=re
-00003500: 7370 5b27 4e65 7874 436f 6e74 696e 7561  sp['NextContinua
-00003510: 7469 6f6e 546f 6b65 6e27 5d2c 0a20 2020  tionToken'],.   
-00003520: 2020 2020 2020 2020 204d 6178 4b65 7973           MaxKeys
-00003530: 3d6d 6178 5f6b 6579 7329 0a0a 0a64 6566  =max_keys)...def
-00003540: 205f 6d61 6b65 5f73 7461 7428 636f 6e74   _make_stat(cont
-00003550: 656e 743a 2044 6963 745b 7374 722c 2041  ent: Dict[str, A
-00003560: 6e79 5d29 3a0a 2020 2020 7265 7475 726e  ny]):.    return
-00003570: 2053 7461 7452 6573 756c 7428 0a20 2020   StatResult(.   
-00003580: 2020 2020 2069 736c 6e6b 3d63 6f6e 7465       islnk=conte
-00003590: 6e74 2e67 6574 2827 6973 6c6e 6b27 2c20  nt.get('islnk', 
-000035a0: 4661 6c73 6529 2c0a 2020 2020 2020 2020  False),.        
-000035b0: 7369 7a65 3d63 6f6e 7465 6e74 5b27 5369  size=content['Si
-000035c0: 7a65 275d 2c0a 2020 2020 2020 2020 6d74  ze'],.        mt
-000035d0: 696d 653d 636f 6e74 656e 745b 274c 6173  ime=content['Las
-000035e0: 744d 6f64 6966 6965 6427 5d2e 7469 6d65  tModified'].time
-000035f0: 7374 616d 7028 292c 0a20 2020 2020 2020  stamp(),.       
-00003600: 2065 7874 7261 3d63 6f6e 7465 6e74 2c0a   extra=content,.
-00003610: 2020 2020 290a 0a0a 6465 6620 5f73 335f      )...def _s3_
-00003620: 676c 6f62 5f73 7461 745f 7369 6e67 6c65  glob_stat_single
-00003630: 5f70 6174 6828 0a20 2020 2020 2020 2073  _path(.        s
-00003640: 335f 7061 7468 6e61 6d65 3a20 5061 7468  3_pathname: Path
-00003650: 4c69 6b65 2c0a 2020 2020 2020 2020 7265  Like,.        re
-00003660: 6375 7273 6976 653a 2062 6f6f 6c20 3d20  cursive: bool = 
-00003670: 5472 7565 2c0a 2020 2020 2020 2020 6d69  True,.        mi
-00003680: 7373 696e 675f 6f6b 3a20 626f 6f6c 203d  ssing_ok: bool =
-00003690: 2054 7275 652c 0a20 2020 2020 2020 2066   True,.        f
-000036a0: 6f6c 6c6f 776c 696e 6b73 3a20 626f 6f6c  ollowlinks: bool
-000036b0: 203d 2046 616c 7365 2c0a 2020 2020 2020   = False,.      
-000036c0: 2020 7072 6f66 696c 655f 6e61 6d65 3a20    profile_name: 
-000036d0: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
-000036e0: 4e6f 6e65 2920 2d3e 2049 7465 7261 746f  None) -> Iterato
-000036f0: 725b 4669 6c65 456e 7472 795d 3a0a 2020  r[FileEntry]:.  
-00003700: 2020 6966 206e 6f74 2072 6563 7572 7369    if not recursi
-00003710: 7665 3a0a 2020 2020 2020 2020 2320 4966  ve:.        # If
-00003720: 206e 6f74 2072 6563 7572 7369 7665 2c20   not recursive, 
-00003730: 7265 706c 6163 6520 2a2a 2077 6974 6820  replace ** with 
-00003740: 2a0a 2020 2020 2020 2020 7333 5f70 6174  *.        s3_pat
-00003750: 686e 616d 6520 3d20 7265 2e73 7562 2872  hname = re.sub(r
-00003760: 275c 2a7b 322c 7d27 2c20 272a 272c 2073  '\*{2,}', '*', s
-00003770: 335f 7061 7468 6e61 6d65 290a 2020 2020  3_pathname).    
-00003780: 746f 705f 6469 722c 2077 696c 6463 6172  top_dir, wildcar
-00003790: 645f 7061 7274 203d 205f 7333 5f73 706c  d_part = _s3_spl
-000037a0: 6974 5f6d 6167 6963 2873 335f 7061 7468  it_magic(s3_path
-000037b0: 6e61 6d65 290a 2020 2020 7365 6172 6368  name).    search
-000037c0: 5f64 6972 203d 2077 696c 6463 6172 645f  _dir = wildcard_
-000037d0: 7061 7274 2e65 6e64 7377 6974 6828 272f  part.endswith('/
-000037e0: 2729 0a0a 2020 2020 6465 6620 7368 6f75  ')..    def shou
-000037f0: 6c64 5f72 6563 7572 7369 7665 2877 696c  ld_recursive(wil
-00003800: 6463 6172 645f 7061 7274 3a20 7374 7229  dcard_part: str)
-00003810: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
-00003820: 2020 6966 2027 2a2a 2720 696e 2077 696c    if '**' in wil
-00003830: 6463 6172 645f 7061 7274 3a0a 2020 2020  dcard_part:.    
-00003840: 2020 2020 2020 2020 7265 7475 726e 2054          return T
-00003850: 7275 650a 2020 2020 2020 2020 666f 7220  rue.        for 
-00003860: 6578 7061 6e64 6564 5f70 6174 6820 696e  expanded_path in
-00003870: 2075 6e67 6c6f 626c 697a 6528 7769 6c64   ungloblize(wild
-00003880: 6361 7264 5f70 6172 7429 3a0a 2020 2020  card_part):.    
-00003890: 2020 2020 2020 2020 7061 7274 735f 6c65          parts_le
-000038a0: 6e67 7468 203d 206c 656e 2865 7870 616e  ngth = len(expan
-000038b0: 6465 645f 7061 7468 2e73 706c 6974 2827  ded_path.split('
-000038c0: 2f27 2929 0a20 2020 2020 2020 2020 2020  /')).           
-000038d0: 2069 6620 7061 7274 735f 6c65 6e67 7468   if parts_length
-000038e0: 202b 2073 6561 7263 685f 6469 7220 3e3d   + search_dir >=
-000038f0: 2032 3a0a 2020 2020 2020 2020 2020 2020   2:.            
-00003900: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
-00003910: 2020 2020 2020 2020 7265 7475 726e 2046          return F
-00003920: 616c 7365 0a0a 2020 2020 6465 6620 6372  alse..    def cr
-00003930: 6561 7465 5f67 656e 6572 6174 6f72 285f  eate_generator(_
-00003940: 7333 5f70 6174 686e 616d 6529 202d 3e20  s3_pathname) -> 
-00003950: 4974 6572 6174 6f72 5b46 696c 6545 6e74  Iterator[FileEnt
-00003960: 7279 5d3a 0a20 2020 2020 2020 2069 6620  ry]:.        if 
-00003970: 6e6f 7420 5333 5061 7468 2874 6f70 5f64  not S3Path(top_d
-00003980: 6972 292e 6578 6973 7473 2829 3a0a 2020  ir).exists():.  
-00003990: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000039a0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-000039b0: 6861 735f 6d61 6769 6328 5f73 335f 7061  has_magic(_s3_pa
-000039c0: 7468 6e61 6d65 293a 0a20 2020 2020 2020  thname):.       
-000039d0: 2020 2020 205f 7333 5f70 6174 686e 616d       _s3_pathnam
-000039e0: 655f 6f62 6a20 3d20 5333 5061 7468 285f  e_obj = S3Path(_
-000039f0: 7333 5f70 6174 686e 616d 6529 0a20 2020  s3_pathname).   
-00003a00: 2020 2020 2020 2020 2069 6620 5f73 335f           if _s3_
-00003a10: 7061 7468 6e61 6d65 5f6f 626a 2e69 735f  pathname_obj.is_
-00003a20: 6669 6c65 2829 3a0a 2020 2020 2020 2020  file():.        
-00003a30: 2020 2020 2020 2020 7374 6174 203d 2053          stat = S
-00003a40: 3350 6174 6828 5f73 335f 7061 7468 6e61  3Path(_s3_pathna
-00003a50: 6d65 292e 7374 6174 2866 6f6c 6c6f 775f  me).stat(follow_
-00003a60: 7379 6d6c 696e 6b73 3d66 6f6c 6c6f 776c  symlinks=followl
-00003a70: 696e 6b73 290a 2020 2020 2020 2020 2020  inks).          
-00003a80: 2020 2020 2020 7969 656c 6420 4669 6c65        yield File
-00003a90: 456e 7472 7928 0a20 2020 2020 2020 2020  Entry(.         
-00003aa0: 2020 2020 2020 2020 2020 205f 7333 5f70             _s3_p
-00003ab0: 6174 686e 616d 655f 6f62 6a2e 6e61 6d65  athname_obj.name
-00003ac0: 2c20 5f73 335f 7061 7468 6e61 6d65 5f6f  , _s3_pathname_o
-00003ad0: 626a 2e70 6174 682c 2073 7461 7429 0a20  bj.path, stat). 
-00003ae0: 2020 2020 2020 2020 2020 2069 6620 5f73             if _s
-00003af0: 335f 7061 7468 6e61 6d65 5f6f 626a 2e69  3_pathname_obj.i
-00003b00: 735f 6469 7228 293a 0a20 2020 2020 2020  s_dir():.       
-00003b10: 2020 2020 2020 2020 2079 6965 6c64 2046           yield F
-00003b20: 696c 6545 6e74 7279 280a 2020 2020 2020  ileEntry(.      
-00003b30: 2020 2020 2020 2020 2020 2020 2020 5f73                _s
-00003b40: 335f 7061 7468 6e61 6d65 5f6f 626a 2e6e  3_pathname_obj.n
-00003b50: 616d 652c 205f 7333 5f70 6174 686e 616d  ame, _s3_pathnam
-00003b60: 655f 6f62 6a2e 7061 7468 2c0a 2020 2020  e_obj.path,.    
-00003b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003b80: 5374 6174 5265 7375 6c74 2869 7364 6972  StatResult(isdir
-00003b90: 3d54 7275 6529 290a 2020 2020 2020 2020  =True)).        
-00003ba0: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-00003bb0: 2020 2020 6465 6c69 6d69 7465 7220 3d20      delimiter = 
-00003bc0: 2727 0a20 2020 2020 2020 2069 6620 6e6f  ''.        if no
-00003bd0: 7420 7368 6f75 6c64 5f72 6563 7572 7369  t should_recursi
-00003be0: 7665 2877 696c 6463 6172 645f 7061 7274  ve(wildcard_part
-00003bf0: 293a 0a20 2020 2020 2020 2020 2020 2064  ):.            d
-00003c00: 656c 696d 6974 6572 203d 2027 2f27 0a0a  elimiter = '/'..
-00003c10: 2020 2020 2020 2020 6469 726e 616d 6573          dirnames
-00003c20: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
-00003c30: 2070 6174 7465 726e 203d 2072 652e 636f   pattern = re.co
-00003c40: 6d70 696c 6528 7472 616e 736c 6174 6528  mpile(translate(
-00003c50: 5f73 335f 7061 7468 6e61 6d65 2929 0a20  _s3_pathname)). 
-00003c60: 2020 2020 2020 2062 7563 6b65 742c 206b         bucket, k
-00003c70: 6579 203d 2070 6172 7365 5f73 335f 7572  ey = parse_s3_ur
-00003c80: 6c28 746f 705f 6469 7229 0a20 2020 2020  l(top_dir).     
-00003c90: 2020 2070 7265 6669 7820 3d20 5f62 6563     prefix = _bec
-00003ca0: 6f6d 655f 7072 6566 6978 286b 6579 290a  ome_prefix(key).
-00003cb0: 2020 2020 2020 2020 636c 6965 6e74 203d          client =
-00003cc0: 2067 6574 5f73 335f 636c 6965 6e74 2870   get_s3_client(p
-00003cd0: 726f 6669 6c65 5f6e 616d 653d 7072 6f66  rofile_name=prof
-00003ce0: 696c 655f 6e61 6d65 290a 2020 2020 2020  ile_name).      
-00003cf0: 2020 7769 7468 2072 6169 7365 5f73 335f    with raise_s3_
-00003d00: 6572 726f 7228 5f73 335f 7061 7468 6e61  error(_s3_pathna
-00003d10: 6d65 293a 0a20 2020 2020 2020 2020 2020  me):.           
-00003d20: 2066 6f72 2072 6573 7020 696e 205f 6c69   for resp in _li
-00003d30: 7374 5f6f 626a 6563 7473 5f72 6563 7572  st_objects_recur
-00003d40: 7369 7665 2863 6c69 656e 742c 2062 7563  sive(client, buc
-00003d50: 6b65 742c 2070 7265 6669 782c 0a20 2020  ket, prefix,.   
-00003d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003d80: 2020 2020 2020 2020 2020 2020 2064 656c               del
-00003d90: 696d 6974 6572 293a 0a20 2020 2020 2020  imiter):.       
-00003da0: 2020 2020 2020 2020 2066 6f72 2063 6f6e           for con
-00003db0: 7465 6e74 2069 6e20 7265 7370 2e67 6574  tent in resp.get
-00003dc0: 2827 436f 6e74 656e 7473 272c 205b 5d29  ('Contents', [])
-00003dd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00003de0: 2020 2020 2020 7061 7468 203d 2073 335f        path = s3_
-00003df0: 7061 7468 5f6a 6f69 6e28 2773 333a 2f2f  path_join('s3://
-00003e00: 272c 2062 7563 6b65 742c 2063 6f6e 7465  ', bucket, conte
-00003e10: 6e74 5b27 4b65 7927 5d29 0a20 2020 2020  nt['Key']).     
-00003e20: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00003e30: 6620 6e6f 7420 7365 6172 6368 5f64 6972  f not search_dir
-00003e40: 2061 6e64 2070 6174 7465 726e 2e6d 6174   and pattern.mat
-00003e50: 6368 2870 6174 6829 3a0a 2020 2020 2020  ch(path):.      
-00003e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003e70: 2020 7969 656c 6420 4669 6c65 456e 7472    yield FileEntr
-00003e80: 7928 0a20 2020 2020 2020 2020 2020 2020  y(.             
-00003e90: 2020 2020 2020 2020 2020 2020 2020 2053                 S
-00003ea0: 3350 6174 6828 7061 7468 292e 6e61 6d65  3Path(path).name
-00003eb0: 2c20 7061 7468 2c20 5f6d 616b 655f 7374  , path, _make_st
-00003ec0: 6174 2863 6f6e 7465 6e74 2929 0a20 2020  at(content)).   
-00003ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003ee0: 2064 6972 6e61 6d65 203d 206f 732e 7061   dirname = os.pa
-00003ef0: 7468 2e64 6972 6e61 6d65 2870 6174 6829  th.dirname(path)
-00003f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003f10: 2020 2020 2077 6869 6c65 2064 6972 6e61       while dirna
-00003f20: 6d65 206e 6f74 2069 6e20 6469 726e 616d  me not in dirnam
-00003f30: 6573 2061 6e64 2064 6972 6e61 6d65 2021  es and dirname !
-00003f40: 3d20 746f 705f 6469 723a 0a20 2020 2020  = top_dir:.     
-00003f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003f60: 2020 2064 6972 6e61 6d65 732e 6164 6428     dirnames.add(
-00003f70: 6469 726e 616d 6529 0a20 2020 2020 2020  dirname).       
+00002c70: 6272 6163 6520 3d20 4661 6c73 650a 2020  brace = False.  
+00002c80: 2020 6966 2073 335f 7061 7468 6e61 6d65    if s3_pathname
+00002c90: 5b6c 6566 745f 696e 6465 783a 5d3a 0a20  [left_index:]:. 
+00002ca0: 2020 2020 2020 2069 6620 6861 735f 6d61         if has_ma
+00002cb0: 6769 635f 6967 6e6f 7265 5f62 7261 6365  gic_ignore_brace
+00002cc0: 2873 335f 7061 7468 6e61 6d65 5b6c 6566  (s3_pathname[lef
+00002cd0: 745f 696e 6465 783a 5d29 3a0a 2020 2020  t_index:]):.    
+00002ce0: 2020 2020 2020 2020 6d61 6769 635f 7061          magic_pa
+00002cf0: 7274 732e 6170 7065 6e64 2873 335f 7061  rts.append(s3_pa
+00002d00: 7468 6e61 6d65 5b6c 6566 745f 696e 6465  thname[left_inde
+00002d10: 783a 5d29 0a20 2020 2020 2020 2065 6c73  x:]).        els
+00002d20: 653a 0a20 2020 2020 2020 2020 2020 206e  e:.            n
+00002d30: 6f72 6d61 6c5f 7061 7274 732e 6170 7065  ormal_parts.appe
+00002d40: 6e64 2873 335f 7061 7468 6e61 6d65 5b6c  nd(s3_pathname[l
+00002d50: 6566 745f 696e 6465 783a 5d29 0a0a 2020  eft_index:])..  
+00002d60: 2020 6966 2068 6173 5f70 726f 746f 636f    if has_protoco
+00002d70: 6c20 616e 6420 6e6f 726d 616c 5f70 6172  l and normal_par
+00002d80: 7473 3a0a 2020 2020 2020 2020 6e6f 726d  ts:.        norm
+00002d90: 616c 5f70 6172 7473 2e69 6e73 6572 7428  al_parts.insert(
+00002da0: 302c 2022 7333 3a2f 2229 0a20 2020 2065  0, "s3:/").    e
+00002db0: 6c69 6620 6861 735f 7072 6f74 6f63 6f6c  lif has_protocol
+00002dc0: 3a0a 2020 2020 2020 2020 6d61 6769 635f  :.        magic_
+00002dd0: 7061 7274 732e 696e 7365 7274 2830 2c20  parts.insert(0, 
+00002de0: 2273 333a 2f22 290a 0a20 2020 2069 6620  "s3:/")..    if 
+00002df0: 6861 735f 6465 6c69 6d69 7465 7220 616e  has_delimiter an
+00002e00: 6420 6d61 6769 635f 7061 7274 733a 0a20  d magic_parts:. 
+00002e10: 2020 2020 2020 206d 6167 6963 5f70 6172         magic_par
+00002e20: 7473 2e61 7070 656e 6428 2222 290a 2020  ts.append("").  
+00002e30: 2020 656c 6966 2068 6173 5f64 656c 696d    elif has_delim
+00002e40: 6974 6572 3a0a 2020 2020 2020 2020 6e6f  iter:.        no
+00002e50: 726d 616c 5f70 6172 7473 2e61 7070 656e  rmal_parts.appen
+00002e60: 6428 2222 290a 0a20 2020 2072 6574 7572  d("")..    retur
+00002e70: 6e20 222f 222e 6a6f 696e 286e 6f72 6d61  n "/".join(norma
+00002e80: 6c5f 7061 7274 7329 2c20 222f 222e 6a6f  l_parts), "/".jo
+00002e90: 696e 286d 6167 6963 5f70 6172 7473 290a  in(magic_parts).
+00002ea0: 0a0a 6465 6620 5f67 726f 7570 5f73 3370  ..def _group_s3p
+00002eb0: 6174 685f 6279 5f70 7265 6669 7828 7333  ath_by_prefix(s3
+00002ec0: 5f70 6174 686e 616d 653a 2073 7472 2920  _pathname: str) 
+00002ed0: 2d3e 204c 6973 745b 7374 725d 3a0a 0a20  -> List[str]:.. 
+00002ee0: 2020 205f 2c20 6b65 7920 3d20 7061 7273     _, key = pars
+00002ef0: 655f 7333 5f75 726c 2873 335f 7061 7468  e_s3_url(s3_path
+00002f00: 6e61 6d65 290a 2020 2020 6966 206e 6f74  name).    if not
+00002f10: 206b 6579 3a0a 2020 2020 2020 2020 7265   key:.        re
+00002f20: 7475 726e 2075 6e67 6c6f 626c 697a 6528  turn ungloblize(
+00002f30: 7333 5f70 6174 686e 616d 6529 0a0a 2020  s3_pathname)..  
+00002f40: 2020 746f 705f 6469 722c 206d 6167 6963    top_dir, magic
+00002f50: 5f70 6172 7420 3d20 5f73 335f 7370 6c69  _part = _s3_spli
+00002f60: 745f 6d61 6769 635f 6967 6e6f 7265 5f62  t_magic_ignore_b
+00002f70: 7261 6365 2873 335f 7061 7468 6e61 6d65  race(s3_pathname
+00002f80: 290a 2020 2020 6966 206e 6f74 2074 6f70  ).    if not top
+00002f90: 5f64 6972 3a0a 2020 2020 2020 2020 7265  _dir:.        re
+00002fa0: 7475 726e 205b 6d61 6769 635f 7061 7274  turn [magic_part
+00002fb0: 5d0a 2020 2020 6772 6f75 7065 645f 7061  ].    grouped_pa
+00002fc0: 7468 203d 205b 5d0a 2020 2020 666f 7220  th = [].    for 
+00002fd0: 7061 7468 6e61 6d65 2069 6e20 756e 676c  pathname in ungl
+00002fe0: 6f62 6c69 7a65 2874 6f70 5f64 6972 293a  oblize(top_dir):
+00002ff0: 0a20 2020 2020 2020 2069 6620 6d61 6769  .        if magi
+00003000: 635f 7061 7274 3a0a 2020 2020 2020 2020  c_part:.        
+00003010: 2020 2020 7061 7468 6e61 6d65 203d 2022      pathname = "
+00003020: 2f22 2e6a 6f69 6e28 5b70 6174 686e 616d  /".join([pathnam
+00003030: 652c 206d 6167 6963 5f70 6172 745d 290a  e, magic_part]).
+00003040: 2020 2020 2020 2020 6772 6f75 7065 645f          grouped_
+00003050: 7061 7468 2e61 7070 656e 6428 7061 7468  path.append(path
+00003060: 6e61 6d65 290a 2020 2020 7265 7475 726e  name).    return
+00003070: 2067 726f 7570 6564 5f70 6174 680a 0a0a   grouped_path...
+00003080: 6465 6620 5f62 6563 6f6d 655f 7072 6566  def _become_pref
+00003090: 6978 2870 7265 6669 783a 2073 7472 2920  ix(prefix: str) 
+000030a0: 2d3e 2073 7472 3a0a 2020 2020 6966 2070  -> str:.    if p
+000030b0: 7265 6669 7820 213d 2027 2720 616e 6420  refix != '' and 
+000030c0: 6e6f 7420 7072 6566 6978 2e65 6e64 7377  not prefix.endsw
+000030d0: 6974 6828 272f 2729 3a0a 2020 2020 2020  ith('/'):.      
+000030e0: 2020 7072 6566 6978 202b 3d20 272f 270a    prefix += '/'.
+000030f0: 2020 2020 7265 7475 726e 2070 7265 6669      return prefi
+00003100: 780a 0a0a 6465 6620 5f73 335f 7370 6c69  x...def _s3_spli
+00003110: 745f 6d61 6769 6328 7333 5f70 6174 686e  t_magic(s3_pathn
+00003120: 616d 653a 2073 7472 2920 2d3e 2054 7570  ame: str) -> Tup
+00003130: 6c65 5b73 7472 2c20 7374 725d 3a0a 2020  le[str, str]:.  
+00003140: 2020 6966 206e 6f74 2068 6173 5f6d 6167    if not has_mag
+00003150: 6963 2873 335f 7061 7468 6e61 6d65 293a  ic(s3_pathname):
+00003160: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00003170: 7333 5f70 6174 686e 616d 652c 2027 270a  s3_pathname, ''.
+00003180: 2020 2020 6465 6c69 6d69 7465 7220 3d20      delimiter = 
+00003190: 272f 270a 2020 2020 6e6f 726d 616c 5f70  '/'.    normal_p
+000031a0: 6172 7473 203d 205b 5d0a 2020 2020 6d61  arts = [].    ma
+000031b0: 6769 635f 7061 7274 7320 3d20 5b5d 0a20  gic_parts = []. 
+000031c0: 2020 2061 6c6c 5f70 6172 7473 203d 2073     all_parts = s
+000031d0: 335f 7061 7468 6e61 6d65 2e73 706c 6974  3_pathname.split
+000031e0: 2864 656c 696d 6974 6572 290a 2020 2020  (delimiter).    
+000031f0: 666f 7220 692c 2070 6172 7420 696e 2065  for i, part in e
+00003200: 6e75 6d65 7261 7465 2861 6c6c 5f70 6172  numerate(all_par
+00003210: 7473 293a 0a20 2020 2020 2020 2069 6620  ts):.        if 
+00003220: 6e6f 7420 6861 735f 6d61 6769 6328 7061  not has_magic(pa
+00003230: 7274 293a 0a20 2020 2020 2020 2020 2020  rt):.           
+00003240: 206e 6f72 6d61 6c5f 7061 7274 732e 6170   normal_parts.ap
+00003250: 7065 6e64 2870 6172 7429 0a20 2020 2020  pend(part).     
+00003260: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00003270: 2020 2020 206d 6167 6963 5f70 6172 7473       magic_parts
+00003280: 203d 2061 6c6c 5f70 6172 7473 5b69 3a5d   = all_parts[i:]
+00003290: 0a20 2020 2020 2020 2020 2020 2062 7265  .            bre
+000032a0: 616b 0a20 2020 2072 6574 7572 6e20 6465  ak.    return de
+000032b0: 6c69 6d69 7465 722e 6a6f 696e 286e 6f72  limiter.join(nor
+000032c0: 6d61 6c5f 7061 7274 7329 2c20 6465 6c69  mal_parts), deli
+000032d0: 6d69 7465 722e 6a6f 696e 286d 6167 6963  miter.join(magic
+000032e0: 5f70 6172 7473 290a 0a0a 6465 6620 5f6c  _parts)...def _l
+000032f0: 6973 745f 6f62 6a65 6374 735f 7265 6375  ist_objects_recu
+00003300: 7273 6976 6528 0a20 2020 2020 2020 2073  rsive(.        s
+00003310: 335f 636c 6965 6e74 2c20 6275 636b 6574  3_client, bucket
+00003320: 3a20 7374 722c 2070 7265 6669 783a 2073  : str, prefix: s
+00003330: 7472 2c20 6465 6c69 6d69 7465 723a 2073  tr, delimiter: s
+00003340: 7472 203d 2027 2729 3a0a 0a20 2020 2072  tr = ''):..    r
+00003350: 6573 7020 3d20 7333 5f63 6c69 656e 742e  esp = s3_client.
+00003360: 6c69 7374 5f6f 626a 6563 7473 5f76 3228  list_objects_v2(
+00003370: 0a20 2020 2020 2020 2042 7563 6b65 743d  .        Bucket=
+00003380: 6275 636b 6574 2c20 5072 6566 6978 3d70  bucket, Prefix=p
+00003390: 7265 6669 782c 2044 656c 696d 6974 6572  refix, Delimiter
+000033a0: 3d64 656c 696d 6974 6572 2c20 4d61 784b  =delimiter, MaxK
+000033b0: 6579 733d 6d61 785f 6b65 7973 290a 0a20  eys=max_keys).. 
+000033c0: 2020 2077 6869 6c65 2054 7275 653a 0a20     while True:. 
+000033d0: 2020 2020 2020 2079 6965 6c64 2072 6573         yield res
+000033e0: 700a 0a20 2020 2020 2020 2069 6620 6e6f  p..        if no
+000033f0: 7420 7265 7370 5b27 4973 5472 756e 6361  t resp['IsTrunca
+00003400: 7465 6427 5d3a 0a20 2020 2020 2020 2020  ted']:.         
+00003410: 2020 2062 7265 616b 0a0a 2020 2020 2020     break..      
+00003420: 2020 7265 7370 203d 2073 335f 636c 6965    resp = s3_clie
+00003430: 6e74 2e6c 6973 745f 6f62 6a65 6374 735f  nt.list_objects_
+00003440: 7632 280a 2020 2020 2020 2020 2020 2020  v2(.            
+00003450: 4275 636b 6574 3d62 7563 6b65 742c 0a20  Bucket=bucket,. 
+00003460: 2020 2020 2020 2020 2020 2050 7265 6669             Prefi
+00003470: 783d 7072 6566 6978 2c0a 2020 2020 2020  x=prefix,.      
+00003480: 2020 2020 2020 4465 6c69 6d69 7465 723d        Delimiter=
+00003490: 6465 6c69 6d69 7465 722c 0a20 2020 2020  delimiter,.     
+000034a0: 2020 2020 2020 2043 6f6e 7469 6e75 6174         Continuat
+000034b0: 696f 6e54 6f6b 656e 3d72 6573 705b 274e  ionToken=resp['N
+000034c0: 6578 7443 6f6e 7469 6e75 6174 696f 6e54  extContinuationT
+000034d0: 6f6b 656e 275d 2c0a 2020 2020 2020 2020  oken'],.        
+000034e0: 2020 2020 4d61 784b 6579 733d 6d61 785f      MaxKeys=max_
+000034f0: 6b65 7973 290a 0a0a 6465 6620 5f6d 616b  keys)...def _mak
+00003500: 655f 7374 6174 2863 6f6e 7465 6e74 3a20  e_stat(content: 
+00003510: 4469 6374 5b73 7472 2c20 416e 795d 293a  Dict[str, Any]):
+00003520: 0a20 2020 2072 6574 7572 6e20 5374 6174  .    return Stat
+00003530: 5265 7375 6c74 280a 2020 2020 2020 2020  Result(.        
+00003540: 6973 6c6e 6b3d 636f 6e74 656e 742e 6765  islnk=content.ge
+00003550: 7428 2769 736c 6e6b 272c 2046 616c 7365  t('islnk', False
+00003560: 292c 0a20 2020 2020 2020 2073 697a 653d  ),.        size=
+00003570: 636f 6e74 656e 745b 2753 697a 6527 5d2c  content['Size'],
+00003580: 0a20 2020 2020 2020 206d 7469 6d65 3d63  .        mtime=c
+00003590: 6f6e 7465 6e74 5b27 4c61 7374 4d6f 6469  ontent['LastModi
+000035a0: 6669 6564 275d 2e74 696d 6573 7461 6d70  fied'].timestamp
+000035b0: 2829 2c0a 2020 2020 2020 2020 6578 7472  (),.        extr
+000035c0: 613d 636f 6e74 656e 742c 0a20 2020 2029  a=content,.    )
+000035d0: 0a0a 0a64 6566 205f 7333 5f67 6c6f 625f  ...def _s3_glob_
+000035e0: 7374 6174 5f73 696e 676c 655f 7061 7468  stat_single_path
+000035f0: 280a 2020 2020 2020 2020 7333 5f70 6174  (.        s3_pat
+00003600: 686e 616d 653a 2050 6174 684c 696b 652c  hname: PathLike,
+00003610: 0a20 2020 2020 2020 2072 6563 7572 7369  .        recursi
+00003620: 7665 3a20 626f 6f6c 203d 2054 7275 652c  ve: bool = True,
+00003630: 0a20 2020 2020 2020 206d 6973 7369 6e67  .        missing
+00003640: 5f6f 6b3a 2062 6f6f 6c20 3d20 5472 7565  _ok: bool = True
+00003650: 2c0a 2020 2020 2020 2020 666f 6c6c 6f77  ,.        follow
+00003660: 6c69 6e6b 733a 2062 6f6f 6c20 3d20 4661  links: bool = Fa
+00003670: 6c73 652c 0a20 2020 2020 2020 2070 726f  lse,.        pro
+00003680: 6669 6c65 5f6e 616d 653a 204f 7074 696f  file_name: Optio
+00003690: 6e61 6c5b 7374 725d 203d 204e 6f6e 6529  nal[str] = None)
+000036a0: 202d 3e20 4974 6572 6174 6f72 5b46 696c   -> Iterator[Fil
+000036b0: 6545 6e74 7279 5d3a 0a20 2020 2069 6620  eEntry]:.    if 
+000036c0: 6e6f 7420 7265 6375 7273 6976 653a 0a20  not recursive:. 
+000036d0: 2020 2020 2020 2023 2049 6620 6e6f 7420         # If not 
+000036e0: 7265 6375 7273 6976 652c 2072 6570 6c61  recursive, repla
+000036f0: 6365 202a 2a20 7769 7468 202a 0a20 2020  ce ** with *.   
+00003700: 2020 2020 2073 335f 7061 7468 6e61 6d65       s3_pathname
+00003710: 203d 2072 652e 7375 6228 7227 5c2a 7b32   = re.sub(r'\*{2
+00003720: 2c7d 272c 2027 2a27 2c20 7333 5f70 6174  ,}', '*', s3_pat
+00003730: 686e 616d 6529 0a20 2020 2074 6f70 5f64  hname).    top_d
+00003740: 6972 2c20 7769 6c64 6361 7264 5f70 6172  ir, wildcard_par
+00003750: 7420 3d20 5f73 335f 7370 6c69 745f 6d61  t = _s3_split_ma
+00003760: 6769 6328 7333 5f70 6174 686e 616d 6529  gic(s3_pathname)
+00003770: 0a20 2020 2073 6561 7263 685f 6469 7220  .    search_dir 
+00003780: 3d20 7769 6c64 6361 7264 5f70 6172 742e  = wildcard_part.
+00003790: 656e 6473 7769 7468 2827 2f27 290a 0a20  endswith('/').. 
+000037a0: 2020 2064 6566 2073 686f 756c 645f 7265     def should_re
+000037b0: 6375 7273 6976 6528 7769 6c64 6361 7264  cursive(wildcard
+000037c0: 5f70 6172 743a 2073 7472 2920 2d3e 2062  _part: str) -> b
+000037d0: 6f6f 6c3a 0a20 2020 2020 2020 2069 6620  ool:.        if 
+000037e0: 272a 2a27 2069 6e20 7769 6c64 6361 7264  '**' in wildcard
+000037f0: 5f70 6172 743a 0a20 2020 2020 2020 2020  _part:.         
+00003800: 2020 2072 6574 7572 6e20 5472 7565 0a20     return True. 
+00003810: 2020 2020 2020 2066 6f72 2065 7870 616e         for expan
+00003820: 6465 645f 7061 7468 2069 6e20 756e 676c  ded_path in ungl
+00003830: 6f62 6c69 7a65 2877 696c 6463 6172 645f  oblize(wildcard_
+00003840: 7061 7274 293a 0a20 2020 2020 2020 2020  part):.         
+00003850: 2020 2070 6172 7473 5f6c 656e 6774 6820     parts_length 
+00003860: 3d20 6c65 6e28 6578 7061 6e64 6564 5f70  = len(expanded_p
+00003870: 6174 682e 7370 6c69 7428 272f 2729 290a  ath.split('/')).
+00003880: 2020 2020 2020 2020 2020 2020 6966 2070              if p
+00003890: 6172 7473 5f6c 656e 6774 6820 2b20 7365  arts_length + se
+000038a0: 6172 6368 5f64 6972 203e 3d20 323a 0a20  arch_dir >= 2:. 
+000038b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000038c0: 6574 7572 6e20 5472 7565 0a20 2020 2020  eturn True.     
+000038d0: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+000038e0: 0a20 2020 2064 6566 2063 7265 6174 655f  .    def create_
+000038f0: 6765 6e65 7261 746f 7228 5f73 335f 7061  generator(_s3_pa
+00003900: 7468 6e61 6d65 2920 2d3e 2049 7465 7261  thname) -> Itera
+00003910: 746f 725b 4669 6c65 456e 7472 795d 3a0a  tor[FileEntry]:.
+00003920: 2020 2020 2020 2020 6966 206e 6f74 2053          if not S
+00003930: 3350 6174 6828 746f 705f 6469 7229 2e65  3Path(top_dir).e
+00003940: 7869 7374 7328 293a 0a20 2020 2020 2020  xists():.       
+00003950: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+00003960: 2020 2020 6966 206e 6f74 2068 6173 5f6d      if not has_m
+00003970: 6167 6963 285f 7333 5f70 6174 686e 616d  agic(_s3_pathnam
+00003980: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+00003990: 5f73 335f 7061 7468 6e61 6d65 5f6f 626a  _s3_pathname_obj
+000039a0: 203d 2053 3350 6174 6828 5f73 335f 7061   = S3Path(_s3_pa
+000039b0: 7468 6e61 6d65 290a 2020 2020 2020 2020  thname).        
+000039c0: 2020 2020 6966 205f 7333 5f70 6174 686e      if _s3_pathn
+000039d0: 616d 655f 6f62 6a2e 6973 5f66 696c 6528  ame_obj.is_file(
+000039e0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000039f0: 2020 2073 7461 7420 3d20 5333 5061 7468     stat = S3Path
+00003a00: 285f 7333 5f70 6174 686e 616d 6529 2e73  (_s3_pathname).s
+00003a10: 7461 7428 666f 6c6c 6f77 5f73 796d 6c69  tat(follow_symli
+00003a20: 6e6b 733d 666f 6c6c 6f77 6c69 6e6b 7329  nks=followlinks)
+00003a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003a40: 2079 6965 6c64 2046 696c 6545 6e74 7279   yield FileEntry
+00003a50: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00003a60: 2020 2020 2020 5f73 335f 7061 7468 6e61        _s3_pathna
+00003a70: 6d65 5f6f 626a 2e6e 616d 652c 205f 7333  me_obj.name, _s3
+00003a80: 5f70 6174 686e 616d 655f 6f62 6a2e 7061  _pathname_obj.pa
+00003a90: 7468 2c20 7374 6174 290a 2020 2020 2020  th, stat).      
+00003aa0: 2020 2020 2020 6966 205f 7333 5f70 6174        if _s3_pat
+00003ab0: 686e 616d 655f 6f62 6a2e 6973 5f64 6972  hname_obj.is_dir
+00003ac0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00003ad0: 2020 2020 7969 656c 6420 4669 6c65 456e      yield FileEn
+00003ae0: 7472 7928 0a20 2020 2020 2020 2020 2020  try(.           
+00003af0: 2020 2020 2020 2020 205f 7333 5f70 6174           _s3_pat
+00003b00: 686e 616d 655f 6f62 6a2e 6e61 6d65 2c20  hname_obj.name, 
+00003b10: 5f73 335f 7061 7468 6e61 6d65 5f6f 626a  _s3_pathname_obj
+00003b20: 2e70 6174 682c 0a20 2020 2020 2020 2020  .path,.         
+00003b30: 2020 2020 2020 2020 2020 2053 7461 7452             StatR
+00003b40: 6573 756c 7428 6973 6469 723d 5472 7565  esult(isdir=True
+00003b50: 2929 0a20 2020 2020 2020 2020 2020 2072  )).            r
+00003b60: 6574 7572 6e0a 0a20 2020 2020 2020 2064  eturn..        d
+00003b70: 656c 696d 6974 6572 203d 2027 270a 2020  elimiter = ''.  
+00003b80: 2020 2020 2020 6966 206e 6f74 2073 686f        if not sho
+00003b90: 756c 645f 7265 6375 7273 6976 6528 7769  uld_recursive(wi
+00003ba0: 6c64 6361 7264 5f70 6172 7429 3a0a 2020  ldcard_part):.  
+00003bb0: 2020 2020 2020 2020 2020 6465 6c69 6d69            delimi
+00003bc0: 7465 7220 3d20 272f 270a 0a20 2020 2020  ter = '/'..     
+00003bd0: 2020 2064 6972 6e61 6d65 7320 3d20 7365     dirnames = se
+00003be0: 7428 290a 2020 2020 2020 2020 7061 7474  t().        patt
+00003bf0: 6572 6e20 3d20 7265 2e63 6f6d 7069 6c65  ern = re.compile
+00003c00: 2874 7261 6e73 6c61 7465 285f 7333 5f70  (translate(_s3_p
+00003c10: 6174 686e 616d 6529 290a 2020 2020 2020  athname)).      
+00003c20: 2020 6275 636b 6574 2c20 6b65 7920 3d20    bucket, key = 
+00003c30: 7061 7273 655f 7333 5f75 726c 2874 6f70  parse_s3_url(top
+00003c40: 5f64 6972 290a 2020 2020 2020 2020 7072  _dir).        pr
+00003c50: 6566 6978 203d 205f 6265 636f 6d65 5f70  efix = _become_p
+00003c60: 7265 6669 7828 6b65 7929 0a20 2020 2020  refix(key).     
+00003c70: 2020 2063 6c69 656e 7420 3d20 6765 745f     client = get_
+00003c80: 7333 5f63 6c69 656e 7428 7072 6f66 696c  s3_client(profil
+00003c90: 655f 6e61 6d65 3d70 726f 6669 6c65 5f6e  e_name=profile_n
+00003ca0: 616d 6529 0a20 2020 2020 2020 2077 6974  ame).        wit
+00003cb0: 6820 7261 6973 655f 7333 5f65 7272 6f72  h raise_s3_error
+00003cc0: 285f 7333 5f70 6174 686e 616d 6529 3a0a  (_s3_pathname):.
+00003cd0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00003ce0: 7265 7370 2069 6e20 5f6c 6973 745f 6f62  resp in _list_ob
+00003cf0: 6a65 6374 735f 7265 6375 7273 6976 6528  jects_recursive(
+00003d00: 636c 6965 6e74 2c20 6275 636b 6574 2c20  client, bucket, 
+00003d10: 7072 6566 6978 2c0a 2020 2020 2020 2020  prefix,.        
+00003d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003d40: 2020 2020 2020 2020 6465 6c69 6d69 7465          delimite
+00003d50: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00003d60: 2020 2020 666f 7220 636f 6e74 656e 7420      for content 
+00003d70: 696e 2072 6573 702e 6765 7428 2743 6f6e  in resp.get('Con
+00003d80: 7465 6e74 7327 2c20 5b5d 293a 0a20 2020  tents', []):.   
+00003d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003da0: 2070 6174 6820 3d20 7333 5f70 6174 685f   path = s3_path_
+00003db0: 6a6f 696e 2827 7333 3a2f 2f27 2c20 6275  join('s3://', bu
+00003dc0: 636b 6574 2c20 636f 6e74 656e 745b 274b  cket, content['K
+00003dd0: 6579 275d 290a 2020 2020 2020 2020 2020  ey']).          
+00003de0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00003df0: 2073 6561 7263 685f 6469 7220 616e 6420   search_dir and 
+00003e00: 7061 7474 6572 6e2e 6d61 7463 6828 7061  pattern.match(pa
+00003e10: 7468 293a 0a20 2020 2020 2020 2020 2020  th):.           
+00003e20: 2020 2020 2020 2020 2020 2020 2079 6965               yie
+00003e30: 6c64 2046 696c 6545 6e74 7279 280a 2020  ld FileEntry(.  
+00003e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003e50: 2020 2020 2020 2020 2020 5333 5061 7468            S3Path
+00003e60: 2870 6174 6829 2e6e 616d 652c 2070 6174  (path).name, pat
+00003e70: 682c 205f 6d61 6b65 5f73 7461 7428 636f  h, _make_stat(co
+00003e80: 6e74 656e 7429 290a 2020 2020 2020 2020  ntent)).        
+00003e90: 2020 2020 2020 2020 2020 2020 6469 726e              dirn
+00003ea0: 616d 6520 3d20 6f73 2e70 6174 682e 6469  ame = os.path.di
+00003eb0: 726e 616d 6528 7061 7468 290a 2020 2020  rname(path).    
+00003ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003ed0: 7768 696c 6520 6469 726e 616d 6520 6e6f  while dirname no
+00003ee0: 7420 696e 2064 6972 6e61 6d65 7320 616e  t in dirnames an
+00003ef0: 6420 6469 726e 616d 6520 213d 2074 6f70  d dirname != top
+00003f00: 5f64 6972 3a0a 2020 2020 2020 2020 2020  _dir:.          
+00003f10: 2020 2020 2020 2020 2020 2020 2020 6469                di
+00003f20: 726e 616d 6573 2e61 6464 2864 6972 6e61  rnames.add(dirna
+00003f30: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
+00003f40: 2020 2020 2020 2020 2020 2020 7061 7468              path
+00003f50: 203d 2064 6972 6e61 6d65 202b 2027 2f27   = dirname + '/'
+00003f60: 2069 6620 7365 6172 6368 5f64 6972 2065   if search_dir e
+00003f70: 6c73 6520 6469 726e 616d 650a 2020 2020  lse dirname.    
 00003f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003f90: 2070 6174 6820 3d20 6469 726e 616d 6520   path = dirname 
-00003fa0: 2b20 272f 2720 6966 2073 6561 7263 685f  + '/' if search_
-00003fb0: 6469 7220 656c 7365 2064 6972 6e61 6d65  dir else dirname
-00003fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003fd0: 2020 2020 2020 2020 2069 6620 7061 7474           if patt
-00003fe0: 6572 6e2e 6d61 7463 6828 7061 7468 293a  ern.match(path):
-00003ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004000: 2020 2020 2020 2020 2020 2020 2079 6965               yie
-00004010: 6c64 2046 696c 6545 6e74 7279 280a 2020  ld FileEntry(.  
-00004020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004030: 2020 2020 2020 2020 2020 2020 2020 5333                S3
-00004040: 5061 7468 2870 6174 6829 2e6e 616d 652c  Path(path).name,
-00004050: 2070 6174 682c 2053 7461 7452 6573 756c   path, StatResul
-00004060: 7428 6973 6469 723d 5472 7565 2929 0a20  t(isdir=True)). 
-00004070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004080: 2020 2020 2020 2064 6972 6e61 6d65 203d         dirname =
-00004090: 206f 732e 7061 7468 2e64 6972 6e61 6d65   os.path.dirname
-000040a0: 2864 6972 6e61 6d65 290a 2020 2020 2020  (dirname).      
-000040b0: 2020 2020 2020 2020 2020 666f 7220 636f            for co
-000040c0: 6d6d 6f6e 5f70 7265 6669 7820 696e 2072  mmon_prefix in r
-000040d0: 6573 702e 6765 7428 2743 6f6d 6d6f 6e50  esp.get('CommonP
-000040e0: 7265 6669 7865 7327 2c20 5b5d 293a 0a20  refixes', []):. 
-000040f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004100: 2020 2070 6174 6820 3d20 7333 5f70 6174     path = s3_pat
-00004110: 685f 6a6f 696e 280a 2020 2020 2020 2020  h_join(.        
-00004120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004130: 2773 333a 2f2f 272c 2062 7563 6b65 742c  's3://', bucket,
-00004140: 2063 6f6d 6d6f 6e5f 7072 6566 6978 5b27   common_prefix['
-00004150: 5072 6566 6978 275d 290a 2020 2020 2020  Prefix']).      
-00004160: 2020 2020 2020 2020 2020 2020 2020 6469                di
-00004170: 726e 616d 6520 3d20 6f73 2e70 6174 682e  rname = os.path.
-00004180: 6469 726e 616d 6528 7061 7468 290a 2020  dirname(path).  
+00003f90: 2020 2020 6966 2070 6174 7465 726e 2e6d      if pattern.m
+00003fa0: 6174 6368 2870 6174 6829 3a0a 2020 2020  atch(path):.    
+00003fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003fc0: 2020 2020 2020 2020 7969 656c 6420 4669          yield Fi
+00003fd0: 6c65 456e 7472 7928 0a20 2020 2020 2020  leEntry(.       
+00003fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003ff0: 2020 2020 2020 2020 2053 3350 6174 6828           S3Path(
+00004000: 7061 7468 292e 6e61 6d65 2c20 7061 7468  path).name, path
+00004010: 2c20 5374 6174 5265 7375 6c74 2869 7364  , StatResult(isd
+00004020: 6972 3d54 7275 6529 290a 2020 2020 2020  ir=True)).      
+00004030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004040: 2020 6469 726e 616d 6520 3d20 6f73 2e70    dirname = os.p
+00004050: 6174 682e 6469 726e 616d 6528 6469 726e  ath.dirname(dirn
+00004060: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
+00004070: 2020 2020 2066 6f72 2063 6f6d 6d6f 6e5f       for common_
+00004080: 7072 6566 6978 2069 6e20 7265 7370 2e67  prefix in resp.g
+00004090: 6574 2827 436f 6d6d 6f6e 5072 6566 6978  et('CommonPrefix
+000040a0: 6573 272c 205b 5d29 3a0a 2020 2020 2020  es', []):.      
+000040b0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+000040c0: 7468 203d 2073 335f 7061 7468 5f6a 6f69  th = s3_path_joi
+000040d0: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+000040e0: 2020 2020 2020 2020 2020 2027 7333 3a2f             's3:/
+000040f0: 2f27 2c20 6275 636b 6574 2c20 636f 6d6d  /', bucket, comm
+00004100: 6f6e 5f70 7265 6669 785b 2750 7265 6669  on_prefix['Prefi
+00004110: 7827 5d29 0a20 2020 2020 2020 2020 2020  x']).           
+00004120: 2020 2020 2020 2020 2064 6972 6e61 6d65           dirname
+00004130: 203d 206f 732e 7061 7468 2e64 6972 6e61   = os.path.dirna
+00004140: 6d65 2870 6174 6829 0a20 2020 2020 2020  me(path).       
+00004150: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00004160: 6469 726e 616d 6520 6e6f 7420 696e 2064  dirname not in d
+00004170: 6972 6e61 6d65 7320 616e 6420 6469 726e  irnames and dirn
+00004180: 616d 6520 213d 2074 6f70 5f64 6972 3a0a  ame != top_dir:.
 00004190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000041a0: 2020 6966 2064 6972 6e61 6d65 206e 6f74    if dirname not
-000041b0: 2069 6e20 6469 726e 616d 6573 2061 6e64   in dirnames and
-000041c0: 2064 6972 6e61 6d65 2021 3d20 746f 705f   dirname != top_
-000041d0: 6469 723a 0a20 2020 2020 2020 2020 2020  dir:.           
-000041e0: 2020 2020 2020 2020 2020 2020 2064 6972               dir
-000041f0: 6e61 6d65 732e 6164 6428 6469 726e 616d  names.add(dirnam
-00004200: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00004210: 2020 2020 2020 2020 2020 2070 6174 6820             path 
-00004220: 3d20 6469 726e 616d 6520 2b20 272f 2720  = dirname + '/' 
-00004230: 6966 2073 6561 7263 685f 6469 7220 656c  if search_dir el
-00004240: 7365 2064 6972 6e61 6d65 0a20 2020 2020  se dirname.     
-00004250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004260: 2020 2069 6620 7061 7474 6572 6e2e 6d61     if pattern.ma
-00004270: 7463 6828 7061 7468 293a 0a20 2020 2020  tch(path):.     
-00004280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004290: 2020 2020 2020 2079 6965 6c64 2046 696c         yield Fil
-000042a0: 6545 6e74 7279 280a 2020 2020 2020 2020  eEntry(.        
-000042b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000042c0: 2020 2020 2020 2020 5333 5061 7468 2870          S3Path(p
-000042d0: 6174 6829 2e6e 616d 652c 2070 6174 682c  ath).name, path,
-000042e0: 2053 7461 7452 6573 756c 7428 6973 6469   StatResult(isdi
-000042f0: 723d 5472 7565 2929 0a0a 2020 2020 7265  r=True))..    re
-00004300: 7475 726e 2063 7265 6174 655f 6765 6e65  turn create_gene
-00004310: 7261 746f 7228 7333 5f70 6174 686e 616d  rator(s3_pathnam
-00004320: 6529 0a0a 0a64 6566 205f 7333 5f73 6361  e)...def _s3_sca
-00004330: 6e5f 7061 6972 7328 7372 635f 7572 6c3a  n_pairs(src_url:
-00004340: 2050 6174 684c 696b 652c 0a20 2020 2020   PathLike,.     
-00004350: 2020 2020 2020 2020 2020 2020 2020 6473                ds
-00004360: 745f 7572 6c3a 2050 6174 684c 696b 6529  t_url: PathLike)
-00004370: 202d 3e20 4974 6572 6174 6f72 5b54 7570   -> Iterator[Tup
-00004380: 6c65 5b50 6174 684c 696b 652c 2050 6174  le[PathLike, Pat
-00004390: 684c 696b 655d 5d3a 0a20 2020 2066 6f72  hLike]]:.    for
-000043a0: 2073 7263 5f66 696c 655f 7061 7468 2069   src_file_path i
-000043b0: 6e20 5333 5061 7468 2873 7263 5f75 726c  n S3Path(src_url
-000043c0: 292e 7363 616e 2829 3a0a 2020 2020 2020  ).scan():.      
-000043d0: 2020 636f 6e74 656e 745f 7061 7468 203d    content_path =
-000043e0: 2073 7263 5f66 696c 655f 7061 7468 5b6c   src_file_path[l
-000043f0: 656e 2873 7263 5f75 726c 293a 5d0a 2020  en(src_url):].  
-00004400: 2020 2020 2020 6966 206c 656e 2863 6f6e        if len(con
-00004410: 7465 6e74 5f70 6174 6829 203e 2030 3a0a  tent_path) > 0:.
-00004420: 2020 2020 2020 2020 2020 2020 6473 745f              dst_
-00004430: 6669 6c65 5f70 6174 6820 3d20 7333 5f70  file_path = s3_p
-00004440: 6174 685f 6a6f 696e 2864 7374 5f75 726c  ath_join(dst_url
-00004450: 2c20 636f 6e74 656e 745f 7061 7468 290a  , content_path).
-00004460: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00004470: 2020 2020 2020 2020 2020 6473 745f 6669            dst_fi
-00004480: 6c65 5f70 6174 6820 3d20 6473 745f 7572  le_path = dst_ur
-00004490: 6c0a 2020 2020 2020 2020 7969 656c 6420  l.        yield 
-000044a0: 7372 635f 6669 6c65 5f70 6174 682c 2064  src_file_path, d
-000044b0: 7374 5f66 696c 655f 7061 7468 0a0a 0a64  st_file_path...d
-000044c0: 6566 2069 735f 7333 2870 6174 683a 2050  ef is_s3(path: P
-000044d0: 6174 684c 696b 6529 202d 3e20 626f 6f6c  athLike) -> bool
-000044e0: 3a0a 2020 2020 2727 270a 2020 2020 312e  :.    '''.    1.
-000044f0: 2041 6363 6f72 6469 6e67 2074 6f20 6061   According to `a
-00004500: 7773 2d63 6c69 203c 6874 7470 733a 2f2f  ws-cli <https://
-00004510: 646f 6373 2e61 7773 2e61 6d61 7a6f 6e2e  docs.aws.amazon.
-00004520: 636f 6d2f 636c 692f 6c61 7465 7374 2f72  com/cli/latest/r
-00004530: 6566 6572 656e 6365 2f73 332f 696e 6465  eference/s3/inde
-00004540: 782e 6874 6d6c 3e60 5f20 2c20 7465 7374  x.html>`_ , test
-00004550: 2069 6620 6120 7061 7468 2069 7320 7333   if a path is s3
-00004560: 2070 6174 682e 0a20 2020 2032 2e20 6d65   path..    2. me
-00004570: 6766 696c 6520 616c 736f 2073 7570 706f  gfile also suppo
-00004580: 7274 2074 6865 2070 6174 6820 6c69 6b65  rt the path like
-00004590: 2060 7333 5b2b 7072 6f66 696c 655f 6e61   `s3[+profile_na
-000045a0: 6d65 5d3a 2f2f 6275 636b 6574 2f6b 6579  me]://bucket/key
-000045b0: 600a 0a20 2020 203a 7061 7261 6d20 7061  `..    :param pa
-000045c0: 7468 3a20 5061 7468 2074 6f20 6265 2074  th: Path to be t
-000045d0: 6573 7465 640a 2020 2020 3a72 6574 7572  ested.    :retur
-000045e0: 6e73 3a20 5472 7565 2069 6620 7061 7468  ns: True if path
-000045f0: 2069 7320 7333 2070 6174 682c 2065 6c73   is s3 path, els
-00004600: 6520 4661 6c73 650a 2020 2020 2727 270a  e False.    '''.
-00004610: 2020 2020 7061 7468 203d 2066 7370 6174      path = fspat
-00004620: 6828 7061 7468 290a 2020 2020 6966 2072  h(path).    if r
-00004630: 652e 6d61 7463 6828 7227 5e73 3328 5c2b  e.match(r'^s3(\+
-00004640: 5c77 2b29 3f3a 5c2f 5c2f 272c 2070 6174  \w+)?:\/\/', pat
-00004650: 6829 3a0a 2020 2020 2020 2020 7265 7475  h):.        retu
-00004660: 726e 2054 7275 650a 2020 2020 7265 7475  rn True.    retu
-00004670: 726e 2046 616c 7365 0a0a 0a64 6566 205f  rn False...def _
-00004680: 7333 5f62 696e 6172 795f 6d6f 6465 2873  s3_binary_mode(s
-00004690: 335f 6f70 656e 5f66 756e 6329 3a0a 0a20  3_open_func):.. 
-000046a0: 2020 2040 7772 6170 7328 7333 5f6f 7065     @wraps(s3_ope
-000046b0: 6e5f 6675 6e63 290a 2020 2020 6465 6620  n_func).    def 
-000046c0: 7772 6170 7065 7228 7333 5f75 726c 2c20  wrapper(s3_url, 
-000046d0: 6d6f 6465 3a20 7374 7220 3d20 2772 6227  mode: str = 'rb'
-000046e0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-000046f0: 2020 2020 2062 7563 6b65 742c 206b 6579       bucket, key
-00004700: 203d 2070 6172 7365 5f73 335f 7572 6c28   = parse_s3_url(
-00004710: 7333 5f75 726c 290a 2020 2020 2020 2020  s3_url).        
-00004720: 6966 206e 6f74 2062 7563 6b65 743a 0a20  if not bucket:. 
-00004730: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00004740: 2053 3342 7563 6b65 744e 6f74 466f 756e   S3BucketNotFoun
-00004750: 6445 7272 6f72 2827 456d 7074 7920 6275  dError('Empty bu
-00004760: 636b 6574 206e 616d 653a 2025 7227 2025  cket name: %r' %
-00004770: 2073 335f 7572 6c29 0a0a 2020 2020 2020   s3_url)..      
-00004780: 2020 6966 206e 6f74 206b 6579 206f 7220    if not key or 
-00004790: 6b65 792e 656e 6473 7769 7468 2827 2f27  key.endswith('/'
-000047a0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-000047b0: 6169 7365 2053 3349 7341 4469 7265 6374  aise S3IsADirect
-000047c0: 6f72 7945 7272 6f72 2827 4973 2061 2064  oryError('Is a d
-000047d0: 6972 6563 746f 7279 3a20 2572 2720 2520  irectory: %r' % 
-000047e0: 7333 5f75 726c 290a 0a20 2020 2020 2020  s3_url)..       
-000047f0: 2069 6620 2778 2720 696e 206d 6f64 653a   if 'x' in mode:
-00004800: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00004810: 5333 5061 7468 2873 335f 7572 6c29 2e69  S3Path(s3_url).i
-00004820: 735f 6669 6c65 2829 3a0a 2020 2020 2020  s_file():.      
-00004830: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00004840: 5333 4669 6c65 4578 6973 7473 4572 726f  S3FileExistsErro
-00004850: 7228 2746 696c 6520 6578 6973 7473 3a20  r('File exists: 
-00004860: 2572 2720 2520 7333 5f75 726c 290a 2020  %r' % s3_url).  
-00004870: 2020 2020 2020 2020 2020 6d6f 6465 203d            mode =
-00004880: 206d 6f64 652e 7265 706c 6163 6528 2778   mode.replace('x
-00004890: 272c 2027 7727 290a 0a20 2020 2020 2020  ', 'w')..       
-000048a0: 2069 6620 2777 2720 696e 206d 6f64 6520   if 'w' in mode 
-000048b0: 6f72 2027 6127 2069 6e20 6d6f 6465 3a0a  or 'a' in mode:.
-000048c0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-000048d0: 6f74 2053 3350 6174 6828 7333 5f75 726c  ot S3Path(s3_url
-000048e0: 292e 6861 7362 7563 6b65 7428 293a 0a20  ).hasbucket():. 
-000048f0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00004900: 6169 7365 2053 3342 7563 6b65 744e 6f74  aise S3BucketNot
-00004910: 466f 756e 6445 7272 6f72 2827 4e6f 2073  FoundError('No s
-00004920: 7563 6820 6275 636b 6574 3a20 2572 2720  uch bucket: %r' 
-00004930: 2520 7333 5f75 726c 290a 0a20 2020 2020  % s3_url)..     
-00004940: 2020 2066 696c 656f 626a 203d 2073 335f     fileobj = s3_
-00004950: 6f70 656e 5f66 756e 6328 7333 5f75 726c  open_func(s3_url
-00004960: 2c20 6765 745f 6269 6e61 7279 5f6d 6f64  , get_binary_mod
-00004970: 6528 6d6f 6465 292c 202a 2a6b 7761 7267  e(mode), **kwarg
-00004980: 7329 0a20 2020 2020 2020 2069 6620 2762  s).        if 'b
-00004990: 2720 6e6f 7420 696e 206d 6f64 653a 0a20  ' not in mode:. 
-000049a0: 2020 2020 2020 2020 2020 2066 696c 656f             fileo
-000049b0: 626a 203d 2069 6f2e 5465 7874 494f 5772  bj = io.TextIOWr
-000049c0: 6170 7065 7228 6669 6c65 6f62 6a29 2020  apper(fileobj)  
-000049d0: 2320 7079 7479 7065 3a20 6469 7361 626c  # pytype: disabl
-000049e0: 653d 7772 6f6e 672d 6172 672d 7479 7065  e=wrong-arg-type
-000049f0: 730a 2020 2020 2020 2020 2020 2020 6669  s.            fi
-00004a00: 6c65 6f62 6a2e 6d6f 6465 203d 206d 6f64  leobj.mode = mod
-00004a10: 650a 2020 2020 2020 2020 7265 7475 726e  e.        return
-00004a20: 2066 696c 656f 626a 0a0a 2020 2020 7265   fileobj..    re
-00004a30: 7475 726e 2077 7261 7070 6572 0a0a 0a40  turn wrapper...@
-00004a40: 5f73 335f 6269 6e61 7279 5f6d 6f64 650a  _s3_binary_mode.
-00004a50: 6465 6620 7333 5f70 7265 6665 7463 685f  def s3_prefetch_
-00004a60: 6f70 656e 280a 2020 2020 2020 2020 7333  open(.        s3
-00004a70: 5f75 726c 3a20 5061 7468 4c69 6b65 2c0a  _url: PathLike,.
-00004a80: 2020 2020 2020 2020 6d6f 6465 3a20 7374          mode: st
-00004a90: 7220 3d20 2772 6227 2c0a 2020 2020 2020  r = 'rb',.      
-00004aa0: 2020 666f 6c6c 6f77 6c69 6e6b 733a 2062    followlinks: b
-00004ab0: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
-00004ac0: 2020 2020 202a 2c0a 2020 2020 2020 2020       *,.        
-00004ad0: 6d61 785f 636f 6e63 7572 7265 6e63 793a  max_concurrency:
-00004ae0: 204f 7074 696f 6e61 6c5b 696e 745d 203d   Optional[int] =
-00004af0: 204e 6f6e 652c 0a20 2020 2020 2020 206d   None,.        m
-00004b00: 6178 5f62 6c6f 636b 5f73 697a 653a 2069  ax_block_size: i
-00004b10: 6e74 203d 2044 4546 4155 4c54 5f42 4c4f  nt = DEFAULT_BLO
-00004b20: 434b 5f53 495a 4529 202d 3e20 5333 5072  CK_SIZE) -> S3Pr
-00004b30: 6566 6574 6368 5265 6164 6572 3a0a 2020  efetchReader:.  
-00004b40: 2020 2727 274f 7065 6e20 6120 6173 796e    '''Open a asyn
-00004b50: 6368 726f 6e6f 7573 2070 7265 6665 7463  chronous prefetc
-00004b60: 6820 7265 6164 6572 2c20 746f 2073 7570  h reader, to sup
-00004b70: 706f 7274 2066 6173 7420 7365 7175 656e  port fast sequen
-00004b80: 7469 616c 2072 6561 6420 616e 6420 7261  tial read and ra
-00004b90: 6e64 6f6d 2072 6561 640a 0a20 2020 202e  ndom read..    .
-00004ba0: 2e20 6e6f 7465 203a 3a0a 0a20 2020 2020  . note ::..     
-00004bb0: 2020 2055 7365 7220 7368 6f75 6c64 206d     User should m
-00004bc0: 616b 6520 7375 7265 2074 6861 7420 7265  ake sure that re
-00004bd0: 6164 6572 202f 2077 7269 7465 7220 6172  ader / writer ar
-00004be0: 6520 636c 6f73 6564 2063 6f72 7265 6374  e closed correct
-00004bf0: 6c79 0a0a 2020 2020 2020 2020 5375 7070  ly..        Supp
-00004c00: 6f72 7473 2063 6f6e 7465 7874 206d 616e  orts context man
-00004c10: 6167 6572 0a0a 2020 2020 2020 2020 536f  ager..        So
-00004c20: 6d65 2070 6172 616d 6574 6572 2073 6574  me parameter set
-00004c30: 7469 6e67 206d 6179 2070 6572 666f 726d  ting may perform
-00004c40: 2077 656c 6c3a 206d 6178 5f63 6f6e 6375   well: max_concu
-00004c50: 7272 656e 6379 3d31 3020 6f72 2032 302c  rrency=10 or 20,
-00004c60: 206d 6178 5f62 6c6f 636b 5f73 697a 653d   max_block_size=
-00004c70: 3820 6f72 2031 3620 4d42 2c20 6465 6661  8 or 16 MB, defa
-00004c80: 756c 7420 7661 6c75 6520 4e6f 6e65 206d  ult value None m
-00004c90: 6561 6e73 2075 7369 6e67 2067 6c6f 6261  eans using globa
-00004ca0: 6c20 7468 7265 6164 2070 6f6f 6c0a 0a20  l thread pool.. 
-00004cb0: 2020 203a 7061 7261 6d20 6d61 785f 636f     :param max_co
-00004cc0: 6e63 7572 7265 6e63 793a 204d 6178 2064  ncurrency: Max d
-00004cd0: 6f77 6e6c 6f61 6420 7468 7265 6164 206e  ownload thread n
-00004ce0: 756d 6265 722c 204e 6f6e 6520 6279 2064  umber, None by d
-00004cf0: 6566 6175 6c74 0a20 2020 203a 7061 7261  efault.    :para
-00004d00: 6d20 6d61 785f 626c 6f63 6b5f 7369 7a65  m max_block_size
-00004d10: 3a20 4d61 7820 6461 7461 2073 697a 6520  : Max data size 
-00004d20: 646f 776e 6c6f 6164 6564 2062 7920 6561  downloaded by ea
-00004d30: 6368 2074 6872 6561 642c 2069 6e20 6279  ch thread, in by
-00004d40: 7465 732c 2038 4d42 2062 7920 6465 6661  tes, 8MB by defa
-00004d50: 756c 740a 2020 2020 3a72 6574 7572 6e73  ult.    :returns
-00004d60: 3a20 416e 206f 7065 6e65 6420 5333 5072  : An opened S3Pr
-00004d70: 6566 6574 6368 5265 6164 6572 206f 626a  efetchReader obj
-00004d80: 6563 740a 2020 2020 3a72 6169 7365 733a  ect.    :raises:
-00004d90: 2053 3346 696c 654e 6f74 466f 756e 6445   S3FileNotFoundE
-00004da0: 7272 6f72 0a20 2020 2027 2727 0a20 2020  rror.    '''.   
-00004db0: 2069 6620 6d6f 6465 2021 3d20 2772 6227   if mode != 'rb'
-00004dc0: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-00004dd0: 5661 6c75 6545 7272 6f72 2827 756e 6163  ValueError('unac
-00004de0: 6365 7074 6162 6c65 206d 6f64 653a 2025  ceptable mode: %
-00004df0: 7227 2025 206d 6f64 6529 0a20 2020 2073  r' % mode).    s
-00004e00: 335f 7572 6c20 3d20 5333 5061 7468 2873  3_url = S3Path(s
-00004e10: 335f 7572 6c29 0a20 2020 2069 6620 666f  3_url).    if fo
-00004e20: 6c6c 6f77 6c69 6e6b 733a 0a20 2020 2020  llowlinks:.     
-00004e30: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00004e40: 2020 2020 7333 5f75 726c 203d 2073 335f      s3_url = s3_
-00004e50: 7572 6c2e 7265 6164 6c69 6e6b 2829 0a20  url.readlink(). 
-00004e60: 2020 2020 2020 2065 7863 6570 7420 5333         except S3
-00004e70: 4e6f 7441 4c69 6e6b 4572 726f 723a 0a20  NotALinkError:. 
-00004e80: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
-00004e90: 0a20 2020 2062 7563 6b65 742c 206b 6579  .    bucket, key
-00004ea0: 203d 2070 6172 7365 5f73 335f 7572 6c28   = parse_s3_url(
-00004eb0: 7333 5f75 726c 2e70 6174 685f 7769 7468  s3_url.path_with
-00004ec0: 5f70 726f 746f 636f 6c29 0a20 2020 2063  _protocol).    c
-00004ed0: 6f6e 6669 6720 3d20 626f 746f 636f 7265  onfig = botocore
-00004ee0: 2e63 6f6e 6669 672e 436f 6e66 6967 286d  .config.Config(m
-00004ef0: 6178 5f70 6f6f 6c5f 636f 6e6e 6563 7469  ax_pool_connecti
-00004f00: 6f6e 733d 6d61 785f 706f 6f6c 5f63 6f6e  ons=max_pool_con
-00004f10: 6e65 6374 696f 6e73 290a 2020 2020 636c  nections).    cl
-00004f20: 6965 6e74 203d 2067 6574 5f73 335f 636c  ient = get_s3_cl
-00004f30: 6965 6e74 280a 2020 2020 2020 2020 636f  ient(.        co
-00004f40: 6e66 6967 3d63 6f6e 6669 672c 0a20 2020  nfig=config,.   
-00004f50: 2020 2020 2063 6163 6865 5f6b 6579 3d27       cache_key='
-00004f60: 7333 5f66 696c 656c 696b 655f 636c 6965  s3_filelike_clie
-00004f70: 6e74 272c 0a20 2020 2020 2020 2070 726f  nt',.        pro
-00004f80: 6669 6c65 5f6e 616d 653d 7333 5f75 726c  file_name=s3_url
-00004f90: 2e5f 7072 6f66 696c 655f 6e61 6d65 290a  ._profile_name).
-00004fa0: 2020 2020 7265 7475 726e 2053 3350 7265      return S3Pre
-00004fb0: 6665 7463 6852 6561 6465 7228 0a20 2020  fetchReader(.   
-00004fc0: 2020 2020 2062 7563 6b65 742c 0a20 2020       bucket,.   
-00004fd0: 2020 2020 206b 6579 2c0a 2020 2020 2020       key,.      
-00004fe0: 2020 7333 5f63 6c69 656e 743d 636c 6965    s3_client=clie
-00004ff0: 6e74 2c0a 2020 2020 2020 2020 6d61 785f  nt,.        max_
-00005000: 7265 7472 6965 733d 6d61 785f 7265 7472  retries=max_retr
-00005010: 6965 732c 0a20 2020 2020 2020 206d 6178  ies,.        max
-00005020: 5f77 6f72 6b65 7273 3d6d 6178 5f63 6f6e  _workers=max_con
-00005030: 6375 7272 656e 6379 2c0a 2020 2020 2020  currency,.      
-00005040: 2020 626c 6f63 6b5f 7369 7a65 3d6d 6178    block_size=max
-00005050: 5f62 6c6f 636b 5f73 697a 6529 0a0a 0a40  _block_size)...@
-00005060: 5f73 335f 6269 6e61 7279 5f6d 6f64 650a  _s3_binary_mode.
-00005070: 6465 6620 7333 5f73 6861 7265 5f63 6163  def s3_share_cac
-00005080: 6865 5f6f 7065 6e28 0a20 2020 2020 2020  he_open(.       
-00005090: 2073 335f 7572 6c3a 2050 6174 684c 696b   s3_url: PathLik
-000050a0: 652c 0a20 2020 2020 2020 206d 6f64 653a  e,.        mode:
-000050b0: 2073 7472 203d 2027 7262 272c 0a20 2020   str = 'rb',.   
-000050c0: 2020 2020 2066 6f6c 6c6f 776c 696e 6b73       followlinks
-000050d0: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
-000050e0: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
-000050f0: 2020 2063 6163 6865 5f6b 6579 3a20 7374     cache_key: st
-00005100: 7220 3d20 276c 7275 272c 0a20 2020 2020  r = 'lru',.     
-00005110: 2020 206d 6178 5f63 6f6e 6375 7272 656e     max_concurren
-00005120: 6379 3a20 4f70 7469 6f6e 616c 5b69 6e74  cy: Optional[int
-00005130: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
-00005140: 2020 6d61 785f 626c 6f63 6b5f 7369 7a65    max_block_size
-00005150: 3a20 696e 7420 3d20 4445 4641 554c 545f  : int = DEFAULT_
-00005160: 424c 4f43 4b5f 5349 5a45 2920 2d3e 2053  BLOCK_SIZE) -> S
-00005170: 3353 6861 7265 4361 6368 6552 6561 6465  3ShareCacheReade
-00005180: 723a 0a20 2020 2027 2727 4f70 656e 2061  r:.    '''Open a
-00005190: 2061 7379 6e63 6872 6f6e 6f75 7320 7072   asynchronous pr
-000051a0: 6566 6574 6368 2072 6561 6465 722c 2074  efetch reader, t
-000051b0: 6f20 7375 7070 6f72 7420 6661 7374 2073  o support fast s
-000051c0: 6571 7565 6e74 6961 6c20 7265 6164 2061  equential read a
-000051d0: 6e64 2072 616e 646f 6d20 7265 6164 0a0a  nd random read..
-000051e0: 2020 2020 2e2e 206e 6f74 6520 3a3a 0a0a      .. note ::..
-000051f0: 2020 2020 2020 2020 5573 6572 2073 686f          User sho
-00005200: 756c 6420 6d61 6b65 2073 7572 6520 7468  uld make sure th
-00005210: 6174 2072 6561 6465 7220 2f20 7772 6974  at reader / writ
-00005220: 6572 2061 7265 2063 6c6f 7365 6420 636f  er are closed co
-00005230: 7272 6563 746c 790a 0a20 2020 2020 2020  rrectly..       
-00005240: 2053 7570 706f 7274 7320 636f 6e74 6578   Supports contex
-00005250: 7420 6d61 6e61 6765 720a 0a20 2020 2020  t manager..     
-00005260: 2020 2053 6f6d 6520 7061 7261 6d65 7465     Some paramete
-00005270: 7220 7365 7474 696e 6720 6d61 7920 7065  r setting may pe
-00005280: 7266 6f72 6d20 7765 6c6c 3a20 6d61 785f  rform well: max_
-00005290: 636f 6e63 7572 7265 6e63 793d 3130 206f  concurrency=10 o
-000052a0: 7220 3230 2c20 6d61 785f 626c 6f63 6b5f  r 20, max_block_
-000052b0: 7369 7a65 3d38 206f 7220 3136 204d 422c  size=8 or 16 MB,
-000052c0: 2064 6566 6175 6c74 2076 616c 7565 204e   default value N
-000052d0: 6f6e 6520 6d65 616e 7320 7573 696e 6720  one means using 
-000052e0: 676c 6f62 616c 2074 6872 6561 6420 706f  global thread po
-000052f0: 6f6c 0a0a 2020 2020 3a70 6172 616d 206d  ol..    :param m
-00005300: 6178 5f63 6f6e 6375 7272 656e 6379 3a20  ax_concurrency: 
-00005310: 4d61 7820 646f 776e 6c6f 6164 2074 6872  Max download thr
-00005320: 6561 6420 6e75 6d62 6572 2c20 4e6f 6e65  ead number, None
-00005330: 2062 7920 6465 6661 756c 740a 2020 2020   by default.    
-00005340: 3a70 6172 616d 206d 6178 5f62 6c6f 636b  :param max_block
-00005350: 5f73 697a 653a 204d 6178 2064 6174 6120  _size: Max data 
-00005360: 7369 7a65 2064 6f77 6e6c 6f61 6465 6420  size downloaded 
-00005370: 6279 2065 6163 6820 7468 7265 6164 2c20  by each thread, 
-00005380: 696e 2062 7974 6573 2c20 384d 4220 6279  in bytes, 8MB by
-00005390: 2064 6566 6175 6c74 0a20 2020 203a 7265   default.    :re
-000053a0: 7475 726e 733a 2041 6e20 6f70 656e 6564  turns: An opened
-000053b0: 2053 3353 6861 7265 4361 6368 6552 6561   S3ShareCacheRea
-000053c0: 6465 7220 6f62 6a65 6374 0a20 2020 203a  der object.    :
-000053d0: 7261 6973 6573 3a20 5333 4669 6c65 4e6f  raises: S3FileNo
-000053e0: 7446 6f75 6e64 4572 726f 720a 2020 2020  tFoundError.    
-000053f0: 2727 270a 2020 2020 6966 206d 6f64 6520  '''.    if mode 
-00005400: 213d 2027 7262 273a 0a20 2020 2020 2020  != 'rb':.       
-00005410: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00005420: 7228 2775 6e61 6363 6570 7461 626c 6520  r('unacceptable 
-00005430: 6d6f 6465 3a20 2572 2720 2520 6d6f 6465  mode: %r' % mode
-00005440: 290a 0a20 2020 2073 335f 7572 6c20 3d20  )..    s3_url = 
-00005450: 5333 5061 7468 2873 335f 7572 6c29 0a20  S3Path(s3_url). 
-00005460: 2020 2069 6620 666f 6c6c 6f77 6c69 6e6b     if followlink
-00005470: 733a 0a20 2020 2020 2020 2074 7279 3a0a  s:.        try:.
-00005480: 2020 2020 2020 2020 2020 2020 7333 5f75              s3_u
-00005490: 726c 203d 2073 335f 7572 6c2e 7265 6164  rl = s3_url.read
-000054a0: 6c69 6e6b 2829 0a20 2020 2020 2020 2065  link().        e
-000054b0: 7863 6570 7420 5333 4e6f 7441 4c69 6e6b  xcept S3NotALink
-000054c0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-000054d0: 2020 2070 6173 730a 0a20 2020 2062 7563     pass..    buc
-000054e0: 6b65 742c 206b 6579 203d 2070 6172 7365  ket, key = parse
-000054f0: 5f73 335f 7572 6c28 7333 5f75 726c 2e70  _s3_url(s3_url.p
-00005500: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-00005510: 6c29 0a20 2020 2063 6f6e 6669 6720 3d20  l).    config = 
-00005520: 626f 746f 636f 7265 2e63 6f6e 6669 672e  botocore.config.
-00005530: 436f 6e66 6967 286d 6178 5f70 6f6f 6c5f  Config(max_pool_
-00005540: 636f 6e6e 6563 7469 6f6e 733d 6d61 785f  connections=max_
-00005550: 706f 6f6c 5f63 6f6e 6e65 6374 696f 6e73  pool_connections
-00005560: 290a 2020 2020 636c 6965 6e74 203d 2067  ).    client = g
-00005570: 6574 5f73 335f 636c 6965 6e74 280a 2020  et_s3_client(.  
-00005580: 2020 2020 2020 636f 6e66 6967 3d63 6f6e        config=con
-00005590: 6669 672c 0a20 2020 2020 2020 2063 6163  fig,.        cac
-000055a0: 6865 5f6b 6579 3d27 7333 5f66 696c 656c  he_key='s3_filel
-000055b0: 696b 655f 636c 6965 6e74 272c 0a20 2020  ike_client',.   
-000055c0: 2020 2020 2070 726f 6669 6c65 5f6e 616d       profile_nam
-000055d0: 653d 7333 5f75 726c 2e5f 7072 6f66 696c  e=s3_url._profil
-000055e0: 655f 6e61 6d65 290a 2020 2020 7265 7475  e_name).    retu
-000055f0: 726e 2053 3353 6861 7265 4361 6368 6552  rn S3ShareCacheR
-00005600: 6561 6465 7228 0a20 2020 2020 2020 2062  eader(.        b
-00005610: 7563 6b65 742c 0a20 2020 2020 2020 206b  ucket,.        k
-00005620: 6579 2c0a 2020 2020 2020 2020 6361 6368  ey,.        cach
-00005630: 655f 6b65 793d 6361 6368 655f 6b65 792c  e_key=cache_key,
-00005640: 0a20 2020 2020 2020 2073 335f 636c 6965  .        s3_clie
-00005650: 6e74 3d63 6c69 656e 742c 0a20 2020 2020  nt=client,.     
-00005660: 2020 206d 6178 5f72 6574 7269 6573 3d6d     max_retries=m
-00005670: 6178 5f72 6574 7269 6573 2c0a 2020 2020  ax_retries,.    
-00005680: 2020 2020 6d61 785f 776f 726b 6572 733d      max_workers=
-00005690: 6d61 785f 636f 6e63 7572 7265 6e63 792c  max_concurrency,
-000056a0: 0a20 2020 2020 2020 2062 6c6f 636b 5f73  .        block_s
-000056b0: 697a 653d 6d61 785f 626c 6f63 6b5f 7369  ize=max_block_si
-000056c0: 7a65 290a 0a0a 405f 7333 5f62 696e 6172  ze)...@_s3_binar
-000056d0: 795f 6d6f 6465 0a64 6566 2073 335f 7069  y_mode.def s3_pi
-000056e0: 7065 5f6f 7065 6e28 0a20 2020 2020 2020  pe_open(.       
-000056f0: 2073 335f 7572 6c3a 2050 6174 684c 696b   s3_url: PathLik
-00005700: 652c 0a20 2020 2020 2020 206d 6f64 653a  e,.        mode:
-00005710: 2073 7472 2c0a 2020 2020 2020 2020 666f   str,.        fo
-00005720: 6c6c 6f77 6c69 6e6b 733a 2062 6f6f 6c20  llowlinks: bool 
-00005730: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
-00005740: 202a 2c0a 2020 2020 2020 2020 6a6f 696e   *,.        join
-00005750: 5f74 6872 6561 643a 2062 6f6f 6c20 3d20  _thread: bool = 
-00005760: 5472 7565 2920 2d3e 2053 3350 6970 6548  True) -> S3PipeH
-00005770: 616e 646c 6572 3a0a 2020 2020 2727 274f  andler:.    '''O
-00005780: 7065 6e20 6120 6173 796e 6368 726f 6e6f  pen a asynchrono
-00005790: 7573 2072 6561 642d 7772 6974 6520 7265  us read-write re
-000057a0: 6164 6572 202f 2077 7269 7465 722c 2074  ader / writer, t
-000057b0: 6f20 7375 7070 6f72 7420 6661 7374 2073  o support fast s
-000057c0: 6571 7565 6e74 6961 6c20 7265 6164 202f  equential read /
-000057d0: 2077 7269 7465 0a0a 2020 2020 2e2e 206e   write..    .. n
-000057e0: 6f74 6520 3a3a 0a0a 2020 2020 2020 2020  ote ::..        
-000057f0: 5573 6572 2073 686f 756c 6420 6d61 6b65  User should make
-00005800: 2073 7572 6520 7468 6174 2072 6561 6465   sure that reade
-00005810: 7220 2f20 7772 6974 6572 2061 7265 2063  r / writer are c
-00005820: 6c6f 7365 6420 636f 7272 6563 746c 790a  losed correctly.
-00005830: 0a20 2020 2020 2020 2053 7570 706f 7274  .        Support
-00005840: 7320 636f 6e74 6578 7420 6d61 6e61 6765  s context manage
-00005850: 720a 0a20 2020 2020 2020 2057 6865 6e20  r..        When 
-00005860: 6a6f 696e 5f74 6872 6561 6420 6973 2046  join_thread is F
-00005870: 616c 7365 2c20 7768 696c 6520 7468 6520  alse, while the 
-00005880: 6669 6c65 2068 616e 646c 6520 6172 6520  file handle are 
-00005890: 636c 6f73 696e 672c 2074 6869 7320 6675  closing, this fu
-000058a0: 6e63 7469 6f6e 2077 696c 6c20 6e6f 7420  nction will not 
-000058b0: 7761 6974 2075 6e74 696c 2074 6865 2061  wait until the a
-000058c0: 7379 6e63 6872 6f6e 6f75 7320 7772 6974  synchronous writ
-000058d0: 696e 6720 6669 6e69 7368 6573 3b0a 2020  ing finishes;.  
-000058e0: 2020 2020 2020 4661 6c73 6520 646f 6573        False does
-000058f0: 6e27 7420 6166 6665 6374 2072 6561 642d  n't affect read-
-00005900: 6861 6e64 6c65 2c20 6275 7420 7468 6973  handle, but this
-00005910: 2063 616e 2073 7065 6564 2075 7020 7772   can speed up wr
-00005920: 6974 652d 6861 6e64 6c65 2062 6563 6175  ite-handle becau
-00005930: 7365 2066 696c 6520 7769 6c6c 2062 6520  se file will be 
-00005940: 7772 6974 7465 6e20 6173 796e 6368 726f  written asynchro
-00005950: 6e6f 7573 6c79 2e0a 2020 2020 2020 2020  nously..        
-00005960: 4275 7420 6173 796e 6368 726f 6e6f 7573  But asynchronous
-00005970: 2062 6568 6176 696f 7572 2063 616e 2067   behaviour can g
-00005980: 7561 7261 6e74 6565 2074 6865 2066 696c  uarantee the fil
-00005990: 6520 6172 6520 7375 6363 6573 7366 756c  e are successful
-000059a0: 6c79 2077 7269 7474 656e 2c20 616e 6420  ly written, and 
-000059b0: 6672 6571 7565 6e74 2065 7865 6375 7469  frequent executi
-000059c0: 6f6e 206d 6179 2063 6175 7365 2074 6872  on may cause thr
-000059d0: 6561 6420 616e 6420 6669 6c65 2068 616e  ead and file han
-000059e0: 646c 6520 6578 6861 7573 7469 6f6e 0a0a  dle exhaustion..
-000059f0: 2020 2020 3a70 6172 616d 206d 6f64 653a      :param mode:
-00005a00: 204d 6f64 6520 746f 206f 7065 6e20 6669   Mode to open fi
-00005a10: 6c65 2c20 6569 7468 6572 2022 7262 2220  le, either "rb" 
-00005a20: 6f72 2022 7762 220a 2020 2020 3a70 6172  or "wb".    :par
-00005a30: 616d 206a 6f69 6e5f 7468 7265 6164 3a20  am join_thread: 
-00005a40: 4966 2077 6169 7420 6166 7465 7220 6675  If wait after fu
-00005a50: 6e63 7469 6f6e 2065 7865 6375 7469 6f6e  nction execution
-00005a60: 2075 6e74 696c 2073 3320 6669 6e69 7368   until s3 finish
-00005a70: 6573 2077 7269 7469 6e67 0a20 2020 203a  es writing.    :
-00005a80: 7265 7475 726e 733a 2041 6e20 6f70 656e  returns: An open
-00005a90: 6564 2042 7566 6665 7265 6452 6561 6465  ed BufferedReade
-00005aa0: 7220 2f20 4275 6666 6572 6564 5772 6974  r / BufferedWrit
-00005ab0: 6572 206f 626a 6563 740a 2020 2020 2727  er object.    ''
-00005ac0: 270a 2020 2020 6966 206d 6f64 6520 6e6f  '.    if mode no
-00005ad0: 7420 696e 2028 2772 6227 2c20 2777 6227  t in ('rb', 'wb'
-00005ae0: 293a 0a20 2020 2020 2020 2072 6169 7365  ):.        raise
-00005af0: 2056 616c 7565 4572 726f 7228 2775 6e61   ValueError('una
-00005b00: 6363 6570 7461 626c 6520 6d6f 6465 3a20  cceptable mode: 
-00005b10: 2572 2720 2520 6d6f 6465 290a 0a20 2020  %r' % mode)..   
-00005b20: 2069 6620 6d6f 6465 5b30 5d20 3d3d 2027   if mode[0] == '
-00005b30: 7227 2061 6e64 206e 6f74 2053 3350 6174  r' and not S3Pat
-00005b40: 6828 7333 5f75 726c 292e 6973 5f66 696c  h(s3_url).is_fil
-00005b50: 6528 293a 0a20 2020 2020 2020 2072 6169  e():.        rai
-00005b60: 7365 2053 3346 696c 654e 6f74 466f 756e  se S3FileNotFoun
-00005b70: 6445 7272 6f72 2827 4e6f 2073 7563 6820  dError('No such 
-00005b80: 6669 6c65 3a20 2572 2720 2520 7333 5f75  file: %r' % s3_u
-00005b90: 726c 290a 0a20 2020 2073 335f 7572 6c20  rl)..    s3_url 
-00005ba0: 3d20 5333 5061 7468 2873 335f 7572 6c29  = S3Path(s3_url)
-00005bb0: 0a20 2020 2069 6620 666f 6c6c 6f77 6c69  .    if followli
-00005bc0: 6e6b 733a 0a20 2020 2020 2020 2074 7279  nks:.        try
-00005bd0: 3a0a 2020 2020 2020 2020 2020 2020 7333  :.            s3
-00005be0: 5f75 726c 203d 2073 335f 7572 6c2e 7265  _url = s3_url.re
-00005bf0: 6164 6c69 6e6b 2829 0a20 2020 2020 2020  adlink().       
-00005c00: 2065 7863 6570 7420 5333 4e6f 7441 4c69   except S3NotALi
-00005c10: 6e6b 4572 726f 723a 0a20 2020 2020 2020  nkError:.       
-00005c20: 2020 2020 2070 6173 730a 0a20 2020 2062       pass..    b
-00005c30: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
-00005c40: 7365 5f73 335f 7572 6c28 7333 5f75 726c  se_s3_url(s3_url
-00005c50: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
-00005c60: 636f 6c29 0a20 2020 2063 6f6e 6669 6720  col).    config 
-00005c70: 3d20 626f 746f 636f 7265 2e63 6f6e 6669  = botocore.confi
-00005c80: 672e 436f 6e66 6967 286d 6178 5f70 6f6f  g.Config(max_poo
-00005c90: 6c5f 636f 6e6e 6563 7469 6f6e 733d 6d61  l_connections=ma
-00005ca0: 785f 706f 6f6c 5f63 6f6e 6e65 6374 696f  x_pool_connectio
-00005cb0: 6e73 290a 2020 2020 636c 6965 6e74 203d  ns).    client =
-00005cc0: 2067 6574 5f73 335f 636c 6965 6e74 280a   get_s3_client(.
-00005cd0: 2020 2020 2020 2020 636f 6e66 6967 3d63          config=c
-00005ce0: 6f6e 6669 672c 0a20 2020 2020 2020 2063  onfig,.        c
-00005cf0: 6163 6865 5f6b 6579 3d27 7333 5f66 696c  ache_key='s3_fil
-00005d00: 656c 696b 655f 636c 6965 6e74 272c 0a20  elike_client',. 
-00005d10: 2020 2020 2020 2070 726f 6669 6c65 5f6e         profile_n
-00005d20: 616d 653d 7333 5f75 726c 2e5f 7072 6f66  ame=s3_url._prof
-00005d30: 696c 655f 6e61 6d65 290a 2020 2020 7265  ile_name).    re
-00005d40: 7475 726e 2053 3350 6970 6548 616e 646c  turn S3PipeHandl
-00005d50: 6572 280a 2020 2020 2020 2020 6275 636b  er(.        buck
-00005d60: 6574 2c20 6b65 792c 206d 6f64 652c 2073  et, key, mode, s
-00005d70: 335f 636c 6965 6e74 3d63 6c69 656e 742c  3_client=client,
-00005d80: 206a 6f69 6e5f 7468 7265 6164 3d6a 6f69   join_thread=joi
-00005d90: 6e5f 7468 7265 6164 290a 0a0a 405f 7333  n_thread)...@_s3
-00005da0: 5f62 696e 6172 795f 6d6f 6465 0a64 6566  _binary_mode.def
-00005db0: 2073 335f 6361 6368 6564 5f6f 7065 6e28   s3_cached_open(
-00005dc0: 0a20 2020 2020 2020 2073 335f 7572 6c3a  .        s3_url:
-00005dd0: 2050 6174 684c 696b 652c 0a20 2020 2020   PathLike,.     
-00005de0: 2020 206d 6f64 653a 2073 7472 2c0a 2020     mode: str,.  
-00005df0: 2020 2020 2020 666f 6c6c 6f77 6c69 6e6b        followlink
-00005e00: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
-00005e10: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
-00005e20: 2020 2020 6361 6368 655f 7061 7468 3a20      cache_path: 
-00005e30: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
-00005e40: 4e6f 6e65 2920 2d3e 2053 3343 6163 6865  None) -> S3Cache
-00005e50: 6448 616e 646c 6572 3a0a 2020 2020 2727  dHandler:.    ''
-00005e60: 274f 7065 6e20 6120 6c6f 6361 6c2d 6361  'Open a local-ca
-00005e70: 6368 6520 6669 6c65 2072 6561 6465 7220  che file reader 
-00005e80: 2f20 7772 6974 6572 2c20 666f 7220 6672  / writer, for fr
-00005e90: 6571 7565 6e74 2072 616e 646f 6d20 7265  equent random re
-00005ea0: 6164 202f 2077 7269 7465 0a0a 2020 2020  ad / write..    
-00005eb0: 2e2e 206e 6f74 6520 3a3a 0a0a 2020 2020  .. note ::..    
-00005ec0: 2020 2020 5573 6572 2073 686f 756c 6420      User should 
-00005ed0: 6d61 6b65 2073 7572 6520 7468 6174 2072  make sure that r
-00005ee0: 6561 6465 7220 2f20 7772 6974 6572 2061  eader / writer a
-00005ef0: 7265 2063 6c6f 7365 6420 636f 7272 6563  re closed correc
-00005f00: 746c 790a 0a20 2020 2020 2020 2053 7570  tly..        Sup
-00005f10: 706f 7274 7320 636f 6e74 6578 7420 6d61  ports context ma
-00005f20: 6e61 6765 720a 0a20 2020 2020 2020 2063  nager..        c
-00005f30: 6163 6865 5f70 6174 6820 6361 6e20 7370  ache_path can sp
-00005f40: 6563 6966 7920 7468 6520 7061 7468 206f  ecify the path o
-00005f50: 6620 6361 6368 6520 6669 6c65 2e20 5065  f cache file. Pe
-00005f60: 7266 6f72 6d61 6e63 6520 636f 756c 6420  rformance could 
-00005f70: 6265 2062 6574 7465 7220 6966 2063 6163  be better if cac
-00005f80: 6865 2066 696c 6520 7061 7468 2069 7320  he file path is 
-00005f90: 6f6e 2073 7364 206f 7220 746d 7066 730a  on ssd or tmpfs.
-00005fa0: 0a20 2020 203a 7061 7261 6d20 6d6f 6465  .    :param mode
-00005fb0: 3a20 4d6f 6465 2074 6f20 6f70 656e 2066  : Mode to open f
-00005fc0: 696c 652c 2063 6f75 6c64 2062 6520 6f6e  ile, could be on
-00005fd0: 6520 6f66 2022 7262 222c 2022 7762 2220  e of "rb", "wb" 
-00005fe0: 6f72 2022 6162 220a 2020 2020 3a70 6172  or "ab".    :par
-00005ff0: 616d 2063 6163 6865 5f70 6174 683a 2063  am cache_path: c
-00006000: 6163 6865 2066 696c 6520 7061 7468 0a20  ache file path. 
-00006010: 2020 203a 7265 7475 726e 733a 2041 6e20     :returns: An 
-00006020: 6f70 656e 6564 2042 7566 6665 7265 6452  opened BufferedR
-00006030: 6561 6465 7220 2f20 4275 6666 6572 6564  eader / Buffered
-00006040: 5772 6974 6572 206f 626a 6563 740a 2020  Writer object.  
-00006050: 2020 2727 270a 2020 2020 6966 206d 6f64    '''.    if mod
-00006060: 6520 6e6f 7420 696e 2028 2772 6227 2c20  e not in ('rb', 
-00006070: 2777 6227 2c20 2761 6227 2c20 2772 622b  'wb', 'ab', 'rb+
-00006080: 272c 2027 7762 2b27 2c20 2761 622b 2729  ', 'wb+', 'ab+')
-00006090: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-000060a0: 5661 6c75 6545 7272 6f72 2827 756e 6163  ValueError('unac
-000060b0: 6365 7074 6162 6c65 206d 6f64 653a 2025  ceptable mode: %
-000060c0: 7227 2025 206d 6f64 6529 0a20 2020 2073  r' % mode).    s
-000060d0: 335f 7572 6c20 3d20 5333 5061 7468 2873  3_url = S3Path(s
-000060e0: 335f 7572 6c29 0a20 2020 2069 6620 666f  3_url).    if fo
-000060f0: 6c6c 6f77 6c69 6e6b 733a 0a20 2020 2020  llowlinks:.     
-00006100: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00006110: 2020 2020 7333 5f75 726c 203d 2073 335f      s3_url = s3_
-00006120: 7572 6c2e 7265 6164 6c69 6e6b 2829 0a20  url.readlink(). 
-00006130: 2020 2020 2020 2065 7863 6570 7420 5333         except S3
-00006140: 4e6f 7441 4c69 6e6b 4572 726f 723a 0a20  NotALinkError:. 
-00006150: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
-00006160: 0a20 2020 2062 7563 6b65 742c 206b 6579  .    bucket, key
-00006170: 203d 2070 6172 7365 5f73 335f 7572 6c28   = parse_s3_url(
-00006180: 7333 5f75 726c 2e70 6174 685f 7769 7468  s3_url.path_with
-00006190: 5f70 726f 746f 636f 6c29 0a20 2020 2063  _protocol).    c
-000061a0: 6f6e 6669 6720 3d20 626f 746f 636f 7265  onfig = botocore
-000061b0: 2e63 6f6e 6669 672e 436f 6e66 6967 286d  .config.Config(m
-000061c0: 6178 5f70 6f6f 6c5f 636f 6e6e 6563 7469  ax_pool_connecti
-000061d0: 6f6e 733d 6d61 785f 706f 6f6c 5f63 6f6e  ons=max_pool_con
-000061e0: 6e65 6374 696f 6e73 290a 2020 2020 636c  nections).    cl
-000061f0: 6965 6e74 203d 2067 6574 5f73 335f 636c  ient = get_s3_cl
-00006200: 6965 6e74 280a 2020 2020 2020 2020 636f  ient(.        co
-00006210: 6e66 6967 3d63 6f6e 6669 672c 0a20 2020  nfig=config,.   
-00006220: 2020 2020 2063 6163 6865 5f6b 6579 3d27       cache_key='
-00006230: 7333 5f66 696c 656c 696b 655f 636c 6965  s3_filelike_clie
-00006240: 6e74 272c 0a20 2020 2020 2020 2070 726f  nt',.        pro
-00006250: 6669 6c65 5f6e 616d 653d 7333 5f75 726c  file_name=s3_url
-00006260: 2e5f 7072 6f66 696c 655f 6e61 6d65 290a  ._profile_name).
-00006270: 2020 2020 7265 7475 726e 2053 3343 6163      return S3Cac
-00006280: 6865 6448 616e 646c 6572 280a 2020 2020  hedHandler(.    
-00006290: 2020 2020 6275 636b 6574 2c20 6b65 792c      bucket, key,
-000062a0: 206d 6f64 652c 2073 335f 636c 6965 6e74   mode, s3_client
-000062b0: 3d63 6c69 656e 742c 2063 6163 6865 5f70  =client, cache_p
-000062c0: 6174 683d 6361 6368 655f 7061 7468 290a  ath=cache_path).
-000062d0: 0a0a 405f 7333 5f62 696e 6172 795f 6d6f  ..@_s3_binary_mo
-000062e0: 6465 0a64 6566 2073 335f 6275 6666 6572  de.def s3_buffer
-000062f0: 6564 5f6f 7065 6e28 0a20 2020 2020 2020  ed_open(.       
-00006300: 2073 335f 7572 6c3a 2050 6174 684c 696b   s3_url: PathLik
-00006310: 652c 0a20 2020 2020 2020 206d 6f64 653a  e,.        mode:
-00006320: 2073 7472 2c0a 2020 2020 2020 2020 666f   str,.        fo
-00006330: 6c6c 6f77 6c69 6e6b 733a 2062 6f6f 6c20  llowlinks: bool 
-00006340: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
-00006350: 202a 2c0a 2020 2020 2020 2020 6d61 785f   *,.        max_
-00006360: 636f 6e63 7572 7265 6e63 793a 204f 7074  concurrency: Opt
-00006370: 696f 6e61 6c5b 696e 745d 203d 204e 6f6e  ional[int] = Non
-00006380: 652c 0a20 2020 2020 2020 206d 6178 5f62  e,.        max_b
-00006390: 7566 6665 725f 7369 7a65 3a20 696e 7420  uffer_size: int 
-000063a0: 3d20 4445 4641 554c 545f 4d41 585f 4255  = DEFAULT_MAX_BU
-000063b0: 4646 4552 5f53 495a 452c 0a20 2020 2020  FFER_SIZE,.     
-000063c0: 2020 2066 6f72 7761 7264 5f72 6174 696f     forward_ratio
-000063d0: 3a20 4f70 7469 6f6e 616c 5b66 6c6f 6174  : Optional[float
-000063e0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
-000063f0: 2020 626c 6f63 6b5f 7369 7a65 3a20 696e    block_size: in
-00006400: 7420 3d20 4445 4641 554c 545f 424c 4f43  t = DEFAULT_BLOC
-00006410: 4b5f 5349 5a45 2c0a 2020 2020 2020 2020  K_SIZE,.        
-00006420: 6c69 6d69 7465 645f 7365 656b 6162 6c65  limited_seekable
-00006430: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
-00006440: 2020 2020 2020 2020 6275 6666 6572 6564          buffered
-00006450: 3a20 626f 6f6c 203d 2054 7275 652c 0a20  : bool = True,. 
-00006460: 2020 2020 2020 2073 6861 7265 5f63 6163         share_cac
-00006470: 6865 5f6b 6579 3a20 4f70 7469 6f6e 616c  he_key: Optional
-00006480: 5b73 7472 5d20 3d20 4e6f 6e65 2c0a 2020  [str] = None,.  
-00006490: 2020 2020 2020 6361 6368 655f 7061 7468        cache_path
-000064a0: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
-000064b0: 3d20 4e6f 6e65 0a29 202d 3e20 556e 696f  = None.) -> Unio
-000064c0: 6e5b 5333 5072 6566 6574 6368 5265 6164  n[S3PrefetchRead
-000064d0: 6572 2c20 5333 4275 6666 6572 6564 5772  er, S3BufferedWr
-000064e0: 6974 6572 2c20 696f 2e42 7566 6665 7265  iter, io.Buffere
-000064f0: 6452 6561 6465 722c 2069 6f2e 0a20 2020  dReader, io..   
-00006500: 2020 2020 2020 2020 4275 6666 6572 6564          Buffered
-00006510: 5772 6974 6572 2c20 5333 4d65 6d6f 7279  Writer, S3Memory
-00006520: 4861 6e64 6c65 725d 3a0a 2020 2020 2727  Handler]:.    ''
-00006530: 274f 7065 6e20 616e 2061 7379 6e63 6872  'Open an asynchr
-00006540: 6f6e 6f75 7320 7072 6566 6574 6368 2072  onous prefetch r
-00006550: 6561 6465 722c 2074 6f20 7375 7070 6f72  eader, to suppor
-00006560: 7420 6661 7374 2073 6571 7565 6e74 6961  t fast sequentia
-00006570: 6c20 7265 6164 0a0a 2020 2020 2e2e 206e  l read..    .. n
-00006580: 6f74 6520 3a3a 0a0a 2020 2020 2020 2020  ote ::..        
-00006590: 5573 6572 2073 686f 756c 6420 6d61 6b65  User should make
-000065a0: 2073 7572 6520 7468 6174 2072 6561 6465   sure that reade
-000065b0: 7220 2f20 7772 6974 6572 2061 7265 2063  r / writer are c
-000065c0: 6c6f 7365 6420 636f 7272 6563 746c 790a  losed correctly.
-000065d0: 0a20 2020 2020 2020 2053 7570 706f 7274  .        Support
-000065e0: 7320 636f 6e74 6578 7420 6d61 6e61 6765  s context manage
-000065f0: 720a 0a20 2020 2020 2020 2053 6f6d 6520  r..        Some 
-00006600: 7061 7261 6d65 7465 7220 7365 7474 696e  parameter settin
-00006610: 6720 6d61 7920 7065 7266 6f72 6d20 7765  g may perform we
-00006620: 6c6c 3a20 6d61 785f 636f 6e63 7572 7265  ll: max_concurre
-00006630: 6e63 793d 3130 206f 7220 3230 2c20 6d61  ncy=10 or 20, ma
-00006640: 785f 626c 6f63 6b5f 7369 7a65 3d38 206f  x_block_size=8 o
-00006650: 7220 3136 204d 422c 2064 6566 6175 6c74  r 16 MB, default
-00006660: 2076 616c 7565 204e 6f6e 6520 6d65 616e   value None mean
-00006670: 7320 7573 696e 6720 676c 6f62 616c 2074  s using global t
-00006680: 6872 6561 6420 706f 6f6c 0a0a 2020 2020  hread pool..    
-00006690: 3a70 6172 616d 206d 6178 5f63 6f6e 6375  :param max_concu
-000066a0: 7272 656e 6379 3a20 4d61 7820 646f 776e  rrency: Max down
-000066b0: 6c6f 6164 2074 6872 6561 6420 6e75 6d62  load thread numb
-000066c0: 6572 2c20 4e6f 6e65 2062 7920 6465 6661  er, None by defa
-000066d0: 756c 740a 2020 2020 3a70 6172 616d 206d  ult.    :param m
-000066e0: 6178 5f62 7566 6665 725f 7369 7a65 3a20  ax_buffer_size: 
-000066f0: 4d61 7820 6361 6368 6564 2062 7566 6665  Max cached buffe
-00006700: 7220 7369 7a65 2069 6e20 6d65 6d6f 7279  r size in memory
-00006710: 2c20 3132 384d 4220 6279 2064 6566 6175  , 128MB by defau
-00006720: 6c74 0a20 2020 203a 7061 7261 6d20 626c  lt.    :param bl
-00006730: 6f63 6b5f 7369 7a65 3a20 5369 7a65 206f  ock_size: Size o
-00006740: 6620 7369 6e67 6c65 2062 6c6f 636b 2c20  f single block, 
-00006750: 384d 4220 6279 2064 6566 6175 6c74 2e20  8MB by default. 
-00006760: 4561 6368 2062 6c6f 636b 2077 696c 6c20  Each block will 
-00006770: 6265 2075 706c 6f61 6465 6420 6f72 2064  be uploaded or d
-00006780: 6f77 6e6c 6f61 6465 6420 6279 2073 696e  ownloaded by sin
-00006790: 676c 6520 7468 7265 6164 2e0a 2020 2020  gle thread..    
-000067a0: 3a70 6172 616d 206c 696d 6974 6564 5f73  :param limited_s
-000067b0: 6565 6b61 626c 653a 2049 6620 7772 6974  eekable: If writ
-000067c0: 652d 6861 6e64 6c65 2073 7570 706f 7274  e-handle support
-000067d0: 7320 6c69 6d69 7465 6420 7365 656b 2028  s limited seek (
-000067e0: 626f 7468 2066 696c 6520 6865 6164 2070  both file head p
-000067f0: 6172 7420 616e 6420 7461 696c 2070 6172  art and tail par
-00006800: 7420 6361 6e20 7365 656b 2062 6c6f 636b  t can seek block
-00006810: 5f73 697a 6529 2e20 4e6f 7465 733a 2054  _size). Notes: T
-00006820: 6869 7320 7061 7261 6d65 7465 7220 6172  his parameter ar
-00006830: 6520 7661 6c69 6420 6f6e 6c79 2066 6f72  e valid only for
-00006840: 2077 7269 7465 2d68 616e 646c 652e 2052   write-handle. R
-00006850: 6561 642d 6861 6e64 6c65 2073 7570 706f  ead-handle suppo
-00006860: 7274 2061 7262 6974 7261 7279 2073 6565  rt arbitrary see
-00006870: 6b0a 2020 2020 3a72 6574 7572 6e73 3a20  k.    :returns: 
-00006880: 416e 206f 7065 6e65 6420 5333 5072 6566  An opened S3Pref
-00006890: 6574 6368 5265 6164 6572 206f 626a 6563  etchReader objec
-000068a0: 740a 2020 2020 3a72 6169 7365 733a 2053  t.    :raises: S
-000068b0: 3346 696c 654e 6f74 466f 756e 6445 7272  3FileNotFoundErr
-000068c0: 6f72 0a20 2020 2027 2727 0a20 2020 2069  or.    '''.    i
-000068d0: 6620 6d6f 6465 206e 6f74 2069 6e20 2827  f mode not in ('
-000068e0: 7262 272c 2027 7762 272c 2027 6162 272c  rb', 'wb', 'ab',
-000068f0: 2027 7262 2b27 2c20 2777 622b 272c 2027   'rb+', 'wb+', '
-00006900: 6162 2b27 293a 0a20 2020 2020 2020 2072  ab+'):.        r
-00006910: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00006920: 2775 6e61 6363 6570 7461 626c 6520 6d6f  'unacceptable mo
-00006930: 6465 3a20 2572 2720 2520 6d6f 6465 290a  de: %r' % mode).
-00006940: 2020 2020 7333 5f75 726c 203d 2053 3350      s3_url = S3P
-00006950: 6174 6828 7333 5f75 726c 290a 2020 2020  ath(s3_url).    
-00006960: 6966 2066 6f6c 6c6f 776c 696e 6b73 3a0a  if followlinks:.
-00006970: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00006980: 2020 2020 2020 2020 2073 335f 7572 6c20           s3_url 
-00006990: 3d20 7333 5f75 726c 2e72 6561 646c 696e  = s3_url.readlin
-000069a0: 6b28 290a 2020 2020 2020 2020 6578 6365  k().        exce
-000069b0: 7074 2053 334e 6f74 414c 696e 6b45 7272  pt S3NotALinkErr
-000069c0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-000069d0: 7061 7373 0a0a 2020 2020 6275 636b 6574  pass..    bucket
-000069e0: 2c20 6b65 7920 3d20 7061 7273 655f 7333  , key = parse_s3
-000069f0: 5f75 726c 2873 335f 7572 6c2e 7061 7468  _url(s3_url.path
-00006a00: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
-00006a10: 2020 2020 636f 6e66 6967 203d 2062 6f74      config = bot
-00006a20: 6f63 6f72 652e 636f 6e66 6967 2e43 6f6e  ocore.config.Con
-00006a30: 6669 6728 6d61 785f 706f 6f6c 5f63 6f6e  fig(max_pool_con
-00006a40: 6e65 6374 696f 6e73 3d6d 6178 5f70 6f6f  nections=max_poo
-00006a50: 6c5f 636f 6e6e 6563 7469 6f6e 7329 0a20  l_connections). 
-00006a60: 2020 2063 6c69 656e 7420 3d20 6765 745f     client = get_
-00006a70: 7333 5f63 6c69 656e 7428 0a20 2020 2020  s3_client(.     
-00006a80: 2020 2063 6f6e 6669 673d 636f 6e66 6967     config=config
-00006a90: 2c0a 2020 2020 2020 2020 6361 6368 655f  ,.        cache_
-00006aa0: 6b65 793d 2773 335f 6669 6c65 6c69 6b65  key='s3_filelike
-00006ab0: 5f63 6c69 656e 7427 2c0a 2020 2020 2020  _client',.      
-00006ac0: 2020 7072 6f66 696c 655f 6e61 6d65 3d73    profile_name=s
-00006ad0: 335f 7572 6c2e 5f70 726f 6669 6c65 5f6e  3_url._profile_n
-00006ae0: 616d 6529 0a0a 2020 2020 6966 2027 6127  ame)..    if 'a'
-00006af0: 2069 6e20 6d6f 6465 206f 7220 272b 2720   in mode or '+' 
-00006b00: 696e 206d 6f64 653a 0a20 2020 2020 2020  in mode:.       
-00006b10: 2069 6620 6361 6368 655f 7061 7468 2069   if cache_path i
-00006b20: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00006b30: 2020 2020 7265 7475 726e 2053 334d 656d      return S3Mem
-00006b40: 6f72 7948 616e 646c 6572 2862 7563 6b65  oryHandler(bucke
-00006b50: 742c 206b 6579 2c20 6d6f 6465 2c20 7333  t, key, mode, s3
-00006b60: 5f63 6c69 656e 743d 636c 6965 6e74 290a  _client=client).
-00006b70: 2020 2020 2020 2020 7265 7475 726e 2053          return S
-00006b80: 3343 6163 6865 6448 616e 646c 6572 280a  3CachedHandler(.
-00006b90: 2020 2020 2020 2020 2020 2020 6275 636b              buck
-00006ba0: 6574 2c20 6b65 792c 206d 6f64 652c 2073  et, key, mode, s
-00006bb0: 335f 636c 6965 6e74 3d63 6c69 656e 742c  3_client=client,
-00006bc0: 2063 6163 6865 5f70 6174 683d 6361 6368   cache_path=cach
-00006bd0: 655f 7061 7468 290a 0a20 2020 2069 6620  e_path)..    if 
-00006be0: 6d6f 6465 203d 3d20 2772 6227 3a0a 2020  mode == 'rb':.  
-00006bf0: 2020 2020 2020 2320 4120 726f 7567 6820        # A rough 
-00006c00: 636f 6e76 6572 7369 6f6e 2061 6c67 6f72  conversion algor
-00006c10: 6974 686d 2074 6f20 616c 6967 6e20 3220  ithm to align 2 
-00006c20: 7479 7065 7320 6f66 2052 6561 6465 7220  types of Reader 
-00006c30: 2f20 5772 6974 6572 2070 6172 616d 6574  / Writer paramet
-00006c40: 6572 730a 2020 2020 2020 2020 2320 544f  ers.        # TO
-00006c50: 444f 3a20 4f70 7469 6d69 7a65 2074 6865  DO: Optimize the
-00006c60: 2063 6f6e 7665 7273 696f 6e20 616c 676f   conversion algo
-00006c70: 7269 7468 6d0a 2020 2020 2020 2020 626c  rithm.        bl
-00006c80: 6f63 6b5f 6361 7061 6369 7479 203d 206d  ock_capacity = m
-00006c90: 6178 5f62 7566 6665 725f 7369 7a65 202f  ax_buffer_size /
-00006ca0: 2f20 626c 6f63 6b5f 7369 7a65 0a20 2020  / block_size.   
-00006cb0: 2020 2020 2069 6620 666f 7277 6172 645f       if forward_
-00006cc0: 7261 7469 6f20 6973 204e 6f6e 653a 0a20  ratio is None:. 
-00006cd0: 2020 2020 2020 2020 2020 2062 6c6f 636b             block
-00006ce0: 5f66 6f72 7761 7264 203d 204e 6f6e 650a  _forward = None.
-00006cf0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00006d00: 2020 2020 2020 2020 2020 626c 6f63 6b5f            block_
-00006d10: 666f 7277 6172 6420 3d20 6d61 7828 696e  forward = max(in
-00006d20: 7428 626c 6f63 6b5f 6361 7061 6369 7479  t(block_capacity
-00006d30: 202a 2066 6f72 7761 7264 5f72 6174 696f   * forward_ratio
-00006d40: 292c 2031 290a 2020 2020 2020 2020 6966  ), 1).        if
-00006d50: 2073 6861 7265 5f63 6163 6865 5f6b 6579   share_cache_key
-00006d60: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00006d70: 2020 2020 2020 2020 2020 7265 6164 6572            reader
-00006d80: 203d 2053 3353 6861 7265 4361 6368 6552   = S3ShareCacheR
-00006d90: 6561 6465 7228 0a20 2020 2020 2020 2020  eader(.         
-00006da0: 2020 2020 2020 2062 7563 6b65 742c 0a20         bucket,. 
-00006db0: 2020 2020 2020 2020 2020 2020 2020 206b                 k
-00006dc0: 6579 2c0a 2020 2020 2020 2020 2020 2020  ey,.            
-00006dd0: 2020 2020 6361 6368 655f 6b65 793d 7368      cache_key=sh
-00006de0: 6172 655f 6361 6368 655f 6b65 792c 0a20  are_cache_key,. 
-00006df0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00006e00: 335f 636c 6965 6e74 3d63 6c69 656e 742c  3_client=client,
-00006e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006e20: 206d 6178 5f72 6574 7269 6573 3d6d 6178   max_retries=max
-00006e30: 5f72 6574 7269 6573 2c0a 2020 2020 2020  _retries,.      
-00006e40: 2020 2020 2020 2020 2020 6d61 785f 776f            max_wo
-00006e50: 726b 6572 733d 6d61 785f 636f 6e63 7572  rkers=max_concur
-00006e60: 7265 6e63 792c 0a20 2020 2020 2020 2020  rency,.         
-00006e70: 2020 2020 2020 2062 6c6f 636b 5f73 697a         block_siz
-00006e80: 653d 626c 6f63 6b5f 7369 7a65 2c0a 2020  e=block_size,.  
-00006e90: 2020 2020 2020 2020 2020 2020 2020 626c                bl
-00006ea0: 6f63 6b5f 666f 7277 6172 643d 626c 6f63  ock_forward=bloc
-00006eb0: 6b5f 666f 7277 6172 6429 0a20 2020 2020  k_forward).     
-00006ec0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00006ed0: 2020 2020 2072 6561 6465 7220 3d20 5333       reader = S3
-00006ee0: 5072 6566 6574 6368 5265 6164 6572 280a  PrefetchReader(.
-00006ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006f00: 6275 636b 6574 2c0a 2020 2020 2020 2020  bucket,.        
-00006f10: 2020 2020 2020 2020 6b65 792c 0a20 2020          key,.   
-00006f20: 2020 2020 2020 2020 2020 2020 2073 335f               s3_
-00006f30: 636c 6965 6e74 3d63 6c69 656e 742c 0a20  client=client,. 
-00006f40: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00006f50: 6178 5f72 6574 7269 6573 3d6d 6178 5f72  ax_retries=max_r
-00006f60: 6574 7269 6573 2c0a 2020 2020 2020 2020  etries,.        
-00006f70: 2020 2020 2020 2020 6d61 785f 776f 726b          max_work
-00006f80: 6572 733d 6d61 785f 636f 6e63 7572 7265  ers=max_concurre
-00006f90: 6e63 792c 0a20 2020 2020 2020 2020 2020  ncy,.           
-00006fa0: 2020 2020 2062 6c6f 636b 5f63 6170 6163       block_capac
-00006fb0: 6974 793d 626c 6f63 6b5f 6361 7061 6369  ity=block_capaci
-00006fc0: 7479 2c0a 2020 2020 2020 2020 2020 2020  ty,.            
-00006fd0: 2020 2020 626c 6f63 6b5f 666f 7277 6172      block_forwar
-00006fe0: 643d 626c 6f63 6b5f 666f 7277 6172 642c  d=block_forward,
-00006ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007000: 2062 6c6f 636b 5f73 697a 653d 626c 6f63   block_size=bloc
-00007010: 6b5f 7369 7a65 290a 2020 2020 2020 2020  k_size).        
-00007020: 6966 2062 7566 6665 7265 643a 0a20 2020  if buffered:.   
-00007030: 2020 2020 2020 2020 2072 6561 6465 7220           reader 
-00007040: 3d20 696f 2e42 7566 6665 7265 6452 6561  = io.BufferedRea
-00007050: 6465 7228 7265 6164 6572 2920 2023 2070  der(reader)  # p
-00007060: 7974 7970 653a 2064 6973 6162 6c65 3d77  ytype: disable=w
-00007070: 726f 6e67 2d61 7267 2d74 7970 6573 0a20  rong-arg-types. 
-00007080: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-00007090: 6164 6572 0a0a 2020 2020 6966 206c 696d  ader..    if lim
-000070a0: 6974 6564 5f73 6565 6b61 626c 653a 0a20  ited_seekable:. 
-000070b0: 2020 2020 2020 2077 7269 7465 7220 3d20         writer = 
-000070c0: 5333 4c69 6d69 7465 6453 6565 6b61 626c  S3LimitedSeekabl
-000070d0: 6557 7269 7465 7228 0a20 2020 2020 2020  eWriter(.       
-000070e0: 2020 2020 2062 7563 6b65 742c 0a20 2020       bucket,.   
-000070f0: 2020 2020 2020 2020 206b 6579 2c0a 2020           key,.  
-00007100: 2020 2020 2020 2020 2020 7333 5f63 6c69            s3_cli
-00007110: 656e 743d 636c 6965 6e74 2c0a 2020 2020  ent=client,.    
-00007120: 2020 2020 2020 2020 6d61 785f 776f 726b          max_work
-00007130: 6572 733d 6d61 785f 636f 6e63 7572 7265  ers=max_concurre
-00007140: 6e63 792c 0a20 2020 2020 2020 2020 2020  ncy,.           
-00007150: 206d 6178 5f62 7566 6665 725f 7369 7a65   max_buffer_size
-00007160: 3d6d 6178 5f62 7566 6665 725f 7369 7a65  =max_buffer_size
-00007170: 2c0a 2020 2020 2020 2020 2020 2020 626c  ,.            bl
-00007180: 6f63 6b5f 7369 7a65 3d62 6c6f 636b 5f73  ock_size=block_s
-00007190: 697a 6529 0a20 2020 2065 6c73 653a 0a20  ize).    else:. 
-000071a0: 2020 2020 2020 2077 7269 7465 7220 3d20         writer = 
-000071b0: 5333 4275 6666 6572 6564 5772 6974 6572  S3BufferedWriter
-000071c0: 280a 2020 2020 2020 2020 2020 2020 6275  (.            bu
-000071d0: 636b 6574 2c0a 2020 2020 2020 2020 2020  cket,.          
-000071e0: 2020 6b65 792c 0a20 2020 2020 2020 2020    key,.         
-000071f0: 2020 2073 335f 636c 6965 6e74 3d63 6c69     s3_client=cli
-00007200: 656e 742c 0a20 2020 2020 2020 2020 2020  ent,.           
-00007210: 206d 6178 5f77 6f72 6b65 7273 3d6d 6178   max_workers=max
-00007220: 5f63 6f6e 6375 7272 656e 6379 2c0a 2020  _concurrency,.  
-00007230: 2020 2020 2020 2020 2020 6d61 785f 6275            max_bu
-00007240: 6666 6572 5f73 697a 653d 6d61 785f 6275  ffer_size=max_bu
-00007250: 6666 6572 5f73 697a 652c 0a20 2020 2020  ffer_size,.     
-00007260: 2020 2020 2020 2062 6c6f 636b 5f73 697a         block_siz
-00007270: 653d 626c 6f63 6b5f 7369 7a65 290a 2020  e=block_size).  
-00007280: 2020 6966 2062 7566 6665 7265 643a 0a20    if buffered:. 
-00007290: 2020 2020 2020 2077 7269 7465 7220 3d20         writer = 
-000072a0: 696f 2e42 7566 6665 7265 6457 7269 7465  io.BufferedWrite
-000072b0: 7228 7772 6974 6572 2920 2023 2070 7974  r(writer)  # pyt
-000072c0: 7970 653a 2064 6973 6162 6c65 3d77 726f  ype: disable=wro
-000072d0: 6e67 2d61 7267 2d74 7970 6573 0a20 2020  ng-arg-types.   
-000072e0: 2072 6574 7572 6e20 7772 6974 6572 0a0a   return writer..
-000072f0: 0a40 5f73 335f 6269 6e61 7279 5f6d 6f64  .@_s3_binary_mod
-00007300: 650a 6465 6620 7333 5f6d 656d 6f72 795f  e.def s3_memory_
-00007310: 6f70 656e 280a 2020 2020 2020 2020 7333  open(.        s3
-00007320: 5f75 726c 3a20 5061 7468 4c69 6b65 2c20  _url: PathLike, 
-00007330: 6d6f 6465 3a20 7374 722c 0a20 2020 2020  mode: str,.     
-00007340: 2020 2066 6f6c 6c6f 776c 696e 6b73 3a20     followlinks: 
-00007350: 626f 6f6c 203d 2046 616c 7365 2920 2d3e  bool = False) ->
-00007360: 2053 334d 656d 6f72 7948 616e 646c 6572   S3MemoryHandler
-00007370: 3a0a 2020 2020 2727 274f 7065 6e20 6120  :.    '''Open a 
-00007380: 6d65 6d6f 7279 2d63 6163 6865 2066 696c  memory-cache fil
-00007390: 6520 7265 6164 6572 202f 2077 7269 7465  e reader / write
-000073a0: 722c 2066 6f72 2066 7265 7175 656e 7420  r, for frequent 
-000073b0: 7261 6e64 6f6d 2072 6561 6420 2f20 7772  random read / wr
-000073c0: 6974 650a 0a20 2020 202e 2e20 6e6f 7465  ite..    .. note
-000073d0: 203a 3a0a 0a20 2020 2020 2020 2055 7365   ::..        Use
-000073e0: 7220 7368 6f75 6c64 206d 616b 6520 7375  r should make su
-000073f0: 7265 2074 6861 7420 7265 6164 6572 202f  re that reader /
-00007400: 2077 7269 7465 7220 6172 6520 636c 6f73   writer are clos
-00007410: 6564 2063 6f72 7265 6374 6c79 0a0a 2020  ed correctly..  
-00007420: 2020 2020 2020 5375 7070 6f72 7473 2063        Supports c
-00007430: 6f6e 7465 7874 206d 616e 6167 6572 0a0a  ontext manager..
-00007440: 2020 2020 3a70 6172 616d 206d 6f64 653a      :param mode:
-00007450: 204d 6f64 6520 746f 206f 7065 6e20 6669   Mode to open fi
-00007460: 6c65 2c20 636f 756c 6420 6265 206f 6e65  le, could be one
-00007470: 206f 6620 2272 6222 2c20 2277 6222 2c20   of "rb", "wb", 
-00007480: 2261 6222 2c20 2272 622b 222c 2022 7762  "ab", "rb+", "wb
-00007490: 2b22 206f 7220 2261 622b 220a 2020 2020  +" or "ab+".    
-000074a0: 3a72 6574 7572 6e73 3a20 416e 206f 7065  :returns: An ope
-000074b0: 6e65 6420 4275 6666 6572 6564 5265 6164  ned BufferedRead
-000074c0: 6572 202f 2042 7566 6665 7265 6457 7269  er / BufferedWri
-000074d0: 7465 7220 6f62 6a65 6374 0a20 2020 2027  ter object.    '
-000074e0: 2727 0a20 2020 2069 6620 6d6f 6465 206e  ''.    if mode n
-000074f0: 6f74 2069 6e20 2827 7262 272c 2027 7762  ot in ('rb', 'wb
-00007500: 272c 2027 6162 272c 2027 7262 2b27 2c20  ', 'ab', 'rb+', 
-00007510: 2777 622b 272c 2027 6162 2b27 293a 0a20  'wb+', 'ab+'):. 
-00007520: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00007530: 7565 4572 726f 7228 2775 6e61 6363 6570  ueError('unaccep
-00007540: 7461 626c 6520 6d6f 6465 3a20 2572 2720  table mode: %r' 
-00007550: 2520 6d6f 6465 290a 2020 2020 7333 5f75  % mode).    s3_u
-00007560: 726c 203d 2053 3350 6174 6828 7333 5f75  rl = S3Path(s3_u
-00007570: 726c 290a 2020 2020 6966 2066 6f6c 6c6f  rl).    if follo
-00007580: 776c 696e 6b73 3a0a 2020 2020 2020 2020  wlinks:.        
-00007590: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-000075a0: 2073 335f 7572 6c20 3d20 7333 5f75 726c   s3_url = s3_url
-000075b0: 2e72 6561 646c 696e 6b28 290a 2020 2020  .readlink().    
-000075c0: 2020 2020 6578 6365 7074 2053 334e 6f74      except S3Not
-000075d0: 414c 696e 6b45 7272 6f72 3a0a 2020 2020  ALinkError:.    
-000075e0: 2020 2020 2020 2020 7061 7373 0a0a 2020          pass..  
-000075f0: 2020 6275 636b 6574 2c20 6b65 7920 3d20    bucket, key = 
-00007600: 7061 7273 655f 7333 5f75 726c 2873 335f  parse_s3_url(s3_
-00007610: 7572 6c2e 7061 7468 5f77 6974 685f 7072  url.path_with_pr
-00007620: 6f74 6f63 6f6c 290a 2020 2020 636f 6e66  otocol).    conf
-00007630: 6967 203d 2062 6f74 6f63 6f72 652e 636f  ig = botocore.co
-00007640: 6e66 6967 2e43 6f6e 6669 6728 6d61 785f  nfig.Config(max_
-00007650: 706f 6f6c 5f63 6f6e 6e65 6374 696f 6e73  pool_connections
-00007660: 3d6d 6178 5f70 6f6f 6c5f 636f 6e6e 6563  =max_pool_connec
-00007670: 7469 6f6e 7329 0a20 2020 2063 6c69 656e  tions).    clien
-00007680: 7420 3d20 6765 745f 7333 5f63 6c69 656e  t = get_s3_clien
-00007690: 7428 0a20 2020 2020 2020 2063 6f6e 6669  t(.        confi
-000076a0: 673d 636f 6e66 6967 2c0a 2020 2020 2020  g=config,.      
-000076b0: 2020 6361 6368 655f 6b65 793d 2773 335f    cache_key='s3_
-000076c0: 6669 6c65 6c69 6b65 5f63 6c69 656e 7427  filelike_client'
-000076d0: 2c0a 2020 2020 2020 2020 7072 6f66 696c  ,.        profil
-000076e0: 655f 6e61 6d65 3d73 335f 7572 6c2e 5f70  e_name=s3_url._p
-000076f0: 726f 6669 6c65 5f6e 616d 6529 0a20 2020  rofile_name).   
-00007700: 2072 6574 7572 6e20 5333 4d65 6d6f 7279   return S3Memory
-00007710: 4861 6e64 6c65 7228 6275 636b 6574 2c20  Handler(bucket, 
-00007720: 6b65 792c 206d 6f64 652c 2073 335f 636c  key, mode, s3_cl
-00007730: 6965 6e74 3d63 6c69 656e 7429 0a0a 0a73  ient=client)...s
-00007740: 335f 6f70 656e 203d 2073 335f 6275 6666  3_open = s3_buff
-00007750: 6572 6564 5f6f 7065 6e0a 0a0a 6465 6620  ered_open...def 
-00007760: 7333 5f64 6f77 6e6c 6f61 6428 0a20 2020  s3_download(.   
-00007770: 2020 2020 2073 7263 5f75 726c 3a20 5061       src_url: Pa
-00007780: 7468 4c69 6b65 2c0a 2020 2020 2020 2020  thLike,.        
-00007790: 6473 745f 7572 6c3a 2050 6174 684c 696b  dst_url: PathLik
-000077a0: 652c 0a20 2020 2020 2020 2066 6f6c 6c6f  e,.        follo
-000077b0: 776c 696e 6b73 3a20 626f 6f6c 203d 2046  wlinks: bool = F
-000077c0: 616c 7365 2c0a 2020 2020 2020 2020 6361  alse,.        ca
-000077d0: 6c6c 6261 636b 3a20 4f70 7469 6f6e 616c  llback: Optional
-000077e0: 5b43 616c 6c61 626c 655b 5b69 6e74 5d2c  [Callable[[int],
-000077f0: 204e 6f6e 655d 5d20 3d20 4e6f 6e65 2920   None]] = None) 
-00007800: 2d3e 204e 6f6e 653a 0a20 2020 2027 2727  -> None:.    '''
-00007810: 0a20 2020 2044 6f77 6e6c 6f61 6473 2061  .    Downloads a
-00007820: 2066 696c 6520 6672 6f6d 2073 3320 746f   file from s3 to
-00007830: 206c 6f63 616c 2066 696c 6573 7973 7465   local filesyste
-00007840: 6d2e 0a20 2020 203a 7061 7261 6d20 7372  m..    :param sr
-00007850: 635f 7572 6c3a 2073 6f75 7263 6520 7333  c_url: source s3
-00007860: 2070 6174 680a 2020 2020 3a70 6172 616d   path.    :param
-00007870: 2064 7374 5f75 726c 3a20 7461 7267 6574   dst_url: target
-00007880: 2066 7320 7061 7468 0a20 2020 203a 7061   fs path.    :pa
-00007890: 7261 6d20 6361 6c6c 6261 636b 3a20 4361  ram callback: Ca
-000078a0: 6c6c 6564 2070 6572 696f 6469 6361 6c6c  lled periodicall
-000078b0: 7920 6475 7269 6e67 2063 6f70 792c 2061  y during copy, a
-000078c0: 6e64 2074 6865 2069 6e70 7574 2070 6172  nd the input par
-000078d0: 616d 6574 6572 2069 7320 7468 6520 6461  ameter is the da
-000078e0: 7461 2073 697a 6520 2869 6e20 6279 7465  ta size (in byte
-000078f0: 7329 206f 6620 636f 7079 2073 696e 6365  s) of copy since
-00007900: 2074 6865 206c 6173 7420 6361 6c6c 0a20   the last call. 
-00007910: 2020 2027 2727 0a20 2020 2073 7263 5f75     '''.    src_u
-00007920: 726c 203d 2053 3350 6174 6828 7372 635f  rl = S3Path(src_
-00007930: 7572 6c29 0a20 2020 2069 6620 666f 6c6c  url).    if foll
-00007940: 6f77 6c69 6e6b 733a 0a20 2020 2020 2020  owlinks:.       
-00007950: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00007960: 2020 7372 635f 7572 6c20 3d20 7372 635f    src_url = src_
-00007970: 7572 6c2e 7265 6164 6c69 6e6b 2829 0a20  url.readlink(). 
-00007980: 2020 2020 2020 2065 7863 6570 7420 5333         except S3
-00007990: 4e6f 7441 4c69 6e6b 4572 726f 723a 0a20  NotALinkError:. 
-000079a0: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
-000079b0: 2020 2020 7372 635f 6275 636b 6574 2c20      src_bucket, 
-000079c0: 7372 635f 6b65 7920 3d20 7061 7273 655f  src_key = parse_
-000079d0: 7333 5f75 726c 2873 7263 5f75 726c 2e70  s3_url(src_url.p
-000079e0: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-000079f0: 6c29 0a20 2020 2069 6620 6e6f 7420 7372  l).    if not sr
-00007a00: 635f 6275 636b 6574 3a0a 2020 2020 2020  c_bucket:.      
-00007a10: 2020 7261 6973 6520 5333 4275 636b 6574    raise S3Bucket
-00007a20: 4e6f 7446 6f75 6e64 4572 726f 7228 0a20  NotFoundError(. 
-00007a30: 2020 2020 2020 2020 2020 2027 456d 7074             'Empt
-00007a40: 7920 6275 636b 6574 206e 616d 653a 2025  y bucket name: %
-00007a50: 7227 2025 2073 7263 5f75 726c 2e70 6174  r' % src_url.pat
-00007a60: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-00007a70: 0a0a 2020 2020 6966 206e 6f74 2073 7263  ..    if not src
-00007a80: 5f75 726c 2e65 7869 7374 7328 293a 0a20  _url.exists():. 
-00007a90: 2020 2020 2020 2072 6169 7365 2053 3346         raise S3F
-00007aa0: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
-00007ab0: 280a 2020 2020 2020 2020 2020 2020 2746  (.            'F
-00007ac0: 696c 6520 6e6f 7420 666f 756e 643a 2025  ile not found: %
-00007ad0: 7227 2025 2073 7263 5f75 726c 2e70 6174  r' % src_url.pat
-00007ae0: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-00007af0: 0a0a 2020 2020 6966 206e 6f74 2073 7263  ..    if not src
-00007b00: 5f75 726c 2e69 735f 6669 6c65 2829 3a0a  _url.is_file():.
-00007b10: 2020 2020 2020 2020 7261 6973 6520 5333          raise S3
-00007b20: 4973 4144 6972 6563 746f 7279 4572 726f  IsADirectoryErro
-00007b30: 7228 0a20 2020 2020 2020 2020 2020 2027  r(.            '
-00007b40: 4973 2061 2064 6972 6563 746f 7279 3a20  Is a directory: 
-00007b50: 2572 2720 2520 7372 635f 7572 6c2e 7061  %r' % src_url.pa
-00007b60: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-00007b70: 290a 0a20 2020 2064 7374 5f75 726c 203d  )..    dst_url =
-00007b80: 2066 7370 6174 6828 6473 745f 7572 6c29   fspath(dst_url)
-00007b90: 0a20 2020 2069 6620 6e6f 7420 6473 745f  .    if not dst_
-00007ba0: 7572 6c20 6f72 2064 7374 5f75 726c 2e65  url or dst_url.e
-00007bb0: 6e64 7377 6974 6828 272f 2729 3a0a 2020  ndswith('/'):.  
-00007bc0: 2020 2020 2020 7261 6973 6520 5333 4973        raise S3Is
-00007bd0: 4144 6972 6563 746f 7279 4572 726f 7228  ADirectoryError(
-00007be0: 2749 7320 6120 6469 7265 6374 6f72 793a  'Is a directory:
-00007bf0: 2025 7227 2025 2064 7374 5f75 726c 290a   %r' % dst_url).
-00007c00: 0a20 2020 2064 7374 5f64 6972 6563 746f  .    dst_directo
-00007c10: 7279 203d 206f 732e 7061 7468 2e64 6972  ry = os.path.dir
-00007c20: 6e61 6d65 2864 7374 5f75 726c 290a 2020  name(dst_url).  
-00007c30: 2020 6966 2064 7374 5f64 6972 6563 746f    if dst_directo
-00007c40: 7279 2021 3d20 2727 3a0a 2020 2020 2020  ry != '':.      
-00007c50: 2020 6f73 2e6d 616b 6564 6972 7328 6473    os.makedirs(ds
-00007c60: 745f 6469 7265 6374 6f72 792c 2065 7869  t_directory, exi
-00007c70: 7374 5f6f 6b3d 5472 7565 290a 0a20 2020  st_ok=True)..   
-00007c80: 2063 6c69 656e 7420 3d20 6765 745f 7333   client = get_s3
-00007c90: 5f63 6c69 656e 7428 7072 6f66 696c 655f  _client(profile_
-00007ca0: 6e61 6d65 3d73 7263 5f75 726c 2e5f 7072  name=src_url._pr
-00007cb0: 6f66 696c 655f 6e61 6d65 290a 2020 2020  ofile_name).    
-00007cc0: 7472 793a 0a20 2020 2020 2020 2063 6c69  try:.        cli
-00007cd0: 656e 742e 646f 776e 6c6f 6164 5f66 696c  ent.download_fil
-00007ce0: 6528 7372 635f 6275 636b 6574 2c20 7372  e(src_bucket, sr
-00007cf0: 635f 6b65 792c 2064 7374 5f75 726c 2c20  c_key, dst_url, 
-00007d00: 4361 6c6c 6261 636b 3d63 616c 6c62 6163  Callback=callbac
-00007d10: 6b29 0a20 2020 2065 7863 6570 7420 4578  k).    except Ex
-00007d20: 6365 7074 696f 6e20 6173 2065 7272 6f72  ception as error
-00007d30: 3a20 2023 2070 7261 676d 613a 206e 6f20  :  # pragma: no 
-00007d40: 636f 7665 720a 2020 2020 2020 2020 6572  cover.        er
-00007d50: 726f 7220 3d20 7472 616e 736c 6174 655f  ror = translate_
-00007d60: 6673 5f65 7272 6f72 2865 7272 6f72 2c20  fs_error(error, 
-00007d70: 6473 745f 7572 6c29 0a20 2020 2020 2020  dst_url).       
-00007d80: 2065 7272 6f72 203d 2074 7261 6e73 6c61   error = transla
-00007d90: 7465 5f73 335f 6572 726f 7228 6572 726f  te_s3_error(erro
-00007da0: 722c 2073 7263 5f75 726c 2e70 6174 685f  r, src_url.path_
-00007db0: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
-00007dc0: 2020 2020 2020 2072 6169 7365 2065 7272         raise err
-00007dd0: 6f72 0a0a 2020 2020 7372 635f 7374 6174  or..    src_stat
-00007de0: 203d 2073 7263 5f75 726c 2e73 7461 7428   = src_url.stat(
-00007df0: 290a 2020 2020 6f73 2e75 7469 6d65 2864  ).    os.utime(d
-00007e00: 7374 5f75 726c 2c20 2873 7263 5f73 7461  st_url, (src_sta
-00007e10: 742e 7374 5f6d 7469 6d65 2c20 7372 635f  t.st_mtime, src_
-00007e20: 7374 6174 2e73 745f 6d74 696d 6529 290a  stat.st_mtime)).
-00007e30: 0a0a 6465 6620 7333 5f75 706c 6f61 6428  ..def s3_upload(
-00007e40: 0a20 2020 2020 2020 2073 7263 5f75 726c  .        src_url
-00007e50: 3a20 5061 7468 4c69 6b65 2c0a 2020 2020  : PathLike,.    
-00007e60: 2020 2020 6473 745f 7572 6c3a 2050 6174      dst_url: Pat
-00007e70: 684c 696b 652c 0a20 2020 2020 2020 2063  hLike,.        c
-00007e80: 616c 6c62 6163 6b3a 204f 7074 696f 6e61  allback: Optiona
-00007e90: 6c5b 4361 6c6c 6162 6c65 5b5b 696e 745d  l[Callable[[int]
-00007ea0: 2c20 4e6f 6e65 5d5d 203d 204e 6f6e 652c  , None]] = None,
-00007eb0: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
-00007ec0: 7329 202d 3e20 4e6f 6e65 3a0a 2020 2020  s) -> None:.    
-00007ed0: 2727 270a 2020 2020 5570 6c6f 6164 7320  '''.    Uploads 
-00007ee0: 6120 6669 6c65 2066 726f 6d20 6c6f 6361  a file from loca
-00007ef0: 6c20 6669 6c65 7379 7374 656d 2074 6f20  l filesystem to 
-00007f00: 7333 2e0a 2020 2020 3a70 6172 616d 2073  s3..    :param s
-00007f10: 7263 5f75 726c 3a20 736f 7572 6365 2066  rc_url: source f
-00007f20: 7320 7061 7468 0a20 2020 203a 7061 7261  s path.    :para
-00007f30: 6d20 6473 745f 7572 6c3a 2074 6172 6765  m dst_url: targe
-00007f40: 7420 7333 2070 6174 680a 2020 2020 3a70  t s3 path.    :p
-00007f50: 6172 616d 2063 616c 6c62 6163 6b3a 2043  aram callback: C
-00007f60: 616c 6c65 6420 7065 7269 6f64 6963 616c  alled periodical
-00007f70: 6c79 2064 7572 696e 6720 636f 7079 2c20  ly during copy, 
-00007f80: 616e 6420 7468 6520 696e 7075 7420 7061  and the input pa
-00007f90: 7261 6d65 7465 7220 6973 2074 6865 2064  rameter is the d
-00007fa0: 6174 6120 7369 7a65 2028 696e 2062 7974  ata size (in byt
-00007fb0: 6573 2920 6f66 2063 6f70 7920 7369 6e63  es) of copy sinc
-00007fc0: 6520 7468 6520 6c61 7374 2063 616c 6c0a  e the last call.
-00007fd0: 2020 2020 2727 270a 2020 2020 6473 745f      '''.    dst_
-00007fe0: 6275 636b 6574 2c20 6473 745f 6b65 7920  bucket, dst_key 
-00007ff0: 3d20 7061 7273 655f 7333 5f75 726c 2864  = parse_s3_url(d
-00008000: 7374 5f75 726c 290a 2020 2020 6966 206e  st_url).    if n
-00008010: 6f74 2064 7374 5f62 7563 6b65 743a 0a20  ot dst_bucket:. 
-00008020: 2020 2020 2020 2072 6169 7365 2053 3342         raise S3B
-00008030: 7563 6b65 744e 6f74 466f 756e 6445 7272  ucketNotFoundErr
-00008040: 6f72 2827 456d 7074 7920 6275 636b 6574  or('Empty bucket
-00008050: 206e 616d 653a 2025 7227 2025 2064 7374   name: %r' % dst
-00008060: 5f75 726c 290a 2020 2020 6966 206e 6f74  _url).    if not
-00008070: 2064 7374 5f6b 6579 206f 7220 6473 745f   dst_key or dst_
-00008080: 6b65 792e 656e 6473 7769 7468 2827 2f27  key.endswith('/'
-00008090: 293a 0a20 2020 2020 2020 2072 6169 7365  ):.        raise
-000080a0: 2053 3349 7341 4469 7265 6374 6f72 7945   S3IsADirectoryE
-000080b0: 7272 6f72 2827 4973 2061 2064 6972 6563  rror('Is a direc
-000080c0: 746f 7279 3a20 2572 2720 2520 6473 745f  tory: %r' % dst_
-000080d0: 7572 6c29 0a0a 2020 2020 636c 6965 6e74  url)..    client
-000080e0: 203d 2067 6574 5f73 335f 636c 6965 6e74   = get_s3_client
-000080f0: 2870 726f 6669 6c65 5f6e 616d 653d 5333  (profile_name=S3
-00008100: 5061 7468 2864 7374 5f75 726c 292e 5f70  Path(dst_url)._p
-00008110: 726f 6669 6c65 5f6e 616d 6529 0a20 2020  rofile_name).   
-00008120: 2077 6974 6820 6f70 656e 2873 7263 5f75   with open(src_u
-00008130: 726c 2c20 2772 6227 2920 6173 2073 7263  rl, 'rb') as src
-00008140: 3a0a 2020 2020 2020 2020 7769 7468 2072  :.        with r
-00008150: 6169 7365 5f73 335f 6572 726f 7228 6473  aise_s3_error(ds
-00008160: 745f 7572 6c29 3a0a 2020 2020 2020 2020  t_url):.        
-00008170: 2020 2020 636c 6965 6e74 2e75 706c 6f61      client.uploa
-00008180: 645f 6669 6c65 6f62 6a28 0a20 2020 2020  d_fileobj(.     
-00008190: 2020 2020 2020 2020 2020 2073 7263 2c20             src, 
-000081a0: 4275 636b 6574 3d64 7374 5f62 7563 6b65  Bucket=dst_bucke
-000081b0: 742c 204b 6579 3d64 7374 5f6b 6579 2c20  t, Key=dst_key, 
-000081c0: 4361 6c6c 6261 636b 3d63 616c 6c62 6163  Callback=callbac
-000081d0: 6b29 0a0a 0a64 6566 2073 335f 6c6f 6164  k)...def s3_load
-000081e0: 5f63 6f6e 7465 6e74 280a 2020 2020 2020  _content(.      
-000081f0: 2020 7333 5f75 726c 2c0a 2020 2020 2020    s3_url,.      
-00008200: 2020 7374 6172 743a 204f 7074 696f 6e61    start: Optiona
-00008210: 6c5b 696e 745d 203d 204e 6f6e 652c 0a20  l[int] = None,. 
-00008220: 2020 2020 2020 2073 746f 703a 204f 7074         stop: Opt
-00008230: 696f 6e61 6c5b 696e 745d 203d 204e 6f6e  ional[int] = Non
-00008240: 652c 0a20 2020 2020 2020 2066 6f6c 6c6f  e,.        follo
-00008250: 776c 696e 6b73 3a20 626f 6f6c 203d 2046  wlinks: bool = F
-00008260: 616c 7365 2920 2d3e 2062 7974 6573 3a0a  alse) -> bytes:.
-00008270: 2020 2020 2727 270a 2020 2020 4765 7420      '''.    Get 
-00008280: 7370 6563 6966 6965 6420 6669 6c65 2066  specified file f
-00008290: 726f 6d20 5b73 7461 7274 2c20 7374 6f70  rom [start, stop
-000082a0: 2920 696e 2062 7974 6573 0a0a 2020 2020  ) in bytes..    
-000082b0: 3a70 6172 616d 2073 335f 7572 6c3a 2053  :param s3_url: S
-000082c0: 7065 6369 6669 6564 2070 6174 680a 2020  pecified path.  
-000082d0: 2020 3a70 6172 616d 2073 7461 7274 3a20    :param start: 
-000082e0: 7374 6172 7420 696e 6465 780a 2020 2020  start index.    
-000082f0: 3a70 6172 616d 2073 746f 703a 2073 746f  :param stop: sto
-00008300: 7020 696e 6465 780a 2020 2020 3a72 6574  p index.    :ret
-00008310: 7572 6e73 3a20 6279 7465 7320 636f 6e74  urns: bytes cont
-00008320: 656e 7420 696e 2072 616e 6765 205b 7374  ent in range [st
-00008330: 6172 742c 2073 746f 7029 0a20 2020 2027  art, stop).    '
-00008340: 2727 0a0a 2020 2020 6465 6620 5f67 6574  ''..    def _get
-00008350: 5f6f 626a 6563 7428 636c 6965 6e74 2c20  _object(client, 
-00008360: 6275 636b 6574 2c20 6b65 792c 2072 616e  bucket, key, ran
-00008370: 6765 5f73 7472 293a 0a20 2020 2020 2020  ge_str):.       
-00008380: 2072 6574 7572 6e20 636c 6965 6e74 2e67   return client.g
-00008390: 6574 5f6f 626a 6563 7428 0a20 2020 2020  et_object(.     
-000083a0: 2020 2020 2020 2042 7563 6b65 743d 6275         Bucket=bu
-000083b0: 636b 6574 2c20 4b65 793d 6b65 792c 2052  cket, Key=key, R
-000083c0: 616e 6765 3d72 616e 6765 5f73 7472 295b  ange=range_str)[
-000083d0: 2742 6f64 7927 5d2e 7265 6164 2829 0a0a  'Body'].read()..
-000083e0: 2020 2020 7333 5f75 726c 203d 2053 3350      s3_url = S3P
-000083f0: 6174 6828 7333 5f75 726c 290a 2020 2020  ath(s3_url).    
-00008400: 6966 2066 6f6c 6c6f 776c 696e 6b73 3a0a  if followlinks:.
-00008410: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00008420: 2020 2020 2020 2020 2073 335f 7572 6c20           s3_url 
-00008430: 3d20 7333 5f75 726c 2e72 6561 646c 696e  = s3_url.readlin
-00008440: 6b28 290a 2020 2020 2020 2020 6578 6365  k().        exce
-00008450: 7074 2053 334e 6f74 414c 696e 6b45 7272  pt S3NotALinkErr
-00008460: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-00008470: 7061 7373 0a0a 2020 2020 6275 636b 6574  pass..    bucket
-00008480: 2c20 6b65 7920 3d20 7061 7273 655f 7333  , key = parse_s3
-00008490: 5f75 726c 2873 335f 7572 6c2e 7061 7468  _url(s3_url.path
-000084a0: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
-000084b0: 2020 2020 6966 206e 6f74 2062 7563 6b65      if not bucke
-000084c0: 743a 0a20 2020 2020 2020 2072 6169 7365  t:.        raise
-000084d0: 2053 3342 7563 6b65 744e 6f74 466f 756e   S3BucketNotFoun
-000084e0: 6445 7272 6f72 2827 456d 7074 7920 6275  dError('Empty bu
-000084f0: 636b 6574 206e 616d 653a 2025 7227 2025  cket name: %r' %
-00008500: 2073 335f 7572 6c29 0a20 2020 2069 6620   s3_url).    if 
-00008510: 6e6f 7420 6b65 7920 6f72 206b 6579 2e65  not key or key.e
-00008520: 6e64 7377 6974 6828 272f 2729 3a0a 2020  ndswith('/'):.  
-00008530: 2020 2020 2020 7261 6973 6520 5333 4973        raise S3Is
-00008540: 4144 6972 6563 746f 7279 4572 726f 7228  ADirectoryError(
-00008550: 2749 7320 6120 6469 7265 6374 6f72 793a  'Is a directory:
-00008560: 2025 7227 2025 2073 335f 7572 6c29 0a0a   %r' % s3_url)..
-00008570: 2020 2020 7374 6172 742c 2073 746f 7020      start, stop 
-00008580: 3d20 6765 745f 636f 6e74 656e 745f 6f66  = get_content_of
-00008590: 6673 6574 280a 2020 2020 2020 2020 7374  fset(.        st
-000085a0: 6172 742c 2073 746f 702c 2073 335f 7572  art, stop, s3_ur
-000085b0: 6c2e 6765 7473 697a 6528 666f 6c6c 6f77  l.getsize(follow
-000085c0: 5f73 796d 6c69 6e6b 733d 4661 6c73 6529  _symlinks=False)
-000085d0: 290a 2020 2020 6966 2073 7461 7274 203d  ).    if start =
-000085e0: 3d20 3020 616e 6420 7374 6f70 203d 3d20  = 0 and stop == 
-000085f0: 303a 0a20 2020 2020 2020 2072 6574 7572  0:.        retur
-00008600: 6e20 6227 270a 2020 2020 7261 6e67 655f  n b''.    range_
-00008610: 7374 7220 3d20 2762 7974 6573 3d25 642d  str = 'bytes=%d-
-00008620: 2564 2720 2520 2873 7461 7274 2c20 7374  %d' % (start, st
-00008630: 6f70 202d 2031 290a 0a20 2020 2063 6c69  op - 1)..    cli
-00008640: 656e 7420 3d20 6765 745f 7333 5f63 6c69  ent = get_s3_cli
-00008650: 656e 7428 7072 6f66 696c 655f 6e61 6d65  ent(profile_name
-00008660: 3d73 335f 7572 6c2e 5f70 726f 6669 6c65  =s3_url._profile
-00008670: 5f6e 616d 6529 0a20 2020 2077 6974 6820  _name).    with 
-00008680: 7261 6973 655f 7333 5f65 7272 6f72 2873  raise_s3_error(s
-00008690: 335f 7572 6c2e 7061 7468 293a 0a20 2020  3_url.path):.   
-000086a0: 2020 2020 2072 6574 7572 6e20 7061 7463       return patc
-000086b0: 685f 6d65 7468 6f64 280a 2020 2020 2020  h_method(.      
-000086c0: 2020 2020 2020 5f67 6574 5f6f 626a 6563        _get_objec
-000086d0: 742c 0a20 2020 2020 2020 2020 2020 206d  t,.            m
-000086e0: 6178 5f72 6574 7269 6573 3d6d 6178 5f72  ax_retries=max_r
-000086f0: 6574 7269 6573 2c0a 2020 2020 2020 2020  etries,.        
-00008700: 2020 2020 7368 6f75 6c64 5f72 6574 7279      should_retry
-00008710: 3d73 335f 7368 6f75 6c64 5f72 6574 7279  =s3_should_retry
-00008720: 2c0a 2020 2020 2020 2020 2928 636c 6965  ,.        )(clie
-00008730: 6e74 2c20 6275 636b 6574 2c20 6b65 792c  nt, bucket, key,
-00008740: 2072 616e 6765 5f73 7472 290a 0a0a 6465   range_str)...de
-00008750: 6620 7333 5f72 6561 646c 696e 6b28 7061  f s3_readlink(pa
-00008760: 7468 2920 2d3e 2073 7472 3a0a 2020 2020  th) -> str:.    
-00008770: 2727 270a 2020 2020 5265 7475 726e 2061  '''.    Return a
-00008780: 2073 7472 696e 6720 7265 7072 6573 656e   string represen
-00008790: 7469 6e67 2074 6865 2070 6174 6820 746f  ting the path to
-000087a0: 2077 6869 6368 2074 6865 2073 796d 626f   which the symbo
-000087b0: 6c69 6320 6c69 6e6b 2070 6f69 6e74 732e  lic link points.
-000087c0: 0a0a 2020 2020 3a72 6574 7572 6e73 3a20  ..    :returns: 
-000087d0: 5265 7475 726e 2061 2073 7472 696e 6720  Return a string 
-000087e0: 7265 7072 6573 656e 7469 6e67 2074 6865  representing the
-000087f0: 2070 6174 6820 746f 2077 6869 6368 2074   path to which t
-00008800: 6865 2073 796d 626f 6c69 6320 6c69 6e6b  he symbolic link
-00008810: 2070 6f69 6e74 732e 0a20 2020 203a 7261   points..    :ra
-00008820: 6973 6573 3a20 5333 4e61 6d65 546f 6f4c  ises: S3NameTooL
-00008830: 6f6e 6745 7272 6f72 2c20 5333 4275 636b  ongError, S3Buck
-00008840: 6574 4e6f 7446 6f75 6e64 4572 726f 722c  etNotFoundError,
-00008850: 2053 3349 7341 4469 7265 6374 6f72 7945   S3IsADirectoryE
-00008860: 7272 6f72 2c20 5333 4e6f 7441 4c69 6e6b  rror, S3NotALink
-00008870: 4572 726f 720a 2020 2020 2727 270a 2020  Error.    '''.  
-00008880: 2020 7265 7475 726e 2053 3350 6174 6828    return S3Path(
-00008890: 7061 7468 292e 7265 6164 6c69 6e6b 2829  path).readlink()
-000088a0: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
-000088b0: 636f 6c0a 0a0a 6465 6620 7333 5f72 656e  col...def s3_ren
-000088c0: 616d 6528 7372 635f 7572 6c3a 2050 6174  ame(src_url: Pat
-000088d0: 684c 696b 652c 2064 7374 5f75 726c 3a20  hLike, dst_url: 
-000088e0: 5061 7468 4c69 6b65 293a 0a20 2020 2027  PathLike):.    '
-000088f0: 2727 0a20 2020 204d 6f76 6520 7333 2066  ''.    Move s3 f
-00008900: 696c 6520 7061 7468 2066 726f 6d20 7372  ile path from sr
-00008910: 635f 7572 6c20 746f 2064 7374 5f75 726c  c_url to dst_url
-00008920: 0a0a 2020 2020 3a70 6172 616d 2064 7374  ..    :param dst
-00008930: 5f75 726c 3a20 4769 7665 6e20 6465 7374  _url: Given dest
-00008940: 696e 6174 696f 6e20 7061 7468 0a20 2020  ination path.   
-00008950: 2027 2727 0a20 2020 2073 7263 5f70 6174   '''.    src_pat
-00008960: 685f 696e 7320 3d20 5333 5061 7468 2873  h_ins = S3Path(s
-00008970: 7263 5f75 726c 290a 2020 2020 6966 2073  rc_url).    if s
-00008980: 7263 5f70 6174 685f 696e 732e 6973 5f66  rc_path_ins.is_f
-00008990: 696c 6528 293a 0a20 2020 2020 2020 2073  ile():.        s
-000089a0: 7263 5f70 6174 685f 696e 732e 636f 7079  rc_path_ins.copy
-000089b0: 2864 7374 5f75 726c 290a 2020 2020 656c  (dst_url).    el
-000089c0: 7365 3a0a 2020 2020 2020 2020 7372 635f  se:.        src_
-000089d0: 7061 7468 5f69 6e73 2e73 796e 6328 6473  path_ins.sync(ds
-000089e0: 745f 7572 6c29 0a20 2020 2073 7263 5f70  t_url).    src_p
-000089f0: 6174 685f 696e 732e 7265 6d6f 7665 2829  ath_ins.remove()
-00008a00: 0a0a 0a63 6c61 7373 2053 3343 6163 6865  ...class S3Cache
-00008a10: 7228 4669 6c65 4361 6368 6572 293a 0a20  r(FileCacher):. 
-00008a20: 2020 2063 6163 6865 5f70 6174 6820 3d20     cache_path = 
-00008a30: 4e6f 6e65 0a0a 2020 2020 6465 6620 5f5f  None..    def __
-00008a40: 696e 6974 5f5f 280a 2020 2020 2020 2020  init__(.        
-00008a50: 2020 2020 7365 6c66 2c20 7061 7468 3a20      self, path: 
-00008a60: 7374 722c 2063 6163 6865 5f70 6174 683a  str, cache_path:
-00008a70: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
-00008a80: 204e 6f6e 652c 206d 6f64 653a 2073 7472   None, mode: str
-00008a90: 203d 2027 7227 293a 0a20 2020 2020 2020   = 'r'):.       
-00008aa0: 2069 6620 6d6f 6465 206e 6f74 2069 6e20   if mode not in 
-00008ab0: 2827 7227 2c20 2777 272c 2027 6127 293a  ('r', 'w', 'a'):
-00008ac0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00008ad0: 7365 2056 616c 7565 4572 726f 7228 2775  se ValueError('u
-00008ae0: 6e61 6363 6570 7461 626c 6520 6d6f 6465  nacceptable mode
-00008af0: 3a20 2572 2720 2520 6d6f 6465 290a 2020  : %r' % mode).  
-00008b00: 2020 2020 2020 6966 206d 6f64 6520 696e        if mode in
-00008b10: 2028 2772 272c 2027 6127 293a 0a20 2020   ('r', 'a'):.   
-00008b20: 2020 2020 2020 2020 2069 6620 6361 6368           if cach
-00008b30: 655f 7061 7468 2069 7320 4e6f 6e65 3a0a  e_path is None:.
-00008b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008b50: 6361 6368 655f 7061 7468 203d 2067 656e  cache_path = gen
-00008b60: 6572 6174 655f 6361 6368 655f 7061 7468  erate_cache_path
-00008b70: 2870 6174 6829 0a20 2020 2020 2020 2020  (path).         
-00008b80: 2020 2073 335f 646f 776e 6c6f 6164 2870     s3_download(p
-00008b90: 6174 682c 2063 6163 6865 5f70 6174 6829  ath, cache_path)
-00008ba0: 0a20 2020 2020 2020 2073 656c 662e 6e61  .        self.na
-00008bb0: 6d65 203d 2070 6174 680a 2020 2020 2020  me = path.      
-00008bc0: 2020 7365 6c66 2e6d 6f64 6520 3d20 6d6f    self.mode = mo
-00008bd0: 6465 0a20 2020 2020 2020 2073 656c 662e  de.        self.
-00008be0: 6361 6368 655f 7061 7468 203d 2063 6163  cache_path = cac
-00008bf0: 6865 5f70 6174 680a 0a20 2020 2064 6566  he_path..    def
-00008c00: 205f 636c 6f73 6528 7365 6c66 293a 0a20   _close(self):. 
-00008c10: 2020 2020 2020 2069 6620 7365 6c66 2e63         if self.c
-00008c20: 6163 6865 5f70 6174 6820 6973 206e 6f74  ache_path is not
-00008c30: 204e 6f6e 6520 616e 6420 5c0a 2020 2020   None and \.    
-00008c40: 2020 2020 2020 2020 6f73 2e70 6174 682e          os.path.
-00008c50: 6578 6973 7473 2873 656c 662e 6361 6368  exists(self.cach
-00008c60: 655f 7061 7468 293a 0a20 2020 2020 2020  e_path):.       
-00008c70: 2020 2020 2069 6620 7365 6c66 2e6d 6f64       if self.mod
-00008c80: 6520 696e 2028 2777 272c 2027 6127 293a  e in ('w', 'a'):
-00008c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008ca0: 2073 335f 7570 6c6f 6164 2873 656c 662e   s3_upload(self.
-00008cb0: 6361 6368 655f 7061 7468 2c20 7365 6c66  cache_path, self
-00008cc0: 2e6e 616d 6529 0a20 2020 2020 2020 2020  .name).         
-00008cd0: 2020 206f 732e 756e 6c69 6e6b 2873 656c     os.unlink(sel
-00008ce0: 662e 6361 6368 655f 7061 7468 290a 0a0a  f.cache_path)...
-00008cf0: 6465 6620 7333 5f67 6c6f 6228 0a20 2020  def s3_glob(.   
-00008d00: 2020 2020 2070 6174 683a 2050 6174 684c       path: PathL
-00008d10: 696b 652c 0a20 2020 2020 2020 2072 6563  ike,.        rec
-00008d20: 7572 7369 7665 3a20 626f 6f6c 203d 2054  ursive: bool = T
-00008d30: 7275 652c 0a20 2020 2020 2020 206d 6973  rue,.        mis
-00008d40: 7369 6e67 5f6f 6b3a 2062 6f6f 6c20 3d20  sing_ok: bool = 
-00008d50: 5472 7565 2c0a 2020 2020 2020 2020 666f  True,.        fo
-00008d60: 6c6c 6f77 6c69 6e6b 733a 2062 6f6f 6c20  llowlinks: bool 
-00008d70: 3d20 4661 6c73 652c 0a29 202d 3e20 4c69  = False,.) -> Li
-00008d80: 7374 5b73 7472 5d3a 0a20 2020 2027 2727  st[str]:.    '''
-00008d90: 5265 7475 726e 2073 3320 7061 7468 206c  Return s3 path l
-00008da0: 6973 7420 696e 2061 7363 656e 6469 6e67  ist in ascending
-00008db0: 2061 6c70 6861 6265 7469 6361 6c20 6f72   alphabetical or
-00008dc0: 6465 722c 2069 6e20 7768 6963 6820 7061  der, in which pa
-00008dd0: 7468 206d 6174 6368 6573 2067 6c6f 6220  th matches glob 
-00008de0: 7061 7474 6572 6e0a 2020 2020 4e6f 7465  pattern.    Note
-00008df0: 733a 204f 6e6c 7920 676c 6f62 2069 6e20  s: Only glob in 
-00008e00: 6275 636b 6574 2e20 4966 2074 7279 696e  bucket. If tryin
-00008e10: 6720 746f 206d 6174 6368 2062 7563 6b65  g to match bucke
-00008e20: 7420 7769 7468 2077 696c 6463 6172 6420  t with wildcard 
-00008e30: 6368 6172 6163 7465 7273 2c20 7261 6973  characters, rais
-00008e40: 6520 556e 7375 7070 6f72 7465 6445 7272  e UnsupportedErr
-00008e50: 6f72 0a0a 2020 2020 3a70 6172 616d 2072  or..    :param r
-00008e60: 6563 7572 7369 7665 3a20 4966 2046 616c  ecursive: If Fal
-00008e70: 7365 2c20 602a 2a60 2077 696c 6c20 6e6f  se, `**` will no
-00008e80: 7420 7365 6172 6368 2064 6972 6563 746f  t search directo
-00008e90: 7279 2072 6563 7572 7369 7665 6c79 0a20  ry recursively. 
-00008ea0: 2020 203a 7061 7261 6d20 6d69 7373 696e     :param missin
-00008eb0: 675f 6f6b 3a20 4966 2046 616c 7365 2061  g_ok: If False a
-00008ec0: 6e64 2074 6172 6765 7420 7061 7468 2064  nd target path d
-00008ed0: 6f65 736e 2774 206d 6174 6368 2061 6e79  oesn't match any
-00008ee0: 2066 696c 652c 2072 6169 7365 2046 696c   file, raise Fil
-00008ef0: 654e 6f74 466f 756e 6445 7272 6f72 0a20  eNotFoundError. 
-00008f00: 2020 203a 7261 6973 6573 3a20 556e 7375     :raises: Unsu
-00008f10: 7070 6f72 7465 6445 7272 6f72 2c20 7768  pportedError, wh
-00008f20: 656e 2062 7563 6b65 7420 7061 7274 2063  en bucket part c
-00008f30: 6f6e 7461 696e 7320 7769 6c64 6361 7264  ontains wildcard
-00008f40: 2063 6861 7261 6374 6572 730a 2020 2020   characters.    
-00008f50: 3a72 6574 7572 6e73 3a20 4120 6c69 7374  :returns: A list
-00008f60: 2063 6f6e 7461 696e 7320 7061 7468 7320   contains paths 
-00008f70: 6d61 7463 6820 6073 335f 7061 7468 6e61  match `s3_pathna
-00008f80: 6d65 600a 2020 2020 2727 270a 2020 2020  me`.    '''.    
-00008f90: 7265 7475 726e 206c 6973 7428 0a20 2020  return list(.   
-00008fa0: 2020 2020 2073 335f 6967 6c6f 6228 0a20       s3_iglob(. 
-00008fb0: 2020 2020 2020 2020 2020 2070 6174 683d             path=
-00008fc0: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
-00008fd0: 2020 7265 6375 7273 6976 653d 7265 6375    recursive=recu
-00008fe0: 7273 6976 652c 0a20 2020 2020 2020 2020  rsive,.         
-00008ff0: 2020 206d 6973 7369 6e67 5f6f 6b3d 6d69     missing_ok=mi
-00009000: 7373 696e 675f 6f6b 2c0a 2020 2020 2020  ssing_ok,.      
-00009010: 2020 2020 2020 666f 6c6c 6f77 6c69 6e6b        followlink
-00009020: 733d 666f 6c6c 6f77 6c69 6e6b 7329 290a  s=followlinks)).
-00009030: 0a0a 6465 6620 7333 5f67 6c6f 625f 7374  ..def s3_glob_st
-00009040: 6174 280a 2020 2020 2020 2020 7061 7468  at(.        path
-00009050: 3a20 5061 7468 4c69 6b65 2c0a 2020 2020  : PathLike,.    
-00009060: 2020 2020 7265 6375 7273 6976 653a 2062      recursive: b
-00009070: 6f6f 6c20 3d20 5472 7565 2c0a 2020 2020  ool = True,.    
-00009080: 2020 2020 6d69 7373 696e 675f 6f6b 3a20      missing_ok: 
-00009090: 626f 6f6c 203d 2054 7275 652c 0a20 2020  bool = True,.   
-000090a0: 2020 2020 2066 6f6c 6c6f 776c 696e 6b73       followlinks
-000090b0: 3a20 626f 6f6c 203d 2046 616c 7365 2920  : bool = False) 
-000090c0: 2d3e 2049 7465 7261 746f 725b 4669 6c65  -> Iterator[File
-000090d0: 456e 7472 795d 3a0a 2020 2020 2727 2752  Entry]:.    '''R
-000090e0: 6574 7572 6e20 6120 6765 6e65 7261 746f  eturn a generato
-000090f0: 7220 636f 6e74 6169 6e73 2074 7570 6c65  r contains tuple
-00009100: 7320 6f66 2070 6174 6820 616e 6420 6669  s of path and fi
-00009110: 6c65 2073 7461 742c 2069 6e20 6173 6365  le stat, in asce
-00009120: 6e64 696e 6720 616c 7068 6162 6574 6963  nding alphabetic
-00009130: 616c 206f 7264 6572 2c20 696e 2077 6869  al order, in whi
-00009140: 6368 2070 6174 6820 6d61 7463 6865 7320  ch path matches 
-00009150: 676c 6f62 2070 6174 7465 726e 0a20 2020  glob pattern.   
-00009160: 204e 6f74 6573 3a20 4f6e 6c79 2067 6c6f   Notes: Only glo
-00009170: 6220 696e 2062 7563 6b65 742e 2049 6620  b in bucket. If 
-00009180: 7472 7969 6e67 2074 6f20 6d61 7463 6820  trying to match 
-00009190: 6275 636b 6574 2077 6974 6820 7769 6c64  bucket with wild
-000091a0: 6361 7264 2063 6861 7261 6374 6572 732c  card characters,
-000091b0: 2072 6169 7365 2055 6e73 7570 706f 7274   raise Unsupport
-000091c0: 6564 4572 726f 720a 0a20 2020 203a 7061  edError..    :pa
-000091d0: 7261 6d20 7265 6375 7273 6976 653a 2049  ram recursive: I
-000091e0: 6620 4661 6c73 652c 2060 2a2a 6020 7769  f False, `**` wi
-000091f0: 6c6c 206e 6f74 2073 6561 7263 6820 6469  ll not search di
-00009200: 7265 6374 6f72 7920 7265 6375 7273 6976  rectory recursiv
-00009210: 656c 790a 2020 2020 3a70 6172 616d 206d  ely.    :param m
-00009220: 6973 7369 6e67 5f6f 6b3a 2049 6620 4661  issing_ok: If Fa
-00009230: 6c73 6520 616e 6420 7461 7267 6574 2070  lse and target p
-00009240: 6174 6820 646f 6573 6e27 7420 6d61 7463  ath doesn't matc
-00009250: 6820 616e 7920 6669 6c65 2c20 7261 6973  h any file, rais
-00009260: 6520 4669 6c65 4e6f 7446 6f75 6e64 4572  e FileNotFoundEr
-00009270: 726f 720a 2020 2020 3a72 6169 7365 733a  ror.    :raises:
-00009280: 2055 6e73 7570 706f 7274 6564 4572 726f   UnsupportedErro
-00009290: 722c 2077 6865 6e20 6275 636b 6574 2070  r, when bucket p
-000092a0: 6172 7420 636f 6e74 6169 6e73 2077 696c  art contains wil
-000092b0: 6463 6172 6420 6368 6172 6163 7465 7273  dcard characters
-000092c0: 0a20 2020 203a 7265 7475 726e 733a 2041  .    :returns: A
-000092d0: 2067 656e 6572 6174 6f72 2063 6f6e 7461   generator conta
-000092e0: 696e 7320 7475 706c 6573 206f 6620 7061  ins tuples of pa
-000092f0: 7468 2061 6e64 2066 696c 6520 7374 6174  th and file stat
-00009300: 2c20 696e 2077 6869 6368 2070 6174 6873  , in which paths
-00009310: 206d 6174 6368 2060 7333 5f70 6174 686e   match `s3_pathn
-00009320: 616d 6560 0a20 2020 2027 2727 0a20 2020  ame`.    '''.   
-00009330: 2072 6574 7572 6e20 5333 5061 7468 2870   return S3Path(p
-00009340: 6174 6829 2e67 6c6f 625f 7374 6174 280a  ath).glob_stat(.
-00009350: 2020 2020 2020 2020 7061 7474 6572 6e3d          pattern=
-00009360: 2222 2c0a 2020 2020 2020 2020 7265 6375  "",.        recu
-00009370: 7273 6976 653d 7265 6375 7273 6976 652c  rsive=recursive,
-00009380: 0a20 2020 2020 2020 206d 6973 7369 6e67  .        missing
-00009390: 5f6f 6b3d 6d69 7373 696e 675f 6f6b 2c0a  _ok=missing_ok,.
-000093a0: 2020 2020 2020 2020 666f 6c6c 6f77 6c69          followli
-000093b0: 6e6b 733d 666f 6c6c 6f77 6c69 6e6b 7329  nks=followlinks)
-000093c0: 0a0a 0a64 6566 2073 335f 6967 6c6f 6228  ...def s3_iglob(
-000093d0: 0a20 2020 2020 2020 2070 6174 683a 2050  .        path: P
-000093e0: 6174 684c 696b 652c 0a20 2020 2020 2020  athLike,.       
-000093f0: 2072 6563 7572 7369 7665 3a20 626f 6f6c   recursive: bool
-00009400: 203d 2054 7275 652c 0a20 2020 2020 2020   = True,.       
-00009410: 206d 6973 7369 6e67 5f6f 6b3a 2062 6f6f   missing_ok: boo
-00009420: 6c20 3d20 5472 7565 2c0a 2020 2020 2020  l = True,.      
-00009430: 2020 666f 6c6c 6f77 6c69 6e6b 733a 2062    followlinks: b
-00009440: 6f6f 6c20 3d20 4661 6c73 652c 0a29 202d  ool = False,.) -
-00009450: 3e20 4974 6572 6174 6f72 5b73 7472 5d3a  > Iterator[str]:
-00009460: 0a20 2020 2027 2727 5265 7475 726e 2073  .    '''Return s
-00009470: 3320 7061 7468 2069 7465 7261 746f 7220  3 path iterator 
-00009480: 696e 2061 7363 656e 6469 6e67 2061 6c70  in ascending alp
-00009490: 6861 6265 7469 6361 6c20 6f72 6465 722c  habetical order,
-000094a0: 2069 6e20 7768 6963 6820 7061 7468 206d   in which path m
-000094b0: 6174 6368 6573 2067 6c6f 6220 7061 7474  atches glob patt
-000094c0: 6572 6e0a 2020 2020 4e6f 7465 733a 204f  ern.    Notes: O
-000094d0: 6e6c 7920 676c 6f62 2069 6e20 6275 636b  nly glob in buck
-000094e0: 6574 2e20 4966 2074 7279 696e 6720 746f  et. If trying to
-000094f0: 206d 6174 6368 2062 7563 6b65 7420 7769   match bucket wi
-00009500: 7468 2077 696c 6463 6172 6420 6368 6172  th wildcard char
-00009510: 6163 7465 7273 2c20 7261 6973 6520 556e  acters, raise Un
-00009520: 7375 7070 6f72 7465 6445 7272 6f72 0a0a  supportedError..
-00009530: 2020 2020 3a70 6172 616d 2072 6563 7572      :param recur
-00009540: 7369 7665 3a20 4966 2046 616c 7365 2c20  sive: If False, 
-00009550: 602a 2a60 2077 696c 6c20 6e6f 7420 7365  `**` will not se
-00009560: 6172 6368 2064 6972 6563 746f 7279 2072  arch directory r
-00009570: 6563 7572 7369 7665 6c79 0a20 2020 203a  ecursively.    :
-00009580: 7061 7261 6d20 6d69 7373 696e 675f 6f6b  param missing_ok
-00009590: 3a20 4966 2046 616c 7365 2061 6e64 2074  : If False and t
-000095a0: 6172 6765 7420 7061 7468 2064 6f65 736e  arget path doesn
-000095b0: 2774 206d 6174 6368 2061 6e79 2066 696c  't match any fil
-000095c0: 652c 2072 6169 7365 2046 696c 654e 6f74  e, raise FileNot
-000095d0: 466f 756e 6445 7272 6f72 0a20 2020 203a  FoundError.    :
-000095e0: 7261 6973 6573 3a20 556e 7375 7070 6f72  raises: Unsuppor
-000095f0: 7465 6445 7272 6f72 2c20 7768 656e 2062  tedError, when b
-00009600: 7563 6b65 7420 7061 7274 2063 6f6e 7461  ucket part conta
-00009610: 696e 7320 7769 6c64 6361 7264 2063 6861  ins wildcard cha
-00009620: 7261 6374 6572 730a 2020 2020 3a72 6574  racters.    :ret
-00009630: 7572 6e73 3a20 416e 2069 7465 7261 746f  urns: An iterato
-00009640: 7220 636f 6e74 6169 6e73 2070 6174 6873  r contains paths
-00009650: 206d 6174 6368 2060 7333 5f70 6174 686e   match `s3_pathn
-00009660: 616d 6560 0a20 2020 2027 2727 0a20 2020  ame`.    '''.   
-00009670: 2066 6f72 2070 6174 685f 6f62 6a20 696e   for path_obj in
-00009680: 2053 3350 6174 6828 7061 7468 292e 6967   S3Path(path).ig
-00009690: 6c6f 6228 7061 7474 6572 6e3d 2222 2c20  lob(pattern="", 
-000096a0: 7265 6375 7273 6976 653d 7265 6375 7273  recursive=recurs
-000096b0: 6976 652c 0a20 2020 2020 2020 2020 2020  ive,.           
-000096c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000096d0: 2020 2020 2020 2020 2020 2020 6d69 7373              miss
-000096e0: 696e 675f 6f6b 3d6d 6973 7369 6e67 5f6f  ing_ok=missing_o
-000096f0: 6b2c 0a20 2020 2020 2020 2020 2020 2020  k,.             
-00009700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009710: 2020 2020 2020 2020 2020 666f 6c6c 6f77            follow
-00009720: 6c69 6e6b 733d 666f 6c6c 6f77 6c69 6e6b  links=followlink
-00009730: 7329 3a0a 2020 2020 2020 2020 7969 656c  s):.        yiel
-00009740: 6420 7061 7468 5f6f 626a 2e70 6174 685f  d path_obj.path_
-00009750: 7769 7468 5f70 726f 746f 636f 6c0a 0a0a  with_protocol...
-00009760: 6465 6620 7333 5f6d 616b 6564 6972 7328  def s3_makedirs(
-00009770: 7061 7468 3a20 5061 7468 4c69 6b65 2c20  path: PathLike, 
-00009780: 6578 6973 745f 6f6b 3a20 626f 6f6c 203d  exist_ok: bool =
-00009790: 2046 616c 7365 293a 0a20 2020 2027 2727   False):.    '''
-000097a0: 0a20 2020 2043 7265 6174 6520 616e 2073  .    Create an s
-000097b0: 3320 6469 7265 6374 6f72 792e 0a20 2020  3 directory..   
-000097c0: 2050 7572 656c 7920 6372 6561 7469 6e67   Purely creating
-000097d0: 2064 6972 6563 746f 7279 2069 7320 696e   directory is in
-000097e0: 7661 6c69 6420 6265 6361 7573 6520 6974  valid because it
-000097f0: 2773 2075 6e61 7661 696c 6162 6c65 206f  's unavailable o
-00009800: 6e20 4f53 532e 0a20 2020 2054 6869 7320  n OSS..    This 
-00009810: 6675 6e63 7469 6f6e 2069 7320 746f 2074  function is to t
-00009820: 6573 7420 7468 6520 7461 7267 6574 2062  est the target b
-00009830: 7563 6b65 7420 6861 7665 2057 5249 5445  ucket have WRITE
-00009840: 2061 6363 6573 732e 0a0a 2020 2020 3a70   access...    :p
-00009850: 6172 616d 2070 6174 683a 2047 6976 656e  aram path: Given
-00009860: 2070 6174 680a 2020 2020 3a70 6172 616d   path.    :param
-00009870: 2065 7869 7374 5f6f 6b3a 2049 6620 4661   exist_ok: If Fa
-00009880: 6c73 6520 616e 6420 7461 7267 6574 2064  lse and target d
-00009890: 6972 6563 746f 7279 2065 7869 7374 732c  irectory exists,
-000098a0: 2072 6169 7365 2053 3346 696c 6545 7869   raise S3FileExi
-000098b0: 7374 7345 7272 6f72 0a20 2020 203a 7261  stsError.    :ra
-000098c0: 6973 6573 3a20 5333 4275 636b 6574 4e6f  ises: S3BucketNo
-000098d0: 7446 6f75 6e64 4572 726f 722c 2053 3346  tFoundError, S3F
-000098e0: 696c 6545 7869 7374 7345 7272 6f72 0a20  ileExistsError. 
-000098f0: 2020 2027 2727 0a20 2020 2072 6574 7572     '''.    retur
-00009900: 6e20 5333 5061 7468 2870 6174 6829 2e6d  n S3Path(path).m
-00009910: 6b64 6972 2870 6172 656e 7473 3d54 7275  kdir(parents=Tru
-00009920: 652c 2065 7869 7374 5f6f 6b3d 6578 6973  e, exist_ok=exis
-00009930: 745f 6f6b 290a 0a0a 6465 6620 5f67 726f  t_ok)...def _gro
-00009940: 7570 5f73 7263 5f70 6174 6873 5f62 795f  up_src_paths_by_
-00009950: 626c 6f63 6b28 0a20 2020 2020 2020 2073  block(.        s
-00009960: 7263 5f70 6174 6873 3a20 4c69 7374 5b50  rc_paths: List[P
-00009970: 6174 684c 696b 655d 2c20 626c 6f63 6b5f  athLike], block_
-00009980: 7369 7a65 3a20 696e 7420 3d20 4445 4641  size: int = DEFA
-00009990: 554c 545f 424c 4f43 4b5f 5349 5a45 0a29  ULT_BLOCK_SIZE.)
-000099a0: 202d 3e20 4c69 7374 5b4c 6973 745b 5475   -> List[List[Tu
-000099b0: 706c 655b 5061 7468 4c69 6b65 2c20 4f70  ple[PathLike, Op
-000099c0: 7469 6f6e 616c 5b73 7472 5d5d 5d5d 3a0a  tional[str]]]]:.
-000099d0: 2020 2020 6772 6f75 7073 203d 205b 5d0a      groups = [].
-000099e0: 2020 2020 6375 7272 656e 745f 6772 6f75      current_grou
-000099f0: 702c 2063 7572 7265 6e74 5f67 726f 7570  p, current_group
-00009a00: 5f73 697a 6520 3d20 5b5d 2c20 300a 2020  _size = [], 0.  
-00009a10: 2020 666f 7220 7372 635f 7061 7468 2069    for src_path i
-00009a20: 6e20 7372 635f 7061 7468 733a 0a20 2020  n src_paths:.   
-00009a30: 2020 2020 2063 7572 7265 6e74 5f66 696c       current_fil
-00009a40: 655f 7369 7a65 203d 2053 3350 6174 6828  e_size = S3Path(
-00009a50: 7372 635f 7061 7468 292e 7374 6174 2829  src_path).stat()
-00009a60: 2e73 697a 650a 2020 2020 2020 2020 6966  .size.        if
-00009a70: 2063 7572 7265 6e74 5f66 696c 655f 7369   current_file_si
-00009a80: 7a65 203d 3d20 303a 2020 2320 7072 6167  ze == 0:  # prag
-00009a90: 6d61 3a20 6e6f 2063 6f76 6572 0a20 2020  ma: no cover.   
-00009aa0: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
-00009ab0: 650a 0a20 2020 2020 2020 2069 6620 6375  e..        if cu
-00009ac0: 7272 656e 745f 6669 6c65 5f73 697a 6520  rrent_file_size 
-00009ad0: 3e3d 2062 6c6f 636b 5f73 697a 653a 0a20  >= block_size:. 
-00009ae0: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
-00009af0: 6e28 6772 6f75 7073 2920 3d3d 2030 3a0a  n(groups) == 0:.
-00009b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009b10: 6966 2063 7572 7265 6e74 5f67 726f 7570  if current_group
-00009b20: 5f73 697a 6520 2b20 6375 7272 656e 745f  _size + current_
-00009b30: 6669 6c65 5f73 697a 6520 3e20 3220 2a20  file_size > 2 * 
-00009b40: 626c 6f63 6b5f 7369 7a65 3a0a 2020 2020  block_size:.    
+000041a0: 2020 2020 2020 2020 6469 726e 616d 6573          dirnames
+000041b0: 2e61 6464 2864 6972 6e61 6d65 290a 2020  .add(dirname).  
+000041c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000041d0: 2020 2020 2020 7061 7468 203d 2064 6972        path = dir
+000041e0: 6e61 6d65 202b 2027 2f27 2069 6620 7365  name + '/' if se
+000041f0: 6172 6368 5f64 6972 2065 6c73 6520 6469  arch_dir else di
+00004200: 726e 616d 650a 2020 2020 2020 2020 2020  rname.          
+00004210: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00004220: 2070 6174 7465 726e 2e6d 6174 6368 2870   pattern.match(p
+00004230: 6174 6829 3a0a 2020 2020 2020 2020 2020  ath):.          
+00004240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004250: 2020 7969 656c 6420 4669 6c65 456e 7472    yield FileEntr
+00004260: 7928 0a20 2020 2020 2020 2020 2020 2020  y(.             
+00004270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004280: 2020 2053 3350 6174 6828 7061 7468 292e     S3Path(path).
+00004290: 6e61 6d65 2c20 7061 7468 2c20 5374 6174  name, path, Stat
+000042a0: 5265 7375 6c74 2869 7364 6972 3d54 7275  Result(isdir=Tru
+000042b0: 6529 290a 0a20 2020 2072 6574 7572 6e20  e))..    return 
+000042c0: 6372 6561 7465 5f67 656e 6572 6174 6f72  create_generator
+000042d0: 2873 335f 7061 7468 6e61 6d65 290a 0a0a  (s3_pathname)...
+000042e0: 6465 6620 5f73 335f 7363 616e 5f70 6169  def _s3_scan_pai
+000042f0: 7273 2873 7263 5f75 726c 3a20 5061 7468  rs(src_url: Path
+00004300: 4c69 6b65 2c0a 2020 2020 2020 2020 2020  Like,.          
+00004310: 2020 2020 2020 2020 2064 7374 5f75 726c           dst_url
+00004320: 3a20 5061 7468 4c69 6b65 2920 2d3e 2049  : PathLike) -> I
+00004330: 7465 7261 746f 725b 5475 706c 655b 5061  terator[Tuple[Pa
+00004340: 7468 4c69 6b65 2c20 5061 7468 4c69 6b65  thLike, PathLike
+00004350: 5d5d 3a0a 2020 2020 666f 7220 7372 635f  ]]:.    for src_
+00004360: 6669 6c65 5f70 6174 6820 696e 2053 3350  file_path in S3P
+00004370: 6174 6828 7372 635f 7572 6c29 2e73 6361  ath(src_url).sca
+00004380: 6e28 293a 0a20 2020 2020 2020 2063 6f6e  n():.        con
+00004390: 7465 6e74 5f70 6174 6820 3d20 7372 635f  tent_path = src_
+000043a0: 6669 6c65 5f70 6174 685b 6c65 6e28 7372  file_path[len(sr
+000043b0: 635f 7572 6c29 3a5d 0a20 2020 2020 2020  c_url):].       
+000043c0: 2069 6620 6c65 6e28 636f 6e74 656e 745f   if len(content_
+000043d0: 7061 7468 2920 3e20 303a 0a20 2020 2020  path) > 0:.     
+000043e0: 2020 2020 2020 2064 7374 5f66 696c 655f         dst_file_
+000043f0: 7061 7468 203d 2073 335f 7061 7468 5f6a  path = s3_path_j
+00004400: 6f69 6e28 6473 745f 7572 6c2c 2063 6f6e  oin(dst_url, con
+00004410: 7465 6e74 5f70 6174 6829 0a20 2020 2020  tent_path).     
+00004420: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00004430: 2020 2020 2064 7374 5f66 696c 655f 7061       dst_file_pa
+00004440: 7468 203d 2064 7374 5f75 726c 0a20 2020  th = dst_url.   
+00004450: 2020 2020 2079 6965 6c64 2073 7263 5f66       yield src_f
+00004460: 696c 655f 7061 7468 2c20 6473 745f 6669  ile_path, dst_fi
+00004470: 6c65 5f70 6174 680a 0a0a 6465 6620 6973  le_path...def is
+00004480: 5f73 3328 7061 7468 3a20 5061 7468 4c69  _s3(path: PathLi
+00004490: 6b65 2920 2d3e 2062 6f6f 6c3a 0a20 2020  ke) -> bool:.   
+000044a0: 2027 2727 0a20 2020 2031 2e20 4163 636f   '''.    1. Acco
+000044b0: 7264 696e 6720 746f 2060 6177 732d 636c  rding to `aws-cl
+000044c0: 6920 3c68 7474 7073 3a2f 2f64 6f63 732e  i <https://docs.
+000044d0: 6177 732e 616d 617a 6f6e 2e63 6f6d 2f63  aws.amazon.com/c
+000044e0: 6c69 2f6c 6174 6573 742f 7265 6665 7265  li/latest/refere
+000044f0: 6e63 652f 7333 2f69 6e64 6578 2e68 746d  nce/s3/index.htm
+00004500: 6c3e 605f 202c 2074 6573 7420 6966 2061  l>`_ , test if a
+00004510: 2070 6174 6820 6973 2073 3320 7061 7468   path is s3 path
+00004520: 2e0a 2020 2020 322e 206d 6567 6669 6c65  ..    2. megfile
+00004530: 2061 6c73 6f20 7375 7070 6f72 7420 7468   also support th
+00004540: 6520 7061 7468 206c 696b 6520 6073 335b  e path like `s3[
+00004550: 2b70 726f 6669 6c65 5f6e 616d 655d 3a2f  +profile_name]:/
+00004560: 2f62 7563 6b65 742f 6b65 7960 0a0a 2020  /bucket/key`..  
+00004570: 2020 3a70 6172 616d 2070 6174 683a 2050    :param path: P
+00004580: 6174 6820 746f 2062 6520 7465 7374 6564  ath to be tested
+00004590: 0a20 2020 203a 7265 7475 726e 733a 2054  .    :returns: T
+000045a0: 7275 6520 6966 2070 6174 6820 6973 2073  rue if path is s
+000045b0: 3320 7061 7468 2c20 656c 7365 2046 616c  3 path, else Fal
+000045c0: 7365 0a20 2020 2027 2727 0a20 2020 2070  se.    '''.    p
+000045d0: 6174 6820 3d20 6673 7061 7468 2870 6174  ath = fspath(pat
+000045e0: 6829 0a20 2020 2069 6620 7265 2e6d 6174  h).    if re.mat
+000045f0: 6368 2872 275e 7333 285c 2b5c 772b 293f  ch(r'^s3(\+\w+)?
+00004600: 3a5c 2f5c 2f27 2c20 7061 7468 293a 0a20  :\/\/', path):. 
+00004610: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
+00004620: 7565 0a20 2020 2072 6574 7572 6e20 4661  ue.    return Fa
+00004630: 6c73 650a 0a0a 6465 6620 5f73 335f 6269  lse...def _s3_bi
+00004640: 6e61 7279 5f6d 6f64 6528 7333 5f6f 7065  nary_mode(s3_ope
+00004650: 6e5f 6675 6e63 293a 0a0a 2020 2020 4077  n_func):..    @w
+00004660: 7261 7073 2873 335f 6f70 656e 5f66 756e  raps(s3_open_fun
+00004670: 6329 0a20 2020 2064 6566 2077 7261 7070  c).    def wrapp
+00004680: 6572 2873 335f 7572 6c2c 206d 6f64 653a  er(s3_url, mode:
+00004690: 2073 7472 203d 2027 7262 272c 202a 2a6b   str = 'rb', **k
+000046a0: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+000046b0: 6275 636b 6574 2c20 6b65 7920 3d20 7061  bucket, key = pa
+000046c0: 7273 655f 7333 5f75 726c 2873 335f 7572  rse_s3_url(s3_ur
+000046d0: 6c29 0a20 2020 2020 2020 2069 6620 6e6f  l).        if no
+000046e0: 7420 6275 636b 6574 3a0a 2020 2020 2020  t bucket:.      
+000046f0: 2020 2020 2020 7261 6973 6520 5333 4275        raise S3Bu
+00004700: 636b 6574 4e6f 7446 6f75 6e64 4572 726f  cketNotFoundErro
+00004710: 7228 2745 6d70 7479 2062 7563 6b65 7420  r('Empty bucket 
+00004720: 6e61 6d65 3a20 2572 2720 2520 7333 5f75  name: %r' % s3_u
+00004730: 726c 290a 0a20 2020 2020 2020 2069 6620  rl)..        if 
+00004740: 6e6f 7420 6b65 7920 6f72 206b 6579 2e65  not key or key.e
+00004750: 6e64 7377 6974 6828 272f 2729 3a0a 2020  ndswith('/'):.  
+00004760: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00004770: 5333 4973 4144 6972 6563 746f 7279 4572  S3IsADirectoryEr
+00004780: 726f 7228 2749 7320 6120 6469 7265 6374  ror('Is a direct
+00004790: 6f72 793a 2025 7227 2025 2073 335f 7572  ory: %r' % s3_ur
+000047a0: 6c29 0a0a 2020 2020 2020 2020 6966 2027  l)..        if '
+000047b0: 7827 2069 6e20 6d6f 6465 3a0a 2020 2020  x' in mode:.    
+000047c0: 2020 2020 2020 2020 6966 2053 3350 6174          if S3Pat
+000047d0: 6828 7333 5f75 726c 292e 6973 5f66 696c  h(s3_url).is_fil
+000047e0: 6528 293a 0a20 2020 2020 2020 2020 2020  e():.           
+000047f0: 2020 2020 2072 6169 7365 2053 3346 696c       raise S3Fil
+00004800: 6545 7869 7374 7345 7272 6f72 2827 4669  eExistsError('Fi
+00004810: 6c65 2065 7869 7374 733a 2025 7227 2025  le exists: %r' %
+00004820: 2073 335f 7572 6c29 0a20 2020 2020 2020   s3_url).       
+00004830: 2020 2020 206d 6f64 6520 3d20 6d6f 6465       mode = mode
+00004840: 2e72 6570 6c61 6365 2827 7827 2c20 2777  .replace('x', 'w
+00004850: 2729 0a0a 2020 2020 2020 2020 6966 2027  ')..        if '
+00004860: 7727 2069 6e20 6d6f 6465 206f 7220 2761  w' in mode or 'a
+00004870: 2720 696e 206d 6f64 653a 0a20 2020 2020  ' in mode:.     
+00004880: 2020 2020 2020 2069 6620 6e6f 7420 5333         if not S3
+00004890: 5061 7468 2873 335f 7572 6c29 2e68 6173  Path(s3_url).has
+000048a0: 6275 636b 6574 2829 3a0a 2020 2020 2020  bucket():.      
+000048b0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+000048c0: 5333 4275 636b 6574 4e6f 7446 6f75 6e64  S3BucketNotFound
+000048d0: 4572 726f 7228 274e 6f20 7375 6368 2062  Error('No such b
+000048e0: 7563 6b65 743a 2025 7227 2025 2073 335f  ucket: %r' % s3_
+000048f0: 7572 6c29 0a0a 2020 2020 2020 2020 6669  url)..        fi
+00004900: 6c65 6f62 6a20 3d20 7333 5f6f 7065 6e5f  leobj = s3_open_
+00004910: 6675 6e63 2873 335f 7572 6c2c 2067 6574  func(s3_url, get
+00004920: 5f62 696e 6172 795f 6d6f 6465 286d 6f64  _binary_mode(mod
+00004930: 6529 2c20 2a2a 6b77 6172 6773 290a 2020  e), **kwargs).  
+00004940: 2020 2020 2020 6966 2027 6227 206e 6f74        if 'b' not
+00004950: 2069 6e20 6d6f 6465 3a0a 2020 2020 2020   in mode:.      
+00004960: 2020 2020 2020 6669 6c65 6f62 6a20 3d20        fileobj = 
+00004970: 696f 2e54 6578 7449 4f57 7261 7070 6572  io.TextIOWrapper
+00004980: 2866 696c 656f 626a 2920 2023 2070 7974  (fileobj)  # pyt
+00004990: 7970 653a 2064 6973 6162 6c65 3d77 726f  ype: disable=wro
+000049a0: 6e67 2d61 7267 2d74 7970 6573 0a20 2020  ng-arg-types.   
+000049b0: 2020 2020 2020 2020 2066 696c 656f 626a           fileobj
+000049c0: 2e6d 6f64 6520 3d20 6d6f 6465 0a20 2020  .mode = mode.   
+000049d0: 2020 2020 2072 6574 7572 6e20 6669 6c65       return file
+000049e0: 6f62 6a0a 0a20 2020 2072 6574 7572 6e20  obj..    return 
+000049f0: 7772 6170 7065 720a 0a0a 405f 7333 5f62  wrapper...@_s3_b
+00004a00: 696e 6172 795f 6d6f 6465 0a64 6566 2073  inary_mode.def s
+00004a10: 335f 7072 6566 6574 6368 5f6f 7065 6e28  3_prefetch_open(
+00004a20: 0a20 2020 2020 2020 2073 335f 7572 6c3a  .        s3_url:
+00004a30: 2050 6174 684c 696b 652c 0a20 2020 2020   PathLike,.     
+00004a40: 2020 206d 6f64 653a 2073 7472 203d 2027     mode: str = '
+00004a50: 7262 272c 0a20 2020 2020 2020 2066 6f6c  rb',.        fol
+00004a60: 6c6f 776c 696e 6b73 3a20 626f 6f6c 203d  lowlinks: bool =
+00004a70: 2046 616c 7365 2c0a 2020 2020 2020 2020   False,.        
+00004a80: 2a2c 0a20 2020 2020 2020 206d 6178 5f63  *,.        max_c
+00004a90: 6f6e 6375 7272 656e 6379 3a20 4f70 7469  oncurrency: Opti
+00004aa0: 6f6e 616c 5b69 6e74 5d20 3d20 4e6f 6e65  onal[int] = None
+00004ab0: 2c0a 2020 2020 2020 2020 6d61 785f 626c  ,.        max_bl
+00004ac0: 6f63 6b5f 7369 7a65 3a20 696e 7420 3d20  ock_size: int = 
+00004ad0: 4445 4641 554c 545f 424c 4f43 4b5f 5349  DEFAULT_BLOCK_SI
+00004ae0: 5a45 2920 2d3e 2053 3350 7265 6665 7463  ZE) -> S3Prefetc
+00004af0: 6852 6561 6465 723a 0a20 2020 2027 2727  hReader:.    '''
+00004b00: 4f70 656e 2061 2061 7379 6e63 6872 6f6e  Open a asynchron
+00004b10: 6f75 7320 7072 6566 6574 6368 2072 6561  ous prefetch rea
+00004b20: 6465 722c 2074 6f20 7375 7070 6f72 7420  der, to support 
+00004b30: 6661 7374 2073 6571 7565 6e74 6961 6c20  fast sequential 
+00004b40: 7265 6164 2061 6e64 2072 616e 646f 6d20  read and random 
+00004b50: 7265 6164 0a0a 2020 2020 2e2e 206e 6f74  read..    .. not
+00004b60: 6520 3a3a 0a0a 2020 2020 2020 2020 5573  e ::..        Us
+00004b70: 6572 2073 686f 756c 6420 6d61 6b65 2073  er should make s
+00004b80: 7572 6520 7468 6174 2072 6561 6465 7220  ure that reader 
+00004b90: 2f20 7772 6974 6572 2061 7265 2063 6c6f  / writer are clo
+00004ba0: 7365 6420 636f 7272 6563 746c 790a 0a20  sed correctly.. 
+00004bb0: 2020 2020 2020 2053 7570 706f 7274 7320         Supports 
+00004bc0: 636f 6e74 6578 7420 6d61 6e61 6765 720a  context manager.
+00004bd0: 0a20 2020 2020 2020 2053 6f6d 6520 7061  .        Some pa
+00004be0: 7261 6d65 7465 7220 7365 7474 696e 6720  rameter setting 
+00004bf0: 6d61 7920 7065 7266 6f72 6d20 7765 6c6c  may perform well
+00004c00: 3a20 6d61 785f 636f 6e63 7572 7265 6e63  : max_concurrenc
+00004c10: 793d 3130 206f 7220 3230 2c20 6d61 785f  y=10 or 20, max_
+00004c20: 626c 6f63 6b5f 7369 7a65 3d38 206f 7220  block_size=8 or 
+00004c30: 3136 204d 422c 2064 6566 6175 6c74 2076  16 MB, default v
+00004c40: 616c 7565 204e 6f6e 6520 6d65 616e 7320  alue None means 
+00004c50: 7573 696e 6720 676c 6f62 616c 2074 6872  using global thr
+00004c60: 6561 6420 706f 6f6c 0a0a 2020 2020 3a70  ead pool..    :p
+00004c70: 6172 616d 206d 6178 5f63 6f6e 6375 7272  aram max_concurr
+00004c80: 656e 6379 3a20 4d61 7820 646f 776e 6c6f  ency: Max downlo
+00004c90: 6164 2074 6872 6561 6420 6e75 6d62 6572  ad thread number
+00004ca0: 2c20 4e6f 6e65 2062 7920 6465 6661 756c  , None by defaul
+00004cb0: 740a 2020 2020 3a70 6172 616d 206d 6178  t.    :param max
+00004cc0: 5f62 6c6f 636b 5f73 697a 653a 204d 6178  _block_size: Max
+00004cd0: 2064 6174 6120 7369 7a65 2064 6f77 6e6c   data size downl
+00004ce0: 6f61 6465 6420 6279 2065 6163 6820 7468  oaded by each th
+00004cf0: 7265 6164 2c20 696e 2062 7974 6573 2c20  read, in bytes, 
+00004d00: 384d 4220 6279 2064 6566 6175 6c74 0a20  8MB by default. 
+00004d10: 2020 203a 7265 7475 726e 733a 2041 6e20     :returns: An 
+00004d20: 6f70 656e 6564 2053 3350 7265 6665 7463  opened S3Prefetc
+00004d30: 6852 6561 6465 7220 6f62 6a65 6374 0a20  hReader object. 
+00004d40: 2020 203a 7261 6973 6573 3a20 5333 4669     :raises: S3Fi
+00004d50: 6c65 4e6f 7446 6f75 6e64 4572 726f 720a  leNotFoundError.
+00004d60: 2020 2020 2727 270a 2020 2020 6966 206d      '''.    if m
+00004d70: 6f64 6520 213d 2027 7262 273a 0a20 2020  ode != 'rb':.   
+00004d80: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00004d90: 4572 726f 7228 2775 6e61 6363 6570 7461  Error('unaccepta
+00004da0: 626c 6520 6d6f 6465 3a20 2572 2720 2520  ble mode: %r' % 
+00004db0: 6d6f 6465 290a 2020 2020 7333 5f75 726c  mode).    s3_url
+00004dc0: 203d 2053 3350 6174 6828 7333 5f75 726c   = S3Path(s3_url
+00004dd0: 290a 2020 2020 6966 2066 6f6c 6c6f 776c  ).    if followl
+00004de0: 696e 6b73 3a0a 2020 2020 2020 2020 7472  inks:.        tr
+00004df0: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
+00004e00: 335f 7572 6c20 3d20 7333 5f75 726c 2e72  3_url = s3_url.r
+00004e10: 6561 646c 696e 6b28 290a 2020 2020 2020  eadlink().      
+00004e20: 2020 6578 6365 7074 2053 334e 6f74 414c    except S3NotAL
+00004e30: 696e 6b45 7272 6f72 3a0a 2020 2020 2020  inkError:.      
+00004e40: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
+00004e50: 6275 636b 6574 2c20 6b65 7920 3d20 7061  bucket, key = pa
+00004e60: 7273 655f 7333 5f75 726c 2873 335f 7572  rse_s3_url(s3_ur
+00004e70: 6c2e 7061 7468 5f77 6974 685f 7072 6f74  l.path_with_prot
+00004e80: 6f63 6f6c 290a 2020 2020 636f 6e66 6967  ocol).    config
+00004e90: 203d 2062 6f74 6f63 6f72 652e 636f 6e66   = botocore.conf
+00004ea0: 6967 2e43 6f6e 6669 6728 6d61 785f 706f  ig.Config(max_po
+00004eb0: 6f6c 5f63 6f6e 6e65 6374 696f 6e73 3d6d  ol_connections=m
+00004ec0: 6178 5f70 6f6f 6c5f 636f 6e6e 6563 7469  ax_pool_connecti
+00004ed0: 6f6e 7329 0a20 2020 2063 6c69 656e 7420  ons).    client 
+00004ee0: 3d20 6765 745f 7333 5f63 6c69 656e 7428  = get_s3_client(
+00004ef0: 0a20 2020 2020 2020 2063 6f6e 6669 673d  .        config=
+00004f00: 636f 6e66 6967 2c0a 2020 2020 2020 2020  config,.        
+00004f10: 6361 6368 655f 6b65 793d 2773 335f 6669  cache_key='s3_fi
+00004f20: 6c65 6c69 6b65 5f63 6c69 656e 7427 2c0a  lelike_client',.
+00004f30: 2020 2020 2020 2020 7072 6f66 696c 655f          profile_
+00004f40: 6e61 6d65 3d73 335f 7572 6c2e 5f70 726f  name=s3_url._pro
+00004f50: 6669 6c65 5f6e 616d 6529 0a20 2020 2072  file_name).    r
+00004f60: 6574 7572 6e20 5333 5072 6566 6574 6368  eturn S3Prefetch
+00004f70: 5265 6164 6572 280a 2020 2020 2020 2020  Reader(.        
+00004f80: 6275 636b 6574 2c0a 2020 2020 2020 2020  bucket,.        
+00004f90: 6b65 792c 0a20 2020 2020 2020 2073 335f  key,.        s3_
+00004fa0: 636c 6965 6e74 3d63 6c69 656e 742c 0a20  client=client,. 
+00004fb0: 2020 2020 2020 206d 6178 5f72 6574 7269         max_retri
+00004fc0: 6573 3d6d 6178 5f72 6574 7269 6573 2c0a  es=max_retries,.
+00004fd0: 2020 2020 2020 2020 6d61 785f 776f 726b          max_work
+00004fe0: 6572 733d 6d61 785f 636f 6e63 7572 7265  ers=max_concurre
+00004ff0: 6e63 792c 0a20 2020 2020 2020 2062 6c6f  ncy,.        blo
+00005000: 636b 5f73 697a 653d 6d61 785f 626c 6f63  ck_size=max_bloc
+00005010: 6b5f 7369 7a65 290a 0a0a 405f 7333 5f62  k_size)...@_s3_b
+00005020: 696e 6172 795f 6d6f 6465 0a64 6566 2073  inary_mode.def s
+00005030: 335f 7368 6172 655f 6361 6368 655f 6f70  3_share_cache_op
+00005040: 656e 280a 2020 2020 2020 2020 7333 5f75  en(.        s3_u
+00005050: 726c 3a20 5061 7468 4c69 6b65 2c0a 2020  rl: PathLike,.  
+00005060: 2020 2020 2020 6d6f 6465 3a20 7374 7220        mode: str 
+00005070: 3d20 2772 6227 2c0a 2020 2020 2020 2020  = 'rb',.        
+00005080: 666f 6c6c 6f77 6c69 6e6b 733a 2062 6f6f  followlinks: boo
+00005090: 6c20 3d20 4661 6c73 652c 0a20 2020 2020  l = False,.     
+000050a0: 2020 202a 2c0a 2020 2020 2020 2020 6361     *,.        ca
+000050b0: 6368 655f 6b65 793a 2073 7472 203d 2027  che_key: str = '
+000050c0: 6c72 7527 2c0a 2020 2020 2020 2020 6d61  lru',.        ma
+000050d0: 785f 636f 6e63 7572 7265 6e63 793a 204f  x_concurrency: O
+000050e0: 7074 696f 6e61 6c5b 696e 745d 203d 204e  ptional[int] = N
+000050f0: 6f6e 652c 0a20 2020 2020 2020 206d 6178  one,.        max
+00005100: 5f62 6c6f 636b 5f73 697a 653a 2069 6e74  _block_size: int
+00005110: 203d 2044 4546 4155 4c54 5f42 4c4f 434b   = DEFAULT_BLOCK
+00005120: 5f53 495a 4529 202d 3e20 5333 5368 6172  _SIZE) -> S3Shar
+00005130: 6543 6163 6865 5265 6164 6572 3a0a 2020  eCacheReader:.  
+00005140: 2020 2727 274f 7065 6e20 6120 6173 796e    '''Open a asyn
+00005150: 6368 726f 6e6f 7573 2070 7265 6665 7463  chronous prefetc
+00005160: 6820 7265 6164 6572 2c20 746f 2073 7570  h reader, to sup
+00005170: 706f 7274 2066 6173 7420 7365 7175 656e  port fast sequen
+00005180: 7469 616c 2072 6561 6420 616e 6420 7261  tial read and ra
+00005190: 6e64 6f6d 2072 6561 640a 0a20 2020 202e  ndom read..    .
+000051a0: 2e20 6e6f 7465 203a 3a0a 0a20 2020 2020  . note ::..     
+000051b0: 2020 2055 7365 7220 7368 6f75 6c64 206d     User should m
+000051c0: 616b 6520 7375 7265 2074 6861 7420 7265  ake sure that re
+000051d0: 6164 6572 202f 2077 7269 7465 7220 6172  ader / writer ar
+000051e0: 6520 636c 6f73 6564 2063 6f72 7265 6374  e closed correct
+000051f0: 6c79 0a0a 2020 2020 2020 2020 5375 7070  ly..        Supp
+00005200: 6f72 7473 2063 6f6e 7465 7874 206d 616e  orts context man
+00005210: 6167 6572 0a0a 2020 2020 2020 2020 536f  ager..        So
+00005220: 6d65 2070 6172 616d 6574 6572 2073 6574  me parameter set
+00005230: 7469 6e67 206d 6179 2070 6572 666f 726d  ting may perform
+00005240: 2077 656c 6c3a 206d 6178 5f63 6f6e 6375   well: max_concu
+00005250: 7272 656e 6379 3d31 3020 6f72 2032 302c  rrency=10 or 20,
+00005260: 206d 6178 5f62 6c6f 636b 5f73 697a 653d   max_block_size=
+00005270: 3820 6f72 2031 3620 4d42 2c20 6465 6661  8 or 16 MB, defa
+00005280: 756c 7420 7661 6c75 6520 4e6f 6e65 206d  ult value None m
+00005290: 6561 6e73 2075 7369 6e67 2067 6c6f 6261  eans using globa
+000052a0: 6c20 7468 7265 6164 2070 6f6f 6c0a 0a20  l thread pool.. 
+000052b0: 2020 203a 7061 7261 6d20 6d61 785f 636f     :param max_co
+000052c0: 6e63 7572 7265 6e63 793a 204d 6178 2064  ncurrency: Max d
+000052d0: 6f77 6e6c 6f61 6420 7468 7265 6164 206e  ownload thread n
+000052e0: 756d 6265 722c 204e 6f6e 6520 6279 2064  umber, None by d
+000052f0: 6566 6175 6c74 0a20 2020 203a 7061 7261  efault.    :para
+00005300: 6d20 6d61 785f 626c 6f63 6b5f 7369 7a65  m max_block_size
+00005310: 3a20 4d61 7820 6461 7461 2073 697a 6520  : Max data size 
+00005320: 646f 776e 6c6f 6164 6564 2062 7920 6561  downloaded by ea
+00005330: 6368 2074 6872 6561 642c 2069 6e20 6279  ch thread, in by
+00005340: 7465 732c 2038 4d42 2062 7920 6465 6661  tes, 8MB by defa
+00005350: 756c 740a 2020 2020 3a72 6574 7572 6e73  ult.    :returns
+00005360: 3a20 416e 206f 7065 6e65 6420 5333 5368  : An opened S3Sh
+00005370: 6172 6543 6163 6865 5265 6164 6572 206f  areCacheReader o
+00005380: 626a 6563 740a 2020 2020 3a72 6169 7365  bject.    :raise
+00005390: 733a 2053 3346 696c 654e 6f74 466f 756e  s: S3FileNotFoun
+000053a0: 6445 7272 6f72 0a20 2020 2027 2727 0a20  dError.    '''. 
+000053b0: 2020 2069 6620 6d6f 6465 2021 3d20 2772     if mode != 'r
+000053c0: 6227 3a0a 2020 2020 2020 2020 7261 6973  b':.        rais
+000053d0: 6520 5661 6c75 6545 7272 6f72 2827 756e  e ValueError('un
+000053e0: 6163 6365 7074 6162 6c65 206d 6f64 653a  acceptable mode:
+000053f0: 2025 7227 2025 206d 6f64 6529 0a0a 2020   %r' % mode)..  
+00005400: 2020 7333 5f75 726c 203d 2053 3350 6174    s3_url = S3Pat
+00005410: 6828 7333 5f75 726c 290a 2020 2020 6966  h(s3_url).    if
+00005420: 2066 6f6c 6c6f 776c 696e 6b73 3a0a 2020   followlinks:.  
+00005430: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00005440: 2020 2020 2020 2073 335f 7572 6c20 3d20         s3_url = 
+00005450: 7333 5f75 726c 2e72 6561 646c 696e 6b28  s3_url.readlink(
+00005460: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+00005470: 2053 334e 6f74 414c 696e 6b45 7272 6f72   S3NotALinkError
+00005480: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
+00005490: 7373 0a0a 2020 2020 6275 636b 6574 2c20  ss..    bucket, 
+000054a0: 6b65 7920 3d20 7061 7273 655f 7333 5f75  key = parse_s3_u
+000054b0: 726c 2873 335f 7572 6c2e 7061 7468 5f77  rl(s3_url.path_w
+000054c0: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
+000054d0: 2020 636f 6e66 6967 203d 2062 6f74 6f63    config = botoc
+000054e0: 6f72 652e 636f 6e66 6967 2e43 6f6e 6669  ore.config.Confi
+000054f0: 6728 6d61 785f 706f 6f6c 5f63 6f6e 6e65  g(max_pool_conne
+00005500: 6374 696f 6e73 3d6d 6178 5f70 6f6f 6c5f  ctions=max_pool_
+00005510: 636f 6e6e 6563 7469 6f6e 7329 0a20 2020  connections).   
+00005520: 2063 6c69 656e 7420 3d20 6765 745f 7333   client = get_s3
+00005530: 5f63 6c69 656e 7428 0a20 2020 2020 2020  _client(.       
+00005540: 2063 6f6e 6669 673d 636f 6e66 6967 2c0a   config=config,.
+00005550: 2020 2020 2020 2020 6361 6368 655f 6b65          cache_ke
+00005560: 793d 2773 335f 6669 6c65 6c69 6b65 5f63  y='s3_filelike_c
+00005570: 6c69 656e 7427 2c0a 2020 2020 2020 2020  lient',.        
+00005580: 7072 6f66 696c 655f 6e61 6d65 3d73 335f  profile_name=s3_
+00005590: 7572 6c2e 5f70 726f 6669 6c65 5f6e 616d  url._profile_nam
+000055a0: 6529 0a20 2020 2072 6574 7572 6e20 5333  e).    return S3
+000055b0: 5368 6172 6543 6163 6865 5265 6164 6572  ShareCacheReader
+000055c0: 280a 2020 2020 2020 2020 6275 636b 6574  (.        bucket
+000055d0: 2c0a 2020 2020 2020 2020 6b65 792c 0a20  ,.        key,. 
+000055e0: 2020 2020 2020 2063 6163 6865 5f6b 6579         cache_key
+000055f0: 3d63 6163 6865 5f6b 6579 2c0a 2020 2020  =cache_key,.    
+00005600: 2020 2020 7333 5f63 6c69 656e 743d 636c      s3_client=cl
+00005610: 6965 6e74 2c0a 2020 2020 2020 2020 6d61  ient,.        ma
+00005620: 785f 7265 7472 6965 733d 6d61 785f 7265  x_retries=max_re
+00005630: 7472 6965 732c 0a20 2020 2020 2020 206d  tries,.        m
+00005640: 6178 5f77 6f72 6b65 7273 3d6d 6178 5f63  ax_workers=max_c
+00005650: 6f6e 6375 7272 656e 6379 2c0a 2020 2020  oncurrency,.    
+00005660: 2020 2020 626c 6f63 6b5f 7369 7a65 3d6d      block_size=m
+00005670: 6178 5f62 6c6f 636b 5f73 697a 6529 0a0a  ax_block_size)..
+00005680: 0a40 5f73 335f 6269 6e61 7279 5f6d 6f64  .@_s3_binary_mod
+00005690: 650a 6465 6620 7333 5f70 6970 655f 6f70  e.def s3_pipe_op
+000056a0: 656e 280a 2020 2020 2020 2020 7333 5f75  en(.        s3_u
+000056b0: 726c 3a20 5061 7468 4c69 6b65 2c0a 2020  rl: PathLike,.  
+000056c0: 2020 2020 2020 6d6f 6465 3a20 7374 722c        mode: str,
+000056d0: 0a20 2020 2020 2020 2066 6f6c 6c6f 776c  .        followl
+000056e0: 696e 6b73 3a20 626f 6f6c 203d 2046 616c  inks: bool = Fal
+000056f0: 7365 2c0a 2020 2020 2020 2020 2a2c 0a20  se,.        *,. 
+00005700: 2020 2020 2020 206a 6f69 6e5f 7468 7265         join_thre
+00005710: 6164 3a20 626f 6f6c 203d 2054 7275 6529  ad: bool = True)
+00005720: 202d 3e20 5333 5069 7065 4861 6e64 6c65   -> S3PipeHandle
+00005730: 723a 0a20 2020 2027 2727 4f70 656e 2061  r:.    '''Open a
+00005740: 2061 7379 6e63 6872 6f6e 6f75 7320 7265   asynchronous re
+00005750: 6164 2d77 7269 7465 2072 6561 6465 7220  ad-write reader 
+00005760: 2f20 7772 6974 6572 2c20 746f 2073 7570  / writer, to sup
+00005770: 706f 7274 2066 6173 7420 7365 7175 656e  port fast sequen
+00005780: 7469 616c 2072 6561 6420 2f20 7772 6974  tial read / writ
+00005790: 650a 0a20 2020 202e 2e20 6e6f 7465 203a  e..    .. note :
+000057a0: 3a0a 0a20 2020 2020 2020 2055 7365 7220  :..        User 
+000057b0: 7368 6f75 6c64 206d 616b 6520 7375 7265  should make sure
+000057c0: 2074 6861 7420 7265 6164 6572 202f 2077   that reader / w
+000057d0: 7269 7465 7220 6172 6520 636c 6f73 6564  riter are closed
+000057e0: 2063 6f72 7265 6374 6c79 0a0a 2020 2020   correctly..    
+000057f0: 2020 2020 5375 7070 6f72 7473 2063 6f6e      Supports con
+00005800: 7465 7874 206d 616e 6167 6572 0a0a 2020  text manager..  
+00005810: 2020 2020 2020 5768 656e 206a 6f69 6e5f        When join_
+00005820: 7468 7265 6164 2069 7320 4661 6c73 652c  thread is False,
+00005830: 2077 6869 6c65 2074 6865 2066 696c 6520   while the file 
+00005840: 6861 6e64 6c65 2061 7265 2063 6c6f 7369  handle are closi
+00005850: 6e67 2c20 7468 6973 2066 756e 6374 696f  ng, this functio
+00005860: 6e20 7769 6c6c 206e 6f74 2077 6169 7420  n will not wait 
+00005870: 756e 7469 6c20 7468 6520 6173 796e 6368  until the asynch
+00005880: 726f 6e6f 7573 2077 7269 7469 6e67 2066  ronous writing f
+00005890: 696e 6973 6865 733b 0a20 2020 2020 2020  inishes;.       
+000058a0: 2046 616c 7365 2064 6f65 736e 2774 2061   False doesn't a
+000058b0: 6666 6563 7420 7265 6164 2d68 616e 646c  ffect read-handl
+000058c0: 652c 2062 7574 2074 6869 7320 6361 6e20  e, but this can 
+000058d0: 7370 6565 6420 7570 2077 7269 7465 2d68  speed up write-h
+000058e0: 616e 646c 6520 6265 6361 7573 6520 6669  andle because fi
+000058f0: 6c65 2077 696c 6c20 6265 2077 7269 7474  le will be writt
+00005900: 656e 2061 7379 6e63 6872 6f6e 6f75 736c  en asynchronousl
+00005910: 792e 0a20 2020 2020 2020 2042 7574 2061  y..        But a
+00005920: 7379 6e63 6872 6f6e 6f75 7320 6265 6861  synchronous beha
+00005930: 7669 6f75 7220 6361 6e20 6775 6172 616e  viour can guaran
+00005940: 7465 6520 7468 6520 6669 6c65 2061 7265  tee the file are
+00005950: 2073 7563 6365 7373 6675 6c6c 7920 7772   successfully wr
+00005960: 6974 7465 6e2c 2061 6e64 2066 7265 7175  itten, and frequ
+00005970: 656e 7420 6578 6563 7574 696f 6e20 6d61  ent execution ma
+00005980: 7920 6361 7573 6520 7468 7265 6164 2061  y cause thread a
+00005990: 6e64 2066 696c 6520 6861 6e64 6c65 2065  nd file handle e
+000059a0: 7868 6175 7374 696f 6e0a 0a20 2020 203a  xhaustion..    :
+000059b0: 7061 7261 6d20 6d6f 6465 3a20 4d6f 6465  param mode: Mode
+000059c0: 2074 6f20 6f70 656e 2066 696c 652c 2065   to open file, e
+000059d0: 6974 6865 7220 2272 6222 206f 7220 2277  ither "rb" or "w
+000059e0: 6222 0a20 2020 203a 7061 7261 6d20 6a6f  b".    :param jo
+000059f0: 696e 5f74 6872 6561 643a 2049 6620 7761  in_thread: If wa
+00005a00: 6974 2061 6674 6572 2066 756e 6374 696f  it after functio
+00005a10: 6e20 6578 6563 7574 696f 6e20 756e 7469  n execution unti
+00005a20: 6c20 7333 2066 696e 6973 6865 7320 7772  l s3 finishes wr
+00005a30: 6974 696e 670a 2020 2020 3a72 6574 7572  iting.    :retur
+00005a40: 6e73 3a20 416e 206f 7065 6e65 6420 4275  ns: An opened Bu
+00005a50: 6666 6572 6564 5265 6164 6572 202f 2042  fferedReader / B
+00005a60: 7566 6665 7265 6457 7269 7465 7220 6f62  ufferedWriter ob
+00005a70: 6a65 6374 0a20 2020 2027 2727 0a20 2020  ject.    '''.   
+00005a80: 2069 6620 6d6f 6465 206e 6f74 2069 6e20   if mode not in 
+00005a90: 2827 7262 272c 2027 7762 2729 3a0a 2020  ('rb', 'wb'):.  
+00005aa0: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+00005ab0: 6545 7272 6f72 2827 756e 6163 6365 7074  eError('unaccept
+00005ac0: 6162 6c65 206d 6f64 653a 2025 7227 2025  able mode: %r' %
+00005ad0: 206d 6f64 6529 0a0a 2020 2020 6966 206d   mode)..    if m
+00005ae0: 6f64 655b 305d 203d 3d20 2772 2720 616e  ode[0] == 'r' an
+00005af0: 6420 6e6f 7420 5333 5061 7468 2873 335f  d not S3Path(s3_
+00005b00: 7572 6c29 2e69 735f 6669 6c65 2829 3a0a  url).is_file():.
+00005b10: 2020 2020 2020 2020 7261 6973 6520 5333          raise S3
+00005b20: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
+00005b30: 7228 274e 6f20 7375 6368 2066 696c 653a  r('No such file:
+00005b40: 2025 7227 2025 2073 335f 7572 6c29 0a0a   %r' % s3_url)..
+00005b50: 2020 2020 7333 5f75 726c 203d 2053 3350      s3_url = S3P
+00005b60: 6174 6828 7333 5f75 726c 290a 2020 2020  ath(s3_url).    
+00005b70: 6966 2066 6f6c 6c6f 776c 696e 6b73 3a0a  if followlinks:.
+00005b80: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00005b90: 2020 2020 2020 2020 2073 335f 7572 6c20           s3_url 
+00005ba0: 3d20 7333 5f75 726c 2e72 6561 646c 696e  = s3_url.readlin
+00005bb0: 6b28 290a 2020 2020 2020 2020 6578 6365  k().        exce
+00005bc0: 7074 2053 334e 6f74 414c 696e 6b45 7272  pt S3NotALinkErr
+00005bd0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+00005be0: 7061 7373 0a0a 2020 2020 6275 636b 6574  pass..    bucket
+00005bf0: 2c20 6b65 7920 3d20 7061 7273 655f 7333  , key = parse_s3
+00005c00: 5f75 726c 2873 335f 7572 6c2e 7061 7468  _url(s3_url.path
+00005c10: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
+00005c20: 2020 2020 636f 6e66 6967 203d 2062 6f74      config = bot
+00005c30: 6f63 6f72 652e 636f 6e66 6967 2e43 6f6e  ocore.config.Con
+00005c40: 6669 6728 6d61 785f 706f 6f6c 5f63 6f6e  fig(max_pool_con
+00005c50: 6e65 6374 696f 6e73 3d6d 6178 5f70 6f6f  nections=max_poo
+00005c60: 6c5f 636f 6e6e 6563 7469 6f6e 7329 0a20  l_connections). 
+00005c70: 2020 2063 6c69 656e 7420 3d20 6765 745f     client = get_
+00005c80: 7333 5f63 6c69 656e 7428 0a20 2020 2020  s3_client(.     
+00005c90: 2020 2063 6f6e 6669 673d 636f 6e66 6967     config=config
+00005ca0: 2c0a 2020 2020 2020 2020 6361 6368 655f  ,.        cache_
+00005cb0: 6b65 793d 2773 335f 6669 6c65 6c69 6b65  key='s3_filelike
+00005cc0: 5f63 6c69 656e 7427 2c0a 2020 2020 2020  _client',.      
+00005cd0: 2020 7072 6f66 696c 655f 6e61 6d65 3d73    profile_name=s
+00005ce0: 335f 7572 6c2e 5f70 726f 6669 6c65 5f6e  3_url._profile_n
+00005cf0: 616d 6529 0a20 2020 2072 6574 7572 6e20  ame).    return 
+00005d00: 5333 5069 7065 4861 6e64 6c65 7228 0a20  S3PipeHandler(. 
+00005d10: 2020 2020 2020 2062 7563 6b65 742c 206b         bucket, k
+00005d20: 6579 2c20 6d6f 6465 2c20 7333 5f63 6c69  ey, mode, s3_cli
+00005d30: 656e 743d 636c 6965 6e74 2c20 6a6f 696e  ent=client, join
+00005d40: 5f74 6872 6561 643d 6a6f 696e 5f74 6872  _thread=join_thr
+00005d50: 6561 6429 0a0a 0a40 5f73 335f 6269 6e61  ead)...@_s3_bina
+00005d60: 7279 5f6d 6f64 650a 6465 6620 7333 5f63  ry_mode.def s3_c
+00005d70: 6163 6865 645f 6f70 656e 280a 2020 2020  ached_open(.    
+00005d80: 2020 2020 7333 5f75 726c 3a20 5061 7468      s3_url: Path
+00005d90: 4c69 6b65 2c0a 2020 2020 2020 2020 6d6f  Like,.        mo
+00005da0: 6465 3a20 7374 722c 0a20 2020 2020 2020  de: str,.       
+00005db0: 2066 6f6c 6c6f 776c 696e 6b73 3a20 626f   followlinks: bo
+00005dc0: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+00005dd0: 2020 2020 2a2c 0a20 2020 2020 2020 2063      *,.        c
+00005de0: 6163 6865 5f70 6174 683a 204f 7074 696f  ache_path: Optio
+00005df0: 6e61 6c5b 7374 725d 203d 204e 6f6e 6529  nal[str] = None)
+00005e00: 202d 3e20 5333 4361 6368 6564 4861 6e64   -> S3CachedHand
+00005e10: 6c65 723a 0a20 2020 2027 2727 4f70 656e  ler:.    '''Open
+00005e20: 2061 206c 6f63 616c 2d63 6163 6865 2066   a local-cache f
+00005e30: 696c 6520 7265 6164 6572 202f 2077 7269  ile reader / wri
+00005e40: 7465 722c 2066 6f72 2066 7265 7175 656e  ter, for frequen
+00005e50: 7420 7261 6e64 6f6d 2072 6561 6420 2f20  t random read / 
+00005e60: 7772 6974 650a 0a20 2020 202e 2e20 6e6f  write..    .. no
+00005e70: 7465 203a 3a0a 0a20 2020 2020 2020 2055  te ::..        U
+00005e80: 7365 7220 7368 6f75 6c64 206d 616b 6520  ser should make 
+00005e90: 7375 7265 2074 6861 7420 7265 6164 6572  sure that reader
+00005ea0: 202f 2077 7269 7465 7220 6172 6520 636c   / writer are cl
+00005eb0: 6f73 6564 2063 6f72 7265 6374 6c79 0a0a  osed correctly..
+00005ec0: 2020 2020 2020 2020 5375 7070 6f72 7473          Supports
+00005ed0: 2063 6f6e 7465 7874 206d 616e 6167 6572   context manager
+00005ee0: 0a0a 2020 2020 2020 2020 6361 6368 655f  ..        cache_
+00005ef0: 7061 7468 2063 616e 2073 7065 6369 6679  path can specify
+00005f00: 2074 6865 2070 6174 6820 6f66 2063 6163   the path of cac
+00005f10: 6865 2066 696c 652e 2050 6572 666f 726d  he file. Perform
+00005f20: 616e 6365 2063 6f75 6c64 2062 6520 6265  ance could be be
+00005f30: 7474 6572 2069 6620 6361 6368 6520 6669  tter if cache fi
+00005f40: 6c65 2070 6174 6820 6973 206f 6e20 7373  le path is on ss
+00005f50: 6420 6f72 2074 6d70 6673 0a0a 2020 2020  d or tmpfs..    
+00005f60: 3a70 6172 616d 206d 6f64 653a 204d 6f64  :param mode: Mod
+00005f70: 6520 746f 206f 7065 6e20 6669 6c65 2c20  e to open file, 
+00005f80: 636f 756c 6420 6265 206f 6e65 206f 6620  could be one of 
+00005f90: 2272 6222 2c20 2277 6222 206f 7220 2261  "rb", "wb" or "a
+00005fa0: 6222 0a20 2020 203a 7061 7261 6d20 6361  b".    :param ca
+00005fb0: 6368 655f 7061 7468 3a20 6361 6368 6520  che_path: cache 
+00005fc0: 6669 6c65 2070 6174 680a 2020 2020 3a72  file path.    :r
+00005fd0: 6574 7572 6e73 3a20 416e 206f 7065 6e65  eturns: An opene
+00005fe0: 6420 4275 6666 6572 6564 5265 6164 6572  d BufferedReader
+00005ff0: 202f 2042 7566 6665 7265 6457 7269 7465   / BufferedWrite
+00006000: 7220 6f62 6a65 6374 0a20 2020 2027 2727  r object.    '''
+00006010: 0a20 2020 2069 6620 6d6f 6465 206e 6f74  .    if mode not
+00006020: 2069 6e20 2827 7262 272c 2027 7762 272c   in ('rb', 'wb',
+00006030: 2027 6162 272c 2027 7262 2b27 2c20 2777   'ab', 'rb+', 'w
+00006040: 622b 272c 2027 6162 2b27 293a 0a20 2020  b+', 'ab+'):.   
+00006050: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00006060: 4572 726f 7228 2775 6e61 6363 6570 7461  Error('unaccepta
+00006070: 626c 6520 6d6f 6465 3a20 2572 2720 2520  ble mode: %r' % 
+00006080: 6d6f 6465 290a 2020 2020 7333 5f75 726c  mode).    s3_url
+00006090: 203d 2053 3350 6174 6828 7333 5f75 726c   = S3Path(s3_url
+000060a0: 290a 2020 2020 6966 2066 6f6c 6c6f 776c  ).    if followl
+000060b0: 696e 6b73 3a0a 2020 2020 2020 2020 7472  inks:.        tr
+000060c0: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
+000060d0: 335f 7572 6c20 3d20 7333 5f75 726c 2e72  3_url = s3_url.r
+000060e0: 6561 646c 696e 6b28 290a 2020 2020 2020  eadlink().      
+000060f0: 2020 6578 6365 7074 2053 334e 6f74 414c    except S3NotAL
+00006100: 696e 6b45 7272 6f72 3a0a 2020 2020 2020  inkError:.      
+00006110: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
+00006120: 6275 636b 6574 2c20 6b65 7920 3d20 7061  bucket, key = pa
+00006130: 7273 655f 7333 5f75 726c 2873 335f 7572  rse_s3_url(s3_ur
+00006140: 6c2e 7061 7468 5f77 6974 685f 7072 6f74  l.path_with_prot
+00006150: 6f63 6f6c 290a 2020 2020 636f 6e66 6967  ocol).    config
+00006160: 203d 2062 6f74 6f63 6f72 652e 636f 6e66   = botocore.conf
+00006170: 6967 2e43 6f6e 6669 6728 6d61 785f 706f  ig.Config(max_po
+00006180: 6f6c 5f63 6f6e 6e65 6374 696f 6e73 3d6d  ol_connections=m
+00006190: 6178 5f70 6f6f 6c5f 636f 6e6e 6563 7469  ax_pool_connecti
+000061a0: 6f6e 7329 0a20 2020 2063 6c69 656e 7420  ons).    client 
+000061b0: 3d20 6765 745f 7333 5f63 6c69 656e 7428  = get_s3_client(
+000061c0: 0a20 2020 2020 2020 2063 6f6e 6669 673d  .        config=
+000061d0: 636f 6e66 6967 2c0a 2020 2020 2020 2020  config,.        
+000061e0: 6361 6368 655f 6b65 793d 2773 335f 6669  cache_key='s3_fi
+000061f0: 6c65 6c69 6b65 5f63 6c69 656e 7427 2c0a  lelike_client',.
+00006200: 2020 2020 2020 2020 7072 6f66 696c 655f          profile_
+00006210: 6e61 6d65 3d73 335f 7572 6c2e 5f70 726f  name=s3_url._pro
+00006220: 6669 6c65 5f6e 616d 6529 0a20 2020 2072  file_name).    r
+00006230: 6574 7572 6e20 5333 4361 6368 6564 4861  eturn S3CachedHa
+00006240: 6e64 6c65 7228 0a20 2020 2020 2020 2062  ndler(.        b
+00006250: 7563 6b65 742c 206b 6579 2c20 6d6f 6465  ucket, key, mode
+00006260: 2c20 7333 5f63 6c69 656e 743d 636c 6965  , s3_client=clie
+00006270: 6e74 2c20 6361 6368 655f 7061 7468 3d63  nt, cache_path=c
+00006280: 6163 6865 5f70 6174 6829 0a0a 0a40 5f73  ache_path)...@_s
+00006290: 335f 6269 6e61 7279 5f6d 6f64 650a 6465  3_binary_mode.de
+000062a0: 6620 7333 5f62 7566 6665 7265 645f 6f70  f s3_buffered_op
+000062b0: 656e 280a 2020 2020 2020 2020 7333 5f75  en(.        s3_u
+000062c0: 726c 3a20 5061 7468 4c69 6b65 2c0a 2020  rl: PathLike,.  
+000062d0: 2020 2020 2020 6d6f 6465 3a20 7374 722c        mode: str,
+000062e0: 0a20 2020 2020 2020 2066 6f6c 6c6f 776c  .        followl
+000062f0: 696e 6b73 3a20 626f 6f6c 203d 2046 616c  inks: bool = Fal
+00006300: 7365 2c0a 2020 2020 2020 2020 2a2c 0a20  se,.        *,. 
+00006310: 2020 2020 2020 206d 6178 5f63 6f6e 6375         max_concu
+00006320: 7272 656e 6379 3a20 4f70 7469 6f6e 616c  rrency: Optional
+00006330: 5b69 6e74 5d20 3d20 4e6f 6e65 2c0a 2020  [int] = None,.  
+00006340: 2020 2020 2020 6d61 785f 6275 6666 6572        max_buffer
+00006350: 5f73 697a 653a 2069 6e74 203d 2044 4546  _size: int = DEF
+00006360: 4155 4c54 5f4d 4158 5f42 5546 4645 525f  AULT_MAX_BUFFER_
+00006370: 5349 5a45 2c0a 2020 2020 2020 2020 666f  SIZE,.        fo
+00006380: 7277 6172 645f 7261 7469 6f3a 204f 7074  rward_ratio: Opt
+00006390: 696f 6e61 6c5b 666c 6f61 745d 203d 204e  ional[float] = N
+000063a0: 6f6e 652c 0a20 2020 2020 2020 2062 6c6f  one,.        blo
+000063b0: 636b 5f73 697a 653a 2069 6e74 203d 2044  ck_size: int = D
+000063c0: 4546 4155 4c54 5f42 4c4f 434b 5f53 495a  EFAULT_BLOCK_SIZ
+000063d0: 452c 0a20 2020 2020 2020 206c 696d 6974  E,.        limit
+000063e0: 6564 5f73 6565 6b61 626c 653a 2062 6f6f  ed_seekable: boo
+000063f0: 6c20 3d20 4661 6c73 652c 0a20 2020 2020  l = False,.     
+00006400: 2020 2062 7566 6665 7265 643a 2062 6f6f     buffered: boo
+00006410: 6c20 3d20 5472 7565 2c0a 2020 2020 2020  l = True,.      
+00006420: 2020 7368 6172 655f 6361 6368 655f 6b65    share_cache_ke
+00006430: 793a 204f 7074 696f 6e61 6c5b 7374 725d  y: Optional[str]
+00006440: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00006450: 2063 6163 6865 5f70 6174 683a 204f 7074   cache_path: Opt
+00006460: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
+00006470: 650a 2920 2d3e 2055 6e69 6f6e 5b53 3350  e.) -> Union[S3P
+00006480: 7265 6665 7463 6852 6561 6465 722c 2053  refetchReader, S
+00006490: 3342 7566 6665 7265 6457 7269 7465 722c  3BufferedWriter,
+000064a0: 2069 6f2e 4275 6666 6572 6564 5265 6164   io.BufferedRead
+000064b0: 6572 2c20 696f 2e0a 2020 2020 2020 2020  er, io..        
+000064c0: 2020 2042 7566 6665 7265 6457 7269 7465     BufferedWrite
+000064d0: 722c 2053 334d 656d 6f72 7948 616e 646c  r, S3MemoryHandl
+000064e0: 6572 5d3a 0a20 2020 2027 2727 4f70 656e  er]:.    '''Open
+000064f0: 2061 6e20 6173 796e 6368 726f 6e6f 7573   an asynchronous
+00006500: 2070 7265 6665 7463 6820 7265 6164 6572   prefetch reader
+00006510: 2c20 746f 2073 7570 706f 7274 2066 6173  , to support fas
+00006520: 7420 7365 7175 656e 7469 616c 2072 6561  t sequential rea
+00006530: 640a 0a20 2020 202e 2e20 6e6f 7465 203a  d..    .. note :
+00006540: 3a0a 0a20 2020 2020 2020 2055 7365 7220  :..        User 
+00006550: 7368 6f75 6c64 206d 616b 6520 7375 7265  should make sure
+00006560: 2074 6861 7420 7265 6164 6572 202f 2077   that reader / w
+00006570: 7269 7465 7220 6172 6520 636c 6f73 6564  riter are closed
+00006580: 2063 6f72 7265 6374 6c79 0a0a 2020 2020   correctly..    
+00006590: 2020 2020 5375 7070 6f72 7473 2063 6f6e      Supports con
+000065a0: 7465 7874 206d 616e 6167 6572 0a0a 2020  text manager..  
+000065b0: 2020 2020 2020 536f 6d65 2070 6172 616d        Some param
+000065c0: 6574 6572 2073 6574 7469 6e67 206d 6179  eter setting may
+000065d0: 2070 6572 666f 726d 2077 656c 6c3a 206d   perform well: m
+000065e0: 6178 5f63 6f6e 6375 7272 656e 6379 3d31  ax_concurrency=1
+000065f0: 3020 6f72 2032 302c 206d 6178 5f62 6c6f  0 or 20, max_blo
+00006600: 636b 5f73 697a 653d 3820 6f72 2031 3620  ck_size=8 or 16 
+00006610: 4d42 2c20 6465 6661 756c 7420 7661 6c75  MB, default valu
+00006620: 6520 4e6f 6e65 206d 6561 6e73 2075 7369  e None means usi
+00006630: 6e67 2067 6c6f 6261 6c20 7468 7265 6164  ng global thread
+00006640: 2070 6f6f 6c0a 0a20 2020 203a 7061 7261   pool..    :para
+00006650: 6d20 6d61 785f 636f 6e63 7572 7265 6e63  m max_concurrenc
+00006660: 793a 204d 6178 2064 6f77 6e6c 6f61 6420  y: Max download 
+00006670: 7468 7265 6164 206e 756d 6265 722c 204e  thread number, N
+00006680: 6f6e 6520 6279 2064 6566 6175 6c74 0a20  one by default. 
+00006690: 2020 203a 7061 7261 6d20 6d61 785f 6275     :param max_bu
+000066a0: 6666 6572 5f73 697a 653a 204d 6178 2063  ffer_size: Max c
+000066b0: 6163 6865 6420 6275 6666 6572 2073 697a  ached buffer siz
+000066c0: 6520 696e 206d 656d 6f72 792c 2031 3238  e in memory, 128
+000066d0: 4d42 2062 7920 6465 6661 756c 740a 2020  MB by default.  
+000066e0: 2020 3a70 6172 616d 2062 6c6f 636b 5f73    :param block_s
+000066f0: 697a 653a 2053 697a 6520 6f66 2073 696e  ize: Size of sin
+00006700: 676c 6520 626c 6f63 6b2c 2038 4d42 2062  gle block, 8MB b
+00006710: 7920 6465 6661 756c 742e 2045 6163 6820  y default. Each 
+00006720: 626c 6f63 6b20 7769 6c6c 2062 6520 7570  block will be up
+00006730: 6c6f 6164 6564 206f 7220 646f 776e 6c6f  loaded or downlo
+00006740: 6164 6564 2062 7920 7369 6e67 6c65 2074  aded by single t
+00006750: 6872 6561 642e 0a20 2020 203a 7061 7261  hread..    :para
+00006760: 6d20 6c69 6d69 7465 645f 7365 656b 6162  m limited_seekab
+00006770: 6c65 3a20 4966 2077 7269 7465 2d68 616e  le: If write-han
+00006780: 646c 6520 7375 7070 6f72 7473 206c 696d  dle supports lim
+00006790: 6974 6564 2073 6565 6b20 2862 6f74 6820  ited seek (both 
+000067a0: 6669 6c65 2068 6561 6420 7061 7274 2061  file head part a
+000067b0: 6e64 2074 6169 6c20 7061 7274 2063 616e  nd tail part can
+000067c0: 2073 6565 6b20 626c 6f63 6b5f 7369 7a65   seek block_size
+000067d0: 292e 204e 6f74 6573 3a20 5468 6973 2070  ). Notes: This p
+000067e0: 6172 616d 6574 6572 2061 7265 2076 616c  arameter are val
+000067f0: 6964 206f 6e6c 7920 666f 7220 7772 6974  id only for writ
+00006800: 652d 6861 6e64 6c65 2e20 5265 6164 2d68  e-handle. Read-h
+00006810: 616e 646c 6520 7375 7070 6f72 7420 6172  andle support ar
+00006820: 6269 7472 6172 7920 7365 656b 0a20 2020  bitrary seek.   
+00006830: 203a 7265 7475 726e 733a 2041 6e20 6f70   :returns: An op
+00006840: 656e 6564 2053 3350 7265 6665 7463 6852  ened S3PrefetchR
+00006850: 6561 6465 7220 6f62 6a65 6374 0a20 2020  eader object.   
+00006860: 203a 7261 6973 6573 3a20 5333 4669 6c65   :raises: S3File
+00006870: 4e6f 7446 6f75 6e64 4572 726f 720a 2020  NotFoundError.  
+00006880: 2020 2727 270a 2020 2020 6966 206d 6f64    '''.    if mod
+00006890: 6520 6e6f 7420 696e 2028 2772 6227 2c20  e not in ('rb', 
+000068a0: 2777 6227 2c20 2761 6227 2c20 2772 622b  'wb', 'ab', 'rb+
+000068b0: 272c 2027 7762 2b27 2c20 2761 622b 2729  ', 'wb+', 'ab+')
+000068c0: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+000068d0: 5661 6c75 6545 7272 6f72 2827 756e 6163  ValueError('unac
+000068e0: 6365 7074 6162 6c65 206d 6f64 653a 2025  ceptable mode: %
+000068f0: 7227 2025 206d 6f64 6529 0a20 2020 2073  r' % mode).    s
+00006900: 335f 7572 6c20 3d20 5333 5061 7468 2873  3_url = S3Path(s
+00006910: 335f 7572 6c29 0a20 2020 2069 6620 666f  3_url).    if fo
+00006920: 6c6c 6f77 6c69 6e6b 733a 0a20 2020 2020  llowlinks:.     
+00006930: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00006940: 2020 2020 7333 5f75 726c 203d 2073 335f      s3_url = s3_
+00006950: 7572 6c2e 7265 6164 6c69 6e6b 2829 0a20  url.readlink(). 
+00006960: 2020 2020 2020 2065 7863 6570 7420 5333         except S3
+00006970: 4e6f 7441 4c69 6e6b 4572 726f 723a 0a20  NotALinkError:. 
+00006980: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+00006990: 0a20 2020 2062 7563 6b65 742c 206b 6579  .    bucket, key
+000069a0: 203d 2070 6172 7365 5f73 335f 7572 6c28   = parse_s3_url(
+000069b0: 7333 5f75 726c 2e70 6174 685f 7769 7468  s3_url.path_with
+000069c0: 5f70 726f 746f 636f 6c29 0a20 2020 2063  _protocol).    c
+000069d0: 6f6e 6669 6720 3d20 626f 746f 636f 7265  onfig = botocore
+000069e0: 2e63 6f6e 6669 672e 436f 6e66 6967 286d  .config.Config(m
+000069f0: 6178 5f70 6f6f 6c5f 636f 6e6e 6563 7469  ax_pool_connecti
+00006a00: 6f6e 733d 6d61 785f 706f 6f6c 5f63 6f6e  ons=max_pool_con
+00006a10: 6e65 6374 696f 6e73 290a 2020 2020 636c  nections).    cl
+00006a20: 6965 6e74 203d 2067 6574 5f73 335f 636c  ient = get_s3_cl
+00006a30: 6965 6e74 280a 2020 2020 2020 2020 636f  ient(.        co
+00006a40: 6e66 6967 3d63 6f6e 6669 672c 0a20 2020  nfig=config,.   
+00006a50: 2020 2020 2063 6163 6865 5f6b 6579 3d27       cache_key='
+00006a60: 7333 5f66 696c 656c 696b 655f 636c 6965  s3_filelike_clie
+00006a70: 6e74 272c 0a20 2020 2020 2020 2070 726f  nt',.        pro
+00006a80: 6669 6c65 5f6e 616d 653d 7333 5f75 726c  file_name=s3_url
+00006a90: 2e5f 7072 6f66 696c 655f 6e61 6d65 290a  ._profile_name).
+00006aa0: 0a20 2020 2069 6620 2761 2720 696e 206d  .    if 'a' in m
+00006ab0: 6f64 6520 6f72 2027 2b27 2069 6e20 6d6f  ode or '+' in mo
+00006ac0: 6465 3a0a 2020 2020 2020 2020 6966 2063  de:.        if c
+00006ad0: 6163 6865 5f70 6174 6820 6973 204e 6f6e  ache_path is Non
+00006ae0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00006af0: 6574 7572 6e20 5333 4d65 6d6f 7279 4861  eturn S3MemoryHa
+00006b00: 6e64 6c65 7228 6275 636b 6574 2c20 6b65  ndler(bucket, ke
+00006b10: 792c 206d 6f64 652c 2073 335f 636c 6965  y, mode, s3_clie
+00006b20: 6e74 3d63 6c69 656e 7429 0a20 2020 2020  nt=client).     
+00006b30: 2020 2072 6574 7572 6e20 5333 4361 6368     return S3Cach
+00006b40: 6564 4861 6e64 6c65 7228 0a20 2020 2020  edHandler(.     
+00006b50: 2020 2020 2020 2062 7563 6b65 742c 206b         bucket, k
+00006b60: 6579 2c20 6d6f 6465 2c20 7333 5f63 6c69  ey, mode, s3_cli
+00006b70: 656e 743d 636c 6965 6e74 2c20 6361 6368  ent=client, cach
+00006b80: 655f 7061 7468 3d63 6163 6865 5f70 6174  e_path=cache_pat
+00006b90: 6829 0a0a 2020 2020 6966 206d 6f64 6520  h)..    if mode 
+00006ba0: 3d3d 2027 7262 273a 0a20 2020 2020 2020  == 'rb':.       
+00006bb0: 2023 2041 2072 6f75 6768 2063 6f6e 7665   # A rough conve
+00006bc0: 7273 696f 6e20 616c 676f 7269 7468 6d20  rsion algorithm 
+00006bd0: 746f 2061 6c69 676e 2032 2074 7970 6573  to align 2 types
+00006be0: 206f 6620 5265 6164 6572 202f 2057 7269   of Reader / Wri
+00006bf0: 7465 7220 7061 7261 6d65 7465 7273 0a20  ter parameters. 
+00006c00: 2020 2020 2020 2023 2054 4f44 4f3a 204f         # TODO: O
+00006c10: 7074 696d 697a 6520 7468 6520 636f 6e76  ptimize the conv
+00006c20: 6572 7369 6f6e 2061 6c67 6f72 6974 686d  ersion algorithm
+00006c30: 0a20 2020 2020 2020 2062 6c6f 636b 5f63  .        block_c
+00006c40: 6170 6163 6974 7920 3d20 6d61 785f 6275  apacity = max_bu
+00006c50: 6666 6572 5f73 697a 6520 2f2f 2062 6c6f  ffer_size // blo
+00006c60: 636b 5f73 697a 650a 2020 2020 2020 2020  ck_size.        
+00006c70: 6966 2066 6f72 7761 7264 5f72 6174 696f  if forward_ratio
+00006c80: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00006c90: 2020 2020 2020 626c 6f63 6b5f 666f 7277        block_forw
+00006ca0: 6172 6420 3d20 4e6f 6e65 0a20 2020 2020  ard = None.     
+00006cb0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00006cc0: 2020 2020 2062 6c6f 636b 5f66 6f72 7761       block_forwa
+00006cd0: 7264 203d 206d 6178 2869 6e74 2862 6c6f  rd = max(int(blo
+00006ce0: 636b 5f63 6170 6163 6974 7920 2a20 666f  ck_capacity * fo
+00006cf0: 7277 6172 645f 7261 7469 6f29 2c20 3129  rward_ratio), 1)
+00006d00: 0a20 2020 2020 2020 2069 6620 7368 6172  .        if shar
+00006d10: 655f 6361 6368 655f 6b65 7920 6973 206e  e_cache_key is n
+00006d20: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00006d30: 2020 2020 2072 6561 6465 7220 3d20 5333       reader = S3
+00006d40: 5368 6172 6543 6163 6865 5265 6164 6572  ShareCacheReader
+00006d50: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00006d60: 2020 6275 636b 6574 2c0a 2020 2020 2020    bucket,.      
+00006d70: 2020 2020 2020 2020 2020 6b65 792c 0a20            key,. 
+00006d80: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00006d90: 6163 6865 5f6b 6579 3d73 6861 7265 5f63  ache_key=share_c
+00006da0: 6163 6865 5f6b 6579 2c0a 2020 2020 2020  ache_key,.      
+00006db0: 2020 2020 2020 2020 2020 7333 5f63 6c69            s3_cli
+00006dc0: 656e 743d 636c 6965 6e74 2c0a 2020 2020  ent=client,.    
+00006dd0: 2020 2020 2020 2020 2020 2020 6d61 785f              max_
+00006de0: 7265 7472 6965 733d 6d61 785f 7265 7472  retries=max_retr
+00006df0: 6965 732c 0a20 2020 2020 2020 2020 2020  ies,.           
+00006e00: 2020 2020 206d 6178 5f77 6f72 6b65 7273       max_workers
+00006e10: 3d6d 6178 5f63 6f6e 6375 7272 656e 6379  =max_concurrency
+00006e20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00006e30: 2020 626c 6f63 6b5f 7369 7a65 3d62 6c6f    block_size=blo
+00006e40: 636b 5f73 697a 652c 0a20 2020 2020 2020  ck_size,.       
+00006e50: 2020 2020 2020 2020 2062 6c6f 636b 5f66           block_f
+00006e60: 6f72 7761 7264 3d62 6c6f 636b 5f66 6f72  orward=block_for
+00006e70: 7761 7264 290a 2020 2020 2020 2020 656c  ward).        el
+00006e80: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00006e90: 7265 6164 6572 203d 2053 3350 7265 6665  reader = S3Prefe
+00006ea0: 7463 6852 6561 6465 7228 0a20 2020 2020  tchReader(.     
+00006eb0: 2020 2020 2020 2020 2020 2062 7563 6b65             bucke
+00006ec0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+00006ed0: 2020 206b 6579 2c0a 2020 2020 2020 2020     key,.        
+00006ee0: 2020 2020 2020 2020 7333 5f63 6c69 656e          s3_clien
+00006ef0: 743d 636c 6965 6e74 2c0a 2020 2020 2020  t=client,.      
+00006f00: 2020 2020 2020 2020 2020 6d61 785f 7265            max_re
+00006f10: 7472 6965 733d 6d61 785f 7265 7472 6965  tries=max_retrie
+00006f20: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00006f30: 2020 206d 6178 5f77 6f72 6b65 7273 3d6d     max_workers=m
+00006f40: 6178 5f63 6f6e 6375 7272 656e 6379 2c0a  ax_concurrency,.
+00006f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006f60: 626c 6f63 6b5f 6361 7061 6369 7479 3d62  block_capacity=b
+00006f70: 6c6f 636b 5f63 6170 6163 6974 792c 0a20  lock_capacity,. 
+00006f80: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00006f90: 6c6f 636b 5f66 6f72 7761 7264 3d62 6c6f  lock_forward=blo
+00006fa0: 636b 5f66 6f72 7761 7264 2c0a 2020 2020  ck_forward,.    
+00006fb0: 2020 2020 2020 2020 2020 2020 626c 6f63              bloc
+00006fc0: 6b5f 7369 7a65 3d62 6c6f 636b 5f73 697a  k_size=block_siz
+00006fd0: 6529 0a20 2020 2020 2020 2069 6620 6275  e).        if bu
+00006fe0: 6666 6572 6564 3a0a 2020 2020 2020 2020  ffered:.        
+00006ff0: 2020 2020 7265 6164 6572 203d 2069 6f2e      reader = io.
+00007000: 4275 6666 6572 6564 5265 6164 6572 2872  BufferedReader(r
+00007010: 6561 6465 7229 2020 2320 7079 7479 7065  eader)  # pytype
+00007020: 3a20 6469 7361 626c 653d 7772 6f6e 672d  : disable=wrong-
+00007030: 6172 672d 7479 7065 730a 2020 2020 2020  arg-types.      
+00007040: 2020 7265 7475 726e 2072 6561 6465 720a    return reader.
+00007050: 0a20 2020 2069 6620 6c69 6d69 7465 645f  .    if limited_
+00007060: 7365 656b 6162 6c65 3a0a 2020 2020 2020  seekable:.      
+00007070: 2020 7772 6974 6572 203d 2053 334c 696d    writer = S3Lim
+00007080: 6974 6564 5365 656b 6162 6c65 5772 6974  itedSeekableWrit
+00007090: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+000070a0: 6275 636b 6574 2c0a 2020 2020 2020 2020  bucket,.        
+000070b0: 2020 2020 6b65 792c 0a20 2020 2020 2020      key,.       
+000070c0: 2020 2020 2073 335f 636c 6965 6e74 3d63       s3_client=c
+000070d0: 6c69 656e 742c 0a20 2020 2020 2020 2020  lient,.         
+000070e0: 2020 206d 6178 5f77 6f72 6b65 7273 3d6d     max_workers=m
+000070f0: 6178 5f63 6f6e 6375 7272 656e 6379 2c0a  ax_concurrency,.
+00007100: 2020 2020 2020 2020 2020 2020 6d61 785f              max_
+00007110: 6275 6666 6572 5f73 697a 653d 6d61 785f  buffer_size=max_
+00007120: 6275 6666 6572 5f73 697a 652c 0a20 2020  buffer_size,.   
+00007130: 2020 2020 2020 2020 2062 6c6f 636b 5f73           block_s
+00007140: 697a 653d 626c 6f63 6b5f 7369 7a65 290a  ize=block_size).
+00007150: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00007160: 2020 7772 6974 6572 203d 2053 3342 7566    writer = S3Buf
+00007170: 6665 7265 6457 7269 7465 7228 0a20 2020  feredWriter(.   
+00007180: 2020 2020 2020 2020 2062 7563 6b65 742c           bucket,
+00007190: 0a20 2020 2020 2020 2020 2020 206b 6579  .            key
+000071a0: 2c0a 2020 2020 2020 2020 2020 2020 7333  ,.            s3
+000071b0: 5f63 6c69 656e 743d 636c 6965 6e74 2c0a  _client=client,.
+000071c0: 2020 2020 2020 2020 2020 2020 6d61 785f              max_
+000071d0: 776f 726b 6572 733d 6d61 785f 636f 6e63  workers=max_conc
+000071e0: 7572 7265 6e63 792c 0a20 2020 2020 2020  urrency,.       
+000071f0: 2020 2020 206d 6178 5f62 7566 6665 725f       max_buffer_
+00007200: 7369 7a65 3d6d 6178 5f62 7566 6665 725f  size=max_buffer_
+00007210: 7369 7a65 2c0a 2020 2020 2020 2020 2020  size,.          
+00007220: 2020 626c 6f63 6b5f 7369 7a65 3d62 6c6f    block_size=blo
+00007230: 636b 5f73 697a 6529 0a20 2020 2069 6620  ck_size).    if 
+00007240: 6275 6666 6572 6564 3a0a 2020 2020 2020  buffered:.      
+00007250: 2020 7772 6974 6572 203d 2069 6f2e 4275    writer = io.Bu
+00007260: 6666 6572 6564 5772 6974 6572 2877 7269  fferedWriter(wri
+00007270: 7465 7229 2020 2320 7079 7479 7065 3a20  ter)  # pytype: 
+00007280: 6469 7361 626c 653d 7772 6f6e 672d 6172  disable=wrong-ar
+00007290: 672d 7479 7065 730a 2020 2020 7265 7475  g-types.    retu
+000072a0: 726e 2077 7269 7465 720a 0a0a 405f 7333  rn writer...@_s3
+000072b0: 5f62 696e 6172 795f 6d6f 6465 0a64 6566  _binary_mode.def
+000072c0: 2073 335f 6d65 6d6f 7279 5f6f 7065 6e28   s3_memory_open(
+000072d0: 0a20 2020 2020 2020 2073 335f 7572 6c3a  .        s3_url:
+000072e0: 2050 6174 684c 696b 652c 206d 6f64 653a   PathLike, mode:
+000072f0: 2073 7472 2c0a 2020 2020 2020 2020 666f   str,.        fo
+00007300: 6c6c 6f77 6c69 6e6b 733a 2062 6f6f 6c20  llowlinks: bool 
+00007310: 3d20 4661 6c73 6529 202d 3e20 5333 4d65  = False) -> S3Me
+00007320: 6d6f 7279 4861 6e64 6c65 723a 0a20 2020  moryHandler:.   
+00007330: 2027 2727 4f70 656e 2061 206d 656d 6f72   '''Open a memor
+00007340: 792d 6361 6368 6520 6669 6c65 2072 6561  y-cache file rea
+00007350: 6465 7220 2f20 7772 6974 6572 2c20 666f  der / writer, fo
+00007360: 7220 6672 6571 7565 6e74 2072 616e 646f  r frequent rando
+00007370: 6d20 7265 6164 202f 2077 7269 7465 0a0a  m read / write..
+00007380: 2020 2020 2e2e 206e 6f74 6520 3a3a 0a0a      .. note ::..
+00007390: 2020 2020 2020 2020 5573 6572 2073 686f          User sho
+000073a0: 756c 6420 6d61 6b65 2073 7572 6520 7468  uld make sure th
+000073b0: 6174 2072 6561 6465 7220 2f20 7772 6974  at reader / writ
+000073c0: 6572 2061 7265 2063 6c6f 7365 6420 636f  er are closed co
+000073d0: 7272 6563 746c 790a 0a20 2020 2020 2020  rrectly..       
+000073e0: 2053 7570 706f 7274 7320 636f 6e74 6578   Supports contex
+000073f0: 7420 6d61 6e61 6765 720a 0a20 2020 203a  t manager..    :
+00007400: 7061 7261 6d20 6d6f 6465 3a20 4d6f 6465  param mode: Mode
+00007410: 2074 6f20 6f70 656e 2066 696c 652c 2063   to open file, c
+00007420: 6f75 6c64 2062 6520 6f6e 6520 6f66 2022  ould be one of "
+00007430: 7262 222c 2022 7762 222c 2022 6162 222c  rb", "wb", "ab",
+00007440: 2022 7262 2b22 2c20 2277 622b 2220 6f72   "rb+", "wb+" or
+00007450: 2022 6162 2b22 0a20 2020 203a 7265 7475   "ab+".    :retu
+00007460: 726e 733a 2041 6e20 6f70 656e 6564 2042  rns: An opened B
+00007470: 7566 6665 7265 6452 6561 6465 7220 2f20  ufferedReader / 
+00007480: 4275 6666 6572 6564 5772 6974 6572 206f  BufferedWriter o
+00007490: 626a 6563 740a 2020 2020 2727 270a 2020  bject.    '''.  
+000074a0: 2020 6966 206d 6f64 6520 6e6f 7420 696e    if mode not in
+000074b0: 2028 2772 6227 2c20 2777 6227 2c20 2761   ('rb', 'wb', 'a
+000074c0: 6227 2c20 2772 622b 272c 2027 7762 2b27  b', 'rb+', 'wb+'
+000074d0: 2c20 2761 622b 2729 3a0a 2020 2020 2020  , 'ab+'):.      
+000074e0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+000074f0: 6f72 2827 756e 6163 6365 7074 6162 6c65  or('unacceptable
+00007500: 206d 6f64 653a 2025 7227 2025 206d 6f64   mode: %r' % mod
+00007510: 6529 0a20 2020 2073 335f 7572 6c20 3d20  e).    s3_url = 
+00007520: 5333 5061 7468 2873 335f 7572 6c29 0a20  S3Path(s3_url). 
+00007530: 2020 2069 6620 666f 6c6c 6f77 6c69 6e6b     if followlink
+00007540: 733a 0a20 2020 2020 2020 2074 7279 3a0a  s:.        try:.
+00007550: 2020 2020 2020 2020 2020 2020 7333 5f75              s3_u
+00007560: 726c 203d 2073 335f 7572 6c2e 7265 6164  rl = s3_url.read
+00007570: 6c69 6e6b 2829 0a20 2020 2020 2020 2065  link().        e
+00007580: 7863 6570 7420 5333 4e6f 7441 4c69 6e6b  xcept S3NotALink
+00007590: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+000075a0: 2020 2070 6173 730a 0a20 2020 2062 7563     pass..    buc
+000075b0: 6b65 742c 206b 6579 203d 2070 6172 7365  ket, key = parse
+000075c0: 5f73 335f 7572 6c28 7333 5f75 726c 2e70  _s3_url(s3_url.p
+000075d0: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+000075e0: 6c29 0a20 2020 2063 6f6e 6669 6720 3d20  l).    config = 
+000075f0: 626f 746f 636f 7265 2e63 6f6e 6669 672e  botocore.config.
+00007600: 436f 6e66 6967 286d 6178 5f70 6f6f 6c5f  Config(max_pool_
+00007610: 636f 6e6e 6563 7469 6f6e 733d 6d61 785f  connections=max_
+00007620: 706f 6f6c 5f63 6f6e 6e65 6374 696f 6e73  pool_connections
+00007630: 290a 2020 2020 636c 6965 6e74 203d 2067  ).    client = g
+00007640: 6574 5f73 335f 636c 6965 6e74 280a 2020  et_s3_client(.  
+00007650: 2020 2020 2020 636f 6e66 6967 3d63 6f6e        config=con
+00007660: 6669 672c 0a20 2020 2020 2020 2063 6163  fig,.        cac
+00007670: 6865 5f6b 6579 3d27 7333 5f66 696c 656c  he_key='s3_filel
+00007680: 696b 655f 636c 6965 6e74 272c 0a20 2020  ike_client',.   
+00007690: 2020 2020 2070 726f 6669 6c65 5f6e 616d       profile_nam
+000076a0: 653d 7333 5f75 726c 2e5f 7072 6f66 696c  e=s3_url._profil
+000076b0: 655f 6e61 6d65 290a 2020 2020 7265 7475  e_name).    retu
+000076c0: 726e 2053 334d 656d 6f72 7948 616e 646c  rn S3MemoryHandl
+000076d0: 6572 2862 7563 6b65 742c 206b 6579 2c20  er(bucket, key, 
+000076e0: 6d6f 6465 2c20 7333 5f63 6c69 656e 743d  mode, s3_client=
+000076f0: 636c 6965 6e74 290a 0a0a 7333 5f6f 7065  client)...s3_ope
+00007700: 6e20 3d20 7333 5f62 7566 6665 7265 645f  n = s3_buffered_
+00007710: 6f70 656e 0a0a 0a64 6566 2073 335f 646f  open...def s3_do
+00007720: 776e 6c6f 6164 280a 2020 2020 2020 2020  wnload(.        
+00007730: 7372 635f 7572 6c3a 2050 6174 684c 696b  src_url: PathLik
+00007740: 652c 0a20 2020 2020 2020 2064 7374 5f75  e,.        dst_u
+00007750: 726c 3a20 5061 7468 4c69 6b65 2c0a 2020  rl: PathLike,.  
+00007760: 2020 2020 2020 666f 6c6c 6f77 6c69 6e6b        followlink
+00007770: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
+00007780: 0a20 2020 2020 2020 2063 616c 6c62 6163  .        callbac
+00007790: 6b3a 204f 7074 696f 6e61 6c5b 4361 6c6c  k: Optional[Call
+000077a0: 6162 6c65 5b5b 696e 745d 2c20 4e6f 6e65  able[[int], None
+000077b0: 5d5d 203d 204e 6f6e 6529 202d 3e20 4e6f  ]] = None) -> No
+000077c0: 6e65 3a0a 2020 2020 2727 270a 2020 2020  ne:.    '''.    
+000077d0: 446f 776e 6c6f 6164 7320 6120 6669 6c65  Downloads a file
+000077e0: 2066 726f 6d20 7333 2074 6f20 6c6f 6361   from s3 to loca
+000077f0: 6c20 6669 6c65 7379 7374 656d 2e0a 2020  l filesystem..  
+00007800: 2020 3a70 6172 616d 2073 7263 5f75 726c    :param src_url
+00007810: 3a20 736f 7572 6365 2073 3320 7061 7468  : source s3 path
+00007820: 0a20 2020 203a 7061 7261 6d20 6473 745f  .    :param dst_
+00007830: 7572 6c3a 2074 6172 6765 7420 6673 2070  url: target fs p
+00007840: 6174 680a 2020 2020 3a70 6172 616d 2063  ath.    :param c
+00007850: 616c 6c62 6163 6b3a 2043 616c 6c65 6420  allback: Called 
+00007860: 7065 7269 6f64 6963 616c 6c79 2064 7572  periodically dur
+00007870: 696e 6720 636f 7079 2c20 616e 6420 7468  ing copy, and th
+00007880: 6520 696e 7075 7420 7061 7261 6d65 7465  e input paramete
+00007890: 7220 6973 2074 6865 2064 6174 6120 7369  r is the data si
+000078a0: 7a65 2028 696e 2062 7974 6573 2920 6f66  ze (in bytes) of
+000078b0: 2063 6f70 7920 7369 6e63 6520 7468 6520   copy since the 
+000078c0: 6c61 7374 2063 616c 6c0a 2020 2020 2727  last call.    ''
+000078d0: 270a 2020 2020 7372 635f 7572 6c20 3d20  '.    src_url = 
+000078e0: 5333 5061 7468 2873 7263 5f75 726c 290a  S3Path(src_url).
+000078f0: 2020 2020 6966 2066 6f6c 6c6f 776c 696e      if followlin
+00007900: 6b73 3a0a 2020 2020 2020 2020 7472 793a  ks:.        try:
+00007910: 0a20 2020 2020 2020 2020 2020 2073 7263  .            src
+00007920: 5f75 726c 203d 2073 7263 5f75 726c 2e72  _url = src_url.r
+00007930: 6561 646c 696e 6b28 290a 2020 2020 2020  eadlink().      
+00007940: 2020 6578 6365 7074 2053 334e 6f74 414c    except S3NotAL
+00007950: 696e 6b45 7272 6f72 3a0a 2020 2020 2020  inkError:.      
+00007960: 2020 2020 2020 7061 7373 0a20 2020 2073        pass.    s
+00007970: 7263 5f62 7563 6b65 742c 2073 7263 5f6b  rc_bucket, src_k
+00007980: 6579 203d 2070 6172 7365 5f73 335f 7572  ey = parse_s3_ur
+00007990: 6c28 7372 635f 7572 6c2e 7061 7468 5f77  l(src_url.path_w
+000079a0: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
+000079b0: 2020 6966 206e 6f74 2073 7263 5f62 7563    if not src_buc
+000079c0: 6b65 743a 0a20 2020 2020 2020 2072 6169  ket:.        rai
+000079d0: 7365 2053 3342 7563 6b65 744e 6f74 466f  se S3BucketNotFo
+000079e0: 756e 6445 7272 6f72 280a 2020 2020 2020  undError(.      
+000079f0: 2020 2020 2020 2745 6d70 7479 2062 7563        'Empty buc
+00007a00: 6b65 7420 6e61 6d65 3a20 2572 2720 2520  ket name: %r' % 
+00007a10: 7372 635f 7572 6c2e 7061 7468 5f77 6974  src_url.path_wit
+00007a20: 685f 7072 6f74 6f63 6f6c 290a 0a20 2020  h_protocol)..   
+00007a30: 2069 6620 6e6f 7420 7372 635f 7572 6c2e   if not src_url.
+00007a40: 6578 6973 7473 2829 3a0a 2020 2020 2020  exists():.      
+00007a50: 2020 7261 6973 6520 5333 4669 6c65 4e6f    raise S3FileNo
+00007a60: 7446 6f75 6e64 4572 726f 7228 0a20 2020  tFoundError(.   
+00007a70: 2020 2020 2020 2020 2027 4669 6c65 206e           'File n
+00007a80: 6f74 2066 6f75 6e64 3a20 2572 2720 2520  ot found: %r' % 
+00007a90: 7372 635f 7572 6c2e 7061 7468 5f77 6974  src_url.path_wit
+00007aa0: 685f 7072 6f74 6f63 6f6c 290a 0a20 2020  h_protocol)..   
+00007ab0: 2069 6620 6e6f 7420 7372 635f 7572 6c2e   if not src_url.
+00007ac0: 6973 5f66 696c 6528 293a 0a20 2020 2020  is_file():.     
+00007ad0: 2020 2072 6169 7365 2053 3349 7341 4469     raise S3IsADi
+00007ae0: 7265 6374 6f72 7945 7272 6f72 280a 2020  rectoryError(.  
+00007af0: 2020 2020 2020 2020 2020 2749 7320 6120            'Is a 
+00007b00: 6469 7265 6374 6f72 793a 2025 7227 2025  directory: %r' %
+00007b10: 2073 7263 5f75 726c 2e70 6174 685f 7769   src_url.path_wi
+00007b20: 7468 5f70 726f 746f 636f 6c29 0a0a 2020  th_protocol)..  
+00007b30: 2020 6473 745f 7572 6c20 3d20 6673 7061    dst_url = fspa
+00007b40: 7468 2864 7374 5f75 726c 290a 2020 2020  th(dst_url).    
+00007b50: 6966 206e 6f74 2064 7374 5f75 726c 206f  if not dst_url o
+00007b60: 7220 6473 745f 7572 6c2e 656e 6473 7769  r dst_url.endswi
+00007b70: 7468 2827 2f27 293a 0a20 2020 2020 2020  th('/'):.       
+00007b80: 2072 6169 7365 2053 3349 7341 4469 7265   raise S3IsADire
+00007b90: 6374 6f72 7945 7272 6f72 2827 4973 2061  ctoryError('Is a
+00007ba0: 2064 6972 6563 746f 7279 3a20 2572 2720   directory: %r' 
+00007bb0: 2520 6473 745f 7572 6c29 0a0a 2020 2020  % dst_url)..    
+00007bc0: 6473 745f 6469 7265 6374 6f72 7920 3d20  dst_directory = 
+00007bd0: 6f73 2e70 6174 682e 6469 726e 616d 6528  os.path.dirname(
+00007be0: 6473 745f 7572 6c29 0a20 2020 2069 6620  dst_url).    if 
+00007bf0: 6473 745f 6469 7265 6374 6f72 7920 213d  dst_directory !=
+00007c00: 2027 273a 0a20 2020 2020 2020 206f 732e   '':.        os.
+00007c10: 6d61 6b65 6469 7273 2864 7374 5f64 6972  makedirs(dst_dir
+00007c20: 6563 746f 7279 2c20 6578 6973 745f 6f6b  ectory, exist_ok
+00007c30: 3d54 7275 6529 0a0a 2020 2020 636c 6965  =True)..    clie
+00007c40: 6e74 203d 2067 6574 5f73 335f 636c 6965  nt = get_s3_clie
+00007c50: 6e74 2870 726f 6669 6c65 5f6e 616d 653d  nt(profile_name=
+00007c60: 7372 635f 7572 6c2e 5f70 726f 6669 6c65  src_url._profile
+00007c70: 5f6e 616d 6529 0a20 2020 2074 7279 3a0a  _name).    try:.
+00007c80: 2020 2020 2020 2020 636c 6965 6e74 2e64          client.d
+00007c90: 6f77 6e6c 6f61 645f 6669 6c65 2873 7263  ownload_file(src
+00007ca0: 5f62 7563 6b65 742c 2073 7263 5f6b 6579  _bucket, src_key
+00007cb0: 2c20 6473 745f 7572 6c2c 2043 616c 6c62  , dst_url, Callb
+00007cc0: 6163 6b3d 6361 6c6c 6261 636b 290a 2020  ack=callback).  
+00007cd0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+00007ce0: 6f6e 2061 7320 6572 726f 723a 0a20 2020  on as error:.   
+00007cf0: 2020 2020 2065 7272 6f72 203d 2074 7261       error = tra
+00007d00: 6e73 6c61 7465 5f66 735f 6572 726f 7228  nslate_fs_error(
+00007d10: 6572 726f 722c 2064 7374 5f75 726c 290a  error, dst_url).
+00007d20: 2020 2020 2020 2020 6572 726f 7220 3d20          error = 
+00007d30: 7472 616e 736c 6174 655f 7333 5f65 7272  translate_s3_err
+00007d40: 6f72 2865 7272 6f72 2c20 7372 635f 7572  or(error, src_ur
+00007d50: 6c2e 7061 7468 5f77 6974 685f 7072 6f74  l.path_with_prot
+00007d60: 6f63 6f6c 290a 2020 2020 2020 2020 7261  ocol).        ra
+00007d70: 6973 6520 6572 726f 720a 0a20 2020 2073  ise error..    s
+00007d80: 7263 5f73 7461 7420 3d20 7372 635f 7572  rc_stat = src_ur
+00007d90: 6c2e 7374 6174 2829 0a20 2020 206f 732e  l.stat().    os.
+00007da0: 7574 696d 6528 6473 745f 7572 6c2c 2028  utime(dst_url, (
+00007db0: 7372 635f 7374 6174 2e73 745f 6d74 696d  src_stat.st_mtim
+00007dc0: 652c 2073 7263 5f73 7461 742e 7374 5f6d  e, src_stat.st_m
+00007dd0: 7469 6d65 2929 0a0a 0a64 6566 2073 335f  time))...def s3_
+00007de0: 7570 6c6f 6164 280a 2020 2020 2020 2020  upload(.        
+00007df0: 7372 635f 7572 6c3a 2050 6174 684c 696b  src_url: PathLik
+00007e00: 652c 0a20 2020 2020 2020 2064 7374 5f75  e,.        dst_u
+00007e10: 726c 3a20 5061 7468 4c69 6b65 2c0a 2020  rl: PathLike,.  
+00007e20: 2020 2020 2020 6361 6c6c 6261 636b 3a20        callback: 
+00007e30: 4f70 7469 6f6e 616c 5b43 616c 6c61 626c  Optional[Callabl
+00007e40: 655b 5b69 6e74 5d2c 204e 6f6e 655d 5d20  e[[int], None]] 
+00007e50: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00007e60: 2a2a 6b77 6172 6773 2920 2d3e 204e 6f6e  **kwargs) -> Non
+00007e70: 653a 0a20 2020 2027 2727 0a20 2020 2055  e:.    '''.    U
+00007e80: 706c 6f61 6473 2061 2066 696c 6520 6672  ploads a file fr
+00007e90: 6f6d 206c 6f63 616c 2066 696c 6573 7973  om local filesys
+00007ea0: 7465 6d20 746f 2073 332e 0a20 2020 203a  tem to s3..    :
+00007eb0: 7061 7261 6d20 7372 635f 7572 6c3a 2073  param src_url: s
+00007ec0: 6f75 7263 6520 6673 2070 6174 680a 2020  ource fs path.  
+00007ed0: 2020 3a70 6172 616d 2064 7374 5f75 726c    :param dst_url
+00007ee0: 3a20 7461 7267 6574 2073 3320 7061 7468  : target s3 path
+00007ef0: 0a20 2020 203a 7061 7261 6d20 6361 6c6c  .    :param call
+00007f00: 6261 636b 3a20 4361 6c6c 6564 2070 6572  back: Called per
+00007f10: 696f 6469 6361 6c6c 7920 6475 7269 6e67  iodically during
+00007f20: 2063 6f70 792c 2061 6e64 2074 6865 2069   copy, and the i
+00007f30: 6e70 7574 2070 6172 616d 6574 6572 2069  nput parameter i
+00007f40: 7320 7468 6520 6461 7461 2073 697a 6520  s the data size 
+00007f50: 2869 6e20 6279 7465 7329 206f 6620 636f  (in bytes) of co
+00007f60: 7079 2073 696e 6365 2074 6865 206c 6173  py since the las
+00007f70: 7420 6361 6c6c 0a20 2020 2027 2727 0a20  t call.    '''. 
+00007f80: 2020 2064 7374 5f62 7563 6b65 742c 2064     dst_bucket, d
+00007f90: 7374 5f6b 6579 203d 2070 6172 7365 5f73  st_key = parse_s
+00007fa0: 335f 7572 6c28 6473 745f 7572 6c29 0a20  3_url(dst_url). 
+00007fb0: 2020 2069 6620 6e6f 7420 6473 745f 6275     if not dst_bu
+00007fc0: 636b 6574 3a0a 2020 2020 2020 2020 7261  cket:.        ra
+00007fd0: 6973 6520 5333 4275 636b 6574 4e6f 7446  ise S3BucketNotF
+00007fe0: 6f75 6e64 4572 726f 7228 2745 6d70 7479  oundError('Empty
+00007ff0: 2062 7563 6b65 7420 6e61 6d65 3a20 2572   bucket name: %r
+00008000: 2720 2520 6473 745f 7572 6c29 0a20 2020  ' % dst_url).   
+00008010: 2069 6620 6e6f 7420 6473 745f 6b65 7920   if not dst_key 
+00008020: 6f72 2064 7374 5f6b 6579 2e65 6e64 7377  or dst_key.endsw
+00008030: 6974 6828 272f 2729 3a0a 2020 2020 2020  ith('/'):.      
+00008040: 2020 7261 6973 6520 5333 4973 4144 6972    raise S3IsADir
+00008050: 6563 746f 7279 4572 726f 7228 2749 7320  ectoryError('Is 
+00008060: 6120 6469 7265 6374 6f72 793a 2025 7227  a directory: %r'
+00008070: 2025 2064 7374 5f75 726c 290a 0a20 2020   % dst_url)..   
+00008080: 2063 6c69 656e 7420 3d20 6765 745f 7333   client = get_s3
+00008090: 5f63 6c69 656e 7428 7072 6f66 696c 655f  _client(profile_
+000080a0: 6e61 6d65 3d53 3350 6174 6828 6473 745f  name=S3Path(dst_
+000080b0: 7572 6c29 2e5f 7072 6f66 696c 655f 6e61  url)._profile_na
+000080c0: 6d65 290a 2020 2020 7769 7468 206f 7065  me).    with ope
+000080d0: 6e28 7372 635f 7572 6c2c 2027 7262 2729  n(src_url, 'rb')
+000080e0: 2061 7320 7372 633a 0a20 2020 2020 2020   as src:.       
+000080f0: 2077 6974 6820 7261 6973 655f 7333 5f65   with raise_s3_e
+00008100: 7272 6f72 2864 7374 5f75 726c 293a 0a20  rror(dst_url):. 
+00008110: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
+00008120: 742e 7570 6c6f 6164 5f66 696c 656f 626a  t.upload_fileobj
+00008130: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00008140: 2020 7372 632c 2042 7563 6b65 743d 6473    src, Bucket=ds
+00008150: 745f 6275 636b 6574 2c20 4b65 793d 6473  t_bucket, Key=ds
+00008160: 745f 6b65 792c 2043 616c 6c62 6163 6b3d  t_key, Callback=
+00008170: 6361 6c6c 6261 636b 290a 0a0a 6465 6620  callback)...def 
+00008180: 7333 5f6c 6f61 645f 636f 6e74 656e 7428  s3_load_content(
+00008190: 0a20 2020 2020 2020 2073 335f 7572 6c2c  .        s3_url,
+000081a0: 0a20 2020 2020 2020 2073 7461 7274 3a20  .        start: 
+000081b0: 4f70 7469 6f6e 616c 5b69 6e74 5d20 3d20  Optional[int] = 
+000081c0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7374  None,.        st
+000081d0: 6f70 3a20 4f70 7469 6f6e 616c 5b69 6e74  op: Optional[int
+000081e0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+000081f0: 2020 666f 6c6c 6f77 6c69 6e6b 733a 2062    followlinks: b
+00008200: 6f6f 6c20 3d20 4661 6c73 6529 202d 3e20  ool = False) -> 
+00008210: 6279 7465 733a 0a20 2020 2027 2727 0a20  bytes:.    '''. 
+00008220: 2020 2047 6574 2073 7065 6369 6669 6564     Get specified
+00008230: 2066 696c 6520 6672 6f6d 205b 7374 6172   file from [star
+00008240: 742c 2073 746f 7029 2069 6e20 6279 7465  t, stop) in byte
+00008250: 730a 0a20 2020 203a 7061 7261 6d20 7333  s..    :param s3
+00008260: 5f75 726c 3a20 5370 6563 6966 6965 6420  _url: Specified 
+00008270: 7061 7468 0a20 2020 203a 7061 7261 6d20  path.    :param 
+00008280: 7374 6172 743a 2073 7461 7274 2069 6e64  start: start ind
+00008290: 6578 0a20 2020 203a 7061 7261 6d20 7374  ex.    :param st
+000082a0: 6f70 3a20 7374 6f70 2069 6e64 6578 0a20  op: stop index. 
+000082b0: 2020 203a 7265 7475 726e 733a 2062 7974     :returns: byt
+000082c0: 6573 2063 6f6e 7465 6e74 2069 6e20 7261  es content in ra
+000082d0: 6e67 6520 5b73 7461 7274 2c20 7374 6f70  nge [start, stop
+000082e0: 290a 2020 2020 2727 270a 0a20 2020 2064  ).    '''..    d
+000082f0: 6566 205f 6765 745f 6f62 6a65 6374 2863  ef _get_object(c
+00008300: 6c69 656e 742c 2062 7563 6b65 742c 206b  lient, bucket, k
+00008310: 6579 2c20 7261 6e67 655f 7374 7229 3a0a  ey, range_str):.
+00008320: 2020 2020 2020 2020 7265 7475 726e 2063          return c
+00008330: 6c69 656e 742e 6765 745f 6f62 6a65 6374  lient.get_object
+00008340: 280a 2020 2020 2020 2020 2020 2020 4275  (.            Bu
+00008350: 636b 6574 3d62 7563 6b65 742c 204b 6579  cket=bucket, Key
+00008360: 3d6b 6579 2c20 5261 6e67 653d 7261 6e67  =key, Range=rang
+00008370: 655f 7374 7229 5b27 426f 6479 275d 2e72  e_str)['Body'].r
+00008380: 6561 6428 290a 0a20 2020 2073 335f 7572  ead()..    s3_ur
+00008390: 6c20 3d20 5333 5061 7468 2873 335f 7572  l = S3Path(s3_ur
+000083a0: 6c29 0a20 2020 2069 6620 666f 6c6c 6f77  l).    if follow
+000083b0: 6c69 6e6b 733a 0a20 2020 2020 2020 2074  links:.        t
+000083c0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+000083d0: 7333 5f75 726c 203d 2073 335f 7572 6c2e  s3_url = s3_url.
+000083e0: 7265 6164 6c69 6e6b 2829 0a20 2020 2020  readlink().     
+000083f0: 2020 2065 7863 6570 7420 5333 4e6f 7441     except S3NotA
+00008400: 4c69 6e6b 4572 726f 723a 0a20 2020 2020  LinkError:.     
+00008410: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
+00008420: 2062 7563 6b65 742c 206b 6579 203d 2070   bucket, key = p
+00008430: 6172 7365 5f73 335f 7572 6c28 7333 5f75  arse_s3_url(s3_u
+00008440: 726c 2e70 6174 685f 7769 7468 5f70 726f  rl.path_with_pro
+00008450: 746f 636f 6c29 0a20 2020 2069 6620 6e6f  tocol).    if no
+00008460: 7420 6275 636b 6574 3a0a 2020 2020 2020  t bucket:.      
+00008470: 2020 7261 6973 6520 5333 4275 636b 6574    raise S3Bucket
+00008480: 4e6f 7446 6f75 6e64 4572 726f 7228 2745  NotFoundError('E
+00008490: 6d70 7479 2062 7563 6b65 7420 6e61 6d65  mpty bucket name
+000084a0: 3a20 2572 2720 2520 7333 5f75 726c 290a  : %r' % s3_url).
+000084b0: 2020 2020 6966 206e 6f74 206b 6579 206f      if not key o
+000084c0: 7220 6b65 792e 656e 6473 7769 7468 2827  r key.endswith('
+000084d0: 2f27 293a 0a20 2020 2020 2020 2072 6169  /'):.        rai
+000084e0: 7365 2053 3349 7341 4469 7265 6374 6f72  se S3IsADirector
+000084f0: 7945 7272 6f72 2827 4973 2061 2064 6972  yError('Is a dir
+00008500: 6563 746f 7279 3a20 2572 2720 2520 7333  ectory: %r' % s3
+00008510: 5f75 726c 290a 0a20 2020 2073 7461 7274  _url)..    start
+00008520: 2c20 7374 6f70 203d 2067 6574 5f63 6f6e  , stop = get_con
+00008530: 7465 6e74 5f6f 6666 7365 7428 0a20 2020  tent_offset(.   
+00008540: 2020 2020 2073 7461 7274 2c20 7374 6f70       start, stop
+00008550: 2c20 7333 5f75 726c 2e67 6574 7369 7a65  , s3_url.getsize
+00008560: 2866 6f6c 6c6f 775f 7379 6d6c 696e 6b73  (follow_symlinks
+00008570: 3d46 616c 7365 2929 0a20 2020 2069 6620  =False)).    if 
+00008580: 7374 6172 7420 3d3d 2030 2061 6e64 2073  start == 0 and s
+00008590: 746f 7020 3d3d 2030 3a0a 2020 2020 2020  top == 0:.      
+000085a0: 2020 7265 7475 726e 2062 2727 0a20 2020    return b''.   
+000085b0: 2072 616e 6765 5f73 7472 203d 2027 6279   range_str = 'by
+000085c0: 7465 733d 2564 2d25 6427 2025 2028 7374  tes=%d-%d' % (st
+000085d0: 6172 742c 2073 746f 7020 2d20 3129 0a0a  art, stop - 1)..
+000085e0: 2020 2020 636c 6965 6e74 203d 2067 6574      client = get
+000085f0: 5f73 335f 636c 6965 6e74 2870 726f 6669  _s3_client(profi
+00008600: 6c65 5f6e 616d 653d 7333 5f75 726c 2e5f  le_name=s3_url._
+00008610: 7072 6f66 696c 655f 6e61 6d65 290a 2020  profile_name).  
+00008620: 2020 7769 7468 2072 6169 7365 5f73 335f    with raise_s3_
+00008630: 6572 726f 7228 7333 5f75 726c 2e70 6174  error(s3_url.pat
+00008640: 6829 3a0a 2020 2020 2020 2020 7265 7475  h):.        retu
+00008650: 726e 2070 6174 6368 5f6d 6574 686f 6428  rn patch_method(
+00008660: 0a20 2020 2020 2020 2020 2020 205f 6765  .            _ge
+00008670: 745f 6f62 6a65 6374 2c0a 2020 2020 2020  t_object,.      
+00008680: 2020 2020 2020 6d61 785f 7265 7472 6965        max_retrie
+00008690: 733d 6d61 785f 7265 7472 6965 732c 0a20  s=max_retries,. 
+000086a0: 2020 2020 2020 2020 2020 2073 686f 756c             shoul
+000086b0: 645f 7265 7472 793d 7333 5f73 686f 756c  d_retry=s3_shoul
+000086c0: 645f 7265 7472 792c 0a20 2020 2020 2020  d_retry,.       
+000086d0: 2029 2863 6c69 656e 742c 2062 7563 6b65   )(client, bucke
+000086e0: 742c 206b 6579 2c20 7261 6e67 655f 7374  t, key, range_st
+000086f0: 7229 0a0a 0a64 6566 2073 335f 7265 6164  r)...def s3_read
+00008700: 6c69 6e6b 2870 6174 6829 202d 3e20 7374  link(path) -> st
+00008710: 723a 0a20 2020 2027 2727 0a20 2020 2052  r:.    '''.    R
+00008720: 6574 7572 6e20 6120 7374 7269 6e67 2072  eturn a string r
+00008730: 6570 7265 7365 6e74 696e 6720 7468 6520  epresenting the 
+00008740: 7061 7468 2074 6f20 7768 6963 6820 7468  path to which th
+00008750: 6520 7379 6d62 6f6c 6963 206c 696e 6b20  e symbolic link 
+00008760: 706f 696e 7473 2e0a 0a20 2020 203a 7265  points...    :re
+00008770: 7475 726e 733a 2052 6574 7572 6e20 6120  turns: Return a 
+00008780: 7374 7269 6e67 2072 6570 7265 7365 6e74  string represent
+00008790: 696e 6720 7468 6520 7061 7468 2074 6f20  ing the path to 
+000087a0: 7768 6963 6820 7468 6520 7379 6d62 6f6c  which the symbol
+000087b0: 6963 206c 696e 6b20 706f 696e 7473 2e0a  ic link points..
+000087c0: 2020 2020 3a72 6169 7365 733a 2053 334e      :raises: S3N
+000087d0: 616d 6554 6f6f 4c6f 6e67 4572 726f 722c  ameTooLongError,
+000087e0: 2053 3342 7563 6b65 744e 6f74 466f 756e   S3BucketNotFoun
+000087f0: 6445 7272 6f72 2c20 5333 4973 4144 6972  dError, S3IsADir
+00008800: 6563 746f 7279 4572 726f 722c 2053 334e  ectoryError, S3N
+00008810: 6f74 414c 696e 6b45 7272 6f72 0a20 2020  otALinkError.   
+00008820: 2027 2727 0a20 2020 2072 6574 7572 6e20   '''.    return 
+00008830: 5333 5061 7468 2870 6174 6829 2e72 6561  S3Path(path).rea
+00008840: 646c 696e 6b28 292e 7061 7468 5f77 6974  dlink().path_wit
+00008850: 685f 7072 6f74 6f63 6f6c 0a0a 0a64 6566  h_protocol...def
+00008860: 2073 335f 7265 6e61 6d65 2873 7263 5f75   s3_rename(src_u
+00008870: 726c 3a20 5061 7468 4c69 6b65 2c20 6473  rl: PathLike, ds
+00008880: 745f 7572 6c3a 2050 6174 684c 696b 6529  t_url: PathLike)
+00008890: 3a0a 2020 2020 2727 270a 2020 2020 4d6f  :.    '''.    Mo
+000088a0: 7665 2073 3320 6669 6c65 2070 6174 6820  ve s3 file path 
+000088b0: 6672 6f6d 2073 7263 5f75 726c 2074 6f20  from src_url to 
+000088c0: 6473 745f 7572 6c0a 0a20 2020 203a 7061  dst_url..    :pa
+000088d0: 7261 6d20 6473 745f 7572 6c3a 2047 6976  ram dst_url: Giv
+000088e0: 656e 2064 6573 7469 6e61 7469 6f6e 2070  en destination p
+000088f0: 6174 680a 2020 2020 2727 270a 2020 2020  ath.    '''.    
+00008900: 7372 635f 7061 7468 5f69 6e73 203d 2053  src_path_ins = S
+00008910: 3350 6174 6828 7372 635f 7572 6c29 0a20  3Path(src_url). 
+00008920: 2020 2069 6620 7372 635f 7061 7468 5f69     if src_path_i
+00008930: 6e73 2e69 735f 6669 6c65 2829 3a0a 2020  ns.is_file():.  
+00008940: 2020 2020 2020 7372 635f 7061 7468 5f69        src_path_i
+00008950: 6e73 2e63 6f70 7928 6473 745f 7572 6c29  ns.copy(dst_url)
+00008960: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+00008970: 2020 2073 7263 5f70 6174 685f 696e 732e     src_path_ins.
+00008980: 7379 6e63 2864 7374 5f75 726c 290a 2020  sync(dst_url).  
+00008990: 2020 7372 635f 7061 7468 5f69 6e73 2e72    src_path_ins.r
+000089a0: 656d 6f76 6528 290a 0a0a 636c 6173 7320  emove()...class 
+000089b0: 5333 4361 6368 6572 2846 696c 6543 6163  S3Cacher(FileCac
+000089c0: 6865 7229 3a0a 2020 2020 6361 6368 655f  her):.    cache_
+000089d0: 7061 7468 203d 204e 6f6e 650a 0a20 2020  path = None..   
+000089e0: 2064 6566 205f 5f69 6e69 745f 5f28 0a20   def __init__(. 
+000089f0: 2020 2020 2020 2020 2020 2073 656c 662c             self,
+00008a00: 2070 6174 683a 2073 7472 2c20 6361 6368   path: str, cach
+00008a10: 655f 7061 7468 3a20 4f70 7469 6f6e 616c  e_path: Optional
+00008a20: 5b73 7472 5d20 3d20 4e6f 6e65 2c20 6d6f  [str] = None, mo
+00008a30: 6465 3a20 7374 7220 3d20 2772 2729 3a0a  de: str = 'r'):.
+00008a40: 2020 2020 2020 2020 6966 206d 6f64 6520          if mode 
+00008a50: 6e6f 7420 696e 2028 2772 272c 2027 7727  not in ('r', 'w'
+00008a60: 2c20 2761 2729 3a0a 2020 2020 2020 2020  , 'a'):.        
+00008a70: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+00008a80: 7272 6f72 2827 756e 6163 6365 7074 6162  rror('unacceptab
+00008a90: 6c65 206d 6f64 653a 2025 7227 2025 206d  le mode: %r' % m
+00008aa0: 6f64 6529 0a20 2020 2020 2020 2069 6620  ode).        if 
+00008ab0: 6d6f 6465 2069 6e20 2827 7227 2c20 2761  mode in ('r', 'a
+00008ac0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+00008ad0: 6966 2063 6163 6865 5f70 6174 6820 6973  if cache_path is
+00008ae0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00008af0: 2020 2020 2020 2063 6163 6865 5f70 6174         cache_pat
+00008b00: 6820 3d20 6765 6e65 7261 7465 5f63 6163  h = generate_cac
+00008b10: 6865 5f70 6174 6828 7061 7468 290a 2020  he_path(path).  
+00008b20: 2020 2020 2020 2020 2020 7333 5f64 6f77            s3_dow
+00008b30: 6e6c 6f61 6428 7061 7468 2c20 6361 6368  nload(path, cach
+00008b40: 655f 7061 7468 290a 2020 2020 2020 2020  e_path).        
+00008b50: 7365 6c66 2e6e 616d 6520 3d20 7061 7468  self.name = path
+00008b60: 0a20 2020 2020 2020 2073 656c 662e 6d6f  .        self.mo
+00008b70: 6465 203d 206d 6f64 650a 2020 2020 2020  de = mode.      
+00008b80: 2020 7365 6c66 2e63 6163 6865 5f70 6174    self.cache_pat
+00008b90: 6820 3d20 6361 6368 655f 7061 7468 0a0a  h = cache_path..
+00008ba0: 2020 2020 6465 6620 5f63 6c6f 7365 2873      def _close(s
+00008bb0: 656c 6629 3a0a 2020 2020 2020 2020 6966  elf):.        if
+00008bc0: 2073 656c 662e 6361 6368 655f 7061 7468   self.cache_path
+00008bd0: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
+00008be0: 205c 0a20 2020 2020 2020 2020 2020 206f   \.            o
+00008bf0: 732e 7061 7468 2e65 7869 7374 7328 7365  s.path.exists(se
+00008c00: 6c66 2e63 6163 6865 5f70 6174 6829 3a0a  lf.cache_path):.
+00008c10: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00008c20: 656c 662e 6d6f 6465 2069 6e20 2827 7727  elf.mode in ('w'
+00008c30: 2c20 2761 2729 3a0a 2020 2020 2020 2020  , 'a'):.        
+00008c40: 2020 2020 2020 2020 7333 5f75 706c 6f61          s3_uploa
+00008c50: 6428 7365 6c66 2e63 6163 6865 5f70 6174  d(self.cache_pat
+00008c60: 682c 2073 656c 662e 6e61 6d65 290a 2020  h, self.name).  
+00008c70: 2020 2020 2020 2020 2020 6f73 2e75 6e6c            os.unl
+00008c80: 696e 6b28 7365 6c66 2e63 6163 6865 5f70  ink(self.cache_p
+00008c90: 6174 6829 0a0a 0a64 6566 2073 335f 676c  ath)...def s3_gl
+00008ca0: 6f62 280a 2020 2020 2020 2020 7061 7468  ob(.        path
+00008cb0: 3a20 5061 7468 4c69 6b65 2c0a 2020 2020  : PathLike,.    
+00008cc0: 2020 2020 7265 6375 7273 6976 653a 2062      recursive: b
+00008cd0: 6f6f 6c20 3d20 5472 7565 2c0a 2020 2020  ool = True,.    
+00008ce0: 2020 2020 6d69 7373 696e 675f 6f6b 3a20      missing_ok: 
+00008cf0: 626f 6f6c 203d 2054 7275 652c 0a20 2020  bool = True,.   
+00008d00: 2020 2020 2066 6f6c 6c6f 776c 696e 6b73       followlinks
+00008d10: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
+00008d20: 2920 2d3e 204c 6973 745b 7374 725d 3a0a  ) -> List[str]:.
+00008d30: 2020 2020 2727 2752 6574 7572 6e20 7333      '''Return s3
+00008d40: 2070 6174 6820 6c69 7374 2069 6e20 6173   path list in as
+00008d50: 6365 6e64 696e 6720 616c 7068 6162 6574  cending alphabet
+00008d60: 6963 616c 206f 7264 6572 2c20 696e 2077  ical order, in w
+00008d70: 6869 6368 2070 6174 6820 6d61 7463 6865  hich path matche
+00008d80: 7320 676c 6f62 2070 6174 7465 726e 0a20  s glob pattern. 
+00008d90: 2020 204e 6f74 6573 3a20 4f6e 6c79 2067     Notes: Only g
+00008da0: 6c6f 6220 696e 2062 7563 6b65 742e 2049  lob in bucket. I
+00008db0: 6620 7472 7969 6e67 2074 6f20 6d61 7463  f trying to matc
+00008dc0: 6820 6275 636b 6574 2077 6974 6820 7769  h bucket with wi
+00008dd0: 6c64 6361 7264 2063 6861 7261 6374 6572  ldcard character
+00008de0: 732c 2072 6169 7365 2055 6e73 7570 706f  s, raise Unsuppo
+00008df0: 7274 6564 4572 726f 720a 0a20 2020 203a  rtedError..    :
+00008e00: 7061 7261 6d20 7265 6375 7273 6976 653a  param recursive:
+00008e10: 2049 6620 4661 6c73 652c 2060 2a2a 6020   If False, `**` 
+00008e20: 7769 6c6c 206e 6f74 2073 6561 7263 6820  will not search 
+00008e30: 6469 7265 6374 6f72 7920 7265 6375 7273  directory recurs
+00008e40: 6976 656c 790a 2020 2020 3a70 6172 616d  ively.    :param
+00008e50: 206d 6973 7369 6e67 5f6f 6b3a 2049 6620   missing_ok: If 
+00008e60: 4661 6c73 6520 616e 6420 7461 7267 6574  False and target
+00008e70: 2070 6174 6820 646f 6573 6e27 7420 6d61   path doesn't ma
+00008e80: 7463 6820 616e 7920 6669 6c65 2c20 7261  tch any file, ra
+00008e90: 6973 6520 4669 6c65 4e6f 7446 6f75 6e64  ise FileNotFound
+00008ea0: 4572 726f 720a 2020 2020 3a72 6169 7365  Error.    :raise
+00008eb0: 733a 2055 6e73 7570 706f 7274 6564 4572  s: UnsupportedEr
+00008ec0: 726f 722c 2077 6865 6e20 6275 636b 6574  ror, when bucket
+00008ed0: 2070 6172 7420 636f 6e74 6169 6e73 2077   part contains w
+00008ee0: 696c 6463 6172 6420 6368 6172 6163 7465  ildcard characte
+00008ef0: 7273 0a20 2020 203a 7265 7475 726e 733a  rs.    :returns:
+00008f00: 2041 206c 6973 7420 636f 6e74 6169 6e73   A list contains
+00008f10: 2070 6174 6873 206d 6174 6368 2060 7333   paths match `s3
+00008f20: 5f70 6174 686e 616d 6560 0a20 2020 2027  _pathname`.    '
+00008f30: 2727 0a20 2020 2072 6574 7572 6e20 6c69  ''.    return li
+00008f40: 7374 280a 2020 2020 2020 2020 7333 5f69  st(.        s3_i
+00008f50: 676c 6f62 280a 2020 2020 2020 2020 2020  glob(.          
+00008f60: 2020 7061 7468 3d70 6174 682c 0a20 2020    path=path,.   
+00008f70: 2020 2020 2020 2020 2072 6563 7572 7369           recursi
+00008f80: 7665 3d72 6563 7572 7369 7665 2c0a 2020  ve=recursive,.  
+00008f90: 2020 2020 2020 2020 2020 6d69 7373 696e            missin
+00008fa0: 675f 6f6b 3d6d 6973 7369 6e67 5f6f 6b2c  g_ok=missing_ok,
+00008fb0: 0a20 2020 2020 2020 2020 2020 2066 6f6c  .            fol
+00008fc0: 6c6f 776c 696e 6b73 3d66 6f6c 6c6f 776c  lowlinks=followl
+00008fd0: 696e 6b73 2929 0a0a 0a64 6566 2073 335f  inks))...def s3_
+00008fe0: 676c 6f62 5f73 7461 7428 0a20 2020 2020  glob_stat(.     
+00008ff0: 2020 2070 6174 683a 2050 6174 684c 696b     path: PathLik
+00009000: 652c 0a20 2020 2020 2020 2072 6563 7572  e,.        recur
+00009010: 7369 7665 3a20 626f 6f6c 203d 2054 7275  sive: bool = Tru
+00009020: 652c 0a20 2020 2020 2020 206d 6973 7369  e,.        missi
+00009030: 6e67 5f6f 6b3a 2062 6f6f 6c20 3d20 5472  ng_ok: bool = Tr
+00009040: 7565 2c0a 2020 2020 2020 2020 666f 6c6c  ue,.        foll
+00009050: 6f77 6c69 6e6b 733a 2062 6f6f 6c20 3d20  owlinks: bool = 
+00009060: 4661 6c73 6529 202d 3e20 4974 6572 6174  False) -> Iterat
+00009070: 6f72 5b46 696c 6545 6e74 7279 5d3a 0a20  or[FileEntry]:. 
+00009080: 2020 2027 2727 5265 7475 726e 2061 2067     '''Return a g
+00009090: 656e 6572 6174 6f72 2063 6f6e 7461 696e  enerator contain
+000090a0: 7320 7475 706c 6573 206f 6620 7061 7468  s tuples of path
+000090b0: 2061 6e64 2066 696c 6520 7374 6174 2c20   and file stat, 
+000090c0: 696e 2061 7363 656e 6469 6e67 2061 6c70  in ascending alp
+000090d0: 6861 6265 7469 6361 6c20 6f72 6465 722c  habetical order,
+000090e0: 2069 6e20 7768 6963 6820 7061 7468 206d   in which path m
+000090f0: 6174 6368 6573 2067 6c6f 6220 7061 7474  atches glob patt
+00009100: 6572 6e0a 2020 2020 4e6f 7465 733a 204f  ern.    Notes: O
+00009110: 6e6c 7920 676c 6f62 2069 6e20 6275 636b  nly glob in buck
+00009120: 6574 2e20 4966 2074 7279 696e 6720 746f  et. If trying to
+00009130: 206d 6174 6368 2062 7563 6b65 7420 7769   match bucket wi
+00009140: 7468 2077 696c 6463 6172 6420 6368 6172  th wildcard char
+00009150: 6163 7465 7273 2c20 7261 6973 6520 556e  acters, raise Un
+00009160: 7375 7070 6f72 7465 6445 7272 6f72 0a0a  supportedError..
+00009170: 2020 2020 3a70 6172 616d 2072 6563 7572      :param recur
+00009180: 7369 7665 3a20 4966 2046 616c 7365 2c20  sive: If False, 
+00009190: 602a 2a60 2077 696c 6c20 6e6f 7420 7365  `**` will not se
+000091a0: 6172 6368 2064 6972 6563 746f 7279 2072  arch directory r
+000091b0: 6563 7572 7369 7665 6c79 0a20 2020 203a  ecursively.    :
+000091c0: 7061 7261 6d20 6d69 7373 696e 675f 6f6b  param missing_ok
+000091d0: 3a20 4966 2046 616c 7365 2061 6e64 2074  : If False and t
+000091e0: 6172 6765 7420 7061 7468 2064 6f65 736e  arget path doesn
+000091f0: 2774 206d 6174 6368 2061 6e79 2066 696c  't match any fil
+00009200: 652c 2072 6169 7365 2046 696c 654e 6f74  e, raise FileNot
+00009210: 466f 756e 6445 7272 6f72 0a20 2020 203a  FoundError.    :
+00009220: 7261 6973 6573 3a20 556e 7375 7070 6f72  raises: Unsuppor
+00009230: 7465 6445 7272 6f72 2c20 7768 656e 2062  tedError, when b
+00009240: 7563 6b65 7420 7061 7274 2063 6f6e 7461  ucket part conta
+00009250: 696e 7320 7769 6c64 6361 7264 2063 6861  ins wildcard cha
+00009260: 7261 6374 6572 730a 2020 2020 3a72 6574  racters.    :ret
+00009270: 7572 6e73 3a20 4120 6765 6e65 7261 746f  urns: A generato
+00009280: 7220 636f 6e74 6169 6e73 2074 7570 6c65  r contains tuple
+00009290: 7320 6f66 2070 6174 6820 616e 6420 6669  s of path and fi
+000092a0: 6c65 2073 7461 742c 2069 6e20 7768 6963  le stat, in whic
+000092b0: 6820 7061 7468 7320 6d61 7463 6820 6073  h paths match `s
+000092c0: 335f 7061 7468 6e61 6d65 600a 2020 2020  3_pathname`.    
+000092d0: 2727 270a 2020 2020 7265 7475 726e 2053  '''.    return S
+000092e0: 3350 6174 6828 7061 7468 292e 676c 6f62  3Path(path).glob
+000092f0: 5f73 7461 7428 0a20 2020 2020 2020 2070  _stat(.        p
+00009300: 6174 7465 726e 3d22 222c 0a20 2020 2020  attern="",.     
+00009310: 2020 2072 6563 7572 7369 7665 3d72 6563     recursive=rec
+00009320: 7572 7369 7665 2c0a 2020 2020 2020 2020  ursive,.        
+00009330: 6d69 7373 696e 675f 6f6b 3d6d 6973 7369  missing_ok=missi
+00009340: 6e67 5f6f 6b2c 0a20 2020 2020 2020 2066  ng_ok,.        f
+00009350: 6f6c 6c6f 776c 696e 6b73 3d66 6f6c 6c6f  ollowlinks=follo
+00009360: 776c 696e 6b73 290a 0a0a 6465 6620 7333  wlinks)...def s3
+00009370: 5f69 676c 6f62 280a 2020 2020 2020 2020  _iglob(.        
+00009380: 7061 7468 3a20 5061 7468 4c69 6b65 2c0a  path: PathLike,.
+00009390: 2020 2020 2020 2020 7265 6375 7273 6976          recursiv
+000093a0: 653a 2062 6f6f 6c20 3d20 5472 7565 2c0a  e: bool = True,.
+000093b0: 2020 2020 2020 2020 6d69 7373 696e 675f          missing_
+000093c0: 6f6b 3a20 626f 6f6c 203d 2054 7275 652c  ok: bool = True,
+000093d0: 0a20 2020 2020 2020 2066 6f6c 6c6f 776c  .        followl
+000093e0: 696e 6b73 3a20 626f 6f6c 203d 2046 616c  inks: bool = Fal
+000093f0: 7365 2c0a 2920 2d3e 2049 7465 7261 746f  se,.) -> Iterato
+00009400: 725b 7374 725d 3a0a 2020 2020 2727 2752  r[str]:.    '''R
+00009410: 6574 7572 6e20 7333 2070 6174 6820 6974  eturn s3 path it
+00009420: 6572 6174 6f72 2069 6e20 6173 6365 6e64  erator in ascend
+00009430: 696e 6720 616c 7068 6162 6574 6963 616c  ing alphabetical
+00009440: 206f 7264 6572 2c20 696e 2077 6869 6368   order, in which
+00009450: 2070 6174 6820 6d61 7463 6865 7320 676c   path matches gl
+00009460: 6f62 2070 6174 7465 726e 0a20 2020 204e  ob pattern.    N
+00009470: 6f74 6573 3a20 4f6e 6c79 2067 6c6f 6220  otes: Only glob 
+00009480: 696e 2062 7563 6b65 742e 2049 6620 7472  in bucket. If tr
+00009490: 7969 6e67 2074 6f20 6d61 7463 6820 6275  ying to match bu
+000094a0: 636b 6574 2077 6974 6820 7769 6c64 6361  cket with wildca
+000094b0: 7264 2063 6861 7261 6374 6572 732c 2072  rd characters, r
+000094c0: 6169 7365 2055 6e73 7570 706f 7274 6564  aise Unsupported
+000094d0: 4572 726f 720a 0a20 2020 203a 7061 7261  Error..    :para
+000094e0: 6d20 7265 6375 7273 6976 653a 2049 6620  m recursive: If 
+000094f0: 4661 6c73 652c 2060 2a2a 6020 7769 6c6c  False, `**` will
+00009500: 206e 6f74 2073 6561 7263 6820 6469 7265   not search dire
+00009510: 6374 6f72 7920 7265 6375 7273 6976 656c  ctory recursivel
+00009520: 790a 2020 2020 3a70 6172 616d 206d 6973  y.    :param mis
+00009530: 7369 6e67 5f6f 6b3a 2049 6620 4661 6c73  sing_ok: If Fals
+00009540: 6520 616e 6420 7461 7267 6574 2070 6174  e and target pat
+00009550: 6820 646f 6573 6e27 7420 6d61 7463 6820  h doesn't match 
+00009560: 616e 7920 6669 6c65 2c20 7261 6973 6520  any file, raise 
+00009570: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
+00009580: 720a 2020 2020 3a72 6169 7365 733a 2055  r.    :raises: U
+00009590: 6e73 7570 706f 7274 6564 4572 726f 722c  nsupportedError,
+000095a0: 2077 6865 6e20 6275 636b 6574 2070 6172   when bucket par
+000095b0: 7420 636f 6e74 6169 6e73 2077 696c 6463  t contains wildc
+000095c0: 6172 6420 6368 6172 6163 7465 7273 0a20  ard characters. 
+000095d0: 2020 203a 7265 7475 726e 733a 2041 6e20     :returns: An 
+000095e0: 6974 6572 6174 6f72 2063 6f6e 7461 696e  iterator contain
+000095f0: 7320 7061 7468 7320 6d61 7463 6820 6073  s paths match `s
+00009600: 335f 7061 7468 6e61 6d65 600a 2020 2020  3_pathname`.    
+00009610: 2727 270a 2020 2020 666f 7220 7061 7468  '''.    for path
+00009620: 5f6f 626a 2069 6e20 5333 5061 7468 2870  _obj in S3Path(p
+00009630: 6174 6829 2e69 676c 6f62 2870 6174 7465  ath).iglob(patte
+00009640: 726e 3d22 222c 2072 6563 7572 7369 7665  rn="", recursive
+00009650: 3d72 6563 7572 7369 7665 2c0a 2020 2020  =recursive,.    
+00009660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009680: 2020 206d 6973 7369 6e67 5f6f 6b3d 6d69     missing_ok=mi
+00009690: 7373 696e 675f 6f6b 2c0a 2020 2020 2020  ssing_ok,.      
+000096a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000096b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000096c0: 2066 6f6c 6c6f 776c 696e 6b73 3d66 6f6c   followlinks=fol
+000096d0: 6c6f 776c 696e 6b73 293a 0a20 2020 2020  lowlinks):.     
+000096e0: 2020 2079 6965 6c64 2070 6174 685f 6f62     yield path_ob
+000096f0: 6a2e 7061 7468 5f77 6974 685f 7072 6f74  j.path_with_prot
+00009700: 6f63 6f6c 0a0a 0a64 6566 2073 335f 6d61  ocol...def s3_ma
+00009710: 6b65 6469 7273 2870 6174 683a 2050 6174  kedirs(path: Pat
+00009720: 684c 696b 652c 2065 7869 7374 5f6f 6b3a  hLike, exist_ok:
+00009730: 2062 6f6f 6c20 3d20 4661 6c73 6529 3a0a   bool = False):.
+00009740: 2020 2020 2727 270a 2020 2020 4372 6561      '''.    Crea
+00009750: 7465 2061 6e20 7333 2064 6972 6563 746f  te an s3 directo
+00009760: 7279 2e0a 2020 2020 5075 7265 6c79 2063  ry..    Purely c
+00009770: 7265 6174 696e 6720 6469 7265 6374 6f72  reating director
+00009780: 7920 6973 2069 6e76 616c 6964 2062 6563  y is invalid bec
+00009790: 6175 7365 2069 7427 7320 756e 6176 6169  ause it's unavai
+000097a0: 6c61 626c 6520 6f6e 204f 5353 2e0a 2020  lable on OSS..  
+000097b0: 2020 5468 6973 2066 756e 6374 696f 6e20    This function 
+000097c0: 6973 2074 6f20 7465 7374 2074 6865 2074  is to test the t
+000097d0: 6172 6765 7420 6275 636b 6574 2068 6176  arget bucket hav
+000097e0: 6520 5752 4954 4520 6163 6365 7373 2e0a  e WRITE access..
+000097f0: 0a20 2020 203a 7061 7261 6d20 7061 7468  .    :param path
+00009800: 3a20 4769 7665 6e20 7061 7468 0a20 2020  : Given path.   
+00009810: 203a 7061 7261 6d20 6578 6973 745f 6f6b   :param exist_ok
+00009820: 3a20 4966 2046 616c 7365 2061 6e64 2074  : If False and t
+00009830: 6172 6765 7420 6469 7265 6374 6f72 7920  arget directory 
+00009840: 6578 6973 7473 2c20 7261 6973 6520 5333  exists, raise S3
+00009850: 4669 6c65 4578 6973 7473 4572 726f 720a  FileExistsError.
+00009860: 2020 2020 3a72 6169 7365 733a 2053 3342      :raises: S3B
+00009870: 7563 6b65 744e 6f74 466f 756e 6445 7272  ucketNotFoundErr
+00009880: 6f72 2c20 5333 4669 6c65 4578 6973 7473  or, S3FileExists
+00009890: 4572 726f 720a 2020 2020 2727 270a 2020  Error.    '''.  
+000098a0: 2020 7265 7475 726e 2053 3350 6174 6828    return S3Path(
+000098b0: 7061 7468 292e 6d6b 6469 7228 7061 7265  path).mkdir(pare
+000098c0: 6e74 733d 5472 7565 2c20 6578 6973 745f  nts=True, exist_
+000098d0: 6f6b 3d65 7869 7374 5f6f 6b29 0a0a 0a64  ok=exist_ok)...d
+000098e0: 6566 205f 6772 6f75 705f 7372 635f 7061  ef _group_src_pa
+000098f0: 7468 735f 6279 5f62 6c6f 636b 280a 2020  ths_by_block(.  
+00009900: 2020 2020 2020 7372 635f 7061 7468 733a        src_paths:
+00009910: 204c 6973 745b 5061 7468 4c69 6b65 5d2c   List[PathLike],
+00009920: 2062 6c6f 636b 5f73 697a 653a 2069 6e74   block_size: int
+00009930: 203d 2044 4546 4155 4c54 5f42 4c4f 434b   = DEFAULT_BLOCK
+00009940: 5f53 495a 450a 2920 2d3e 204c 6973 745b  _SIZE.) -> List[
+00009950: 4c69 7374 5b54 7570 6c65 5b50 6174 684c  List[Tuple[PathL
+00009960: 696b 652c 204f 7074 696f 6e61 6c5b 7374  ike, Optional[st
+00009970: 725d 5d5d 5d3a 0a20 2020 2067 726f 7570  r]]]]:.    group
+00009980: 7320 3d20 5b5d 0a20 2020 2063 7572 7265  s = [].    curre
+00009990: 6e74 5f67 726f 7570 2c20 6375 7272 656e  nt_group, curren
+000099a0: 745f 6772 6f75 705f 7369 7a65 203d 205b  t_group_size = [
+000099b0: 5d2c 2030 0a20 2020 2066 6f72 2073 7263  ], 0.    for src
+000099c0: 5f70 6174 6820 696e 2073 7263 5f70 6174  _path in src_pat
+000099d0: 6873 3a0a 2020 2020 2020 2020 6375 7272  hs:.        curr
+000099e0: 656e 745f 6669 6c65 5f73 697a 6520 3d20  ent_file_size = 
+000099f0: 5333 5061 7468 2873 7263 5f70 6174 6829  S3Path(src_path)
+00009a00: 2e73 7461 7428 292e 7369 7a65 0a20 2020  .stat().size.   
+00009a10: 2020 2020 2069 6620 6375 7272 656e 745f       if current_
+00009a20: 6669 6c65 5f73 697a 6520 3d3d 2030 3a0a  file_size == 0:.
+00009a30: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00009a40: 696e 7565 0a0a 2020 2020 2020 2020 6966  inue..        if
+00009a50: 2063 7572 7265 6e74 5f66 696c 655f 7369   current_file_si
+00009a60: 7a65 203e 3d20 626c 6f63 6b5f 7369 7a65  ze >= block_size
+00009a70: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00009a80: 206c 656e 2867 726f 7570 7329 203d 3d20   len(groups) == 
+00009a90: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+00009aa0: 2020 2069 6620 6375 7272 656e 745f 6772     if current_gr
+00009ab0: 6f75 705f 7369 7a65 202b 2063 7572 7265  oup_size + curre
+00009ac0: 6e74 5f66 696c 655f 7369 7a65 203e 2032  nt_file_size > 2
+00009ad0: 202a 2062 6c6f 636b 5f73 697a 653a 0a20   * block_size:. 
+00009ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009af0: 2020 2067 726f 7570 5f6c 6163 6b5f 7369     group_lack_si
+00009b00: 7a65 203d 2062 6c6f 636b 5f73 697a 6520  ze = block_size 
+00009b10: 2d20 6375 7272 656e 745f 6772 6f75 705f  - current_group_
+00009b20: 7369 7a65 0a20 2020 2020 2020 2020 2020  size.           
+00009b30: 2020 2020 2020 2020 2063 7572 7265 6e74           current
+00009b40: 5f67 726f 7570 2e61 7070 656e 6428 0a20  _group.append(. 
 00009b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009b60: 6772 6f75 705f 6c61 636b 5f73 697a 6520  group_lack_size 
-00009b70: 3d20 626c 6f63 6b5f 7369 7a65 202d 2063  = block_size - c
-00009b80: 7572 7265 6e74 5f67 726f 7570 5f73 697a  urrent_group_siz
-00009b90: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00009ba0: 2020 2020 2020 6375 7272 656e 745f 6772        current_gr
-00009bb0: 6f75 702e 6170 7065 6e64 280a 2020 2020  oup.append(.    
-00009bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009bd0: 2020 2020 2873 7263 5f70 6174 682c 2066      (src_path, f
-00009be0: 2762 7974 6573 3d30 2d7b 6772 6f75 705f  'bytes=0-{group_
-00009bf0: 6c61 636b 5f73 697a 652d 317d 2729 290a  lack_size-1}')).
+00009b60: 2020 2020 2020 2028 7372 635f 7061 7468         (src_path
+00009b70: 2c20 6627 6279 7465 733d 302d 7b67 726f  , f'bytes=0-{gro
+00009b80: 7570 5f6c 6163 6b5f 7369 7a65 2d31 7d27  up_lack_size-1}'
+00009b90: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00009ba0: 2020 2020 2020 2067 726f 7570 732e 6578         groups.ex
+00009bb0: 7465 6e64 280a 2020 2020 2020 2020 2020  tend(.          
+00009bc0: 2020 2020 2020 2020 2020 2020 2020 5b0a                [.
+00009bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009be0: 2020 2020 2020 2020 2020 2020 6375 7272              curr
+00009bf0: 656e 745f 6772 6f75 702c 0a20 2020 2020  ent_group,.     
 00009c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c10: 2020 2020 6772 6f75 7073 2e65 7874 656e      groups.exten
-00009c20: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
-00009c30: 2020 2020 2020 2020 2020 205b 0a20 2020             [.   
+00009c10: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00009c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009c30: 2020 2020 2020 2020 2028 0a20 2020 2020           (.     
 00009c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c50: 2020 2020 2020 2020 2063 7572 7265 6e74           current
-00009c60: 5f67 726f 7570 2c0a 2020 2020 2020 2020  _group,.        
+00009c50: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00009c60: 7263 5f70 6174 682c 0a20 2020 2020 2020  rc_path,.       
 00009c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c80: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00009c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009ca0: 2020 2020 2020 280a 2020 2020 2020 2020        (.        
-00009cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009cc0: 2020 2020 2020 2020 2020 2020 7372 635f              src_
-00009cd0: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
+00009c80: 2020 2020 2020 2020 2020 2020 2066 2762               f'b
+00009c90: 7974 6573 3d7b 6772 6f75 705f 6c61 636b  ytes={group_lack
+00009ca0: 5f73 697a 657d 2d7b 6375 7272 656e 745f  _size}-{current_
+00009cb0: 6669 6c65 5f73 697a 652d 317d 270a 2020  file_size-1}'.  
+00009cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009cd0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
 00009ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009cf0: 2020 2020 2020 2020 2020 6627 6279 7465            f'byte
-00009d00: 733d 7b67 726f 7570 5f6c 6163 6b5f 7369  s={group_lack_si
-00009d10: 7a65 7d2d 7b63 7572 7265 6e74 5f66 696c  ze}-{current_fil
-00009d20: 655f 7369 7a65 2d31 7d27 0a20 2020 2020  e_size-1}'.     
+00009cf0: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
+00009d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d10: 2020 2020 2020 5d29 0a20 2020 2020 2020        ]).       
+00009d20: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
 00009d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009d40: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00009d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009d60: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
-00009d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009d80: 2020 205d 290a 2020 2020 2020 2020 2020     ]).          
-00009d90: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00009da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009db0: 6375 7272 656e 745f 6772 6f75 702e 6170  current_group.ap
-00009dc0: 7065 6e64 2828 7372 635f 7061 7468 2c20  pend((src_path, 
-00009dd0: 4e6f 6e65 2929 0a20 2020 2020 2020 2020  None)).         
-00009de0: 2020 2020 2020 2020 2020 2067 726f 7570             group
-00009df0: 732e 6170 7065 6e64 2863 7572 7265 6e74  s.append(current
-00009e00: 5f67 726f 7570 290a 2020 2020 2020 2020  _group).        
-00009e10: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00009e20: 2020 2020 2020 2020 2020 6772 6f75 7073            groups
-00009e30: 5b2d 315d 2e65 7874 656e 6428 6375 7272  [-1].extend(curr
-00009e40: 656e 745f 6772 6f75 7029 0a20 2020 2020  ent_group).     
-00009e50: 2020 2020 2020 2020 2020 2067 726f 7570             group
-00009e60: 732e 6170 7065 6e64 285b 2873 7263 5f70  s.append([(src_p
-00009e70: 6174 682c 204e 6f6e 6529 5d29 0a20 2020  ath, None)]).   
-00009e80: 2020 2020 2020 2020 2063 7572 7265 6e74           current
-00009e90: 5f67 726f 7570 2c20 6375 7272 656e 745f  _group, current_
-00009ea0: 6772 6f75 705f 7369 7a65 203d 205b 5d2c  group_size = [],
-00009eb0: 2030 0a20 2020 2020 2020 2065 6c73 653a   0.        else:
-00009ec0: 0a20 2020 2020 2020 2020 2020 2063 7572  .            cur
-00009ed0: 7265 6e74 5f67 726f 7570 2e61 7070 656e  rent_group.appen
-00009ee0: 6428 2873 7263 5f70 6174 682c 204e 6f6e  d((src_path, Non
-00009ef0: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
-00009f00: 6375 7272 656e 745f 6772 6f75 705f 7369  current_group_si
-00009f10: 7a65 202b 3d20 6375 7272 656e 745f 6669  ze += current_fi
-00009f20: 6c65 5f73 697a 650a 2020 2020 2020 2020  le_size.        
-00009f30: 2020 2020 6966 2063 7572 7265 6e74 5f67      if current_g
-00009f40: 726f 7570 5f73 697a 6520 3e3d 2062 6c6f  roup_size >= blo
-00009f50: 636b 5f73 697a 653a 0a20 2020 2020 2020  ck_size:.       
-00009f60: 2020 2020 2020 2020 2067 726f 7570 732e           groups.
-00009f70: 6170 7065 6e64 2863 7572 7265 6e74 5f67  append(current_g
-00009f80: 726f 7570 290a 2020 2020 2020 2020 2020  roup).          
-00009f90: 2020 2020 2020 6375 7272 656e 745f 6772        current_gr
-00009fa0: 6f75 702c 2063 7572 7265 6e74 5f67 726f  oup, current_gro
-00009fb0: 7570 5f73 697a 6520 3d20 5b5d 2c20 300a  up_size = [], 0.
-00009fc0: 2020 2020 6966 2063 7572 7265 6e74 5f67      if current_g
-00009fd0: 726f 7570 3a0a 2020 2020 2020 2020 6772  roup:.        gr
-00009fe0: 6f75 7073 2e61 7070 656e 6428 6375 7272  oups.append(curr
-00009ff0: 656e 745f 6772 6f75 7029 0a20 2020 2072  ent_group).    r
-0000a000: 6574 7572 6e20 6772 6f75 7073 0a0a 0a64  eturn groups...d
-0000a010: 6566 2073 335f 636f 6e63 6174 280a 2020  ef s3_concat(.  
-0000a020: 2020 2020 2020 7372 635f 7061 7468 733a        src_paths:
-0000a030: 204c 6973 745b 5061 7468 4c69 6b65 5d2c   List[PathLike],
-0000a040: 0a20 2020 2020 2020 2064 7374 5f70 6174  .        dst_pat
-0000a050: 683a 2050 6174 684c 696b 652c 0a20 2020  h: PathLike,.   
-0000a060: 2020 2020 2062 6c6f 636b 5f73 697a 653a       block_size:
-0000a070: 2069 6e74 203d 2044 4546 4155 4c54 5f42   int = DEFAULT_B
-0000a080: 4c4f 434b 5f53 495a 452c 0a20 2020 2020  LOCK_SIZE,.     
-0000a090: 2020 206d 6178 5f77 6f72 6b65 7273 3a20     max_workers: 
-0000a0a0: 696e 7420 3d20 474c 4f42 414c 5f4d 4158  int = GLOBAL_MAX
-0000a0b0: 5f57 4f52 4b45 5253 2920 2d3e 204e 6f6e  _WORKERS) -> Non
-0000a0c0: 653a 0a20 2020 2027 2727 436f 6e63 6174  e:.    '''Concat
-0000a0d0: 656e 6174 6520 7333 2066 696c 6573 2074  enate s3 files t
-0000a0e0: 6f20 6f6e 6520 6669 6c65 2e0a 0a20 2020  o one file...   
-0000a0f0: 203a 7061 7261 6d20 7372 635f 7061 7468   :param src_path
-0000a100: 733a 2047 6976 656e 2073 6f75 7263 6520  s: Given source 
-0000a110: 7061 7468 730a 2020 2020 3a70 6172 616d  paths.    :param
-0000a120: 2064 7374 5f70 6174 683a 2047 6976 656e   dst_path: Given
-0000a130: 2064 6573 7469 6e61 7469 6f6e 2070 6174   destination pat
-0000a140: 680a 2020 2020 2727 270a 2020 2020 636c  h.    '''.    cl
-0000a150: 6965 6e74 203d 2053 3350 6174 6828 6473  ient = S3Path(ds
-0000a160: 745f 7061 7468 292e 5f63 6c69 656e 740a  t_path)._client.
-0000a170: 2020 2020 7769 7468 2072 6169 7365 5f73      with raise_s
-0000a180: 335f 6572 726f 7228 6473 745f 7061 7468  3_error(dst_path
-0000a190: 293a 0a20 2020 2020 2020 2069 6620 626c  ):.        if bl
-0000a1a0: 6f63 6b5f 7369 7a65 203d 3d20 303a 2020  ock_size == 0:  
-0000a1b0: 2320 7072 6167 6d61 3a20 6e6f 2063 6f76  # pragma: no cov
-0000a1c0: 6572 0a20 2020 2020 2020 2020 2020 2067  er.            g
-0000a1d0: 726f 7570 7320 3d20 5b5b 2873 7263 5f70  roups = [[(src_p
-0000a1e0: 6174 682c 204e 6f6e 6529 5d20 666f 7220  ath, None)] for 
-0000a1f0: 7372 635f 7061 7468 2069 6e20 7372 635f  src_path in src_
-0000a200: 7061 7468 735d 0a20 2020 2020 2020 2065  paths].        e
-0000a210: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000a220: 2067 726f 7570 7320 3d20 5f67 726f 7570   groups = _group
-0000a230: 5f73 7263 5f70 6174 6873 5f62 795f 626c  _src_paths_by_bl
-0000a240: 6f63 6b28 7372 635f 7061 7468 732c 2062  ock(src_paths, b
-0000a250: 6c6f 636b 5f73 697a 653d 626c 6f63 6b5f  lock_size=block_
-0000a260: 7369 7a65 290a 0a20 2020 2020 2020 2077  size)..        w
-0000a270: 6974 6820 4d75 6c74 6950 6172 7457 7269  ith MultiPartWri
-0000a280: 7465 7228 636c 6965 6e74 2c20 6473 745f  ter(client, dst_
-0000a290: 7061 7468 2920 6173 2077 7269 7465 722c  path) as writer,
-0000a2a0: 2054 6872 6561 6450 6f6f 6c45 7865 6375   ThreadPoolExecu
-0000a2b0: 746f 7228 0a20 2020 2020 2020 2020 2020  tor(.           
-0000a2c0: 2020 2020 206d 6178 5f77 6f72 6b65 7273       max_workers
-0000a2d0: 3d6d 6178 5f77 6f72 6b65 7273 2920 6173  =max_workers) as
-0000a2e0: 2065 7865 6375 746f 723a 0a20 2020 2020   executor:.     
-0000a2f0: 2020 2020 2020 2066 6f72 2069 6e64 6578         for index
-0000a300: 2c20 6772 6f75 7020 696e 2065 6e75 6d65  , group in enume
-0000a310: 7261 7465 2867 726f 7570 732c 2073 7461  rate(groups, sta
-0000a320: 7274 3d31 293a 0a20 2020 2020 2020 2020  rt=1):.         
-0000a330: 2020 2020 2020 2069 6620 6c65 6e28 6772         if len(gr
-0000a340: 6f75 7029 203d 3d20 313a 0a20 2020 2020  oup) == 1:.     
-0000a350: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000a360: 7865 6375 746f 722e 7375 626d 6974 280a  xecutor.submit(.
+00009d40: 2020 2063 7572 7265 6e74 5f67 726f 7570     current_group
+00009d50: 2e61 7070 656e 6428 2873 7263 5f70 6174  .append((src_pat
+00009d60: 682c 204e 6f6e 6529 290a 2020 2020 2020  h, None)).      
+00009d70: 2020 2020 2020 2020 2020 2020 2020 6772                gr
+00009d80: 6f75 7073 2e61 7070 656e 6428 6375 7272  oups.append(curr
+00009d90: 656e 745f 6772 6f75 7029 0a20 2020 2020  ent_group).     
+00009da0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00009db0: 2020 2020 2020 2020 2020 2020 2067 726f               gro
+00009dc0: 7570 735b 2d31 5d2e 6578 7465 6e64 2863  ups[-1].extend(c
+00009dd0: 7572 7265 6e74 5f67 726f 7570 290a 2020  urrent_group).  
+00009de0: 2020 2020 2020 2020 2020 2020 2020 6772                gr
+00009df0: 6f75 7073 2e61 7070 656e 6428 5b28 7372  oups.append([(sr
+00009e00: 635f 7061 7468 2c20 4e6f 6e65 295d 290a  c_path, None)]).
+00009e10: 2020 2020 2020 2020 2020 2020 6375 7272              curr
+00009e20: 656e 745f 6772 6f75 702c 2063 7572 7265  ent_group, curre
+00009e30: 6e74 5f67 726f 7570 5f73 697a 6520 3d20  nt_group_size = 
+00009e40: 5b5d 2c20 300a 2020 2020 2020 2020 656c  [], 0.        el
+00009e50: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00009e60: 6375 7272 656e 745f 6772 6f75 702e 6170  current_group.ap
+00009e70: 7065 6e64 2828 7372 635f 7061 7468 2c20  pend((src_path, 
+00009e80: 4e6f 6e65 2929 0a20 2020 2020 2020 2020  None)).         
+00009e90: 2020 2063 7572 7265 6e74 5f67 726f 7570     current_group
+00009ea0: 5f73 697a 6520 2b3d 2063 7572 7265 6e74  _size += current
+00009eb0: 5f66 696c 655f 7369 7a65 0a20 2020 2020  _file_size.     
+00009ec0: 2020 2020 2020 2069 6620 6375 7272 656e         if curren
+00009ed0: 745f 6772 6f75 705f 7369 7a65 203e 3d20  t_group_size >= 
+00009ee0: 626c 6f63 6b5f 7369 7a65 3a0a 2020 2020  block_size:.    
+00009ef0: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+00009f00: 7073 2e61 7070 656e 6428 6375 7272 656e  ps.append(curren
+00009f10: 745f 6772 6f75 7029 0a20 2020 2020 2020  t_group).       
+00009f20: 2020 2020 2020 2020 2063 7572 7265 6e74           current
+00009f30: 5f67 726f 7570 2c20 6375 7272 656e 745f  _group, current_
+00009f40: 6772 6f75 705f 7369 7a65 203d 205b 5d2c  group_size = [],
+00009f50: 2030 0a20 2020 2069 6620 6375 7272 656e   0.    if curren
+00009f60: 745f 6772 6f75 703a 0a20 2020 2020 2020  t_group:.       
+00009f70: 2067 726f 7570 732e 6170 7065 6e64 2863   groups.append(c
+00009f80: 7572 7265 6e74 5f67 726f 7570 290a 2020  urrent_group).  
+00009f90: 2020 7265 7475 726e 2067 726f 7570 730a    return groups.
+00009fa0: 0a0a 6465 6620 7333 5f63 6f6e 6361 7428  ..def s3_concat(
+00009fb0: 0a20 2020 2020 2020 2073 7263 5f70 6174  .        src_pat
+00009fc0: 6873 3a20 4c69 7374 5b50 6174 684c 696b  hs: List[PathLik
+00009fd0: 655d 2c0a 2020 2020 2020 2020 6473 745f  e],.        dst_
+00009fe0: 7061 7468 3a20 5061 7468 4c69 6b65 2c0a  path: PathLike,.
+00009ff0: 2020 2020 2020 2020 626c 6f63 6b5f 7369          block_si
+0000a000: 7a65 3a20 696e 7420 3d20 4445 4641 554c  ze: int = DEFAUL
+0000a010: 545f 424c 4f43 4b5f 5349 5a45 2c0a 2020  T_BLOCK_SIZE,.  
+0000a020: 2020 2020 2020 6d61 785f 776f 726b 6572        max_worker
+0000a030: 733a 2069 6e74 203d 2047 4c4f 4241 4c5f  s: int = GLOBAL_
+0000a040: 4d41 585f 574f 524b 4552 5329 202d 3e20  MAX_WORKERS) -> 
+0000a050: 4e6f 6e65 3a0a 2020 2020 2727 2743 6f6e  None:.    '''Con
+0000a060: 6361 7465 6e61 7465 2073 3320 6669 6c65  catenate s3 file
+0000a070: 7320 746f 206f 6e65 2066 696c 652e 0a0a  s to one file...
+0000a080: 2020 2020 3a70 6172 616d 2073 7263 5f70      :param src_p
+0000a090: 6174 6873 3a20 4769 7665 6e20 736f 7572  aths: Given sour
+0000a0a0: 6365 2070 6174 6873 0a20 2020 203a 7061  ce paths.    :pa
+0000a0b0: 7261 6d20 6473 745f 7061 7468 3a20 4769  ram dst_path: Gi
+0000a0c0: 7665 6e20 6465 7374 696e 6174 696f 6e20  ven destination 
+0000a0d0: 7061 7468 0a20 2020 2027 2727 0a20 2020  path.    '''.   
+0000a0e0: 2063 6c69 656e 7420 3d20 5333 5061 7468   client = S3Path
+0000a0f0: 2864 7374 5f70 6174 6829 2e5f 636c 6965  (dst_path)._clie
+0000a100: 6e74 0a20 2020 2077 6974 6820 7261 6973  nt.    with rais
+0000a110: 655f 7333 5f65 7272 6f72 2864 7374 5f70  e_s3_error(dst_p
+0000a120: 6174 6829 3a0a 2020 2020 2020 2020 6966  ath):.        if
+0000a130: 2062 6c6f 636b 5f73 697a 6520 3d3d 2030   block_size == 0
+0000a140: 3a0a 2020 2020 2020 2020 2020 2020 6772  :.            gr
+0000a150: 6f75 7073 203d 205b 5b28 7372 635f 7061  oups = [[(src_pa
+0000a160: 7468 2c20 4e6f 6e65 295d 2066 6f72 2073  th, None)] for s
+0000a170: 7263 5f70 6174 6820 696e 2073 7263 5f70  rc_path in src_p
+0000a180: 6174 6873 5d0a 2020 2020 2020 2020 656c  aths].        el
+0000a190: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000a1a0: 6772 6f75 7073 203d 205f 6772 6f75 705f  groups = _group_
+0000a1b0: 7372 635f 7061 7468 735f 6279 5f62 6c6f  src_paths_by_blo
+0000a1c0: 636b 2873 7263 5f70 6174 6873 2c20 626c  ck(src_paths, bl
+0000a1d0: 6f63 6b5f 7369 7a65 3d62 6c6f 636b 5f73  ock_size=block_s
+0000a1e0: 697a 6529 0a0a 2020 2020 2020 2020 7769  ize)..        wi
+0000a1f0: 7468 204d 756c 7469 5061 7274 5772 6974  th MultiPartWrit
+0000a200: 6572 2863 6c69 656e 742c 2064 7374 5f70  er(client, dst_p
+0000a210: 6174 6829 2061 7320 7772 6974 6572 2c20  ath) as writer, 
+0000a220: 5468 7265 6164 506f 6f6c 4578 6563 7574  ThreadPoolExecut
+0000a230: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+0000a240: 2020 2020 6d61 785f 776f 726b 6572 733d      max_workers=
+0000a250: 6d61 785f 776f 726b 6572 7329 2061 7320  max_workers) as 
+0000a260: 6578 6563 7574 6f72 3a0a 2020 2020 2020  executor:.      
+0000a270: 2020 2020 2020 666f 7220 696e 6465 782c        for index,
+0000a280: 2067 726f 7570 2069 6e20 656e 756d 6572   group in enumer
+0000a290: 6174 6528 6772 6f75 7073 2c20 7374 6172  ate(groups, star
+0000a2a0: 743d 3129 3a0a 2020 2020 2020 2020 2020  t=1):.          
+0000a2b0: 2020 2020 2020 6966 206c 656e 2867 726f        if len(gro
+0000a2c0: 7570 2920 3d3d 2031 3a0a 2020 2020 2020  up) == 1:.      
+0000a2d0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+0000a2e0: 6563 7574 6f72 2e73 7562 6d69 7428 0a20  ecutor.submit(. 
+0000a2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a300: 2020 2020 2020 2077 7269 7465 722e 7570         writer.up
+0000a310: 6c6f 6164 5f70 6172 745f 636f 7079 2c20  load_part_copy, 
+0000a320: 696e 6465 782c 2067 726f 7570 5b30 5d5b  index, group[0][
+0000a330: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+0000a340: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+0000a350: 705b 305d 5b31 5d29 0a20 2020 2020 2020  p[0][1]).       
+0000a360: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
 0000a370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a380: 2020 2020 2020 2020 7772 6974 6572 2e75          writer.u
-0000a390: 706c 6f61 645f 7061 7274 5f63 6f70 792c  pload_part_copy,
-0000a3a0: 2069 6e64 6578 2c20 6772 6f75 705b 305d   index, group[0]
-0000a3b0: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
-0000a3c0: 2020 2020 2020 2020 2020 2020 2067 726f               gro
-0000a3d0: 7570 5b30 5d5b 315d 290a 2020 2020 2020  up[0][1]).      
-0000a3e0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0000a3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a400: 2020 2020 6578 6563 7574 6f72 2e73 7562      executor.sub
-0000a410: 6d69 7428 7772 6974 6572 2e75 706c 6f61  mit(writer.uploa
-0000a420: 645f 7061 7274 5f62 795f 7061 7468 732c  d_part_by_paths,
-0000a430: 2069 6e64 6578 2c20 6772 6f75 7029 0a0a   index, group)..
-0000a440: 0a40 536d 6172 7450 6174 682e 7265 6769  .@SmartPath.regi
-0000a450: 7374 6572 0a63 6c61 7373 2053 3350 6174  ster.class S3Pat
-0000a460: 6828 5552 4950 6174 6829 3a0a 0a20 2020  h(URIPath):..   
-0000a470: 2070 726f 746f 636f 6c20 3d20 2273 3322   protocol = "s3"
-0000a480: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
-0000a490: 5f5f 2873 656c 662c 2070 6174 683a 2022  __(self, path: "
-0000a4a0: 5061 7468 4c69 6b65 222c 202a 6f74 6865  PathLike", *othe
-0000a4b0: 725f 7061 7468 733a 2022 5061 7468 4c69  r_paths: "PathLi
-0000a4c0: 6b65 2229 3a0a 2020 2020 2020 2020 7375  ke"):.        su
-0000a4d0: 7065 7228 292e 5f5f 696e 6974 5f5f 2870  per().__init__(p
-0000a4e0: 6174 682c 202a 6f74 6865 725f 7061 7468  ath, *other_path
-0000a4f0: 7329 0a20 2020 2020 2020 2070 726f 746f  s).        proto
-0000a500: 636f 6c20 3d20 6765 745f 7572 6c5f 7363  col = get_url_sc
-0000a510: 6865 6d65 2873 656c 662e 7061 7468 290a  heme(self.path).
+0000a380: 2020 2065 7865 6375 746f 722e 7375 626d     executor.subm
+0000a390: 6974 2877 7269 7465 722e 7570 6c6f 6164  it(writer.upload
+0000a3a0: 5f70 6172 745f 6279 5f70 6174 6873 2c20  _part_by_paths, 
+0000a3b0: 696e 6465 782c 2067 726f 7570 290a 0a0a  index, group)...
+0000a3c0: 4053 6d61 7274 5061 7468 2e72 6567 6973  @SmartPath.regis
+0000a3d0: 7465 720a 636c 6173 7320 5333 5061 7468  ter.class S3Path
+0000a3e0: 2855 5249 5061 7468 293a 0a0a 2020 2020  (URIPath):..    
+0000a3f0: 7072 6f74 6f63 6f6c 203d 2022 7333 220a  protocol = "s3".
+0000a400: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+0000a410: 5f28 7365 6c66 2c20 7061 7468 3a20 2250  _(self, path: "P
+0000a420: 6174 684c 696b 6522 2c20 2a6f 7468 6572  athLike", *other
+0000a430: 5f70 6174 6873 3a20 2250 6174 684c 696b  _paths: "PathLik
+0000a440: 6522 293a 0a20 2020 2020 2020 2073 7570  e"):.        sup
+0000a450: 6572 2829 2e5f 5f69 6e69 745f 5f28 7061  er().__init__(pa
+0000a460: 7468 2c20 2a6f 7468 6572 5f70 6174 6873  th, *other_paths
+0000a470: 290a 2020 2020 2020 2020 7072 6f74 6f63  ).        protoc
+0000a480: 6f6c 203d 2067 6574 5f75 726c 5f73 6368  ol = get_url_sch
+0000a490: 656d 6528 7365 6c66 2e70 6174 6829 0a20  eme(self.path). 
+0000a4a0: 2020 2020 2020 2073 656c 662e 5f70 726f         self._pro
+0000a4b0: 746f 636f 6c5f 7769 7468 5f70 726f 6669  tocol_with_profi
+0000a4c0: 6c65 203d 2073 656c 662e 7072 6f74 6f63  le = self.protoc
+0000a4d0: 6f6c 0a20 2020 2020 2020 2073 656c 662e  ol.        self.
+0000a4e0: 5f70 726f 6669 6c65 5f6e 616d 6520 3d20  _profile_name = 
+0000a4f0: 4e6f 6e65 0a20 2020 2020 2020 2069 6620  None.        if 
+0000a500: 7072 6f74 6f63 6f6c 2e73 7461 7274 7377  protocol.startsw
+0000a510: 6974 6828 2773 332b 2729 3a0a 2020 2020  ith('s3+'):.    
 0000a520: 2020 2020 2020 2020 7365 6c66 2e5f 7072          self._pr
 0000a530: 6f74 6f63 6f6c 5f77 6974 685f 7072 6f66  otocol_with_prof
-0000a540: 696c 6520 3d20 7365 6c66 2e70 726f 746f  ile = self.proto
-0000a550: 636f 6c0a 2020 2020 2020 2020 7365 6c66  col.        self
-0000a560: 2e5f 7072 6f66 696c 655f 6e61 6d65 203d  ._profile_name =
-0000a570: 204e 6f6e 650a 2020 2020 2020 2020 6966   None.        if
-0000a580: 2070 726f 746f 636f 6c2e 7374 6172 7473   protocol.starts
-0000a590: 7769 7468 2827 7333 2b27 293a 0a20 2020  with('s3+'):.   
-0000a5a0: 2020 2020 2020 2020 2073 656c 662e 5f70           self._p
-0000a5b0: 726f 746f 636f 6c5f 7769 7468 5f70 726f  rotocol_with_pro
-0000a5c0: 6669 6c65 203d 2070 726f 746f 636f 6c0a  file = protocol.
-0000a5d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000a5e0: 2e5f 7072 6f66 696c 655f 6e61 6d65 203d  ._profile_name =
-0000a5f0: 2070 726f 746f 636f 6c5b 333a 5d0a 2020   protocol[3:].  
-0000a600: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-0000a610: 7333 5f70 6174 6820 3d20 6622 7333 3a2f  s3_path = f"s3:/
-0000a620: 2f7b 7365 6c66 2e70 6174 685b 6c65 6e28  /{self.path[len(
-0000a630: 7072 6f74 6f63 6f6c 292b 333a 5d7d 220a  protocol)+3:]}".
-0000a640: 2020 2020 2020 2020 656c 6966 206e 6f74          elif not
-0000a650: 2070 726f 746f 636f 6c3a 0a20 2020 2020   protocol:.     
-0000a660: 2020 2020 2020 2073 656c 662e 5f73 335f         self._s3_
-0000a670: 7061 7468 203d 2066 2273 333a 2f2f 7b73  path = f"s3://{s
-0000a680: 656c 662e 7061 7468 2e6c 7374 7269 7028  elf.path.lstrip(
-0000a690: 272f 2729 7d22 0a20 2020 2020 2020 2065  '/')}".        e
-0000a6a0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000a6b0: 2073 656c 662e 5f73 335f 7061 7468 203d   self._s3_path =
-0000a6c0: 2073 656c 662e 7061 7468 0a0a 2020 2020   self.path..    
-0000a6d0: 4063 6163 6865 6470 726f 7065 7274 790a  @cachedproperty.
-0000a6e0: 2020 2020 6465 6620 7061 7468 5f77 6974      def path_wit
-0000a6f0: 685f 7072 6f74 6f63 6f6c 2873 656c 6629  h_protocol(self)
-0000a700: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-0000a710: 2027 2727 5265 7475 726e 2070 6174 6820   '''Return path 
-0000a720: 7769 7468 2070 726f 746f 636f 6c2c 206c  with protocol, l
-0000a730: 696b 6520 6669 6c65 3a2f 2f2f 726f 6f74  ike file:///root
-0000a740: 2c20 7333 3a2f 2f62 7563 6b65 742f 6b65  , s3://bucket/ke
-0000a750: 7927 2727 0a20 2020 2020 2020 2070 6174  y'''.        pat
-0000a760: 6820 3d20 7365 6c66 2e70 6174 680a 2020  h = self.path.  
-0000a770: 2020 2020 2020 7072 6f74 6f63 6f6c 5f70        protocol_p
-0000a780: 7265 6669 7820 3d20 7365 6c66 2e5f 7072  refix = self._pr
-0000a790: 6f74 6f63 6f6c 5f77 6974 685f 7072 6f66  otocol_with_prof
-0000a7a0: 696c 6520 2b20 223a 2f2f 220a 2020 2020  ile + "://".    
-0000a7b0: 2020 2020 6966 2070 6174 682e 7374 6172      if path.star
-0000a7c0: 7473 7769 7468 2870 726f 746f 636f 6c5f  tswith(protocol_
-0000a7d0: 7072 6566 6978 293a 0a20 2020 2020 2020  prefix):.       
-0000a7e0: 2020 2020 2072 6574 7572 6e20 7061 7468       return path
-0000a7f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000a800: 7072 6f74 6f63 6f6c 5f70 7265 6669 7820  protocol_prefix 
-0000a810: 2b20 7061 7468 2e6c 7374 7269 7028 272f  + path.lstrip('/
-0000a820: 2729 0a0a 2020 2020 4063 6163 6865 6470  ')..    @cachedp
-0000a830: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-0000a840: 7061 7468 5f77 6974 686f 7574 5f70 726f  path_without_pro
-0000a850: 746f 636f 6c28 7365 6c66 2920 2d3e 2073  tocol(self) -> s
-0000a860: 7472 3a0a 2020 2020 2020 2020 2727 2752  tr:.        '''R
-0000a870: 6574 7572 6e20 7061 7468 2077 6974 686f  eturn path witho
-0000a880: 7574 2070 726f 746f 636f 6c2c 2065 7861  ut protocol, exa
-0000a890: 6d70 6c65 3a20 6966 2070 6174 6820 6973  mple: if path is
-0000a8a0: 2073 333a 2f2f 6275 636b 6574 2f6b 6579   s3://bucket/key
-0000a8b0: 2c20 7265 7475 726e 2062 7563 6b65 742f  , return bucket/
-0000a8c0: 6b65 7927 2727 0a20 2020 2020 2020 2070  key'''.        p
-0000a8d0: 6174 6820 3d20 7365 6c66 2e70 6174 680a  ath = self.path.
-0000a8e0: 2020 2020 2020 2020 7072 6f74 6f63 6f6c          protocol
-0000a8f0: 5f70 7265 6669 7820 3d20 7365 6c66 2e5f  _prefix = self._
-0000a900: 7072 6f74 6f63 6f6c 5f77 6974 685f 7072  protocol_with_pr
-0000a910: 6f66 696c 6520 2b20 223a 2f2f 220a 2020  ofile + "://".  
-0000a920: 2020 2020 2020 6966 2070 6174 682e 7374        if path.st
-0000a930: 6172 7473 7769 7468 2870 726f 746f 636f  artswith(protoco
-0000a940: 6c5f 7072 6566 6978 293a 0a20 2020 2020  l_prefix):.     
-0000a950: 2020 2020 2020 2070 6174 6820 3d20 7061         path = pa
-0000a960: 7468 5b6c 656e 2870 726f 746f 636f 6c5f  th[len(protocol_
-0000a970: 7072 6566 6978 293a 5d0a 2020 2020 2020  prefix):].      
-0000a980: 2020 7265 7475 726e 2070 6174 680a 0a20    return path.. 
-0000a990: 2020 2040 6361 6368 6564 7072 6f70 6572     @cachedproper
-0000a9a0: 7479 0a20 2020 2064 6566 205f 636c 6965  ty.    def _clie
-0000a9b0: 6e74 2873 656c 6629 3a0a 2020 2020 2020  nt(self):.      
-0000a9c0: 2020 7265 7475 726e 2067 6574 5f73 335f    return get_s3_
-0000a9d0: 636c 6965 6e74 2870 726f 6669 6c65 5f6e  client(profile_n
-0000a9e0: 616d 653d 7365 6c66 2e5f 7072 6f66 696c  ame=self._profil
-0000a9f0: 655f 6e61 6d65 290a 0a20 2020 2064 6566  e_name)..    def
-0000aa00: 205f 7333 5f67 6574 5f6d 6574 6164 6174   _s3_get_metadat
-0000aa10: 6128 7365 6c66 2920 2d3e 2064 6963 743a  a(self) -> dict:
-0000aa20: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
-0000aa30: 2020 2020 2047 6574 206f 626a 6563 7420       Get object 
-0000aa40: 6d65 7461 6461 7461 0a0a 2020 2020 2020  metadata..      
-0000aa50: 2020 3a70 6172 616d 2070 6174 683a 204f    :param path: O
-0000aa60: 626a 6563 7420 7061 7468 0a20 2020 2020  bject path.     
-0000aa70: 2020 203a 7265 7475 726e 733a 204f 626a     :returns: Obj
-0000aa80: 6563 7420 6d65 7461 6461 7461 0a20 2020  ect metadata.   
-0000aa90: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
-0000aaa0: 2062 7563 6b65 742c 206b 6579 203d 2070   bucket, key = p
-0000aab0: 6172 7365 5f73 335f 7572 6c28 7365 6c66  arse_s3_url(self
-0000aac0: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
-0000aad0: 636f 6c29 0a20 2020 2020 2020 2069 6620  col).        if 
-0000aae0: 6e6f 7420 6275 636b 6574 3a0a 2020 2020  not bucket:.    
-0000aaf0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-0000ab00: 7d0a 2020 2020 2020 2020 6966 206e 6f74  }.        if not
-0000ab10: 206b 6579 206f 7220 6b65 792e 656e 6473   key or key.ends
-0000ab20: 7769 7468 2827 2f27 293a 0a20 2020 2020  with('/'):.     
-0000ab30: 2020 2020 2020 2072 6574 7572 6e20 7b7d         return {}
-0000ab40: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-0000ab50: 2020 2020 2020 2020 2020 7769 7468 2072            with r
-0000ab60: 6169 7365 5f73 335f 6572 726f 7228 7365  aise_s3_error(se
-0000ab70: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-0000ab80: 746f 636f 6c29 3a0a 2020 2020 2020 2020  tocol):.        
-0000ab90: 2020 2020 2020 2020 7265 7370 203d 2073          resp = s
-0000aba0: 656c 662e 5f63 6c69 656e 742e 6865 6164  elf._client.head
-0000abb0: 5f6f 626a 6563 7428 4275 636b 6574 3d62  _object(Bucket=b
-0000abc0: 7563 6b65 742c 204b 6579 3d6b 6579 290a  ucket, Key=key).
-0000abd0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000abe0: 726e 2064 6963 7428 0a20 2020 2020 2020  rn dict(.       
-0000abf0: 2020 2020 2020 2020 2028 6b65 792e 6c6f           (key.lo
-0000ac00: 7765 7228 292c 2076 616c 7565 2920 666f  wer(), value) fo
-0000ac10: 7220 6b65 792c 2076 616c 7565 2069 6e20  r key, value in 
-0000ac20: 7265 7370 5b27 4d65 7461 6461 7461 275d  resp['Metadata']
-0000ac30: 2e69 7465 6d73 2829 290a 2020 2020 2020  .items()).      
-0000ac40: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-0000ac50: 6f6e 2061 7320 6572 726f 723a 0a20 2020  on as error:.   
-0000ac60: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
-0000ac70: 7374 616e 6365 2865 7272 6f72 2c0a 2020  stance(error,.  
-0000ac80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ac90: 2020 2020 2020 2020 2853 3355 6e6b 6e6f          (S3Unkno
-0000aca0: 776e 4572 726f 722c 2053 3343 6f6e 6669  wnError, S3Confi
-0000acb0: 6745 7272 6f72 2c20 5333 5065 726d 6973  gError, S3Permis
-0000acc0: 7369 6f6e 4572 726f 7229 293a 0a20 2020  sionError)):.   
-0000acd0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-0000ace0: 7365 2065 7272 6f72 0a20 2020 2020 2020  se error.       
-0000acf0: 2020 2020 2072 6574 7572 6e20 7b7d 0a0a       return {}..
-0000ad00: 2020 2020 6465 6620 6163 6365 7373 280a      def access(.
-0000ad10: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000ad20: 2c20 6d6f 6465 3a20 4163 6365 7373 203d  , mode: Access =
-0000ad30: 2041 6363 6573 732e 5245 4144 2c0a 2020   Access.READ,.  
-0000ad40: 2020 2020 2020 2020 2020 666f 6c6c 6f77            follow
-0000ad50: 6c69 6e6b 733a 2062 6f6f 6c20 3d20 4661  links: bool = Fa
-0000ad60: 6c73 6529 202d 3e20 626f 6f6c 3a0a 2020  lse) -> bool:.  
-0000ad70: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
-0000ad80: 2020 5465 7374 2069 6620 7061 7468 2068    Test if path h
-0000ad90: 6173 2061 6363 6573 7320 7065 726d 6973  as access permis
-0000ada0: 7369 6f6e 2064 6573 6372 6962 6564 2062  sion described b
-0000adb0: 7920 6d6f 6465 0a20 2020 2020 2020 2055  y mode.        U
-0000adc0: 7369 6e67 2068 6561 645f 6275 636b 6574  sing head_bucket
-0000add0: 2829 2c20 6e6f 7720 5245 4144 2f57 5249  (), now READ/WRI
-0000ade0: 5445 2061 7265 2073 616d 652e 0a0a 2020  TE are same...  
-0000adf0: 2020 2020 2020 3a70 6172 616d 206d 6f64        :param mod
-0000ae00: 653a 2061 6363 6573 7320 6d6f 6465 0a20  e: access mode. 
-0000ae10: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
-0000ae20: 2062 6f6f 6c2c 2069 6620 7468 6520 6275   bool, if the bu
-0000ae30: 636b 6574 206f 6620 7333 5f75 726c 2068  cket of s3_url h
-0000ae40: 6173 2072 6561 642f 7772 6974 6520 6163  as read/write ac
-0000ae50: 6365 7373 2e0a 2020 2020 2020 2020 2727  cess..        ''
-0000ae60: 270a 2020 2020 2020 2020 7333 5f75 726c  '.        s3_url
-0000ae70: 203d 2073 656c 662e 7061 7468 5f77 6974   = self.path_wit
-0000ae80: 685f 7072 6f74 6f63 6f6c 0a20 2020 2020  h_protocol.     
-0000ae90: 2020 2069 6620 666f 6c6c 6f77 6c69 6e6b     if followlink
-0000aea0: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
-0000aeb0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000aec0: 2020 2020 7333 5f75 726c 203d 2073 656c      s3_url = sel
-0000aed0: 662e 7265 6164 6c69 6e6b 2829 2e70 6174  f.readlink().pat
-0000aee0: 685f 7769 7468 5f70 726f 746f 636f 6c0a  h_with_protocol.
-0000aef0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-0000af00: 7074 2053 334e 6f74 414c 696e 6b45 7272  pt S3NotALinkErr
-0000af10: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-0000af20: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
-0000af30: 2062 7563 6b65 742c 205f 203d 2070 6172   bucket, _ = par
-0000af40: 7365 5f73 335f 7572 6c28 7333 5f75 726c  se_s3_url(s3_url
-0000af50: 2920 2023 206f 6e6c 7920 6368 6563 6b20  )  # only check 
-0000af60: 6275 636b 6574 2061 6363 6573 7369 6269  bucket accessibi
-0000af70: 6c69 7479 0a20 2020 2020 2020 2069 6620  lity.        if 
-0000af80: 6e6f 7420 6275 636b 6574 3a0a 2020 2020  not bucket:.    
-0000af90: 2020 2020 2020 2020 7261 6973 6520 4578          raise Ex
-0000afa0: 6365 7074 696f 6e28 224e 6f20 6176 6169  ception("No avai
-0000afb0: 6c61 626c 6520 6275 636b 6574 2229 0a20  lable bucket"). 
-0000afc0: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
-0000afd0: 696e 7374 616e 6365 286d 6f64 652c 2041  instance(mode, A
-0000afe0: 6363 6573 7329 3a0a 2020 2020 2020 2020  ccess):.        
-0000aff0: 2020 2020 7261 6973 6520 5479 7065 4572      raise TypeEr
-0000b000: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-0000b010: 2020 2020 2027 556e 7375 7070 6f72 7465       'Unsupporte
-0000b020: 6420 6d6f 6465 3a20 7b7d 202d 2d20 4d6f  d mode: {} -- Mo
-0000b030: 6465 2073 686f 756c 6420 7573 6520 6f6e  de should use on
-0000b040: 6520 6f66 2074 6865 2065 6e75 6d73 2062  e of the enums b
-0000b050: 656c 6f6e 6769 6e67 2074 6f3a 2020 7b7d  elonging to:  {}
-0000b060: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0000b070: 2020 2e66 6f72 6d61 7428 6d6f 6465 2c20    .format(mode, 
-0000b080: 272c 2027 2e6a 6f69 6e28 5b73 7472 2861  ', '.join([str(a
-0000b090: 2920 666f 7220 6120 696e 2041 6363 6573  ) for a in Acces
-0000b0a0: 735d 2929 290a 2020 2020 2020 2020 6966  s]))).        if
-0000b0b0: 206d 6f64 6520 6e6f 7420 696e 2028 4163   mode not in (Ac
-0000b0c0: 6365 7373 2e52 4541 442c 2041 6363 6573  cess.READ, Acces
-0000b0d0: 732e 5752 4954 4529 3a0a 2020 2020 2020  s.WRITE):.      
-0000b0e0: 2020 2020 2020 7261 6973 6520 5479 7065        raise Type
-0000b0f0: 4572 726f 7228 2755 6e73 7570 706f 7274  Error('Unsupport
-0000b100: 6564 206d 6f64 653a 207b 7d27 2e66 6f72  ed mode: {}'.for
-0000b110: 6d61 7428 6d6f 6465 2929 0a20 2020 2020  mat(mode)).     
-0000b120: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0000b130: 2020 2020 7365 6c66 2e5f 636c 6965 6e74      self._client
-0000b140: 2e68 6561 645f 6275 636b 6574 2842 7563  .head_bucket(Buc
-0000b150: 6b65 743d 6275 636b 6574 290a 2020 2020  ket=bucket).    
-0000b160: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-0000b170: 7469 6f6e 2061 7320 6572 726f 723a 0a20  tion as error:. 
-0000b180: 2020 2020 2020 2020 2020 2065 7272 6f72             error
-0000b190: 203d 2074 7261 6e73 6c61 7465 5f73 335f   = translate_s3_
-0000b1a0: 6572 726f 7228 6572 726f 722c 2073 335f  error(error, s3_
-0000b1b0: 7572 6c29 0a20 2020 2020 2020 2020 2020  url).           
-0000b1c0: 2069 6620 6973 696e 7374 616e 6365 2865   if isinstance(e
-0000b1d0: 7272 6f72 2c20 2853 3350 6572 6d69 7373  rror, (S3Permiss
-0000b1e0: 696f 6e45 7272 6f72 2c20 5333 4669 6c65  ionError, S3File
-0000b1f0: 4e6f 7446 6f75 6e64 4572 726f 722c 0a20  NotFoundError,. 
-0000b200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b220: 2053 3342 7563 6b65 744e 6f74 466f 756e   S3BucketNotFoun
-0000b230: 6445 7272 6f72 2929 3a0a 2020 2020 2020  dError)):.      
-0000b240: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000b250: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
-0000b260: 2020 2072 6169 7365 2065 7272 6f72 0a20     raise error. 
-0000b270: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
-0000b280: 7565 0a0a 2020 2020 6465 6620 6578 6973  ue..    def exis
-0000b290: 7473 2873 656c 662c 2066 6f6c 6c6f 776c  ts(self, followl
-0000b2a0: 696e 6b73 3a20 626f 6f6c 203d 2046 616c  inks: bool = Fal
-0000b2b0: 7365 2920 2d3e 2062 6f6f 6c3a 0a20 2020  se) -> bool:.   
-0000b2c0: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
-0000b2d0: 2054 6573 7420 6966 2073 335f 7572 6c20   Test if s3_url 
-0000b2e0: 6578 6973 7473 0a0a 2020 2020 2020 2020  exists..        
-0000b2f0: 4966 2074 6865 2062 7563 6b65 7420 6f66  If the bucket of
-0000b300: 2073 335f 7572 6c20 6172 6520 6e6f 7420   s3_url are not 
-0000b310: 7065 726d 6974 7465 6420 746f 2072 6561  permitted to rea
-0000b320: 642c 2072 6574 7572 6e20 4661 6c73 650a  d, return False.
-0000b330: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-0000b340: 733a 2054 7275 6520 6966 2073 335f 7572  s: True if s3_ur
-0000b350: 6c20 6569 7873 7473 2c20 656c 7365 2046  l eixsts, else F
-0000b360: 616c 7365 0a20 2020 2020 2020 2027 2727  alse.        '''
-0000b370: 0a20 2020 2020 2020 2062 7563 6b65 742c  .        bucket,
-0000b380: 206b 6579 203d 2070 6172 7365 5f73 335f   key = parse_s3_
-0000b390: 7572 6c28 7365 6c66 2e70 6174 685f 7769  url(self.path_wi
-0000b3a0: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
-0000b3b0: 2020 2020 2069 6620 6e6f 7420 6275 636b       if not buck
-0000b3c0: 6574 3a20 2023 2073 333a 2f2f 203d 3e20  et:  # s3:// => 
-0000b3d0: 5472 7565 2c20 7333 3a2f 2f2f 6b65 7920  True, s3:///key 
-0000b3e0: 3d3e 2046 616c 7365 0a20 2020 2020 2020  => False.       
-0000b3f0: 2020 2020 2072 6574 7572 6e20 6e6f 7420       return not 
-0000b400: 6b65 790a 0a20 2020 2020 2020 2072 6574  key..        ret
-0000b410: 7572 6e20 7365 6c66 2e69 735f 6469 7228  urn self.is_dir(
-0000b420: 2920 6f72 2073 656c 662e 6973 5f66 696c  ) or self.is_fil
-0000b430: 6528 666f 6c6c 6f77 6c69 6e6b 7329 0a0a  e(followlinks)..
-0000b440: 2020 2020 6465 6620 6765 746d 7469 6d65      def getmtime
-0000b450: 2873 656c 662c 2066 6f6c 6c6f 775f 7379  (self, follow_sy
-0000b460: 6d6c 696e 6b73 3a20 626f 6f6c 203d 2046  mlinks: bool = F
-0000b470: 616c 7365 2920 2d3e 2066 6c6f 6174 3a0a  alse) -> float:.
-0000b480: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-0000b490: 2020 2020 4765 7420 6c61 7374 2d6d 6f64      Get last-mod
-0000b4a0: 6966 6965 6420 7469 6d65 206f 6620 7468  ified time of th
-0000b4b0: 6520 6669 6c65 206f 6e20 7468 6520 6769  e file on the gi
-0000b4c0: 7665 6e20 7333 5f75 726c 2070 6174 6820  ven s3_url path 
-0000b4d0: 2869 6e20 556e 6978 2074 696d 6573 7461  (in Unix timesta
-0000b4e0: 6d70 2066 6f72 6d61 7429 2e0a 2020 2020  mp format)..    
-0000b4f0: 2020 2020 4966 2074 6865 2070 6174 6820      If the path 
-0000b500: 6973 2061 6e20 6578 6973 7465 6e74 2064  is an existent d
-0000b510: 6972 6563 746f 7279 2c20 7265 7475 726e  irectory, return
-0000b520: 2074 6865 206c 6174 6573 7420 6d6f 6469   the latest modi
-0000b530: 6669 6564 2074 696d 6520 6f66 2061 6c6c  fied time of all
-0000b540: 2066 696c 6520 696e 2069 742e 2054 6865   file in it. The
-0000b550: 206d 7469 6d65 206f 6620 656d 7074 7920   mtime of empty 
-0000b560: 6469 7265 6374 6f72 7920 6973 2031 3937  directory is 197
-0000b570: 302d 3031 2d30 3120 3030 3a30 303a 3030  0-01-01 00:00:00
-0000b580: 0a0a 2020 2020 2020 2020 4966 2073 335f  ..        If s3_
-0000b590: 7572 6c20 6973 206e 6f74 2061 6e20 6578  url is not an ex
-0000b5a0: 6973 7465 6e74 2070 6174 682c 2077 6869  istent path, whi
-0000b5b0: 6368 206d 6561 6e73 2073 335f 6578 6973  ch means s3_exis
-0000b5c0: 7428 7333 5f75 726c 2920 7265 7475 726e  t(s3_url) return
-0000b5d0: 7320 4661 6c73 652c 2074 6865 6e20 7261  s False, then ra
-0000b5e0: 6973 6520 5333 4669 6c65 4e6f 7446 6f75  ise S3FileNotFou
-0000b5f0: 6e64 4572 726f 720a 0a20 2020 2020 2020  ndError..       
-0000b600: 203a 7265 7475 726e 733a 204c 6173 742d   :returns: Last-
-0000b610: 6d6f 6469 6669 6564 2074 696d 650a 2020  modified time.  
-0000b620: 2020 2020 2020 3a72 6169 7365 733a 2053        :raises: S
-0000b630: 3346 696c 654e 6f74 466f 756e 6445 7272  3FileNotFoundErr
-0000b640: 6f72 2c20 556e 7375 7070 6f72 7465 6445  or, UnsupportedE
-0000b650: 7272 6f72 0a20 2020 2020 2020 2027 2727  rror.        '''
-0000b660: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000b670: 7365 6c66 2e73 7461 7428 666f 6c6c 6f77  self.stat(follow
-0000b680: 5f73 796d 6c69 6e6b 733d 666f 6c6c 6f77  _symlinks=follow
-0000b690: 5f73 796d 6c69 6e6b 7329 2e6d 7469 6d65  _symlinks).mtime
-0000b6a0: 0a0a 2020 2020 6465 6620 6765 7473 697a  ..    def getsiz
-0000b6b0: 6528 7365 6c66 2c20 666f 6c6c 6f77 5f73  e(self, follow_s
-0000b6c0: 796d 6c69 6e6b 733a 2062 6f6f 6c20 3d20  ymlinks: bool = 
-0000b6d0: 4661 6c73 6529 202d 3e20 696e 743a 0a20  False) -> int:. 
-0000b6e0: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-0000b6f0: 2020 2047 6574 2066 696c 6520 7369 7a65     Get file size
-0000b700: 206f 6e20 7468 6520 6769 7665 6e20 7333   on the given s3
-0000b710: 5f75 726c 2070 6174 6820 2869 6e20 6279  _url path (in by
-0000b720: 7465 7329 2e0a 2020 2020 2020 2020 4966  tes)..        If
-0000b730: 2074 6865 2070 6174 6820 696e 2061 2064   the path in a d
-0000b740: 6972 6563 746f 7279 2c20 7265 7475 726e  irectory, return
-0000b750: 2074 6865 2073 756d 206f 6620 616c 6c20   the sum of all 
-0000b760: 6669 6c65 2073 697a 6520 696e 2069 742c  file size in it,
-0000b770: 2069 6e63 6c75 6469 6e67 2066 696c 6520   including file 
-0000b780: 696e 2073 7562 6469 7265 6374 6f72 6965  in subdirectorie
-0000b790: 7320 2869 6620 6578 6973 7429 2e0a 2020  s (if exist)..  
-0000b7a0: 2020 2020 2020 5468 6520 7265 7375 6c74        The result
-0000b7b0: 2065 7863 6c75 6465 7320 7468 6520 7369   excludes the si
-0000b7c0: 7a65 206f 6620 6469 7265 6374 6f72 7920  ze of directory 
-0000b7d0: 6974 7365 6c66 2e20 496e 206f 7468 6572  itself. In other
-0000b7e0: 2077 6f72 6473 2c20 7265 7475 726e 2030   words, return 0
-0000b7f0: 2042 7974 6520 6f6e 2061 6e20 656d 7074   Byte on an empt
-0000b800: 7920 6469 7265 6374 6f72 7920 7061 7468  y directory path
-0000b810: 2e0a 0a20 2020 2020 2020 2049 6620 7333  ...        If s3
-0000b820: 5f75 726c 2069 7320 6e6f 7420 616e 2065  _url is not an e
-0000b830: 7869 7374 656e 7420 7061 7468 2c20 7768  xistent path, wh
-0000b840: 6963 6820 6d65 616e 7320 7333 5f65 7869  ich means s3_exi
-0000b850: 7374 2873 335f 7572 6c29 2072 6574 7572  st(s3_url) retur
-0000b860: 6e73 2046 616c 7365 2c20 7468 656e 2072  ns False, then r
-0000b870: 6169 7365 2053 3346 696c 654e 6f74 466f  aise S3FileNotFo
-0000b880: 756e 6445 7272 6f72 0a0a 2020 2020 2020  undError..      
-0000b890: 2020 3a72 6574 7572 6e73 3a20 4669 6c65    :returns: File
-0000b8a0: 2073 697a 650a 2020 2020 2020 2020 3a72   size.        :r
-0000b8b0: 6169 7365 733a 2053 3346 696c 654e 6f74  aises: S3FileNot
-0000b8c0: 466f 756e 6445 7272 6f72 2c20 556e 7375  FoundError, Unsu
-0000b8d0: 7070 6f72 7465 6445 7272 6f72 0a20 2020  pportedError.   
-0000b8e0: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
-0000b8f0: 2072 6574 7572 6e20 7365 6c66 2e73 7461   return self.sta
-0000b900: 7428 666f 6c6c 6f77 5f73 796d 6c69 6e6b  t(follow_symlink
-0000b910: 733d 666f 6c6c 6f77 5f73 796d 6c69 6e6b  s=follow_symlink
-0000b920: 7329 2e73 697a 650a 0a20 2020 2064 6566  s).size..    def
-0000b930: 2067 6c6f 6228 0a20 2020 2020 2020 2020   glob(.         
-0000b940: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-0000b950: 2020 2020 2070 6174 7465 726e 2c0a 2020       pattern,.  
-0000b960: 2020 2020 2020 2020 2020 7265 6375 7273            recurs
-0000b970: 6976 653a 2062 6f6f 6c20 3d20 5472 7565  ive: bool = True
-0000b980: 2c0a 2020 2020 2020 2020 2020 2020 6d69  ,.            mi
-0000b990: 7373 696e 675f 6f6b 3a20 626f 6f6c 203d  ssing_ok: bool =
-0000b9a0: 2054 7275 652c 0a20 2020 2020 2020 2020   True,.         
-0000b9b0: 2020 2066 6f6c 6c6f 776c 696e 6b73 3a20     followlinks: 
-0000b9c0: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
-0000b9d0: 2020 2920 2d3e 204c 6973 745b 2753 3350    ) -> List['S3P
-0000b9e0: 6174 6827 5d3a 0a20 2020 2020 2020 2027  ath']:.        '
-0000b9f0: 2727 5265 7475 726e 2073 3320 7061 7468  ''Return s3 path
-0000ba00: 206c 6973 7420 696e 2061 7363 656e 6469   list in ascendi
-0000ba10: 6e67 2061 6c70 6861 6265 7469 6361 6c20  ng alphabetical 
-0000ba20: 6f72 6465 722c 2069 6e20 7768 6963 6820  order, in which 
-0000ba30: 7061 7468 206d 6174 6368 6573 2067 6c6f  path matches glo
-0000ba40: 6220 7061 7474 6572 6e0a 2020 2020 2020  b pattern.      
-0000ba50: 2020 4e6f 7465 733a 204f 6e6c 7920 676c    Notes: Only gl
-0000ba60: 6f62 2069 6e20 6275 636b 6574 2e20 4966  ob in bucket. If
-0000ba70: 2074 7279 696e 6720 746f 206d 6174 6368   trying to match
-0000ba80: 2062 7563 6b65 7420 7769 7468 2077 696c   bucket with wil
-0000ba90: 6463 6172 6420 6368 6172 6163 7465 7273  dcard characters
-0000baa0: 2c20 7261 6973 6520 556e 7375 7070 6f72  , raise Unsuppor
-0000bab0: 7465 6445 7272 6f72 0a0a 2020 2020 2020  tedError..      
-0000bac0: 2020 3a70 6172 616d 2070 6174 7465 726e    :param pattern
-0000bad0: 3a20 476c 6f62 2074 6865 2067 6976 656e  : Glob the given
-0000bae0: 2072 656c 6174 6976 6520 7061 7474 6572   relative patter
-0000baf0: 6e20 696e 2074 6865 2064 6972 6563 746f  n in the directo
-0000bb00: 7279 2072 6570 7265 7365 6e74 6564 2062  ry represented b
-0000bb10: 7920 7468 6973 2070 6174 680a 2020 2020  y this path.    
-0000bb20: 2020 2020 3a70 6172 616d 2072 6563 7572      :param recur
-0000bb30: 7369 7665 3a20 4966 2046 616c 7365 2c20  sive: If False, 
-0000bb40: 602a 2a60 2077 696c 6c20 6e6f 7420 7365  `**` will not se
-0000bb50: 6172 6368 2064 6972 6563 746f 7279 2072  arch directory r
-0000bb60: 6563 7572 7369 7665 6c79 0a20 2020 2020  ecursively.     
-0000bb70: 2020 203a 7061 7261 6d20 6d69 7373 696e     :param missin
-0000bb80: 675f 6f6b 3a20 4966 2046 616c 7365 2061  g_ok: If False a
-0000bb90: 6e64 2074 6172 6765 7420 7061 7468 2064  nd target path d
-0000bba0: 6f65 736e 2774 206d 6174 6368 2061 6e79  oesn't match any
-0000bbb0: 2066 696c 652c 2072 6169 7365 2046 696c   file, raise Fil
-0000bbc0: 654e 6f74 466f 756e 6445 7272 6f72 0a20  eNotFoundError. 
-0000bbd0: 2020 2020 2020 203a 7261 6973 6573 3a20         :raises: 
-0000bbe0: 556e 7375 7070 6f72 7465 6445 7272 6f72  UnsupportedError
-0000bbf0: 2c20 7768 656e 2062 7563 6b65 7420 7061  , when bucket pa
-0000bc00: 7274 2063 6f6e 7461 696e 7320 7769 6c64  rt contains wild
-0000bc10: 6361 7264 2063 6861 7261 6374 6572 730a  card characters.
-0000bc20: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
-0000bc30: 3a20 4120 6c69 7374 2063 6f6e 7461 696e  : A list contain
-0000bc40: 7320 7061 7468 7320 6d61 7463 6820 6073  s paths match `s
-0000bc50: 335f 7061 7468 6e61 6d65 600a 2020 2020  3_pathname`.    
-0000bc60: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
-0000bc70: 7265 7475 726e 206c 6973 7428 0a20 2020  return list(.   
-0000bc80: 2020 2020 2020 2020 2073 656c 662e 6967           self.ig
-0000bc90: 6c6f 6228 0a20 2020 2020 2020 2020 2020  lob(.           
-0000bca0: 2020 2020 2070 6174 7465 726e 3d70 6174       pattern=pat
-0000bcb0: 7465 726e 2c0a 2020 2020 2020 2020 2020  tern,.          
-0000bcc0: 2020 2020 2020 7265 6375 7273 6976 653d        recursive=
-0000bcd0: 7265 6375 7273 6976 652c 0a20 2020 2020  recursive,.     
-0000bce0: 2020 2020 2020 2020 2020 206d 6973 7369             missi
-0000bcf0: 6e67 5f6f 6b3d 6d69 7373 696e 675f 6f6b  ng_ok=missing_ok
-0000bd00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000bd10: 2020 666f 6c6c 6f77 6c69 6e6b 733d 666f    followlinks=fo
-0000bd20: 6c6c 6f77 6c69 6e6b 7329 290a 0a20 2020  llowlinks))..   
-0000bd30: 2064 6566 2067 6c6f 625f 7374 6174 280a   def glob_stat(.
-0000bd40: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000bd50: 2c0a 2020 2020 2020 2020 2020 2020 7061  ,.            pa
-0000bd60: 7474 6572 6e2c 0a20 2020 2020 2020 2020  ttern,.         
-0000bd70: 2020 2072 6563 7572 7369 7665 3a20 626f     recursive: bo
-0000bd80: 6f6c 203d 2054 7275 652c 0a20 2020 2020  ol = True,.     
-0000bd90: 2020 2020 2020 206d 6973 7369 6e67 5f6f         missing_o
-0000bda0: 6b3a 2062 6f6f 6c20 3d20 5472 7565 2c0a  k: bool = True,.
-0000bdb0: 2020 2020 2020 2020 2020 2020 666f 6c6c              foll
-0000bdc0: 6f77 6c69 6e6b 733a 2062 6f6f 6c20 3d20  owlinks: bool = 
-0000bdd0: 4661 6c73 6529 202d 3e20 4974 6572 6174  False) -> Iterat
-0000bde0: 6f72 5b46 696c 6545 6e74 7279 5d3a 0a20  or[FileEntry]:. 
-0000bdf0: 2020 2020 2020 2027 2727 5265 7475 726e         '''Return
-0000be00: 2061 2067 656e 6572 6174 6f72 2063 6f6e   a generator con
-0000be10: 7461 696e 7320 7475 706c 6573 206f 6620  tains tuples of 
-0000be20: 7061 7468 2061 6e64 2066 696c 6520 7374  path and file st
-0000be30: 6174 2c20 696e 2061 7363 656e 6469 6e67  at, in ascending
-0000be40: 2061 6c70 6861 6265 7469 6361 6c20 6f72   alphabetical or
-0000be50: 6465 722c 2069 6e20 7768 6963 6820 7061  der, in which pa
-0000be60: 7468 206d 6174 6368 6573 2067 6c6f 6220  th matches glob 
-0000be70: 7061 7474 6572 6e0a 2020 2020 2020 2020  pattern.        
-0000be80: 4e6f 7465 733a 204f 6e6c 7920 676c 6f62  Notes: Only glob
-0000be90: 2069 6e20 6275 636b 6574 2e20 4966 2074   in bucket. If t
-0000bea0: 7279 696e 6720 746f 206d 6174 6368 2062  rying to match b
-0000beb0: 7563 6b65 7420 7769 7468 2077 696c 6463  ucket with wildc
-0000bec0: 6172 6420 6368 6172 6163 7465 7273 2c20  ard characters, 
-0000bed0: 7261 6973 6520 556e 7375 7070 6f72 7465  raise Unsupporte
-0000bee0: 6445 7272 6f72 0a0a 2020 2020 2020 2020  dError..        
-0000bef0: 3a70 6172 616d 2070 6174 7465 726e 3a20  :param pattern: 
-0000bf00: 476c 6f62 2074 6865 2067 6976 656e 2072  Glob the given r
-0000bf10: 656c 6174 6976 6520 7061 7474 6572 6e20  elative pattern 
-0000bf20: 696e 2074 6865 2064 6972 6563 746f 7279  in the directory
-0000bf30: 2072 6570 7265 7365 6e74 6564 2062 7920   represented by 
-0000bf40: 7468 6973 2070 6174 680a 2020 2020 2020  this path.      
-0000bf50: 2020 3a70 6172 616d 2072 6563 7572 7369    :param recursi
-0000bf60: 7665 3a20 4966 2046 616c 7365 2c20 602a  ve: If False, `*
-0000bf70: 2a60 2077 696c 6c20 6e6f 7420 7365 6172  *` will not sear
-0000bf80: 6368 2064 6972 6563 746f 7279 2072 6563  ch directory rec
-0000bf90: 7572 7369 7665 6c79 0a20 2020 2020 2020  ursively.       
-0000bfa0: 203a 7061 7261 6d20 6d69 7373 696e 675f   :param missing_
-0000bfb0: 6f6b 3a20 4966 2046 616c 7365 2061 6e64  ok: If False and
-0000bfc0: 2074 6172 6765 7420 7061 7468 2064 6f65   target path doe
-0000bfd0: 736e 2774 206d 6174 6368 2061 6e79 2066  sn't match any f
-0000bfe0: 696c 652c 2072 6169 7365 2046 696c 654e  ile, raise FileN
-0000bff0: 6f74 466f 756e 6445 7272 6f72 0a20 2020  otFoundError.   
-0000c000: 2020 2020 203a 7261 6973 6573 3a20 556e       :raises: Un
-0000c010: 7375 7070 6f72 7465 6445 7272 6f72 2c20  supportedError, 
-0000c020: 7768 656e 2062 7563 6b65 7420 7061 7274  when bucket part
-0000c030: 2063 6f6e 7461 696e 7320 7769 6c64 6361   contains wildca
-0000c040: 7264 2063 6861 7261 6374 6572 730a 2020  rd characters.  
-0000c050: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
-0000c060: 4120 6765 6e65 7261 746f 7220 636f 6e74  A generator cont
-0000c070: 6169 6e73 2074 7570 6c65 7320 6f66 2070  ains tuples of p
-0000c080: 6174 6820 616e 6420 6669 6c65 2073 7461  ath and file sta
-0000c090: 742c 2069 6e20 7768 6963 6820 7061 7468  t, in which path
-0000c0a0: 7320 6d61 7463 6820 6073 335f 7061 7468  s match `s3_path
-0000c0b0: 6e61 6d65 600a 2020 2020 2020 2020 2727  name`.        ''
-0000c0c0: 270a 2020 2020 2020 2020 676c 6f62 5f70  '.        glob_p
-0000c0d0: 6174 6820 3d20 7365 6c66 2e5f 7333 5f70  ath = self._s3_p
-0000c0e0: 6174 680a 2020 2020 2020 2020 6966 2070  ath.        if p
-0000c0f0: 6174 7465 726e 3a0a 2020 2020 2020 2020  attern:.        
-0000c100: 2020 2020 676c 6f62 5f70 6174 6820 3d20      glob_path = 
-0000c110: 7365 6c66 2e6a 6f69 6e70 6174 6828 7061  self.joinpath(pa
-0000c120: 7474 6572 6e29 2e5f 7333 5f70 6174 6820  ttern)._s3_path 
-0000c130: 2023 2070 7974 7970 653a 2064 6973 6162   # pytype: disab
-0000c140: 6c65 3d61 7474 7269 6275 7465 2d65 7272  le=attribute-err
-0000c150: 6f72 0a20 2020 2020 2020 2073 335f 7061  or.        s3_pa
-0000c160: 7468 6e61 6d65 203d 2066 7370 6174 6828  thname = fspath(
-0000c170: 676c 6f62 5f70 6174 6829 0a0a 2020 2020  glob_path)..    
-0000c180: 2020 2020 6465 6620 6372 6561 7465 5f67      def create_g
-0000c190: 656e 6572 6174 6f72 2829 3a0a 2020 2020  enerator():.    
-0000c1a0: 2020 2020 2020 2020 666f 7220 6772 6f75          for grou
-0000c1b0: 705f 7333 5f70 6174 686e 616d 655f 3120  p_s3_pathname_1 
-0000c1c0: 696e 205f 6772 6f75 705f 7333 7061 7468  in _group_s3path
-0000c1d0: 5f62 795f 6275 636b 6574 280a 2020 2020  _by_bucket(.    
-0000c1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c1f0: 7333 5f70 6174 686e 616d 652c 2073 656c  s3_pathname, sel
-0000c200: 662e 5f70 726f 6669 6c65 5f6e 616d 6529  f._profile_name)
-0000c210: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000c220: 2020 666f 7220 6772 6f75 705f 7333 5f70    for group_s3_p
-0000c230: 6174 686e 616d 655f 3220 696e 205f 6772  athname_2 in _gr
-0000c240: 6f75 705f 7333 7061 7468 5f62 795f 7072  oup_s3path_by_pr
-0000c250: 6566 6978 280a 2020 2020 2020 2020 2020  efix(.          
-0000c260: 2020 2020 2020 2020 2020 2020 2020 6772                gr
-0000c270: 6f75 705f 7333 5f70 6174 686e 616d 655f  oup_s3_pathname_
-0000c280: 3129 3a0a 2020 2020 2020 2020 2020 2020  1):.            
-0000c290: 2020 2020 2020 2020 666f 7220 6669 6c65          for file
-0000c2a0: 5f65 6e74 7279 2069 6e20 5f73 335f 676c  _entry in _s3_gl
-0000c2b0: 6f62 5f73 7461 745f 7369 6e67 6c65 5f70  ob_stat_single_p
-0000c2c0: 6174 6828 0a20 2020 2020 2020 2020 2020  ath(.           
-0000c2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c2e0: 2067 726f 7570 5f73 335f 7061 7468 6e61   group_s3_pathna
-0000c2f0: 6d65 5f32 2c20 7265 6375 7273 6976 652c  me_2, recursive,
-0000c300: 206d 6973 7369 6e67 5f6f 6b2c 0a20 2020   missing_ok,.   
-0000c310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c320: 2020 2020 2020 2020 2066 6f6c 6c6f 776c           followl
-0000c330: 696e 6b73 3d66 6f6c 6c6f 776c 696e 6b73  inks=followlinks
-0000c340: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000c350: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0000c360: 6f66 696c 655f 6e61 6d65 3d73 656c 662e  ofile_name=self.
-0000c370: 5f70 726f 6669 6c65 5f6e 616d 6529 3a0a  _profile_name):.
-0000c380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c390: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0000c3a0: 5f70 726f 6669 6c65 5f6e 616d 653a 0a20  _profile_name:. 
-0000c3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c3c0: 2020 2020 2020 2020 2020 2066 696c 655f             file_
-0000c3d0: 656e 7472 7920 3d20 6669 6c65 5f65 6e74  entry = file_ent
-0000c3e0: 7279 2e5f 7265 706c 6163 6528 0a20 2020  ry._replace(.   
+0000a540: 696c 6520 3d20 7072 6f74 6f63 6f6c 0a20  ile = protocol. 
+0000a550: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000a560: 5f70 726f 6669 6c65 5f6e 616d 6520 3d20  _profile_name = 
+0000a570: 7072 6f74 6f63 6f6c 5b33 3a5d 0a20 2020  protocol[3:].   
+0000a580: 2020 2020 2020 2020 2073 656c 662e 5f73           self._s
+0000a590: 335f 7061 7468 203d 2066 2273 333a 2f2f  3_path = f"s3://
+0000a5a0: 7b73 656c 662e 7061 7468 5b6c 656e 2870  {self.path[len(p
+0000a5b0: 726f 746f 636f 6c29 2b33 3a5d 7d22 0a20  rotocol)+3:]}". 
+0000a5c0: 2020 2020 2020 2065 6c69 6620 6e6f 7420         elif not 
+0000a5d0: 7072 6f74 6f63 6f6c 3a0a 2020 2020 2020  protocol:.      
+0000a5e0: 2020 2020 2020 7365 6c66 2e5f 7333 5f70        self._s3_p
+0000a5f0: 6174 6820 3d20 6622 7333 3a2f 2f7b 7365  ath = f"s3://{se
+0000a600: 6c66 2e70 6174 682e 6c73 7472 6970 2827  lf.path.lstrip('
+0000a610: 2f27 297d 220a 2020 2020 2020 2020 656c  /')}".        el
+0000a620: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000a630: 7365 6c66 2e5f 7333 5f70 6174 6820 3d20  self._s3_path = 
+0000a640: 7365 6c66 2e70 6174 680a 0a20 2020 2040  self.path..    @
+0000a650: 6361 6368 6564 7072 6f70 6572 7479 0a20  cachedproperty. 
+0000a660: 2020 2064 6566 2070 6174 685f 7769 7468     def path_with
+0000a670: 5f70 726f 746f 636f 6c28 7365 6c66 2920  _protocol(self) 
+0000a680: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
+0000a690: 2727 2752 6574 7572 6e20 7061 7468 2077  '''Return path w
+0000a6a0: 6974 6820 7072 6f74 6f63 6f6c 2c20 6c69  ith protocol, li
+0000a6b0: 6b65 2066 696c 653a 2f2f 2f72 6f6f 742c  ke file:///root,
+0000a6c0: 2073 333a 2f2f 6275 636b 6574 2f6b 6579   s3://bucket/key
+0000a6d0: 2727 270a 2020 2020 2020 2020 7061 7468  '''.        path
+0000a6e0: 203d 2073 656c 662e 7061 7468 0a20 2020   = self.path.   
+0000a6f0: 2020 2020 2070 726f 746f 636f 6c5f 7072       protocol_pr
+0000a700: 6566 6978 203d 2073 656c 662e 5f70 726f  efix = self._pro
+0000a710: 746f 636f 6c5f 7769 7468 5f70 726f 6669  tocol_with_profi
+0000a720: 6c65 202b 2022 3a2f 2f22 0a20 2020 2020  le + "://".     
+0000a730: 2020 2069 6620 7061 7468 2e73 7461 7274     if path.start
+0000a740: 7377 6974 6828 7072 6f74 6f63 6f6c 5f70  swith(protocol_p
+0000a750: 7265 6669 7829 3a0a 2020 2020 2020 2020  refix):.        
+0000a760: 2020 2020 7265 7475 726e 2070 6174 680a      return path.
+0000a770: 2020 2020 2020 2020 7265 7475 726e 2070          return p
+0000a780: 726f 746f 636f 6c5f 7072 6566 6978 202b  rotocol_prefix +
+0000a790: 2070 6174 682e 6c73 7472 6970 2827 2f27   path.lstrip('/'
+0000a7a0: 290a 0a20 2020 2040 6361 6368 6564 7072  )..    @cachedpr
+0000a7b0: 6f70 6572 7479 0a20 2020 2064 6566 2070  operty.    def p
+0000a7c0: 6174 685f 7769 7468 6f75 745f 7072 6f74  ath_without_prot
+0000a7d0: 6f63 6f6c 2873 656c 6629 202d 3e20 7374  ocol(self) -> st
+0000a7e0: 723a 0a20 2020 2020 2020 2027 2727 5265  r:.        '''Re
+0000a7f0: 7475 726e 2070 6174 6820 7769 7468 6f75  turn path withou
+0000a800: 7420 7072 6f74 6f63 6f6c 2c20 6578 616d  t protocol, exam
+0000a810: 706c 653a 2069 6620 7061 7468 2069 7320  ple: if path is 
+0000a820: 7333 3a2f 2f62 7563 6b65 742f 6b65 792c  s3://bucket/key,
+0000a830: 2072 6574 7572 6e20 6275 636b 6574 2f6b   return bucket/k
+0000a840: 6579 2727 270a 2020 2020 2020 2020 7061  ey'''.        pa
+0000a850: 7468 203d 2073 656c 662e 7061 7468 0a20  th = self.path. 
+0000a860: 2020 2020 2020 2070 726f 746f 636f 6c5f         protocol_
+0000a870: 7072 6566 6978 203d 2073 656c 662e 5f70  prefix = self._p
+0000a880: 726f 746f 636f 6c5f 7769 7468 5f70 726f  rotocol_with_pro
+0000a890: 6669 6c65 202b 2022 3a2f 2f22 0a20 2020  file + "://".   
+0000a8a0: 2020 2020 2069 6620 7061 7468 2e73 7461       if path.sta
+0000a8b0: 7274 7377 6974 6828 7072 6f74 6f63 6f6c  rtswith(protocol
+0000a8c0: 5f70 7265 6669 7829 3a0a 2020 2020 2020  _prefix):.      
+0000a8d0: 2020 2020 2020 7061 7468 203d 2070 6174        path = pat
+0000a8e0: 685b 6c65 6e28 7072 6f74 6f63 6f6c 5f70  h[len(protocol_p
+0000a8f0: 7265 6669 7829 3a5d 0a20 2020 2020 2020  refix):].       
+0000a900: 2072 6574 7572 6e20 7061 7468 0a0a 2020   return path..  
+0000a910: 2020 4063 6163 6865 6470 726f 7065 7274    @cachedpropert
+0000a920: 790a 2020 2020 6465 6620 5f63 6c69 656e  y.    def _clien
+0000a930: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
+0000a940: 2072 6574 7572 6e20 6765 745f 7333 5f63   return get_s3_c
+0000a950: 6c69 656e 7428 7072 6f66 696c 655f 6e61  lient(profile_na
+0000a960: 6d65 3d73 656c 662e 5f70 726f 6669 6c65  me=self._profile
+0000a970: 5f6e 616d 6529 0a0a 2020 2020 6465 6620  _name)..    def 
+0000a980: 5f73 335f 6765 745f 6d65 7461 6461 7461  _s3_get_metadata
+0000a990: 2873 656c 6629 202d 3e20 6469 6374 3a0a  (self) -> dict:.
+0000a9a0: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+0000a9b0: 2020 2020 4765 7420 6f62 6a65 6374 206d      Get object m
+0000a9c0: 6574 6164 6174 610a 0a20 2020 2020 2020  etadata..       
+0000a9d0: 203a 7061 7261 6d20 7061 7468 3a20 4f62   :param path: Ob
+0000a9e0: 6a65 6374 2070 6174 680a 2020 2020 2020  ject path.      
+0000a9f0: 2020 3a72 6574 7572 6e73 3a20 4f62 6a65    :returns: Obje
+0000aa00: 6374 206d 6574 6164 6174 610a 2020 2020  ct metadata.    
+0000aa10: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
+0000aa20: 6275 636b 6574 2c20 6b65 7920 3d20 7061  bucket, key = pa
+0000aa30: 7273 655f 7333 5f75 726c 2873 656c 662e  rse_s3_url(self.
+0000aa40: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
+0000aa50: 6f6c 290a 2020 2020 2020 2020 6966 206e  ol).        if n
+0000aa60: 6f74 2062 7563 6b65 743a 0a20 2020 2020  ot bucket:.     
+0000aa70: 2020 2020 2020 2072 6574 7572 6e20 7b7d         return {}
+0000aa80: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0000aa90: 6b65 7920 6f72 206b 6579 2e65 6e64 7377  key or key.endsw
+0000aaa0: 6974 6828 272f 2729 3a0a 2020 2020 2020  ith('/'):.      
+0000aab0: 2020 2020 2020 7265 7475 726e 207b 7d0a        return {}.
+0000aac0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0000aad0: 2020 2020 2020 2020 2077 6974 6820 7261           with ra
+0000aae0: 6973 655f 7333 5f65 7272 6f72 2873 656c  ise_s3_error(sel
+0000aaf0: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
+0000ab00: 6f63 6f6c 293a 0a20 2020 2020 2020 2020  ocol):.         
+0000ab10: 2020 2020 2020 2072 6573 7020 3d20 7365         resp = se
+0000ab20: 6c66 2e5f 636c 6965 6e74 2e68 6561 645f  lf._client.head_
+0000ab30: 6f62 6a65 6374 2842 7563 6b65 743d 6275  object(Bucket=bu
+0000ab40: 636b 6574 2c20 4b65 793d 6b65 7929 0a20  cket, Key=key). 
+0000ab50: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000ab60: 6e20 6469 6374 280a 2020 2020 2020 2020  n dict(.        
+0000ab70: 2020 2020 2020 2020 286b 6579 2e6c 6f77          (key.low
+0000ab80: 6572 2829 2c20 7661 6c75 6529 2066 6f72  er(), value) for
+0000ab90: 206b 6579 2c20 7661 6c75 6520 696e 2072   key, value in r
+0000aba0: 6573 705b 274d 6574 6164 6174 6127 5d2e  esp['Metadata'].
+0000abb0: 6974 656d 7328 2929 0a20 2020 2020 2020  items()).       
+0000abc0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+0000abd0: 6e20 6173 2065 7272 6f72 3a0a 2020 2020  n as error:.    
+0000abe0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+0000abf0: 7461 6e63 6528 6572 726f 722c 0a20 2020  tance(error,.   
+0000ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ac10: 2020 2020 2020 2028 5333 556e 6b6e 6f77         (S3Unknow
+0000ac20: 6e45 7272 6f72 2c20 5333 436f 6e66 6967  nError, S3Config
+0000ac30: 4572 726f 722c 2053 3350 6572 6d69 7373  Error, S3Permiss
+0000ac40: 696f 6e45 7272 6f72 2929 3a0a 2020 2020  ionError)):.    
+0000ac50: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000ac60: 6520 6572 726f 720a 2020 2020 2020 2020  e error.        
+0000ac70: 2020 2020 7265 7475 726e 207b 7d0a 0a20      return {}.. 
+0000ac80: 2020 2064 6566 2061 6363 6573 7328 0a20     def access(. 
+0000ac90: 2020 2020 2020 2020 2020 2073 656c 662c             self,
+0000aca0: 206d 6f64 653a 2041 6363 6573 7320 3d20   mode: Access = 
+0000acb0: 4163 6365 7373 2e52 4541 442c 0a20 2020  Access.READ,.   
+0000acc0: 2020 2020 2020 2020 2066 6f6c 6c6f 776c           followl
+0000acd0: 696e 6b73 3a20 626f 6f6c 203d 2046 616c  inks: bool = Fal
+0000ace0: 7365 2920 2d3e 2062 6f6f 6c3a 0a20 2020  se) -> bool:.   
+0000acf0: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
+0000ad00: 2054 6573 7420 6966 2070 6174 6820 6861   Test if path ha
+0000ad10: 7320 6163 6365 7373 2070 6572 6d69 7373  s access permiss
+0000ad20: 696f 6e20 6465 7363 7269 6265 6420 6279  ion described by
+0000ad30: 206d 6f64 650a 2020 2020 2020 2020 5573   mode.        Us
+0000ad40: 696e 6720 6865 6164 5f62 7563 6b65 7428  ing head_bucket(
+0000ad50: 292c 206e 6f77 2052 4541 442f 5752 4954  ), now READ/WRIT
+0000ad60: 4520 6172 6520 7361 6d65 2e0a 0a20 2020  E are same...   
+0000ad70: 2020 2020 203a 7061 7261 6d20 6d6f 6465       :param mode
+0000ad80: 3a20 6163 6365 7373 206d 6f64 650a 2020  : access mode.  
+0000ad90: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
+0000ada0: 626f 6f6c 2c20 6966 2074 6865 2062 7563  bool, if the buc
+0000adb0: 6b65 7420 6f66 2073 335f 7572 6c20 6861  ket of s3_url ha
+0000adc0: 7320 7265 6164 2f77 7269 7465 2061 6363  s read/write acc
+0000add0: 6573 732e 0a20 2020 2020 2020 2027 2727  ess..        '''
+0000ade0: 0a20 2020 2020 2020 2073 335f 7572 6c20  .        s3_url 
+0000adf0: 3d20 7365 6c66 2e70 6174 685f 7769 7468  = self.path_with
+0000ae00: 5f70 726f 746f 636f 6c0a 2020 2020 2020  _protocol.      
+0000ae10: 2020 6966 2066 6f6c 6c6f 776c 696e 6b73    if followlinks
+0000ae20: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
+0000ae30: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0000ae40: 2020 2073 335f 7572 6c20 3d20 7365 6c66     s3_url = self
+0000ae50: 2e72 6561 646c 696e 6b28 292e 7061 7468  .readlink().path
+0000ae60: 5f77 6974 685f 7072 6f74 6f63 6f6c 0a20  _with_protocol. 
+0000ae70: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0000ae80: 7420 5333 4e6f 7441 4c69 6e6b 4572 726f  t S3NotALinkErro
+0000ae90: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+0000aea0: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
+0000aeb0: 6275 636b 6574 2c20 5f20 3d20 7061 7273  bucket, _ = pars
+0000aec0: 655f 7333 5f75 726c 2873 335f 7572 6c29  e_s3_url(s3_url)
+0000aed0: 2020 2320 6f6e 6c79 2063 6865 636b 2062    # only check b
+0000aee0: 7563 6b65 7420 6163 6365 7373 6962 696c  ucket accessibil
+0000aef0: 6974 790a 2020 2020 2020 2020 6966 206e  ity.        if n
+0000af00: 6f74 2062 7563 6b65 743a 0a20 2020 2020  ot bucket:.     
+0000af10: 2020 2020 2020 2072 6169 7365 2045 7863         raise Exc
+0000af20: 6570 7469 6f6e 2822 4e6f 2061 7661 696c  eption("No avail
+0000af30: 6162 6c65 2062 7563 6b65 7422 290a 2020  able bucket").  
+0000af40: 2020 2020 2020 6966 206e 6f74 2069 7369        if not isi
+0000af50: 6e73 7461 6e63 6528 6d6f 6465 2c20 4163  nstance(mode, Ac
+0000af60: 6365 7373 293a 0a20 2020 2020 2020 2020  cess):.         
+0000af70: 2020 2072 6169 7365 2054 7970 6545 7272     raise TypeErr
+0000af80: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+0000af90: 2020 2020 2755 6e73 7570 706f 7274 6564      'Unsupported
+0000afa0: 206d 6f64 653a 207b 7d20 2d2d 204d 6f64   mode: {} -- Mod
+0000afb0: 6520 7368 6f75 6c64 2075 7365 206f 6e65  e should use one
+0000afc0: 206f 6620 7468 6520 656e 756d 7320 6265   of the enums be
+0000afd0: 6c6f 6e67 696e 6720 746f 3a20 207b 7d27  longing to:  {}'
+0000afe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000aff0: 202e 666f 726d 6174 286d 6f64 652c 2027   .format(mode, '
+0000b000: 2c20 272e 6a6f 696e 285b 7374 7228 6129  , '.join([str(a)
+0000b010: 2066 6f72 2061 2069 6e20 4163 6365 7373   for a in Access
+0000b020: 5d29 2929 0a20 2020 2020 2020 2069 6620  ]))).        if 
+0000b030: 6d6f 6465 206e 6f74 2069 6e20 2841 6363  mode not in (Acc
+0000b040: 6573 732e 5245 4144 2c20 4163 6365 7373  ess.READ, Access
+0000b050: 2e57 5249 5445 293a 0a20 2020 2020 2020  .WRITE):.       
+0000b060: 2020 2020 2072 6169 7365 2054 7970 6545       raise TypeE
+0000b070: 7272 6f72 2827 556e 7375 7070 6f72 7465  rror('Unsupporte
+0000b080: 6420 6d6f 6465 3a20 7b7d 272e 666f 726d  d mode: {}'.form
+0000b090: 6174 286d 6f64 6529 290a 2020 2020 2020  at(mode)).      
+0000b0a0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0000b0b0: 2020 2073 656c 662e 5f63 6c69 656e 742e     self._client.
+0000b0c0: 6865 6164 5f62 7563 6b65 7428 4275 636b  head_bucket(Buck
+0000b0d0: 6574 3d62 7563 6b65 7429 0a20 2020 2020  et=bucket).     
+0000b0e0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+0000b0f0: 696f 6e20 6173 2065 7272 6f72 3a0a 2020  ion as error:.  
+0000b100: 2020 2020 2020 2020 2020 6572 726f 7220            error 
+0000b110: 3d20 7472 616e 736c 6174 655f 7333 5f65  = translate_s3_e
+0000b120: 7272 6f72 2865 7272 6f72 2c20 7333 5f75  rror(error, s3_u
+0000b130: 726c 290a 2020 2020 2020 2020 2020 2020  rl).            
+0000b140: 6966 2069 7369 6e73 7461 6e63 6528 6572  if isinstance(er
+0000b150: 726f 722c 2028 5333 5065 726d 6973 7369  ror, (S3Permissi
+0000b160: 6f6e 4572 726f 722c 2053 3346 696c 654e  onError, S3FileN
+0000b170: 6f74 466f 756e 6445 7272 6f72 2c0a 2020  otFoundError,.  
+0000b180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b1a0: 5333 4275 636b 6574 4e6f 7446 6f75 6e64  S3BucketNotFound
+0000b1b0: 4572 726f 7229 293a 0a20 2020 2020 2020  Error)):.       
+0000b1c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000b1d0: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
+0000b1e0: 2020 7261 6973 6520 6572 726f 720a 2020    raise error.  
+0000b1f0: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
+0000b200: 650a 0a20 2020 2064 6566 2065 7869 7374  e..    def exist
+0000b210: 7328 7365 6c66 2c20 666f 6c6c 6f77 6c69  s(self, followli
+0000b220: 6e6b 733a 2062 6f6f 6c20 3d20 4661 6c73  nks: bool = Fals
+0000b230: 6529 202d 3e20 626f 6f6c 3a0a 2020 2020  e) -> bool:.    
+0000b240: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
+0000b250: 5465 7374 2069 6620 7333 5f75 726c 2065  Test if s3_url e
+0000b260: 7869 7374 730a 0a20 2020 2020 2020 2049  xists..        I
+0000b270: 6620 7468 6520 6275 636b 6574 206f 6620  f the bucket of 
+0000b280: 7333 5f75 726c 2061 7265 206e 6f74 2070  s3_url are not p
+0000b290: 6572 6d69 7474 6564 2074 6f20 7265 6164  ermitted to read
+0000b2a0: 2c20 7265 7475 726e 2046 616c 7365 0a0a  , return False..
+0000b2b0: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
+0000b2c0: 3a20 5472 7565 2069 6620 7333 5f75 726c  : True if s3_url
+0000b2d0: 2065 6978 7374 732c 2065 6c73 6520 4661   eixsts, else Fa
+0000b2e0: 6c73 650a 2020 2020 2020 2020 2727 270a  lse.        '''.
+0000b2f0: 2020 2020 2020 2020 6275 636b 6574 2c20          bucket, 
+0000b300: 6b65 7920 3d20 7061 7273 655f 7333 5f75  key = parse_s3_u
+0000b310: 726c 2873 656c 662e 7061 7468 5f77 6974  rl(self.path_wit
+0000b320: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
+0000b330: 2020 2020 6966 206e 6f74 2062 7563 6b65      if not bucke
+0000b340: 743a 2020 2320 7333 3a2f 2f20 3d3e 2054  t:  # s3:// => T
+0000b350: 7275 652c 2073 333a 2f2f 2f6b 6579 203d  rue, s3:///key =
+0000b360: 3e20 4661 6c73 650a 2020 2020 2020 2020  > False.        
+0000b370: 2020 2020 7265 7475 726e 206e 6f74 206b      return not k
+0000b380: 6579 0a0a 2020 2020 2020 2020 7265 7475  ey..        retu
+0000b390: 726e 2073 656c 662e 6973 5f64 6972 2829  rn self.is_dir()
+0000b3a0: 206f 7220 7365 6c66 2e69 735f 6669 6c65   or self.is_file
+0000b3b0: 2866 6f6c 6c6f 776c 696e 6b73 290a 0a20  (followlinks).. 
+0000b3c0: 2020 2064 6566 2067 6574 6d74 696d 6528     def getmtime(
+0000b3d0: 7365 6c66 2c20 666f 6c6c 6f77 5f73 796d  self, follow_sym
+0000b3e0: 6c69 6e6b 733a 2062 6f6f 6c20 3d20 4661  links: bool = Fa
+0000b3f0: 6c73 6529 202d 3e20 666c 6f61 743a 0a20  lse) -> float:. 
+0000b400: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+0000b410: 2020 2047 6574 206c 6173 742d 6d6f 6469     Get last-modi
+0000b420: 6669 6564 2074 696d 6520 6f66 2074 6865  fied time of the
+0000b430: 2066 696c 6520 6f6e 2074 6865 2067 6976   file on the giv
+0000b440: 656e 2073 335f 7572 6c20 7061 7468 2028  en s3_url path (
+0000b450: 696e 2055 6e69 7820 7469 6d65 7374 616d  in Unix timestam
+0000b460: 7020 666f 726d 6174 292e 0a20 2020 2020  p format)..     
+0000b470: 2020 2049 6620 7468 6520 7061 7468 2069     If the path i
+0000b480: 7320 616e 2065 7869 7374 656e 7420 6469  s an existent di
+0000b490: 7265 6374 6f72 792c 2072 6574 7572 6e20  rectory, return 
+0000b4a0: 7468 6520 6c61 7465 7374 206d 6f64 6966  the latest modif
+0000b4b0: 6965 6420 7469 6d65 206f 6620 616c 6c20  ied time of all 
+0000b4c0: 6669 6c65 2069 6e20 6974 2e20 5468 6520  file in it. The 
+0000b4d0: 6d74 696d 6520 6f66 2065 6d70 7479 2064  mtime of empty d
+0000b4e0: 6972 6563 746f 7279 2069 7320 3139 3730  irectory is 1970
+0000b4f0: 2d30 312d 3031 2030 303a 3030 3a30 300a  -01-01 00:00:00.
+0000b500: 0a20 2020 2020 2020 2049 6620 7333 5f75  .        If s3_u
+0000b510: 726c 2069 7320 6e6f 7420 616e 2065 7869  rl is not an exi
+0000b520: 7374 656e 7420 7061 7468 2c20 7768 6963  stent path, whic
+0000b530: 6820 6d65 616e 7320 7333 5f65 7869 7374  h means s3_exist
+0000b540: 2873 335f 7572 6c29 2072 6574 7572 6e73  (s3_url) returns
+0000b550: 2046 616c 7365 2c20 7468 656e 2072 6169   False, then rai
+0000b560: 7365 2053 3346 696c 654e 6f74 466f 756e  se S3FileNotFoun
+0000b570: 6445 7272 6f72 0a0a 2020 2020 2020 2020  dError..        
+0000b580: 3a72 6574 7572 6e73 3a20 4c61 7374 2d6d  :returns: Last-m
+0000b590: 6f64 6966 6965 6420 7469 6d65 0a20 2020  odified time.   
+0000b5a0: 2020 2020 203a 7261 6973 6573 3a20 5333       :raises: S3
+0000b5b0: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
+0000b5c0: 722c 2055 6e73 7570 706f 7274 6564 4572  r, UnsupportedEr
+0000b5d0: 726f 720a 2020 2020 2020 2020 2727 270a  ror.        '''.
+0000b5e0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0000b5f0: 656c 662e 7374 6174 2866 6f6c 6c6f 775f  elf.stat(follow_
+0000b600: 7379 6d6c 696e 6b73 3d66 6f6c 6c6f 775f  symlinks=follow_
+0000b610: 7379 6d6c 696e 6b73 292e 6d74 696d 650a  symlinks).mtime.
+0000b620: 0a20 2020 2064 6566 2067 6574 7369 7a65  .    def getsize
+0000b630: 2873 656c 662c 2066 6f6c 6c6f 775f 7379  (self, follow_sy
+0000b640: 6d6c 696e 6b73 3a20 626f 6f6c 203d 2046  mlinks: bool = F
+0000b650: 616c 7365 2920 2d3e 2069 6e74 3a0a 2020  alse) -> int:.  
+0000b660: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
+0000b670: 2020 4765 7420 6669 6c65 2073 697a 6520    Get file size 
+0000b680: 6f6e 2074 6865 2067 6976 656e 2073 335f  on the given s3_
+0000b690: 7572 6c20 7061 7468 2028 696e 2062 7974  url path (in byt
+0000b6a0: 6573 292e 0a20 2020 2020 2020 2049 6620  es)..        If 
+0000b6b0: 7468 6520 7061 7468 2069 6e20 6120 6469  the path in a di
+0000b6c0: 7265 6374 6f72 792c 2072 6574 7572 6e20  rectory, return 
+0000b6d0: 7468 6520 7375 6d20 6f66 2061 6c6c 2066  the sum of all f
+0000b6e0: 696c 6520 7369 7a65 2069 6e20 6974 2c20  ile size in it, 
+0000b6f0: 696e 636c 7564 696e 6720 6669 6c65 2069  including file i
+0000b700: 6e20 7375 6264 6972 6563 746f 7269 6573  n subdirectories
+0000b710: 2028 6966 2065 7869 7374 292e 0a20 2020   (if exist)..   
+0000b720: 2020 2020 2054 6865 2072 6573 756c 7420       The result 
+0000b730: 6578 636c 7564 6573 2074 6865 2073 697a  excludes the siz
+0000b740: 6520 6f66 2064 6972 6563 746f 7279 2069  e of directory i
+0000b750: 7473 656c 662e 2049 6e20 6f74 6865 7220  tself. In other 
+0000b760: 776f 7264 732c 2072 6574 7572 6e20 3020  words, return 0 
+0000b770: 4279 7465 206f 6e20 616e 2065 6d70 7479  Byte on an empty
+0000b780: 2064 6972 6563 746f 7279 2070 6174 682e   directory path.
+0000b790: 0a0a 2020 2020 2020 2020 4966 2073 335f  ..        If s3_
+0000b7a0: 7572 6c20 6973 206e 6f74 2061 6e20 6578  url is not an ex
+0000b7b0: 6973 7465 6e74 2070 6174 682c 2077 6869  istent path, whi
+0000b7c0: 6368 206d 6561 6e73 2073 335f 6578 6973  ch means s3_exis
+0000b7d0: 7428 7333 5f75 726c 2920 7265 7475 726e  t(s3_url) return
+0000b7e0: 7320 4661 6c73 652c 2074 6865 6e20 7261  s False, then ra
+0000b7f0: 6973 6520 5333 4669 6c65 4e6f 7446 6f75  ise S3FileNotFou
+0000b800: 6e64 4572 726f 720a 0a20 2020 2020 2020  ndError..       
+0000b810: 203a 7265 7475 726e 733a 2046 696c 6520   :returns: File 
+0000b820: 7369 7a65 0a20 2020 2020 2020 203a 7261  size.        :ra
+0000b830: 6973 6573 3a20 5333 4669 6c65 4e6f 7446  ises: S3FileNotF
+0000b840: 6f75 6e64 4572 726f 722c 2055 6e73 7570  oundError, Unsup
+0000b850: 706f 7274 6564 4572 726f 720a 2020 2020  portedError.    
+0000b860: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
+0000b870: 7265 7475 726e 2073 656c 662e 7374 6174  return self.stat
+0000b880: 2866 6f6c 6c6f 775f 7379 6d6c 696e 6b73  (follow_symlinks
+0000b890: 3d66 6f6c 6c6f 775f 7379 6d6c 696e 6b73  =follow_symlinks
+0000b8a0: 292e 7369 7a65 0a0a 2020 2020 6465 6620  ).size..    def 
+0000b8b0: 676c 6f62 280a 2020 2020 2020 2020 2020  glob(.          
+0000b8c0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+0000b8d0: 2020 2020 7061 7474 6572 6e2c 0a20 2020      pattern,.   
+0000b8e0: 2020 2020 2020 2020 2072 6563 7572 7369           recursi
+0000b8f0: 7665 3a20 626f 6f6c 203d 2054 7275 652c  ve: bool = True,
+0000b900: 0a20 2020 2020 2020 2020 2020 206d 6973  .            mis
+0000b910: 7369 6e67 5f6f 6b3a 2062 6f6f 6c20 3d20  sing_ok: bool = 
+0000b920: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+0000b930: 2020 666f 6c6c 6f77 6c69 6e6b 733a 2062    followlinks: b
+0000b940: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+0000b950: 2029 202d 3e20 4c69 7374 5b27 5333 5061   ) -> List['S3Pa
+0000b960: 7468 275d 3a0a 2020 2020 2020 2020 2727  th']:.        ''
+0000b970: 2752 6574 7572 6e20 7333 2070 6174 6820  'Return s3 path 
+0000b980: 6c69 7374 2069 6e20 6173 6365 6e64 696e  list in ascendin
+0000b990: 6720 616c 7068 6162 6574 6963 616c 206f  g alphabetical o
+0000b9a0: 7264 6572 2c20 696e 2077 6869 6368 2070  rder, in which p
+0000b9b0: 6174 6820 6d61 7463 6865 7320 676c 6f62  ath matches glob
+0000b9c0: 2070 6174 7465 726e 0a20 2020 2020 2020   pattern.       
+0000b9d0: 204e 6f74 6573 3a20 4f6e 6c79 2067 6c6f   Notes: Only glo
+0000b9e0: 6220 696e 2062 7563 6b65 742e 2049 6620  b in bucket. If 
+0000b9f0: 7472 7969 6e67 2074 6f20 6d61 7463 6820  trying to match 
+0000ba00: 6275 636b 6574 2077 6974 6820 7769 6c64  bucket with wild
+0000ba10: 6361 7264 2063 6861 7261 6374 6572 732c  card characters,
+0000ba20: 2072 6169 7365 2055 6e73 7570 706f 7274   raise Unsupport
+0000ba30: 6564 4572 726f 720a 0a20 2020 2020 2020  edError..       
+0000ba40: 203a 7061 7261 6d20 7061 7474 6572 6e3a   :param pattern:
+0000ba50: 2047 6c6f 6220 7468 6520 6769 7665 6e20   Glob the given 
+0000ba60: 7265 6c61 7469 7665 2070 6174 7465 726e  relative pattern
+0000ba70: 2069 6e20 7468 6520 6469 7265 6374 6f72   in the director
+0000ba80: 7920 7265 7072 6573 656e 7465 6420 6279  y represented by
+0000ba90: 2074 6869 7320 7061 7468 0a20 2020 2020   this path.     
+0000baa0: 2020 203a 7061 7261 6d20 7265 6375 7273     :param recurs
+0000bab0: 6976 653a 2049 6620 4661 6c73 652c 2060  ive: If False, `
+0000bac0: 2a2a 6020 7769 6c6c 206e 6f74 2073 6561  **` will not sea
+0000bad0: 7263 6820 6469 7265 6374 6f72 7920 7265  rch directory re
+0000bae0: 6375 7273 6976 656c 790a 2020 2020 2020  cursively.      
+0000baf0: 2020 3a70 6172 616d 206d 6973 7369 6e67    :param missing
+0000bb00: 5f6f 6b3a 2049 6620 4661 6c73 6520 616e  _ok: If False an
+0000bb10: 6420 7461 7267 6574 2070 6174 6820 646f  d target path do
+0000bb20: 6573 6e27 7420 6d61 7463 6820 616e 7920  esn't match any 
+0000bb30: 6669 6c65 2c20 7261 6973 6520 4669 6c65  file, raise File
+0000bb40: 4e6f 7446 6f75 6e64 4572 726f 720a 2020  NotFoundError.  
+0000bb50: 2020 2020 2020 3a72 6169 7365 733a 2055        :raises: U
+0000bb60: 6e73 7570 706f 7274 6564 4572 726f 722c  nsupportedError,
+0000bb70: 2077 6865 6e20 6275 636b 6574 2070 6172   when bucket par
+0000bb80: 7420 636f 6e74 6169 6e73 2077 696c 6463  t contains wildc
+0000bb90: 6172 6420 6368 6172 6163 7465 7273 0a20  ard characters. 
+0000bba0: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
+0000bbb0: 2041 206c 6973 7420 636f 6e74 6169 6e73   A list contains
+0000bbc0: 2070 6174 6873 206d 6174 6368 2060 7333   paths match `s3
+0000bbd0: 5f70 6174 686e 616d 6560 0a20 2020 2020  _pathname`.     
+0000bbe0: 2020 2027 2727 0a20 2020 2020 2020 2072     '''.        r
+0000bbf0: 6574 7572 6e20 6c69 7374 280a 2020 2020  eturn list(.    
+0000bc00: 2020 2020 2020 2020 7365 6c66 2e69 676c          self.igl
+0000bc10: 6f62 280a 2020 2020 2020 2020 2020 2020  ob(.            
+0000bc20: 2020 2020 7061 7474 6572 6e3d 7061 7474      pattern=patt
+0000bc30: 6572 6e2c 0a20 2020 2020 2020 2020 2020  ern,.           
+0000bc40: 2020 2020 2072 6563 7572 7369 7665 3d72       recursive=r
+0000bc50: 6563 7572 7369 7665 2c0a 2020 2020 2020  ecursive,.      
+0000bc60: 2020 2020 2020 2020 2020 6d69 7373 696e            missin
+0000bc70: 675f 6f6b 3d6d 6973 7369 6e67 5f6f 6b2c  g_ok=missing_ok,
+0000bc80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bc90: 2066 6f6c 6c6f 776c 696e 6b73 3d66 6f6c   followlinks=fol
+0000bca0: 6c6f 776c 696e 6b73 2929 0a0a 2020 2020  lowlinks))..    
+0000bcb0: 6465 6620 676c 6f62 5f73 7461 7428 0a20  def glob_stat(. 
+0000bcc0: 2020 2020 2020 2020 2020 2073 656c 662c             self,
+0000bcd0: 0a20 2020 2020 2020 2020 2020 2070 6174  .            pat
+0000bce0: 7465 726e 2c0a 2020 2020 2020 2020 2020  tern,.          
+0000bcf0: 2020 7265 6375 7273 6976 653a 2062 6f6f    recursive: boo
+0000bd00: 6c20 3d20 5472 7565 2c0a 2020 2020 2020  l = True,.      
+0000bd10: 2020 2020 2020 6d69 7373 696e 675f 6f6b        missing_ok
+0000bd20: 3a20 626f 6f6c 203d 2054 7275 652c 0a20  : bool = True,. 
+0000bd30: 2020 2020 2020 2020 2020 2066 6f6c 6c6f             follo
+0000bd40: 776c 696e 6b73 3a20 626f 6f6c 203d 2046  wlinks: bool = F
+0000bd50: 616c 7365 2920 2d3e 2049 7465 7261 746f  alse) -> Iterato
+0000bd60: 725b 4669 6c65 456e 7472 795d 3a0a 2020  r[FileEntry]:.  
+0000bd70: 2020 2020 2020 2727 2752 6574 7572 6e20        '''Return 
+0000bd80: 6120 6765 6e65 7261 746f 7220 636f 6e74  a generator cont
+0000bd90: 6169 6e73 2074 7570 6c65 7320 6f66 2070  ains tuples of p
+0000bda0: 6174 6820 616e 6420 6669 6c65 2073 7461  ath and file sta
+0000bdb0: 742c 2069 6e20 6173 6365 6e64 696e 6720  t, in ascending 
+0000bdc0: 616c 7068 6162 6574 6963 616c 206f 7264  alphabetical ord
+0000bdd0: 6572 2c20 696e 2077 6869 6368 2070 6174  er, in which pat
+0000bde0: 6820 6d61 7463 6865 7320 676c 6f62 2070  h matches glob p
+0000bdf0: 6174 7465 726e 0a20 2020 2020 2020 204e  attern.        N
+0000be00: 6f74 6573 3a20 4f6e 6c79 2067 6c6f 6220  otes: Only glob 
+0000be10: 696e 2062 7563 6b65 742e 2049 6620 7472  in bucket. If tr
+0000be20: 7969 6e67 2074 6f20 6d61 7463 6820 6275  ying to match bu
+0000be30: 636b 6574 2077 6974 6820 7769 6c64 6361  cket with wildca
+0000be40: 7264 2063 6861 7261 6374 6572 732c 2072  rd characters, r
+0000be50: 6169 7365 2055 6e73 7570 706f 7274 6564  aise Unsupported
+0000be60: 4572 726f 720a 0a20 2020 2020 2020 203a  Error..        :
+0000be70: 7061 7261 6d20 7061 7474 6572 6e3a 2047  param pattern: G
+0000be80: 6c6f 6220 7468 6520 6769 7665 6e20 7265  lob the given re
+0000be90: 6c61 7469 7665 2070 6174 7465 726e 2069  lative pattern i
+0000bea0: 6e20 7468 6520 6469 7265 6374 6f72 7920  n the directory 
+0000beb0: 7265 7072 6573 656e 7465 6420 6279 2074  represented by t
+0000bec0: 6869 7320 7061 7468 0a20 2020 2020 2020  his path.       
+0000bed0: 203a 7061 7261 6d20 7265 6375 7273 6976   :param recursiv
+0000bee0: 653a 2049 6620 4661 6c73 652c 2060 2a2a  e: If False, `**
+0000bef0: 6020 7769 6c6c 206e 6f74 2073 6561 7263  ` will not searc
+0000bf00: 6820 6469 7265 6374 6f72 7920 7265 6375  h directory recu
+0000bf10: 7273 6976 656c 790a 2020 2020 2020 2020  rsively.        
+0000bf20: 3a70 6172 616d 206d 6973 7369 6e67 5f6f  :param missing_o
+0000bf30: 6b3a 2049 6620 4661 6c73 6520 616e 6420  k: If False and 
+0000bf40: 7461 7267 6574 2070 6174 6820 646f 6573  target path does
+0000bf50: 6e27 7420 6d61 7463 6820 616e 7920 6669  n't match any fi
+0000bf60: 6c65 2c20 7261 6973 6520 4669 6c65 4e6f  le, raise FileNo
+0000bf70: 7446 6f75 6e64 4572 726f 720a 2020 2020  tFoundError.    
+0000bf80: 2020 2020 3a72 6169 7365 733a 2055 6e73      :raises: Uns
+0000bf90: 7570 706f 7274 6564 4572 726f 722c 2077  upportedError, w
+0000bfa0: 6865 6e20 6275 636b 6574 2070 6172 7420  hen bucket part 
+0000bfb0: 636f 6e74 6169 6e73 2077 696c 6463 6172  contains wildcar
+0000bfc0: 6420 6368 6172 6163 7465 7273 0a20 2020  d characters.   
+0000bfd0: 2020 2020 203a 7265 7475 726e 733a 2041       :returns: A
+0000bfe0: 2067 656e 6572 6174 6f72 2063 6f6e 7461   generator conta
+0000bff0: 696e 7320 7475 706c 6573 206f 6620 7061  ins tuples of pa
+0000c000: 7468 2061 6e64 2066 696c 6520 7374 6174  th and file stat
+0000c010: 2c20 696e 2077 6869 6368 2070 6174 6873  , in which paths
+0000c020: 206d 6174 6368 2060 7333 5f70 6174 686e   match `s3_pathn
+0000c030: 616d 6560 0a20 2020 2020 2020 2027 2727  ame`.        '''
+0000c040: 0a20 2020 2020 2020 2067 6c6f 625f 7061  .        glob_pa
+0000c050: 7468 203d 2073 656c 662e 5f73 335f 7061  th = self._s3_pa
+0000c060: 7468 0a20 2020 2020 2020 2069 6620 7061  th.        if pa
+0000c070: 7474 6572 6e3a 0a20 2020 2020 2020 2020  ttern:.         
+0000c080: 2020 2067 6c6f 625f 7061 7468 203d 2073     glob_path = s
+0000c090: 656c 662e 6a6f 696e 7061 7468 2870 6174  elf.joinpath(pat
+0000c0a0: 7465 726e 292e 5f73 335f 7061 7468 2020  tern)._s3_path  
+0000c0b0: 2320 7079 7479 7065 3a20 6469 7361 626c  # pytype: disabl
+0000c0c0: 653d 6174 7472 6962 7574 652d 6572 726f  e=attribute-erro
+0000c0d0: 720a 2020 2020 2020 2020 7333 5f70 6174  r.        s3_pat
+0000c0e0: 686e 616d 6520 3d20 6673 7061 7468 2867  hname = fspath(g
+0000c0f0: 6c6f 625f 7061 7468 290a 0a20 2020 2020  lob_path)..     
+0000c100: 2020 2064 6566 2063 7265 6174 655f 6765     def create_ge
+0000c110: 6e65 7261 746f 7228 293a 0a20 2020 2020  nerator():.     
+0000c120: 2020 2020 2020 2066 6f72 2067 726f 7570         for group
+0000c130: 5f73 335f 7061 7468 6e61 6d65 5f31 2069  _s3_pathname_1 i
+0000c140: 6e20 5f67 726f 7570 5f73 3370 6174 685f  n _group_s3path_
+0000c150: 6279 5f62 7563 6b65 7428 0a20 2020 2020  by_bucket(.     
+0000c160: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000c170: 335f 7061 7468 6e61 6d65 2c20 7365 6c66  3_pathname, self
+0000c180: 2e5f 7072 6f66 696c 655f 6e61 6d65 293a  ._profile_name):
+0000c190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c1a0: 2066 6f72 2067 726f 7570 5f73 335f 7061   for group_s3_pa
+0000c1b0: 7468 6e61 6d65 5f32 2069 6e20 5f67 726f  thname_2 in _gro
+0000c1c0: 7570 5f73 3370 6174 685f 6279 5f70 7265  up_s3path_by_pre
+0000c1d0: 6669 7828 0a20 2020 2020 2020 2020 2020  fix(.           
+0000c1e0: 2020 2020 2020 2020 2020 2020 2067 726f               gro
+0000c1f0: 7570 5f73 335f 7061 7468 6e61 6d65 5f31  up_s3_pathname_1
+0000c200: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000c210: 2020 2020 2020 2066 6f72 2066 696c 655f         for file_
+0000c220: 656e 7472 7920 696e 205f 7333 5f67 6c6f  entry in _s3_glo
+0000c230: 625f 7374 6174 5f73 696e 676c 655f 7061  b_stat_single_pa
+0000c240: 7468 280a 2020 2020 2020 2020 2020 2020  th(.            
+0000c250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c260: 6772 6f75 705f 7333 5f70 6174 686e 616d  group_s3_pathnam
+0000c270: 655f 322c 2072 6563 7572 7369 7665 2c20  e_2, recursive, 
+0000c280: 6d69 7373 696e 675f 6f6b 2c0a 2020 2020  missing_ok,.    
+0000c290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c2a0: 2020 2020 2020 2020 666f 6c6c 6f77 6c69          followli
+0000c2b0: 6e6b 733d 666f 6c6c 6f77 6c69 6e6b 732c  nks=followlinks,
+0000c2c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c2d0: 2020 2020 2020 2020 2020 2020 2070 726f               pro
+0000c2e0: 6669 6c65 5f6e 616d 653d 7365 6c66 2e5f  file_name=self._
+0000c2f0: 7072 6f66 696c 655f 6e61 6d65 293a 0a20  profile_name):. 
+0000c300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c310: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
+0000c320: 7072 6f66 696c 655f 6e61 6d65 3a0a 2020  profile_name:.  
+0000c330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c340: 2020 2020 2020 2020 2020 6669 6c65 5f65            file_e
+0000c350: 6e74 7279 203d 2066 696c 655f 656e 7472  ntry = file_entr
+0000c360: 792e 5f72 6570 6c61 6365 280a 2020 2020  y._replace(.    
+0000c370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c380: 2020 2020 2020 2020 2020 2020 7061 7468              path
+0000c390: 3d0a 2020 2020 2020 2020 2020 2020 2020  =.              
+0000c3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c3b0: 2020 6622 7b73 656c 662e 5f70 726f 746f    f"{self._proto
+0000c3c0: 636f 6c5f 7769 7468 5f70 726f 6669 6c65  col_with_profile
+0000c3d0: 7d3a 2f2f 7b66 696c 655f 656e 7472 792e  }://{file_entry.
+0000c3e0: 7061 7468 5b35 3a5d 7d22 0a20 2020 2020  path[5:]}".     
 0000c3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c400: 2020 2020 2020 2020 2020 2020 2070 6174               pat
-0000c410: 683d 0a20 2020 2020 2020 2020 2020 2020  h=.             
-0000c420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c430: 2020 2066 227b 7365 6c66 2e5f 7072 6f74     f"{self._prot
-0000c440: 6f63 6f6c 5f77 6974 685f 7072 6f66 696c  ocol_with_profil
-0000c450: 657d 3a2f 2f7b 6669 6c65 5f65 6e74 7279  e}://{file_entry
-0000c460: 2e70 6174 685b 353a 5d7d 220a 2020 2020  .path[5:]}".    
-0000c470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c480: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000c490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c4a0: 2020 7969 656c 6420 6669 6c65 5f65 6e74    yield file_ent
-0000c4b0: 7279 0a0a 2020 2020 2020 2020 7265 7475  ry..        retu
-0000c4c0: 726e 205f 6372 6561 7465 5f6d 6973 7369  rn _create_missi
-0000c4d0: 6e67 5f6f 6b5f 6765 6e65 7261 746f 7228  ng_ok_generator(
-0000c4e0: 0a20 2020 2020 2020 2020 2020 2063 7265  .            cre
-0000c4f0: 6174 655f 6765 6e65 7261 746f 7228 292c  ate_generator(),
-0000c500: 206d 6973 7369 6e67 5f6f 6b2c 0a20 2020   missing_ok,.   
-0000c510: 2020 2020 2020 2020 2053 3346 696c 654e           S3FileN
-0000c520: 6f74 466f 756e 6445 7272 6f72 2827 4e6f  otFoundError('No
-0000c530: 206d 6174 6368 2066 696c 653a 2025 7227   match file: %r'
-0000c540: 2025 2073 335f 7061 7468 6e61 6d65 2929   % s3_pathname))
-0000c550: 0a0a 2020 2020 6465 6620 6967 6c6f 6228  ..    def iglob(
-0000c560: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000c570: 662c 0a20 2020 2020 2020 2020 2020 2070  f,.            p
-0000c580: 6174 7465 726e 2c0a 2020 2020 2020 2020  attern,.        
-0000c590: 2020 2020 7265 6375 7273 6976 653a 2062      recursive: b
-0000c5a0: 6f6f 6c20 3d20 5472 7565 2c0a 2020 2020  ool = True,.    
-0000c5b0: 2020 2020 2020 2020 6d69 7373 696e 675f          missing_
-0000c5c0: 6f6b 3a20 626f 6f6c 203d 2054 7275 652c  ok: bool = True,
-0000c5d0: 0a20 2020 2020 2020 2020 2020 2066 6f6c  .            fol
-0000c5e0: 6c6f 776c 696e 6b73 3a20 626f 6f6c 203d  lowlinks: bool =
-0000c5f0: 2046 616c 7365 2c0a 2020 2020 2920 2d3e   False,.    ) ->
-0000c600: 2049 7465 7261 746f 725b 2753 3350 6174   Iterator['S3Pat
-0000c610: 6827 5d3a 0a20 2020 2020 2020 2027 2727  h']:.        '''
-0000c620: 5265 7475 726e 2073 3320 7061 7468 2069  Return s3 path i
-0000c630: 7465 7261 746f 7220 696e 2061 7363 656e  terator in ascen
-0000c640: 6469 6e67 2061 6c70 6861 6265 7469 6361  ding alphabetica
-0000c650: 6c20 6f72 6465 722c 2069 6e20 7768 6963  l order, in whic
-0000c660: 6820 7061 7468 206d 6174 6368 6573 2067  h path matches g
-0000c670: 6c6f 6220 7061 7474 6572 6e0a 2020 2020  lob pattern.    
-0000c680: 2020 2020 4e6f 7465 733a 204f 6e6c 7920      Notes: Only 
-0000c690: 676c 6f62 2069 6e20 6275 636b 6574 2e20  glob in bucket. 
-0000c6a0: 4966 2074 7279 696e 6720 746f 206d 6174  If trying to mat
-0000c6b0: 6368 2062 7563 6b65 7420 7769 7468 2077  ch bucket with w
-0000c6c0: 696c 6463 6172 6420 6368 6172 6163 7465  ildcard characte
-0000c6d0: 7273 2c20 7261 6973 6520 556e 7375 7070  rs, raise Unsupp
-0000c6e0: 6f72 7465 6445 7272 6f72 0a0a 2020 2020  ortedError..    
-0000c6f0: 2020 2020 3a70 6172 616d 2070 6174 7465      :param patte
-0000c700: 726e 3a20 476c 6f62 2074 6865 2067 6976  rn: Glob the giv
-0000c710: 656e 2072 656c 6174 6976 6520 7061 7474  en relative patt
-0000c720: 6572 6e20 696e 2074 6865 2064 6972 6563  ern in the direc
-0000c730: 746f 7279 2072 6570 7265 7365 6e74 6564  tory represented
-0000c740: 2062 7920 7468 6973 2070 6174 680a 2020   by this path.  
-0000c750: 2020 2020 2020 3a70 6172 616d 2072 6563        :param rec
-0000c760: 7572 7369 7665 3a20 4966 2046 616c 7365  ursive: If False
-0000c770: 2c20 602a 2a60 2077 696c 6c20 6e6f 7420  , `**` will not 
-0000c780: 7365 6172 6368 2064 6972 6563 746f 7279  search directory
-0000c790: 2072 6563 7572 7369 7665 6c79 0a20 2020   recursively.   
-0000c7a0: 2020 2020 203a 7061 7261 6d20 6d69 7373       :param miss
-0000c7b0: 696e 675f 6f6b 3a20 4966 2046 616c 7365  ing_ok: If False
-0000c7c0: 2061 6e64 2074 6172 6765 7420 7061 7468   and target path
-0000c7d0: 2064 6f65 736e 2774 206d 6174 6368 2061   doesn't match a
-0000c7e0: 6e79 2066 696c 652c 2072 6169 7365 2046  ny file, raise F
-0000c7f0: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
-0000c800: 0a20 2020 2020 2020 203a 7261 6973 6573  .        :raises
-0000c810: 3a20 556e 7375 7070 6f72 7465 6445 7272  : UnsupportedErr
-0000c820: 6f72 2c20 7768 656e 2062 7563 6b65 7420  or, when bucket 
-0000c830: 7061 7274 2063 6f6e 7461 696e 7320 7769  part contains wi
-0000c840: 6c64 6361 7264 2063 6861 7261 6374 6572  ldcard character
-0000c850: 730a 2020 2020 2020 2020 3a72 6574 7572  s.        :retur
-0000c860: 6e73 3a20 416e 2069 7465 7261 746f 7220  ns: An iterator 
-0000c870: 636f 6e74 6169 6e73 2070 6174 6873 206d  contains paths m
-0000c880: 6174 6368 2060 7333 5f70 6174 686e 616d  atch `s3_pathnam
-0000c890: 6560 0a20 2020 2020 2020 2027 2727 0a20  e`.        '''. 
-0000c8a0: 2020 2020 2020 2066 6f72 2066 696c 655f         for file_
-0000c8b0: 656e 7472 7920 696e 2073 656c 662e 676c  entry in self.gl
-0000c8c0: 6f62 5f73 7461 7428 7061 7474 6572 6e3d  ob_stat(pattern=
-0000c8d0: 7061 7474 6572 6e2c 2072 6563 7572 7369  pattern, recursi
-0000c8e0: 7665 3d72 6563 7572 7369 7665 2c0a 2020  ve=recursive,.  
-0000c8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c910: 2020 2020 2020 206d 6973 7369 6e67 5f6f         missing_o
-0000c920: 6b3d 6d69 7373 696e 675f 6f6b 2c0a 2020  k=missing_ok,.  
-0000c930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c950: 2020 2020 2020 2066 6f6c 6c6f 776c 696e         followlin
-0000c960: 6b73 3d66 6f6c 6c6f 776c 696e 6b73 293a  ks=followlinks):
-0000c970: 0a20 2020 2020 2020 2020 2020 2079 6965  .            yie
-0000c980: 6c64 2073 656c 662e 6672 6f6d 5f70 6174  ld self.from_pat
-0000c990: 6828 6669 6c65 5f65 6e74 7279 2e70 6174  h(file_entry.pat
-0000c9a0: 6829 0a0a 2020 2020 6465 6620 6973 5f64  h)..    def is_d
-0000c9b0: 6972 2873 656c 662c 2066 6f6c 6c6f 776c  ir(self, followl
-0000c9c0: 696e 6b73 3a20 626f 6f6c 203d 2046 616c  inks: bool = Fal
-0000c9d0: 7365 2920 2d3e 2062 6f6f 6c3a 0a20 2020  se) -> bool:.   
-0000c9e0: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
-0000c9f0: 2054 6573 7420 6966 2061 6e20 7333 2075   Test if an s3 u
-0000ca00: 726c 2069 7320 6469 7265 6374 6f72 790a  rl is directory.
-0000ca10: 2020 2020 2020 2020 5370 6563 6966 6963          Specific
-0000ca20: 2070 726f 6365 6475 7265 7320 6172 6520   procedures are 
-0000ca30: 6173 2066 6f6c 6c6f 7773 3a0a 2020 2020  as follows:.    
-0000ca40: 2020 2020 4966 2074 6865 7265 2065 7869      If there exi
-0000ca50: 7374 7320 6120 7375 6666 6978 2c20 6f66  sts a suffix, of
-0000ca60: 2077 6869 6368 2060 606f 732e 7061 7468   which ``os.path
-0000ca70: 2e6a 6f69 6e28 7333 5f75 726c 2c20 7375  .join(s3_url, su
-0000ca80: 6666 6978 2960 6020 6973 2061 2066 696c  ffix)`` is a fil
-0000ca90: 650a 2020 2020 2020 2020 4966 2074 6865  e.        If the
-0000caa0: 2075 726c 2069 7320 656d 7074 7920 6275   url is empty bu
-0000cab0: 636b 6574 206f 7220 7333 3a2f 2f0a 0a20  cket or s3://.. 
-0000cac0: 2020 2020 2020 203a 7061 7261 6d20 666f         :param fo
-0000cad0: 6c6c 6f77 6c69 6e6b 733a 2077 6865 7468  llowlinks: wheth
-0000cae0: 6572 2066 6f6c 6c6f 776c 696e 6b73 2069  er followlinks i
-0000caf0: 7320 5472 7565 206f 7220 4661 6c73 652c  s True or False,
-0000cb00: 2072 6573 756c 7420 6973 2074 6865 2073   result is the s
-0000cb10: 616d 652e 2042 6563 6175 7365 2073 3320  ame. Because s3 
-0000cb20: 7379 6d6c 696e 6b20 6e6f 7420 7375 7070  symlink not supp
-0000cb30: 6f72 7420 6469 722e 0a20 2020 2020 2020  ort dir..       
-0000cb40: 203a 7265 7475 726e 733a 2054 7275 6520   :returns: True 
-0000cb50: 6966 2070 6174 6820 6973 2073 3320 6469  if path is s3 di
-0000cb60: 7265 6374 6f72 792c 2065 6c73 6520 4661  rectory, else Fa
-0000cb70: 6c73 650a 2020 2020 2020 2020 2727 270a  lse.        '''.
-0000cb80: 2020 2020 2020 2020 6275 636b 6574 2c20          bucket, 
-0000cb90: 6b65 7920 3d20 7061 7273 655f 7333 5f75  key = parse_s3_u
-0000cba0: 726c 2873 656c 662e 7061 7468 5f77 6974  rl(self.path_wit
-0000cbb0: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
-0000cbc0: 2020 2020 6966 206e 6f74 2062 7563 6b65      if not bucke
-0000cbd0: 743a 2020 2320 7333 3a2f 2f20 3d3e 2054  t:  # s3:// => T
-0000cbe0: 7275 652c 2073 333a 2f2f 2f6b 6579 203d  rue, s3:///key =
-0000cbf0: 3e20 4661 6c73 650a 2020 2020 2020 2020  > False.        
-0000cc00: 2020 2020 7265 7475 726e 206e 6f74 206b      return not k
-0000cc10: 6579 0a20 2020 2020 2020 2070 7265 6669  ey.        prefi
-0000cc20: 7820 3d20 5f62 6563 6f6d 655f 7072 6566  x = _become_pref
-0000cc30: 6978 286b 6579 290a 2020 2020 2020 2020  ix(key).        
-0000cc40: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0000cc50: 2072 6573 7020 3d20 7365 6c66 2e5f 636c   resp = self._cl
-0000cc60: 6965 6e74 2e6c 6973 745f 6f62 6a65 6374  ient.list_object
-0000cc70: 735f 7632 280a 2020 2020 2020 2020 2020  s_v2(.          
-0000cc80: 2020 2020 2020 4275 636b 6574 3d62 7563        Bucket=buc
-0000cc90: 6b65 742c 2050 7265 6669 783d 7072 6566  ket, Prefix=pref
-0000cca0: 6978 2c20 4465 6c69 6d69 7465 723d 272f  ix, Delimiter='/
-0000ccb0: 272c 204d 6178 4b65 7973 3d31 290a 2020  ', MaxKeys=1).  
-0000ccc0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-0000ccd0: 6570 7469 6f6e 2061 7320 6572 726f 723a  eption as error:
-0000cce0: 0a20 2020 2020 2020 2020 2020 2065 7272  .            err
-0000ccf0: 6f72 203d 2074 7261 6e73 6c61 7465 5f73  or = translate_s
-0000cd00: 335f 6572 726f 7228 6572 726f 722c 2073  3_error(error, s
-0000cd10: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
-0000cd20: 6f74 6f63 6f6c 290a 2020 2020 2020 2020  otocol).        
-0000cd30: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-0000cd40: 6528 6572 726f 722c 0a20 2020 2020 2020  e(error,.       
-0000cd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cd60: 2020 2028 5333 556e 6b6e 6f77 6e45 7272     (S3UnknownErr
-0000cd70: 6f72 2c20 5333 436f 6e66 6967 4572 726f  or, S3ConfigErro
-0000cd80: 722c 2053 3350 6572 6d69 7373 696f 6e45  r, S3PermissionE
-0000cd90: 7272 6f72 2929 3a0a 2020 2020 2020 2020  rror)):.        
-0000cda0: 2020 2020 2020 2020 7261 6973 6520 6572          raise er
-0000cdb0: 726f 720a 2020 2020 2020 2020 2020 2020  ror.            
-0000cdc0: 7265 7475 726e 2046 616c 7365 0a0a 2020  return False..  
-0000cdd0: 2020 2020 2020 6966 206e 6f74 206b 6579        if not key
-0000cde0: 3a20 2023 2062 7563 6b65 7420 6973 2061  :  # bucket is a
-0000cdf0: 6363 6573 7369 626c 650a 2020 2020 2020  ccessible.      
-0000ce00: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
-0000ce10: 650a 0a20 2020 2020 2020 2069 6620 274b  e..        if 'K
-0000ce20: 6579 436f 756e 7427 2069 6e20 7265 7370  eyCount' in resp
-0000ce30: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0000ce40: 7475 726e 2072 6573 705b 274b 6579 436f  turn resp['KeyCo
-0000ce50: 756e 7427 5d20 3e20 300a 0a20 2020 2020  unt'] > 0..     
-0000ce60: 2020 2072 6574 7572 6e20 6c65 6e28 7265     return len(re
-0000ce70: 7370 2e67 6574 2827 436f 6e74 656e 7473  sp.get('Contents
-0000ce80: 272c 205b 5d29 2920 3e20 3020 6f72 205c  ', [])) > 0 or \
-0000ce90: 0a20 2020 2020 2020 2020 2020 206c 656e  .            len
-0000cea0: 2872 6573 702e 6765 7428 2743 6f6d 6d6f  (resp.get('Commo
-0000ceb0: 6e50 7265 6669 7865 7327 2c20 5b5d 2929  nPrefixes', []))
-0000cec0: 203e 2030 0a0a 2020 2020 6465 6620 6973   > 0..    def is
-0000ced0: 5f66 696c 6528 7365 6c66 2c20 666f 6c6c  _file(self, foll
-0000cee0: 6f77 6c69 6e6b 733a 2062 6f6f 6c20 3d20  owlinks: bool = 
-0000cef0: 4661 6c73 6529 202d 3e20 626f 6f6c 3a0a  False) -> bool:.
-0000cf00: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-0000cf10: 2020 2020 5465 7374 2069 6620 616e 2073      Test if an s
-0000cf20: 335f 7572 6c20 6973 2066 696c 650a 0a20  3_url is file.. 
-0000cf30: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
-0000cf40: 2054 7275 6520 6966 2070 6174 6820 6973   True if path is
-0000cf50: 2073 3320 6669 6c65 2c20 656c 7365 2046   s3 file, else F
-0000cf60: 616c 7365 0a20 2020 2020 2020 2027 2727  alse.        '''
-0000cf70: 0a20 2020 2020 2020 2073 335f 7572 6c20  .        s3_url 
-0000cf80: 3d20 7365 6c66 2e70 6174 685f 7769 7468  = self.path_with
-0000cf90: 5f70 726f 746f 636f 6c0a 2020 2020 2020  _protocol.      
-0000cfa0: 2020 6966 2066 6f6c 6c6f 776c 696e 6b73    if followlinks
-0000cfb0: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
-0000cfc0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-0000cfd0: 2020 2073 335f 7572 6c20 3d20 7365 6c66     s3_url = self
-0000cfe0: 2e72 6561 646c 696e 6b28 292e 7061 7468  .readlink().path
-0000cff0: 5f77 6974 685f 7072 6f74 6f63 6f6c 0a20  _with_protocol. 
-0000d000: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-0000d010: 7420 5333 4e6f 7441 4c69 6e6b 4572 726f  t S3NotALinkErro
-0000d020: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-0000d030: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
-0000d040: 6275 636b 6574 2c20 6b65 7920 3d20 7061  bucket, key = pa
-0000d050: 7273 655f 7333 5f75 726c 2873 335f 7572  rse_s3_url(s3_ur
-0000d060: 6c29 0a20 2020 2020 2020 2069 6620 6e6f  l).        if no
-0000d070: 7420 6275 636b 6574 206f 7220 6e6f 7420  t bucket or not 
-0000d080: 6b65 7920 6f72 206b 6579 2e65 6e64 7377  key or key.endsw
-0000d090: 6974 6828 272f 2729 3a0a 2020 2020 2020  ith('/'):.      
-0000d0a0: 2020 2020 2020 2320 7333 3a2f 2f2c 2073        # s3://, s
-0000d0b0: 333a 2f2f 2f6b 6579 2c20 7333 3a2f 2f62  3:///key, s3://b
-0000d0c0: 7563 6b65 742c 2073 333a 2f2f 6275 636b  ucket, s3://buck
-0000d0d0: 6574 2f70 7265 6669 782f 0a20 2020 2020  et/prefix/.     
-0000d0e0: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
-0000d0f0: 6c73 650a 2020 2020 2020 2020 7472 793a  lse.        try:
-0000d100: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000d110: 662e 5f63 6c69 656e 742e 6865 6164 5f6f  f._client.head_o
-0000d120: 626a 6563 7428 4275 636b 6574 3d62 7563  bject(Bucket=buc
-0000d130: 6b65 742c 204b 6579 3d6b 6579 290a 2020  ket, Key=key).  
-0000d140: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-0000d150: 6570 7469 6f6e 2061 7320 6572 726f 723a  eption as error:
-0000d160: 0a20 2020 2020 2020 2020 2020 2065 7272  .            err
-0000d170: 6f72 203d 2074 7261 6e73 6c61 7465 5f73  or = translate_s
-0000d180: 335f 6572 726f 7228 6572 726f 722c 2073  3_error(error, s
-0000d190: 335f 7572 6c29 0a20 2020 2020 2020 2020  3_url).         
-0000d1a0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-0000d1b0: 2865 7272 6f72 2c0a 2020 2020 2020 2020  (error,.        
-0000d1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d1d0: 2020 2853 3355 6e6b 6e6f 776e 4572 726f    (S3UnknownErro
-0000d1e0: 722c 2053 3343 6f6e 6669 6745 7272 6f72  r, S3ConfigError
-0000d1f0: 2c20 5333 5065 726d 6973 7369 6f6e 4572  , S3PermissionEr
-0000d200: 726f 7229 293a 0a20 2020 2020 2020 2020  ror)):.         
-0000d210: 2020 2020 2020 2072 6169 7365 2065 7272         raise err
-0000d220: 6f72 0a20 2020 2020 2020 2020 2020 2072  or.            r
-0000d230: 6574 7572 6e20 4661 6c73 650a 2020 2020  eturn False.    
-0000d240: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
-0000d250: 0a20 2020 2064 6566 206c 6973 7464 6972  .    def listdir
-0000d260: 2873 656c 662c 2066 6f6c 6c6f 776c 696e  (self, followlin
-0000d270: 6b73 3a20 626f 6f6c 203d 2046 616c 7365  ks: bool = False
-0000d280: 2920 2d3e 204c 6973 745b 7374 725d 3a0a  ) -> List[str]:.
-0000d290: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-0000d2a0: 2020 2020 4765 7420 616c 6c20 636f 6e74      Get all cont
-0000d2b0: 656e 7473 206f 6620 6769 7665 6e20 7333  ents of given s3
-0000d2c0: 5f75 726c 2e20 5468 6520 7265 7375 6c74  _url. The result
-0000d2d0: 2069 7320 696e 2061 6373 656e 6469 6e67   is in acsending
-0000d2e0: 2061 6c70 6861 6265 7469 6361 6c20 6f72   alphabetical or
-0000d2f0: 6465 722e 0a0a 2020 2020 2020 2020 3a72  der...        :r
-0000d300: 6574 7572 6e73 3a20 416c 6c20 636f 6e74  eturns: All cont
-0000d310: 656e 7473 2068 6176 6520 7072 6566 6978  ents have prefix
-0000d320: 206f 6620 7333 5f75 726c 2069 6e20 6163   of s3_url in ac
-0000d330: 7365 6e64 696e 6720 616c 7068 6162 6574  sending alphabet
-0000d340: 6963 616c 206f 7264 6572 0a20 2020 2020  ical order.     
-0000d350: 2020 203a 7261 6973 6573 3a20 5333 4669     :raises: S3Fi
-0000d360: 6c65 4e6f 7446 6f75 6e64 4572 726f 722c  leNotFoundError,
-0000d370: 2053 334e 6f74 4144 6972 6563 746f 7279   S3NotADirectory
-0000d380: 4572 726f 720a 2020 2020 2020 2020 2727  Error.        ''
-0000d390: 270a 2020 2020 2020 2020 656e 7472 6965  '.        entrie
-0000d3a0: 7320 3d20 6c69 7374 2873 656c 662e 7363  s = list(self.sc
-0000d3b0: 616e 6469 7228 666f 6c6c 6f77 6c69 6e6b  andir(followlink
-0000d3c0: 733d 666f 6c6c 6f77 6c69 6e6b 7329 290a  s=followlinks)).
-0000d3d0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0000d3e0: 6f72 7465 6428 5b65 6e74 7279 2e6e 616d  orted([entry.nam
-0000d3f0: 6520 666f 7220 656e 7472 7920 696e 2065  e for entry in e
-0000d400: 6e74 7269 6573 5d29 0a0a 2020 2020 6465  ntries])..    de
-0000d410: 6620 6974 6572 6469 7228 7365 6c66 2c20  f iterdir(self, 
-0000d420: 666f 6c6c 6f77 6c69 6e6b 733a 2062 6f6f  followlinks: boo
-0000d430: 6c20 3d20 4661 6c73 6529 202d 3e20 4974  l = False) -> It
-0000d440: 6572 6174 6f72 5b27 5333 5061 7468 275d  erator['S3Path']
-0000d450: 3a0a 2020 2020 2020 2020 2727 270a 2020  :.        '''.  
-0000d460: 2020 2020 2020 4765 7420 616c 6c20 636f        Get all co
-0000d470: 6e74 656e 7473 206f 6620 6769 7665 6e20  ntents of given 
-0000d480: 7333 5f75 726c 2e20 5468 6520 7265 7375  s3_url. The resu
-0000d490: 6c74 2069 7320 696e 2061 6373 656e 6469  lt is in acsendi
-0000d4a0: 6e67 2061 6c70 6861 6265 7469 6361 6c20  ng alphabetical 
-0000d4b0: 6f72 6465 722e 0a0a 2020 2020 2020 2020  order...        
-0000d4c0: 3a72 6574 7572 6e73 3a20 416c 6c20 636f  :returns: All co
-0000d4d0: 6e74 656e 7473 2068 6176 6520 7072 6566  ntents have pref
-0000d4e0: 6978 206f 6620 7333 5f75 726c 2069 6e20  ix of s3_url in 
-0000d4f0: 6163 7365 6e64 696e 6720 616c 7068 6162  acsending alphab
-0000d500: 6574 6963 616c 206f 7264 6572 0a20 2020  etical order.   
-0000d510: 2020 2020 203a 7261 6973 6573 3a20 5333       :raises: S3
-0000d520: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
-0000d530: 722c 2053 334e 6f74 4144 6972 6563 746f  r, S3NotADirecto
-0000d540: 7279 4572 726f 720a 2020 2020 2020 2020  ryError.        
-0000d550: 2727 270a 2020 2020 2020 2020 666f 7220  '''.        for 
-0000d560: 7061 7468 2069 6e20 7365 6c66 2e6c 6973  path in self.lis
-0000d570: 7464 6972 2866 6f6c 6c6f 776c 696e 6b73  tdir(followlinks
-0000d580: 3d66 6f6c 6c6f 776c 696e 6b73 293a 0a20  =followlinks):. 
-0000d590: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
-0000d5a0: 2073 656c 662e 6a6f 696e 7061 7468 2870   self.joinpath(p
-0000d5b0: 6174 6829 2020 2320 7479 7065 3a20 6967  ath)  # type: ig
-0000d5c0: 6e6f 7265 0a0a 2020 2020 6465 6620 6c6f  nore..    def lo
-0000d5d0: 6164 2873 656c 662c 2066 6f6c 6c6f 776c  ad(self, followl
-0000d5e0: 696e 6b73 3a20 626f 6f6c 203d 2046 616c  inks: bool = Fal
-0000d5f0: 7365 2920 2d3e 2042 696e 6172 7949 4f3a  se) -> BinaryIO:
-0000d600: 0a20 2020 2020 2020 2027 2727 5265 6164  .        '''Read
-0000d610: 2061 6c6c 2063 6f6e 7465 6e74 2069 6e20   all content in 
-0000d620: 6269 6e61 7279 206f 6e20 7370 6563 6966  binary on specif
-0000d630: 6965 6420 7061 7468 2061 6e64 2077 7269  ied path and wri
-0000d640: 7465 2069 6e74 6f20 6d65 6d6f 7279 0a0a  te into memory..
-0000d650: 2020 2020 2020 2020 5573 6572 2073 686f          User sho
-0000d660: 756c 6420 636c 6f73 6520 7468 6520 4269  uld close the Bi
-0000d670: 6e61 7279 494f 206d 616e 7561 6c6c 790a  naryIO manually.
-0000d680: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-0000d690: 733a 2042 696e 6172 7949 4f0a 2020 2020  s: BinaryIO.    
-0000d6a0: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
-0000d6b0: 7333 5f75 726c 203d 2073 656c 662e 7061  s3_url = self.pa
-0000d6c0: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-0000d6d0: 0a20 2020 2020 2020 2069 6620 666f 6c6c  .        if foll
-0000d6e0: 6f77 6c69 6e6b 733a 0a20 2020 2020 2020  owlinks:.       
-0000d6f0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0000d700: 2020 2020 2020 2020 2020 7333 5f75 726c            s3_url
-0000d710: 203d 2073 656c 662e 7265 6164 6c69 6e6b   = self.readlink
-0000d720: 2829 2e70 6174 685f 7769 7468 5f70 726f  ().path_with_pro
-0000d730: 746f 636f 6c0a 2020 2020 2020 2020 2020  tocol.          
-0000d740: 2020 6578 6365 7074 2053 334e 6f74 414c    except S3NotAL
-0000d750: 696e 6b45 7272 6f72 3a0a 2020 2020 2020  inkError:.      
-0000d760: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
-0000d770: 2020 2020 2020 2062 7563 6b65 742c 206b         bucket, k
-0000d780: 6579 203d 2070 6172 7365 5f73 335f 7572  ey = parse_s3_ur
-0000d790: 6c28 7333 5f75 726c 290a 2020 2020 2020  l(s3_url).      
-0000d7a0: 2020 6966 206e 6f74 2062 7563 6b65 743a    if not bucket:
-0000d7b0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-0000d7c0: 7365 2053 3342 7563 6b65 744e 6f74 466f  se S3BucketNotFo
-0000d7d0: 756e 6445 7272 6f72 2827 456d 7074 7920  undError('Empty 
-0000d7e0: 6275 636b 6574 206e 616d 653a 2025 7227  bucket name: %r'
-0000d7f0: 2025 2073 335f 7572 6c29 0a20 2020 2020   % s3_url).     
-0000d800: 2020 2069 6620 6e6f 7420 6b65 7920 6f72     if not key or
-0000d810: 206b 6579 2e65 6e64 7377 6974 6828 272f   key.endswith('/
-0000d820: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-0000d830: 7261 6973 6520 5333 4973 4144 6972 6563  raise S3IsADirec
-0000d840: 746f 7279 4572 726f 7228 2749 7320 6120  toryError('Is a 
-0000d850: 6469 7265 6374 6f72 793a 2025 7227 2025  directory: %r' %
-0000d860: 2073 335f 7572 6c29 0a0a 2020 2020 2020   s3_url)..      
-0000d870: 2020 6275 6666 6572 203d 2069 6f2e 4279    buffer = io.By
-0000d880: 7465 7349 4f28 290a 2020 2020 2020 2020  tesIO().        
-0000d890: 7769 7468 2072 6169 7365 5f73 335f 6572  with raise_s3_er
-0000d8a0: 726f 7228 7333 5f75 726c 293a 0a20 2020  ror(s3_url):.   
-0000d8b0: 2020 2020 2020 2020 2073 656c 662e 5f63           self._c
-0000d8c0: 6c69 656e 742e 646f 776e 6c6f 6164 5f66  lient.download_f
-0000d8d0: 696c 656f 626a 2862 7563 6b65 742c 206b  ileobj(bucket, k
-0000d8e0: 6579 2c20 6275 6666 6572 290a 2020 2020  ey, buffer).    
-0000d8f0: 2020 2020 6275 6666 6572 2e73 6565 6b28      buffer.seek(
-0000d900: 3029 0a20 2020 2020 2020 2072 6574 7572  0).        retur
-0000d910: 6e20 6275 6666 6572 0a0a 2020 2020 6465  n buffer..    de
-0000d920: 6620 6861 7362 7563 6b65 7428 7365 6c66  f hasbucket(self
-0000d930: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
-0000d940: 2020 2027 2727 0a20 2020 2020 2020 2054     '''.        T
-0000d950: 6573 7420 6966 2074 6865 2062 7563 6b65  est if the bucke
-0000d960: 7420 6f66 2073 335f 7572 6c20 6578 6973  t of s3_url exis
-0000d970: 7473 0a0a 2020 2020 2020 2020 3a72 6574  ts..        :ret
-0000d980: 7572 6e73 3a20 5472 7565 2069 6620 6275  urns: True if bu
-0000d990: 636b 6574 206f 6620 7333 5f75 726c 2065  cket of s3_url e
-0000d9a0: 6978 7374 732c 2065 6c73 6520 4661 6c73  ixsts, else Fals
-0000d9b0: 650a 2020 2020 2020 2020 2727 270a 2020  e.        '''.  
-0000d9c0: 2020 2020 2020 6275 636b 6574 2c20 5f20        bucket, _ 
-0000d9d0: 3d20 7061 7273 655f 7333 5f75 726c 2873  = parse_s3_url(s
-0000d9e0: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
-0000d9f0: 6f74 6f63 6f6c 290a 2020 2020 2020 2020  otocol).        
-0000da00: 6966 206e 6f74 2062 7563 6b65 743a 0a20  if not bucket:. 
-0000da10: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000da20: 6e20 4661 6c73 650a 0a20 2020 2020 2020  n False..       
-0000da30: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0000da40: 2020 7365 6c66 2e5f 636c 6965 6e74 2e68    self._client.h
-0000da50: 6561 645f 6275 636b 6574 2842 7563 6b65  ead_bucket(Bucke
-0000da60: 743d 6275 636b 6574 290a 2020 2020 2020  t=bucket).      
-0000da70: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-0000da80: 6f6e 2061 7320 6572 726f 723a 0a20 2020  on as error:.   
-0000da90: 2020 2020 2020 2020 2065 7272 6f72 203d           error =
-0000daa0: 2074 7261 6e73 6c61 7465 5f73 335f 6572   translate_s3_er
-0000dab0: 726f 7228 6572 726f 722c 2073 656c 662e  ror(error, self.
-0000dac0: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
-0000dad0: 6f6c 290a 2020 2020 2020 2020 2020 2020  ol).            
-0000dae0: 6966 2069 7369 6e73 7461 6e63 6528 6572  if isinstance(er
-0000daf0: 726f 722c 0a20 2020 2020 2020 2020 2020  ror,.           
-0000db00: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-0000db10: 5333 556e 6b6e 6f77 6e45 7272 6f72 2c20  S3UnknownError, 
-0000db20: 5333 436f 6e66 6967 4572 726f 722c 2053  S3ConfigError, S
-0000db30: 3350 6572 6d69 7373 696f 6e45 7272 6f72  3PermissionError
-0000db40: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-0000db50: 2020 2020 7261 6973 6520 6572 726f 720a      raise error.
-0000db60: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-0000db70: 7369 6e73 7461 6e63 6528 6572 726f 722c  sinstance(error,
-0000db80: 2053 3346 696c 654e 6f74 466f 756e 6445   S3FileNotFoundE
-0000db90: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-0000dba0: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
-0000dbb0: 6c73 650a 0a20 2020 2020 2020 2072 6574  lse..        ret
-0000dbc0: 7572 6e20 5472 7565 0a0a 2020 2020 6465  urn True..    de
-0000dbd0: 6620 6d6b 6469 7228 7365 6c66 2c20 6d6f  f mkdir(self, mo
-0000dbe0: 6465 3d30 6f37 3737 2c20 7061 7265 6e74  de=0o777, parent
-0000dbf0: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
-0000dc00: 2065 7869 7374 5f6f 6b3a 2062 6f6f 6c20   exist_ok: bool 
-0000dc10: 3d20 4661 6c73 6529 3a0a 2020 2020 2020  = False):.      
-0000dc20: 2020 2727 270a 2020 2020 2020 2020 4372    '''.        Cr
-0000dc30: 6561 7465 2061 6e20 7333 2064 6972 6563  eate an s3 direc
-0000dc40: 746f 7279 2e0a 2020 2020 2020 2020 5075  tory..        Pu
-0000dc50: 7265 6c79 2063 7265 6174 696e 6720 6469  rely creating di
-0000dc60: 7265 6374 6f72 7920 6973 2069 6e76 616c  rectory is inval
-0000dc70: 6964 2062 6563 6175 7365 2069 7427 7320  id because it's 
-0000dc80: 756e 6176 6169 6c61 626c 6520 6f6e 204f  unavailable on O
-0000dc90: 5353 2e0a 2020 2020 2020 2020 5468 6973  SS..        This
-0000dca0: 2066 756e 6374 696f 6e20 6973 2074 6f20   function is to 
-0000dcb0: 7465 7374 2074 6865 2074 6172 6765 7420  test the target 
-0000dcc0: 6275 636b 6574 2068 6176 6520 5752 4954  bucket have WRIT
-0000dcd0: 4520 6163 6365 7373 2e0a 0a20 2020 2020  E access...     
-0000dce0: 2020 203a 7061 7261 6d20 6d6f 6465 3a20     :param mode: 
-0000dcf0: 6d6f 6465 2069 7320 6967 6e6f 7265 642c  mode is ignored,
-0000dd00: 206f 6e6c 7920 6265 2063 6f6d 7061 7469   only be compati
-0000dd10: 626c 6520 7769 7468 2070 6174 686c 6962  ble with pathlib
-0000dd20: 2e50 6174 680a 2020 2020 2020 2020 3a70  .Path.        :p
-0000dd30: 6172 616d 2070 6172 656e 7473 3a20 7061  aram parents: pa
-0000dd40: 7265 6e74 7320 6973 2069 676e 6f72 6564  rents is ignored
-0000dd50: 2c20 6f6e 6c79 2062 6520 636f 6d70 6174  , only be compat
-0000dd60: 6962 6c65 2077 6974 6820 7061 7468 6c69  ible with pathli
-0000dd70: 622e 5061 7468 0a20 2020 2020 2020 203a  b.Path.        :
-0000dd80: 7061 7261 6d20 6578 6973 745f 6f6b 3a20  param exist_ok: 
-0000dd90: 4966 2046 616c 7365 2061 6e64 2074 6172  If False and tar
-0000dda0: 6765 7420 6469 7265 6374 6f72 7920 6578  get directory ex
-0000ddb0: 6973 7473 2c20 7261 6973 6520 5333 4669  ists, raise S3Fi
-0000ddc0: 6c65 4578 6973 7473 4572 726f 720a 2020  leExistsError.  
-0000ddd0: 2020 2020 2020 3a72 6169 7365 733a 2053        :raises: S
-0000dde0: 3342 7563 6b65 744e 6f74 466f 756e 6445  3BucketNotFoundE
-0000ddf0: 7272 6f72 2c20 5333 4669 6c65 4578 6973  rror, S3FileExis
-0000de00: 7473 4572 726f 720a 2020 2020 2020 2020  tsError.        
-0000de10: 2727 270a 2020 2020 2020 2020 6275 636b  '''.        buck
-0000de20: 6574 2c20 5f20 3d20 7061 7273 655f 7333  et, _ = parse_s3
-0000de30: 5f75 726c 2873 656c 662e 7061 7468 5f77  _url(self.path_w
-0000de40: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
-0000de50: 2020 2020 2020 6966 206e 6f74 2062 7563        if not buc
-0000de60: 6b65 743a 0a20 2020 2020 2020 2020 2020  ket:.           
-0000de70: 2072 6169 7365 2053 3342 7563 6b65 744e   raise S3BucketN
-0000de80: 6f74 466f 756e 6445 7272 6f72 280a 2020  otFoundError(.  
-0000de90: 2020 2020 2020 2020 2020 2020 2020 2745                'E
-0000dea0: 6d70 7479 2062 7563 6b65 7420 6e61 6d65  mpty bucket name
-0000deb0: 3a20 2572 2720 2520 7365 6c66 2e70 6174  : %r' % self.pat
-0000dec0: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-0000ded0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0000dee0: 7365 6c66 2e68 6173 6275 636b 6574 2829  self.hasbucket()
-0000def0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0000df00: 6973 6520 5333 4275 636b 6574 4e6f 7446  ise S3BucketNotF
-0000df10: 6f75 6e64 4572 726f 7228 0a20 2020 2020  oundError(.     
-0000df20: 2020 2020 2020 2020 2020 2027 4e6f 2073             'No s
-0000df30: 7563 6820 6275 636b 6574 3a20 2572 2720  uch bucket: %r' 
-0000df40: 2520 7365 6c66 2e70 6174 685f 7769 7468  % self.path_with
-0000df50: 5f70 726f 746f 636f 6c29 0a20 2020 2020  _protocol).     
-0000df60: 2020 2069 6620 6578 6973 745f 6f6b 3a0a     if exist_ok:.
-0000df70: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-0000df80: 656c 662e 6973 5f66 696c 6528 293a 0a20  elf.is_file():. 
-0000df90: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000dfa0: 6169 7365 2053 3346 696c 6545 7869 7374  aise S3FileExist
-0000dfb0: 7345 7272 6f72 280a 2020 2020 2020 2020  sError(.        
-0000dfc0: 2020 2020 2020 2020 2020 2020 2746 696c              'Fil
-0000dfd0: 6520 6578 6973 7473 3a20 2572 2720 2520  e exists: %r' % 
-0000dfe0: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
-0000dff0: 726f 746f 636f 6c29 0a20 2020 2020 2020  rotocol).       
-0000e000: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
-0000e010: 2020 2020 6966 2073 656c 662e 6578 6973      if self.exis
-0000e020: 7473 2829 3a0a 2020 2020 2020 2020 2020  ts():.          
-0000e030: 2020 7261 6973 6520 5333 4669 6c65 4578    raise S3FileEx
-0000e040: 6973 7473 4572 726f 7228 2746 696c 6520  istsError('File 
-0000e050: 6578 6973 7473 3a20 2572 2720 2520 7365  exists: %r' % se
-0000e060: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-0000e070: 746f 636f 6c29 0a0a 2020 2020 6465 6620  tocol)..    def 
-0000e080: 6d6f 7665 2873 656c 662c 2064 7374 5f75  move(self, dst_u
-0000e090: 726c 3a20 5061 7468 4c69 6b65 2920 2d3e  rl: PathLike) ->
-0000e0a0: 204e 6f6e 653a 0a20 2020 2020 2020 2027   None:.        '
-0000e0b0: 2727 0a20 2020 2020 2020 204d 6f76 6520  ''.        Move 
-0000e0c0: 6669 6c65 2f64 6972 6563 746f 7279 2070  file/directory p
-0000e0d0: 6174 6820 6672 6f6d 2073 7263 5f75 726c  ath from src_url
-0000e0e0: 2074 6f20 6473 745f 7572 6c0a 0a20 2020   to dst_url..   
-0000e0f0: 2020 2020 203a 7061 7261 6d20 6473 745f       :param dst_
-0000e100: 7572 6c3a 2047 6976 656e 2064 6573 7469  url: Given desti
-0000e110: 6e61 7469 6f6e 2070 6174 680a 2020 2020  nation path.    
-0000e120: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
-0000e130: 666f 7220 7372 635f 6669 6c65 5f70 6174  for src_file_pat
-0000e140: 682c 2064 7374 5f66 696c 655f 7061 7468  h, dst_file_path
-0000e150: 2069 6e20 5f73 335f 7363 616e 5f70 6169   in _s3_scan_pai
-0000e160: 7273 280a 2020 2020 2020 2020 2020 2020  rs(.            
-0000e170: 2020 2020 7365 6c66 2e70 6174 685f 7769      self.path_wi
-0000e180: 7468 5f70 726f 746f 636f 6c2c 2064 7374  th_protocol, dst
-0000e190: 5f75 726c 293a 0a20 2020 2020 2020 2020  _url):.         
-0000e1a0: 2020 2053 3350 6174 6828 7372 635f 6669     S3Path(src_fi
-0000e1b0: 6c65 5f70 6174 6829 2e72 656e 616d 6528  le_path).rename(
-0000e1c0: 6473 745f 6669 6c65 5f70 6174 6829 0a0a  dst_file_path)..
-0000e1d0: 2020 2020 6465 6620 7265 6d6f 7665 2873      def remove(s
-0000e1e0: 656c 662c 206d 6973 7369 6e67 5f6f 6b3a  elf, missing_ok:
-0000e1f0: 2062 6f6f 6c20 3d20 4661 6c73 6529 202d   bool = False) -
-0000e200: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0000e210: 2727 270a 2020 2020 2020 2020 5265 6d6f  '''.        Remo
-0000e220: 7665 2074 6865 2066 696c 6520 6f72 2064  ve the file or d
-0000e230: 6972 6563 746f 7279 206f 6e20 7333 2c20  irectory on s3, 
-0000e240: 6073 333a 2f2f 6020 616e 6420 6073 333a  `s3://` and `s3:
-0000e250: 2f2f 6275 636b 6574 6020 6172 6520 6e6f  //bucket` are no
-0000e260: 7420 7065 726d 6974 7465 6420 746f 2072  t permitted to r
-0000e270: 656d 6f76 650a 0a20 2020 2020 2020 203a  emove..        :
-0000e280: 7061 7261 6d20 6d69 7373 696e 675f 6f6b  param missing_ok
-0000e290: 3a20 6966 2046 616c 7365 2061 6e64 2074  : if False and t
-0000e2a0: 6172 6765 7420 6669 6c65 2f64 6972 6563  arget file/direc
-0000e2b0: 746f 7279 206e 6f74 2065 7869 7374 732c  tory not exists,
-0000e2c0: 2072 6169 7365 2053 3346 696c 654e 6f74   raise S3FileNot
-0000e2d0: 466f 756e 6445 7272 6f72 0a20 2020 2020  FoundError.     
-0000e2e0: 2020 203a 7261 6973 6573 3a20 5333 5065     :raises: S3Pe
-0000e2f0: 726d 6973 7369 6f6e 4572 726f 722c 2053  rmissionError, S
-0000e300: 3346 696c 654e 6f74 466f 756e 6445 7272  3FileNotFoundErr
-0000e310: 6f72 2c20 556e 7375 7070 6f72 7465 6445  or, UnsupportedE
-0000e320: 7272 6f72 0a20 2020 2020 2020 2027 2727  rror.        '''
-0000e330: 0a20 2020 2020 2020 2062 7563 6b65 742c  .        bucket,
-0000e340: 206b 6579 203d 2070 6172 7365 5f73 335f   key = parse_s3_
-0000e350: 7572 6c28 7365 6c66 2e70 6174 685f 7769  url(self.path_wi
-0000e360: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
-0000e370: 2020 2020 2069 6620 6e6f 7420 6275 636b       if not buck
-0000e380: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
-0000e390: 6966 206e 6f74 206b 6579 3a0a 2020 2020  if not key:.    
-0000e3a0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000e3b0: 6520 556e 7375 7070 6f72 7465 6445 7272  e UnsupportedErr
-0000e3c0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-0000e3d0: 2020 2020 2020 2020 2752 656d 6f76 6520          'Remove 
-0000e3e0: 7768 6f6c 6520 7333 272c 2073 656c 662e  whole s3', self.
-0000e3f0: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
-0000e400: 6f6c 290a 2020 2020 2020 2020 2020 2020  ol).            
-0000e410: 7261 6973 6520 5333 4275 636b 6574 4e6f  raise S3BucketNo
-0000e420: 7446 6f75 6e64 4572 726f 7228 0a20 2020  tFoundError(.   
-0000e430: 2020 2020 2020 2020 2020 2020 2027 456d               'Em
-0000e440: 7074 7920 6275 636b 6574 206e 616d 653a  pty bucket name:
-0000e450: 2025 7227 2025 2073 656c 662e 7061 7468   %r' % self.path
-0000e460: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
-0000e470: 2020 2020 2020 2020 6966 206e 6f74 206b          if not k
-0000e480: 6579 3a0a 2020 2020 2020 2020 2020 2020  ey:.            
-0000e490: 7261 6973 6520 556e 7375 7070 6f72 7465  raise Unsupporte
-0000e4a0: 6445 7272 6f72 2827 5265 6d6f 7665 2062  dError('Remove b
-0000e4b0: 7563 6b65 7427 2c20 7365 6c66 2e70 6174  ucket', self.pat
-0000e4c0: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-0000e4d0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0000e4e0: 7365 6c66 2e65 7869 7374 7328 293a 0a20  self.exists():. 
-0000e4f0: 2020 2020 2020 2020 2020 2069 6620 6d69             if mi
-0000e500: 7373 696e 675f 6f6b 3a0a 2020 2020 2020  ssing_ok:.      
-0000e510: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000e520: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-0000e530: 7365 2053 3346 696c 654e 6f74 466f 756e  se S3FileNotFoun
-0000e540: 6445 7272 6f72 280a 2020 2020 2020 2020  dError(.        
-0000e550: 2020 2020 2020 2020 274e 6f20 7375 6368          'No such
-0000e560: 2066 696c 6520 6f72 2064 6972 6563 746f   file or directo
-0000e570: 7279 3a20 2572 2720 2520 7365 6c66 2e70  ry: %r' % self.p
-0000e580: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-0000e590: 6c29 0a0a 2020 2020 2020 2020 636c 6965  l)..        clie
-0000e5a0: 6e74 203d 2073 656c 662e 5f63 6c69 656e  nt = self._clien
-0000e5b0: 740a 2020 2020 2020 2020 7769 7468 2072  t.        with r
-0000e5c0: 6169 7365 5f73 335f 6572 726f 7228 7365  aise_s3_error(se
-0000e5d0: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-0000e5e0: 746f 636f 6c29 3a0a 2020 2020 2020 2020  tocol):.        
-0000e5f0: 2020 2020 6966 2073 656c 662e 6973 5f66      if self.is_f
-0000e600: 696c 6528 293a 0a20 2020 2020 2020 2020  ile():.         
-0000e610: 2020 2020 2020 2063 6c69 656e 742e 6465         client.de
-0000e620: 6c65 7465 5f6f 626a 6563 7428 4275 636b  lete_object(Buck
-0000e630: 6574 3d62 7563 6b65 742c 204b 6579 3d6b  et=bucket, Key=k
-0000e640: 6579 290a 2020 2020 2020 2020 2020 2020  ey).            
-0000e650: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
-0000e660: 2020 2020 2020 2070 7265 6669 7820 3d20         prefix = 
-0000e670: 5f62 6563 6f6d 655f 7072 6566 6978 286b  _become_prefix(k
-0000e680: 6579 290a 2020 2020 2020 2020 2020 2020  ey).            
-0000e690: 746f 7461 6c5f 636f 756e 742c 2065 7272  total_count, err
-0000e6a0: 6f72 5f63 6f75 6e74 203d 2030 2c20 300a  or_count = 0, 0.
-0000e6b0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000e6c0: 7265 7370 2069 6e20 5f6c 6973 745f 6f62  resp in _list_ob
-0000e6d0: 6a65 6374 735f 7265 6375 7273 6976 6528  jects_recursive(
-0000e6e0: 636c 6965 6e74 2c20 6275 636b 6574 2c20  client, bucket, 
-0000e6f0: 7072 6566 6978 293a 0a20 2020 2020 2020  prefix):.       
-0000e700: 2020 2020 2020 2020 2069 6620 2743 6f6e           if 'Con
-0000e710: 7465 6e74 7327 2069 6e20 7265 7370 3a0a  tents' in resp:.
-0000e720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e730: 2020 2020 6b65 7973 203d 205b 0a20 2020      keys = [.   
-0000e740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e750: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0000e760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e770: 2020 2027 4b65 7927 3a20 636f 6e74 656e     'Key': conten
-0000e780: 745b 274b 6579 275d 0a20 2020 2020 2020  t['Key'].       
-0000e790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e7a0: 207d 2066 6f72 2063 6f6e 7465 6e74 2069   } for content i
-0000e7b0: 6e20 7265 7370 5b27 436f 6e74 656e 7473  n resp['Contents
-0000e7c0: 275d 0a20 2020 2020 2020 2020 2020 2020  '].             
-0000e7d0: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
-0000e7e0: 2020 2020 2020 2020 2020 2020 2074 6f74               tot
-0000e7f0: 616c 5f63 6f75 6e74 202b 3d20 6c65 6e28  al_count += len(
-0000e800: 6b65 7973 290a 2020 2020 2020 2020 2020  keys).          
-0000e810: 2020 2020 2020 2020 2020 6572 726f 7273            errors
-0000e820: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
-0000e830: 2020 2020 2020 2020 2020 7265 7472 6965            retrie
-0000e840: 7320 3d20 320a 2020 2020 2020 2020 2020  s = 2.          
-0000e850: 2020 2020 2020 2020 2020 7265 7472 795f            retry_
-0000e860: 696e 7465 7276 616c 203d 206d 696e 2830  interval = min(0
-0000e870: 2e31 202a 2032 2a2a 7265 7472 6965 732c  .1 * 2**retries,
-0000e880: 2033 3029 0a20 2020 2020 2020 2020 2020   30).           
-0000e890: 2020 2020 2020 2020 2066 6f72 2069 2069           for i i
-0000e8a0: 6e20 7261 6e67 6528 7265 7472 6965 7329  n range(retries)
-0000e8b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000e8c0: 2020 2020 2020 2020 2020 2320 646f 633a            # doc:
-0000e8d0: 2068 7474 7073 3a2f 2f62 6f74 6f33 2e61   https://boto3.a
-0000e8e0: 6d61 7a6f 6e61 7773 2e63 6f6d 2f76 312f  mazonaws.com/v1/
-0000e8f0: 646f 6375 6d65 6e74 6174 696f 6e2f 6170  documentation/ap
-0000e900: 692f 6c61 7465 7374 2f72 6566 6572 656e  i/latest/referen
-0000e910: 6365 2f73 6572 7669 6365 732f 7333 2e68  ce/services/s3.h
-0000e920: 746d 6c23 5333 2e43 6c69 656e 742e 6465  tml#S3.Client.de
-0000e930: 6c65 7465 5f6f 626a 6563 7473 0a20 2020  lete_objects.   
+0000c400: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000c410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c420: 2079 6965 6c64 2066 696c 655f 656e 7472   yield file_entr
+0000c430: 790a 0a20 2020 2020 2020 2072 6574 7572  y..        retur
+0000c440: 6e20 5f63 7265 6174 655f 6d69 7373 696e  n _create_missin
+0000c450: 675f 6f6b 5f67 656e 6572 6174 6f72 280a  g_ok_generator(.
+0000c460: 2020 2020 2020 2020 2020 2020 6372 6561              crea
+0000c470: 7465 5f67 656e 6572 6174 6f72 2829 2c20  te_generator(), 
+0000c480: 6d69 7373 696e 675f 6f6b 2c0a 2020 2020  missing_ok,.    
+0000c490: 2020 2020 2020 2020 5333 4669 6c65 4e6f          S3FileNo
+0000c4a0: 7446 6f75 6e64 4572 726f 7228 274e 6f20  tFoundError('No 
+0000c4b0: 6d61 7463 6820 6669 6c65 3a20 2572 2720  match file: %r' 
+0000c4c0: 2520 7333 5f70 6174 686e 616d 6529 290a  % s3_pathname)).
+0000c4d0: 0a20 2020 2064 6566 2069 676c 6f62 280a  .    def iglob(.
+0000c4e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000c4f0: 2c0a 2020 2020 2020 2020 2020 2020 7061  ,.            pa
+0000c500: 7474 6572 6e2c 0a20 2020 2020 2020 2020  ttern,.         
+0000c510: 2020 2072 6563 7572 7369 7665 3a20 626f     recursive: bo
+0000c520: 6f6c 203d 2054 7275 652c 0a20 2020 2020  ol = True,.     
+0000c530: 2020 2020 2020 206d 6973 7369 6e67 5f6f         missing_o
+0000c540: 6b3a 2062 6f6f 6c20 3d20 5472 7565 2c0a  k: bool = True,.
+0000c550: 2020 2020 2020 2020 2020 2020 666f 6c6c              foll
+0000c560: 6f77 6c69 6e6b 733a 2062 6f6f 6c20 3d20  owlinks: bool = 
+0000c570: 4661 6c73 652c 0a20 2020 2029 202d 3e20  False,.    ) -> 
+0000c580: 4974 6572 6174 6f72 5b27 5333 5061 7468  Iterator['S3Path
+0000c590: 275d 3a0a 2020 2020 2020 2020 2727 2752  ']:.        '''R
+0000c5a0: 6574 7572 6e20 7333 2070 6174 6820 6974  eturn s3 path it
+0000c5b0: 6572 6174 6f72 2069 6e20 6173 6365 6e64  erator in ascend
+0000c5c0: 696e 6720 616c 7068 6162 6574 6963 616c  ing alphabetical
+0000c5d0: 206f 7264 6572 2c20 696e 2077 6869 6368   order, in which
+0000c5e0: 2070 6174 6820 6d61 7463 6865 7320 676c   path matches gl
+0000c5f0: 6f62 2070 6174 7465 726e 0a20 2020 2020  ob pattern.     
+0000c600: 2020 204e 6f74 6573 3a20 4f6e 6c79 2067     Notes: Only g
+0000c610: 6c6f 6220 696e 2062 7563 6b65 742e 2049  lob in bucket. I
+0000c620: 6620 7472 7969 6e67 2074 6f20 6d61 7463  f trying to matc
+0000c630: 6820 6275 636b 6574 2077 6974 6820 7769  h bucket with wi
+0000c640: 6c64 6361 7264 2063 6861 7261 6374 6572  ldcard character
+0000c650: 732c 2072 6169 7365 2055 6e73 7570 706f  s, raise Unsuppo
+0000c660: 7274 6564 4572 726f 720a 0a20 2020 2020  rtedError..     
+0000c670: 2020 203a 7061 7261 6d20 7061 7474 6572     :param patter
+0000c680: 6e3a 2047 6c6f 6220 7468 6520 6769 7665  n: Glob the give
+0000c690: 6e20 7265 6c61 7469 7665 2070 6174 7465  n relative patte
+0000c6a0: 726e 2069 6e20 7468 6520 6469 7265 6374  rn in the direct
+0000c6b0: 6f72 7920 7265 7072 6573 656e 7465 6420  ory represented 
+0000c6c0: 6279 2074 6869 7320 7061 7468 0a20 2020  by this path.   
+0000c6d0: 2020 2020 203a 7061 7261 6d20 7265 6375       :param recu
+0000c6e0: 7273 6976 653a 2049 6620 4661 6c73 652c  rsive: If False,
+0000c6f0: 2060 2a2a 6020 7769 6c6c 206e 6f74 2073   `**` will not s
+0000c700: 6561 7263 6820 6469 7265 6374 6f72 7920  earch directory 
+0000c710: 7265 6375 7273 6976 656c 790a 2020 2020  recursively.    
+0000c720: 2020 2020 3a70 6172 616d 206d 6973 7369      :param missi
+0000c730: 6e67 5f6f 6b3a 2049 6620 4661 6c73 6520  ng_ok: If False 
+0000c740: 616e 6420 7461 7267 6574 2070 6174 6820  and target path 
+0000c750: 646f 6573 6e27 7420 6d61 7463 6820 616e  doesn't match an
+0000c760: 7920 6669 6c65 2c20 7261 6973 6520 4669  y file, raise Fi
+0000c770: 6c65 4e6f 7446 6f75 6e64 4572 726f 720a  leNotFoundError.
+0000c780: 2020 2020 2020 2020 3a72 6169 7365 733a          :raises:
+0000c790: 2055 6e73 7570 706f 7274 6564 4572 726f   UnsupportedErro
+0000c7a0: 722c 2077 6865 6e20 6275 636b 6574 2070  r, when bucket p
+0000c7b0: 6172 7420 636f 6e74 6169 6e73 2077 696c  art contains wil
+0000c7c0: 6463 6172 6420 6368 6172 6163 7465 7273  dcard characters
+0000c7d0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+0000c7e0: 733a 2041 6e20 6974 6572 6174 6f72 2063  s: An iterator c
+0000c7f0: 6f6e 7461 696e 7320 7061 7468 7320 6d61  ontains paths ma
+0000c800: 7463 6820 6073 335f 7061 7468 6e61 6d65  tch `s3_pathname
+0000c810: 600a 2020 2020 2020 2020 2727 270a 2020  `.        '''.  
+0000c820: 2020 2020 2020 666f 7220 6669 6c65 5f65        for file_e
+0000c830: 6e74 7279 2069 6e20 7365 6c66 2e67 6c6f  ntry in self.glo
+0000c840: 625f 7374 6174 2870 6174 7465 726e 3d70  b_stat(pattern=p
+0000c850: 6174 7465 726e 2c20 7265 6375 7273 6976  attern, recursiv
+0000c860: 653d 7265 6375 7273 6976 652c 0a20 2020  e=recursive,.   
+0000c870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c890: 2020 2020 2020 6d69 7373 696e 675f 6f6b        missing_ok
+0000c8a0: 3d6d 6973 7369 6e67 5f6f 6b2c 0a20 2020  =missing_ok,.   
+0000c8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c8d0: 2020 2020 2020 666f 6c6c 6f77 6c69 6e6b        followlink
+0000c8e0: 733d 666f 6c6c 6f77 6c69 6e6b 7329 3a0a  s=followlinks):.
+0000c8f0: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
+0000c900: 6420 7365 6c66 2e66 726f 6d5f 7061 7468  d self.from_path
+0000c910: 2866 696c 655f 656e 7472 792e 7061 7468  (file_entry.path
+0000c920: 290a 0a20 2020 2064 6566 2069 735f 6469  )..    def is_di
+0000c930: 7228 7365 6c66 2c20 666f 6c6c 6f77 6c69  r(self, followli
+0000c940: 6e6b 733a 2062 6f6f 6c20 3d20 4661 6c73  nks: bool = Fals
+0000c950: 6529 202d 3e20 626f 6f6c 3a0a 2020 2020  e) -> bool:.    
+0000c960: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
+0000c970: 5465 7374 2069 6620 616e 2073 3320 7572  Test if an s3 ur
+0000c980: 6c20 6973 2064 6972 6563 746f 7279 0a20  l is directory. 
+0000c990: 2020 2020 2020 2053 7065 6369 6669 6320         Specific 
+0000c9a0: 7072 6f63 6564 7572 6573 2061 7265 2061  procedures are a
+0000c9b0: 7320 666f 6c6c 6f77 733a 0a20 2020 2020  s follows:.     
+0000c9c0: 2020 2049 6620 7468 6572 6520 6578 6973     If there exis
+0000c9d0: 7473 2061 2073 7566 6669 782c 206f 6620  ts a suffix, of 
+0000c9e0: 7768 6963 6820 6060 6f73 2e70 6174 682e  which ``os.path.
+0000c9f0: 6a6f 696e 2873 335f 7572 6c2c 2073 7566  join(s3_url, suf
+0000ca00: 6669 7829 6060 2069 7320 6120 6669 6c65  fix)`` is a file
+0000ca10: 0a20 2020 2020 2020 2049 6620 7468 6520  .        If the 
+0000ca20: 7572 6c20 6973 2065 6d70 7479 2062 7563  url is empty buc
+0000ca30: 6b65 7420 6f72 2073 333a 2f2f 0a0a 2020  ket or s3://..  
+0000ca40: 2020 2020 2020 3a70 6172 616d 2066 6f6c        :param fol
+0000ca50: 6c6f 776c 696e 6b73 3a20 7768 6574 6865  lowlinks: whethe
+0000ca60: 7220 666f 6c6c 6f77 6c69 6e6b 7320 6973  r followlinks is
+0000ca70: 2054 7275 6520 6f72 2046 616c 7365 2c20   True or False, 
+0000ca80: 7265 7375 6c74 2069 7320 7468 6520 7361  result is the sa
+0000ca90: 6d65 2e20 4265 6361 7573 6520 7333 2073  me. Because s3 s
+0000caa0: 796d 6c69 6e6b 206e 6f74 2073 7570 706f  ymlink not suppo
+0000cab0: 7274 2064 6972 2e0a 2020 2020 2020 2020  rt dir..        
+0000cac0: 3a72 6574 7572 6e73 3a20 5472 7565 2069  :returns: True i
+0000cad0: 6620 7061 7468 2069 7320 7333 2064 6972  f path is s3 dir
+0000cae0: 6563 746f 7279 2c20 656c 7365 2046 616c  ectory, else Fal
+0000caf0: 7365 0a20 2020 2020 2020 2027 2727 0a20  se.        '''. 
+0000cb00: 2020 2020 2020 2062 7563 6b65 742c 206b         bucket, k
+0000cb10: 6579 203d 2070 6172 7365 5f73 335f 7572  ey = parse_s3_ur
+0000cb20: 6c28 7365 6c66 2e70 6174 685f 7769 7468  l(self.path_with
+0000cb30: 5f70 726f 746f 636f 6c29 0a20 2020 2020  _protocol).     
+0000cb40: 2020 2069 6620 6e6f 7420 6275 636b 6574     if not bucket
+0000cb50: 3a20 2023 2073 333a 2f2f 203d 3e20 5472  :  # s3:// => Tr
+0000cb60: 7565 2c20 7333 3a2f 2f2f 6b65 7920 3d3e  ue, s3:///key =>
+0000cb70: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
+0000cb80: 2020 2072 6574 7572 6e20 6e6f 7420 6b65     return not ke
+0000cb90: 790a 2020 2020 2020 2020 7072 6566 6978  y.        prefix
+0000cba0: 203d 205f 6265 636f 6d65 5f70 7265 6669   = _become_prefi
+0000cbb0: 7828 6b65 7929 0a20 2020 2020 2020 2074  x(key).        t
+0000cbc0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0000cbd0: 7265 7370 203d 2073 656c 662e 5f63 6c69  resp = self._cli
+0000cbe0: 656e 742e 6c69 7374 5f6f 626a 6563 7473  ent.list_objects
+0000cbf0: 5f76 3228 0a20 2020 2020 2020 2020 2020  _v2(.           
+0000cc00: 2020 2020 2042 7563 6b65 743d 6275 636b       Bucket=buck
+0000cc10: 6574 2c20 5072 6566 6978 3d70 7265 6669  et, Prefix=prefi
+0000cc20: 782c 2044 656c 696d 6974 6572 3d27 2f27  x, Delimiter='/'
+0000cc30: 2c20 4d61 784b 6579 733d 3129 0a20 2020  , MaxKeys=1).   
+0000cc40: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
+0000cc50: 7074 696f 6e20 6173 2065 7272 6f72 3a0a  ption as error:.
+0000cc60: 2020 2020 2020 2020 2020 2020 6572 726f              erro
+0000cc70: 7220 3d20 7472 616e 736c 6174 655f 7333  r = translate_s3
+0000cc80: 5f65 7272 6f72 2865 7272 6f72 2c20 7365  _error(error, se
+0000cc90: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
+0000cca0: 746f 636f 6c29 0a20 2020 2020 2020 2020  tocol).         
+0000ccb0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+0000ccc0: 2865 7272 6f72 2c0a 2020 2020 2020 2020  (error,.        
+0000ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cce0: 2020 2853 3355 6e6b 6e6f 776e 4572 726f    (S3UnknownErro
+0000ccf0: 722c 2053 3343 6f6e 6669 6745 7272 6f72  r, S3ConfigError
+0000cd00: 2c20 5333 5065 726d 6973 7369 6f6e 4572  , S3PermissionEr
+0000cd10: 726f 7229 293a 0a20 2020 2020 2020 2020  ror)):.         
+0000cd20: 2020 2020 2020 2072 6169 7365 2065 7272         raise err
+0000cd30: 6f72 0a20 2020 2020 2020 2020 2020 2072  or.            r
+0000cd40: 6574 7572 6e20 4661 6c73 650a 0a20 2020  eturn False..   
+0000cd50: 2020 2020 2069 6620 6e6f 7420 6b65 793a       if not key:
+0000cd60: 2020 2320 6275 636b 6574 2069 7320 6163    # bucket is ac
+0000cd70: 6365 7373 6962 6c65 0a20 2020 2020 2020  cessible.       
+0000cd80: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
+0000cd90: 0a0a 2020 2020 2020 2020 6966 2027 4b65  ..        if 'Ke
+0000cda0: 7943 6f75 6e74 2720 696e 2072 6573 703a  yCount' in resp:
+0000cdb0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0000cdc0: 7572 6e20 7265 7370 5b27 4b65 7943 6f75  urn resp['KeyCou
+0000cdd0: 6e74 275d 203e 2030 0a0a 2020 2020 2020  nt'] > 0..      
+0000cde0: 2020 7265 7475 726e 206c 656e 2872 6573    return len(res
+0000cdf0: 702e 6765 7428 2743 6f6e 7465 6e74 7327  p.get('Contents'
+0000ce00: 2c20 5b5d 2929 203e 2030 206f 7220 5c0a  , [])) > 0 or \.
+0000ce10: 2020 2020 2020 2020 2020 2020 6c65 6e28              len(
+0000ce20: 7265 7370 2e67 6574 2827 436f 6d6d 6f6e  resp.get('Common
+0000ce30: 5072 6566 6978 6573 272c 205b 5d29 2920  Prefixes', [])) 
+0000ce40: 3e20 300a 0a20 2020 2064 6566 2069 735f  > 0..    def is_
+0000ce50: 6669 6c65 2873 656c 662c 2066 6f6c 6c6f  file(self, follo
+0000ce60: 776c 696e 6b73 3a20 626f 6f6c 203d 2046  wlinks: bool = F
+0000ce70: 616c 7365 2920 2d3e 2062 6f6f 6c3a 0a20  alse) -> bool:. 
+0000ce80: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+0000ce90: 2020 2054 6573 7420 6966 2061 6e20 7333     Test if an s3
+0000cea0: 5f75 726c 2069 7320 6669 6c65 0a0a 2020  _url is file..  
+0000ceb0: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
+0000cec0: 5472 7565 2069 6620 7061 7468 2069 7320  True if path is 
+0000ced0: 7333 2066 696c 652c 2065 6c73 6520 4661  s3 file, else Fa
+0000cee0: 6c73 650a 2020 2020 2020 2020 2727 270a  lse.        '''.
+0000cef0: 2020 2020 2020 2020 7333 5f75 726c 203d          s3_url =
+0000cf00: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
+0000cf10: 7072 6f74 6f63 6f6c 0a20 2020 2020 2020  protocol.       
+0000cf20: 2069 6620 666f 6c6c 6f77 6c69 6e6b 733a   if followlinks:
+0000cf30: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
+0000cf40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000cf50: 2020 7333 5f75 726c 203d 2073 656c 662e    s3_url = self.
+0000cf60: 7265 6164 6c69 6e6b 2829 2e70 6174 685f  readlink().path_
+0000cf70: 7769 7468 5f70 726f 746f 636f 6c0a 2020  with_protocol.  
+0000cf80: 2020 2020 2020 2020 2020 6578 6365 7074            except
+0000cf90: 2053 334e 6f74 414c 696e 6b45 7272 6f72   S3NotALinkError
+0000cfa0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000cfb0: 2020 7061 7373 0a20 2020 2020 2020 2062    pass.        b
+0000cfc0: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
+0000cfd0: 7365 5f73 335f 7572 6c28 7333 5f75 726c  se_s3_url(s3_url
+0000cfe0: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+0000cff0: 2062 7563 6b65 7420 6f72 206e 6f74 206b   bucket or not k
+0000d000: 6579 206f 7220 6b65 792e 656e 6473 7769  ey or key.endswi
+0000d010: 7468 2827 2f27 293a 0a20 2020 2020 2020  th('/'):.       
+0000d020: 2020 2020 2023 2073 333a 2f2f 2c20 7333       # s3://, s3
+0000d030: 3a2f 2f2f 6b65 792c 2073 333a 2f2f 6275  :///key, s3://bu
+0000d040: 636b 6574 2c20 7333 3a2f 2f62 7563 6b65  cket, s3://bucke
+0000d050: 742f 7072 6566 6978 2f0a 2020 2020 2020  t/prefix/.      
+0000d060: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
+0000d070: 7365 0a20 2020 2020 2020 2074 7279 3a0a  se.        try:.
+0000d080: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000d090: 2e5f 636c 6965 6e74 2e68 6561 645f 6f62  ._client.head_ob
+0000d0a0: 6a65 6374 2842 7563 6b65 743d 6275 636b  ject(Bucket=buck
+0000d0b0: 6574 2c20 4b65 793d 6b65 7929 0a20 2020  et, Key=key).   
+0000d0c0: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
+0000d0d0: 7074 696f 6e20 6173 2065 7272 6f72 3a0a  ption as error:.
+0000d0e0: 2020 2020 2020 2020 2020 2020 6572 726f              erro
+0000d0f0: 7220 3d20 7472 616e 736c 6174 655f 7333  r = translate_s3
+0000d100: 5f65 7272 6f72 2865 7272 6f72 2c20 7333  _error(error, s3
+0000d110: 5f75 726c 290a 2020 2020 2020 2020 2020  _url).          
+0000d120: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0000d130: 6572 726f 722c 0a20 2020 2020 2020 2020  error,.         
+0000d140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d150: 2028 5333 556e 6b6e 6f77 6e45 7272 6f72   (S3UnknownError
+0000d160: 2c20 5333 436f 6e66 6967 4572 726f 722c  , S3ConfigError,
+0000d170: 2053 3350 6572 6d69 7373 696f 6e45 7272   S3PermissionErr
+0000d180: 6f72 2929 3a0a 2020 2020 2020 2020 2020  or)):.          
+0000d190: 2020 2020 2020 7261 6973 6520 6572 726f        raise erro
+0000d1a0: 720a 2020 2020 2020 2020 2020 2020 7265  r.            re
+0000d1b0: 7475 726e 2046 616c 7365 0a20 2020 2020  turn False.     
+0000d1c0: 2020 2072 6574 7572 6e20 5472 7565 0a0a     return True..
+0000d1d0: 2020 2020 6465 6620 6c69 7374 6469 7228      def listdir(
+0000d1e0: 7365 6c66 2c20 666f 6c6c 6f77 6c69 6e6b  self, followlink
+0000d1f0: 733a 2062 6f6f 6c20 3d20 4661 6c73 6529  s: bool = False)
+0000d200: 202d 3e20 4c69 7374 5b73 7472 5d3a 0a20   -> List[str]:. 
+0000d210: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+0000d220: 2020 2047 6574 2061 6c6c 2063 6f6e 7465     Get all conte
+0000d230: 6e74 7320 6f66 2067 6976 656e 2073 335f  nts of given s3_
+0000d240: 7572 6c2e 2054 6865 2072 6573 756c 7420  url. The result 
+0000d250: 6973 2069 6e20 6163 7365 6e64 696e 6720  is in acsending 
+0000d260: 616c 7068 6162 6574 6963 616c 206f 7264  alphabetical ord
+0000d270: 6572 2e0a 0a20 2020 2020 2020 203a 7265  er...        :re
+0000d280: 7475 726e 733a 2041 6c6c 2063 6f6e 7465  turns: All conte
+0000d290: 6e74 7320 6861 7665 2070 7265 6669 7820  nts have prefix 
+0000d2a0: 6f66 2073 335f 7572 6c20 696e 2061 6373  of s3_url in acs
+0000d2b0: 656e 6469 6e67 2061 6c70 6861 6265 7469  ending alphabeti
+0000d2c0: 6361 6c20 6f72 6465 720a 2020 2020 2020  cal order.      
+0000d2d0: 2020 3a72 6169 7365 733a 2053 3346 696c    :raises: S3Fil
+0000d2e0: 654e 6f74 466f 756e 6445 7272 6f72 2c20  eNotFoundError, 
+0000d2f0: 5333 4e6f 7441 4469 7265 6374 6f72 7945  S3NotADirectoryE
+0000d300: 7272 6f72 0a20 2020 2020 2020 2027 2727  rror.        '''
+0000d310: 0a20 2020 2020 2020 2065 6e74 7269 6573  .        entries
+0000d320: 203d 206c 6973 7428 7365 6c66 2e73 6361   = list(self.sca
+0000d330: 6e64 6972 2866 6f6c 6c6f 776c 696e 6b73  ndir(followlinks
+0000d340: 3d66 6f6c 6c6f 776c 696e 6b73 2929 0a20  =followlinks)). 
+0000d350: 2020 2020 2020 2072 6574 7572 6e20 736f         return so
+0000d360: 7274 6564 285b 656e 7472 792e 6e61 6d65  rted([entry.name
+0000d370: 2066 6f72 2065 6e74 7279 2069 6e20 656e   for entry in en
+0000d380: 7472 6965 735d 290a 0a20 2020 2064 6566  tries])..    def
+0000d390: 2069 7465 7264 6972 2873 656c 662c 2066   iterdir(self, f
+0000d3a0: 6f6c 6c6f 776c 696e 6b73 3a20 626f 6f6c  ollowlinks: bool
+0000d3b0: 203d 2046 616c 7365 2920 2d3e 2049 7465   = False) -> Ite
+0000d3c0: 7261 746f 725b 2753 3350 6174 6827 5d3a  rator['S3Path']:
+0000d3d0: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
+0000d3e0: 2020 2020 2047 6574 2061 6c6c 2063 6f6e       Get all con
+0000d3f0: 7465 6e74 7320 6f66 2067 6976 656e 2073  tents of given s
+0000d400: 335f 7572 6c2e 2054 6865 2072 6573 756c  3_url. The resul
+0000d410: 7420 6973 2069 6e20 6163 7365 6e64 696e  t is in acsendin
+0000d420: 6720 616c 7068 6162 6574 6963 616c 206f  g alphabetical o
+0000d430: 7264 6572 2e0a 0a20 2020 2020 2020 203a  rder...        :
+0000d440: 7265 7475 726e 733a 2041 6c6c 2063 6f6e  returns: All con
+0000d450: 7465 6e74 7320 6861 7665 2070 7265 6669  tents have prefi
+0000d460: 7820 6f66 2073 335f 7572 6c20 696e 2061  x of s3_url in a
+0000d470: 6373 656e 6469 6e67 2061 6c70 6861 6265  csending alphabe
+0000d480: 7469 6361 6c20 6f72 6465 720a 2020 2020  tical order.    
+0000d490: 2020 2020 3a72 6169 7365 733a 2053 3346      :raises: S3F
+0000d4a0: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
+0000d4b0: 2c20 5333 4e6f 7441 4469 7265 6374 6f72  , S3NotADirector
+0000d4c0: 7945 7272 6f72 0a20 2020 2020 2020 2027  yError.        '
+0000d4d0: 2727 0a20 2020 2020 2020 2066 6f72 2070  ''.        for p
+0000d4e0: 6174 6820 696e 2073 656c 662e 6c69 7374  ath in self.list
+0000d4f0: 6469 7228 666f 6c6c 6f77 6c69 6e6b 733d  dir(followlinks=
+0000d500: 666f 6c6c 6f77 6c69 6e6b 7329 3a0a 2020  followlinks):.  
+0000d510: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
+0000d520: 7365 6c66 2e6a 6f69 6e70 6174 6828 7061  self.joinpath(pa
+0000d530: 7468 2920 2023 2074 7970 653a 2069 676e  th)  # type: ign
+0000d540: 6f72 650a 0a20 2020 2064 6566 206c 6f61  ore..    def loa
+0000d550: 6428 7365 6c66 2c20 666f 6c6c 6f77 6c69  d(self, followli
+0000d560: 6e6b 733a 2062 6f6f 6c20 3d20 4661 6c73  nks: bool = Fals
+0000d570: 6529 202d 3e20 4269 6e61 7279 494f 3a0a  e) -> BinaryIO:.
+0000d580: 2020 2020 2020 2020 2727 2752 6561 6420          '''Read 
+0000d590: 616c 6c20 636f 6e74 656e 7420 696e 2062  all content in b
+0000d5a0: 696e 6172 7920 6f6e 2073 7065 6369 6669  inary on specifi
+0000d5b0: 6564 2070 6174 6820 616e 6420 7772 6974  ed path and writ
+0000d5c0: 6520 696e 746f 206d 656d 6f72 790a 0a20  e into memory.. 
+0000d5d0: 2020 2020 2020 2055 7365 7220 7368 6f75         User shou
+0000d5e0: 6c64 2063 6c6f 7365 2074 6865 2042 696e  ld close the Bin
+0000d5f0: 6172 7949 4f20 6d61 6e75 616c 6c79 0a0a  aryIO manually..
+0000d600: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
+0000d610: 3a20 4269 6e61 7279 494f 0a20 2020 2020  : BinaryIO.     
+0000d620: 2020 2027 2727 0a20 2020 2020 2020 2073     '''.        s
+0000d630: 335f 7572 6c20 3d20 7365 6c66 2e70 6174  3_url = self.pat
+0000d640: 685f 7769 7468 5f70 726f 746f 636f 6c0a  h_with_protocol.
+0000d650: 2020 2020 2020 2020 6966 2066 6f6c 6c6f          if follo
+0000d660: 776c 696e 6b73 3a0a 2020 2020 2020 2020  wlinks:.        
+0000d670: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0000d680: 2020 2020 2020 2020 2073 335f 7572 6c20           s3_url 
+0000d690: 3d20 7365 6c66 2e72 6561 646c 696e 6b28  = self.readlink(
+0000d6a0: 292e 7061 7468 5f77 6974 685f 7072 6f74  ).path_with_prot
+0000d6b0: 6f63 6f6c 0a20 2020 2020 2020 2020 2020  ocol.           
+0000d6c0: 2065 7863 6570 7420 5333 4e6f 7441 4c69   except S3NotALi
+0000d6d0: 6e6b 4572 726f 723a 0a20 2020 2020 2020  nkError:.       
+0000d6e0: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
+0000d6f0: 2020 2020 2020 6275 636b 6574 2c20 6b65        bucket, ke
+0000d700: 7920 3d20 7061 7273 655f 7333 5f75 726c  y = parse_s3_url
+0000d710: 2873 335f 7572 6c29 0a20 2020 2020 2020  (s3_url).       
+0000d720: 2069 6620 6e6f 7420 6275 636b 6574 3a0a   if not bucket:.
+0000d730: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000d740: 6520 5333 4275 636b 6574 4e6f 7446 6f75  e S3BucketNotFou
+0000d750: 6e64 4572 726f 7228 2745 6d70 7479 2062  ndError('Empty b
+0000d760: 7563 6b65 7420 6e61 6d65 3a20 2572 2720  ucket name: %r' 
+0000d770: 2520 7333 5f75 726c 290a 2020 2020 2020  % s3_url).      
+0000d780: 2020 6966 206e 6f74 206b 6579 206f 7220    if not key or 
+0000d790: 6b65 792e 656e 6473 7769 7468 2827 2f27  key.endswith('/'
+0000d7a0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+0000d7b0: 6169 7365 2053 3349 7341 4469 7265 6374  aise S3IsADirect
+0000d7c0: 6f72 7945 7272 6f72 2827 4973 2061 2064  oryError('Is a d
+0000d7d0: 6972 6563 746f 7279 3a20 2572 2720 2520  irectory: %r' % 
+0000d7e0: 7333 5f75 726c 290a 0a20 2020 2020 2020  s3_url)..       
+0000d7f0: 2062 7566 6665 7220 3d20 696f 2e42 7974   buffer = io.Byt
+0000d800: 6573 494f 2829 0a20 2020 2020 2020 2077  esIO().        w
+0000d810: 6974 6820 7261 6973 655f 7333 5f65 7272  ith raise_s3_err
+0000d820: 6f72 2873 335f 7572 6c29 3a0a 2020 2020  or(s3_url):.    
+0000d830: 2020 2020 2020 2020 7365 6c66 2e5f 636c          self._cl
+0000d840: 6965 6e74 2e64 6f77 6e6c 6f61 645f 6669  ient.download_fi
+0000d850: 6c65 6f62 6a28 6275 636b 6574 2c20 6b65  leobj(bucket, ke
+0000d860: 792c 2062 7566 6665 7229 0a20 2020 2020  y, buffer).     
+0000d870: 2020 2062 7566 6665 722e 7365 656b 2830     buffer.seek(0
+0000d880: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+0000d890: 2062 7566 6665 720a 0a20 2020 2064 6566   buffer..    def
+0000d8a0: 2068 6173 6275 636b 6574 2873 656c 6629   hasbucket(self)
+0000d8b0: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
+0000d8c0: 2020 2727 270a 2020 2020 2020 2020 5465    '''.        Te
+0000d8d0: 7374 2069 6620 7468 6520 6275 636b 6574  st if the bucket
+0000d8e0: 206f 6620 7333 5f75 726c 2065 7869 7374   of s3_url exist
+0000d8f0: 730a 0a20 2020 2020 2020 203a 7265 7475  s..        :retu
+0000d900: 726e 733a 2054 7275 6520 6966 2062 7563  rns: True if buc
+0000d910: 6b65 7420 6f66 2073 335f 7572 6c20 6569  ket of s3_url ei
+0000d920: 7873 7473 2c20 656c 7365 2046 616c 7365  xsts, else False
+0000d930: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
+0000d940: 2020 2020 2062 7563 6b65 742c 205f 203d       bucket, _ =
+0000d950: 2070 6172 7365 5f73 335f 7572 6c28 7365   parse_s3_url(se
+0000d960: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
+0000d970: 746f 636f 6c29 0a20 2020 2020 2020 2069  tocol).        i
+0000d980: 6620 6e6f 7420 6275 636b 6574 3a0a 2020  f not bucket:.  
+0000d990: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000d9a0: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
+0000d9b0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0000d9c0: 2073 656c 662e 5f63 6c69 656e 742e 6865   self._client.he
+0000d9d0: 6164 5f62 7563 6b65 7428 4275 636b 6574  ad_bucket(Bucket
+0000d9e0: 3d62 7563 6b65 7429 0a20 2020 2020 2020  =bucket).       
+0000d9f0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+0000da00: 6e20 6173 2065 7272 6f72 3a0a 2020 2020  n as error:.    
+0000da10: 2020 2020 2020 2020 6572 726f 7220 3d20          error = 
+0000da20: 7472 616e 736c 6174 655f 7333 5f65 7272  translate_s3_err
+0000da30: 6f72 2865 7272 6f72 2c20 7365 6c66 2e70  or(error, self.p
+0000da40: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+0000da50: 6c29 0a20 2020 2020 2020 2020 2020 2069  l).            i
+0000da60: 6620 6973 696e 7374 616e 6365 2865 7272  f isinstance(err
+0000da70: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
+0000da80: 2020 2020 2020 2020 2020 2020 2020 2853                (S
+0000da90: 3355 6e6b 6e6f 776e 4572 726f 722c 2053  3UnknownError, S
+0000daa0: 3343 6f6e 6669 6745 7272 6f72 2c20 5333  3ConfigError, S3
+0000dab0: 5065 726d 6973 7369 6f6e 4572 726f 7229  PermissionError)
+0000dac0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000dad0: 2020 2072 6169 7365 2065 7272 6f72 0a20     raise error. 
+0000dae0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+0000daf0: 696e 7374 616e 6365 2865 7272 6f72 2c20  instance(error, 
+0000db00: 5333 4669 6c65 4e6f 7446 6f75 6e64 4572  S3FileNotFoundEr
+0000db10: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+0000db20: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
+0000db30: 7365 0a0a 2020 2020 2020 2020 7265 7475  se..        retu
+0000db40: 726e 2054 7275 650a 0a20 2020 2064 6566  rn True..    def
+0000db50: 206d 6b64 6972 2873 656c 662c 206d 6f64   mkdir(self, mod
+0000db60: 653d 306f 3737 372c 2070 6172 656e 7473  e=0o777, parents
+0000db70: 3a20 626f 6f6c 203d 2046 616c 7365 2c20  : bool = False, 
+0000db80: 6578 6973 745f 6f6b 3a20 626f 6f6c 203d  exist_ok: bool =
+0000db90: 2046 616c 7365 293a 0a20 2020 2020 2020   False):.       
+0000dba0: 2027 2727 0a20 2020 2020 2020 2043 7265   '''.        Cre
+0000dbb0: 6174 6520 616e 2073 3320 6469 7265 6374  ate an s3 direct
+0000dbc0: 6f72 792e 0a20 2020 2020 2020 2050 7572  ory..        Pur
+0000dbd0: 656c 7920 6372 6561 7469 6e67 2064 6972  ely creating dir
+0000dbe0: 6563 746f 7279 2069 7320 696e 7661 6c69  ectory is invali
+0000dbf0: 6420 6265 6361 7573 6520 6974 2773 2075  d because it's u
+0000dc00: 6e61 7661 696c 6162 6c65 206f 6e20 4f53  navailable on OS
+0000dc10: 532e 0a20 2020 2020 2020 2054 6869 7320  S..        This 
+0000dc20: 6675 6e63 7469 6f6e 2069 7320 746f 2074  function is to t
+0000dc30: 6573 7420 7468 6520 7461 7267 6574 2062  est the target b
+0000dc40: 7563 6b65 7420 6861 7665 2057 5249 5445  ucket have WRITE
+0000dc50: 2061 6363 6573 732e 0a0a 2020 2020 2020   access...      
+0000dc60: 2020 3a70 6172 616d 206d 6f64 653a 206d    :param mode: m
+0000dc70: 6f64 6520 6973 2069 676e 6f72 6564 2c20  ode is ignored, 
+0000dc80: 6f6e 6c79 2062 6520 636f 6d70 6174 6962  only be compatib
+0000dc90: 6c65 2077 6974 6820 7061 7468 6c69 622e  le with pathlib.
+0000dca0: 5061 7468 0a20 2020 2020 2020 203a 7061  Path.        :pa
+0000dcb0: 7261 6d20 7061 7265 6e74 733a 2070 6172  ram parents: par
+0000dcc0: 656e 7473 2069 7320 6967 6e6f 7265 642c  ents is ignored,
+0000dcd0: 206f 6e6c 7920 6265 2063 6f6d 7061 7469   only be compati
+0000dce0: 626c 6520 7769 7468 2070 6174 686c 6962  ble with pathlib
+0000dcf0: 2e50 6174 680a 2020 2020 2020 2020 3a70  .Path.        :p
+0000dd00: 6172 616d 2065 7869 7374 5f6f 6b3a 2049  aram exist_ok: I
+0000dd10: 6620 4661 6c73 6520 616e 6420 7461 7267  f False and targ
+0000dd20: 6574 2064 6972 6563 746f 7279 2065 7869  et directory exi
+0000dd30: 7374 732c 2072 6169 7365 2053 3346 696c  sts, raise S3Fil
+0000dd40: 6545 7869 7374 7345 7272 6f72 0a20 2020  eExistsError.   
+0000dd50: 2020 2020 203a 7261 6973 6573 3a20 5333       :raises: S3
+0000dd60: 4275 636b 6574 4e6f 7446 6f75 6e64 4572  BucketNotFoundEr
+0000dd70: 726f 722c 2053 3346 696c 6545 7869 7374  ror, S3FileExist
+0000dd80: 7345 7272 6f72 0a20 2020 2020 2020 2027  sError.        '
+0000dd90: 2727 0a20 2020 2020 2020 2062 7563 6b65  ''.        bucke
+0000dda0: 742c 205f 203d 2070 6172 7365 5f73 335f  t, _ = parse_s3_
+0000ddb0: 7572 6c28 7365 6c66 2e70 6174 685f 7769  url(self.path_wi
+0000ddc0: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
+0000ddd0: 2020 2020 2069 6620 6e6f 7420 6275 636b       if not buck
+0000dde0: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
+0000ddf0: 7261 6973 6520 5333 4275 636b 6574 4e6f  raise S3BucketNo
+0000de00: 7446 6f75 6e64 4572 726f 7228 0a20 2020  tFoundError(.   
+0000de10: 2020 2020 2020 2020 2020 2020 2027 456d               'Em
+0000de20: 7074 7920 6275 636b 6574 206e 616d 653a  pty bucket name:
+0000de30: 2025 7227 2025 2073 656c 662e 7061 7468   %r' % self.path
+0000de40: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
+0000de50: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+0000de60: 656c 662e 6861 7362 7563 6b65 7428 293a  elf.hasbucket():
+0000de70: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0000de80: 7365 2053 3342 7563 6b65 744e 6f74 466f  se S3BucketNotFo
+0000de90: 756e 6445 7272 6f72 280a 2020 2020 2020  undError(.      
+0000dea0: 2020 2020 2020 2020 2020 274e 6f20 7375            'No su
+0000deb0: 6368 2062 7563 6b65 743a 2025 7227 2025  ch bucket: %r' %
+0000dec0: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
+0000ded0: 7072 6f74 6f63 6f6c 290a 2020 2020 2020  protocol).      
+0000dee0: 2020 6966 2065 7869 7374 5f6f 6b3a 0a20    if exist_ok:. 
+0000def0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+0000df00: 6c66 2e69 735f 6669 6c65 2829 3a0a 2020  lf.is_file():.  
+0000df10: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0000df20: 6973 6520 5333 4669 6c65 4578 6973 7473  ise S3FileExists
+0000df30: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+0000df40: 2020 2020 2020 2020 2020 2027 4669 6c65             'File
+0000df50: 2065 7869 7374 733a 2025 7227 2025 2073   exists: %r' % s
+0000df60: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
+0000df70: 6f74 6f63 6f6c 290a 2020 2020 2020 2020  otocol).        
+0000df80: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
+0000df90: 2020 2069 6620 7365 6c66 2e65 7869 7374     if self.exist
+0000dfa0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+0000dfb0: 2072 6169 7365 2053 3346 696c 6545 7869   raise S3FileExi
+0000dfc0: 7374 7345 7272 6f72 2827 4669 6c65 2065  stsError('File e
+0000dfd0: 7869 7374 733a 2025 7227 2025 2073 656c  xists: %r' % sel
+0000dfe0: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
+0000dff0: 6f63 6f6c 290a 0a20 2020 2064 6566 206d  ocol)..    def m
+0000e000: 6f76 6528 7365 6c66 2c20 6473 745f 7572  ove(self, dst_ur
+0000e010: 6c3a 2050 6174 684c 696b 6529 202d 3e20  l: PathLike) -> 
+0000e020: 4e6f 6e65 3a0a 2020 2020 2020 2020 2727  None:.        ''
+0000e030: 270a 2020 2020 2020 2020 4d6f 7665 2066  '.        Move f
+0000e040: 696c 652f 6469 7265 6374 6f72 7920 7061  ile/directory pa
+0000e050: 7468 2066 726f 6d20 7372 635f 7572 6c20  th from src_url 
+0000e060: 746f 2064 7374 5f75 726c 0a0a 2020 2020  to dst_url..    
+0000e070: 2020 2020 3a70 6172 616d 2064 7374 5f75      :param dst_u
+0000e080: 726c 3a20 4769 7665 6e20 6465 7374 696e  rl: Given destin
+0000e090: 6174 696f 6e20 7061 7468 0a20 2020 2020  ation path.     
+0000e0a0: 2020 2027 2727 0a20 2020 2020 2020 2066     '''.        f
+0000e0b0: 6f72 2073 7263 5f66 696c 655f 7061 7468  or src_file_path
+0000e0c0: 2c20 6473 745f 6669 6c65 5f70 6174 6820  , dst_file_path 
+0000e0d0: 696e 205f 7333 5f73 6361 6e5f 7061 6972  in _s3_scan_pair
+0000e0e0: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
+0000e0f0: 2020 2073 656c 662e 7061 7468 5f77 6974     self.path_wit
+0000e100: 685f 7072 6f74 6f63 6f6c 2c20 6473 745f  h_protocol, dst_
+0000e110: 7572 6c29 3a0a 2020 2020 2020 2020 2020  url):.          
+0000e120: 2020 5333 5061 7468 2873 7263 5f66 696c    S3Path(src_fil
+0000e130: 655f 7061 7468 292e 7265 6e61 6d65 2864  e_path).rename(d
+0000e140: 7374 5f66 696c 655f 7061 7468 290a 0a20  st_file_path).. 
+0000e150: 2020 2064 6566 2072 656d 6f76 6528 7365     def remove(se
+0000e160: 6c66 2c20 6d69 7373 696e 675f 6f6b 3a20  lf, missing_ok: 
+0000e170: 626f 6f6c 203d 2046 616c 7365 2920 2d3e  bool = False) ->
+0000e180: 204e 6f6e 653a 0a20 2020 2020 2020 2027   None:.        '
+0000e190: 2727 0a20 2020 2020 2020 2052 656d 6f76  ''.        Remov
+0000e1a0: 6520 7468 6520 6669 6c65 206f 7220 6469  e the file or di
+0000e1b0: 7265 6374 6f72 7920 6f6e 2073 332c 2060  rectory on s3, `
+0000e1c0: 7333 3a2f 2f60 2061 6e64 2060 7333 3a2f  s3://` and `s3:/
+0000e1d0: 2f62 7563 6b65 7460 2061 7265 206e 6f74  /bucket` are not
+0000e1e0: 2070 6572 6d69 7474 6564 2074 6f20 7265   permitted to re
+0000e1f0: 6d6f 7665 0a0a 2020 2020 2020 2020 3a70  move..        :p
+0000e200: 6172 616d 206d 6973 7369 6e67 5f6f 6b3a  aram missing_ok:
+0000e210: 2069 6620 4661 6c73 6520 616e 6420 7461   if False and ta
+0000e220: 7267 6574 2066 696c 652f 6469 7265 6374  rget file/direct
+0000e230: 6f72 7920 6e6f 7420 6578 6973 7473 2c20  ory not exists, 
+0000e240: 7261 6973 6520 5333 4669 6c65 4e6f 7446  raise S3FileNotF
+0000e250: 6f75 6e64 4572 726f 720a 2020 2020 2020  oundError.      
+0000e260: 2020 3a72 6169 7365 733a 2053 3350 6572    :raises: S3Per
+0000e270: 6d69 7373 696f 6e45 7272 6f72 2c20 5333  missionError, S3
+0000e280: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
+0000e290: 722c 2055 6e73 7570 706f 7274 6564 4572  r, UnsupportedEr
+0000e2a0: 726f 720a 2020 2020 2020 2020 2727 270a  ror.        '''.
+0000e2b0: 2020 2020 2020 2020 6275 636b 6574 2c20          bucket, 
+0000e2c0: 6b65 7920 3d20 7061 7273 655f 7333 5f75  key = parse_s3_u
+0000e2d0: 726c 2873 656c 662e 7061 7468 5f77 6974  rl(self.path_wit
+0000e2e0: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
+0000e2f0: 2020 2020 6966 206e 6f74 2062 7563 6b65      if not bucke
+0000e300: 743a 0a20 2020 2020 2020 2020 2020 2069  t:.            i
+0000e310: 6620 6e6f 7420 6b65 793a 0a20 2020 2020  f not key:.     
+0000e320: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000e330: 2055 6e73 7570 706f 7274 6564 4572 726f   UnsupportedErro
+0000e340: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+0000e350: 2020 2020 2020 2027 5265 6d6f 7665 2077         'Remove w
+0000e360: 686f 6c65 2073 3327 2c20 7365 6c66 2e70  hole s3', self.p
+0000e370: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+0000e380: 6c29 0a20 2020 2020 2020 2020 2020 2072  l).            r
+0000e390: 6169 7365 2053 3342 7563 6b65 744e 6f74  aise S3BucketNot
+0000e3a0: 466f 756e 6445 7272 6f72 280a 2020 2020  FoundError(.    
+0000e3b0: 2020 2020 2020 2020 2020 2020 2745 6d70              'Emp
+0000e3c0: 7479 2062 7563 6b65 7420 6e61 6d65 3a20  ty bucket name: 
+0000e3d0: 2572 2720 2520 7365 6c66 2e70 6174 685f  %r' % self.path_
+0000e3e0: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
+0000e3f0: 2020 2020 2020 2069 6620 6e6f 7420 6b65         if not ke
+0000e400: 793a 0a20 2020 2020 2020 2020 2020 2072  y:.            r
+0000e410: 6169 7365 2055 6e73 7570 706f 7274 6564  aise Unsupported
+0000e420: 4572 726f 7228 2752 656d 6f76 6520 6275  Error('Remove bu
+0000e430: 636b 6574 272c 2073 656c 662e 7061 7468  cket', self.path
+0000e440: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
+0000e450: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+0000e460: 656c 662e 6578 6973 7473 2829 3a0a 2020  elf.exists():.  
+0000e470: 2020 2020 2020 2020 2020 6966 206d 6973            if mis
+0000e480: 7369 6e67 5f6f 6b3a 0a20 2020 2020 2020  sing_ok:.       
+0000e490: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+0000e4a0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000e4b0: 6520 5333 4669 6c65 4e6f 7446 6f75 6e64  e S3FileNotFound
+0000e4c0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+0000e4d0: 2020 2020 2020 2027 4e6f 2073 7563 6820         'No such 
+0000e4e0: 6669 6c65 206f 7220 6469 7265 6374 6f72  file or director
+0000e4f0: 793a 2025 7227 2025 2073 656c 662e 7061  y: %r' % self.pa
+0000e500: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
+0000e510: 290a 0a20 2020 2020 2020 2063 6c69 656e  )..        clien
+0000e520: 7420 3d20 7365 6c66 2e5f 636c 6965 6e74  t = self._client
+0000e530: 0a20 2020 2020 2020 2077 6974 6820 7261  .        with ra
+0000e540: 6973 655f 7333 5f65 7272 6f72 2873 656c  ise_s3_error(sel
+0000e550: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
+0000e560: 6f63 6f6c 293a 0a20 2020 2020 2020 2020  ocol):.         
+0000e570: 2020 2069 6620 7365 6c66 2e69 735f 6669     if self.is_fi
+0000e580: 6c65 2829 3a0a 2020 2020 2020 2020 2020  le():.          
+0000e590: 2020 2020 2020 636c 6965 6e74 2e64 656c        client.del
+0000e5a0: 6574 655f 6f62 6a65 6374 2842 7563 6b65  ete_object(Bucke
+0000e5b0: 743d 6275 636b 6574 2c20 4b65 793d 6b65  t=bucket, Key=ke
+0000e5c0: 7929 0a20 2020 2020 2020 2020 2020 2020  y).             
+0000e5d0: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
+0000e5e0: 2020 2020 2020 7072 6566 6978 203d 205f        prefix = _
+0000e5f0: 6265 636f 6d65 5f70 7265 6669 7828 6b65  become_prefix(ke
+0000e600: 7929 0a20 2020 2020 2020 2020 2020 2074  y).            t
+0000e610: 6f74 616c 5f63 6f75 6e74 2c20 6572 726f  otal_count, erro
+0000e620: 725f 636f 756e 7420 3d20 302c 2030 0a20  r_count = 0, 0. 
+0000e630: 2020 2020 2020 2020 2020 2066 6f72 2072             for r
+0000e640: 6573 7020 696e 205f 6c69 7374 5f6f 626a  esp in _list_obj
+0000e650: 6563 7473 5f72 6563 7572 7369 7665 2863  ects_recursive(c
+0000e660: 6c69 656e 742c 2062 7563 6b65 742c 2070  lient, bucket, p
+0000e670: 7265 6669 7829 3a0a 2020 2020 2020 2020  refix):.        
+0000e680: 2020 2020 2020 2020 6966 2027 436f 6e74          if 'Cont
+0000e690: 656e 7473 2720 696e 2072 6573 703a 0a20  ents' in resp:. 
+0000e6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e6b0: 2020 206b 6579 7320 3d20 5b0a 2020 2020     keys = [.    
+0000e6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e6d0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0000e6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e6f0: 2020 274b 6579 273a 2063 6f6e 7465 6e74    'Key': content
+0000e700: 5b27 4b65 7927 5d0a 2020 2020 2020 2020  ['Key'].        
+0000e710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e720: 7d20 666f 7220 636f 6e74 656e 7420 696e  } for content in
+0000e730: 2072 6573 705b 2743 6f6e 7465 6e74 7327   resp['Contents'
+0000e740: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0000e750: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+0000e760: 2020 2020 2020 2020 2020 2020 746f 7461              tota
+0000e770: 6c5f 636f 756e 7420 2b3d 206c 656e 286b  l_count += len(k
+0000e780: 6579 7329 0a20 2020 2020 2020 2020 2020  eys).           
+0000e790: 2020 2020 2020 2020 2065 7272 6f72 7320           errors 
+0000e7a0: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
+0000e7b0: 2020 2020 2020 2020 2072 6574 7269 6573           retries
+0000e7c0: 203d 2032 0a20 2020 2020 2020 2020 2020   = 2.           
+0000e7d0: 2020 2020 2020 2020 2072 6574 7279 5f69           retry_i
+0000e7e0: 6e74 6572 7661 6c20 3d20 6d69 6e28 302e  nterval = min(0.
+0000e7f0: 3120 2a20 322a 2a72 6574 7269 6573 2c20  1 * 2**retries, 
+0000e800: 3330 290a 2020 2020 2020 2020 2020 2020  30).            
+0000e810: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
+0000e820: 2072 616e 6765 2872 6574 7269 6573 293a   range(retries):
+0000e830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e840: 2020 2020 2020 2020 2023 2064 6f63 3a20           # doc: 
+0000e850: 6874 7470 733a 2f2f 626f 746f 332e 616d  https://boto3.am
+0000e860: 617a 6f6e 6177 732e 636f 6d2f 7631 2f64  azonaws.com/v1/d
+0000e870: 6f63 756d 656e 7461 7469 6f6e 2f61 7069  ocumentation/api
+0000e880: 2f6c 6174 6573 742f 7265 6665 7265 6e63  /latest/referenc
+0000e890: 652f 7365 7276 6963 6573 2f73 332e 6874  e/services/s3.ht
+0000e8a0: 6d6c 2353 332e 436c 6965 6e74 2e64 656c  ml#S3.Client.del
+0000e8b0: 6574 655f 6f62 6a65 6374 730a 2020 2020  ete_objects.    
+0000e8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e8d0: 2020 2020 6966 206e 6f74 206b 6579 733a      if not keys:
+0000e8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e8f0: 2020 2020 2020 2020 2020 2020 2062 7265               bre
+0000e900: 616b 0a20 2020 2020 2020 2020 2020 2020  ak.             
+0000e910: 2020 2020 2020 2020 2020 2072 6573 706f             respo
+0000e920: 6e73 6520 3d20 636c 6965 6e74 2e64 656c  nse = client.del
+0000e930: 6574 655f 6f62 6a65 6374 7328 0a20 2020  ete_objects(.   
 0000e940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e950: 2020 2020 2069 6620 6e6f 7420 6b65 7973       if not keys
-0000e960: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000e970: 2020 2020 2020 2020 2020 2020 2020 6272                br
-0000e980: 6561 6b0a 2020 2020 2020 2020 2020 2020  eak.            
-0000e990: 2020 2020 2020 2020 2020 2020 7265 7370              resp
-0000e9a0: 6f6e 7365 203d 2063 6c69 656e 742e 6465  onse = client.de
-0000e9b0: 6c65 7465 5f6f 626a 6563 7473 280a 2020  lete_objects(.  
-0000e9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e9d0: 2020 2020 2020 2020 2020 4275 636b 6574            Bucket
-0000e9e0: 3d62 7563 6b65 742c 2044 656c 6574 653d  =bucket, Delete=
-0000e9f0: 7b27 4f62 6a65 6374 7327 3a20 6b65 7973  {'Objects': keys
-0000ea00: 7d29 0a20 2020 2020 2020 2020 2020 2020  }).             
-0000ea10: 2020 2020 2020 2020 2020 206b 6579 7320             keys 
-0000ea20: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-0000ea30: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0000ea40: 2065 7272 6f72 5f69 6e66 6f20 696e 2072   error_info in r
-0000ea50: 6573 706f 6e73 652e 6765 7428 2745 7272  esponse.get('Err
-0000ea60: 6f72 7327 2c20 5b5d 293a 0a20 2020 2020  ors', []):.     
+0000e950: 2020 2020 2020 2020 2042 7563 6b65 743d           Bucket=
+0000e960: 6275 636b 6574 2c20 4465 6c65 7465 3d7b  bucket, Delete={
+0000e970: 274f 626a 6563 7473 273a 206b 6579 737d  'Objects': keys}
+0000e980: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000e990: 2020 2020 2020 2020 2020 6b65 7973 203d            keys =
+0000e9a0: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+0000e9b0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0000e9c0: 6572 726f 725f 696e 666f 2069 6e20 7265  error_info in re
+0000e9d0: 7370 6f6e 7365 2e67 6574 2827 4572 726f  sponse.get('Erro
+0000e9e0: 7273 272c 205b 5d29 3a0a 2020 2020 2020  rs', []):.      
+0000e9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea00: 2020 2020 2020 6966 2073 335f 6572 726f        if s3_erro
+0000ea10: 725f 636f 6465 5f73 686f 756c 645f 7265  r_code_should_re
+0000ea20: 7472 7928 0a20 2020 2020 2020 2020 2020  try(.           
+0000ea30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea40: 2020 2020 2020 2020 2065 7272 6f72 5f69           error_i
+0000ea50: 6e66 6f2e 6765 7428 2743 6f64 6527 2929  nfo.get('Code'))
+0000ea60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
 0000ea70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ea80: 2020 2020 2020 2069 6620 7333 5f65 7272         if s3_err
-0000ea90: 6f72 5f63 6f64 655f 7368 6f75 6c64 5f72  or_code_should_r
-0000eaa0: 6574 7279 280a 2020 2020 2020 2020 2020  etry(.          
-0000eab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eac0: 2020 2020 2020 2020 2020 6572 726f 725f            error_
-0000ead0: 696e 666f 2e67 6574 2827 436f 6465 2729  info.get('Code')
-0000eae0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000eaf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb00: 2020 2065 7272 6f72 5f6c 6f67 6765 722e     error_logger.
-0000eb10: 7761 726e 696e 6728 0a20 2020 2020 2020  warning(.       
+0000ea80: 2020 6572 726f 725f 6c6f 6767 6572 2e77    error_logger.w
+0000ea90: 6172 6e69 6e67 280a 2020 2020 2020 2020  arning(.        
+0000eaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eab0: 2020 2020 2020 2020 2020 2020 2272 6574              "ret
+0000eac0: 7279 2025 7320 7469 6d65 732c 2072 656d  ry %s times, rem
+0000ead0: 6f76 696e 6720 6669 6c65 3a20 2573 2c20  oving file: %s, 
+0000eae0: 7769 7468 2065 7272 6f72 2025 733a 2025  with error %s: %
+0000eaf0: 7322 0a20 2020 2020 2020 2020 2020 2020  s".             
+0000eb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb10: 2020 2020 2020 2025 2028 0a20 2020 2020         % (.     
 0000eb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb30: 2020 2020 2020 2020 2020 2020 2022 7265               "re
-0000eb40: 7472 7920 2573 2074 696d 6573 2c20 7265  try %s times, re
-0000eb50: 6d6f 7669 6e67 2066 696c 653a 2025 732c  moving file: %s,
-0000eb60: 2077 6974 6820 6572 726f 7220 2573 3a20   with error %s: 
-0000eb70: 2573 220a 2020 2020 2020 2020 2020 2020  %s".            
-0000eb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb90: 2020 2020 2020 2020 2520 280a 2020 2020          % (.    
+0000eb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb40: 2020 2069 202b 2031 2c20 6572 726f 725f     i + 1, error_
+0000eb50: 696e 666f 5b27 4b65 7927 5d2c 0a20 2020  info['Key'],.   
+0000eb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb80: 2020 2020 2065 7272 6f72 5f69 6e66 6f5b       error_info[
+0000eb90: 2743 6f64 6527 5d2c 0a20 2020 2020 2020  'Code'],.       
 0000eba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0000ebb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ebc0: 2020 2020 6920 2b20 312c 2065 7272 6f72      i + 1, error
-0000ebd0: 5f69 6e66 6f5b 274b 6579 275d 2c0a 2020  _info['Key'],.  
+0000ebc0: 2065 7272 6f72 5f69 6e66 6f5b 274d 6573   error_info['Mes
+0000ebd0: 7361 6765 275d 2929 0a20 2020 2020 2020  sage'])).       
 0000ebe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ebf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ec00: 2020 2020 2020 6572 726f 725f 696e 666f        error_info
-0000ec10: 5b27 436f 6465 275d 2c0a 2020 2020 2020  ['Code'],.      
-0000ec20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ec30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ec40: 2020 6572 726f 725f 696e 666f 5b27 4d65    error_info['Me
-0000ec50: 7373 6167 6527 5d29 290a 2020 2020 2020  ssage'])).      
-0000ec60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ec70: 2020 2020 2020 2020 2020 6b65 7973 2e61            keys.a
-0000ec80: 7070 656e 6428 7b27 4b65 7927 3a20 6572  ppend({'Key': er
-0000ec90: 726f 725f 696e 666f 5b27 4b65 7927 5d7d  ror_info['Key']}
-0000eca0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000ecb0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0000ecc0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000ecd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ece0: 2020 2020 6572 726f 7273 2e61 7070 656e      errors.appen
-0000ecf0: 6428 6572 726f 725f 696e 666f 290a 2020  d(error_info).  
-0000ed00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ed10: 2020 2020 2020 7469 6d65 2e73 6c65 6570        time.sleep
-0000ed20: 2872 6574 7279 5f69 6e74 6572 7661 6c29  (retry_interval)
-0000ed30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ed40: 2020 2020 2066 6f72 2065 7272 6f72 5f69       for error_i
-0000ed50: 6e66 6f20 696e 2065 7272 6f72 733a 0a20  nfo in errors:. 
+0000ebf0: 2020 2020 2020 2020 206b 6579 732e 6170           keys.ap
+0000ec00: 7065 6e64 287b 274b 6579 273a 2065 7272  pend({'Key': err
+0000ec10: 6f72 5f69 6e66 6f5b 274b 6579 275d 7d29  or_info['Key']})
+0000ec20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ec30: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+0000ec40: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000ec50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec60: 2020 2065 7272 6f72 732e 6170 7065 6e64     errors.append
+0000ec70: 2865 7272 6f72 5f69 6e66 6f29 0a20 2020  (error_info).   
+0000ec80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec90: 2020 2020 2074 696d 652e 736c 6565 7028       time.sleep(
+0000eca0: 7265 7472 795f 696e 7465 7276 616c 290a  retry_interval).
+0000ecb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ecc0: 2020 2020 666f 7220 6572 726f 725f 696e      for error_in
+0000ecd0: 666f 2069 6e20 6572 726f 7273 3a0a 2020  fo in errors:.  
+0000ece0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ecf0: 2020 2020 2020 6572 726f 725f 6c6f 6767        error_logg
+0000ed00: 6572 2e65 7272 6f72 280a 2020 2020 2020  er.error(.      
+0000ed10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ed20: 2020 2020 2020 2266 6169 6c65 6420 7265        "failed re
+0000ed30: 6d6f 7665 2066 696c 653a 2025 732c 2077  move file: %s, w
+0000ed40: 6974 6820 6572 726f 7220 2573 3a20 2573  ith error %s: %s
+0000ed50: 2220 2520 280a 2020 2020 2020 2020 2020  " % (.          
 0000ed60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ed70: 2020 2020 2020 2065 7272 6f72 5f6c 6f67         error_log
-0000ed80: 6765 722e 6572 726f 7228 0a20 2020 2020  ger.error(.     
-0000ed90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eda0: 2020 2020 2020 2022 6661 696c 6564 2072         "failed r
-0000edb0: 656d 6f76 6520 6669 6c65 3a20 2573 2c20  emove file: %s, 
-0000edc0: 7769 7468 2065 7272 6f72 2025 733a 2025  with error %s: %
-0000edd0: 7322 2025 2028 0a20 2020 2020 2020 2020  s" % (.         
-0000ede0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000edf0: 2020 2020 2020 2065 7272 6f72 5f69 6e66         error_inf
-0000ee00: 6f5b 274b 6579 275d 2c20 6572 726f 725f  o['Key'], error_
-0000ee10: 696e 666f 5b27 436f 6465 275d 2c0a 2020  info['Code'],.  
-0000ee20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee30: 2020 2020 2020 2020 2020 2020 2020 6572                er
-0000ee40: 726f 725f 696e 666f 5b27 4d65 7373 6167  ror_info['Messag
-0000ee50: 6527 5d29 290a 2020 2020 2020 2020 2020  e'])).          
-0000ee60: 2020 2020 2020 2020 2020 6572 726f 725f            error_
-0000ee70: 636f 756e 7420 2b3d 206c 656e 2865 7272  count += len(err
-0000ee80: 6f72 7329 0a20 2020 2020 2020 2020 2020  ors).           
-0000ee90: 2069 6620 6572 726f 725f 636f 756e 7420   if error_count 
-0000eea0: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
-0000eeb0: 2020 2020 2065 7272 6f72 5f6d 7367 203d       error_msg =
-0000eec0: 2022 6661 696c 6564 2072 656d 6f76 6520   "failed remove 
-0000eed0: 7061 7468 3a20 2573 2c20 746f 7461 6c20  path: %s, total 
-0000eee0: 6669 6c65 2063 6f75 6e74 3a20 2573 2c20  file count: %s, 
-0000eef0: 6661 696c 6564 2063 6f75 6e74 3a20 2573  failed count: %s
-0000ef00: 2220 2520 280a 2020 2020 2020 2020 2020  " % (.          
-0000ef10: 2020 2020 2020 2020 2020 7365 6c66 2e70            self.p
-0000ef20: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-0000ef30: 6c2c 2074 6f74 616c 5f63 6f75 6e74 2c20  l, total_count, 
-0000ef40: 6572 726f 725f 636f 756e 7429 0a20 2020  error_count).   
-0000ef50: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-0000ef60: 7365 2053 3355 6e6b 6e6f 776e 4572 726f  se S3UnknownErro
-0000ef70: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-0000ef80: 2020 2020 2020 2045 7863 6570 7469 6f6e         Exception
-0000ef90: 2865 7272 6f72 5f6d 7367 292c 2073 656c  (error_msg), sel
-0000efa0: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
-0000efb0: 6f63 6f6c 290a 0a20 2020 2064 6566 2072  ocol)..    def r
-0000efc0: 656e 616d 6528 7365 6c66 2c20 6473 745f  ename(self, dst_
-0000efd0: 7061 7468 3a20 5061 7468 4c69 6b65 2920  path: PathLike) 
-0000efe0: 2d3e 2027 5333 5061 7468 273a 0a20 2020  -> 'S3Path':.   
-0000eff0: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
-0000f000: 204d 6f76 6520 7333 2066 696c 6520 7061   Move s3 file pa
-0000f010: 7468 2066 726f 6d20 7372 635f 7572 6c20  th from src_url 
-0000f020: 746f 2064 7374 5f75 726c 0a0a 2020 2020  to dst_url..    
-0000f030: 2020 2020 3a70 6172 616d 2064 7374 5f70      :param dst_p
-0000f040: 6174 683a 2047 6976 656e 2064 6573 7469  ath: Given desti
-0000f050: 6e61 7469 6f6e 2070 6174 680a 2020 2020  nation path.    
-0000f060: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
-0000f070: 7333 5f72 656e 616d 6528 7365 6c66 2e70  s3_rename(self.p
-0000f080: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-0000f090: 6c2c 2064 7374 5f70 6174 6829 0a20 2020  l, dst_path).   
-0000f0a0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0000f0b0: 2e66 726f 6d5f 7061 7468 2864 7374 5f70  .from_path(dst_p
-0000f0c0: 6174 6829 0a0a 2020 2020 6465 6620 7363  ath)..    def sc
-0000f0d0: 616e 2873 656c 662c 206d 6973 7369 6e67  an(self, missing
-0000f0e0: 5f6f 6b3a 2062 6f6f 6c20 3d20 5472 7565  _ok: bool = True
-0000f0f0: 2c0a 2020 2020 2020 2020 2020 2020 2066  ,.             f
-0000f100: 6f6c 6c6f 776c 696e 6b73 3a20 626f 6f6c  ollowlinks: bool
-0000f110: 203d 2046 616c 7365 2920 2d3e 2049 7465   = False) -> Ite
-0000f120: 7261 746f 725b 7374 725d 3a0a 2020 2020  rator[str]:.    
-0000f130: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
-0000f140: 4974 6572 6174 6976 656c 7920 7472 6176  Iteratively trav
-0000f150: 6572 7365 206f 6e6c 7920 6669 6c65 7320  erse only files 
-0000f160: 696e 2067 6976 656e 2073 3320 6469 7265  in given s3 dire
-0000f170: 6374 6f72 792c 2069 6e20 616c 7068 6162  ctory, in alphab
-0000f180: 6574 6963 616c 206f 7264 6572 2e0a 2020  etical order..  
-0000f190: 2020 2020 2020 4576 6572 7920 6974 6572        Every iter
-0000f1a0: 6174 696f 6e20 6f6e 2067 656e 6572 6174  ation on generat
-0000f1b0: 6f72 2079 6965 6c64 7320 6120 7061 7468  or yields a path
-0000f1c0: 2073 7472 696e 672e 0a0a 2020 2020 2020   string...      
-0000f1d0: 2020 4966 2073 335f 7572 6c20 6973 2061    If s3_url is a
-0000f1e0: 2066 696c 6520 7061 7468 2c20 7969 656c   file path, yiel
-0000f1f0: 6473 2074 6865 2066 696c 6520 6f6e 6c79  ds the file only
-0000f200: 0a20 2020 2020 2020 2049 6620 7333 5f75  .        If s3_u
-0000f210: 726c 2069 7320 6120 6e6f 6e2d 6578 6973  rl is a non-exis
-0000f220: 7465 6e74 2070 6174 682c 2072 6574 7572  tent path, retur
-0000f230: 6e20 616e 2065 6d70 7479 2067 656e 6572  n an empty gener
-0000f240: 6174 6f72 0a20 2020 2020 2020 2049 6620  ator.        If 
-0000f250: 7333 5f75 726c 2069 7320 6120 6275 636b  s3_url is a buck
-0000f260: 6574 2070 6174 682c 2072 6574 7572 6e20  et path, return 
-0000f270: 616c 6c20 6669 6c65 2070 6174 6873 2069  all file paths i
-0000f280: 6e20 7468 6520 6275 636b 6574 0a20 2020  n the bucket.   
-0000f290: 2020 2020 2049 6620 7333 5f75 726c 2069       If s3_url i
-0000f2a0: 7320 616e 2065 6d70 7479 2062 7563 6b65  s an empty bucke
-0000f2b0: 742c 2072 6574 7572 6e20 616e 2065 6d70  t, return an emp
-0000f2c0: 7479 2067 656e 6572 6174 6f72 0a20 2020  ty generator.   
-0000f2d0: 2020 2020 2049 6620 7333 5f75 726c 2064       If s3_url d
-0000f2e0: 6f65 736e 2774 2063 6f6e 7461 696e 2061  oesn't contain a
-0000f2f0: 6e79 2062 7563 6b65 742c 2077 6869 6368  ny bucket, which
-0000f300: 2069 7320 7333 5f75 726c 203d 3d20 2773   is s3_url == 's
-0000f310: 333a 2f2f 272c 2072 6169 7365 2055 6e73  3://', raise Uns
-0000f320: 7570 706f 7274 6564 4572 726f 722e 2077  upportedError. w
-0000f330: 616c 6b28 2920 6f6e 2063 6f6d 706c 6574  alk() on complet
-0000f340: 6520 7333 2069 7320 6e6f 7420 7375 7070  e s3 is not supp
-0000f350: 6f72 7465 6420 696e 206d 6567 6669 6c65  orted in megfile
-0000f360: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-0000f370: 206d 6973 7369 6e67 5f6f 6b3a 2049 6620   missing_ok: If 
-0000f380: 4661 6c73 6520 616e 6420 7468 6572 6527  False and there'
-0000f390: 7320 6e6f 2066 696c 6520 696e 2074 6865  s no file in the
-0000f3a0: 2064 6972 6563 746f 7279 2c20 7261 6973   directory, rais
-0000f3b0: 6520 4669 6c65 4e6f 7446 6f75 6e64 4572  e FileNotFoundEr
-0000f3c0: 726f 720a 2020 2020 2020 2020 3a72 6169  ror.        :rai
-0000f3d0: 7365 733a 2055 6e73 7570 706f 7274 6564  ses: Unsupported
-0000f3e0: 4572 726f 720a 2020 2020 2020 2020 3a72  Error.        :r
-0000f3f0: 6574 7572 6e73 3a20 4120 6669 6c65 2070  eturns: A file p
-0000f400: 6174 6820 6765 6e65 7261 746f 720a 2020  ath generator.  
-0000f410: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
-0000f420: 2020 7363 616e 5f73 7461 745f 6974 6572    scan_stat_iter
-0000f430: 203d 2073 656c 662e 7363 616e 5f73 7461   = self.scan_sta
-0000f440: 7428 0a20 2020 2020 2020 2020 2020 206d  t(.            m
-0000f450: 6973 7369 6e67 5f6f 6b3d 6d69 7373 696e  issing_ok=missin
-0000f460: 675f 6f6b 2c20 666f 6c6c 6f77 6c69 6e6b  g_ok, followlink
-0000f470: 733d 666f 6c6c 6f77 6c69 6e6b 7329 0a0a  s=followlinks)..
-0000f480: 2020 2020 2020 2020 6465 6620 6372 6561          def crea
-0000f490: 7465 5f67 656e 6572 6174 6f72 2829 202d  te_generator() -
-0000f4a0: 3e20 4974 6572 6174 6f72 5b73 7472 5d3a  > Iterator[str]:
-0000f4b0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0000f4c0: 2066 696c 655f 656e 7472 7920 696e 2073   file_entry in s
-0000f4d0: 6361 6e5f 7374 6174 5f69 7465 723a 0a20  can_stat_iter:. 
-0000f4e0: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-0000f4f0: 6965 6c64 2066 696c 655f 656e 7472 792e  ield file_entry.
-0000f500: 7061 7468 0a0a 2020 2020 2020 2020 7265  path..        re
-0000f510: 7475 726e 2063 7265 6174 655f 6765 6e65  turn create_gene
-0000f520: 7261 746f 7228 290a 0a20 2020 2064 6566  rator()..    def
-0000f530: 2073 6361 6e5f 7374 6174 2873 656c 662c   scan_stat(self,
-0000f540: 206d 6973 7369 6e67 5f6f 6b3a 2062 6f6f   missing_ok: boo
-0000f550: 6c20 3d20 5472 7565 2c0a 2020 2020 2020  l = True,.      
-0000f560: 2020 2020 2020 2020 2020 2020 666f 6c6c              foll
-0000f570: 6f77 6c69 6e6b 733a 2062 6f6f 6c20 3d20  owlinks: bool = 
-0000f580: 4661 6c73 6529 202d 3e20 4974 6572 6174  False) -> Iterat
-0000f590: 6f72 5b46 696c 6545 6e74 7279 5d3a 0a20  or[FileEntry]:. 
-0000f5a0: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-0000f5b0: 2020 2049 7465 7261 7469 7665 6c79 2074     Iteratively t
-0000f5c0: 7261 7665 7273 6520 6f6e 6c79 2066 696c  raverse only fil
-0000f5d0: 6573 2069 6e20 6769 7665 6e20 6469 7265  es in given dire
-0000f5e0: 6374 6f72 792c 2069 6e20 616c 7068 6162  ctory, in alphab
-0000f5f0: 6574 6963 616c 206f 7264 6572 2e0a 2020  etical order..  
-0000f600: 2020 2020 2020 4576 6572 7920 6974 6572        Every iter
-0000f610: 6174 696f 6e20 6f6e 2067 656e 6572 6174  ation on generat
-0000f620: 6f72 2079 6965 6c64 7320 6120 7475 706c  or yields a tupl
-0000f630: 6520 6f66 2070 6174 6820 7374 7269 6e67  e of path string
-0000f640: 2061 6e64 2066 696c 6520 7374 6174 0a0a   and file stat..
-0000f650: 2020 2020 2020 2020 3a70 6172 616d 206d          :param m
-0000f660: 6973 7369 6e67 5f6f 6b3a 2049 6620 4661  issing_ok: If Fa
-0000f670: 6c73 6520 616e 6420 7468 6572 6527 7320  lse and there's 
-0000f680: 6e6f 2066 696c 6520 696e 2074 6865 2064  no file in the d
-0000f690: 6972 6563 746f 7279 2c20 7261 6973 6520  irectory, raise 
-0000f6a0: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
-0000f6b0: 720a 2020 2020 2020 2020 3a72 6169 7365  r.        :raise
-0000f6c0: 733a 2055 6e73 7570 706f 7274 6564 4572  s: UnsupportedEr
-0000f6d0: 726f 720a 2020 2020 2020 2020 3a72 6574  ror.        :ret
-0000f6e0: 7572 6e73 3a20 4120 6669 6c65 2070 6174  urns: A file pat
-0000f6f0: 6820 6765 6e65 7261 746f 720a 2020 2020  h generator.    
-0000f700: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
-0000f710: 6275 636b 6574 2c20 6b65 7920 3d20 7061  bucket, key = pa
-0000f720: 7273 655f 7333 5f75 726c 2873 656c 662e  rse_s3_url(self.
-0000f730: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
-0000f740: 6f6c 290a 2020 2020 2020 2020 6966 206e  ol).        if n
-0000f750: 6f74 2062 7563 6b65 743a 0a20 2020 2020  ot bucket:.     
-0000f760: 2020 2020 2020 2072 6169 7365 2055 6e73         raise Uns
-0000f770: 7570 706f 7274 6564 4572 726f 7228 2753  upportedError('S
-0000f780: 6361 6e20 7768 6f6c 6520 7333 272c 2073  can whole s3', s
-0000f790: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
-0000f7a0: 6f74 6f63 6f6c 290a 0a20 2020 2020 2020  otocol)..       
-0000f7b0: 2064 6566 2063 7265 6174 655f 6765 6e65   def create_gene
-0000f7c0: 7261 746f 7228 2920 2d3e 2049 7465 7261  rator() -> Itera
-0000f7d0: 746f 725b 4669 6c65 456e 7472 795d 3a0a  tor[FileEntry]:.
-0000f7e0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0000f7f0: 6f74 2073 656c 662e 6973 5f64 6972 2829  ot self.is_dir()
-0000f800: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000f810: 2020 6966 2073 656c 662e 6973 5f66 696c    if self.is_fil
-0000f820: 6528 293a 0a20 2020 2020 2020 2020 2020  e():.           
-0000f830: 2020 2020 2020 2020 2023 204f 6e20 7333           # On s3
-0000f840: 2c20 6669 6c65 2061 6e64 2064 6972 6563  , file and direc
-0000f850: 746f 7279 206d 6179 2062 6520 6f66 2073  tory may be of s
-0000f860: 616d 6520 6e61 6d65 2061 6e64 206c 6576  ame name and lev
-0000f870: 656c 2c20 736f 206e 6565 6420 746f 2074  el, so need to t
-0000f880: 6573 7420 7468 6520 7061 7468 2069 7320  est the path is 
-0000f890: 6669 6c65 206f 7220 6469 7265 6374 6f72  file or director
-0000f8a0: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
-0000f8b0: 2020 2020 2020 7969 656c 6420 4669 6c65        yield File
-0000f8c0: 456e 7472 7928 0a20 2020 2020 2020 2020  Entry(.         
-0000f8d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000f8e0: 656c 662e 6e61 6d65 2c20 6673 7061 7468  elf.name, fspath
-0000f8f0: 2873 656c 662e 7061 7468 5f77 6974 685f  (self.path_with_
-0000f900: 7072 6f74 6f63 6f6c 292c 0a20 2020 2020  protocol),.     
-0000f910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f920: 2020 2073 656c 662e 7374 6174 2866 6f6c     self.stat(fol
-0000f930: 6c6f 775f 7379 6d6c 696e 6b73 3d66 6f6c  low_symlinks=fol
-0000f940: 6c6f 776c 696e 6b73 2929 0a20 2020 2020  lowlinks)).     
-0000f950: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000f960: 6e0a 0a20 2020 2020 2020 2020 2020 2069  n..            i
-0000f970: 6620 6e6f 7420 6b65 792e 656e 6473 7769  f not key.endswi
-0000f980: 7468 2827 2f27 2920 616e 6420 7365 6c66  th('/') and self
-0000f990: 2e69 735f 6669 6c65 2829 3a0a 2020 2020  .is_file():.    
-0000f9a0: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
-0000f9b0: 6420 4669 6c65 456e 7472 7928 0a20 2020  d FileEntry(.   
-0000f9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f9d0: 2073 656c 662e 6e61 6d65 2c20 6673 7061   self.name, fspa
-0000f9e0: 7468 2873 656c 662e 7061 7468 5f77 6974  th(self.path_wit
-0000f9f0: 685f 7072 6f74 6f63 6f6c 292c 0a20 2020  h_protocol),.   
-0000fa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fa10: 2073 656c 662e 7374 6174 2866 6f6c 6c6f   self.stat(follo
-0000fa20: 775f 7379 6d6c 696e 6b73 3d66 6f6c 6c6f  w_symlinks=follo
-0000fa30: 776c 696e 6b73 2929 0a0a 2020 2020 2020  wlinks))..      
-0000fa40: 2020 2020 2020 7072 6566 6978 203d 205f        prefix = _
-0000fa50: 6265 636f 6d65 5f70 7265 6669 7828 6b65  become_prefix(ke
-0000fa60: 7929 0a20 2020 2020 2020 2020 2020 2063  y).            c
-0000fa70: 6c69 656e 7420 3d20 7365 6c66 2e5f 636c  lient = self._cl
-0000fa80: 6965 6e74 0a20 2020 2020 2020 2020 2020  ient.           
-0000fa90: 2077 6974 6820 7261 6973 655f 7333 5f65   with raise_s3_e
-0000faa0: 7272 6f72 2873 656c 662e 7061 7468 5f77  rror(self.path_w
-0000fab0: 6974 685f 7072 6f74 6f63 6f6c 293a 0a20  ith_protocol):. 
-0000fac0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000fad0: 6f72 2072 6573 7020 696e 205f 6c69 7374  or resp in _list
-0000fae0: 5f6f 626a 6563 7473 5f72 6563 7572 7369  _objects_recursi
-0000faf0: 7665 2863 6c69 656e 742c 2062 7563 6b65  ve(client, bucke
-0000fb00: 742c 2070 7265 6669 7829 3a0a 2020 2020  t, prefix):.    
-0000fb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fb20: 666f 7220 636f 6e74 656e 7420 696e 2072  for content in r
-0000fb30: 6573 702e 6765 7428 2743 6f6e 7465 6e74  esp.get('Content
-0000fb40: 7327 2c20 5b5d 293a 0a20 2020 2020 2020  s', []):.       
-0000fb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fb60: 2066 756c 6c5f 7061 7468 203d 2073 335f   full_path = s3_
-0000fb70: 7061 7468 5f6a 6f69 6e28 0a20 2020 2020  path_join(.     
-0000fb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fb90: 2020 2020 2020 2066 277b 7365 6c66 2e5f         f'{self._
-0000fba0: 7072 6f74 6f63 6f6c 5f77 6974 685f 7072  protocol_with_pr
-0000fbb0: 6f66 696c 657d 3a2f 2f27 2c20 6275 636b  ofile}://', buck
-0000fbc0: 6574 2c0a 2020 2020 2020 2020 2020 2020  et,.            
-0000fbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fbe0: 636f 6e74 656e 745b 274b 6579 275d 290a  content['Key']).
-0000fbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fc00: 2020 2020 2020 2020 7969 656c 6420 4669          yield Fi
-0000fc10: 6c65 456e 7472 7928 0a20 2020 2020 2020  leEntry(.       
-0000fc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fc30: 2020 2020 2053 3350 6174 6828 6675 6c6c       S3Path(full
-0000fc40: 5f70 6174 6829 2e6e 616d 652c 2066 756c  _path).name, ful
-0000fc50: 6c5f 7061 7468 2c0a 2020 2020 2020 2020  l_path,.        
-0000fc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fc70: 2020 2020 5f6d 616b 655f 7374 6174 2863      _make_stat(c
-0000fc80: 6f6e 7465 6e74 2929 0a0a 2020 2020 2020  ontent))..      
-0000fc90: 2020 7265 7475 726e 205f 6372 6561 7465    return _create
-0000fca0: 5f6d 6973 7369 6e67 5f6f 6b5f 6765 6e65  _missing_ok_gene
-0000fcb0: 7261 746f 7228 0a20 2020 2020 2020 2020  rator(.         
-0000fcc0: 2020 2063 7265 6174 655f 6765 6e65 7261     create_genera
-0000fcd0: 746f 7228 292c 206d 6973 7369 6e67 5f6f  tor(), missing_o
-0000fce0: 6b2c 0a20 2020 2020 2020 2020 2020 2053  k,.            S
-0000fcf0: 3346 696c 654e 6f74 466f 756e 6445 7272  3FileNotFoundErr
-0000fd00: 6f72 2827 4e6f 206d 6174 6368 2066 696c  or('No match fil
-0000fd10: 653a 2025 7227 2025 2073 656c 662e 7061  e: %r' % self.pa
-0000fd20: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-0000fd30: 2929 0a0a 2020 2020 6465 6620 7363 616e  ))..    def scan
-0000fd40: 6469 7228 7365 6c66 2c20 666f 6c6c 6f77  dir(self, follow
-0000fd50: 6c69 6e6b 733a 2062 6f6f 6c20 3d20 4661  links: bool = Fa
-0000fd60: 6c73 6529 202d 3e20 4974 6572 6174 6f72  lse) -> Iterator
-0000fd70: 5b46 696c 6545 6e74 7279 5d3a 0a20 2020  [FileEntry]:.   
-0000fd80: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
-0000fd90: 2047 6574 2061 6c6c 2063 6f6e 7465 6e74   Get all content
-0000fda0: 7320 6f66 2067 6976 656e 2073 335f 7572  s of given s3_ur
-0000fdb0: 6c2c 2074 6865 206f 7264 6572 206f 6620  l, the order of 
-0000fdc0: 7265 7375 6c74 2069 7320 6e6f 7420 6775  result is not gu
-0000fdd0: 6172 616e 7465 6564 2e0a 0a20 2020 2020  aranteed...     
-0000fde0: 2020 203a 7265 7475 726e 733a 2041 6c6c     :returns: All
-0000fdf0: 2063 6f6e 7465 6e74 7320 6861 7665 2070   contents have p
-0000fe00: 7265 6669 7820 6f66 2073 335f 7572 6c0a  refix of s3_url.
-0000fe10: 2020 2020 2020 2020 3a72 6169 7365 733a          :raises:
-0000fe20: 2053 3346 696c 654e 6f74 466f 756e 6445   S3FileNotFoundE
-0000fe30: 7272 6f72 2c20 5333 4e6f 7441 4469 7265  rror, S3NotADire
-0000fe40: 6374 6f72 7945 7272 6f72 0a20 2020 2020  ctoryError.     
-0000fe50: 2020 2027 2727 0a20 2020 2020 2020 2062     '''.        b
-0000fe60: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
-0000fe70: 7365 5f73 335f 7572 6c28 7365 6c66 2e70  se_s3_url(self.p
-0000fe80: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-0000fe90: 6c29 0a20 2020 2020 2020 2069 6620 6e6f  l).        if no
-0000fea0: 7420 6275 636b 6574 2061 6e64 206b 6579  t bucket and key
-0000feb0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0000fec0: 6973 6520 5333 4275 636b 6574 4e6f 7446  ise S3BucketNotF
-0000fed0: 6f75 6e64 4572 726f 7228 0a20 2020 2020  oundError(.     
-0000fee0: 2020 2020 2020 2020 2020 2027 456d 7074             'Empt
-0000fef0: 7920 6275 636b 6574 206e 616d 653a 2025  y bucket name: %
-0000ff00: 7227 2025 2073 656c 662e 7061 7468 5f77  r' % self.path_w
-0000ff10: 6974 685f 7072 6f74 6f63 6f6c 290a 0a20  ith_protocol).. 
-0000ff20: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
-0000ff30: 735f 6669 6c65 2829 3a0a 2020 2020 2020  s_file():.      
-0000ff40: 2020 2020 2020 7261 6973 6520 5333 4e6f        raise S3No
-0000ff50: 7441 4469 7265 6374 6f72 7945 7272 6f72  tADirectoryError
-0000ff60: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000ff70: 2020 274e 6f74 2061 2064 6972 6563 746f    'Not a directo
-0000ff80: 7279 3a20 2572 2720 2520 7365 6c66 2e70  ry: %r' % self.p
-0000ff90: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-0000ffa0: 6c29 0a20 2020 2020 2020 2065 6c69 6620  l).        elif 
-0000ffb0: 6e6f 7420 7365 6c66 2e69 735f 6469 7228  not self.is_dir(
-0000ffc0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-0000ffd0: 6169 7365 2053 3346 696c 654e 6f74 466f  aise S3FileNotFo
-0000ffe0: 756e 6445 7272 6f72 280a 2020 2020 2020  undError(.      
-0000fff0: 2020 2020 2020 2020 2020 274e 6f20 7375            'No su
-00010000: 6368 2064 6972 6563 746f 7279 3a20 2572  ch directory: %r
-00010010: 2720 2520 7365 6c66 2e70 6174 685f 7769  ' % self.path_wi
-00010020: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
-00010030: 2020 2020 2070 7265 6669 7820 3d20 5f62       prefix = _b
-00010040: 6563 6f6d 655f 7072 6566 6978 286b 6579  ecome_prefix(key
-00010050: 290a 2020 2020 2020 2020 636c 6965 6e74  ).        client
-00010060: 203d 2073 656c 662e 5f63 6c69 656e 740a   = self._client.
-00010070: 0a20 2020 2020 2020 2023 2049 6e20 6f72  .        # In or
-00010080: 6465 7220 746f 2064 6f20 6368 6563 6b20  der to do check 
-00010090: 6f6e 2063 7265 6174 696f 6e2c 0a20 2020  on creation,.   
-000100a0: 2020 2020 2023 2077 6520 6e65 6564 2074       # we need t
-000100b0: 6f20 7772 6170 2074 6865 2069 7465 7261  o wrap the itera
-000100c0: 746f 7220 696e 2061 6e6f 7468 6572 2066  tor in another f
-000100d0: 756e 6374 696f 6e0a 2020 2020 2020 2020  unction.        
-000100e0: 6465 6620 6372 6561 7465 5f67 656e 6572  def create_gener
-000100f0: 6174 6f72 2829 202d 3e20 4974 6572 6174  ator() -> Iterat
-00010100: 6f72 5b46 696c 6545 6e74 7279 5d3a 0a20  or[FileEntry]:. 
-00010110: 2020 2020 2020 2020 2020 2077 6974 6820             with 
-00010120: 7261 6973 655f 7333 5f65 7272 6f72 2873  raise_s3_error(s
-00010130: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
-00010140: 6f74 6f63 6f6c 293a 0a0a 2020 2020 2020  otocol):..      
-00010150: 2020 2020 2020 2020 2020 6465 6620 6765            def ge
-00010160: 6e65 7261 7465 5f73 335f 7061 7468 280a  nerate_s3_path(.
-00010170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010180: 2020 2020 2020 2020 7072 6f74 6f63 6f6c          protocol
-00010190: 3a20 7374 722c 2062 7563 6b65 743a 2073  : str, bucket: s
-000101a0: 7472 2c20 6b65 793a 2073 7472 2920 2d3e  tr, key: str) ->
-000101b0: 2073 7472 3a0a 2020 2020 2020 2020 2020   str:.          
-000101c0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000101d0: 2022 2573 3a2f 2f25 732f 2573 2220 2520   "%s://%s/%s" % 
-000101e0: 2870 726f 746f 636f 6c2c 2062 7563 6b65  (protocol, bucke
-000101f0: 742c 206b 6579 290a 0a20 2020 2020 2020  t, key)..       
-00010200: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-00010210: 6275 636b 6574 2061 6e64 206e 6f74 206b  bucket and not k
-00010220: 6579 3a20 2023 206c 6973 7420 6275 636b  ey:  # list buck
-00010230: 6574 730a 2020 2020 2020 2020 2020 2020  ets.            
-00010240: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
-00010250: 203d 2063 6c69 656e 742e 6c69 7374 5f62   = client.list_b
-00010260: 7563 6b65 7473 2829 0a20 2020 2020 2020  uckets().       
-00010270: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00010280: 2063 6f6e 7465 6e74 2069 6e20 7265 7370   content in resp
-00010290: 6f6e 7365 5b27 4275 636b 6574 7327 5d3a  onse['Buckets']:
-000102a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000102b0: 2020 2020 2020 2020 2079 6965 6c64 2046           yield F
-000102c0: 696c 6545 6e74 7279 280a 2020 2020 2020  ileEntry(.      
-000102d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000102e0: 2020 2020 2020 636f 6e74 656e 745b 274e        content['N
-000102f0: 616d 6527 5d2c 2066 2273 333a 2f2f 7b63  ame'], f"s3://{c
-00010300: 6f6e 7465 6e74 5b27 4e61 6d65 275d 7d22  ontent['Name']}"
-00010310: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00010320: 2020 2020 2020 2020 2020 2020 2020 5374                St
-00010330: 6174 5265 7375 6c74 280a 2020 2020 2020  atResult(.      
+0000ed70: 2020 2020 2020 6572 726f 725f 696e 666f        error_info
+0000ed80: 5b27 4b65 7927 5d2c 2065 7272 6f72 5f69  ['Key'], error_i
+0000ed90: 6e66 6f5b 2743 6f64 6527 5d2c 0a20 2020  nfo['Code'],.   
+0000eda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000edb0: 2020 2020 2020 2020 2020 2020 2065 7272               err
+0000edc0: 6f72 5f69 6e66 6f5b 274d 6573 7361 6765  or_info['Message
+0000edd0: 275d 2929 0a20 2020 2020 2020 2020 2020  '])).           
+0000ede0: 2020 2020 2020 2020 2065 7272 6f72 5f63           error_c
+0000edf0: 6f75 6e74 202b 3d20 6c65 6e28 6572 726f  ount += len(erro
+0000ee00: 7273 290a 2020 2020 2020 2020 2020 2020  rs).            
+0000ee10: 6966 2065 7272 6f72 5f63 6f75 6e74 203e  if error_count >
+0000ee20: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+0000ee30: 2020 2020 6572 726f 725f 6d73 6720 3d20      error_msg = 
+0000ee40: 2266 6169 6c65 6420 7265 6d6f 7665 2070  "failed remove p
+0000ee50: 6174 683a 2025 732c 2074 6f74 616c 2066  ath: %s, total f
+0000ee60: 696c 6520 636f 756e 743a 2025 732c 2066  ile count: %s, f
+0000ee70: 6169 6c65 6420 636f 756e 743a 2025 7322  ailed count: %s"
+0000ee80: 2025 2028 0a20 2020 2020 2020 2020 2020   % (.           
+0000ee90: 2020 2020 2020 2020 2073 656c 662e 7061           self.pa
+0000eea0: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
+0000eeb0: 2c20 746f 7461 6c5f 636f 756e 742c 2065  , total_count, e
+0000eec0: 7272 6f72 5f63 6f75 6e74 290a 2020 2020  rror_count).    
+0000eed0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000eee0: 6520 5333 556e 6b6e 6f77 6e45 7272 6f72  e S3UnknownError
+0000eef0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000ef00: 2020 2020 2020 4578 6365 7074 696f 6e28        Exception(
+0000ef10: 6572 726f 725f 6d73 6729 2c20 7365 6c66  error_msg), self
+0000ef20: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+0000ef30: 636f 6c29 0a0a 2020 2020 6465 6620 7265  col)..    def re
+0000ef40: 6e61 6d65 2873 656c 662c 2064 7374 5f70  name(self, dst_p
+0000ef50: 6174 683a 2050 6174 684c 696b 6529 202d  ath: PathLike) -
+0000ef60: 3e20 2753 3350 6174 6827 3a0a 2020 2020  > 'S3Path':.    
+0000ef70: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
+0000ef80: 4d6f 7665 2073 3320 6669 6c65 2070 6174  Move s3 file pat
+0000ef90: 6820 6672 6f6d 2073 7263 5f75 726c 2074  h from src_url t
+0000efa0: 6f20 6473 745f 7572 6c0a 0a20 2020 2020  o dst_url..     
+0000efb0: 2020 203a 7061 7261 6d20 6473 745f 7061     :param dst_pa
+0000efc0: 7468 3a20 4769 7665 6e20 6465 7374 696e  th: Given destin
+0000efd0: 6174 696f 6e20 7061 7468 0a20 2020 2020  ation path.     
+0000efe0: 2020 2027 2727 0a20 2020 2020 2020 2073     '''.        s
+0000eff0: 335f 7265 6e61 6d65 2873 656c 662e 7061  3_rename(self.pa
+0000f000: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
+0000f010: 2c20 6473 745f 7061 7468 290a 2020 2020  , dst_path).    
+0000f020: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0000f030: 6672 6f6d 5f70 6174 6828 6473 745f 7061  from_path(dst_pa
+0000f040: 7468 290a 0a20 2020 2064 6566 2073 6361  th)..    def sca
+0000f050: 6e28 7365 6c66 2c20 6d69 7373 696e 675f  n(self, missing_
+0000f060: 6f6b 3a20 626f 6f6c 203d 2054 7275 652c  ok: bool = True,
+0000f070: 0a20 2020 2020 2020 2020 2020 2020 666f  .             fo
+0000f080: 6c6c 6f77 6c69 6e6b 733a 2062 6f6f 6c20  llowlinks: bool 
+0000f090: 3d20 4661 6c73 6529 202d 3e20 4974 6572  = False) -> Iter
+0000f0a0: 6174 6f72 5b73 7472 5d3a 0a20 2020 2020  ator[str]:.     
+0000f0b0: 2020 2027 2727 0a20 2020 2020 2020 2049     '''.        I
+0000f0c0: 7465 7261 7469 7665 6c79 2074 7261 7665  teratively trave
+0000f0d0: 7273 6520 6f6e 6c79 2066 696c 6573 2069  rse only files i
+0000f0e0: 6e20 6769 7665 6e20 7333 2064 6972 6563  n given s3 direc
+0000f0f0: 746f 7279 2c20 696e 2061 6c70 6861 6265  tory, in alphabe
+0000f100: 7469 6361 6c20 6f72 6465 722e 0a20 2020  tical order..   
+0000f110: 2020 2020 2045 7665 7279 2069 7465 7261       Every itera
+0000f120: 7469 6f6e 206f 6e20 6765 6e65 7261 746f  tion on generato
+0000f130: 7220 7969 656c 6473 2061 2070 6174 6820  r yields a path 
+0000f140: 7374 7269 6e67 2e0a 0a20 2020 2020 2020  string...       
+0000f150: 2049 6620 7333 5f75 726c 2069 7320 6120   If s3_url is a 
+0000f160: 6669 6c65 2070 6174 682c 2079 6965 6c64  file path, yield
+0000f170: 7320 7468 6520 6669 6c65 206f 6e6c 790a  s the file only.
+0000f180: 2020 2020 2020 2020 4966 2073 335f 7572          If s3_ur
+0000f190: 6c20 6973 2061 206e 6f6e 2d65 7869 7374  l is a non-exist
+0000f1a0: 656e 7420 7061 7468 2c20 7265 7475 726e  ent path, return
+0000f1b0: 2061 6e20 656d 7074 7920 6765 6e65 7261   an empty genera
+0000f1c0: 746f 720a 2020 2020 2020 2020 4966 2073  tor.        If s
+0000f1d0: 335f 7572 6c20 6973 2061 2062 7563 6b65  3_url is a bucke
+0000f1e0: 7420 7061 7468 2c20 7265 7475 726e 2061  t path, return a
+0000f1f0: 6c6c 2066 696c 6520 7061 7468 7320 696e  ll file paths in
+0000f200: 2074 6865 2062 7563 6b65 740a 2020 2020   the bucket.    
+0000f210: 2020 2020 4966 2073 335f 7572 6c20 6973      If s3_url is
+0000f220: 2061 6e20 656d 7074 7920 6275 636b 6574   an empty bucket
+0000f230: 2c20 7265 7475 726e 2061 6e20 656d 7074  , return an empt
+0000f240: 7920 6765 6e65 7261 746f 720a 2020 2020  y generator.    
+0000f250: 2020 2020 4966 2073 335f 7572 6c20 646f      If s3_url do
+0000f260: 6573 6e27 7420 636f 6e74 6169 6e20 616e  esn't contain an
+0000f270: 7920 6275 636b 6574 2c20 7768 6963 6820  y bucket, which 
+0000f280: 6973 2073 335f 7572 6c20 3d3d 2027 7333  is s3_url == 's3
+0000f290: 3a2f 2f27 2c20 7261 6973 6520 556e 7375  ://', raise Unsu
+0000f2a0: 7070 6f72 7465 6445 7272 6f72 2e20 7761  pportedError. wa
+0000f2b0: 6c6b 2829 206f 6e20 636f 6d70 6c65 7465  lk() on complete
+0000f2c0: 2073 3320 6973 206e 6f74 2073 7570 706f   s3 is not suppo
+0000f2d0: 7274 6564 2069 6e20 6d65 6766 696c 650a  rted in megfile.
+0000f2e0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0000f2f0: 6d69 7373 696e 675f 6f6b 3a20 4966 2046  missing_ok: If F
+0000f300: 616c 7365 2061 6e64 2074 6865 7265 2773  alse and there's
+0000f310: 206e 6f20 6669 6c65 2069 6e20 7468 6520   no file in the 
+0000f320: 6469 7265 6374 6f72 792c 2072 6169 7365  directory, raise
+0000f330: 2046 696c 654e 6f74 466f 756e 6445 7272   FileNotFoundErr
+0000f340: 6f72 0a20 2020 2020 2020 203a 7261 6973  or.        :rais
+0000f350: 6573 3a20 556e 7375 7070 6f72 7465 6445  es: UnsupportedE
+0000f360: 7272 6f72 0a20 2020 2020 2020 203a 7265  rror.        :re
+0000f370: 7475 726e 733a 2041 2066 696c 6520 7061  turns: A file pa
+0000f380: 7468 2067 656e 6572 6174 6f72 0a20 2020  th generator.   
+0000f390: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
+0000f3a0: 2073 6361 6e5f 7374 6174 5f69 7465 7220   scan_stat_iter 
+0000f3b0: 3d20 7365 6c66 2e73 6361 6e5f 7374 6174  = self.scan_stat
+0000f3c0: 280a 2020 2020 2020 2020 2020 2020 6d69  (.            mi
+0000f3d0: 7373 696e 675f 6f6b 3d6d 6973 7369 6e67  ssing_ok=missing
+0000f3e0: 5f6f 6b2c 2066 6f6c 6c6f 776c 696e 6b73  _ok, followlinks
+0000f3f0: 3d66 6f6c 6c6f 776c 696e 6b73 290a 0a20  =followlinks).. 
+0000f400: 2020 2020 2020 2064 6566 2063 7265 6174         def creat
+0000f410: 655f 6765 6e65 7261 746f 7228 2920 2d3e  e_generator() ->
+0000f420: 2049 7465 7261 746f 725b 7374 725d 3a0a   Iterator[str]:.
+0000f430: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0000f440: 6669 6c65 5f65 6e74 7279 2069 6e20 7363  file_entry in sc
+0000f450: 616e 5f73 7461 745f 6974 6572 3a0a 2020  an_stat_iter:.  
+0000f460: 2020 2020 2020 2020 2020 2020 2020 7969                yi
+0000f470: 656c 6420 6669 6c65 5f65 6e74 7279 2e70  eld file_entry.p
+0000f480: 6174 680a 0a20 2020 2020 2020 2072 6574  ath..        ret
+0000f490: 7572 6e20 6372 6561 7465 5f67 656e 6572  urn create_gener
+0000f4a0: 6174 6f72 2829 0a0a 2020 2020 6465 6620  ator()..    def 
+0000f4b0: 7363 616e 5f73 7461 7428 7365 6c66 2c20  scan_stat(self, 
+0000f4c0: 6d69 7373 696e 675f 6f6b 3a20 626f 6f6c  missing_ok: bool
+0000f4d0: 203d 2054 7275 652c 0a20 2020 2020 2020   = True,.       
+0000f4e0: 2020 2020 2020 2020 2020 2066 6f6c 6c6f             follo
+0000f4f0: 776c 696e 6b73 3a20 626f 6f6c 203d 2046  wlinks: bool = F
+0000f500: 616c 7365 2920 2d3e 2049 7465 7261 746f  alse) -> Iterato
+0000f510: 725b 4669 6c65 456e 7472 795d 3a0a 2020  r[FileEntry]:.  
+0000f520: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
+0000f530: 2020 4974 6572 6174 6976 656c 7920 7472    Iteratively tr
+0000f540: 6176 6572 7365 206f 6e6c 7920 6669 6c65  averse only file
+0000f550: 7320 696e 2067 6976 656e 2064 6972 6563  s in given direc
+0000f560: 746f 7279 2c20 696e 2061 6c70 6861 6265  tory, in alphabe
+0000f570: 7469 6361 6c20 6f72 6465 722e 0a20 2020  tical order..   
+0000f580: 2020 2020 2045 7665 7279 2069 7465 7261       Every itera
+0000f590: 7469 6f6e 206f 6e20 6765 6e65 7261 746f  tion on generato
+0000f5a0: 7220 7969 656c 6473 2061 2074 7570 6c65  r yields a tuple
+0000f5b0: 206f 6620 7061 7468 2073 7472 696e 6720   of path string 
+0000f5c0: 616e 6420 6669 6c65 2073 7461 740a 0a20  and file stat.. 
+0000f5d0: 2020 2020 2020 203a 7061 7261 6d20 6d69         :param mi
+0000f5e0: 7373 696e 675f 6f6b 3a20 4966 2046 616c  ssing_ok: If Fal
+0000f5f0: 7365 2061 6e64 2074 6865 7265 2773 206e  se and there's n
+0000f600: 6f20 6669 6c65 2069 6e20 7468 6520 6469  o file in the di
+0000f610: 7265 6374 6f72 792c 2072 6169 7365 2046  rectory, raise F
+0000f620: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
+0000f630: 0a20 2020 2020 2020 203a 7261 6973 6573  .        :raises
+0000f640: 3a20 556e 7375 7070 6f72 7465 6445 7272  : UnsupportedErr
+0000f650: 6f72 0a20 2020 2020 2020 203a 7265 7475  or.        :retu
+0000f660: 726e 733a 2041 2066 696c 6520 7061 7468  rns: A file path
+0000f670: 2067 656e 6572 6174 6f72 0a20 2020 2020   generator.     
+0000f680: 2020 2027 2727 0a20 2020 2020 2020 2062     '''.        b
+0000f690: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
+0000f6a0: 7365 5f73 335f 7572 6c28 7365 6c66 2e70  se_s3_url(self.p
+0000f6b0: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+0000f6c0: 6c29 0a20 2020 2020 2020 2069 6620 6e6f  l).        if no
+0000f6d0: 7420 6275 636b 6574 3a0a 2020 2020 2020  t bucket:.      
+0000f6e0: 2020 2020 2020 7261 6973 6520 556e 7375        raise Unsu
+0000f6f0: 7070 6f72 7465 6445 7272 6f72 2827 5363  pportedError('Sc
+0000f700: 616e 2077 686f 6c65 2073 3327 2c20 7365  an whole s3', se
+0000f710: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
+0000f720: 746f 636f 6c29 0a0a 2020 2020 2020 2020  tocol)..        
+0000f730: 6465 6620 6372 6561 7465 5f67 656e 6572  def create_gener
+0000f740: 6174 6f72 2829 202d 3e20 4974 6572 6174  ator() -> Iterat
+0000f750: 6f72 5b46 696c 6545 6e74 7279 5d3a 0a20  or[FileEntry]:. 
+0000f760: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0000f770: 7420 7365 6c66 2e69 735f 6469 7228 293a  t self.is_dir():
+0000f780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f790: 2069 6620 7365 6c66 2e69 735f 6669 6c65   if self.is_file
+0000f7a0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+0000f7b0: 2020 2020 2020 2020 2320 4f6e 2073 332c          # On s3,
+0000f7c0: 2066 696c 6520 616e 6420 6469 7265 6374   file and direct
+0000f7d0: 6f72 7920 6d61 7920 6265 206f 6620 7361  ory may be of sa
+0000f7e0: 6d65 206e 616d 6520 616e 6420 6c65 7665  me name and leve
+0000f7f0: 6c2c 2073 6f20 6e65 6564 2074 6f20 7465  l, so need to te
+0000f800: 7374 2074 6865 2070 6174 6820 6973 2066  st the path is f
+0000f810: 696c 6520 6f72 2064 6972 6563 746f 7279  ile or directory
+0000f820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f830: 2020 2020 2079 6965 6c64 2046 696c 6545       yield FileE
+0000f840: 6e74 7279 280a 2020 2020 2020 2020 2020  ntry(.          
+0000f850: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0000f860: 6c66 2e6e 616d 652c 2066 7370 6174 6828  lf.name, fspath(
+0000f870: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
+0000f880: 726f 746f 636f 6c29 2c0a 2020 2020 2020  rotocol),.      
+0000f890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f8a0: 2020 7365 6c66 2e73 7461 7428 666f 6c6c    self.stat(foll
+0000f8b0: 6f77 5f73 796d 6c69 6e6b 733d 666f 6c6c  ow_symlinks=foll
+0000f8c0: 6f77 6c69 6e6b 7329 290a 2020 2020 2020  owlinks)).      
+0000f8d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000f8e0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+0000f8f0: 206e 6f74 206b 6579 2e65 6e64 7377 6974   not key.endswit
+0000f900: 6828 272f 2729 2061 6e64 2073 656c 662e  h('/') and self.
+0000f910: 6973 5f66 696c 6528 293a 0a20 2020 2020  is_file():.     
+0000f920: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
+0000f930: 2046 696c 6545 6e74 7279 280a 2020 2020   FileEntry(.    
+0000f940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f950: 7365 6c66 2e6e 616d 652c 2066 7370 6174  self.name, fspat
+0000f960: 6828 7365 6c66 2e70 6174 685f 7769 7468  h(self.path_with
+0000f970: 5f70 726f 746f 636f 6c29 2c0a 2020 2020  _protocol),.    
+0000f980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f990: 7365 6c66 2e73 7461 7428 666f 6c6c 6f77  self.stat(follow
+0000f9a0: 5f73 796d 6c69 6e6b 733d 666f 6c6c 6f77  _symlinks=follow
+0000f9b0: 6c69 6e6b 7329 290a 0a20 2020 2020 2020  links))..       
+0000f9c0: 2020 2020 2070 7265 6669 7820 3d20 5f62       prefix = _b
+0000f9d0: 6563 6f6d 655f 7072 6566 6978 286b 6579  ecome_prefix(key
+0000f9e0: 290a 2020 2020 2020 2020 2020 2020 636c  ).            cl
+0000f9f0: 6965 6e74 203d 2073 656c 662e 5f63 6c69  ient = self._cli
+0000fa00: 656e 740a 2020 2020 2020 2020 2020 2020  ent.            
+0000fa10: 7769 7468 2072 6169 7365 5f73 335f 6572  with raise_s3_er
+0000fa20: 726f 7228 7365 6c66 2e70 6174 685f 7769  ror(self.path_wi
+0000fa30: 7468 5f70 726f 746f 636f 6c29 3a0a 2020  th_protocol):.  
+0000fa40: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0000fa50: 7220 7265 7370 2069 6e20 5f6c 6973 745f  r resp in _list_
+0000fa60: 6f62 6a65 6374 735f 7265 6375 7273 6976  objects_recursiv
+0000fa70: 6528 636c 6965 6e74 2c20 6275 636b 6574  e(client, bucket
+0000fa80: 2c20 7072 6566 6978 293a 0a20 2020 2020  , prefix):.     
+0000fa90: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000faa0: 6f72 2063 6f6e 7465 6e74 2069 6e20 7265  or content in re
+0000fab0: 7370 2e67 6574 2827 436f 6e74 656e 7473  sp.get('Contents
+0000fac0: 272c 205b 5d29 3a0a 2020 2020 2020 2020  ', []):.        
+0000fad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fae0: 6675 6c6c 5f70 6174 6820 3d20 7333 5f70  full_path = s3_p
+0000faf0: 6174 685f 6a6f 696e 280a 2020 2020 2020  ath_join(.      
+0000fb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb10: 2020 2020 2020 6627 7b73 656c 662e 5f70        f'{self._p
+0000fb20: 726f 746f 636f 6c5f 7769 7468 5f70 726f  rotocol_with_pro
+0000fb30: 6669 6c65 7d3a 2f2f 272c 2062 7563 6b65  file}://', bucke
+0000fb40: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+0000fb50: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000fb60: 6f6e 7465 6e74 5b27 4b65 7927 5d29 0a20  ontent['Key']). 
+0000fb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb80: 2020 2020 2020 2079 6965 6c64 2046 696c         yield Fil
+0000fb90: 6545 6e74 7279 280a 2020 2020 2020 2020  eEntry(.        
+0000fba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fbb0: 2020 2020 5333 5061 7468 2866 756c 6c5f      S3Path(full_
+0000fbc0: 7061 7468 292e 6e61 6d65 2c20 6675 6c6c  path).name, full
+0000fbd0: 5f70 6174 682c 0a20 2020 2020 2020 2020  _path,.         
+0000fbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fbf0: 2020 205f 6d61 6b65 5f73 7461 7428 636f     _make_stat(co
+0000fc00: 6e74 656e 7429 290a 0a20 2020 2020 2020  ntent))..       
+0000fc10: 2072 6574 7572 6e20 5f63 7265 6174 655f   return _create_
+0000fc20: 6d69 7373 696e 675f 6f6b 5f67 656e 6572  missing_ok_gener
+0000fc30: 6174 6f72 280a 2020 2020 2020 2020 2020  ator(.          
+0000fc40: 2020 6372 6561 7465 5f67 656e 6572 6174    create_generat
+0000fc50: 6f72 2829 2c20 6d69 7373 696e 675f 6f6b  or(), missing_ok
+0000fc60: 2c0a 2020 2020 2020 2020 2020 2020 5333  ,.            S3
+0000fc70: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
+0000fc80: 7228 274e 6f20 6d61 7463 6820 6669 6c65  r('No match file
+0000fc90: 3a20 2572 2720 2520 7365 6c66 2e70 6174  : %r' % self.pat
+0000fca0: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
+0000fcb0: 290a 0a20 2020 2064 6566 2073 6361 6e64  )..    def scand
+0000fcc0: 6972 2873 656c 662c 2066 6f6c 6c6f 776c  ir(self, followl
+0000fcd0: 696e 6b73 3a20 626f 6f6c 203d 2046 616c  inks: bool = Fal
+0000fce0: 7365 2920 2d3e 2049 7465 7261 746f 725b  se) -> Iterator[
+0000fcf0: 4669 6c65 456e 7472 795d 3a0a 2020 2020  FileEntry]:.    
+0000fd00: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
+0000fd10: 4765 7420 616c 6c20 636f 6e74 656e 7473  Get all contents
+0000fd20: 206f 6620 6769 7665 6e20 7333 5f75 726c   of given s3_url
+0000fd30: 2c20 7468 6520 6f72 6465 7220 6f66 2072  , the order of r
+0000fd40: 6573 756c 7420 6973 206e 6f74 2067 7561  esult is not gua
+0000fd50: 7261 6e74 6565 642e 0a0a 2020 2020 2020  ranteed...      
+0000fd60: 2020 3a72 6574 7572 6e73 3a20 416c 6c20    :returns: All 
+0000fd70: 636f 6e74 656e 7473 2068 6176 6520 7072  contents have pr
+0000fd80: 6566 6978 206f 6620 7333 5f75 726c 0a20  efix of s3_url. 
+0000fd90: 2020 2020 2020 203a 7261 6973 6573 3a20         :raises: 
+0000fda0: 5333 4669 6c65 4e6f 7446 6f75 6e64 4572  S3FileNotFoundEr
+0000fdb0: 726f 722c 2053 334e 6f74 4144 6972 6563  ror, S3NotADirec
+0000fdc0: 746f 7279 4572 726f 720a 2020 2020 2020  toryError.      
+0000fdd0: 2020 2727 270a 2020 2020 2020 2020 6275    '''.        bu
+0000fde0: 636b 6574 2c20 6b65 7920 3d20 7061 7273  cket, key = pars
+0000fdf0: 655f 7333 5f75 726c 2873 656c 662e 7061  e_s3_url(self.pa
+0000fe00: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
+0000fe10: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+0000fe20: 2062 7563 6b65 7420 616e 6420 6b65 793a   bucket and key:
+0000fe30: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0000fe40: 7365 2053 3342 7563 6b65 744e 6f74 466f  se S3BucketNotFo
+0000fe50: 756e 6445 7272 6f72 280a 2020 2020 2020  undError(.      
+0000fe60: 2020 2020 2020 2020 2020 2745 6d70 7479            'Empty
+0000fe70: 2062 7563 6b65 7420 6e61 6d65 3a20 2572   bucket name: %r
+0000fe80: 2720 2520 7365 6c66 2e70 6174 685f 7769  ' % self.path_wi
+0000fe90: 7468 5f70 726f 746f 636f 6c29 0a0a 2020  th_protocol)..  
+0000fea0: 2020 2020 2020 6966 2073 656c 662e 6973        if self.is
+0000feb0: 5f66 696c 6528 293a 0a20 2020 2020 2020  _file():.       
+0000fec0: 2020 2020 2072 6169 7365 2053 334e 6f74       raise S3Not
+0000fed0: 4144 6972 6563 746f 7279 4572 726f 7228  ADirectoryError(
+0000fee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fef0: 2027 4e6f 7420 6120 6469 7265 6374 6f72   'Not a director
+0000ff00: 793a 2025 7227 2025 2073 656c 662e 7061  y: %r' % self.pa
+0000ff10: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
+0000ff20: 290a 2020 2020 2020 2020 656c 6966 206e  ).        elif n
+0000ff30: 6f74 2073 656c 662e 6973 5f64 6972 2829  ot self.is_dir()
+0000ff40: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+0000ff50: 6973 6520 5333 4669 6c65 4e6f 7446 6f75  ise S3FileNotFou
+0000ff60: 6e64 4572 726f 7228 0a20 2020 2020 2020  ndError(.       
+0000ff70: 2020 2020 2020 2020 2027 4e6f 2073 7563           'No suc
+0000ff80: 6820 6469 7265 6374 6f72 793a 2025 7227  h directory: %r'
+0000ff90: 2025 2073 656c 662e 7061 7468 5f77 6974   % self.path_wit
+0000ffa0: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
+0000ffb0: 2020 2020 7072 6566 6978 203d 205f 6265      prefix = _be
+0000ffc0: 636f 6d65 5f70 7265 6669 7828 6b65 7929  come_prefix(key)
+0000ffd0: 0a20 2020 2020 2020 2063 6c69 656e 7420  .        client 
+0000ffe0: 3d20 7365 6c66 2e5f 636c 6965 6e74 0a0a  = self._client..
+0000fff0: 2020 2020 2020 2020 2320 496e 206f 7264          # In ord
+00010000: 6572 2074 6f20 646f 2063 6865 636b 206f  er to do check o
+00010010: 6e20 6372 6561 7469 6f6e 2c0a 2020 2020  n creation,.    
+00010020: 2020 2020 2320 7765 206e 6565 6420 746f      # we need to
+00010030: 2077 7261 7020 7468 6520 6974 6572 6174   wrap the iterat
+00010040: 6f72 2069 6e20 616e 6f74 6865 7220 6675  or in another fu
+00010050: 6e63 7469 6f6e 0a20 2020 2020 2020 2064  nction.        d
+00010060: 6566 2063 7265 6174 655f 6765 6e65 7261  ef create_genera
+00010070: 746f 7228 2920 2d3e 2049 7465 7261 746f  tor() -> Iterato
+00010080: 725b 4669 6c65 456e 7472 795d 3a0a 2020  r[FileEntry]:.  
+00010090: 2020 2020 2020 2020 2020 7769 7468 2072            with r
+000100a0: 6169 7365 5f73 335f 6572 726f 7228 7365  aise_s3_error(se
+000100b0: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
+000100c0: 746f 636f 6c29 3a0a 0a20 2020 2020 2020  tocol):..       
+000100d0: 2020 2020 2020 2020 2064 6566 2067 656e           def gen
+000100e0: 6572 6174 655f 7333 5f70 6174 6828 0a20  erate_s3_path(. 
+000100f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010100: 2020 2020 2020 2070 726f 746f 636f 6c3a         protocol:
+00010110: 2073 7472 2c20 6275 636b 6574 3a20 7374   str, bucket: st
+00010120: 722c 206b 6579 3a20 7374 7229 202d 3e20  r, key: str) -> 
+00010130: 7374 723a 0a20 2020 2020 2020 2020 2020  str:.           
+00010140: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00010150: 2225 733a 2f2f 2573 2f25 7322 2025 2028  "%s://%s/%s" % (
+00010160: 7072 6f74 6f63 6f6c 2c20 6275 636b 6574  protocol, bucket
+00010170: 2c20 6b65 7929 0a0a 2020 2020 2020 2020  , key)..        
+00010180: 2020 2020 2020 2020 6966 206e 6f74 2062          if not b
+00010190: 7563 6b65 7420 616e 6420 6e6f 7420 6b65  ucket and not ke
+000101a0: 793a 2020 2320 6c69 7374 2062 7563 6b65  y:  # list bucke
+000101b0: 7473 0a20 2020 2020 2020 2020 2020 2020  ts.             
+000101c0: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
+000101d0: 3d20 636c 6965 6e74 2e6c 6973 745f 6275  = client.list_bu
+000101e0: 636b 6574 7328 290a 2020 2020 2020 2020  ckets().        
+000101f0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00010200: 636f 6e74 656e 7420 696e 2072 6573 706f  content in respo
+00010210: 6e73 655b 2742 7563 6b65 7473 275d 3a0a  nse['Buckets']:.
+00010220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010230: 2020 2020 2020 2020 7969 656c 6420 4669          yield Fi
+00010240: 6c65 456e 7472 7928 0a20 2020 2020 2020  leEntry(.       
+00010250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010260: 2020 2020 2063 6f6e 7465 6e74 5b27 4e61       content['Na
+00010270: 6d65 275d 2c20 6622 7333 3a2f 2f7b 636f  me'], f"s3://{co
+00010280: 6e74 656e 745b 274e 616d 6527 5d7d 222c  ntent['Name']}",
+00010290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000102a0: 2020 2020 2020 2020 2020 2020 2053 7461               Sta
+000102b0: 7452 6573 756c 7428 0a20 2020 2020 2020  tResult(.       
+000102c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000102d0: 2020 2020 2020 2020 2063 7469 6d65 3d63           ctime=c
+000102e0: 6f6e 7465 6e74 5b27 4372 6561 7469 6f6e  ontent['Creation
+000102f0: 4461 7465 275d 2e74 696d 6573 7461 6d70  Date'].timestamp
+00010300: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
+00010310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010320: 2020 2020 6973 6469 723d 5472 7565 2c0a      isdir=True,.
+00010330: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00010340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010350: 2020 2020 2020 2020 2020 6374 696d 653d            ctime=
-00010360: 636f 6e74 656e 745b 2743 7265 6174 696f  content['Creatio
-00010370: 6e44 6174 6527 5d2e 7469 6d65 7374 616d  nDate'].timestam
-00010380: 7028 292c 0a20 2020 2020 2020 2020 2020  p(),.           
-00010390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000103a0: 2020 2020 2069 7364 6972 3d54 7275 652c       isdir=True,
-000103b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000103c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000103d0: 2065 7874 7261 3d63 6f6e 7465 6e74 2c0a   extra=content,.
-000103e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000103f0: 2020 2020 2020 2020 2020 2020 2929 0a20              )). 
+00010350: 6578 7472 613d 636f 6e74 656e 742c 0a20  extra=content,. 
+00010360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010370: 2020 2020 2020 2020 2020 2029 290a 2020             )).  
+00010380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010390: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
+000103a0: 2020 2020 2020 2020 2020 666f 7220 7265            for re
+000103b0: 7370 2069 6e20 5f6c 6973 745f 6f62 6a65  sp in _list_obje
+000103c0: 6374 735f 7265 6375 7273 6976 6528 636c  cts_recursive(cl
+000103d0: 6965 6e74 2c20 6275 636b 6574 2c20 7072  ient, bucket, pr
+000103e0: 6566 6978 2c0a 2020 2020 2020 2020 2020  efix,.          
+000103f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00010400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010410: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
-00010420: 2020 2020 2020 2020 2020 2066 6f72 2072             for r
-00010430: 6573 7020 696e 205f 6c69 7374 5f6f 626a  esp in _list_obj
-00010440: 6563 7473 5f72 6563 7572 7369 7665 2863  ects_recursive(c
-00010450: 6c69 656e 742c 2062 7563 6b65 742c 2070  lient, bucket, p
-00010460: 7265 6669 782c 0a20 2020 2020 2020 2020  refix,.         
+00010410: 2020 2020 2020 2020 2020 272f 2729 3a0a            '/'):.
+00010420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010430: 2020 2020 666f 7220 636f 6d6d 6f6e 5f70      for common_p
+00010440: 7265 6669 7820 696e 2072 6573 702e 6765  refix in resp.ge
+00010450: 7428 2743 6f6d 6d6f 6e50 7265 6669 7865  t('CommonPrefixe
+00010460: 7327 2c20 5b5d 293a 0a20 2020 2020 2020  s', []):.       
 00010470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010490: 2020 2020 2020 2020 2020 2027 2f27 293a             '/'):
-000104a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000104b0: 2020 2020 2066 6f72 2063 6f6d 6d6f 6e5f       for common_
-000104c0: 7072 6566 6978 2069 6e20 7265 7370 2e67  prefix in resp.g
-000104d0: 6574 2827 436f 6d6d 6f6e 5072 6566 6978  et('CommonPrefix
-000104e0: 6573 272c 205b 5d29 3a0a 2020 2020 2020  es', []):.      
-000104f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010500: 2020 7969 656c 6420 4669 6c65 456e 7472    yield FileEntr
-00010510: 7928 0a20 2020 2020 2020 2020 2020 2020  y(.             
-00010520: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00010530: 6f6d 6d6f 6e5f 7072 6566 6978 5b27 5072  ommon_prefix['Pr
-00010540: 6566 6978 275d 5b6c 656e 2870 7265 6669  efix'][len(prefi
-00010550: 7829 3a2d 315d 2c0a 2020 2020 2020 2020  x):-1],.        
-00010560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010570: 2020 2020 6765 6e65 7261 7465 5f73 335f      generate_s3_
-00010580: 7061 7468 280a 2020 2020 2020 2020 2020  path(.          
+00010480: 2079 6965 6c64 2046 696c 6545 6e74 7279   yield FileEntry
+00010490: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000104a0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+000104b0: 6d6d 6f6e 5f70 7265 6669 785b 2750 7265  mmon_prefix['Pre
+000104c0: 6669 7827 5d5b 6c65 6e28 7072 6566 6978  fix'][len(prefix
+000104d0: 293a 2d31 5d2c 0a20 2020 2020 2020 2020  ):-1],.         
+000104e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000104f0: 2020 2067 656e 6572 6174 655f 7333 5f70     generate_s3_p
+00010500: 6174 6828 0a20 2020 2020 2020 2020 2020  ath(.           
+00010510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010520: 2020 2020 2073 656c 662e 5f70 726f 746f       self._proto
+00010530: 636f 6c5f 7769 7468 5f70 726f 6669 6c65  col_with_profile
+00010540: 2c20 6275 636b 6574 2c0a 2020 2020 2020  , bucket,.      
+00010550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010560: 2020 2020 2020 2020 2020 636f 6d6d 6f6e            common
+00010570: 5f70 7265 6669 785b 2750 7265 6669 7827  _prefix['Prefix'
+00010580: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
 00010590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000105a0: 2020 2020 2020 7365 6c66 2e5f 7072 6f74        self._prot
-000105b0: 6f63 6f6c 5f77 6974 685f 7072 6f66 696c  ocol_with_profil
-000105c0: 652c 2062 7563 6b65 742c 0a20 2020 2020  e, bucket,.     
+000105a0: 5374 6174 5265 7375 6c74 2869 7364 6972  StatResult(isdir
+000105b0: 3d54 7275 652c 2065 7874 7261 3d63 6f6d  =True, extra=com
+000105c0: 6d6f 6e5f 7072 6566 6978 2929 0a20 2020  mon_prefix)).   
 000105d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000105e0: 2020 2020 2020 2020 2020 2063 6f6d 6d6f             commo
-000105f0: 6e5f 7072 6566 6978 5b27 5072 6566 6978  n_prefix['Prefix
-00010600: 275d 292c 0a20 2020 2020 2020 2020 2020  ']),.           
+000105e0: 2066 6f72 2063 6f6e 7465 6e74 2069 6e20   for content in 
+000105f0: 7265 7370 2e67 6574 2827 436f 6e74 656e  resp.get('Conten
+00010600: 7473 272c 205b 5d29 3a0a 2020 2020 2020  ts', []):.      
 00010610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010620: 2053 7461 7452 6573 756c 7428 6973 6469   StatResult(isdi
-00010630: 723d 5472 7565 2c20 6578 7472 613d 636f  r=True, extra=co
-00010640: 6d6d 6f6e 5f70 7265 6669 7829 290a 2020  mmon_prefix)).  
-00010650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010660: 2020 666f 7220 636f 6e74 656e 7420 696e    for content in
-00010670: 2072 6573 702e 6765 7428 2743 6f6e 7465   resp.get('Conte
-00010680: 6e74 7327 2c20 5b5d 293a 0a20 2020 2020  nts', []):.     
+00010620: 2020 7372 635f 7572 6c20 3d20 6765 6e65    src_url = gene
+00010630: 7261 7465 5f73 335f 7061 7468 280a 2020  rate_s3_path(.  
+00010640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010650: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00010660: 7072 6f74 6f63 6f6c 5f77 6974 685f 7072  protocol_with_pr
+00010670: 6f66 696c 652c 2062 7563 6b65 742c 2063  ofile, bucket, c
+00010680: 6f6e 7465 6e74 5b27 4b65 7927 5d29 0a0a  ontent['Key'])..
 00010690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000106a0: 2020 2073 7263 5f75 726c 203d 2067 656e     src_url = gen
-000106b0: 6572 6174 655f 7333 5f70 6174 6828 0a20  erate_s3_path(. 
-000106c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000106d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000106e0: 5f70 726f 746f 636f 6c5f 7769 7468 5f70  _protocol_with_p
-000106f0: 726f 6669 6c65 2c20 6275 636b 6574 2c20  rofile, bucket, 
-00010700: 636f 6e74 656e 745b 274b 6579 275d 290a  content['Key']).
-00010710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010720: 2020 2020 2020 2020 2069 6620 666f 6c6c           if foll
-00010730: 6f77 6c69 6e6b 7320 616e 6420 5333 5061  owlinks and S3Pa
-00010740: 7468 2873 7263 5f75 726c 292e 6973 5f73  th(src_url).is_s
-00010750: 796d 6c69 6e6b 2829 3a0a 2020 2020 2020  ymlink():.      
-00010760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010770: 2020 2020 2020 636f 6e74 656e 745b 2769        content['i
-00010780: 736c 6e6b 275d 203d 2054 7275 650a 0a20  slnk'] = True.. 
-00010790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000107a0: 2020 2020 2020 2079 6965 6c64 2046 696c         yield Fil
-000107b0: 6545 6e74 7279 280a 2020 2020 2020 2020  eEntry(.        
-000107c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000107d0: 2020 2020 636f 6e74 656e 745b 274b 6579      content['Key
-000107e0: 275d 5b6c 656e 2870 7265 6669 7829 3a5d  '][len(prefix):]
-000107f0: 2c20 7372 635f 7572 6c2c 0a20 2020 2020  , src_url,.     
-00010800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010810: 2020 2020 2020 205f 6d61 6b65 5f73 7461         _make_sta
-00010820: 7428 636f 6e74 656e 7429 290a 0a20 2020  t(content))..   
-00010830: 2020 2020 2072 6574 7572 6e20 436f 6e74       return Cont
-00010840: 6578 7449 7465 7261 746f 7228 6372 6561  extIterator(crea
-00010850: 7465 5f67 656e 6572 6174 6f72 2829 290a  te_generator()).
-00010860: 0a20 2020 2064 6566 205f 6765 7464 6972  .    def _getdir
-00010870: 7374 6174 2873 656c 6629 202d 3e20 5374  stat(self) -> St
-00010880: 6174 5265 7375 6c74 3a0a 2020 2020 2020  atResult:.      
-00010890: 2020 2727 270a 2020 2020 2020 2020 5265    '''.        Re
-000108a0: 7475 726e 2053 7461 7452 6573 756c 7420  turn StatResult 
-000108b0: 6f66 2067 6976 656e 2073 335f 7572 6c20  of given s3_url 
-000108c0: 6469 7265 6374 6f72 792c 2069 6e63 6c75  directory, inclu
-000108d0: 6469 6e67 3a20 0a0a 2020 2020 2020 2020  ding: ..        
-000108e0: 312e 2044 6972 6563 746f 7279 2073 697a  1. Directory siz
-000108f0: 653a 2074 6865 2073 756d 206f 6620 616c  e: the sum of al
-00010900: 6c20 6669 6c65 2073 697a 6520 696e 2069  l file size in i
-00010910: 742c 2069 6e63 6c75 6469 6e67 2066 696c  t, including fil
-00010920: 6520 696e 2073 7562 6469 7265 6374 6f72  e in subdirector
-00010930: 6965 7320 2869 6620 6578 6973 7429 2e0a  ies (if exist)..
-00010940: 2020 2020 2020 2020 5468 6520 7265 7375          The resu
-00010950: 6c74 2065 7863 6c75 6465 7320 7468 6520  lt excludes the 
-00010960: 7369 7a65 206f 6620 6469 7265 6374 6f72  size of director
-00010970: 7920 6974 7365 6c66 2e20 496e 206f 7468  y itself. In oth
-00010980: 6572 2077 6f72 6473 2c20 7265 7475 726e  er words, return
-00010990: 2030 2042 7974 6520 6f6e 2061 6e20 656d   0 Byte on an em
-000109a0: 7074 7920 6469 7265 6374 6f72 7920 7061  pty directory pa
-000109b0: 7468 0a20 2020 2020 2020 2032 2e20 4c61  th.        2. La
-000109c0: 7374 2d6d 6f64 6966 6965 6420 7469 6d65  st-modified time
-000109d0: 206f 6620 6469 7265 6374 6f72 793a 2072   of directory: r
-000109e0: 6574 7572 6e20 7468 6520 6c61 7465 7374  eturn the latest
-000109f0: 206d 6f64 6966 6965 6420 7469 6d65 206f   modified time o
-00010a00: 6620 616c 6c20 6669 6c65 2069 6e20 6974  f all file in it
-00010a10: 2e20 5468 6520 6d74 696d 6520 6f66 2065  . The mtime of e
-00010a20: 6d70 7479 2064 6972 6563 746f 7279 2069  mpty directory i
-00010a30: 7320 3139 3730 2d30 312d 3031 2030 303a  s 1970-01-01 00:
-00010a40: 3030 3a30 300a 0a20 2020 2020 2020 203a  00:00..        :
-00010a50: 7265 7475 726e 733a 2041 6e20 696e 7420  returns: An int 
-00010a60: 696e 6469 6361 7465 7320 7369 7a65 2069  indicates size i
-00010a70: 6e20 4279 7465 730a 2020 2020 2020 2020  n Bytes.        
-00010a80: 2727 270a 2020 2020 2020 2020 6966 206e  '''.        if n
-00010a90: 6f74 2073 656c 662e 6973 5f64 6972 2829  ot self.is_dir()
-00010aa0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00010ab0: 6973 6520 5333 4669 6c65 4e6f 7446 6f75  ise S3FileNotFou
-00010ac0: 6e64 4572 726f 7228 0a20 2020 2020 2020  ndError(.       
-00010ad0: 2020 2020 2020 2020 2027 4e6f 2073 7563           'No suc
-00010ae0: 6820 6669 6c65 206f 7220 6469 7265 6374  h file or direct
-00010af0: 6f72 793a 2025 7227 2025 2073 656c 662e  ory: %r' % self.
-00010b00: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
-00010b10: 6f6c 290a 0a20 2020 2020 2020 2062 7563  ol)..        buc
-00010b20: 6b65 742c 206b 6579 203d 2070 6172 7365  ket, key = parse
-00010b30: 5f73 335f 7572 6c28 7365 6c66 2e70 6174  _s3_url(self.pat
-00010b40: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-00010b50: 0a20 2020 2020 2020 2070 7265 6669 7820  .        prefix 
-00010b60: 3d20 5f62 6563 6f6d 655f 7072 6566 6978  = _become_prefix
-00010b70: 286b 6579 290a 2020 2020 2020 2020 636c  (key).        cl
-00010b80: 6965 6e74 203d 2073 656c 662e 5f63 6c69  ient = self._cli
-00010b90: 656e 740a 2020 2020 2020 2020 7369 7a65  ent.        size
-00010ba0: 203d 2030 0a20 2020 2020 2020 206d 7469   = 0.        mti
-00010bb0: 6d65 203d 2030 2e30 0a20 2020 2020 2020  me = 0.0.       
-00010bc0: 2077 6974 6820 7261 6973 655f 7333 5f65   with raise_s3_e
-00010bd0: 7272 6f72 2873 656c 662e 7061 7468 5f77  rror(self.path_w
-00010be0: 6974 685f 7072 6f74 6f63 6f6c 293a 0a20  ith_protocol):. 
-00010bf0: 2020 2020 2020 2020 2020 2066 6f72 2072             for r
-00010c00: 6573 7020 696e 205f 6c69 7374 5f6f 626a  esp in _list_obj
-00010c10: 6563 7473 5f72 6563 7572 7369 7665 2863  ects_recursive(c
-00010c20: 6c69 656e 742c 2062 7563 6b65 742c 2070  lient, bucket, p
-00010c30: 7265 6669 7829 3a0a 2020 2020 2020 2020  refix):.        
-00010c40: 2020 2020 2020 2020 666f 7220 636f 6e74          for cont
-00010c50: 656e 7420 696e 2072 6573 702e 6765 7428  ent in resp.get(
-00010c60: 2743 6f6e 7465 6e74 7327 2c20 5b5d 293a  'Contents', []):
-00010c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010c80: 2020 2020 2073 697a 6520 2b3d 2063 6f6e       size += con
-00010c90: 7465 6e74 5b27 5369 7a65 275d 0a20 2020  tent['Size'].   
-00010ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010cb0: 206c 6173 745f 6d6f 6469 6669 6564 203d   last_modified =
-00010cc0: 2063 6f6e 7465 6e74 5b27 4c61 7374 4d6f   content['LastMo
-00010cd0: 6469 6669 6564 275d 2e74 696d 6573 7461  dified'].timesta
-00010ce0: 6d70 2829 0a20 2020 2020 2020 2020 2020  mp().           
-00010cf0: 2020 2020 2020 2020 2069 6620 6d74 696d           if mtim
-00010d00: 6520 3c20 6c61 7374 5f6d 6f64 6966 6965  e < last_modifie
-00010d10: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
-00010d20: 2020 2020 2020 2020 2020 206d 7469 6d65             mtime
-00010d30: 203d 206c 6173 745f 6d6f 6469 6669 6564   = last_modified
-00010d40: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00010d50: 2053 7461 7452 6573 756c 7428 7369 7a65   StatResult(size
-00010d60: 3d73 697a 652c 206d 7469 6d65 3d6d 7469  =size, mtime=mti
-00010d70: 6d65 2c20 6973 6469 723d 5472 7565 290a  me, isdir=True).
-00010d80: 0a20 2020 2064 6566 2073 7461 7428 7365  .    def stat(se
-00010d90: 6c66 2c20 666f 6c6c 6f77 5f73 796d 6c69  lf, follow_symli
-00010da0: 6e6b 733d 5472 7565 2920 2d3e 2053 7461  nks=True) -> Sta
-00010db0: 7452 6573 756c 743a 0a20 2020 2020 2020  tResult:.       
-00010dc0: 2027 2727 0a20 2020 2020 2020 2047 6574   '''.        Get
-00010dd0: 2053 7461 7452 6573 756c 7420 6f66 2073   StatResult of s
-00010de0: 335f 7572 6c20 6669 6c65 2c20 696e 636c  3_url file, incl
-00010df0: 7564 696e 6720 6669 6c65 2073 697a 6520  uding file size 
-00010e00: 616e 6420 6d74 696d 652c 2072 6566 6572  and mtime, refer
-00010e10: 7269 6e67 2074 6f20 7333 5f67 6574 7369  ring to s3_getsi
-00010e20: 7a65 2061 6e64 2073 335f 6765 746d 7469  ze and s3_getmti
-00010e30: 6d65 0a0a 2020 2020 2020 2020 4966 2073  me..        If s
-00010e40: 335f 7572 6c20 6973 206e 6f74 2061 6e20  3_url is not an 
-00010e50: 6578 6973 7465 6e74 2070 6174 682c 2077  existent path, w
-00010e60: 6869 6368 206d 6561 6e73 2073 335f 6578  hich means s3_ex
-00010e70: 6973 7428 7333 5f75 726c 2920 7265 7475  ist(s3_url) retu
-00010e80: 726e 7320 4661 6c73 652c 2074 6865 6e20  rns False, then 
-00010e90: 7261 6973 6520 5333 4669 6c65 4e6f 7446  raise S3FileNotF
-00010ea0: 6f75 6e64 4572 726f 720a 2020 2020 2020  oundError.      
-00010eb0: 2020 4966 2061 7474 656d 7074 2074 6f20    If attempt to 
-00010ec0: 6765 7420 5374 6174 5265 7375 6c74 206f  get StatResult o
-00010ed0: 6620 636f 6d70 6c65 7465 2073 332c 2073  f complete s3, s
-00010ee0: 7563 6820 6173 2073 335f 6469 725f 7572  uch as s3_dir_ur
-00010ef0: 6c20 3d3d 2027 7333 3a2f 2f27 2c20 7261  l == 's3://', ra
-00010f00: 6973 6520 5333 4275 636b 6574 4e6f 7446  ise S3BucketNotF
-00010f10: 6f75 6e64 4572 726f 720a 0a20 2020 2020  oundError..     
-00010f20: 2020 203a 7265 7475 726e 733a 2053 7461     :returns: Sta
-00010f30: 7452 6573 756c 740a 2020 2020 2020 2020  tResult.        
-00010f40: 3a72 6169 7365 733a 2053 3346 696c 654e  :raises: S3FileN
-00010f50: 6f74 466f 756e 6445 7272 6f72 2c20 5333  otFoundError, S3
-00010f60: 4275 636b 6574 4e6f 7446 6f75 6e64 4572  BucketNotFoundEr
-00010f70: 726f 720a 2020 2020 2020 2020 2727 270a  ror.        '''.
-00010f80: 2020 2020 2020 2020 6973 6c6e 6b20 3d20          islnk = 
-00010f90: 4661 6c73 650a 2020 2020 2020 2020 6275  False.        bu
-00010fa0: 636b 6574 2c20 6b65 7920 3d20 7061 7273  cket, key = pars
-00010fb0: 655f 7333 5f75 726c 2873 656c 662e 7061  e_s3_url(self.pa
-00010fc0: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-00010fd0: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-00010fe0: 2062 7563 6b65 743a 0a20 2020 2020 2020   bucket:.       
-00010ff0: 2020 2020 2072 6169 7365 2053 3342 7563       raise S3Buc
-00011000: 6b65 744e 6f74 466f 756e 6445 7272 6f72  ketNotFoundError
-00011010: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00011020: 2020 2745 6d70 7479 2062 7563 6b65 7420    'Empty bucket 
-00011030: 6e61 6d65 3a20 2572 2720 2520 7365 6c66  name: %r' % self
-00011040: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
-00011050: 636f 6c29 0a0a 2020 2020 2020 2020 6966  col)..        if
-00011060: 206e 6f74 2073 656c 662e 6973 5f66 696c   not self.is_fil
-00011070: 6528 293a 0a20 2020 2020 2020 2020 2020  e():.           
-00011080: 2072 6574 7572 6e20 7365 6c66 2e5f 6765   return self._ge
-00011090: 7464 6972 7374 6174 2829 0a0a 2020 2020  tdirstat()..    
-000110a0: 2020 2020 636c 6965 6e74 203d 2073 656c      client = sel
-000110b0: 662e 5f63 6c69 656e 740a 2020 2020 2020  f._client.      
-000110c0: 2020 7769 7468 2072 6169 7365 5f73 335f    with raise_s3_
-000110d0: 6572 726f 7228 7365 6c66 2e70 6174 685f  error(self.path_
-000110e0: 7769 7468 5f70 726f 746f 636f 6c29 3a0a  with_protocol):.
-000110f0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00011100: 656e 7420 3d20 636c 6965 6e74 2e68 6561  ent = client.hea
-00011110: 645f 6f62 6a65 6374 2842 7563 6b65 743d  d_object(Bucket=
-00011120: 6275 636b 6574 2c20 4b65 793d 6b65 7929  bucket, Key=key)
-00011130: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00011140: 274d 6574 6164 6174 6127 2069 6e20 636f  'Metadata' in co
-00011150: 6e74 656e 743a 0a20 2020 2020 2020 2020  ntent:.         
-00011160: 2020 2020 2020 206d 6574 6164 6174 6120         metadata 
-00011170: 3d20 6469 6374 280a 2020 2020 2020 2020  = dict(.        
-00011180: 2020 2020 2020 2020 2020 2020 286b 6579              (key
-00011190: 2e6c 6f77 6572 2829 2c20 7661 6c75 6529  .lower(), value)
-000111a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000111b0: 2020 2020 2066 6f72 206b 6579 2c20 7661       for key, va
-000111c0: 6c75 6520 696e 2063 6f6e 7465 6e74 5b27  lue in content['
-000111d0: 4d65 7461 6461 7461 275d 2e69 7465 6d73  Metadata'].items
-000111e0: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
-000111f0: 2020 2020 6966 206d 6574 6164 6174 6120      if metadata 
-00011200: 616e 6420 2773 796d 6c69 6e6b 5f74 6f27  and 'symlink_to'
-00011210: 2069 6e20 6d65 7461 6461 7461 3a0a 2020   in metadata:.  
-00011220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011230: 2020 6973 6c6e 6b20 3d20 5472 7565 0a20    islnk = True. 
-00011240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011250: 2020 2069 6620 6973 6c6e 6b20 616e 6420     if islnk and 
-00011260: 666f 6c6c 6f77 5f73 796d 6c69 6e6b 733a  follow_symlinks:
-00011270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011280: 2020 2020 2020 2020 2073 335f 7572 6c20           s3_url 
-00011290: 3d20 6d65 7461 6461 7461 5b27 7379 6d6c  = metadata['syml
-000112a0: 696e 6b5f 746f 275d 0a20 2020 2020 2020  ink_to'].       
-000112b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000112c0: 2062 7563 6b65 742c 206b 6579 203d 2070   bucket, key = p
-000112d0: 6172 7365 5f73 335f 7572 6c28 7333 5f75  arse_s3_url(s3_u
-000112e0: 726c 290a 2020 2020 2020 2020 2020 2020  rl).            
-000112f0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00011300: 656e 7420 3d20 636c 6965 6e74 2e68 6561  ent = client.hea
-00011310: 645f 6f62 6a65 6374 2842 7563 6b65 743d  d_object(Bucket=
-00011320: 6275 636b 6574 2c20 4b65 793d 6b65 7929  bucket, Key=key)
-00011330: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-00011340: 745f 7265 636f 7264 203d 2053 7461 7452  t_record = StatR
-00011350: 6573 756c 7428 0a20 2020 2020 2020 2020  esult(.         
-00011360: 2020 2020 2020 2069 736c 6e6b 3d69 736c         islnk=isl
-00011370: 6e6b 2c0a 2020 2020 2020 2020 2020 2020  nk,.            
-00011380: 2020 2020 7369 7a65 3d63 6f6e 7465 6e74      size=content
-00011390: 5b27 436f 6e74 656e 744c 656e 6774 6827  ['ContentLength'
-000113a0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-000113b0: 2020 206d 7469 6d65 3d63 6f6e 7465 6e74     mtime=content
-000113c0: 5b27 4c61 7374 4d6f 6469 6669 6564 275d  ['LastModified']
-000113d0: 2e74 696d 6573 7461 6d70 2829 2c0a 2020  .timestamp(),.  
-000113e0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-000113f0: 7472 613d 636f 6e74 656e 7429 0a20 2020  tra=content).   
-00011400: 2020 2020 2072 6574 7572 6e20 7374 6174       return stat
-00011410: 5f72 6563 6f72 640a 0a20 2020 2064 6566  _record..    def
-00011420: 206c 7374 6174 2873 656c 6629 202d 3e20   lstat(self) -> 
-00011430: 5374 6174 5265 7375 6c74 3a0a 2020 2020  StatResult:.    
-00011440: 2020 2020 2727 274c 696b 6520 5061 7468      '''Like Path
-00011450: 2e73 7461 7428 2920 6275 742c 2069 6620  .stat() but, if 
-00011460: 7468 6520 7061 7468 2070 6f69 6e74 7320  the path points 
-00011470: 746f 2061 2073 796d 626f 6c69 6320 6c69  to a symbolic li
-00011480: 6e6b 2c20 7265 7475 726e 2074 6865 2073  nk, return the s
-00011490: 796d 626f 6c69 6320 6c69 6e6b e280 9973  ymbolic link...s
-000114a0: 2069 6e66 6f72 6d61 7469 6f6e 2072 6174   information rat
-000114b0: 6865 7220 7468 616e 2069 7473 2074 6172  her than its tar
-000114c0: 6765 74e2 8099 732e 2727 270a 2020 2020  get...s.'''.    
-000114d0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-000114e0: 7374 6174 2866 6f6c 6c6f 775f 7379 6d6c  stat(follow_syml
-000114f0: 696e 6b73 3d46 616c 7365 290a 0a20 2020  inks=False)..   
-00011500: 2064 6566 2075 6e6c 696e 6b28 7365 6c66   def unlink(self
-00011510: 2c20 6d69 7373 696e 675f 6f6b 3a20 626f  , missing_ok: bo
-00011520: 6f6c 203d 2046 616c 7365 2920 2d3e 204e  ol = False) -> N
-00011530: 6f6e 653a 0a20 2020 2020 2020 2027 2727  one:.        '''
-00011540: 0a20 2020 2020 2020 2052 656d 6f76 6520  .        Remove 
-00011550: 7468 6520 6669 6c65 206f 6e20 7333 0a0a  the file on s3..
-00011560: 2020 2020 2020 2020 3a70 6172 616d 206d          :param m
-00011570: 6973 7369 6e67 5f6f 6b3a 2069 6620 4661  issing_ok: if Fa
-00011580: 6c73 6520 616e 6420 7461 7267 6574 2066  lse and target f
-00011590: 696c 6520 6e6f 7420 6578 6973 7473 2c20  ile not exists, 
-000115a0: 7261 6973 6520 5333 4669 6c65 4e6f 7446  raise S3FileNotF
-000115b0: 6f75 6e64 4572 726f 720a 2020 2020 2020  oundError.      
-000115c0: 2020 3a72 6169 7365 733a 2053 3350 6572    :raises: S3Per
-000115d0: 6d69 7373 696f 6e45 7272 6f72 2c20 5333  missionError, S3
-000115e0: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
-000115f0: 722c 2053 3349 7341 4469 7265 6374 6f72  r, S3IsADirector
-00011600: 7945 7272 6f72 0a20 2020 2020 2020 2027  yError.        '
-00011610: 2727 0a20 2020 2020 2020 2062 7563 6b65  ''.        bucke
-00011620: 742c 206b 6579 203d 2070 6172 7365 5f73  t, key = parse_s
-00011630: 335f 7572 6c28 7365 6c66 2e70 6174 685f  3_url(self.path_
-00011640: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
-00011650: 2020 2020 2020 2069 6620 6e6f 7420 6275         if not bu
-00011660: 636b 6574 206f 7220 6e6f 7420 6b65 7920  cket or not key 
-00011670: 6f72 206b 6579 2e65 6e64 7377 6974 6828  or key.endswith(
-00011680: 272f 2729 3a0a 2020 2020 2020 2020 2020  '/'):.          
-00011690: 2020 7261 6973 6520 5333 4973 4144 6972    raise S3IsADir
-000116a0: 6563 746f 7279 4572 726f 7228 0a20 2020  ectoryError(.   
-000116b0: 2020 2020 2020 2020 2020 2020 2027 4973               'Is
-000116c0: 2061 2064 6972 6563 746f 7279 3a20 2572   a directory: %r
-000116d0: 2720 2520 7365 6c66 2e70 6174 685f 7769  ' % self.path_wi
-000116e0: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
-000116f0: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
-00011700: 2e69 735f 6669 6c65 2829 3a0a 2020 2020  .is_file():.    
-00011710: 2020 2020 2020 2020 6966 206d 6973 7369          if missi
-00011720: 6e67 5f6f 6b3a 0a20 2020 2020 2020 2020  ng_ok:.         
-00011730: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
-00011740: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00011750: 5333 4669 6c65 4e6f 7446 6f75 6e64 4572  S3FileNotFoundEr
-00011760: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-00011770: 2020 2020 2027 4e6f 2073 7563 6820 6669       'No such fi
-00011780: 6c65 3a20 2572 2720 2520 7365 6c66 2e70  le: %r' % self.p
-00011790: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-000117a0: 6c29 0a0a 2020 2020 2020 2020 7769 7468  l)..        with
-000117b0: 2072 6169 7365 5f73 335f 6572 726f 7228   raise_s3_error(
-000117c0: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
-000117d0: 726f 746f 636f 6c29 3a0a 2020 2020 2020  rotocol):.      
-000117e0: 2020 2020 2020 7365 6c66 2e5f 636c 6965        self._clie
-000117f0: 6e74 2e64 656c 6574 655f 6f62 6a65 6374  nt.delete_object
-00011800: 2842 7563 6b65 743d 6275 636b 6574 2c20  (Bucket=bucket, 
-00011810: 4b65 793d 6b65 7929 0a0a 2020 2020 6465  Key=key)..    de
-00011820: 6620 7761 6c6b 2873 656c 662c 2066 6f6c  f walk(self, fol
-00011830: 6c6f 776c 696e 6b73 3a20 626f 6f6c 203d  lowlinks: bool =
-00011840: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
-00011850: 2020 2029 202d 3e20 4974 6572 6174 6f72     ) -> Iterator
-00011860: 5b54 7570 6c65 5b73 7472 2c20 4c69 7374  [Tuple[str, List
-00011870: 5b73 7472 5d2c 204c 6973 745b 7374 725d  [str], List[str]
-00011880: 5d5d 3a0a 2020 2020 2020 2020 2727 270a  ]]:.        '''.
-00011890: 2020 2020 2020 2020 4974 6572 6174 6976          Iterativ
-000118a0: 656c 7920 7472 6176 6572 7365 2074 6865  ely traverse the
-000118b0: 2067 6976 656e 2073 3320 6469 7265 6374   given s3 direct
-000118c0: 6f72 792c 2069 6e20 746f 702d 626f 7474  ory, in top-bott
-000118d0: 6f6d 206f 7264 6572 2e20 496e 206f 7468  om order. In oth
-000118e0: 6572 2077 6f72 6473 2c20 6669 7273 746c  er words, firstl
-000118f0: 7920 7472 6176 6572 7365 2070 6172 656e  y traverse paren
-00011900: 7420 6469 7265 6374 6f72 792c 2069 6620  t directory, if 
-00011910: 7375 6264 6972 6563 746f 7269 6573 2065  subdirectories e
-00011920: 7869 7374 2c20 7472 6176 6572 7365 2074  xist, traverse t
-00011930: 6865 2073 7562 6469 7265 6374 6f72 6965  he subdirectorie
-00011940: 7320 696e 2061 6c70 6861 6265 7469 6361  s in alphabetica
-00011950: 6c20 6f72 6465 722e 0a20 2020 2020 2020  l order..       
-00011960: 2045 7665 7279 2069 7465 7261 7469 6f6e   Every iteration
-00011970: 206f 6e20 6765 6e65 7261 746f 7220 7969   on generator yi
-00011980: 656c 6473 2061 2033 2d74 7570 6c65 3a20  elds a 3-tuple: 
-00011990: 2872 6f6f 742c 2064 6972 732c 2066 696c  (root, dirs, fil
-000119a0: 6573 290a 0a20 2020 2020 2020 202d 2072  es)..        - r
-000119b0: 6f6f 743a 2043 7572 7265 6e74 2073 3320  oot: Current s3 
-000119c0: 7061 7468 3b0a 2020 2020 2020 2020 2d20  path;.        - 
-000119d0: 6469 7273 3a20 4e61 6d65 206c 6973 7420  dirs: Name list 
-000119e0: 6f66 2073 7562 6469 7265 6374 6f72 6965  of subdirectorie
-000119f0: 7320 696e 2063 7572 7265 6e74 2064 6972  s in current dir
-00011a00: 6563 746f 7279 2e20 5468 6520 6c69 7374  ectory. The list
-00011a10: 2069 7320 736f 7274 6564 2062 7920 6e61   is sorted by na
-00011a20: 6d65 2069 6e20 6173 6365 6e64 696e 6720  me in ascending 
-00011a30: 616c 7068 6162 6574 6963 616c 206f 7264  alphabetical ord
-00011a40: 6572 3b0a 2020 2020 2020 2020 2d20 6669  er;.        - fi
-00011a50: 6c65 733a 204e 616d 6520 6c69 7374 206f  les: Name list o
-00011a60: 6620 6669 6c65 7320 696e 2063 7572 7265  f files in curre
-00011a70: 6e74 2064 6972 6563 746f 7279 2e20 5468  nt directory. Th
-00011a80: 6520 6c69 7374 2069 7320 736f 7274 6564  e list is sorted
-00011a90: 2062 7920 6e61 6d65 2069 6e20 6173 6365   by name in asce
-00011aa0: 6e64 696e 6720 616c 7068 6162 6574 6963  nding alphabetic
-00011ab0: 616c 206f 7264 6572 3b0a 0a20 2020 2020  al order;..     
-00011ac0: 2020 2049 6620 7333 5f75 726c 2069 7320     If s3_url is 
-00011ad0: 6120 6669 6c65 2070 6174 682c 2072 6574  a file path, ret
-00011ae0: 7572 6e20 616e 2065 6d70 7479 2067 656e  urn an empty gen
-00011af0: 6572 6174 6f72 0a20 2020 2020 2020 2049  erator.        I
-00011b00: 6620 7333 5f75 726c 2069 7320 6120 6e6f  f s3_url is a no
-00011b10: 6e2d 6578 6973 7465 6e74 2070 6174 682c  n-existent path,
-00011b20: 2072 6574 7572 6e20 616e 2065 6d70 7479   return an empty
-00011b30: 2067 656e 6572 6174 6f72 0a20 2020 2020   generator.     
-00011b40: 2020 2049 6620 7333 5f75 726c 2069 7320     If s3_url is 
-00011b50: 6120 6275 636b 6574 2070 6174 682c 2062  a bucket path, b
-00011b60: 7563 6b65 7420 7769 6c6c 2062 6520 7468  ucket will be th
-00011b70: 6520 746f 7020 6469 7265 6374 6f72 792c  e top directory,
-00011b80: 2061 6e64 2077 696c 6c20 6265 2072 6574   and will be ret
-00011b90: 7572 6e65 6420 6174 2066 6972 7374 2069  urned at first i
-00011ba0: 7465 7261 7469 6f6e 206f 6620 6765 6e65  teration of gene
-00011bb0: 7261 746f 720a 2020 2020 2020 2020 4966  rator.        If
-00011bc0: 2073 335f 7572 6c20 6973 2061 6e20 656d   s3_url is an em
-00011bd0: 7074 7920 6275 636b 6574 2c20 6f6e 6c79  pty bucket, only
-00011be0: 2079 6965 6c64 206f 6e65 2033 2d74 7570   yield one 3-tup
-00011bf0: 6c65 2028 6e6f 7465 733a 2073 3320 646f  le (notes: s3 do
-00011c00: 6573 6e27 7420 6861 7665 2065 6d70 7479  esn't have empty
-00011c10: 2064 6972 6563 746f 7279 290a 2020 2020   directory).    
-00011c20: 2020 2020 4966 2073 335f 7572 6c20 646f      If s3_url do
-00011c30: 6573 6e27 7420 636f 6e74 6169 6e20 616e  esn't contain an
-00011c40: 7920 6275 636b 6574 2c20 7768 6963 6820  y bucket, which 
-00011c50: 6973 2073 335f 7572 6c20 3d3d 2027 7333  is s3_url == 's3
-00011c60: 3a2f 2f27 2c20 7261 6973 6520 556e 7375  ://', raise Unsu
-00011c70: 7070 6f72 7465 6445 7272 6f72 2e20 7761  pportedError. wa
-00011c80: 6c6b 2829 206f 6e20 636f 6d70 6c65 7465  lk() on complete
-00011c90: 2073 3320 6973 206e 6f74 2073 7570 706f   s3 is not suppo
-00011ca0: 7274 6564 2069 6e20 6d65 6766 696c 650a  rted in megfile.
-00011cb0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-00011cc0: 666f 6c6c 6f77 6c69 6e6b 733a 2077 6865  followlinks: whe
-00011cd0: 7468 6572 2066 6f6c 6c6f 776c 696e 6b73  ther followlinks
-00011ce0: 2069 7320 5472 7565 206f 7220 4661 6c73   is True or Fals
-00011cf0: 652c 2072 6573 756c 7420 6973 2074 6865  e, result is the
-00011d00: 2073 616d 652e 2042 6563 6175 7365 2073   same. Because s
-00011d10: 3320 7379 6d6c 696e 6b20 6e6f 7420 7375  3 symlink not su
-00011d20: 7070 6f72 7420 6469 722e 0a20 2020 2020  pport dir..     
-00011d30: 2020 203a 7261 6973 6573 3a20 556e 7375     :raises: Unsu
-00011d40: 7070 6f72 7465 6445 7272 6f72 0a20 2020  pportedError.   
-00011d50: 2020 2020 203a 7265 7475 726e 733a 2041       :returns: A
-00011d60: 2033 2d74 7570 6c65 2067 656e 6572 6174   3-tuple generat
-00011d70: 6f72 0a20 2020 2020 2020 2027 2727 0a20  or.        '''. 
-00011d80: 2020 2020 2020 2062 7563 6b65 742c 206b         bucket, k
-00011d90: 6579 203d 2070 6172 7365 5f73 335f 7572  ey = parse_s3_ur
-00011da0: 6c28 7365 6c66 2e70 6174 685f 7769 7468  l(self.path_with
-00011db0: 5f70 726f 746f 636f 6c29 0a20 2020 2020  _protocol).     
-00011dc0: 2020 2069 6620 6e6f 7420 6275 636b 6574     if not bucket
-00011dd0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00011de0: 6973 6520 556e 7375 7070 6f72 7465 6445  ise UnsupportedE
-00011df0: 7272 6f72 2827 5761 6c6b 2077 686f 6c65  rror('Walk whole
-00011e00: 2073 3327 2c20 7365 6c66 2e70 6174 685f   s3', self.path_
-00011e10: 7769 7468 5f70 726f 746f 636f 6c29 0a0a  with_protocol)..
-00011e20: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-00011e30: 656c 662e 6973 5f64 6972 2829 3a0a 2020  elf.is_dir():.  
-00011e40: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00011e50: 0a0a 2020 2020 2020 2020 7374 6163 6b20  ..        stack 
-00011e60: 3d20 5b6b 6579 5d0a 2020 2020 2020 2020  = [key].        
-00011e70: 636c 6965 6e74 203d 2073 656c 662e 5f63  client = self._c
-00011e80: 6c69 656e 740a 2020 2020 2020 2020 7768  lient.        wh
-00011e90: 696c 6520 6c65 6e28 7374 6163 6b29 203e  ile len(stack) >
-00011ea0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00011eb0: 6375 7272 656e 7420 3d20 5f62 6563 6f6d  current = _becom
-00011ec0: 655f 7072 6566 6978 2873 7461 636b 2e70  e_prefix(stack.p
-00011ed0: 6f70 2829 290a 2020 2020 2020 2020 2020  op()).          
-00011ee0: 2020 6469 7273 2c20 6669 6c65 7320 3d20    dirs, files = 
-00011ef0: 5b5d 2c20 5b5d 0a20 2020 2020 2020 2020  [], [].         
-00011f00: 2020 2066 6f72 2072 6573 7020 696e 205f     for resp in _
-00011f10: 6c69 7374 5f6f 626a 6563 7473 5f72 6563  list_objects_rec
-00011f20: 7572 7369 7665 2863 6c69 656e 742c 2062  ursive(client, b
-00011f30: 7563 6b65 742c 2063 7572 7265 6e74 2c20  ucket, current, 
-00011f40: 272f 2729 3a0a 2020 2020 2020 2020 2020  '/'):.          
-00011f50: 2020 2020 2020 666f 7220 636f 6d6d 6f6e        for common
-00011f60: 5f70 7265 6669 7820 696e 2072 6573 702e  _prefix in resp.
-00011f70: 6765 7428 2743 6f6d 6d6f 6e50 7265 6669  get('CommonPrefi
-00011f80: 7865 7327 2c20 5b5d 293a 0a20 2020 2020  xes', []):.     
-00011f90: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00011fa0: 6972 732e 6170 7065 6e64 2863 6f6d 6d6f  irs.append(commo
-00011fb0: 6e5f 7072 6566 6978 5b27 5072 6566 6978  n_prefix['Prefix
-00011fc0: 275d 5b3a 2d31 5d29 0a20 2020 2020 2020  '][:-1]).       
-00011fd0: 2020 2020 2020 2020 2066 6f72 2063 6f6e           for con
-00011fe0: 7465 6e74 2069 6e20 7265 7370 2e67 6574  tent in resp.get
-00011ff0: 2827 436f 6e74 656e 7473 272c 205b 5d29  ('Contents', [])
-00012000: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012010: 2020 2020 2020 6669 6c65 732e 6170 7065        files.appe
-00012020: 6e64 2863 6f6e 7465 6e74 5b27 4b65 7927  nd(content['Key'
-00012030: 5d29 0a0a 2020 2020 2020 2020 2020 2020  ])..            
-00012040: 6469 7273 203d 2073 6f72 7465 6428 6469  dirs = sorted(di
-00012050: 7273 290a 2020 2020 2020 2020 2020 2020  rs).            
-00012060: 7374 6163 6b2e 6578 7465 6e64 2872 6576  stack.extend(rev
-00012070: 6572 7365 6428 6469 7273 2929 0a0a 2020  ersed(dirs))..  
-00012080: 2020 2020 2020 2020 2020 726f 6f74 203d            root =
-00012090: 2073 335f 7061 7468 5f6a 6f69 6e28 0a20   s3_path_join(. 
-000120a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000120b0: 277b 7365 6c66 2e5f 7072 6f74 6f63 6f6c  '{self._protocol
-000120c0: 5f77 6974 685f 7072 6f66 696c 657d 3a2f  _with_profile}:/
-000120d0: 2f27 2c20 6275 636b 6574 2c20 6375 7272  /', bucket, curr
-000120e0: 656e 7429 5b3a 2d31 5d0a 2020 2020 2020  ent)[:-1].      
-000120f0: 2020 2020 2020 6469 7273 203d 205b 7061        dirs = [pa
-00012100: 7468 5b6c 656e 2863 7572 7265 6e74 293a  th[len(current):
-00012110: 5d20 666f 7220 7061 7468 2069 6e20 6469  ] for path in di
-00012120: 7273 5d0a 2020 2020 2020 2020 2020 2020  rs].            
-00012130: 6669 6c65 7320 3d20 736f 7274 6564 2870  files = sorted(p
-00012140: 6174 685b 6c65 6e28 6375 7272 656e 7429  ath[len(current)
-00012150: 3a5d 2066 6f72 2070 6174 6820 696e 2066  :] for path in f
-00012160: 696c 6573 290a 2020 2020 2020 2020 2020  iles).          
-00012170: 2020 7969 656c 6420 726f 6f74 2c20 6469    yield root, di
-00012180: 7273 2c20 6669 6c65 730a 0a20 2020 2064  rs, files..    d
-00012190: 6566 206d 6435 2873 656c 662c 2072 6563  ef md5(self, rec
-000121a0: 616c 6375 6c61 7465 3a20 626f 6f6c 203d  alculate: bool =
-000121b0: 2046 616c 7365 2c20 666f 6c6c 6f77 6c69   False, followli
-000121c0: 6e6b 733a 2062 6f6f 6c20 3d20 4661 6c73  nks: bool = Fals
-000121d0: 6529 202d 3e20 7374 723a 0a20 2020 2020  e) -> str:.     
-000121e0: 2020 2027 2727 0a20 2020 2020 2020 2047     '''.        G
-000121f0: 6574 206d 6435 206d 6574 6120 696e 666f  et md5 meta info
-00012200: 2069 6e20 6669 6c65 7320 7468 6174 2075   in files that u
-00012210: 706c 6f61 6465 642f 636f 7069 6564 2076  ploaded/copied v
-00012220: 6961 206d 6567 6669 6c65 0a0a 2020 2020  ia megfile..    
-00012230: 2020 2020 4966 206d 6574 6120 696e 666f      If meta info
-00012240: 2069 7320 6c6f 7374 206f 7220 6e6f 6e2d   is lost or non-
-00012250: 6578 6973 7465 6e74 2c20 7265 7475 726e  existent, return
-00012260: 204e 6f6e 650a 0a20 2020 2020 2020 203a   None..        :
-00012270: 7061 7261 6d20 7265 6361 6c63 756c 6174  param recalculat
-00012280: 653a 2063 616c 6375 6c61 7465 206d 6435  e: calculate md5
-00012290: 2069 6e20 7265 616c 2d74 696d 6520 6f72   in real-time or
-000122a0: 2072 6574 7572 6e20 7333 2065 7461 670a   return s3 etag.
-000122b0: 2020 2020 2020 2020 3a70 6172 616d 2066          :param f
-000122c0: 6f6c 6c6f 776c 696e 6b73 3a20 4966 2069  ollowlinks: If i
-000122d0: 7320 5472 7565 2c20 6361 6c63 756c 6174  s True, calculat
-000122e0: 6520 6d64 3520 666f 7220 7265 616c 2066  e md5 for real f
-000122f0: 696c 650a 2020 2020 2020 2020 3a72 6574  ile.        :ret
-00012300: 7572 6e73 3a20 6d64 3520 6d65 7461 2069  urns: md5 meta i
-00012310: 6e66 6f0a 2020 2020 2020 2020 2727 270a  nfo.        '''.
-00012320: 2020 2020 2020 2020 6275 636b 6574 2c20          bucket, 
-00012330: 5f20 3d20 7061 7273 655f 7333 5f75 726c  _ = parse_s3_url
-00012340: 2873 656c 662e 7061 7468 5f77 6974 685f  (self.path_with_
-00012350: 7072 6f74 6f63 6f6c 290a 2020 2020 2020  protocol).      
-00012360: 2020 6966 206e 6f74 2062 7563 6b65 743a    if not bucket:
-00012370: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00012380: 7365 2053 3342 7563 6b65 744e 6f74 466f  se S3BucketNotFo
-00012390: 756e 6445 7272 6f72 280a 2020 2020 2020  undError(.      
-000123a0: 2020 2020 2020 2020 2020 2745 6d70 7479            'Empty
-000123b0: 2062 7563 6b65 7420 6e61 6d65 3a20 2572   bucket name: %r
-000123c0: 2720 2520 7365 6c66 2e70 6174 685f 7769  ' % self.path_wi
-000123d0: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
-000123e0: 2020 2020 2073 7461 7420 3d20 7365 6c66       stat = self
-000123f0: 2e73 7461 7428 666f 6c6c 6f77 5f73 796d  .stat(follow_sym
-00012400: 6c69 6e6b 733d 666f 6c6c 6f77 6c69 6e6b  links=followlink
-00012410: 7329 0a20 2020 2020 2020 2069 6620 7374  s).        if st
-00012420: 6174 2e69 7364 6972 3a0a 2020 2020 2020  at.isdir:.      
-00012430: 2020 2020 2020 6861 7368 5f6d 6435 203d        hash_md5 =
-00012440: 2068 6173 686c 6962 2e6d 6435 2829 2020   hashlib.md5()  
-00012450: 2320 6e6f 7365 630a 2020 2020 2020 2020  # nosec.        
-00012460: 2020 2020 666f 7220 6669 6c65 5f6e 616d      for file_nam
-00012470: 6520 696e 2073 656c 662e 6c69 7374 6469  e in self.listdi
-00012480: 7228 293a 0a20 2020 2020 2020 2020 2020  r():.           
-00012490: 2020 2020 2063 6875 6e6b 203d 2053 3350       chunk = S3P
-000124a0: 6174 6828 0a20 2020 2020 2020 2020 2020  ath(.           
-000124b0: 2020 2020 2020 2020 2073 335f 7061 7468           s3_path
-000124c0: 5f6a 6f69 6e28 0a20 2020 2020 2020 2020  _join(.         
-000124d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000124e0: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
-000124f0: 6f74 6f63 6f6c 2c0a 2020 2020 2020 2020  otocol,.        
-00012500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012510: 6669 6c65 5f6e 616d 6529 292e 6d64 3528  file_name)).md5(
-00012520: 7265 6361 6c63 756c 6174 653d 7265 6361  recalculate=reca
-00012530: 6c63 756c 6174 6529 2e65 6e63 6f64 6528  lculate).encode(
-00012540: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00012550: 2020 6861 7368 5f6d 6435 2e75 7064 6174    hash_md5.updat
-00012560: 6528 6368 756e 6b29 0a20 2020 2020 2020  e(chunk).       
-00012570: 2020 2020 2072 6574 7572 6e20 6861 7368       return hash
-00012580: 5f6d 6435 2e68 6578 6469 6765 7374 2829  _md5.hexdigest()
-00012590: 0a20 2020 2020 2020 2069 6620 7265 6361  .        if reca
-000125a0: 6c63 756c 6174 653a 0a20 2020 2020 2020  lculate:.       
-000125b0: 2020 2020 2070 6174 685f 696e 7374 616e       path_instan
-000125c0: 6365 203d 2073 656c 660a 2020 2020 2020  ce = self.      
-000125d0: 2020 2020 2020 6966 2066 6f6c 6c6f 776c        if followl
-000125e0: 696e 6b73 3a0a 2020 2020 2020 2020 2020  inks:.          
-000125f0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00012600: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00012610: 6174 685f 696e 7374 616e 6365 203d 2073  ath_instance = s
-00012620: 656c 662e 7265 6164 6c69 6e6b 2829 0a20  elf.readlink(). 
-00012630: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00012640: 7863 6570 7420 5333 4e6f 7441 4c69 6e6b  xcept S3NotALink
-00012650: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-00012660: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
-00012670: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00012680: 2070 6174 685f 696e 7374 616e 6365 2e6f   path_instance.o
-00012690: 7065 6e28 2772 6227 2920 6173 2066 3a0a  pen('rb') as f:.
-000126a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000126b0: 7265 7475 726e 2063 616c 6375 6c61 7465  return calculate
-000126c0: 5f6d 6435 2866 290a 2020 2020 2020 2020  _md5(f).        
-000126d0: 7265 7475 726e 2073 7461 742e 6578 7472  return stat.extr
-000126e0: 612e 6765 7428 2745 5461 6727 2c20 2727  a.get('ETag', ''
-000126f0: 295b 313a 2d31 5d0a 0a20 2020 2064 6566  )[1:-1]..    def
-00012700: 2063 6f70 7928 0a20 2020 2020 2020 2020   copy(.         
-00012710: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00012720: 2020 2020 2064 7374 5f75 726c 3a20 5061       dst_url: Pa
-00012730: 7468 4c69 6b65 2c0a 2020 2020 2020 2020  thLike,.        
-00012740: 2020 2020 666f 6c6c 6f77 6c69 6e6b 733a      followlinks:
-00012750: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
-00012760: 2020 2020 2020 2020 2020 2063 616c 6c62             callb
-00012770: 6163 6b3a 204f 7074 696f 6e61 6c5b 4361  ack: Optional[Ca
-00012780: 6c6c 6162 6c65 5b5b 696e 745d 2c20 4e6f  llable[[int], No
-00012790: 6e65 5d5d 203d 204e 6f6e 6529 202d 3e20  ne]] = None) -> 
-000127a0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2727  None:.        ''
-000127b0: 2720 4669 6c65 2063 6f70 7920 6f6e 2053  ' File copy on S
-000127c0: 330a 2020 2020 2020 2020 436f 7079 2063  3.        Copy c
-000127d0: 6f6e 7465 6e74 206f 6620 6669 6c65 206f  ontent of file o
-000127e0: 6e20 6073 7263 5f70 6174 6860 2074 6f20  n `src_path` to 
-000127f0: 6064 7374 5f70 6174 6860 2e0a 2020 2020  `dst_path`..    
-00012800: 2020 2020 4974 2773 2063 616c 6c65 7227      It's caller'
-00012810: 7320 7265 7370 6f6e 7365 6269 6c69 7479  s responsebility
-00012820: 2074 6f20 656e 7375 7265 2074 6865 2073   to ensure the s
-00012830: 335f 6973 6669 6c65 2873 7263 5f75 726c  3_isfile(src_url
-00012840: 2920 3d3d 2054 7275 650a 0a20 2020 2020  ) == True..     
-00012850: 2020 203a 7061 7261 6d20 6473 745f 7061     :param dst_pa
-00012860: 7468 3a20 5461 7267 6574 2066 696c 6520  th: Target file 
-00012870: 7061 7468 0a20 2020 2020 2020 203a 7061  path.        :pa
-00012880: 7261 6d20 6361 6c6c 6261 636b 3a20 4361  ram callback: Ca
-00012890: 6c6c 6564 2070 6572 696f 6469 6361 6c6c  lled periodicall
-000128a0: 7920 6475 7269 6e67 2063 6f70 792c 2061  y during copy, a
-000128b0: 6e64 2074 6865 2069 6e70 7574 2070 6172  nd the input par
-000128c0: 616d 6574 6572 2069 7320 7468 6520 6461  ameter is the da
-000128d0: 7461 2073 697a 6520 2869 6e20 6279 7465  ta size (in byte
-000128e0: 7329 206f 6620 636f 7079 2073 696e 6365  s) of copy since
-000128f0: 2074 6865 206c 6173 7420 6361 6c6c 0a20   the last call. 
-00012900: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-00012910: 2020 2073 7263 5f75 726c 203d 2073 656c     src_url = sel
-00012920: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
-00012930: 6f63 6f6c 0a20 2020 2020 2020 2073 7263  ocol.        src
-00012940: 5f62 7563 6b65 742c 2073 7263 5f6b 6579  _bucket, src_key
-00012950: 203d 2070 6172 7365 5f73 335f 7572 6c28   = parse_s3_url(
-00012960: 7372 635f 7572 6c29 0a20 2020 2020 2020  src_url).       
-00012970: 2064 7374 5f62 7563 6b65 742c 2064 7374   dst_bucket, dst
-00012980: 5f6b 6579 203d 2070 6172 7365 5f73 335f  _key = parse_s3_
-00012990: 7572 6c28 6473 745f 7572 6c29 0a0a 2020  url(dst_url)..  
-000129a0: 2020 2020 2020 6966 206e 6f74 2073 7263        if not src
-000129b0: 5f62 7563 6b65 743a 0a20 2020 2020 2020  _bucket:.       
-000129c0: 2020 2020 2072 6169 7365 2053 3342 7563       raise S3Buc
-000129d0: 6b65 744e 6f74 466f 756e 6445 7272 6f72  ketNotFoundError
-000129e0: 2827 456d 7074 7920 6275 636b 6574 206e  ('Empty bucket n
-000129f0: 616d 653a 2025 7227 2025 2073 7263 5f75  ame: %r' % src_u
-00012a00: 726c 290a 2020 2020 2020 2020 6966 2073  rl).        if s
-00012a10: 656c 662e 6973 5f64 6972 2829 3a0a 2020  elf.is_dir():.  
-00012a20: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00012a30: 5333 4973 4144 6972 6563 746f 7279 4572  S3IsADirectoryEr
-00012a40: 726f 7228 2749 7320 6120 6469 7265 6374  ror('Is a direct
-00012a50: 6f72 793a 2025 7227 2025 2073 7263 5f75  ory: %r' % src_u
-00012a60: 726c 290a 0a20 2020 2020 2020 2069 6620  rl)..        if 
-00012a70: 6e6f 7420 6473 745f 6275 636b 6574 3a0a  not dst_bucket:.
-00012a80: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00012a90: 6520 5333 4275 636b 6574 4e6f 7446 6f75  e S3BucketNotFou
-00012aa0: 6e64 4572 726f 7228 2745 6d70 7479 2062  ndError('Empty b
-00012ab0: 7563 6b65 7420 6e61 6d65 3a20 2572 2720  ucket name: %r' 
-00012ac0: 2520 6473 745f 7572 6c29 0a20 2020 2020  % dst_url).     
-00012ad0: 2020 2069 6620 6e6f 7420 6473 745f 6b65     if not dst_ke
-00012ae0: 7920 6f72 2064 7374 5f6b 6579 2e65 6e64  y or dst_key.end
-00012af0: 7377 6974 6828 272f 2729 3a0a 2020 2020  swith('/'):.    
-00012b00: 2020 2020 2020 2020 7261 6973 6520 5333          raise S3
-00012b10: 4973 4144 6972 6563 746f 7279 4572 726f  IsADirectoryErro
-00012b20: 7228 2749 7320 6120 6469 7265 6374 6f72  r('Is a director
-00012b30: 793a 2025 7227 2025 2064 7374 5f75 726c  y: %r' % dst_url
-00012b40: 290a 0a20 2020 2020 2020 2069 6620 666f  )..        if fo
-00012b50: 6c6c 6f77 6c69 6e6b 733a 0a20 2020 2020  llowlinks:.     
-00012b60: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00012b70: 2020 2020 2020 2020 2020 2020 7333 5f75              s3_u
-00012b80: 726c 203d 2073 656c 662e 7265 6164 6c69  rl = self.readli
-00012b90: 6e6b 2829 2e70 6174 680a 2020 2020 2020  nk().path.      
-00012ba0: 2020 2020 2020 2020 2020 7372 635f 6275            src_bu
-00012bb0: 636b 6574 2c20 7372 635f 6b65 7920 3d20  cket, src_key = 
-00012bc0: 7061 7273 655f 7333 5f75 726c 2873 335f  parse_s3_url(s3_
-00012bd0: 7572 6c29 0a20 2020 2020 2020 2020 2020  url).           
-00012be0: 2065 7863 6570 7420 5333 4e6f 7441 4c69   except S3NotALi
-00012bf0: 6e6b 4572 726f 723a 0a20 2020 2020 2020  nkError:.       
-00012c00: 2020 2020 2020 2020 2070 6173 730a 0a20           pass.. 
-00012c10: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00012c20: 2020 2020 2020 2020 7365 6c66 2e5f 636c          self._cl
-00012c30: 6965 6e74 2e63 6f70 7928 0a20 2020 2020  ient.copy(.     
-00012c40: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+000106a0: 2020 2020 2020 2020 6966 2066 6f6c 6c6f          if follo
+000106b0: 776c 696e 6b73 2061 6e64 2053 3350 6174  wlinks and S3Pat
+000106c0: 6828 7372 635f 7572 6c29 2e69 735f 7379  h(src_url).is_sy
+000106d0: 6d6c 696e 6b28 293a 0a20 2020 2020 2020  mlink():.       
+000106e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000106f0: 2020 2020 2063 6f6e 7465 6e74 5b27 6973       content['is
+00010700: 6c6e 6b27 5d20 3d20 5472 7565 0a0a 2020  lnk'] = True..  
+00010710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010720: 2020 2020 2020 7969 656c 6420 4669 6c65        yield File
+00010730: 456e 7472 7928 0a20 2020 2020 2020 2020  Entry(.         
+00010740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010750: 2020 2063 6f6e 7465 6e74 5b27 4b65 7927     content['Key'
+00010760: 5d5b 6c65 6e28 7072 6566 6978 293a 5d2c  ][len(prefix):],
+00010770: 2073 7263 5f75 726c 2c0a 2020 2020 2020   src_url,.      
+00010780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010790: 2020 2020 2020 5f6d 616b 655f 7374 6174        _make_stat
+000107a0: 2863 6f6e 7465 6e74 2929 0a0a 2020 2020  (content))..    
+000107b0: 2020 2020 7265 7475 726e 2043 6f6e 7465      return Conte
+000107c0: 7874 4974 6572 6174 6f72 2863 7265 6174  xtIterator(creat
+000107d0: 655f 6765 6e65 7261 746f 7228 2929 0a0a  e_generator())..
+000107e0: 2020 2020 6465 6620 5f67 6574 6469 7273      def _getdirs
+000107f0: 7461 7428 7365 6c66 2920 2d3e 2053 7461  tat(self) -> Sta
+00010800: 7452 6573 756c 743a 0a20 2020 2020 2020  tResult:.       
+00010810: 2027 2727 0a20 2020 2020 2020 2052 6574   '''.        Ret
+00010820: 7572 6e20 5374 6174 5265 7375 6c74 206f  urn StatResult o
+00010830: 6620 6769 7665 6e20 7333 5f75 726c 2064  f given s3_url d
+00010840: 6972 6563 746f 7279 2c20 696e 636c 7564  irectory, includ
+00010850: 696e 673a 200a 0a20 2020 2020 2020 2031  ing: ..        1
+00010860: 2e20 4469 7265 6374 6f72 7920 7369 7a65  . Directory size
+00010870: 3a20 7468 6520 7375 6d20 6f66 2061 6c6c  : the sum of all
+00010880: 2066 696c 6520 7369 7a65 2069 6e20 6974   file size in it
+00010890: 2c20 696e 636c 7564 696e 6720 6669 6c65  , including file
+000108a0: 2069 6e20 7375 6264 6972 6563 746f 7269   in subdirectori
+000108b0: 6573 2028 6966 2065 7869 7374 292e 0a20  es (if exist).. 
+000108c0: 2020 2020 2020 2054 6865 2072 6573 756c         The resul
+000108d0: 7420 6578 636c 7564 6573 2074 6865 2073  t excludes the s
+000108e0: 697a 6520 6f66 2064 6972 6563 746f 7279  ize of directory
+000108f0: 2069 7473 656c 662e 2049 6e20 6f74 6865   itself. In othe
+00010900: 7220 776f 7264 732c 2072 6574 7572 6e20  r words, return 
+00010910: 3020 4279 7465 206f 6e20 616e 2065 6d70  0 Byte on an emp
+00010920: 7479 2064 6972 6563 746f 7279 2070 6174  ty directory pat
+00010930: 680a 2020 2020 2020 2020 322e 204c 6173  h.        2. Las
+00010940: 742d 6d6f 6469 6669 6564 2074 696d 6520  t-modified time 
+00010950: 6f66 2064 6972 6563 746f 7279 3a20 7265  of directory: re
+00010960: 7475 726e 2074 6865 206c 6174 6573 7420  turn the latest 
+00010970: 6d6f 6469 6669 6564 2074 696d 6520 6f66  modified time of
+00010980: 2061 6c6c 2066 696c 6520 696e 2069 742e   all file in it.
+00010990: 2054 6865 206d 7469 6d65 206f 6620 656d   The mtime of em
+000109a0: 7074 7920 6469 7265 6374 6f72 7920 6973  pty directory is
+000109b0: 2031 3937 302d 3031 2d30 3120 3030 3a30   1970-01-01 00:0
+000109c0: 303a 3030 0a0a 2020 2020 2020 2020 3a72  0:00..        :r
+000109d0: 6574 7572 6e73 3a20 416e 2069 6e74 2069  eturns: An int i
+000109e0: 6e64 6963 6174 6573 2073 697a 6520 696e  ndicates size in
+000109f0: 2042 7974 6573 0a20 2020 2020 2020 2027   Bytes.        '
+00010a00: 2727 0a20 2020 2020 2020 2069 6620 6e6f  ''.        if no
+00010a10: 7420 7365 6c66 2e69 735f 6469 7228 293a  t self.is_dir():
+00010a20: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00010a30: 7365 2053 3346 696c 654e 6f74 466f 756e  se S3FileNotFoun
+00010a40: 6445 7272 6f72 280a 2020 2020 2020 2020  dError(.        
+00010a50: 2020 2020 2020 2020 274e 6f20 7375 6368          'No such
+00010a60: 2066 696c 6520 6f72 2064 6972 6563 746f   file or directo
+00010a70: 7279 3a20 2572 2720 2520 7365 6c66 2e70  ry: %r' % self.p
+00010a80: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+00010a90: 6c29 0a0a 2020 2020 2020 2020 6275 636b  l)..        buck
+00010aa0: 6574 2c20 6b65 7920 3d20 7061 7273 655f  et, key = parse_
+00010ab0: 7333 5f75 726c 2873 656c 662e 7061 7468  s3_url(self.path
+00010ac0: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
+00010ad0: 2020 2020 2020 2020 7072 6566 6978 203d          prefix =
+00010ae0: 205f 6265 636f 6d65 5f70 7265 6669 7828   _become_prefix(
+00010af0: 6b65 7929 0a20 2020 2020 2020 2063 6c69  key).        cli
+00010b00: 656e 7420 3d20 7365 6c66 2e5f 636c 6965  ent = self._clie
+00010b10: 6e74 0a20 2020 2020 2020 2073 697a 6520  nt.        size 
+00010b20: 3d20 300a 2020 2020 2020 2020 6d74 696d  = 0.        mtim
+00010b30: 6520 3d20 302e 300a 2020 2020 2020 2020  e = 0.0.        
+00010b40: 7769 7468 2072 6169 7365 5f73 335f 6572  with raise_s3_er
+00010b50: 726f 7228 7365 6c66 2e70 6174 685f 7769  ror(self.path_wi
+00010b60: 7468 5f70 726f 746f 636f 6c29 3a0a 2020  th_protocol):.  
+00010b70: 2020 2020 2020 2020 2020 666f 7220 7265            for re
+00010b80: 7370 2069 6e20 5f6c 6973 745f 6f62 6a65  sp in _list_obje
+00010b90: 6374 735f 7265 6375 7273 6976 6528 636c  cts_recursive(cl
+00010ba0: 6965 6e74 2c20 6275 636b 6574 2c20 7072  ient, bucket, pr
+00010bb0: 6566 6978 293a 0a20 2020 2020 2020 2020  efix):.         
+00010bc0: 2020 2020 2020 2066 6f72 2063 6f6e 7465         for conte
+00010bd0: 6e74 2069 6e20 7265 7370 2e67 6574 2827  nt in resp.get('
+00010be0: 436f 6e74 656e 7473 272c 205b 5d29 3a0a  Contents', []):.
+00010bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c00: 2020 2020 7369 7a65 202b 3d20 636f 6e74      size += cont
+00010c10: 656e 745b 2753 697a 6527 5d0a 2020 2020  ent['Size'].    
+00010c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c30: 6c61 7374 5f6d 6f64 6966 6965 6420 3d20  last_modified = 
+00010c40: 636f 6e74 656e 745b 274c 6173 744d 6f64  content['LastMod
+00010c50: 6966 6965 6427 5d2e 7469 6d65 7374 616d  ified'].timestam
+00010c60: 7028 290a 2020 2020 2020 2020 2020 2020  p().            
+00010c70: 2020 2020 2020 2020 6966 206d 7469 6d65          if mtime
+00010c80: 203c 206c 6173 745f 6d6f 6469 6669 6564   < last_modified
+00010c90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00010ca0: 2020 2020 2020 2020 2020 6d74 696d 6520            mtime 
+00010cb0: 3d20 6c61 7374 5f6d 6f64 6966 6965 640a  = last_modified.
+00010cc0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00010cd0: 5374 6174 5265 7375 6c74 2873 697a 653d  StatResult(size=
+00010ce0: 7369 7a65 2c20 6d74 696d 653d 6d74 696d  size, mtime=mtim
+00010cf0: 652c 2069 7364 6972 3d54 7275 6529 0a0a  e, isdir=True)..
+00010d00: 2020 2020 6465 6620 7374 6174 2873 656c      def stat(sel
+00010d10: 662c 2066 6f6c 6c6f 775f 7379 6d6c 696e  f, follow_symlin
+00010d20: 6b73 3d54 7275 6529 202d 3e20 5374 6174  ks=True) -> Stat
+00010d30: 5265 7375 6c74 3a0a 2020 2020 2020 2020  Result:.        
+00010d40: 2727 270a 2020 2020 2020 2020 4765 7420  '''.        Get 
+00010d50: 5374 6174 5265 7375 6c74 206f 6620 7333  StatResult of s3
+00010d60: 5f75 726c 2066 696c 652c 2069 6e63 6c75  _url file, inclu
+00010d70: 6469 6e67 2066 696c 6520 7369 7a65 2061  ding file size a
+00010d80: 6e64 206d 7469 6d65 2c20 7265 6665 7272  nd mtime, referr
+00010d90: 696e 6720 746f 2073 335f 6765 7473 697a  ing to s3_getsiz
+00010da0: 6520 616e 6420 7333 5f67 6574 6d74 696d  e and s3_getmtim
+00010db0: 650a 0a20 2020 2020 2020 2049 6620 7333  e..        If s3
+00010dc0: 5f75 726c 2069 7320 6e6f 7420 616e 2065  _url is not an e
+00010dd0: 7869 7374 656e 7420 7061 7468 2c20 7768  xistent path, wh
+00010de0: 6963 6820 6d65 616e 7320 7333 5f65 7869  ich means s3_exi
+00010df0: 7374 2873 335f 7572 6c29 2072 6574 7572  st(s3_url) retur
+00010e00: 6e73 2046 616c 7365 2c20 7468 656e 2072  ns False, then r
+00010e10: 6169 7365 2053 3346 696c 654e 6f74 466f  aise S3FileNotFo
+00010e20: 756e 6445 7272 6f72 0a20 2020 2020 2020  undError.       
+00010e30: 2049 6620 6174 7465 6d70 7420 746f 2067   If attempt to g
+00010e40: 6574 2053 7461 7452 6573 756c 7420 6f66  et StatResult of
+00010e50: 2063 6f6d 706c 6574 6520 7333 2c20 7375   complete s3, su
+00010e60: 6368 2061 7320 7333 5f64 6972 5f75 726c  ch as s3_dir_url
+00010e70: 203d 3d20 2773 333a 2f2f 272c 2072 6169   == 's3://', rai
+00010e80: 7365 2053 3342 7563 6b65 744e 6f74 466f  se S3BucketNotFo
+00010e90: 756e 6445 7272 6f72 0a0a 2020 2020 2020  undError..      
+00010ea0: 2020 3a72 6574 7572 6e73 3a20 5374 6174    :returns: Stat
+00010eb0: 5265 7375 6c74 0a20 2020 2020 2020 203a  Result.        :
+00010ec0: 7261 6973 6573 3a20 5333 4669 6c65 4e6f  raises: S3FileNo
+00010ed0: 7446 6f75 6e64 4572 726f 722c 2053 3342  tFoundError, S3B
+00010ee0: 7563 6b65 744e 6f74 466f 756e 6445 7272  ucketNotFoundErr
+00010ef0: 6f72 0a20 2020 2020 2020 2027 2727 0a20  or.        '''. 
+00010f00: 2020 2020 2020 2069 736c 6e6b 203d 2046         islnk = F
+00010f10: 616c 7365 0a20 2020 2020 2020 2062 7563  alse.        buc
+00010f20: 6b65 742c 206b 6579 203d 2070 6172 7365  ket, key = parse
+00010f30: 5f73 335f 7572 6c28 7365 6c66 2e70 6174  _s3_url(self.pat
+00010f40: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
+00010f50: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00010f60: 6275 636b 6574 3a0a 2020 2020 2020 2020  bucket:.        
+00010f70: 2020 2020 7261 6973 6520 5333 4275 636b      raise S3Buck
+00010f80: 6574 4e6f 7446 6f75 6e64 4572 726f 7228  etNotFoundError(
+00010f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010fa0: 2027 456d 7074 7920 6275 636b 6574 206e   'Empty bucket n
+00010fb0: 616d 653a 2025 7227 2025 2073 656c 662e  ame: %r' % self.
+00010fc0: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
+00010fd0: 6f6c 290a 0a20 2020 2020 2020 2069 6620  ol)..        if 
+00010fe0: 6e6f 7420 7365 6c66 2e69 735f 6669 6c65  not self.is_file
+00010ff0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00011000: 7265 7475 726e 2073 656c 662e 5f67 6574  return self._get
+00011010: 6469 7273 7461 7428 290a 0a20 2020 2020  dirstat()..     
+00011020: 2020 2063 6c69 656e 7420 3d20 7365 6c66     client = self
+00011030: 2e5f 636c 6965 6e74 0a20 2020 2020 2020  ._client.       
+00011040: 2077 6974 6820 7261 6973 655f 7333 5f65   with raise_s3_e
+00011050: 7272 6f72 2873 656c 662e 7061 7468 5f77  rror(self.path_w
+00011060: 6974 685f 7072 6f74 6f63 6f6c 293a 0a20  ith_protocol):. 
+00011070: 2020 2020 2020 2020 2020 2063 6f6e 7465             conte
+00011080: 6e74 203d 2063 6c69 656e 742e 6865 6164  nt = client.head
+00011090: 5f6f 626a 6563 7428 4275 636b 6574 3d62  _object(Bucket=b
+000110a0: 7563 6b65 742c 204b 6579 3d6b 6579 290a  ucket, Key=key).
+000110b0: 2020 2020 2020 2020 2020 2020 6966 2027              if '
+000110c0: 4d65 7461 6461 7461 2720 696e 2063 6f6e  Metadata' in con
+000110d0: 7465 6e74 3a0a 2020 2020 2020 2020 2020  tent:.          
+000110e0: 2020 2020 2020 6d65 7461 6461 7461 203d        metadata =
+000110f0: 2064 6963 7428 0a20 2020 2020 2020 2020   dict(.         
+00011100: 2020 2020 2020 2020 2020 2028 6b65 792e             (key.
+00011110: 6c6f 7765 7228 292c 2076 616c 7565 290a  lower(), value).
+00011120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011130: 2020 2020 666f 7220 6b65 792c 2076 616c      for key, val
+00011140: 7565 2069 6e20 636f 6e74 656e 745b 274d  ue in content['M
+00011150: 6574 6164 6174 6127 5d2e 6974 656d 7328  etadata'].items(
+00011160: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00011170: 2020 2069 6620 6d65 7461 6461 7461 2061     if metadata a
+00011180: 6e64 2027 7379 6d6c 696e 6b5f 746f 2720  nd 'symlink_to' 
+00011190: 696e 206d 6574 6164 6174 613a 0a20 2020  in metadata:.   
+000111a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000111b0: 2069 736c 6e6b 203d 2054 7275 650a 2020   islnk = True.  
+000111c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000111d0: 2020 6966 2069 736c 6e6b 2061 6e64 2066    if islnk and f
+000111e0: 6f6c 6c6f 775f 7379 6d6c 696e 6b73 3a0a  ollow_symlinks:.
+000111f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011200: 2020 2020 2020 2020 7333 5f75 726c 203d          s3_url =
+00011210: 206d 6574 6164 6174 615b 2773 796d 6c69   metadata['symli
+00011220: 6e6b 5f74 6f27 5d0a 2020 2020 2020 2020  nk_to'].        
+00011230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011240: 6275 636b 6574 2c20 6b65 7920 3d20 7061  bucket, key = pa
+00011250: 7273 655f 7333 5f75 726c 2873 335f 7572  rse_s3_url(s3_ur
+00011260: 6c29 0a20 2020 2020 2020 2020 2020 2020  l).             
+00011270: 2020 2020 2020 2020 2020 2063 6f6e 7465             conte
+00011280: 6e74 203d 2063 6c69 656e 742e 6865 6164  nt = client.head
+00011290: 5f6f 626a 6563 7428 4275 636b 6574 3d62  _object(Bucket=b
+000112a0: 7563 6b65 742c 204b 6579 3d6b 6579 290a  ucket, Key=key).
+000112b0: 2020 2020 2020 2020 2020 2020 7374 6174              stat
+000112c0: 5f72 6563 6f72 6420 3d20 5374 6174 5265  _record = StatRe
+000112d0: 7375 6c74 280a 2020 2020 2020 2020 2020  sult(.          
+000112e0: 2020 2020 2020 6973 6c6e 6b3d 6973 6c6e        islnk=isln
+000112f0: 6b2c 0a20 2020 2020 2020 2020 2020 2020  k,.             
+00011300: 2020 2073 697a 653d 636f 6e74 656e 745b     size=content[
+00011310: 2743 6f6e 7465 6e74 4c65 6e67 7468 275d  'ContentLength']
+00011320: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00011330: 2020 6d74 696d 653d 636f 6e74 656e 745b    mtime=content[
+00011340: 274c 6173 744d 6f64 6966 6965 6427 5d2e  'LastModified'].
+00011350: 7469 6d65 7374 616d 7028 292c 0a20 2020  timestamp(),.   
+00011360: 2020 2020 2020 2020 2020 2020 2065 7874               ext
+00011370: 7261 3d63 6f6e 7465 6e74 290a 2020 2020  ra=content).    
+00011380: 2020 2020 7265 7475 726e 2073 7461 745f      return stat_
+00011390: 7265 636f 7264 0a0a 2020 2020 6465 6620  record..    def 
+000113a0: 6c73 7461 7428 7365 6c66 2920 2d3e 2053  lstat(self) -> S
+000113b0: 7461 7452 6573 756c 743a 0a20 2020 2020  tatResult:.     
+000113c0: 2020 2027 2727 4c69 6b65 2050 6174 682e     '''Like Path.
+000113d0: 7374 6174 2829 2062 7574 2c20 6966 2074  stat() but, if t
+000113e0: 6865 2070 6174 6820 706f 696e 7473 2074  he path points t
+000113f0: 6f20 6120 7379 6d62 6f6c 6963 206c 696e  o a symbolic lin
+00011400: 6b2c 2072 6574 7572 6e20 7468 6520 7379  k, return the sy
+00011410: 6d62 6f6c 6963 206c 696e 6be2 8099 7320  mbolic link...s 
+00011420: 696e 666f 726d 6174 696f 6e20 7261 7468  information rath
+00011430: 6572 2074 6861 6e20 6974 7320 7461 7267  er than its targ
+00011440: 6574 e280 9973 2e27 2727 0a20 2020 2020  et...s.'''.     
+00011450: 2020 2072 6574 7572 6e20 7365 6c66 2e73     return self.s
+00011460: 7461 7428 666f 6c6c 6f77 5f73 796d 6c69  tat(follow_symli
+00011470: 6e6b 733d 4661 6c73 6529 0a0a 2020 2020  nks=False)..    
+00011480: 6465 6620 756e 6c69 6e6b 2873 656c 662c  def unlink(self,
+00011490: 206d 6973 7369 6e67 5f6f 6b3a 2062 6f6f   missing_ok: boo
+000114a0: 6c20 3d20 4661 6c73 6529 202d 3e20 4e6f  l = False) -> No
+000114b0: 6e65 3a0a 2020 2020 2020 2020 2727 270a  ne:.        '''.
+000114c0: 2020 2020 2020 2020 5265 6d6f 7665 2074          Remove t
+000114d0: 6865 2066 696c 6520 6f6e 2073 330a 0a20  he file on s3.. 
+000114e0: 2020 2020 2020 203a 7061 7261 6d20 6d69         :param mi
+000114f0: 7373 696e 675f 6f6b 3a20 6966 2046 616c  ssing_ok: if Fal
+00011500: 7365 2061 6e64 2074 6172 6765 7420 6669  se and target fi
+00011510: 6c65 206e 6f74 2065 7869 7374 732c 2072  le not exists, r
+00011520: 6169 7365 2053 3346 696c 654e 6f74 466f  aise S3FileNotFo
+00011530: 756e 6445 7272 6f72 0a20 2020 2020 2020  undError.       
+00011540: 203a 7261 6973 6573 3a20 5333 5065 726d   :raises: S3Perm
+00011550: 6973 7369 6f6e 4572 726f 722c 2053 3346  issionError, S3F
+00011560: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
+00011570: 2c20 5333 4973 4144 6972 6563 746f 7279  , S3IsADirectory
+00011580: 4572 726f 720a 2020 2020 2020 2020 2727  Error.        ''
+00011590: 270a 2020 2020 2020 2020 6275 636b 6574  '.        bucket
+000115a0: 2c20 6b65 7920 3d20 7061 7273 655f 7333  , key = parse_s3
+000115b0: 5f75 726c 2873 656c 662e 7061 7468 5f77  _url(self.path_w
+000115c0: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
+000115d0: 2020 2020 2020 6966 206e 6f74 2062 7563        if not buc
+000115e0: 6b65 7420 6f72 206e 6f74 206b 6579 206f  ket or not key o
+000115f0: 7220 6b65 792e 656e 6473 7769 7468 2827  r key.endswith('
+00011600: 2f27 293a 0a20 2020 2020 2020 2020 2020  /'):.           
+00011610: 2072 6169 7365 2053 3349 7341 4469 7265   raise S3IsADire
+00011620: 6374 6f72 7945 7272 6f72 280a 2020 2020  ctoryError(.    
+00011630: 2020 2020 2020 2020 2020 2020 2749 7320              'Is 
+00011640: 6120 6469 7265 6374 6f72 793a 2025 7227  a directory: %r'
+00011650: 2025 2073 656c 662e 7061 7468 5f77 6974   % self.path_wit
+00011660: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
+00011670: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+00011680: 6973 5f66 696c 6528 293a 0a20 2020 2020  is_file():.     
+00011690: 2020 2020 2020 2069 6620 6d69 7373 696e         if missin
+000116a0: 675f 6f6b 3a0a 2020 2020 2020 2020 2020  g_ok:.          
+000116b0: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+000116c0: 2020 2020 2020 2020 2072 6169 7365 2053           raise S
+000116d0: 3346 696c 654e 6f74 466f 756e 6445 7272  3FileNotFoundErr
+000116e0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+000116f0: 2020 2020 274e 6f20 7375 6368 2066 696c      'No such fil
+00011700: 653a 2025 7227 2025 2073 656c 662e 7061  e: %r' % self.pa
+00011710: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
+00011720: 290a 0a20 2020 2020 2020 2077 6974 6820  )..        with 
+00011730: 7261 6973 655f 7333 5f65 7272 6f72 2873  raise_s3_error(s
+00011740: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
+00011750: 6f74 6f63 6f6c 293a 0a20 2020 2020 2020  otocol):.       
+00011760: 2020 2020 2073 656c 662e 5f63 6c69 656e       self._clien
+00011770: 742e 6465 6c65 7465 5f6f 626a 6563 7428  t.delete_object(
+00011780: 4275 636b 6574 3d62 7563 6b65 742c 204b  Bucket=bucket, K
+00011790: 6579 3d6b 6579 290a 0a20 2020 2064 6566  ey=key)..    def
+000117a0: 2077 616c 6b28 7365 6c66 2c20 666f 6c6c   walk(self, foll
+000117b0: 6f77 6c69 6e6b 733a 2062 6f6f 6c20 3d20  owlinks: bool = 
+000117c0: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
+000117d0: 2020 2920 2d3e 2049 7465 7261 746f 725b    ) -> Iterator[
+000117e0: 5475 706c 655b 7374 722c 204c 6973 745b  Tuple[str, List[
+000117f0: 7374 725d 2c20 4c69 7374 5b73 7472 5d5d  str], List[str]]
+00011800: 5d3a 0a20 2020 2020 2020 2027 2727 0a20  ]:.        '''. 
+00011810: 2020 2020 2020 2049 7465 7261 7469 7665         Iterative
+00011820: 6c79 2074 7261 7665 7273 6520 7468 6520  ly traverse the 
+00011830: 6769 7665 6e20 7333 2064 6972 6563 746f  given s3 directo
+00011840: 7279 2c20 696e 2074 6f70 2d62 6f74 746f  ry, in top-botto
+00011850: 6d20 6f72 6465 722e 2049 6e20 6f74 6865  m order. In othe
+00011860: 7220 776f 7264 732c 2066 6972 7374 6c79  r words, firstly
+00011870: 2074 7261 7665 7273 6520 7061 7265 6e74   traverse parent
+00011880: 2064 6972 6563 746f 7279 2c20 6966 2073   directory, if s
+00011890: 7562 6469 7265 6374 6f72 6965 7320 6578  ubdirectories ex
+000118a0: 6973 742c 2074 7261 7665 7273 6520 7468  ist, traverse th
+000118b0: 6520 7375 6264 6972 6563 746f 7269 6573  e subdirectories
+000118c0: 2069 6e20 616c 7068 6162 6574 6963 616c   in alphabetical
+000118d0: 206f 7264 6572 2e0a 2020 2020 2020 2020   order..        
+000118e0: 4576 6572 7920 6974 6572 6174 696f 6e20  Every iteration 
+000118f0: 6f6e 2067 656e 6572 6174 6f72 2079 6965  on generator yie
+00011900: 6c64 7320 6120 332d 7475 706c 653a 2028  lds a 3-tuple: (
+00011910: 726f 6f74 2c20 6469 7273 2c20 6669 6c65  root, dirs, file
+00011920: 7329 0a0a 2020 2020 2020 2020 2d20 726f  s)..        - ro
+00011930: 6f74 3a20 4375 7272 656e 7420 7333 2070  ot: Current s3 p
+00011940: 6174 683b 0a20 2020 2020 2020 202d 2064  ath;.        - d
+00011950: 6972 733a 204e 616d 6520 6c69 7374 206f  irs: Name list o
+00011960: 6620 7375 6264 6972 6563 746f 7269 6573  f subdirectories
+00011970: 2069 6e20 6375 7272 656e 7420 6469 7265   in current dire
+00011980: 6374 6f72 792e 2054 6865 206c 6973 7420  ctory. The list 
+00011990: 6973 2073 6f72 7465 6420 6279 206e 616d  is sorted by nam
+000119a0: 6520 696e 2061 7363 656e 6469 6e67 2061  e in ascending a
+000119b0: 6c70 6861 6265 7469 6361 6c20 6f72 6465  lphabetical orde
+000119c0: 723b 0a20 2020 2020 2020 202d 2066 696c  r;.        - fil
+000119d0: 6573 3a20 4e61 6d65 206c 6973 7420 6f66  es: Name list of
+000119e0: 2066 696c 6573 2069 6e20 6375 7272 656e   files in curren
+000119f0: 7420 6469 7265 6374 6f72 792e 2054 6865  t directory. The
+00011a00: 206c 6973 7420 6973 2073 6f72 7465 6420   list is sorted 
+00011a10: 6279 206e 616d 6520 696e 2061 7363 656e  by name in ascen
+00011a20: 6469 6e67 2061 6c70 6861 6265 7469 6361  ding alphabetica
+00011a30: 6c20 6f72 6465 723b 0a0a 2020 2020 2020  l order;..      
+00011a40: 2020 4966 2073 335f 7572 6c20 6973 2061    If s3_url is a
+00011a50: 2066 696c 6520 7061 7468 2c20 7265 7475   file path, retu
+00011a60: 726e 2061 6e20 656d 7074 7920 6765 6e65  rn an empty gene
+00011a70: 7261 746f 720a 2020 2020 2020 2020 4966  rator.        If
+00011a80: 2073 335f 7572 6c20 6973 2061 206e 6f6e   s3_url is a non
+00011a90: 2d65 7869 7374 656e 7420 7061 7468 2c20  -existent path, 
+00011aa0: 7265 7475 726e 2061 6e20 656d 7074 7920  return an empty 
+00011ab0: 6765 6e65 7261 746f 720a 2020 2020 2020  generator.      
+00011ac0: 2020 4966 2073 335f 7572 6c20 6973 2061    If s3_url is a
+00011ad0: 2062 7563 6b65 7420 7061 7468 2c20 6275   bucket path, bu
+00011ae0: 636b 6574 2077 696c 6c20 6265 2074 6865  cket will be the
+00011af0: 2074 6f70 2064 6972 6563 746f 7279 2c20   top directory, 
+00011b00: 616e 6420 7769 6c6c 2062 6520 7265 7475  and will be retu
+00011b10: 726e 6564 2061 7420 6669 7273 7420 6974  rned at first it
+00011b20: 6572 6174 696f 6e20 6f66 2067 656e 6572  eration of gener
+00011b30: 6174 6f72 0a20 2020 2020 2020 2049 6620  ator.        If 
+00011b40: 7333 5f75 726c 2069 7320 616e 2065 6d70  s3_url is an emp
+00011b50: 7479 2062 7563 6b65 742c 206f 6e6c 7920  ty bucket, only 
+00011b60: 7969 656c 6420 6f6e 6520 332d 7475 706c  yield one 3-tupl
+00011b70: 6520 286e 6f74 6573 3a20 7333 2064 6f65  e (notes: s3 doe
+00011b80: 736e 2774 2068 6176 6520 656d 7074 7920  sn't have empty 
+00011b90: 6469 7265 6374 6f72 7929 0a20 2020 2020  directory).     
+00011ba0: 2020 2049 6620 7333 5f75 726c 2064 6f65     If s3_url doe
+00011bb0: 736e 2774 2063 6f6e 7461 696e 2061 6e79  sn't contain any
+00011bc0: 2062 7563 6b65 742c 2077 6869 6368 2069   bucket, which i
+00011bd0: 7320 7333 5f75 726c 203d 3d20 2773 333a  s s3_url == 's3:
+00011be0: 2f2f 272c 2072 6169 7365 2055 6e73 7570  //', raise Unsup
+00011bf0: 706f 7274 6564 4572 726f 722e 2077 616c  portedError. wal
+00011c00: 6b28 2920 6f6e 2063 6f6d 706c 6574 6520  k() on complete 
+00011c10: 7333 2069 7320 6e6f 7420 7375 7070 6f72  s3 is not suppor
+00011c20: 7465 6420 696e 206d 6567 6669 6c65 0a0a  ted in megfile..
+00011c30: 2020 2020 2020 2020 3a70 6172 616d 2066          :param f
+00011c40: 6f6c 6c6f 776c 696e 6b73 3a20 7768 6574  ollowlinks: whet
+00011c50: 6865 7220 666f 6c6c 6f77 6c69 6e6b 7320  her followlinks 
+00011c60: 6973 2054 7275 6520 6f72 2046 616c 7365  is True or False
+00011c70: 2c20 7265 7375 6c74 2069 7320 7468 6520  , result is the 
+00011c80: 7361 6d65 2e20 4265 6361 7573 6520 7333  same. Because s3
+00011c90: 2073 796d 6c69 6e6b 206e 6f74 2073 7570   symlink not sup
+00011ca0: 706f 7274 2064 6972 2e0a 2020 2020 2020  port dir..      
+00011cb0: 2020 3a72 6169 7365 733a 2055 6e73 7570    :raises: Unsup
+00011cc0: 706f 7274 6564 4572 726f 720a 2020 2020  portedError.    
+00011cd0: 2020 2020 3a72 6574 7572 6e73 3a20 4120      :returns: A 
+00011ce0: 332d 7475 706c 6520 6765 6e65 7261 746f  3-tuple generato
+00011cf0: 720a 2020 2020 2020 2020 2727 270a 2020  r.        '''.  
+00011d00: 2020 2020 2020 6275 636b 6574 2c20 6b65        bucket, ke
+00011d10: 7920 3d20 7061 7273 655f 7333 5f75 726c  y = parse_s3_url
+00011d20: 2873 656c 662e 7061 7468 5f77 6974 685f  (self.path_with_
+00011d30: 7072 6f74 6f63 6f6c 290a 2020 2020 2020  protocol).      
+00011d40: 2020 6966 206e 6f74 2062 7563 6b65 743a    if not bucket:
+00011d50: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00011d60: 7365 2055 6e73 7570 706f 7274 6564 4572  se UnsupportedEr
+00011d70: 726f 7228 2757 616c 6b20 7768 6f6c 6520  ror('Walk whole 
+00011d80: 7333 272c 2073 656c 662e 7061 7468 5f77  s3', self.path_w
+00011d90: 6974 685f 7072 6f74 6f63 6f6c 290a 0a20  ith_protocol).. 
+00011da0: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
+00011db0: 6c66 2e69 735f 6469 7228 293a 0a20 2020  lf.is_dir():.   
+00011dc0: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+00011dd0: 0a20 2020 2020 2020 2073 7461 636b 203d  .        stack =
+00011de0: 205b 6b65 795d 0a20 2020 2020 2020 2063   [key].        c
+00011df0: 6c69 656e 7420 3d20 7365 6c66 2e5f 636c  lient = self._cl
+00011e00: 6965 6e74 0a20 2020 2020 2020 2077 6869  ient.        whi
+00011e10: 6c65 206c 656e 2873 7461 636b 2920 3e20  le len(stack) > 
+00011e20: 303a 0a20 2020 2020 2020 2020 2020 2063  0:.            c
+00011e30: 7572 7265 6e74 203d 205f 6265 636f 6d65  urrent = _become
+00011e40: 5f70 7265 6669 7828 7374 6163 6b2e 706f  _prefix(stack.po
+00011e50: 7028 2929 0a20 2020 2020 2020 2020 2020  p()).           
+00011e60: 2064 6972 732c 2066 696c 6573 203d 205b   dirs, files = [
+00011e70: 5d2c 205b 5d0a 2020 2020 2020 2020 2020  ], [].          
+00011e80: 2020 666f 7220 7265 7370 2069 6e20 5f6c    for resp in _l
+00011e90: 6973 745f 6f62 6a65 6374 735f 7265 6375  ist_objects_recu
+00011ea0: 7273 6976 6528 636c 6965 6e74 2c20 6275  rsive(client, bu
+00011eb0: 636b 6574 2c20 6375 7272 656e 742c 2027  cket, current, '
+00011ec0: 2f27 293a 0a20 2020 2020 2020 2020 2020  /'):.           
+00011ed0: 2020 2020 2066 6f72 2063 6f6d 6d6f 6e5f       for common_
+00011ee0: 7072 6566 6978 2069 6e20 7265 7370 2e67  prefix in resp.g
+00011ef0: 6574 2827 436f 6d6d 6f6e 5072 6566 6978  et('CommonPrefix
+00011f00: 6573 272c 205b 5d29 3a0a 2020 2020 2020  es', []):.      
+00011f10: 2020 2020 2020 2020 2020 2020 2020 6469                di
+00011f20: 7273 2e61 7070 656e 6428 636f 6d6d 6f6e  rs.append(common
+00011f30: 5f70 7265 6669 785b 2750 7265 6669 7827  _prefix['Prefix'
+00011f40: 5d5b 3a2d 315d 290a 2020 2020 2020 2020  ][:-1]).        
+00011f50: 2020 2020 2020 2020 666f 7220 636f 6e74          for cont
+00011f60: 656e 7420 696e 2072 6573 702e 6765 7428  ent in resp.get(
+00011f70: 2743 6f6e 7465 6e74 7327 2c20 5b5d 293a  'Contents', []):
+00011f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011f90: 2020 2020 2066 696c 6573 2e61 7070 656e       files.appen
+00011fa0: 6428 636f 6e74 656e 745b 274b 6579 275d  d(content['Key']
+00011fb0: 290a 0a20 2020 2020 2020 2020 2020 2064  )..            d
+00011fc0: 6972 7320 3d20 736f 7274 6564 2864 6972  irs = sorted(dir
+00011fd0: 7329 0a20 2020 2020 2020 2020 2020 2073  s).            s
+00011fe0: 7461 636b 2e65 7874 656e 6428 7265 7665  tack.extend(reve
+00011ff0: 7273 6564 2864 6972 7329 290a 0a20 2020  rsed(dirs))..   
+00012000: 2020 2020 2020 2020 2072 6f6f 7420 3d20           root = 
+00012010: 7333 5f70 6174 685f 6a6f 696e 280a 2020  s3_path_join(.  
+00012020: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00012030: 7b73 656c 662e 5f70 726f 746f 636f 6c5f  {self._protocol_
+00012040: 7769 7468 5f70 726f 6669 6c65 7d3a 2f2f  with_profile}://
+00012050: 272c 2062 7563 6b65 742c 2063 7572 7265  ', bucket, curre
+00012060: 6e74 295b 3a2d 315d 0a20 2020 2020 2020  nt)[:-1].       
+00012070: 2020 2020 2064 6972 7320 3d20 5b70 6174       dirs = [pat
+00012080: 685b 6c65 6e28 6375 7272 656e 7429 3a5d  h[len(current):]
+00012090: 2066 6f72 2070 6174 6820 696e 2064 6972   for path in dir
+000120a0: 735d 0a20 2020 2020 2020 2020 2020 2066  s].            f
+000120b0: 696c 6573 203d 2073 6f72 7465 6428 7061  iles = sorted(pa
+000120c0: 7468 5b6c 656e 2863 7572 7265 6e74 293a  th[len(current):
+000120d0: 5d20 666f 7220 7061 7468 2069 6e20 6669  ] for path in fi
+000120e0: 6c65 7329 0a20 2020 2020 2020 2020 2020  les).           
+000120f0: 2079 6965 6c64 2072 6f6f 742c 2064 6972   yield root, dir
+00012100: 732c 2066 696c 6573 0a0a 2020 2020 6465  s, files..    de
+00012110: 6620 6d64 3528 7365 6c66 2c20 7265 6361  f md5(self, reca
+00012120: 6c63 756c 6174 653a 2062 6f6f 6c20 3d20  lculate: bool = 
+00012130: 4661 6c73 652c 2066 6f6c 6c6f 776c 696e  False, followlin
+00012140: 6b73 3a20 626f 6f6c 203d 2046 616c 7365  ks: bool = False
+00012150: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
+00012160: 2020 2727 270a 2020 2020 2020 2020 4765    '''.        Ge
+00012170: 7420 6d64 3520 6d65 7461 2069 6e66 6f20  t md5 meta info 
+00012180: 696e 2066 696c 6573 2074 6861 7420 7570  in files that up
+00012190: 6c6f 6164 6564 2f63 6f70 6965 6420 7669  loaded/copied vi
+000121a0: 6120 6d65 6766 696c 650a 0a20 2020 2020  a megfile..     
+000121b0: 2020 2049 6620 6d65 7461 2069 6e66 6f20     If meta info 
+000121c0: 6973 206c 6f73 7420 6f72 206e 6f6e 2d65  is lost or non-e
+000121d0: 7869 7374 656e 742c 2072 6574 7572 6e20  xistent, return 
+000121e0: 4e6f 6e65 0a0a 2020 2020 2020 2020 3a70  None..        :p
+000121f0: 6172 616d 2072 6563 616c 6375 6c61 7465  aram recalculate
+00012200: 3a20 6361 6c63 756c 6174 6520 6d64 3520  : calculate md5 
+00012210: 696e 2072 6561 6c2d 7469 6d65 206f 7220  in real-time or 
+00012220: 7265 7475 726e 2073 3320 6574 6167 0a20  return s3 etag. 
+00012230: 2020 2020 2020 203a 7061 7261 6d20 666f         :param fo
+00012240: 6c6c 6f77 6c69 6e6b 733a 2049 6620 6973  llowlinks: If is
+00012250: 2054 7275 652c 2063 616c 6375 6c61 7465   True, calculate
+00012260: 206d 6435 2066 6f72 2072 6561 6c20 6669   md5 for real fi
+00012270: 6c65 0a20 2020 2020 2020 203a 7265 7475  le.        :retu
+00012280: 726e 733a 206d 6435 206d 6574 6120 696e  rns: md5 meta in
+00012290: 666f 0a20 2020 2020 2020 2027 2727 0a20  fo.        '''. 
+000122a0: 2020 2020 2020 2062 7563 6b65 742c 205f         bucket, _
+000122b0: 203d 2070 6172 7365 5f73 335f 7572 6c28   = parse_s3_url(
+000122c0: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
+000122d0: 726f 746f 636f 6c29 0a20 2020 2020 2020  rotocol).       
+000122e0: 2069 6620 6e6f 7420 6275 636b 6574 3a0a   if not bucket:.
+000122f0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00012300: 6520 5333 4275 636b 6574 4e6f 7446 6f75  e S3BucketNotFou
+00012310: 6e64 4572 726f 7228 0a20 2020 2020 2020  ndError(.       
+00012320: 2020 2020 2020 2020 2027 456d 7074 7920           'Empty 
+00012330: 6275 636b 6574 206e 616d 653a 2025 7227  bucket name: %r'
+00012340: 2025 2073 656c 662e 7061 7468 5f77 6974   % self.path_wit
+00012350: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
+00012360: 2020 2020 7374 6174 203d 2073 656c 662e      stat = self.
+00012370: 7374 6174 2866 6f6c 6c6f 775f 7379 6d6c  stat(follow_syml
+00012380: 696e 6b73 3d66 6f6c 6c6f 776c 696e 6b73  inks=followlinks
+00012390: 290a 2020 2020 2020 2020 6966 2073 7461  ).        if sta
+000123a0: 742e 6973 6469 723a 0a20 2020 2020 2020  t.isdir:.       
+000123b0: 2020 2020 2068 6173 685f 6d64 3520 3d20       hash_md5 = 
+000123c0: 6861 7368 6c69 622e 6d64 3528 2920 2023  hashlib.md5()  #
+000123d0: 206e 6f73 6563 0a20 2020 2020 2020 2020   nosec.         
+000123e0: 2020 2066 6f72 2066 696c 655f 6e61 6d65     for file_name
+000123f0: 2069 6e20 7365 6c66 2e6c 6973 7464 6972   in self.listdir
+00012400: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00012410: 2020 2020 6368 756e 6b20 3d20 5333 5061      chunk = S3Pa
+00012420: 7468 280a 2020 2020 2020 2020 2020 2020  th(.            
+00012430: 2020 2020 2020 2020 7333 5f70 6174 685f          s3_path_
+00012440: 6a6f 696e 280a 2020 2020 2020 2020 2020  join(.          
+00012450: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00012460: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
+00012470: 746f 636f 6c2c 0a20 2020 2020 2020 2020  tocol,.         
+00012480: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00012490: 696c 655f 6e61 6d65 2929 2e6d 6435 2872  ile_name)).md5(r
+000124a0: 6563 616c 6375 6c61 7465 3d72 6563 616c  ecalculate=recal
+000124b0: 6375 6c61 7465 292e 656e 636f 6465 2829  culate).encode()
+000124c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000124d0: 2068 6173 685f 6d64 352e 7570 6461 7465   hash_md5.update
+000124e0: 2863 6875 6e6b 290a 2020 2020 2020 2020  (chunk).        
+000124f0: 2020 2020 7265 7475 726e 2068 6173 685f      return hash_
+00012500: 6d64 352e 6865 7864 6967 6573 7428 290a  md5.hexdigest().
+00012510: 2020 2020 2020 2020 6966 2072 6563 616c          if recal
+00012520: 6375 6c61 7465 3a0a 2020 2020 2020 2020  culate:.        
+00012530: 2020 2020 7061 7468 5f69 6e73 7461 6e63      path_instanc
+00012540: 6520 3d20 7365 6c66 0a20 2020 2020 2020  e = self.       
+00012550: 2020 2020 2069 6620 666f 6c6c 6f77 6c69       if followli
+00012560: 6e6b 733a 0a20 2020 2020 2020 2020 2020  nks:.           
+00012570: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00012580: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00012590: 7468 5f69 6e73 7461 6e63 6520 3d20 7365  th_instance = se
+000125a0: 6c66 2e72 6561 646c 696e 6b28 290a 2020  lf.readlink().  
+000125b0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+000125c0: 6365 7074 2053 334e 6f74 414c 696e 6b45  cept S3NotALinkE
+000125d0: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+000125e0: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
+000125f0: 2020 2020 2020 2020 2020 2077 6974 6820             with 
+00012600: 7061 7468 5f69 6e73 7461 6e63 652e 6f70  path_instance.op
+00012610: 656e 2827 7262 2729 2061 7320 663a 0a20  en('rb') as f:. 
+00012620: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00012630: 6574 7572 6e20 6361 6c63 756c 6174 655f  eturn calculate_
+00012640: 6d64 3528 6629 0a20 2020 2020 2020 2072  md5(f).        r
+00012650: 6574 7572 6e20 7374 6174 2e65 7874 7261  eturn stat.extra
+00012660: 2e67 6574 2827 4554 6167 272c 2027 2729  .get('ETag', '')
+00012670: 5b31 3a2d 315d 0a0a 2020 2020 6465 6620  [1:-1]..    def 
+00012680: 636f 7079 280a 2020 2020 2020 2020 2020  copy(.          
+00012690: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+000126a0: 2020 2020 6473 745f 7572 6c3a 2050 6174      dst_url: Pat
+000126b0: 684c 696b 652c 0a20 2020 2020 2020 2020  hLike,.         
+000126c0: 2020 2066 6f6c 6c6f 776c 696e 6b73 3a20     followlinks: 
+000126d0: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
+000126e0: 2020 2020 2020 2020 2020 6361 6c6c 6261            callba
+000126f0: 636b 3a20 4f70 7469 6f6e 616c 5b43 616c  ck: Optional[Cal
+00012700: 6c61 626c 655b 5b69 6e74 5d2c 204e 6f6e  lable[[int], Non
+00012710: 655d 5d20 3d20 4e6f 6e65 2920 2d3e 204e  e]] = None) -> N
+00012720: 6f6e 653a 0a20 2020 2020 2020 2027 2727  one:.        '''
+00012730: 2046 696c 6520 636f 7079 206f 6e20 5333   File copy on S3
+00012740: 0a20 2020 2020 2020 2043 6f70 7920 636f  .        Copy co
+00012750: 6e74 656e 7420 6f66 2066 696c 6520 6f6e  ntent of file on
+00012760: 2060 7372 635f 7061 7468 6020 746f 2060   `src_path` to `
+00012770: 6473 745f 7061 7468 602e 0a20 2020 2020  dst_path`..     
+00012780: 2020 2049 7427 7320 6361 6c6c 6572 2773     It's caller's
+00012790: 2072 6573 706f 6e73 6562 696c 6974 7920   responsebility 
+000127a0: 746f 2065 6e73 7572 6520 7468 6520 7333  to ensure the s3
+000127b0: 5f69 7366 696c 6528 7372 635f 7572 6c29  _isfile(src_url)
+000127c0: 203d 3d20 5472 7565 0a0a 2020 2020 2020   == True..      
+000127d0: 2020 3a70 6172 616d 2064 7374 5f70 6174    :param dst_pat
+000127e0: 683a 2054 6172 6765 7420 6669 6c65 2070  h: Target file p
+000127f0: 6174 680a 2020 2020 2020 2020 3a70 6172  ath.        :par
+00012800: 616d 2063 616c 6c62 6163 6b3a 2043 616c  am callback: Cal
+00012810: 6c65 6420 7065 7269 6f64 6963 616c 6c79  led periodically
+00012820: 2064 7572 696e 6720 636f 7079 2c20 616e   during copy, an
+00012830: 6420 7468 6520 696e 7075 7420 7061 7261  d the input para
+00012840: 6d65 7465 7220 6973 2074 6865 2064 6174  meter is the dat
+00012850: 6120 7369 7a65 2028 696e 2062 7974 6573  a size (in bytes
+00012860: 2920 6f66 2063 6f70 7920 7369 6e63 6520  ) of copy since 
+00012870: 7468 6520 6c61 7374 2063 616c 6c0a 2020  the last call.  
+00012880: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
+00012890: 2020 7372 635f 7572 6c20 3d20 7365 6c66    src_url = self
+000128a0: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+000128b0: 636f 6c0a 2020 2020 2020 2020 7372 635f  col.        src_
+000128c0: 6275 636b 6574 2c20 7372 635f 6b65 7920  bucket, src_key 
+000128d0: 3d20 7061 7273 655f 7333 5f75 726c 2873  = parse_s3_url(s
+000128e0: 7263 5f75 726c 290a 2020 2020 2020 2020  rc_url).        
+000128f0: 6473 745f 6275 636b 6574 2c20 6473 745f  dst_bucket, dst_
+00012900: 6b65 7920 3d20 7061 7273 655f 7333 5f75  key = parse_s3_u
+00012910: 726c 2864 7374 5f75 726c 290a 0a20 2020  rl(dst_url)..   
+00012920: 2020 2020 2069 6620 6e6f 7420 7372 635f       if not src_
+00012930: 6275 636b 6574 3a0a 2020 2020 2020 2020  bucket:.        
+00012940: 2020 2020 7261 6973 6520 5333 4275 636b      raise S3Buck
+00012950: 6574 4e6f 7446 6f75 6e64 4572 726f 7228  etNotFoundError(
+00012960: 2745 6d70 7479 2062 7563 6b65 7420 6e61  'Empty bucket na
+00012970: 6d65 3a20 2572 2720 2520 7372 635f 7572  me: %r' % src_ur
+00012980: 6c29 0a20 2020 2020 2020 2069 6620 7365  l).        if se
+00012990: 6c66 2e69 735f 6469 7228 293a 0a20 2020  lf.is_dir():.   
+000129a0: 2020 2020 2020 2020 2072 6169 7365 2053           raise S
+000129b0: 3349 7341 4469 7265 6374 6f72 7945 7272  3IsADirectoryErr
+000129c0: 6f72 2827 4973 2061 2064 6972 6563 746f  or('Is a directo
+000129d0: 7279 3a20 2572 2720 2520 7372 635f 7572  ry: %r' % src_ur
+000129e0: 6c29 0a0a 2020 2020 2020 2020 6966 206e  l)..        if n
+000129f0: 6f74 2064 7374 5f62 7563 6b65 743a 0a20  ot dst_bucket:. 
+00012a00: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00012a10: 2053 3342 7563 6b65 744e 6f74 466f 756e   S3BucketNotFoun
+00012a20: 6445 7272 6f72 2827 456d 7074 7920 6275  dError('Empty bu
+00012a30: 636b 6574 206e 616d 653a 2025 7227 2025  cket name: %r' %
+00012a40: 2064 7374 5f75 726c 290a 2020 2020 2020   dst_url).      
+00012a50: 2020 6966 206e 6f74 2064 7374 5f6b 6579    if not dst_key
+00012a60: 206f 7220 6473 745f 6b65 792e 656e 6473   or dst_key.ends
+00012a70: 7769 7468 2827 2f27 293a 0a20 2020 2020  with('/'):.     
+00012a80: 2020 2020 2020 2072 6169 7365 2053 3349         raise S3I
+00012a90: 7341 4469 7265 6374 6f72 7945 7272 6f72  sADirectoryError
+00012aa0: 2827 4973 2061 2064 6972 6563 746f 7279  ('Is a directory
+00012ab0: 3a20 2572 2720 2520 6473 745f 7572 6c29  : %r' % dst_url)
+00012ac0: 0a0a 2020 2020 2020 2020 6966 2066 6f6c  ..        if fol
+00012ad0: 6c6f 776c 696e 6b73 3a0a 2020 2020 2020  lowlinks:.      
+00012ae0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00012af0: 2020 2020 2020 2020 2020 2073 335f 7572             s3_ur
+00012b00: 6c20 3d20 7365 6c66 2e72 6561 646c 696e  l = self.readlin
+00012b10: 6b28 292e 7061 7468 0a20 2020 2020 2020  k().path.       
+00012b20: 2020 2020 2020 2020 2073 7263 5f62 7563           src_buc
+00012b30: 6b65 742c 2073 7263 5f6b 6579 203d 2070  ket, src_key = p
+00012b40: 6172 7365 5f73 335f 7572 6c28 7333 5f75  arse_s3_url(s3_u
+00012b50: 726c 290a 2020 2020 2020 2020 2020 2020  rl).            
+00012b60: 6578 6365 7074 2053 334e 6f74 414c 696e  except S3NotALin
+00012b70: 6b45 7272 6f72 3a0a 2020 2020 2020 2020  kError:.        
+00012b80: 2020 2020 2020 2020 7061 7373 0a0a 2020          pass..  
+00012b90: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00012ba0: 2020 2020 2020 2073 656c 662e 5f63 6c69         self._cli
+00012bb0: 656e 742e 636f 7079 280a 2020 2020 2020  ent.copy(.      
+00012bc0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00012bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012be0: 2742 7563 6b65 7427 3a20 7372 635f 6275  'Bucket': src_bu
+00012bf0: 636b 6574 2c0a 2020 2020 2020 2020 2020  cket,.          
+00012c00: 2020 2020 2020 2020 2020 274b 6579 273a            'Key':
+00012c10: 2073 7263 5f6b 6579 2c0a 2020 2020 2020   src_key,.      
+00012c20: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
+00012c30: 2020 2020 2020 2020 2020 2020 2042 7563               Buc
+00012c40: 6b65 743d 6473 745f 6275 636b 6574 2c0a  ket=dst_bucket,.
 00012c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012c60: 2027 4275 636b 6574 273a 2073 7263 5f62   'Bucket': src_b
-00012c70: 7563 6b65 742c 0a20 2020 2020 2020 2020  ucket,.         
-00012c80: 2020 2020 2020 2020 2020 2027 4b65 7927             'Key'
-00012c90: 3a20 7372 635f 6b65 792c 0a20 2020 2020  : src_key,.     
-00012ca0: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
-00012cb0: 2020 2020 2020 2020 2020 2020 2020 4275                Bu
-00012cc0: 636b 6574 3d64 7374 5f62 7563 6b65 742c  cket=dst_bucket,
-00012cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012ce0: 204b 6579 3d64 7374 5f6b 6579 2c0a 2020   Key=dst_key,.  
-00012cf0: 2020 2020 2020 2020 2020 2020 2020 4361                Ca
-00012d00: 6c6c 6261 636b 3d63 616c 6c62 6163 6b29  llback=callback)
-00012d10: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00012d20: 4578 6365 7074 696f 6e20 6173 2065 7272  Exception as err
-00012d30: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-00012d40: 6572 726f 7220 3d20 7472 616e 736c 6174  error = translat
-00012d50: 655f 7333 5f65 7272 6f72 2865 7272 6f72  e_s3_error(error
-00012d60: 2c20 6473 745f 7572 6c29 0a20 2020 2020  , dst_url).     
-00012d70: 2020 2020 2020 2023 2045 7272 6f72 2063         # Error c
-00012d80: 616e 2774 2068 656c 7020 7465 6c6c 2077  an't help tell w
-00012d90: 6869 6368 2069 7320 7072 6f62 6c65 6d61  hich is problema
-00012da0: 7469 630a 2020 2020 2020 2020 2020 2020  tic.            
-00012db0: 6966 2069 7369 6e73 7461 6e63 6528 6572  if isinstance(er
-00012dc0: 726f 722c 2053 3342 7563 6b65 744e 6f74  ror, S3BucketNot
-00012dd0: 466f 756e 6445 7272 6f72 293a 0a20 2020  FoundError):.   
-00012de0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00012df0: 6e6f 7420 7365 6c66 2e68 6173 6275 636b  not self.hasbuck
-00012e00: 6574 2829 3a0a 2020 2020 2020 2020 2020  et():.          
-00012e10: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00012e20: 5333 4275 636b 6574 4e6f 7446 6f75 6e64  S3BucketNotFound
-00012e30: 4572 726f 7228 274e 6f20 7375 6368 2062  Error('No such b
-00012e40: 7563 6b65 743a 2025 7227 2025 2073 7263  ucket: %r' % src
-00012e50: 5f75 726c 290a 2020 2020 2020 2020 2020  _url).          
-00012e60: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
-00012e70: 6528 6572 726f 722c 2053 3346 696c 654e  e(error, S3FileN
-00012e80: 6f74 466f 756e 6445 7272 6f72 293a 0a20  otFoundError):. 
-00012e90: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00012ea0: 6620 6e6f 7420 7365 6c66 2e69 735f 6669  f not self.is_fi
-00012eb0: 6c65 2829 3a0a 2020 2020 2020 2020 2020  le():.          
-00012ec0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00012ed0: 5333 4669 6c65 4e6f 7446 6f75 6e64 4572  S3FileNotFoundEr
-00012ee0: 726f 7228 274e 6f20 7375 6368 2066 696c  ror('No such fil
-00012ef0: 653a 2025 7227 2025 2073 7263 5f75 726c  e: %r' % src_url
-00012f00: 290a 2020 2020 2020 2020 2020 2020 7261  ).            ra
-00012f10: 6973 6520 6572 726f 720a 0a20 2020 2064  ise error..    d
-00012f20: 6566 2073 796e 6328 7365 6c66 2c20 6473  ef sync(self, ds
-00012f30: 745f 7572 6c3a 2050 6174 684c 696b 652c  t_url: PathLike,
-00012f40: 2066 6f6c 6c6f 776c 696e 6b73 3a20 626f   followlinks: bo
-00012f50: 6f6c 203d 2046 616c 7365 2920 2d3e 204e  ol = False) -> N
-00012f60: 6f6e 653a 0a20 2020 2020 2020 2027 2727  one:.        '''
-00012f70: 0a20 2020 2020 2020 2043 6f70 7920 6669  .        Copy fi
-00012f80: 6c65 2f64 6972 6563 746f 7279 206f 6e20  le/directory on 
-00012f90: 7372 635f 7572 6c20 746f 2064 7374 5f75  src_url to dst_u
-00012fa0: 726c 0a0a 2020 2020 2020 2020 3a70 6172  rl..        :par
-00012fb0: 616d 2064 7374 5f75 726c 3a20 4769 7665  am dst_url: Give
-00012fc0: 6e20 6465 7374 696e 6174 696f 6e20 7061  n destination pa
-00012fd0: 7468 0a20 2020 2020 2020 2027 2727 0a20  th.        '''. 
-00012fe0: 2020 2020 2020 2066 6f72 2073 7263 5f66         for src_f
-00012ff0: 696c 655f 7061 7468 2c20 6473 745f 6669  ile_path, dst_fi
-00013000: 6c65 5f70 6174 6820 696e 205f 7333 5f73  le_path in _s3_s
-00013010: 6361 6e5f 7061 6972 7328 0a20 2020 2020  can_pairs(.     
-00013020: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00013030: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
-00013040: 6f6c 2c20 6473 745f 7572 6c29 3a0a 2020  ol, dst_url):.  
-00013050: 2020 2020 2020 2020 2020 7372 635f 6669            src_fi
-00013060: 6c65 5f70 6174 6820 3d20 7365 6c66 2e66  le_path = self.f
-00013070: 726f 6d5f 7061 7468 2873 7263 5f66 696c  rom_path(src_fil
-00013080: 655f 7061 7468 290a 2020 2020 2020 2020  e_path).        
-00013090: 2020 2020 6473 745f 6669 6c65 5f70 6174      dst_file_pat
-000130a0: 6820 3d20 7365 6c66 2e66 726f 6d5f 7061  h = self.from_pa
-000130b0: 7468 2864 7374 5f66 696c 655f 7061 7468  th(dst_file_path
-000130c0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-000130d0: 2064 7374 5f66 696c 655f 7061 7468 2e65   dst_file_path.e
-000130e0: 7869 7374 7328 2920 616e 6420 6973 5f73  xists() and is_s
-000130f0: 616d 655f 6669 6c65 280a 2020 2020 2020  ame_file(.      
-00013100: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-00013110: 635f 6669 6c65 5f70 6174 682e 7374 6174  c_file_path.stat
-00013120: 2829 2c20 6473 745f 6669 6c65 5f70 6174  (), dst_file_pat
-00013130: 682e 7374 6174 2829 2c20 2763 6f70 7927  h.stat(), 'copy'
-00013140: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00013150: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
-00013160: 2020 2020 2020 2020 7372 635f 6669 6c65          src_file
-00013170: 5f70 6174 682e 636f 7079 2864 7374 5f66  _path.copy(dst_f
-00013180: 696c 655f 7061 7468 2c20 666f 6c6c 6f77  ile_path, follow
-00013190: 6c69 6e6b 733d 666f 6c6c 6f77 6c69 6e6b  links=followlink
-000131a0: 7329 0a0a 2020 2020 6465 6620 7379 6d6c  s)..    def syml
-000131b0: 696e 6b28 7365 6c66 2c20 6473 745f 7061  ink(self, dst_pa
-000131c0: 7468 3a20 5061 7468 4c69 6b65 2920 2d3e  th: PathLike) ->
-000131d0: 204e 6f6e 653a 0a20 2020 2020 2020 2027   None:.        '
-000131e0: 2727 0a20 2020 2020 2020 2043 7265 6174  ''.        Creat
-000131f0: 6520 6120 7379 6d62 6f6c 6963 206c 696e  e a symbolic lin
-00013200: 6b20 706f 696e 7469 6e67 2074 6f20 7372  k pointing to sr
-00013210: 635f 7061 7468 206e 616d 6564 2064 7374  c_path named dst
-00013220: 5f70 6174 682e 0a0a 2020 2020 2020 2020  _path...        
-00013230: 3a70 6172 616d 2064 7374 5f70 6174 683a  :param dst_path:
-00013240: 2044 6573 696e 6174 696f 6e20 7061 7468   Desination path
-00013250: 0a20 2020 2020 2020 203a 7261 6973 6573  .        :raises
-00013260: 3a20 5333 4e61 6d65 546f 6f4c 6f6e 6745  : S3NameTooLongE
-00013270: 7272 6f72 2c20 5333 4275 636b 6574 4e6f  rror, S3BucketNo
-00013280: 7446 6f75 6e64 4572 726f 722c 2053 3349  tFoundError, S3I
-00013290: 7341 4469 7265 6374 6f72 7945 7272 6f72  sADirectoryError
-000132a0: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
-000132b0: 2020 2020 2069 6620 6c65 6e28 7374 7228       if len(str(
-000132c0: 7365 6c66 2e5f 7333 5f70 6174 6829 2e65  self._s3_path).e
-000132d0: 6e63 6f64 6528 2929 203e 2031 3032 343a  ncode()) > 1024:
-000132e0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-000132f0: 7365 2053 334e 616d 6554 6f6f 4c6f 6e67  se S3NameTooLong
-00013300: 4572 726f 7228 2746 696c 6520 6e61 6d65  Error('File name
-00013310: 2074 6f6f 206c 6f6e 673a 2025 7227 2025   too long: %r' %
-00013320: 2064 7374 5f70 6174 6829 0a20 2020 2020   dst_path).     
-00013330: 2020 2073 7263 5f62 7563 6b65 742c 2073     src_bucket, s
-00013340: 7263 5f6b 6579 203d 2070 6172 7365 5f73  rc_key = parse_s
-00013350: 335f 7572 6c28 7365 6c66 2e70 6174 685f  3_url(self.path_
-00013360: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
-00013370: 2020 2020 2020 2064 7374 5f62 7563 6b65         dst_bucke
-00013380: 742c 2064 7374 5f6b 6579 203d 2070 6172  t, dst_key = par
-00013390: 7365 5f73 335f 7572 6c28 6473 745f 7061  se_s3_url(dst_pa
-000133a0: 7468 290a 0a20 2020 2020 2020 2069 6620  th)..        if 
-000133b0: 6e6f 7420 7372 635f 6275 636b 6574 3a0a  not src_bucket:.
-000133c0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-000133d0: 6520 5333 4275 636b 6574 4e6f 7446 6f75  e S3BucketNotFou
-000133e0: 6e64 4572 726f 7228 2745 6d70 7479 2062  ndError('Empty b
-000133f0: 7563 6b65 7420 6e61 6d65 3a20 2572 2720  ucket name: %r' 
-00013400: 2520 7365 6c66 2e70 6174 6829 0a20 2020  % self.path).   
-00013410: 2020 2020 2069 6620 6e6f 7420 6473 745f       if not dst_
-00013420: 6275 636b 6574 3a0a 2020 2020 2020 2020  bucket:.        
-00013430: 2020 2020 7261 6973 6520 5333 4275 636b      raise S3Buck
-00013440: 6574 4e6f 7446 6f75 6e64 4572 726f 7228  etNotFoundError(
-00013450: 2745 6d70 7479 2062 7563 6b65 7420 6e61  'Empty bucket na
-00013460: 6d65 3a20 2572 2720 2520 6473 745f 7061  me: %r' % dst_pa
-00013470: 7468 290a 2020 2020 2020 2020 6966 206e  th).        if n
-00013480: 6f74 2064 7374 5f6b 6579 206f 7220 6473  ot dst_key or ds
-00013490: 745f 6b65 792e 656e 6473 7769 7468 2827  t_key.endswith('
-000134a0: 2f27 293a 0a20 2020 2020 2020 2020 2020  /'):.           
-000134b0: 2072 6169 7365 2053 3349 7341 4469 7265   raise S3IsADire
-000134c0: 6374 6f72 7945 7272 6f72 2827 4973 2061  ctoryError('Is a
-000134d0: 2064 6972 6563 746f 7279 3a20 2572 2720   directory: %r' 
-000134e0: 2520 6473 745f 7061 7468 290a 0a20 2020  % dst_path)..   
-000134f0: 2020 2020 2073 7263 5f70 6174 6820 3d20       src_path = 
-00013500: 7365 6c66 2e5f 7333 5f70 6174 680a 2020  self._s3_path.  
-00013510: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00013520: 2020 2020 2020 2073 7263 5f70 6174 6820         src_path 
-00013530: 3d20 7365 6c66 2e72 6561 646c 696e 6b28  = self.readlink(
-00013540: 292e 5f73 335f 7061 7468 0a20 2020 2020  )._s3_path.     
-00013550: 2020 2065 7863 6570 7420 5333 4e6f 7441     except S3NotA
-00013560: 4c69 6e6b 4572 726f 723a 0a20 2020 2020  LinkError:.     
-00013570: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
-00013580: 2020 2020 7769 7468 2072 6169 7365 5f73      with raise_s
-00013590: 335f 6572 726f 7228 6473 745f 7061 7468  3_error(dst_path
-000135a0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-000135b0: 656c 662e 5f63 6c69 656e 742e 7075 745f  elf._client.put_
-000135c0: 6f62 6a65 6374 280a 2020 2020 2020 2020  object(.        
-000135d0: 2020 2020 2020 2020 4275 636b 6574 3d64          Bucket=d
-000135e0: 7374 5f62 7563 6b65 742c 0a20 2020 2020  st_bucket,.     
-000135f0: 2020 2020 2020 2020 2020 204b 6579 3d64             Key=d
-00013600: 7374 5f6b 6579 2c0a 2020 2020 2020 2020  st_key,.        
-00013610: 2020 2020 2020 2020 4d65 7461 6461 7461          Metadata
-00013620: 3d7b 2273 796d 6c69 6e6b 5f74 6f22 3a20  ={"symlink_to": 
-00013630: 7372 635f 7061 7468 7d29 0a0a 2020 2020  src_path})..    
-00013640: 6465 6620 7265 6164 6c69 6e6b 2873 656c  def readlink(sel
-00013650: 6629 202d 3e20 2753 3350 6174 6827 3a0a  f) -> 'S3Path':.
-00013660: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-00013670: 2020 2020 5265 7475 726e 2061 2053 3350      Return a S3P
-00013680: 6174 6820 696e 7374 616e 6365 2072 6570  ath instance rep
-00013690: 7265 7365 6e74 696e 6720 7468 6520 7061  resenting the pa
-000136a0: 7468 2074 6f20 7768 6963 6820 7468 6520  th to which the 
-000136b0: 7379 6d62 6f6c 6963 206c 696e 6b20 706f  symbolic link po
-000136c0: 696e 7473 2e0a 0a20 2020 2020 2020 203a  ints...        :
-000136d0: 7265 7475 726e 733a 2052 6574 7572 6e20  returns: Return 
-000136e0: 6120 5333 5061 7468 2069 6e73 7461 6e63  a S3Path instanc
-000136f0: 6520 7265 7072 6573 656e 7469 6e67 2074  e representing t
-00013700: 6865 2070 6174 6820 746f 2077 6869 6368  he path to which
-00013710: 2074 6865 2073 796d 626f 6c69 6320 6c69   the symbolic li
-00013720: 6e6b 2070 6f69 6e74 732e 0a20 2020 2020  nk points..     
-00013730: 2020 203a 7261 6973 6573 3a20 5333 4e61     :raises: S3Na
-00013740: 6d65 546f 6f4c 6f6e 6745 7272 6f72 2c20  meTooLongError, 
-00013750: 5333 4275 636b 6574 4e6f 7446 6f75 6e64  S3BucketNotFound
-00013760: 4572 726f 722c 2053 3349 7341 4469 7265  Error, S3IsADire
-00013770: 6374 6f72 7945 7272 6f72 2c20 5333 4e6f  ctoryError, S3No
-00013780: 7441 4c69 6e6b 4572 726f 720a 2020 2020  tALinkError.    
-00013790: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
-000137a0: 6275 636b 6574 2c20 6b65 7920 3d20 7061  bucket, key = pa
-000137b0: 7273 655f 7333 5f75 726c 2873 656c 662e  rse_s3_url(self.
-000137c0: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
-000137d0: 6f6c 290a 2020 2020 2020 2020 6966 206e  ol).        if n
-000137e0: 6f74 2062 7563 6b65 743a 0a20 2020 2020  ot bucket:.     
-000137f0: 2020 2020 2020 2072 6169 7365 2053 3342         raise S3B
-00013800: 7563 6b65 744e 6f74 466f 756e 6445 7272  ucketNotFoundErr
-00013810: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00013820: 2020 2020 2745 6d70 7479 2062 7563 6b65      'Empty bucke
-00013830: 7420 6e61 6d65 3a20 2572 2720 2520 7365  t name: %r' % se
-00013840: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-00013850: 746f 636f 6c29 0a20 2020 2020 2020 2069  tocol).        i
-00013860: 6620 6e6f 7420 6b65 7920 6f72 206b 6579  f not key or key
-00013870: 2e65 6e64 7377 6974 6828 272f 2729 3a0a  .endswith('/'):.
-00013880: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00013890: 6520 5333 4973 4144 6972 6563 746f 7279  e S3IsADirectory
-000138a0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-000138b0: 2020 2020 2020 2027 4973 2061 2064 6972         'Is a dir
-000138c0: 6563 746f 7279 3a20 2572 2720 2520 7365  ectory: %r' % se
-000138d0: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-000138e0: 746f 636f 6c29 0a20 2020 2020 2020 206d  tocol).        m
-000138f0: 6574 6164 6174 6120 3d20 7365 6c66 2e5f  etadata = self._
-00013900: 7333 5f67 6574 5f6d 6574 6164 6174 6128  s3_get_metadata(
-00013910: 290a 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
-00013920: 7420 2773 796d 6c69 6e6b 5f74 6f27 2069  t 'symlink_to' i
-00013930: 6e20 6d65 7461 6461 7461 3a0a 2020 2020  n metadata:.    
-00013940: 2020 2020 2020 2020 7261 6973 6520 5333          raise S3
-00013950: 4e6f 7441 4c69 6e6b 4572 726f 7228 274e  NotALinkError('N
-00013960: 6f74 2061 206c 696e 6b3a 2025 7227 2025  ot a link: %r' %
-00013970: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
-00013980: 7072 6f74 6f63 6f6c 290a 2020 2020 2020  protocol).      
-00013990: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000139a0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-000139b0: 6672 6f6d 5f70 6174 6828 6d65 7461 6461  from_path(metada
-000139c0: 7461 5b27 7379 6d6c 696e 6b5f 746f 275d  ta['symlink_to']
-000139d0: 290a 0a20 2020 2064 6566 2069 735f 7379  )..    def is_sy
-000139e0: 6d6c 696e 6b28 7365 6c66 2920 2d3e 2062  mlink(self) -> b
-000139f0: 6f6f 6c3a 0a20 2020 2020 2020 2027 2727  ool:.        '''
-00013a00: 0a20 2020 2020 2020 2054 6573 7420 7768  .        Test wh
-00013a10: 6574 6865 7220 6120 7061 7468 2069 7320  ether a path is 
-00013a20: 6c69 6e6b 0a0a 2020 2020 2020 2020 3a72  link..        :r
-00013a30: 6574 7572 6e73 3a20 5472 7565 2069 6620  eturns: True if 
-00013a40: 6120 7061 7468 2069 7320 6c69 6e6b 2c20  a path is link, 
-00013a50: 656c 7365 2046 616c 7365 0a20 2020 2020  else False.     
-00013a60: 2020 203a 7261 6973 6573 3a20 5333 4e6f     :raises: S3No
-00013a70: 7441 4c69 6e6b 4572 726f 720a 2020 2020  tALinkError.    
-00013a80: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
-00013a90: 6275 636b 6574 2c20 6b65 7920 3d20 7061  bucket, key = pa
-00013aa0: 7273 655f 7333 5f75 726c 2873 656c 662e  rse_s3_url(self.
-00013ab0: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
-00013ac0: 6f6c 290a 2020 2020 2020 2020 6966 206e  ol).        if n
-00013ad0: 6f74 2062 7563 6b65 743a 0a20 2020 2020  ot bucket:.     
-00013ae0: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
-00013af0: 6c73 650a 2020 2020 2020 2020 6966 206e  lse.        if n
-00013b00: 6f74 206b 6579 206f 7220 6b65 792e 656e  ot key or key.en
-00013b10: 6473 7769 7468 2827 2f27 293a 0a20 2020  dswith('/'):.   
-00013b20: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00013b30: 4661 6c73 650a 2020 2020 2020 2020 6d65  False.        me
-00013b40: 7461 6461 7461 203d 2073 656c 662e 5f73  tadata = self._s
-00013b50: 335f 6765 745f 6d65 7461 6461 7461 2829  3_get_metadata()
-00013b60: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00013b70: 2773 796d 6c69 6e6b 5f74 6f27 2069 6e20  'symlink_to' in 
-00013b80: 6d65 7461 6461 7461 0a0a 2020 2020 6465  metadata..    de
-00013b90: 6620 7361 7665 2873 656c 662c 2066 696c  f save(self, fil
-00013ba0: 655f 6f62 6a65 6374 3a20 4269 6e61 7279  e_object: Binary
-00013bb0: 494f 293a 0a20 2020 2020 2020 2027 2727  IO):.        '''
-00013bc0: 5772 6974 6520 7468 6520 6f70 656e 6564  Write the opened
-00013bd0: 2062 696e 6172 7920 7374 7265 616d 2074   binary stream t
-00013be0: 6f20 7370 6563 6966 6965 6420 7061 7468  o specified path
-00013bf0: 2c20 6275 7420 7468 6520 7374 7265 616d  , but the stream
-00013c00: 2077 6f6e 2774 2062 6520 636c 6f73 6564   won't be closed
-00013c10: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-00013c20: 2066 696c 655f 6f62 6a65 6374 3a20 5374   file_object: St
-00013c30: 7265 616d 2074 6f20 6265 2072 6561 640a  ream to be read.
-00013c40: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-00013c50: 2020 2020 6275 636b 6574 2c20 6b65 7920      bucket, key 
-00013c60: 3d20 7061 7273 655f 7333 5f75 726c 2873  = parse_s3_url(s
-00013c70: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
-00013c80: 6f74 6f63 6f6c 290a 2020 2020 2020 2020  otocol).        
-00013c90: 6966 206e 6f74 2062 7563 6b65 743a 0a20  if not bucket:. 
-00013ca0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00013cb0: 2053 3342 7563 6b65 744e 6f74 466f 756e   S3BucketNotFoun
-00013cc0: 6445 7272 6f72 280a 2020 2020 2020 2020  dError(.        
-00013cd0: 2020 2020 2020 2020 2745 6d70 7479 2062          'Empty b
-00013ce0: 7563 6b65 7420 6e61 6d65 3a20 2572 2720  ucket name: %r' 
-00013cf0: 2520 7365 6c66 2e70 6174 685f 7769 7468  % self.path_with
-00013d00: 5f70 726f 746f 636f 6c29 0a20 2020 2020  _protocol).     
-00013d10: 2020 2069 6620 6e6f 7420 6b65 7920 6f72     if not key or
-00013d20: 206b 6579 2e65 6e64 7377 6974 6828 272f   key.endswith('/
-00013d30: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-00013d40: 7261 6973 6520 5333 4973 4144 6972 6563  raise S3IsADirec
-00013d50: 746f 7279 4572 726f 7228 0a20 2020 2020  toryError(.     
-00013d60: 2020 2020 2020 2020 2020 2027 4973 2061             'Is a
-00013d70: 2064 6972 6563 746f 7279 3a20 2572 2720   directory: %r' 
-00013d80: 2520 7365 6c66 2e70 6174 685f 7769 7468  % self.path_with
-00013d90: 5f70 726f 746f 636f 6c29 0a0a 2020 2020  _protocol)..    
-00013da0: 2020 2020 7769 7468 2072 6169 7365 5f73      with raise_s
-00013db0: 335f 6572 726f 7228 7365 6c66 2e70 6174  3_error(self.pat
-00013dc0: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-00013dd0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00013de0: 6c66 2e5f 636c 6965 6e74 2e75 706c 6f61  lf._client.uploa
-00013df0: 645f 6669 6c65 6f62 6a28 6669 6c65 5f6f  d_fileobj(file_o
-00013e00: 626a 6563 742c 2042 7563 6b65 743d 6275  bject, Bucket=bu
-00013e10: 636b 6574 2c20 4b65 793d 6b65 7929 0a0a  cket, Key=key)..
-00013e20: 2020 2020 6465 6620 6f70 656e 280a 2020      def open(.  
-00013e30: 2020 2020 2020 2020 2020 7365 6c66 2c0a            self,.
-00013e40: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-00013e50: 3a20 7374 7220 3d20 2772 272c 0a20 2020  : str = 'r',.   
-00013e60: 2020 2020 2020 2020 202a 2c0a 2020 2020           *,.    
-00013e70: 2020 2020 2020 2020 7333 5f6f 7065 6e5f          s3_open_
-00013e80: 6675 6e63 3a20 4361 6c6c 6162 6c65 5b5b  func: Callable[[
-00013e90: 7374 722c 2073 7472 5d2c 2042 696e 6172  str, str], Binar
-00013ea0: 7949 4f5d 203d 2073 335f 6f70 656e 2c0a  yIO] = s3_open,.
-00013eb0: 2020 2020 2020 2020 2020 2020 2a2a 6b77              **kw
-00013ec0: 6172 6773 2920 2d3e 2049 4f5b 416e 7953  args) -> IO[AnyS
-00013ed0: 7472 5d3a 2020 2320 7079 7479 7065 3a20  tr]:  # pytype: 
-00013ee0: 6469 7361 626c 653d 7369 676e 6174 7572  disable=signatur
-00013ef0: 652d 6d69 736d 6174 6368 0a20 2020 2020  e-mismatch.     
-00013f00: 2020 2072 6574 7572 6e20 7333 5f6f 7065     return s3_ope
-00013f10: 6e5f 6675 6e63 280a 2020 2020 2020 2020  n_func(.        
-00013f20: 2020 2020 7365 6c66 2e70 6174 685f 7769      self.path_wi
-00013f30: 7468 5f70 726f 746f 636f 6c2c 206d 6f64  th_protocol, mod
-00013f40: 652c 0a20 2020 2020 2020 2020 2020 202a  e,.            *
-00013f50: 2a6e 6563 6573 7361 7279 5f70 6172 616d  *necessary_param
-00013f60: 7328 7333 5f6f 7065 6e5f 6675 6e63 2c20  s(s3_open_func, 
-00013f70: 2a2a 6b77 6172 6773 2929 0a0a 2020 2020  **kwargs))..    
-00013f80: 6465 6620 6162 736f 6c75 7465 2873 656c  def absolute(sel
-00013f90: 6629 202d 3e20 2753 3350 6174 6827 3a0a  f) -> 'S3Path':.
-00013fa0: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-00013fb0: 2020 2020 4d61 6b65 2074 6865 2070 6174      Make the pat
-00013fc0: 6820 6162 736f 6c75 7465 2c20 7769 7468  h absolute, with
-00013fd0: 6f75 7420 6e6f 726d 616c 697a 6174 696f  out normalizatio
-00013fe0: 6e20 6f72 2072 6573 6f6c 7669 6e67 2073  n or resolving s
-00013ff0: 796d 6c69 6e6b 732e 2052 6574 7572 6e73  ymlinks. Returns
-00014000: 2061 206e 6577 2070 6174 6820 6f62 6a65   a new path obje
-00014010: 6374 0a20 2020 2020 2020 2027 2727 0a20  ct.        '''. 
-00014020: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00014030: 6c66 0a0a 2020 2020 6465 6620 6377 6428  lf..    def cwd(
-00014040: 7365 6c66 2920 2d3e 2027 5333 5061 7468  self) -> 'S3Path
-00014050: 273a 0a20 2020 2020 2020 2027 2727 5265  ':.        '''Re
-00014060: 7475 726e 2063 7572 7265 6e74 2077 6f72  turn current wor
-00014070: 6b69 6e67 2064 6972 6563 746f 7279 0a0a  king directory..
-00014080: 2020 2020 2020 2020 7265 7475 726e 733a          returns:
-00014090: 2043 7572 7265 6e74 2077 6f72 6b69 6e67   Current working
-000140a0: 2064 6972 6563 746f 7279 0a20 2020 2020   directory.     
-000140b0: 2020 2027 2727 0a20 2020 2020 2020 2072     '''.        r
-000140c0: 6574 7572 6e20 7365 6c66 2e66 726f 6d5f  eturn self.from_
-000140d0: 7061 7468 2873 656c 662e 7061 7468 5f77  path(self.path_w
-000140e0: 6974 685f 7072 6f74 6f63 6f6c 290a 0a0a  ith_protocol)...
-000140f0: 636c 6173 7320 4d75 6c74 6950 6172 7457  class MultiPartW
-00014100: 7269 7465 723a 0a0a 2020 2020 6465 6620  riter:..    def 
-00014110: 5f5f 696e 6974 5f5f 2873 656c 662c 2063  __init__(self, c
-00014120: 6c69 656e 742c 2070 6174 683a 2050 6174  lient, path: Pat
-00014130: 684c 696b 6529 202d 3e20 4e6f 6e65 3a0a  hLike) -> None:.
-00014140: 2020 2020 2020 2020 7365 6c66 2e5f 636c          self._cl
-00014150: 6965 6e74 203d 2063 6c69 656e 740a 2020  ient = client.  
-00014160: 2020 2020 2020 7365 6c66 2e5f 6d75 6c74        self._mult
-00014170: 6970 6172 745f 7570 6c6f 6164 5f69 6e66  ipart_upload_inf
-00014180: 6f20 3d20 5b5d 0a0a 2020 2020 2020 2020  o = []..        
-00014190: 6275 636b 6574 2c20 6b65 7920 3d20 7061  bucket, key = pa
-000141a0: 7273 655f 7333 5f75 726c 2870 6174 6829  rse_s3_url(path)
-000141b0: 0a20 2020 2020 2020 2073 656c 662e 5f62  .        self._b
-000141c0: 7563 6b65 7420 3d20 6275 636b 6574 0a20  ucket = bucket. 
-000141d0: 2020 2020 2020 2073 656c 662e 5f6b 6579         self._key
-000141e0: 203d 206b 6579 0a20 2020 2020 2020 2073   = key.        s
-000141f0: 656c 662e 5f75 706c 6f61 645f 6964 203d  elf._upload_id =
-00014200: 2073 656c 662e 5f63 6c69 656e 742e 6372   self._client.cr
-00014210: 6561 7465 5f6d 756c 7469 7061 7274 5f75  eate_multipart_u
-00014220: 706c 6f61 6428 0a20 2020 2020 2020 2020  pload(.         
-00014230: 2020 2042 7563 6b65 743d 7365 6c66 2e5f     Bucket=self._
-00014240: 6275 636b 6574 2c20 4b65 793d 7365 6c66  bucket, Key=self
-00014250: 2e5f 6b65 7929 5b27 5570 6c6f 6164 4964  ._key)['UploadId
-00014260: 275d 0a0a 2020 2020 6465 6620 7570 6c6f  ']..    def uplo
-00014270: 6164 5f70 6172 7428 7365 6c66 2c20 7061  ad_part(self, pa
-00014280: 7274 5f6e 756d 3a20 696e 742c 2066 696c  rt_num: int, fil
-00014290: 655f 6f62 6a3a 2069 6f2e 4279 7465 7349  e_obj: io.BytesI
-000142a0: 4f29 202d 3e20 4e6f 6e65 3a0a 2020 2020  O) -> None:.    
-000142b0: 2020 2020 7265 7370 6f6e 7365 203d 2073      response = s
-000142c0: 656c 662e 5f63 6c69 656e 742e 7570 6c6f  elf._client.uplo
-000142d0: 6164 5f70 6172 7428 0a20 2020 2020 2020  ad_part(.       
-000142e0: 2020 2020 2042 6f64 793d 6669 6c65 5f6f       Body=file_o
-000142f0: 626a 2c0a 2020 2020 2020 2020 2020 2020  bj,.            
-00014300: 5570 6c6f 6164 4964 3d73 656c 662e 5f75  UploadId=self._u
-00014310: 706c 6f61 645f 6964 2c0a 2020 2020 2020  pload_id,.      
-00014320: 2020 2020 2020 5061 7274 4e75 6d62 6572        PartNumber
-00014330: 3d70 6172 745f 6e75 6d2c 0a20 2020 2020  =part_num,.     
-00014340: 2020 2020 2020 2042 7563 6b65 743d 7365         Bucket=se
-00014350: 6c66 2e5f 6275 636b 6574 2c0a 2020 2020  lf._bucket,.    
-00014360: 2020 2020 2020 2020 4b65 793d 7365 6c66          Key=self
-00014370: 2e5f 6b65 792c 0a20 2020 2020 2020 2029  ._key,.        )
-00014380: 0a20 2020 2020 2020 2073 656c 662e 5f6d  .        self._m
-00014390: 756c 7469 7061 7274 5f75 706c 6f61 645f  ultipart_upload_
-000143a0: 696e 666f 2e61 7070 656e 6428 0a20 2020  info.append(.   
-000143b0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000143c0: 2020 2020 2020 2020 2020 2027 5061 7274             'Part
-000143d0: 4e75 6d62 6572 273a 2070 6172 745f 6e75  Number': part_nu
-000143e0: 6d2c 0a20 2020 2020 2020 2020 2020 2020  m,.             
-000143f0: 2020 2027 4554 6167 273a 2072 6573 706f     'ETag': respo
-00014400: 6e73 655b 2745 5461 6727 5d0a 2020 2020  nse['ETag'].    
-00014410: 2020 2020 2020 2020 7d29 0a0a 2020 2020          })..    
-00014420: 6465 6620 7570 6c6f 6164 5f70 6172 745f  def upload_part_
-00014430: 6279 5f70 6174 6873 280a 2020 2020 2020  by_paths(.      
-00014440: 2020 2020 2020 7365 6c66 2c20 7061 7274        self, part
-00014450: 5f6e 756d 3a20 696e 742c 2070 6174 6873  _num: int, paths
-00014460: 3a20 4c69 7374 5b54 7570 6c65 5b50 6174  : List[Tuple[Pat
-00014470: 684c 696b 652c 2073 7472 5d5d 2920 2d3e  hLike, str]]) ->
-00014480: 204e 6f6e 653a 0a20 2020 2020 2020 2066   None:.        f
-00014490: 696c 655f 6f62 6a20 3d20 696f 2e42 7974  ile_obj = io.Byt
-000144a0: 6573 494f 2829 0a20 2020 2020 2020 2066  esIO().        f
-000144b0: 6f72 2070 6174 682c 2062 7974 6573 5f72  or path, bytes_r
-000144c0: 616e 6765 2069 6e20 7061 7468 733a 0a20  ange in paths:. 
-000144d0: 2020 2020 2020 2020 2020 2062 7563 6b65             bucke
-000144e0: 742c 206b 6579 203d 2070 6172 7365 5f73  t, key = parse_s
-000144f0: 335f 7572 6c28 7061 7468 290a 2020 2020  3_url(path).    
-00014500: 2020 2020 2020 2020 6966 2062 7974 6573          if bytes
-00014510: 5f72 616e 6765 3a0a 2020 2020 2020 2020  _range:.        
-00014520: 2020 2020 2020 2020 6669 6c65 5f6f 626a          file_obj
-00014530: 2e77 7269 7465 280a 2020 2020 2020 2020  .write(.        
-00014540: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00014550: 2e5f 636c 6965 6e74 2e67 6574 5f6f 626a  ._client.get_obj
-00014560: 6563 7428 0a20 2020 2020 2020 2020 2020  ect(.           
-00014570: 2020 2020 2020 2020 2020 2020 2042 7563               Buc
-00014580: 6b65 743d 6275 636b 6574 2c20 4b65 793d  ket=bucket, Key=
-00014590: 6b65 792c 0a20 2020 2020 2020 2020 2020  key,.           
-000145a0: 2020 2020 2020 2020 2020 2020 2052 616e               Ran
-000145b0: 6765 3d62 7974 6573 5f72 616e 6765 295b  ge=bytes_range)[
-000145c0: 2742 6f64 7927 5d2e 7265 6164 2829 290a  'Body'].read()).
-000145d0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000145e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000145f0: 2020 6669 6c65 5f6f 626a 2e77 7269 7465    file_obj.write
-00014600: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00014610: 2020 2020 2020 7365 6c66 2e5f 636c 6965        self._clie
-00014620: 6e74 2e67 6574 5f6f 626a 6563 7428 4275  nt.get_object(Bu
-00014630: 636b 6574 3d62 7563 6b65 742c 0a20 2020  cket=bucket,.   
-00014640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014660: 2020 2020 2020 2020 204b 6579 3d6b 6579           Key=key
-00014670: 295b 2742 6f64 7927 5d2e 7265 6164 2829  )['Body'].read()
-00014680: 290a 2020 2020 2020 2020 6669 6c65 5f6f  ).        file_o
-00014690: 626a 2e73 6565 6b28 302c 206f 732e 5345  bj.seek(0, os.SE
-000146a0: 454b 5f53 4554 290a 2020 2020 2020 2020  EK_SET).        
-000146b0: 7365 6c66 2e75 706c 6f61 645f 7061 7274  self.upload_part
-000146c0: 2870 6172 745f 6e75 6d2c 2066 696c 655f  (part_num, file_
-000146d0: 6f62 6a29 0a0a 2020 2020 6465 6620 7570  obj)..    def up
-000146e0: 6c6f 6164 5f70 6172 745f 636f 7079 280a  load_part_copy(.
-000146f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00014700: 2c0a 2020 2020 2020 2020 2020 2020 7061  ,.            pa
-00014710: 7274 5f6e 756d 3a20 696e 742c 0a20 2020  rt_num: int,.   
-00014720: 2020 2020 2020 2020 2070 6174 683a 2050           path: P
-00014730: 6174 684c 696b 652c 0a20 2020 2020 2020  athLike,.       
-00014740: 2020 2020 2063 6f70 795f 736f 7572 6365       copy_source
-00014750: 5f72 616e 6765 3a20 4f70 7469 6f6e 616c  _range: Optional
-00014760: 5b73 7472 5d20 3d20 4e6f 6e65 2920 2d3e  [str] = None) ->
-00014770: 204e 6f6e 653a 0a20 2020 2020 2020 2062   None:.        b
-00014780: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
-00014790: 7365 5f73 335f 7572 6c28 7061 7468 290a  se_s3_url(path).
-000147a0: 2020 2020 2020 2020 7061 7261 6d73 203d          params =
-000147b0: 2064 6963 7428 0a20 2020 2020 2020 2020   dict(.         
-000147c0: 2020 2055 706c 6f61 6449 643d 7365 6c66     UploadId=self
-000147d0: 2e5f 7570 6c6f 6164 5f69 642c 0a20 2020  ._upload_id,.   
-000147e0: 2020 2020 2020 2020 2050 6172 744e 756d           PartNum
-000147f0: 6265 723d 7061 7274 5f6e 756d 2c0a 2020  ber=part_num,.  
-00014800: 2020 2020 2020 2020 2020 436f 7079 536f            CopySo
-00014810: 7572 6365 3d7b 0a20 2020 2020 2020 2020  urce={.         
-00014820: 2020 2020 2020 2027 4275 636b 6574 273a         'Bucket':
-00014830: 2062 7563 6b65 742c 0a20 2020 2020 2020   bucket,.       
-00014840: 2020 2020 2020 2020 2027 4b65 7927 3a20           'Key': 
-00014850: 6b65 790a 2020 2020 2020 2020 2020 2020  key.            
-00014860: 7d2c 0a20 2020 2020 2020 2020 2020 2042  },.            B
-00014870: 7563 6b65 743d 7365 6c66 2e5f 6275 636b  ucket=self._buck
-00014880: 6574 2c0a 2020 2020 2020 2020 2020 2020  et,.            
-00014890: 4b65 793d 7365 6c66 2e5f 6b65 792c 0a20  Key=self._key,. 
-000148a0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000148b0: 2069 6620 636f 7079 5f73 6f75 7263 655f   if copy_source_
-000148c0: 7261 6e67 653a 0a20 2020 2020 2020 2020  range:.         
-000148d0: 2020 2070 6172 616d 735b 2743 6f70 7953     params['CopyS
-000148e0: 6f75 7263 6552 616e 6765 275d 203d 2063  ourceRange'] = c
-000148f0: 6f70 795f 736f 7572 6365 5f72 616e 6765  opy_source_range
-00014900: 0a20 2020 2020 2020 2072 6573 706f 6e73  .        respons
-00014910: 6520 3d20 7365 6c66 2e5f 636c 6965 6e74  e = self._client
-00014920: 2e75 706c 6f61 645f 7061 7274 5f63 6f70  .upload_part_cop
-00014930: 7928 2a2a 7061 7261 6d73 290a 2020 2020  y(**params).    
-00014940: 2020 2020 7365 6c66 2e5f 6d75 6c74 6970      self._multip
-00014950: 6172 745f 7570 6c6f 6164 5f69 6e66 6f2e  art_upload_info.
-00014960: 6170 7065 6e64 280a 2020 2020 2020 2020  append(.        
-00014970: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00014980: 2020 2020 2020 2750 6172 744e 756d 6265        'PartNumbe
-00014990: 7227 3a20 7061 7274 5f6e 756d 2c0a 2020  r': part_num,.  
-000149a0: 2020 2020 2020 2020 2020 2020 2020 2745                'E
-000149b0: 5461 6727 3a20 7265 7370 6f6e 7365 5b27  Tag': response['
-000149c0: 436f 7079 5061 7274 5265 7375 6c74 275d  CopyPartResult']
-000149d0: 5b27 4554 6167 275d 0a20 2020 2020 2020  ['ETag'].       
-000149e0: 2020 2020 207d 290a 0a20 2020 2064 6566       })..    def
-000149f0: 2063 6c6f 7365 2873 656c 6629 3a0a 2020   close(self):.  
-00014a00: 2020 2020 2020 7365 6c66 2e5f 6d75 6c74        self._mult
-00014a10: 6970 6172 745f 7570 6c6f 6164 5f69 6e66  ipart_upload_inf
-00014a20: 6f2e 736f 7274 286b 6579 3d6c 616d 6264  o.sort(key=lambd
-00014a30: 6120 743a 2074 5b27 5061 7274 4e75 6d62  a t: t['PartNumb
-00014a40: 6572 275d 290a 2020 2020 2020 2020 7365  er']).        se
-00014a50: 6c66 2e5f 636c 6965 6e74 2e63 6f6d 706c  lf._client.compl
-00014a60: 6574 655f 6d75 6c74 6970 6172 745f 7570  ete_multipart_up
-00014a70: 6c6f 6164 280a 2020 2020 2020 2020 2020  load(.          
-00014a80: 2020 5570 6c6f 6164 4964 3d73 656c 662e    UploadId=self.
-00014a90: 5f75 706c 6f61 645f 6964 2c0a 2020 2020  _upload_id,.    
-00014aa0: 2020 2020 2020 2020 4275 636b 6574 3d73          Bucket=s
-00014ab0: 656c 662e 5f62 7563 6b65 742c 0a20 2020  elf._bucket,.   
-00014ac0: 2020 2020 2020 2020 204b 6579 3d73 656c           Key=sel
-00014ad0: 662e 5f6b 6579 2c0a 2020 2020 2020 2020  f._key,.        
-00014ae0: 2020 2020 4d75 6c74 6970 6172 7455 706c      MultipartUpl
-00014af0: 6f61 643d 7b27 5061 7274 7327 3a20 7365  oad={'Parts': se
-00014b00: 6c66 2e5f 6d75 6c74 6970 6172 745f 7570  lf._multipart_up
-00014b10: 6c6f 6164 5f69 6e66 6f7d 290a 0a20 2020  load_info})..   
-00014b20: 2064 6566 205f 5f65 6e74 6572 5f5f 2873   def __enter__(s
-00014b30: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
-00014b40: 7475 726e 2073 656c 660a 0a20 2020 2064  turn self..    d
-00014b50: 6566 205f 5f65 7869 745f 5f28 7365 6c66  ef __exit__(self
-00014b60: 2c20 6578 635f 7479 7065 2c20 6578 635f  , exc_type, exc_
-00014b70: 7661 6c2c 2065 7863 5f74 6229 3a0a 2020  val, exc_tb):.  
-00014b80: 2020 2020 2020 7365 6c66 2e63 6c6f 7365        self.close
-00014b90: 2829 0a                                  ().
+00012c60: 4b65 793d 6473 745f 6b65 792c 0a20 2020  Key=dst_key,.   
+00012c70: 2020 2020 2020 2020 2020 2020 2043 616c               Cal
+00012c80: 6c62 6163 6b3d 6361 6c6c 6261 636b 290a  lback=callback).
+00012c90: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+00012ca0: 7863 6570 7469 6f6e 2061 7320 6572 726f  xception as erro
+00012cb0: 723a 0a20 2020 2020 2020 2020 2020 2065  r:.            e
+00012cc0: 7272 6f72 203d 2074 7261 6e73 6c61 7465  rror = translate
+00012cd0: 5f73 335f 6572 726f 7228 6572 726f 722c  _s3_error(error,
+00012ce0: 2064 7374 5f75 726c 290a 2020 2020 2020   dst_url).      
+00012cf0: 2020 2020 2020 2320 4572 726f 7220 6361        # Error ca
+00012d00: 6e27 7420 6865 6c70 2074 656c 6c20 7768  n't help tell wh
+00012d10: 6963 6820 6973 2070 726f 626c 656d 6174  ich is problemat
+00012d20: 6963 0a20 2020 2020 2020 2020 2020 2069  ic.            i
+00012d30: 6620 6973 696e 7374 616e 6365 2865 7272  f isinstance(err
+00012d40: 6f72 2c20 5333 4275 636b 6574 4e6f 7446  or, S3BucketNotF
+00012d50: 6f75 6e64 4572 726f 7229 3a0a 2020 2020  oundError):.    
+00012d60: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00012d70: 6f74 2073 656c 662e 6861 7362 7563 6b65  ot self.hasbucke
+00012d80: 7428 293a 0a20 2020 2020 2020 2020 2020  t():.           
+00012d90: 2020 2020 2020 2020 2072 6169 7365 2053           raise S
+00012da0: 3342 7563 6b65 744e 6f74 466f 756e 6445  3BucketNotFoundE
+00012db0: 7272 6f72 2827 4e6f 2073 7563 6820 6275  rror('No such bu
+00012dc0: 636b 6574 3a20 2572 2720 2520 7372 635f  cket: %r' % src_
+00012dd0: 7572 6c29 0a20 2020 2020 2020 2020 2020  url).           
+00012de0: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
+00012df0: 2865 7272 6f72 2c20 5333 4669 6c65 4e6f  (error, S3FileNo
+00012e00: 7446 6f75 6e64 4572 726f 7229 3a0a 2020  tFoundError):.  
+00012e10: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00012e20: 206e 6f74 2073 656c 662e 6973 5f66 696c   not self.is_fil
+00012e30: 6528 293a 0a20 2020 2020 2020 2020 2020  e():.           
+00012e40: 2020 2020 2020 2020 2072 6169 7365 2053           raise S
+00012e50: 3346 696c 654e 6f74 466f 756e 6445 7272  3FileNotFoundErr
+00012e60: 6f72 2827 4e6f 2073 7563 6820 6669 6c65  or('No such file
+00012e70: 3a20 2572 2720 2520 7372 635f 7572 6c29  : %r' % src_url)
+00012e80: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00012e90: 7365 2065 7272 6f72 0a0a 2020 2020 6465  se error..    de
+00012ea0: 6620 7379 6e63 2873 656c 662c 2064 7374  f sync(self, dst
+00012eb0: 5f75 726c 3a20 5061 7468 4c69 6b65 2c20  _url: PathLike, 
+00012ec0: 666f 6c6c 6f77 6c69 6e6b 733a 2062 6f6f  followlinks: boo
+00012ed0: 6c20 3d20 4661 6c73 6529 202d 3e20 4e6f  l = False) -> No
+00012ee0: 6e65 3a0a 2020 2020 2020 2020 2727 270a  ne:.        '''.
+00012ef0: 2020 2020 2020 2020 436f 7079 2066 696c          Copy fil
+00012f00: 652f 6469 7265 6374 6f72 7920 6f6e 2073  e/directory on s
+00012f10: 7263 5f75 726c 2074 6f20 6473 745f 7572  rc_url to dst_ur
+00012f20: 6c0a 0a20 2020 2020 2020 203a 7061 7261  l..        :para
+00012f30: 6d20 6473 745f 7572 6c3a 2047 6976 656e  m dst_url: Given
+00012f40: 2064 6573 7469 6e61 7469 6f6e 2070 6174   destination pat
+00012f50: 680a 2020 2020 2020 2020 2727 270a 2020  h.        '''.  
+00012f60: 2020 2020 2020 666f 7220 7372 635f 6669        for src_fi
+00012f70: 6c65 5f70 6174 682c 2064 7374 5f66 696c  le_path, dst_fil
+00012f80: 655f 7061 7468 2069 6e20 5f73 335f 7363  e_path in _s3_sc
+00012f90: 616e 5f70 6169 7273 280a 2020 2020 2020  an_pairs(.      
+00012fa0: 2020 2020 2020 2020 2020 7365 6c66 2e70            self.p
+00012fb0: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+00012fc0: 6c2c 2064 7374 5f75 726c 293a 0a20 2020  l, dst_url):.   
+00012fd0: 2020 2020 2020 2020 2073 7263 5f66 696c           src_fil
+00012fe0: 655f 7061 7468 203d 2073 656c 662e 6672  e_path = self.fr
+00012ff0: 6f6d 5f70 6174 6828 7372 635f 6669 6c65  om_path(src_file
+00013000: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
+00013010: 2020 2064 7374 5f66 696c 655f 7061 7468     dst_file_path
+00013020: 203d 2073 656c 662e 6672 6f6d 5f70 6174   = self.from_pat
+00013030: 6828 6473 745f 6669 6c65 5f70 6174 6829  h(dst_file_path)
+00013040: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00013050: 6473 745f 6669 6c65 5f70 6174 682e 6578  dst_file_path.ex
+00013060: 6973 7473 2829 2061 6e64 2069 735f 7361  ists() and is_sa
+00013070: 6d65 5f66 696c 6528 0a20 2020 2020 2020  me_file(.       
+00013080: 2020 2020 2020 2020 2020 2020 2073 7263               src
+00013090: 5f66 696c 655f 7061 7468 2e73 7461 7428  _file_path.stat(
+000130a0: 292c 2064 7374 5f66 696c 655f 7061 7468  ), dst_file_path
+000130b0: 2e73 7461 7428 292c 2027 636f 7079 2729  .stat(), 'copy')
+000130c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000130d0: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
+000130e0: 2020 2020 2020 2073 7263 5f66 696c 655f         src_file_
+000130f0: 7061 7468 2e63 6f70 7928 6473 745f 6669  path.copy(dst_fi
+00013100: 6c65 5f70 6174 682c 2066 6f6c 6c6f 776c  le_path, followl
+00013110: 696e 6b73 3d66 6f6c 6c6f 776c 696e 6b73  inks=followlinks
+00013120: 290a 0a20 2020 2064 6566 2073 796d 6c69  )..    def symli
+00013130: 6e6b 2873 656c 662c 2064 7374 5f70 6174  nk(self, dst_pat
+00013140: 683a 2050 6174 684c 696b 6529 202d 3e20  h: PathLike) -> 
+00013150: 4e6f 6e65 3a0a 2020 2020 2020 2020 2727  None:.        ''
+00013160: 270a 2020 2020 2020 2020 4372 6561 7465  '.        Create
+00013170: 2061 2073 796d 626f 6c69 6320 6c69 6e6b   a symbolic link
+00013180: 2070 6f69 6e74 696e 6720 746f 2073 7263   pointing to src
+00013190: 5f70 6174 6820 6e61 6d65 6420 6473 745f  _path named dst_
+000131a0: 7061 7468 2e0a 0a20 2020 2020 2020 203a  path...        :
+000131b0: 7061 7261 6d20 6473 745f 7061 7468 3a20  param dst_path: 
+000131c0: 4465 7369 6e61 7469 6f6e 2070 6174 680a  Desination path.
+000131d0: 2020 2020 2020 2020 3a72 6169 7365 733a          :raises:
+000131e0: 2053 334e 616d 6554 6f6f 4c6f 6e67 4572   S3NameTooLongEr
+000131f0: 726f 722c 2053 3342 7563 6b65 744e 6f74  ror, S3BucketNot
+00013200: 466f 756e 6445 7272 6f72 2c20 5333 4973  FoundError, S3Is
+00013210: 4144 6972 6563 746f 7279 4572 726f 720a  ADirectoryError.
+00013220: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+00013230: 2020 2020 6966 206c 656e 2873 7472 2873      if len(str(s
+00013240: 656c 662e 5f73 335f 7061 7468 292e 656e  elf._s3_path).en
+00013250: 636f 6465 2829 2920 3e20 3130 3234 3a0a  code()) > 1024:.
+00013260: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00013270: 6520 5333 4e61 6d65 546f 6f4c 6f6e 6745  e S3NameTooLongE
+00013280: 7272 6f72 2827 4669 6c65 206e 616d 6520  rror('File name 
+00013290: 746f 6f20 6c6f 6e67 3a20 2572 2720 2520  too long: %r' % 
+000132a0: 6473 745f 7061 7468 290a 2020 2020 2020  dst_path).      
+000132b0: 2020 7372 635f 6275 636b 6574 2c20 7372    src_bucket, sr
+000132c0: 635f 6b65 7920 3d20 7061 7273 655f 7333  c_key = parse_s3
+000132d0: 5f75 726c 2873 656c 662e 7061 7468 5f77  _url(self.path_w
+000132e0: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
+000132f0: 2020 2020 2020 6473 745f 6275 636b 6574        dst_bucket
+00013300: 2c20 6473 745f 6b65 7920 3d20 7061 7273  , dst_key = pars
+00013310: 655f 7333 5f75 726c 2864 7374 5f70 6174  e_s3_url(dst_pat
+00013320: 6829 0a0a 2020 2020 2020 2020 6966 206e  h)..        if n
+00013330: 6f74 2073 7263 5f62 7563 6b65 743a 0a20  ot src_bucket:. 
+00013340: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00013350: 2053 3342 7563 6b65 744e 6f74 466f 756e   S3BucketNotFoun
+00013360: 6445 7272 6f72 2827 456d 7074 7920 6275  dError('Empty bu
+00013370: 636b 6574 206e 616d 653a 2025 7227 2025  cket name: %r' %
+00013380: 2073 656c 662e 7061 7468 290a 2020 2020   self.path).    
+00013390: 2020 2020 6966 206e 6f74 2064 7374 5f62      if not dst_b
+000133a0: 7563 6b65 743a 0a20 2020 2020 2020 2020  ucket:.         
+000133b0: 2020 2072 6169 7365 2053 3342 7563 6b65     raise S3Bucke
+000133c0: 744e 6f74 466f 756e 6445 7272 6f72 2827  tNotFoundError('
+000133d0: 456d 7074 7920 6275 636b 6574 206e 616d  Empty bucket nam
+000133e0: 653a 2025 7227 2025 2064 7374 5f70 6174  e: %r' % dst_pat
+000133f0: 6829 0a20 2020 2020 2020 2069 6620 6e6f  h).        if no
+00013400: 7420 6473 745f 6b65 7920 6f72 2064 7374  t dst_key or dst
+00013410: 5f6b 6579 2e65 6e64 7377 6974 6828 272f  _key.endswith('/
+00013420: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+00013430: 7261 6973 6520 5333 4973 4144 6972 6563  raise S3IsADirec
+00013440: 746f 7279 4572 726f 7228 2749 7320 6120  toryError('Is a 
+00013450: 6469 7265 6374 6f72 793a 2025 7227 2025  directory: %r' %
+00013460: 2064 7374 5f70 6174 6829 0a0a 2020 2020   dst_path)..    
+00013470: 2020 2020 7372 635f 7061 7468 203d 2073      src_path = s
+00013480: 656c 662e 5f73 335f 7061 7468 0a20 2020  elf._s3_path.   
+00013490: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+000134a0: 2020 2020 2020 7372 635f 7061 7468 203d        src_path =
+000134b0: 2073 656c 662e 7265 6164 6c69 6e6b 2829   self.readlink()
+000134c0: 2e5f 7333 5f70 6174 680a 2020 2020 2020  ._s3_path.      
+000134d0: 2020 6578 6365 7074 2053 334e 6f74 414c    except S3NotAL
+000134e0: 696e 6b45 7272 6f72 3a0a 2020 2020 2020  inkError:.      
+000134f0: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
+00013500: 2020 2077 6974 6820 7261 6973 655f 7333     with raise_s3
+00013510: 5f65 7272 6f72 2864 7374 5f70 6174 6829  _error(dst_path)
+00013520: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00013530: 6c66 2e5f 636c 6965 6e74 2e70 7574 5f6f  lf._client.put_o
+00013540: 626a 6563 7428 0a20 2020 2020 2020 2020  bject(.         
+00013550: 2020 2020 2020 2042 7563 6b65 743d 6473         Bucket=ds
+00013560: 745f 6275 636b 6574 2c0a 2020 2020 2020  t_bucket,.      
+00013570: 2020 2020 2020 2020 2020 4b65 793d 6473            Key=ds
+00013580: 745f 6b65 792c 0a20 2020 2020 2020 2020  t_key,.         
+00013590: 2020 2020 2020 204d 6574 6164 6174 613d         Metadata=
+000135a0: 7b22 7379 6d6c 696e 6b5f 746f 223a 2073  {"symlink_to": s
+000135b0: 7263 5f70 6174 687d 290a 0a20 2020 2064  rc_path})..    d
+000135c0: 6566 2072 6561 646c 696e 6b28 7365 6c66  ef readlink(self
+000135d0: 2920 2d3e 2027 5333 5061 7468 273a 0a20  ) -> 'S3Path':. 
+000135e0: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+000135f0: 2020 2052 6574 7572 6e20 6120 5333 5061     Return a S3Pa
+00013600: 7468 2069 6e73 7461 6e63 6520 7265 7072  th instance repr
+00013610: 6573 656e 7469 6e67 2074 6865 2070 6174  esenting the pat
+00013620: 6820 746f 2077 6869 6368 2074 6865 2073  h to which the s
+00013630: 796d 626f 6c69 6320 6c69 6e6b 2070 6f69  ymbolic link poi
+00013640: 6e74 732e 0a0a 2020 2020 2020 2020 3a72  nts...        :r
+00013650: 6574 7572 6e73 3a20 5265 7475 726e 2061  eturns: Return a
+00013660: 2053 3350 6174 6820 696e 7374 616e 6365   S3Path instance
+00013670: 2072 6570 7265 7365 6e74 696e 6720 7468   representing th
+00013680: 6520 7061 7468 2074 6f20 7768 6963 6820  e path to which 
+00013690: 7468 6520 7379 6d62 6f6c 6963 206c 696e  the symbolic lin
+000136a0: 6b20 706f 696e 7473 2e0a 2020 2020 2020  k points..      
+000136b0: 2020 3a72 6169 7365 733a 2053 334e 616d    :raises: S3Nam
+000136c0: 6554 6f6f 4c6f 6e67 4572 726f 722c 2053  eTooLongError, S
+000136d0: 3342 7563 6b65 744e 6f74 466f 756e 6445  3BucketNotFoundE
+000136e0: 7272 6f72 2c20 5333 4973 4144 6972 6563  rror, S3IsADirec
+000136f0: 746f 7279 4572 726f 722c 2053 334e 6f74  toryError, S3Not
+00013700: 414c 696e 6b45 7272 6f72 0a20 2020 2020  ALinkError.     
+00013710: 2020 2027 2727 0a20 2020 2020 2020 2062     '''.        b
+00013720: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
+00013730: 7365 5f73 335f 7572 6c28 7365 6c66 2e70  se_s3_url(self.p
+00013740: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+00013750: 6c29 0a20 2020 2020 2020 2069 6620 6e6f  l).        if no
+00013760: 7420 6275 636b 6574 3a0a 2020 2020 2020  t bucket:.      
+00013770: 2020 2020 2020 7261 6973 6520 5333 4275        raise S3Bu
+00013780: 636b 6574 4e6f 7446 6f75 6e64 4572 726f  cketNotFoundErro
+00013790: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+000137a0: 2020 2027 456d 7074 7920 6275 636b 6574     'Empty bucket
+000137b0: 206e 616d 653a 2025 7227 2025 2073 656c   name: %r' % sel
+000137c0: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
+000137d0: 6f63 6f6c 290a 2020 2020 2020 2020 6966  ocol).        if
+000137e0: 206e 6f74 206b 6579 206f 7220 6b65 792e   not key or key.
+000137f0: 656e 6473 7769 7468 2827 2f27 293a 0a20  endswith('/'):. 
+00013800: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00013810: 2053 3349 7341 4469 7265 6374 6f72 7945   S3IsADirectoryE
+00013820: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+00013830: 2020 2020 2020 2749 7320 6120 6469 7265        'Is a dire
+00013840: 6374 6f72 793a 2025 7227 2025 2073 656c  ctory: %r' % sel
+00013850: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
+00013860: 6f63 6f6c 290a 2020 2020 2020 2020 6d65  ocol).        me
+00013870: 7461 6461 7461 203d 2073 656c 662e 5f73  tadata = self._s
+00013880: 335f 6765 745f 6d65 7461 6461 7461 2829  3_get_metadata()
+00013890: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+000138a0: 2027 7379 6d6c 696e 6b5f 746f 2720 696e   'symlink_to' in
+000138b0: 206d 6574 6164 6174 613a 0a20 2020 2020   metadata:.     
+000138c0: 2020 2020 2020 2072 6169 7365 2053 334e         raise S3N
+000138d0: 6f74 414c 696e 6b45 7272 6f72 2827 4e6f  otALinkError('No
+000138e0: 7420 6120 6c69 6e6b 3a20 2572 2720 2520  t a link: %r' % 
+000138f0: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
+00013900: 726f 746f 636f 6c29 0a20 2020 2020 2020  rotocol).       
+00013910: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00013920: 2020 2072 6574 7572 6e20 7365 6c66 2e66     return self.f
+00013930: 726f 6d5f 7061 7468 286d 6574 6164 6174  rom_path(metadat
+00013940: 615b 2773 796d 6c69 6e6b 5f74 6f27 5d29  a['symlink_to'])
+00013950: 0a0a 2020 2020 6465 6620 6973 5f73 796d  ..    def is_sym
+00013960: 6c69 6e6b 2873 656c 6629 202d 3e20 626f  link(self) -> bo
+00013970: 6f6c 3a0a 2020 2020 2020 2020 2727 270a  ol:.        '''.
+00013980: 2020 2020 2020 2020 5465 7374 2077 6865          Test whe
+00013990: 7468 6572 2061 2070 6174 6820 6973 206c  ther a path is l
+000139a0: 696e 6b0a 0a20 2020 2020 2020 203a 7265  ink..        :re
+000139b0: 7475 726e 733a 2054 7275 6520 6966 2061  turns: True if a
+000139c0: 2070 6174 6820 6973 206c 696e 6b2c 2065   path is link, e
+000139d0: 6c73 6520 4661 6c73 650a 2020 2020 2020  lse False.      
+000139e0: 2020 3a72 6169 7365 733a 2053 334e 6f74    :raises: S3Not
+000139f0: 414c 696e 6b45 7272 6f72 0a20 2020 2020  ALinkError.     
+00013a00: 2020 2027 2727 0a20 2020 2020 2020 2062     '''.        b
+00013a10: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
+00013a20: 7365 5f73 335f 7572 6c28 7365 6c66 2e70  se_s3_url(self.p
+00013a30: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+00013a40: 6c29 0a20 2020 2020 2020 2069 6620 6e6f  l).        if no
+00013a50: 7420 6275 636b 6574 3a0a 2020 2020 2020  t bucket:.      
+00013a60: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
+00013a70: 7365 0a20 2020 2020 2020 2069 6620 6e6f  se.        if no
+00013a80: 7420 6b65 7920 6f72 206b 6579 2e65 6e64  t key or key.end
+00013a90: 7377 6974 6828 272f 2729 3a0a 2020 2020  swith('/'):.    
+00013aa0: 2020 2020 2020 2020 7265 7475 726e 2046          return F
+00013ab0: 616c 7365 0a20 2020 2020 2020 206d 6574  alse.        met
+00013ac0: 6164 6174 6120 3d20 7365 6c66 2e5f 7333  adata = self._s3
+00013ad0: 5f67 6574 5f6d 6574 6164 6174 6128 290a  _get_metadata().
+00013ae0: 2020 2020 2020 2020 7265 7475 726e 2027          return '
+00013af0: 7379 6d6c 696e 6b5f 746f 2720 696e 206d  symlink_to' in m
+00013b00: 6574 6164 6174 610a 0a20 2020 2064 6566  etadata..    def
+00013b10: 2073 6176 6528 7365 6c66 2c20 6669 6c65   save(self, file
+00013b20: 5f6f 626a 6563 743a 2042 696e 6172 7949  _object: BinaryI
+00013b30: 4f29 3a0a 2020 2020 2020 2020 2727 2757  O):.        '''W
+00013b40: 7269 7465 2074 6865 206f 7065 6e65 6420  rite the opened 
+00013b50: 6269 6e61 7279 2073 7472 6561 6d20 746f  binary stream to
+00013b60: 2073 7065 6369 6669 6564 2070 6174 682c   specified path,
+00013b70: 2062 7574 2074 6865 2073 7472 6561 6d20   but the stream 
+00013b80: 776f 6e27 7420 6265 2063 6c6f 7365 640a  won't be closed.
+00013b90: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+00013ba0: 6669 6c65 5f6f 626a 6563 743a 2053 7472  file_object: Str
+00013bb0: 6561 6d20 746f 2062 6520 7265 6164 0a20  eam to be read. 
+00013bc0: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+00013bd0: 2020 2062 7563 6b65 742c 206b 6579 203d     bucket, key =
+00013be0: 2070 6172 7365 5f73 335f 7572 6c28 7365   parse_s3_url(se
+00013bf0: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
+00013c00: 746f 636f 6c29 0a20 2020 2020 2020 2069  tocol).        i
+00013c10: 6620 6e6f 7420 6275 636b 6574 3a0a 2020  f not bucket:.  
+00013c20: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00013c30: 5333 4275 636b 6574 4e6f 7446 6f75 6e64  S3BucketNotFound
+00013c40: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+00013c50: 2020 2020 2020 2027 456d 7074 7920 6275         'Empty bu
+00013c60: 636b 6574 206e 616d 653a 2025 7227 2025  cket name: %r' %
+00013c70: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
+00013c80: 7072 6f74 6f63 6f6c 290a 2020 2020 2020  protocol).      
+00013c90: 2020 6966 206e 6f74 206b 6579 206f 7220    if not key or 
+00013ca0: 6b65 792e 656e 6473 7769 7468 2827 2f27  key.endswith('/'
+00013cb0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+00013cc0: 6169 7365 2053 3349 7341 4469 7265 6374  aise S3IsADirect
+00013cd0: 6f72 7945 7272 6f72 280a 2020 2020 2020  oryError(.      
+00013ce0: 2020 2020 2020 2020 2020 2749 7320 6120            'Is a 
+00013cf0: 6469 7265 6374 6f72 793a 2025 7227 2025  directory: %r' %
+00013d00: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
+00013d10: 7072 6f74 6f63 6f6c 290a 0a20 2020 2020  protocol)..     
+00013d20: 2020 2077 6974 6820 7261 6973 655f 7333     with raise_s3
+00013d30: 5f65 7272 6f72 2873 656c 662e 7061 7468  _error(self.path
+00013d40: 5f77 6974 685f 7072 6f74 6f63 6f6c 293a  _with_protocol):
+00013d50: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00013d60: 662e 5f63 6c69 656e 742e 7570 6c6f 6164  f._client.upload
+00013d70: 5f66 696c 656f 626a 2866 696c 655f 6f62  _fileobj(file_ob
+00013d80: 6a65 6374 2c20 4275 636b 6574 3d62 7563  ject, Bucket=buc
+00013d90: 6b65 742c 204b 6579 3d6b 6579 290a 0a20  ket, Key=key).. 
+00013da0: 2020 2064 6566 206f 7065 6e28 0a20 2020     def open(.   
+00013db0: 2020 2020 2020 2020 2073 656c 662c 0a20           self,. 
+00013dc0: 2020 2020 2020 2020 2020 206d 6f64 653a             mode:
+00013dd0: 2073 7472 203d 2027 7227 2c0a 2020 2020   str = 'r',.    
+00013de0: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
+00013df0: 2020 2020 2020 2073 335f 6f70 656e 5f66         s3_open_f
+00013e00: 756e 633a 2043 616c 6c61 626c 655b 5b73  unc: Callable[[s
+00013e10: 7472 2c20 7374 725d 2c20 4269 6e61 7279  tr, str], Binary
+00013e20: 494f 5d20 3d20 7333 5f6f 7065 6e2c 0a20  IO] = s3_open,. 
+00013e30: 2020 2020 2020 2020 2020 202a 2a6b 7761             **kwa
+00013e40: 7267 7329 202d 3e20 494f 5b41 6e79 5374  rgs) -> IO[AnySt
+00013e50: 725d 3a20 2023 2070 7974 7970 653a 2064  r]:  # pytype: d
+00013e60: 6973 6162 6c65 3d73 6967 6e61 7475 7265  isable=signature
+00013e70: 2d6d 6973 6d61 7463 680a 2020 2020 2020  -mismatch.      
+00013e80: 2020 7265 7475 726e 2073 335f 6f70 656e    return s3_open
+00013e90: 5f66 756e 6328 0a20 2020 2020 2020 2020  _func(.         
+00013ea0: 2020 2073 656c 662e 7061 7468 5f77 6974     self.path_wit
+00013eb0: 685f 7072 6f74 6f63 6f6c 2c20 6d6f 6465  h_protocol, mode
+00013ec0: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
+00013ed0: 6e65 6365 7373 6172 795f 7061 7261 6d73  necessary_params
+00013ee0: 2873 335f 6f70 656e 5f66 756e 632c 202a  (s3_open_func, *
+00013ef0: 2a6b 7761 7267 7329 290a 0a20 2020 2064  *kwargs))..    d
+00013f00: 6566 2061 6273 6f6c 7574 6528 7365 6c66  ef absolute(self
+00013f10: 2920 2d3e 2027 5333 5061 7468 273a 0a20  ) -> 'S3Path':. 
+00013f20: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+00013f30: 2020 204d 616b 6520 7468 6520 7061 7468     Make the path
+00013f40: 2061 6273 6f6c 7574 652c 2077 6974 686f   absolute, witho
+00013f50: 7574 206e 6f72 6d61 6c69 7a61 7469 6f6e  ut normalization
+00013f60: 206f 7220 7265 736f 6c76 696e 6720 7379   or resolving sy
+00013f70: 6d6c 696e 6b73 2e20 5265 7475 726e 7320  mlinks. Returns 
+00013f80: 6120 6e65 7720 7061 7468 206f 626a 6563  a new path objec
+00013f90: 740a 2020 2020 2020 2020 2727 270a 2020  t.        '''.  
+00013fa0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00013fb0: 660a 0a20 2020 2064 6566 2063 7764 2873  f..    def cwd(s
+00013fc0: 656c 6629 202d 3e20 2753 3350 6174 6827  elf) -> 'S3Path'
+00013fd0: 3a0a 2020 2020 2020 2020 2727 2752 6574  :.        '''Ret
+00013fe0: 7572 6e20 6375 7272 656e 7420 776f 726b  urn current work
+00013ff0: 696e 6720 6469 7265 6374 6f72 790a 0a20  ing directory.. 
+00014000: 2020 2020 2020 2072 6574 7572 6e73 3a20         returns: 
+00014010: 4375 7272 656e 7420 776f 726b 696e 6720  Current working 
+00014020: 6469 7265 6374 6f72 790a 2020 2020 2020  directory.      
+00014030: 2020 2727 270a 2020 2020 2020 2020 7265    '''.        re
+00014040: 7475 726e 2073 656c 662e 6672 6f6d 5f70  turn self.from_p
+00014050: 6174 6828 7365 6c66 2e70 6174 685f 7769  ath(self.path_wi
+00014060: 7468 5f70 726f 746f 636f 6c29 0a0a 0a63  th_protocol)...c
+00014070: 6c61 7373 204d 756c 7469 5061 7274 5772  lass MultiPartWr
+00014080: 6974 6572 3a0a 0a20 2020 2064 6566 205f  iter:..    def _
+00014090: 5f69 6e69 745f 5f28 7365 6c66 2c20 636c  _init__(self, cl
+000140a0: 6965 6e74 2c20 7061 7468 3a20 5061 7468  ient, path: Path
+000140b0: 4c69 6b65 2920 2d3e 204e 6f6e 653a 0a20  Like) -> None:. 
+000140c0: 2020 2020 2020 2073 656c 662e 5f63 6c69         self._cli
+000140d0: 656e 7420 3d20 636c 6965 6e74 0a20 2020  ent = client.   
+000140e0: 2020 2020 2073 656c 662e 5f6d 756c 7469       self._multi
+000140f0: 7061 7274 5f75 706c 6f61 645f 696e 666f  part_upload_info
+00014100: 203d 205b 5d0a 0a20 2020 2020 2020 2062   = []..        b
+00014110: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
+00014120: 7365 5f73 335f 7572 6c28 7061 7468 290a  se_s3_url(path).
+00014130: 2020 2020 2020 2020 7365 6c66 2e5f 6275          self._bu
+00014140: 636b 6574 203d 2062 7563 6b65 740a 2020  cket = bucket.  
+00014150: 2020 2020 2020 7365 6c66 2e5f 6b65 7920        self._key 
+00014160: 3d20 6b65 790a 2020 2020 2020 2020 7365  = key.        se
+00014170: 6c66 2e5f 7570 6c6f 6164 5f69 6420 3d20  lf._upload_id = 
+00014180: 7365 6c66 2e5f 636c 6965 6e74 2e63 7265  self._client.cre
+00014190: 6174 655f 6d75 6c74 6970 6172 745f 7570  ate_multipart_up
+000141a0: 6c6f 6164 280a 2020 2020 2020 2020 2020  load(.          
+000141b0: 2020 4275 636b 6574 3d73 656c 662e 5f62    Bucket=self._b
+000141c0: 7563 6b65 742c 204b 6579 3d73 656c 662e  ucket, Key=self.
+000141d0: 5f6b 6579 295b 2755 706c 6f61 6449 6427  _key)['UploadId'
+000141e0: 5d0a 0a20 2020 2064 6566 2075 706c 6f61  ]..    def uploa
+000141f0: 645f 7061 7274 2873 656c 662c 2070 6172  d_part(self, par
+00014200: 745f 6e75 6d3a 2069 6e74 2c20 6669 6c65  t_num: int, file
+00014210: 5f6f 626a 3a20 696f 2e42 7974 6573 494f  _obj: io.BytesIO
+00014220: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00014230: 2020 2072 6573 706f 6e73 6520 3d20 7365     response = se
+00014240: 6c66 2e5f 636c 6965 6e74 2e75 706c 6f61  lf._client.uploa
+00014250: 645f 7061 7274 280a 2020 2020 2020 2020  d_part(.        
+00014260: 2020 2020 426f 6479 3d66 696c 655f 6f62      Body=file_ob
+00014270: 6a2c 0a20 2020 2020 2020 2020 2020 2055  j,.            U
+00014280: 706c 6f61 6449 643d 7365 6c66 2e5f 7570  ploadId=self._up
+00014290: 6c6f 6164 5f69 642c 0a20 2020 2020 2020  load_id,.       
+000142a0: 2020 2020 2050 6172 744e 756d 6265 723d       PartNumber=
+000142b0: 7061 7274 5f6e 756d 2c0a 2020 2020 2020  part_num,.      
+000142c0: 2020 2020 2020 4275 636b 6574 3d73 656c        Bucket=sel
+000142d0: 662e 5f62 7563 6b65 742c 0a20 2020 2020  f._bucket,.     
+000142e0: 2020 2020 2020 204b 6579 3d73 656c 662e         Key=self.
+000142f0: 5f6b 6579 2c0a 2020 2020 2020 2020 290a  _key,.        ).
+00014300: 2020 2020 2020 2020 7365 6c66 2e5f 6d75          self._mu
+00014310: 6c74 6970 6172 745f 7570 6c6f 6164 5f69  ltipart_upload_i
+00014320: 6e66 6f2e 6170 7065 6e64 280a 2020 2020  nfo.append(.    
+00014330: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00014340: 2020 2020 2020 2020 2020 2750 6172 744e            'PartN
+00014350: 756d 6265 7227 3a20 7061 7274 5f6e 756d  umber': part_num
+00014360: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00014370: 2020 2745 5461 6727 3a20 7265 7370 6f6e    'ETag': respon
+00014380: 7365 5b27 4554 6167 275d 0a20 2020 2020  se['ETag'].     
+00014390: 2020 2020 2020 207d 290a 0a20 2020 2064         })..    d
+000143a0: 6566 2075 706c 6f61 645f 7061 7274 5f62  ef upload_part_b
+000143b0: 795f 7061 7468 7328 0a20 2020 2020 2020  y_paths(.       
+000143c0: 2020 2020 2073 656c 662c 2070 6172 745f       self, part_
+000143d0: 6e75 6d3a 2069 6e74 2c20 7061 7468 733a  num: int, paths:
+000143e0: 204c 6973 745b 5475 706c 655b 5061 7468   List[Tuple[Path
+000143f0: 4c69 6b65 2c20 7374 725d 5d29 202d 3e20  Like, str]]) -> 
+00014400: 4e6f 6e65 3a0a 2020 2020 2020 2020 6669  None:.        fi
+00014410: 6c65 5f6f 626a 203d 2069 6f2e 4279 7465  le_obj = io.Byte
+00014420: 7349 4f28 290a 2020 2020 2020 2020 666f  sIO().        fo
+00014430: 7220 7061 7468 2c20 6279 7465 735f 7261  r path, bytes_ra
+00014440: 6e67 6520 696e 2070 6174 6873 3a0a 2020  nge in paths:.  
+00014450: 2020 2020 2020 2020 2020 6275 636b 6574            bucket
+00014460: 2c20 6b65 7920 3d20 7061 7273 655f 7333  , key = parse_s3
+00014470: 5f75 726c 2870 6174 6829 0a20 2020 2020  _url(path).     
+00014480: 2020 2020 2020 2069 6620 6279 7465 735f         if bytes_
+00014490: 7261 6e67 653a 0a20 2020 2020 2020 2020  range:.         
+000144a0: 2020 2020 2020 2066 696c 655f 6f62 6a2e         file_obj.
+000144b0: 7772 6974 6528 0a20 2020 2020 2020 2020  write(.         
+000144c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000144d0: 5f63 6c69 656e 742e 6765 745f 6f62 6a65  _client.get_obje
+000144e0: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
+000144f0: 2020 2020 2020 2020 2020 2020 4275 636b              Buck
+00014500: 6574 3d62 7563 6b65 742c 204b 6579 3d6b  et=bucket, Key=k
+00014510: 6579 2c0a 2020 2020 2020 2020 2020 2020  ey,.            
+00014520: 2020 2020 2020 2020 2020 2020 5261 6e67              Rang
+00014530: 653d 6279 7465 735f 7261 6e67 6529 5b27  e=bytes_range)['
+00014540: 426f 6479 275d 2e72 6561 6428 2929 0a20  Body'].read()). 
+00014550: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00014560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014570: 2066 696c 655f 6f62 6a2e 7772 6974 6528   file_obj.write(
+00014580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014590: 2020 2020 2073 656c 662e 5f63 6c69 656e       self._clien
+000145a0: 742e 6765 745f 6f62 6a65 6374 2842 7563  t.get_object(Buc
+000145b0: 6b65 743d 6275 636b 6574 2c0a 2020 2020  ket=bucket,.    
+000145c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000145d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000145e0: 2020 2020 2020 2020 4b65 793d 6b65 7929          Key=key)
+000145f0: 5b27 426f 6479 275d 2e72 6561 6428 2929  ['Body'].read())
+00014600: 0a20 2020 2020 2020 2066 696c 655f 6f62  .        file_ob
+00014610: 6a2e 7365 656b 2830 2c20 6f73 2e53 4545  j.seek(0, os.SEE
+00014620: 4b5f 5345 5429 0a20 2020 2020 2020 2073  K_SET).        s
+00014630: 656c 662e 7570 6c6f 6164 5f70 6172 7428  elf.upload_part(
+00014640: 7061 7274 5f6e 756d 2c20 6669 6c65 5f6f  part_num, file_o
+00014650: 626a 290a 0a20 2020 2064 6566 2075 706c  bj)..    def upl
+00014660: 6f61 645f 7061 7274 5f63 6f70 7928 0a20  oad_part_copy(. 
+00014670: 2020 2020 2020 2020 2020 2073 656c 662c             self,
+00014680: 0a20 2020 2020 2020 2020 2020 2070 6172  .            par
+00014690: 745f 6e75 6d3a 2069 6e74 2c0a 2020 2020  t_num: int,.    
+000146a0: 2020 2020 2020 2020 7061 7468 3a20 5061          path: Pa
+000146b0: 7468 4c69 6b65 2c0a 2020 2020 2020 2020  thLike,.        
+000146c0: 2020 2020 636f 7079 5f73 6f75 7263 655f      copy_source_
+000146d0: 7261 6e67 653a 204f 7074 696f 6e61 6c5b  range: Optional[
+000146e0: 7374 725d 203d 204e 6f6e 6529 202d 3e20  str] = None) -> 
+000146f0: 4e6f 6e65 3a0a 2020 2020 2020 2020 6275  None:.        bu
+00014700: 636b 6574 2c20 6b65 7920 3d20 7061 7273  cket, key = pars
+00014710: 655f 7333 5f75 726c 2870 6174 6829 0a20  e_s3_url(path). 
+00014720: 2020 2020 2020 2070 6172 616d 7320 3d20         params = 
+00014730: 6469 6374 280a 2020 2020 2020 2020 2020  dict(.          
+00014740: 2020 5570 6c6f 6164 4964 3d73 656c 662e    UploadId=self.
+00014750: 5f75 706c 6f61 645f 6964 2c0a 2020 2020  _upload_id,.    
+00014760: 2020 2020 2020 2020 5061 7274 4e75 6d62          PartNumb
+00014770: 6572 3d70 6172 745f 6e75 6d2c 0a20 2020  er=part_num,.   
+00014780: 2020 2020 2020 2020 2043 6f70 7953 6f75           CopySou
+00014790: 7263 653d 7b0a 2020 2020 2020 2020 2020  rce={.          
+000147a0: 2020 2020 2020 2742 7563 6b65 7427 3a20        'Bucket': 
+000147b0: 6275 636b 6574 2c0a 2020 2020 2020 2020  bucket,.        
+000147c0: 2020 2020 2020 2020 274b 6579 273a 206b          'Key': k
+000147d0: 6579 0a20 2020 2020 2020 2020 2020 207d  ey.            }
+000147e0: 2c0a 2020 2020 2020 2020 2020 2020 4275  ,.            Bu
+000147f0: 636b 6574 3d73 656c 662e 5f62 7563 6b65  cket=self._bucke
+00014800: 742c 0a20 2020 2020 2020 2020 2020 204b  t,.            K
+00014810: 6579 3d73 656c 662e 5f6b 6579 2c0a 2020  ey=self._key,.  
+00014820: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00014830: 6966 2063 6f70 795f 736f 7572 6365 5f72  if copy_source_r
+00014840: 616e 6765 3a0a 2020 2020 2020 2020 2020  ange:.          
+00014850: 2020 7061 7261 6d73 5b27 436f 7079 536f    params['CopySo
+00014860: 7572 6365 5261 6e67 6527 5d20 3d20 636f  urceRange'] = co
+00014870: 7079 5f73 6f75 7263 655f 7261 6e67 650a  py_source_range.
+00014880: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+00014890: 203d 2073 656c 662e 5f63 6c69 656e 742e   = self._client.
+000148a0: 7570 6c6f 6164 5f70 6172 745f 636f 7079  upload_part_copy
+000148b0: 282a 2a70 6172 616d 7329 0a20 2020 2020  (**params).     
+000148c0: 2020 2073 656c 662e 5f6d 756c 7469 7061     self._multipa
+000148d0: 7274 5f75 706c 6f61 645f 696e 666f 2e61  rt_upload_info.a
+000148e0: 7070 656e 6428 0a20 2020 2020 2020 2020  ppend(.         
+000148f0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00014900: 2020 2020 2027 5061 7274 4e75 6d62 6572       'PartNumber
+00014910: 273a 2070 6172 745f 6e75 6d2c 0a20 2020  ': part_num,.   
+00014920: 2020 2020 2020 2020 2020 2020 2027 4554               'ET
+00014930: 6167 273a 2072 6573 706f 6e73 655b 2743  ag': response['C
+00014940: 6f70 7950 6172 7452 6573 756c 7427 5d5b  opyPartResult'][
+00014950: 2745 5461 6727 5d0a 2020 2020 2020 2020  'ETag'].        
+00014960: 2020 2020 7d29 0a0a 2020 2020 6465 6620      })..    def 
+00014970: 636c 6f73 6528 7365 6c66 293a 0a20 2020  close(self):.   
+00014980: 2020 2020 2073 656c 662e 5f6d 756c 7469       self._multi
+00014990: 7061 7274 5f75 706c 6f61 645f 696e 666f  part_upload_info
+000149a0: 2e73 6f72 7428 6b65 793d 6c61 6d62 6461  .sort(key=lambda
+000149b0: 2074 3a20 745b 2750 6172 744e 756d 6265   t: t['PartNumbe
+000149c0: 7227 5d29 0a20 2020 2020 2020 2073 656c  r']).        sel
+000149d0: 662e 5f63 6c69 656e 742e 636f 6d70 6c65  f._client.comple
+000149e0: 7465 5f6d 756c 7469 7061 7274 5f75 706c  te_multipart_upl
+000149f0: 6f61 6428 0a20 2020 2020 2020 2020 2020  oad(.           
+00014a00: 2055 706c 6f61 6449 643d 7365 6c66 2e5f   UploadId=self._
+00014a10: 7570 6c6f 6164 5f69 642c 0a20 2020 2020  upload_id,.     
+00014a20: 2020 2020 2020 2042 7563 6b65 743d 7365         Bucket=se
+00014a30: 6c66 2e5f 6275 636b 6574 2c0a 2020 2020  lf._bucket,.    
+00014a40: 2020 2020 2020 2020 4b65 793d 7365 6c66          Key=self
+00014a50: 2e5f 6b65 792c 0a20 2020 2020 2020 2020  ._key,.         
+00014a60: 2020 204d 756c 7469 7061 7274 5570 6c6f     MultipartUplo
+00014a70: 6164 3d7b 2750 6172 7473 273a 2073 656c  ad={'Parts': sel
+00014a80: 662e 5f6d 756c 7469 7061 7274 5f75 706c  f._multipart_upl
+00014a90: 6f61 645f 696e 666f 7d29 0a0a 2020 2020  oad_info})..    
+00014aa0: 6465 6620 5f5f 656e 7465 725f 5f28 7365  def __enter__(se
+00014ab0: 6c66 293a 0a20 2020 2020 2020 2072 6574  lf):.        ret
+00014ac0: 7572 6e20 7365 6c66 0a0a 2020 2020 6465  urn self..    de
+00014ad0: 6620 5f5f 6578 6974 5f5f 2873 656c 662c  f __exit__(self,
+00014ae0: 2065 7863 5f74 7970 652c 2065 7863 5f76   exc_type, exc_v
+00014af0: 616c 2c20 6578 635f 7462 293a 0a20 2020  al, exc_tb):.   
+00014b00: 2020 2020 2073 656c 662e 636c 6f73 6528       self.close(
+00014b10: 290a                                     ).
```

## megfile/sftp_path.py

```diff
@@ -139,15 +139,15 @@
 
 
 def _get_sftp_client(
         hostname: str,
         port: Optional[int] = None,
         username: Optional[str] = None,
         password: Optional[str] = None,
-) -> paramiko.SFTPClient:  # pragma: no cover
+) -> paramiko.SFTPClient:
     '''Get sftp client
 
     :returns: sftp client
     '''
     ssh_client = get_ssh_client(hostname, port, username, password)
     sftp_client = ssh_client.open_sftp()
     _patch_sftp_client_request(sftp_client, hostname, port, username, password)
@@ -170,15 +170,15 @@
 
 
 def _get_ssh_client(
         hostname: str,
         port: Optional[int] = None,
         username: Optional[str] = None,
         password: Optional[str] = None,
-) -> paramiko.SSHClient:  # pragma: no cover
+) -> paramiko.SSHClient:
     hostname, port, username, password, private_key = provide_connect_info(
         hostname=hostname,
         port=port,
         username=username,
         password=password,
     )
 
@@ -206,15 +206,15 @@
 
 
 def get_ssh_session(
         hostname: str,
         port: Optional[int] = None,
         username: Optional[str] = None,
         password: Optional[str] = None,
-) -> paramiko.Channel:  # pragma: no cover
+) -> paramiko.Channel:
     ssh_client = get_ssh_client(hostname, port, username, password)
     try:
         return _open_session(ssh_client)
     except paramiko.SSHException:
         ssh_client.close()
         atexit.unregister(ssh_client.close)
         ssh_key = f'ssh_client:{hostname},{port},{username},{password}'
@@ -228,16 +228,15 @@
                 hostname=hostname,
                 port=port,
                 username=username,
                 password=password,
             ))
 
 
-def _open_session(
-        ssh_client: paramiko.SSHClient) -> paramiko.Channel:  # pragma: no cover
+def _open_session(ssh_client: paramiko.SSHClient) -> paramiko.Channel:
     transport = ssh_client.get_transport()
     if not transport:
         raise paramiko.SSHException()
     session = transport.open_session(timeout=DEFAULT_SSH_CONNECT_TIMEOUT)
     return session
 
 
@@ -379,15 +378,22 @@
         src_url = src_url.readlink()
     if src_url.is_dir():
         raise IsADirectoryError('Is a directory: %r' % src_url)
     if str(dst_url).endswith('/'):
         raise IsADirectoryError('Is a directory: %r' % dst_url)
 
     os.makedirs(os.path.dirname(dst_url), exist_ok=True)
-    src_url._client.get(src_url._real_path, dst_url, callback=callback)
+
+    sftp_callback = None
+    if callback:
+
+        def sftp_callback(bytes_transferred: int, _total_bytes: int):
+            callback(bytes_transferred)
+
+    src_url._client.get(src_url._real_path, dst_url, callback=sftp_callback)
 
     src_stat = src_url.stat()
     dst_path = FSPath(dst_url)
     dst_path.utime(src_stat.st_atime, src_stat.st_mtime)
     dst_path.chmod(src_stat.st_mode)
 
 
@@ -410,15 +416,22 @@
     if os.path.isdir(src_url):
         raise IsADirectoryError('Is a directory: %r' % src_url)
     if str(dst_url).endswith('/'):
         raise IsADirectoryError('Is a directory: %r' % dst_url)
 
     dst_url = SftpPath(dst_url)
     dst_url.parent.makedirs(exist_ok=True)
-    dst_url._client.put(src_url, dst_url._real_path, callback=callback)
+
+    sftp_callback = None
+    if callback:
+
+        def sftp_callback(bytes_transferred: int, _total_bytes: int):
+            callback(bytes_transferred)
+
+    dst_url._client.put(src_url, dst_url._real_path, callback=sftp_callback)
 
     src_stat = fs_stat(src_url)
     dst_url.utime(src_stat.st_atime, src_stat.st_mtime)
     dst_url.chmod(src_stat.st_mode)
 
 
 def sftp_path_join(path: PathLike, *other_paths: PathLike) -> str:
@@ -707,15 +720,20 @@
                 if parent_path_object.exists():
                     break
                 else:
                     parent_path_objects.append(parent_path_object)
             for parent_path_object in parent_path_objects[::-1]:
                 parent_path_object.mkdir(
                     mode=mode, parents=False, exist_ok=True)
-        self._client.mkdir(path=self._real_path, mode=mode)
+        try:
+            self._client.mkdir(path=self._real_path, mode=mode)
+        except OSError:
+            # catch OSError when mkdir concurrently
+            if not self.exists():
+                raise
 
     def realpath(self) -> str:
         '''Return the real path of given path
 
         :returns: Real path of given path
         '''
         return self.resolve().path_with_protocol
@@ -1059,15 +1077,15 @@
 
     def _exec_command(
             self,
             command: List[str],
             bufsize: int = -1,
             timeout: Optional[int] = None,
             environment: Optional[dict] = None,
-    ) -> subprocess.CompletedProcess:  # pragma: no cover
+    ) -> subprocess.CompletedProcess:
         with get_ssh_session(
                 hostname=self._urlsplit_parts.hostname,
                 port=self._urlsplit_parts.port,
                 username=self._urlsplit_parts.username,
                 password=self._urlsplit_parts.password,
         ) as chan:
             chan.settimeout(timeout)
@@ -1110,15 +1128,15 @@
                 'Is a directory: %r' % self.path_with_protocol)
 
         self.from_path(os.path.dirname(dst_path)).makedirs(exist_ok=True)
         dst_path = self.from_path(dst_path)
         if self._is_same_backend(dst_path):
             exec_result = self._exec_command(
                 ["cp", self._real_path, dst_path._real_path])
-            if exec_result.returncode != 0:  # pragma: no cover
+            if exec_result.returncode != 0:
                 _logger.error(exec_result.stderr)
                 raise OSError(
                     f'Copy file error, returncode: {exec_result.returncode}')
         else:
             with self.open('rb') as fsrc:
                 with dst_path.open('wb') as fdst:
                     length = 16 * 1024
```

## megfile/smart.py

```diff
@@ -252,15 +252,15 @@
     '''
     try:
         _copy_funcs[src_protocol][dst_protocol]
     except KeyError:
         dst_dict = _copy_funcs.get(src_protocol, {})
         dst_dict[dst_protocol] = copy_func
         _copy_funcs[src_protocol] = dst_dict
-    except Exception as error:  # pragma: no cover
+    except Exception as error:
         raise error
     else:
         raise ValueError(
             'Copy Function has already existed: {}->{}'.format(
                 src_protocol, dst_protocol))
 
 
@@ -354,15 +354,15 @@
     dst_protocol, _ = SmartPath._extract_protocol(dst_abs_file_path)
     should_sync = True
     try:
         if smart_exists(dst_abs_file_path) and is_same_file(
                 smart_stat(src_file_path), smart_stat(dst_abs_file_path),
                 get_sync_type(src_protocol, dst_protocol)):
             should_sync = False
-    except NotImplementedError:  # pragma: no cover
+    except NotImplementedError:
         pass
 
     if should_sync:
         copy_callback = partial(callback, src_file_path) if callback else None
         smart_copy(
             src_file_path,
             dst_abs_file_path,
@@ -460,15 +460,15 @@
         smart_scan_stat(src_path, missing_ok=False, followlinks=followlinks))
     tbar = tqdm(total=len(file_stats), ascii=True)
     sbar = tqdm(unit='B', ascii=True, unit_scale=True)
 
     def tqdm_callback(current_src_path, length: int):
         sbar.update(length)
         if callback:
-            callback(current_src_path, length)  # pragma: no cover
+            callback(current_src_path, length)
 
     def callback_after_copy_file(src_file_path, dst_file_path):
         tbar.update(1)
 
     smart_sync(
         src_path,
         dst_path,
```

## megfile/version.py

```diff
@@ -1 +1 @@
-VERSION = "2.1.1.post2"
+VERSION = "2.1.2"
```

## megfile/lib/combine_reader.py

```diff
@@ -32,16 +32,15 @@
         self._blocks_sizes.append(self._content_size)
 
     @property
     def _block_index_and_offset(self):
         for index, size in enumerate(self._blocks_sizes):
             if self._offset < size:
                 return index - 1, self._offset - self._blocks_sizes[index - 1]
-        raise IOError(
-            'offset out of range: %d' % self._offset)  # pragma: no cover
+        raise IOError('offset out of range: %d' % self._offset)
 
     @property
     def name(self) -> str:
         return self._name
 
     @property
     def mode(self) -> str:
```

## megfile/lib/compat.py

```diff
@@ -14,26 +14,26 @@
         return result.decode()
     return result
 
 
 import sys
 
 if sys.version_info.major == 3 and sys.version_info.minor >= 8:
-    from shutil import copytree  # pragma: no cover
+    from shutil import copytree
 else:
-    from shutil import Error, copy2, copystat  # pragma: no cover
+    from shutil import Error, copy2, copystat
 
     def copytree(
             src,
             dst,
             symlinks=False,
             ignore=None,
             copy_function=copy2,
             ignore_dangling_symlinks=False,
-            dirs_exist_ok=False):  # pragma: no cover
+            dirs_exist_ok=False):
         names = os.listdir(src)
         if ignore is not None:
             ignored_names = ignore(src, names)
         else:
             ignored_names = set()
 
         os.makedirs(dst, exist_ok=dirs_exist_ok)
```

## megfile/lib/glob.py

```diff
@@ -162,15 +162,15 @@
         dirname = os.curdir
     try:
         # dirname may be non-existent, raise OSError
         for name, isdir in fs.scandir(dirname):
             try:
                 if not dironly or isdir:
                     yield name  # type: ignore
-            except OSError:  # pragma: no cover
+            except OSError:
                 pass
     except OSError:
         return
 
 
 # Recursively yields relative pathnames inside a literal directory.
 def _rlistdir(dirname: str, dironly: bool, fs: FSFunc) -> Iterator[str]:
```

## megfile/lib/s3_limited_seekable_writer.py

```diff
@@ -122,15 +122,15 @@
             self._submit_futures()
         self._offset += len(data)
         if self._offset > self._content_size:
             self._content_size = self._offset
 
     def _submit_futures(self):
         content = self._buffer.getvalue()
-        if len(content) == 0:  # pragma: no cover
+        if len(content) == 0:
             return
         offset = len(content) - self._tail_block_size
         self._buffer = BytesIO(content[offset:])
         self._buffer.seek(0, os.SEEK_END)
         self._submit_upload_content(content[:offset])
 
     def _close(self):
```

## megfile/lib/s3_pipe_handler.py

```diff
@@ -68,15 +68,15 @@
     def tell(self) -> int:
         return self._offset
 
     def _download_fileobj(self):
         try:
             with os.fdopen(self._pipe[1], 'wb') as buffer:
                 self._client.download_fileobj(self._bucket, self._key, buffer)
-        except BrokenPipeError:  # pragma: no cover
+        except BrokenPipeError:
             if self._fileobj.closed:
                 return
             raise
         except Exception as error:
             self._exc = error
 
     def _upload_fileobj(self):
```

## megfile/lib/s3_prefetch_reader.py

```diff
@@ -380,15 +380,15 @@
                 'File changed: %r, etag before: %s, after: %s' %
                 (self.name, self._content_info, response))
 
         return BytesIO(response['Body'].read())
 
     def _submit_future(self, index: int):
         if index < 0 or index >= self._block_stop:
-            return  # pragma: no cover
+            return
         self._futures.submit(self._executor, index, self._fetch_buffer, index)
 
     def _insert_futures(self, index: int, future: Future):
         self._futures[index] = future
 
     def _fetch_future_result(self, index: int):
         return self._futures.result(index)
```

## megfile/lib/s3_share_cache_reader.py

```diff
@@ -65,15 +65,15 @@
         # The corresponding block is probably not downloaded when seeked to a new position
         # So record the offset first, set it when it is accessed
         self._cached_offset = offset
         self._block_index = index
 
     def _submit_future(self, index: int):
         if index < 0 or index >= self._block_stop:
-            return  # pragma: no cover
+            return
         self._futures.submit(
             self._executor, (self.name, index), self._fetch_buffer, index)
 
     def _insert_futures(self, index: int, future: Future):
         self._futures[(self.name, index)] = future
 
     def _fetch_future_result(self, index: int):
```

## megfile/utils/__init__.py

```diff
@@ -222,15 +222,15 @@
 def calculate_md5(file_object):
     hash_md5 = hashlib.md5()  # nosec
     for chunk in iter(lambda: file_object.read(4096), b''):
         hash_md5.update(chunk)
     return hash_md5.hexdigest()
 
 
-class classproperty(property):  # pragma: no cover
+class classproperty(property):
     """
     The use this class as a decorator for your class property.
     Example:
         @classproperty
         def prop(cls):
             return "value"
     """
```

## Comparing `megfile-2.1.1.post2.dist-info/LICENSE` & `megfile-2.1.2.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `megfile-2.1.1.post2.dist-info/LICENSE.pyre` & `megfile-2.1.2.dist-info/LICENSE.pyre`

 * *Files identical despite different names*

## Comparing `megfile-2.1.1.post2.dist-info/METADATA` & `megfile-2.1.2.dist-info/METADATA`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: megfile
-Version: 2.1.1.post2
+Version: 2.1.2
 Summary: Megvii file operation library
 Home-page: https://github.com/megvii-research/megfile
 Author: megvii
 Author-email: megfile@megvii.com
 Classifier: Development Status :: 4 - Beta
 Classifier: Environment :: Console
 Classifier: Intended Audience :: Developers
```

## Comparing `megfile-2.1.1.post2.dist-info/RECORD` & `megfile-2.1.2.dist-info/RECORD`

 * *Files 14% similar despite different names*

```diff
@@ -1,45 +1,45 @@
 megfile/__init__.py,sha256=wlijLJS6F8Vdm1xjpsjd9fKBeDGpgIMrVsXYSeOQ4Xw,5434
-megfile/cli.py,sha256=nIrugxYRV_FnW_SdHSi5Oy9R5n90LLDA7ApcTSkWCnA,10265
+megfile/cli.py,sha256=5WnLtC2PBXfNDB4h9i4idjMEwu334MGXz-VdbfHoed8,10396
 megfile/errors.py,sha256=H5wCiVBvOtQo5cu3JLhAUCpQJsCkPNm1KNw9o8y4Las,11349
 megfile/fs.py,sha256=sjkm_LsvNCw8hj9Ee-1HSNzvg7bRHTPem8KTDDBQlCw,11621
-megfile/fs_path.py,sha256=xadMpuqRCdr3CLFmRMg6lTlZfSvnPbc_Dql23NO24SU,38552
+megfile/fs_path.py,sha256=Lz-u8XL2RMViHl_39yapAwX5XSE_ZpQsuhAvVve6rk8,38532
 megfile/http.py,sha256=vLUxd0Ae9S8XU3ZUKbaTUerkAG5TG9fBEucPNYG90JM,2113
-megfile/http_path.py,sha256=ED-t_b7XL4MMRpiTySP_pt7AhlDp8hMSn9lD31h3wj8,4805
+megfile/http_path.py,sha256=80hSwGcyGAHhhch8Mj5-wUOY_t0VL812cOPB48rT4iM,4785
 megfile/interfaces.py,sha256=h3tWE8hVt5S-HopaMAX6lunPJ97vzhv6jH_2HubcDNc,6219
 megfile/pathlike.py,sha256=52e6POtMfUCC3Hb9XNwBLXM3Gkz3aGP8H8AagGKlDSg,29307
 megfile/s3.py,sha256=6d9bBVkVdXIvmJLfpOgJkK4nVAsLR3lirrB6x1-P2y8,12437
-megfile/s3_path.py,sha256=WpbI1BrunWfc_k9Le-JunPWtNG9AmSAr9bBn0qNfIJY,84883
+megfile/s3_path.py,sha256=2AY_Rcn0ZR2TpPSqWxBcbUuQ3JuS7XerZ-wBK4wXyMo,84754
 megfile/sftp.py,sha256=qzfgI-MGzNsr7adUQaiVKS7zRHGuK-Hs6o45wNIAcww,11943
-megfile/sftp_path.py,sha256=tyckiG1TFnlYAPN_4pijfqa3NGi0bJIIxevy7F_y28I,46328
-megfile/smart.py,sha256=l4orTpsYzwuNkg0mdS-gBy2_iZ8asL8UUhqMzztN2xQ,31952
+megfile/sftp_path.py,sha256=Gb-x0H3ziX5N7pMxj768-ootIfn5ZTyATi_gT4FWqMw,46668
+megfile/smart.py,sha256=Q-vfhUL06F4FDOmjqJDupP6ZFOF9y9IdUG7XY1AWIjA,31892
 megfile/smart_path.py,sha256=Rwb1McXsshi9-F6miTRqE6j8FO2j1edjmSxZF32YZ6E,6708
 megfile/stdio.py,sha256=qmi1c7VTll6Y6ya9MCd-dSKffocX2GafA-YUncZRU1Y,559
 megfile/stdio_path.py,sha256=ULMzGOj7SBMn3c7fYVSDepT_1nEUiVetc-xRt2pR5o4,2682
-megfile/version.py,sha256=9W9M0jH8kyqG90R_AXdJtPp9-v2TqYgHfX2bbfNlhmo,25
+megfile/version.py,sha256=TftECSnqZVrWlS4d6pWN2XLX3RDZzn7_oqAHiDuCrIg,19
 megfile/lib/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-megfile/lib/combine_reader.py,sha256=TkjvYvM5ZBVCh3tA7cOmTe8dYZc_eI7XbpPhnzqaNvU,4580
+megfile/lib/combine_reader.py,sha256=XFSqEY5A5X5Uf7eQ6AXAzrvNteESSXvKNVPktGjo3KY,4546
 megfile/lib/compare.py,sha256=yG2fZve_gMg32rQVCdwixBdqgYRsjn-24TqhALQaOrA,2233
-megfile/lib/compat.py,sha256=eEwcFLU82aZHmJSjpbmj54YMn-FNM8gGTgnnX60LYjU,3073
+megfile/lib/compat.py,sha256=6m4eIwCndB8CbIl0FRx0Y0tg8VAcjdRLHma2bdWPO0k,3013
 megfile/lib/fnmatch.py,sha256=HgdlnEWBsdFUOZqnW_v1kj1jeH_9lMcCqW85pyMu4vM,4054
-megfile/lib/glob.py,sha256=L5PniK6PWzpfUrWgOHxOAzZzSg4k7l2JbN8jWNfCq4E,9752
+megfile/lib/glob.py,sha256=7i9dIput9rI9JIPyTZX-JDmFS7IP_THlX1k-35foAfw,9732
 megfile/lib/joinpath.py,sha256=D4Px6-lnDDpYs1LMUHkTIGqMPJQ0oCBGfTzREs373iU,929
 megfile/lib/lazy_handler.py,sha256=f1rip2_T57vVo0WRNXve2bAa4LArvVheMfQg1S0vFzg,1915
 megfile/lib/s3_buffered_writer.py,sha256=AGjCNQ1X16kjFbEJouavkO6ykmlAtfVKBPAD-yYwAT0,6934
 megfile/lib/s3_cached_handler.py,sha256=e4KamTLMIPKa96yp7HGF05wDl2Yfoizz9pBrz-uAQ5w,1322
-megfile/lib/s3_limited_seekable_writer.py,sha256=OEh_HCbxNt8hsF2Y5OAQ9puikvzDfNkzluHjXtThegg,6057
+megfile/lib/s3_limited_seekable_writer.py,sha256=NSBh5cZCCtwZM0DTwfPkpOA_h0NXd9-6qjasOby5zxc,6037
 megfile/lib/s3_memory_handler.py,sha256=jLBA5HVuI-UBPYMYN-B8iX_VGr8bC9brAqY-KbEGrtw,3725
-megfile/lib/s3_pipe_handler.py,sha256=6r0rmLQp6VlJ4ZpBAvurfkaY0-qxKIuNpi5wMe1sDJ4,3404
-megfile/lib/s3_prefetch_reader.py,sha256=zSd_gmpDtQCDA-Rrh7Nxh2WOb0Z8Q1QZZg1g7WO6JNg,15053
-megfile/lib/s3_share_cache_reader.py,sha256=q3MVEDUgOvalO7js6S_LWQ-eJS4xFHiio8ZoJZt40e4,3791
+megfile/lib/s3_pipe_handler.py,sha256=38x8oPrxlXVWqMgDOqScPj0Pt2w2cQFSNoTK27EtBSw,3384
+megfile/lib/s3_prefetch_reader.py,sha256=9YBnxKeOZ5RPbUw9vZ_PpYZzevfhw-GLkw08HIy4KVk,15033
+megfile/lib/s3_share_cache_reader.py,sha256=QyZvzVpTswgiXv-E8QhV_jFdQjCBxVcgbgybXo6d1cM,3771
 megfile/lib/shadow_handler.py,sha256=IbFyTw107t-yWH0cGrDjAJX-CS3xeEr77_PTGsnSgk4,2683
 megfile/lib/stdio_handler.py,sha256=QDWtcZxz-hzi-rqQUiSlR3NrihX1fjK_Rj9T2mdTFEg,2044
 megfile/lib/url.py,sha256=VbQLjo0s4AaV0iSk66BcjI68aUTcN9zBZ5x6-cM4Qvs,103
-megfile/utils/__init__.py,sha256=gWplPIHzpSqV9AiQiRvUrBCkD737caNYyudsgwQBbKk,9025
+megfile/utils/__init__.py,sha256=DEVSwUQ1-1rkHBIuXBxgEYiepq8W25JIWYQrC1gcFrc,9005
 megfile/utils/mutex.py,sha256=BE16gbmZxr0RgU0ULaAFVDTZGwiOA-Jven-fDeG3ltQ,2461
-megfile-2.1.1.post2.dist-info/LICENSE,sha256=WNHhf_5RCaeuKWyq_K39vmp9F28LxKsB4SpomwSZ2L0,11357
-megfile-2.1.1.post2.dist-info/LICENSE.pyre,sha256=9lf5nT-5ZH25JijpYAequ0bl8E8z5JmZB1qrjiUMp84,1080
-megfile-2.1.1.post2.dist-info/METADATA,sha256=1xUHdV8_aARo0maxzB7ad7r_kxgf1hdYgR4ycD5sgV4,10160
-megfile-2.1.1.post2.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
-megfile-2.1.1.post2.dist-info/entry_points.txt,sha256=M6ZWSSv5_5_QtIpZafy3vq7WuOJ_5dSGQQnEZbByt2Q,49
-megfile-2.1.1.post2.dist-info/top_level.txt,sha256=i3rMgdU1ZAJekAceojhA-bkm3749PzshtRmLTbeLUPQ,8
-megfile-2.1.1.post2.dist-info/RECORD,,
+megfile-2.1.2.dist-info/LICENSE,sha256=WNHhf_5RCaeuKWyq_K39vmp9F28LxKsB4SpomwSZ2L0,11357
+megfile-2.1.2.dist-info/LICENSE.pyre,sha256=9lf5nT-5ZH25JijpYAequ0bl8E8z5JmZB1qrjiUMp84,1080
+megfile-2.1.2.dist-info/METADATA,sha256=c5_ThqMGxAe4RUWjgSUg3hoz1wH54bVokuHl_HM_ITg,10154
+megfile-2.1.2.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
+megfile-2.1.2.dist-info/entry_points.txt,sha256=M6ZWSSv5_5_QtIpZafy3vq7WuOJ_5dSGQQnEZbByt2Q,49
+megfile-2.1.2.dist-info/top_level.txt,sha256=i3rMgdU1ZAJekAceojhA-bkm3749PzshtRmLTbeLUPQ,8
+megfile-2.1.2.dist-info/RECORD,,
```

